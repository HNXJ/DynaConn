function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.774779384401404e-02   +3.217256273808445e-02   -3.547154819264060e-02   -4.216644385277726e-02   +7.942876489536523e-02   -2.317210937116949e-02   -1.553064407297294e-02   -1.831422561609267e-02   -2.059871379490242e-02; +3.913164317499961e-04   +4.300901044972192e-04   -2.303103643687236e-02   +4.475654773234907e-04   -3.702169187744053e-02   +5.546806051843919e-02   +3.455544690973313e-02   -1.985184716065164e-02   +3.128785831058610e-02; +5.421216091488709e-02   -6.102116077785556e-02   +1.411550964959634e-01   -2.783200558751839e-02   -5.957754573708118e-03   -6.405175352967850e-02   +3.171622819880428e-02   -3.679314446541157e-02   +3.246704469230099e-03; +4.527022952536894e-02   -5.002577559212583e-02   +4.186742492724358e-02   -6.064592911379227e-02   +1.013181290720056e-03   +4.266173482251866e-02   -4.977489222007900e-02   +7.841564054485059e-02   +7.389916249924473e-02; +1.498561137805341e-02   +1.435261710950221e-02   +7.314490338138110e-02   -2.358167236833512e-02   +3.614965627721886e-02   -5.655760716110194e-02   -9.909576225400073e-03   +5.297353452566418e-02   -2.017561775347548e-03; +8.202365281917869e-02   -1.603171856418006e-02   +2.727680166356736e-02   +3.298860493762309e-02   +3.842346750757113e-04   +7.128828529415588e-03   -3.557067860218761e-02   +2.171387999783879e-02   +1.783160588480127e-02; +5.185255250390920e-02   +3.042220551333363e-02   -5.627182982105997e-03   +1.380569132870178e-01   -1.870059306119329e-02   +1.853817624446850e-02   +5.872548135136955e-03   +5.593646195792545e-02   +3.190196418694795e-02; +1.115855177288399e-01   +3.155168566055339e-02   -2.742675780404241e-03   +2.823382528253915e-02   -6.807725304931125e-02   +3.107288986409456e-03   +1.071608460886779e-02   +4.814095248283205e-02   +1.124459726391917e-02; +1.025328306735078e-01   +3.696545938203216e-02   +6.128478763568446e-02   -4.284110284801427e-02   +8.220385761163021e-02   +2.695192790599878e-02   +5.715520410491561e-02   -1.926178175255534e-02   -3.517294671729431e-03];
L1_L2_iAMPA_netcon = [+7.106377836491355e-02   +4.976921651167709e-02   +1.227102444652995e-01   +1.668433097541470e-02   +5.867762381786754e-02   +4.977463894919111e-02   +2.606410590307865e-02   -5.624255491330300e-02   +4.365251699632740e-02; -7.126069347392698e-02   +1.798574205068339e-02   -7.548447724109239e-03   +3.449441217204822e-02   +4.809993835987450e-02   +2.351644051142085e-02   -2.024000995084176e-02   +6.921506204249797e-02   +1.899814176157402e-02; -3.065653541522440e-04   +6.707296122109924e-02   +1.491926559939104e-01   +2.970001272072335e-02   +7.881795364362015e-02   +7.537593313950217e-02   +8.292005107123407e-02   -4.162799201587814e-02   +7.982076134918491e-03; -4.052855683872531e-02   +1.113337651088022e-01   -8.639043805909720e-03   +3.935149610558152e-02   +1.622025405362958e-02   -4.403892027822487e-05   -6.379040552120951e-02   -5.264243640668210e-02   -1.060868677830001e-01; +1.254607739201080e-03   -4.773296480566292e-02   +3.976003812451241e-02   +1.882071018262065e-03   +9.677823164855334e-02   +9.726256044760281e-02   +7.729383669428914e-02   +5.353241304178268e-03   +1.264928599803002e-01; +2.819016946061335e-02   +4.420732217147768e-02   +8.391419431775414e-02   +1.326750807180137e-02   -4.335163671576182e-02   -2.846776286379048e-02   +8.764052458224836e-02   +7.275510021856381e-02   +5.167929922044896e-02; +4.835759080408253e-02   +1.133537237653125e-02   +4.625232137416959e-02   +1.377132498604894e-02   +5.138112845706944e-02   +2.936558969782462e-02   -6.904353162969010e-02   -3.360804028804841e-02   +5.069335627520970e-02; +8.705520972744547e-02   +2.099649155261275e-02   +5.271248966981089e-02   +3.129537741383492e-02   +7.873053253632314e-02   -2.669892319821291e-02   +8.056410993681026e-02   +3.603221679063851e-02   -4.941663578822852e-02; +2.886668521968589e-02   +4.337216300923490e-02   +2.095104244147041e-02   -9.425133916456861e-03   +3.573433310223638e-02   -6.988914404927730e-02   +1.034010334058163e-01   +5.442784084533200e-02   +5.093459262518135e-02];
L2_L5_iAMPA_netcon = [-1.173529958147496e-02   +1.356160929083302e-02   -8.983535203817568e-03   -1.557660564178929e-02   -3.515095276135015e-02   +3.150945193228018e-02   -2.110353681925780e-02   -4.970077677560802e-03   +5.537945788570288e-02; -2.978266957078410e-03   +1.470631291320007e-02   +2.585588310876115e-02   -6.256094910371802e-02   +4.103677494641062e-02   +1.969658983336717e-02   +9.065995729506632e-02   -1.630083728834987e-02   +3.623556402756274e-02; +6.390090162925131e-02   +7.363619612063908e-02   +1.218825958418212e-02   +4.403794010168197e-02   +1.093124619385072e-01   -1.882368729247327e-02   -1.574428700071452e-02   +7.451111839782036e-02   +1.202999668451907e-02; +1.417526837471296e-02   +6.572701153429590e-02   -2.485189206383149e-03   +5.935859695626729e-02   -6.380977545410411e-02   +5.073928855842989e-02   +4.067374257791659e-02   -2.315062514670681e-02   +5.590005194863374e-02; +1.874959444295390e-02   +2.837994560466389e-03   +2.373430094404026e-02   +5.683924793770934e-03   +8.633757732432332e-02   +2.619238153131364e-02   +5.296526205993351e-02   +5.269157680433185e-03   +3.935865438146691e-02; +4.983046334850994e-02   -6.099328608165172e-03   +2.781279022085381e-02   -1.188876732980702e-03   +2.502656533832023e-02   +3.021801552757975e-02   -1.270083123903831e-02   -1.165966261456152e-02   +3.025550226180890e-02];
L5_L2_iGABA_netcon = [-1.674857438208117e-02   +4.985986065460377e-02   +9.644668655221514e-02   +8.462202638338696e-03   +1.158675777022870e-01   +6.467325651868130e-02; +8.895157854927202e-02   +6.939472613986340e-02   +2.277125592365800e-02   -2.441160298082272e-03   +4.288276454240195e-02   +6.223686910170413e-02; +3.725569555913293e-02   +1.195843175466823e-01   +1.423370698784675e-01   +7.386454809472903e-02   -3.299187631600182e-02   +5.108512000206599e-02; +5.829441913199438e-02   -9.281554834213396e-02   -2.120272727783344e-02   -1.120518728799779e-02   -3.579257832172791e-02   -6.308651053109983e-02; +2.343604973583242e-02   +2.612365785141715e-02   +7.064714881682281e-02   +1.509576202829899e-02   -6.401633878532959e-02   +1.636648135354470e-02; -7.080158941200324e-02   -1.193489000519478e-02   -3.754838982619862e-03   +4.609829166089943e-02   +2.568761348355788e-02   +3.859259421175430e-02; +6.612028736595695e-03   -3.622664620753325e-02   +3.831548963890623e-02   +5.537222939123783e-02   +2.384042212411661e-02   +7.056697510042691e-02; -2.866223498395233e-03   +4.075445543984257e-04   +1.266861956958631e-01   -5.533649214762978e-02   +2.168930186149470e-02   +1.097211623804177e-01; +4.263862260655978e-02   +4.486834562350829e-02   -2.681196172240596e-02   +2.103848619386758e-02   +2.824854017714042e-02   -4.217408248356709e-02];
L3_L2_iAMPA_netcon = [+1.186801837774437e-02   -4.192889733429798e-02   +7.598020914380457e-02   +5.840126034068738e-03   +2.291821385358005e-02   +8.904380889549814e-02; +4.061979586822079e-02   +2.269903065306781e-02   -9.582010773215941e-03   -3.682954774494814e-03   -5.370155709937983e-04   +1.402723465346882e-02; +3.709106931957736e-02   -3.028326550923488e-02   +3.987740274086717e-02   +1.221001024240678e-01   -2.224850278072751e-02   +2.657434931189529e-02; -7.597373442684428e-03   -1.050950210938612e-01   -2.588098577927484e-02   +7.477419147528214e-02   +4.317748156668761e-03   +6.887682438269280e-02; +9.717667297484667e-02   +2.201531887213797e-02   +4.572418900284159e-02   +3.049380125496070e-02   +3.661817328751581e-02   +6.507709323743294e-02; +4.740106277873854e-02   +3.609392755777555e-02   +4.679271011713365e-02   +5.455802393929177e-02   +1.088403540953897e-02   -3.111191026987028e-02; +8.119156957478646e-02   -2.434269670008250e-02   -7.464198426731980e-02   +2.015954151544691e-02   -4.452976158504809e-02   +4.403631125184194e-02; +2.666657291026466e-02   +8.750167622681826e-03   +7.340718372548873e-03   +1.605919246409210e-05   +1.511600092654015e-02   -4.411882135987172e-03; +5.147954218890505e-02   +1.079992452812542e-02   -1.178524932805656e-02   -1.575240243457103e-02   +8.052683676631830e-02   -4.257009736289662e-03];
L2_L3_iGABA_netcon = [-1.541098336926146e-01   +1.086881776767798e-02   +5.360789355251173e-03   -4.757686624473925e-02   +2.325758214091124e-02   +1.561516661207956e-02   +3.477505821613591e-02   +5.667168156508263e-02   +2.089371922890138e-02; -3.251945475183086e-03   -4.798017839402962e-02   -3.535061428574862e-02   -1.192626203408093e-02   -1.109163188250000e-03   +1.002599124151961e-01   +1.860650969270379e-02   -4.690779648491648e-03   -6.068250850465310e-03; -2.193162031017195e-02   +4.234769125679910e-02   +2.086505846412041e-02   -2.074295001001221e-02   +7.117718970952217e-02   +1.454347838240339e-02   +4.409479917054810e-02   -4.712711834357819e-02   +3.473223797164912e-02; +3.536009461862592e-02   -2.447028260124010e-02   -1.091051831746038e-02   +7.399937146706691e-02   +4.634898169969649e-02   -1.981748207083221e-02   +8.121921558523151e-02   +3.612661343926460e-02   +1.890676201347485e-02; +4.170456072557946e-02   -4.068735833772914e-02   +3.032021160769448e-02   +9.135291485205255e-02   +5.539519891156289e-03   +6.056780068738149e-02   +9.845001643408138e-02   -2.767469780543479e-02   +4.686130333367245e-02; +1.048445747688412e-02   -5.236652213517417e-03   +3.912576287786149e-02   -3.211504870894705e-02   -2.404539370372629e-03   +4.681126673292486e-02   +2.763246706545021e-02   +1.757098293800872e-02   -5.186947860989534e-03];
L1_L4_iGABA_netcon = [+2.580922827056430e-02   -8.644309201145811e-03   +4.202918243110462e-02   +6.628336286023839e-03   -4.095743862425769e-03   +1.006462967516149e-01   -6.151874730869291e-02   +4.680845345560485e-02   -9.567459825658241e-02; -2.595626175447409e-02   +3.343604425105975e-02   +9.492766201810518e-03   +5.380829657303396e-02   +2.995495756768024e-02   -7.162705668533251e-02   +3.091625514094916e-02   -2.466534470193813e-02   +7.611602361857701e-02; +3.857488669303081e-03   +3.258076939392150e-02   +9.775830195637852e-02   -1.438439503774071e-02   +1.609558510226299e-02   -3.833575791808415e-02   -2.521676667017681e-02   -4.566139372415574e-02   +3.487657893615401e-02; -5.476752919439938e-02   -6.929209162292724e-02   +5.174135378843646e-02   +6.313883990709269e-02   +5.795270634773264e-02   +9.693909187853603e-02   -1.965507011167779e-02   +2.366915790836723e-02   +7.171672597383946e-02; -4.408635542681023e-02   +1.053245844679929e-01   -8.233828752982630e-02   -8.342203760291331e-02   +8.560495346787232e-02   -2.724680931064198e-02   +3.013094058375501e-02   +1.004536218505379e-01   +9.469320182824198e-03; -7.170471669665900e-03   +3.517811066754868e-02   +6.725689438701464e-02   +6.971676627128005e-02   +4.796255009355405e-02   +6.697234516548844e-02   -5.650259085119291e-02   +3.686200194387249e-02   -9.233715359739825e-03; +2.820087647999783e-02   +6.023704816607330e-02   +6.845596411292577e-02   +3.827640901246192e-03   +3.402445497405232e-02   +3.189998968159917e-02   +9.183257287790896e-02   +6.842637185581735e-02   -2.796574020509096e-02; +3.846146586162209e-02   +9.083842136284946e-02   +6.630787253098359e-02   +5.273912799662228e-02   -1.066573372882549e-02   +5.216187848625154e-02   -1.542281728367662e-02   +2.230449472715225e-02   +6.119361206613681e-02; +2.231429903348715e-03   +2.466812474000803e-02   +3.505306867465076e-02   -2.423826386765085e-02   +3.771686926546243e-02   +4.659990406955113e-02   +4.480628446883868e-02   +3.214948646252063e-02   -1.900746434212326e-02; +1.295294922431817e-01   +3.079357222676477e-02   -1.780417318329808e-02   -2.462564661133241e-02   +8.035098602381252e-03   -1.889248935435153e-03   +7.406994525307847e-02   -9.728019864927957e-03   +1.040730945926683e-02; +1.018425188008206e-01   -7.928405819332053e-03   +2.095289083695423e-02   +9.588808190003879e-02   +4.162176766785251e-02   -2.429205929628282e-02   -9.576265352986607e-03   -1.569812884121655e-02   -3.335578829624979e-02; +1.004979505879356e-01   +2.491340233882507e-02   -3.231433420586387e-02   +7.437952335267999e-03   +4.807729918912913e-03   -4.851212364084040e-02   +8.976331620634535e-02   +7.447066590776104e-02   +7.251308801058697e-03];
L4_L1_iGABA_netcon = [+4.179427626222308e-02   -3.626724988535934e-02   -3.214487042322053e-03   -1.751271092981941e-02   +6.579716658967349e-03   +4.025252294574904e-03   -1.845980025347940e-02   -5.433999811787947e-02   +4.563110339369492e-02   +3.204983625437934e-02   +4.584319392475044e-02   +3.581031824466837e-03; +6.819272246759178e-02   +1.780717712456264e-02   -5.885790263870583e-02   +2.303706458310949e-02   -7.913088711478007e-03   +3.420855654502113e-02   +4.451098968599560e-02   -1.600797739712279e-02   +2.796964288519022e-02   +5.116888737787226e-02   -7.229478210109511e-03   +9.990668603747558e-03; +3.240819634626022e-02   +4.257819903423080e-02   -2.362701045489709e-02   -1.078923202929798e-02   +1.758816478980334e-02   +2.685232416813325e-02   +8.144119801807666e-02   +5.698322122621548e-02   +5.889889909632787e-02   -2.980923997988500e-02   -6.208109299164224e-02   +1.037900464734462e-01; -5.166785454285117e-02   +4.990305525584672e-02   +1.353188384326995e-02   +9.820482706690004e-03   +5.799893767778253e-02   +6.695422241913328e-02   +2.429936480727242e-02   +2.793771378885312e-03   +4.294076369772489e-02   +8.727749585117106e-02   +9.576091159749438e-02   -3.216033626613997e-03; +3.210875782556238e-02   +3.200120763117575e-02   -3.728903150864982e-03   +3.417888813659238e-03   +2.156097459779786e-02   +9.667891093712974e-02   -1.089981693254525e-01   +4.206509636723733e-02   -3.801743649816800e-02   +6.874955663421629e-02   +7.994446371168040e-02   +9.773942036163434e-03; +3.476423398413135e-02   +1.202991786106135e-02   -4.738514662259913e-02   +4.711644056039477e-02   -9.602885882298590e-03   +4.667173571785711e-02   -7.451471371989385e-03   -2.273748842422567e-02   +5.247538499230286e-02   +9.648596861793619e-02   +2.192585586245004e-03   -1.144609449757973e-02; -6.907414965083034e-02   -3.792366559217861e-02   +2.555723639539432e-02   +1.042764031593144e-01   +2.038266943497146e-02   +5.397206431005202e-02   +3.594974511404618e-02   -8.983527171759496e-02   -6.857787011222000e-02   +9.933874187927888e-02   +3.542367496215983e-02   +1.306867521303635e-02; +4.469508986801297e-03   -4.532441870311298e-02   +1.020184064613724e-01   +4.256595075290082e-02   -2.715464503853817e-02   -3.029553466412171e-02   +6.470177021211117e-02   +4.925414255805546e-02   +3.424867986833370e-02   +2.639336482712884e-02   +9.214785870988174e-04   -1.566038752666900e-02; +7.002215085068490e-02   +2.907165508074897e-02   +7.519419525246709e-02   +4.377329206877401e-02   +1.188585211478799e-01   -8.503074017119062e-03   -5.991192904759510e-05   +8.612707175976307e-03   +1.249875481139412e-01   -5.572770282607765e-02   -2.935896174225308e-02   +2.013325085349068e-02];
L1_L3_iAMPA_netcon = [+4.320351717722178e-02   +1.008100285046113e-01   +1.308512454712757e-02   +5.440856261857484e-02   +5.755560990159388e-03   +6.780285782332335e-02   +9.162770977938473e-02   -2.162806877222619e-02   +5.945246831526117e-02; +1.182547291649233e-01   +8.195851728139761e-02   +1.776228079698031e-02   +1.007037439851881e-01   +6.354432080784693e-03   -2.349534721587556e-02   +8.474426460710684e-02   +8.769234552682101e-02   +2.841416866735870e-02; +2.187243072969408e-03   +6.150847978116948e-02   +8.900587417033863e-02   -2.063370784294349e-02   +2.297194537074892e-02   +1.124498944906701e-02   -4.913429928211555e-02   +1.617529178050563e-02   -2.734809051074515e-02; +6.929969898115219e-02   -3.053544056025252e-02   +3.119460192156005e-02   -8.633125361999169e-02   -2.290098098490287e-03   +3.795302027239585e-03   -2.688859716590474e-02   +7.758353584269453e-02   -2.137959826307627e-02; +3.256020730413726e-02   -1.475858970515603e-02   -2.098326736745761e-02   -1.419182649105778e-01   +1.001388006564728e-02   -3.390356764336154e-02   +1.071310296019305e-03   +6.588090854694809e-02   +6.710653184387975e-02; +3.468599179819132e-02   +1.225180158791255e-01   -2.237114098477859e-02   -1.503159012532001e-02   +3.281848792726941e-02   +6.303198734413767e-02   +4.978977099619236e-02   +2.115564439668854e-02   +1.647891559871882e-02];
L3_L1_iGABA_netcon = [-3.236140519394958e-02   -3.457086141495035e-02   -3.062803837901273e-02   +3.163234817614574e-02   +2.478890981031391e-02   -5.723545461362624e-02; +7.426840913570150e-02   +3.655120783506624e-02   +1.213400872786090e-02   +7.868319390326813e-02   +6.164240018522254e-02   +1.549641962435958e-02; +4.204565404940406e-03   +1.954014479891218e-02   +3.401734743805584e-02   +7.252920086366400e-03   +5.355546784013143e-02   +6.975480590248788e-02; +1.145735112168459e-01   -9.441690980749347e-02   -2.876502306998195e-02   +5.357617039185094e-02   +7.819163019668654e-02   +1.122976608787814e-02; +6.374897170575403e-02   -2.646853806560865e-02   +4.541938976513687e-02   -1.497950870059787e-02   +1.750782722585176e-02   +5.511383833533117e-03; -4.907396144487629e-02   +8.808424344333449e-04   -1.353103445589782e-02   -7.136367177529371e-02   +2.276515404065581e-02   +5.825575021558557e-02; -2.796653180119425e-02   -7.023230002395643e-02   -6.855227657164457e-03   +1.341775718673197e-02   -2.287651230680577e-02   +6.509658569007569e-02; +3.512939705385235e-02   +1.873419386831287e-02   -1.170541213890221e-02   +6.783185425755324e-03   +5.427289793053071e-02   +1.158780738576329e-01; +3.921083663166321e-02   -3.496382755672553e-02   -2.594873607696314e-03   +7.759810356383377e-03   +2.009810800362196e-02   -3.093881439823386e-02];
L5_Input1_iAMPA_netcon = [+1.413503707396983e-03   -7.083027125118549e-02   -3.049273535487016e-02   -7.480980342096177e-02   +3.375220341747850e-02   -1.672011675542767e-02];
L6_Input2_iAMPA_netcon = [+2.704831789612094e-02   -5.959477021010546e-02   +8.223590427831852e-02   +4.680245639332241e-02   +5.403787015150121e-03   -7.852963478156785e-02];
L5_L6_iAMPA_netcon = [+5.096902343725289e-02   +2.715024404541223e-03   -1.398084084672370e-02   +3.575665779654961e-02   +3.642282241857638e-02   +8.819757049866986e-02; +7.255714617227332e-02   +6.166939416616059e-02   -7.279099857025212e-02   -8.101952430902634e-02   -3.122607359873856e-04   +2.677107984333048e-02; +2.832575996604375e-02   +3.224367117648555e-02   -5.411453794430252e-02   +7.107045978473962e-02   +1.027244178280044e-02   +5.409183761601120e-02; +4.449110779161804e-02   +8.431985296518298e-02   +5.068557377424430e-02   +1.324152051397726e-01   -5.018337820320528e-02   -1.355281332411375e-02; +7.981774047505651e-02   -1.101498825830812e-02   +5.385565905349199e-02   +1.987697139981474e-03   -1.193123778488987e-02   +7.204145075658908e-03; -1.967096139324761e-02   -3.616497609612740e-02   -3.565672140972900e-02   +5.352763020607661e-02   +3.823204994507241e-02   -5.165467793028498e-02];
L4_L5_iAMPA_netcon = [+3.935223740616355e-02   +6.414961708143924e-02   +4.818186996824639e-02   +4.157354560046674e-02   +1.797525323210726e-02   +1.704948398035118e-02   +6.318019971363484e-02   +9.454236047846452e-02   -4.160935783947706e-02   -1.683171495978329e-03   -2.267603430455401e-02   +2.777182883325417e-03; +3.596351616828990e-02   +5.782493870717793e-02   -5.534578022263762e-03   +5.018087843782996e-02   +7.169393216507985e-02   +1.206025981190938e-02   +3.569311677538991e-02   +3.451095518658422e-02   -4.498572270186311e-02   +3.017795488242274e-02   +6.460537208326590e-02   +6.636174436891037e-02; -6.437358558652941e-03   +1.026762920475608e-02   -5.612398314313892e-02   -4.109821484272511e-03   -7.319574891694835e-03   +6.365634259070782e-02   +4.338448092852502e-02   +2.280543537125938e-02   +5.309892621046217e-02   +1.103473408273187e-02   +4.301278325297336e-02   +9.596594707716957e-02; -1.760682325983225e-02   -2.304035173959153e-02   +9.046225461201843e-02   +1.216524678054350e-02   +5.092496800121853e-02   +3.476414037605234e-02   +6.652101140113532e-02   +9.889124482255762e-02   +4.364619830912148e-02   +7.692494674408111e-02   -8.906469718873853e-03   +2.885454422699602e-02; +2.700501781669835e-02   +1.257773430479418e-01   +1.001350893581621e-01   -2.413523108833027e-02   +5.321338391328254e-02   +8.766362517434440e-02   -1.191117413085329e-02   +5.290365882321749e-04   -6.762853535613254e-03   +2.743951439616251e-02   -5.343169010340488e-02   +1.047613357066507e-01; -8.107272595831239e-02   -4.485325710613445e-03   -5.472127855546505e-02   +1.497355377806475e-02   +1.561302243437819e-02   +1.175905889999374e-01   -1.330370823538792e-02   +6.899837644548265e-03   -6.451828696336658e-02   +3.082630400448766e-03   +6.094184665751425e-02   +2.985891270844327e-02];
L6_L4_iAMPA_netcon = [+6.230049432609230e-02   +4.388941634343074e-02   -1.029160287840093e-01   +4.415861813337692e-02   +1.232495821285306e-01   -1.284872441721981e-02; +4.352659295404933e-02   -3.261214448415620e-02   -2.315490775914749e-02   -2.657247007978808e-02   +2.131373157400120e-02   -2.999210596278894e-02; +3.979514466272593e-03   +3.078182704542437e-02   +2.776523081427053e-02   +1.113266957965383e-02   +1.920505418594427e-02   +9.110733477492150e-02; +2.734722406676469e-03   +5.550583771461978e-02   +1.019649126801010e-01   +8.309977435709029e-02   +3.009385473615633e-02   +6.097566687562327e-02; +1.564284225757633e-02   -1.544501043991576e-02   +1.206394391996636e-02   -2.148221588396184e-02   +3.245335089105199e-02   -5.842222748996621e-02; -3.607995296365160e-02   -7.198443055234853e-03   +1.309536473531456e-01   +6.983653538573473e-02   +5.865282388866951e-02   +4.503277106661795e-02; +1.168121004941626e-02   +1.754559567059806e-02   +4.843915064151816e-02   +1.037952904580864e-01   +3.808930796515626e-03   +1.580079466073170e-02; -4.586069261711065e-02   +7.996090341144231e-02   -5.895558240083203e-02   +5.241910556805833e-03   +4.648000117783450e-02   -5.837362455380321e-02; -1.623982859512074e-02   -2.540206470541338e-02   +1.827416685493474e-02   +3.983054738855137e-02   -5.560715378138050e-02   -8.669957463416363e-03; +3.753936708757802e-04   +7.380980040251713e-02   +8.514685909036368e-02   +1.380209203684796e-01   +8.056308395797347e-02   +3.103219792547859e-02; +1.023410723076769e-01   +6.089637866153698e-02   +3.651663897796070e-03   +2.200345366320716e-02   -5.181889007692997e-03   +3.303060650861171e-02; +8.687365698040930e-02   +7.017413583976854e-02   -9.693102546668509e-03   -3.765605937676143e-03   +1.217372793122879e-02   +7.376458489836074e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
