function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.176307690292801e-01   +4.918589672443155e-02   -7.705630872987422e-02   +1.435391056474702e-02   -9.353756081432976e-03   -7.882351028241069e-02   -5.249241947407690e-02   -6.849230447668884e-03   +4.473053022582055e-03; +6.203723175108675e-02   +9.809853957009332e-02   +5.497688871865683e-02   +5.295394545907156e-02   -8.877294671085205e-02   -3.810243695657928e-02   +7.782183550795450e-02   +1.099167517323926e-01   -2.597574269162803e-02; +4.407655903758840e-02   -6.013209931450794e-02   -5.000383101700627e-02   -1.113219345418577e-02   -1.494586022460212e-01   +5.130806340430287e-02   +7.171852839752757e-02   -3.563252999315061e-02   +1.965008170795085e-02; -6.244815736272613e-02   +8.185794372123631e-02   +2.033594126158496e-02   -2.859678921405182e-02   -4.347363147335642e-02   -2.609464685811108e-02   +4.466943135030374e-02   -2.761107258996907e-02   +1.462443992065077e-01; -9.894940321145664e-02   +4.383596095454531e-02   -3.054520161678364e-02   -9.300392945447988e-02   +1.308995275515740e-01   -2.789843937284570e-02   +6.717458810433069e-02   -6.745055849257445e-02   +4.381324197309771e-02; +2.500716963370998e-03   -2.089229328520311e-02   -8.832044527900509e-02   +1.978468337173196e-03   -4.445899948590851e-02   -5.780359383831217e-02   -3.891342382192199e-02   +1.285652890616948e-02   +1.479385661535936e-01; +1.223644548977999e-02   +1.281990670973434e-01   +9.186277126598512e-02   -1.150976977190281e-01   +2.177485743600642e-02   +1.719922876397296e-01   +1.227572018016719e-01   -2.609130293635093e-02   +1.226657884811252e-01; -1.008040124856281e-02   -1.149283861355158e-01   -6.231043621423514e-02   +8.953200872881947e-02   -1.416177865191437e-01   +4.271437247178844e-02   -5.190416419164996e-02   -8.305703555394566e-03   +1.864236790001394e-01; -4.321856550762268e-02   -7.120341505730884e-03   -5.150161226300254e-03   -1.151466110734209e-01   -8.514420134465921e-02   +1.862961436710331e-02   +2.752047385526935e-02   +6.208212634458314e-02   +1.023605438415633e-01];
L1_L2_iAMPA_netcon = [-9.360473662477858e-02   -9.744456432897430e-02   +1.185591962584459e-01   -6.569670240108373e-02   +1.451045676469552e-01   -1.190477556963496e-01   -1.687609031305249e-02   -3.254867462852808e-02   +5.422023762413367e-02; +1.035456576826111e-01   -7.248327822603402e-02   +3.116004366574271e-02   +5.509888078699639e-02   -7.149755040119821e-02   +8.019149827947679e-02   +5.484671480455990e-03   -1.394502255992125e-01   -7.592269882514230e-02; +6.322227876224955e-02   +5.651347627171356e-02   -4.500530615167277e-02   -4.320058803448298e-02   -6.545001422327545e-02   +3.087188902210815e-02   +6.695580126885062e-02   -3.833697988741099e-02   +2.190040696603340e-02; -1.841369868285134e-01   -1.318724447228680e-01   +5.059041174749146e-02   -5.266768894941855e-02   +5.108500908767723e-02   -4.095187783887651e-03   +6.724618823121697e-02   -7.214794920707962e-02   +7.222137097629197e-02; -5.686149138005060e-02   -5.260748799982323e-02   -7.733660060119724e-02   -6.467283306527837e-03   +6.379651697197902e-02   +1.233166987356875e-02   +1.084436907350288e-01   +9.442953889993293e-02   +1.933630129599335e-02; +3.184509512230670e-02   -1.482818932539909e-02   -9.302804924129705e-02   +8.402839098154545e-02   -1.537413091662153e-01   -1.589068562847053e-02   -1.294332318306442e-02   +1.096977798533430e-02   +1.182332215295077e-01; -1.664348267730109e-02   -8.959214872943939e-03   -8.283321033969276e-02   -6.744184921616229e-02   +1.083896174654622e-01   -1.343828705308746e-01   -8.715063626643610e-02   +1.043650533350504e-01   +8.645323701463294e-02; +8.707900751938717e-02   -2.368605653937104e-02   +4.711528654954637e-02   -7.764463199570287e-02   +2.978592614101677e-02   -1.900691130167807e-02   +3.045647036168596e-02   +9.147621062777622e-02   +1.090768958306432e-02; -1.315630328439543e-02   +3.936384708659718e-02   +5.549782676653907e-02   +2.598111371737017e-02   +3.545197183406826e-02   +7.729031490268916e-02   +1.303525442333509e-02   +1.020020894898385e-03   -1.494394816398580e-01];
L2_L5_iAMPA_netcon = [+7.502079375839586e-02   -1.713672143394889e-03   +5.883653006565152e-03   -9.635957493466643e-02   +1.872665296424726e-02   +1.338332464995737e-02   +4.793246574816398e-02   -9.772379452093490e-02   +2.820984185680005e-02; +1.665498744090015e-02   +1.647251582503725e-01   -3.495248268784736e-02   -1.158796634629103e-01   -1.254370731172093e-02   +4.958696972248887e-02   -1.377493493921516e-01   -1.538453799748644e-02   +2.255356698063538e-02; +6.807716300686983e-02   +7.417060111678897e-02   -9.043241272523427e-02   -3.041262324449016e-02   +1.167251850864648e-02   -1.779930892479642e-02   +7.598172641360103e-02   +3.264308646842376e-02   -5.757032039841806e-02; -1.460473958066319e-02   -1.028095358342671e-02   +6.524679749038134e-02   -5.345438237233090e-02   -3.808950622077997e-03   -4.554396614482560e-02   -1.506012799731905e-01   -2.273728675446111e-02   +1.651556997862242e-02; +7.461710382917706e-02   -9.448544537113518e-02   -1.594125408855190e-01   -3.496154322807225e-02   +6.503357624587219e-02   +5.058840830000590e-02   +1.707379316605336e-02   -1.363038061297020e-01   -3.947437962722868e-03; -2.024459333694515e-01   -2.091012437821533e-02   -1.385027785594702e-01   -1.669148574494312e-01   +2.462252956857270e-03   +9.059313667389682e-02   +2.827927946666082e-02   -1.116538093321028e-01   +1.073546188939215e-01];
L5_L2_iGABA_netcon = [-2.471096827993539e-02   -4.626188648348576e-03   -8.027356154628060e-02   -8.713839060600668e-03   -2.245149317914866e-02   -9.653641327402651e-02; +6.696774446370109e-02   -1.304415881697927e-01   -7.106304517639805e-02   +3.729708929292994e-02   +1.189921478947955e-02   +3.078179261379455e-02; +7.387738302168062e-02   +4.809353242096861e-03   +2.106629898265811e-02   +3.380384225390469e-02   -5.128383731612891e-02   +2.607411834694207e-02; -2.833062624477498e-03   -8.041126486134208e-02   -5.898821341096658e-02   +5.896417149594543e-02   +3.618744661179892e-02   -6.275540945906322e-02; +9.510157340671038e-02   +4.194191192132845e-02   +4.655759444023879e-03   +7.692603355490418e-03   -5.877073295905418e-02   +6.550945914473158e-02; -9.362899898588428e-02   -3.083922855328450e-04   +1.692615825091343e-02   -4.313965920093663e-02   -1.963341740152186e-02   -6.691005261678754e-02; +2.228234315466875e-02   -8.828602538365242e-02   -8.678641375358592e-02   +9.052759634761205e-02   -6.748152350483175e-02   +2.434176892794661e-03; +1.596845430248280e-01   -7.407332421478914e-02   -7.052284238495753e-02   +1.634406128048794e-01   -7.566107418374882e-02   -6.908454283063353e-02; -6.330532256762872e-02   -3.358024335343380e-02   +2.790988348942189e-02   +7.164361353159081e-02   -6.290674047982463e-02   -9.330996734746017e-02];
L3_L2_iAMPA_netcon = [-1.654967894435904e-01   -3.012112085258631e-02   +2.780816164421097e-02   -9.686156026984158e-02   -9.752273671928086e-02   -5.127885108998304e-02; +2.607277422846343e-02   +1.140092241690835e-01   -1.172101949242819e-01   +4.432969346166498e-02   +9.795179712854441e-03   +1.854531462185325e-01; +5.351500545103194e-03   +4.605055704794934e-02   +7.504842916677539e-02   -8.501730211824172e-02   +1.267978289333550e-01   -9.822479659546339e-02; -3.048871900223137e-02   -5.180939667356536e-02   -9.345793854316081e-02   -3.892694545025969e-02   -5.276878320111476e-02   -2.643594967496682e-02; -3.655714404189357e-02   -3.301221473926057e-02   +3.758943201363889e-02   -7.981407335620989e-02   -1.714443488473305e-01   -9.213496204848244e-03; -3.663082819859070e-02   -8.787198523809203e-02   -1.462473844035046e-01   -1.407487468531072e-01   -6.701139269223773e-02   +1.422789147324511e-01; -7.904091795112488e-02   +8.800462262837015e-02   +8.734278264265534e-02   -9.366336732407786e-02   +7.585908018854690e-02   -2.957542187444528e-02; +4.981944054537679e-02   +3.943176972571086e-02   -1.385272702879488e-01   -3.529777621541443e-02   -6.708349906884946e-02   -8.908339770573298e-02; -1.013652710869392e-01   +4.218119983525423e-02   -6.344304034219816e-02   -5.529158465581620e-02   -1.846955192453710e-02   -5.100012568962425e-04];
L2_L3_iGABA_netcon = [-2.712059074988186e-02   -3.341785177096111e-02   +9.111744632273105e-02   +1.005176015216424e-01   -7.752278350580602e-02   -1.015963694290862e-02   +7.429309241775944e-02   +4.569643842467554e-02   +1.472440012264483e-03; -9.796539004341459e-02   -7.966601927125323e-02   -5.446985321067178e-02   +1.380062720956560e-01   +5.547810028027263e-02   -9.133695241772863e-02   -5.885120790740202e-02   -8.409792127600388e-02   -2.162185820684400e-02; -6.524364118116446e-02   -4.446875139294368e-02   +4.274131078940528e-02   -9.866125788700481e-02   -3.171652311639265e-02   +1.530373098740631e-01   -2.508504601311445e-03   +1.018532886799160e-01   -1.156584525704090e-01; +5.213008723837521e-03   +6.801574097976258e-02   +6.638129849573032e-02   +1.001560291563652e-01   -5.671261123926626e-03   +1.430479597506793e-01   +4.913751351450030e-03   +7.352165550268604e-02   -2.227199912316032e-02; +5.704389634247581e-02   +8.261780640765329e-02   -9.413485519485205e-02   +2.523791864457323e-03   -1.744234421021924e-02   +7.684062050671021e-02   +1.111007322155591e-02   +7.554042062404930e-02   +3.740187799073634e-02; +1.058911505134075e-01   -4.098298329979286e-02   -4.429435862330757e-02   -1.247537774270347e-01   -4.704764717159642e-02   -3.509446105796184e-02   -8.507488012693207e-02   +3.755538221091435e-02   -1.569580030895080e-01];
L1_L4_iGABA_netcon = [-4.425254320454161e-02   -4.004235488179528e-02   +8.891253952066634e-02   +2.753812930961673e-02   +1.856379764106250e-01   -1.291731166395735e-01   -6.008456917560790e-03   -2.020700261933722e-02   -5.450147568632794e-03; +5.485224434547561e-02   +2.284314473828966e-02   -3.265237726114326e-02   -1.544935720706134e-01   -5.544212732037197e-02   +1.405118608226585e-01   -6.164447345372950e-02   +2.838868346129553e-02   +1.609173146069868e-02; -4.494810274709525e-02   -3.430384940245990e-03   -8.137727357626653e-02   +1.282459022891811e-01   -1.110651681352205e-01   -3.435035093933096e-02   -1.364023784102296e-02   +6.343398107669616e-02   -1.835864598873650e-01; -2.163645192396544e-03   +4.390580007251305e-03   +2.817682277213290e-02   -6.950279142352395e-02   -6.401697732224527e-02   +2.261478092613222e-02   +5.387258187430853e-02   +4.310622186744843e-02   +1.475241355612206e-01; -1.376550392527238e-01   -7.081858581599110e-02   +2.500767367468478e-03   +6.982206676959020e-03   -9.073142913377853e-02   +4.088593343506810e-02   -9.450800583785243e-02   -3.515272191569110e-02   +2.805513726230956e-02; -1.013416897140065e-02   +9.915367635244424e-02   +8.853411351814257e-03   -4.297302827474045e-02   +1.825404155133260e-02   -2.890165532939443e-02   -1.650843011596639e-01   +2.226974350880220e-02   -1.751539284804368e-01; -1.946730078141175e-02   +8.860935649635331e-02   -1.185837432861288e-01   -4.276688437757863e-02   +1.306502191415064e-02   +4.106428129868622e-02   +4.075958223088422e-02   +2.806106140956419e-02   +1.595108724743850e-01; +1.221582477884232e-01   +1.256823155573504e-01   +6.491770372730926e-02   +7.059201925144788e-02   -8.519316083691462e-02   +6.131840889763572e-02   +6.565604149952273e-02   -6.920030555753877e-02   +6.225080557642976e-03; +5.804208575988952e-02   -1.153349949226128e-01   +6.265613494807962e-03   -7.809315772136068e-02   -1.281716255885848e-02   +1.405906930340181e-01   +1.478858960175058e-02   -1.516535884313130e-01   +1.125964620015089e-01; +1.095828242918627e-02   +6.795055475614600e-02   -1.616498321615448e-02   +1.572047935062986e-01   +3.587650883620994e-03   +5.262165334756416e-03   -1.135401273147037e-01   +6.948769941886147e-02   -5.827879357300364e-02; +3.267378279897305e-02   +6.776968420401906e-02   +8.658391473161205e-02   -3.909309721612521e-02   +1.795418397274438e-02   -8.722219988026242e-03   -9.684049968933754e-02   +1.423390632883502e-01   +1.339140834693822e-01; -4.501011075200642e-03   -2.508180685629232e-02   +5.512156705182027e-02   +8.009065611490755e-02   +7.246098413301606e-02   +2.010873907371938e-01   +4.717048047589503e-03   -1.234545149433215e-01   -9.009247502862677e-02];
L4_L1_iAMPA_netcon = [-9.529942885997711e-02   +9.627049052750167e-02   -4.881617378515425e-02   +2.485587653030946e-02   -5.506253580303702e-02   +3.214580381673347e-02   +1.113647371124750e-01   +3.227631463476707e-02   -2.604434421731689e-02   +1.760165380638243e-02   +2.305376152887908e-02   +3.515073036521047e-02; +4.032809400233080e-02   +7.968649352198157e-03   -1.114917020460273e-01   -8.301243859729091e-02   -2.909661531466010e-02   -3.824859173335331e-02   +6.416338322609839e-02   +1.013057270090865e-01   +6.556022355232304e-02   +1.380285832051664e-01   +6.552409412078934e-02   -9.879143649578492e-02; +2.444025668272828e-02   -9.817031108668227e-02   +3.578072328470724e-02   +2.496994199084005e-02   +8.692130280299849e-02   +5.480715292686862e-02   +8.664003748480859e-02   +2.967452335365590e-02   -3.923141529868885e-02   +7.038356279163929e-02   +1.561175033984079e-02   +9.021214435194612e-02; -7.811911924306546e-02   +9.019443836161199e-02   -1.210845424463699e-01   +5.365512714805642e-03   -6.134423404375661e-02   -5.741236103692890e-02   +7.498897726389754e-02   +9.540087648378186e-02   +1.697009021839477e-02   -7.514150484965330e-02   -8.629596873844264e-03   -5.884599582373339e-02; +8.781762051738720e-02   -3.823447002186581e-02   +2.277717082556722e-02   +3.270529713501248e-02   -6.097156055926171e-02   +5.509078012195175e-02   -1.844541654422522e-03   +1.510733938467774e-01   +6.020750453570185e-02   -9.131013968193284e-02   -6.869121470541822e-02   +1.028410985130076e-01; +1.118530863660196e-01   +4.527603900359813e-02   -6.294291516550216e-02   +1.543030382193378e-02   -8.734220829808396e-02   +1.194125309866085e-01   +1.510095813606669e-01   -1.150341743001832e-01   +1.237261402127694e-01   -2.071964213325567e-02   +6.978057574853954e-03   +5.192990525153814e-02; -8.234209905619085e-02   +2.325464236024036e-03   +1.483122810128332e-02   -1.444800735794802e-01   -2.862042984234010e-02   -8.846016839786461e-02   +1.913456850101392e-02   +3.873029642012353e-04   -1.309314001980850e-01   -8.060984108345096e-02   +1.059032781093381e-01   -2.230367745453942e-02; -5.862401510870950e-02   -5.215897766001484e-02   +1.313071214799102e-02   -2.500414103754757e-02   -3.082917947047368e-02   -9.770233752227787e-03   -5.426654714300753e-02   +8.749411163296852e-02   -2.252953942995496e-01   -4.855028077797867e-02   +1.216598745665412e-01   -1.022502141230934e-01; -5.100602058435887e-03   +2.229177055432159e-02   -1.167052964790515e-01   +4.264637534846055e-02   -7.162303713480567e-02   +8.890157608646169e-02   +5.905733582180707e-02   -3.964449556264837e-02   +4.548184105173005e-02   -1.579284820621866e-01   -5.237835243767849e-04   +8.676477192330466e-03];
L1_L3_iAMPA_netcon = [+3.570529061313511e-02   -5.237151519369605e-02   -1.670098500391418e-01   -5.485137965984995e-02   -1.574852206273958e-01   +2.409450452581631e-02   +9.199857519422179e-02   +5.861142327083367e-02   -1.474348722052121e-02; +2.557965068406066e-02   +1.510861487310909e-01   +9.881362348882357e-02   -1.076367596759225e-01   -5.525830643222079e-02   +6.700172451916055e-02   -1.417663462871364e-01   +1.651646103854788e-02   -4.976161851375980e-02; +1.060848323954482e-01   -5.062109422801961e-02   -1.172848370579125e-01   -1.489282874399924e-01   -1.044485097984574e-01   +1.539282910565779e-01   +1.512568350767419e-02   +5.869550305809196e-02   -8.083000409292758e-02; -7.087933950639658e-02   +1.265954953646021e-01   +1.044819317752389e-01   -3.570105126413700e-02   +7.772777717361473e-02   -3.421531454724996e-02   -5.326983569695487e-02   +4.262700639232495e-02   -6.328706342871131e-04; +1.464843527972128e-02   -4.846278798048037e-02   +7.298225476639772e-02   +4.774876061207081e-03   +2.121185386219858e-02   -1.052765382303966e-01   -6.888445757857141e-02   +2.983329014442331e-02   +1.189446892757641e-02; +6.578950530517397e-02   -3.965791914890233e-02   -9.709084652646242e-02   -1.593908011985627e-01   +2.549104539140964e-02   +1.331776771874988e-01   +2.639594476756080e-02   +1.120388752099164e-02   +1.128954635339496e-01];
L3_L1_iGABA_netcon = [-2.605849308956391e-02   -8.236922866976006e-02   -8.035092648238681e-02   -2.076371740805016e-02   -4.491685787943298e-02   -1.333336859855039e-03; -5.867544919684504e-02   -1.044545828008307e-01   +7.165122630417112e-02   -6.520061758540033e-02   -4.129980745496286e-02   +1.045184900816315e-01; +6.340511720048357e-02   -6.008493113739389e-02   +7.343194121608708e-02   +1.244570454795460e-01   +3.116030325553300e-02   -7.642648468296961e-02; +5.716101774991666e-02   +1.557943669286687e-01   -1.228945957051761e-01   -1.299811730862633e-01   -3.172028254279749e-02   +2.324425280696893e-02; +7.265364279833743e-03   -7.585640357651104e-02   +4.177886567714482e-02   +7.799724759559168e-02   -9.357544938182058e-02   -2.480664284364296e-02; -1.020539150638854e-01   +9.949933240106391e-03   -1.389702011613736e-01   +1.043762902428323e-01   -5.419570577305724e-02   +1.607776479956319e-01; +8.156663727022884e-03   +5.213044169665163e-02   -9.325036171688637e-02   -6.003268380857353e-02   +2.170401450093735e-02   +3.945918982081197e-03; +6.870045377715558e-02   -4.421974854408772e-02   +1.194979964122088e-02   +2.796005130218716e-02   +5.963330349343035e-02   +1.527570236119312e-01; +5.898058934299349e-02   +9.508754694830088e-02   +6.563103171895297e-02   +1.678074119378429e-02   -3.442272029954642e-02   -2.537729584334596e-02];
L5_Input1_iAMPA_netcon = [+5.803609000665703e-02   +1.234187728998038e-01   +7.661234502931301e-02   +6.463630108264599e-02   -1.834199356189635e-02   -1.937984615554698e-02];
L6_Input2_iAMPA_netcon = [-3.382437381202452e-02   +9.312253723128544e-02   -2.812726793473289e-02   +9.455429765202032e-03   +1.068133842041811e-01   +1.047471865500343e-02];
L5_L6_iAMPA_netcon = [-1.083787505615849e-01   +6.021017169750399e-02   +1.510210111539106e-01   -9.216345899841077e-02   -1.336468039973948e-02   -6.617728922014142e-02; -3.407490780333318e-02   +4.416043080540911e-02   -1.007540753932322e-01   +1.089712574808943e-02   +4.009161385860081e-02   +3.547473034707529e-02; +2.762420528616176e-02   +1.158063935972806e-01   -2.682178933395921e-02   +4.018876426286498e-02   +1.482807463276216e-02   -1.533373051414930e-01; +7.878552422584889e-02   -7.456926231278722e-02   -1.393345435222640e-01   +1.124444979060873e-01   +1.106630031187090e-01   +4.132912666162890e-02; -6.310027712129505e-02   +9.544001189079060e-02   +6.061696326673319e-02   -4.564605764090726e-02   -3.833634406155876e-02   -5.542412730456717e-03; -5.885116375376780e-02   +6.260286856786110e-02   -5.259918662395040e-02   +9.775337372524531e-02   -6.202358475183772e-02   +1.158373039122778e-01];
L4_L5_iGABA_netcon = [+1.138761802760054e-01   +3.253287779115885e-02   -7.290324243214362e-02   -3.384076881437798e-02   +8.138416891128902e-02   -4.893827428174735e-02   -1.132689917863522e-01   +1.379745823220866e-01   -1.173618326141304e-01   -3.522373513287427e-02   +6.512224194301468e-02   +1.006275776533499e-01; -3.768571052530984e-02   -5.846090415716439e-03   +3.668432083827109e-02   -3.982818437826848e-02   -1.214389969700401e-02   -1.802878474973327e-02   +2.257172164797041e-02   -1.120106525003782e-01   +9.735036310328012e-02   -8.172820593684271e-02   -4.497638336382182e-02   -1.635030958515791e-02; +1.479275853497845e-02   +6.133823876539026e-02   -3.498354049167580e-02   -2.894568022923660e-02   +1.880091539848389e-03   +1.177884252274309e-01   +7.917094031568335e-02   -6.286161844838865e-02   -1.090913421699671e-01   -6.595114123319805e-02   +2.130644825382355e-02   +1.473198877531181e-01; -3.766555755705948e-02   -1.957936861901915e-01   -1.196048240171747e-02   -2.607294838768424e-02   -1.103154952299688e-01   +2.253921076285439e-02   +7.676272638344882e-02   -2.681203099131791e-02   +3.551490324196946e-02   +1.344815518931637e-01   +3.219818551486912e-02   -3.805001121099640e-02; +4.416554008784282e-02   +1.319080854065990e-01   -9.398617941594486e-03   -4.240370243922458e-02   -9.881048395936207e-02   -2.642102458410623e-02   -1.305537642792551e-01   +4.520442046345984e-02   +5.643445991692098e-02   +2.765097937315494e-03   -4.559391117466415e-02   +1.643836345266143e-02; +2.140616083817938e-02   +5.461772388863113e-02   -4.474504150934301e-02   -5.256154403279263e-02   -1.811186527788176e-01   -1.439485094658409e-01   -5.319209170568530e-02   -3.637300893988658e-02   +6.329234006757857e-02   -7.802303956049300e-02   +7.443678865069016e-02   -1.318139278125765e-01];
L6_L4_iAMPA_netcon = [-4.283151397057267e-02   +5.715404511499213e-02   +3.768510607717934e-03   -5.870665376937202e-02   +6.411486852160017e-02   +2.240414061235947e-01; -6.316433648620152e-02   +9.644526915327369e-02   -2.043683125312258e-02   +4.013023255953012e-03   -8.990452753802411e-02   +1.412473352018467e-01; +1.477866076016013e-01   +2.239131213839168e-02   -9.061698383784744e-03   +8.846473174531959e-02   -4.649467565233378e-02   -6.771044023713810e-02; -2.139903387314838e-02   +8.327711726924484e-03   +4.924809202383832e-02   +9.884206493038486e-02   -1.491798442407930e-02   -4.051926064068752e-02; +7.377200647591058e-02   +7.236193768825694e-03   -6.205018024777677e-02   +3.144537161796045e-02   -9.689208061304841e-02   +2.922829111722743e-02; +1.413102910759106e-01   +5.913712044098813e-02   -1.135387711280918e-02   -1.061337891711521e-02   -6.159660599601947e-03   -9.312748908505855e-02; +1.090138797875500e-02   -2.907136289939609e-02   -3.074710758394614e-03   -1.084624129627450e-02   -2.396757520740660e-02   -3.455421505075131e-03; -5.450243005741411e-02   +8.404149381262480e-02   -1.180644048139133e-01   -7.114023178546280e-02   +9.477653857396834e-02   +4.896519085999729e-02; -1.915097300675291e-01   +8.081671686208834e-02   +7.634530543254460e-02   -1.085446354779670e-02   -9.574742769038569e-02   -7.566696015222335e-02; +9.114207363713300e-02   +5.143273862234912e-02   +3.214430569586389e-02   +1.522964482913495e-02   +2.557788686561475e-02   -1.031132606748894e-01; -6.407105747710309e-02   +5.772674829981719e-02   +4.082804694167190e-02   +1.055243098399089e-01   +7.686666691413140e-02   +1.447069433370050e-02; -3.025822332466254e-02   +1.930174816887351e-03   +9.112319862607109e-02   +8.446661263602603e-02   -1.485900823999002e-01   +6.009039072852068e-02];
L5_L4_iAMPA_netcon = [-5.303837711487454e-02   -1.748138825799002e-02   -2.375412190016919e-02   +3.175943758364857e-02   +8.603568289119476e-02   -1.428236163481094e-03; +3.549866567172260e-02   +3.334276202653668e-02   -8.831489970277853e-02   +3.621017823127101e-02   -6.373817762001391e-02   +6.923352927957505e-02; +1.414171833178216e-02   +7.132057397263421e-02   +5.817152617045209e-03   -1.045612122571232e-01   +5.432120813423984e-02   +8.691017640740094e-02; -8.978977530157807e-02   +3.946365507826944e-02   +1.026423758857164e-01   +1.072895492392348e-01   -8.199061318966926e-02   -4.987611398108172e-02; -5.391427145481487e-02   +1.053822728814534e-01   +3.284311252763631e-02   -7.071559273980840e-02   +3.840057838519677e-02   +2.130079440103075e-02; +8.625295729329305e-02   -4.273623908020465e-03   +7.179804407209436e-02   -2.633308651846165e-02   +1.111402635304227e-01   +5.487235025868105e-02; -3.986076498505813e-02   +1.212345874583677e-01   -6.008092077740142e-02   -2.578644051609827e-02   -4.148913830874729e-02   -7.082004787442969e-02; +1.271761600777965e-02   -4.486773078185664e-02   -5.090818634563771e-02   -6.192990510186603e-02   +8.285893029949462e-02   -1.146489188359325e-03; -1.158534191943264e-01   +1.082155290093322e-01   -9.364573917987363e-03   +5.156712718329373e-02   -1.250568117943276e-01   -1.458934118882905e-02; +1.082237118692108e-01   -5.834082361719323e-02   -1.101140115265442e-01   -9.789814897683520e-02   +7.806191625094891e-02   +2.209250766531068e-02; +3.724195838718945e-02   +7.751066023471588e-02   +6.460937343357596e-02   -4.103843002775746e-02   +9.343847274291082e-04   -9.189759278070764e-02; -7.017738462286266e-02   +1.800793175357206e-02   +2.991658675099554e-02   -5.392749256782642e-02   +7.260085191929883e-02   +8.853887938493085e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
