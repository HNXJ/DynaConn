function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.294466992246761e-02   -5.995686117374416e-02   +1.522112635232262e-02   +3.468690470938155e-04   +1.148081457130142e-02   +3.864541072564738e-02   -2.676816435804524e-02   +5.799225166814465e-02   -1.035966053232773e-02; +2.311451934207708e-02   -8.110619921969721e-03   -2.666134835299056e-02   +1.296852694852721e-02   -1.260804999788671e-02   -4.324900517772250e-02   -4.853517012290445e-02   -1.740714008158793e-02   +2.097238324152348e-02; +3.053234885878986e-02   -2.155229132590356e-02   +5.770150312228006e-03   +2.116659065583731e-02   -3.040169973269255e-02   -4.445564043276166e-02   +1.898693230644482e-02   -3.945789772352105e-02   +6.548476734916640e-02; -1.013204303684109e-02   -1.653204418434530e-02   -5.736381670112717e-02   +6.675520894876540e-03   -4.029489469937475e-02   -1.641443345516623e-02   +1.715304691994964e-02   -7.352662049418431e-04   +4.169215731900609e-02; -6.715857908833178e-02   -6.466983426078719e-02   +1.093796118789290e-02   -1.890798225366248e-02   -5.417562825785863e-02   +7.191408319728462e-03   +1.194890027199390e-02   -8.822440413276391e-03   -1.064729412078419e-01; -2.922540962097712e-02   -4.592654738777539e-02   +1.105961441680950e-02   +4.360577097004072e-02   -9.462886672216821e-03   -7.037947949800900e-02   -1.324022170557038e-03   -2.505039640252719e-03   -2.444320471430326e-02; +1.172961401892657e-02   +4.375604867850540e-02   +1.063241795161926e-02   -9.362261552442810e-05   +1.555328875572339e-02   -5.122000585428534e-02   -3.064138633103478e-02   +6.476250192630877e-02   +3.591976365900199e-02; -3.131385809546012e-02   -5.044279831636488e-02   +3.145042621284824e-02   +9.551570718969896e-02   +3.564821247284513e-02   -5.532395230488116e-02   +2.590425906761240e-02   +3.291584273802212e-02   +1.571484457737973e-03; -1.886836461382211e-02   -1.039250699616950e-02   +2.889186549407799e-02   -2.223107244120000e-02   -9.857275175945399e-03   +4.827547366300756e-02   +2.124936598205764e-02   +5.787371418900110e-02   -1.945635907986870e-02];
L1_L2_iAMPA_netcon = [-2.875824770585344e-02   -9.633820495678937e-03   -4.705754053055368e-02   +3.356508954459825e-02   -1.792685534116075e-02   +5.553231385433621e-03   -1.881889783022422e-03   +3.715318002882356e-02   +1.798444610691055e-02; -1.098139778293650e-02   +5.809352360940197e-02   +1.000932562116289e-02   -1.559091220177175e-02   +3.557522955151336e-02   -3.485593276652773e-02   +3.524197449032970e-02   +1.062737975470744e-02   +1.802432570056407e-02; -4.901744449058926e-02   -2.441376971329536e-02   -5.679129063296802e-02   -3.459205711227761e-02   -3.204694267632947e-02   +3.057011145956085e-02   +7.620169580706944e-02   -9.359219725886826e-02   -3.407365707997975e-02; -9.258480817407064e-02   +8.106692181682430e-03   +4.717208864817603e-02   -4.592775948767899e-02   -6.656955250004058e-02   +5.993098346294155e-02   -3.203133606857358e-02   -1.585021711624086e-02   -1.569452320026889e-02; -3.511459969641744e-02   +6.801746208642830e-03   -5.267260611810502e-02   +4.751775370646296e-02   +5.090890414049556e-02   +1.480767776530624e-02   -3.821602248700467e-03   +3.671780639247547e-03   +3.096324789795885e-02; +2.064842351727343e-02   -5.950010679311476e-03   -1.152116160184558e-02   -1.944721928797382e-02   +3.014159145908728e-02   +1.489215296225584e-03   +2.169515138238349e-02   +3.763426085917308e-02   +3.923074511400328e-02; -2.023176643450138e-02   +6.421653939510026e-02   -4.713004082806177e-02   -1.240387416944930e-02   -4.516287178512773e-03   -4.724419164412486e-02   +2.415395804099643e-02   -1.374132063496833e-02   +1.473290032535631e-02; +2.605445082936920e-02   -6.055140784979769e-03   +6.709463614926241e-03   -5.703969645439680e-02   +4.311565182445817e-02   +4.448911267446444e-02   -4.142482405788438e-02   +5.397589113675902e-02   -1.724704193052300e-02; +1.795516587435862e-02   -3.342501400965724e-02   +1.656397813878871e-02   +6.577193030072506e-02   -3.534848095603663e-02   +4.843813394412831e-04   -2.723347076032114e-02   +5.670365417444210e-02   +2.480203617393063e-02];
L2_L5_iAMPA_netcon = [+1.502538328822148e-03   -5.131344546398958e-02   -3.492656776682557e-02   +7.202526662076662e-03   -4.075230678903700e-03   -5.336586709700220e-03   +1.778250752182555e-02   -4.163377078115323e-02   -1.573760145961713e-02; -2.127409696917833e-02   -4.416281468313341e-02   +7.690701430964647e-02   +2.977795125171602e-02   +1.754942250642079e-02   +8.637001322329444e-03   -2.951632684051256e-02   +6.806178385848244e-02   +2.316599421143809e-02; +1.120218031255488e-01   -2.701264170884208e-02   +4.878544636341359e-02   +7.393582401882887e-03   -4.148438400630691e-02   -3.246178615866559e-02   -1.869557696360074e-02   +1.281581848857746e-02   +8.859976678920119e-02; +1.993499387070523e-02   +4.292777365285574e-02   +1.944350704420768e-02   +3.015380991695753e-02   -1.186190000420907e-02   -5.277001728452286e-02   -7.873205994881166e-03   +4.661889461792707e-03   -4.193102967992225e-02; -2.601080562965713e-02   -3.586127639782135e-03   +6.670412433184472e-02   -3.773070169298433e-04   +8.812974097693270e-02   -9.815942296239768e-03   -1.963753527772465e-02   +2.117333414601239e-02   +3.601059573483902e-02; +3.229233845953222e-03   -1.017919570339633e-02   -2.740491880861159e-02   -1.963890577418104e-02   +3.961148026659711e-02   +4.389039679591252e-03   +4.110223317215249e-02   +2.063967802347574e-02   +4.661932420569133e-02];
L5_L2_iGABA_netcon = [-4.041875833042574e-02   -3.715634662974913e-03   +1.653321523116267e-02   +1.361325362431856e-02   -2.784805700499976e-02   -1.367365100807559e-02; +3.285661193625205e-03   +8.554624515758745e-03   +2.950375563727847e-02   +1.917710899549553e-02   -1.614555081663237e-02   -1.585827193016663e-02; +4.874856003002669e-02   -6.618327418322935e-02   +9.029204457318682e-03   +2.960875291658773e-02   +6.741142928820207e-04   +3.854271042710158e-03; +1.085835311101031e-03   +5.975811656616514e-02   -1.120992197597250e-02   -2.559568513551319e-02   -2.922280676985663e-02   +3.485802683916560e-02; +5.904026391417453e-02   -1.284392389043916e-01   -3.386335520162485e-02   +1.494929814380890e-02   -2.042559872040134e-02   -6.330902703768726e-02; -3.393816671074339e-02   -3.611170645845568e-02   +3.502904634708040e-02   -2.407156691912100e-02   -6.678991156165709e-02   -9.682547604485198e-03; +2.797969384728463e-02   +4.136007066427846e-03   -4.987762746943077e-03   -4.871405888110039e-02   -1.800942829850990e-02   +1.181369303488611e-02; +1.686875605650401e-02   +3.072496242554545e-03   +1.339811362085788e-02   +4.048905018732907e-02   +4.970553356990639e-02   +1.311474643051150e-02; +2.213299628566786e-02   -1.794464912132124e-02   -2.309595466421541e-03   -3.387493039004812e-02   -8.917476004447077e-03   +2.507860399775552e-02];
L3_L2_iAMPA_netcon = [-1.307696986628504e-02   -5.548276943811808e-03   +4.403270184159845e-02   +5.383706853213324e-02   -3.859471831230423e-02   -6.032583314122293e-02; +3.563708156926191e-02   +8.811524162560782e-03   +3.105623855925907e-02   -2.653442847571939e-02   +3.083633694800766e-02   +4.377631721058275e-02; +9.006480078754465e-03   +2.403772675198091e-02   -9.987148458021278e-03   -7.962683153788076e-03   +4.185661469077930e-02   -6.499751738989376e-02; -3.319411033701578e-03   -4.006321882384957e-04   +7.210019543592641e-02   -2.275966246632356e-02   -9.291324539678723e-02   -5.076382488442942e-02; +9.440011693295024e-02   +1.396386948587665e-02   -1.898499484830732e-02   +1.792603319806222e-02   -3.798063190980600e-03   -2.020785485143248e-02; -9.762827164839073e-03   +3.676136516835204e-02   +5.518248603024828e-02   +4.999387480907892e-02   -2.121753051391874e-02   -6.574565524418870e-03; +3.066717273386519e-03   -1.361692991430332e-02   -1.148543209999803e-02   +3.993164172029381e-02   +3.216610569378298e-02   +1.543138086387016e-02; -4.800050597036838e-03   -2.587594046559555e-02   -1.843872646161238e-02   -7.018862632612925e-02   -5.076637083876973e-02   +1.557784590782182e-02; +6.383959567452840e-03   -4.744150901614085e-04   -3.864992210972489e-02   -4.710430150237964e-02   -6.849401710365353e-02   +1.552311525378459e-02];
L2_L3_iGABA_netcon = [+8.999932576955479e-03   +6.954096057524813e-02   +1.566745069525331e-03   -2.779583293514951e-02   -5.296530786654059e-02   -5.121933159600398e-02   -6.297715000496830e-02   +8.608740148956694e-03   -5.194786088534487e-02; +2.369157840645197e-02   -1.325213057714351e-02   -8.298181825116931e-03   -2.120469003385559e-04   -6.175662310984773e-03   +3.503400130303490e-02   -2.308600770141020e-02   +1.943492081958871e-02   +4.336841562886656e-02; +1.173008556244758e-02   -1.756589869976726e-02   -2.038572882915572e-02   -6.278937073096277e-02   -2.932432043825003e-02   -3.320667894484389e-02   +5.844186686447723e-02   -3.894785347948248e-02   -4.886242655079638e-02; +7.743308315751141e-02   -2.059382111302113e-02   -3.489378041576423e-02   -8.423040005753946e-03   +2.050941284665311e-02   +1.270716928067149e-02   -8.317727641519727e-02   +3.476532961669727e-04   -1.630811085521033e-02; -6.743455001704267e-03   +1.317095739253740e-02   +7.646712036197206e-02   +4.216372122274055e-02   -2.214004951191479e-02   -2.136761798680258e-02   +2.907933255782718e-02   +8.602580804517260e-04   +2.439734510689983e-02; +6.240783274709943e-02   +3.042053005508481e-02   +1.666470372035675e-02   +2.572195244416589e-02   +1.854281229920105e-02   -5.011150670302354e-02   -7.073195446177849e-02   -3.085645014794058e-02   -7.952799123034666e-03];
L1_L4_iGABA_netcon = [-5.309799049010538e-02   -2.756568557190917e-02   -1.783893684978537e-02   -3.873046319200596e-02   -8.618407881419866e-03   +2.089816960389194e-02   -3.425310346732837e-03   +1.155636203211617e-02   -9.244235391084790e-03; -3.098342223149513e-04   -3.202014322216940e-02   -1.567438517687874e-02   -3.460999852519807e-02   -3.914131989327925e-02   -4.896097386217704e-02   +2.975930734832051e-03   -1.394086538245152e-02   -9.509767390464940e-03; +8.835513132073730e-06   +9.612450137948389e-02   +9.293787160673979e-02   -2.590897080764457e-02   -2.142800089405026e-02   +1.037928078512801e-03   -5.092262525116970e-02   +1.511219227807392e-02   +3.369924124252695e-03; -3.019543657253576e-02   +1.475461004685191e-02   +2.950310633793363e-02   -8.302550724686752e-03   +6.785106596492466e-03   +1.847201317408668e-02   +7.605601282219647e-04   -8.517569701751293e-03   -1.999367802542236e-02; +6.037091867078570e-03   +2.167245582416974e-03   +4.446661928324483e-02   -7.376580308103312e-02   +3.221645536754917e-02   +2.442486278470173e-02   -2.230479707357525e-02   -1.451969988677790e-02   -9.063584764031821e-02; -3.266613451062271e-02   +2.886679870235987e-03   +1.614840877859140e-03   -4.403916628981082e-02   +5.992759479371609e-02   +4.107871493572041e-02   -4.922165099536467e-02   +2.570721780809389e-02   -5.418980384410661e-02; +8.414030760062051e-03   -6.950381436163160e-03   +3.469047320977291e-02   -3.402232504976373e-02   +5.084915775891137e-02   +1.723277985813794e-02   +2.740310691249023e-02   +3.258544768901549e-02   -1.508118937317019e-02; -2.814183570811008e-03   +1.331857008592167e-03   -1.542007037708110e-02   +2.185500838494695e-02   -2.965096547734009e-02   -2.149432911988319e-02   -2.228907717265771e-02   +6.829101577657672e-02   -2.174123275029262e-02; +2.466469590811166e-02   +5.550075400552985e-02   +7.267615552383333e-03   -3.666662414566328e-02   -6.562789329100903e-02   -1.197696427670470e-02   -1.787430633386869e-02   -4.255508552941025e-02   +1.934254436328817e-02; +2.100933984437167e-02   -3.994944998425144e-02   -1.108234965044102e-02   -4.427451549680801e-02   -3.358148741537963e-03   +5.672679077938636e-02   -6.176166071189780e-04   -3.593723927112949e-02   +3.540395486539685e-02; -3.692616383892747e-02   +2.913952196391024e-02   +9.105360638691887e-03   -2.512142916688375e-02   +3.346226204388982e-02   +8.933841341493691e-02   +6.941157869250136e-02   -1.730670432788694e-02   +8.539683378619611e-02; -4.909638962519142e-02   -2.520583375437099e-02   -5.970917560511733e-03   -2.301769390785732e-02   -2.563308033184609e-02   -2.150336974010721e-02   -9.546158206271191e-02   -7.699261554681491e-02   +4.983670419324580e-02];
L4_L1_iAMPA_netcon = [+3.805490388408242e-02   -1.587158531412679e-02   +5.329205264705746e-02   +5.116992397903064e-02   -8.807788458367450e-03   -5.190796252337099e-02   +4.803186845327250e-03   +2.446479935834571e-02   +7.375256788127367e-02   -1.663880251221657e-02   +3.363836760525300e-02   +4.974490411665743e-02; +4.399731767222621e-02   +2.339326425118207e-03   +7.120548532629056e-02   +7.224607116045755e-02   +5.928364446454774e-03   +8.335282950310292e-02   +5.329033089711681e-02   -7.376577611412177e-02   -6.250779903898189e-02   -2.231322314918556e-02   -1.692270354861214e-02   +1.070681338892069e-02; -2.218275181753630e-02   -1.744705098264190e-02   +3.840647499244138e-02   +4.500945745489636e-02   +8.089548096324515e-03   +3.244290138597769e-03   +2.150089243570762e-04   -7.110102582332092e-02   -2.028292648971371e-03   +2.975638424594777e-02   +4.789762598710581e-02   -2.661032427696991e-02; -2.381813783069070e-02   +5.186858621890071e-03   +1.250107567283850e-01   +1.278952406428740e-02   -6.063709002043314e-03   +5.008313970390215e-03   +4.290790831911343e-02   -2.750586395738320e-02   -7.627475999028030e-03   +4.867987022204598e-02   +5.567520790031010e-02   -3.566694088416172e-02; +1.387773829313627e-02   -9.121050580826765e-04   -8.980249242869531e-02   +2.834275141529123e-02   -4.727611373858734e-03   -8.350666759625930e-02   +1.258855436880716e-02   -5.323092198392670e-02   +5.216801478505691e-02   -7.572752958810531e-03   -1.687375396628490e-02   -2.490257235825317e-02; -4.520903510984522e-02   +1.480978477622452e-02   -4.571051427435981e-02   -1.131476408470592e-02   +5.469830521795001e-02   -4.942251545419830e-02   +8.083565404574580e-04   +4.801962246703957e-02   +6.369578732721570e-02   +6.054726793688109e-02   +8.463387978378341e-02   +2.126235281124491e-02; -4.708466402009113e-02   -4.936730260138365e-02   +6.525123766561126e-03   -3.721419370523079e-02   +2.799969685425284e-02   +2.718390156702640e-02   -8.372161220625143e-03   +3.224813375751959e-02   -7.506008817473472e-02   -2.508804088161316e-02   +1.065252165375850e-01   +3.134499543441008e-02; -4.945061202260018e-03   +4.301304882838465e-02   -3.299664637553519e-02   +4.139875630995540e-02   +3.784870728747603e-03   +8.104899287273483e-03   +4.093523488547129e-02   +5.313339412186126e-02   -1.146560336750413e-02   -4.980365142670001e-02   -3.771690096731848e-02   -3.159271945168644e-02; +3.217874389774494e-02   -3.344514629916397e-02   -4.222398861865125e-02   +2.619686743553840e-02   +7.393159358816667e-03   -9.488883709907234e-03   -3.320304994337848e-03   -6.532746598919120e-02   -1.979951233565016e-02   +4.205017682263613e-02   -3.854570594884208e-02   -2.222791989819393e-03];
L1_L3_iAMPA_netcon = [+2.547563317574900e-02   +5.132434521290727e-02   -3.857575553243479e-02   -3.773240978558039e-02   +4.744929474928599e-02   -5.953646899128387e-02   +3.433917468708683e-02   +3.233754679467234e-02   +3.691284169363245e-02; -7.146666756385663e-02   -2.615252336605237e-02   +4.249139986977208e-03   +6.255416758076371e-02   -3.036469433951873e-02   -5.536007348695835e-03   -7.639400121349806e-03   -1.736547953428329e-02   +3.660688181765463e-02; +1.937970359152977e-02   +4.862270692724836e-02   +2.464186222351398e-02   +2.591512967854049e-02   +4.354013361671780e-02   +6.600993880802181e-04   +4.403639094956602e-02   -4.286592570887462e-02   -1.758685351607994e-02; +2.112413735669890e-02   -4.948859169996848e-02   -3.503013730645636e-02   +3.556960087433088e-02   +1.369371965688039e-02   +1.587266716590316e-02   +9.663860925704339e-03   +6.633531360656765e-03   -3.318416815943083e-02; +5.261006815880706e-02   -4.067144248528382e-02   -1.366417933862071e-02   +7.549114716737981e-03   -3.227912226261297e-02   -7.137145333972320e-03   +1.226418460384452e-02   +9.100851410756450e-03   +9.870804336200760e-03; -7.671728144620764e-02   -2.858045613373979e-02   -6.236140502943334e-02   -9.195033688654514e-03   +2.403348187898009e-02   -4.662952725040612e-04   +8.660297711059698e-03   +1.708868673317779e-02   +4.052633894953370e-02];
L3_L1_iGABA_netcon = [-5.814140155413867e-02   +1.334093125681172e-03   -2.432852135803880e-02   -6.967055006995741e-02   -2.450607731229973e-02   +2.607423628308113e-02; -4.052880401886243e-02   -6.032910872472491e-02   -3.132512647083569e-02   -3.171606893491638e-02   -6.877881768306815e-03   +2.103989229219314e-02; -4.834333326498951e-02   -4.845010497336002e-02   -6.297723767187355e-02   -1.348702646146613e-02   +3.402749382532066e-02   +3.995855450135589e-02; +4.515777152925404e-03   -3.560798936506116e-02   -2.771244636306825e-02   -2.956089338385589e-03   +5.820327186682227e-03   +3.110510135401265e-02; -3.503728518663356e-02   +4.768547223537394e-02   +2.433300949767454e-02   -8.270212935488266e-02   +6.469023125486652e-02   -1.246443651404899e-02; -5.703720382180179e-02   -3.071896019659704e-02   -2.398704543881896e-02   +8.535579749977690e-02   -9.723910932694476e-03   -1.518119851235102e-02; -2.888308946661620e-02   -4.350636684856567e-02   -1.443375913154143e-02   +5.531726628941988e-02   +2.750989022370309e-03   -4.393876043907924e-03; -5.190816765490484e-02   +5.862628542837640e-02   +2.537182731872619e-02   +1.349191801365580e-02   -1.719160092864587e-02   +6.754749340441402e-02; -2.054284081774915e-02   +4.067836848089142e-02   +1.831865757990268e-02   -9.258552892266663e-03   -3.206747565300285e-03   -2.264053312873718e-02];
L5_Input1_iAMPA_netcon = [-4.980296448727425e-02   +5.362835913700408e-02   -7.199895110626291e-02   +1.067925922525830e-02   -4.154183279451475e-02   +7.119873231358900e-03];
L6_Input2_iAMPA_netcon = [-2.551377664977318e-02   +2.509651801152735e-02   +1.467368085289162e-02   -2.024812174921287e-02   +4.734185572738372e-02   +3.402594205256998e-02];
L5_L6_iAMPA_netcon = [-6.284256935106758e-03   -6.704205278705824e-02   -4.994509961744865e-02   +4.206107010327784e-02   -5.640156030239702e-03   -1.707902279546536e-02; +1.230687847079017e-02   +1.418345080326637e-02   -4.411002040945484e-02   +4.311163590871903e-02   +3.615298442979074e-02   +1.606586260370253e-02; -3.986196353090156e-02   +1.923229680682489e-02   +1.976489539594209e-02   -2.502471954894712e-02   +1.054075325957669e-02   +6.781656605356960e-02; +2.813395443568218e-02   -6.782379900578056e-02   -7.600474223167995e-02   -9.010920936516931e-02   -3.487175306111036e-02   +8.463103236695423e-03; -8.513439843665611e-03   -2.107005793745359e-02   +3.214963989264329e-02   +9.079244586959344e-03   -1.982175204733471e-02   -1.358638771755271e-02; -6.409017506464090e-02   -1.402840266146323e-02   +2.291542518287288e-02   -3.373716242565228e-02   +3.560957425950997e-02   +3.831684377689084e-02];
L4_L5_iGABA_netcon = [-1.104392813644114e-02   +7.801759028003617e-02   +5.983748084734156e-02   +2.010513453039141e-02   -1.537093737741024e-03   -6.165104050201595e-02   -3.162650207441091e-02   +5.103291483078219e-02   +1.472903550090053e-02   +4.223383046538512e-02   +4.476349974794546e-05   -8.499176971176069e-02; -4.075936100959233e-02   -4.491194476005960e-02   +7.976519037813609e-02   +1.999600084871778e-02   -2.619590886517854e-02   +7.964262870151527e-03   +4.001761682807949e-03   -6.688631931453232e-03   -2.419878143832668e-02   -4.433793602383487e-02   +2.340024512380287e-02   +4.473557540293393e-03; -2.831614968153019e-02   -1.783935110434641e-03   -1.110038382426459e-02   -2.953452638914539e-02   -5.612925602421677e-02   -2.604699854973603e-02   +2.129063289555961e-02   -2.502027182609994e-02   -1.621970066947963e-02   -1.306335504899979e-02   -5.168559829018676e-03   +4.717700763540583e-02; +4.546600279515704e-02   -3.630477784372413e-02   -8.315172043264950e-02   +2.223886436334453e-02   +3.631816807962969e-02   -5.713516650694152e-02   +5.386045711956770e-02   -1.782010587908296e-02   +4.380713218360267e-02   +6.320980246098749e-02   +3.635801888943202e-02   +8.686040654369363e-02; +8.097850953350726e-02   +8.679025564392820e-02   +2.128746226011653e-02   -1.259790487893466e-02   -1.800863676528656e-02   -6.525504186032420e-03   -2.156734254994737e-02   -3.259468363774950e-02   -3.325823942721477e-02   +4.166633690963362e-03   +3.834895041694070e-02   -7.282689862378448e-02; +1.553627973058646e-03   -2.092863360755912e-02   -3.897948561852342e-02   +4.246558877285271e-03   +5.887302945685480e-02   +8.463097714348045e-03   +3.353860108750788e-02   -1.973381503775335e-02   +5.282374359014821e-02   +1.008588476722458e-03   -2.555001963950874e-02   +1.132311948806421e-02];
L6_L4_iAMPA_netcon = [-8.179789023630347e-02   -7.907667475876887e-02   -2.173023408755099e-02   -2.277091368051275e-02   +1.999641042142449e-02   +3.708889674169359e-03; +1.015901741494864e-02   -1.570234043440320e-02   +3.754377060209323e-02   -1.030107604227773e-02   -6.960518316787562e-02   -1.829487419250693e-02; -3.105663991548604e-02   -3.246832897660090e-02   +1.692513857600927e-02   +6.305526620239766e-03   +2.270816522895632e-02   +7.499211396029137e-02; -5.623782570002673e-03   -9.561820690615370e-02   -1.937791693758001e-02   -3.617019115664584e-02   +5.916343399050383e-02   +5.842201207826950e-02; +3.310139948179785e-02   -1.710356506200529e-03   +2.444765662038043e-02   -1.281666077972402e-02   +3.242482374106493e-02   +1.768089124747720e-02; +5.010113548525432e-03   -2.374864488239440e-02   -1.839783797880579e-02   +1.757181709789178e-02   +2.260485462967249e-02   -5.585965127137203e-02; +3.647470791484005e-02   -7.780727423515103e-02   +2.608223000165145e-02   +1.679361583662285e-02   -4.302859964918787e-02   +4.377154370323252e-02; +1.163794233699110e-02   +3.832280971805431e-02   +1.268626085082606e-01   +2.769018068046770e-02   -3.182173026105622e-02   -1.329830816163234e-02; +4.034168616656713e-03   -1.984535003986288e-02   +2.684624468262647e-02   +4.250650003426448e-03   +4.966829714111122e-02   +4.040374750204433e-02; -9.342913885684520e-05   +1.532443009587759e-02   +5.086274415768754e-03   -7.374534835743661e-02   +4.782050916857564e-02   +1.550803856226748e-02; -4.035966882317155e-02   -1.918774592439523e-02   +3.183006299598955e-02   -4.336378945065871e-02   +2.605123162711874e-02   +3.811459450469368e-03; -1.359061917521757e-02   -1.701323626744236e-02   +8.917156730358568e-03   +1.067175495064800e-02   +8.412705088734515e-02   -2.314288507480920e-02];
L5_L4_iAMPA_netcon = [-5.383747994600112e-03   -2.295092414805394e-02   -4.122219168798041e-04   +8.275492054646233e-03   +1.371464704581551e-02   -4.763889214234131e-02; -8.629110326192915e-03   -5.893413669254696e-02   +4.512198715366322e-02   -2.577351401335266e-02   +8.678638251588047e-02   -6.429526955531473e-03; +4.376520461332759e-02   +1.013995720490354e-01   -5.886597301703121e-02   +1.422302127465740e-02   -5.973457844930948e-02   +5.682046177097598e-02; -5.305807435273441e-03   +2.665060489521077e-02   -1.321379159496005e-02   -3.569270470581203e-02   -1.683293774470338e-02   +1.128392475477358e-02; -2.610023482729271e-02   -1.694123453729986e-03   -1.304219844178734e-02   -1.723501546185406e-02   -1.448958060862519e-02   -3.721420199570790e-02; -5.471384776206295e-02   +3.586818745714270e-02   -5.254414517057473e-02   +2.081348723118927e-02   +3.653694079498897e-02   +8.100006513442764e-03; -4.484762874471956e-02   -6.136683330502062e-02   -1.212805984115635e-02   -3.231153901418306e-02   -1.850369684484422e-02   -4.470464559691074e-02; -5.701509542316182e-03   +4.204908885181560e-02   -8.137997420163211e-03   +5.125586336455137e-02   -2.972811923855829e-02   +5.905440826062333e-02; -7.305467423053383e-02   +2.544844296183003e-02   -6.074480921319132e-03   -2.933389399505723e-03   -4.425350669816804e-02   -2.936530181453948e-02; +8.024985300968979e-02   -3.326455388425174e-02   +2.498568045249673e-02   -1.469588834416058e-03   -4.454938525713628e-02   +2.594406181434766e-02; -1.663625503632894e-02   -2.412914626126905e-02   -2.410600008816982e-02   +1.055210333362069e-02   +1.894365115147308e-02   -8.224164878013411e-03; -4.722112267009771e-02   -2.869926529682715e-02   -6.471309717916511e-03   +4.059645639987584e-02   +2.770694989619215e-02   +6.971212853215778e-03];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
