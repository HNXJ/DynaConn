function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.490186888734942e-01   +1.879614119719998e-01   +1.129710281233419e-01   -3.647181916167046e-01   +1.184551971117642e-01   +1.403313111265414e-01   -3.648358237241477e-01   -3.654273494438927e-01   -3.958636204337986e-01; +1.514145246721205e-02   -2.153564732019387e-01   -2.768482358340261e-01   -2.914002758303909e-01   -7.018507094237990e-02   +1.425096420056534e-01   -5.026000457798938e-02   +3.715297198796791e-03   +7.540011516134763e-02; -5.568608443407861e-02   +8.478560312298346e-02   +3.508552180741586e-02   -3.808987195080246e-01   -3.548972290492716e-01   +2.911337057767290e-01   -8.178231483498666e-02   +3.814984255287563e-01   -3.563645537791542e-01; -1.241997963924642e-01   +1.497536913161458e-01   +3.463436620929447e-02   -1.588352241428547e-01   +3.180078103254418e-01   +3.169695559572698e-01   -2.429145945934777e-01   +3.129373966764938e-01   +1.240238865104162e-01; +5.537784679511187e-03   -8.023299977344331e-02   +1.272535568624513e-01   +3.765688281346864e-01   +1.402487489050311e-01   -8.590593174042199e-02   +2.191972095723799e-01   -2.685099814510794e-01   -2.627916881971398e-01; +1.444761959966019e-01   +1.583086779128446e-01   +8.145199665505420e-02   -8.994227037604074e-02   +1.487589833524139e-01   +8.136641240518018e-02   -2.233519418197807e-01   -9.095024354700387e-02   +4.296439132623722e-01; -5.267979525408861e-02   +7.995012895803302e-02   -1.704869360773563e-01   -2.929826847589286e-01   -4.254024368811188e-01   -2.174220228464989e-01   +2.367365659845791e-01   -1.225767143248574e-01   -1.196532331658597e-01; -6.013881634649038e-02   -1.652702370369172e-01   -2.851499402219674e-01   -2.561308678960934e-01   -1.807299842586252e-01   +3.639383501158729e-01   -4.314708127097169e-02   -3.944336660373139e-01   +7.618612106712713e-02; -3.211879138458116e-01   +1.963070299965110e-01   +3.267721802867343e-01   +6.420026063531048e-02   -1.489742816803628e-01   +2.110769818790516e-01   +2.138093354887424e-02   -8.222128179552562e-02   -3.581429353657414e-01];
L1_L2_iAMPA_netcon = [+3.616824209930404e-02   -2.559512741568905e-01   -1.670573348805031e-01   -1.125788049210197e-01   -4.809874064075620e-01   -8.988879663772192e-02   +5.560657642216565e-02   +8.621719500849628e-02   +2.351441248314359e-02; +2.221556613692748e-01   -2.530641748890469e-01   -1.064709987401145e-02   -1.269091446099158e-04   +1.615311732057981e-01   -2.360876441714014e-01   -8.228797636180168e-02   -9.979431723974896e-02   +4.117843548210032e-01; +1.190499041121840e-02   +1.885145944506295e-01   +1.216708781845982e-01   +1.975094349132639e-01   +3.153217841361139e-01   -4.486196227510069e-01   -9.178362937469822e-02   +7.741939066339346e-02   -1.577615526254844e-01; +2.727100800376747e-02   -1.703748187668197e-01   -1.948958613263075e-01   -2.155888191966771e-01   +1.771407604282274e-01   +7.887273329274902e-02   -2.269304187083872e-01   -2.124089748507456e-01   -4.940717534260647e-01; -1.180813994525064e-01   -2.125911949354575e-01   +6.913291639056046e-03   -1.308897645215007e-02   +2.124729621640313e-02   +6.595779442715674e-02   +5.116020985943881e-02   -9.805917061433345e-02   -1.483609724117092e-01; -3.399392723737047e-01   -1.194788773347130e-01   -3.926464554666200e-01   +4.087857983918191e-01   +1.202053809340910e-01   -4.560204499303231e-01   +2.057042836301354e-01   -1.116730712990860e-02   -1.298783105533393e-01; -2.134784551326318e-01   -1.869538103779448e-01   +2.317189587398993e-01   +4.489464414034682e-01   +1.262485012938225e-02   -1.517152726995976e-01   -2.427442564222977e-01   -1.524677558457153e-02   +2.052280537372431e-01; +3.893119207125063e-01   +8.428699564544326e-02   -1.057530259897581e-01   +2.599568219589638e-01   +1.890033742000428e-01   +2.261914664717332e-01   +2.687870642764719e-01   +3.395095962332315e-01   -5.009195194556498e-02; -3.997507783239426e-01   -3.702384032807008e-01   +2.407799694286070e-01   -2.391613005171417e-01   +3.764464226136994e-01   -2.179949898421175e-01   +9.630681780501602e-02   +5.045834517745745e-02   +9.535282360402750e-02];
L2_L5_iAMPA_netcon = [+1.832946420342861e-01   +2.597108688469152e-01   -1.835007737138413e-01   +3.122541688255576e-01   +1.190800023213801e-01   -7.709252401418043e-02   -2.796638564332656e-01   +6.823607392543005e-02   -1.302975399081270e-01; +1.777529271930430e-01   -1.220205047212810e-01   -2.757422245919495e-01   +3.263845464252431e-01   -2.390261694762483e-01   -4.167058717067592e-01   -2.350363651381399e-02   -2.402270528933419e-02   +1.590665208523611e-01; +3.149092520644610e-02   +7.092840352955430e-02   -9.959798615539225e-02   +1.717216926039254e-01   +2.117464091817940e-01   +4.061043453640071e-01   +2.929791635537572e-01   -3.073941349176262e-01   +8.785910547274096e-02; +3.318753013571115e-01   +2.086387190355574e-01   +3.317779807952198e-01   +3.237005612740731e-01   -1.582831480086723e-01   +2.399524979884565e-01   -2.596584207783610e-01   +1.373214709034546e-01   -2.839295211937074e-01; -1.418889490485421e-01   -6.417621000942705e-02   -3.192498239442464e-01   -2.386765219871767e-01   -4.723778052556054e-01   -3.199054425098604e-01   -5.515390059623992e-03   -6.047863339809097e-02   -8.831223129527177e-02; -1.794245785066897e-01   -2.254707610529810e-01   -2.771162740298350e-02   +1.862155988549846e-01   -9.635029396726016e-02   +2.299466832807102e-01   -4.730293373449898e-02   -6.206735747615416e-02   +3.853095795857736e-01];
L5_L2_iGABA_netcon = [-1.384017392748210e-02   -7.983601211723529e-02   -3.594785062573146e-01   -1.551904036238868e-01   -1.044248282998579e-01   +4.302927840418688e-02; +1.116434420469810e-01   +2.339571247798424e-01   -1.730895548265662e-01   -1.591450487115743e-01   -3.089401915403500e-01   +1.176200426502096e-01; -1.812436761592774e-01   +4.223737086173457e-01   -2.692023249420228e-01   +1.694236801203284e-01   -2.958616860601052e-01   +1.130645790514051e-01; +2.511061789785173e-01   +1.684616231345108e-01   +3.717404401972731e-01   -1.030405890580068e-02   +1.863425026132690e-01   +3.181432582405525e-01; -3.450914286253439e-01   -9.922926108299542e-02   +2.068256939226526e-01   +1.734385921729061e-01   -9.105144668020131e-02   +2.518851433919154e-01; +9.083765437400682e-02   -4.721241862519340e-02   +1.552889894215528e-01   -3.385707509267380e-02   +2.164904692775040e-01   -1.806553905433240e-01; -1.594932378999459e-02   +5.181510681419893e-02   -6.220966281508995e-02   +2.501092602341946e-01   +1.646470715811069e-01   +1.928907936329713e-01; -9.234005458573741e-02   +2.103400830624513e-01   +4.226720778815845e-01   -3.283141281211815e-02   +5.650307237568782e-02   +6.192932193622269e-03; +8.320734000361193e-02   -4.468590449071523e-01   -3.021779545786558e-01   +2.505184672694484e-01   -1.836199152428977e-02   +1.938169559241932e-01];
L3_L2_iAMPA_netcon = [-1.419069384021008e-01   -1.418854614252854e-02   +2.996426352296597e-01   -3.667409911045193e-01   -3.915309119661377e-02   +3.452431147618749e-01; -8.407533509839508e-02   -1.788379618880861e-01   +8.093525736122968e-02   +6.428691694760021e-03   -8.861160935151197e-02   +1.348978015415335e-01; -4.950740865687886e-02   -4.207133211253887e-01   -2.719989596344292e-01   -2.589813057016155e-01   +1.334403244421526e-01   -2.655986568616013e-01; -5.251927513969960e-02   -2.964806275563796e-01   -1.513940946250447e-01   -5.427743925266331e-02   +1.829350696099035e-01   -4.084406553237062e-02; +1.241324595330727e-01   +1.463184458411556e-01   -2.693984243042835e-01   -6.788007272618961e-03   +1.808330289524228e-01   -3.166795042239187e-01; -4.428952353410505e-01   +1.078856251209627e-01   -1.536066058417500e-02   +1.146412569084621e-02   -3.150119889782468e-01   -4.898095192483238e-02; +8.189614988157205e-02   +2.000338958895678e-01   -3.624373773614063e-01   +2.470555655108855e-01   +6.223030234460596e-02   -1.921346777029010e-01; +1.265394499498410e-01   -1.237269368812146e-01   -3.225644080910972e-02   +1.266297226923672e-01   +1.937133645299113e-01   +9.770833572952997e-02; -3.402726793567508e-01   -6.562698225430699e-02   +2.964042414432744e-02   +2.132750774481174e-01   +1.599574898043357e-01   -1.763598455686337e-01];
L2_L3_iAMPA_netcon = [-1.502911254418030e-01   +2.347658805446400e-01   +6.618577250440677e-02   +2.011407660528162e-01   -1.636966856181157e-01   -3.421099323927674e-01   -3.410154596611513e-01   +3.857484610394801e-01   +5.644953789216856e-02; +4.741788049835709e-01   -2.365153343674526e-01   -2.466275141196809e-01   -1.722737568852996e-01   +1.236021049769148e-01   +5.265259899039580e-02   +2.418013475563868e-01   -2.542212688208563e-01   -1.610282197464097e-01; +1.319787755411673e-01   +2.285587570333976e-02   -1.834723492841336e-01   -1.468990844029137e-01   -3.343387499931075e-01   -3.885485381857737e-01   +1.084708578917243e-01   +1.403282130590993e-01   +1.950234776042042e-01; +8.939849673568484e-02   -6.427528746691585e-02   -9.963300888552085e-02   +1.324082274787403e-01   +1.249231724967294e-02   +4.229325831612903e-01   -2.541566822063190e-01   +3.164428359354196e-01   +3.714280133415886e-01; +2.963376542611938e-01   -3.265162574509908e-01   -2.296055639764785e-01   +3.843617078497011e-01   -8.129315702544873e-02   +2.359451569854552e-01   +6.892705174904298e-02   +2.008452041994588e-01   -3.276447922359466e-01; +3.027652287185217e-01   +3.963393245971626e-01   +1.097641013660086e-02   +7.083053420592830e-03   +1.651018934824467e-01   -1.030471740166898e-01   -2.314878025821977e-01   +3.003716940709239e-02   -1.525435386708578e-01];
L1_L4_iGABA_netcon = [-4.412695733934153e-01   +3.426606970830377e-01   -1.346396090258509e-01   -1.223796966734610e-01   +8.413339841028245e-02   -2.147400293559125e-01   -1.320632335691937e-01   +1.805039911899527e-01   +1.367573650679846e-01; +3.043891512608777e-01   -4.101544257654724e-01   +1.463423885569802e-01   +1.803889493136632e-01   +2.299728384014695e-01   +1.690068584433299e-01   +1.203747746872073e-01   -1.156033681005092e-02   -1.048042925940716e-01; -1.172463625243362e-01   -1.688607108404796e-01   -1.721119303935711e-02   -3.384446749992981e-01   -4.793430758772443e-02   +1.898542947994597e-01   -1.960686306312365e-01   +2.648717157854713e-01   +1.975644621362612e-01; +1.900212533507034e-01   -3.099125350680623e-01   +4.077474115694321e-02   -2.458658916089568e-03   -1.980017973041822e-01   +2.746046548048252e-01   -2.225337868383891e-01   -1.459877697777762e-01   +1.980670647146204e-01; +1.907012341030425e-01   -6.080523186325348e-02   -1.549643492050959e-01   -5.577130538794475e-02   +1.182822046543660e-01   -1.073246941296825e-01   -1.354805485150349e-01   -7.753073314992753e-02   -2.563367557720063e-01; -1.037954527650468e-01   -1.579621155402464e-01   +1.379612218396840e-01   +3.936739727921798e-02   -1.953835042068891e-02   +1.921025278287936e-01   -9.556430950537284e-02   -4.942926259593526e-02   +9.412298602530625e-02; +4.191203936103774e-02   +1.662000331648983e-01   -1.771776340056304e-01   +3.603407740578351e-01   +4.426935774166521e-01   -8.418577062632965e-02   +2.422608079326652e-01   -2.639934377419126e-02   +1.730862738630007e-02; -3.753988188776921e-01   +1.538039808049336e-01   +4.901804242269219e-01   -1.890011830527178e-01   +2.116120738128807e-02   -1.032385779330342e-01   +3.528895226255153e-01   -1.485330870678833e-01   -2.961309083987663e-01; -7.717712136787597e-02   -9.909229194785033e-02   +3.999206706010645e-01   +1.594384213650407e-01   +1.252080431515302e-01   +2.921310060321847e-02   -2.423912049237361e-01   +3.861511551544100e-03   +1.306644962163144e-01; -1.717375296952887e-01   +3.607021808473208e-01   -1.867869724684281e-01   +4.846766212007267e-02   +1.020480594657314e-02   -5.089157672858367e-01   -2.209092146476524e-01   -1.641315021726887e-01   +3.112604456769192e-01; -2.888298507229353e-01   +3.337278347013434e-01   +3.932577193109088e-02   +3.637372647452206e-01   +4.238993826322528e-02   -2.570390819841581e-01   +1.537936147402474e-01   -1.528423232328897e-01   -2.777498644585543e-01; -1.388656032159860e-01   +1.938399147657713e-01   +1.571997735853981e-02   -2.384332448213255e-01   +3.498210245792394e-01   +3.522421621773563e-01   +7.337483877756373e-03   -3.648006312667591e-01   -1.241886118242608e-03];
L4_L1_iGABA_netcon = [+3.411557205667750e-01   +5.929717044766628e-02   -1.001395912664786e-01   -3.850191029744635e-02   +2.250080052169748e-01   -1.531348587067519e-01   -2.428860650851111e-01   -1.472851035330432e-01   -5.441897050152709e-02   +1.381638144344727e-01   -2.155961859565800e-02   +2.337197203143394e-01; +1.377603997204234e-01   -4.576445057260332e-01   +1.973839628861555e-01   +1.249058211566728e-01   -2.460846348477224e-01   +1.925103385910329e-01   -1.621696825831027e-01   -4.118600624458149e-01   +3.095387025771483e-01   -1.692062967265299e-01   -1.957716135910018e-01   +2.272326750955498e-02; +1.722523491611493e-01   -4.741983472752688e-01   +1.266108237604261e-01   +3.172637114543475e-01   -3.858657000487795e-02   -1.292830639384867e-01   -1.988477112585538e-01   -2.019008542185588e-01   +4.152834688008283e-02   +2.004841412119046e-01   +2.971866149414601e-02   +6.300318198539630e-02; -1.854657384265059e-01   -2.754058546521273e-01   +6.102102846206600e-02   +2.720862869958391e-01   +1.316712978368788e-01   -7.668914626093393e-02   -2.971411675247672e-02   -5.942372469834303e-02   +1.194128669141966e-01   +2.523316689112383e-01   +3.203870021139660e-01   -1.927377328133242e-01; -2.294002492535653e-01   +1.143170540102048e-01   +4.230917035466107e-01   +2.215071999918450e-01   -1.626409084030781e-01   -1.346526277906712e-01   +1.954227313734413e-01   +2.783573692621411e-01   -3.238986236893017e-01   -1.354066309717174e-01   +3.818292228922987e-01   -2.652689204946182e-01; -3.110376052315201e-01   +1.064834745723381e-01   -2.097426698895997e-01   +1.189653814724660e-01   -7.200185459173428e-02   +1.350221868579279e-01   -6.092963149119973e-03   +1.090004731003845e-01   -4.098306750391822e-02   -4.443027795383175e-02   -2.738420093377379e-01   -4.076469995679872e-01; +2.452689608402410e-01   +2.918631747154676e-03   +7.884435167206016e-02   +1.863110831950839e-01   -7.869705790766017e-02   +2.126484823095128e-01   -2.378093126889392e-01   -4.329255812288018e-01   +1.708957199746941e-01   +1.463923293870674e-01   -1.923978277251345e-01   -3.955039293681278e-02; -3.028119373521531e-01   +2.643170747328453e-01   -8.234236884334376e-02   +1.228694190787933e-01   +4.108522207534730e-02   -3.851212479828717e-01   -1.263201169382283e-02   +1.850106388846251e-02   +1.463596729265501e-02   +5.874902736285675e-02   -4.113107019297395e-01   +1.105277054576711e-01; -3.937983686906028e-01   -2.278261248342145e-01   +1.741364103744589e-01   -4.196588849033597e-01   -1.554527026918493e-01   +2.848360516705383e-01   +9.631119320303475e-02   -4.076057212156473e-01   +9.897374331059500e-02   -3.885219323542603e-02   -3.442406402526935e-02   -1.057715928584313e-01];
L1_L3_iAMPA_netcon = [-1.309595664691071e-01   +6.651517696849375e-02   -6.890237813226949e-02   -3.338268256288963e-01   -3.131261814302833e-01   -1.196224234030494e-01   +2.989176200759242e-01   -9.784182774582771e-02   +4.158799722571267e-01; -5.730141933207555e-02   +2.962567032834666e-01   +3.262660365772118e-01   +3.741246760092141e-01   +1.270264132235245e-01   +7.888061089397119e-02   +2.842996154936545e-01   -3.226678850047554e-01   -1.131393529127004e-01; +2.301618418783697e-01   +2.982627358331345e-01   +1.726104488882217e-01   +2.045473731656001e-01   +3.277615909621912e-02   -2.540500321525300e-01   +1.996953189705545e-01   -3.288000214746913e-01   +8.668477161167787e-02; -1.509772152246010e-02   -1.973490171652756e-01   +1.799529946342916e-02   -9.093832221823178e-02   -9.271835673419360e-02   +2.786251859110357e-01   -2.080494793343563e-01   -2.471296880201921e-01   -6.141402677062234e-02; +1.388135887826158e-02   -3.717086379868167e-02   +3.041586935133378e-02   +5.860195241034698e-03   -7.888340355988047e-02   +3.440498840339664e-01   -2.654653257216072e-01   +3.805516117381500e-01   -2.548856154514324e-01; -3.065611586659425e-01   -5.672818240165815e-02   +6.363011727356396e-02   +1.157629177875218e-01   -3.335085208040510e-01   +1.072579299320153e-01   -3.626894536267300e-02   +3.602088761012646e-01   -3.302806732692134e-01];
L3_L1_iGABA_netcon = [+1.500314482856484e-01   -1.141596659254673e-01   -1.154543318510573e-01   -4.851257822232087e-01   +3.495611202647914e-01   -4.837329552225036e-01; -1.089936162556144e-01   +1.707615984596420e-01   -4.218457928452379e-02   -2.034611772895493e-01   -3.741144324682150e-01   -3.930059425300826e-01; +5.136808069093068e-02   +3.915431786627338e-02   +1.433947763461413e-01   +1.330536826196186e-01   -3.167695614271126e-02   -6.218419290064163e-02; -1.174242732676363e-01   -2.872453156247790e-03   -3.761826229359018e-01   -2.923316402665573e-01   +2.082812705597500e-02   -7.442977703116110e-02; -1.731522417490749e-01   -1.080141909002350e-01   -2.927791672390586e-01   +2.106772837213676e-01   +1.474823305270872e-01   -9.396892032116698e-02; +1.895712143429808e-01   -7.240076596711595e-02   +2.029259713242574e-01   +3.320443246654737e-01   +2.364531329610985e-01   +1.828677406698846e-01; -7.168487800623569e-02   +2.855048315972204e-01   -2.558050534609396e-02   -3.268684113051935e-01   +3.128137533500344e-01   +1.903412119282000e-01; +1.481945372475180e-02   -5.958441830819558e-02   -2.914433125431104e-01   -3.237231742940650e-02   -1.542862919725693e-01   +2.320342921157472e-01; +2.653932694152922e-02   -2.337712331503141e-01   -2.971684727060814e-01   +1.410841737007283e-01   -3.816086706188721e-01   -5.658480453272943e-02];
L5_Input1_iAMPA_netcon = [+1.980396340744675e-01   +2.156793981943369e-01   -1.775372279222116e-01   +2.375276217709090e-01   -1.163537674081817e-01   -4.684371763428047e-01];
L6_Input2_iAMPA_netcon = [-1.536813044788142e-02   -3.952379746126562e-01   -1.554497128241745e-01];
L5_L6_iAMPA_netcon = [-5.127139928181666e-02   -2.386049736452128e-01   +7.110344341540802e-02   +1.577963679380567e-03   -3.055265770894784e-01   +1.953544352248758e-01; +1.004556648034477e-03   +1.876734739493280e-01   -5.141262439558213e-02   +7.169717360011899e-02   -1.730273435128468e-01   -5.733533124700982e-02; -3.723362109234002e-01   +1.903478147750845e-02   +3.583306662282659e-01   +2.754541749652089e-01   +2.261630090053529e-02   +1.651199181926485e-01];
L4_L5_iAMPA_netcon = [-2.074838738288641e-01   -7.180374127133007e-02   -2.328172633413294e-01   -2.765521981928959e-02   +1.175918931644725e-02   -2.113138960704699e-01   +3.437371076380867e-01   +1.153868595758861e-02   -3.227238930553312e-01   +3.387454309503132e-02   -2.859454242341558e-01   -2.720282000110633e-01; +2.555018580594225e-01   +2.392108182355715e-01   +3.816149636965894e-01   -6.184725889892617e-02   -5.598244006771434e-02   -1.316575650438070e-01   +1.006072206246493e-01   +2.766859442878808e-01   -1.273600978883302e-01   +1.044913953689779e-01   -4.268138949249682e-01   -8.476179299618185e-02; +2.412880059275864e-01   -1.699042274195178e-01   +2.333971472293559e-01   +6.293533623171457e-02   +1.064017417349905e-01   +2.762558564001649e-02   +1.431101758743919e-01   +5.258780937104142e-02   -3.025650245098085e-01   -6.462413305809746e-02   -4.395482200909781e-02   +2.093046701141810e-01; +4.012537403273229e-01   -7.294282588361249e-02   +8.007256876007793e-02   +1.717424700267200e-01   -1.631042060568876e-01   -2.789743270197256e-01   +2.636040160131744e-01   +1.887986529171713e-01   -7.673717616957906e-02   -1.926314824029599e-02   -3.176720142851891e-01   -2.336672022487310e-01; +9.036236613316606e-02   +3.613001453963909e-01   -4.939549767171114e-02   +3.132206430261301e-02   +1.295126522937879e-01   +3.331300860807603e-01   +8.075206432155554e-02   -1.054621370666406e-01   -2.707383131296941e-01   +2.599972092333239e-02   +3.677797288782474e-01   +4.966240881318226e-01; -2.029362819978735e-01   -2.651822291637738e-01   -3.305013295341050e-01   -7.134925029558474e-02   -3.753468124544731e-01   -1.176889783809634e-01   +4.183530583632731e-01   +2.443669051980106e-01   +3.078954524330177e-01   -2.901752860046973e-01   -3.875496835462399e-01   +6.573405916623562e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
