function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.921967250977304e-01   +1.334408048938493e-01   -2.424994540288204e-02   +3.628597189821142e-01   +1.321132497794287e-01   +5.586504583195474e-01   -1.683921151323541e-01   -1.203273215592768e-01   -1.720072211658957e-01; +2.834094459524324e-01   -3.099247532535719e-02   -9.397430585276147e-02   +5.121618887065119e-01   +3.551062965631949e-01   +6.284553936092198e-01   +4.023892240796320e-01   -5.328083780215886e-02   -9.134670369144150e-02; +2.074158277807428e-01   +3.111788354750437e-01   +7.521775248629750e-01   +1.172347345686882e-01   +6.548112564765930e-02   -6.076412132717347e-02   +2.451264363549364e-01   +1.904105129163787e-01   -3.436858009326339e-01; +2.071623302163019e-01   -3.256654377545053e-01   +5.829960057530044e-01   +2.880200554258592e-01   +7.418996216462951e-03   +1.630050345724490e-01   -5.695639168578117e-01   +2.029416319685852e-01   +2.005517900880557e-01; -2.491997275705351e-01   -3.745769309378189e-02   -1.557737535253466e-01   +2.516634007398324e-01   -1.333937429695108e-01   +1.714028944995666e-01   -2.124949237331793e-01   -8.413785825983407e-02   -1.444323720845339e-01; +7.974512027359609e-02   -3.216825423039449e-01   +5.674606074621699e-03   +8.829888999156463e-02   +2.057826100768680e-01   +3.049534955566055e-02   -2.447436123114716e-02   +6.399489778896048e-01   -1.103409917509691e-01; +3.091548282166716e-01   -5.078613502295066e-02   +7.409084915274001e-01   -1.263437455977145e-01   +9.631470063507917e-02   -8.896579032148326e-02   +2.201140365669040e-01   +7.596688553840830e-01   +5.799782648059443e-01; +4.533608431566463e-01   +5.366446898741475e-01   +1.999556107374573e-02   +2.382371297878607e-01   +7.430159278965939e-02   +5.506945887239439e-01   +1.581038423811205e-01   -3.057079263881707e-01   -6.246669072788062e-02; +4.276804960146339e-01   +7.386791212673074e-01   +1.000000000000000e+00   +2.194549746306587e-01   +4.975065154476185e-01   -3.727632952451422e-01   +4.086550082140638e-01   +3.968266626359259e-01   +3.794914350183472e-01];
L1_L2_iAMPA_netcon = [+6.670723851735640e-01   -2.175775862540430e-01   +1.410222581880303e-01   -5.205413789173122e-01   -3.027605882932973e-01   -2.956838169100341e-01   +2.741023634366174e-01   +2.721785626200310e-01   -1.084685393632107e-02; -1.962879661666536e-01   +5.631966782077340e-01   +4.116352394950650e-01   +4.800250321992082e-01   -3.506287089335674e-01   -2.712372052537269e-01   -2.827720664640631e-01   +1.776787797847616e-01   +1.349187133466044e-01; -1.461975291519934e-01   +2.340364194705266e-01   -1.611125367316023e-01   -3.734517776251147e-02   -5.200683177424739e-01   +7.104014979471805e-01   +5.571417979862029e-01   -4.359313563404876e-02   -1.997332393102364e-01; +1.872774307459212e-01   -1.919009938434118e-01   -1.775125845585290e-01   +6.323036049082684e-01   +3.492514886747284e-01   +5.998618898036534e-01   +3.324305092015021e-01   +5.872916757862088e-01   +2.822490446413536e-01; -6.000443512118593e-02   +9.068892610047483e-02   -2.000924972415195e-01   +5.930225870439354e-01   -1.289144163223803e-01   -2.857000811174187e-01   +3.176355520726053e-01   +3.386888471488374e-01   -4.294910896975223e-01; -5.074986911376670e-01   -3.460866613285833e-01   +2.954015068319741e-01   -1.299475259662619e-03   -1.070661673924734e-01   +3.779477735821889e-01   +1.017292817837121e-01   +5.561488702852352e-02   +3.941520518024738e-01; +2.860530279024227e-01   +3.807589300176474e-01   +5.674712976907169e-01   +2.404241016576089e-01   -9.818043012169703e-02   +1.890156625957942e-01   +6.282926413288367e-01   -3.197929045281879e-01   +1.783941183786337e-01; -2.245844033678254e-01   +4.987977442585997e-01   -5.192762541080630e-01   +4.669146878962293e-01   +4.110698315271546e-02   -6.248245292578686e-01   -6.633604044817836e-01   -1.765888746303310e-01   +1.388899086333161e-01; -1.266709538829310e-01   +5.657114478526377e-01   +4.697859026416388e-01   -1.837440762345473e-01   -7.051648295961912e-01   -1.996738425641186e-01   +4.827079710139847e-01   +3.163773583419597e-01   -7.915870511930370e-02];
L2_L5_iAMPA_netcon = [+5.970080042403030e-01   -1.995077783999192e-01   +2.728965795961393e-02   +4.657642160711684e-01   -8.603554331722645e-02   +4.291079969585282e-02   +1.227183489096492e-01   +4.804870701728449e-01   -2.372098609701497e-01; -2.373413308011571e-01   +2.057692128199558e-01   -7.116005428378838e-02   -2.362376186855308e-01   -1.823584201433190e-01   +6.199290114790859e-01   -2.226081648058237e-01   -2.140627950446592e-01   +4.803886567473131e-02; -1.274557109991545e-01   +3.535688584333965e-01   -3.182443198728335e-01   +4.456383287814555e-01   +1.217299132274765e-01   +2.178825192956364e-01   -2.605158518364517e-01   +7.302296917195382e-03   +6.865519449737832e-01; -1.136730021691902e-02   +9.155745466861773e-02   +1.411199111888072e-01   -1.727462034329688e-01   -3.188667268358570e-01   +5.920078655883699e-01   -6.619583729916276e-01   -2.882945104689287e-01   +6.492089887143850e-01; +2.864132278507113e-01   -1.242488370824188e-01   -1.287460871347930e-01   +5.594322536829460e-02   -3.035332299320986e-01   +5.166782527297703e-01   -1.647357739670069e-01   +2.242479336911544e-01   -1.068416054400465e-01; +3.089018898576611e-01   +1.807469484984962e-01   -3.726510532552011e-01   +1.059047159779108e-01   -4.091522031143334e-01   +2.076357119818803e-01   +3.280558388977955e-01   -7.259425678244844e-02   +7.306580754088472e-01];
L5_L2_iGABA_netcon = [-6.159272272022061e-01   +3.326279314047464e-01   +1.180383062265225e-01   -1.602292218897212e-01   +3.087740640537999e-01   -1.745096926055699e-01; -3.593098030572289e-01   +2.412965386319696e-01   +4.051990795236395e-01   +3.802622297255501e-02   -3.039907200411476e-01   -5.697206797876683e-01; +3.351755182480289e-01   -3.978851570246585e-01   +4.227401919887722e-01   +1.786793696442893e-01   +4.310478564294408e-02   +1.424846944748961e-01; -2.804802224065860e-01   +1.510926862935381e-01   +2.915299159462869e-01   +3.809398788422250e-01   +3.504761107099741e-02   -6.437208802640038e-01; -1.755889659788116e-01   +6.403162016023550e-02   +6.295825526564800e-01   -1.821355571087432e-01   -1.298421016747440e-01   -3.580952417597427e-02; +2.084885156877746e-01   +4.137258605575795e-01   +4.639773569518513e-02   -1.967924783883230e-01   -1.700441491511188e-01   -9.165668684645469e-02; -1.062250832472702e-02   -3.274286013818697e-01   +4.191583905823745e-01   +1.771100450698404e-01   +2.761760374820407e-01   +2.127946591697693e-01; -4.523328561629666e-03   -5.485806876363411e-02   +5.194040725044864e-01   -3.514360253428105e-01   -1.574444145398858e-01   -7.403029749614778e-01; +3.043993006810581e-01   +5.417961535177954e-02   +5.058932872846206e-01   +7.356644958210571e-01   +1.267191061341868e-01   -5.433771100200185e-01];
L3_L2_iAMPA_netcon = [+2.925210763388530e-03   -1.494555393833219e-01   -3.698621563669220e-02   +4.241844423459298e-02   -3.324205436360301e-01   -2.012443175317601e-01; -4.462843281339168e-03   -2.381484675554675e-01   -2.434642764065997e-01   -3.566543101785599e-02   +5.085008763991985e-01   -5.533919740394238e-01; +3.364688693809094e-01   -2.561117256005697e-01   -7.941026707209325e-02   +4.132809676349183e-02   +2.953782351380537e-01   -2.658717680199355e-01; -1.314974264609984e-01   -1.838500001349800e-01   +3.664195837258213e-01   -2.091571248115412e-01   +4.001149785374081e-03   +1.166841900697462e-01; -4.698199750190850e-01   +6.754420990853226e-01   +6.477656600062897e-01   +2.985190232918870e-01   -1.189023238913140e-01   -6.708157310429298e-02; -1.451446242743497e-01   +6.968029120078509e-01   -1.622471279470998e-01   +2.494401386500845e-01   +6.455569093111748e-01   +4.668249257511167e-01; +2.027217742193785e-01   +2.595383365381232e-02   +4.202798446765045e-01   +2.069556917002215e-01   -2.653260671253121e-01   -4.506596671301160e-01; -2.049822275638062e-01   -1.038265224191727e-01   +2.557800296739444e-01   +1.927388406670610e-02   +3.374808928274705e-01   +1.110946642485559e-01; -1.266021345348743e-01   +1.008535157283046e-01   +1.007909786058822e-01   +5.118940405115979e-01   -2.330022300355547e-01   +4.393973290943591e-01];
L2_L3_iGABA_netcon = [+3.158562375158799e-01   +2.137986830478310e-01   -5.679150295348536e-01   +4.289345339739198e-01   +1.087945694174797e-01   -2.448514509788315e-01   -3.436463312358823e-02   -2.074457351575034e-01   +3.161126617738690e-01; +5.060173557241664e-01   -1.110327510209021e-01   +7.432584550544642e-02   -7.096596605740990e-01   +3.228864618631291e-01   +3.129142644029567e-01   +2.960145333330847e-01   -1.596558003779551e-01   -1.729442296175179e-01; -4.917939055253173e-02   +3.002971335762614e-02   +2.312247480937491e-01   +2.379642354261706e-01   -5.715972669701896e-01   -3.694869326003019e-01   -2.492113822098310e-01   -8.135386979786374e-02   +4.061973728128112e-01; +5.805744415298690e-01   -3.125353859032759e-02   +4.006219290748397e-01   -8.226298396294945e-02   +2.900216160971789e-01   -4.115317330749803e-01   -1.628230073059131e-01   +2.772202427913731e-01   +7.434847763908432e-01; -3.631696249508151e-02   -9.234519679266126e-02   -1.248261611465190e-01   +7.324481504883057e-02   +3.198957963553475e-01   +7.181657291942350e-01   -2.610762495484040e-02   +6.862961880682256e-02   +2.263662795143966e-01; +7.867008569547440e-01   +3.724502091956593e-01   -1.478852058201319e-01   +2.405428727571574e-01   +7.900338840803070e-02   +2.983324673271026e-01   -7.507023572683076e-01   -3.010560492152584e-01   +1.831218260863331e-01];
L1_L4_iGABA_netcon = [+2.614583588456156e-01   -5.420284827743544e-01   -1.514890875547254e-01   -4.952282254276824e-02   +4.641675643829770e-01   -1.945169051636815e-01   -1.113596018411802e-01   +2.005725449439388e-02   +6.681067227700472e-01; +1.010157638615045e-01   -1.877082827996171e-02   +5.832386635579909e-01   +4.311723839250142e-01   +2.395217026902819e-01   -5.151209578458241e-01   +1.629102849700606e-01   +1.868274384982801e-01   +1.945104937956919e-01; +9.944783462114561e-01   +3.323207407478115e-01   +7.699138169975403e-02   +3.268401089356807e-01   +3.165894774268445e-01   +3.607886859675777e-01   -1.393220472207848e-02   +3.893267056010719e-01   -2.690630033815944e-02; +1.940791967522278e-01   +1.466627559516502e-01   +2.644959762247398e-01   -1.014829253287828e-01   +7.292490787449202e-01   +8.648393833511947e-01   +1.910022119065632e-01   +3.950402392039936e-01   +8.599026400601018e-02; -5.786001179532780e-01   +5.160487231174047e-01   +8.143278436655796e-02   -1.655889273531748e-01   -3.370775292228121e-01   +3.640900188332218e-01   +5.461915416756266e-03   +2.473855033717239e-01   +5.422332611112229e-01; +8.670363330240456e-01   +1.432102942193484e-01   -4.721822052779596e-01   +3.173076987480339e-01   +3.310712693323883e-01   +4.121438704809719e-01   +1.540101073850254e-01   -5.520485894320118e-02   -6.575298445525575e-01; -2.516764194283670e-01   +2.825276758824002e-01   +3.345254894264239e-01   +1.930429774842255e-01   +8.389053488495730e-01   +7.703575428695223e-01   +5.830060554360401e-01   +2.792155898750218e-01   -9.304282503261277e-02; +3.245563557102000e-01   +1.583143285263282e-01   -4.675744159514644e-01   -6.041244242076690e-02   +2.548275541048803e-01   +1.361656500813387e-01   +6.978195275072668e-02   +3.394960992855720e-01   -2.594663986009873e-01; +2.616738141465192e-01   -3.231943007418464e-02   +4.229627815670837e-01   -2.572018338497787e-01   -5.123390855375751e-01   -5.574051346594187e-02   +3.750121841488820e-01   +3.832733109557183e-01   +6.251901075524254e-02; +6.310989629464236e-01   +1.659982322178313e-01   +4.871799000015459e-01   +1.669798070357112e-01   +1.245335298066672e-02   +6.163770707554195e-03   +1.789989499255683e-02   +2.911013129776541e-03   -2.488191751015418e-01; +1.347393948765739e-01   +5.035510334794890e-03   -4.151157017986798e-01   +2.468638514478861e-01   +2.295313637503483e-01   -3.756791148223195e-01   -4.417426833668056e-01   +1.360813771806441e-01   +5.205734775535571e-01; -2.040239987864684e-01   -3.049219319918605e-01   -6.180982024280157e-01   +2.481825839901375e-01   -1.777020216934146e-01   -3.336326592082034e-01   +3.463121202999885e-01   -6.869243382647224e-01   -9.852746746510982e-02];
L4_L1_iAMPA_netcon = [-1.918697387053359e-01   +1.142512602204884e-02   +3.203528520756933e-01   +4.186206116624441e-02   +2.589870725893553e-01   +5.067426329014142e-02   +3.569119889519878e-02   +6.794765312849727e-04   +9.963499334547754e-02   +2.470291379809431e-01   -6.252065755523604e-01   -2.234007923780998e-01; +1.290861943337569e-01   +2.688358797027111e-01   +6.303684729231378e-01   +3.084878794413540e-01   +5.640608251149093e-01   +4.076182358958512e-01   +7.877716761987585e-01   +3.070728679220250e-02   -6.280288788965473e-01   +1.358068928706055e-01   -2.300899664003119e-01   +7.236949887321418e-01; +3.616752355181649e-02   -1.417422579171875e-01   +2.239588446552843e-01   +5.715162173245838e-01   +5.149549160277623e-01   -3.821451024534936e-01   +8.502227561083453e-02   +1.893331129090581e-01   +3.173612665186190e-01   -2.691023166903981e-01   -2.231073004905846e-01   -6.680935879823982e-02; +5.814412336775938e-01   -2.909701487976535e-03   -3.213192037308530e-01   -3.318295247507306e-01   +6.114363992609542e-02   +5.513388585989903e-02   -1.600254563570455e-01   -2.904148364776397e-01   -2.565469383434474e-01   +2.939927993379892e-01   +7.025730601756228e-01   -2.669893803755874e-01; -4.121129729496861e-01   +2.425805587131052e-01   +2.646073546076669e-01   +2.741420681574017e-01   +3.178759582897770e-01   -1.330455098828508e-01   +4.711798328554193e-01   +4.692441158972378e-02   +2.358860747771001e-01   -1.780333372569165e-02   -1.553162670132199e-01   +1.048374677668024e-02; -4.947945823137722e-01   +5.964316324082897e-01   +2.851613116996887e-02   -4.310881024076361e-01   +3.349026861472309e-01   -9.970565399022302e-03   +1.865388783544092e-01   +1.681877243672317e-02   -1.008320059802450e-01   -5.131878312552380e-01   -4.386720353447107e-01   -1.205792823423131e-01; +1.413581755693556e-01   +4.488383207382391e-01   +4.009861006394887e-02   -7.091792353181275e-03   +7.786920585093925e-01   +1.075573756090906e-01   +2.713056680914576e-01   +1.832395243165170e-01   +2.313182860112289e-01   +3.894998774293522e-01   +2.384457241770584e-01   +6.239128922532946e-01; +9.115597390929016e-02   +1.986652671325226e-01   -2.350956247077730e-02   -2.316749518867005e-01   -1.477657955214211e-01   -2.085582907102587e-01   +2.199407407631468e-02   +3.596892172933187e-01   -3.376300096718963e-01   -4.082111184616737e-01   +2.603861133329594e-01   +9.769245486317352e-02; +1.649658439005524e-01   +9.300600756346764e-01   +2.378789160230659e-01   -5.736867927066269e-02   -2.234421201689291e-01   +6.184204602333025e-01   +4.374248991083102e-02   +2.047919551825344e-01   +1.870433110819344e-02   -2.636783899225045e-01   +1.854679373689965e-01   -6.265352559524904e-01];
L1_L3_iAMPA_netcon = [+6.329154199415618e-01   -5.223552840850356e-01   +6.636042806761506e-01   +1.818809528164695e-01   -4.186927876936817e-01   +3.429235521091064e-01   -1.332096541803134e-01   +3.028737916097178e-01   -3.094326106196737e-01; -3.727247052081061e-01   -5.521349561847466e-03   +1.891381472374176e-01   +3.734048987414179e-01   +3.638686330540502e-01   +4.380665320174536e-01   +3.035288901024344e-01   +2.621721594812984e-01   +3.218195210055479e-01; +4.244266028026195e-01   +3.165427495822911e-01   +1.676454890744258e-02   +3.375959925045768e-01   -6.640152913440738e-01   -7.710437416018093e-02   -6.335799758735131e-02   -4.270080274602728e-02   +4.722772043559560e-01; -1.126431461867623e-01   -2.650549221419777e-01   -2.458538302022652e-02   +2.770758361586337e-01   +5.298312884077888e-02   +4.062079136724217e-01   +1.035971128412118e-01   -1.805350950045127e-01   +4.733863545137248e-01; -2.850394987000542e-01   -6.469059917817283e-02   +6.295806567155060e-02   -4.093579018522762e-01   +5.631313086231229e-02   -3.839660979839752e-01   +2.969286549184273e-01   -3.265267168951173e-01   +1.067565528936549e-01; +7.470075907664313e-01   -6.091543966002337e-01   +4.600613828687008e-01   +5.543182096436391e-01   +2.549542959067612e-01   +1.947743352366848e-01   +4.577335086441933e-01   -5.599307416377410e-01   -4.552406310381638e-01];
L3_L1_iGABA_netcon = [+4.934297514826808e-01   -2.737101210935547e-02   +3.234354980306531e-02   +5.982651832842150e-01   -3.296219624251991e-01   -2.795520299167941e-01; +1.247000154428142e-01   +5.751265713733407e-01   -4.547412896427767e-01   +3.024771706482449e-01   +5.204525999968712e-01   +3.022338999698687e-02; -3.298495083936536e-01   +2.534101694078394e-01   -1.336971255212888e-01   -3.676065368334308e-01   +6.951808501588228e-01   +4.543645372251107e-02; -1.092407674612060e-01   -3.395375520119134e-01   +2.275008655147998e-01   -4.911078125522697e-02   +1.374833402613840e-02   -1.785823625354012e-02; -1.568837843726535e-01   +9.629134532985273e-01   -1.301721622603877e-01   -1.376779716138324e-01   +4.004810045159853e-01   +3.728087001815946e-01; +1.855349623216854e-01   +2.614403313389405e-01   -1.521809966590616e-01   -2.301236093940296e-01   +5.133020123209278e-01   +8.062561865816787e-01; +4.131166387456517e-01   +4.275107505983353e-01   +5.025683042545109e-01   +5.245649833428643e-01   +2.672729706071116e-01   +2.862752554698074e-01; +2.980437291307503e-01   -2.503877068339483e-01   +3.721231556129110e-01   -3.201391099019489e-01   +2.164758129868476e-01   +8.453935195792498e-01; -3.795897509013789e-01   -7.544808092525260e-01   +4.211406087733535e-01   +4.122760802985585e-01   +1.127556935352844e-01   -2.627114335934460e-01];
L5_Input1_iAMPA_netcon = [-3.079751946421570e-01   -2.173464837582978e-02   +4.195571035856540e-01   +1.220662241075096e-01   +2.371808885517901e-01   -3.936909801202527e-01];
L6_Input2_iAMPA_netcon = [+2.195135902956274e-01   -2.231513844125166e-01   +5.940132033340895e-01   -3.537608628637959e-01   -1.633004316320054e-02   +2.335097027728461e-02];
L5_L6_iAMPA_netcon = [-3.689686435370165e-01   -3.348490353954369e-01   +1.366649492202172e-01   +6.954102370589055e-02   -2.552811715796943e-02   -2.191250124882245e-01; -4.636549029837714e-02   +1.556162948387562e-01   +4.757365603368258e-01   +5.074654915617902e-01   +4.709121886874855e-01   +4.783342108183672e-01; -3.751878348940391e-03   +3.620412019313081e-01   +4.227897199516966e-01   +2.744925510456212e-01   -9.628378709206614e-02   -1.165868085735491e-01; -5.706018967672890e-01   +3.797747087906080e-01   +3.023979364766771e-02   +4.718043119125502e-01   -2.047765055523380e-01   +1.402778272930787e-01; +1.786231897550659e-01   +4.016322962425668e-01   -2.674779884831717e-01   -1.296187687499805e-01   +4.842130967091798e-01   +4.420078656991867e-01; +2.342331902902695e-01   +1.772264018636421e-01   +4.537777161452458e-01   +4.501383710295473e-01   +1.046655914758185e-01   -2.954681371690162e-01];
L4_L5_iGABA_netcon = [+2.880431679913614e-02   +5.367616445781904e-01   -1.084227472228186e-01   -1.154580215524691e-01   +5.627549140691110e-01   +2.500870829037363e-01   +3.987570233643828e-01   -6.558093878246033e-01   +2.019232198511038e-01   +3.018012438763243e-01   +2.282618012543593e-02   -4.378425087206261e-03; +6.054277081177744e-01   -1.876717288767413e-01   +3.623596311543258e-01   +5.856551113420595e-01   -7.257836736080885e-02   +4.429100358694510e-01   +5.987276894702421e-01   +4.985174238003952e-01   -4.003313462134353e-01   +2.094546512471535e-01   -5.701295131322515e-01   -1.450280625891714e-01; +5.540841093211623e-01   -3.407047856001826e-02   -1.716206885791991e-01   +5.505631469971188e-01   -3.637275114559908e-01   +3.652134237634927e-01   +3.418619001343265e-01   +4.147018651412279e-01   +5.288174723712266e-01   +1.710040278205220e-01   +1.327772991341431e-01   -5.550190439387889e-01; -8.372525879948632e-01   +4.433472330654528e-01   +3.865244189313455e-01   +9.451121316116353e-01   -7.273772454741712e-02   +5.886289751772983e-02   +1.216983665532775e-01   +1.291938487566996e-01   +1.237565252518285e-01   +9.630869707873820e-01   +4.122301296477988e-01   -1.270148861042279e-01; +4.506104451937064e-01   +3.610620103066520e-01   +1.044779209023586e-01   +2.306312313369341e-02   +2.331132826960020e-01   -2.562987458126215e-01   +2.007537457626665e-01   +1.848399971863205e-01   +1.266144998861075e-01   +1.579593235635252e-01   +2.438792331643392e-01   -4.789995554395231e-01; +5.023992357047278e-01   +2.846296277998344e-01   +4.417754891261043e-01   -7.218086712544232e-01   -2.477990064627510e-01   -4.524294540723786e-01   -9.074692559092920e-02   +5.511378768453119e-01   -2.359795391006764e-01   +2.679027653701901e-01   +5.333941477248152e-02   +5.877561350045644e-01];
L6_L4_iAMPA_netcon = [+1.124786897009636e-01   +6.271585141298256e-01   -1.393024169790727e-01   +4.378947610484927e-01   +1.950940408330258e-02   +5.548811024994109e-01; +1.356818821809445e-01   -3.360562507433296e-01   -4.101390449834484e-01   +5.945571226120828e-01   -1.808992611489475e-01   -2.449612511921006e-01; +1.306646878768162e-01   -5.973189669310008e-02   -9.468543911827121e-02   +3.759115973875183e-01   -2.207310431019411e-01   +7.497275357136332e-01; +6.467034927102891e-02   -1.640764762955932e-01   +4.739765115973927e-01   -1.339745403953846e-01   +1.829773536779176e-01   +2.917808390117947e-01; -3.014078928025355e-01   +3.445383800886054e-01   +9.585461174374010e-01   +7.396691571773322e-01   +2.407193980173414e-02   +5.187900798618108e-01; +9.383426272605683e-02   +6.342499161668901e-01   +3.391797127898534e-01   +3.678948066297037e-01   +3.515046987253880e-01   +2.207850286991628e-01; +7.001002361186390e-01   -1.388702149259994e-01   +2.485888973961347e-01   +6.137772860030727e-02   +2.317876646178504e-01   +3.101436376719979e-02; -4.574526614531670e-01   -1.146157760463124e-01   +5.592301663793750e-02   +5.081273795514291e-03   +2.628953131024201e-01   -6.959913930132422e-02; -5.930125044155102e-02   +3.937995535673626e-01   +8.539339842428597e-01   -3.410259717395512e-01   -2.319514168812418e-01   +8.429603571962024e-02; -1.325720924250030e-01   -1.203610480109607e-01   +2.520205162836396e-01   -3.275298804730551e-01   -3.223564741502538e-02   +7.966038172251516e-02; +3.394286439458815e-01   +7.981094185880463e-02   -5.774308463482675e-02   +1.589926794972666e-01   -1.780888519515233e-01   +2.360127858483878e-01; -1.284804485709245e-01   +2.093785420415294e-01   -2.349794704962715e-01   +2.206265397074830e-01   +7.402055126668992e-01   +1.616678458413157e-01];
L5_L4_iAMPA_netcon = [+2.007037433084993e-01   +4.141423831197731e-01   +1.471963773739821e-01   +1.098097364079778e-01   +3.046039859611258e-01   +1.078371185496826e-02; -2.940271233393542e-02   +2.238944163456377e-01   +6.072011285939620e-01   +1.937624692610471e-01   +3.054658980289270e-01   +3.701877681547537e-01; +4.173868971556235e-01   +9.061118644042025e-01   -3.039722613099021e-01   +1.609382501666179e-01   -7.594752518931741e-03   -1.038439507057305e-01; +2.566662586863416e-02   -1.400021810212577e-01   -2.100614920216474e-01   -3.238609153998098e-01   +4.779476979011626e-01   +7.209554217572424e-02; -2.827502623632029e-01   +3.577455259396358e-01   -3.935536317281962e-01   -1.641683736160185e-01   +2.156879692399640e-01   -1.963271189279009e-02; +8.007383677368270e-02   -2.419940423150840e-02   -3.994703875731129e-01   -7.524158553414739e-02   -5.203240810604793e-01   +3.056129644183344e-01; -3.312452161718165e-01   +1.358295042627350e-01   +1.724022451794344e-02   -9.313126220125176e-02   +2.388962730828690e-01   +3.207068124121076e-02; -2.902163811142006e-01   +8.032159682440763e-01   +3.708148655821821e-01   +1.301224954592426e-01   -2.534906325486701e-01   +2.997949310915460e-01; -2.731446993813836e-01   +1.895222003032578e-01   +3.356692465556572e-01   +2.163164637534478e-01   +2.407056618559292e-01   +4.458528335187855e-01; -1.004720854185003e-01   -5.403717390957703e-02   -6.229862156927399e-01   +1.124658027631751e-01   -4.277281020802884e-01   +1.053086128937823e-01; +4.697219122978642e-01   -1.172882606877155e-01   +2.557926945407974e-01   +2.436178426781589e-01   -4.577806723393190e-01   +1.201204035379941e-01; -3.672018596819814e-01   -2.267946267812511e-01   +1.971909881081142e-01   -2.356113518648324e-01   +1.582703229619305e-01   -1.529346631934354e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
