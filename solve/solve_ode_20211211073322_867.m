function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.294033807491008e-01   -1.253945382200098e-01   +2.432167410882370e-01   +4.916361132797780e-01   +2.396388765527281e-01   +2.679243382240457e-01   +5.647555103525828e-01   -5.642687473636390e-02   -4.332421140807909e-01; +2.018404579431766e-01   -6.686605277279418e-01   -2.899984421401264e-01   +3.920010207992830e-01   +3.036347967632419e-01   +2.803373731248722e-01   +5.040996033655916e-01   +1.638216302256150e-01   +3.756553950066056e-02; +2.591467352571485e-01   +3.683614981215225e-01   +4.614636521254587e-01   +2.482467239109716e-01   +2.798457159716108e-01   +3.658989541537729e-01   +6.930852116871451e-01   +7.693554408074492e-02   -5.452402366869805e-02; +2.906423239259792e-01   +9.696644318633879e-02   +2.822551618770698e-01   +9.196967306794368e-03   +1.148653556314840e-01   +3.666341393264959e-01   -5.625456336471538e-01   +7.282419995578511e-01   +4.124480617387606e-02; -2.372438323205135e-01   -1.393611378589487e-01   -4.617343507498392e-01   +3.204121339799514e-01   -2.756466610313278e-01   -7.573627309367331e-02   +2.963086843818654e-01   -2.442973736901488e-01   +3.422981348328094e-04; +1.202782435470647e-01   +9.610831086249694e-02   +2.356528534081695e-01   +2.686747288929020e-02   +3.252489056739081e-01   -2.626236737223488e-01   +3.174695562856655e-01   +8.260001161743699e-01   -1.381989070096774e-01; +1.907975791700379e-01   -8.542189630408467e-02   +7.871405457308843e-01   +3.806003378126779e-01   -1.449769704817307e-01   -5.170279364756141e-01   +5.290051446091887e-02   +5.296533630710077e-01   +6.566318169467302e-01; +3.635955594524266e-01   +4.655193914977946e-01   +1.537415092545145e-01   +1.702386197712112e-01   -6.681021233716172e-02   +6.764693439716909e-01   +1.954716676472960e-01   +9.300232428086375e-02   -1.771773919334085e-01; -6.056061733282553e-02   +7.597098323120746e-01   +7.770909671668623e-01   +3.338555347307035e-01   +4.305098405154804e-01   +1.528226749415749e-01   +3.475428547619981e-01   +2.878853570054147e-01   +4.161078319595852e-01];
L1_L2_iAMPA_netcon = [+7.826863944620895e-01   -8.294741291006234e-02   -2.552297738400120e-01   -4.514878357431992e-01   -2.065195540700609e-01   +1.387707654112129e-01   +4.544017714659924e-02   +4.847363750013348e-01   +2.478249206636358e-01; -2.891902522991975e-01   +6.078432541561209e-01   +6.412127804190543e-01   +4.916565548768805e-01   -3.648089346525738e-01   +1.835788845566548e-02   -2.441472100174503e-01   +2.267356299454439e-01   +1.224839602384858e-01; -4.663914489558874e-01   +6.503991920115352e-01   -1.918352253579956e-01   -3.816952140752353e-01   -4.470424873077001e-01   +4.748770562466663e-01   +2.509384134794891e-01   +1.152105602131967e-01   +2.809354565482497e-01; +2.747714290423566e-01   -4.686883450445471e-01   -4.197531330428037e-01   +4.102921434708433e-01   +6.683343853180730e-01   +4.488178379963669e-01   -2.318217249033373e-02   +1.509537348400194e-01   +4.625473218888232e-01; +2.425489863346707e-01   +2.049416912995218e-01   -3.567961204902492e-02   +8.929291314682943e-01   -2.139850292701522e-01   +2.064154591151809e-02   +7.276894973867664e-01   +1.153801466753181e-01   +2.777019496899364e-01; -1.380875024036219e-01   +1.687645401580664e-01   +4.599012364095285e-01   +6.926044274484250e-02   -1.445140138993204e-01   +4.440861062174817e-01   +7.248944874059476e-02   +3.702138385466485e-01   +7.089934910225894e-01; +8.391274222173802e-01   +4.244031948437044e-01   +4.026301938840576e-01   -1.825098843258844e-01   -5.291777189926791e-02   +5.295338919736214e-01   +1.101125870990767e-01   -8.883493110908727e-02   +3.110640457588506e-01; -3.327327045814976e-01   +2.752913429255202e-01   -1.847307263746258e-01   +3.942476473068452e-01   -1.721860450495333e-03   -6.769366030659044e-01   -1.917721192413789e-01   -4.293543818283841e-03   +2.937439685952704e-01; -1.934996688227225e-01   +3.125936713123242e-01   -9.802560694873121e-02   -1.086989708385864e-01   -4.186840096772924e-01   -4.722401305386235e-02   +1.000000000000000e+00   +4.688725552729320e-01   -2.186522531490404e-02];
L2_L5_iAMPA_netcon = [+1.109360722779964e-01   -3.975879897996646e-01   +1.769185969876692e-01   +6.858562971490013e-01   +2.495468753364255e-01   +2.445992482096851e-01   -2.291492284084540e-03   +3.742684294156404e-02   +5.793832927868310e-01; -8.132276085905715e-02   -2.893684313159445e-01   +3.511635761709470e-01   +6.192403120026246e-02   -6.965888128716241e-02   +3.027737626533781e-01   -1.569263628390663e-01   +3.045572322498969e-01   +1.474025458400176e-01; -2.674771037940221e-02   +5.128546296250277e-01   +1.345417067267734e-01   +1.438862376381206e-01   +3.894833982850907e-01   -8.150467152959656e-02   +2.613857221923317e-01   +4.248922046470099e-02   +8.201409373306301e-01; +1.383213820204058e-01   -1.047390490941252e-01   -6.039927833218468e-02   +3.903566719408919e-02   -4.845800992356528e-01   +5.911766282415336e-01   -3.703926010727695e-01   +2.721807133577422e-02   +1.813861450079128e-01; +6.847841879959063e-02   +1.766034376382967e-01   -3.045845083517861e-01   -1.646441027446697e-01   -6.496680424233248e-01   +5.510676630336928e-01   +1.238056683525226e-01   +2.666194325526213e-01   +2.928393449352102e-01; -2.938883769584272e-01   +3.978108345729607e-01   -5.164776940594448e-02   +1.215703521256850e-01   +8.275691092225770e-02   +1.971311102115765e-01   +7.527165917195823e-01   +4.552138805316698e-01   +4.613858125476429e-01];
L5_L2_iGABA_netcon = [-4.470455796023807e-01   +6.798915867439265e-02   +8.513516859941507e-02   -2.962345948012357e-01   +1.844205520819891e-01   -4.497302304611990e-01; -2.937770855629263e-02   +8.679873071061217e-03   +2.876581106015131e-01   +1.704738375827508e-01   +2.918227646717397e-03   -4.857632748552356e-01; +5.590515501827119e-01   -5.470275831416630e-01   +4.638472063264973e-01   -1.520505210966343e-01   +2.600383647920052e-01   +1.084505440223794e-01; +1.744870306921285e-01   +1.600443811532430e-01   +3.012748304564171e-01   +2.527025101003011e-01   -1.857857669005108e-01   -4.849028102849845e-01; -4.253186456649766e-01   -1.553227234686488e-01   +3.866653912341440e-01   +2.753938967917566e-01   +2.588496711540985e-01   -3.409256043212999e-02; +1.291519065864911e-01   +5.301983921474047e-01   +2.535757776304960e-01   -6.218012340909751e-01   -5.132304488184359e-01   +2.390589672060747e-01; +3.042087942965076e-02   -2.808249980144139e-01   -8.634796464850561e-02   +2.683956306892335e-01   +1.317020762877900e-01   +3.557889704664147e-01; +1.876762277511223e-01   +1.537262375369924e-01   +2.586821055345440e-01   -2.173192593565222e-01   -6.090514409449820e-02   -8.096246567148606e-01; +7.519539299116620e-01   +2.735443144366979e-01   +6.192722838121016e-01   +8.667427103627344e-01   +2.453380062449932e-01   -2.108764802408555e-01];
L3_L2_iAMPA_netcon = [+4.439764215429083e-01   -4.530793632023527e-01   -1.275301447992807e-01   -1.158957646585861e-02   -5.029161414948914e-01   -3.526358043482603e-01; +6.963505233301330e-02   -1.225650971341395e-01   +9.102737390803334e-02   +3.656833793785372e-02   +1.000000000000000e+00   -9.050690424152047e-02; +1.601977706923940e-01   -5.814459623938253e-03   +7.504608296475376e-03   -2.027797516148651e-01   +4.036509124545082e-01   -1.132407428227389e-01; +1.415411410401428e-01   +6.275553597003508e-01   +2.433710986904052e-01   +2.400823563604945e-01   +4.354783020779416e-02   +7.686320867298483e-01; -2.599039645382084e-03   +8.702191682129824e-01   +5.112690271379640e-01   +5.275680065709332e-01   +3.728396598287468e-01   +3.896676172269632e-01; -2.910336051882665e-02   +6.327274094892251e-01   -4.596910828106740e-02   +1.350244697097609e-01   +9.503496192738639e-01   +2.208214662277483e-01; +5.819194403695760e-01   +2.344056813867040e-01   +4.959613518342590e-01   +2.646254769541448e-01   -9.269615586436697e-02   -4.508165900753528e-02; +8.032650606847838e-03   -1.562720202600376e-01   +5.902644682701224e-01   +2.484620324867556e-01   -7.741473665479763e-02   -3.623172472663721e-01; +6.917128425114749e-02   -4.575888729794603e-01   +3.887306424754183e-02   +3.846834310866508e-01   -2.633247671708008e-01   +1.425642455679535e-01];
L2_L3_iGABA_netcon = [+1.552628922918465e-01   -2.105504708755889e-01   -4.637258056956832e-01   +4.048952847543413e-01   +5.217799098375429e-01   -3.947553793829927e-01   -6.521235411967258e-02   +2.395413787209163e-01   +6.833626106296387e-01; +6.027104285501177e-01   -1.519272400886067e-01   -2.751714235328014e-01   -7.664258710174285e-01   +7.321138155337912e-01   +2.325119402365440e-01   +4.929276433114645e-01   +1.957128834992590e-01   +3.022372411511978e-01; +2.857780619765482e-01   -8.792814154998529e-02   -3.020492883251946e-02   +5.303913374774073e-01   -5.869963579735166e-02   -2.171112939042313e-01   -1.166999322343042e-01   +1.011483877046611e-01   +7.144589349803774e-01; +6.232290978742155e-01   +1.934323042185172e-01   +1.618669297104545e-01   -1.888104042839870e-01   -1.400442860521454e-01   -1.125405119559444e-01   +6.853674838741497e-02   +2.561811161325270e-01   +4.214144330922955e-01; +7.341869042150195e-02   +6.478187487104459e-02   -8.363538657039593e-03   -8.750922904505831e-02   +5.659842353938001e-01   +7.822155385134180e-01   +2.507510980216701e-01   +3.263775368695350e-01   +5.211192475226532e-01; +3.051329304082566e-01   -2.199298043528116e-01   +4.440559428296573e-02   +4.540932320975209e-01   +4.391816494793144e-03   +9.421281886287758e-02   -3.519854723256388e-01   -5.336971249967133e-01   +2.424788565471767e-01];
L1_L4_iGABA_netcon = [-1.943094614559502e-01   -3.418109766758129e-01   +1.937187945591555e-01   +4.103159203557494e-01   +6.456314837044581e-01   -4.350163703009403e-01   +3.800161727568629e-02   +8.811217135545299e-02   +5.496156376319106e-01; +1.880044058959896e-01   +5.005273047774247e-01   +3.276595905097624e-01   +8.806055517192461e-01   -3.919449683603844e-01   -5.979353636738216e-01   +4.339416364704051e-01   +6.867580694828096e-03   +2.025185158138229e-01; +9.559416176717745e-01   +3.287824181837366e-01   -5.128846028506105e-02   -1.069414723588002e-02   +4.606961971520259e-01   +4.397886410481764e-01   +1.014145612077179e-01   +6.278685916081637e-01   -1.720259356735413e-01; -5.848732896745035e-03   +3.532605136759421e-01   +1.447993195258678e-01   +4.836003220744682e-01   +4.335001386421389e-01   +7.495341425532780e-01   +7.093361406813235e-02   +4.365966798305197e-01   -2.713030337827054e-01; -5.150995097152365e-01   +5.086536137339601e-01   +3.240805329282194e-01   -6.352621195002983e-02   -5.949156907934978e-02   +1.990779376096502e-02   +1.499440845186080e-01   +6.241221038268684e-01   +7.473354088590489e-01; +8.925471982754081e-01   -3.732676464891399e-01   -9.760950786674240e-02   -1.378897131488491e-01   -2.775323647657250e-02   +5.821853333404977e-01   +2.678607437877641e-01   +1.745452850595549e-01   -6.280775390358406e-01; +3.116827385095640e-02   +2.792806282312932e-01   -2.076354071149976e-01   +8.284532861991042e-01   +6.367459423825170e-01   +8.443645438375806e-01   +5.277206942438324e-01   -2.655090806741278e-02   +2.625079833085999e-01; -2.910141063104118e-01   +2.076512703705857e-01   +4.601806743457593e-02   -5.940482989277419e-02   -1.221375108561586e-01   +7.178081643547560e-01   +3.245943613291025e-01   +5.272793364257954e-01   -1.503692094195208e-01; +2.240858030108058e-01   +3.903899816982009e-01   +5.139893877819284e-01   -2.826676599977022e-01   -4.413180382249959e-01   +1.622228815862818e-01   +2.304703428038877e-01   +3.563570401895137e-01   +1.279248240169783e-01; +7.039728707842079e-01   -2.822306966189558e-02   +4.843243992770990e-01   -3.837108694914292e-01   +2.122753890972664e-01   +4.469381369942679e-01   +1.005890247285262e-01   -5.747347820458268e-02   -2.076346026972078e-01; +4.388154952794395e-01   -3.098558180565748e-01   -1.604668649610069e-01   -2.122375774994077e-01   +2.992661795877046e-01   -1.773791980615641e-01   -4.376659455835243e-01   -3.792270481724483e-02   +3.208343439109923e-01; -1.501425159692367e-01   -5.432324491129128e-01   -2.144801601963331e-01   +1.195185576326609e-01   +2.465839087255111e-01   -3.623168944694086e-02   +5.054392796123008e-01   -2.015031079522788e-01   -4.155792903967412e-02];
L4_L1_iAMPA_netcon = [+1.324230178509730e-01   -3.063491194426955e-01   +4.105389893856189e-01   -3.730313754920065e-01   +2.150985349379420e-01   +5.021586473776342e-02   -2.051854585810525e-02   +1.934588423993908e-01   +8.064447475164974e-01   -4.999553370531884e-02   -2.365744623170677e-01   -1.434615203060860e-01; +4.574241379773702e-01   +3.104826909742937e-01   +6.796833752445832e-01   +6.834230130351108e-01   +1.469804711026872e-01   +1.768617683350828e-01   +8.019967724609784e-01   +1.460023522361038e-01   -4.356508126265656e-01   +1.079852382044390e-01   -3.152634865025016e-01   +6.916985140083363e-01; -5.853562642514720e-02   +2.920915568009930e-02   -8.062384272982362e-02   +2.735308348482436e-01   +8.300494200154349e-01   -5.583816613657793e-01   +1.321660997988366e-01   +3.317047759968861e-01   +4.855894678457946e-01   +2.405659741217998e-01   -1.162223175368451e-01   +1.550002749154701e-01; +2.211249732655252e-01   +5.672263166606994e-01   -5.381344046501398e-01   -2.469936780660484e-01   +3.645458233750969e-01   -1.811026668613144e-01   +4.655249655607309e-02   -2.451287120928610e-01   +3.821511893959616e-01   +1.996108849051868e-01   +4.942378323983982e-01   +1.744809591108565e-01; -6.133462595864343e-01   +2.897733755814191e-01   +3.942120098834804e-01   -4.440017408742677e-01   +4.782704183940912e-01   -4.275210056608360e-01   +5.268726651918467e-01   +3.230792545568268e-01   +6.034840256381311e-01   -1.661680210576102e-02   -1.152507287580418e-01   +1.744976634308192e-01; -5.085606095281561e-01   +8.888117666261079e-01   +2.029643737337053e-02   -2.160735020669234e-01   -2.272318849252718e-01   +1.626799222922662e-01   +6.568142386727788e-01   -2.356770047533888e-01   -2.966070407951758e-01   -3.472386533362661e-01   -3.713381117570370e-01   -1.877666893854193e-01; +3.006539711342869e-01   -5.967427196585746e-02   +2.375057351425899e-01   +4.647050816564704e-01   +7.059820591979710e-01   +3.091567712277213e-01   -8.023312406211877e-02   -1.794301483101979e-01   +4.612811247801864e-01   +5.630647730743635e-01   +4.915827699817277e-01   +6.173840443931307e-01; +4.645214997793585e-01   +4.544124265474562e-01   -2.174546741394480e-02   +3.884342308960570e-01   +1.198538959356568e-01   +3.958565218749262e-02   +5.724532420233322e-02   -3.618009395847291e-02   -8.185565711665986e-01   -1.163952496344924e-01   +2.321411213977773e-01   +6.536251914571376e-01; +1.058349127055403e-01   +5.449955909409510e-01   +4.968322290876303e-01   -1.303063241161402e-01   -4.613318944410568e-01   +4.772408824926325e-01   -1.416906086936545e-01   +4.484869174994957e-01   +1.394212838687613e-01   +1.162883683465055e-01   +1.140846917168536e-02   -3.037645861755942e-01];
L1_L3_iAMPA_netcon = [+5.582175570407535e-01   -3.534328275240762e-01   +4.825727132997300e-01   +1.909921752661614e-01   -3.067986449913017e-01   +2.418579609583721e-01   -1.425672754353149e-01   -8.244775264143209e-02   -3.750250081633086e-02; -7.479667609516628e-01   +3.672012294874911e-01   +3.754008052157926e-01   +8.533278912127188e-01   +2.563259942918933e-01   +9.928552796026695e-02   +3.247934401286540e-01   +1.103926167125296e-01   +4.914403942865931e-01; +7.101796463412089e-01   +8.354328123980757e-01   -1.756277997494590e-01   -1.851439269622510e-01   -4.563061116533044e-01   -5.471764964951276e-01   -1.856996842033748e-01   -4.037047241943650e-01   +5.740171179392046e-01; -2.392486976099818e-01   -5.652862853559704e-02   +2.251688874129681e-01   +1.793517926808977e-01   +1.094607219756767e-01   +3.091977174941904e-01   -6.389009969729234e-01   -6.034102218349801e-01   +9.714738712284517e-01; -7.382767333114643e-02   +2.542584875034326e-01   -8.468939200043836e-02   -2.544122530079599e-01   +3.587116185924606e-01   -6.584778398334237e-01   +6.616249381518360e-01   -4.645509711356435e-01   +9.258934915044620e-02; +5.407663592150287e-01   -5.141249280544297e-01   +4.701650456818001e-01   +7.342188931040698e-02   +2.836559869284950e-01   +2.618757880055312e-01   +4.202951966476451e-01   -1.800474524757945e-01   -1.566470127962462e-01];
L3_L1_iGABA_netcon = [+7.826070068911936e-01   +2.930914877431345e-01   +2.408872651397936e-01   +7.621498015498980e-01   +2.308577286434532e-01   -2.566938241364374e-01; -1.798739892792353e-01   +6.286473506917685e-01   -3.352677948111534e-01   +2.082439188919628e-04   +1.739325262923467e-01   -4.831397553349823e-01; -5.945086088502161e-02   +9.663155185128323e-01   +1.528306670210938e-01   -6.456684306705582e-02   +6.221276861508007e-01   -1.088474685774941e-01; -2.242509164949616e-01   -2.426379126015174e-01   +4.583439566502829e-01   +2.461523991780713e-01   +7.434719731929931e-01   +2.559030137299557e-01; -2.408242040627460e-01   +8.627653628621512e-01   +3.594259194143037e-01   -3.966762522450189e-02   +1.202208313326810e-01   +1.360981628724586e-01; +3.037767603752588e-01   +1.692041834003289e-01   -5.057537587681626e-01   -3.506077303728675e-01   +2.389593414184773e-01   +5.458213519715526e-01; +1.622929487662972e-01   +3.213816407482126e-01   +3.787879312110136e-01   +2.844249541491995e-01   +2.109699005863754e-01   +4.481232525531355e-01; +3.308790687448733e-01   +8.208990052560761e-03   +1.411781671046760e-02   +4.412926472657669e-01   +1.540143704132082e-01   +7.352217931323919e-01; +2.719329849427053e-02   -6.389036610043244e-01   +2.920547972967964e-01   +2.813920466003137e-01   -2.769353970967645e-02   +1.125551621611426e-01];
L5_Input1_iAMPA_netcon = [-2.252353030871230e-01   +2.728332984097036e-01   +6.511085082102388e-01   -2.291230333831689e-01   +7.849996713561260e-01   +9.677109837621503e-02];
L6_Input2_iAMPA_netcon = [+4.448186589033924e-01   +1.833612631874850e-01   +5.334825127647203e-01   +5.324234536184655e-02   -2.738047182710341e-01   -2.900233068938866e-01];
L5_L6_iAMPA_netcon = [+1.449288870001093e-01   -7.934725324276537e-02   -4.786771542255976e-01   +2.159419418647276e-01   +2.409114669603019e-01   -7.764929120902511e-01; -2.058352896023727e-01   -2.067029129482761e-01   +4.324102295522098e-01   +5.974150826255396e-01   -4.825989361428501e-03   -3.508765253782051e-02; +7.069854576559627e-02   +9.017641223290643e-02   +4.391033009841306e-01   +3.054444441349177e-01   +2.454993806801162e-02   -4.641589347436726e-01; +5.270744612420296e-02   +3.433230836492288e-02   -1.737660988507803e-01   +9.161218805990061e-02   -1.813477802808919e-01   +3.960730476180246e-02; -5.222693104987045e-02   +3.167290496576090e-01   +1.273523471924593e-01   -3.014354151305682e-02   +5.962925307295517e-01   +1.696009066836794e-01; -1.584205535533379e-01   +3.080909951942615e-01   +7.879215199548936e-01   +3.270426495224009e-02   +4.413039992305317e-01   +3.746883886198278e-01];
L4_L5_iGABA_netcon = [+6.036721767465787e-01   +3.870711101633265e-01   +8.031071928744704e-02   +2.138830018895704e-01   +5.026712357925298e-01   -7.984916309150951e-02   +1.874851405450763e-01   -2.379786234408068e-01   +5.386473911328281e-02   +3.603840208821077e-01   +3.422714576420994e-01   +2.379146779546836e-01; +3.462681324757862e-01   +3.918693881083242e-01   -7.175814765455406e-02   +8.259197769186324e-01   +2.292021705502127e-01   +3.087983770977794e-01   +5.119821717149284e-01   +1.275357415738547e-01   -4.194915717913437e-01   +4.087266416442574e-01   -3.322798872618258e-01   +3.142353333290454e-01; +6.838942838397667e-01   +8.844481390251697e-02   -2.389521378199538e-01   +4.415308664394045e-01   -1.066915866645611e-01   +1.134668266159714e-01   +1.256244072558369e-01   +2.678842274906212e-01   +1.143178013495219e-01   +7.341505264689376e-01   -1.662874031598257e-01   -1.993268104497721e-01; -9.009290367725047e-01   +1.532374487615169e-01   +6.756568173323111e-01   +7.313207100388676e-01   +3.343749424220497e-03   -7.172448716266391e-03   +3.366890980992473e-01   +4.237464604063384e-01   -9.150910368845191e-02   +1.000000000000000e+00   -4.117214450556782e-02   +9.264416115274471e-02; +3.899529491759851e-01   -7.677828975073549e-02   +4.090449938708758e-01   +8.202639946541587e-02   +5.634980160955080e-01   +5.403716137432981e-01   +5.873650099542655e-01   +1.913537998236400e-01   +3.064496009980301e-01   +1.075592658911451e-01   +2.965345342697794e-01   -1.881160997033044e-01; +6.953175802232898e-01   -1.293576462362477e-01   +2.174684169574561e-01   -5.559575766670217e-01   +3.542433502252288e-01   -6.229898207534413e-01   +1.600359699671851e-01   +3.733019165211115e-01   -2.621193388368352e-01   -1.103848136923026e-01   +1.085876564767884e-01   +1.597619044819778e-01];
L6_L4_iAMPA_netcon = [+1.882512432232112e-01   +5.887064907704496e-01   +3.022065444217188e-01   +3.157759091720366e-01   -1.067429141030842e-01   +6.352902334593440e-01; +3.839929687732573e-01   -2.046493269057608e-01   -2.228250522578889e-01   +5.741178490107521e-01   +8.063967869375802e-02   -1.117699816293336e-01; -5.313958639598164e-02   -3.639845492898975e-01   +2.684669626938101e-02   +4.486540320350877e-02   +2.131997873597853e-01   +7.046275764524358e-01; +5.077781878955701e-01   +3.438193951616601e-01   +4.079397358346867e-01   +2.882050525045441e-01   -1.351336107492473e-01   +3.752057502672668e-01; -4.869951460878436e-02   +1.688081419730473e-01   +7.970065879169476e-01   +6.471787057223641e-01   -2.074195211158452e-01   +6.056670578266189e-01; +2.681736444266163e-01   +3.126798327240630e-01   -1.878962895210665e-01   +4.680345562301845e-01   +3.616458603285482e-01   +2.581060223505692e-01; +5.495856101793182e-01   +1.237893354051362e-01   +2.152922548382485e-01   +4.621179398550191e-01   -7.856005166326736e-02   +1.667062617819115e-01; -1.842384521265091e-01   -4.491579333327316e-01   +1.118776632815470e-01   +4.343544004191875e-01   -7.778012599261243e-02   -3.476690794570707e-01; -9.335844017825877e-02   +1.023629092014621e-01   +1.000000000000000e+00   +1.199120398352212e-02   -2.943585943948978e-01   +2.863553353902253e-01; -1.394532533820217e-02   -5.502298150003975e-01   +2.400087019705902e-01   -1.403916026167116e-02   +3.035135637109574e-01   +2.944285249813360e-01; +3.467875157360228e-01   -8.445465951039913e-02   -3.087408694730377e-02   +1.517259023369131e-01   +3.836782041166624e-01   +4.053355128443358e-01; -2.972960313357284e-01   -2.306944326829216e-01   -1.328272144291647e-01   +6.272212249471530e-01   +4.592585173102929e-01   +1.235506878617742e-01];
L5_L4_iAMPA_netcon = [-1.675704505664980e-02   +2.733137212467029e-02   +1.279549205204554e-01   -2.543374293470911e-01   +5.191939929330782e-01   +3.129921807664483e-01; +1.347872091960607e-01   +1.825654589837795e-01   +4.162676937820029e-01   +3.966039256888501e-01   -1.291877678303434e-01   +6.502684539859555e-01; +5.775354139317227e-01   +6.182776179744959e-01   -7.082252063353753e-01   +4.844666972223625e-01   +2.884894304047545e-02   +2.019074568866666e-01; +3.396266951301775e-01   +4.321629190658182e-02   -4.206567578804940e-01   -5.109484740943551e-01   +5.960029949786099e-01   +7.906693551944585e-02; -2.489230058700233e-01   -2.474843191663441e-01   -1.602083754994907e-01   +4.314312497223771e-01   +2.954624465537701e-01   +9.164652313472063e-02; +2.753624945942782e-01   +4.746931133997169e-01   -8.280570307168932e-02   +1.130457177216332e-01   -3.814684782809695e-01   +7.863905670525937e-01; -7.439120670675722e-02   -2.832147791572037e-01   +4.565139912796053e-01   +6.981205097292634e-01   -1.026584676981840e-01   +7.775392253266680e-01; -4.311961510857660e-01   +6.521661214517874e-01   +5.988041571608813e-01   +7.390118609604182e-02   +2.905083275803682e-01   -1.526249130738243e-01; -3.117008689814617e-01   -2.055893592914106e-01   +1.816489342025168e-01   -1.406662796111389e-01   +6.025559887454714e-01   -8.956959219854771e-02; +3.135908963522410e-01   -1.808361859008786e-01   -3.136070734469488e-01   +3.180254582883152e-01   +1.860301150724541e-01   -2.369467041343087e-01; +3.577196483267455e-01   -1.830494400452335e-01   +6.806756530701605e-02   +2.153481898485779e-01   -3.301456067759748e-01   +1.598879639693775e-01; -2.302182305391256e-01   +1.980414741336054e-01   +2.037192492135069e-01   -1.743326316453761e-01   +3.607973778307890e-01   +1.756414589894307e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
