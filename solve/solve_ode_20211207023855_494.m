function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.367393797660828e-02   +2.637781286521043e-02   -1.350897929044684e-02   -7.449527990913507e-03   -7.895541657589600e-03   -8.052230750958025e-02   -8.529021661489706e-03   +3.465933978090811e-02   +5.619339932902544e-02; +2.782642156570963e-02   -3.711242582532694e-02   -3.995288101947042e-02   +1.040799035716315e-02   +7.475306782186964e-03   +4.239184271108848e-02   +2.302021833714566e-02   -6.290345731021044e-02   +5.442916977635061e-02; +3.629076906158317e-03   -3.704956912361253e-02   -1.325474131466577e-03   -3.140739953281572e-02   -4.380223537287007e-02   -1.898940364727928e-02   -2.665379402177404e-02   -2.621073253584819e-02   -5.493108851074551e-03; -3.977436122260728e-02   +7.492930766695658e-03   +2.568710100198663e-02   +3.092165436928775e-02   +7.954576406802150e-02   -5.192327201204085e-03   -9.006068861357783e-03   -6.743020406914210e-03   +4.100183803249558e-02; -1.347340689560324e-02   -1.426395051726402e-02   +9.742275004711379e-03   +1.474171218134097e-02   -2.036474450570386e-02   -4.897315606750795e-04   +2.414315994073032e-02   -3.462757277557753e-02   -1.241772240517778e-02; -2.668133324946888e-02   +3.221022424909063e-02   -5.255860738840282e-02   -2.470343400359495e-02   -1.245323554325731e-02   -6.786876999519662e-02   +3.869378261096974e-02   -3.180051100763995e-02   +3.684634089898002e-02; +1.298147522407373e-02   +4.418042891491612e-02   +7.260151047610777e-02   -6.642025112397476e-03   +4.210647313913846e-02   -2.030420569854429e-02   -2.062423344598687e-03   -4.766112052687625e-03   +1.559546011744656e-02; +3.709869399849332e-02   +4.283409301724631e-02   -2.605560665179864e-02   +1.504597764244184e-02   +4.073015889842643e-02   -1.666676923965427e-02   +6.509026458862982e-02   -1.828913019344413e-02   -3.244795449950832e-02; +4.223970607613747e-02   -2.932177863687418e-03   +1.951420999234398e-02   -1.775378482118781e-02   +5.134779250265309e-02   +3.647237773723280e-02   +3.779747547949424e-02   +2.640989027803551e-02   +2.676402025026428e-02];
L1_L2_iAMPA_netcon = [+3.538713661476664e-03   -2.450764738932532e-02   +1.045182890920826e-02   +6.960653190246401e-03   +3.398961330767929e-02   -7.287606436248953e-02   +3.042264385644624e-05   +7.712207907111836e-02   +3.041912782084957e-02; +4.963481999136697e-02   +1.662469004250710e-02   +3.981694713941514e-02   +1.582636565940623e-02   +3.927571540826690e-02   +4.327699322682805e-02   +1.896658911286012e-02   +1.789420642965164e-03   +5.889805965642254e-02; -3.761607367416085e-02   +1.315861461091141e-02   +4.200854260090839e-02   +1.368909554137477e-02   -1.648319015698254e-02   -6.433975396705088e-02   -1.496312002206404e-02   +6.043814245972717e-02   -2.649046428676315e-02; +1.469068954518777e-02   +1.080444725335685e-02   +3.568265101030652e-02   +3.730452776255339e-02   -2.929718279948340e-03   +2.482577317208531e-02   +4.211786262046660e-02   -5.078830741854554e-02   +6.749237554288207e-02; +4.909334535229329e-03   +5.010638124863548e-03   -4.964340207895361e-02   +1.360459068059399e-02   -4.213157876545420e-02   +7.531608534029235e-02   -7.867631246374233e-03   -4.696685448328627e-03   -1.158680452309680e-02; +3.489404131214367e-02   -3.246248509999249e-02   +1.035290426738793e-02   -8.023001143167376e-03   +4.310635700881610e-03   -2.309691942747043e-03   +3.465792435573149e-02   +6.146519004960717e-02   +1.728755082364211e-04; +1.372228045401546e-02   -9.122167396784474e-03   +4.705593328680269e-02   -2.716787716757704e-02   +3.957721297750452e-02   +3.716199583634570e-03   +4.038778242137841e-03   +4.356602295892690e-02   +7.846961614896734e-03; -1.549570106059155e-02   -5.699295923822683e-03   +6.669582000544542e-03   -1.726595543258416e-02   +8.593463261776235e-03   -1.795663658937910e-02   -3.606450222019413e-02   +9.133778652042847e-03   -1.190920703573376e-02; +7.742041483993756e-02   -2.833990665679667e-02   +2.808578711035980e-03   -4.810073379137757e-02   +2.009834056779853e-02   +1.368159933962639e-02   -2.431280199507672e-04   -4.563809978719661e-02   +2.628202450443750e-02];
L2_L5_iAMPA_netcon = [+3.899172968077916e-02   +4.351987514267382e-02   +4.893794646602563e-02   -2.076944770404140e-03   +6.415872700834621e-03   +6.847787297969400e-03   -1.172749662281234e-02   +1.635697066851589e-02   +2.254236647292450e-02; -3.148404288556652e-02   -1.240318262448875e-02   -2.808678076800547e-03   +6.108182829920868e-02   -2.010877062278152e-02   -6.051677924421572e-03   +3.432804150586310e-02   -2.086439022145724e-02   +4.111757014241404e-02; -7.235388487523087e-03   +1.940357717029306e-02   +3.346783306796135e-02   +9.873891544199966e-03   -2.609772248233797e-02   +9.551674852916694e-02   -1.223477164162188e-02   +7.018559671720300e-03   +3.735922340556688e-02; +5.360096979762590e-03   -1.836431603181915e-02   +5.373148272915983e-02   +1.085984671099962e-01   +1.632823421990388e-02   +1.821835135002683e-02   +2.056784105802116e-02   +6.660200161491894e-04   +6.489729590692217e-02; -1.868995712410640e-02   +4.094802523053434e-02   +6.712199733947333e-02   +1.275052245946848e-02   -4.190537144224301e-02   +6.706012008133940e-03   +3.670090293645571e-02   -1.794081273628396e-02   -7.581005989989027e-03; +1.151303377613773e-02   +9.499814034656648e-03   -1.837106722272005e-02   -2.605699219576590e-02   -5.398187994425513e-03   +4.977657159977496e-03   +2.100911028872818e-02   -2.194992116449711e-02   +3.057923559337564e-02];
L5_L2_iGABA_netcon = [+1.298470166217760e-02   +7.039055120416932e-03   +3.080877459490052e-02   -2.526683230124616e-04   -2.208343441851406e-02   +9.493558021991984e-05; +1.054131746939904e-02   -2.568221200191655e-02   +2.678188258023485e-02   -5.372703092207600e-03   +1.087729698283155e-01   -6.521447140153742e-02; +3.559559148272594e-02   +4.950793616307132e-02   +1.574008870660117e-02   -3.373168319128739e-02   +2.479091857931215e-02   +6.947018107366049e-02; -2.672919265437190e-02   -1.623257185458694e-02   +5.203776855427147e-02   -4.299028603749417e-03   +5.651572552156982e-02   -1.172638573607277e-02; -4.001627437236824e-04   +2.833656531060709e-02   +1.037995237192089e-02   +2.615114058226437e-02   -1.272701602485206e-02   +3.233909609004002e-02; -5.335836148046946e-02   +5.220337421926995e-02   +2.268110933013039e-02   +1.636508033753263e-02   +8.195360207881443e-03   -2.800724350133591e-02; -6.604905063206956e-02   -3.281573136683977e-02   -6.273693842022410e-02   +1.422178225602119e-02   -1.768270150229176e-02   +3.487861040315464e-02; +2.473481945808905e-02   +1.066254398270335e-02   +3.545137577107309e-02   +3.424901402244827e-02   -1.814352323862915e-02   -3.513858756284217e-03; +6.984859509843996e-02   +5.344581258105587e-02   -8.361935209510313e-03   -3.419378714033677e-02   -9.121058311219560e-02   +1.620607322952024e-03];
L3_L2_iAMPA_netcon = [+2.303447752347864e-02   -4.500388176379873e-02   -4.490331952485947e-02   -2.923952755708738e-02   +4.627620157308814e-02   -2.283312559925720e-02; +7.488436262350592e-02   +4.587771713055042e-02   +6.423932099785759e-02   -2.857887069824679e-02   +1.530278277011939e-02   +3.659232738816526e-02; -3.926394093404596e-02   -4.767031295413439e-02   +2.698805875879212e-02   +4.431496134020589e-02   +1.267959334712292e-02   -2.291494481548418e-02; -3.041481089510202e-02   +3.546036609873977e-02   -1.594164600816889e-02   +2.022476666676921e-02   -2.888649796174987e-02   -2.570910097030299e-02; -3.826029417335512e-02   +8.597893276091161e-03   +9.491978886224894e-03   -1.628621769167371e-02   +1.596210723840227e-02   -1.821867413690447e-02; +6.612382346134107e-02   +5.550769228427577e-02   -8.670490816251189e-03   +2.219018585856763e-02   -1.062520369179706e-02   -4.471508356519255e-02; -3.693569088366340e-02   +1.268102726620896e-02   -3.999914278035906e-02   -1.607337117296635e-02   -1.002589090786953e-03   +2.834496499043900e-02; +2.281336582498537e-03   +6.074894131051135e-02   -1.307159940082408e-02   -3.608730094514048e-02   -2.127066761384803e-02   +6.891567238857260e-02; +4.059790733804744e-02   +2.271925977538453e-02   -1.833481259345811e-02   +5.564403949374951e-02   -1.852533669500409e-02   -1.213520815336648e-03];
L2_L3_iGABA_netcon = [+5.372100815702577e-02   -5.227030958653762e-02   +6.543290565792850e-04   +4.283576353211322e-02   -2.851576067324481e-02   +2.107444281477497e-02   +3.726432227884269e-02   +5.192381376843684e-02   +5.171617124860078e-02; -4.662070292590249e-02   +1.885585857429536e-02   +4.221046636525591e-02   -6.581592507517255e-03   +7.740837529856523e-02   -4.385705032537282e-02   -7.154663945594322e-02   +2.095732363121080e-02   +5.391972083860369e-02; -3.271359718962082e-03   +8.417710524088930e-03   -2.010468975712146e-02   +8.563701695949373e-03   +5.222152496759054e-02   +3.605120702141915e-02   +2.835608899102007e-02   +1.008936138128797e-02   -4.407831567457866e-04; -4.503537792559660e-02   -9.096908835314425e-02   -1.347821687821784e-02   +2.060720666984305e-03   +5.325539958734292e-02   -5.226782800918892e-02   +1.307679703276908e-02   +2.142661940687071e-02   -2.204252154094646e-02; -5.220875368932829e-03   -3.738637386226290e-02   -1.034269050396153e-02   +1.490360808557814e-02   +2.283409827273478e-02   -5.676399376485194e-03   +1.369420556564772e-03   +3.558074503548626e-02   +1.314658187807847e-02; -2.864608771546513e-02   +4.123550233804951e-03   +2.705746868399709e-02   +5.350498413864556e-02   -3.344107397863861e-02   +7.058157594245919e-02   -3.077355109611677e-02   +8.641715198958598e-02   -4.443860574401784e-03];
L1_L4_iGABA_netcon = [+2.144722603476414e-02   +5.923284127345873e-03   +2.336938148381697e-02   +1.822688192359109e-02   -9.021794238826038e-03   -3.340719592458439e-02   -8.745951588911366e-03   -8.112583422445402e-02   +3.899817507374882e-03; +4.611847311558957e-02   +4.432713947853620e-02   +6.573142822043362e-02   -1.281683558638814e-02   +6.318954119816461e-02   +3.465337322357592e-02   +6.524127451355466e-02   +1.222223146709464e-02   -1.723697171810527e-03; -1.555370397140981e-02   -3.379431849591039e-04   +4.674507420679424e-02   -3.700754658634715e-02   +1.365642933250728e-02   +2.408205471695966e-03   +6.487450190526255e-02   +1.689308998571865e-02   +2.138703868259472e-02; +2.611906507668176e-02   +2.270276127384073e-02   -2.742620147118621e-02   +1.903513464281867e-02   -1.839054025432849e-02   -5.957353853573791e-03   -3.572709712660889e-02   -1.374250976651402e-02   -2.156642881647895e-02; +5.113624955267113e-02   +1.986314111738753e-02   -1.204591309684602e-02   +1.576766107594110e-02   +5.197158411325287e-02   +1.595691489321217e-02   +9.515644926540220e-03   -4.327860978185012e-02   -2.174945289671432e-02; +4.149141598694980e-02   +4.325707102126276e-02   +4.103043592852192e-02   +5.736447565997445e-02   -2.896599134600628e-02   -2.838218545575222e-02   -5.214089316628895e-02   +3.695991649439555e-03   +2.429260558548446e-02; -5.392494184622505e-02   +4.039069583952919e-02   -4.004183736057501e-02   -5.011861975741452e-04   +7.870958478016287e-03   +1.909561370032707e-02   -2.564229986201781e-03   -6.566742712090731e-02   -1.520820347513765e-02; -2.678598131005770e-03   +1.903290231203595e-02   +6.293422091718953e-02   -3.860147680082346e-02   +3.965451272546473e-02   +3.129855060545328e-02   +6.058307402120131e-02   +1.636982120954067e-02   -1.608641728803256e-02; +2.360561073412449e-02   +2.152000520666214e-02   +6.550776661095499e-02   +1.738116454113318e-02   -1.045599828286294e-02   +3.638136627482898e-02   -3.398695874048045e-02   +2.600044602732034e-02   -4.023343773098156e-03; -1.160590229293011e-02   +5.634479305885497e-02   -2.729593309499402e-03   +2.024644111361701e-02   -4.414544293468724e-02   +7.998925326350884e-03   +4.527959547520844e-02   +8.929266655652981e-03   +3.917641286951258e-02; -8.793682173787096e-03   +6.439385733515686e-02   +6.100402664297093e-02   -2.717077753902686e-02   -7.178821170190650e-02   +2.414708862451696e-02   -2.926408525397132e-03   +5.478050561042522e-02   -1.925732923997338e-03; -5.326122673901339e-02   -3.295564726937605e-03   -1.281707715013496e-02   -2.352383083604911e-02   +3.221601998894090e-02   +3.868558244424786e-02   +7.717712600335655e-02   -5.323595112885990e-02   +7.744742420420284e-02];
L4_L1_iGABA_netcon = [+1.617539730824478e-02   -4.432283586974585e-02   -1.425297450545271e-02   -1.187012181156169e-02   -3.295078859091684e-02   +4.598040981696397e-02   +2.427686295337642e-02   -9.049038469589900e-04   -3.471753223168565e-02   -2.492827077405320e-03   -2.426273715581720e-02   +1.742804758240513e-02; +3.050380274241520e-02   +5.994922643005876e-02   +1.036907847954149e-02   -3.932618014792494e-02   -2.147918848757361e-02   -3.892768152486220e-02   +7.916783793915694e-03   +2.396985275605162e-02   +9.920225326166647e-05   +2.749500204846823e-02   +8.294897408633999e-03   -1.694571774917020e-02; -1.937257706909109e-02   -3.858498354226648e-02   +1.806730449649203e-02   +2.121789914281592e-02   -3.111226599175661e-02   +6.371579404192923e-02   -1.775735392181612e-02   -1.641746017468831e-03   -7.009247303681653e-03   -3.148194678337517e-02   +3.966224083850181e-03   +5.740636522910075e-02; -1.130221629861067e-03   +4.256025308720029e-03   -8.885375114872914e-03   -1.455657804541897e-02   -1.099440723368761e-02   +4.902596126088093e-02   -4.275916073214200e-02   +2.269447394855216e-02   -3.778236233072424e-02   -1.836240711240558e-02   +3.953297389477177e-02   +5.088298020268735e-02; -8.779314032548466e-03   +5.227505706052916e-02   -1.406813000191732e-02   +3.432588144250855e-02   -4.669948066636997e-02   -1.814947046056973e-03   -1.807747440163084e-02   +1.819987211040814e-02   -1.853036286028978e-02   -6.717001279310045e-02   +3.745106505269160e-02   +2.845620984406692e-02; +8.464027629964989e-03   +5.626389236554422e-02   -6.854377465247750e-03   +4.298421886326811e-02   +3.481004814592884e-03   -1.388311612113493e-03   -3.865295794279926e-02   +4.215788297992246e-02   +7.928368103996200e-02   -1.212363138924104e-02   -3.561362288861908e-02   +4.919615668681558e-02; +3.045605075079606e-03   -8.570039136045265e-02   -5.882182917789641e-02   +5.200791177925773e-02   -1.146497643679703e-03   -7.944820378021271e-03   +6.419243070753219e-02   +1.101221924919047e-02   +6.961524840934272e-02   +3.276801159887260e-02   -1.291835423944655e-02   +4.889714481934379e-02; -1.007107244807533e-02   -6.174739595001544e-02   +1.269806161738661e-02   -2.436695056186038e-02   -9.199052177135254e-03   +2.908779037089466e-02   -2.347832146927462e-02   -1.486335056533959e-02   +1.631774749952084e-02   +2.487160662679521e-02   +3.713714441711744e-02   +2.312723188324893e-02; +7.042029874914101e-02   +2.656238607998804e-02   +9.574249314909952e-03   -3.321162547807600e-02   +7.906708288768631e-03   +6.401067825821015e-02   +3.412229510660261e-02   +9.157733884224067e-03   -3.351866276178211e-02   +6.807027477709628e-02   +4.780108080325644e-03   +1.068031193568860e-02];
L1_L3_iAMPA_netcon = [+7.323269885610328e-02   +3.346944418096863e-02   +2.139674895612542e-04   -1.416762375055343e-02   +5.497289971419150e-02   +7.730030290601542e-02   +2.245061263879358e-02   +5.390228969384159e-02   -1.485978087985103e-02; -1.217846201871139e-02   -3.011966232174697e-02   +2.671800451499734e-03   +3.392306512677958e-02   -2.595088166142262e-04   -3.588048293275501e-03   +1.094321670844528e-02   +4.218897038588525e-02   -1.824295389427792e-02; +2.426185378469827e-02   +3.189329193739354e-02   +3.308641189094034e-02   +2.807615978171713e-02   +1.358441763332358e-02   +4.092455714682040e-02   -2.973851320173076e-02   -3.394715515098623e-02   +1.767014111029209e-02; +2.682645114413014e-02   -1.146230040641262e-02   -3.921939369404921e-02   +3.409674646761694e-02   -9.073076150819814e-02   +7.067318990798861e-02   -2.029818327973002e-02   -5.035136896606590e-04   -1.489509169645103e-02; +2.223575597837920e-02   -4.907260148819678e-02   -2.712870334998728e-02   +5.307100146822235e-02   +2.083489795182037e-02   -2.992524115766881e-02   +1.831072332848595e-03   -8.906716894420047e-03   +6.500507855377372e-02; +2.896395519616033e-02   +1.194569450080032e-02   +1.116855170033955e-02   -1.661494391664893e-02   +4.732696087280334e-03   -1.839254775744636e-02   +6.616914846683766e-02   +7.144090038197236e-03   +4.244900773926311e-02];
L3_L1_iGABA_netcon = [+2.123236795791329e-02   +2.329048613854597e-02   +5.143128622343939e-02   +1.955359076501846e-02   +4.189982447547898e-02   +3.984058160188498e-04; +3.243376094559968e-02   +1.732922679356811e-02   -9.083616285534165e-03   +3.636056428008211e-02   +4.834857981460723e-02   -4.814831279178338e-02; +1.146226462002504e-02   -3.478332635278029e-03   +1.491544351325855e-02   -1.522256493324332e-02   +2.645811892601223e-02   +1.248142598596517e-02; -7.872110654332288e-03   +2.253874262767859e-03   -5.550244826153815e-02   +1.490829242840600e-02   -4.982497057750275e-02   +1.091555513008944e-02; +1.855801199020504e-02   -3.602105414855731e-02   +7.521406045724580e-02   -5.272224560898716e-02   -2.139298226987291e-02   -4.657014406030063e-02; +4.198070768563461e-03   -3.220718579302298e-03   +6.646907924426906e-02   +2.091467798440862e-02   +2.778203494140149e-03   +7.806426709225395e-02; +2.239842803112955e-02   +8.010955306412304e-02   +3.374290550415578e-02   +1.609371882691349e-02   +2.103823379700308e-02   -4.157103950444242e-02; +2.229669080502998e-02   +3.996472800507562e-02   -8.442256791703635e-03   -8.713427370254368e-03   +2.888791009152457e-02   -5.069539063790335e-02; -2.308569289068033e-02   -6.651070201067632e-03   -3.133192377684007e-02   +2.868094858398873e-02   -2.394117216960828e-02   -9.101447244638657e-03];
L5_Input1_iAMPA_netcon = [-2.090996299846007e-02   -1.068978751461951e-02   +4.716618507096608e-02   +3.227942449882635e-02   +5.762859895834921e-02   -4.080539262630890e-02];
L6_Input2_iAMPA_netcon = [-3.412062662158723e-02   +1.720276448612452e-02   +1.157104010936788e-02   -8.344211880013143e-02   +3.230611127117529e-02   +6.795599099928690e-03];
L5_L6_iAMPA_netcon = [+2.569781370443798e-02   +2.036390647907796e-02   -5.558909141498386e-02   +1.777353490510891e-02   +4.374111083980181e-03   -6.075179282361648e-02; -1.227634209274267e-02   +1.817744906071151e-02   +3.103460926936062e-02   +7.152841596708409e-02   +1.207054821083122e-02   +6.218647220747043e-02; +2.799011542809218e-02   +1.581028584797357e-02   -1.277575570888798e-02   -1.227410277568550e-02   +2.630984609588257e-02   +3.692131126639692e-02; +5.580488655406864e-02   +2.308111034753269e-02   +5.601676317406860e-02   -4.593943355304941e-02   -2.085128859403647e-02   -1.623835284939625e-02; +1.393006506529245e-02   +2.810832373536524e-02   +6.385145925820157e-02   +2.360645183293116e-02   -6.864155321414277e-03   +2.017075774197239e-02; +3.620461791190265e-03   -1.304119369119035e-02   +6.589796023328981e-02   +1.444780786292526e-02   -5.248828210536566e-02   +7.557383742763700e-02];
L4_L5_iAMPA_netcon = [-4.141936428946671e-02   -1.366758741281465e-02   +1.306712842020309e-03   -5.958280806150032e-03   +6.823753003246786e-04   -2.257195306987423e-02   +3.087034225453238e-02   +7.138525894183251e-02   +5.728438257501804e-02   -1.702006441296443e-02   -2.220244241816354e-02   -1.171943869399657e-02; +3.500568001441673e-02   +1.084525774007849e-03   -1.094659582124749e-03   +3.662300930699714e-02   +2.790526618007981e-02   -2.046648407193055e-02   -4.451691230453782e-03   -5.201437037631492e-02   -6.448236137878940e-02   -1.903721532261766e-02   +1.026720044697594e-02   +8.805420774928910e-02; +2.179961365497400e-02   +1.264945322900518e-02   +7.075239566580992e-02   +2.739803590692822e-02   +4.032526909410031e-02   +5.346489678431422e-02   +1.077981909060882e-02   +3.483123337303949e-02   -2.433838177273675e-02   +4.430178208526042e-02   +1.688332031395242e-02   -5.980637223577101e-03; -2.347173804131902e-02   -4.866232183607404e-02   +9.538478759889418e-04   +2.101697166956835e-02   -3.262565518808470e-02   +8.085614051030771e-03   -1.026423378983320e-02   -2.002138391906426e-02   -1.570179522430858e-02   +4.659568633330625e-02   +8.488466998906367e-03   +2.137335549503283e-02; +3.331649699746324e-02   +3.670005085063762e-02   +2.103434555718043e-02   -6.354955130436547e-02   +4.473682693939090e-02   +1.286001635452067e-02   -2.616141560799802e-02   +2.067047242422114e-02   +4.208062979090908e-02   -3.830514842549316e-02   +4.545343302246443e-02   +5.486241044128481e-03; -3.992091896703845e-02   +1.313895370634964e-02   -1.688297674018304e-02   -1.342726416608373e-02   -3.998174280359711e-02   +7.018952071814195e-02   -5.991744837486254e-03   +1.005115580357811e-02   -2.267099745885199e-02   +3.864762154681192e-02   -1.978637620374252e-02   -2.243804498723716e-02];
L6_L4_iAMPA_netcon = [+2.860073259559988e-02   -3.912730764371005e-02   +3.697597579550320e-02   -3.195645320664388e-02   +9.428570577338195e-04   +2.729595197784374e-02; +5.452620020210690e-02   +5.553985058925882e-02   -1.353032644491539e-02   -5.173683345227761e-02   +5.872159154812032e-02   +1.605359379643493e-02; -2.571375736344821e-02   -1.331394642498374e-03   -3.739339722047275e-02   +1.708819019291268e-02   -1.842293783864201e-02   -1.964036438799536e-02; +2.768016465952455e-02   -4.359404344228719e-02   +3.136534129623676e-03   +1.214867752301365e-02   +5.541507880276372e-02   -5.048575861002508e-02; -1.604325576458249e-02   +6.527008066661399e-02   -3.117219931933343e-02   -5.845816853050710e-03   -1.208227746592188e-02   +6.131032492803318e-02; +7.274843677524311e-03   +4.356622326855780e-02   -3.097604496333177e-02   +2.808483184543906e-02   +6.015377588813538e-02   -1.125182120950791e-02; +1.477866935828519e-02   +4.097167804011428e-02   +8.133536129652369e-04   +5.087871095682077e-02   +2.584107236942084e-02   +1.493410114282635e-02; +2.021377399722522e-02   +4.927803181905624e-02   +2.703177534783233e-02   +2.542076018932251e-02   +7.288982914949626e-03   +8.354968930904594e-02; -1.606782951584648e-02   +3.929347446763268e-02   -6.743787673343246e-02   +4.653214458071252e-03   +7.878595059967856e-03   +1.151613624774371e-02; +7.728478025754638e-03   -2.900247346618300e-03   +1.756489617791639e-02   +4.713203094722975e-03   +5.478201617048174e-02   -5.014516209634902e-02; +2.876254850170270e-02   -8.752233010756462e-03   +4.926883588005784e-02   +8.606079534668720e-02   -5.878007317407068e-02   +1.906303292923730e-02; +3.872668462459966e-02   +3.710794911762156e-02   -1.135147740367437e-03   +1.198686358900750e-02   -4.413514688507920e-02   +8.605825272941715e-03];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
