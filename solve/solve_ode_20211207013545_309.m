function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.911689613793857e-01   +2.077178328367011e-01   +1.083292804750648e-02   +3.697695039158664e-01   +4.519561766763530e-01   +6.163361110309228e-01   +1.882147584573446e-01   +3.089132871376152e-01   +2.971389504858653e-02; +2.168977520435843e-01   +2.682929081977798e-01   +5.120542369248603e-01   +2.501102574546428e-01   +6.161522007382917e-01   +2.152028426259671e-02   +1.798469389233911e-01   +2.963056051996368e-02   +2.965419186993978e-01; +2.186272812084564e-02   +3.817561456761410e-01   +1.959218574807300e-01   +5.311889411806460e-01   +8.437989004979221e-02   +3.320658528649904e-01   +3.579786123894513e-01   +4.458351027061940e-01   +7.312556575148971e-02; +2.274819866970819e-01   +9.893900765856051e-02   +3.710406387950761e-02   +4.702463945979157e-01   +1.587031306147590e-01   +3.246337083441490e-01   +1.097654289073941e-01   +2.962225380561340e-01   +4.549521306207566e-01; +3.689308905712440e-01   +6.211295613895905e-01   +2.770498019499189e-01   +3.254245533197981e-01   +4.345994505865401e-01   +3.071321257642504e-01   +1.749261064167266e-01   +6.118021081142935e-01   +5.381839401207265e-02; +3.244696228349806e-01   +4.725901272286200e-01   +5.111351916328177e-01   +1.987121446336065e-01   +5.016584637528926e-01   +1.871495394214812e-01   +5.126060027581163e-01   +6.303276098572561e-02   +3.565280394557586e-01; -1.168962774224593e-03   +5.613852667713114e-01   +5.767489686633899e-01   +5.148649468654765e-01   +5.655119666499464e-01   +7.140444781344800e-02   +4.878332441009380e-01   +2.343265119152369e-01   +2.006838765986897e-01; +1.227235538343964e-01   +5.860205671540372e-01   +4.391676580455954e-02   +1.565357655075403e-01   +4.922030744882188e-01   +5.925499808809984e-01   +4.293840755473798e-01   +7.101570977247765e-02   +3.974119533419745e-01; +3.883073859717126e-01   +1.583135904063836e-01   +3.659374514993060e-01   +5.144992481699788e-01   +3.244274307251431e-01   +4.791294790447664e-01   +4.496258611879157e-01   +2.123290764486039e-01   +5.949148010830457e-01];
L1_L2_iAMPA_netcon = [+5.266496211176888e-02   +3.046447883362318e-01   +2.934099790862060e-02   +2.771675809035664e-01   +7.032217883151191e-02   +6.004326577321266e-01   +8.577043912465525e-02   +2.096515917237634e-01   +5.872542989814525e-01; +4.161988111026439e-01   +5.255828795314456e-01   +5.057894040000057e-01   +1.513119496088576e-02   +8.133288977953126e-02   +3.332550189133011e-01   +3.926362986466494e-01   +1.434294927547349e-01   +4.338459512763277e-01; +1.304748024096305e-01   +1.592687453214799e-01   +1.599919728491926e-01   +8.194052549195914e-02   +2.220212953789455e-01   +1.668538542633374e-01   +2.441694845117363e-01   +3.027714614714058e-01   +3.010649616235824e-01; +5.764337634491020e-01   +5.141404054077574e-01   +5.222294660730090e-01   +6.165725606191426e-01   +3.735320839313591e-01   +2.705400744696034e-01   +5.150848815246771e-01   +3.215332271784493e-01   +4.286608778800260e-01; +4.068223832614432e-01   +5.840711952286633e-02   +1.131427799630225e-01   +3.363869332337305e-01   +1.104479929927242e-01   +4.246370007330820e-01   +4.492963119292109e-01   +1.189160999372180e-01   +2.749502730240517e-01; +3.330440645468360e-01   +3.162589449758449e-01   +6.196003849277804e-01   +5.980064857788108e-01   +4.605290049991288e-02   +2.598289893749506e-01   +1.418183925608853e-01   +3.692985639299937e-01   +2.672161644814830e-01; +5.305562834617166e-01   +8.857772058516922e-03   +8.759265573922016e-03   +4.039219949744723e-01   +3.406571319191414e-01   +6.066900457763561e-01   +1.478039409061317e-01   +3.656579713428415e-01   +1.470850501931458e-01; +2.685536793110654e-01   +3.901531324354546e-01   +2.253549264916472e-01   +5.832912174181556e-01   +2.062743290948653e-01   +4.964540868475056e-01   +5.864921635203053e-01   +6.645143097653521e-02   +4.682488540108781e-02; +1.510529425407948e-01   +1.621991854383243e-01   +3.268683026260563e-01   +5.269702940260697e-01   +5.496346151886707e-01   +1.858317001143242e-01   +5.494822337857538e-01   +5.402764866693518e-01   +4.038968869057951e-01];
L2_L5_iAMPA_netcon = [+3.995705285651788e-01   +3.227428948512822e-01   +2.918783033674733e-01   +6.043284778951343e-01   +5.987256811043764e-01   +5.204335352534828e-01   +5.799020479031524e-01   +6.384075271843739e-01   +2.740223975427548e-01; +2.789738657550915e-01   +3.168733098094206e-01   +4.975286885657850e-01   +3.817470197359294e-01   +2.291570850722886e-01   +6.597387694730875e-02   +8.691997522550246e-02   +2.908455072673229e-01   +5.361385733560901e-01; +1.377267524578509e-01   +4.388110182242643e-01   +1.689382778276099e-01   +7.555148329309715e-02   +5.693507084539089e-01   +1.417722053970794e-01   +2.168126736152486e-01   +3.935989425164417e-01   +3.166475356963341e-01; +2.125913174717291e-01   +4.222328305227185e-01   +2.864935662753680e-01   +5.157333027367533e-01   +4.958287548153462e-01   +5.321238613034821e-01   +5.778496666626242e-01   +5.495343739770243e-01   +5.839462092463923e-01; +5.394024515163189e-01   +5.196266027367428e-01   +5.703395837619227e-02   +4.560114061066072e-01   +4.703386895805833e-01   +4.697420949579872e-01   +4.922948628878965e-02   +1.555106408870581e-01   +4.932230588235125e-01; +5.830172112321905e-01   +3.906664482975172e-01   +5.151236069447662e-01   +2.462447285972901e-01   +2.920051752207050e-01   +4.588740855798331e-01   +4.510813280658865e-01   +1.507609440078550e-01   +6.264274733279139e-01];
L5_L2_iGABA_netcon = [+7.022003594279076e-02   +5.466948695750301e-01   +2.219770762082635e-01   +5.347600887806435e-01   +1.613238288839632e-01   +1.821588593606651e-01; +6.224337109505232e-01   -2.483799738274537e-03   +2.204757730920033e-01   -3.056570477616271e-02   +5.586991473429748e-01   +4.410440086618008e-01; +1.413565787818106e-01   +4.906701464739561e-01   +3.409028440235051e-01   +8.527759362473095e-02   +1.764145497304193e-01   +4.141210904219507e-01; +1.754686061382958e-01   +2.462423184754726e-01   +3.483674004462368e-02   +8.242411608196000e-02   +1.691910767925779e-01   +4.529259824659371e-01; +2.606080437910253e-01   +1.244606638575115e-01   +5.604819690871424e-01   +5.301469498201644e-01   +4.063015550383384e-01   +4.938049934618850e-01; +5.306662500902811e-01   +4.577938836055754e-01   +4.364733873990155e-01   +4.223224056150942e-01   +1.069570028277666e-01   +2.058691920903587e-01; +1.326399727031470e-01   +5.850230191441178e-01   +3.030680584587985e-01   +4.961885349976364e-02   +4.692345471345069e-01   +3.078231636079918e-01; +2.013228867272728e-01   +5.969249004829327e-01   +1.266035906451728e-01   +1.393156469722574e-01   +2.945034780444028e-01   +2.643497780096494e-01; +4.187469913045546e-01   +2.320120986539588e-01   +1.381430803164901e-01   +5.126815394722662e-01   +6.365927743734385e-01   +2.930439996424630e-01];
L3_L2_iAMPA_netcon = [+2.793304668076600e-01   +5.243885364207964e-01   +1.898823263841220e-01   +3.680243617664888e-01   +6.412633444296811e-01   +5.510025599542734e-01; +1.374163519267455e-01   +1.536016820963254e-01   +5.535405823083733e-01   +1.515813652221980e-01   +5.467690563338455e-02   +4.173441418483376e-02; +5.295341673423802e-01   +1.963697104554826e-01   +2.348129429780957e-01   +4.584423344403741e-01   +3.457131586641202e-01   -5.428045135880030e-03; +7.646029108045861e-02   +2.645646632244960e-01   +4.659713116310991e-02   +4.952622906988358e-01   +1.568691936916665e-01   +4.029893110519355e-01; +3.165316450525960e-01   +1.566215341053410e-01   +3.603294448608376e-02   +5.288082830712904e-01   +1.635521346302907e-01   +5.911645736687362e-01; +9.320621398047976e-02   +5.481802269901753e-01   +1.625166789919525e-01   +6.282210091785977e-01   +5.282949368265347e-01   +4.203145280756908e-01; +2.516855396256331e-01   +5.771688623501006e-02   +3.597027586386675e-01   +3.536416126075418e-01   +2.954559632710375e-01   +1.535035646029151e-01; +5.833868184577238e-02   +2.156543365502635e-01   +5.960667055238544e-01   +1.495152159496261e-01   +6.163242044737396e-01   +9.135044416224426e-02; +5.952573916723528e-01   +6.080208852972374e-01   +2.094127060871075e-01   +7.365215609447159e-02   +4.839808657381450e-01   +3.774921031560660e-01];
L2_L3_iGABA_netcon = [+3.729936135712293e-01   +4.654607554987265e-02   +4.058057796635920e-01   +4.910286499074103e-01   +6.125850974353665e-01   +3.658543891575021e-01   +5.744394950852729e-01   +2.086663480649618e-01   +2.430166287149409e-01; +5.296359942358937e-01   +5.698524651691690e-01   +4.085440317252753e-02   +7.549858216890014e-02   +4.906741297112778e-01   +4.525323716337641e-02   +1.589596712597662e-02   +2.729943892128589e-01   +1.917391612247240e-01; +1.755423103481512e-01   +2.666836212778027e-01   +3.573769664168837e-01   +5.506355543504055e-01   +5.038915209021987e-01   +1.781772624645850e-01   +1.220024452554763e-01   +2.082712619302677e-01   +5.755661249050278e-01; +1.619681035897079e-01   +1.294056317220167e-02   +1.455893022455777e-01   +1.767068681657171e-01   +4.383847343802990e-01   +4.665576551083385e-01   +5.806926246629056e-02   +3.396251976213249e-01   +5.206646981939947e-01; -3.591853470192077e-03   +5.729355473823143e-01   +6.303778500531614e-01   +2.884594642974240e-01   +2.121207279581137e-01   +1.247587961203555e-01   +5.285334440767938e-01   +7.083641775317773e-02   +2.279052826703029e-01; +3.796738581807690e-01   +5.346412872797386e-01   +1.359509370376046e-01   +3.803513864637019e-01   +3.438504106067465e-02   +2.326763162169670e-01   +8.835201177832187e-02   +4.482843792463529e-01   +3.134680936697218e-01];
L1_L4_iGABA_netcon = [+2.474977818319659e-01   +4.228490465575946e-01   +5.448575892571051e-01   +4.655329541551623e-01   +1.916526474296756e-01   +3.433313738673853e-01   +4.782863264049352e-02   +2.310378266562917e-01   +6.362072898989841e-01; +4.862078072121097e-01   +2.652995757992054e-01   +4.271984881222787e-02   +1.172481074007369e-01   +1.289405485700321e-01   +4.245503610355946e-01   +2.214674904125681e-01   +2.496496598329356e-01   +5.985996475041239e-01; +6.995850391734239e-02   +1.911667715261815e-01   +5.530516761749484e-01   +4.652782307834812e-01   +2.840600449842013e-01   +2.915254619634222e-01   +4.687919236682950e-01   +3.647513200061213e-01   +4.891738053735730e-01; +5.490007790213696e-01   +5.171500464095115e-01   +1.518134671245379e-01   +3.724480082529005e-01   +4.272405374530463e-01   +5.761719896732944e-01   +5.900661482764503e-01   +8.653012072499004e-02   +2.907420300790383e-03; +3.575996491917515e-01   +4.497512477285267e-02   +5.234282388065852e-03   +8.021167273921644e-02   +5.292063343911448e-01   +1.307635276868769e-01   +1.839609953448355e-01   +1.571742731878057e-01   +3.295931965814766e-01; +2.309529724094692e-01   +3.778016869804046e-01   +3.427752822219948e-01   +8.887444469277542e-02   +1.711866572733880e-01   +1.989435201853224e-01   +4.474138900201349e-01   +1.870872529027232e-01   +2.833977461696493e-02; +1.070283758451792e-01   +4.464523316986196e-01   +3.787629005326997e-01   +4.054753875476706e-01   +4.410328857708753e-02   +1.631234115191104e-01   +1.506956607774854e-01   +9.787931275714680e-02   +5.569438241988650e-01; +4.216861734413658e-01   +8.967705918010564e-02   +4.274777102037736e-01   +3.843374027162780e-01   +2.375548270776629e-01   +4.179686601596867e-01   +2.185421180222596e-01   +2.581190812095127e-01   +1.755831459111962e-01; +2.494034269834524e-01   +1.810632714865402e-01   +1.961309731353729e-01   +3.132658757163339e-01   +9.374802745189259e-02   +4.439108862975583e-01   +7.734265508069856e-02   +3.474701675249825e-01   +5.533441321443555e-01; +1.363603328524101e-01   +1.529116273859847e-01   +4.911629244324656e-01   +2.869027065092096e-01   +5.703621094762495e-01   +2.147936986602524e-01   +4.310277990300331e-01   +1.471897929249691e-01   +3.479538859523077e-01; +1.443398306436467e-01   +3.229355834704273e-01   +1.078089563224346e-01   +5.813206592186360e-01   +6.376650610336116e-01   +5.646172956192884e-01   +8.513093638750768e-02   +3.222017406633559e-01   +4.586770680624771e-01; +3.056202055359337e-01   +6.275917315059860e-01   +3.463666373713020e-01   +4.263395913500483e-01   +2.691212134342458e-01   +1.518687506545389e-01   +4.243436045594431e-02   +1.257160716726522e-01   +4.577899887134805e-01];
L4_L1_iGABA_netcon = [+3.618385468600806e-01   +3.239152750173592e-01   +5.156891519998606e-02   +3.861861689304049e-01   +1.914749810078970e-01   +1.598036268700327e-01   +4.142072752715161e-01   +3.852135712063973e-01   +5.381260512816864e-02   +2.018743908141039e-01   +2.940260646028641e-01   +5.238247985704112e-01; +5.532975811477355e-02   +1.550141889241329e-01   +5.462916385729190e-01   +3.715584857839157e-03   +2.609675070906729e-02   +5.413682880471384e-01   +1.411923420192244e-01   +5.097905905542267e-01   +5.101144404560304e-01   +4.535968740288571e-01   +6.339402927516082e-02   +5.556759721314161e-01; +6.873262621481790e-02   +1.891863848286258e-01   +2.404350984155141e-01   +4.483030944213161e-01   +1.874755034957855e-01   +1.940310698360060e-01   +3.603230709973978e-01   +5.743475687599811e-01   +5.745467038693999e-01   +6.826861140529615e-03   +3.407209839875612e-01   +1.866407698192028e-01; +1.931913284323844e-01   +1.331149983178384e-01   +6.207458697043132e-01   +5.954096303555910e-01   +2.175006207647623e-01   +5.196636605242321e-01   +4.766214844395904e-01   +6.677430795411470e-01   +5.668921391033057e-01   +1.782878845738601e-01   +5.891646969766030e-01   +3.155053341140486e-01; +3.566006539082647e-01   +1.466628451253518e-01   +1.622118904785868e-01   +4.947213267237860e-01   +1.698514747400658e-01   +2.629377210456146e-01   +2.893241165783964e-01   +2.170064553836948e-01   +5.378954100567467e-01   +2.996734841849737e-01   +2.148783260909644e-01   +1.587162600240663e-01; +1.216392974167550e-01   +5.689088992304112e-01   +4.043072322508725e-01   +6.133744246898153e-01   +2.808248580688723e-01   +2.113262940015047e-01   +3.901937202382487e-01   +5.745766111144214e-01   +1.403544870652856e-01   +2.941537265387756e-01   +4.809382451834756e-01   +1.124777202911685e-01; +1.848880025321828e-01   +3.607452704807299e-02   +5.485122460739179e-01   +3.996214969662004e-01   +5.785001857019472e-01   +4.524319306409900e-01   +1.993285120615450e-01   +4.113294978071648e-01   +3.219122008722762e-01   +6.261770101533960e-01   +2.101944618601064e-01   +4.711237528313296e-01; +1.980807607348019e-01   +2.068235403580293e-01   +7.236185183087174e-02   +2.557103777063647e-01   +1.249602709686333e-01   +2.445207091009926e-01   +2.132496165871457e-01   +5.746088952159544e-01   +4.481911324714971e-01   +1.050923861910373e-01   +6.622700678495297e-01   +5.469030271330797e-01; +2.008587784198839e-01   +3.145842985224166e-01   +6.365181106425163e-01   +5.653764579560169e-01   +3.388294183092708e-01   +2.617454902550369e-01   +2.915227469899114e-01   +4.491810191320329e-02   +3.983082814558234e-01   +2.070694580087438e-02   +2.213709102893131e-01   +2.435828208927301e-01];
L1_L3_iAMPA_netcon = [+3.435733796604014e-01   +4.146025003503693e-01   +4.956284018662798e-01   +3.136533852772569e-02   +4.710482976481348e-01   +5.388177507896108e-01   +3.191169279937106e-02   +3.323463616648148e-01   +5.586655469677027e-01; +2.806854158790295e-01   +5.016311666942003e-01   +4.654067454903737e-01   +5.696971176133664e-01   +6.515024843749121e-01   +5.706553131116554e-01   +5.218340671489782e-01   +3.566625890447490e-02   +3.969105509503857e-01; +5.370209008251265e-01   +5.242158230758159e-01   +2.472088586429291e-01   +3.761652495335360e-01   +4.946039658463532e-01   +4.107494598238856e-01   +2.626380605753135e-01   +5.523372196824636e-01   +3.387573495473138e-01; +8.603603504277432e-02   +4.762528827121082e-01   +2.682023702751007e-01   +3.975847714257340e-01   +4.631482896060555e-01   +9.357752781171699e-02   +1.096540154305604e-01   +4.972537448925877e-01   +5.224265911532183e-01; +3.732270226104268e-01   +5.327904574494190e-02   +5.110757961019183e-01   +4.145953878487609e-01   +5.559295532236023e-01   +9.490058474648051e-02   +2.513684582464361e-01   +5.830436712054197e-01   +3.453569530319729e-01; +2.371306484571988e-01   +1.016041853613888e-01   +1.848454973521283e-02   +4.388039204088081e-01   +6.521832009147462e-01   +3.613869595816135e-01   +1.072035930617107e-01   +3.086327180107482e-01   +4.720060542940365e-01];
L3_L1_iGABA_netcon = [+1.164149767370223e-01   +1.134803551176589e-01   +4.970062853803123e-01   +2.500370804979203e-01   +4.199203506058947e-01   +5.894468548567930e-01; +6.075816716861363e-01   +6.455137474384472e-01   +2.473779235549326e-01   +2.975598823311323e-01   +1.744841518465656e-01   +4.145921937886367e-01; +4.740002166879360e-01   +4.941349214418927e-01   +3.486704470582261e-01   +5.575461521501127e-01   +2.941736980793284e-01   +2.843174654458427e-01; +4.665148690735691e-01   +6.363819122420542e-01   +4.449325568296815e-01   +4.783597289213178e-01   +1.289772623058098e-01   +3.431619037531710e-01; +3.295024666392160e-01   +5.372302891462244e-01   +1.561877360010669e-01   +3.240531406088654e-01   +1.295808307813340e-02   +1.704319092873480e-01; +3.611193450285032e-02   +4.716483288929393e-01   +6.117422036607510e-01   +1.051854789263694e-01   +2.993659026758208e-02   +3.525752826750272e-01; +1.269496872275273e-01   +6.001806421228928e-01   +2.892439146972661e-01   +2.599071115339598e-01   +3.954819020269082e-01   +4.296259210144288e-01; +1.787913357682264e-02   +2.753938094765214e-01   +5.356633033209400e-01   +2.680642032551278e-01   +8.123535190434329e-02   +2.569253722275647e-01; +1.773949479644893e-02   +5.736230494733726e-01   +2.821942438446433e-01   +2.455935985180038e-01   +4.440202668065870e-01   +5.247789488773349e-01];
L5_Input1_iAMPA_netcon = [+2.386161078284385e-01   +2.582002576671067e-01   +4.737252714176735e-01   +2.216209153893653e-01   +2.765829010498255e-02   +2.844887681151435e-01];
L6_Input2_iAMPA_netcon = [-5.925759166562836e-04   +5.270579758256094e-01   +3.806675816950792e-01];
L5_L6_iAMPA_netcon = [+6.083817886616538e-01   +6.126927430927294e-02   +5.600456260859127e-01   +4.383660374206391e-01   +6.125470350251185e-01   +3.552036638433321e-01; +3.517767608243345e-01   +3.943646972251608e-02   +3.888520594736407e-01   +1.540921642115103e-01   +1.556054248372407e-01   +5.025783504820361e-01; +5.428314323940906e-01   +2.933902443434111e-02   +1.561254271247285e-01   +1.375082829796097e-01   +4.646662381135050e-02   +3.889067262287413e-01];
L4_L5_iAMPA_netcon = [+5.192633648948695e-01   +5.283672038066615e-01   +1.936382587618366e-01   +6.174501349750489e-02   +1.141268035295900e-01   +4.493005286699157e-02   +2.363919115413063e-01   +2.585671932357658e-01   +2.636195078474124e-01   +3.171087555545060e-01   +2.036356150013905e-01   +1.498843107588251e-01; +5.309279602326016e-01   +4.686477454199681e-02   +3.496048335901918e-01   +3.312807456149684e-02   +1.144270954254950e-01   +2.928683655374370e-01   +4.474470982038277e-01   +2.492349149280327e-01   +1.071374973884894e-01   +8.309393937211063e-02   +8.242140108930218e-02   +5.997754659276862e-01; +7.203911849280253e-02   +3.711438323264799e-01   +1.090871622848323e-01   +2.822670017124085e-01   +5.725621749802828e-01   +1.829178231248429e-02   +3.365424165874290e-01   +4.978831506720528e-01   +3.778962150463695e-01   +1.410207798944291e-01   +4.063262879281159e-01   +4.100401210278730e-01; +3.665397505272260e-01   +2.707787927883772e-01   +4.254754387405592e-01   +3.679370186579082e-01   +4.159870632101584e-01   +4.477248400324037e-02   +5.452243587965019e-02   +4.080781079576780e-01   +1.077788899114864e-01   +2.908168148751159e-01   +2.734374198628303e-01   +6.030451266594331e-01; +4.736335268639742e-01   +3.907037692096870e-01   +5.813078834875945e-01   +1.759569033035327e-01   +2.498337731207857e-01   +6.374050097108298e-01   +5.200947853135802e-01   +6.000917053557130e-01   +6.318197478986364e-01   +9.283612346594469e-02   +2.461904927679800e-01   +4.889035963511907e-01; +2.062497676058379e-01   +5.008396437745355e-01   +1.305489290721759e-01   +3.683445026960785e-01   +5.752961274278732e-01   +5.904249293963620e-01   +1.383236304038974e-01   +4.049978360591455e-01   +5.947360542103518e-01   +4.155432831483193e-01   +6.370139259586616e-01   +4.843749429141803e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
