function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.023762987195932e-01   -9.182440402486090e-02   -2.239100738797687e-01   -4.868132181840592e-01   +1.695792941023147e-01   +6.932393502537294e-01   -1.000000000000000e+00   -9.458848826386196e-01   +2.702289615815635e-01; -4.789693419592705e-01   -3.637993898321040e-01   -7.379861555688260e-01   +6.659455082601308e-01   -8.705405992621306e-01   +7.840412736093850e-01   -1.986470141237697e-01   -3.583947961865613e-01   -8.820910162603289e-02; -9.688902371156368e-01   +9.376036074105497e-01   -4.773338798432353e-01   +2.034077198576953e-01   -3.275531748782843e-01   +7.167838598037868e-02   -3.253166874228492e-01   -1.192133480845973e-01   -7.336367975631257e-02; -4.257039648989582e-01   -2.084345783529251e-01   -3.795356189823725e-01   +3.799768470219612e-01   -6.803754358086491e-01   -6.871289894359089e-01   -6.916844411059788e-01   +4.489322602402007e-01   +3.453870067894113e-01; +3.424398350802680e-01   -1.954218641390126e-01   -6.798681398296434e-01   -7.603788715504031e-01   -6.514833284606103e-01   +8.673791941701929e-01   -8.358964849001023e-01   +5.160523215883290e-01   -7.968071764313706e-01; +8.601760179590346e-01   +7.280885298709241e-01   -6.904400815079522e-01   -6.405549760690933e-02   -1.726050557627528e-01   -1.468656850183662e-01   -2.359063888317636e-01   +8.021161570825815e-01   -9.037013664413176e-01; -9.297042099870332e-01   -3.533757208925309e-01   +8.182560261574465e-02   -5.433227872180968e-01   +1.706377223567419e-01   +1.462533241549096e-01   +5.456972935578548e-01   +1.157436520014185e-01   +1.837530029432337e-01; -4.086158215037893e-01   -4.493633069185050e-01   -8.393677535967932e-01   +5.812946894279833e-01   -4.491281967853909e-01   +6.158883595851274e-01   -5.400455844894848e-01   -7.219594583619519e-01   +6.429639068506965e-01; +3.418869511489554e-01   -7.469740085286830e-02   -4.259222586966525e-01   +5.432114339970341e-01   +1.739790539490499e-01   -2.536805821323281e-02   +5.897652763673471e-01   -6.638885008933455e-02   +6.818040004520747e-01];
L1_L2_iAMPA_netcon = [-3.503567266374895e-01   -4.483625811375187e-01   +1.000000000000000e+00   +1.442078186407842e-01   +5.167915110318874e-01   -4.301463301422085e-01   -6.288568382580968e-01   -3.822861765648233e-01   +6.594459698558516e-01; +2.917117196819868e-01   -3.033598996949509e-01   -5.841730716319418e-02   +2.887567332642935e-02   +6.879004102102824e-01   -9.487580861720900e-01   +2.682414424111519e-01   -7.898174949945641e-01   -5.859967928681084e-01; +3.124884928489889e-01   +8.044566112835623e-01   +4.756158228250454e-01   -7.182461130338831e-01   -7.217632873465166e-01   +3.476717027423916e-01   -8.248889946607539e-01   -5.734922688916573e-01   -1.754146196430502e-01; -3.678797111054065e-01   -8.204226189927131e-01   +4.836822564889744e-01   -7.695682461221817e-01   +3.251311799245718e-02   +6.365661042072178e-01   -6.239675090926242e-02   -1.052417730791067e-01   -6.963645801408441e-02; +6.839371525905957e-01   -6.071252954111097e-01   +2.862914948748803e-01   +4.137989170706348e-01   -8.211178923477508e-02   +6.715312052743750e-01   +1.927254109311747e-01   +2.397099048580970e-02   -3.812694527674031e-01; +3.633286724576948e-01   -5.476129525213422e-01   -3.413396283131355e-01   -3.621065462259531e-01   -7.373420627483118e-01   +1.356196588603324e-01   +5.638030669046435e-02   -8.209545590906270e-01   -2.197227462028152e-01; -6.500151549580058e-01   -2.010514568729419e-01   +6.940639795187608e-01   +5.966017650237300e-01   +6.815038225940310e-01   -9.309033803534321e-01   -5.722279140989935e-01   +5.176359681926029e-01   -9.653108682175208e-01; -1.388911557458630e-01   +5.710236020471010e-01   +3.653179532616750e-01   -5.816232249380804e-01   -5.951309747408199e-01   +5.466946506221846e-01   +5.712705425704646e-01   -5.289333956897079e-01   +7.933227825934294e-01; +1.198780940129683e-01   -3.018349337643580e-01   -8.130645403367694e-02   +8.953074947277232e-01   +5.616271183977147e-01   +7.066734023624386e-01   -3.975804289529629e-01   +1.169231405535796e-01   -1.819143808839456e-01];
L2_L5_iAMPA_netcon = [-4.471155775473992e-01   -4.940055800762632e-01   -1.913057125184295e-01   -3.034900127386766e-01   -1.187529939029469e-01   +7.643112064216554e-01   -8.922910496240112e-01   +3.868991435000377e-01   -9.091338165057696e-01; +2.891314439671726e-01   +3.832787747409420e-01   -2.562246507158821e-01   +3.795680291086941e-01   +5.946198003548764e-01   +4.799189167685494e-01   -9.293455686026064e-02   -7.024939551626572e-01   +7.824053163873701e-01; -2.113281815675425e-01   +6.429272394378343e-01   +6.997651899463412e-01   +1.957951926702457e-01   +5.677124257531186e-01   +5.980140655669062e-02   +6.567816893410126e-02   +4.349418759575450e-01   +8.759013489054425e-02; +8.294349978006051e-02   +1.000000000000000e+00   +4.955729540541079e-01   +6.544272065943105e-01   -5.646808800418412e-01   +8.496158674753740e-02   +6.515730915693371e-02   -2.148020871735910e-01   -6.586922012219868e-01; -5.013796971336466e-01   +1.362360487153437e-01   -7.778895986864892e-01   +1.823998453231356e-01   +6.760117832717418e-01   -3.563799422503482e-01   -3.373108519780521e-01   -1.034550675298174e-01   -4.581179056475195e-01; +8.266734241076586e-01   -2.550034823638248e-01   -7.975826152090756e-01   +7.275969341328170e-01   +4.398316923126597e-02   -2.438390290981674e-01   +3.963927087244701e-01   -2.637051767828374e-02   -9.487460459571355e-01];
L5_L2_iGABA_netcon = [+1.564808435508354e-01   +1.000000000000000e+00   -4.411685588355443e-01   +7.184343573964902e-01   -7.608468831712753e-02   -1.964657904171438e-01; +2.409051807991347e-01   -2.287557686389548e-01   +4.882422950514294e-01   -1.768055845208008e-01   +8.555639035880621e-01   +2.026904334287392e-01; +4.694419163144824e-02   -3.807253358088377e-01   +3.479033667328249e-01   -7.568613953744084e-01   +9.004292484501852e-01   +4.728834814800850e-01; +2.883386614149712e-01   -2.943434335498958e-01   +4.395413764203158e-01   +5.346060820225651e-01   -2.566574458579329e-01   -1.980232301578362e-02; +3.277162457044653e-01   +4.485705274571456e-01   +6.805902485178404e-01   +7.126181205119951e-01   -5.467146977103033e-01   -2.992456322407169e-01; -1.796499857465936e-02   +7.732433248998558e-01   -8.461997670387997e-01   -7.178146401641923e-01   -6.774509877714223e-01   -6.846431608262814e-01; -6.834275201794930e-01   +9.510346898719376e-01   +5.733459551426365e-02   +1.141521148018465e-01   +5.907805836723123e-01   -2.348908202137910e-01; +7.268858220520485e-01   -7.230249626465455e-01   +1.983294220757428e-01   -3.080791585810434e-02   +8.455270491992847e-01   +7.058886902201288e-01; -5.623376393389658e-02   -1.094611543718630e-01   +7.785148035138910e-01   +9.066913001770383e-01   -5.245952884506138e-01   +7.626061067869913e-01];
L3_L2_iAMPA_netcon = [+6.529135608865973e-02   +6.487323994442105e-01   -1.098499699801987e-01   +6.151198578061275e-02   +3.015072077709239e-01   -7.383709387903213e-02; -5.072807758495111e-01   +7.648906770363072e-01   +5.123689921056767e-01   -5.745028263672283e-02   +4.304099243895959e-01   -1.698199795379344e-01; -9.544860660024919e-02   -2.968917602728304e-01   +6.520701473742352e-01   +1.974388343612632e-01   -1.556315199028790e-01   -5.503356646463672e-01; -3.176459928651404e-01   -5.413205142559805e-01   -6.171281283118742e-01   +7.959101871077924e-01   +8.692993819051915e-01   -2.679318363518901e-01; -4.398874356518826e-01   -8.396734591718432e-01   +6.731344405367308e-01   -7.448540547120855e-01   -5.736225622954976e-01   -3.936985999633498e-01; -1.000000000000000e+00   -2.560500182798697e-01   -1.719322209485007e-01   +4.288610737312806e-01   +6.252899508467820e-01   -4.367625882171705e-01; -7.443222647394105e-01   -6.417026186096021e-01   -5.861275126543020e-01   -7.264641450861735e-01   +1.551126143897747e-01   -4.862826398461942e-01; +7.037138009649732e-01   +7.609955006243647e-01   -2.817746941139455e-01   -1.160118895795945e-01   +7.711469121098010e-01   -2.869578183872912e-01; -7.438597114590133e-01   +1.230016943101613e-02   +2.817482821071180e-01   +6.146144228741968e-01   +3.640310874696531e-01   -7.490972799852509e-01];
L2_L3_iGABA_netcon = [+7.272525073082152e-01   -6.487252807430853e-01   +2.232043737134740e-01   -7.335445632281125e-01   -3.324643026093005e-02   +5.216722320028824e-01   +3.429504371403738e-01   -7.539698554470745e-01   +5.793685465038555e-02; +6.681656983202773e-01   -2.464458429463652e-01   +8.226086788623220e-01   -8.689163389483372e-01   -3.376867805375218e-01   -4.948205381775280e-01   -5.289766618433008e-01   -2.740646666562623e-01   -3.141698794709489e-01; -9.853763840547557e-02   +1.418220113223649e-01   +6.772915236968852e-01   -4.634298471051501e-01   -1.394344315456733e-01   +6.455555995144568e-01   -9.236677539419694e-01   -2.532658549267412e-01   -7.202573149194187e-01; +8.483727514070433e-02   -3.991599742731846e-01   -2.733285085796185e-01   -1.377864769382421e-02   -2.812962862564619e-01   -8.707699404157665e-01   +5.215989024905053e-01   -2.632623266554916e-01   +3.259122278565807e-01; -4.936337464776115e-01   -6.608819248543887e-01   -7.575075106455552e-01   -5.146881828135520e-01   +1.000000000000000e+00   +6.753948635964023e-01   -7.482706470495466e-01   +2.101693345662397e-01   +1.775828011829927e-01; +8.122531240787517e-01   -8.404581455396820e-02   -3.614489211780407e-01   +6.764083203631560e-01   -7.519925548715826e-01   -1.508876852590335e-01   +8.218787630449532e-01   +2.852392556725752e-02   +5.527312070051403e-01];
L1_L4_iGABA_netcon = [+4.885451520503665e-01   -2.736188264920251e-03   +2.334840367880438e-01   -1.683577804879446e-01   +1.587858551369760e-01   +2.990914399073064e-02   +7.298799810303044e-01   -1.401356350840970e-01   -1.003084928456091e-01; -7.612271206295238e-01   +2.149003552782340e-01   -1.159137164842486e-01   -2.573134697821663e-01   -7.188495955747793e-01   -4.714017112150378e-01   -8.388334049019616e-02   -6.865390111277678e-01   +4.825106361849386e-01; -1.652139194560003e-01   +3.718113440997388e-01   +5.649785295163317e-01   -3.658979262773094e-01   -4.168052723259318e-01   -6.788493134873719e-02   -1.052256174537656e-02   -4.614063103627945e-01   +3.930961312478314e-01; +2.785509128705768e-01   +1.103150842587496e-01   -1.748962985769255e-01   +4.695940581551805e-01   +7.246986966041608e-01   -6.579154867199389e-01   -1.363013063375504e-01   +1.090095321748765e-01   -6.013344943999001e-01; +1.685732401047368e-01   -4.128361221044017e-01   +3.424810955419940e-01   -3.741910475687521e-01   +7.423191029630158e-02   -4.688685235199141e-01   +5.870645824774657e-01   +1.269077828258142e-01   +1.120235363638071e-02; +8.191322915176543e-01   -1.842404725722456e-02   -8.754117385111929e-01   -1.247434835794882e-01   +2.204237293487135e-01   -3.654289562031125e-01   -2.730677276600313e-01   +3.635644265468006e-01   +6.011895403511210e-01; +7.162271623563127e-01   +3.888772956003844e-01   -7.916844219450528e-01   +6.552366645722215e-01   +1.191901501839435e-01   +5.946617612570944e-01   -1.577742651308240e-01   +1.994074068545898e-01   +3.095065361463282e-01; -2.606861997969917e-02   +5.033295786566567e-01   +4.186154172091636e-01   +8.862849869273927e-01   -3.834518218823471e-01   +1.754547010364347e-02   -6.986250879703402e-01   +6.188671810597292e-01   +4.892199781868175e-01; -1.839104515382122e-01   -3.131340065103661e-01   +1.567083863121672e-02   -2.302908871504692e-01   -3.488179376347892e-01   +3.293141838477656e-01   -4.398630182771160e-01   -7.814568016722032e-01   +3.926469711802090e-01; +3.196315613490913e-01   -4.768349058328573e-01   -2.387656805570848e-01   +6.443212530480370e-02   +8.158942789967016e-01   -8.025424123561257e-01   +7.770059350924925e-02   +3.437851926420764e-01   +5.108774816341393e-01; +5.412222463074772e-01   +6.640416345426834e-01   -7.001047488446281e-01   +9.862986401222762e-03   -3.491130211181869e-01   +5.890553906065342e-01   -5.153712944562140e-02   +6.701110357886836e-01   +1.925462685829511e-01; +8.773972023475387e-01   -5.138365347637575e-02   -6.951245674162387e-01   -6.099116223239553e-01   +4.607053184142402e-01   +6.120507585852949e-01   -2.403845060135158e-01   -3.347795647299186e-02   +1.000000000000000e+00];
L4_L1_iAMPA_netcon = [-6.330711005535973e-01   +5.999519935852780e-01   -4.024709904220424e-01   -6.423976921092457e-02   +4.262550496285547e-02   +3.910803235097491e-01   +4.605523211512841e-01   +2.494058909139963e-01   +3.724764911829629e-01   +7.442347383279581e-01   +2.575035215456570e-01   +6.559495719182257e-01; +4.245957267999286e-01   +2.530725059877460e-01   +9.187207891501848e-01   +7.428394691914416e-01   +4.132771304423180e-01   +6.455802071776631e-01   +5.869810223550361e-01   +8.511680563935248e-02   +6.878672673147869e-01   +2.141114565831583e-01   +4.120228600193402e-01   -8.959919256021529e-01; -9.073564629606201e-01   -1.000000000000000e+00   +2.776304015216230e-01   +3.139419033500283e-01   -5.922956616260767e-01   -4.630097247341526e-01   -2.525085180671673e-01   +4.956337306110271e-01   +3.313255164547054e-01   -5.969965579342140e-02   +5.090836075524731e-01   +2.993405371102365e-01; +4.536563592332119e-01   -5.057040359329438e-01   -4.557402330881934e-01   +7.631040691318393e-01   -1.506878971138131e-01   +1.923060169968268e-01   +2.766093356872334e-01   -9.942450714496774e-02   -2.951271113883122e-01   -9.413308454769563e-01   +4.857645860469255e-01   -3.757358758751640e-01; -1.517435044016087e-01   -5.218422553135718e-01   +2.033301576456264e-01   +1.220135281170082e-03   +6.880497681346444e-01   +8.627793770600571e-02   -4.753215489010253e-01   -3.047306754010634e-01   +5.588704283374969e-01   -4.807211224216456e-01   +8.451923699670838e-01   -2.452264916716849e-01; +2.322982404633013e-01   +1.942644598626914e-01   -6.830140405750228e-01   +3.948527107257760e-01   -7.522451547229869e-01   -2.473989411856134e-01   -7.528070645530989e-01   -3.578995764023022e-01   -7.681688494044902e-01   +2.766270029058995e-01   +1.908148754987294e-02   -2.507593880174422e-01; +7.045956427430010e-02   -2.545580843338254e-01   +8.890628652459225e-01   -7.344439472372383e-01   +8.976302679569735e-01   -9.035012828376225e-01   -9.373225867277690e-01   +2.532872756326069e-01   +8.512359951365989e-01   +4.121502417630367e-01   +9.249735176726237e-01   +3.668209012128818e-01; -1.815209701693527e-01   -1.026020870342997e-01   +6.874151850774148e-01   -2.370410282618109e-01   -5.743710805262494e-01   +6.949046738214327e-01   -7.529574063121225e-01   +8.177569746962744e-01   -8.408473789681896e-01   +9.236825685711344e-01   +2.879850656981567e-02   -5.707442491885915e-01; -6.664590445267200e-01   -4.986541843257524e-01   -4.999366935689485e-01   +5.557250235941444e-02   +5.027149372448576e-01   -6.521352676181421e-01   +5.334210486668441e-01   -2.905940849778336e-01   +2.921386251905270e-01   -9.054934096785815e-01   +5.486322810176630e-01   +2.315453506366712e-01];
L1_L3_iAMPA_netcon = [+8.201070162915478e-01   +3.050367522756097e-01   +2.139593350461075e-01   -1.586537302177976e-01   -7.352634993011733e-01   +5.468468719482948e-01   +4.705491484383159e-01   -1.115387685048286e-01   +1.263343788036787e-01; -4.252867034824713e-01   -1.738672126756439e-01   -1.634199642151503e-01   -4.682860315251848e-01   +6.203973903228123e-01   -4.874684662892878e-01   +3.216843498164474e-01   -5.569825182837095e-01   +5.269228909152633e-01; -3.996331257519766e-01   +4.649504269314927e-02   +7.092985465379621e-01   -6.106749323260332e-01   +2.647572619525363e-01   +4.291962072543298e-01   +5.191033861415149e-01   +3.843865631585903e-01   +4.777156108512812e-01; -5.425509094519665e-01   +8.438020767892287e-01   +3.938024481934271e-01   +6.644198249744445e-01   +4.959749216114200e-01   +3.566919235973370e-01   -5.184093379754202e-01   +5.154841680307004e-01   +8.187321006155442e-01; -8.075959795591442e-01   +7.142946681512804e-01   -1.782123094261991e-01   +6.252236463106352e-01   -5.411447080010986e-01   -9.113452478134271e-01   -4.290535332042129e-01   -1.228669577136929e-01   -3.190672465198867e-01; +8.218463360245202e-01   +4.516014607170409e-01   -5.953890784254092e-01   -2.430828227439046e-01   +6.778164874947697e-01   -6.739382241359363e-01   -1.000000000000000e+00   -7.671613158814068e-01   +4.429184249871418e-01];
L3_L1_iGABA_netcon = [-5.300855764501956e-02   -6.638231341587068e-01   +4.705752456461093e-01   -5.693847557063114e-01   +4.488161326398169e-01   +8.175266607790419e-01; -5.647500397522739e-01   +3.992843219348837e-02   +9.543458542805431e-01   +3.320381038458354e-01   -4.005403328218030e-01   +1.136465288954487e-01; -1.553208414364840e-01   -2.279575768438604e-01   +2.919393345287292e-01   -2.428254729795727e-01   +3.061551083956358e-01   +2.349041071028387e-01; -1.313779185773311e-01   -3.513823155711500e-01   -3.941498839033934e-01   -2.549021073743515e-01   +3.130332399179647e-01   +3.846320981777695e-01; -2.699414045660852e-01   -8.189379950038194e-01   -7.539944742082755e-01   -3.774180740093712e-02   -9.101570107118505e-01   +5.140405044508154e-02; +6.956873170170748e-01   -1.221704346955518e-01   -9.618726995085675e-01   -2.320163144635749e-01   -4.050089343561756e-01   +8.958056755996613e-01; +7.289610839771786e-01   +4.194374731755030e-01   +8.050941144499619e-01   -1.575718119103798e-01   -8.359462232153768e-02   +7.963466745408584e-01; -9.562801653997244e-02   +8.834211959110652e-01   +8.504998734798104e-02   -6.475958841921294e-01   -2.889551597648025e-01   -1.626754810155382e-01; -1.000000000000000e+00   +8.014275742957305e-02   -9.197157918310825e-01   +3.366266940335524e-01   -7.769089902930905e-01   -4.178074469488028e-01];
L5_Input1_iAMPA_netcon = [-7.216958205980013e-01   +1.000000000000000e+00   -9.016703432304085e-01   +9.456245170386016e-02   +6.843649221834950e-01   +7.133890467182484e-01];
L6_Input2_iAMPA_netcon = [-4.571306325772879e-01   +6.786930852464538e-01   +7.020817352929225e-01   +4.011636392177141e-01   -4.761622111956296e-02   -1.000000000000000e+00];
L5_L6_iAMPA_netcon = [+5.894324915669112e-01   -7.370834058688360e-01   +4.452540064386025e-01   -1.830898619424999e-01   +2.803314625983019e-01   +6.325425958024102e-01; +7.942727535864622e-01   +4.030052778138182e-01   -6.142114242538175e-01   +5.841845182344374e-01   -8.789722931044312e-02   -3.272708587552151e-01; -7.636306943623347e-01   -7.508540255168401e-02   -5.438918816318266e-01   +6.904555518222906e-02   +5.997789850829960e-01   +5.739222101507487e-03; -1.027963304824533e-01   -5.723578244275531e-03   +2.283699361968759e-01   +1.000000000000000e+00   -3.530801543450316e-01   -8.057882844621673e-01; +8.550932422885184e-01   +3.352771615383309e-01   -6.610102065657858e-01   +3.519595196675834e-01   +6.479190875119510e-01   +3.631516976360115e-01; -1.623095868912143e-01   +4.344880018410101e-01   -8.509734742042285e-01   +4.361142621105719e-01   +4.588244421186967e-01   +2.289431609275013e-01];
L4_L5_iGABA_netcon = [+8.818037912355847e-02   -6.597504074945880e-01   +9.217792138892010e-01   -2.964986243911115e-02   +2.453906465436650e-01   +1.598350035570374e-01   +4.217110081811721e-01   -9.837676403532955e-02   +5.159203856806603e-01   -4.150682776711486e-01   +1.135503413687469e-01   +3.009285139261100e-01; +9.169527297882264e-01   +5.596102190951472e-01   +2.781416114603240e-03   +1.947816739455654e-01   +1.667122845198197e-01   +6.176676410179035e-01   +7.497959217206848e-01   -8.130524683582121e-01   -7.258595893538893e-01   +2.616574326331015e-01   -4.064986790257775e-01   -4.298654844759049e-01; +2.247280566840016e-01   -3.540096915743759e-01   +3.671564091055505e-01   +1.104868588903326e-01   +6.634225761203386e-01   -7.600669406644744e-01   +9.970986777343378e-01   +1.000000000000000e+00   +2.584714563180861e-01   +3.261329057570776e-01   -2.919659147999619e-01   -6.955226585056598e-01; +3.113860992802523e-01   -6.397738026903032e-01   +3.107823934231511e-01   -3.074281212956975e-02   -3.289740996173216e-01   -9.093451368440204e-01   +7.961298293477276e-01   -7.091736679418110e-01   -1.655252264596296e-01   +7.454832191897902e-01   -5.108626559620536e-01   -4.161335179400448e-01; -9.365203176961474e-02   -6.546132560384456e-01   +1.800889652200392e-01   -9.659601045674583e-01   +4.599534578096844e-01   -2.035540989458202e-01   +2.662683215219244e-01   -1.150449306556594e-01   -7.724131697440673e-01   -1.120470104718250e-01   -4.164769500207674e-01   -3.172181017927746e-01; +3.286602289602127e-02   -6.758455484039071e-01   -9.197057333099674e-01   -5.264534075756725e-01   -2.799010115479221e-01   -8.294105554500933e-01   -3.999903801018887e-01   -5.051026477919474e-02   +1.098912333692066e-01   +1.232447216194047e-01   -6.155594425419547e-01   -9.930912499718281e-01];
L6_L4_iAMPA_netcon = [+1.369595929863909e-01   -6.831681207201056e-01   +1.702504268879804e-01   +2.953825692055426e-01   -5.299628595554804e-01   -5.087126491273853e-01; +3.716903171991905e-01   -7.160607802609313e-01   +9.359485724301460e-02   -3.588537329233729e-02   +3.799054885378469e-01   -3.368093929794754e-02; +3.117733083130127e-01   -3.268383896768552e-01   +5.983780963367618e-01   -8.836545997837879e-01   -5.160165101982106e-01   -3.082044305232431e-01; -2.092798472172838e-01   +7.107341152756173e-01   +1.487607639913435e-01   +3.859720637775504e-01   -6.575877445532782e-01   +5.535350003193767e-01; -7.927504771190572e-01   +8.896436057729891e-01   +7.366517018344633e-01   +5.022366385150754e-01   -7.666474372586886e-01   -8.044960054292233e-01; +3.433373752722748e-01   +2.149856626952625e-01   -3.803343622116645e-01   +6.653490498504532e-01   +4.983795294542925e-01   +5.166522045180147e-01; -5.675729025763730e-02   +7.151263949626612e-01   -4.922309042151115e-01   -5.293420039134985e-02   -5.421891518375520e-01   +9.246630366131970e-01; -5.697693728522372e-01   +2.859788357883220e-01   +4.992368659722969e-01   -2.127637457607803e-01   +3.231827325361543e-01   -4.834105445342853e-01; +5.870971439701087e-01   +6.588556625089935e-01   +6.259307942163513e-01   -7.370791617863326e-01   +1.166198888416295e-01   +7.708665821421858e-01; -4.211129643796677e-01   -2.657701864159402e-01   +5.158397851481467e-02   +6.609356276926153e-01   +3.891944628284933e-01   -6.253463904807222e-01; -1.000000000000000e+00   +8.049038531134369e-01   +7.205751954655844e-01   -3.127022766666361e-01   +6.674995032759103e-01   +3.149153427876206e-01; -7.200675732615006e-01   +7.140750559531414e-01   +2.858874659803265e-01   +4.813143926346387e-01   -2.993821278751855e-01   -2.775590062618523e-01];
L5_L4_iAMPA_netcon = [+7.873640288558178e-01   +3.427708317715638e-02   -5.780118903042284e-01   +5.855832181907062e-01   +4.158748660770733e-01   +4.377636084669949e-01; -7.824911444732906e-01   -5.229191687396156e-01   +8.240822302502804e-01   -3.972444772200522e-01   -1.443386541468578e-01   +6.512420678223241e-01; +3.686320530523517e-01   +7.289811375218384e-01   +9.996385938507028e-01   -4.008530054223117e-01   -2.433994247417578e-01   +6.722218103540134e-01; -8.943186209647607e-01   -7.054560490640595e-01   +5.206906494681752e-01   +7.935152868838523e-01   -5.678978040223522e-01   +8.533258569440771e-01; +5.743069525588003e-01   +2.722735278509338e-01   +3.531090111360988e-01   -1.902813556896461e-01   +2.258786768525652e-01   +1.966702547244135e-01; +7.241312024875325e-01   -5.812232606459525e-01   +7.100912883959731e-01   +8.692325891643347e-01   -1.094330710347645e-01   +4.885235148568062e-01; +1.174606287616084e-01   +2.525275566196793e-01   -1.897518996134167e-01   -2.189596998151519e-01   +6.646007905892445e-02   +4.377883943253576e-01; -7.704903171827035e-02   +2.662680579564223e-01   +3.473149391101187e-01   +6.056234615292173e-01   -7.452376476999650e-01   +5.405554902866504e-02; +2.125896142072722e-01   -2.940397501458194e-02   +3.186766820681124e-01   +4.954536407564968e-01   -1.306449317309567e-01   +7.209581681157431e-01; -5.132509482735892e-01   +4.780150828022789e-01   -3.087770943151070e-01   +5.053179283644416e-01   +3.417651083454530e-02   -1.635804547410580e-01; +5.935262184753973e-01   +5.875074130789912e-01   -8.863093181209472e-01   +3.473153949648670e-01   -9.400239442827265e-01   +5.695350170563028e-01; -6.985464272459976e-01   +3.358410439830667e-01   +4.132486009114013e-01   +7.097123973651565e-01   +1.000000000000000e+00   -5.477712080633069e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
