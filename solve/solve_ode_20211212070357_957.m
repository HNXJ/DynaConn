function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.823069689287580e-01   -2.700946509113251e-02   -1.511787151044167e-02   +1.174323838495138e-01   -9.872462052334045e-03   -1.358435620419190e-01   +3.568232962554143e-02   -6.970834077421088e-02   +1.045793451382907e-01; +7.378104548200906e-02   +2.055952774578864e-01   -8.578114341888840e-02   -4.904703327853659e-02   -1.036240658545493e-01   -4.784398679278845e-02   +9.293517967059962e-02   +6.285666785187230e-02   -5.567432216255330e-03; -9.871790373888688e-02   +2.697033421549455e-02   -1.076511526328370e-01   +2.978310297239029e-02   -1.628178041093591e-01   -2.376588360746193e-02   +1.429095347152021e-01   +6.420472496939705e-02   +8.261884581469953e-03; -1.290059999784535e-01   +3.847359320354287e-02   -8.243041571144395e-03   +1.665634586959416e-01   -2.055015993749588e-01   +7.114812621763029e-02   -2.723645661416661e-02   -2.493530751093925e-02   +1.724282748389734e-01; -1.284374898736932e-01   +7.312884031596899e-02   +1.082061564182381e-01   -9.385349383527650e-02   +1.328727234530371e-01   +1.280099191952826e-01   +2.159759836260556e-01   -9.478753751450240e-02   -9.921918439598175e-02; -3.178022179303477e-02   +1.619429069661435e-01   -1.873605931566792e-01   +1.857921199317671e-01   +7.029533421137243e-02   -6.429588266645780e-02   +9.440738428595995e-02   -6.529745010748097e-03   +1.000609328296628e-01; +2.863047059387607e-02   +1.214572982053395e-01   +1.075359499925084e-02   -1.537941194010663e-02   -8.385664431678908e-02   +1.374069349030307e-01   +2.364281808944121e-02   -1.808528191608811e-01   +8.956922718088484e-03; -1.172151181826235e-01   -8.194581545283462e-02   +1.059794337127104e-01   -5.343758371712363e-03   -1.213520791640820e-01   -2.624496609024970e-02   +3.090234430968217e-03   -4.232716830839848e-02   +2.249237759479744e-01; -4.146508464139829e-02   -8.988941536057286e-02   -8.964553697484337e-02   -1.055151655298449e-01   -1.201261182036148e-01   -3.922861759968169e-02   -2.072849949057357e-02   +1.248283531160135e-01   +9.715142943758842e-02];
L1_L2_iAMPA_netcon = [-5.512957375591855e-03   +7.261528981515815e-02   +1.426470416595257e-01   +1.234013996347240e-01   +1.272012350248623e-01   -2.979551770775278e-02   +5.895882786475192e-03   +1.027938773352689e-01   +3.377496502025285e-02; +1.222343691817031e-01   +4.108493396201719e-02   +1.856675656465552e-03   +4.433835355192089e-02   -1.730645094116447e-03   -1.172218190940013e-01   -2.325586063610561e-01   -6.690489505359695e-02   +5.006897024731637e-02; +7.975933175796532e-02   +3.021879786254382e-02   -8.548196249863274e-02   +7.388286526413185e-02   -3.492143389928550e-02   +1.511520362669881e-01   -1.709062548854095e-02   -6.594488754679731e-02   +1.144197900577320e-01; -1.280540202908969e-01   -1.521577122750682e-01   -2.881539831605334e-02   -1.492556058694477e-02   +4.966543904928364e-02   -4.702043089372913e-02   +3.006894751731193e-02   -1.441304180736905e-01   -2.250902863448682e-02; -4.641971342150292e-02   -1.719235585197556e-01   -1.191367623109415e-01   +1.643691338015470e-01   -7.874421119947859e-02   +3.676217221042631e-02   -1.961653705523694e-02   +7.193221761194915e-02   +1.412868391215866e-02; +5.853824245870996e-02   +1.942651268475206e-01   -1.475292811608356e-01   +9.930047105646728e-02   -1.124603278512771e-01   -1.210471043977841e-01   -5.049960646773032e-02   -5.163643732185740e-02   +1.989609092893038e-01; -1.479700492950781e-02   +1.504658609280598e-02   -2.115179053818356e-01   +3.898049110913498e-02   +1.625559198297907e-01   -1.032578951374543e-01   -6.607617456365984e-02   +1.708203408277312e-01   -1.697609333620791e-02; +7.742887254604425e-02   -2.345391452229476e-02   +2.620242323678034e-02   -2.298298033416810e-02   +8.268722158317721e-02   +9.602857211056177e-02   +2.894322830090040e-02   +1.139969186559052e-01   -3.293201457512072e-02; +3.088762590941550e-02   -5.333988399780387e-02   -1.216310635335970e-01   -1.484611131788908e-01   -7.864055705717787e-02   -6.631167274818525e-02   -7.622411784695625e-02   -5.526901959237093e-02   -1.317152783425848e-01];
L2_L5_iAMPA_netcon = [+8.494524143242019e-02   -1.721661947775672e-01   +4.293946510798932e-02   -5.524130652737118e-02   -1.569692567367619e-01   -6.830815271194847e-02   -1.072135575313537e-01   -3.904191431567500e-02   -6.566113836801410e-02; +2.257834989331718e-02   +1.783784712321686e-01   -4.007963689258799e-03   -1.481731628312796e-01   +1.695076725060198e-01   -3.473686000511286e-02   -1.924114566625586e-01   +9.752672834683729e-02   -9.949541217104771e-02; +1.297480426424067e-01   +1.864543420358138e-01   +4.931896820063829e-03   -2.609639051046873e-02   -4.690536240800044e-02   -7.242154575597241e-02   -1.369129384042523e-01   -7.400086932826336e-02   -3.585146951055757e-02; +3.655689856792541e-02   +6.044033874998145e-02   +1.204954598953628e-01   -9.848773653271224e-02   -3.850943664548853e-02   -6.886109854174813e-02   -1.316019471113651e-01   -1.102611314928435e-01   +1.581513592917138e-01; +9.441380911850575e-02   -7.155429720172528e-02   -1.619636882659990e-01   +8.730936503004749e-02   +1.533142824618136e-01   -1.074188969472165e-01   +1.289008353230337e-01   -1.051421296135972e-01   -4.689607228512503e-02; -2.110451261319274e-01   +1.555144622039965e-01   -2.800849668571523e-02   -1.664786036469812e-01   -4.264177112874673e-02   -2.002463252305513e-03   +1.715067552654614e-02   -3.975991713660834e-02   +1.106093470876456e-01];
L5_L2_iGABA_netcon = [+6.719366700085075e-02   +1.773607987760182e-02   +8.082942523907308e-02   -3.189039459632993e-02   +9.321099957276599e-02   +3.026116262619955e-02; +5.526994062986636e-02   -1.220434354390044e-01   -5.648022891218192e-02   +2.093024378422552e-02   +6.079560515728883e-02   +7.101341604498823e-03; +5.218194871107223e-02   +6.394788876675467e-02   -6.196057552988115e-03   +2.139440964563735e-01   -2.148295373547891e-01   -5.047065920202036e-02; +4.691759378916824e-02   -9.564126888918098e-02   +3.663165435874292e-02   +1.681946867899987e-01   +7.319856556964088e-02   -8.564649150408374e-02; -1.274011102843770e-03   -5.682117606664738e-02   +6.316007948980425e-02   +3.007960046171076e-02   -1.294627004827756e-03   -1.372793216895742e-02; -1.242965939358605e-01   +1.650666924355218e-01   +2.203168371042824e-02   -7.031736080825873e-02   -6.628675794943346e-02   -1.427296115284202e-01; -1.212091536731446e-01   -1.058403132945088e-02   -2.237406554116149e-02   +1.131480407871582e-01   -3.330474654989863e-02   +1.141245965994577e-01; +2.170413984537708e-01   -2.136120765828689e-01   -6.642268483645666e-02   +1.809442925839230e-01   -1.073482258128185e-02   -8.265891764891631e-02; -2.825335512732812e-02   -3.014680994999847e-02   +9.823963934149349e-02   +8.695713509132845e-02   +6.276696466129125e-02   -7.160340951218336e-02];
L3_L2_iAMPA_netcon = [-8.582425413666722e-02   +1.081922425597754e-01   +2.161667788189727e-01   -1.470108444526503e-01   -1.228615707138116e-01   +7.041544458435377e-04; +6.218997745530976e-02   +2.826542997966978e-02   -1.182386091724986e-02   -8.416612348706846e-02   +3.161808980307462e-02   +2.568515495594256e-01; +1.594376465116559e-01   +4.665784917426235e-02   -1.419988606431503e-02   -6.414533501279085e-02   +2.245720954609570e-01   -4.011102874760787e-03; +4.550366599810839e-02   +4.520641517257676e-02   -1.290415642909622e-01   -9.762334049192922e-02   -1.099836026239898e-02   -1.864406137068758e-03; -5.062532940699795e-02   -1.563617746333311e-01   +1.067755579197557e-01   +4.438628336534111e-02   -1.786232324603026e-01   +1.340835571916516e-01; -2.154315354324721e-03   +7.500895415656739e-03   -8.233767098197793e-02   -2.062602146429232e-01   +9.383091786791700e-02   +7.326140978446719e-02; -1.747620494463206e-01   +8.020989652945168e-02   +7.629407820600295e-02   +1.173457087141453e-01   +1.193010560372157e-01   -1.735620988906218e-01; -2.730456505330908e-03   +1.201555453770774e-01   -1.447282951108339e-01   -1.554494743421838e-01   +1.480456240882717e-01   -7.076656444729393e-02; -9.604942492767279e-02   +1.662540873510978e-01   -2.789611698323523e-02   +5.359154240828495e-02   -6.556690643314661e-02   +1.180214419510874e-01];
L2_L3_iGABA_netcon = [-6.469678349728950e-02   +3.808743994953488e-02   +1.882760126674621e-01   +9.933346221400446e-02   +7.513982547338430e-02   +2.177408576000269e-01   -3.401924882176002e-02   -1.063660496853469e-01   -5.074494012730275e-02; -1.531411731078079e-01   -2.228328311869111e-02   -4.154131549921451e-02   +9.905224841447091e-02   +9.050552812512758e-02   -7.340085287330446e-02   +3.480544699574672e-02   -9.192484598587566e-03   +8.121903697667344e-02; +1.044405225084492e-01   +5.751877041554707e-03   -2.645250868507146e-03   +9.691017924448017e-02   -4.487770442861896e-02   +2.513242209727679e-01   -2.079596502831607e-02   +8.540202170859829e-02   -1.643551318083993e-01; +1.237843553459054e-01   +6.765819329862741e-02   -1.048538448304606e-02   +1.355061516625632e-02   +2.626378776032064e-03   +1.495047493849685e-01   +1.363418549194540e-01   +7.376948525742361e-02   -1.473150866960513e-01; -3.417374668020663e-02   +1.113241975167215e-01   -5.275060655521540e-02   -1.141277283857499e-01   +9.555695654994719e-03   +1.493971512601898e-02   -8.647423562762893e-02   +2.146699448187776e-02   -1.134429674463881e-01; +2.274932515686943e-02   -2.361595605969833e-02   +1.808486085690961e-02   -1.223282615078398e-01   +1.198002342647563e-01   +8.746498306639958e-02   -3.215396657873072e-02   +1.251334831182528e-01   -8.254980858288090e-02];
L1_L4_iGABA_netcon = [-6.772147791516894e-02   -1.241207670451909e-01   +6.476483993577523e-02   +4.059443881292257e-02   +1.978480925945320e-01   -7.476963495871507e-02   -5.925162734739429e-02   -9.501536490807090e-02   -2.776089083988174e-02; +5.280037580887423e-02   +9.767185702616879e-02   +5.877976224925370e-03   -1.542577327051655e-01   -3.543387451636316e-02   +1.180958960766215e-01   +8.393150883459752e-03   -8.729246178412664e-02   +4.556836655225376e-02; -6.768764575022107e-02   -1.118239168011455e-01   -2.052359723294017e-02   +1.488987750708153e-01   -6.900752034873554e-02   -3.008701081617228e-02   +3.317871295670537e-03   +1.563294654768266e-01   -1.942857638265452e-01; -1.613174970697560e-02   -2.749855617168437e-02   -2.401012069689378e-02   +4.423522683164573e-02   -5.079819739688643e-02   -1.997760103736929e-02   -7.027308305969768e-02   +5.017858414591358e-02   +1.297489098603841e-01; -9.131656557812319e-02   -1.287717134902248e-01   -8.190635292541132e-03   +2.561377119040967e-02   -7.535687301812410e-02   -4.907755626886705e-02   -6.142923217168964e-02   +1.340474305094746e-01   -1.710510197859056e-02; -5.344761792695449e-02   +1.611666035854488e-02   +9.923316234264309e-02   -1.478091905237983e-01   -4.435579723405150e-03   -1.037097144150038e-01   -1.745722217182758e-01   +1.277107081763612e-01   -1.484823217041788e-01; -2.991211654956867e-02   +9.413854009329592e-03   -9.676602698982086e-02   -3.138456391603199e-02   +5.433086592161722e-02   +8.941664406813279e-02   -1.691217126420519e-01   +1.813882205508130e-01   +7.178977134028286e-02; +1.222016376443094e-02   +1.106141411151439e-02   +1.198799533263433e-01   +7.005470506502509e-02   -4.503554454178749e-02   -8.907551530300834e-03   +4.837114988192967e-02   -5.908459286515076e-02   +2.099641836199956e-01; -1.842899305019591e-02   -1.565732251615556e-01   +2.953547497726929e-02   -8.619724408595775e-02   +7.867795532133756e-02   +7.371539077534174e-02   -3.609285871535071e-02   -1.923571130912206e-01   +1.214189246516772e-01; -7.284321181187450e-02   +6.103894296146301e-02   -6.167372508997668e-03   +1.082279633045403e-01   -4.882802658918145e-02   +1.634325827846575e-03   -1.723019092384149e-01   +1.422271346851876e-01   +1.998141043753024e-02; +6.623626251130244e-02   +3.514041964584512e-02   +1.021614655400185e-01   +2.095221885959644e-02   -6.225819715912689e-02   +5.421594078244394e-02   -8.619968547462090e-02   +1.356864166885744e-01   +1.417553948970590e-01; -5.954469057148755e-02   -2.382644556247361e-02   +6.939818770987886e-02   -6.467322440407080e-03   +4.163398267734392e-03   +1.864476373675984e-01   +1.621862479621374e-01   -1.709034957182982e-01   -1.125527942049637e-01];
L4_L1_iAMPA_netcon = [-1.163154669306835e-01   +6.395673633003393e-02   -1.051637997739902e-01   -2.978083671895607e-02   -1.180050725822980e-03   +1.369388936081717e-01   -6.011910160261630e-02   -4.524277117755049e-02   +1.711977159464644e-01   -1.644044227892459e-01   -1.953911624180462e-01   -4.882539963230702e-02; -7.986008721231005e-03   -7.013762168165535e-02   -1.400816578955986e-01   +6.827746102768045e-02   -7.846432074484173e-02   +7.268358784483703e-02   -5.889464433253829e-02   +4.982600772492199e-02   +1.865424640657832e-01   +1.855390032363662e-01   -5.571102990023206e-02   +1.687446611943189e-02; -1.201815576096080e-01   -3.375884012378465e-02   +1.702476588097226e-01   +6.885826061453025e-02   +9.904640630998429e-02   +6.465399640402142e-02   +1.151697729098503e-01   +4.083865256864751e-02   -8.794458973035851e-04   +1.101236131427241e-01   +2.493748479760118e-02   -7.168799302250528e-02; -1.406218266148763e-01   +3.495040936013126e-02   -1.826416056181674e-01   -1.263257991808079e-01   -8.682375876448029e-02   +7.509626385250046e-03   +9.728911317463283e-02   -2.586527569120659e-02   +9.478749571539108e-02   +4.181729567626687e-02   -1.008549194039073e-02   -7.575500025932398e-02; -1.089391062650646e-02   +1.944481997245401e-01   -1.099518706909809e-01   +9.548476525539147e-02   +1.226173836627854e-02   +1.207285566354323e-01   +5.806579566670607e-03   +1.243406718156303e-01   +1.637812498474790e-01   -4.910266633733096e-02   +4.813896970579808e-02   +1.865716303835307e-02; +9.586800122210662e-02   -4.192548669467602e-02   -1.096269453671247e-01   +1.242508707107347e-01   +1.037681914574403e-02   +3.313209601341675e-02   +1.465046121658871e-01   -4.610793941322020e-02   +1.541471749617295e-01   -6.371701765672934e-02   +2.960141590063125e-02   +1.191099783971148e-01; -2.261927065928274e-02   -7.327645923142952e-02   -2.686305953855158e-02   -1.800719041017110e-01   +2.586922235936089e-02   -5.716603535686804e-02   -1.156337760740414e-02   +1.397502225632516e-01   -1.494886773271565e-01   -1.412305969411060e-01   -3.746789254316110e-03   -1.579699874301984e-01; -3.273990142763515e-02   +3.602335224370282e-02   -1.290715941815844e-01   -1.828272836408160e-01   -2.083683507274421e-02   +1.421249973558124e-01   -1.391990244381498e-01   -2.953031599963851e-03   -2.877513270694395e-01   +2.837366342239349e-02   +1.293099145686377e-01   -1.112064144027331e-01; +4.748890905928401e-02   -6.577365572372341e-02   -2.195806779281657e-01   +1.442637731729432e-01   +5.262316260622690e-02   +1.126219966000282e-02   +7.774490788872163e-02   -2.674605993698423e-02   -2.323027771744339e-02   -2.115149479397907e-01   +7.013159395429749e-03   -6.544949220671721e-02];
L1_L3_iAMPA_netcon = [-1.137757447363113e-01   +2.611541611160294e-02   -1.548075459713777e-01   +1.657932551697194e-02   -1.288814580702081e-01   +1.192994968202675e-01   -1.412010131474514e-02   -3.456486609990736e-02   -6.500446286195735e-02; -1.379962528872858e-01   +1.360419039794049e-01   +1.360878177614092e-01   +9.036726955999733e-03   -5.567745279310501e-02   -9.494152448925139e-02   -1.215422229926323e-01   +8.838023827508468e-02   +1.075535527785787e-01; +1.308564702150159e-01   -7.993507104820020e-02   +4.393485949183695e-02   -8.000439142636437e-02   -1.292042844782945e-01   +1.327132849297561e-01   +4.226680991064292e-02   +1.282130875043579e-01   -4.213027694013694e-02; -1.318082169891437e-01   +1.519756301515384e-01   +9.454669869762131e-02   -1.338233359315970e-01   +1.524496972496863e-02   -1.206970558529099e-01   +1.426303354103451e-01   +4.844174306953739e-02   -1.132472357229438e-01; -7.714482866800916e-02   -2.896878212337872e-02   +6.209588781922683e-02   -1.389916772267392e-02   +5.844245748950598e-02   -9.298300508564797e-02   -1.506147672132092e-01   -8.973668888370226e-02   +3.340376234661164e-02; +8.979153595821878e-03   -7.375962763243474e-02   -5.084113458577659e-02   -1.601218354027655e-01   +1.170303352039891e-01   +5.600647727769725e-02   -3.955496363038490e-02   +1.925949266565161e-01   +1.375723453603938e-01];
L3_L1_iGABA_netcon = [-1.071706450414366e-01   +5.225616914556491e-02   -2.269787061061489e-02   -8.224631205585577e-02   -1.693907479506394e-02   +1.264216865523676e-01; -1.189278501966587e-01   -3.757138138174432e-02   +8.749517522307659e-02   +5.671384401932406e-02   -3.021068333694407e-02   +2.755446313458034e-02; +1.021443862305171e-01   +1.075590923969760e-01   +2.964202557800208e-02   +1.073973088911967e-01   -5.450971043996925e-02   -3.367802985279744e-02; +6.983384911842179e-02   +1.237874003874871e-01   +4.191443511084859e-02   -6.758785065149713e-02   +1.390488682110386e-01   +9.620709677396708e-02; +1.953458380338065e-01   -1.067420312902932e-01   +3.773907787500902e-02   +1.476074667094928e-02   +2.226923005943236e-02   +1.078894294712525e-01; -1.100097499406610e-02   -7.479580713515360e-02   -1.670586644186313e-01   +6.180981917397366e-02   -1.655606768397801e-01   +1.740822480794506e-01; -6.902761086392456e-03   +1.904012157078022e-02   -6.259250568515988e-02   +1.549355929694203e-01   +2.213030479168354e-02   +1.198752220174626e-01; -1.097420508296697e-02   +1.416392792983360e-01   +2.199468826432528e-01   +4.097675027043348e-02   -2.703654908255670e-02   +1.714375334506739e-01; -3.391920528619474e-02   +8.478967504716725e-02   +8.733084204441731e-02   -1.059523308224683e-01   +4.948449522493187e-02   +2.884407679365222e-02];
L5_Input1_iAMPA_netcon = [-1.306422639218865e-01   +1.017580700050604e-01   -7.295419575144134e-02   +6.360501571413181e-02   -1.562757227631429e-01   -1.711929851798892e-01];
L6_Input2_iAMPA_netcon = [-1.684966160702432e-01   +6.830123871443089e-02   -5.777055757172044e-02   -3.018770910223871e-02   +5.153625021174722e-02   -1.457738651023582e-01];
L5_L6_iAMPA_netcon = [-8.625336896974205e-02   +1.542930141844070e-01   +1.325113202853222e-01   -3.719683393707113e-02   +1.266002065444678e-01   -3.563122311868232e-02; -1.633169699964191e-01   +5.285437530682217e-02   -1.766398639026574e-02   +1.355960169552686e-01   -2.396276049215244e-02   +3.302243286194959e-02; -1.399783455286186e-01   +2.738201475127680e-02   +4.801479908534884e-03   +1.013178073248582e-01   -8.227020842652219e-02   -1.539234580962410e-01; +2.054907866515764e-01   -9.254089793922719e-03   -5.624756188291945e-02   +7.456668395694807e-02   +9.883026025043143e-02   -4.422137493109609e-02; +4.499570427297767e-02   +7.249979134019903e-02   +1.222484346086883e-01   +8.761337194643051e-02   -3.500417098150940e-02   -4.014783989059252e-03; +1.152466397632737e-01   +8.723308004920281e-02   -8.463227907902551e-02   +1.715918402500867e-01   -2.453777581467482e-02   +8.685163408400093e-02];
L4_L5_iGABA_netcon = [+1.096599927244599e-01   +1.607599371670286e-03   +3.840053601880317e-02   +6.114693283852146e-02   -6.165377868272791e-02   +6.138790978936040e-02   +1.009900155930629e-01   +1.222348920731923e-01   -1.523370717471101e-01   +8.103680885904105e-02   -1.138851501122874e-02   +1.647090174852871e-02; +6.411358964572254e-04   -4.442472839621201e-02   +1.182856776521293e-01   -7.623857921446450e-02   +6.138255965339323e-02   -3.487302336893875e-02   -1.358674940899143e-01   -1.579345281749240e-01   +5.890160209804197e-02   -1.205362974779669e-01   +4.264676879906773e-02   +6.786566539328370e-02; -1.167253171714489e-01   +1.363201915386138e-01   -7.511447236476929e-02   +1.913115827969439e-01   +2.002803528694467e-01   +1.848800259240062e-01   -1.266472436821811e-01   -1.562271623667859e-01   -5.443852601561260e-02   +2.067949156583052e-02   -2.068870259536171e-04   +6.647655842570170e-02; +5.625746655390444e-02   -1.738066892824853e-01   +8.794332110103552e-02   +1.374419550966141e-01   -1.117206190185194e-01   +2.225646703667098e-01   +9.993649360516280e-02   -1.312285651274396e-01   +1.750540815487841e-01   +8.727252598428448e-02   -8.068634586375115e-02   +2.991412959415091e-02; +1.274298579373765e-02   +1.025310668123472e-01   -2.840962962514730e-03   -1.842570933182925e-01   +4.124491546994571e-02   -5.313087541983134e-03   -1.989219215213253e-01   -2.104807637166183e-02   -3.654866194586092e-02   -1.096612064292713e-01   -4.977052332894362e-02   +1.242055434788306e-01; +3.703012037954775e-02   -1.390598420214082e-02   -1.313606288803794e-02   -1.375215382501647e-01   -1.969653501717265e-01   +2.709687871224081e-03   -3.934554479443973e-02   -1.186259222216393e-01   -8.288604333974788e-02   -6.154364233537381e-02   +7.898644110532274e-02   -1.287711850841776e-01];
L6_L4_iAMPA_netcon = [+8.552553916271986e-02   +1.961223168010284e-03   -5.812952053826571e-02   +2.223389952450666e-02   +5.465192264610978e-03   +1.835515307452693e-01; +4.153701914662852e-02   -3.291292930292040e-02   +1.702495045736389e-02   +1.037214472477652e-01   -1.262486342170943e-01   +1.095300399039421e-01; +2.068683506186431e-01   +1.395740399287995e-01   -4.304325207303750e-02   +7.511014557453331e-02   -2.961542589628962e-02   -1.837993890682034e-01; -1.697372667540887e-01   +1.426591680804244e-01   +1.566663967474422e-01   +7.727896440685644e-02   -8.725554639259583e-02   -9.888671936573157e-02; +5.568443488179028e-02   -4.510633323543904e-02   -1.301146633866734e-01   +2.320811558817240e-03   +3.918169191174048e-02   -1.547851292821781e-01; +1.440592435013160e-01   -1.614420818679895e-01   +5.623492357532880e-02   +1.481731429242036e-01   +1.413701952042694e-01   +3.007204069547226e-03; +2.037902687776502e-02   +1.126854465944217e-02   -1.666410809678590e-02   -9.943856976186548e-02   +3.899333779136699e-02   +1.892772099742475e-02; +9.510863345220381e-02   -4.303320275477771e-02   +3.357814314886872e-02   +5.558260602627558e-02   +7.613000351747892e-02   +6.498595339931837e-02; -8.157727310730008e-02   +1.105409839518616e-01   -3.482345220605383e-02   -3.824884356103831e-03   -3.785640563926752e-02   -6.896796935064525e-02; -2.023011027079316e-02   +4.827452227460832e-02   +8.550246902000455e-02   +9.675209170363734e-02   +1.378093887626146e-01   -9.441272019054646e-02; -6.438562001865160e-02   -9.240268944716407e-02   +1.308533575155294e-01   +5.288123520422942e-02   +1.217393701796095e-01   +3.457988299880348e-02; -1.277592083690586e-01   -1.219548169161606e-01   +1.454205706900492e-01   +6.713612911285516e-02   -1.055544893343822e-01   +4.137478656513500e-03];
L5_L4_iAMPA_netcon = [-3.589460860018273e-02   -7.074580999395244e-02   +3.683881699234288e-03   -7.791768889970074e-03   +8.710221851989525e-02   +7.308319283916209e-02; -5.742010837277048e-02   -6.863798704490422e-03   -6.625912174046868e-02   -8.842242982792671e-02   -9.148092419331066e-03   -1.702174258452768e-02; -3.458346604499676e-02   -1.067549036164004e-01   +1.223784789664280e-01   -2.325289160895555e-03   +7.376072125487243e-02   +2.314154502474572e-02; -7.721732721679833e-02   +8.011070824021789e-02   +1.364632819384578e-02   +1.204493094110705e-01   -6.300828009823227e-03   -8.707816157067869e-03; -1.669989539839011e-01   +6.878057399621619e-02   +6.674794402643444e-02   +1.219092084401291e-02   +1.045187074574897e-01   -6.095648236932848e-02; -1.321330882181982e-01   -9.102108099221257e-02   +1.536437091373339e-01   +6.990362777450447e-02   +1.346643005828335e-01   -2.264699347008540e-02; -3.089308430649513e-02   -1.277462712746336e-02   -1.180268296513799e-01   +5.959740936911055e-02   +8.322730450416549e-02   -1.455621635143374e-01; +3.063530278523409e-02   -5.515214220019490e-02   +1.536952306376555e-01   +8.234771463239056e-02   +2.805506678794642e-02   -6.706784386673752e-02; +2.882193184348649e-02   +1.088858252559192e-01   -1.451231178260151e-02   -1.992215886052336e-02   -1.821268378622925e-01   -1.129943131021018e-01; +5.637982764643813e-02   +3.327611433829313e-02   -4.548543507225460e-02   -1.248937239131848e-01   -9.223751764904296e-02   -3.736896328534151e-02; +2.044185760621790e-02   +3.146041998855605e-02   +2.846631416457521e-02   +8.864232015657139e-02   -9.306015737907117e-02   -5.032986057296585e-02; +2.025468444546363e-02   -9.075727678889590e-02   -3.402646192054534e-03   +9.130578794882698e-03   +1.895776005986612e-02   +1.278029784572818e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
