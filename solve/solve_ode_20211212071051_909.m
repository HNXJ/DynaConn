function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.760124146142602e-01   +3.936050743943542e-02   -5.928229896316140e-02   +8.021117292521304e-03   -7.896612940609558e-03   -5.984370999012860e-02   -3.916541191764868e-02   -3.785886346977724e-03   +5.967749007008243e-03; +5.009421703021832e-02   +8.069703201429503e-02   +4.224912730557508e-02   +4.195507418676277e-02   -7.161649090386832e-02   -3.276331876028959e-02   +6.471696239017041e-02   +8.992495122386657e-02   -2.402156608064134e-02; +3.357348137609706e-02   -4.458399407410386e-02   -4.053433117335300e-02   -8.485217127065053e-03   -1.197249412384058e-01   +4.435031152780411e-02   +5.921784195589455e-02   -2.609962372215455e-02   +1.631415351470515e-02; -4.746098780441565e-02   +6.407259264314195e-02   +1.412086552438896e-02   -2.174268928716130e-02   -3.523116437811269e-02   -2.187959507747981e-02   +3.642360693502851e-02   -1.907157318138864e-02   +1.170195911622307e-01; -7.943408119102467e-02   +3.611520951461404e-02   -2.469178394369700e-02   -7.601903971537100e-02   +1.040481395443619e-01   -2.135412257133132e-02   +5.636345977406790e-02   -5.448959564421402e-02   +3.365993439289795e-02; +5.379025834102727e-03   -1.510177634697016e-02   -7.315022561004475e-02   -5.656257248331641e-05   -3.803417693661616e-02   -4.490979074761587e-02   -3.327590075145165e-02   +6.997876983549131e-03   +1.188008647894958e-01; +1.047834162912699e-02   +1.060548659201206e-01   +7.317800478912243e-02   -8.948276264503299e-02   +1.806623650928133e-02   +1.370367029985429e-01   +9.741663422799844e-02   -2.393701441607170e-02   +9.460913478230730e-02; -7.047234885577619e-03   -9.196681804117363e-02   -5.076255989502270e-02   +6.870185551001531e-02   -1.116625600175897e-01   +3.595331341012729e-02   -4.025787730893543e-02   -4.153290443981455e-03   +1.489231915118655e-01; -3.469235816967429e-02   -6.831600894411177e-03   -7.319217792864249e-03   -9.438307356304239e-02   -6.582377422662158e-02   +1.566256368800952e-02   +1.964860762348008e-02   +5.105116259544711e-02   +8.535002837845383e-02];
L1_L2_iAMPA_netcon = [-7.210559740121389e-02   -8.000239368698983e-02   +9.303230200430641e-02   -5.567835851869061e-02   +1.135039915252001e-01   -9.603330631932185e-02   -1.464684545166008e-02   -2.953784868527588e-02   +4.288787284074726e-02; +8.004839171602672e-02   -5.819829520872748e-02   +2.413230143439172e-02   +4.408855917522634e-02   -5.683047895970094e-02   +6.488885613163811e-02   +5.288162592127410e-03   -1.132473723458288e-01   -5.885319686231806e-02; +4.729732861583633e-02   +4.798178438240844e-02   -3.300340721350350e-02   -3.133001694379267e-02   -5.505282230289833e-02   +2.442111256634970e-02   +5.679448756855085e-02   -2.712173704122653e-02   +1.681172446545151e-02; -1.487073074239773e-01   -1.077322102308427e-01   +4.116261381784456e-02   -4.551407574202904e-02   +3.920755113688092e-02   -6.314780056862293e-03   +5.589705765742456e-02   -5.757679467866549e-02   +5.718744781683346e-02; -4.533488525820079e-02   -4.558694234147004e-02   -6.046869811769925e-02   -1.942821075680973e-03   +5.228960817370856e-02   +1.275230866973327e-02   +8.887316678171667e-02   +7.392653899081003e-02   +1.554575398176740e-02; +2.652839999141534e-02   -8.816482062800560e-03   -7.332940001972346e-02   +6.899453023833983e-02   -1.224567589532558e-01   -9.347957786733781e-03   -8.539481275837740e-03   +1.034234775997178e-02   +9.179633239874944e-02; -1.229845591171018e-02   -6.330220176930380e-03   -6.799456693271523e-02   -5.639639213903059e-02   +8.963047261531837e-02   -1.041256602367518e-01   -6.947910452476777e-02   +8.348726576818100e-02   +7.151140264616868e-02; +6.920875602445645e-02   -1.982598691203870e-02   +4.015322219394503e-02   -6.152064802789996e-02   +2.691935806179255e-02   -1.184878336102845e-02   +2.231309561320245e-02   +7.440127690355186e-02   +8.313013941446835e-03; -7.523590142021959e-03   +3.132309700222891e-02   +4.754478092753155e-02   +2.220744216019981e-02   +2.894681585564059e-02   +6.114585894894756e-02   +9.141640768765303e-03   +5.748758501886731e-04   -1.222889510336253e-01];
L2_L5_iAMPA_netcon = [+6.028604821088758e-02   -5.862639233251152e-04   +6.074863883063380e-03   -7.481778541761364e-02   +1.622960355491027e-02   +1.407304075878340e-02   +3.880245665474516e-02   -7.689883177310519e-02   +2.115330032723909e-02; +1.555698088576477e-02   +1.288908809898670e-01   -3.005489625301265e-02   -9.042336823843969e-02   -7.113169733116385e-03   +4.141256025846884e-02   -1.076542454423977e-01   -1.102997750746224e-02   +1.523007078935842e-02; +5.603077694986195e-02   +6.001010246716273e-02   -7.175480391413971e-02   -2.333694208456635e-02   +1.154643373250423e-02   -1.181544137768638e-02   +5.991220772691681e-02   +2.327781311471309e-02   -4.810593373630093e-02; -1.008440908274755e-02   -7.268255969959308e-03   +4.886321761721496e-02   -3.986153675915686e-02   -3.975625191018827e-03   -3.860067732332394e-02   -1.171118407164848e-01   -1.623376295991425e-02   +1.427977581024069e-02; +5.667482380358299e-02   -7.359730570705854e-02   -1.297839262651711e-01   -3.060115014008851e-02   +5.069859464706188e-02   +4.371937134267202e-02   +1.066049543173113e-02   -1.062320604674750e-01   -1.632320841955771e-03; -1.640067264251532e-01   -1.656142396570568e-02   -1.135345877786039e-01   -1.364816748440783e-01   +2.834811244794482e-03   +7.070226305196613e-02   +2.148528000343857e-02   -8.881525913605683e-02   +8.853535691731999e-02];
L5_L2_iGABA_netcon = [-1.819999124574587e-02   -1.016356502500104e-03   -6.707611254023139e-02   -9.326774867442057e-03   -1.952686672621212e-02   -7.852927010130778e-02; +5.315161490570949e-02   -1.055904742267745e-01   -5.922398715323713e-02   +2.696581474640412e-02   +9.691427656942196e-03   +2.730024820898619e-02; +5.678446868582938e-02   +3.223363520991787e-03   +1.475176839860825e-02   +2.566062494904392e-02   -3.788837474734769e-02   +2.151509055200946e-02; -3.155053502830131e-03   -6.126308425558590e-02   -4.516966464705282e-02   +4.449841522470975e-02   +2.661661373292901e-02   -4.723276172437765e-02; +7.956195975438016e-02   +3.018083092802048e-02   +2.784855730324626e-03   +4.583751896200444e-03   -4.880321769591390e-02   +5.151549985756163e-02; -7.697246574864650e-02   +1.304914732408642e-03   +1.596451692882266e-02   -3.596203990976564e-02   -1.388312598470021e-02   -5.055099870664091e-02; +1.469527303457791e-02   -6.850141263684750e-02   -7.269294113709551e-02   +6.906880994787003e-02   -5.102233706295964e-02   -1.458506761378276e-03; +1.262103585854440e-01   -6.135903174083691e-02   -5.655004971603617e-02   +1.324061184425525e-01   -6.017440669964005e-02   -5.386080797925511e-02; -4.988355759093500e-02   -2.537740366349021e-02   +2.409449455467998e-02   +5.794438913010631e-02   -5.268619318502109e-02   -7.276455184664422e-02];
L3_L2_iAMPA_netcon = [-1.334305673041979e-01   -2.380957730106558e-02   +2.176370440594095e-02   -8.001863873752700e-02   -7.515386679247871e-02   -3.788968102959123e-02; +1.895187820806093e-02   +9.381430228946044e-02   -9.280707601350019e-02   +3.424578584009030e-02   +8.507401100603697e-03   +1.494044016368546e-01; +7.587767078260696e-03   +3.780759629074319e-02   +5.651971184964224e-02   -7.012192133708726e-02   +9.976150820442298e-02   -8.122020159879471e-02; -2.521467274947699e-02   -4.140285420342483e-02   -7.264684533704882e-02   -3.090337767399757e-02   -4.040562499425118e-02   -1.866994407304500e-02; -3.256172292335231e-02   -2.398393943338196e-02   +2.989890577179674e-02   -6.723545082703841e-02   -1.372613236966295e-01   -8.175176054348096e-03; -3.026029225743967e-02   -7.042447275343952e-02   -1.197130790146770e-01   -1.120175501538355e-01   -5.182337841890076e-02   +1.110439137688511e-01; -6.419380262454928e-02   +6.705414284014542e-02   +7.088166127065028e-02   -7.763669456352243e-02   +5.933556550724193e-02   -2.123090866771950e-02; +4.204704641804732e-02   +3.367303437774566e-02   -1.082995655506668e-01   -2.579915527291215e-02   -5.217852747564710e-02   -6.905917684774864e-02; -7.856323229910298e-02   +3.140966308535211e-02   -5.246455064151502e-02   -4.078245610656097e-02   -1.679999671138872e-02   +6.716057722884214e-04];
L2_L3_iGABA_netcon = [-2.312960462130651e-02   -2.804550384564180e-02   +7.553266098874627e-02   +8.245763765194647e-02   -6.261979178753621e-02   -8.628061866417659e-03   +5.970074241173128e-02   +3.580962956756250e-02   +2.540405148221788e-03; -7.589101916630527e-02   -6.111183705430058e-02   -4.282267822824450e-02   +1.086913038991744e-01   +4.292057799305898e-02   -7.440507277521963e-02   -4.505254410521984e-02   -6.647260510200501e-02   -1.769916937020832e-02; -5.395462838236768e-02   -3.869342062434600e-02   +3.219541413172552e-02   -8.038403502896350e-02   -2.891938607628417e-02   +1.211518492038961e-01   -2.990864308640210e-03   +8.345480182528936e-02   -8.915272658417984e-02; +7.064964597621158e-03   +5.392007564938199e-02   +5.513545780037110e-02   +7.899504296016269e-02   -5.564932215922155e-03   +1.153653117336770e-01   +9.557841816647821e-04   +6.078331195432575e-02   -1.793089082614460e-02; +4.435352781706966e-02   +6.814871532281939e-02   -7.628003828872049e-02   +1.851969045021670e-03   -1.364830231882076e-02   +6.058434249089515e-02   +1.021851296958940e-02   +6.193635075128443e-02   +2.642728452353694e-02; +8.230338985458800e-02   -3.171919372514260e-02   -3.282268104093644e-02   -9.769958140432818e-02   -3.456891956566775e-02   -2.669358152048679e-02   -6.532268750097489e-02   +2.661592785965123e-02   -1.241578090803989e-01];
L1_L4_iGABA_netcon = [-3.202694054299769e-02   -3.036771121259392e-02   +7.266908192863834e-02   +2.000934946034657e-02   +1.461083635701343e-01   -1.055704853741122e-01   -6.811069041177849e-03   -1.315643864980098e-02   -7.291352469810357e-03; +4.498600425979634e-02   +1.645753261288422e-02   -2.512403710042532e-02   -1.206131252833677e-01   -4.271728628192969e-02   +1.095942977648182e-01   -5.151560369741326e-02   +2.623048365913698e-02   +9.472780045847335e-03; -3.705840284608272e-02   -9.076725749033255e-04   -6.810013952201646e-02   +1.058055025853271e-01   -8.987003919381091e-02   -2.834287325958416e-02   -8.114271654922955e-03   +5.043196047834717e-02   -1.482962342681368e-01; -3.516998348889005e-03   +3.958906020306363e-03   +2.431216628576663e-02   -5.900910280767720e-02   -5.102601115996903e-02   +1.709634348575303e-02   +4.133933943112418e-02   +3.465287173855482e-02   +1.211468444862142e-01; -1.120566312378152e-01   -5.801164944310384e-02   +3.831237641282776e-03   +6.200539192889414e-03   -7.265659745565839e-02   +3.176832991599160e-02   -7.343071076155225e-02   -2.647801545772386e-02   +2.037201462285675e-02; -9.057702986239648e-03   +8.044476947987922e-02   +8.280076458524929e-03   -3.216421655357075e-02   +1.515120153816587e-02   -2.587757603777472e-02   -1.328902025042973e-01   +1.843976243738365e-02   -1.392976954960883e-01; -1.526138494523640e-02   +7.059786257502727e-02   -9.257873478721956e-02   -3.334075598509106e-02   +1.112070864547499e-02   +3.005251400811170e-02   +3.231679310176913e-02   +1.940231728123879e-02   +1.309421162848479e-01; +9.626108650653357e-02   +1.027457441164967e-01   +4.936793412607522e-02   +5.377592582281148e-02   -7.165859887329737e-02   +5.256487173931616e-02   +5.206486994833698e-02   -5.524144569304072e-02   +4.796018379002023e-03; +4.541648802201000e-02   -8.892502015799710e-02   +6.628759915210296e-03   -6.358947252589528e-02   -1.196756706860942e-02   +1.149492150790240e-01   +1.256518793762879e-02   -1.198125743522003e-01   +8.711057235346673e-02; +1.145071509873759e-02   +5.316408324950053e-02   -1.400286232176250e-02   +1.251304472884209e-01   +9.058942968413310e-04   +1.895783041234373e-03   -9.280064160290646e-02   +5.695069485751245e-02   -4.332844852940029e-02; +2.962629597213620e-02   +5.487214812470771e-02   +6.653845724692740e-02   -3.067513207557547e-02   +1.308090433875072e-02   -5.383408897897787e-03   -7.529518615362213e-02   +1.158950342144669e-01   +1.062444821600900e-01; -4.049660301484238e-04   -1.687373915092347e-02   +4.197144336071180e-02   +6.298271725109174e-02   +5.512922726420486e-02   +1.639874324957241e-01   +9.080856994567866e-04   -9.647457663220582e-02   -7.252747420912009e-02];
L4_L1_iAMPA_netcon = [-7.539288118599922e-02   +8.037828329489946e-02   -3.789940890885915e-02   +2.290131559909221e-02   -4.571925060521341e-02   +2.561170967179533e-02   +8.743597486891459e-02   +2.330816314361375e-02   -2.132101496021015e-02   +1.385763278182463e-02   +1.510820194572221e-02   +2.883164949275987e-02; +2.903638046005188e-02   +5.616782342515343e-03   -8.847942406401378e-02   -6.495204312875610e-02   -2.131702968223003e-02   -3.024358018087054e-02   +5.427148477064658e-02   +8.221755409091136e-02   +5.368092700566958e-02   +1.113107397900545e-01   +5.385351463236351e-02   -7.796711777963482e-02; +1.868022769713469e-02   -7.893112527835032e-02   +3.082048303692990e-02   +1.693955760129643e-02   +6.769867087105698e-02   +4.138194683249095e-02   +6.883214023634032e-02   +2.335287775370067e-02   -2.993975827884250e-02   +5.904293822819141e-02   +1.598076235182009e-02   +7.075444749619475e-02; -6.433617717869723e-02   +6.993920520515594e-02   -9.635049650973304e-02   +7.260315157076523e-03   -4.611376436438025e-02   -4.827380435751456e-02   +5.839131834845696e-02   +7.940460938076950e-02   +1.380502486184415e-02   -6.332979051104659e-02   -5.325964277797676e-03   -5.002684301028501e-02; +6.861006715849854e-02   -2.911568386513529e-02   +1.810972114666083e-02   +2.857603063361222e-02   -5.227153243250700e-02   +4.424397907236378e-02   -9.971070606978800e-04   +1.242705850420968e-01   +4.808778032232474e-02   -7.377596632685279e-02   -5.537367613442087e-02   +8.393125083833006e-02; +8.919761250814458e-02   +3.523696542417565e-02   -5.163062668484960e-02   +9.089851085114894e-03   -7.298538825845798e-02   +9.748135284956033e-02   +1.183720042125036e-01   -9.537075970062647e-02   +9.775058009009709e-02   -1.641382103436701e-02   +4.399412684052487e-03   +4.153628285934976e-02; -6.663801334723987e-02   -2.607336027371349e-04   +1.017884682649468e-02   -1.159483066377285e-01   -2.451463723550985e-02   -6.899515375663053e-02   +1.360655384754964e-02   +6.398230419196490e-04   -1.082596361293642e-01   -6.735272183716998e-02   +8.578018643715833e-02   -1.499341659392213e-02; -4.804035914628821e-02   -4.041159848203638e-02   +8.611287447534732e-03   -2.069277505600835e-02   -2.713623483744393e-02   -7.115535479324763e-03   -4.044432592428725e-02   +7.275321538343651e-02   -1.824217794641867e-01   -3.691091947045331e-02   +9.903818196770885e-02   -8.426847782297110e-02; -6.117378919430914e-03   +1.619383331180575e-02   -9.641164171402035e-02   +3.521907016581304e-02   -6.049007150953695e-02   +6.938343515746487e-02   +4.475338349845541e-02   -3.488475222385767e-02   +3.970696811068301e-02   -1.247890189928485e-01   +2.786108210109912e-03   +8.114278072023879e-03];
L1_L3_iAMPA_netcon = [+3.178670838147654e-02   -4.065856354348233e-02   -1.311018175348040e-01   -4.109203121694688e-02   -1.277670285054113e-01   +1.817214082277813e-02   +7.272213607131510e-02   +4.661960966361948e-02   -1.188757099354947e-02; +1.749367201534275e-02   +1.209330732741585e-01   +7.891514938703004e-02   -8.418787372535008e-02   -4.360092673686802e-02   +5.243522374096746e-02   -1.112763669576827e-01   +1.416681026919567e-02   -4.044036022013783e-02; +8.133174738938959e-02   -4.157855141434639e-02   -9.603806627263588e-02   -1.189044332970566e-01   -8.502581694166995e-02   +1.212960560339507e-01   +8.869171482801289e-03   +4.594295073129148e-02   -6.692391576036788e-02; -5.893156971580150e-02   +1.002460964506688e-01   +8.389404950169395e-02   -2.914249286953800e-02   +6.408257391466526e-02   -2.834236891059492e-02   -4.600957080862064e-02   +3.482414007195363e-02   -1.297429521183291e-03; +1.416221603386786e-02   -3.757599701160778e-02   +6.154193593220969e-02   +1.134612334721555e-03   +1.673431412995066e-02   -8.585037393429079e-02   -5.461116793173313e-02   +2.589981858192602e-02   +6.587843876166045e-03; +5.504349738088894e-02   -3.065498454178366e-02   -7.885145333607797e-02   -1.266332294543847e-01   +2.231944473581864e-02   +1.043262116470916e-01   +1.977146568889669e-02   +9.260854168131518e-03   +8.825979912164601e-02];
L3_L1_iGABA_netcon = [-2.281422872426102e-02   -6.281638942020881e-02   -6.191015745967784e-02   -1.378818239715972e-02   -3.872515226083523e-02   -2.668927045950807e-03; -5.004299478779874e-02   -8.600474937578288e-02   +5.852715248066902e-02   -5.511297178869191e-02   -3.405099957763973e-02   +8.090335033906274e-02; +5.339553936615608e-02   -5.129848615310280e-02   +5.625621366578625e-02   +1.018958697736996e-01   +2.155948792888774e-02   -6.467046626625672e-02; +4.465374787936604e-02   +1.238482716874087e-01   -9.721676958699439e-02   -1.037688328945000e-01   -2.226018446205398e-02   +2.026590421270467e-02; +4.844683974139674e-03   -6.063884031204327e-02   +3.292207847728868e-02   +6.397059204142005e-02   -7.185707211168599e-02   -1.954630649496026e-02; -8.203737149682659e-02   +9.975973892188067e-03   -1.112429938183394e-01   +8.298879955059953e-02   -4.423510269775985e-02   +1.310490460773719e-01; +9.222135606468385e-03   +4.209657113177809e-02   -7.487263981521279e-02   -4.660789689147098e-02   +1.779547538081701e-02   +1.472669246635250e-03; +5.507117331877599e-02   -3.344194113512694e-02   +7.139078776886725e-03   +1.955180190659710e-02   +5.017697674910307e-02   +1.216707585421000e-01; +4.506298417128057e-02   +7.701255818737880e-02   +5.520106182959451e-02   +1.083472791446919e-02   -2.911132361027015e-02   -2.354519443960816e-02];
L5_Input1_iAMPA_netcon = [+4.779751705659072e-02   +9.961876021290345e-02   +6.325148165164328e-02   +5.393885245943666e-02   -1.751918330065468e-02   -1.329797829958810e-02];
L6_Input2_iAMPA_netcon = [-2.927388119763015e-02   +7.601633374241622e-02   -1.954291394313635e-02   +5.494258713253949e-03   +8.678693886419632e-02   +7.404729643348081e-03];
L5_L6_iAMPA_netcon = [-8.773316651258511e-02   +5.008991593947815e-02   +1.239930213779554e-01   -7.084010373971199e-02   -9.802809459175457e-03   -5.104874298395035e-02; -2.400543150916306e-02   +3.500502902751073e-02   -8.363211150188286e-02   +5.566168145673880e-03   +3.194412093753538e-02   +3.025400576448114e-02; +2.527909237649989e-02   +9.402388143492742e-02   -2.409415845909286e-02   +3.098645986970085e-02   +1.468830931336062e-02   -1.227608481007732e-01; +6.368981535758378e-02   -5.858162725395973e-02   -1.108893308570875e-01   +9.116993766292440e-02   +8.887157717088193e-02   +3.604986747502448e-02; -5.200345648506427e-02   +7.780651134923708e-02   +4.862484228751437e-02   -3.881966879435421e-02   -2.903074066963298e-02   -6.975450109842267e-03; -4.448055486937853e-02   +4.689311225396558e-02   -4.379053020983435e-02   +7.548108193820775e-02   -5.185353705797482e-02   +9.301974371947534e-02];
L4_L5_iGABA_netcon = [+9.237949776166778e-02   +2.450396494364826e-02   -6.102332271907786e-02   -2.764086003292156e-02   +6.213656969233988e-02   -3.718994378591790e-02   -9.237841109175425e-02   +1.102837733950268e-01   -9.156391457860105e-02   -2.556716780381835e-02   +5.136735118533579e-02   +8.136388817174423e-02; -2.709712949163577e-02   -4.589543613709257e-03   +3.250563934431917e-02   -3.281528134278408e-02   -1.058006879434242e-02   -1.348707584215342e-02   +2.135444714534382e-02   -8.947506951149467e-02   +7.455680805965258e-02   -6.544631291562220e-02   -3.362665888290846e-02   -1.148274368976186e-02; +1.147360161381594e-02   +4.899390693115106e-02   -2.910435420259860e-02   -2.303622823676528e-02   +2.019256496397660e-03   +9.214944622518442e-02   +6.551940550043694e-02   -5.230754976651372e-02   -8.513780027218523e-02   -5.000027526117799e-02   +2.037240135203096e-02   +1.172722737879746e-01; -2.965764391392392e-02   -1.552780945047745e-01   -6.667812451087768e-03   -2.090070674384965e-02   -8.682548563589032e-02   +1.918071523198578e-02   +5.800409129605037e-02   -2.430792996248065e-02   +2.532881667027360e-02   +1.103561939599230e-01   +2.544072721206163e-02   -2.824384366727489e-02; +3.798434989424952e-02   +1.087216732410102e-01   -5.263614786268585e-03   -3.521893975165388e-02   -8.193692151845096e-02   -1.964226442471817e-02   -1.031173902579167e-01   +3.673634201428554e-02   +4.412995539615350e-02   -1.028971075536658e-03   -3.798447255423913e-02   +9.882684999687362e-03; +1.725167352613480e-02   +4.228922198635235e-02   -3.632078854915895e-02   -4.135189245020822e-02   -1.416885969999367e-01   -1.166434432852139e-01   -4.136897223092089e-02   -2.882906840139238e-02   +5.331519621942719e-02   -6.099391186822280e-02   +5.637815102689269e-02   -1.025722694738848e-01];
L6_L4_iAMPA_netcon = [-3.426440936948759e-02   +4.868633410553607e-02   +1.287047862646732e-03   -5.018046260117399e-02   +4.871372524223969e-02   +1.793639100691535e-01; -4.764533804126583e-02   +7.448324184349618e-02   -1.892170010613264e-02   +1.940966972234762e-03   -7.027515430058863e-02   +1.133901370547470e-01; +1.206596866423732e-01   +1.473753673361603e-02   -9.487458139089659e-03   +7.296830300697869e-02   -3.923167225998163e-02   -5.491044525391894e-02; -1.676722041393199e-02   +3.565729160542173e-03   +3.708433352310481e-02   +8.089088848499140e-02   -8.636891286490965e-03   -3.086463177090467e-02; +5.752748552400651e-02   +4.508717237243513e-03   -4.820688416526107e-02   +2.493716370226388e-02   -7.806395020171104e-02   +2.246418631372114e-02; +1.101120763849533e-01   +4.959421868015527e-02   -1.011460724858134e-02   -8.362402513326306e-03   -6.213201573100043e-03   -7.327566587174721e-02; +9.349681413160553e-03   -2.488744231433344e-02   -2.915859615962882e-03   -1.154405645961617e-02   -1.884594889615035e-02   -6.098638687652971e-03; -4.517193911775909e-02   +6.821367303355676e-02   -9.268854779233218e-02   -5.981448130121633e-02   +7.591983943674648e-02   +3.943306066276273e-02; -1.533685043248543e-01   +6.300213051955905e-02   +6.022324140114237e-02   -1.057761179027204e-02   -7.478489300893142e-02   -6.199973940216859e-02; +7.241980931635100e-02   +4.307049979551507e-02   +2.787191234004145e-02   +1.340429771242693e-02   +2.372304942158603e-02   -8.104434132588072e-02; -5.424447614248703e-02   +4.839407540077233e-02   +3.602073616094833e-02   +8.574599971832733e-02   +6.056009189121343e-02   +9.618669421989691e-03; -2.458767979175705e-02   +3.615648221276275e-03   +7.207147732567790e-02   +6.868148252787856e-02   -1.195815128773534e-01   +4.943056643846604e-02];
L5_L4_iAMPA_netcon = [-4.227968366257455e-02   -1.138214195449341e-02   -2.118610622488345e-02   +2.837515422919166e-02   +6.626471816123496e-02   +5.267821804069781e-04; +2.662783423217929e-02   +2.315272730600169e-02   -6.794316681289170e-02   +3.210881227547374e-02   -4.985738227410620e-02   +5.767975552893556e-02; +8.550164841308749e-03   +5.436937696918746e-02   +3.004048622704257e-03   -8.579804648037068e-02   +4.438439511338783e-02   +7.066417000037763e-02; -7.364117356825013e-02   +3.072309538829784e-02   +8.132825561163746e-02   +8.463940754633302e-02   -6.828369633716237e-02   -3.926312462835924e-02; -4.610828310888819e-02   +8.640160879950884e-02   +2.796639513804525e-02   -5.609564594306693e-02   +2.913332876928646e-02   +1.921548225850109e-02; +6.574209103201295e-02   -6.776665186906386e-04   +5.405841955689868e-02   -1.972755307749878e-02   +8.994948321200268e-02   +4.131615683827627e-02; -3.511343826211584e-02   +9.800352197055129e-02   -5.049020567405110e-02   -2.132467672291436e-02   -3.650771965572483e-02   -5.844953051391182e-02; +9.321199719206138e-03   -3.894376460001775e-02   -4.195264908625820e-02   -5.003786103824265e-02   +6.846487740634558e-02   -2.494932096378322e-03; -9.240215493821094e-02   +8.744386245866993e-02   -1.078538901154289e-02   +3.981103423201952e-02   -9.875357557845703e-02   -1.242112004292184e-02; +8.995890733205064e-02   -4.472010287724727e-02   -8.483064905650239e-02   -7.731116593954258e-02   +6.365256761274782e-02   +1.423987407791392e-02; +3.222603727591458e-02   +5.984090941046555e-02   +5.067140034324167e-02   -2.999248930904707e-02   -2.858012004875139e-04   -7.171766320787951e-02; -5.436276894980164e-02   +1.125502315050797e-02   +2.187449524363323e-02   -4.260647198875759e-02   +5.463486608293278e-02   +7.215740762888033e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
