function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.802035443290553e-02   -9.454680946757377e-02   -3.364184661645286e-02   -3.260332192221878e-02   +9.322244944411422e-02   +1.271476117183555e-02   -1.144700829165664e-01   -4.624629618333578e-02   -6.381320687672687e-02; -2.106362091699555e-02   +2.172275921494393e-01   -5.315711243813428e-02   -7.559937236541291e-02   -5.982052145416098e-02   +1.100326085655400e-01   +2.891721274191260e-02   -5.623006032636711e-02   +1.525015336909935e-01; +4.235500687161632e-02   +5.254742604268245e-02   -4.387349871055053e-02   +4.278991840075914e-02   -1.507566737746970e-01   -4.896468777006493e-02   -1.588739408359381e-02   +3.284684305232882e-02   +7.017981443250948e-02; +5.954734755981399e-02   +3.387362160842247e-03   +3.097325631467494e-02   -1.143960390591458e-01   -9.482152180831763e-02   -1.028198065803940e-02   -5.759774343922886e-02   -7.711560039917009e-02   +8.718176482784440e-02; -4.643601538387220e-02   -5.863243727818664e-02   -1.038613506497367e-02   -1.477557640358418e-02   +5.495533047001989e-02   -1.122190933579015e-01   +1.943691449091911e-01   +1.277628837016533e-01   -1.219584821832689e-01; +1.738831504341265e-01   -1.035170279189448e-01   -2.547553468163424e-03   -8.265321292159138e-02   +3.344910478745408e-02   +2.346680315042771e-02   -3.121790561848602e-02   -9.531977577249368e-02   -1.169730495995185e-01; -9.591576284783754e-02   -2.278236770528121e-02   +6.061466269226863e-02   -5.398900047788139e-02   +1.889675942435138e-02   +5.517751266221102e-03   +1.159328710541824e-01   +2.857046445396286e-02   +2.208684641088844e-02; -8.974001501232930e-02   +2.991214549500504e-02   -1.079889465275144e-01   -9.980655319016160e-03   -1.854074102032931e-01   -1.105338638317023e-01   +4.975639935057383e-03   +3.535622272610246e-03   +1.098127528377160e-01; -1.285269100236577e-01   -1.191696719265510e-01   +8.277304409465359e-02   -8.688149191953404e-03   +7.483361570939447e-02   -1.672085635430215e-01   +9.388929880811159e-02   +1.450660074157603e-02   +8.052749079688486e-02];
L1_L2_iAMPA_netcon = [-8.251389600854341e-02   -1.460732337141592e-01   -4.244295762698931e-02   -1.669913532900466e-01   -7.374288112204316e-02   -7.507514838738177e-02   +6.716184629205912e-02   -8.271926741324555e-02   +4.293823625912584e-02; +9.703696298553637e-02   +1.224034724596296e-01   -1.324938928715470e-01   -7.776108961910751e-02   -6.619385096834629e-02   -6.334066520359199e-03   +6.975032437148665e-02   -2.134651785997569e-01   -8.445522677296127e-02; -4.335271866740822e-02   -7.252547176796292e-02   +5.462078619945039e-02   +8.910962705105691e-03   +5.457126030646673e-02   +1.609993880547288e-01   +1.427568075118903e-01   -5.973279176725957e-02   +7.658474162942717e-02; +2.666443964570726e-02   -2.228044336948266e-01   -1.695260486355593e-01   -1.326708113217076e-01   -3.958765338821102e-02   -5.612324593597627e-02   +1.681744597986945e-01   +1.821824307741098e-01   -1.000697100790025e-02; -1.053331247120046e-01   +3.229822591862566e-02   -9.236843277026643e-02   -1.193635177268560e-01   -1.475662866837264e-01   -9.338610908424749e-02   -6.993845739632862e-02   +5.200470518569127e-02   -1.743098357544111e-02; +1.092159702017105e-02   +1.826435988805994e-02   +2.190628937787133e-02   +2.789966009080072e-02   +1.201317536455144e-01   -3.066716482702705e-02   +1.402856708180531e-01   +8.754467120949350e-03   -4.133646940475563e-03; -5.027615255536259e-02   +4.136345540306424e-02   -1.856062317199169e-01   +5.917622835971900e-02   +2.540233095676836e-01   -5.117868734949326e-02   +2.407018668296878e-02   +8.063817120595819e-02   -1.400325920219275e-02; -3.082866836137333e-02   -7.038177816550611e-03   +6.140806931410688e-02   -9.991567008953842e-02   +1.706292904034120e-01   +7.398548666268910e-02   -5.648075516379812e-02   +1.409904282420296e-01   +1.700291294935480e-02; -6.973006652837130e-02   +1.089477467721201e-01   -1.864836128680405e-01   +1.288113251130138e-03   +5.653044100262608e-02   +3.933706924758306e-02   +1.834744385824102e-01   +1.409410990284398e-02   -4.392330422651844e-03];
L2_L5_iAMPA_netcon = [+1.928941167099132e-02   -1.610066235974032e-01   +8.769953184156200e-02   -6.503485240832385e-02   +1.181283206212782e-02   -1.514724787562101e-01   +1.945679912608404e-01   -1.566899183543961e-01   +1.395262043028033e-02; +8.701660154119079e-03   +8.074480779513662e-02   -6.138051530758613e-02   +4.253967631245149e-02   -2.461598627699933e-02   +2.131536626306731e-02   -6.935945815844516e-03   +8.306518232829925e-02   -4.106626557735776e-03; -1.095064398688135e-01   -1.257565454551741e-02   -1.276816271967024e-01   +1.096859963949131e-01   -1.282669581562544e-01   -1.421641393103039e-02   +3.943922605786850e-02   -3.630950203111518e-03   +7.784386101060063e-02; -7.045005206750844e-02   +1.015012348476280e-01   +2.278861028758253e-02   -1.450640583535450e-01   +1.153470786926624e-01   +1.781215613563952e-01   -7.114256365350666e-02   +5.866901085050510e-02   -1.020750844203977e-01; +1.369073832271875e-01   -2.351030530306798e-02   +5.500946936577412e-02   -3.741378654118987e-02   +7.136280059463182e-02   -4.699321040041358e-02   -1.085753446030553e-01   +7.998444716870381e-02   +7.189546345358153e-02; -1.364469160722712e-02   -3.008124184275739e-02   +3.754446926917600e-02   -1.610498459620928e-01   -2.661228601075748e-02   -8.754241879503907e-02   +3.325045809724747e-02   +3.939902718717223e-02   -1.731327986322580e-03];
L5_L2_iGABA_netcon = [+7.678635430859686e-03   -4.581746575986266e-02   -3.312428924275247e-02   +8.572083980110337e-02   -4.620737675372630e-02   -5.658519041926736e-02; -3.425547979751793e-02   -1.975175757635278e-01   -1.500220536335050e-01   -1.535957606538762e-01   +1.128957666243630e-02   +4.219745092508595e-02; -4.040505135303581e-02   -1.613368228346103e-02   +6.238858466034623e-02   -8.636796252693399e-02   -3.316198571225157e-02   -3.322581095548842e-02; +1.496195546061724e-01   -7.109632147527921e-02   -1.505173163549363e-02   -7.897741514438039e-02   +7.157183674963624e-03   +8.372793437081697e-03; -6.322394787227398e-02   +3.451106890021272e-02   +4.964790400719861e-03   +9.462688071302376e-02   -4.969377929274079e-02   +2.644376384565643e-02; -1.080547155688689e-01   -1.432945812369345e-02   +8.465251268204875e-02   +1.466034396865760e-01   -6.651351097712751e-03   -9.732128240548372e-02; +7.340967555666368e-02   +1.803184535651516e-02   -1.878775296869505e-01   -3.836631778042705e-02   +5.788173499309696e-02   +1.496922532409747e-01; -1.211457642351458e-01   -5.004743573683598e-02   -4.384503233431709e-02   +3.067378696799791e-02   +1.347676422476134e-01   -1.468556583384781e-01; -6.088368375583925e-02   -1.236457662012196e-01   +1.981719812938338e-01   +1.066058347935305e-01   -1.303125013301013e-01   -1.279185402687413e-01];
L3_L2_iAMPA_netcon = [-4.338817853536293e-02   -7.686617366881134e-02   -6.426394912923752e-02   +8.952546156713835e-04   -3.824526396364331e-02   +7.173410754113699e-02; -4.099607687114992e-02   +1.441089360971251e-01   -1.804290916692916e-02   +1.017460005717540e-01   +2.964312423841398e-02   +6.855813083017701e-02; +1.785244753200450e-01   +4.637415284548637e-02   +1.905426832151866e-02   -1.907227223956792e-01   -9.174429814834387e-02   +8.216977101887703e-02; -9.798611420641042e-02   -8.155670640014481e-02   -3.065700770002956e-02   +3.184731280359961e-02   +9.462950929615523e-02   +5.581875410242926e-02; +7.242363107503696e-02   -9.035486791785395e-02   +1.574954381567423e-01   -9.155539355394067e-02   -9.394563983779541e-02   +3.703863387066241e-02; -2.457149652219745e-02   -6.175758119339654e-02   +2.374954786803048e-02   -4.257841996975072e-04   -1.064734849514978e-02   +9.130024126224183e-02; -6.428692413531202e-02   +5.823897813880152e-02   +7.390606166474623e-02   -1.720084546616059e-02   +1.085976070873629e-01   -1.539242787473807e-01; +1.082562636043269e-01   -3.810661326443819e-02   -1.738400541847401e-01   +9.919137500080374e-03   -1.745921683731745e-01   -3.025705821166692e-02; +8.555789438077550e-02   +1.284854568264366e-01   +1.483434767229607e-01   -3.839589034101212e-02   -1.038501388208748e-02   -1.561986924015035e-02];
L2_L3_iGABA_netcon = [-7.662345888988638e-02   +8.734694179464975e-02   +1.081812754123718e-01   +6.859759694863418e-02   -4.910573406333164e-02   -9.221429853673534e-02   +2.338985948215593e-01   +7.748580764022453e-02   +7.492757190910029e-02; +7.827175537875962e-02   -2.092372012624717e-02   +4.361141636723077e-02   +1.721537604621800e-01   +1.811111377096680e-02   -2.630166758465652e-02   -2.387911113527433e-03   +1.661034922675963e-02   -2.830554528151253e-02; +3.982565395609199e-02   -7.175024919472550e-02   -1.430504128787137e-01   -5.356934975724273e-03   +5.060097146019840e-02   +5.417116497780403e-02   -4.387173544112893e-02   +7.333566022100486e-03   +6.049779287706082e-02; +6.165215029828106e-02   +1.861013018284230e-02   +1.265532436250542e-01   +1.231722870433518e-01   +5.533321750923588e-02   +1.260800846749290e-01   +1.490164769380384e-01   +5.439540039987248e-02   +1.965625322593314e-01; +7.672739863311773e-02   +1.024983766526635e-01   -3.221319799321967e-02   -2.314440436348669e-02   -1.436987143852156e-01   -3.164525113481918e-02   -2.124165820513416e-02   +1.155509576160412e-01   +1.283608444718736e-01; +1.308994991901688e-01   -6.209043664403323e-02   +1.508264445443032e-02   +3.133912083084466e-02   -1.593384884605238e-01   -1.462047794670996e-01   -1.358642621339777e-01   -1.593029468993150e-02   -1.671673156248696e-01];
L1_L4_iGABA_netcon = [-1.537925860579268e-02   -9.103060112329850e-02   +1.552161558832573e-01   +5.708924883483006e-02   -5.217669952836406e-02   +2.107492372401688e-02   -5.821453883098784e-02   +8.856885474962370e-02   -1.508079400759441e-01; +1.774291920252404e-01   -1.651058798080112e-02   -4.833939395482560e-02   -1.042827703108384e-01   -6.096449878300069e-02   +9.219417691666559e-02   +7.771728215906964e-02   +1.054622611651278e-02   +1.291945464685061e-01; -4.666031916172377e-02   +1.523104747986601e-02   +4.877657913436391e-02   -1.072310361507124e-01   -7.191078993154049e-02   -7.405943941079839e-02   +1.959743052319871e-01   +1.271923410045445e-01   +1.134617669142374e-02; -8.260194516219874e-02   -4.657417116673300e-03   +4.324034563233450e-03   +4.414019889931396e-02   +3.491013386464126e-02   -1.185281895185396e-01   +1.689612810684551e-01   +1.445733396584467e-01   +1.574793302488614e-01; -2.291467476567986e-02   -2.165093848521172e-01   -5.599904639723360e-02   -9.358682077133550e-03   -9.855442339510272e-02   +7.554445784561693e-02   -1.443294043594026e-02   -1.337803689144278e-01   -2.115885131276848e-02; +1.518199205124710e-01   +1.510899644811183e-01   +3.897554565311389e-03   +1.002174910559092e-01   +1.013001494979418e-01   +1.377172386299675e-01   -1.962104961268493e-01   -2.504613675654880e-02   -9.109983283354488e-03; +5.423728309543666e-02   -2.526168015123917e-02   -1.612815321010089e-01   -1.021367140195269e-02   -2.032657872207396e-02   +5.945504061212278e-02   -4.601025085711502e-03   -1.223424801575677e-02   +6.653020980780680e-02; +3.404699380832492e-02   +1.826620267672030e-01   -2.988687048124954e-02   -4.712027355416202e-02   -1.142367083007384e-01   +8.981416880331004e-02   +9.509409350879175e-02   +3.403138476046094e-02   -3.628361719367685e-02; +8.350291653542632e-02   -8.433203436540172e-02   +9.689697095732773e-02   +4.792678812229484e-02   +5.307640386771165e-02   +1.483074162939674e-01   -1.035161721261308e-01   -1.933450956229475e-01   +2.074606819698738e-01; +9.118933649551209e-02   -2.963013431840197e-02   +4.687255378446940e-02   +4.084848234023194e-02   -1.345909375456930e-02   -7.038342912316749e-02   +7.795693911295433e-02   -5.289405755559310e-02   -8.785680726655912e-02; +3.370984575162617e-02   -8.446600288467766e-02   +4.026498448844566e-02   +5.575164519821703e-02   -3.733020880142914e-02   +1.408344396707839e-01   -4.931235097861265e-02   +1.716468673601844e-02   +1.540902372011398e-02; +3.792694969115835e-02   -3.886143859774646e-02   +1.017144209612927e-01   -1.196314769382504e-01   -8.552780943317397e-02   +1.909996068337438e-01   -2.971037392078195e-02   -1.631155468509926e-01   -1.396351390184990e-01];
L4_L1_iAMPA_netcon = [+5.226264711744333e-02   +5.015927153062587e-02   -3.837418215168761e-02   +2.543055214055078e-02   +1.266612460587130e-01   -7.485682796296986e-02   +1.432603699692038e-01   -1.973425451024069e-01   -6.471597382053414e-02   +1.503903292535210e-01   +1.564896443035059e-01   -1.013766854537784e-01; +1.618502787343926e-01   +1.399096983210900e-01   -8.252233175576620e-02   -4.504651144616179e-02   +1.228804730491367e-01   -2.998867696115371e-02   -1.338764766815597e-01   -5.804655539811120e-02   -4.634461192967371e-03   +7.465232768715321e-02   -2.579022459374847e-02   -1.561539452587806e-01; -7.681029561252908e-03   -5.195336057062551e-02   -1.724324194176508e-01   +6.421766374182225e-02   -7.260070393745077e-02   +8.157354841430892e-02   +6.375612694995765e-03   -2.234106379880731e-02   +7.104373904529256e-02   +6.413407958308173e-02   +3.196364624030220e-02   -1.562388598658157e-01; -1.137970236798156e-02   -7.510748465762976e-02   -4.226602499479207e-02   -3.882562185108560e-02   -8.991915416512029e-03   +6.040744704388273e-02   +1.843710791829981e-01   +8.201918309623862e-02   -3.766341827386098e-02   -1.542031303486444e-01   -2.818048877007161e-02   +2.452658361672932e-02; +8.868248148931571e-03   -5.204278912997355e-02   +5.791097592391464e-02   -4.569359142983011e-02   -1.360330881156060e-01   -6.029759060103005e-02   +8.576658753997088e-02   +4.030269247891786e-02   +1.362500825074881e-01   -1.798413574599430e-01   +6.770899854309455e-02   +5.700911188276317e-02; +1.755876328892046e-01   -9.844678867614362e-02   -1.759835326303444e-01   +9.375245928979772e-02   -1.346289252559203e-01   -2.442142849553604e-02   +1.096371134162231e-01   -4.388539955681409e-02   +6.949415443492850e-02   -5.570530256003911e-02   +1.764503321741758e-02   -2.375299218414096e-02; +4.179996349019666e-04   +9.123248028278913e-02   +1.118787442593000e-01   +1.552212919653811e-02   +4.448786891335528e-02   -1.301079665980826e-01   +1.908132467692147e-01   -7.386519919035982e-03   +9.083712656392934e-02   -3.179981705392505e-02   -8.986703512722588e-02   +2.719203808162496e-02; -1.300388725205641e-02   +5.147464819972943e-02   +1.495281755540799e-01   +7.199439048963918e-02   +1.808554741268147e-02   +1.398720680689614e-01   +8.466897045979230e-03   +4.436706201784008e-02   -1.231504281869098e-01   -9.858277324968011e-02   -9.222089944372112e-02   -1.662850305275985e-03; -1.585892604091312e-01   +6.833497575056449e-02   -2.108217143112619e-02   -1.023057213886221e-01   +1.901090198113370e-02   +2.026213097390446e-01   +7.761838875358117e-02   +1.044597845562744e-01   -3.238301483583325e-03   -2.184946399877787e-01   -9.735976015503925e-02   +1.873979242968257e-02];
L1_L3_iAMPA_netcon = [-9.803604073830309e-02   +1.891810351203370e-02   +7.812695097946153e-02   -2.257112720990713e-02   -1.712119955110681e-02   -3.611208100258497e-03   +8.528290114220259e-03   -2.862132098984056e-02   +1.467085967436836e-01; +8.049380828245681e-02   +1.365128112551749e-01   +1.100749434011105e-01   +5.516274287704147e-02   -1.964611397277873e-01   -5.823079880679004e-02   -4.222058793048737e-02   -2.788953245609328e-02   +1.406603072656138e-01; +7.611807219172255e-03   -3.077371610318446e-02   -7.750754612994556e-02   -3.138419585427166e-02   -8.300058642206889e-02   +8.976354112483122e-03   +7.570892368184444e-02   -3.422294733307393e-02   -1.154496057948717e-01; -6.395017757499896e-02   +8.437876447722281e-02   +2.026280179214758e-01   -1.013424373186876e-01   -2.061298929389736e-02   -8.304466377868192e-02   -1.575376245062771e-01   -8.439066344044707e-02   +1.625120068772792e-01; +1.100620952492366e-02   -2.973922762169816e-02   +1.518963049041708e-02   +3.420878669099491e-02   -8.535833224222474e-03   -5.178903151501186e-02   -6.423212748580362e-02   +7.265163535504361e-02   -3.647622808906500e-02; -2.544786091859139e-03   -1.066295707722889e-01   -1.555337402948275e-01   +1.360011710596016e-01   +1.234920681805028e-01   +5.344765718056151e-02   -4.701986454911426e-02   -3.754083405915212e-02   +1.493911735577427e-01];
L3_L1_iGABA_netcon = [+5.183425745281336e-02   -3.401736412882805e-02   -3.106938817874136e-02   -1.498292500428169e-01   -1.731896934601965e-01   +1.119906429142733e-01; -1.127543816652034e-01   -1.023709284712079e-01   +1.313023951534769e-01   -8.801338877080306e-02   -3.524755901297552e-02   +6.337247526436107e-02; +1.346434945576628e-01   +8.213745706762732e-02   +5.833552406253222e-02   +6.544814608346974e-02   -4.923547366807085e-03   +1.982586223519808e-03; +1.515225730770386e-01   +1.144241026207198e-01   -5.457818991658871e-02   -1.582308282097654e-02   -1.101717034790837e-01   -5.679887120079875e-02; -3.010106669439890e-02   +4.195689306408529e-04   -1.663184598696489e-01   +1.468959574701965e-01   -1.061497705660617e-01   +1.825926592371836e-02; -7.492355964245698e-02   -1.577727730416665e-01   +1.677496474264918e-02   +8.612093623176528e-02   -9.049337362133779e-02   +1.575269446648798e-01; +1.777190855000168e-01   +1.185799658010901e-02   +4.408186556947163e-02   -1.113678307450806e-01   +1.807291026991277e-01   +1.049388351272446e-02; +1.511898627505860e-01   -1.618839566531730e-01   -4.431096847518809e-02   +5.387198944975488e-02   -1.060734888938378e-01   +2.039886177613909e-01; +2.700141258976417e-02   +2.015785570774776e-01   +1.016350439592630e-01   -4.279620428474559e-02   +5.934173542386526e-02   +1.001321656385092e-01];
L5_Input1_iAMPA_netcon = [-1.044255887739837e-01   +1.609621190787169e-01   +8.194341817086012e-02   +1.762361264945551e-02   -9.682514216988701e-02   +1.206873456476502e-01];
L6_Input2_iAMPA_netcon = [+2.932947406527519e-02   -1.003632258334745e-02   -1.170094089462249e-01   -1.068687250546829e-02   +1.546082933192547e-01   +1.343383405465620e-02];
L5_L6_iAMPA_netcon = [-9.636256644264862e-02   +1.218338287143022e-01   +4.465350984884351e-02   -6.877449487530520e-03   -5.537934954523573e-03   +1.110746562235353e-01; +1.083502988257216e-01   -5.652798587886781e-02   +3.060963736682557e-02   -6.672319220978629e-02   +1.358105810703606e-01   +2.965944759311224e-02; -7.799722072023639e-02   +1.214629502674495e-01   -1.392023598553388e-01   +5.974866258419902e-02   -1.499752110346161e-01   +5.212399860198835e-04; -2.634663428109283e-02   -3.473350566620106e-02   -8.596938453656013e-02   -8.980862079809335e-02   +1.887516777764788e-01   -3.787975820304011e-02; -8.347154239436344e-02   -1.331093955183053e-01   +1.212911936731440e-01   -1.268417344939469e-01   -1.323087529085458e-01   +7.808561711988338e-02; -5.228668013821322e-02   +2.568598093668301e-02   -1.023950973351901e-02   +7.126004225407906e-02   -1.635598775315147e-01   -1.087727611601551e-01];
L4_L5_iGABA_netcon = [+4.988991569848874e-02   -1.239390527113188e-01   -1.331938921333646e-01   +6.179137495772119e-02   +1.247682824112714e-01   +2.630166224142373e-03   -2.634033816761323e-02   +1.914306520336015e-02   -1.554699469250695e-01   -9.574311203336752e-03   -3.933781853402098e-02   -5.973993619213348e-03; -1.583327448019755e-01   -1.731566803009137e-01   +8.093192862840817e-02   -9.425187702257677e-02   +8.425706252717914e-03   -2.061265855531468e-01   -3.948291478313868e-02   -2.224580274130077e-01   -5.614896261715131e-02   +9.491448998254090e-03   -1.759848337831761e-02   -1.252183860057023e-01; +9.067950131927099e-02   +3.380386023817360e-02   +3.488347477563831e-02   +1.719438768222034e-01   +1.569445155443121e-02   -1.287629216387331e-01   +1.546085863795724e-02   +3.478825180936149e-02   -1.066769846443473e-01   +9.540927077837247e-02   +3.814141642734926e-02   -8.043910102736578e-02; +1.106219484681836e-01   -8.844464392526538e-02   +1.403559390861653e-01   +1.857458395051009e-02   +1.708933562240917e-01   -4.515692908750801e-02   -1.126572623518014e-02   -1.525839578317052e-01   -1.641088942606230e-02   -1.747060610322974e-01   +9.600868378259408e-02   +4.715497489205221e-02; +1.757282540864512e-01   +7.592665848701328e-02   +9.829237318792101e-03   +2.719159133181699e-02   +8.322080737925383e-02   +1.686680090000873e-01   -8.699404507141315e-02   -6.249283325303839e-02   -2.545417534919768e-02   +4.860315684050783e-02   +5.240689097241082e-02   -2.709406350773333e-02; -5.953337334865387e-02   -5.633044936097611e-02   +9.019831975404072e-02   -5.208854143408355e-02   -3.126699388565004e-02   +6.010858674517242e-02   +1.029053925301276e-01   -1.290738936321174e-01   +1.968515035323304e-01   +4.918430213565936e-02   +1.412430821710781e-01   +9.763008927062609e-02];
L6_L4_iAMPA_netcon = [+3.287878149216595e-02   +9.242217783424117e-02   +6.424177508965428e-02   -8.516007839961928e-02   -1.155130497543193e-01   -6.474270392029254e-02; -6.395535499912949e-02   +5.303568646427814e-02   +5.048776596178242e-02   +1.547571987811081e-01   +2.003018925766555e-02   +2.045639577341539e-01; +5.916043664453759e-02   -4.700836329681535e-02   -7.746320035762788e-02   -2.261787218889363e-02   +5.802819237784899e-02   +1.060065407158913e-01; +1.074854125520698e-02   +1.514159606254925e-01   -5.828095804482843e-02   +8.884040135568555e-02   -4.304476994783121e-02   +8.176963202718353e-02; +3.565540497919219e-03   +2.164287584908421e-03   -1.633682152271527e-01   +1.731632088795937e-01   +7.915361145252792e-02   +6.319689236709931e-02; +1.689336641350466e-01   -1.116694145236459e-01   -3.837026568104772e-02   +5.576860090755933e-02   -1.457256650178158e-01   -1.208628963895787e-01; -7.304014770038264e-02   +2.627944233288239e-02   +2.496303205057175e-02   -1.363215613333623e-01   -1.693269531831369e-01   +4.174880254525291e-02; +3.037119778237217e-02   +1.213180691769794e-01   -1.793475848153725e-01   +2.917764478075464e-02   +8.693180990702844e-02   +1.087090858128220e-01; -8.340735165568151e-02   +1.862817634093832e-01   +7.430040499337201e-02   +5.523737781136688e-02   -1.086599532167540e-01   -5.411238425092688e-02; +1.089100703924369e-02   +1.561530617870878e-01   -9.366855070231342e-02   -6.226503481820809e-02   +3.265897361330738e-02   +4.779794240930854e-02; -1.251327935680459e-01   +4.601155454563600e-02   +1.080243481070524e-01   +5.430855928482373e-02   +2.019186382397438e-01   +1.020941547455282e-01; -1.611794072076949e-01   +6.598744218476608e-02   -5.637193480730740e-02   +5.848798332377423e-03   +4.494618880876326e-02   +1.303374050129906e-01];
L5_L4_iAMPA_netcon = [-1.826557966420649e-01   +4.692399332490998e-02   +1.082508114174804e-01   +1.563267316533869e-01   +1.290481809711106e-01   +3.307654540807327e-02; +3.791150388290751e-02   -1.090396005322451e-01   +1.008403584612210e-01   -5.835345407089153e-02   +1.987293731576956e-02   +5.630290034083537e-02; -1.299426931353354e-01   -1.048247373125727e-03   -4.944753548514833e-02   -1.337521929677376e-01   +3.686013846267064e-02   +3.868093110281989e-02; -2.192212821130930e-01   +5.583040132735145e-02   +4.149126197964317e-02   -5.783593670735022e-02   -1.767255904189537e-02   +1.443176529369379e-01; -6.587029439568749e-02   +1.843422237650521e-02   -1.647703011552331e-01   -3.228768999786057e-02   -3.951405111755030e-02   +3.592128511877795e-02; -3.411876398778309e-02   -1.055901085283622e-01   +5.381249850080224e-02   -1.927423933788625e-01   -8.604261840233038e-02   -9.718783384095328e-02; +1.270295902580913e-02   -2.697354052442558e-02   +4.203514949621019e-02   +1.670877518112871e-01   -1.266221630550158e-02   +3.013428611521790e-02; +1.769018673854377e-01   -7.238430666390194e-02   -1.769071898822281e-01   -1.991559910251522e-02   -4.795627999903998e-02   +1.283723432790554e-01; +1.513439662320037e-02   -6.545332559263918e-02   -3.844481712936115e-02   -8.805550805131954e-02   -5.732495600531935e-02   +7.216455718932150e-03; -1.560464026494793e-01   -1.034623103569837e-01   -3.243593194441275e-02   +7.388258511957929e-03   +1.086939501453158e-01   +4.820945710257722e-02; -7.941983086909823e-02   +9.454861210130631e-02   -2.336271400192430e-02   +1.459997608886189e-01   +4.713222964333547e-02   +3.287478499746548e-02; +1.896431968878783e-01   +3.381294090163085e-02   -3.143853418775835e-02   +1.133021970674986e-01   +1.599098348055304e-01   +1.049016139540198e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
