function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.706903891254206e-01   +5.772535179246999e-01   -1.439904951754072e-01   +2.040922469478507e-01   +1.721957954079917e-01   -1.182155635543320e-01   +1.853227525658792e-01   +2.089260397795151e-01   +2.640182707562856e-01; +1.607606582914619e-01   +5.011111587299748e-01   +4.166425689998159e-01   +7.649234611641723e-01   -6.415158819045488e-02   +3.325581739990643e-01   +5.209560055629580e-01   +5.065128406614252e-01   -9.429264361075839e-03; +3.732173043851247e-01   +1.000000000000000e+00   +5.233934626164860e-01   +2.119486694582808e-02   +5.174238841144858e-01   +3.874244797835484e-01   +4.806237164632691e-01   -1.187353304340431e-01   +6.427153039073047e-02; +3.243086670434995e-01   -2.242768855644605e-01   +3.909576345966377e-01   +3.045627595100656e-01   -5.381196639233208e-02   -3.025499146096730e-02   +4.445397071842871e-01   +5.885100263425369e-01   +3.217846651992474e-01; +4.712178121842526e-01   +8.435544758929334e-01   +3.040798670789226e-01   +4.974911146689238e-01   +9.160444179233074e-02   +4.766563970589030e-01   -1.370151830817276e-01   +4.314120689653685e-01   +3.287079526720267e-01; +1.058663885068780e-01   -1.131056534794458e-02   +3.808299082305060e-01   +7.366461546831918e-01   +3.008690846351073e-01   +1.197174852574512e-01   +1.099221275170160e-01   +5.547053001436087e-01   +8.179524970347302e-01; +6.348773557206536e-01   +4.001087807160403e-01   +5.667114024058364e-01   +2.667121779585678e-01   +2.111076579471401e-01   +4.369000201008292e-01   +1.229869116295517e-01   +6.420779061364495e-01   +5.162497025326079e-01; -2.622233805061036e-01   +7.058176866239860e-01   +5.030075833196024e-01   +4.219213896359369e-01   +2.120223135272554e-01   -4.456221913579038e-01   +4.408217373347779e-01   -1.070245413107815e-01   +3.614466182466793e-01; +4.090273091247440e-01   +3.959260628193967e-01   +6.286405433043231e-01   +2.689909980074225e-01   +6.169779505825228e-02   +1.498207107649860e-01   +1.839339706879007e-01   +4.974955069186058e-01   -1.920651580428612e-01];
L1_L2_iAMPA_netcon = [+7.966163145368781e-01   -1.468431739050952e-01   +2.911350988738236e-01   +6.445657358006529e-01   -3.636010384385714e-01   +5.099578574159289e-02   +1.204744589516969e-01   +1.209281181794941e-01   +7.760126103524847e-01; +3.417889907236286e-01   +2.877331384416058e-01   +2.981208400823959e-01   +1.000000000000000e+00   +3.747461034022911e-01   -7.537483049692620e-02   +6.987607380155666e-01   +6.354798093999143e-01   +2.146080687031836e-01; +2.515504523048258e-01   +1.052275287880974e-01   +4.717555290654362e-01   +7.633172631403941e-02   +4.301941112387635e-01   -4.649661658251734e-02   +7.739699922281346e-02   +4.002108348314118e-01   +3.619893091891938e-01; -7.933623569195869e-02   +4.440300014420400e-01   +1.424946996764503e-01   +3.242427721048441e-01   -1.297831594754034e-01   +3.894028031287867e-01   +6.372447506172931e-01   +1.485600914935970e-01   +8.062154998828588e-01; +4.018224716362732e-01   +5.981602137208725e-01   -1.758431059149443e-01   +1.554416757737431e-01   +5.865037005608734e-01   +7.204450216411216e-02   +3.047134870099733e-01   +8.550523963431061e-02   +3.962763137089598e-01; +1.104000574226259e-02   +9.052523501091235e-02   -7.665622970904148e-04   +6.136603586166621e-01   +1.092317523045687e-01   +2.182105038505377e-01   +8.166514597730736e-01   +2.122641263434552e-01   +7.047422574291825e-01; +5.072632836072772e-01   +5.928615660364482e-01   +2.439214593687763e-01   +1.732697035715828e-02   +3.230923627975885e-01   +5.438916428164005e-01   +5.883478829267385e-01   +5.396126865752377e-02   -2.590871296497901e-01; +2.679679826287648e-01   +6.390085100521973e-01   -1.924731169404095e-01   +4.424592719538590e-01   +3.048558481618932e-01   +6.829462001312439e-01   +8.433118748583757e-01   +1.648471772432423e-01   +3.600428039011520e-01; -4.300321792675347e-02   -9.356796788324817e-02   +6.055985285928744e-01   +2.594169264148507e-01   +9.370079006721059e-02   +3.222230526333158e-01   +9.622884799830094e-01   +6.402168915134566e-01   +3.574111949189220e-01];
L2_L5_iAMPA_netcon = [+9.569450862007475e-01   +3.730367508267617e-01   +5.174962342379423e-01   +1.194068484028207e-01   +7.154820888102861e-01   +4.366107946817956e-01   -3.910331453482657e-02   -4.340015152504711e-01   +4.440197501834701e-01; +8.121152955909227e-01   +3.832586321006629e-01   +3.850296975322754e-01   +4.299587141898635e-01   +2.656126356286901e-01   +3.558197063774245e-01   -6.582694235499548e-02   +2.816537095476102e-01   +6.106496560436392e-01; +6.365593043097989e-02   -2.061428887607822e-01   +4.076968037945033e-01   +5.198821863178477e-01   +2.553383092444395e-01   +5.342281152852694e-01   +7.826565807054964e-01   -2.818976036008660e-01   +5.537716273155617e-01; +3.113443025636840e-01   +1.256413190318606e-01   +4.030377233217411e-01   +8.073613989980439e-01   +4.965081231237152e-01   +7.334759404323958e-01   +1.739973166256921e-01   +3.154145271275578e-01   -5.553291231326481e-02; +1.321185017808166e-01   -7.867782997226019e-02   +1.399653376036767e-01   +2.446569984344709e-01   +5.372535774370166e-02   -4.729880291864520e-01   +3.381990819135458e-01   +7.956634535046214e-01   +7.328386332909973e-01; +7.332708307677100e-01   +5.521080189623672e-01   +4.545434341890471e-01   +5.192011019725757e-01   +4.182621282950334e-01   +4.208191491847757e-01   +4.830986794483791e-01   -1.045632616627046e-03   +8.362156236329816e-01];
L5_L2_iGABA_netcon = [+3.276204103683962e-01   -9.322621775516113e-02   +5.073737753936631e-01   +9.115165556815613e-02   -1.301026092235277e-01   +6.483551687516868e-01; -1.064858422826302e-01   +6.087057516853159e-01   +4.194397950995295e-01   +8.392505078677781e-01   +6.578056862126858e-01   +4.454921339031848e-02; +8.818988546928845e-01   +8.312938843555113e-01   +3.531303411218052e-01   +2.928354537629326e-01   +1.894084444714136e-01   -2.489139646716275e-01; -1.819329227681787e-01   -1.007186525715235e-01   +3.042446222340204e-01   +2.386229461504099e-01   +6.373744551661182e-01   +5.466017427001618e-02; +2.871669658807875e-01   +1.778297562439423e-01   -3.906647224953552e-02   +5.329443276293004e-01   -8.611854721739406e-02   +3.343029389180175e-01; +3.111685408271300e-01   +3.097721405810833e-01   +4.527055909981272e-01   -1.513416405750656e-02   +1.192042528290518e-01   +4.100978926713401e-01; +9.001800029188096e-01   -2.169521917238315e-01   +4.034854016539675e-01   +6.895358520964410e-01   -4.224812811318277e-01   +2.796237574952498e-01; +5.817773677703103e-01   +1.004139250112246e-01   +7.551975109801440e-01   +6.658739290858922e-01   +1.205848766230476e-01   +5.227361729023617e-01; +6.227221322756442e-01   +4.314582754215580e-01   -3.269189696885507e-01   -2.630582286890337e-01   +1.535234976479508e-01   +2.327747043916203e-01];
L3_L2_iAMPA_netcon = [+6.586855020690485e-01   +3.519444366072895e-01   +1.522582192245612e-01   -2.242832255944113e-02   +4.388250818666531e-01   -1.046234837428503e-01; -1.844966070750634e-01   +6.352115971839113e-01   +2.094859338141005e-01   +1.782117649459978e-01   -2.967109648836874e-02   -1.996788325814206e-02; +2.734083489892096e-01   +7.486991815339840e-02   +7.639346288579647e-01   +6.768567280235156e-01   +2.897300794026328e-01   +8.820133202364846e-01; -1.042493162500269e-03   +3.744603570752471e-01   -2.538034412963441e-01   +3.922820582281853e-01   +8.953694512508459e-01   -1.774380420272918e-01; +7.982688689748547e-01   +1.367923474644474e-01   +3.501862048746519e-01   +1.013026170798955e-01   +1.390259102537635e-01   +4.506660134348360e-01; +7.700840756210811e-02   +2.556263299436922e-01   +4.469810965702551e-01   +3.052225002086413e-01   +7.731422841149207e-01   +3.246335366283251e-01; +6.620641659279819e-01   +4.465916630936257e-01   +3.610375350201889e-01   +1.294343793591840e-01   +1.246388381804167e-01   -3.690788092112687e-01; +2.007804985454351e-01   +1.276853113249972e-01   +6.805112436954348e-01   -2.741870725886564e-01   -1.828743243536979e-02   +6.533192205781346e-01; +5.831734940915067e-01   -1.000572782712216e-01   +4.298281479530214e-01   -1.695171064073258e-01   +1.469554985027250e-01   +9.477011002764117e-01];
L2_L3_iGABA_netcon = [+5.623178849233061e-01   +7.426220084805001e-02   +1.326367995363157e-02   +3.720529440546740e-01   +2.892152495166522e-01   +3.534893336175067e-01   +3.720426120744589e-01   +1.875287494500788e-01   +3.519583963378854e-02; +2.078961599563793e-01   +3.345611761261761e-01   +6.682324442629577e-01   +2.958893564676434e-01   +2.714166230144511e-01   +1.459844585837725e-01   +1.971602365510232e-01   +3.406677079684924e-01   -8.627778340115808e-02; +2.243642408245937e-01   +2.878954906965182e-01   +3.566202924108893e-02   +4.953786636418901e-01   -2.868707746264023e-01   +4.472041739243017e-01   +2.132696681827111e-01   +3.683019259126326e-01   +3.195959761165723e-01; +2.730477934961557e-01   +1.000000000000000e+00   +3.573125557167405e-01   -1.366058446728653e-01   +1.629973793067306e-01   +1.363538003044014e-01   +5.806053314844005e-01   -1.713181738736242e-01   +3.230870378962906e-01; -1.473626231508070e-02   +5.583560365064906e-01   +1.067679946133132e-01   +1.135317873926625e-02   +3.452165600194767e-01   +3.075711675512186e-02   +1.050235693856835e-01   +2.023751405819056e-01   +7.056047867514643e-01; +1.452498331188692e-01   -1.203128788201465e-01   +5.630094717035083e-01   +2.412673682040541e-02   +1.418074742762536e-01   +5.589223558792530e-01   +1.883176238048940e-02   +1.420190430984103e-01   +4.760175755951068e-01];
L1_L4_iGABA_netcon = [+3.591332605510401e-01   +7.402489975439914e-01   +4.436453007939961e-01   +2.578770464027379e-01   +1.890316526667027e-01   +2.678749121100307e-01   +4.417192425874137e-01   +5.527898899461992e-01   -1.638794580515711e-01; +4.081070867699864e-01   +4.849305751259754e-01   +4.256445386827009e-01   +6.424977590775646e-01   +1.216691462243106e-01   -1.120607323908693e-01   +8.555400237718712e-01   -8.885069809931556e-02   -2.139183635534195e-01; -3.135546918470981e-01   -1.088035978940769e-01   +8.850173849973941e-03   +1.799927530891920e-01   -1.676155683892915e-01   +5.255831428025527e-01   +4.365799917103275e-01   +7.652235817900790e-02   +2.233830523524352e-01; +5.895952681746753e-01   +4.219815863704812e-01   +2.377588508045341e-01   +1.745959776369918e-01   +4.250674421897666e-01   -1.711823852871812e-01   +8.938981382945967e-01   +8.950335240403789e-01   -4.795594011187224e-02; +3.882307252601358e-01   +2.663879800819628e-01   +6.746381463016914e-01   +6.735641858196212e-01   +7.201066954603881e-01   +1.884939108397820e-01   +5.551920801246597e-01   +3.652299212466120e-01   +1.089861765853389e-01; +3.944209182929762e-01   +3.557132648703810e-01   +6.972129904070906e-01   +4.467450281298091e-02   +2.089868213816594e-01   +4.282695023844617e-01   +2.703102124831734e-01   +3.327543213922716e-01   -2.118025301898843e-01; +7.606653217000197e-01   +2.093487499210965e-01   +4.726251773448319e-01   +3.617130154010035e-01   +9.734111134303036e-02   +7.688742631838652e-01   -2.646080398490609e-01   -2.007780246080962e-02   +5.861916836710623e-02; +3.205852944899399e-01   +2.314661714421946e-01   +5.896601762558222e-02   +1.498346947561550e-01   +3.234734657168793e-01   +3.156609543565062e-01   +7.235621327165684e-02   +6.684196572866131e-01   -4.530466892171292e-01; +2.226001913751864e-01   +2.137209077109315e-01   +2.236617259392125e-01   +9.591161639143382e-01   +5.669642776752852e-01   +7.238568919757937e-01   +3.274268880890139e-01   +9.429376141973985e-01   +6.100954371388306e-01; -6.033400500539482e-02   +5.986965434148604e-01   +7.568920129637222e-01   +2.592099692088414e-01   -5.170211556671137e-01   +2.820859642205462e-01   +4.798380062783764e-01   +4.036546764712986e-01   -3.914126942120764e-02; +4.691869671645177e-01   +3.332405245898520e-01   +3.651814892269933e-01   +2.182220036775500e-01   +7.243790442078518e-01   +8.894702999662312e-01   +3.553411848476623e-01   +1.284828134466671e-01   +2.356146502851938e-01; +7.750948213214284e-01   +8.187183252555262e-01   -2.257502101871025e-01   +1.469314917064938e-01   +2.540636661308875e-01   +6.760248373605533e-01   -3.401708145693078e-01   +4.206084179194340e-01   +6.617963876142534e-01];
L4_L1_iGABA_netcon = [-3.238247242919122e-02   +5.727112539414533e-01   +4.723890533600736e-01   -1.682485766138334e-01   -2.837746686768844e-02   -6.696660842580932e-02   +4.554748664893169e-01   +3.456241855374195e-01   +3.898954164164886e-02   -6.902754342641965e-02   +1.908586102713063e-01   +5.776217876598750e-01; +2.656682386335660e-01   -1.108381510434349e-01   -1.268803277905124e-01   +1.062909680703633e-01   +6.789006610973984e-01   +4.838320535624367e-01   +4.835175263899065e-01   +6.337802802794572e-01   +3.439115712825724e-02   -3.513978341864767e-01   +8.640288306328441e-01   +2.090132529654258e-01; +3.678134080091633e-01   +4.575130175553408e-01   +6.870918606340215e-02   -2.947807009892449e-01   +2.724449487662873e-01   +7.148873488345375e-01   +7.494961845473762e-01   +8.339089705193534e-01   -1.940223512333678e-01   +3.281010390594946e-02   +9.303578541963204e-01   +6.526617796209393e-01; +4.546706376322428e-01   +2.767768973921951e-01   +2.563646973637817e-01   +4.758965816014454e-01   +6.432840655250808e-01   +3.784969499961156e-01   +5.076518327107225e-01   +4.010273538808306e-01   -1.612873418981015e-02   +5.468778871918324e-01   +8.075380069881350e-01   -1.583627653633325e-02; +5.644225467689599e-01   -1.871219958566738e-01   +3.145515025457030e-02   +6.736403761833760e-01   -1.641619414306628e-01   +1.872659670765253e-01   +8.305054682403391e-01   +3.715034938022893e-01   +5.830937593984662e-01   +2.716272244240397e-01   +1.291926946298717e-01   +7.627107651526146e-01; +6.811359040527476e-01   +4.728218559504579e-01   +1.892268267465378e-01   +4.764097822196110e-01   +6.630569466629880e-01   -1.723382325553979e-01   +9.779822686429557e-01   +5.674024999945346e-01   -1.512619290238382e-01   +4.994802378894861e-01   +4.621906083144545e-01   +4.626991479772071e-01; +6.066754466692486e-01   +5.440838255063168e-01   +6.793901454519573e-01   +4.731338704056867e-01   +1.915430224218259e-01   -6.468211696768666e-02   +6.599353988925257e-01   +3.327968501428099e-01   -3.415579786544496e-01   +2.600508110118512e-01   +1.562742227859801e-01   -3.021019360142206e-01; +5.380752234397765e-01   +2.515364492900731e-01   +3.302583567428255e-01   -1.493624611566706e-01   -2.813133455024469e-02   -3.124798916043758e-02   -8.334596650613299e-02   +1.174985425608952e-01   +3.584767382801087e-01   -5.099417975177076e-02   +5.822396132450017e-01   -3.834318398552894e-02; +2.087874955624601e-01   +4.672684292157052e-01   +3.346164581953234e-01   +4.897352577958484e-01   +6.599479583678224e-01   +1.065421298217201e-01   +6.794250119303525e-01   +6.137461995552804e-01   -1.998551766921998e-01   -2.982022425901037e-01   +1.321452610032659e-01   -2.032562282979795e-01];
L1_L3_iAMPA_netcon = [-1.379057644959936e-01   +2.596481763747946e-02   +3.183640673995008e-01   -1.550542787966548e-01   +9.464003808981685e-01   +4.014988725851014e-01   -5.787094272171164e-01   -1.253588034233905e-02   +4.708130266834439e-01; +3.489768511568621e-01   +5.303288103995076e-01   +6.636003230181438e-01   +3.245098455788782e-01   +9.183159297874353e-01   +3.775352577725607e-02   +5.176192426456062e-01   +5.042029206803473e-01   +2.580862850444712e-01; +5.374827642087694e-01   +2.270585829474232e-01   -1.344555263108437e-01   +8.238528262222009e-01   +8.674031302792968e-01   +3.834718834637671e-01   +5.889860604983758e-01   +6.647258349164503e-02   +4.530623365948478e-01; +5.929299912127652e-01   -1.446446901606487e-01   -6.055457561940253e-02   +4.345307743161584e-01   +4.484664847833639e-01   +4.435456385386355e-01   +8.175889776003769e-01   +7.192583963491623e-01   +3.237180923027098e-01; +2.940003273366166e-01   +2.232900172285776e-01   +5.104797578072591e-01   +4.250532846714850e-01   +3.844431222240406e-01   +7.028552484007948e-01   +9.203577525444906e-01   +5.256690502862652e-01   -5.957595367429186e-02; +2.407269166043315e-01   +3.587826973862459e-01   +6.238104036376735e-01   +4.397238465420024e-01   -2.284956377202782e-01   +3.929511495657483e-01   +1.066604764099759e-01   +9.807828749334366e-01   +7.742861275041990e-01];
L3_L1_iGABA_netcon = [-2.104283851904532e-01   +4.365941479662671e-01   -4.590454852327943e-01   -1.127561429995522e-01   +4.587393610936739e-02   +1.520932870920838e-01; +5.073069104450760e-02   -1.676226159059251e-01   +4.015849280646553e-01   +6.407363576632411e-02   +3.528940294187982e-01   +8.351734320992280e-01; +3.081376667422946e-02   +8.016074036176218e-02   +3.675508586748580e-01   +3.372933635308527e-01   -1.892493316334944e-01   +1.776668312043059e-01; +2.279098495429983e-01   -5.181667431691652e-01   +6.181063180071775e-01   -8.056279120616905e-02   +4.343498582122234e-01   +8.533718802144263e-01; +7.505610236639517e-01   +6.604533586020154e-01   +2.565374092830557e-01   +7.061499093732074e-01   +6.407901138339523e-01   -3.900736638585619e-01; +4.007020370131227e-01   +8.458949775417642e-01   +1.662883590593935e-01   -1.131344561972744e-01   -3.609222651645068e-02   +2.072288953837809e-01; -3.707733276880565e-03   +5.781923743366746e-01   +6.724263204551910e-01   +1.194840738507620e-01   +7.900973836418326e-01   +8.341746103360479e-01; +1.538495528427652e-01   +1.062558812637492e-01   +1.666841746911932e-01   +1.161962423676686e-01   +5.043438404386633e-01   +5.299912666978789e-01; +7.247271261114383e-01   +8.309273115001936e-01   +2.319383015784128e-01   +1.396812348838685e-01   +6.421762475706005e-01   +4.913646344895923e-01];
L5_Input1_iAMPA_netcon = [-2.301613040163926e-02   -3.189272624235072e-02   +1.000000000000000e+00   +3.323831298224482e-01   +1.779030816137052e-02   +5.687510165217636e-01];
L6_Input2_iAMPA_netcon = [+1.417300453535942e-01   +6.514036420076985e-01   +8.099033427821903e-01   +3.391357249081377e-01   +7.078860363404524e-01   +3.769981362813509e-01];
L5_L6_iAMPA_netcon = [+3.598772390745293e-01   +9.340491868991851e-02   -1.288493781568028e-01   +1.379933447414108e-01   +5.478627390015256e-01   +6.831814377900693e-02; +5.838637435416960e-02   +5.635337215048892e-01   +8.073506150453245e-01   +1.668613242352437e-01   +5.796050536900664e-01   +1.167260237049384e-01; +1.573388168556717e-01   +5.361309308504111e-02   -2.053160616787526e-01   +1.586793388224195e-01   +6.183067455699893e-01   +5.721028295607677e-01; +4.122562650335778e-01   +5.780178714454582e-01   +3.607357416868373e-01   -1.859789159555154e-01   +2.792522381769063e-01   +2.337834507725154e-01; +3.418350309633072e-01   -4.542274437022011e-01   -1.875559691655417e-01   +3.293236819658499e-01   +6.386952649302289e-01   +4.022759636922825e-01; +7.451516877963259e-01   +4.132417240409310e-01   +7.352912388692525e-01   +3.910004747313623e-01   +4.432795071761239e-01   +3.013915261643118e-01];
L4_L5_iAMPA_netcon = [+5.266706510239594e-01   +5.315931352380181e-01   +1.306601155746102e-01   +5.383953993609084e-01   +2.259689088055606e-01   +2.121996995817851e-01   +6.347740920911062e-01   +6.042024160414611e-01   +2.360745415699653e-01   +3.647012929775172e-01   +5.989037233482586e-03   -1.066514751561800e-01; -1.128631759737877e-01   +7.172091429454882e-01   +3.212601363041490e-01   +8.690158036182151e-01   +3.645241173356249e-02   +3.335897085572733e-01   +6.167454504789813e-02   +3.792237028571033e-01   +1.764523436296926e-01   +6.355986506774177e-01   +5.375624840977967e-01   +4.972094147060761e-02; +5.746133797484236e-01   +1.517412355279667e-01   +7.229190144512872e-02   +2.477597816953524e-01   +3.782760123201790e-01   +1.000000000000000e+00   +1.969787391204099e-01   +3.857560107337699e-01   +6.186440776287876e-01   +5.147381798586559e-01   +1.212011247448423e-01   +7.790082479658136e-01; +4.554588359285610e-01   +3.152597805928430e-01   -1.853896887872502e-01   +6.380484182245451e-01   +3.008342699419699e-01   -1.297203433410461e-02   +2.351537901009039e-01   +2.634441211040983e-01   -1.931215701350852e-01   +4.716059212157419e-01   +2.015301562890834e-01   -1.810678451359569e-02; -3.175373095847326e-01   +4.870088763467722e-01   +4.504691453831046e-02   +4.721539157046663e-01   +5.483885604364498e-01   +3.299769060056298e-01   +8.562745964695848e-02   -1.714092085815412e-01   -1.223641214513299e-01   -3.654057002256297e-01   +4.447494128798213e-02   +2.389731533118603e-01; +2.818461364209097e-01   +4.630146883251648e-01   -1.690240420508468e-01   -1.377224404557959e-01   +3.542918003569376e-01   +3.323700481702380e-01   +9.555847179486070e-02   +1.049739899792435e-02   +2.796098786087142e-01   +3.971437410425686e-01   -1.924979314003655e-02   +4.930478031161299e-01];
L6_L4_iAMPA_netcon = [+6.821043891005550e-01   +4.908226872536608e-01   +4.131216491993855e-01   +4.436101986498998e-01   +9.277448679780140e-01   +5.659697226191845e-02; -4.423675123460854e-01   +4.113054112709590e-01   +2.353318087153612e-01   -6.835987259384220e-02   -8.130317521806138e-02   -2.636204998334463e-01; -6.131612472362107e-02   +8.188426816964526e-01   +1.599576011134131e-01   +4.984022817704871e-01   +2.700157966815777e-01   +4.194402851377476e-01; +3.308931403593142e-01   +2.273974020883207e-01   +1.209049285267276e-01   -2.260760127313334e-01   +4.571418219389420e-02   +3.174696835930566e-01; +2.434494262690836e-01   -1.339564885658630e-01   +1.568379311672105e-01   +5.815274627364919e-01   +1.000000000000000e+00   +3.178122712256102e-01; -1.720124505748895e-01   +4.147946727701682e-01   +6.077909789748971e-01   +9.640332915463234e-01   +1.493544533842615e-01   +7.661096851103456e-02; -4.251690131121423e-02   +6.638223572794504e-01   +3.551742234878574e-01   +7.401292016294722e-02   +3.968183100935249e-01   +7.128216518725082e-01; -1.114281414696056e-01   +6.664223589730101e-02   +2.872276638078535e-01   +3.943161604367805e-01   +5.592386813390317e-01   +1.496170485761578e-01; +2.152283375330205e-02   -2.612260164417026e-01   -1.179862497864009e-01   +4.810078685560987e-02   -8.642096217151743e-02   -6.565145194671192e-02; +6.111719079448162e-01   -1.169144317732094e-01   +4.203646064642451e-01   +5.241045245971008e-01   +2.085318530592387e-01   +5.024959143438371e-01; +6.860782309107358e-01   +4.498096276464155e-01   +7.428406303373777e-01   -1.402329528585350e-01   -1.623065316705880e-01   -9.494609938010228e-02; -1.431381883616499e-01   -5.421922338226678e-02   +6.775815742101546e-01   +3.442091305368948e-01   +1.440874030765143e-01   -2.620144445410515e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
