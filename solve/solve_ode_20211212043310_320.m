function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.794412369772402e-01   +1.429919672337416e-01   -2.820941412087680e-02   -1.975006238755107e-01   -2.445971622837678e-01   -2.844130191416924e-01   +2.676179551093572e-02   +5.648851815229046e-01   +5.483156066377318e-02; +5.821184183611801e-01   +8.598421196854639e-02   -5.719628852609251e-01   +1.388676161467159e-01   +3.203351584348111e-01   -3.606463934634806e-01   -1.753533590982342e-01   -2.493458692237139e-01   -1.912552781022988e-01; +2.768810576450559e-01   +1.836114300070590e-02   -1.489470579826463e-01   -6.981151563401938e-01   +4.935420654285351e-01   +2.938099586492614e-01   +5.989415395603826e-02   +7.946341637608012e-01   +1.600514720641928e-01; -5.805121066554582e-01   -4.555340828767516e-01   +1.882082495233032e-01   -2.090005345483845e-02   +7.349232483091214e-02   +6.286423976017869e-02   -9.418466646169077e-02   +1.994978462598322e-01   -5.541707439459991e-02; -4.768923552605253e-01   +8.856695812435242e-02   -5.009556602751519e-01   -2.197520944150339e-01   -2.081232739168768e-01   +3.299460567458996e-01   -1.279383572328358e-01   +3.264767254824424e-01   +6.604996533029686e-01; +6.168073307731603e-02   -3.133832989544351e-01   +1.432298439976003e-01   +1.677613772471923e-01   -1.962054642808492e-02   -3.606548037577546e-01   -3.836375892050647e-02   +1.710324657622654e-01   +1.498315952336283e-01; +3.594614178189474e-01   -2.517062580331833e-02   +3.054371452017444e-01   +4.665154689117235e-01   +2.125930369966664e-02   -4.277633461835612e-02   -6.768229197737418e-01   +4.867594554732771e-01   -3.142870035187085e-01; -5.420427127083233e-01   +1.116102851082283e-01   +2.948143229728284e-01   +1.708452009314404e-01   +1.262373397572411e-01   -3.438568163714249e-02   -1.351588509188225e-01   +4.099781226148806e-02   +1.620628792920249e-01; +2.931627069153608e-01   -3.273365789378716e-01   -1.893468144393333e-01   -5.390675232337597e-01   +2.552221202908850e-01   +3.192577409473851e-02   +6.489306278553602e-01   -2.612548652285816e-01   +4.990830657189897e-01];
L1_L2_iAMPA_netcon = [-4.445623623407224e-04   -5.026500559622224e-02   -1.878221537388240e-01   +7.905086433136227e-02   -3.440051848915156e-02   +3.500904145999771e-01   -1.198507608528415e-02   +3.832772782375535e-01   +2.017624814420157e-01; -5.736813044427708e-01   +2.594723139183538e-01   +2.144314173988557e-01   +6.314941907682929e-01   +5.251870873563996e-01   -2.729881711812188e-01   +6.113872303101787e-01   +2.336088386434210e-01   +1.757642427467307e-02; +3.567234986711277e-01   +2.980558564822247e-01   -1.664591856398133e-02   +1.620677404487135e-01   -2.160365115563970e-01   -6.360013870278562e-01   +6.491452315430657e-01   -5.754924153574963e-01   +3.451150101391756e-01; +2.182396848414853e-01   +3.344739273022763e-01   -2.408481602738403e-01   +2.677742375189212e-01   +1.223277056988014e-01   +3.129038207305112e-01   -1.838045470578302e-01   +6.716309230873101e-01   -1.552629619030317e-01; -1.451795033514321e-01   -7.201530424913416e-01   +2.068963593036588e-01   +1.510245555892652e-01   -4.229774066188661e-01   -6.963160299096161e-01   -3.287909005176419e-01   -7.639220247922920e-02   -3.240249639775755e-01; +2.309179472274469e-01   +2.316205159449222e-02   +1.918314516406355e-02   +4.705307912492104e-01   -5.426157397608773e-02   -3.485510754743157e-01   -2.800204692500526e-01   +3.108877784052728e-01   +5.167839704169445e-01; +1.751126476114522e-01   +1.009421510893809e-01   -4.265139239338482e-01   +5.667537227048072e-01   +2.741099036738608e-01   -7.301377111647517e-02   +5.628399038287102e-03   +8.495938396310969e-02   +4.476040583896438e-01; -2.122684398001214e-01   +4.908952223162292e-01   +1.454989138723267e-01   -7.285771357881729e-02   +1.293639231951429e-01   -1.718395313591371e-01   -3.438840020103330e-01   -1.947014303322310e-01   +2.478841509154289e-01; +2.624613604273771e-01   +2.369044679787916e-01   -3.762421855077585e-01   +3.769604575134342e-02   +1.697495708683053e-01   -5.640530730634535e-01   -1.643976426044647e-01   +6.744139435925445e-01   +6.441232485212474e-01];
L2_L5_iAMPA_netcon = [-2.290156334301175e-01   -1.174027472733591e-01   +3.218661266542903e-03   -2.042323948529453e-01   -2.238729093632826e-01   +4.647076909427519e-02   -4.549752704189317e-01   -3.721044307951592e-01   +2.018038276394463e-01; -8.887679273218263e-01   +1.252441172535657e-01   +4.315435074941139e-01   +5.377507421228693e-02   -1.857453424230470e-01   +2.641516758972307e-01   +1.120541540721753e-02   +3.000567499645983e-01   +3.836615709102223e-01; +3.197478519350966e-01   +4.513530602892918e-01   +1.309348227666989e-01   -2.861674424609311e-01   -6.078753927283065e-01   +3.203424522594369e-01   -7.441717377051724e-02   -5.806530598415222e-01   +2.327864778139250e-01; +1.977419146573524e-01   +1.103666454017233e-01   -2.100584548588166e-01   -2.676477337950101e-01   +2.974379263032340e-01   +1.873792872555852e-01   +1.516720965992406e-01   +6.222332256601740e-01   +1.912702169187331e-01; -1.235935533196503e-02   +9.017146322653451e-01   -4.812000966351551e-03   -1.426023163174424e-01   +2.210609139510713e-01   +4.180693013769942e-01   +3.463701936548667e-01   -4.858036687598629e-01   -5.852594026295741e-01; -3.647046246324818e-02   +1.416324231064259e-01   +4.520802214734126e-01   +6.058386869429861e-01   -3.396299666140237e-01   -2.025401915116701e-01   +1.055329475867154e-01   -5.172633868515555e-01   -3.405393751935644e-01];
L5_L2_iGABA_netcon = [+1.019081991076992e-01   +2.955672329775755e-01   -1.962719125704697e-01   -1.510206325589857e-01   -2.079658986275029e-01   -4.824942593180126e-02; +2.549707532332883e-01   +4.025645505613728e-01   -2.100744482206058e-01   +1.591335422015842e-01   +3.255231022291163e-02   +1.481113339580388e-01; -7.390504242591098e-02   -8.018273019026798e-02   +6.399595026094387e-02   -5.337265200494394e-01   +5.625167298496012e-01   -4.178628387020670e-01; -6.750641327922857e-03   +5.504404185514100e-01   -1.978709616140902e-01   +3.440280025333597e-01   +3.171263404154190e-01   -3.242647335839091e-01; +4.827381851609883e-02   +1.634408445934138e-01   +1.747724964263850e-02   +4.191950129775601e-01   -3.469342901906375e-01   +2.982012787653588e-01; -2.280203792713280e-01   -4.935051303001208e-01   -3.416919730946287e-01   +3.934144503896384e-01   +2.225238340446161e-01   +1.106028930349938e-01; +3.048057279511960e-01   +2.315660451317915e-01   -3.355755648086781e-03   +6.844445704025561e-01   -1.824993628926607e-01   +3.527483109701356e-01; +3.272799632955750e-02   -2.690883235526224e-01   -1.838580210254531e-01   -4.624982327918896e-02   -5.084513873999175e-01   -4.830679134445099e-01; +6.266278350286064e-02   -5.287250834943624e-02   -2.870407426482446e-01   -2.915465832804915e-01   +1.843687870729055e-02   -2.721601501005952e-01];
L3_L2_iAMPA_netcon = [+3.205527378791313e-01   +2.691378484782701e-02   +6.447364942239361e-01   +1.766787162267545e-01   +8.357614085370585e-02   -7.796297011952823e-02; -7.810236551485464e-02   +6.517928429472091e-01   -1.559031255904605e-01   -5.532849824975148e-01   -1.020699382714331e-01   +3.124178403970507e-01; +8.687642463198356e-02   -4.613650904182663e-01   +4.305250969172734e-01   -1.877915969858310e-01   -3.169693767531133e-02   -1.632108088366391e-01; -8.231407814494493e-02   -8.043757633121632e-02   -1.545222004298439e-01   +4.628525022663967e-01   +5.024406931724912e-01   -1.020646772904645e-01; -1.225196555472199e-01   +1.467663938102541e-01   +9.722119404491822e-02   -1.861883523570276e-01   +1.091491940304802e-01   -1.016949320181353e-01; -2.666079138597546e-01   +2.984662927448065e-01   +4.245917126990143e-01   +3.723684453029691e-01   -4.442773153513587e-01   -3.951011242537066e-01; +7.424215856497778e-01   +4.784781271540989e-01   -2.043969471537800e-01   -5.009201465909483e-01   -4.395630168496790e-01   -2.304516528621430e-01; +2.176967171535291e-02   -2.120856280801842e-01   +2.858691735005616e-01   +3.801122227190877e-01   +4.948481493133710e-01   +3.416193277011594e-01; +4.352836217138769e-01   +1.286801552486705e-01   -4.980026165481853e-01   +1.791066283869590e-01   +2.823207246565969e-01   -1.644926811276346e-01];
L2_L3_iGABA_netcon = [+1.826143032556032e-01   -7.637706813441081e-02   -5.188688931460428e-02   +2.312803100493497e-01   -4.624260201435518e-01   -5.311741786234727e-01   +1.419409668597656e-01   -7.167476726016252e-01   -6.988850587999274e-02; -1.395471881797984e-01   +3.294598672469851e-01   +1.833349385752867e-01   -2.927461678976735e-01   +1.868504338401967e-01   +2.666091366016524e-01   +4.021617683861403e-01   -4.198235606075962e-01   +1.799080652439239e-01; +3.380460759975662e-01   +3.638069204335236e-01   -2.060822022880812e-01   -1.976458184650060e-01   +4.445755734537292e-01   +3.960070241080388e-03   -1.881954150219440e-01   +6.019755967980971e-01   +4.468112076129254e-01; +4.023242625698267e-01   +4.554298151533278e-01   -3.699971038552125e-01   +1.850119262364945e-01   -4.520916891183245e-01   -1.248898022028562e-01   -1.636173852437421e-01   +5.371380780503809e-01   -3.259034456758450e-02; +3.035715957260827e-01   -1.149607979043811e-01   +3.578950380910231e-01   +4.925725666372685e-01   -5.333285101480669e-01   +3.649786536810858e-01   +1.231589809224415e-02   +1.496864447639452e-01   -2.172417697426116e-01; +3.470611142894797e-01   -3.928813937989437e-02   +2.232753414152421e-01   -1.405281165501330e-01   -1.390189571815346e-01   -4.921299542762255e-01   -1.633067282233923e-01   -5.526106409331485e-01   -1.290056305651817e-01];
L1_L4_iGABA_netcon = [-7.743377544978409e-01   +1.630698042476586e-01   -2.825530859548468e-02   -4.801704651243796e-02   +2.224803723173352e-01   +9.300620616815816e-01   -2.441183410910097e-03   +1.029587555623506e-01   -3.530482395932932e-02; -3.134116519215654e-01   -3.083132454500769e-01   -2.685816449650447e-01   -8.820921039980745e-02   -4.752525177840937e-01   +1.441007428540773e-02   +1.819874191405655e-01   +4.270698505300438e-02   +4.272724458000299e-01; +3.191480364002173e-01   -1.835842840251846e-01   +6.629989830316654e-01   +1.007969112957013e-01   +2.519988075379206e-01   -6.827612930520370e-01   -3.014312168582862e-01   +5.890358023008233e-01   +1.133036636947863e-01; +6.832233260975709e-02   +2.584354553983080e-01   -3.051497621096281e-01   -3.381648477239695e-01   +1.735993897296672e-01   +3.131517637941215e-01   +9.463299874162792e-03   -2.344952139581174e-01   +1.586543888598888e-01; -2.735174084115357e-02   -2.846682621579729e-01   +4.375713585392984e-01   -2.715183542650052e-01   -8.572211890310361e-02   +1.369343415228000e-01   -3.407789016322049e-02   +9.688219095609049e-02   -8.924331583320686e-01; +6.645631350027739e-02   +1.930982414338341e-01   -1.766087242898630e-01   +3.231769843226801e-01   +8.060738707363813e-01   -3.261340172754664e-01   -7.384778583924200e-01   -8.899086079304447e-02   +1.253602992029247e-01; -2.604650734246547e-01   -1.677948679710980e-01   +9.999621968883086e-02   -2.457362850454498e-01   +3.173152318235032e-01   -1.228188370843257e-01   +5.941234358884665e-01   +2.822860596930616e-01   -2.834537595478703e-01; -4.513441625961084e-02   +3.319417751738097e-01   +7.450074143949250e-01   +3.949630043373192e-02   -1.460941161710058e-01   +3.518608743731562e-01   +2.639704850310683e-01   +2.732557663383977e-01   +2.517097080202904e-01; -4.289443721196179e-01   -1.986946148198207e-01   +3.390389855941502e-01   +1.231290815806191e-01   +4.891249401724029e-02   -4.221999568002707e-01   -2.832222875695386e-01   -1.195338675705093e-03   +2.806092980839403e-01; -4.841270992369331e-01   -4.394044324452889e-01   -5.017467937160111e-02   +3.868087575294205e-02   +3.249545371550934e-01   -2.400527696106423e-01   +7.705502287021133e-01   -2.053533429014580e-01   +3.105759333106897e-02; +1.300934851289604e-01   -4.410143858223671e-01   +4.741983411743925e-01   +2.365207591743668e-01   -8.905882526860889e-02   -1.539899606448014e-01   +1.581786488291608e-01   +3.151433082667673e-01   +1.630178031821029e-01; +2.717854535226288e-01   +4.795938324979979e-02   -4.410036704721144e-01   +2.143270190699977e-01   -2.162241699922433e-01   -4.458356048836721e-01   +4.316822129061973e-01   +1.868089862329609e-01   -3.001441357926936e-01];
L4_L1_iAMPA_netcon = [+4.807422666291647e-01   +2.227647344122916e-01   +1.915481216518628e-01   +2.000198996464515e-01   +8.836616779504274e-01   +3.341719795803815e-01   +3.698083548357544e-01   +2.945032460438881e-01   -2.290988271243874e-01   -4.126481619451006e-01   +6.634972497799922e-02   -7.273773461117163e-01; +5.692797131653696e-02   -1.497709366213345e-01   +2.713777063110406e-01   -1.189664582627983e-02   +1.197363349984230e-01   +5.836376648603223e-01   -5.941075414857958e-02   -5.586995125951710e-01   -2.092108845672253e-01   +2.977357044048756e-01   -2.612944308563962e-02   -1.181833249639363e-01; +3.896611622795018e-02   +1.801846206786559e-01   -3.646102728777805e-01   +2.241037877346164e-01   -2.527564279684980e-01   +5.748630954035818e-01   -2.452033989708186e-01   +2.020408830334853e-01   +1.989367184890544e-01   -2.785796780674071e-01   -1.467392166532245e-01   +1.440200673920998e-01; +1.361068252483028e-01   -8.083273570520222e-02   +1.007511557034657e-03   +8.572025569136238e-01   -2.755055571153370e-01   +4.060196808039265e-01   +5.830293517418055e-01   +1.476230137132691e-01   -4.776496984958259e-01   +1.745890225910130e-01   +3.424176115620347e-01   -4.601157493360547e-02; +9.385064996947304e-02   +5.007166393236026e-02   -5.649057593359375e-03   +1.929329207588872e-01   -3.016169759191161e-01   -1.433861900535978e-01   -4.600689880382555e-02   -4.248807962587479e-01   -4.751707717665753e-01   +1.478271038136142e-01   -3.120815319525835e-01   -4.045406162374231e-01; +2.585715074203147e-01   +1.221140455567514e-01   -6.345793510159756e-01   +6.535449977182464e-02   +2.736608505694176e-01   -3.612004314464262e-01   -2.541370691239753e-01   -4.398648211378876e-01   -7.524216131132130e-02   +9.958633294473943e-02   +4.381593400484864e-01   -3.921737596236703e-01; +3.619209033505795e-01   +2.452901976628711e-01   +4.930216366436425e-01   +1.770463555926804e-04   +2.360754681482457e-01   +4.086265672437381e-01   +5.037217256552510e-01   +4.982825647305966e-01   -4.442640575009063e-01   +3.405005868859982e-01   +5.324120434267362e-01   +4.013617941642386e-01; -1.016635707896113e-01   -2.371500180861035e-01   +2.021549146338207e-01   -5.229556364034335e-01   +2.708528514362861e-01   -2.987533950321233e-01   -2.051958456819755e-01   +3.302254031300368e-01   +1.951678692860220e-02   +1.120853754695969e-02   -1.995532623465406e-01   -8.160425603738981e-01; -2.248304682592620e-01   -5.474373645540427e-01   -5.323241587976404e-01   +2.973944204293657e-01   +2.761649836814944e-02   -3.397098703515581e-01   +5.364184218408952e-01   +4.447533180021668e-01   -3.188696911102276e-01   -1.934244769498837e-01   -3.896764417212761e-01   +2.139910235991165e-01];
L1_L3_iAMPA_netcon = [+1.990665795095593e-01   -2.640231642769732e-02   -3.320300121617212e-02   +5.693725898234878e-01   -3.108302622657408e-01   -1.051369948076918e-01   +4.533282807382052e-02   +2.695378915742888e-01   -2.152645875320038e-01; +1.762159194319313e-01   -2.941624580985114e-02   +2.713340694359535e-01   -2.087369130432740e-01   -5.586060438705874e-01   -3.063489019360290e-01   +8.047103294497662e-04   -7.682874896864716e-02   +8.054416335747711e-02; -1.943462284472907e-01   -1.243679449041154e-01   -1.681111369751491e-01   +7.742525164275926e-02   +2.893999613451976e-01   -4.603510536018240e-01   -6.228540418070491e-02   +2.306512416454153e-01   -1.273980598735425e-01; -2.060538721463580e-01   -5.552621474575635e-02   +4.211574220503880e-01   +2.755352800886488e-01   +2.163835316164404e-01   -1.071466901010518e-02   +5.074829498453817e-01   +6.396015880611885e-01   +3.457356214516382e-01; +5.309931333535660e-01   -2.828558753348424e-01   -3.239419400713274e-01   +1.514399752203069e-01   -5.607364417247915e-01   +6.816393067279108e-02   +1.753698847846482e-01   -1.599184324457167e-02   -1.268381978092881e-01; +4.715483982007742e-01   -8.827545640440049e-01   +1.803243079582488e-01   -8.782141141546868e-02   +2.572084611523520e-01   +4.608828414951137e-01   +4.103000266581326e-01   +4.081418984728068e-01   -5.035264559170096e-01];
L3_L1_iGABA_netcon = [-2.243234584986101e-01   -4.583271980197752e-01   -2.306681329693102e-01   +4.521783765218582e-02   +5.849242378700287e-02   -2.553157011692096e-01; -1.989745747808624e-02   -2.263419600148204e-01   -5.566300752305328e-01   +5.342248013096795e-02   -1.646405093011037e-01   +1.733246515116194e-01; -1.539676682123708e-01   +6.113404739918188e-01   -1.321216476115374e-01   -3.535035659708964e-01   -9.425860756558782e-02   +3.078058818066794e-01; +2.763726743383705e-01   +8.327692052565801e-02   -2.003394573151396e-01   -2.454055034209039e-01   +1.526953096114844e-01   -9.458948747743869e-02; +3.525103398010880e-01   -4.195791679618671e-03   +2.637763508031563e-01   -1.336561869790727e-01   -7.795852144908028e-02   +2.780251870706446e-01; -3.313402315119235e-01   +2.272683981748586e-01   -1.554583353286727e-01   +4.107873902842908e-01   +2.014179618433123e-01   -3.362270319665937e-01; -9.789753704775246e-02   +1.708796512606780e-01   +2.142099871243252e-01   +4.559692036741837e-01   -3.066338042406984e-01   +1.363989091239130e-01; +1.453516508403885e-01   -1.816771354055301e-01   +1.500757569841975e-01   -2.487380373298639e-01   -5.835705708731768e-02   -2.465974522183396e-01; +7.552664116066476e-02   -3.243080906956951e-01   +1.588692557011442e-01   -4.404241700674554e-01   -3.740779716295470e-01   -2.422255898832779e-01];
L5_Input1_iAMPA_netcon = [-2.303283039969605e-01   -9.042120498146618e-02   +6.586054473637777e-01   +4.103930161652791e-01   -6.347239511322794e-03   -3.077921410953172e-01];
L6_Input2_iAMPA_netcon = [+2.630396895393889e-01   +4.572191131407644e-01   -4.660177734464336e-01   +2.580083310733435e-01   -2.498266992507846e-01   +7.738639317833707e-02];
L5_L6_iAMPA_netcon = [+3.298733257638324e-01   -3.774166922762057e-03   -3.162322628924644e-01   +3.318537381943398e-01   -4.572547295077532e-01   +1.312153641699459e-02; +2.451122668791746e-01   -3.975997696114732e-01   +4.394916203874938e-01   +4.282337490001623e-01   +2.055971965249037e-01   -2.691004060611420e-01; +2.186715834791288e-01   +4.434453447471182e-02   +2.977363489684240e-02   +5.009325190517490e-01   -1.939048765769645e-01   -9.799373535918729e-02; +1.628307419912586e-02   +3.813297701766236e-01   -3.959030501841215e-01   -2.724806938295930e-01   +2.187723442647203e-01   -1.426256156727528e-01; -2.669313118173401e-01   -5.919602156340213e-01   -1.282456565972429e-02   +1.874713471579995e-01   -2.563561469393232e-01   +2.375633388629334e-01; +1.882869031652515e-01   +1.325697933756944e-01   +2.583080567036392e-01   +1.920423695519671e-01   +1.550353552357059e-01   +1.497637602170422e-01];
L4_L5_iGABA_netcon = [-2.853923968625714e-01   +1.928921320907070e-01   +3.273331084081814e-01   +2.214773680222142e-01   -2.860204227920259e-01   +6.829885775577371e-01   -2.378065616860887e-01   +5.458208404901158e-02   +8.339586708683164e-02   +1.089141084840998e-01   +4.436994448974934e-01   +5.419692714411514e-01; +5.206146043081741e-01   +4.165276037953093e-01   +2.428009820950959e-01   -1.218640402529746e-01   +5.043566975092289e-02   +4.762036482272247e-02   -8.318610692085054e-02   +6.183431921853886e-01   -3.109045239005577e-02   -4.270476936691413e-01   +2.187955578586852e-01   -3.123345562051745e-01; -4.747509489145333e-01   -5.303334352437267e-01   +3.107447477508598e-01   +3.010835748216947e-03   -2.930833438101740e-01   -4.204980396485142e-01   +4.010119413493832e-01   -2.176982242111525e-01   -6.188398456758273e-02   +6.021786958420399e-01   -5.570434173190462e-01   +1.984604670434763e-01; -1.524948745374961e-01   +5.907201154934716e-01   -2.443785319566216e-01   -4.420298797362513e-01   +4.393418099979409e-01   +3.279481622138586e-01   +3.676098673606380e-01   -3.097890947863020e-01   +2.711766142077160e-01   +4.003637558926016e-01   +7.938009210576802e-01   +5.338450289347400e-01; +5.126216065318727e-01   +2.338843965613686e-01   -7.456076384661706e-02   +3.381495198086552e-01   +8.305099582162770e-02   -4.012521553593658e-02   +3.766268569817354e-01   +3.893797380711254e-01   +1.887131460031181e-01   +6.948566899172298e-02   -1.010091061173723e-02   -1.672217867855652e-02; -1.115413217139623e-01   +4.833266086059795e-01   -2.317839614496621e-01   -6.790416091419512e-01   -3.158632200135882e-01   -1.828939233416161e-01   +3.921512711963665e-01   +6.929513272889231e-01   +4.499178395903592e-01   +8.229522687152914e-02   +2.074229832040157e-01   +2.436632997134517e-01];
L6_L4_iAMPA_netcon = [-1.224544718274453e-01   -4.529921309436197e-01   -1.320241683753488e-01   +6.641653884536414e-03   +4.559393944746352e-01   +4.509044793960773e-01; -4.972571453094906e-01   -4.485476106764414e-01   +1.725873044561679e-01   -2.264346595833968e-01   +4.519956852641710e-01   +1.990652728027233e-01; -2.811869631688856e-01   -6.367242091603657e-01   -3.592878925240621e-01   +1.932963908856212e-01   +5.511552445258553e-01   +3.048613123659312e-01; +8.435062397223980e-01   -4.308030981939151e-02   -2.694258763694159e-01   -1.704840436608913e-02   +8.343423325398526e-02   +6.954355233829624e-01; +2.876092332579550e-02   +1.235375040387907e-02   -1.157986007697550e-01   +6.531626091782455e-01   -2.388159651931749e-01   -5.870323543665172e-03; -3.710465937374668e-01   +8.029386203222426e-01   +2.245262708388184e-01   +8.840771896935967e-03   +2.595435210312739e-01   +3.404720533630278e-01; +2.478649977815736e-01   -8.221873298090404e-02   -5.010545236017570e-01   +6.195642923324538e-01   -1.217528553527189e-01   +3.650258250866853e-02; +3.124435128149389e-02   -2.073148568026543e-01   +1.257186834656620e-01   +1.889481615962610e-01   -2.536511228791142e-01   -5.095321214134709e-01; -6.107985552372047e-03   +6.187293602158130e-01   +2.337781577639310e-01   +3.161206995483323e-01   +3.807078225904598e-02   -1.024684416399117e-01; -5.214185236168632e-01   +1.476357744141753e-01   +4.369452691805994e-01   -3.405856488068885e-01   +3.844790310719821e-01   -3.212046748451796e-01; +9.591562114172891e-04   +6.605856833512991e-02   -3.065555361676365e-01   +1.425698497054262e-04   +5.584949250482942e-01   -3.838435980952535e-01; +9.423316778672001e-01   +3.363812005666005e-01   +2.681260058086761e-01   +3.076848581789451e-01   -5.173214194251612e-01   -1.672614138399679e-01];
L5_L4_iAMPA_netcon = [-1.579741957780638e-01   +2.554456898231145e-01   -3.754913793601531e-01   -2.960660043300584e-01   +2.340673775088590e-01   +1.039044733997554e-01; +2.967370193134863e-01   -1.954906215187815e-01   -2.019693389974933e-01   -4.999180884524169e-02   -3.153709169523705e-03   -2.477445138789844e-02; +2.284464599419854e-01   +2.967752449979348e-01   +8.403587653142508e-02   +5.251057791043576e-02   +1.572349225969495e-01   +4.867822529263954e-01; -3.769913240257853e-01   -2.241711416524811e-01   -3.052761372709228e-01   +3.351583508538029e-01   +2.784490608044543e-02   +2.922320780970395e-01; +3.015866925137647e-01   +7.547545358852732e-01   +4.784616296778947e-01   +3.930106877768255e-01   -6.231428961642256e-02   +2.590772766905001e-02; +5.116758321137417e-01   -3.605391089281007e-01   +7.358863917252667e-01   +4.388302734624635e-02   +1.707562207159424e-02   +2.751876677235146e-01; +1.063821960815096e-01   +1.124320400950065e-01   +1.079694969140643e-01   -3.500770681103283e-01   -6.369505681645682e-02   +4.581910271104743e-01; +1.804255345784020e-01   -2.267057761905039e-02   +3.120892023044757e-01   -2.654625771282823e-01   -4.713764098117307e-01   +2.032405328647631e-01; +3.244189266176373e-01   -6.514795357814161e-02   -5.611799811704749e-02   -5.537011658875013e-02   -2.661247780562094e-02   +2.359514452194829e-01; +8.240143449866924e-02   +3.492576967541763e-01   -7.283892334232399e-01   -1.481528228508353e-01   -1.475318181375370e-02   -1.670464583895319e-01; +2.855190504755536e-03   -5.036332197465290e-01   +1.916582588020597e-01   +3.040762355604763e-01   -4.764593901347849e-01   -6.074836986221916e-01; +4.845153223270369e-01   -4.463168566652159e-01   +1.590706938230597e-01   -1.711911412720802e-01   -5.686387761039564e-01   +2.824145528628217e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
