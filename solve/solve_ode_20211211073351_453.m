function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.521132728930234e-01   +8.322610233290142e-02   +3.164816277738282e-01   +5.800945209247113e-01   +2.916078857468801e-01   +3.746123732310684e-01   +1.041291160555845e-01   -8.062912248749646e-02   -2.947025720498332e-01; +8.195978225978817e-02   -3.883179731660679e-01   -1.764501485491839e-01   +6.416459682623930e-01   +5.527956003355097e-01   +5.535448491301060e-01   +5.480397983055465e-01   +1.785764239152292e-01   -7.390909577822337e-02; +3.641173466148185e-01   +4.645037342425943e-01   +6.596095485909103e-01   +5.049269027777993e-01   +5.047279617863298e-01   +2.807550159428707e-02   +5.632932700798035e-01   +2.521586104991572e-01   -5.747227547858635e-02; -2.638966678829641e-02   -1.926037925400985e-01   +3.455842526972591e-01   +1.632888745543071e-01   -3.215724624217614e-02   +4.062272417501633e-02   -6.061115164266958e-01   +6.267703262273986e-01   +6.021617335203103e-02; +2.157804860739782e-02   -2.763211284582384e-01   -2.488934195369328e-01   +1.678344176813192e-01   -5.401537953735729e-01   +9.135193779204702e-02   +5.320777218099948e-02   -1.323494096065004e-01   -2.184663325626322e-01; +2.109303722363993e-01   -1.453846479401316e-01   +4.066613830426447e-01   -1.823621814852525e-01   +1.823356191969120e-01   -7.294201737092804e-03   +2.422868471700490e-01   +4.663149659949868e-01   -4.238292499024552e-01; +1.581292699798316e-01   -3.742221684283056e-01   +5.967916786736259e-01   +1.856787505966046e-01   +9.921614759729291e-02   -4.478316102142698e-01   +2.387863773328431e-01   +6.028900612270893e-01   +5.578633324138234e-01; +6.036000230136271e-01   +5.424842756565618e-01   -1.489967436298523e-01   -8.531493971657647e-02   +9.511973645058659e-03   +6.987680893185566e-01   +9.637283842870739e-02   -6.840628718482909e-02   -2.451951467505782e-01; +2.344937673320875e-01   +6.951489100805864e-01   +9.217178051766423e-01   +7.144316427939165e-02   +3.893399764606852e-01   -2.280106303832913e-01   +5.983025258796838e-01   +2.038779829838391e-01   +5.312366016255231e-01];
L1_L2_iAMPA_netcon = [+9.122048685895431e-01   -3.911786493831952e-02   -4.917694324372754e-02   -5.176333727998907e-01   -3.058609130228837e-01   -1.005087657167418e-01   +2.198567273029583e-01   +3.997800042574823e-01   +2.767906075333185e-01; +8.549775568202522e-03   +6.228003798612807e-01   +5.976476268862227e-01   +6.544791774624221e-01   -3.845413053579731e-01   +9.746557814138674e-03   -4.899937387189065e-01   +3.879627606534877e-01   +5.409936928344954e-02; -4.354835617297202e-01   +5.740667054526223e-01   -2.605756046766780e-01   -1.675655574928714e-03   -5.698200962227304e-01   +5.024609655425605e-01   +4.871195179374629e-01   +2.839704560944845e-02   +1.774052319475361e-03; -1.188864307413927e-01   -6.113294674400583e-01   -6.529500620042749e-01   +4.640169654746811e-01   +3.809678791860781e-01   +4.015589474564376e-01   +2.381531219196343e-01   +4.020857359334807e-01   +5.754474437759718e-01; +1.301183139448494e-01   +3.042920119353034e-01   -2.996675238288365e-01   +9.555851242202968e-01   -2.436182586951187e-01   -2.251728274783322e-01   +7.452275846230266e-01   +1.597707425942051e-01   -1.060270195972542e-01; -3.435407174015639e-01   -1.806288592028437e-01   +4.495752682164594e-01   +3.065449675077845e-01   +1.654094825717256e-02   +4.502029241576407e-01   +1.215125004760290e-01   +3.514798611368634e-01   +4.161567875727721e-01; +6.483569689982921e-01   +5.326926349906955e-01   +4.791370339699903e-01   +1.602964656276507e-01   +2.193398321263887e-01   +1.149632704409320e-01   +4.258650951447294e-01   -3.535548373581125e-01   +4.217222927510680e-02; -4.579677681249701e-01   +3.356837359817346e-01   -4.623404144983944e-01   +2.773577057028713e-01   -1.647079577622729e-01   -8.171128603727021e-01   -4.169768105906441e-01   +1.643701266744393e-01   +3.058119402587585e-01; -3.711923209225780e-01   +2.979302951340584e-01   +2.214021522643514e-01   +6.108486684498056e-02   -5.144970332556145e-01   +4.609004372156236e-02   +4.654028609502754e-01   +5.121822637475373e-01   +2.583954001531321e-01];
L2_L5_iAMPA_netcon = [+4.094308966773270e-01   -4.627586250763496e-01   -3.633872225391008e-02   +2.558050957759122e-01   -7.062301186642977e-02   +2.637413988118278e-01   +2.936308524042909e-01   +2.858631697366285e-01   +1.312243259192590e-01; -1.603882606725503e-02   -1.348845068002779e-01   +1.640241751873271e-01   -1.309918459208833e-01   +6.165519952679301e-02   +5.037671081350656e-01   -3.441309044851811e-01   -2.559030323819411e-02   +3.548378861398377e-01; -2.448662636070666e-01   +4.121179851132473e-01   -1.306136484022237e-01   +3.790876712049546e-01   +3.106170975751262e-01   -8.381038901196292e-02   +9.619018552124063e-02   -4.127776914823718e-02   +5.563995305559890e-01; -3.695552288787997e-02   -1.094268712415415e-01   -2.548575414599888e-01   -1.346671910767809e-01   -4.559284400710035e-01   +4.808528206183759e-01   -4.031689734312760e-01   -8.431272847423798e-03   +4.315804601601983e-01; +1.204963314739688e-01   -5.292041854207474e-02   -4.065299837509263e-01   -2.742167106089306e-01   -5.171079461419658e-01   +3.925818462542967e-01   -2.385161499372932e-01   +2.227337383801209e-03   -8.502096121324149e-02; +7.934917452582907e-02   +3.974884659181541e-01   -1.579697496704880e-01   +2.352916807446187e-02   -1.494963745412748e-01   +1.294617455499431e-01   +7.999839660878509e-01   +1.737275254557013e-01   +6.435570043849825e-01];
L5_L2_iGABA_netcon = [-5.877930133340015e-01   +3.643199165516144e-03   -1.019653083129979e-01   +5.532664177690786e-03   +5.423720546420941e-02   -5.138033289514736e-01; -2.809503016255019e-01   +1.279904200534626e-01   +1.820573465015035e-01   +2.252300355664443e-01   -1.918200097144464e-01   -4.983430246758396e-01; +2.916016430947356e-01   -3.081080140104894e-01   +4.178637341921549e-01   -3.060056346942950e-02   +1.651470579578160e-01   -6.205641129527659e-02; -6.408881348010437e-03   +5.617744208526112e-02   +3.380603477872884e-01   +2.628560300970029e-01   -2.835081436923513e-01   -4.443921763900996e-01; -2.493218594424914e-01   -1.642667047604425e-01   +4.196552254747157e-01   +6.534039387016317e-02   -8.095027645848511e-02   +3.057081152486272e-01; +5.012592715803282e-02   +6.255799577563903e-01   +4.703219405414835e-01   -1.806956310807664e-01   -1.535095988330570e-01   -9.081137565410370e-02; -5.231057616322987e-02   -1.810695291875634e-01   +2.095930411537904e-01   +9.241973883979364e-02   +2.819373591856891e-01   +9.972712821286296e-02; -5.842188502175204e-02   -2.195586909251167e-01   +3.757943638237299e-01   -4.723358731082183e-01   -3.685614520483472e-01   -7.516558544183110e-01; +3.005272794237799e-01   +8.505999607496589e-02   +5.941449326529845e-01   +1.000000000000000e+00   +5.029954830540908e-01   -4.664002461506038e-01];
L3_L2_iAMPA_netcon = [+2.079803441886942e-01   -4.157116048321038e-01   -1.466081650536886e-01   +3.282025986853647e-01   -3.915552752101079e-01   -3.049685463316527e-01; +3.816708969293123e-01   +4.321263536676251e-02   +2.499149042159417e-02   +3.003690327939522e-01   +9.716730063102558e-01   -3.695366739651121e-01; +1.892852617663439e-01   -4.307361093397948e-02   -3.290139130774661e-01   -1.970319009241278e-01   -1.061217844998852e-03   -3.425354627781984e-01; +2.937077496688985e-02   +1.834020909727561e-01   +3.728925518243780e-01   +1.979154846529219e-04   +1.716997397637720e-01   +4.762428145114791e-01; -3.429052469636416e-01   +9.474891631442361e-01   +7.388759541260737e-01   +6.818402290673372e-01   +8.334469155924962e-02   +1.284446530493266e-01; -7.340506432631641e-02   +5.612859742378531e-01   -8.305944833014345e-02   +2.132116110757835e-01   +5.288075314622569e-01   +3.217386700878760e-01; +1.937827487174072e-01   +3.802564974433388e-01   +5.223521942706828e-01   +1.466558320716752e-01   +4.183262596107352e-02   -2.663225506677784e-01; +5.025266582755870e-02   -3.713667444872709e-01   +6.767346748903600e-01   -1.432388015062594e-01   +9.325909125116530e-02   -1.011156486296894e-01; +1.079548065870934e-01   -1.730529971969282e-01   -1.159845213852896e-01   +6.369477789026158e-01   -4.604531886836611e-01   +2.190860994833732e-01];
L2_L3_iGABA_netcon = [+1.595059698827077e-01   -1.634419479572345e-01   -6.088855667763949e-01   +1.034969411158398e-01   +2.811741474546580e-01   -1.938374644084373e-01   +2.169627230350880e-01   -3.355049958135131e-02   +5.814140691019228e-01; +4.006842560407497e-01   -4.595606612502625e-01   +3.017281789244711e-02   -7.398235591967953e-01   +8.021028159460228e-01   +4.005271739770352e-02   +2.627670269511463e-01   +1.987502927032290e-01   +3.037552068505192e-02; +2.173550730400256e-01   -3.085358663989206e-01   +2.057023322774050e-01   +4.340427154154988e-01   -3.595384629034789e-01   -4.036600617696204e-01   -9.957518608978777e-02   -1.073343717161941e-01   +6.409739071697018e-01; +5.471732443879467e-01   +3.793152937311103e-01   +7.122887550554828e-02   -3.288140235430427e-01   +1.872027873476631e-01   -3.846247167294948e-01   +1.595410252675226e-01   +3.943745858044423e-01   +6.685590329951716e-01; -3.326092276232526e-02   -2.580715403217140e-02   -2.257644502645860e-01   -7.317173109663286e-02   +3.437699461304046e-01   +8.022425999556180e-01   +1.972639760960694e-01   +4.011227609825986e-01   +4.870444752836028e-01; +5.751374904875048e-01   +1.742343955772171e-01   -8.554393338061486e-02   +5.074036916175224e-01   +2.025718558620799e-02   +3.669151065351638e-01   -5.553395595366845e-01   -3.463859407947779e-01   -6.947977639942832e-02];
L1_L4_iGABA_netcon = [+1.089966359367917e-01   -5.698283072564085e-01   +1.420295482566777e-01   +2.877200941239447e-01   +7.114219093162142e-01   -4.818797070943471e-01   -1.114644602877711e-01   -2.661774386717729e-01   +6.635482121077498e-01; +1.625648798366870e-01   +2.238763310482800e-01   +4.900934894844561e-01   +8.149800233612507e-01   -5.913672564380357e-03   -3.504887934400817e-01   +4.870254210848252e-01   +2.883854613275961e-01   -1.668541394341488e-02; +9.499695790530838e-01   +8.709417602460298e-02   +3.003690705330353e-01   +2.870120420076633e-01   +5.905791179755260e-01   +2.504133662244252e-01   +2.304018506270600e-01   +4.084929688473238e-01   -2.040787219153780e-01; +2.432987930348633e-01   +4.479733731207705e-01   +4.350911579687064e-01   +2.211697917302293e-01   +6.602749511777362e-01   +6.999577778365805e-01   +4.139241536679995e-02   +6.322263296202428e-01   +6.379872435876346e-02; -4.530481235778133e-01   +6.199952859191894e-01   +1.955461997526877e-01   -6.127825540322376e-02   -7.325989028017825e-02   +1.761746464845464e-01   -1.277030442979317e-01   +3.593379273990840e-01   +6.435391895662144e-01; +8.322799116537728e-01   -1.217181601793259e-01   -1.955337137898865e-01   -2.490003097286775e-02   +1.894718776193637e-01   +1.871026257614519e-01   +6.040206458051445e-02   +1.210141471784477e-01   -7.486647340557018e-01; -2.572232813742770e-01   +3.049566039735502e-01   -1.405544886962462e-02   +6.155727555366034e-01   +6.887524833251129e-01   +9.711731899211919e-01   +6.268746285765036e-01   +1.546082840834470e-01   +8.225132523296291e-03; -1.460231190721004e-02   -1.052646370907654e-01   -1.886805757253961e-01   -3.869652820473877e-01   -5.145442475873437e-02   +3.389075746891181e-01   +4.980861715348164e-01   +2.042566798833730e-01   -1.544354757873055e-01; +1.412895228405436e-02   +3.072823235335412e-01   +1.944022224194207e-01   -7.846636667937648e-02   -3.561884306924788e-01   -1.563793658625245e-03   +3.028664174518471e-01   +3.020162131780053e-01   -9.916142558409113e-03; +6.567883154917540e-01   -6.120996642419856e-02   +4.174165777125960e-01   -2.089505742444341e-01   +2.595531283567128e-01   +4.020329305285849e-01   -1.496701714321689e-01   -2.628212560721808e-01   -4.909544438123158e-01; +3.633489734762835e-02   +3.954933052189946e-02   -1.024576495273192e-01   +1.008460711082219e-01   +2.817213307902966e-04   -3.367193546206352e-01   -2.776949200923262e-01   +2.057456728039462e-01   +4.166008480567911e-01; -2.014758083122285e-01   -6.632778064351974e-01   -4.211525473602590e-01   +2.313051283864032e-01   +5.781347986144142e-02   -3.617148634041956e-01   +3.908512152519774e-01   -4.814914290469292e-01   +8.125314675827752e-02];
L4_L1_iAMPA_netcon = [+2.391772646959046e-02   +7.922751913613302e-02   +3.941159186932819e-01   -2.101086247519052e-01   +2.361718244805930e-01   -1.520156303188563e-01   -1.709258084267055e-01   -1.198060550863218e-01   +5.204847819610190e-01   +5.768371412761634e-02   -3.963640083884497e-01   -1.557081956151750e-01; +2.006251686282024e-01   +4.971792313974075e-01   +4.628696948791022e-01   +3.444675688207781e-01   +4.486642219313067e-01   +9.031459639354023e-02   +5.642532931518075e-01   +3.348153339279452e-01   -3.950044164088305e-01   +2.054210102756034e-01   -4.721775072558413e-01   +5.319940689457956e-01; +2.384954779464437e-01   -1.939719850504307e-01   -9.428822790608557e-02   +3.762694551503366e-01   +6.466154967661297e-01   -5.345175726556052e-01   +4.290642692440884e-02   +3.557379706990658e-01   +2.295020427524747e-01   +6.418465553991229e-02   -3.029308675889899e-01   +2.867181810664398e-01; +4.099688803615619e-01   +1.398595863461700e-01   -9.413926661361777e-02   -6.561956133750482e-02   +3.818846970654775e-01   -3.166734863482182e-01   +1.026805795384830e-01   -6.984728284005368e-02   +5.971839341991136e-03   +1.467119345507140e-03   +5.041013999537577e-01   -6.471463630965027e-02; -4.263644821268253e-01   +1.716985338612367e-01   +3.859197530173955e-01   -5.955265352046263e-02   +4.117102175531834e-01   -1.771579741281092e-01   +6.766020369537964e-01   +8.904285083126071e-02   +4.791509277806084e-01   +3.263560046806496e-01   -1.014254379446814e-01   +2.152519127243148e-01; -3.682313538762151e-01   +7.623330144937719e-01   +2.486880988111328e-01   -2.155918953769387e-01   +1.120345957890387e-02   +3.446614194554627e-01   +6.325074278085753e-01   -3.028724494296799e-01   -5.056838094329617e-01   -5.633707909853913e-01   -5.017479193889984e-01   -3.312402380428807e-01; -8.242612527226933e-02   +3.019246085207276e-01   -3.183055293545936e-02   +1.386431568105263e-01   +7.159432659531675e-01   +5.413978021012533e-01   +2.579082401273443e-01   -1.923121329559509e-01   +2.322328187107845e-01   +3.210570451969389e-01   +4.551166281277191e-02   +5.172236021909238e-01; +1.946554963691967e-01   +1.743566111143436e-01   -9.827902328649102e-02   -3.099386748523120e-02   -3.421045762994337e-02   -2.358006405227895e-01   -2.539317064212341e-01   +2.592345445692975e-01   -4.216282322220209e-01   -1.205631134841370e-01   +3.409023348520879e-01   +5.483315068015648e-01; -2.171287668534039e-01   +7.829837425300379e-01   +6.809838185149388e-01   -1.604619349845874e-01   -2.860866618926148e-01   +5.495181330316401e-01   -3.171373391442955e-01   +4.201766388173882e-01   -2.135883655484010e-01   -2.443052791082695e-01   +1.563296086861306e-01   -3.702790325485972e-01];
L1_L3_iAMPA_netcon = [+4.534927085895479e-01   -4.968868389643024e-01   +5.623395711621452e-01   -1.988005100737232e-01   -1.485448004341027e-01   +2.022483881543545e-01   -2.181815305747781e-01   -1.502141834540268e-02   -2.406646521405243e-01; -8.081491619910388e-01   +3.773282487011860e-01   +3.755718539076125e-02   +7.477649609343382e-01   +2.219636873630121e-01   +1.412219203692654e-01   +4.742462705362365e-01   -7.455825585314652e-02   +6.691127505975920e-01; +7.539022638403088e-01   +7.735573970981445e-01   +1.083023938315544e-01   +1.709245607392688e-01   -4.756295743562785e-01   -3.506954066884484e-01   -2.383856102673578e-01   -2.663543788076995e-01   +3.005399514854737e-01; -5.886623045829220e-02   -1.403147055556729e-01   -9.621134205381029e-02   -6.100797359700702e-02   +3.081041355869208e-01   +4.326463125459654e-01   -2.886661493883469e-01   -3.924186553726384e-01   +5.455452062444566e-01; -3.557839608046117e-01   +3.878886627794084e-02   +2.559527121306582e-01   -1.677523639476714e-01   +3.120342910532273e-01   -5.408748251090481e-01   +7.195227570899568e-01   -6.756590891717745e-02   +2.329109681586021e-01; +5.244545004768117e-01   -3.728811001707624e-01   +5.897118329977702e-01   +3.639767882221828e-01   +5.066901482652106e-01   +4.152750997321920e-01   +1.499578939345774e-01   -3.197232582408212e-01   -3.802910661531471e-01];
L3_L1_iGABA_netcon = [+6.584376854009379e-01   +1.698878995260981e-01   +4.353397364688162e-01   +8.582530597499111e-01   -4.083554291550667e-02   -4.465343549987489e-01; -8.324545010504186e-02   +5.142300085476820e-01   -3.123703818046978e-01   +7.882336878416568e-02   +4.226090263627071e-01   -3.411551456584068e-01; -1.845121275377559e-01   +5.720086847835422e-01   -8.073365289652222e-02   -3.966581875955929e-02   +4.655230145937321e-01   +2.555398075574393e-01; +1.590336421905794e-01   -3.710703926022283e-01   +7.061736205116524e-01   +1.415742245881950e-01   +2.448360455528790e-01   +1.228766962826405e-01; -5.683259252956552e-02   +7.774636338686552e-01   +4.601886850393586e-02   +1.060833052236025e-01   +4.432514355323811e-01   +2.944419444259025e-01; +8.607789311706662e-02   +1.591404325286007e-01   -1.948048628522011e-01   -1.078377204603294e-01   +2.610676962356867e-01   +7.660383748164323e-01; +3.149795462939643e-01   +5.236965107423391e-01   +3.834072847304958e-01   +4.774618023742238e-01   +2.568068820452449e-01   +3.559008117885366e-01; +6.158208534934213e-01   -7.535560566434081e-02   +2.866428097161154e-01   +1.907254498186806e-02   +5.041146503371313e-04   +9.329757590048451e-01; -1.137099313051189e-01   -7.841432253270002e-01   +2.723086747951174e-01   +3.818454401802142e-01   +4.689151973620323e-02   +2.107998680101891e-03];
L5_Input1_iAMPA_netcon = [-2.921187288295000e-01   +2.873328818660770e-01   +3.981712074361022e-01   +1.323899314312241e-01   +6.137007540108476e-01   -1.979260637871095e-01];
L6_Input2_iAMPA_netcon = [+6.300015577333113e-01   -1.209148922619832e-02   +7.330138092076672e-01   -2.787372712557534e-02   +5.693452875994559e-02   -8.889093728720351e-02];
L5_L6_iAMPA_netcon = [-1.023583430427866e-01   +7.433164667737899e-03   -1.711117569172350e-01   +3.911000316402571e-01   +3.865909084672855e-01   -3.207002962240117e-01; -3.082861918434881e-01   -1.777250714808192e-01   +4.265332335790484e-01   +2.037212979207399e-01   +1.677304863834896e-01   +1.682756363423647e-01; -1.638302524598949e-01   +2.404366138001501e-01   +6.309598985249589e-01   +1.277844564635329e-01   -1.896806551463687e-01   -2.670688010386078e-01; -2.827083482723001e-01   +3.630101581148366e-01   -2.789743705058940e-01   +3.984610117083167e-01   +3.503811894175596e-02   +5.762447385550755e-03; +1.075792533628461e-01   +2.768618775785153e-01   -1.287430237589352e-01   +2.147314588107748e-01   +1.963231581451771e-01   +3.989608385984257e-01; -8.899806386844747e-03   +2.848654757044463e-01   +9.164295690906989e-01   +2.572034385890241e-01   +1.002299788905661e-01   +3.365852240961981e-02];
L4_L5_iGABA_netcon = [+1.984341052776198e-01   +5.948736123848863e-01   -8.095079788405109e-02   +1.388556220984586e-01   +7.197779157733810e-01   +4.446367944519991e-03   +2.307316829059013e-01   -4.532019043960435e-01   +2.834161326881726e-01   +6.016339844995261e-01   -6.010188736693405e-02   +2.517007845074169e-01; +3.990832684072561e-01   +1.510109902040902e-01   +2.025826986826864e-01   +4.307940842956842e-01   -1.243839599832923e-02   +2.667890055002314e-01   +4.820697726305107e-01   +2.404190719232111e-01   -5.141837189188430e-01   +4.902301671296619e-01   -4.783198747780348e-01   +1.342020863032922e-01; +5.364274051076025e-01   -1.984040268254552e-01   -3.541496887783899e-01   +4.197181632457620e-01   -1.487022785357996e-01   +2.824730911642973e-01   +1.362275143304314e-01   +3.491662250178278e-01   +2.507693861560112e-01   +2.720698844188769e-01   -1.645595554441604e-01   -2.916432876395245e-01; -9.132095978291204e-01   +3.736807797607305e-01   +6.673185601993484e-01   +8.020055726307217e-01   -3.384728197683971e-02   +2.061470509314716e-01   +3.121222293791512e-01   +2.323919049744829e-01   -2.501660536437337e-01   +1.000000000000000e+00   +1.483551299468968e-01   -9.892992606022953e-02; +1.784920790693385e-01   +1.310425651040092e-01   +2.639693026401890e-01   +3.876558725570062e-01   +1.553804897224717e-01   +1.115108193234379e-01   +2.789554898342858e-01   +1.943296933945594e-01   +2.272901647729117e-01   +3.891244378637328e-01   -8.168341196866316e-02   -4.459629691064851e-01; +2.813058559650058e-01   -6.784551310008141e-02   +1.205458723224690e-01   -6.470368166932549e-01   -5.986066218046194e-02   -4.881333839930078e-01   +2.575282358434260e-01   +5.607376515527099e-01   -2.053444419267542e-01   +1.732716709322397e-01   -2.159519134375208e-01   +3.311755145561615e-01];
L6_L4_iAMPA_netcon = [-1.763174783618085e-01   +7.823291136735411e-01   +1.263119716397894e-01   +3.506747228491834e-01   +1.020368808394397e-01   +5.631113709406144e-01; +2.776909639798406e-01   -2.515869268575779e-01   -5.042657396404722e-01   +4.924449005221166e-01   +1.889656799856917e-01   +6.771285916390371e-02; +8.955219065692199e-02   -9.175703368858776e-02   +6.822270684802723e-02   +5.255881344392492e-02   -2.282668873936919e-02   +8.571388699534170e-01; +2.680903621510686e-01   +1.554347318471611e-01   +6.615922737682975e-01   +1.218514400179187e-01   +2.013664440740967e-01   +1.472850544072752e-01; -1.974652778543882e-01   +4.065956107178528e-01   +9.682636516580145e-01   +7.020719339970274e-01   -2.095666303760092e-01   +4.873028114978876e-01; +4.183090900689769e-01   +5.367073181531928e-01   +1.329599371528310e-01   +1.956341502825419e-01   +3.786423486828900e-01   -2.737099594794332e-02; +6.534160686152330e-01   +2.124586630258060e-01   +1.531123674651947e-01   +3.374497761633137e-01   -2.321574079265074e-02   +1.188317126102170e-01; -1.814911375470716e-01   -4.072041201011316e-01   -2.257437736121041e-01   -8.203793143493066e-04   +1.203782568214893e-01   -1.434873541038611e-01; -3.479996403244891e-01   +3.068729311787946e-01   +9.527239555641569e-01   -2.883679442370540e-02   -2.880078192543096e-01   -6.440375560209502e-02; -1.506019604260844e-01   -4.846842853000538e-01   +4.404182604026631e-01   -1.349236673417420e-01   +1.865451961335750e-01   +3.201674628844931e-01; -4.476586943709837e-03   +2.435935365852034e-01   +2.798030273349368e-01   -2.223175540602746e-01   -4.212440200859191e-02   +4.684079097967312e-01; -3.337015920849926e-01   -1.151646572321806e-01   -2.352987396659314e-01   +2.996398331549498e-01   +6.817769048665167e-01   +3.797101889284431e-01];
L5_L4_iAMPA_netcon = [-1.514696944418572e-01   +2.558088245707398e-01   +3.743330879975428e-01   -1.054094274792138e-01   +6.387972449137167e-01   +3.018851572980354e-01; -7.703987389354804e-02   +1.785586155880527e-01   +5.629160377909534e-01   +3.754049360320436e-01   -1.900864657189374e-03   +3.634358255189460e-01; +7.268582180326846e-01   +7.317061390076834e-01   -3.890202181141059e-01   +6.111807743771203e-01   -1.398659219966880e-01   -7.239627717440639e-02; +3.699068563097732e-01   -5.654009745756014e-02   -6.039326009956022e-01   -5.320199577335590e-01   +7.140616916304015e-01   -8.083181809914407e-02; -1.550736588868825e-01   +1.218362696544555e-01   -1.557697037104421e-01   +2.186459653139533e-01   +4.900994197998432e-01   +4.795435044960245e-03; -5.829967471128400e-02   +6.482169803255561e-02   -2.737091344193173e-01   -2.076243324083814e-01   -3.339529984510912e-01   +4.124257524148166e-01; -1.133179590967667e-02   -2.868088360617904e-02   +4.517895225840053e-01   +2.408601583677120e-01   -9.636640874513237e-02   +2.825576214241394e-01; -1.348434853494191e-01   +6.850713198738925e-01   +1.400937737418432e-01   +2.924484216652763e-01   -1.530537892968906e-02   -4.549798936404101e-02; -1.834130544704388e-02   -8.355082327561714e-03   +1.286013968194000e-03   +1.547109088531680e-01   +4.283653163374530e-01   +1.244916411835316e-01; +1.107005643390767e-01   -1.732568216363724e-01   -3.612465666046361e-01   +3.109971752744724e-01   -1.332190618657428e-01   +1.367516436143016e-01; +5.549514386518535e-01   -1.646246305988671e-01   +1.564442428029034e-01   +3.167466473960444e-01   -4.447322262213054e-01   +3.008773820471112e-01; -3.611827561613247e-01   -1.753586284485485e-01   +7.567700554900418e-02   +1.104606379776812e-01   +1.572952141013432e-01   +2.295282472154681e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
