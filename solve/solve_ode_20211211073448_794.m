function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.204831887581738e-02   -9.831508484310764e-02   -2.970201183471956e-01   +1.596485421082058e-01   +2.861406350744807e-01   +4.427148926123372e-01   -3.368910239939785e-02   -2.484308526289216e-01   -3.970029344427407e-01; +3.426085430494746e-03   -2.454685430839439e-01   -1.839766886394411e-01   +7.110464655054558e-01   +4.471926186624230e-01   +5.425837302832005e-01   +6.756183657893527e-02   -1.434589476167947e-01   -2.774306693375496e-01; +2.760749387761575e-01   -2.586072533786227e-02   +3.657407151140536e-01   -1.223474917314227e-01   -1.156247405437353e-01   +2.589695260757824e-02   +4.789763767338339e-01   +1.255612690957967e-01   -4.384570425595099e-01; -1.490152026156769e-01   -1.087865642983954e-02   +3.071635704289895e-01   +2.439904181686380e-01   -8.360368687779032e-02   +1.961755226185816e-01   -7.362771183765915e-01   +3.526128785930477e-01   -8.948948542387414e-02; -2.578155586280632e-01   +1.061829815497498e-01   -2.680129591403365e-01   +3.254781467539524e-01   -1.106654736060006e-01   +3.163028833098294e-01   +4.501585974753128e-02   -3.828055848186040e-01   +1.205755537431618e-01; +2.452092168372602e-01   -1.048568339274932e-01   -5.855463062731010e-02   -1.921918248067333e-01   +4.157748374542324e-01   +1.865274494136726e-01   -3.268629851898105e-01   +3.343387313293488e-01   -3.476927328557740e-01; +2.786049513791569e-02   +1.222662394669651e-01   +6.880082368729903e-01   -1.108992076238066e-02   +1.188919721079839e-01   +6.609110482316716e-03   +1.543942773237831e-01   +6.221265612594198e-01   +2.037658963426986e-01; +7.783259687111999e-02   +5.405870602537770e-01   +1.422145762777900e-01   +2.588655700004917e-01   +2.299076131046986e-01   +1.417995764797457e-01   +2.838348325756027e-01   -3.263813833174223e-01   +5.587654022407815e-02; +1.906170035167182e-01   +4.325561189955412e-01   +9.893709935168611e-01   -1.173938208649470e-01   +3.989545030344052e-01   -4.533894040688666e-01   +2.135194017995796e-01   +4.044468008579072e-02   +2.676701022679197e-01];
L1_L2_iAMPA_netcon = [+6.899701416126914e-01   +1.070415484629129e-01   +3.468014046107613e-01   -2.709312535300502e-01   -2.113207258945659e-01   -3.158108027793750e-01   +1.891272681048193e-01   -3.209996642385693e-02   -2.553901013372654e-01; -3.600624542274691e-01   +5.901135242939285e-01   +5.030497250951810e-01   +1.730713867215223e-01   -3.899893074543114e-01   -6.557739695133558e-02   -1.764783707934892e-01   -1.545625340100715e-02   +3.628032483619725e-01; -4.309159542990348e-01   +2.304779676591305e-01   -4.054876452565503e-01   -1.519785587892221e-01   -3.708487442062186e-01   +7.823845495575167e-01   +7.463620041209666e-01   -3.420776966838895e-01   -4.678456436367084e-01; +1.851748466131753e-01   -8.357697980970163e-03   +6.197242465663216e-02   +5.412206255746803e-01   +5.485142594007815e-01   +3.747024073452515e-01   +5.186768060888183e-01   +7.766193157593100e-01   +1.560096780960783e-01; +1.995694364841191e-01   -7.619883083956513e-02   +2.016759311351499e-02   +6.633811818430576e-01   -3.093184680421611e-02   -1.626278791904084e-01   +2.060036047116055e-01   +5.307003413780693e-01   -2.785031545546752e-01; -1.595199853400695e-01   -1.733129409343219e-01   +2.710129296263766e-01   -1.288931954970015e-01   -4.011537644219948e-01   +2.285588366203060e-01   +1.202410719620548e-01   -9.179960959006733e-02   +3.747064966041597e-01; +1.395971994022616e-01   +2.242135550582114e-02   +2.411380766222811e-01   +2.590550856748858e-01   +5.417994817655190e-02   -1.430300815980661e-01   +7.382284531659806e-01   -6.832317174759511e-02   +4.241309337105929e-02; -3.225360388851494e-01   +6.170852656385730e-01   -4.081102500386021e-01   +3.525946347916967e-01   -1.447737016202515e-01   -2.877367174276327e-01   -5.252250096846809e-01   -3.256989736833871e-01   +1.730803479751742e-01; -1.735451076001421e-01   +3.282183014334553e-01   +5.330648906906091e-01   -2.864663718876495e-02   -6.888250843427922e-01   -3.836063783835084e-01   +3.960395895371654e-01   +1.907108223317187e-01   +1.201582287258574e-02];
L2_L5_iAMPA_netcon = [+3.956626862435764e-01   -4.274630759335193e-01   -2.814995733114628e-01   +1.207365238462698e-01   +2.127898436508150e-01   +3.083905802818042e-01   +7.875209650338227e-02   +4.582136760610013e-01   -4.427611904258609e-01; -7.881338013874262e-02   +2.849124701807611e-01   -3.684458481923092e-01   -3.195969667374834e-02   -3.838484234589034e-01   +3.778541303966588e-01   -3.617458253005980e-01   -1.470513228999634e-01   +4.998626358000061e-02; -6.542562150770520e-02   +2.318258909327426e-01   +5.373870188038476e-03   +2.970333848089993e-01   +3.993878173320548e-01   +2.564764656040830e-01   -4.806785288769546e-01   +2.342569295440596e-01   +6.310755872811145e-01; +1.386154038792403e-01   +1.430191204531068e-01   +3.124537240137268e-01   -2.319013853081994e-02   -1.236650547563132e-01   +6.389961260164683e-01   -5.722540144169587e-01   -8.379288453485825e-02   +2.535211863007726e-01; -5.269303865417271e-02   -3.937311863081866e-01   -2.065751100772993e-01   +4.696874625040826e-02   -4.596940765871150e-01   +4.204481873349300e-01   +4.766802606755546e-02   +3.234196075446933e-01   -3.807093606191781e-01; +4.501472224862207e-01   +2.522402071230465e-01   -6.890649194220655e-02   +2.887323520181753e-01   -1.085957577970521e-01   +1.502851259106286e-01   +1.768453513917503e-01   -6.046671212050899e-02   +5.199515226663801e-01];
L5_L2_iGABA_netcon = [-2.116315739314644e-01   +3.249272025270078e-02   +8.860084676685344e-02   -3.056547070350665e-01   +1.820428180525678e-01   -3.930931931351833e-02; -2.062652278855517e-01   +8.958764035632041e-02   +4.933488521582016e-01   +2.846045833865736e-02   -4.821518901657537e-01   -5.102618370945617e-01; +1.825488408669499e-01   -2.195981415749104e-02   +2.559725033848588e-01   +1.934355987945331e-01   -8.455072899824337e-02   -1.321729518685087e-01; -1.763121949643618e-01   +1.901620082650768e-01   +4.028800096600470e-01   +5.515751103589350e-01   -7.287703775398686e-02   -5.321478996601554e-01; -1.174477043422909e-01   -1.841559797061088e-01   +2.673333303191098e-01   -3.354483424229754e-03   -6.128978366823343e-03   +1.517339324213925e-02; +2.549776372144555e-02   +5.295191989299917e-01   +5.899554809003249e-02   -4.121228110835170e-01   +1.298739982182595e-01   +1.408766820243062e-01; -2.714649836337125e-01   -3.771245420912969e-01   +3.995052956413746e-01   +2.000390569529652e-01   -7.693190772560915e-02   +3.405258270967643e-01; -2.951069794588786e-01   +9.003550637099006e-02   +2.841797764959655e-01   -5.339923762280954e-01   -3.771165597053726e-01   -6.884303892644463e-01; +4.736536545731583e-01   +2.615300657477417e-01   +3.468222035979345e-01   +4.728449158230564e-01   +4.669850181436052e-02   -2.559310407642482e-01];
L3_L2_iAMPA_netcon = [-7.683839322034207e-02   +3.592466288788218e-03   +4.893259264895190e-02   +1.730232958258113e-01   +7.997470552182528e-03   -3.369685103787995e-02; +3.049696113810192e-01   -8.255686142093814e-02   -4.976354163616560e-01   -7.071788674965368e-02   +2.872631982821368e-01   -6.093611356275717e-01; +3.974292581920938e-01   -3.513997135164691e-01   +5.629696655903235e-02   +9.298884725414297e-02   +1.064665549204644e-01   -1.898301419351978e-01; -6.297901398355515e-02   +4.824508912881398e-02   +5.314164243793221e-02   +1.471193575410289e-01   +4.872042691896301e-02   -5.668720360742793e-02; -4.160837854712123e-01   +5.306678674906280e-01   +7.461076544855004e-01   +4.992282715179047e-02   +1.971516536506929e-03   -6.573578071955109e-02; +1.663286971147459e-01   +2.702876540051837e-01   -4.034118024677360e-01   +2.663583822495071e-01   +6.535060056083766e-01   +5.135388092320499e-01; -4.632607830055055e-02   -2.422815918203434e-01   +2.188509655034719e-01   +2.340419289877417e-01   -1.576480396934528e-01   -5.720099458426959e-01; +4.143049675777724e-02   +1.151208832485166e-01   -3.574953519862845e-02   -2.688697247201582e-01   +9.926297419406094e-02   -2.835041093907700e-02; -1.524572088479907e-01   +3.244738056409508e-01   +3.454880554884734e-01   +2.123044740492151e-01   -2.151122951727695e-01   +3.210102812847083e-01];
L2_L3_iGABA_netcon = [+5.360686891956790e-01   +2.331551006208226e-01   -5.233644522390311e-01   +3.568874633606829e-01   +8.366029728605938e-02   +1.054033995316110e-01   +1.084308048371160e-01   -9.564700070768284e-02   +3.932875538661763e-01; +2.959444903306389e-01   +1.341417619571636e-01   +2.454346106060184e-01   -4.968500306059004e-01   +5.156065554124265e-01   +5.300969450170807e-01   +3.058614412674802e-01   -1.263999131502407e-01   +1.568372078258867e-02; +1.207405917337186e-01   -2.683261735028233e-01   -4.363698103980956e-02   +3.316079576541580e-01   -2.078757817364791e-01   +1.734805242506909e-02   -1.742622544892338e-01   +7.011005251696248e-03   +2.862406374739096e-01; +1.888074990100798e-01   -1.463570884470622e-01   +5.919532308684585e-01   -3.387411347548916e-01   -1.996294705238782e-02   -6.047937195002261e-01   -1.703676907230411e-01   +1.611685657263851e-01   +3.725306015027474e-01; +3.108109392887181e-02   -3.686381582429881e-01   +6.369629391195941e-02   -1.825387273930415e-01   +4.902703243226154e-01   +6.096765517568776e-01   -1.377924934885303e-01   -5.232717417023609e-02   +1.566950083810386e-01; +6.530039425938233e-01   +4.848201390760784e-01   +6.098351020158907e-02   +1.504385498541094e-01   -4.671132528764793e-02   +2.532779381663631e-01   -4.632685199166350e-01   -1.564979342941473e-01   -3.517662740345520e-02];
L1_L4_iGABA_netcon = [-8.817740488530471e-02   -3.492613910774781e-01   +9.086375788473511e-02   +6.639395060982581e-02   +1.710075690742211e-01   -5.075362653784202e-02   +6.375047945089118e-02   -2.808463036385946e-01   +2.931836983659082e-01; +3.007403368338464e-01   -3.210338366962537e-02   +4.536619394453498e-01   +3.436072646611225e-01   +1.278520315760256e-02   -7.069624582895604e-01   +2.371655574005342e-01   +1.267702279877755e-02   +1.365573045241529e-01; +5.612537978003367e-01   +4.892934897707447e-01   +3.333328388129053e-01   -8.680902241566812e-03   -4.441422602089018e-02   +2.268471780293261e-01   +7.736118873188411e-03   +5.789121447074803e-01   +1.167392883808489e-01; +2.485569036955135e-02   +3.653833434391227e-03   +1.091377565142327e-01   -7.136826403486028e-02   +8.742913048761904e-01   +9.096113976604598e-01   +3.692313934061408e-01   +5.608563148847934e-01   -1.817901555820307e-01; -2.213443131575300e-01   +4.735086460813852e-01   +1.711564582162234e-01   +4.869367333186805e-02   -1.203108049269125e-02   +6.834364280249550e-02   +1.152877755232937e-01   -1.047477044889466e-01   +3.763187285889542e-01; +8.355737120381532e-01   +1.687787144212778e-01   -6.169038466562274e-01   +4.976540840509504e-01   +2.014631556816601e-01   +3.140158017624713e-01   +2.028722211278200e-01   +1.500225652433394e-01   -4.709808291097163e-01; -4.345162910091909e-01   +5.067043260371519e-01   -3.703059357960392e-03   +2.292729411628849e-01   +9.835194221538190e-01   +8.553983156481455e-01   +6.117161316497626e-01   -3.997627470465137e-02   +9.754263268839414e-02; +6.888505571281522e-02   -1.572015719291336e-01   -2.692458007592808e-01   +1.297728357356601e-01   +3.567649747538394e-01   -1.302442238000858e-01   +3.514516737150002e-01   +2.334743594495060e-01   +9.012348995114919e-02; +3.120457132035994e-01   -3.533555206276991e-02   +4.271868041491888e-01   -3.771039605816769e-01   -5.877093693679271e-01   -3.189186485210943e-01   +4.448641230576367e-01   +5.254158512945903e-01   +6.694401795213216e-02; +5.910125740431149e-01   +3.785040869895454e-01   +2.760834070418353e-01   +1.036779096656967e-01   +2.900097818604464e-02   +2.490296537713702e-01   +5.200785890178630e-02   +1.962054226467741e-01   -3.792317501973166e-01; +1.963486512490125e-01   +1.980967710602031e-01   -5.621640063093176e-01   +6.104375916356125e-02   -1.875813665212472e-03   -5.607124107919867e-01   -5.985831384210712e-01   -1.853691932250397e-01   +5.385302704491434e-01; -1.884051838753734e-01   +4.054224845545137e-02   -3.748562219641477e-01   +2.952880709994897e-01   -3.190561951289524e-01   -9.192918763805463e-02   +3.710024267850232e-01   -6.084534695534218e-01   -4.274161279922419e-02];
L4_L1_iAMPA_netcon = [+5.167040673450479e-02   +2.578695375666605e-01   +2.875569904388000e-01   -2.198564474780574e-01   +3.439876929449459e-01   +1.011232801080380e-01   -2.432922315629988e-01   +2.182671074087170e-01   -2.136064411038867e-01   +2.977083637442426e-01   -5.241884783954371e-01   +1.345255538049585e-01; -1.231046838700050e-01   +3.495493105922194e-01   +2.294305043063289e-01   +1.492215426209691e-01   +1.898546397657263e-01   +2.638137797517134e-01   +6.357535068737691e-01   -2.691016884898463e-02   -5.350097785938753e-01   +1.973371807829171e-01   -2.001188290582372e-01   +8.941574178964432e-01; +3.243268622491104e-01   -3.836090577972335e-01   +3.562592355395064e-01   +4.841859390867416e-01   +5.370203332248857e-01   -5.246764857586358e-01   -1.587256771097361e-01   +3.765761626661390e-01   +4.330891206193552e-02   -4.416942391181752e-02   -2.703572748971962e-01   +1.536055567736131e-01; +2.695401036270170e-01   +1.224302407563660e-01   -1.917235675639791e-01   -2.548779778932223e-01   +7.555601759350611e-02   +6.320699202747367e-03   +7.080636937960172e-02   -9.778182428604454e-03   -2.509382612202370e-01   +2.874944337998285e-01   +8.317178284334539e-01   -4.853638683565475e-01; -1.063891787356707e-01   +1.310943586315621e-01   +3.123315155246324e-01   +4.414394437070088e-01   +7.364192658826960e-02   +1.078970789599257e-01   +2.110920823614471e-01   -2.793900750840981e-01   +3.440421029547521e-01   +1.507660390974153e-01   -5.657137423087238e-04   +1.451566530194954e-01; -3.636287252308795e-01   +6.222353933726866e-01   +2.500081182005486e-01   -5.316727544152193e-01   +3.335750431089448e-01   +2.521932003886174e-01   -1.437592862727214e-01   +1.582317731582634e-01   -3.393991571381917e-01   -3.011855103641180e-01   -6.431842464745063e-01   +4.204676261823542e-02; +7.824124960335746e-02   +4.760281498746720e-01   +2.745266801097573e-03   +1.098822088773417e-01   +7.087348684413002e-01   +2.142074172617691e-01   +8.392771567450374e-02   -1.522675724011886e-01   +7.166886199560256e-02   +5.539578947809629e-01   -4.193117687023157e-03   +2.584490699691087e-01; -1.951115215776649e-01   +8.320286632534744e-02   -2.153618288322052e-01   +2.077832263206772e-02   +1.873793581777439e-02   -1.249587444712274e-01   -2.697155049141414e-01   +2.567166043545098e-01   -5.839070460958776e-01   -5.059159950719574e-01   -9.543117075777774e-02   +1.630648723047078e-01; +5.446536327600039e-02   +5.369979635525943e-01   -1.137513915146379e-02   +1.623539018379205e-01   -1.950851878295315e-01   +5.667488746413839e-01   +4.552240469728495e-02   -2.414169811008893e-03   -1.342673568201290e-01   -7.873112263096055e-02   +4.557984166056385e-01   -6.248726788653566e-01];
L1_L3_iAMPA_netcon = [+2.508736597928764e-01   -5.736543944826079e-01   +6.577702451061958e-01   +1.627206009256371e-01   -3.042856699858902e-01   +3.766128382530187e-02   -1.060833398535157e-01   +3.681149838060283e-01   -2.926274362805834e-01; -3.214391866505412e-01   +1.693888435845100e-01   +2.554878217104544e-01   +3.730732000500737e-01   +5.067445969125370e-02   +3.998401144528008e-01   -2.479734831709518e-02   -9.006744135823946e-02   -2.336545514207811e-03; +1.692565576956911e-01   +3.709457718922082e-01   -1.424681581132163e-01   +3.081572729124909e-01   -7.102237193955506e-01   -2.138368852311673e-01   -2.839624983347111e-01   +1.219077850489585e-01   +4.788849457531325e-01; -2.528425074638421e-01   -1.057978840302979e-01   -3.737057651522723e-03   +8.579201541331424e-02   -4.992419166754117e-02   +2.750802091019481e-01   +1.883632431821888e-01   +6.797417781056866e-02   +4.281362761281129e-01; -4.104499425539749e-01   +6.009630581632336e-02   -4.935067228163455e-03   -6.305464902701208e-01   -8.128173413485124e-04   -5.728109940632591e-01   -6.929856576463500e-03   -4.639917387371870e-01   +2.924856273576991e-01; +5.961308499694870e-01   -7.758631898352969e-01   +2.177012261816168e-01   +7.228564610798811e-01   +4.215623037918978e-01   +4.407303836921297e-01   +4.685910213799701e-01   -5.666206054386249e-01   -6.201906359536928e-01];
L3_L1_iGABA_netcon = [+1.442022858017575e-01   -3.116862715233507e-01   -4.237781036154889e-02   +2.762188249509375e-01   -5.294762066292015e-01   -8.491041726345983e-02; +2.806224230431597e-01   +6.432951645815921e-01   -1.873800037925970e-01   +3.590157509315867e-01   +3.910109217687588e-01   -2.225868107373336e-01; -5.196924290060843e-01   +4.557123039567842e-02   -2.363409182345312e-01   -4.768751230044771e-01   +2.858515378063800e-01   +1.565330002137554e-01; +2.261902447850799e-01   -3.629534369808907e-01   +1.069739598251787e-01   -3.530622384435775e-01   +3.692491168509557e-02   -2.708427233436539e-01; -2.584278620909951e-01   +8.540412159121809e-01   -2.712312853228354e-01   +6.308754774051342e-02   +5.634613403708020e-01   +1.213547302582457e-01; +2.330722951261627e-01   -4.568757124464762e-02   -1.817501510361463e-01   -4.543657242913559e-01   +4.039111361417621e-01   +9.007253583109689e-01; +7.177326128153488e-02   +4.777721510730454e-01   +4.944075252441846e-01   +4.991696667159023e-01   +2.186589086534472e-01   +4.369810847190462e-01; +1.769214583423510e-01   -4.730451846669072e-01   +2.530087525400032e-02   -2.928160871930683e-01   +1.821977020599982e-01   +6.898434238912363e-01; -1.845806876494842e-01   -6.502409097184562e-01   +3.873887421715160e-01   +3.240834372145013e-01   +2.774608866707399e-01   -2.674510337692507e-02];
L5_Input1_iAMPA_netcon = [-1.198907828926868e-01   +2.440310752060041e-01   +5.582974152563250e-01   +2.040912009071369e-01   -1.173413413969390e-01   -2.144683109681268e-01];
L6_Input2_iAMPA_netcon = [+3.842201237296137e-01   -4.563252312350471e-02   +2.069592445706134e-01   -3.652362339278168e-01   -3.009822067178976e-01   +3.540912727923229e-02];
L5_L6_iAMPA_netcon = [-2.437504287093893e-01   -4.613329164206527e-01   -8.797092233232610e-02   -9.342352056573480e-02   -5.930424481199019e-02   +1.083227739522571e-02; -1.136226253938264e-01   +1.784902301531128e-01   +6.020819094266763e-01   +3.234820551795024e-01   +3.967003183068264e-01   +3.513238943662191e-01; -2.830652648393491e-01   +4.663307404420564e-01   +4.478983175262707e-01   +2.098547261478644e-01   +1.505039524765955e-01   -3.859762598397708e-01; -5.812664146141079e-01   +2.072856811804885e-01   -1.552829156442288e-01   +6.492397933014615e-02   -2.978350932632307e-02   -7.800764870706070e-02; +1.585817505716314e-01   +4.945468923430868e-01   -2.060250801337878e-01   -4.136694479981973e-01   +2.069108318320722e-01   +4.167906789520269e-01; +2.081756066882304e-01   +1.660706021737768e-02   +6.664962687702777e-01   +5.490184579884536e-01   +1.458673339832362e-01   -2.467309958210047e-01];
L4_L5_iGABA_netcon = [-2.229726055967043e-01   +1.904421190265080e-01   -1.248601829957720e-01   -9.793914080973784e-02   +5.954682747168809e-01   +1.429145749915088e-01   +2.026921502204413e-01   -5.894223434549328e-01   +1.386384603976945e-01   +7.056304870441366e-02   -5.825279121336227e-02   -7.869324169983875e-02; +2.142739281658133e-01   +8.328125668047423e-02   +1.460997817837681e-01   +5.194276054182014e-01   -2.049849016491631e-01   +1.784056044697462e-01   +7.004052493303938e-01   +1.491401869083749e-01   -8.085676193691185e-02   +1.393196356738172e-02   -7.115569792443696e-01   -9.651493825860950e-02; +4.027744280158632e-01   -5.189160079742941e-02   -4.230690589514888e-01   +5.739348106880010e-01   -4.366244645818966e-01   +5.734852811970066e-01   +3.062131335332179e-01   +1.856803292429044e-01   +6.064825222038331e-01   +4.456568931419592e-02   +1.245847276282174e-02   -6.921399270773202e-01; -5.809452322393356e-01   +4.986724000845991e-01   +1.266289709920453e-01   +1.000000000000000e+00   +1.423306679582652e-01   +2.165398396380357e-01   -8.532355756083587e-02   -9.919981792430942e-02   +3.792522762431150e-02   +8.272894404617356e-01   +2.104675694565029e-01   -2.813337563312110e-01; +2.378898032755113e-01   +5.604100284216527e-01   -1.196545719495407e-01   -2.842255352740644e-01   +1.674231124840674e-01   -2.223778079757764e-02   +2.338199046101536e-01   -2.782140403134637e-02   +1.306065176376220e-01   +3.176938323090996e-01   +4.377188156310651e-01   -2.181275926026232e-01; +8.648634132419730e-02   +1.046912177131101e-01   +7.372662007175042e-02   -5.753263331560312e-01   +3.898950427782959e-02   -4.091897421736166e-01   -1.340097994922947e-01   +4.672880589916850e-01   -2.479832838200950e-01   +2.172136461633295e-01   -1.994045414998343e-01   +4.926806339050220e-01];
L6_L4_iAMPA_netcon = [+4.256164048969596e-02   +6.590110213761105e-01   -3.585611984937668e-01   +4.409209564056634e-01   +2.541886467120025e-01   +4.034178494980437e-01; -1.758467998371608e-01   -3.172762064884707e-01   -7.812603821641428e-02   +5.197356529612324e-01   -3.060948653126706e-02   +7.152377269072888e-02; +3.580786881038692e-01   -3.391487554237453e-01   +1.204966573700421e-01   +5.457424474580950e-01   -3.842142532279120e-01   +9.166115297533663e-01; -1.620985099671714e-01   -1.346912273435539e-01   +5.820689735137257e-01   -3.701807782132602e-01   -7.317313123915770e-02   +1.711162060844912e-02; +2.512937087922057e-02   +3.151711104745281e-01   +7.012304898375732e-01   +5.696520014734769e-01   -2.053081632619922e-01   +5.885335714983763e-01; -8.778407259566433e-02   +4.350875629017716e-01   +1.724791847940577e-02   +6.936873598197149e-02   +2.923890566998173e-01   +7.934118913464057e-02; +5.372418436625426e-01   -4.176980796658909e-02   +6.306090105803416e-02   +9.246930459415265e-02   -8.461867048967869e-03   -7.371009969681562e-02; -4.258723992588877e-01   -1.539491415383786e-01   +1.114533255889602e-01   -8.291251779938240e-02   +2.069449225215716e-01   +3.938620763272453e-02; +2.500930708060795e-02   +1.825814237353316e-01   +6.102047155063303e-01   -3.738701082104828e-01   -1.290959162879876e-01   +3.494323796947100e-01; -1.690392885476933e-01   +1.144963789793415e-01   +7.624523546601197e-02   -5.466610581852973e-01   +6.471288598063828e-02   +1.554878888934829e-01; -4.659467342703671e-03   +2.454194763384498e-01   -2.431569258996744e-01   +1.549746294473465e-01   -7.740104980302799e-02   +1.366520850551607e-01; +8.563286281152220e-02   -1.334277010667130e-01   -1.450987276301260e-01   -1.133202401101632e-02   +8.742289172704621e-01   +2.836142419770971e-01];
L5_L4_iAMPA_netcon = [+4.294008418679025e-01   +3.812545561288920e-01   -1.061615265259203e-01   +1.313655857171935e-01   +3.183438839761524e-02   +5.177811993636231e-02; +9.986895063125655e-02   +1.633309908758761e-01   +6.434520909709815e-01   +2.882485672652773e-01   +1.623670137587231e-01   -1.660685964437991e-02; +3.937694550712771e-01   +7.370182893778902e-01   -5.575965730812100e-01   +4.135181956646354e-01   -2.751540470026075e-01   -3.330831237333420e-01; +3.273169882791489e-01   +1.329505812060528e-01   -2.344834133129516e-01   -1.248437153398226e-01   +7.167415548908579e-02   -9.294206263175364e-02; -4.732064719332394e-01   +4.462265653619810e-01   -6.347147100861417e-02   -9.807605020505283e-02   +3.470012311379165e-01   -9.145004486528982e-02; +2.069502656008299e-01   -1.932115689210793e-01   -1.368437120375698e-02   +2.002961608811755e-01   -5.289428373921707e-01   +8.216697023009611e-02; -1.248452763452779e-02   -1.337734910262557e-01   +2.788093521040375e-01   -1.208984704066305e-01   +1.617532605989556e-01   -1.999491129266178e-01; -4.632592606522463e-01   +8.391685245075631e-01   +3.623773964052583e-01   -7.356037231401627e-02   +1.157157935980888e-02   +3.072206681772332e-01; -2.465117097114859e-01   +2.326335993423634e-01   +1.769917519448141e-01   +1.057195299958917e-01   +1.762797136865153e-01   +1.539580141921486e-01; +1.368998535451467e-02   +1.631339422889792e-01   -6.859172924666798e-01   +3.688285587676807e-01   -6.408173055865645e-01   +9.129212240180133e-02; +2.754918293143731e-01   -2.407285686309925e-01   +1.214495632612258e-01   +1.793883330486747e-01   -5.871103531119498e-01   -1.331058202417003e-01; +2.185087881981634e-02   -3.436887587201732e-01   +3.443971702027804e-01   -1.506139122391544e-01   +2.046844307915819e-01   -7.523031314533493e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
