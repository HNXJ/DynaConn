function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.412257002862326e-02   +1.267911500581989e-01   -3.529513074612615e-02   +4.133631233715945e-02   +2.204621569504684e-01   +1.275912904562664e-02   +2.897084232393014e-02   -1.235737333038492e-01   -7.142817321337495e-02; -1.204362192731205e-02   -6.719955120026246e-02   -9.005091595233077e-02   +5.098315136125346e-02   +6.938951371842188e-02   +1.675115546727399e-01   +9.804242281436069e-02   +7.873332789127918e-02   +1.283240787152191e-01; +6.078353488220546e-02   -6.235069505290999e-02   +1.489171337508265e-01   +2.117824914331116e-02   +2.974753621898024e-02   -1.336479014559157e-01   +9.037951455177563e-02   -1.749886233693339e-02   -2.213434744630590e-02; +1.274108145882360e-01   -6.154848776758863e-02   +7.792068455175861e-02   -9.769520311002435e-02   -6.226158836565212e-03   +1.153735662466640e-02   -1.685765890458361e-02   +1.129664155512683e-01   +2.737568806525559e-02; -1.152064226379215e-02   +7.186872512865901e-02   +5.729172696392699e-02   +1.177117682075341e-02   +4.691322642322365e-02   -5.030597440409863e-02   -8.420729883387115e-03   +8.810925668250720e-02   +7.413793690269693e-02; +1.274497207251018e-01   -1.048614426634172e-01   +7.419132687214512e-02   +4.580619330304635e-02   -7.492584474123593e-02   +8.016109569495165e-02   -5.249813165794109e-02   +2.888840391957339e-02   +3.065037937028760e-02; +1.580199807821972e-01   +8.967813732967417e-02   +3.020269704127044e-03   +1.870192068585053e-01   -1.613375841885501e-02   +9.571962975477202e-02   -3.334553845960732e-02   +1.648629514090922e-01   +3.217234179035864e-02; +1.386611604214577e-01   +1.003286170700611e-01   +5.226842603929620e-02   +7.551662053071295e-02   -7.519173431790956e-02   +4.050249652702761e-02   +2.751917946593915e-02   +6.653527224060589e-02   -1.533047942604920e-02; +2.263001167815741e-01   -3.538764976695502e-03   +5.012156023583147e-02   -8.625112427132391e-02   +5.631578391183693e-02   +1.738816228204243e-02   +1.152478006442243e-01   -3.343592149391605e-02   -1.038191186620184e-02];
L1_L2_iAMPA_netcon = [+1.308771224619382e-01   +6.318809395496876e-02   +1.776002405890264e-01   +2.369936537600052e-02   +9.284479809883019e-02   +6.932953469557944e-02   +4.260151264903118e-02   -1.397862875076653e-02   -1.622369683189443e-02; -3.641813117823373e-02   -1.078040977923345e-03   -2.303010045122135e-02   +1.799732891571162e-02   +1.003836452593720e-01   -2.967237735135405e-02   +7.974376752758520e-03   +1.267457842726973e-01   -1.821263819924065e-02; -4.045532047817504e-02   +3.075900596306719e-02   +1.606280797732443e-01   -9.407871943749416e-02   +1.526392101213777e-01   +2.172469443408053e-02   +1.554991148658046e-01   +2.857601628347070e-02   -3.284980439983821e-02; +8.316880439545475e-02   +1.170486833684694e-01   -3.920652334489880e-02   +1.015606073742535e-01   +8.332252156480412e-02   +6.059161228199622e-02   -1.584884037159545e-01   -3.201102458145475e-02   -1.070713203315104e-01; +1.336561837312352e-02   -1.151808052930468e-01   +9.107946356256807e-02   +1.154868514342316e-02   +8.128104340498549e-02   +1.569762122672461e-01   +1.995891723775130e-01   +3.242093818420433e-02   +2.102026955210358e-01; +1.442367502073534e-01   -8.053598467759478e-02   +1.129201133862355e-01   +2.006081398937293e-01   +3.340971494262546e-03   -9.098177627494099e-02   +7.233062396678676e-02   +7.728390835003066e-02   +1.545049816073246e-01; +7.399025280856916e-02   +4.062922319101966e-02   +1.312101294107789e-01   -9.763394122347599e-02   +7.199506668201271e-02   +6.073552729960126e-02   -7.364496628129713e-02   +1.604256257291375e-02   +5.144164910688842e-02; +5.942458720611197e-02   +4.321427851798375e-02   +3.460476795100993e-02   +8.150619077412734e-02   +5.272798693066671e-02   +3.240597955079050e-02   +4.870560733841896e-02   +1.134664115376305e-01   -1.234185978853412e-01; -5.396490100826256e-02   +1.413820521807995e-01   +9.819020282147466e-02   -6.116722494852769e-03   +1.468564909726309e-01   -3.638828929762011e-02   +1.354496287623562e-01   +1.503638910845839e-01   +1.299190295576429e-01];
L2_L5_iAMPA_netcon = [-2.134285171758325e-02   +8.427387185877101e-02   -6.522174114112883e-02   -3.194197227690670e-02   +3.381083227362322e-03   +7.809635071906795e-02   +5.726163054386919e-02   -1.272675668360785e-01   -3.959775782218673e-02; +9.663897087035671e-02   +5.441424026869707e-02   +1.733039452712822e-01   -6.477288036065806e-02   +5.567137827064068e-02   +8.040511555292926e-02   +7.893950607120070e-02   -7.899448405564974e-02   +3.827226093570798e-02; +3.868049048107915e-03   +9.315916830152160e-02   -2.270493527083751e-03   +9.502659695247855e-02   +2.072465025555931e-01   -8.769943031480296e-03   +8.112800544504830e-03   +4.752824140512060e-02   +6.579796940644198e-02; +7.303282974832037e-02   +2.118802621667999e-01   +6.051052038633795e-02   +6.653039660267418e-02   -4.334683549327589e-02   +1.026191785556822e-01   +3.312509196755981e-03   +7.160506878636724e-02   +2.000490600027748e-02; +6.279433710943777e-02   -5.857329382405714e-02   +1.329640718252891e-01   +7.238819899050297e-02   +1.220745904146625e-01   +4.610248181721957e-02   +1.122234054881547e-01   -2.623920683801655e-02   +8.930213287983249e-02; +1.188697024033837e-01   -1.151129815401483e-01   -6.010186954060721e-02   +2.311635015231640e-02   +2.512134425562308e-02   +4.407663488449590e-02   -3.732867833616542e-02   -5.131439965316769e-02   +8.390192680544059e-02];
L5_L2_iGABA_netcon = [-1.917256689849651e-02   -1.542771725177540e-02   +1.831152817415387e-01   +2.939838550922081e-02   +2.190174448633478e-01   +7.456404064355075e-02; +7.959401754095076e-02   +1.210732354324247e-01   +1.621536535985307e-01   +6.430884135196287e-02   +7.899154699737115e-02   +1.618243474533740e-01; +9.100645505869352e-02   +1.394969333806333e-01   +2.508421493499844e-01   +7.537836946338003e-02   -7.987577482168673e-02   +4.757006946756788e-02; +8.990011977665600e-02   -9.326636205878532e-02   -8.774627133463497e-02   -1.660034893587389e-02   +3.152538960019103e-02   -4.414145544542436e-03; +8.562934452944919e-02   +1.508597412070220e-01   +1.722219085032923e-01   +7.383174959342925e-02   -2.015238303994839e-02   +1.275341628400679e-01; -1.504577111637241e-01   +1.040840884298030e-01   -2.047614003199077e-02   +1.258315876873883e-01   +3.107041328933993e-02   +3.188169949502734e-02; -7.557308098835812e-02   -8.383061152303858e-02   +3.095391993103547e-02   +8.215916309766579e-02   +1.183702591883653e-01   +1.189822967702771e-01; +2.694885897814021e-02   -4.136462173901574e-03   +2.068013323969406e-01   +2.696398525804571e-02   -4.950850932353068e-02   +2.383463909975982e-01; +1.111460909066881e-01   +9.650091531874749e-02   +4.658052206760437e-02   +3.516503926687535e-02   +7.123470561489052e-02   +5.364204025952963e-03];
L3_L2_iAMPA_netcon = [-1.565579252271191e-02   -9.427002206536994e-02   +9.577369231694928e-02   -2.007314702072482e-02   +6.320849340025424e-02   +1.434963526987204e-01; +9.477190148290268e-02   +7.671064437412548e-02   +3.092046525849127e-02   +5.654229914965712e-02   +5.102697426859829e-04   +5.939177712466613e-03; +3.707024481304794e-02   -1.130465868473919e-02   +1.048413922614018e-02   +1.381735611730960e-01   -2.115639857907949e-03   +9.811187264787639e-02; -2.075689222097532e-02   -1.167717403209046e-01   -3.846527561946304e-04   +5.449823574278700e-02   +4.967596977784421e-04   +5.204965861133618e-02; +1.837557358323444e-01   +4.085623400294303e-03   +6.374273276270467e-02   +4.782319658072560e-02   +2.458964204082466e-02   +1.587117653197921e-01; +8.011815519475074e-02   +1.567360870246989e-02   +5.779920529772037e-02   +1.926548183282081e-01   -3.789056077106196e-02   +3.346784471031233e-04; +1.767608806759733e-01   +3.548510536073017e-02   -3.228529903733671e-02   +9.077270317089536e-02   -2.041296851748474e-02   +6.299393861688821e-02; +4.572863050633400e-02   +1.187824402600907e-01   +1.288462383438721e-01   +7.202883981867556e-02   -1.091171438453900e-01   -2.655307403001692e-02; +1.498440807563936e-01   +6.282100857464078e-02   -1.337562038161958e-01   +1.039073025277914e-01   +2.072897658136146e-01   +4.840225386687998e-02];
L2_L3_iGABA_netcon = [-2.099838678185370e-01   +1.203491362295770e-01   +7.042360072826467e-02   -3.196736254967850e-02   +6.305818465781234e-02   +1.107298084703574e-01   +2.523904947319155e-02   +6.025900566372256e-02   +5.650968154894812e-02; +1.732268698467517e-01   -6.103066629009201e-02   +8.391455096836774e-03   -6.937585784066161e-02   -1.504705412354875e-02   +2.414212367062657e-01   -3.142356950510639e-02   -6.060356036212984e-02   -4.244226014300766e-02; +1.799112547001490e-02   +1.025368209122502e-01   +9.982259067766198e-02   +6.549754645263743e-02   +7.962692933906713e-02   +5.752184353213578e-02   +1.277121015084820e-01   -3.458239557016800e-02   +1.520906710276754e-01; +1.920154977290275e-02   -9.204103835733992e-03   +1.002536352249827e-02   +1.081550440094514e-01   +1.288253858755400e-01   +2.712278342798656e-03   +1.340819755923144e-01   +1.054815612540238e-01   +2.705431279954929e-02; +9.483378343028767e-02   -9.469033511152088e-02   +1.977372544293884e-02   +1.665250997042917e-01   +5.659355825636278e-02   +1.078789158062344e-01   +1.163707675208811e-01   -4.887069314972324e-02   +1.188818240008302e-01; +9.013340909581471e-02   -3.295941879151826e-02   -3.030307841736128e-02   +4.058833957655915e-02   +1.114046417201519e-01   +2.183753576054613e-01   -2.366720111788944e-02   +6.473103710707105e-04   -5.412155682166327e-02];
L1_L4_iGABA_netcon = [+1.622301079892411e-01   +7.793457961943119e-02   +8.996082535670080e-02   +4.152677411742367e-02   +9.996715624798064e-02   +2.196894136183931e-01   -6.205626208292649e-02   +5.528130614209555e-02   -7.618900583836978e-02; +3.070476767952608e-02   +5.289821261396280e-02   +1.089767064498823e-01   +1.397574548757117e-01   +7.253626134842221e-02   -3.426159680064404e-02   +5.635305749817265e-02   -3.860349167562405e-02   +6.420454003346482e-02; +1.234634240279521e-01   +1.173802482947830e-01   +1.102568230414934e-01   -3.454718255293079e-02   +1.455021591507149e-01   +1.085423130474075e-02   -2.872907778538153e-02   -9.985296926210808e-02   +4.975883209904440e-02; -1.639143822784208e-02   -4.341712945911348e-02   +3.978288717115588e-02   +3.992310125428651e-02   +1.737227113356301e-02   +1.402031209299482e-01   +6.473034490236769e-02   +4.962276605165811e-02   +1.092735238577027e-01; -6.674714236096102e-02   +1.412168449315296e-01   -3.524550011661660e-02   -1.125525244121392e-01   +1.019604678444310e-01   +2.278479019460086e-02   -3.737904775110885e-02   +1.801849616291745e-01   +6.428902804772674e-02; +4.486493442362086e-02   +1.627761707985854e-02   +8.585312637492384e-02   +1.260224178976880e-01   +7.455367285111963e-02   +7.923700640470263e-02   +5.440358132475819e-02   +1.895233362415858e-02   +3.291839139152288e-02; +8.420609523321347e-02   +1.470434229656416e-01   +3.960388485398647e-02   +1.163360596219576e-01   +9.697266853248179e-02   +3.798613937424048e-02   +1.965011855365102e-01   +1.775583467251420e-01   +4.312209046358335e-02; +1.130509854694579e-01   +1.658017249043677e-01   -1.286937796626948e-02   -5.355955539530919e-02   -1.383871436489657e-01   +1.737633018729499e-03   +7.040864652092887e-02   +8.622495738744901e-02   +1.358650325512702e-01; -2.050611465421518e-03   -1.388793936741717e-02   +7.696251673935262e-02   -4.753477281638780e-02   +5.380495998502772e-02   +3.561103188987683e-03   +8.495501753744973e-02   +1.312052643307813e-01   -4.002039700758525e-02; +1.702586123515233e-01   -9.475228722027666e-03   -1.142498429453871e-02   +4.271094211002442e-02   +8.714996197031603e-02   +7.661749885696068e-02   +1.198396709447180e-01   -2.068776765090426e-02   +1.175939801672705e-01; +6.583458353996016e-02   +2.558080610298660e-02   +1.096583789516695e-01   +4.703898961788761e-02   -2.106742588843177e-02   +4.364667909096220e-02   +1.749634896625003e-03   +5.789657720495414e-02   -3.434678210749531e-02; +1.701082918012963e-01   -4.612180768202466e-02   +1.233004774680405e-02   +1.329904784532705e-01   +7.068658224666882e-02   -9.371057159489705e-03   +1.135263966238146e-01   +1.111466801490679e-01   +1.512280404400929e-01];
L4_L1_iGABA_netcon = [-1.405916476473337e-02   -3.477792795964264e-02   -3.575879870492515e-02   -4.159279175229760e-02   +2.219106267173795e-02   +9.633740195606037e-03   +1.151267541718387e-01   -9.312796137270600e-02   +7.648089029525267e-02   +1.097444758085330e-01   +6.516820227077991e-02   +9.102059259440382e-02; +1.065859026667392e-01   +2.443325792708724e-02   -5.131541720890331e-02   +2.977677612069275e-02   -7.546579835844910e-02   +6.454390943319602e-02   +1.510895758713067e-01   +1.440469519777317e-02   -5.985416279986425e-02   +6.110633780953835e-02   +4.049908919303045e-02   +1.356084630758326e-01; +1.556162648664739e-02   +8.105506930897621e-02   +2.258619527697080e-02   +8.368871665688109e-02   +1.138414409790749e-01   +1.169440068413434e-01   +3.321591733049625e-02   +1.132455253628849e-01   +1.386898697090737e-01   -4.479760194244287e-02   -6.271346406510009e-02   +1.579856965880175e-01; -4.777157226818167e-02   +4.486079984436555e-02   +1.165497347986858e-01   +4.516142358788854e-02   +9.999434194121276e-02   +1.335241974883130e-02   +1.093618494809374e-01   +7.441773130436712e-02   +5.515015192598766e-02   +1.891933406857123e-01   +1.464669092357680e-01   +1.115686032745655e-01; +1.494128592780950e-01   +1.297395965661501e-01   +1.202380162213481e-01   -3.573210072468531e-02   +6.704733080102598e-02   +1.146607302689953e-01   -1.714680577431780e-01   +1.038569959916035e-01   -9.747252193756803e-02   +1.075733064101542e-01   +2.137155364483908e-02   +9.027840994370775e-02; +8.779604110368011e-02   -1.367431330883680e-02   -3.404452055850770e-02   +9.857425895433192e-02   -6.960101680376633e-02   +9.244855136985365e-02   -9.435381037901600e-02   +9.451277560420070e-02   +6.820957843142150e-02   +7.851645966956530e-02   +3.859461352016806e-03   -8.679686827452193e-02; -4.008590298808506e-02   -6.464999298817992e-02   +1.025982854216794e-01   +1.714607875698175e-01   -2.667155049023723e-04   +1.004862229815277e-01   +3.213741016088355e-03   -1.409531952672113e-01   -2.063698520385327e-02   +1.375017765494806e-01   -3.987010535175091e-02   +1.182762830828198e-02; +1.351436902773601e-01   -5.310575716418440e-03   +1.845516858723507e-01   -1.459566764938846e-02   -9.662448527607084e-02   +1.215153266894225e-01   +1.522591331904906e-01   +2.049802480971692e-01   +1.023548771281342e-01   +3.151385089872728e-02   +4.011971603498093e-02   -2.584149161185822e-04; +1.755283568804613e-01   +2.452686484020113e-02   +1.525001476521922e-01   +5.247768537161915e-02   +1.605901141974608e-01   -3.351657705398649e-02   -2.681144094542599e-02   +4.863163322356893e-02   +1.401893687660651e-01   -8.385085931830998e-02   +3.310703813215929e-02   +8.257595686196596e-02];
L1_L3_iAMPA_netcon = [+9.121147193942480e-02   +1.673214038431905e-01   +1.024186889251440e-01   +1.755080491197368e-01   -2.828887215883848e-04   +1.384309782527012e-01   +2.124950398806747e-01   +5.639185071712058e-02   +4.522968735341041e-02; +2.540118873696434e-01   +9.803548453058425e-02   +1.220400371446905e-01   +1.815154593585550e-01   +2.247266879808439e-02   -4.820973909367298e-03   +2.054360149348576e-01   +8.229077955184991e-02   +1.681420806948841e-01; +9.240252735570398e-02   +7.996744833559712e-02   +1.155184372153966e-01   +5.693279525008987e-03   +8.916114816262544e-02   +6.119534010871718e-02   +8.590243754756814e-02   +6.836153566906189e-02   +9.845018558076840e-02; +1.585829010088950e-01   -1.251246231943987e-01   -2.077133014828093e-02   -5.454333020175346e-02   -2.643563935871344e-02   +5.186534593149872e-02   +1.763883394795674e-02   +1.389611406765920e-01   +1.753223690662745e-01; +3.249141702809819e-02   +9.077003828557145e-02   -2.318716258091117e-02   -1.371055406181843e-01   -6.498375737853170e-02   +4.086395756812029e-02   -3.272519270460615e-02   +5.137051447758420e-02   +5.166875232901905e-02; +7.410642285224150e-02   +1.310472700029059e-01   +1.548338941929946e-02   -5.690081720708497e-02   +8.741114191240944e-03   +5.132154467076182e-02   -4.153205257726569e-02   -2.670434903422406e-04   +1.998306238304405e-01];
L3_L1_iGABA_netcon = [+9.037420752866998e-02   -1.800738926809346e-02   +8.539492430340542e-02   -1.887388347516090e-02   +7.001996762705111e-02   +5.691398762265876e-04; +1.490297485836563e-01   +1.223510879573152e-01   +9.629607997469798e-02   +2.002068142750051e-01   +3.662378329772536e-03   -3.457116883335563e-02; +7.342706882933622e-02   +2.821153175231421e-02   -4.809584223981726e-02   -5.499191369545546e-03   +1.121799707885901e-01   +9.489502939075873e-03; +9.499178697520398e-02   -1.012941229545023e-01   +6.588763136078220e-02   +5.159944090077405e-02   +1.603859436389115e-01   +9.554965003766014e-02; +8.657783017718990e-02   -5.785454181257380e-02   +2.714528510322315e-02   +3.465383166409772e-02   +5.888094092868539e-02   +7.538662585343989e-02; -9.866323435148643e-02   +3.502754737340621e-02   +3.913994510649361e-03   -4.437900745106212e-02   +3.989515365071011e-02   +2.016901648297936e-01; -1.071011462972092e-02   -2.874185647390833e-02   +1.276343555818470e-01   +7.836012732850374e-03   +5.674001520335167e-02   +9.502336471743691e-02; +5.029104689358993e-02   +1.011171849289195e-01   +4.573384160265415e-02   +3.731364446942704e-02   +2.493222004221990e-02   +1.574686024258878e-01; +5.600521529267668e-02   -3.589579136684326e-04   +2.042845678532425e-02   +6.969959394956483e-03   +9.892929988364008e-02   -1.265344528755202e-01];
L5_Input1_iAMPA_netcon = [+8.970551645998508e-03   -6.263005992561661e-02   -1.785583212471099e-02   -5.750587728956225e-02   -2.849576920309406e-03   +3.096431459761314e-02];
L6_Input2_iAMPA_netcon = [-2.230315027162900e-02   +6.124200211451426e-02   +4.924208347139414e-02   +7.683465093983821e-03   +1.012686765303332e-01   -1.004794579423962e-01];
L5_L6_iAMPA_netcon = [+8.022407199800215e-02   +1.078939103789950e-01   +6.355325463914753e-02   +5.985404301966807e-02   +1.146240910686497e-01   +7.257842090203848e-02; +1.065357034092433e-01   +1.354062988890075e-01   -6.811534030027810e-02   -1.169277159821625e-01   +1.015505361195264e-01   +5.247547079633246e-02; +3.978828896181238e-02   +2.921533466543270e-02   -8.678319872927037e-02   +1.630130938860753e-01   +1.254542174931746e-01   +1.036211239603358e-01; +4.140795599654803e-02   +1.815792218728866e-01   +6.018973384942627e-02   +2.578318152554676e-01   +7.534534296289731e-03   +4.179616521738742e-02; +8.287724341555235e-02   +1.845716320405487e-02   +9.218168334224164e-02   +1.485965681261552e-02   +1.009064340913769e-02   +1.131343107347952e-01; +2.202680648335024e-02   -1.354218621216213e-01   -5.542756698588996e-02   +1.072368122741130e-02   +9.111578702818686e-02   -3.112845044694128e-02];
L4_L5_iAMPA_netcon = [+8.744099063467356e-02   +1.145714858064201e-02   +1.563337412298820e-01   +1.483276501165163e-01   +6.567422844832241e-03   +3.011092942279534e-02   +1.339631797244701e-01   +2.118922290221474e-01   -2.742683978631698e-02   -6.695450441349454e-02   -8.832376513100210e-02   +3.039162556905539e-02; +1.316325483107250e-01   +1.120873794963407e-01   +2.907028348333444e-02   +1.009565863472759e-01   +1.425587453096626e-01   +4.154239295408137e-02   +1.027115909722454e-01   +7.905410290815648e-02   +6.107143312527839e-02   +1.028071858970766e-01   +5.317475251233027e-02   +1.944448036555449e-01; +8.098713680030492e-02   -5.733056464986715e-02   -1.132851229977786e-02   +7.493725193590181e-02   -8.526951061289340e-02   +4.873797427854777e-02   +2.247961104648593e-02   -1.437346543729006e-02   +5.728086788966694e-02   +2.997079067897861e-02   +9.488553648846057e-02   +7.091663454224563e-02; +1.122731558145717e-02   -1.002619568344830e-01   +1.461003466664230e-01   +8.838294535614031e-03   +4.912981127578142e-02   +2.445389716910539e-02   -7.506040455628775e-03   +1.297582040797836e-01   -4.893062214452417e-02   +2.795263026505738e-02   -2.880631107528622e-02   +6.337670393376379e-02; +6.302231088250436e-03   +1.345860265676557e-01   +1.881090373040590e-01   -1.431972902215088e-01   +1.323481203916235e-01   +1.072772197450813e-01   +4.672394987841187e-02   +6.624509381666085e-02   -1.976660593356773e-02   +8.197588037133802e-02   -1.254456159086612e-01   +1.668997320621938e-01; -1.096601237722130e-01   +5.025996597708374e-02   -7.536402844753529e-04   +1.092069043516273e-02   -1.161307622842686e-02   +1.134986317805537e-01   +1.575149109802189e-02   +5.473884542639679e-02   -4.782683400044908e-02   +1.133370972848806e-01   +1.454697133137258e-01   -3.275587948425041e-02];
L6_L4_iAMPA_netcon = [+2.647533337790383e-03   +5.599614957162588e-02   -1.711063723372561e-01   +1.525942806627993e-01   +1.678739663638217e-01   -4.410154373941880e-03; +3.880038026013109e-02   -5.026464180795907e-02   +5.210694773063774e-02   +3.404827178595383e-02   -8.416413252972016e-03   +9.264689969353002e-02; +4.654935909868571e-02   +4.715602331359520e-02   +7.659583664259675e-02   +1.250383571291333e-01   +7.571709943475141e-02   +1.436494468106401e-01; +1.135214792727594e-01   +1.020743359414073e-01   +2.122873641699448e-01   +1.537888954825099e-01   +4.443101639382696e-02   +1.736431708311650e-01; +7.880999249275708e-02   +2.213497775119943e-02   +2.662491968882767e-02   -4.904280285546884e-02   +2.822216269031712e-02   -8.148940252707505e-02; +3.280318502575923e-02   +7.005551196642296e-02   +1.931352571830997e-01   +1.324552098344751e-01   +1.426062607923215e-01   +1.010651566308656e-01; -4.576207555140797e-02   +1.177609943387832e-01   +3.491924255977202e-02   +9.672590333703582e-02   +7.183806227699981e-02   +7.257460409673887e-02; +3.337145769322991e-02   +5.942082137047161e-02   -1.005727565883834e-01   -6.176129600194328e-02   +8.744792995489457e-02   +3.852300938818549e-02; +4.042146539439719e-02   +8.904568587466875e-03   +5.756133809866006e-02   -7.165749615401429e-04   -4.509652205322714e-02   -4.355789077875959e-02; +1.849592883076068e-02   +1.866180106724163e-01   +1.878963486030321e-01   +2.818694648944992e-01   +2.225426868729198e-01   -1.242626923096725e-02; +1.847167341965687e-01   +4.805828470704152e-02   +1.340419556174628e-01   +1.939834285292414e-02   -3.892869226128283e-02   +1.187643536852989e-01; +1.275679549953409e-01   +9.998242336640108e-02   +7.921781089244508e-04   +7.697710662717007e-02   +7.401317762163956e-02   +8.530271858803623e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
