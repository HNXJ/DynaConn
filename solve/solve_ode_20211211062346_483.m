function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.096675698633815e-01   +3.636336720315045e-01   -5.821244149653746e-02   +4.078599455785982e-02   +4.087525839843839e-01   +6.192571660662920e-02   +9.274829775761785e-02   -2.215823306774831e-01   -2.344344610351995e-01; -2.228762117583784e-02   +6.039958969542823e-02   -1.038621052426255e-01   +5.286587517943422e-02   +1.120748612320154e-01   +2.990238092588834e-01   +1.268723766235505e-02   +3.445407041412814e-01   +3.075003141488836e-01; -2.915101098476196e-02   +4.515381247441611e-02   +3.080415372239045e-01   +1.102342871475908e-01   +1.098391460430859e-01   -2.133491820837778e-01   +9.818087439529631e-02   +7.994361932949098e-03   -3.748419657323716e-02; +1.876163065338675e-01   -7.172840608488908e-02   +3.065924490803029e-01   -1.904528880869550e-01   +1.120557917885742e-01   -1.244608520644582e-01   -1.249474698442653e-01   +1.444118593316719e-01   -1.117750340450691e-01; +9.357090910617344e-05   +6.253041881329746e-04   +2.417896634565107e-01   -2.457074323034637e-02   +8.351322444067139e-03   -2.052155819567891e-01   +4.545930513161565e-02   +3.407592708771467e-01   +6.614177358511031e-02; +2.008552310414123e-01   -7.707576001421680e-02   +3.224459722009223e-01   +1.560397249269839e-01   -1.147231076495324e-01   +2.556446316818095e-02   -5.071689971491575e-02   +2.215180828079379e-01   +2.862719642004378e-01; +2.311651482651120e-01   +2.882303263993611e-01   +5.882952425638939e-02   +3.020983639834500e-01   +2.432336006070474e-02   +2.722792585894015e-01   -5.837195974234997e-02   +3.780169142862085e-01   +9.619402682253350e-03; +3.537813691241237e-01   +1.501259431481467e-01   +5.338232490250641e-02   +1.454467185803557e-01   -6.886468165227311e-02   +3.560129877361484e-01   +8.641555144668447e-02   +6.460997504851375e-02   -9.203254372442171e-02; +5.344225833215829e-01   +7.732519480371924e-02   +3.164837273294139e-01   -2.606854641173008e-01   +2.997863743809766e-02   +6.939384255102501e-02   +2.956878006503392e-01   -8.593409486135428e-02   +1.581541827073346e-01];
L1_L2_iAMPA_netcon = [+3.168423566352009e-01   +2.892343030723039e-01   +3.163413558627552e-01   -9.121898674028459e-02   +3.683755323834405e-01   +3.142833002356678e-01   +5.616345002218312e-02   +4.561915370882446e-02   +9.944829568790489e-03; +4.896569196290119e-02   -8.651050109134864e-02   -1.188641085018856e-02   +6.504481487416948e-02   +3.494852751668348e-01   -7.838118807288488e-02   +6.421924532368359e-02   +3.425003586497660e-01   -1.404322501162483e-01; +3.614955078922150e-02   +2.320937438458147e-02   +2.993840383640390e-01   -1.006316128399252e-01   +3.551280609303540e-01   -7.807209798792346e-02   +2.151418636866088e-01   +1.521791128933868e-01   -9.551785255992154e-02; +2.007561954515553e-01   +3.625308551961792e-01   -1.031711756497144e-01   +1.683760597289121e-01   +3.002122782752876e-01   -1.992339338327525e-02   -2.804622584581411e-01   +1.277456794473456e-02   -2.233616492430286e-01; -1.118277376078599e-01   -1.999586539896485e-01   +1.468694465142468e-01   +1.365334870337557e-01   +1.368488510180522e-01   +3.738901698593510e-01   +4.636014718607556e-01   +4.933920907375211e-02   +4.543321080113857e-01; +2.030851159219091e-01   -1.293809260160220e-01   +3.020565979299681e-01   +2.298619263197311e-01   +1.369973419155872e-02   -8.144790719355043e-02   +1.704818162646526e-01   +3.237493076420826e-01   +1.891423324928999e-01; +1.760112442237322e-01   +1.720833037856687e-01   +3.723203488718680e-01   -2.364314300070111e-01   +8.500984225630226e-02   +1.855685916472084e-01   -3.977685829810135e-02   +4.738983818872559e-02   +1.430642340135774e-01; +2.343068656612222e-01   +1.478321042161684e-01   -4.783899873053238e-02   +3.769146036789184e-01   +1.470403617498255e-01   +1.257636254134692e-01   +2.203872375856612e-02   +3.241912553994595e-01   -1.201150636224437e-01; -8.885575439815192e-02   +2.125316869767946e-01   +6.145905764066881e-02   +2.107351513923880e-01   +4.015579790624760e-01   -2.196662300266022e-03   +2.544814176291809e-01   +2.574681779023770e-01   +2.752486192790959e-01];
L2_L5_iAMPA_netcon = [-1.451316680545367e-01   -8.802584381909624e-03   +1.535795624848525e-01   -7.916348915213334e-02   +9.714739774096387e-02   +1.970027538819521e-01   +2.216851918019627e-01   -1.932877360137856e-02   +1.317073442982421e-02; +3.862385575011006e-01   +1.654651471822597e-01   +3.924632884830500e-01   -5.659257308865200e-02   +2.221284403822210e-01   +4.234554070117913e-01   +2.867099995241914e-01   +7.775408158339805e-02   +2.897073556942928e-01; +6.389740932927052e-02   +1.935370476009883e-01   +6.063843320531861e-02   +2.807434507965915e-01   +3.351180941254188e-01   +5.834220568109104e-02   +1.039936640939321e-01   +1.495422923798477e-01   +1.719642740995625e-02; +7.817923743405596e-02   +3.723091855624512e-01   -5.039825425171986e-02   +8.614458395037530e-02   -1.514040414859802e-01   +2.388287226020912e-01   -1.741156924625246e-01   +1.770846528055876e-01   +1.194507095035199e-01; +7.856150976696852e-02   -1.872586206486875e-01   +2.538564363260333e-01   +8.617753222884569e-02   +2.005367463320102e-01   +2.927404750684456e-02   +3.143488541023781e-01   -6.744349613883593e-03   +1.860786015136136e-01; +1.352597780062709e-01   -2.054435709137027e-01   -1.701898370977815e-01   -8.551969451531455e-02   -5.424889388470840e-02   +2.218334178083871e-01   -2.601559397585787e-02   -6.620243964369685e-02   +3.507024881899437e-01];
L5_L2_iGABA_netcon = [-1.271331979440904e-01   +1.004953740031835e-01   +3.158134408041712e-01   +1.971757235956327e-01   +3.442451908562856e-01   +2.759977565616525e-01; +6.767795599361190e-02   +4.019420903217937e-01   +2.426829814211382e-01   +3.640455507917487e-02   +1.664070775602304e-01   +2.099942692150930e-01; +2.688069245035465e-01   +4.046831072775257e-01   +5.604349759325655e-01   +4.907859477573091e-02   -9.161729399351592e-02   +3.811413017889684e-02; +2.596646823892061e-01   -3.233580840916431e-01   -1.268786326163782e-02   -5.858247775595314e-03   +2.296054670319613e-01   -1.382600423260930e-01; +4.331921794822000e-02   +1.151571283637242e-01   +3.908623280581035e-01   +2.134541738151102e-01   -4.803922266121016e-02   +3.165273532022516e-01; -2.073731586533480e-01   +2.912114784815490e-01   -1.047481313804577e-02   +2.326880685845119e-01   +2.593372431737507e-01   -2.164149206988174e-02; -5.391503701552577e-02   -1.061111762666015e-01   +1.542609933528805e-01   +8.473345770309770e-02   +2.051376150592531e-01   +1.300280168001577e-01; +2.340003281148687e-01   +1.465043346266269e-01   +3.459935310432578e-01   -9.219433678040750e-02   +5.725847844026360e-02   +3.322570634549496e-01; +2.064526895834912e-01   +2.627930562314319e-01   +1.478732941481752e-01   +2.610253848551478e-02   +1.673176846689919e-01   +9.132344876164478e-03];
L3_L2_iAMPA_netcon = [+9.103215956297991e-02   -1.433768248384989e-01   +2.297169004210905e-01   +6.770665082569155e-02   +2.759171687870409e-01   +4.200613671849334e-01; +8.281884090778557e-02   +9.247441273883443e-02   +9.413637623860299e-02   +9.320587783134057e-02   +1.107859148009135e-01   +1.092939424559551e-01; +4.651082198758073e-02   +7.553525027843119e-02   +7.489969506487391e-02   +2.737200183936799e-01   +6.917516311433444e-02   +2.047661790874600e-01; +1.093266347316671e-01   -1.783690412807240e-01   +2.103455365668759e-01   +2.404364612558866e-01   +2.095200272667783e-01   +1.764076170576445e-04; +4.172755624923766e-01   -3.093102904025214e-02   +1.419948661257840e-01   +2.338515081780753e-01   +1.668620937797692e-01   +3.509093884343772e-01; +2.501330353116871e-01   -1.891506906412835e-01   +1.980666961821997e-01   +2.346413480003078e-01   +6.242830188318032e-02   +6.331039300495381e-02; +3.961654163552364e-01   +1.165531542846077e-01   -5.808404077890600e-02   +1.903761841053164e-01   -1.358292824555504e-01   +1.913043398367631e-01; +6.744355125364221e-02   +2.022726674426222e-01   +1.543398662271862e-01   +2.483267662771565e-01   -2.289201692183193e-01   -6.729771314292876e-02; +4.614588501988439e-01   +9.975884300167891e-02   -1.901491363881007e-01   -1.517824420857843e-03   +4.456004459487098e-01   +1.379291907547262e-01];
L2_L3_iGABA_netcon = [-3.289657477020634e-01   +3.084451371698186e-01   +2.562585761344334e-01   -1.733842139990587e-01   +4.237238624156585e-02   +2.992479445705720e-01   +2.050414566733581e-01   +8.263311294522166e-02   +4.481093167849816e-02; +3.410316180110540e-01   -3.610010990363309e-02   +9.865173738893668e-02   -5.541616759631869e-02   +2.327758367149156e-02   +3.629843854013742e-01   -9.745934731945002e-03   +1.231855952775680e-02   -2.119076558879517e-01; +1.514475415954313e-01   +2.245572394627302e-01   +2.697458099141183e-01   +2.516891356294990e-01   +2.200230259777977e-01   +1.415674974009136e-01   +2.517543651101501e-01   -3.567414526839777e-02   +2.898232399742514e-01; +1.162912335139040e-01   +2.236870758639931e-03   -1.004809962788304e-02   +3.427636719568961e-01   +1.805096280692709e-01   -7.517464253114330e-02   +2.932894741243712e-01   +2.413242018128263e-01   +3.763077675952002e-02; +1.318494759059231e-01   -8.111189173238609e-02   +6.193668794248906e-02   +3.082124397744803e-01   +2.571456319201793e-01   +1.701280076585550e-02   +2.171763038062077e-01   +6.484152335102328e-02   +2.897496638749077e-01; +1.014006293745067e-01   -2.114993966524522e-01   +1.638932877170960e-01   +1.200171384534492e-01   +3.987058762115341e-01   +4.017865366421623e-01   +9.400231935538279e-02   -2.641361655426390e-02   -1.950205128388096e-01];
L1_L4_iGABA_netcon = [+1.722343985591289e-01   +1.327699294966516e-01   +1.287644882684038e-01   +1.177916628892215e-01   +9.741740868216178e-02   +3.026251969300554e-01   +6.313712401537656e-02   +8.983908618169947e-02   -2.243296522435328e-01; -1.693412270334797e-02   +2.604221471480673e-01   +3.320270425958056e-01   +2.648125646662660e-01   +2.894393169525425e-01   -1.620895956409605e-02   +2.836469114226890e-02   +9.675677474504256e-03   +1.406357986845250e-01; +1.793057558794078e-01   +2.737524989808091e-01   +1.867530109098914e-01   +5.743938281669905e-02   +2.956865684660192e-01   +9.808642192829095e-02   +2.334463799090029e-03   -1.191844753610953e-01   +2.662065107607898e-01; +4.378784213465665e-03   -1.420463539637084e-01   +1.201506982576956e-01   +1.748811470284863e-01   +1.317138929589027e-01   +2.858930686355237e-01   +1.943163786334356e-01   +1.806668365696237e-01   +2.157857751656911e-01; -1.262053846369016e-01   +3.324851954373589e-01   -9.691244908710782e-02   -2.923130888577468e-01   +2.134080673468237e-01   +7.989729707194455e-02   +3.373878866584248e-02   +2.966713617512926e-01   +1.546801462641927e-01; -1.081137849468177e-02   -3.202715350852602e-02   +1.802811939036458e-01   +1.261177404812168e-01   +9.960185178285641e-02   +5.536854999277893e-02   +1.576408491602312e-01   +6.957591079691111e-02   +1.213943394372768e-01; +3.011067916409627e-01   +2.241479668125670e-01   +2.543636324261526e-01   +2.490733970968636e-01   +2.673567012657805e-01   +7.398601757625570e-02   +3.358536222340743e-01   +2.682147783113072e-01   +1.607044856954978e-01; +1.508459979395698e-01   +2.906069032002022e-01   -1.049543714828929e-02   -2.129832642716322e-01   -1.563670351099818e-01   +1.416117245760107e-01   +2.159722664121298e-01   +2.743036580323804e-01   +2.877391447167522e-01; +8.018379238262398e-02   -2.817579316430000e-02   +5.581265801819014e-02   -7.509030372937678e-02   +3.311956858256010e-01   +3.507795145379652e-02   +2.099931841271997e-01   +3.527943765499490e-01   -2.286325319531132e-01; +4.466379712013656e-01   +6.550335679490586e-02   -3.976615384203176e-02   +1.022498390140731e-01   +2.049930141224169e-01   +2.295244605500349e-01   +1.784219577874827e-01   +2.503736975373417e-02   +4.305318918759206e-01; +1.006306568909893e-01   -1.239143198218989e-02   +2.279385332162305e-01   +2.746373202288679e-01   -8.941069207542521e-03   -3.541470813388904e-02   -6.481206626106373e-02   +2.814435491639007e-01   -3.035690340027888e-02; +3.939394510360336e-01   -7.031592923719415e-03   +1.432315586915592e-02   +3.210504950145914e-01   +1.349779034663853e-01   +1.032631273556803e-01   +2.336085251955905e-01   +2.811949760902894e-01   +2.994407011025866e-01];
L4_L1_iGABA_netcon = [+7.384653423691166e-02   -7.721035411014479e-02   -1.682181061727529e-01   -5.772537721742327e-02   +1.659320354067405e-01   +1.814149645815257e-01   +2.529849724945333e-01   -1.205189665547493e-02   +2.226030133634102e-01   +1.677624088464871e-01   +2.914278299987333e-01   +3.592681862454890e-01; +1.750693027020920e-01   +2.115086937308892e-01   +7.653167087607975e-02   +2.191139030339360e-01   -1.375642020125671e-01   -3.883272244629769e-02   +3.746941646306792e-01   +7.280036678502927e-02   +2.431462943997917e-02   +6.022660894266847e-02   +1.654312733781397e-01   +1.924162309816931e-01; +1.938534786720001e-01   +4.079110750897363e-02   +2.488247079267923e-02   +3.583429190441974e-02   +2.579620406657042e-01   +2.310571426042500e-01   +1.195942298266463e-01   +3.086951281675218e-01   +1.611893662005889e-01   +2.929912845061979e-02   -1.338763541368864e-01   +4.106550511157697e-01; +1.148611585864667e-02   +2.229644606537745e-02   +1.905741216886512e-01   +1.537727068440546e-01   +4.007341332530234e-01   +6.439863016549074e-02   +3.022771354166823e-01   +1.948648687473358e-01   +1.587139439660245e-01   +4.456039278662171e-01   +3.398382562162663e-01   +1.374800021449225e-01; +2.671496629482346e-01   +1.350920502848221e-01   +1.541576050354990e-01   -3.102542057389372e-02   +2.050066642814783e-01   +1.905270877359105e-01   -2.308795905032497e-01   +1.246882202417737e-01   -2.332363707107788e-01   +3.799279259204067e-01   +8.524711239744326e-03   +1.779426142327286e-01; +3.005623215993375e-01   +6.609858363953619e-02   -1.308935734781055e-01   +1.361488104904866e-01   -1.570039484646343e-01   +3.336020029506968e-01   -4.176940332236634e-02   +1.783083438748161e-01   +1.054407415290751e-01   +2.425362061791046e-01   +7.213891719996625e-02   -2.130826505836625e-01; -5.467176494192765e-03   +7.565759195263588e-02   +2.628632627071245e-01   +1.969421154304758e-01   -1.025069465444140e-01   +1.575216563903417e-01   +5.515661575361389e-02   -8.202802396589902e-02   -2.942740533985100e-03   +2.515108486238504e-01   -5.194825096979847e-02   +7.640104561145590e-02; +2.607117062558348e-01   -7.510674971307889e-02   +3.822853217709618e-01   +1.273649079000844e-01   -3.404420204297989e-02   +3.078664130585593e-01   +2.507299954277443e-01   +4.235344097967802e-01   +2.198099054039009e-01   +1.998722635044585e-01   +4.049773771128383e-02   +8.377092587841882e-02; +2.988274371544983e-01   +2.539722096437397e-01   +3.993990698801598e-01   +5.598935127615466e-02   +3.600122688290381e-01   -9.123817866489689e-02   +8.775310407975112e-02   +3.204024733984356e-02   +3.659710994569925e-01   -2.210881909322907e-01   +5.187902308093637e-02   +2.113518193382661e-02];
L1_L3_iAMPA_netcon = [-2.555299579714880e-02   +2.616727605166866e-01   +2.963705456510846e-01   +3.580975387443507e-01   +2.960235322638350e-02   +2.331798063660492e-01   +3.785241295196783e-01   +2.642407557425945e-01   +3.180348534343228e-01; +5.159126485625680e-01   +3.542528333916568e-01   +2.432400902822967e-01   +4.055687275764132e-01   -7.609371587105021e-03   +9.161511712149419e-02   +3.020473529825819e-01   +8.388075974790675e-02   +4.658358341163503e-01; +2.029612682490322e-01   +1.669303249356218e-01   +1.675283038698230e-01   +3.789990549057004e-02   +1.036998135120672e-01   +1.216809789703800e-01   +3.473617047890071e-01   +2.230419686033901e-01   +2.376621214946553e-01; +4.694395315693125e-01   -2.864237575938940e-01   +3.065355724419891e-03   -9.957019034538417e-02   -6.429713969724575e-02   +3.293345716522031e-01   -1.028286006096570e-01   +2.708017605077929e-01   +2.241717958328821e-01; +1.418819215862505e-01   +3.166663837454961e-01   +4.024598089601937e-02   -1.456444332957818e-01   -2.234917251044225e-01   +1.186869026232805e-01   +8.068811998052790e-02   +1.474588534379715e-01   +1.384085109830600e-01; +2.752051505430568e-01   +3.724496014497329e-01   +1.319726156405432e-01   +4.373753045003702e-02   +5.492143121874942e-02   +5.001077870993030e-02   +7.698078312591193e-02   -2.048366162724043e-01   +4.193895753704172e-01];
L3_L1_iGABA_netcon = [+1.813888806108061e-01   +1.022302579627287e-01   +1.491159954739768e-01   +4.216814059430578e-02   +2.184118714161361e-01   -3.620341889290851e-02; +3.390914363440298e-01   +2.827447576600794e-01   +1.848455005445270e-01   +3.541290089822179e-01   -5.719246008987844e-02   +3.419455958521508e-02; +2.509306382517783e-01   +1.385620445257283e-01   -7.129081622556041e-02   +1.381092655598465e-01   +2.850925461196485e-01   +1.699195081312750e-01; +1.359726533888100e-01   -3.551604510251717e-02   +6.869358411427788e-02   +9.213135856009524e-02   +1.618247694274261e-01   +3.217310621089253e-01; +1.087049484840162e-01   -5.834927234012208e-02   +3.752918900831210e-01   +1.850407543102962e-01   +1.000970554183288e-01   +1.715650712496158e-01; -5.185843894619548e-02   +1.821735705838901e-01   +5.718659351662873e-02   +7.136714324765639e-02   +5.787562219380351e-02   +3.375752576505605e-01; +4.097280736206108e-02   -1.644410285164115e-02   +2.520568732702265e-01   -6.042036233840810e-02   +1.913081905360380e-01   +3.122695733858599e-01; +6.027375087164225e-02   +2.652663922525369e-01   +2.111087201610838e-01   +2.287209377400399e-01   +2.545200365178524e-02   +1.556425524266866e-01; +2.258377968194781e-01   -1.842024614828880e-02   +5.820353423673525e-02   +1.283510362387356e-01   +1.295853753063883e-01   -2.233888713045324e-01];
L5_Input1_iAMPA_netcon = [+4.129208465937065e-02   -7.876823501542432e-02   -8.655528075201652e-02   -1.975240769100787e-01   +1.700915930178988e-01   +1.249491746056720e-01];
L6_Input2_iAMPA_netcon = [-7.896300700908316e-03   +5.093520458153473e-02   +1.140807667580546e-01   -1.526758410953502e-02   +2.135482385175241e-01   -1.457143324002620e-01];
L5_L6_iAMPA_netcon = [+2.362012372734215e-01   +1.781768040249010e-01   +8.066669219649686e-02   +2.365955786964019e-02   +9.897538131203470e-02   +1.159190225813240e-01; +1.995555914685112e-01   +4.214620703555981e-01   -9.724806350466761e-02   -1.341400693977376e-01   +2.248150401487176e-01   +2.145456259474117e-01; +1.242364523093302e-01   +9.996437653205544e-02   -2.556021238918034e-01   +4.386807992299511e-01   +2.301292254543207e-01   +2.062882458842060e-01; +1.243103117661827e-01   +4.258966663278605e-01   +1.942066132929022e-01   +4.370044461811031e-01   +1.276862346683048e-01   +1.034710557766195e-01; +1.549721086701427e-01   +8.010688031158802e-02   +2.099518960972961e-01   +8.930875479689952e-02   +9.347070418060373e-02   +2.576981337052051e-01; +2.390675729467590e-01   -1.220443181869824e-01   +1.043602493557051e-02   +1.167944479854323e-01   +2.038530786083235e-01   +3.725925133277931e-02];
L4_L5_iAMPA_netcon = [+2.299726409431034e-01   +1.682501650322811e-01   +3.267819700062142e-01   +3.920335071079452e-01   +1.564576601740039e-01   +5.443079393699701e-02   +2.766307802133828e-01   +4.093527799445784e-01   -1.092405401979159e-01   +1.159222572380977e-01   -1.617676919439157e-01   +2.102349375690657e-01; +3.900040782011481e-01   +3.306485998115906e-01   +1.341147263305335e-01   +8.705696439472725e-02   +2.234324159346414e-01   +1.872797449306546e-01   +2.811030204658432e-01   +3.315486308371221e-01   +1.069994802355110e-01   +2.742674123184531e-01   +1.295012838058281e-01   +3.172623783559019e-01; +1.946988807396836e-01   -1.934997307340544e-01   +1.425839153544477e-01   +2.224974307228838e-01   -1.001257353523750e-01   +1.904957460211410e-01   -5.111516343351040e-02   -4.971249112453373e-02   -1.488840363339292e-02   +8.249135383786908e-02   +2.607832633293294e-01   +1.870592366088225e-01; +5.943996711968542e-02   -2.398948548053907e-01   +2.828642194037511e-01   +2.219449951498785e-02   +2.403956566831391e-01   +1.964183985154561e-01   +6.462850782353020e-02   +3.629668974004686e-01   -1.544779276995401e-01   +3.590444960187189e-02   +2.703750059250234e-02   +1.449334525791668e-01; -1.993800231723106e-02   +4.590783902135072e-01   +3.219867750964880e-01   -2.907805136086958e-01   +3.106021195869337e-01   +3.361670169690513e-01   +1.552045431962165e-02   +2.739787698622926e-01   +8.614389162735721e-03   +3.264188099501715e-01   -1.371690849161263e-01   +4.638002000629694e-01; -1.871849248236427e-01   +1.436485927000422e-01   +6.231143331632493e-02   -3.677624885481526e-03   +3.183900559604970e-02   +3.285003247952609e-01   +5.872340241799597e-02   +8.494997803585236e-02   -9.833951363384337e-02   +1.889629291155151e-01   +3.726504121134356e-01   +1.758852374163377e-02];
L6_L4_iAMPA_netcon = [+1.377470248360944e-01   +6.031676803019834e-02   -2.721965047706241e-01   +3.156014708916710e-01   +3.619724842333755e-01   +3.078974324381608e-02; +1.192769801825084e-01   -5.898442693619645e-02   +3.111033434710794e-03   +1.641722168200879e-01   +1.128258208312422e-01   +3.189336816291801e-01; +1.013432329630326e-01   +1.823405656580348e-02   +2.383048055827822e-01   +5.787808490262154e-02   +1.438494364989255e-01   +3.075586384676335e-01; +2.041637258848359e-01   +2.405061349090445e-01   +4.108359835811828e-01   +3.178403329054093e-01   +2.677884039864170e-01   +3.192548657874949e-01; +9.900910662903520e-02   +1.993734304876044e-01   +2.971254010639852e-01   +6.609247716995020e-02   +1.696145977321811e-01   +1.722513752473447e-02; +7.334260217908418e-02   +1.601852225007808e-01   +2.332978267907592e-01   +2.472441303028575e-01   +2.488962549581408e-01   +2.056054487401422e-01; +1.008322682728457e-01   +3.190968587012716e-01   +1.999719123634124e-01   +2.561969590337034e-01   +9.054813601429011e-02   +1.419134940513866e-01; -3.149802201365340e-02   +2.233064495964079e-01   -1.666733614848272e-02   -1.605518920275688e-01   +4.170620229924413e-02   +2.822269817917728e-02; +2.870932012855444e-01   -2.225443378379645e-01   +1.397241779112274e-01   -2.206097099962674e-03   +3.255689207863943e-02   +1.478507986970335e-02; +1.158650247942577e-01   +2.963363888276054e-01   +3.539353838190434e-01   +5.976716127224314e-01   +4.214428655977680e-01   -6.215476856574356e-02; +3.625594729488648e-01   +5.862672595148920e-02   +2.814044011681704e-01   -1.261009088799958e-02   -4.141625013934866e-02   +2.532582693379102e-01; +3.366595555818414e-01   +1.729159412477811e-01   -1.436199675282743e-02   +3.333062832462050e-01   +1.617151330392007e-01   +1.051239137545912e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
