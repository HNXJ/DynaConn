function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.384255789764762e-02   +1.259060946827769e-02   -5.020917060091897e-02   +2.972282961066115e-02   +1.693091220655196e-03   +9.741305290361293e-02   -4.745062513547932e-02   -4.141273011973603e-03   -4.265169655418891e-02; +1.512572397766546e-01   -4.537627248109005e-03   -9.841555730248534e-02   +1.069455656340035e-01   -6.663410445635426e-02   -8.571142196537532e-02   -5.756576916260125e-02   +1.559547417597513e-02   -2.019651347408274e-02; +5.201720410012775e-02   +1.606299894470317e-02   -5.161824755178387e-02   -1.028431845515276e-02   -8.390918398369680e-02   +3.587396911282979e-02   -5.263762261041870e-02   -3.742287816196146e-02   +7.128867488406830e-02; -2.522281840447180e-02   -6.186249556539440e-02   -8.323926442300802e-02   +1.390479588256520e-02   -5.016050889449856e-02   -9.024096408546685e-03   +1.033820923161733e-02   +8.148945134943044e-03   -1.596722561050347e-02; -1.763781608057935e-02   -3.568823090194236e-02   -7.535366569756254e-02   -9.468611858575604e-02   -6.624516519896022e-02   -2.161442091030998e-03   +7.167605129388072e-02   +5.089780503155627e-02   -4.628910172942097e-02; -6.153404381117945e-03   -7.004426991284398e-03   +2.785868666206898e-02   -1.580611424198537e-02   -6.196313163189986e-02   -7.269815752994443e-02   -4.498137156841148e-02   -1.571918262805817e-02   -6.011004105312648e-03; +1.194174064700143e-01   +1.357865383142581e-01   +2.546167070295150e-02   +4.916608185414113e-02   +5.241731550510795e-02   +3.186869697759585e-02   -1.034732125520029e-01   +3.842353220717293e-02   +1.755540517909788e-02; +1.067122114943407e-01   -1.044121029241050e-01   -1.539818283239034e-02   +1.052248328056103e-01   +1.943024262062777e-02   -8.828091621733179e-02   +2.311463033257590e-02   +5.394348282933997e-02   +2.629221383356320e-02; -3.478271814687187e-02   +2.426587597255879e-02   -6.817481033245724e-03   +1.293401391031062e-02   -1.146981109512363e-01   +1.001998603260089e-01   +1.083400284949542e-01   +5.804199119588777e-02   -6.344186625871506e-02];
L1_L2_iAMPA_netcon = [-5.824286971079721e-02   +4.511968833193960e-03   -8.321310895218545e-02   +4.175058954446417e-02   -7.976446709309254e-02   -4.950340824886790e-02   -2.153282300572372e-03   +8.115241602627048e-02   -3.497082385122928e-02; -5.199434472782336e-02   +5.300762784265230e-02   -2.770643885591732e-02   -5.458502560629269e-02   -4.032566867234950e-02   -1.872003448949172e-02   +6.619579936906861e-03   +4.549277473104757e-02   +5.532331236377418e-02; -3.007447457300995e-02   -8.568791431690460e-02   +2.365022613628864e-03   -1.443541648422373e-02   +3.851617247465964e-03   +8.722668457664856e-02   +1.279063979129273e-01   -9.702134681590149e-02   -2.605874402391965e-02; -8.789457746255773e-02   +6.525827160262834e-02   +1.053883515937646e-01   +1.634732419660107e-02   -6.939771989072198e-02   +6.821204687769540e-02   -5.455980016467011e-02   +2.936930729601225e-02   -9.678495733940998e-02; -1.192949282247779e-02   -1.299742795174669e-02   -3.865165439932188e-03   +1.603910448376300e-02   +1.607420961164434e-02   -7.261347445832844e-02   -6.941994845950497e-02   +1.159372840640804e-02   +8.587629958786627e-02; +4.161566128682746e-02   -5.562880629280757e-02   +4.021789039424453e-02   +1.088092922501487e-02   -6.123314400143875e-02   +1.185071418645400e-01   +1.421723085522604e-02   +2.089988026746273e-02   +2.695034842087432e-02; +3.589385495810710e-02   +1.225623805148483e-01   -1.068028713820296e-01   +3.817912840073097e-03   -1.816545721965664e-02   -1.994830217993376e-02   -4.600192263119389e-02   +9.448937355022231e-03   +4.998945483732425e-02; -5.087690030055284e-03   -2.701210490672392e-02   -5.569710375298047e-02   -4.413726522425622e-02   -2.902828316768795e-04   +3.204957671602955e-03   -9.662484108799591e-02   +8.234457838411235e-02   -6.021261899525687e-02; +2.707750140934694e-02   -7.221181528331792e-03   +3.531236986785040e-02   +6.689355908008339e-02   -2.141412386439780e-02   +2.294575913564006e-02   -2.840275999644818e-03   +2.904743676156310e-02   -1.033913190313432e-02];
L2_L5_iAMPA_netcon = [-1.309823189549829e-02   -6.287638478314504e-02   +8.558620117251657e-03   -1.242363165941048e-02   +1.755098168327537e-02   -1.150493673201039e-01   -2.771077930579929e-03   -7.077263381981774e-02   +1.147916439607418e-01; -6.104739089945423e-02   -1.157329808548449e-01   +1.089955597143569e-01   +1.122682873967997e-01   +1.369300848050598e-02   -1.584089280852180e-02   -5.835734365538907e-02   +1.459089809872292e-01   +1.369092564579446e-02; +1.618566913642976e-01   -5.621913621375453e-02   +5.828982142880524e-02   +1.345101892141880e-02   -3.066847548032672e-03   +2.970911466370538e-02   -7.480462369902682e-04   -1.352704719357467e-02   +2.583973934350620e-02; -9.563574603579879e-03   +8.411423154375391e-02   +1.081528368650594e-02   +8.143759202037021e-02   +1.022108689377001e-01   -3.658263538054624e-02   -2.812023781494213e-03   -5.594422955937296e-02   +8.717249414955386e-03; +1.032026703545256e-02   -3.142412829288861e-02   +2.297427277744941e-02   -1.087520532855123e-03   +2.372576898987996e-02   +3.295524465106131e-02   +5.707718492549230e-02   +5.916197681871121e-02   +1.129058239044890e-03; +2.808004936077788e-03   -1.615187669190584e-02   +4.144784439939602e-03   +5.102355397819759e-02   +3.146469048704261e-02   -1.086825593103576e-03   +3.194164940403595e-02   +2.037414647734699e-02   +6.537213581731653e-02];
L5_L2_iGABA_netcon = [-2.758623771460297e-02   -5.956277712688562e-02   -2.816790562682305e-02   -1.232381993349452e-03   -4.569632216169833e-02   +2.947278355682099e-02; +2.707159118039600e-03   -1.666915471834758e-03   +9.661162619266754e-02   +5.156201957987388e-02   -1.359800773000866e-02   -6.756826710306041e-02; +3.985465656623909e-02   -5.093778911057763e-03   +1.080861251199774e-01   +1.158073279781703e-01   +7.052872981684090e-04   -7.037766704318504e-03; +3.047039176098675e-02   +1.234403319004570e-01   -2.237886464307874e-02   -9.010440372996496e-03   +4.665154625804671e-02   +8.808691526130238e-02; +3.554570620817750e-02   -9.951321366741835e-02   -5.885830938457418e-03   -1.993536870068364e-02   -6.355618470327583e-02   -5.498917252733667e-02; -8.771431155685416e-02   -1.960730521162301e-02   +4.444260948248618e-02   -3.606761567295187e-02   -2.686871920247164e-02   +4.050131658230922e-02; +1.238925635512953e-02   -3.373430267042610e-02   +1.615429266265940e-02   -1.750919526855009e-02   +4.360250647877264e-04   +4.154031290387476e-02; +6.791818806304323e-02   -4.782069541963037e-02   +4.048171083513065e-02   +1.136941663807996e-02   +6.159708019527392e-02   +1.467024794817027e-02; +6.917543859567997e-02   -4.703860155186396e-02   +7.734922879687484e-04   -3.093670940953399e-02   +1.820393883096655e-02   +5.735699646190446e-02];
L3_L2_iAMPA_netcon = [+7.234047145008526e-02   -7.975578002596292e-03   +6.748386077276604e-02   +7.001641788174508e-02   -5.668810403321112e-02   -7.540943295417239e-02; +2.607881549675921e-02   -2.511692236938787e-02   -5.936211470552362e-02   +2.237394447742749e-02   +8.135012481521742e-02   -4.207654646125014e-02; -2.647711589497941e-02   +1.222363924048187e-01   -8.176763304631239e-02   -1.882167558088052e-02   -1.690094573230036e-03   -1.112165482483040e-02; +2.383021929036754e-03   -1.976869585477372e-02   +1.488329930657907e-02   +7.425159830679529e-02   -9.463427619069174e-02   -7.136977895685820e-02; +8.728572283597046e-02   +2.668331157209604e-02   -1.217551128776121e-02   +5.175182128051235e-02   -9.389293521266637e-03   -3.970499828061223e-02; +5.244701780315213e-02   +5.679241739784233e-03   +5.545558164488389e-02   -1.943129251453917e-02   -9.199499531375504e-03   -3.053200855893258e-02; -6.203690620470645e-02   -2.703085546204542e-02   +1.901644271510616e-02   -1.258260506031895e-02   -2.147242551001638e-02   +8.230287172735087e-02; +5.259346323856958e-03   -8.592421315341572e-02   -2.680501120840340e-02   -7.063326331055143e-02   +3.992320514003900e-03   -5.177235074482479e-02; -1.383465786609480e-02   -6.809952712454956e-02   -7.848769580184664e-02   -8.270726897713521e-02   -1.204348576414028e-01   +7.833377234345332e-02];
L2_L3_iGABA_netcon = [+1.359829244423683e-02   +1.283429204353851e-01   -2.547968020308058e-03   -2.455576852017491e-02   -9.391860013240665e-02   +3.812129499810839e-02   -2.400195939789131e-02   -3.774181129319704e-02   -5.491419220587013e-02; -5.640566417345720e-04   +5.628319594558581e-02   -6.331852372297819e-02   +2.356345987202755e-02   -9.887429905333187e-03   -1.350256404721326e-02   +1.192456692730359e-02   +4.033863252104620e-02   +4.467509550959758e-02; +9.929193715985456e-02   +7.190170836054142e-02   +7.561921900656478e-02   +2.138775849833633e-02   -3.862973492872540e-03   -6.312985036685088e-02   +6.520775449949000e-02   -8.167996637388092e-02   -6.522070898448971e-02; +5.811843351574642e-02   -3.694328689776909e-02   -5.835235433995489e-02   -7.529371524221955e-02   +3.749894959345242e-03   -1.149856014286322e-02   -1.879286760651318e-02   -4.157008829802579e-02   -5.853895736389562e-03; +1.034341068191144e-02   -4.998210204158223e-02   +1.520303436609250e-01   +3.205906322557166e-02   -2.161226792060637e-02   -6.838880063289951e-02   +3.899694133599231e-02   -1.352169651833735e-02   +1.329369459726484e-02; +3.088746973674252e-02   +9.239562384245331e-02   +3.915656617321048e-02   +1.820900922102758e-02   -5.566899587936383e-02   -6.551673954365853e-02   -1.023219981610326e-01   -3.069881193548350e-02   -8.216219127133439e-04];
L1_L4_iGABA_netcon = [-1.532280730367583e-01   +5.870146641730835e-02   -6.657161682367599e-02   -3.746504420122181e-02   +1.333071624268140e-02   +8.053095343250122e-03   +6.894136401189221e-02   +4.358088215741315e-02   -9.647109916050750e-03; +2.821482055508630e-02   -1.749284513093605e-02   -1.476529484670540e-02   -1.163797821289891e-01   -7.308273019737556e-02   -9.573772434277095e-03   +2.318613300899526e-02   -4.822377804396798e-03   -5.276797893656746e-02; +8.385652301825886e-02   +9.407140545582983e-02   +2.938437337410227e-02   -4.009068799015372e-03   -4.842317928792095e-02   +3.972008344518389e-02   -6.580261787444924e-02   +9.442313030206589e-02   -3.588218272962233e-02; -1.033270612904536e-02   -9.097587500869229e-03   +2.704464588480767e-02   -2.801429241771642e-03   -4.944242808242004e-02   -2.625351632313491e-03   +2.106336213241059e-02   -4.543663920564932e-02   +3.951999864408005e-03; -3.771440942765634e-02   +1.023577975430424e-01   +6.744998272630856e-02   -8.962484418896650e-02   -3.351914326301785e-03   -6.305175689968426e-02   +5.083789641856164e-02   +8.584004823618786e-02   -6.883021989156118e-02; -3.681490628127061e-02   +4.157112255963626e-02   +2.901248890258607e-02   -5.451752458651993e-02   +1.371720024624071e-01   -7.723288724377914e-03   -5.038410655512636e-02   +1.235809169924643e-01   -7.392219217169922e-02; -7.375397848648668e-03   -6.411891408238761e-02   -4.492641199413956e-02   +4.006614006216323e-02   +3.634761072918341e-02   -2.865976716686890e-02   +9.222989213204594e-02   +6.512446424724259e-02   -2.165168855904610e-02; +5.664712472308215e-02   +3.120952092375453e-02   -3.583499151048190e-02   +1.207937579467298e-02   -1.925655312131808e-02   +5.049967843851570e-02   +1.049194713379107e-02   +6.298652622662150e-02   -7.377526050122077e-02; -2.586137634201862e-02   +3.450318904662303e-02   -6.146641344764951e-02   -6.040136951020068e-02   +1.032763653988176e-02   -5.977644196618777e-02   +1.435826469193806e-03   +2.403770085431410e-02   +3.322945777191860e-02; +6.599872351684709e-03   -1.177876444728804e-01   -3.257355075839710e-02   -6.832047236681257e-02   -3.424246429477752e-02   +7.862686263478712e-02   +6.014233450207931e-02   -9.452033147502537e-02   +3.253921706849804e-02; -6.699692910434268e-02   +9.345585198331831e-02   +4.107250547570844e-02   -1.745528215247843e-02   -7.548366050423677e-02   +1.039809183324060e-01   +9.756253906575654e-02   +7.873843415103032e-02   +6.750263678439930e-02; -9.459825752198489e-04   +7.762440570074159e-03   +1.814527606875060e-02   +1.105622073332693e-02   +7.706492534012963e-02   -3.337228392709839e-02   -7.280920053152921e-02   -3.594202122073017e-02   +6.672529625163443e-02];
L4_L1_iAMPA_netcon = [+2.441982261758458e-02   -1.292758257246283e-02   -8.224281258918767e-03   +9.005407488707719e-02   -1.460254860070103e-02   -4.128082193209072e-02   -1.821787861349309e-02   +4.108723536333763e-02   +1.151010276191301e-01   +1.624087385924254e-03   +4.959360677603079e-02   +3.272088537101429e-03; +1.000037781832260e-01   -1.288127487535572e-02   +6.725668996327394e-02   +4.428079278665255e-02   +7.674455141619933e-02   +1.380564884963018e-01   +4.986709161388263e-02   -4.794649387391273e-02   -1.031624632187827e-01   +1.389237896835819e-02   +6.973143137091862e-03   -1.709679947490821e-03; +3.228443862545446e-02   +4.804694177051884e-03   +1.118026149860611e-01   -3.646602482689269e-02   +5.365805148571179e-02   -5.446756091649008e-03   +2.849942829063425e-02   -5.270352376053121e-02   -8.458666055804324e-02   -6.011065470150402e-02   +1.241332888901369e-02   -4.253051638426066e-03; -4.144709429970703e-02   -9.401708422955415e-02   +1.538984242999312e-01   +5.602544059974907e-02   -9.822149314627671e-02   +2.157143599869519e-02   +2.585624113164553e-02   +1.763219683792119e-02   +3.187169125517305e-03   +5.664479272163908e-02   +5.773368074994833e-02   +4.900596688867231e-03; +1.816728080693122e-02   +5.088590436949390e-02   -1.153437364176967e-02   -3.924868083357777e-03   -1.545137965902417e-02   +2.033250486553059e-02   -1.287314732214699e-01   -4.896515796044408e-02   -2.086636631953992e-04   -1.378561880511429e-02   +2.371124740690965e-02   -2.444892733480015e-02; +1.017903153528912e-02   -6.278717306739547e-03   -2.904273819054502e-02   +4.932823858294933e-02   +5.838870886294503e-02   -4.488686817562450e-02   +3.085685334844677e-02   -1.957838380684610e-02   +1.440137235423785e-01   +9.569172581835615e-03   +3.666282137504868e-02   +7.609321088306695e-03; -5.816665588906460e-02   -3.844424060004732e-02   -4.545388069837092e-03   -8.669294699987450e-02   +8.677118904578621e-02   +7.232987793557026e-02   +5.150065279059968e-02   +1.624211548719813e-03   -1.473271169644798e-01   +1.152898288674892e-02   +1.091400643095077e-01   -5.020620763413285e-02; +3.665939459255183e-02   -2.581980718190508e-03   -1.034520537854639e-01   -2.747814060480333e-02   -8.544912554551340e-02   +1.527500170804296e-02   +1.365955253015625e-02   +3.045454902845827e-02   -2.581718581522861e-02   -7.345679782206355e-02   -5.905046136065811e-02   -4.998586918209699e-03; +6.181254289541552e-02   -2.856661152061441e-02   -1.105475580250534e-01   +6.022530749119019e-02   +6.497714312749257e-02   +2.008159428970376e-02   +5.000066436983299e-03   +8.046457698175451e-03   +2.087266841517963e-02   +3.577083287757533e-02   -7.631788035727589e-02   +2.027619353226571e-02];
L1_L3_iAMPA_netcon = [-7.613254367687561e-03   +5.243699518520063e-02   -3.403699714515447e-02   +4.581592985534214e-03   +4.524835825342896e-02   -9.877646524859676e-02   +2.735011535372843e-02   +8.727998018087749e-03   +9.398869687258032e-02; -4.414034409615931e-02   -2.009254672949302e-02   +8.683222297591638e-02   +6.487350571689421e-02   +9.272473476528452e-03   +2.175831568309876e-02   -4.539116010901716e-02   -2.707329949462405e-02   +5.033621931442153e-02; +2.335330359336295e-04   +1.434241651978014e-02   -3.399907552396852e-02   -4.396966044199035e-02   +3.912086942797845e-02   +4.546612464157104e-02   +9.045904132397344e-02   -2.087022533857452e-03   -3.858511304415001e-02; -1.381963912141342e-02   -5.884824468587934e-03   -4.167093678637043e-03   -6.325508337297385e-03   +5.394113369169917e-02   +5.323174664648551e-03   -1.712160231870776e-02   +1.476194622999064e-02   +3.335028357252622e-02; +7.988503941942036e-02   +4.068183052221813e-02   +4.260635521752631e-02   -7.240226659393389e-02   +8.717846452273159e-02   -8.057553186570049e-02   -2.642088523032448e-03   +5.531217044105400e-02   +1.694213465694720e-02; -5.925224740535739e-02   +4.256973875388745e-03   -1.511321207870476e-02   -2.891272775238738e-04   +5.029084743999936e-02   -5.882699038022825e-02   +9.053206854965634e-04   +4.762442646624578e-02   -2.934146636817965e-02];
L3_L1_iGABA_netcon = [-1.857178092088320e-02   -2.537506737956732e-02   -3.077307254908641e-02   -8.028065970396735e-02   -1.226455487943999e-02   +8.290569709038370e-02; -2.101785588657152e-02   -9.132580504922327e-02   -2.801294878547500e-02   +2.442697606062332e-02   +4.754167076911464e-02   +2.576041235897701e-02; -4.499463887877855e-02   -2.307828536972342e-02   -7.153542342647930e-04   -7.736445709226801e-02   +1.309213890534986e-02   +1.056898358279198e-01; +9.401882119524781e-02   -4.195835798299578e-02   -7.049830158964236e-02   +2.554194022607596e-02   +5.221263052446380e-02   -3.323184530056507e-03; +2.986679068891806e-02   +3.595575536269862e-02   +1.627560356159910e-02   -2.462553107510917e-02   +6.054540128602295e-02   +6.642363664743907e-04; -3.401587775278988e-02   -1.459905248228494e-02   +3.979691492012302e-02   +7.249370619220916e-02   -2.809825140538333e-03   -1.456005505202348e-02; +5.095083584990037e-02   +9.199641968556686e-02   +3.031010249577039e-02   -2.417570062657616e-02   -5.317185162690384e-02   +4.841466922950051e-02; -2.977616049052608e-02   -2.855361361086895e-03   +5.525136898310732e-02   -4.469051547612024e-02   -3.578780365668990e-03   +6.981930817564716e-02; +6.752248509083439e-02   +2.858171739288421e-02   +6.113774617585195e-02   -9.618049296317840e-02   -6.913864201778053e-02   +1.518500117232249e-02];
L5_Input1_iAMPA_netcon = [-1.029054621351814e-01   +7.189796748518841e-03   -7.671410374524529e-02   +3.117205219581737e-02   -2.468128373802497e-03   -2.607714037759527e-02];
L6_Input2_iAMPA_netcon = [-3.787672911761943e-02   -5.649468688553014e-03   -2.949209560516398e-02   -4.572197335191897e-02   +1.605367717185333e-02   +1.827761177259139e-02];
L5_L6_iAMPA_netcon = [+2.876659696307494e-02   -6.029043056656123e-02   -5.102044546400780e-02   +5.711892389843028e-02   -9.114532401880114e-02   -8.154716503298336e-02; +5.241160704850924e-02   +4.047018173412721e-02   +3.395288501565229e-02   +5.198967301461808e-02   +4.081570777126986e-02   +8.766721323670634e-03; -7.249475002520345e-02   +6.919183439140139e-02   +4.519652693195020e-02   +3.516762919237744e-02   +2.210021418135154e-02   -1.449954175680277e-02; -3.307590523284731e-03   -1.031382764053117e-01   -4.325202137445863e-02   -1.302899223235482e-01   -6.610855624669271e-02   +1.834702339280164e-02; -2.524590293713045e-02   -1.766300195598470e-03   +1.171591091826019e-01   +3.733840452316491e-02   -5.255115916775881e-02   +5.749358974925304e-02; -2.153614846792957e-02   -2.720209667586250e-02   +6.591876488746219e-03   -4.097116359201654e-02   +6.961911870223163e-02   +5.352289660320791e-02];
L4_L5_iGABA_netcon = [-7.716987196183644e-02   +1.502427897596036e-01   +6.398755425036802e-02   +1.464064854113442e-01   -5.018526904502241e-02   -8.566364436380405e-02   +3.496085891880695e-02   +3.736856118076272e-02   -9.292746471089700e-03   +4.781382642209538e-02   +3.767340032387870e-02   -1.018558043728571e-01; -4.830919740698052e-02   +1.048121882533138e-02   +1.779220444389516e-01   +5.942057802886628e-02   +2.623619140128492e-02   +2.132508823385271e-02   +7.355448016133777e-02   -5.131613541455405e-02   -7.505750839351419e-02   -3.397350899368303e-02   +5.668101060878766e-02   +3.888732155430144e-02; -4.270465996283602e-02   -3.723129792288282e-02   +3.781821521910546e-02   -2.572055612875871e-02   -1.272407066000352e-02   -2.993847699393585e-02   -5.872358661008065e-02   -4.750445607965145e-02   -6.617830156264599e-02   +3.888651283980488e-02   -6.031290381519577e-02   +3.288243564290685e-02; +9.365569207209325e-02   +6.619163285392748e-03   -1.046028589839446e-01   +1.047197379820956e-02   +3.523776765459605e-02   -4.517887390845366e-02   +9.522271850873569e-02   +6.742757729384782e-02   -7.800594150634088e-02   +3.060938630970918e-02   +8.341678013372392e-02   +1.768652029304166e-01; +7.148894082279925e-02   +1.178593827589809e-01   -4.747779607557036e-02   +4.822013208707177e-03   +1.215995336955029e-02   -2.050695566679198e-02   +1.210065539760763e-02   -1.053934694227575e-01   +1.040551951254875e-01   -6.866676604952709e-02   +1.077594208027866e-01   -3.747487941373132e-02; -4.153697896782918e-02   -2.087649515027561e-02   -5.863779133460492e-02   +2.913133260739943e-02   +4.217276482207921e-02   +5.290238865005216e-03   -1.736618287405050e-02   +1.494223189684219e-02   +8.337328619290209e-02   +2.539813897599788e-02   +1.296290206439981e-02   +4.447690789940423e-02];
L6_L4_iAMPA_netcon = [-2.947237911845389e-02   -1.701514665718009e-01   -3.262137776013932e-02   -6.625292516834781e-02   +1.346034608648178e-01   -3.268416370868969e-02; -4.946022219599255e-02   -8.262716550715214e-02   +2.051448645624447e-02   -1.148941516142615e-02   -1.474680036418862e-02   -1.221467639368452e-02; -8.176620884973622e-02   -1.068158950482619e-01   +3.831482121796476e-02   +1.099269280216469e-02   +2.924298557745694e-02   +8.183258290500417e-02; -2.316642504806287e-02   -8.406147783706670e-02   -4.325827638816723e-02   -1.753406813399901e-02   +4.334683212459457e-02   +7.721260481846833e-02; -2.364336339367287e-02   +5.310626673295811e-02   +5.772707275714635e-02   -1.591546464258272e-02   +8.610896402035631e-02   -2.266189644906938e-02; -1.277791273983928e-02   +4.638755334203731e-02   +7.594875736690365e-02   -4.174767185515287e-02   +9.359144355709108e-03   -3.921406404634794e-02; +1.238970237584797e-02   +5.762247440353641e-03   -7.182838146278696e-02   +3.409559544811512e-02   -5.942173870423370e-02   +9.303412350429265e-02; +3.552921685824639e-02   -2.269347348286368e-02   +1.782774311646600e-01   +1.695719847580628e-02   -2.155314832302253e-02   -3.026313149419210e-02; -5.602565986161927e-02   -1.306328903909730e-01   +2.007869159660429e-02   +3.028508107120579e-02   -3.047224893375710e-02   +2.125486884041971e-03; +2.519590510283028e-02   +1.499199524771040e-02   -3.308250804704198e-02   -4.284306480579118e-02   +1.507904952221964e-01   -1.694465078384958e-02; -1.583872946429846e-02   -7.871250384687178e-02   +6.706340470708584e-03   -1.719798401680803e-02   +3.772178455539187e-02   -3.402138864398942e-02; +1.270740450456433e-02   -3.419362841080576e-02   +5.913769115315315e-02   -1.706003615742419e-02   +6.983803858116652e-02   -3.506643332345579e-02];
L5_L4_iAMPA_netcon = [-8.174741388988287e-02   -1.368268886243366e-01   +3.832280513544895e-02   +2.811785301323196e-03   +6.806501440150245e-02   -1.001918403672235e-02; -1.607482222180697e-02   -1.678652752954830e-02   +7.666562350170686e-02   -2.488140813745749e-02   +6.821793410830471e-02   -1.743512687886677e-02; +5.951376440741010e-02   +8.631872211418425e-02   -4.330596504758928e-02   -2.502666750228558e-02   -5.433237209627979e-02   +8.431723521525246e-02; -4.362847949918185e-02   -1.336682939238047e-03   -2.787751041316660e-02   +2.008651591759442e-02   -7.017792475679202e-02   -2.285633209912392e-02; -4.918977290907294e-02   +8.730552150880212e-02   +1.570341746452453e-02   -7.969146848502051e-02   +2.984865062066688e-02   -1.014282486261110e-01; -6.593720518380994e-02   +5.403965859389550e-02   -1.061028361864090e-02   +2.479315980822219e-02   +8.523593603126675e-02   -1.476342041868870e-02; +1.518662115334629e-02   -6.081073596147626e-02   -5.362294085026459e-02   -7.163320919615675e-02   +1.476322240611815e-02   +2.110394352221781e-02; +4.418606940107508e-02   +6.761361065762130e-02   -8.175385587287480e-02   +7.573057732525570e-02   -4.371400621763454e-02   +1.086709903193085e-01; -3.397812372575306e-02   +4.234204273415909e-02   +1.467774958281508e-03   +2.230149817021419e-02   -2.159123231802738e-02   -3.975499111248990e-02; +5.129318978381450e-02   +3.261900618953290e-02   -2.983709221558703e-02   +4.745304271528031e-02   -4.229459972104119e-02   -3.700712750760104e-02; -5.996804584415716e-02   -9.606338640365344e-02   +9.800457283023582e-03   +1.718272708425798e-02   +2.506010334201939e-02   -4.717396407901161e-02; +2.858792556462308e-02   -6.107070426021919e-02   -1.193077682884050e-01   +4.921263424302631e-02   -2.037481392873366e-02   +1.763732360406130e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
