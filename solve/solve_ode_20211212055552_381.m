function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.549571459282837e-01   -8.415100828978851e-02   -1.520523901478141e-01   -5.399483844800866e-01   +8.034594869577658e-01   -1.614227942350043e-01   +8.711929239237631e-02   -2.300223997140140e-01   +6.474872777042316e-01; +5.925712890027754e-01   +2.295276121932996e-01   -3.909384523300806e-01   +8.331738634653166e-01   -2.250838931008035e-01   +4.408643860447937e-01   -7.632448471824598e-01   +7.549255729513881e-01   +1.495823090970509e-01; +3.224286611465670e-01   -3.179716260684365e-01   -2.884414213436449e-01   -7.223989196569087e-01   +1.587323304595049e-01   +6.946001822390759e-01   +3.774773503562060e-01   +2.788874549808391e-02   -3.445449332725813e-01; -1.000000000000000e+00   -4.573786296349702e-01   -7.794227728620527e-01   -1.437204345538055e-01   -6.699943798975481e-01   -4.178191207691044e-01   +6.836857651643474e-01   +2.829744065895616e-01   +5.140704433776679e-01; -6.387790902848661e-01   +5.175256457434187e-01   +3.626938098534910e-01   -1.586948876549727e-01   -5.235086609088084e-01   +7.597110935988277e-01   -8.916863639325259e-01   -4.737362632382984e-01   -9.140150881850486e-01; +6.883310371282538e-01   +1.244498700009857e-01   -6.615081954907951e-01   -4.521772797267919e-01   +1.397179347193753e-01   +3.338116603295884e-01   +6.573848077194235e-01   +2.582422293998387e-01   -3.073236213319068e-01; +4.914174241285585e-01   -2.695575841132750e-01   +7.055252416193086e-01   -1.614171290898957e-01   -3.811155535528544e-01   -4.484379059292816e-01   +1.122805527895905e-01   +4.218535845238029e-01   -1.212641571722410e-01; +6.343619403693344e-01   -5.788829178274363e-01   +3.733846583272536e-01   -3.770755799751183e-01   +6.204531341561653e-01   -4.738984579275423e-01   -8.879907283505575e-01   -5.039545894481051e-01   -1.822411926997545e-01; -2.840626835767807e-01   -1.531465315979240e-01   -9.251670472209550e-02   +2.102132015181874e-01   +2.418085221935805e-01   -6.696303015533820e-01   -2.711358097186924e-01   +8.282185130515890e-01   +5.133173834588320e-01];
L1_L2_iAMPA_netcon = [+8.610122847783421e-01   -7.323212161442028e-01   -3.542596588138071e-01   -5.243294171456222e-01   -4.414987541336580e-02   -2.931767658511471e-02   -8.617906684065999e-01   -8.963278186297814e-01   +9.584809757530711e-01; +4.446899784531155e-01   -7.983040562375514e-01   +1.448508979742310e-01   -4.655448861079742e-01   +1.119958566915450e-01   -5.908561656973104e-01   -2.895204253179067e-02   -4.286478271976299e-02   +7.326602697212443e-01; +3.027313079424709e-01   +2.103464183444097e-02   +8.705981010752150e-01   +3.452909834375542e-01   +2.111281335095369e-01   +6.787075117999857e-01   +5.380154141376383e-01   -2.542663932949765e-01   +4.203896466796023e-01; -9.936783154414185e-02   +8.699760884145288e-01   -3.852194805726415e-02   -9.075469578971126e-01   +1.876264882016760e-01   +8.694678792099614e-02   -2.944542198088952e-01   -7.540844893052733e-01   +4.129956662758561e-01; +3.628068440636124e-01   +2.635228783773649e-01   +4.052667209898466e-01   -1.977849130680649e-01   -7.634314561474288e-01   -3.181922136591270e-02   +3.496677604230419e-01   -2.512786286424206e-01   -1.157550340065834e-01; +4.127495450869460e-01   +6.246879814367556e-01   +4.586755899515784e-01   -7.619138323001137e-01   -5.743209084617499e-01   -5.710615412477964e-01   -2.429605377201212e-01   +6.544326931328930e-01   +1.000000000000000e+00; -1.854261448984546e-01   +2.049017904110412e-01   +3.856541606155459e-01   +3.275335008815188e-01   +5.672764658987999e-01   +1.457730700799279e-01   +6.555064339924117e-02   -5.411728268024864e-01   -5.704297477878211e-01; -6.727427577373614e-01   +1.371880418434762e-01   +4.308562240957200e-01   +7.461512439467783e-01   -4.751490580917810e-01   +8.174951041623338e-02   +4.652570760682970e-01   +3.657794540623738e-01   -6.078835487390720e-01; +1.304850023976373e-01   +2.256533522393598e-01   -4.466317173727196e-01   +1.290570143744035e-01   -2.650815827293897e-01   -2.101837101864932e-01   +2.552412669481267e-01   +2.274886535452154e-01   +4.081456733098801e-01];
L2_L5_iAMPA_netcon = [+4.369932514852349e-01   -5.574941101468043e-01   +7.533211153396850e-01   +7.191811769902771e-01   +8.113436978259401e-01   +2.289346653032153e-01   +7.918556360755175e-01   +4.888264066715872e-01   +6.908381086696747e-01; +6.886431708336950e-01   +4.801652533255522e-01   -5.471416097157272e-01   +1.736096573151474e-02   -4.485661667135986e-01   +4.887384265279251e-01   +9.871332828484346e-01   -7.322492595206652e-01   +6.935628529514472e-01; -3.352372847001925e-01   -3.026966696675806e-01   +4.465233868302791e-01   +8.533886159973867e-01   -1.740720478258482e-01   +6.248993230426629e-01   +6.230525004795635e-01   +3.910419158784940e-01   +6.966026465630247e-01; -7.644114760686904e-01   -2.956224754074736e-02   -2.973768532691449e-01   -5.156289848123824e-01   -8.324399852865336e-01   -3.225503575908022e-01   +1.000000000000000e+00   +6.543084054336340e-01   +2.558341414902084e-01; -3.572658195745659e-01   +8.828784640800722e-01   -6.438549796630251e-02   +6.440662363976237e-01   +1.840733948066951e-01   -4.062008033601368e-01   -1.746283254972562e-01   -4.458494821819948e-01   -7.122838100791599e-01; +2.853450769155887e-01   +2.933159807046332e-01   +2.895055712640300e-01   +8.059965103466873e-01   -4.007683731389901e-01   -1.415603543007508e-01   -8.263656913392943e-01   -4.800016389644203e-01   -4.445543552827837e-01];
L5_L2_iGABA_netcon = [+9.953351370745893e-01   -6.081661360369754e-01   +6.167357858663581e-02   +1.001909690025319e-01   +3.974264295456842e-01   +9.086252311770748e-01; +6.592424053740710e-01   -2.222243385452831e-01   +6.365167863770062e-02   +7.417195732640401e-01   +4.568829971194621e-01   -4.856502966132030e-01; -2.202346741546052e-02   -1.151749244810460e-01   -5.044655120485586e-01   -5.777694297171067e-01   -4.824603935590683e-01   -4.837036936620732e-01; -5.835210658288839e-01   -7.824372065998959e-01   +2.106488163562708e-01   +4.281601595543738e-01   +5.968328555150922e-01   -8.583378342327267e-01; -7.458592304219601e-01   -7.922340601236008e-01   +4.432527498346312e-01   -2.843392313134536e-01   +9.731910212517321e-02   +8.983436056437972e-01; -6.174307454937065e-01   +2.330227976723148e-01   -5.210211842083338e-01   +8.224330202335478e-01   +5.241824545295606e-01   -6.659470330401264e-01; -2.578826077238747e-01   -7.757343104141275e-02   +7.988891271931313e-02   -1.152822467845631e-01   +5.053776846458707e-01   -1.000000000000000e+00; -3.903086540328192e-01   -7.194219240723663e-01   -2.686195727416889e-01   -3.473204080032589e-01   -3.422063122462228e-01   -7.378064793896967e-01; -2.322046467397379e-01   +5.926906321206526e-01   -5.952324675132235e-01   -7.538034691244783e-01   -3.969918311199368e-01   +7.998374418475476e-01];
L3_L2_iAMPA_netcon = [+2.346515339626363e-01   +4.864623163211638e-01   -1.305582536521223e-01   +2.469216126992989e-01   -9.678676998029138e-01   -8.468606935105372e-01; -7.428982922264213e-01   +6.536658409610743e-01   -3.597988615693189e-01   -2.806486630798100e-01   +1.265255296125205e-02   +3.134540556418253e-01; -1.751243806038416e-01   +1.717195955786939e-01   -5.227207033809568e-01   -4.089998305313292e-01   +5.380690521908108e-01   -4.509836225576607e-01; +1.835822643387380e-03   +4.448173856985965e-02   -6.522168842673450e-01   -8.689345009066671e-01   +6.458213730726907e-01   -8.431156528155412e-01; +6.511282983985234e-01   -4.645071005654798e-03   +5.278888652279576e-01   +2.505874200590641e-01   -3.744598688831227e-01   +6.430369360344149e-01; -6.288464850351441e-01   -3.161721168972036e-02   -8.746615739421960e-01   -1.224069408240741e-01   +5.277094391850585e-01   +1.000000000000000e+00; +3.880441542745969e-01   -8.530120659812359e-01   -1.989994680162793e-01   -7.032492013430839e-01   -2.208825852859797e-01   +6.079020626510938e-01; -2.304911509635778e-01   +6.204365518353850e-01   +2.062936349506214e-01   -2.832200223383471e-01   +7.573672401492950e-01   +7.746760504523365e-01; -2.393915951568197e-01   -1.189446286822185e-01   -7.655619889448175e-01   -3.951308552162694e-01   +1.145162148783626e-01   -2.220824094207646e-01];
L2_L3_iGABA_netcon = [-9.923715170635015e-01   +1.661129909518249e-01   +5.063350195532202e-01   +1.420115787614443e-01   -6.766580118145447e-01   +5.050389641823959e-02   +2.780304259232717e-01   +3.858073775062800e-01   +3.761905538860449e-01; +5.372757722591760e-01   -7.296559473137811e-02   +1.000000000000000e+00   -2.690559891040975e-02   +2.207894564465525e-01   +1.307349884251864e-01   +2.482753434614618e-01   -1.047055242766926e-01   +1.757067271697221e-03; +1.096841389962596e-02   -9.468774240660142e-02   -1.891981291019746e-01   +6.006291726884374e-01   +1.287421090377673e-01   -7.114325715551909e-01   +7.650292599801172e-01   -4.098482447202815e-01   -3.365114595428149e-01; +6.341954456954829e-01   -1.811070471611780e-01   +3.252697964827475e-01   -5.670230399690284e-01   +2.669658196150910e-01   -1.458752485513313e-01   -1.114614797719347e-01   +6.865314769395845e-01   +4.286769907344829e-01; -4.510216058671295e-01   +7.029309433818651e-01   +4.902909658330665e-01   -5.106205864111057e-01   +5.154943520116322e-01   -1.856496453164469e-01   +6.628315948384005e-01   -4.997703396886545e-01   +8.604426351455091e-01; +6.257528238223020e-01   +6.662411229138352e-01   -9.793160086331488e-01   -6.136747078706252e-01   +7.267329481460199e-01   -3.321584131982634e-01   -7.096564656551765e-01   +7.905199637104902e-01   -1.827051068940974e-01];
L1_L4_iGABA_netcon = [+6.340546190139635e-01   -6.340643555115929e-01   -6.575766299734909e-01   +1.708808899328305e-01   -4.597591511895902e-01   +3.644009713636575e-01   -3.569586089672911e-01   -5.552152866922121e-01   +3.668744539245299e-01; -9.197580041936535e-01   -5.954222589135204e-01   -6.421494463569017e-01   -8.621044491345695e-01   -8.230374427442883e-02   -3.016867849905222e-01   -3.368866799472549e-02   -2.468750132515101e-01   +6.759079067881077e-01; +5.585046096364450e-02   +2.289576160981022e-01   -1.896832316095320e-01   +8.583495096194282e-02   +9.238500178027429e-01   -2.864294480415163e-01   +3.029029308232358e-01   +5.528075134637904e-01   +3.348882719494913e-01; +2.324626398870050e-01   +3.635032422631976e-01   -6.081150344705900e-01   -3.573981881638372e-01   -3.715584259284862e-01   +1.219525198070609e-01   -2.254175794684068e-01   -1.936599548149779e-01   +4.370508845409097e-01; -2.739060675065221e-01   -8.973618537134209e-02   +2.143773573294974e-02   -1.273389605507123e-01   -6.907060004469825e-01   -1.000000000000000e+00   +6.222650837714044e-01   -2.580478140678668e-01   +7.250539337815225e-01; +5.152507346314947e-01   -3.788199753621260e-01   +9.675192778279246e-01   +6.223543934770200e-01   +7.811773745661420e-01   +5.304859946244985e-01   -6.496345529130555e-01   -2.844165604076813e-01   -7.245376720187640e-01; -8.183005281411697e-01   +5.180690051828339e-01   +2.523367890461276e-01   +1.459589634714008e-01   -9.639997123505000e-01   +7.377755996215279e-01   -8.246543225146434e-01   -1.984282196696299e-01   +3.339228949437004e-01; +1.291640468488700e-01   -7.275742524978219e-01   +9.461090666190114e-01   -2.621903221806728e-01   +9.499447348446921e-01   -4.275378933427161e-01   +7.615408966236693e-01   -2.396619849880950e-01   -5.281956372775260e-02; -3.601441982807541e-01   +7.913464293685192e-01   -6.154552844072260e-04   +5.699836329752963e-01   +5.409797736159279e-01   -4.656747446255465e-01   -5.519313975758943e-01   +9.976000548562783e-01   +7.479534153524638e-01; +1.330333109992951e-01   +4.733122558219759e-01   -2.499089479951059e-01   +5.707507737812546e-01   -3.883871478421530e-01   -3.543632868507064e-01   -2.971986295642894e-01   -7.369471637691232e-01   -7.593699432211609e-01; -4.678851759323939e-02   +3.466568563966029e-02   +3.184963268191418e-01   -5.958226511330791e-01   +5.892492567131979e-01   +7.393486640287006e-01   -6.677743854329420e-01   +2.666369419151070e-02   +6.955047532571126e-01; +2.665329293767443e-01   -2.055595078274539e-02   +1.476685292941096e-01   +3.390013543120747e-01   -4.621712551778818e-01   +4.561904800448443e-01   -2.286986336331807e-01   -2.069686023896862e-01   +7.692626525514750e-01];
L4_L1_iAMPA_netcon = [-6.493358821704831e-01   +7.592304177660799e-01   +6.269289374542257e-01   -8.395872230659425e-01   -4.996613636963899e-01   -4.296459278789645e-01   +5.417173826850445e-01   -3.760533237196685e-01   -4.346869713170093e-01   -9.153507960244496e-01   +8.941676757264672e-02   -3.568646688331467e-01; +7.723111182309456e-01   -6.846023757686737e-01   +6.538130242476452e-01   +2.597709546441592e-01   -8.160641892237636e-01   +3.999252644566256e-01   -9.799733463728977e-01   -3.080207836382761e-01   +8.514186562653132e-01   -1.705625395835708e-01   +8.083380185018985e-01   +1.925817225072500e-01; -6.385985470136002e-01   -1.530298767292084e-01   -2.503631740733537e-01   +7.511839076651714e-01   +2.547055423781835e-01   -2.228051075060125e-02   -3.979338445453959e-01   -6.342443941027326e-01   -3.414632122587717e-01   -6.881549638577934e-03   -6.023240198668254e-01   -7.195500245401744e-01; +1.423293278049466e-01   -1.032731707418214e-02   -8.547305782137090e-01   +3.662777949948578e-01   +7.945470647485972e-01   -1.991340726075024e-01   -2.630009402704158e-01   +5.225746383776639e-01   -2.554271455434878e-01   +1.856613571421959e-01   +7.657567697985825e-02   -4.386906505029673e-01; -6.693580591483995e-01   +1.595802072553579e-01   -2.901687760683291e-01   +7.109656525873785e-01   -7.229188136128858e-01   -8.255792145198548e-01   +3.770326633190059e-01   +5.030769485902198e-01   +3.028859691466284e-01   +3.223850463161976e-01   -5.397931658229275e-01   -5.886609429827634e-01; +7.052286038350341e-01   +3.707156481505985e-01   -6.094270464422160e-01   -1.318913493276176e-01   -8.361134462397998e-02   +1.727287142197061e-01   +8.405750569480445e-01   +4.835997198845554e-01   -3.276244485962170e-01   -2.070413524539344e-02   -7.161054209538296e-01   -8.575312393410663e-01; -6.953060647835977e-01   -5.914022089323001e-01   -5.011308820757213e-01   -3.343355865451259e-01   -3.937650213698995e-01   -2.402561625480695e-01   +4.196436146237584e-02   +4.663721419364258e-01   +4.357417792209760e-01   +3.743420661419857e-01   -8.023373507202678e-01   +2.544217045835399e-01; -6.436169250587063e-01   +6.486753359859316e-01   -1.517493776413839e-01   -3.143109226139140e-01   -6.500978109077217e-01   +1.000000000000000e+00   +8.026260848979893e-01   -4.938034547712954e-01   -9.754378951645305e-01   +5.553198429245079e-01   -6.211615888565544e-01   +9.242595762822505e-01; -5.160419436488831e-01   +1.068035318589303e-01   -3.751817163516679e-01   +6.728578729340531e-01   +1.901234875942781e-01   +7.480835248843524e-01   -2.820977127571045e-01   -7.226550006300150e-01   +5.094568333013388e-01   +5.843548125120925e-01   +5.574431628677796e-03   +5.787920619541447e-01];
L1_L3_iAMPA_netcon = [-4.957815854948041e-01   +4.515462965397971e-01   -3.117777999300348e-01   -8.062681972442418e-01   +7.420160966667437e-01   -1.466118750288970e-01   +4.507085410964588e-01   +7.610293214185955e-01   +3.092651606427423e-01; +3.123251197205814e-01   -7.604650367214699e-01   +7.857906302836997e-01   +1.187077918825896e-01   -5.271517103649619e-01   -6.894084509670571e-01   +8.176010242769386e-01   -5.945250398044928e-01   -5.844685300553715e-01; -5.410800801419989e-01   -7.464446796032984e-01   +3.201613420090310e-01   +7.750567415461425e-01   +7.473805040381035e-01   +6.742590530068202e-01   -4.164422128930409e-01   -1.000000000000000e+00   +6.783121536185295e-01; -7.472816944082035e-01   +6.342443622130983e-01   -4.313234760277564e-01   -3.752997489917215e-01   -9.080724045608682e-01   +8.104233683677071e-02   +6.486458288434021e-01   -8.989546637564856e-01   +2.470221417932664e-01; -5.223197497094852e-01   -6.756461492210736e-01   +1.105886612448637e-01   +8.949715684352026e-01   -8.525096069818625e-01   -3.403299570218803e-01   +4.738539748943713e-01   -6.659295841830426e-01   -3.161871871297789e-01; +6.723623494618444e-01   +6.645927400563043e-01   -8.446412584582446e-01   +8.939179125000368e-01   -7.813230394438933e-01   -9.987289496243905e-02   -1.284577712682602e-01   +8.596391097813141e-01   -1.537193123234512e-02];
L3_L1_iGABA_netcon = [-1.161740607880876e-01   -4.217151498273884e-01   -7.702821154681196e-01   -3.281646205225022e-01   +2.183887908122094e-01   +4.739960487622856e-01; -2.734148538278274e-01   -5.495383153899031e-01   -2.853851842305340e-03   -4.593831512619441e-01   +1.693063588897417e-01   +2.250596429649802e-01; -8.921597243683972e-02   +1.796605702360848e-01   +2.021288434808388e-01   -5.651737178362138e-01   +1.223322591472739e-01   -2.194656362098336e-01; +3.876538134482025e-01   +6.511510191709288e-01   -3.946974753196933e-01   +6.100416202892577e-01   -4.686049728153778e-01   -2.111169988766462e-01; -1.494339326762727e-01   -3.896147077091590e-01   -5.411684333986001e-01   -2.210788605945919e-01   +8.667128883099685e-02   -8.458784350615950e-01; +3.761378232515446e-01   -2.347268303840357e-01   +5.429623426587004e-01   +6.067296865140918e-01   -5.903769147036222e-01   -2.584126748540100e-01; -5.998014407575140e-01   +3.541040160062381e-01   +3.131725445594594e-01   +9.227788167829966e-01   +7.193187803412815e-01   -3.016577964745422e-01; -3.435446551530127e-01   +3.150684868096162e-01   -1.576335683618377e-01   -9.229396598846065e-02   +6.951989927002404e-01   +6.515858287029098e-01; +6.900638355343754e-01   +4.607368260289070e-01   -7.869743284849290e-01   -7.320732781639396e-01   -6.496152432889198e-01   +1.000000000000000e+00];
L5_Input1_iAMPA_netcon = [-3.863724989530761e-01   +6.208251712178221e-01   -6.422296231248634e-01   +1.951685849858142e-01   +1.000000000000000e+00   +4.706797241186514e-01];
L6_Input2_iAMPA_netcon = [+7.322703711945083e-02   +9.567692908890074e-02   -7.473358503630808e-01   -1.002177310509089e-02   +1.000000000000000e+00   -1.044848408569261e-01];
L5_L6_iAMPA_netcon = [-2.741219967299617e-01   +8.464723673924673e-01   +6.886858749985224e-02   +2.946234108841344e-01   -3.154841835606335e-01   -5.322598023958398e-01; -9.261053328299569e-01   +1.000000000000000e+00   -4.837668249453956e-02   -9.617165522312719e-01   +6.682511280534457e-01   +7.796375779531793e-01; -9.441507057031794e-01   +6.696141598034601e-01   -5.838896729567557e-02   -6.487997461298940e-02   +5.208283393218025e-01   -1.483138494660070e-02; -2.433390104552930e-01   -5.287153732208655e-01   +5.004764734961278e-01   -1.607223859717839e-01   +3.566333930696728e-01   -5.290159837194921e-01; +6.787037613318478e-01   -3.250682998904084e-01   +8.647961645872962e-01   +5.721603687736496e-01   -9.039515105762524e-01   -8.235446268134687e-01; -8.001241151818081e-01   -8.397774068801893e-01   +2.783547109270192e-01   +3.191331793134965e-01   -1.138833728477569e-01   +8.416289244196358e-01];
L4_L5_iGABA_netcon = [-2.632507105215401e-01   +2.139890169188705e-01   +2.291921908969103e-01   -5.467293967322341e-01   -9.258348687363609e-01   +4.542593683412389e-01   +2.230159128393344e-01   -6.225306098530491e-01   -6.113423021039650e-01   -9.933027225618897e-01   +3.835237851915522e-01   +4.229070356671709e-01; +5.704793547700856e-01   +8.431768094392385e-01   +8.185942593803294e-01   -8.166392347753243e-01   +6.206050308927211e-01   +2.989261517861257e-01   -1.131028294604754e-01   -7.857342739149614e-01   +7.611365525055588e-01   +5.468650620353128e-01   -2.726265900967081e-01   -4.664648239470116e-01; -8.942746927697399e-01   -1.100462193073416e-01   +3.947085586117299e-01   -1.345634031133734e-01   -5.281083105226889e-01   +1.546779574367666e-02   -7.860576540200821e-01   +5.556647396948361e-01   -1.482303738789179e-01   -3.516638779869922e-01   +1.925902053107310e-01   +6.612905190874598e-01; -5.987263672793515e-01   -9.389635990177693e-01   +4.882015180952491e-01   +3.060892988025390e-01   +9.140037386295592e-01   -8.888011310595255e-02   -6.550198498728860e-01   +4.054691661990095e-01   +6.852666380341723e-01   +5.281952810764965e-01   +1.328776687072309e-01   -5.727032617353149e-01; -5.109262671233186e-01   -6.398163391662608e-02   -7.837492375581867e-02   -6.242636386036909e-02   -5.808249283401268e-02   +4.751428764457454e-01   +7.819336041861835e-01   -1.000000000000000e+00   +2.571147149536693e-01   -5.278214038857421e-01   +1.985874881458971e-02   +6.127139923146706e-01; +5.804789112516512e-01   -2.226128982124269e-01   -4.822166991595242e-01   -1.545718501589959e-01   +6.488864357011034e-01   +2.832431864491966e-01   +1.915724154301892e-01   +5.212120920523541e-01   -8.645571314309208e-01   -7.661841274588511e-01   -4.241753187794648e-01   -8.558040925279262e-01];
L6_L4_iAMPA_netcon = [-2.132351669154552e-01   -1.741222171950409e-01   -2.894662586265584e-02   +4.974035722368754e-01   +4.278134781915446e-01   -4.873749891982423e-01; +7.792473281533570e-02   -2.162305154897481e-01   -7.276214646812431e-01   -9.130546971995243e-03   +1.000000000000000e+00   +5.705967058107477e-01; +1.342078350422651e-01   -7.047472227393194e-01   +6.963243105999746e-01   -6.695953767755768e-01   -4.884706261462217e-01   -2.841188244057662e-01; +7.103035375504625e-01   +1.681571010158985e-01   -6.240177292344379e-01   -7.748008290777811e-01   +3.105953638145105e-01   -1.703590477574955e-01; +9.297823480320787e-01   +5.782591668370681e-01   +6.165375014350219e-02   -8.691616294474410e-01   -6.158079047257822e-01   -6.632934510735576e-01; +1.069180205709015e-01   +3.491898200464034e-01   +7.949808946234853e-01   -3.455857701981327e-01   +9.067523689373386e-01   +2.673179394450230e-01; -2.392816664984437e-01   -5.502056332503361e-01   -7.545489288876335e-01   +7.546480922568222e-01   -5.371640752038368e-01   -4.604430154863416e-01; -1.196147899451046e-01   -1.951702802418140e-01   +4.513958451727899e-01   +4.380613429793943e-01   +1.319892899685488e-01   +3.383379934007368e-01; +4.961831004550293e-01   +1.677250775851049e-01   +6.595668077131182e-01   +3.074281114661225e-01   -6.194243280313602e-01   -9.351633464155367e-01; +4.383051457766404e-01   -7.484341528416574e-01   -3.569278059243377e-01   -7.792030374529847e-01   -2.481180312222193e-01   +7.654978200087796e-01; -2.452188773212529e-01   +4.952409207292316e-01   +7.778247392042703e-01   -2.543148842525655e-01   +6.211919233026324e-01   +6.801825390127605e-01; -2.053915546584989e-01   -7.411306942786262e-02   +5.011216394424223e-01   -7.905069100810542e-01   -8.254009536815103e-01   +5.238029914460262e-01];
L5_L4_iAMPA_netcon = [-4.181012733265465e-01   -7.320942989054049e-01   -8.856179260589675e-01   +7.961281653101818e-01   +8.896929320635784e-01   +8.598842511949423e-01; +3.851295041855635e-01   -1.217500342143818e-01   -3.422894433947959e-01   +6.219240206035979e-01   +7.913556026137447e-01   +4.782367380401517e-03; -6.434320091514942e-01   +1.708376580566214e-01   -3.107475963195515e-01   +3.074660241319727e-01   +8.237490713786226e-01   -7.137641568755659e-01; -8.103461735447280e-02   +4.279245162609811e-01   -4.348262478446028e-01   +1.789077051905926e-01   -9.551207782521300e-01   -9.727198636624442e-01; -5.124938140689088e-01   +2.116217406912139e-01   +1.000000000000000e+00   -8.626522573328422e-01   -5.325771474889093e-02   +6.229535331101511e-01; -8.430759813452019e-01   -5.561276403709017e-01   -7.814979388311600e-01   -4.390679398892715e-01   -8.239416025792307e-01   -4.203319737014192e-01; -3.192482505800516e-01   -3.092427677142163e-01   -2.568105917643939e-01   -7.009613962404897e-01   -9.524880678123975e-01   -6.702086464507766e-01; -9.926313451855202e-01   -5.686096109498509e-02   -1.992035173924907e-01   -8.255708317024527e-01   -3.488382208551652e-01   -1.828148579256834e-01; -7.424243293757334e-01   -3.837128761252947e-01   -4.433385482896077e-01   -1.386236210369763e-01   +3.614402511905360e-01   -3.383653770076823e-01; -6.085795154533565e-01   -4.829391786510435e-01   -5.954459991968618e-01   +7.533520868135947e-01   -2.459036494204105e-01   +4.883735383068878e-01; +2.855551553565074e-01   -3.618319016523202e-01   -6.867063942452516e-01   +5.393671657369259e-02   -3.010368629306852e-01   -6.809275064137441e-01; -5.325830182280483e-01   +5.494852813661335e-01   +6.767410302814072e-01   -6.262145943579362e-01   +7.242391361295875e-01   -5.364447783202193e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
