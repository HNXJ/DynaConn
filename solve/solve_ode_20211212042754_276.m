function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.992238007998838e-01   +1.987310295734075e-01   +3.423700298212366e-01   +4.365621628359074e-01   +2.118843624190676e-01   +3.316453350668276e-01   -2.627549848479176e-01   +2.312173273416946e-01   +3.207787423165108e-01; +1.079925845631689e-01   +1.467582427261856e-01   -4.716076895296281e-01   +1.402264595094194e-01   -1.137324705834102e-01   +1.343813718111815e-01   +4.280175748755006e-01   -2.628678788448758e-01   +2.944692953786225e-01; -2.963125503833403e-01   -1.371724520332766e-01   -3.424000542249334e-01   +1.848786491508250e-01   +4.929261219306263e-01   +4.158172077199163e-02   +5.567349877053398e-01   +7.920113258001757e-01   -7.561565900667883e-01; +2.873570130843140e-02   -3.676380510344640e-01   -3.002397961146652e-02   +1.823402692864829e-01   -1.870297992928992e-01   +1.011184735950688e-03   +1.493230131268103e-01   +5.357952599805784e-01   +3.900144330010891e-02; -3.091559383558466e-01   +5.435254283803581e-01   -6.047803849492282e-02   -2.112710833603314e-01   +2.956914199315330e-01   +2.052310424859468e-01   -1.503572389843745e-02   +1.278342396715032e-02   -4.614162149416384e-02; +2.602126401372141e-01   -3.326804273630241e-02   +4.371894606867974e-01   +8.519827784788587e-01   -3.711975182676480e-02   -3.165821294412713e-02   +1.979216646587136e-02   -7.858521473738464e-02   -2.912802739930905e-01; -4.060288648169231e-01   +2.890727962029942e-01   -3.153077355126555e-01   +5.634487146146286e-01   +7.399784932872346e-01   -5.839613635793997e-01   +6.487071635875866e-02   +5.496116717394102e-01   +3.273081669581996e-01; +3.654417590947691e-01   -7.247179274357068e-02   +4.611993406990610e-01   +4.290036006940878e-01   +2.684887697694503e-01   +7.999533395978644e-01   +5.364425692637033e-01   +2.730878607395333e-01   -5.383157803547494e-01; +7.389039681319693e-01   -4.770494746978051e-01   +1.665754523517338e-01   +7.098506243836238e-01   +2.812939823246058e-01   -1.340323627309313e-03   +3.172885234996023e-01   +1.887087887849234e-01   -1.088910312599516e-01];
L1_L2_iAMPA_netcon = [+5.674314572429142e-01   -1.927389184372867e-01   -6.069854138294544e-01   +5.595262723693957e-01   +3.530961367819835e-02   +5.208755023785314e-01   -2.489855456337476e-01   -1.533286651426884e-01   -7.848279958962120e-02; -2.874869155621211e-01   -1.703418675713289e-01   +4.363415927737800e-01   +3.423048212564985e-01   -3.963040165740701e-02   +8.507177252522241e-01   +1.348985287517430e-01   -7.399794862795141e-02   -4.241742616719399e-01; +2.626587838855780e-01   +4.248901201663059e-01   -3.931125049465388e-02   -7.419624895448501e-02   -1.873569839223724e-03   +5.610134881793686e-01   -2.002954391663297e-01   -1.140930583593893e-01   -5.398676267019784e-01; -9.253717127819008e-02   +4.174851462473786e-01   +3.881988171045365e-02   +3.335654211895130e-01   +5.432377900012092e-01   +7.391707303539125e-02   +3.525609182827312e-01   -4.030913956984050e-02   +4.550089612334952e-01; +4.856157881020967e-01   -2.349627140591563e-01   -2.832501194846127e-01   +1.460008211257300e-01   -5.034224567442089e-01   -2.445736362486858e-01   -3.446206219705972e-01   +4.636961201770540e-03   +4.440060532208820e-01; +4.706655502124351e-01   +6.838923433020672e-01   +2.370005978978045e-01   +2.426881066467165e-01   +3.256348320379424e-01   -4.888664764986089e-02   -3.723864468863655e-01   +3.620260961850045e-01   -2.233118969838321e-01; -6.323778324552565e-02   +2.328933569833980e-01   +2.850042137979036e-01   +4.157141155705738e-01   -2.111855209477751e-01   +6.766698714145464e-02   +1.162342505502120e-01   +4.791830721869006e-01   -5.316515175633607e-02; +6.389657923707197e-01   +1.159314764955285e-01   +6.294366800149023e-01   +5.277835458122596e-01   +5.496711738066859e-02   -5.289384458774010e-01   -9.286740113414786e-01   +4.011616415891097e-01   +2.833453277092445e-01; -1.302858389410526e-01   +2.142146936091956e-01   +2.309092587914229e-01   +2.248420960992224e-01   +4.768588913677460e-01   -6.871141203496725e-01   -2.990390329728358e-02   +3.776838961204341e-01   +2.884833170727548e-01];
L2_L5_iAMPA_netcon = [-3.748488776401698e-02   +5.445045523020414e-02   +4.365448737956280e-01   +4.017519753334849e-01   -3.339703375122058e-01   +6.689049110406802e-01   +7.531221351956320e-01   -5.782193969914534e-02   +5.165041563867023e-02; +1.167753781357571e-01   +3.422385160941616e-01   -7.705491749233878e-02   +1.832735189922019e-01   -8.621673910828227e-02   -9.890572577852245e-02   +1.390950615008457e-01   +4.044149541564867e-01   -1.253621316422365e-01; +5.792273419042435e-01   +3.233107699692113e-01   -4.196655344647640e-02   +4.645790545505789e-01   -6.035830946377546e-01   +6.325015863595879e-01   +2.047246074437071e-01   +2.557041720339901e-01   +7.569373082276614e-01; +3.583180017823747e-01   +7.738785975360816e-01   +5.922806082792561e-01   -1.607967043421196e-01   +8.875829649517869e-02   +2.357978758373013e-01   +5.197996153615210e-01   +4.720284879620689e-01   -9.886634088961421e-02; +1.601501276301086e-01   +6.855485768373981e-01   +9.160201499513043e-01   +1.872065116018065e-01   +2.519949615023664e-01   -1.707935378898761e-01   +1.401674120719924e-01   -5.952804712709079e-01   -9.302669999600091e-02; +2.418749137557284e-01   +2.498884396818710e-01   +5.961206419954301e-01   +3.880829466915425e-01   -3.136150292566798e-01   +5.851883434139249e-01   +1.778676749877752e-01   -5.078304458995959e-02   +1.804886663210689e-02];
L5_L2_iGABA_netcon = [+2.983452245154837e-01   +3.657190237416980e-03   +2.697413298776321e-01   +2.362131730432481e-01   +5.308333561642928e-01   +2.976052201956222e-02; +4.349509758074708e-01   +9.350640841017169e-02   -6.780803891916393e-02   +1.195393353456918e-01   +2.746880103161669e-01   +7.572811544071325e-01; +5.807050464292877e-01   +4.554631016618145e-01   +5.439710664923247e-01   +1.549129159112758e-02   +5.880310825704539e-01   -2.958209865237921e-01; -8.517043172273654e-01   +3.169071118740020e-01   -3.995725408506000e-01   -6.845874722947834e-03   +2.825849256815973e-01   -3.166041359292252e-01; +7.123651751645256e-01   +3.240506104681286e-01   +2.115786546482414e-01   +4.029867376442310e-01   +1.969368153619649e-01   -1.297308767052827e-01; -7.871367435032972e-02   +1.113299765932713e-01   +6.757461045911803e-01   +5.003264011377681e-01   +2.641634245670106e-01   +3.681602676781308e-01; +9.192418896806407e-01   +1.273407094497646e-02   +3.533466587140228e-01   +5.198595901059500e-01   +1.032311045435864e-01   +2.099349594787370e-01; +9.912164067036094e-02   +6.506846437128574e-01   +4.552700103266702e-01   +4.942339814490463e-01   -2.626077648172004e-01   +5.856026151610896e-01; +4.104837190599041e-01   +2.902101221292936e-01   -4.352797591872037e-02   -5.195176609293564e-01   -3.318479505369290e-02   -1.976478202006645e-01];
L3_L2_iAMPA_netcon = [-3.818408577454735e-01   +8.277274440898440e-02   +2.488516593364699e-01   +4.562233653821597e-02   +3.867292427369673e-02   -1.843392350930365e-01; +2.146987688334839e-01   +5.035591128257069e-01   -2.566357715707677e-01   -4.368482581108155e-02   +1.684295594066568e-01   +4.083573770057173e-02; +4.514331070804196e-01   +3.752846223591966e-01   +7.758057570682730e-02   +3.067387280657021e-01   -1.436405438505066e-01   +5.415183183604709e-01; +4.604108734219126e-01   -1.125137110476235e-01   -6.481024348624470e-01   -2.837204828056393e-01   +8.288475672743566e-01   +4.225422624730201e-01; -8.897925845232413e-02   +1.310299110410005e-01   -1.617573190121580e-02   +3.679230656507890e-01   +6.298828003545314e-01   +4.139034877882123e-01; -4.524903942086000e-02   +4.729581726217625e-01   +9.141004353716382e-01   +3.615025512920426e-01   +4.870179580447530e-01   -7.285510179760802e-01; +8.119889735773971e-01   +2.554667184418864e-01   +1.699673535237120e-01   +6.489650932220999e-01   -1.789565611218964e-01   -7.657509545047617e-02; -1.258849778854757e-01   -2.049456571138416e-01   +6.729588201804545e-01   +4.975939355338939e-01   +6.029342022418691e-01   +4.893709270197212e-01; +9.217993161229918e-01   +7.497272635973717e-03   -2.730078623623112e-01   +2.715447227777258e-01   -3.869580920023169e-02   -1.704368779918956e-01];
L2_L3_iGABA_netcon = [+7.893696297356333e-01   +1.380658860105394e-02   +1.586659916181948e-01   +2.335090142228717e-01   +7.678844991369708e-01   -3.464582849476853e-01   -7.154487939393483e-02   -3.119852192491485e-01   +4.624690673089950e-01; -4.947692156225961e-01   +4.921118639632047e-01   +2.155587688088308e-01   +4.753605671677674e-01   +8.032280623744918e-01   +3.974477617784377e-01   +5.712560811075322e-01   +7.786705251669798e-01   +2.750320405886667e-01; +1.479989663913422e-01   -2.275127576328137e-01   -5.691113328239958e-02   +4.172944140179111e-01   +3.961194587034415e-01   -1.774506081188460e-01   +1.531639825738711e-01   +6.031928819351117e-01   +5.659424808265947e-01; +4.508988230062929e-01   +8.001312251701095e-02   +5.119157790542946e-01   +9.828528273935125e-02   +3.119140879242174e-01   -2.852954029881070e-02   +1.090407866494350e-01   -1.161466189895873e-01   +2.144425690372819e-01; +4.106966992301432e-01   +6.626168705621263e-01   +3.138434216066546e-01   -3.372746125140663e-01   +3.856325728266223e-01   -4.633347280291941e-01   -7.315309694086994e-02   +2.074716465436777e-01   -1.092821064963122e-01; +1.000000000000000e+00   +3.171020651542025e-02   +3.030630450704582e-01   +8.012092254681432e-01   +9.844475095491274e-01   +3.271812362944447e-01   -2.003625458755420e-01   +5.731962808833602e-01   +2.012017236447214e-01];
L1_L4_iGABA_netcon = [-3.090975028140724e-01   +7.246952451941420e-01   +8.998311297930854e-03   +1.328564745937854e-01   +7.287792943964168e-02   +2.150618011172588e-01   +7.317200792407557e-01   -1.827115847054439e-01   +7.164360280745719e-01; -2.683658320998524e-01   -1.236613600409426e-01   +1.856901459791039e-01   +3.392398604140751e-01   -2.837325454872690e-01   +3.178994019503983e-01   +2.702857888317245e-01   -1.304158516199489e-02   +4.126663616550722e-01; -1.090173165719534e-01   -1.548927532726569e-01   -2.286824029532196e-01   +3.257897727273251e-02   +7.711085185861981e-01   +4.180106780545187e-01   +1.780489425844609e-01   +2.119009408380835e-01   +5.830545629469214e-01; -1.903833598207492e-02   +7.014102037394007e-02   -4.829935806098519e-01   -1.762434161422848e-01   +2.041645916964927e-01   -2.589388002169274e-02   +3.262855287153852e-01   +6.801007925693924e-01   -2.101847089574066e-01; +4.958355188208611e-02   -3.038154125170449e-01   +2.836044451724338e-01   +4.375709850651306e-01   -1.694390172907166e-01   -1.490739916385772e-01   +3.075100801063210e-01   -1.977043134715609e-01   -3.060928820578087e-01; +1.947636424971321e-01   +8.156128051533634e-02   +1.189799244206021e-01   +4.813520604144034e-01   +1.379027023617623e-01   -1.341740951803280e-01   +2.463057287793165e-01   +1.014302634545845e-01   +7.421246845815440e-01; +4.855370174821384e-01   +1.000000000000000e+00   -1.198210399832830e-01   +4.881793559268706e-01   +4.267794998853363e-01   -2.498114385268926e-01   +1.215645566065906e-01   +8.169905169016854e-01   +4.421726412892926e-01; -1.592159267727433e-01   +1.188763467732935e-01   -4.145013306667181e-02   +3.508005864066402e-01   -2.200948811839391e-01   +6.606167852462018e-01   +5.377314768898355e-01   +2.065938180806736e-01   -2.573926459810423e-01; -6.655623291017009e-02   +3.915243957043379e-01   -4.285787319870659e-01   -1.033329400652897e-01   -4.621592462700232e-01   +2.705759651571465e-01   -1.395737188120533e-01   +3.930021089247407e-01   -3.893603605638463e-02; -1.902242326532096e-01   +3.586446165601446e-01   +2.682436657954411e-01   -7.559815359876738e-01   +3.002553559374360e-01   +3.701420663220310e-01   +2.014808288092934e-01   +7.432746377057192e-02   +1.299360271699496e-01; +4.089815097373294e-01   +3.806821471954996e-01   +1.524954216574057e-01   -1.760896635282371e-01   +2.693203488457016e-01   +1.103826910329184e-02   -2.202842746530156e-01   -2.252677251062649e-01   +2.682644607545571e-01; +5.476439952691643e-01   -3.570937256124302e-01   -2.960880637476937e-01   -1.290756971868884e-01   -8.681177388053593e-02   -1.509818687461265e-01   +2.715844626583241e-01   +2.637757660964752e-01   -1.817580141610916e-01];
L4_L1_iAMPA_netcon = [-1.500242905400493e-01   -4.867392883551757e-01   +3.311168465507647e-01   +4.980889467188240e-01   +3.939823607003745e-01   +9.230863276257854e-01   -1.625890936931755e-01   +4.586234894077082e-01   +2.080493766373925e-01   +1.337942034321132e-01   +1.570219214561549e-01   -1.989072479282645e-01; +8.674490993969344e-02   -3.496521449797104e-01   +4.159891783715153e-01   +2.075918656465003e-01   -1.420371868453041e-01   -3.800064775625674e-01   +4.950065388833499e-01   -8.381921651805964e-02   +2.714252490166463e-01   +2.650254646191476e-01   +7.512349557944198e-01   +2.930158252659522e-01; -3.220270194795160e-01   -1.394505359432307e-01   +5.112791781670937e-01   +5.541917015780281e-01   -3.402308208468815e-01   -1.822005020386297e-01   +2.218061570069726e-01   +3.947183305256015e-01   +4.822263425076196e-01   +4.607164347904418e-01   -5.465185226435997e-01   +3.105542089366599e-01; -1.279903509887440e-02   +3.150909180433395e-02   +2.384628912822870e-01   +7.899211207631379e-01   -2.008007909605583e-01   +7.191178709037475e-01   +8.632438616847922e-02   -8.307803057589797e-02   +3.730761699368474e-01   +3.920542555388040e-01   -7.588247558249552e-04   -2.060699101318123e-01; -2.776063090455152e-01   +6.831055348071964e-01   +4.231288057219725e-01   +5.594065586547144e-01   -1.672303370279116e-01   +4.468534179879360e-01   +8.436430677086545e-02   +4.628548679948967e-01   -1.135669329933864e-01   +4.661054707626753e-01   +3.146541000251944e-01   +7.955218719982680e-01; +1.663619758987231e-01   +4.484153471554382e-01   -1.728206741393693e-01   +2.312523528903689e-01   +1.285881643403371e-01   +3.097795913915763e-01   +1.835681602557621e-01   +3.073880627690448e-01   -2.174099442806709e-01   +2.585515094100498e-01   +4.435660286985414e-01   -1.159468305367329e-02; -4.072543145829525e-01   +1.286257719720241e-01   +1.181721277602445e-01   -2.932730047137877e-01   +1.235625876824150e-01   -7.228833655984904e-02   -1.092914261798272e-01   +6.636030831285824e-01   -5.220902453211524e-01   -3.721830830102088e-02   +5.412620013554679e-01   +1.000000000000000e+00; +1.267274576372864e-01   +1.810199518640876e-01   +3.549161427518107e-01   -2.267842999508283e-01   +4.682086174018675e-01   -4.575396337807430e-02   -2.960786910003929e-01   +2.013942982408875e-01   +3.428323449321187e-01   -6.149648141626820e-02   +9.056967782360960e-02   -2.544984524603948e-01; +5.269424407411869e-02   -7.304849954361227e-02   +1.964182555410970e-01   +5.817046297055354e-01   -1.196433453576846e-01   +1.075107763498720e-01   +1.632625384422402e-01   +2.714052864031056e-01   +1.400787635581125e-01   -1.514589586433602e-02   -2.002547880246988e-01   -1.225475137776670e-01];
L1_L3_iAMPA_netcon = [+5.128894563572296e-01   +2.724791022653111e-01   +2.570431613192875e-01   +2.650250270547680e-01   +6.362232285080808e-01   +2.786645768600028e-01   +4.849774927632862e-01   +2.486516467204145e-01   +1.507793656837253e-01; +5.450454241174864e-01   -2.097993672532590e-01   +7.220932404317487e-01   -8.041230817794021e-02   +5.885438819202721e-02   -2.962280448737286e-01   +3.628778130097075e-01   +1.711341721569088e-01   +6.934491376007824e-02; -1.151352039141899e-01   +5.197037781164903e-02   +3.541844327661491e-02   +2.180834409049644e-01   +4.062832403534020e-01   -8.487209784126670e-02   -2.970203726231024e-01   +5.655756478398559e-01   +6.861813571292865e-01; -2.390050906651064e-01   -1.601339365115611e-01   +2.834614028588674e-01   +3.554722534660482e-01   +3.210592071281966e-01   +1.169365870744729e-01   -1.567207965654546e-01   +2.144774538541472e-01   +2.599951015496805e-01; +7.239696681065574e-01   +9.540503758919703e-01   -1.999722603051015e-01   +2.724160949164599e-01   -5.848238844235899e-01   +2.003817962904564e-01   +4.834940089166033e-02   +4.125541044911762e-02   -1.075014722352765e-01; +9.201765427847001e-01   -5.882468781443937e-02   +1.528451640106132e-01   -5.795128027815964e-01   +9.690038942648935e-01   +4.141444191212846e-01   +7.526483780736762e-01   +1.000000000000000e+00   +2.145910931404917e-01];
L3_L1_iGABA_netcon = [+9.188184464804381e-03   +1.839295594816807e-03   +3.417163876503601e-01   +2.672308350551643e-01   +9.998368751831857e-02   -6.633653520084867e-01; -1.954653857253370e-01   +2.027939729054502e-01   -6.772769909778904e-02   -3.457643054270555e-01   +2.615267697916274e-02   +5.216421180317311e-01; -5.680554498132379e-02   +5.724368900046427e-01   +9.686852241596425e-02   -5.305711856825898e-01   +5.144599569335411e-01   +4.825697377467723e-01; +2.304924207756772e-01   +5.987618339409330e-01   -5.364223670058970e-01   -5.345210311864050e-01   +4.225352278437006e-02   +4.270958408757560e-01; +6.462927544796425e-01   +3.592472485051397e-01   +6.819644622515584e-01   -6.111293938013564e-01   -1.980896613617500e-03   +1.000000000000000e+00; +2.283365091510445e-01   +2.474599736619482e-01   -5.551782195368789e-02   +3.662053234509369e-01   -9.026815201559771e-02   -7.631985388186652e-02; -9.458984464885024e-02   -2.275625971947436e-01   +1.964222204889487e-01   +2.323156845817069e-01   +7.052975671441772e-02   -1.520458294411417e-01; +5.037295443130319e-02   -3.041241041872177e-02   +8.070112575467471e-01   -1.055882187714085e-02   -4.216572644329563e-01   -4.677234684012269e-02; +2.600047111602303e-01   -4.580621843115956e-02   +2.901196826019910e-01   +8.155699881920873e-01   -1.054022728200779e-01   -4.350482015517043e-01];
L5_Input1_iAMPA_netcon = [-2.543701722842064e-01   +7.176086099583134e-02   -2.195470224750427e-01   -8.985393279819065e-02   -1.511537590257377e-01   -4.176192053941704e-01];
L6_Input2_iAMPA_netcon = [+4.026620842505017e-01   +2.686357145824978e-01   -9.104489593266710e-02   +4.267201068065519e-01   -6.797143034017988e-02   -1.159876865410523e-01];
L5_L6_iAMPA_netcon = [+5.684014574635361e-01   +7.468740404643521e-01   +3.962173316661390e-01   -4.418409261380629e-01   +1.870763939542369e-01   +3.959547529233513e-01; +2.973936741675731e-03   +6.378690444683227e-02   +7.553392362204413e-01   +3.453364539042494e-01   +5.581215456994586e-01   -4.248241247617617e-01; +1.619511609628699e-01   +5.639804304348590e-01   +3.498976304150513e-01   +1.707418971506087e-01   +9.431023401771845e-01   +2.633243725943655e-01; +2.018404288739969e-01   +4.834716915544891e-01   +6.911855644238362e-01   -2.159790211505605e-01   +1.094229235941122e-01   +4.741369531913198e-01; +6.426726528519864e-01   -2.876771435285631e-01   -1.399338971817906e-01   +7.311105401752800e-01   -4.316831476099285e-01   -1.843362893676333e-01; +3.573781672153729e-01   +2.206487838850746e-03   +1.642672683021909e-01   +1.489145283110408e-01   +3.285360019454628e-02   +1.952450897621166e-01];
L4_L5_iGABA_netcon = [+1.829253528456726e-03   +5.247681576328149e-01   +3.547194308992850e-01   +3.188480847811593e-01   -4.118898828978801e-01   +5.544061679002140e-01   -3.627137984925531e-01   +5.211965262024600e-01   +5.912177628502906e-01   +5.329606430765210e-01   -6.456871475235898e-02   -2.613451034269204e-01; +4.710069963876281e-01   +4.208080135562249e-01   +9.187737430639031e-01   +3.419854816743229e-01   +3.589507561875727e-01   -4.001511152937801e-02   +6.172131886750467e-01   -4.391369341754970e-01   -2.010426753651322e-01   -2.535487786295038e-01   +8.675467838972614e-01   +3.434847659441388e-01; +3.627675396065486e-01   +1.973240355592268e-01   +3.549901989209170e-01   +2.346817735171834e-01   +1.602680837830231e-01   +4.468518339422243e-01   +3.667239803615253e-01   +7.774258953363644e-01   +7.066582178872596e-01   +2.283734269598794e-02   +9.977177446778768e-02   +5.848972824928600e-01; +9.219009565215591e-02   -4.205819317325636e-02   +3.820972087133854e-01   +5.034072879063211e-01   +4.932243124922803e-01   +2.394066760081245e-01   -8.257985504424969e-02   +1.060428277585435e-01   -5.774828611917496e-02   +4.670239321820244e-01   +3.641866699220602e-01   +8.357495658338776e-02; +3.001313568299403e-01   -1.250116564536805e-01   +3.709870662766515e-01   +1.777332506620286e-01   +4.722067791696235e-01   -2.124067381145300e-01   +1.949310575353749e-01   +6.252972078731717e-01   +3.933187179576466e-01   +2.646541768561871e-01   +3.395520251750322e-01   -3.056524043124050e-01; +5.586490262519552e-01   +8.945099246106303e-02   -3.702375729601403e-01   -6.166063857535056e-01   +2.735114403911827e-01   +2.118469898452507e-02   +1.363369046582445e-01   +8.589860653967619e-01   -4.133749181143900e-02   -3.711314646118737e-01   +6.925478919619894e-01   +4.792673246891704e-01];
L6_L4_iAMPA_netcon = [-3.586360228668545e-01   -4.088923917462996e-01   -1.807961127784680e-01   +1.099042911163942e-01   -2.766968869754923e-02   -1.702895238005425e-01; +3.414433081447648e-01   -8.342621633880662e-02   +5.358493759302528e-02   -1.067314625400427e-01   +3.692117053430679e-01   +3.278104888493378e-01; +2.342082252335194e-01   +4.225522410464810e-01   -3.754291765384069e-01   +1.934335454349912e-01   -1.964268169880068e-01   +1.475845577889897e-01; -7.008191118199808e-02   -3.117921199060293e-01   +4.657550417239061e-02   -2.221234389232821e-01   -2.779965278503117e-01   +8.756371356854888e-01; +3.206139203832341e-01   +1.958759266644312e-01   +4.317233306371990e-02   +3.691780739852675e-01   -2.737407430951975e-01   -3.573026869131222e-01; -5.471005737855614e-01   +2.936019282385356e-01   +4.323774441050793e-01   +2.108400969292724e-01   -2.824458956444016e-01   -3.071633859539049e-01; +1.658913350406532e-01   +1.063030421588024e-02   -3.133822983310965e-01   +3.561111156821593e-01   -6.113642944780850e-01   +5.484746665405822e-01; +2.613775670444392e-01   +2.539772902552009e-01   +5.764968501347136e-01   +8.127943298162537e-01   +6.985646160315427e-02   -3.530248860026968e-01; +2.820222902352508e-02   +1.400190916249389e-01   +4.409476033923229e-01   +6.422236138563657e-01   -2.498448700042222e-01   +1.867133420943248e-01; +2.291783650192209e-02   -8.012792530354576e-02   -7.345870060256857e-02   -9.526117005359332e-03   +6.392947902233247e-01   -1.964750708768574e-02; +1.000000000000000e+00   +4.722923629968681e-01   +1.019683300420989e-01   +9.413911510300854e-02   +5.783511780553805e-01   +3.549264998585561e-01; +5.048056242047043e-01   -5.464259224832241e-02   +7.324666708212723e-01   -2.233869671579779e-01   -1.390849952351417e-01   -7.711910329686538e-03];
L5_L4_iAMPA_netcon = [+3.687689468064892e-01   -2.398874531073404e-01   -4.743602085049691e-02   -2.336532858841485e-01   +6.536480899758548e-01   -3.214843797864963e-02; -1.716786683444180e-02   +1.433337161141976e-01   -1.149263846761157e-01   -1.621209139832011e-01   +8.882833335936668e-02   +3.871519632748581e-01; +1.690954233590462e-01   +5.009881653542635e-01   +1.746944820330877e-01   +1.436621926879266e-01   -7.071972535997085e-01   +2.376120714479766e-02; -1.764822053111408e-01   +5.750101557778866e-03   -6.110751833799030e-01   +3.430091826198727e-01   +9.486150898058179e-03   +1.014000924897557e-01; +4.791271680342259e-01   +6.461228918819450e-01   +6.956900959974086e-01   -1.653479715899694e-01   -3.109050642522805e-01   -2.127311153116526e-01; +2.410188031199824e-01   +9.935895299129786e-02   +1.000000000000000e+00   +2.684372206231932e-01   -2.478630591715844e-01   +2.427997250619517e-01; +2.702828055606683e-01   +4.350925227780728e-01   -1.838795322632253e-02   +1.939750153003957e-01   -4.274087741645020e-01   -1.812651709994033e-01; -1.780236218706257e-01   +8.705602614081590e-01   +4.035389893617534e-01   +1.368435781881361e-01   -1.794557606015410e-02   +5.127849560128471e-01; +5.059418732864557e-01   +8.776807710849323e-01   -3.889614506250985e-01   +5.403874843934313e-02   -1.380780999031876e-01   +1.349692154541048e-01; +2.136299758475562e-01   -1.109924539516366e-01   +2.274924491391968e-01   -2.588513197612641e-01   -2.688410572564181e-01   -2.005331685853981e-01; +4.521311132769015e-01   -3.377332525905014e-02   +4.531435209860584e-01   +4.094749119504535e-01   -2.122199096235182e-01   +3.301447930523494e-02; +1.499627278443000e-01   -2.334928724392168e-02   +4.993363605095205e-01   +6.058523811574666e-01   -2.016564991162143e-01   +5.894075929747991e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
