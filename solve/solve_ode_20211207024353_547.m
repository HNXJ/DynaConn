function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+9.062617513023286e-03   -5.687625847930651e-04   -1.810470810579053e-02   +3.434937244264639e-03   -1.141103639217019e-02   -6.004129947842799e-03   -3.743721166480397e-03   -3.254809031850234e-02   +2.180057852901097e-02; +3.639410039907938e-02   -4.415991642745525e-03   -2.993366674955102e-02   -2.699112545181327e-03   -4.038202067260748e-02   +4.613819311182318e-02   +1.826459052103184e-02   -1.090859997736704e-02   +3.597004161855202e-02; +2.201161550429953e-02   -2.295311892441416e-02   -3.851169258180578e-02   +5.098397847892452e-02   +5.912764049424787e-02   +4.666688757861838e-02   -6.851527805414179e-02   -3.189259972071520e-02   +1.523510703062647e-02; -2.043487529719429e-02   -3.920061076180902e-02   -5.884689135138092e-02   +5.662429598271912e-02   +4.920841552147704e-02   -5.463453376017234e-02   +5.539572383852928e-02   +4.013628526949459e-02   +5.125908641703193e-02; -4.642344679859561e-02   +2.535632231342336e-02   -5.707107224963134e-02   -1.824367628557013e-03   -3.089088214497850e-03   -1.088356530205367e-02   +6.256676014476578e-02   -1.914467089350275e-02   -4.047506380679549e-02; -1.525232970383844e-02   -1.220768187370557e-02   -4.199625742655807e-02   -1.425155835287760e-03   -3.191884288831715e-02   -4.864810939482629e-02   +4.192628967169165e-02   -3.111216861853659e-02   +4.887569389294803e-03; +6.549035858416991e-02   +1.011683795077825e-01   +1.396554990471995e-02   -2.908298299064852e-02   +5.759845858237156e-02   +1.202529465051722e-02   -7.656070698986052e-02   -1.605618478975617e-02   +5.165115040244986e-02; -5.230574995896988e-02   +2.339134524494140e-02   +2.783108392943970e-02   -3.095738149830566e-02   -2.711544990327006e-02   +4.705595878753571e-02   -1.029991521107404e-02   -2.119387525744305e-02   -7.247224551085019e-03; -1.096243493818721e-02   +1.286918382752898e-02   +3.207691514232890e-02   -2.272197428186165e-02   -4.461620214971432e-02   -1.244287993828675e-03   +2.609774112895559e-02   -1.913952577583456e-03   -7.229490846661979e-02];
L1_L2_iAMPA_netcon = [-2.429357944520446e-02   +3.847012012285581e-03   +4.013710451030930e-02   -9.088683670552249e-02   +4.820238637198626e-02   -2.686503910391655e-02   +2.031355355662703e-03   +6.383528876862601e-02   -4.318764410144971e-02; +1.279295124522523e-02   -3.709241509426910e-03   +6.184293789570752e-02   -4.021081839691767e-03   -4.221859120633356e-03   -4.901606561731340e-02   +5.774160842905746e-03   +5.838495010471912e-02   -3.426022039771379e-02; -1.085895645697190e-03   +1.641503055826777e-02   +2.139648161367560e-02   -2.022322261214332e-02   -3.523368177778601e-02   -7.483782433755645e-02   +9.376014359012818e-03   -4.873388818434143e-03   -3.216771741935816e-02; +3.595970352392142e-02   +7.500983762186403e-02   +1.579064153275112e-02   +3.088782442941671e-02   +6.447269187636214e-03   +1.140151846186344e-02   +4.693724395762038e-02   -2.612092630605539e-02   +2.109053641479199e-02; +1.201487192900073e-02   +2.505386876777583e-02   +1.849390149454793e-02   -1.747670097695649e-02   -5.941115124319416e-03   +7.390670895741501e-02   +5.031677708631016e-02   +2.314733888057926e-02   +4.888945032534449e-02; -2.358597727160613e-02   +9.487250093356325e-03   -3.201684765756004e-02   +2.251348572016411e-02   +5.076578973211676e-02   +4.473532120755302e-02   +3.130321559721016e-02   -4.315605241148719e-03   -2.523432683675364e-02; +3.609337704961048e-02   +3.695243392985265e-02   +1.499333321075834e-02   -6.757208876822467e-02   +4.936432780910407e-02   -1.632945377788238e-02   +3.008834520323121e-02   +3.609224664349144e-02   +1.143353569733132e-03; -3.231458336708715e-02   +2.982627250976854e-02   -1.250269472448055e-02   +2.561777188392640e-02   -2.199811036806470e-02   +7.178834385909715e-02   -5.449757003517306e-02   -4.176820273589000e-03   -3.955715693306084e-02; +6.700036741082625e-03   +3.754081448935091e-02   +1.032399289555296e-02   +1.583109840454655e-02   +2.489547175459544e-03   +8.878579140717879e-03   -1.820156077255368e-02   +6.979824502188800e-03   +1.379937653260471e-02];
L2_L5_iAMPA_netcon = [+6.026429121444630e-02   -5.239060989263476e-02   -4.115600388732940e-02   +2.758241823125589e-02   +1.300817261224583e-02   +9.463240482171849e-03   +3.109233729591072e-02   +2.298791624340730e-02   -1.425814232991779e-02; +3.735211914639192e-02   +6.603093212055300e-02   +5.829370739910396e-02   +9.594328070972515e-02   -1.080011413002945e-02   +5.472442459534932e-02   +6.274780058601280e-02   +2.896052526547110e-02   +4.407042708571733e-02; -3.842337720107274e-02   +3.692502670421941e-02   +7.417320680132211e-02   +1.814481909262426e-02   +8.213193487964156e-03   +6.999379842938250e-02   -4.949312147684468e-02   -2.103942946034845e-02   +2.863453089912100e-02; +2.168567074143168e-02   -4.177991415828062e-03   -7.809093893559128e-02   +6.080699402755768e-02   +2.339406172351956e-02   +4.331691222292917e-02   +6.897377993142370e-02   -4.439125690231843e-02   +1.574298217150306e-02; +5.529869182829742e-02   +2.590673313297474e-02   -2.113298481228216e-02   -2.317801553546599e-02   -2.187959699937058e-02   +6.714313772094028e-03   +3.174391756142016e-02   +9.104540897972517e-03   -8.560137472678270e-03; -4.029220936962108e-02   -2.104667241364525e-02   +3.154475203217540e-02   -1.775511104633944e-02   -5.441519398642379e-02   +5.803760494956800e-02   +3.807829097389705e-02   +2.665611456771489e-02   -3.464282850624814e-02];
L5_L2_iGABA_netcon = [+3.752867800536736e-02   +2.688674219996990e-03   -5.563309359557440e-02   +7.581643177192968e-03   +3.279991214479267e-02   -1.197495804439284e-01; -1.997464180835700e-02   -2.941735324081319e-02   -7.060806198032277e-02   +5.987126500351740e-02   +1.929048918301121e-03   +4.567507232094920e-03; +2.293004004043132e-02   -2.625628921820727e-02   +6.118501683805880e-02   -3.987033310265833e-02   +8.912972469407673e-02   -4.981642656922369e-02; +7.520756498854681e-03   -5.370881268335936e-02   +2.696139060731070e-02   -9.465255352397853e-03   +2.377472132892448e-02   -6.575726381131684e-03; -4.899947960492183e-02   -2.941381713784278e-03   +3.043435772361233e-02   +1.418486238580457e-02   -1.443338701039502e-02   +1.316642698644393e-02; -1.906249000605589e-02   +3.006864240859959e-02   +3.283896262864465e-02   +9.958388794693641e-03   +3.582855824207418e-02   -6.382422828618912e-02; -4.338020678916159e-02   +5.058087875609782e-02   -2.610398032176496e-02   -1.574743259353387e-02   -4.742860133092829e-02   -3.625064978090925e-03; -5.458552269141768e-02   +3.510106918365896e-02   +6.311831718957894e-02   -3.586846497538296e-02   -4.077305702202497e-02   -5.370745473188181e-02; +6.214721116048970e-02   +2.071805550357169e-02   +4.841956139372332e-02   -3.822510560262292e-02   -9.263727065172971e-03   +7.580823122721225e-02];
L3_L2_iAMPA_netcon = [-1.738800912497391e-02   -4.596120386795607e-02   +5.648076085674275e-02   -5.559160106287080e-02   +4.983562928535515e-03   -7.097305904503341e-02; +1.418580449446998e-03   +7.198333240795518e-03   +5.051808716646339e-03   +7.201369764489432e-02   -5.387559124472906e-02   +5.833543204435993e-02; -4.621676216724178e-03   -4.008675022248967e-02   -1.004784216374614e-02   -4.409156170181885e-02   -2.473503184980525e-02   +3.678958608239065e-02; +3.777315016390160e-02   +1.445540364105360e-02   -2.146626877985743e-02   +2.078852247341008e-02   -6.754517887551813e-02   -3.668023128555023e-02; -5.050046600441348e-02   +4.816456898908751e-03   +2.523514138598178e-02   +4.153860383318432e-02   -1.068892284242820e-02   -1.458324732780096e-02; +1.673629612707549e-02   +2.826733440863827e-02   +1.334685601556564e-03   -2.757828302120192e-03   -4.481759566136798e-02   -2.071876393693790e-02; -4.095253149580052e-02   +4.182735969356834e-03   +6.206365086312499e-02   -4.426523557961909e-02   -4.771921141086958e-03   +2.133243541186378e-02; +1.951207223344286e-02   +1.725243019304688e-02   -6.615214192992629e-02   +2.550367755025042e-02   +2.520250939365124e-03   +5.961714486467984e-02; -2.860836935764701e-02   -5.343601102407168e-03   +2.407030229523060e-02   +2.157256572232060e-02   -4.110615705640379e-02   +3.534491848633345e-03];
L2_L3_iGABA_netcon = [+6.841661338553581e-02   -1.427803315483668e-02   -1.461032046747852e-02   -4.886992585904228e-03   +9.337354399610157e-02   +5.682734465713036e-04   +2.608442887373361e-02   +1.425177725120974e-02   +2.601045775262395e-02; -1.062769708227704e-02   +3.424761275879618e-02   +2.979922248263867e-02   +1.999298141039276e-02   +4.552871042477934e-02   +3.792653706983605e-02   +2.279612191751040e-02   +9.124284605325439e-02   -9.980674261633293e-03; +4.486839040621639e-02   +3.613148504969731e-02   -1.253960569267584e-02   -6.526661108152729e-02   -3.598566765496441e-02   +1.883192176595543e-02   +5.575073022916135e-02   -8.238616814808326e-03   +6.236574098030172e-04; -4.939715393055140e-02   -6.570871293400118e-02   -6.328511464934808e-03   +6.831396694513471e-03   -6.485973303931379e-03   -2.628364257352464e-02   +5.501809025377007e-02   +7.465501837135256e-02   +2.855216962961108e-02; -6.125559927049908e-03   +5.343493074659275e-02   +3.121591240540449e-02   +3.521726470306891e-03   +3.699654844332184e-03   -4.345816569693293e-02   +4.371902422476476e-02   +2.332775363721568e-02   +6.275812913972123e-02; -8.084234719183492e-02   -9.592631596710140e-03   +6.123666897295852e-02   -3.200404709137530e-03   -7.736731657910040e-03   -8.936703763566905e-03   -2.850034958975638e-02   +4.518302863529157e-02   -3.298983964465699e-03];
L1_L4_iGABA_netcon = [+8.991406478907511e-03   -6.072083665320050e-02   +1.937948556260201e-02   +1.415489323771706e-02   +1.196110927772113e-02   +3.181895630242448e-02   +4.367027608580508e-02   -4.751385274157286e-02   +6.327994335962445e-03; +5.037280655279619e-02   -4.181828902478856e-02   +1.901877434275473e-02   -1.440026830781094e-02   +1.147457455212183e-01   -3.708422310873570e-02   +5.339889683564483e-02   +3.534615166270405e-03   -5.839358166475662e-05; -1.084038713169454e-02   +1.557147798874822e-04   +4.316353754344645e-02   +3.035623039107270e-02   -2.200981143188380e-03   -5.010352614222731e-02   +6.549577761249531e-02   -2.190482325030889e-02   -3.660473095668276e-02; +5.957079320375496e-02   +3.490730988867441e-02   +3.729941516979383e-02   +2.120962977858160e-02   +4.441126188232902e-02   -1.619975008973583e-02   -6.085663018749445e-03   +4.974817328247074e-02   +2.921845486436849e-02; +1.242644571043001e-02   +3.853180159825655e-02   -2.699275483919868e-02   -4.709231491393708e-02   +1.113571630748647e-02   +6.323281129280915e-02   +4.150037885282405e-02   +5.268020839213577e-02   -2.275009232294974e-02; +1.293521217560280e-03   -1.785316601432397e-02   +7.687251459621135e-03   -2.519456284779244e-02   +2.599196255028654e-03   -3.086151360416849e-02   -7.637591004394005e-02   +3.163356489154337e-02   +7.147015042234209e-03; -2.692449510227126e-03   -2.426065053092508e-03   -1.699437736246095e-02   -1.316248550924305e-03   -1.896768025678387e-02   +6.263604995562833e-03   -3.629807820443937e-02   +1.147489935675079e-02   +2.670031936736680e-02; -9.500414444152741e-05   +4.273178988576350e-02   +7.428266162657893e-02   -1.443840145530402e-03   +1.942502202132074e-02   -2.158298685812867e-02   -1.098163272113320e-02   -5.440562782006184e-02   -5.076967182843927e-02; -1.891319013836391e-02   -1.325799448656839e-02   -9.828602555753765e-03   -3.285072030165660e-02   -2.230392030046721e-02   -4.986455597742559e-02   +3.010179950624838e-02   -2.208122544493559e-02   -1.859206712964466e-02; -6.843452894379488e-02   +3.483177439603312e-03   +2.071234758274760e-02   +4.698524822585211e-03   +2.390508269363837e-02   -3.858741601502505e-02   +4.917825176611092e-02   +1.442790571331996e-02   -4.295288256007270e-02; -5.504768932555794e-02   +7.711692611912407e-03   +2.793148184834846e-02   +4.718680794651129e-03   -2.346031916433501e-02   +2.265720228281932e-02   +3.296285614359287e-02   +3.709194555774798e-02   +5.288847640282000e-02; +7.985849384222080e-02   -4.494131591053918e-02   +2.464618518230776e-02   -3.950406167612175e-02   +5.973332681979564e-02   +5.383858774399367e-02   +5.218335256152393e-02   -2.188915809188895e-02   +2.374006064167731e-02];
L4_L1_iGABA_netcon = [-2.742660357038343e-02   -7.233900769977587e-02   +1.989582493978236e-02   +5.486972939664245e-03   +8.595522825283260e-03   +1.335537026512583e-02   +2.464562189865903e-02   -5.346851919483385e-02   -3.381107287967847e-02   +3.623488553993013e-02   -7.010426397061015e-02   +5.576575317561193e-03; +1.394373815531600e-02   -4.004819031968365e-02   +4.703990966844210e-02   -3.575526758411338e-02   +2.765410475975684e-03   -5.582488865252344e-02   +5.520240240258079e-02   -3.352496418487790e-02   +6.430730529328765e-02   +6.065218781314516e-02   +2.432233829340703e-02   +2.787867296729473e-02; +2.734855436544870e-02   -4.779679486718747e-02   -1.153851221858663e-02   +5.171645377698778e-02   +5.941524399692751e-02   +1.814217748757903e-02   -2.862587250755875e-02   -4.923397242315714e-02   +5.925349700011788e-02   +1.344262103143998e-02   -3.567663656240878e-02   +5.452667968795195e-02; -1.097159144059817e-02   +4.258019026467023e-02   -6.180568246303628e-03   -5.138468746831501e-02   +1.155766713516518e-02   -5.740869680590215e-02   -6.202998447518266e-02   +1.490675585578759e-02   -1.267567833465764e-02   +4.509723243755724e-02   +1.691604914058151e-02   +6.273605985509560e-02; -6.220441020123429e-02   +1.955196926496987e-02   -3.543109459259167e-02   -3.598726304783778e-03   -4.903919265106298e-03   -4.021415879010633e-02   +1.973839797595833e-02   -1.855312833100529e-02   +7.501369476781633e-02   -1.265927561807256e-02   +6.506134724091321e-03   -8.991452524360889e-03; +1.884401503787450e-02   +7.479693869158616e-02   +3.294399139141355e-02   +2.681490178702074e-02   -2.926634297592290e-03   -2.014421417140930e-02   -1.506798502487229e-02   -3.180364963480602e-02   -2.688272874363471e-02   +6.767089743765128e-02   -5.222320774905792e-02   -1.030598204976969e-02; -9.306863441748081e-03   -1.181952138825519e-02   -1.499154975713428e-02   +1.556211241821994e-02   +1.042444614319853e-02   +5.562134726657716e-02   +2.984549225055672e-02   -1.133290753488561e-02   +6.259220575079333e-02   +4.809517348073035e-02   -3.235368681059798e-02   +3.809998343777811e-02; +2.352299155135251e-02   -1.975254325637306e-02   -1.133415728357571e-02   +1.400818802038045e-03   -1.647678152467247e-02   +3.760940462659322e-02   +4.660732068615307e-02   -3.911902231669252e-02   -7.152977137213284e-02   +5.149534420113507e-02   +1.710102124742357e-03   +4.253081400360481e-02; +8.403653216836650e-04   +1.699509644437849e-02   +4.131127500238469e-02   +1.420427700846826e-02   +3.704997025685430e-03   +3.916981550080922e-02   +5.305977627785115e-02   +9.593222840415406e-03   +5.091174155954396e-02   +6.992494375097601e-02   -1.277532418121158e-02   +3.102908462175336e-02];
L1_L3_iAMPA_netcon = [+1.965970634197606e-02   +4.450802313861205e-03   +5.599240345200855e-02   -3.161393364285169e-02   -2.201826476477475e-02   +2.939946302901404e-02   +3.786522041705979e-03   +5.675720108715527e-02   -1.961178819502233e-02; +6.590254839612868e-02   -7.835927860674508e-02   +1.125753395055282e-02   -1.588974878278120e-02   +5.670246637013447e-02   +3.461903751533907e-03   -1.840713165423578e-02   +2.452965736625974e-02   -2.542904405969094e-02; +1.011669473394081e-02   -7.876783622987785e-03   +1.430627397493768e-02   -6.515804714375388e-03   -3.984439428647747e-02   -2.111448383061952e-02   -3.354928535801632e-02   +9.752723962092660e-02   +3.225846166519348e-02; +8.352035453455250e-03   +1.853923674841267e-02   +1.291835041501247e-02   -4.049978453990989e-02   -5.289137064541918e-02   +1.873899358901960e-02   +4.905948263544586e-02   -4.506299951442237e-02   +4.843877361527772e-03; -5.625411020739448e-03   -2.329073908125829e-02   -1.816990401380161e-02   -1.021662603655637e-02   +1.785495843889928e-02   +2.022347855762558e-02   +4.699663607098877e-02   -3.297897065776124e-02   +1.373639797122962e-02; +1.718251787313093e-02   +2.001936340901464e-02   +6.684164022157942e-02   +8.924446593567319e-03   -1.417775157661244e-02   -1.616993141965475e-02   -6.511296221528319e-02   -2.310756487476894e-02   +2.352351132536825e-02];
L3_L1_iGABA_netcon = [+7.267213204011810e-02   -2.978187486628241e-02   -3.441853585348275e-03   -1.119045600194116e-02   -1.300683365291086e-02   -1.456960476944221e-02; -9.593342206487492e-03   -1.373785050240174e-03   -5.682205393862286e-02   +1.749816239978082e-02   +7.461238105936702e-02   -3.463214273442335e-02; -1.565155985058491e-02   -3.056498120959030e-02   +2.910269341287815e-02   +2.762705764006774e-02   +3.143904125550545e-02   +5.168158652330018e-02; -3.414275683756361e-02   -3.746733276331460e-03   -3.349887369004612e-02   +3.907138016911231e-02   +1.449181720595556e-02   -7.954185892409010e-03; -1.703070198654684e-03   +3.287992047890233e-02   +2.075808378869263e-02   +5.875464758895829e-03   -2.597127932322686e-02   +1.825601569301653e-02; +4.403064447848255e-02   +1.719156379170979e-03   +9.013532649180768e-02   +6.598248017259928e-02   -6.179468781137996e-02   +8.856396778792748e-02; -1.779487941916359e-02   +4.517168759936850e-02   +2.012993774437509e-02   -2.623713969612521e-02   -4.260819022433517e-02   -6.598031400072128e-02; -1.377716406554604e-02   -7.523411108409407e-02   -4.812296239968060e-03   -1.610233026188741e-03   +4.018974217654095e-02   -1.649989788285699e-02; +1.637149624952930e-02   +6.872534074895123e-02   -2.311391281794309e-02   -4.249417831582007e-03   -1.181747824991131e-02   -2.616077850733194e-02];
L5_Input1_iAMPA_netcon = [-3.579528168960287e-02   +6.591311724610596e-02   +2.900699162976571e-02   -2.773595185145863e-02   -4.148596386978065e-04   +1.290465451584108e-02];
L6_Input2_iAMPA_netcon = [+2.598868250983467e-02   +6.849354251475576e-02   -2.973195866270381e-02   +1.884609879249837e-02   +1.853938190478530e-02   -2.918332993648178e-02];
L5_L6_iAMPA_netcon = [+3.777363338528554e-02   +1.547551917554306e-02   +2.921577224888141e-02   +7.665800246062643e-03   -3.899130399798614e-02   -3.347702626213915e-03; -7.029914924210906e-02   +4.152279221965006e-02   +4.520215123849709e-02   +3.251886399162997e-03   -3.144758791499825e-02   +2.331575748443648e-02; +4.415728220953960e-02   +2.150139955697386e-03   -3.416019621491399e-02   +4.668257117378956e-02   +7.712968131392284e-02   +5.144049162760251e-02; +5.676689221201698e-03   +9.470857591299642e-03   +7.992158046120085e-02   -2.453554865970137e-02   -4.334191222379340e-02   -8.969004120861332e-03; +6.737479614797687e-02   -8.003471776280718e-03   -2.470325907880714e-02   +6.201887523911580e-03   +1.104298198675135e-02   -3.076024825541718e-02; +2.027956083474226e-02   +1.920941343055043e-02   -2.115944323953574e-03   -1.468106382740901e-02   -9.852296343122004e-02   -9.477262765604365e-03];
L4_L5_iAMPA_netcon = [+6.714367211319795e-02   +1.954716726983822e-02   -5.587119664944794e-02   -2.411578124882539e-03   +1.037641946281198e-02   -3.144864694386910e-02   +6.141127007578927e-02   +5.750363126013007e-03   +3.095396387668781e-02   +4.691112533898766e-02   +3.589641892888154e-02   +5.976373241845868e-03; -3.078138928011377e-02   -2.437659222495005e-02   -5.037288010859174e-02   -8.494129805715770e-03   +3.817201303835457e-02   +2.159017170346677e-03   +6.394882666025631e-02   -2.763692006058061e-02   -1.559387975836186e-02   +2.716115322597388e-02   +7.894175846695817e-03   -2.202713514593894e-03; -1.325107854633204e-02   +2.893779953327807e-02   +9.470922881085289e-02   +2.964343484216971e-02   +9.011088491831304e-04   +6.308653670438502e-02   +3.663359856051257e-03   +6.097519612912056e-02   +1.574549208379616e-02   +4.957441775962226e-02   +1.250344446469148e-02   -1.386708472746464e-02; -5.175313932918942e-02   +2.895108843201752e-02   +1.413825698305001e-02   -4.075070512473122e-02   -4.747073484456665e-02   +4.674327091410852e-02   +2.168552731070487e-02   -8.973019368069879e-03   +3.012896004201213e-03   +9.318486505502745e-03   -1.133912024452302e-03   -7.116328658491287e-03; -6.274476523174699e-02   +6.332491089053841e-02   +2.552325618211126e-02   +4.623290243005315e-02   +1.483366213842570e-02   -6.615979475272032e-02   -6.790538635577563e-02   +1.646631439485418e-03   -3.295071316932217e-02   -1.419622330135107e-02   +2.584770467780327e-02   +4.236616815646891e-02; +8.760929662198425e-03   +1.635562590447275e-02   -2.463050313268412e-02   -3.881802036387671e-03   -2.805890968643383e-02   +1.128009358547636e-01   +1.181551785125057e-02   -5.089326214615118e-02   +1.398956728476711e-02   +3.783060649641178e-02   -1.897542252395364e-03   -1.776326327190893e-02];
L6_L4_iAMPA_netcon = [-1.799618069997650e-02   -8.923545680426426e-02   +2.162847994381547e-02   +9.419117881607682e-03   -7.043102696076038e-02   -5.652118757914999e-03; -6.741935643653223e-03   +1.254420954146220e-03   +5.964868640067275e-04   -1.968278840072252e-03   -4.867339923523893e-02   -2.782106268567695e-02; +3.877111954858391e-02   +3.510160431894142e-02   -1.349841029898719e-02   -3.502720150309801e-02   +4.765940054616128e-02   -4.980516658737370e-02; -4.826086415028831e-02   -1.247795734629913e-02   -5.265000248945702e-02   +1.842847990241019e-02   -2.269408397765782e-02   -4.840685391776257e-02; +1.582822940362754e-02   +4.383502320857467e-02   +3.112089628814281e-02   -2.864593483547528e-02   +7.921364316018305e-02   +7.917740792729583e-02; -2.839789569875988e-02   +8.664949407472380e-02   -9.326725463097305e-03   +3.342469130082760e-02   +2.038732611522753e-02   -6.558414843904865e-03; -1.682411103255119e-02   +1.204204064168417e-03   +6.799033205067447e-03   -7.641529347758137e-02   +6.920132210197313e-02   +9.834178197497399e-02; -1.649492560707386e-02   -2.220084486261707e-02   +2.986881068299689e-03   -1.881279780081900e-02   +2.653382155896187e-02   -5.842686088320048e-02; -2.008758894666836e-02   +3.879441794137762e-02   -3.924935095628808e-02   +8.848037787948218e-03   +1.384203643161448e-02   +2.384510097258679e-02; +1.957691702588725e-02   +2.403518722750411e-02   +4.524425841223459e-02   +4.988022844788598e-03   +5.469545269763572e-04   -2.045940772715832e-02; -2.805949266316545e-02   +2.081125415597756e-02   +5.619356521878421e-02   +6.661430038641350e-03   -3.556225245917613e-02   -1.570472373148508e-02; -6.836690796817318e-03   -1.428829338611256e-02   -8.562866102732536e-02   +2.282459385265818e-02   +5.131480922262080e-03   -1.353871398629145e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
