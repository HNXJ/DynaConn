function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+6.453023943859029e-02   +4.192221113170586e-02   -5.227472915415345e-02   +5.655226686762414e-02   +9.188399118509580e-02   +1.720530673757728e-01   -6.755448009675931e-02   -4.078374624308978e-02   -8.747372600566440e-03; +2.342925744409907e-01   +7.943703991076759e-02   -1.287172464335426e-01   +7.281156338421607e-02   -1.990022139852447e-02   -1.154343981694377e-01   -2.049069916266872e-02   -5.315286291053503e-02   -7.710252553818898e-02; +1.024329954853641e-01   +5.204090408161103e-02   -6.343494031917210e-02   +1.785504319189464e-02   -2.377090313587059e-01   +6.748072304347933e-03   +2.368470322716136e-03   -1.054688859650483e-01   +1.841712329758021e-01; +1.908936555396170e-03   -1.178273125469537e-01   -2.068182437138518e-01   -1.641513099222200e-02   -7.590476256738782e-02   -5.407121394288326e-02   +5.265510954816070e-02   +1.100549472958384e-02   -1.042185221044617e-01; -3.289870211073866e-02   +1.022300237758140e-03   -5.278415048990927e-02   -1.230829312279275e-01   -2.070485255927106e-01   -3.976569670205910e-02   +1.824277922821203e-01   +8.633295699765377e-02   -1.081253259949147e-01; -2.754909310825454e-02   -3.659064512834048e-02   +9.565211802942458e-02   +6.994357606453935e-02   -1.196419944203332e-01   -2.804472755227458e-02   -4.366322694957359e-02   -8.756099194080114e-02   +6.967545473588881e-02; +1.222465958008235e-01   +1.836330900793645e-01   +9.026248462881174e-02   +8.224809202154115e-02   +1.030071129765823e-01   +9.782980179821418e-02   -1.496307663647189e-01   +1.541343795658296e-02   -2.905011381101055e-02; +1.643485149867002e-01   -1.943221559052897e-01   +1.062391290581111e-02   +8.620768401217085e-02   +6.819574972291924e-02   -1.079079260302152e-01   +1.764109150392668e-02   +6.730874861456751e-04   -2.151358880657459e-02; -1.289387142900498e-02   -2.100506671966162e-02   +3.198151153621012e-02   -1.555441623555760e-02   -1.877601731605023e-01   +1.249080802329444e-01   +1.480132838447473e-01   +7.739410287397058e-02   -1.013620747550595e-01];
L1_L2_iAMPA_netcon = [-1.358171993470449e-01   +3.388463062508520e-02   -9.476253105084578e-02   +1.215162066571390e-01   -2.134892496332978e-01   -1.263228950995527e-01   -5.652985726029934e-02   +9.577481637443019e-02   -1.195679793040605e-01; -7.888533484460492e-02   +1.006008029206212e-01   +3.942260155189582e-02   +3.128507074667172e-02   -4.448261191177400e-02   +2.032696914533760e-02   +4.741311361205740e-02   +4.383112608362043e-02   +1.411030592097646e-02; -5.603765809251803e-02   -1.201022631104489e-01   +3.320059833356732e-02   +1.156856578157378e-01   -4.256916311364295e-02   +2.123582004409044e-01   +1.745890370648655e-01   -1.134624223919366e-01   -6.551163303867817e-02; -1.571874484074074e-01   +7.853742892118126e-02   +9.176891321349506e-02   +5.902955093507772e-02   -5.990135404052206e-02   +1.054447200121065e-01   -8.367055862054848e-02   +1.079278837384991e-01   -3.360247287772782e-02; -3.940275750186666e-02   -5.619699380115733e-02   +2.837604112875948e-02   +1.143842386733020e-02   +4.246177368977221e-02   -3.944880591639772e-02   -1.925574012399981e-01   +8.983002742421260e-03   +1.875805818545055e-01; +1.019073254040282e-01   -1.224841862570970e-01   +5.922978022510908e-02   -6.621902195223073e-02   -9.758635647470934e-02   +1.219339846954153e-01   +5.969008882359916e-02   -4.805634586723159e-03   +1.419066981401518e-02; -2.606906161375817e-02   +1.951888047613612e-01   -2.395933422864591e-01   +2.687185942767654e-03   -4.223097968514934e-02   -2.491498596982285e-02   +7.795220848136754e-03   +7.840332978123719e-02   +1.386670517432076e-01; -4.036109090260847e-02   -1.122061422712195e-01   -7.384361338620640e-02   -1.211141278941819e-01   +5.934813390665538e-02   +1.214020531628040e-01   -1.548481202877844e-01   +1.547589715425073e-01   -1.709678767718529e-01; +1.200408884023961e-01   -4.732641095574339e-02   +4.817658023676639e-03   +7.001148013689618e-02   -5.077950472385104e-02   +2.430550526002060e-03   +9.021738415544851e-02   +8.086574394202169e-02   -3.287768850462780e-02];
L2_L5_iAMPA_netcon = [-3.562862415199346e-02   -1.687094137074974e-01   +3.746975506812325e-02   +6.421626810332737e-02   +9.079886208810975e-02   -9.858156657188462e-02   -2.408700174411938e-02   -9.950142006291317e-02   +1.299852595832728e-01; -1.012484633734780e-01   -1.804179256791054e-01   +1.339697994756149e-01   +1.658192705594460e-01   -7.043055844091292e-02   -3.882533959082794e-02   -4.219652009490063e-02   +2.571637893134842e-01   +9.213342642175652e-03; +2.189768098299516e-01   -2.515147573047075e-02   +1.660287494477100e-01   +8.590382788100091e-02   +8.490047981174534e-02   -1.026384386197596e-02   +2.647728368661246e-02   +6.790927185691586e-02   +1.019633247132636e-01; -7.671966528404259e-02   +1.103738872319436e-01   -1.814764242060758e-02   +1.282799671448389e-01   +2.022437209928198e-01   -2.408072974634411e-02   +1.263676254449590e-02   -6.409713063494778e-02   +6.086625470183657e-02; -7.311541988976204e-03   -4.429136061532559e-02   -1.104610427377809e-01   -2.646414817910086e-02   +5.367719625356199e-02   +4.274221155773214e-02   +2.110769361005253e-01   +1.754409968722135e-02   +6.641911510501947e-02; -6.116541986780411e-02   -9.264938945329690e-04   +4.964335217846710e-02   +6.397121809085371e-02   +6.990869653194746e-02   +4.878855122684589e-02   -3.162702411873504e-02   -1.694591100966696e-02   +3.263632835056277e-03];
L5_L2_iGABA_netcon = [-1.681509273575611e-02   -8.136925963629502e-02   -8.726032633755840e-02   +4.672736619545022e-02   -6.724783571334139e-02   +5.130425390717389e-02; -1.235968595215095e-01   +2.138309282409273e-02   +1.936860753754728e-01   +8.196701518497967e-02   +5.526084130885431e-02   -1.377460145040118e-02; +8.514784037793496e-02   +3.954012455678788e-02   +1.187648679456609e-01   +1.210296037039029e-01   -8.178889320932579e-02   -2.571625102299482e-02; -1.025240711157464e-02   +1.019898150832427e-01   -3.879607140657541e-02   -9.398787376185444e-02   +7.933448872344855e-02   +1.009625560035756e-01; +1.798377555577203e-02   -1.365760980966780e-01   -5.511937258868425e-02   +2.259039224666404e-02   -5.741876533168425e-02   -2.286640581382445e-03; -7.022749889804054e-02   -6.561746055920421e-02   +8.541661843468613e-02   -9.444024598152373e-02   +6.104686165572727e-02   +3.860682679098704e-02; +6.136766113189739e-02   -6.340747454514287e-02   +8.402678159622154e-02   -2.810486489197923e-02   -2.630628808633828e-02   +1.553337336801538e-01; +1.365833752852156e-01   -6.604737187249468e-02   +1.274705525808932e-01   -1.423125544364579e-02   +1.065735095521388e-01   -1.077948293888230e-01; +1.297445217262087e-01   -2.852074679770113e-02   -2.864233225675993e-03   +6.251185815226504e-03   +7.838238697248621e-02   +1.418754714975323e-01];
L3_L2_iAMPA_netcon = [+6.265526609304205e-02   +9.749144728459314e-02   +6.912804804770614e-02   +1.150422291156628e-01   -6.010534205055482e-02   -2.372070923936584e-02; -5.403745599349035e-02   -6.364230250831875e-03   -1.281976118985132e-01   +1.626296672852126e-02   +1.359730715089963e-01   -1.323125658347636e-01; -5.234279140965060e-02   +1.883924662151366e-01   -1.180951703817764e-01   -7.785296938103708e-02   -7.602281301032941e-03   -2.022968688468572e-02; +5.036598166432931e-02   -8.082977774466786e-02   +7.019216304158120e-02   +5.166250087162354e-02   -8.556624788718137e-02   -1.710859917230878e-02; +1.717134880054905e-01   +1.129906002390996e-02   +4.756226103757477e-03   +2.003834547391935e-02   -7.313145882015676e-02   -6.841409255379943e-02; +9.623293131924875e-02   -1.181927722157525e-02   +4.783745721441179e-02   +5.802513331180315e-03   -3.217203831229296e-03   -1.872232147819296e-03; -4.792138034257519e-02   -5.888327659894872e-02   +5.787465917105065e-02   +4.657469125996720e-02   -5.456862395830390e-02   +4.890610182502546e-02; -1.027202269300919e-02   -2.190172715519131e-01   +3.169349473794611e-02   -1.246295931924304e-01   +2.605909873689364e-02   -6.921243282335499e-02; +3.201501359886239e-02   -3.366717902650015e-03   -5.313305764650830e-02   -6.825717469420532e-02   -1.949686728253864e-01   +8.918426432526981e-02];
L2_L3_iGABA_netcon = [+3.679045938358164e-02   +1.005494554074059e-01   +6.707673815298426e-02   -1.379898140419729e-01   -1.803015405156883e-01   +3.502262736230638e-04   -4.840284582446865e-02   -9.931761199564285e-02   -1.093815941825500e-01; -7.835187071448541e-02   +3.492104343955635e-02   -8.706597128057730e-02   +7.432650098980714e-02   -3.512537348692710e-03   -1.212852537224773e-02   -3.865889395046478e-02   -8.736852563430800e-02   +6.848215114258113e-02; +1.233804462165366e-01   +1.009320928366503e-01   +1.049868620846710e-01   +2.522442021159741e-02   +8.927564255407205e-02   -1.063658415077444e-01   +3.922266845618398e-02   -6.654208142252760e-02   -8.179597503440175e-02; +1.390048150774668e-02   -8.483719670107127e-02   -1.179923163185101e-01   -6.419424716390246e-02   +2.818034270993801e-03   -5.008045254145688e-02   -3.795676016071257e-02   -2.086442415383495e-02   +5.664372969760623e-02; +5.678568076562474e-03   -7.990975774258582e-02   +2.231115337978697e-01   +1.086900552101791e-01   -2.453505694371323e-02   -6.821660678498262e-02   +1.003773951667174e-01   +3.376931533467017e-02   -4.452693488510834e-02; +5.527018186363908e-02   +1.614338604316259e-01   +3.793479441904642e-02   -7.921981917573191e-02   -1.310667973011478e-01   -1.572650831427908e-01   -1.358911648499058e-01   -7.568237046271280e-03   -2.691556113380443e-02];
L1_L4_iGABA_netcon = [-2.357171382023258e-01   +1.137918114398112e-01   -9.207290052600851e-02   -5.168215277995035e-02   -4.875393231268622e-02   +1.034326854561395e-01   +7.030015152988899e-02   +1.390469102355553e-01   -4.196100220125709e-02; +9.663042528528600e-02   +7.870989273351454e-03   -9.852324160276468e-02   -1.749125118510841e-01   -1.809632834329408e-01   +3.697224972228157e-02   -4.263451648477779e-02   -1.651018771061936e-02   -3.117327972649518e-02; +9.971068051966053e-02   +1.081934811173664e-01   +2.600759720001903e-02   +3.005222278630117e-03   -1.330059951164169e-01   +2.790957012194174e-02   -8.250185366902688e-02   +1.108867400102757e-01   -1.137946102550408e-01; +4.274161913544103e-02   -1.536941541440719e-02   +7.216021479338876e-02   +6.703140648981852e-02   -1.817376411064044e-01   +5.602313611799671e-02   -7.879753504095310e-04   -7.924511528040782e-03   -3.052613752835564e-02; -4.535088331133831e-02   +1.182913760214697e-01   +5.289102301429469e-02   -2.210649409588337e-01   -6.722171981314837e-02   -4.492712726213696e-02   +1.217734266307516e-01   +9.271651018977034e-02   -1.545031452993322e-01; -2.527633600669310e-02   -2.935902118014100e-02   +5.365423610976463e-02   -1.460682513866488e-01   +1.751496465572765e-01   +6.331737667386847e-02   -6.099532244759802e-02   +1.179001774955030e-01   -1.237391583325515e-01; +2.122533990329658e-02   -5.685051622566610e-02   -9.772183255632730e-02   +2.926727316451261e-02   +1.479583386492690e-01   -3.163380878594534e-02   +1.397492325325935e-01   +8.020982172096236e-02   -1.214365135047767e-01; +3.802282259759992e-02   +1.069433008908421e-01   -1.775875181546200e-03   +1.997968057247446e-03   -2.508055332760363e-03   +8.667507692864115e-03   +6.780803680407799e-02   +7.587047028074378e-02   -1.283428484252855e-01; +2.366999786749835e-02   +2.552240276532633e-02   -7.095514810475098e-02   -1.075773673968071e-01   +6.518267522424642e-02   -1.973245337726872e-01   +1.337360657972121e-02   -2.503925924253345e-03   +4.552365579391175e-02; -3.264641837195805e-02   -1.962688306594364e-01   -6.369659026040328e-02   -5.751163735759685e-02   -1.826421241920058e-02   +1.594568178539743e-01   +9.029281534477857e-02   -1.908441383641104e-01   +4.339576611584508e-02; -1.157582476804072e-01   +1.546228024007780e-01   +4.552265256685725e-02   -1.420174327036726e-01   -1.850914161606388e-02   +1.581166992159732e-01   +1.971389879669783e-01   +1.211475615433622e-01   +1.282116157061140e-01; -1.114389063079358e-01   -4.709741062858155e-03   -2.408183260445465e-02   +7.704338340390084e-02   +7.178158584542253e-02   -4.372650310236990e-02   -1.531345295166815e-01   -1.121652921060733e-01   +7.408462127941869e-02];
L4_L1_iAMPA_netcon = [-2.659934875764615e-02   +3.432990779467006e-02   -1.566655329004509e-02   +1.285638708027987e-01   -5.597320447039764e-02   -9.992383759172017e-02   -8.038791267018046e-02   +4.347691873757662e-02   +1.550666023949664e-01   +2.721090454030001e-02   +4.775263374583731e-02   +6.616398999679651e-02; +1.786872775458305e-01   -1.168384413884815e-01   +1.017223174142692e-01   +3.919727435567037e-02   +1.422528158121928e-01   +1.834079115117171e-01   +1.242548210933924e-01   -5.705167575595252e-02   -1.630755981295112e-01   +2.582737644970648e-03   -4.171214012580747e-02   +6.970041214556505e-02; +1.729600397200242e-02   -9.934201417114707e-04   +1.508277941653939e-01   -6.109971941599146e-02   +7.069929072062166e-02   -7.391111918606405e-03   +2.327515744790135e-03   -1.177088702768221e-01   -7.139347638555398e-02   -5.622670022512447e-02   +8.482964175813079e-02   +6.817727508107228e-02; -1.026181695718571e-01   -1.033532280766613e-01   +1.830285072496853e-01   +1.128225445047188e-01   -1.025760444213106e-01   +1.260454954263013e-01   +7.309733893318821e-04   -5.345989220992350e-02   +1.195827850200111e-02   +3.029311813020903e-02   +5.245756859435764e-02   +6.200738189854407e-02; -5.140980422553532e-02   +2.301067553873715e-02   -3.113485602182893e-02   -2.902817622555518e-02   -1.211222201011200e-01   -4.783025775492544e-02   -2.080343500391805e-01   -1.641525488528383e-01   -6.865864473373064e-02   -8.134568146319457e-02   +5.208147483615758e-02   -2.530255449735824e-02; -2.780969504967999e-03   -5.214131630038182e-02   -2.937586638818893e-02   +1.183590800619536e-01   +4.275213658949501e-02   -4.498905389097002e-02   +2.694429324811724e-03   -1.184058432358999e-01   +1.326551051565977e-01   +1.007605434192325e-01   +8.172933720688139e-02   +2.499878696824808e-02; -8.262576967480761e-02   -8.842332243964846e-02   -3.369728630490946e-03   -9.054147041518312e-02   +1.031597078726232e-01   +8.441994644221895e-02   +2.760213822907532e-02   +3.992177709804202e-02   -1.462887013800012e-01   +2.016918545019398e-03   +1.152259823907383e-01   +1.395267864682583e-02; -2.127136241889348e-02   -9.210759116862367e-02   -1.992796626438678e-01   -6.134111820098024e-02   -1.359186672360410e-01   -9.062292620455099e-02   -2.845916923301416e-02   +1.176970602449341e-02   -1.137940751666561e-01   -1.294197485925603e-01   -2.596868242563178e-02   -3.924191821296197e-02; +1.145660534258022e-01   -7.328997819933583e-03   -9.505607991102066e-02   +4.388267124263280e-02   +1.231388920919424e-01   +5.416341794438720e-02   -5.214579258644342e-02   +2.997916940298440e-03   +3.166492415217043e-02   +5.616265601864873e-02   -1.083455264578023e-01   +2.062718183531490e-02];
L1_L3_iAMPA_netcon = [+3.784999981175357e-03   +4.468215420164140e-02   +6.326635745953366e-03   +1.110113109687107e-02   +7.002444447295840e-02   -1.772348828949184e-01   +6.628209852933094e-02   +3.368807017373884e-02   +1.229295012199542e-01; -1.876335261336397e-01   +7.187497010849914e-02   +1.800180613119700e-01   +7.952236355788635e-02   +7.579552456421124e-02   +7.121048121846560e-02   +7.055274984466217e-04   -1.013470996979717e-01   +8.363430053187182e-03; -3.146393146401005e-02   +2.486186008881488e-02   -1.085166334440281e-01   -1.552902991978455e-01   +5.721699074620611e-02   +2.988476839536215e-02   +1.273532408498288e-01   +6.640418364457291e-02   -7.416378381750857e-02; +1.789733080674901e-02   +3.257967961490358e-02   +1.069520026248244e-03   +1.154611468969092e-01   +4.576698716470932e-02   -3.746273694111595e-02   +9.023221067185525e-02   +8.482501416422428e-02   +3.637933082581112e-02; +1.228381740813683e-01   +1.210854054598042e-01   -4.756654501434011e-03   -1.695517075658305e-01   +1.089255011405680e-01   -1.040458002787914e-01   +6.575320352850916e-02   +5.099429832732086e-02   +5.513884819094004e-02; -1.007779295903699e-01   +5.428641057955575e-02   -1.167703438294039e-01   -1.447860963776737e-02   +9.112974527972038e-02   -9.664831240047053e-02   +8.057178403010157e-02   +4.794909669249129e-02   +1.228734963917913e-02];
L3_L1_iGABA_netcon = [-4.385657167797104e-02   -9.574710377606779e-02   -2.936565725274284e-02   -1.156559645690461e-01   -7.498350582134548e-02   +8.661356861947624e-02; +4.852248392264218e-02   -1.533746130372051e-01   -5.648465703582099e-02   +1.149399888378304e-02   -4.670509038503662e-04   +6.600220832193185e-02; -1.592023306259724e-01   +2.976152839791739e-02   +1.643730670515608e-02   -2.158246547399643e-01   +1.303040081021687e-02   +8.273199614170755e-02; +1.275305168427715e-01   -8.553503481923072e-02   -3.760309560703888e-02   -3.035553967899528e-02   +8.975711889396218e-02   -8.790266494047502e-02; -8.481562487246984e-03   +3.090181740571257e-02   +8.735154201197973e-02   +1.641113589740072e-02   +5.713246231173104e-02   -4.199860612972249e-04; +1.457315176579461e-02   -1.385704273525840e-01   +4.886522152171831e-02   +5.191654280509256e-02   +1.381296920908676e-02   -3.870644496424355e-02; -3.900797823540157e-03   +2.001121441199338e-01   +7.234207398139771e-02   -8.993282178240240e-03   -8.150768364720837e-02   +3.713865118804741e-02; -2.742095532630937e-02   +4.065525152446617e-02   +8.562790282410186e-02   -3.777621708173173e-02   +8.467157946850340e-02   +5.569654169413023e-02; +9.362719860180524e-02   +3.660092872310306e-02   +1.001654688854320e-01   -1.124006287302222e-01   -1.484953238653064e-01   +2.480997066760828e-02];
L5_Input1_iAMPA_netcon = [-1.208714739863326e-01   -5.246457588555562e-02   -1.821576851584231e-01   +1.347125710111745e-01   +1.606887892048361e-02   -6.035625857685260e-02];
L6_Input2_iAMPA_netcon = [-2.653101512279894e-02   +1.036935141372466e-01   +5.600195571158480e-02   -2.554151893702813e-02   +5.947098957570641e-02   +9.681090336122871e-03];
L5_L6_iAMPA_netcon = [+7.877980150300901e-02   -4.243743896987587e-02   -1.203449178650040e-01   +1.574857221255064e-01   -1.403989177636955e-01   -2.370227871833799e-01; +2.129993638043635e-02   +4.932808017805079e-02   +4.292938330860261e-02   +2.106276411864409e-02   +9.234573812293179e-02   +4.413117312210002e-04; -1.308089020363408e-01   +9.220103969895815e-02   +6.826740041870742e-02   +6.581461035414134e-02   -7.556745662894510e-03   -6.061725381357540e-02; +1.854812928046051e-02   -1.643595653628980e-01   -6.211591940462466e-02   -2.509165044336874e-01   -9.304804940677799e-02   -3.789062618288984e-02; +1.605406257855485e-02   +9.702216659143474e-03   +1.126531247679114e-01   +1.774621497176649e-02   -4.285478110944003e-02   +1.097893114766880e-01; -7.637179684513179e-02   -3.557586525020548e-02   -6.653553025195991e-05   -9.446864187068717e-02   +7.673913873745905e-02   +2.318603997771955e-02];
L4_L5_iGABA_netcon = [-1.137317996824882e-01   +2.732771088888232e-01   +1.280419058640164e-01   +1.696822290336372e-01   -5.664855468448831e-02   -3.297116469249817e-02   -3.022863828099204e-03   +5.706728021083755e-02   +7.120375864284382e-03   +1.740721471871170e-01   +6.039583425892446e-02   -8.893477837972633e-02; -8.028357076851769e-02   -1.262136562491292e-02   +2.004027359753323e-01   +1.163283886984057e-01   +7.057711081512276e-02   -2.625068296655795e-02   +1.128154649008210e-01   +2.961346497258779e-02   -7.649518740401208e-02   -3.663305308553847e-02   +1.969811225039448e-01   +7.493432491576724e-02; -7.784319119823693e-02   -1.108552161657217e-02   +6.231572180180095e-02   -5.217023716514581e-02   -3.773624110610747e-02   -8.738575946673620e-03   -9.869938700240374e-02   -4.626455055098388e-02   -1.145112737588540e-01   +1.300261837575197e-01   -1.954782811698833e-02   +1.174874274672198e-01; +1.817214581053988e-01   +4.053451869965385e-02   -1.472241386492884e-01   +4.004236614463714e-02   +7.821961489970924e-02   +4.798002717258058e-03   +1.401689192077163e-01   +1.504486736752084e-01   -1.089786001442111e-01   +5.997140920194684e-02   +1.714340851581765e-01   +2.365393558315537e-01; +7.109006210074299e-02   +1.372334200330184e-01   -6.461992460101088e-02   +7.044996470442423e-02   -4.127363826802603e-02   -4.470816696395292e-02   +3.799395529394173e-02   -9.788374014492457e-02   +1.650138211863626e-01   -1.199287093380360e-01   +1.831950965124269e-01   -9.142390377283348e-02; -2.034724475260132e-02   +6.533823031576330e-02   -9.585671881841973e-02   -4.856595638276048e-02   +7.649653148699265e-02   +2.893608054329737e-02   +5.274191805560276e-03   +1.158659763839741e-01   +8.403422047951539e-02   -7.027282582445900e-03   -1.171460855839962e-02   +4.817528221675783e-02];
L6_L4_iAMPA_netcon = [-7.383713316816243e-02   -2.448699126556786e-01   -1.026825754336379e-01   -1.126817440393260e-01   +2.968325541347602e-01   -2.381444835156329e-02; -1.370250543494085e-02   -1.487194173737379e-01   +6.961468000140872e-02   -6.654834750776352e-02   -6.783057232583484e-02   +7.128753764721052e-03; -1.505256947305940e-01   -1.514372842940785e-01   +2.194870028164158e-02   +7.464792350230078e-02   +1.143270693662123e-01   +1.392587576384346e-01; +7.442502904723379e-02   -1.911341585066469e-01   -9.998036028816916e-02   -3.164137153597631e-02   +2.636229334795532e-02   +1.386386376486669e-01; +4.488689866487270e-04   +1.764056068548039e-02   +1.723342163518352e-01   -9.639495725985722e-02   +6.675316186462868e-02   -4.769883427204048e-02; +7.823306705798848e-02   +1.353152661397195e-01   +7.769619608602618e-02   -2.704117286258195e-02   +3.631067662399773e-02   -1.593172683740622e-01; +5.972667654176114e-02   +4.068083483027110e-02   -1.553557373422199e-01   -1.697232860977045e-02   -7.769628763974179e-02   +1.189870746875791e-01; +4.488380655906293e-02   +2.458954475123466e-02   +3.111348907487302e-01   +3.835287747967289e-02   -8.338129473750097e-02   -7.041665380357663e-02; -1.014432031372532e-01   -1.436759141552695e-01   +4.121908886172247e-04   +6.392785097272535e-04   -4.288697024232536e-02   +5.386303619000488e-02; +1.371451322394704e-01   +6.009792451233643e-02   -7.684364893371312e-02   -1.331381150292630e-01   +2.397762871168858e-01   -7.374233587151638e-02; -2.811729730029316e-02   -7.560894824274374e-02   +7.151404605301476e-03   +7.822175911279070e-03   +2.814195204870946e-02   -3.941281427429100e-02; +1.986860046116670e-02   -2.867718725932884e-02   +1.167803972204461e-01   -2.267958987632951e-02   +1.856089003931560e-01   +4.686208112248952e-02];
L5_L4_iAMPA_netcon = [-1.505528355611964e-01   -2.516538418589665e-01   +1.241602615738271e-01   -2.513639980971186e-02   +1.071739282573569e-01   +2.896541950641670e-02; -3.299632855984401e-02   -8.686184998240093e-02   +1.877633875087804e-01   +3.468466723355552e-03   +6.393312538356559e-02   +7.566691554123725e-02; +6.146238735274155e-02   +1.880414113958158e-01   -1.873785590747353e-02   +4.730871590960183e-02   -3.159705591897422e-02   +1.526463444149870e-01; -6.608075026002655e-02   -2.530010891009375e-02   -2.754515005408916e-02   +1.174162657555321e-02   -6.051946954585957e-02   -8.590330907575133e-02; +2.452242187248897e-02   +1.438805131485655e-01   +9.599516307054287e-03   -9.039356271498414e-02   +6.196808829681228e-02   -1.111654883584522e-01; -4.633744616076342e-02   +3.669936594770882e-02   -4.451626406220341e-02   +9.036899153022318e-03   +7.163066047190952e-02   -4.210060514635598e-02; +3.677440690119657e-02   -1.497180282649272e-01   -3.913613735432599e-02   -8.698034090494791e-02   +1.283073137464484e-01   +1.279220153146422e-01; -2.608033541044256e-02   +1.345545598765124e-01   -1.395468727135877e-01   +1.301871122244152e-01   +1.738564842766698e-02   +1.753945928169862e-01; -3.301800131799133e-02   -4.702749390938053e-02   +7.026196929351704e-02   +3.520975896981546e-02   -3.007085219631393e-02   -7.610437778260354e-02; +1.295564244515698e-01   +2.053308946273689e-02   -5.528635655583561e-02   +5.918391389521012e-02   -1.561206168971577e-01   -1.048302838756889e-01; -1.263743443785117e-01   -8.117813533244142e-02   +1.365326417156174e-01   +2.529633770223427e-02   +7.985303912064683e-03   -3.696250187349806e-02; +2.280437335221524e-02   -2.182387053022884e-01   -1.562171937653289e-01   +7.370334534628803e-02   -5.804084190939397e-02   +7.789900770590673e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
