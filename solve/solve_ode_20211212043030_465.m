function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.402087363566821e-01   +3.838726341256964e-01   +1.348186395664340e-01   -2.559995547586966e-01   -9.719912387061827e-02   +2.231775660181232e-02   -5.461090364770522e-01   +3.648551966154909e-01   -3.552698221044099e-01; +1.505253002643156e-02   -2.955294668776257e-01   -4.954369138691567e-01   +1.169139114179752e-01   +1.104548790194126e-01   -2.969956163969324e-01   -9.435490567158097e-02   -1.651931181963734e-01   +6.493972836782730e-02; +2.110070692012748e-02   +3.101290661910291e-01   -2.296641737380944e-01   -5.048625202563088e-01   +6.119637136144390e-01   +3.645472553716219e-01   +4.191395535610259e-02   +6.423977805826215e-01   -2.910317494898778e-01; -5.094087704861435e-01   -6.299749091653799e-01   +5.785373227113405e-02   -1.863624023758769e-01   -3.596903372965768e-01   +1.867891123638029e-01   -1.876941117062918e-01   +4.030021174113962e-01   +1.392948579009245e-01; -6.399714075723847e-01   +3.147869270177407e-01   +9.995085307174954e-02   -1.083178376183502e-02   -6.819242968409531e-02   +2.784854006599925e-01   +3.044426766871347e-03   +5.905421310066177e-01   +6.728275921632554e-01; +3.563631867006117e-03   -4.219770596196528e-01   +1.557209340641465e-01   +4.959551198678614e-01   -2.228446717669231e-01   -1.598834722557734e-01   -8.146132905547626e-02   +1.895538327820810e-01   +4.471584574200550e-01; +1.881357037192498e-01   +2.782721713250320e-01   +4.030055614804781e-01   +4.091570622547563e-01   +5.240150043648004e-01   -5.316059903133862e-01   -4.501286422170775e-01   +4.143788412158622e-01   -8.058897141444227e-02; -5.718396195359818e-01   -5.628799368156283e-01   -9.313787453941415e-02   +4.694740460694266e-01   +2.762282930450710e-01   +1.632367386853534e-01   +3.010245724034020e-01   -3.473972113253573e-02   -2.463204671726740e-02; +2.391078133758859e-01   -5.286509966398892e-01   -1.789784586158346e-01   +2.983686240030335e-01   +5.586349459144444e-01   -6.013515598346376e-01   +3.093725652876200e-01   +2.969589761861202e-02   +7.785024796579401e-03];
L1_L2_iAMPA_netcon = [-1.329613849268249e-01   -3.769360263802652e-01   -3.395472892695152e-01   +4.000869551245445e-01   +2.057559700089647e-01   +3.774331760505826e-01   -2.200999632356830e-01   +4.704323161923291e-02   +1.024242102641961e-01; -6.462896840889598e-01   -7.531089659285936e-03   +2.105387831071096e-01   +4.371679502256274e-01   -2.366195016397939e-02   +3.197994503762343e-01   +3.977227935787870e-01   +5.800200039595603e-01   -1.046588255979634e-01; -1.482776330504297e-01   +2.937486082786103e-01   -1.171295698974332e-01   +2.397199862067726e-01   -2.927969780513492e-02   +1.506883509926367e-01   +4.388450383075873e-01   -4.011487169769449e-02   -2.098281819163133e-01; +7.131629925874897e-02   +7.360562083032604e-02   -1.995295062580200e-01   +3.801531575215781e-01   -1.111993174264564e-01   -9.855030632865112e-02   -2.330253462580053e-01   +4.241047742848747e-02   +7.392727143657535e-01; +7.965768592960435e-01   -2.184294746792305e-01   -3.080012525969506e-01   -1.271986945138235e-01   -5.198071018171059e-01   -1.703699167195127e-01   -1.639264742802155e-01   +5.223304097818068e-02   -1.448928649895234e-01; +3.641454666487030e-01   -1.733024504306824e-01   +2.096123311486722e-01   +2.917230506375886e-01   +4.011218532488199e-01   -6.482366113300148e-02   -2.896052798739676e-01   +8.299673332440563e-02   +1.025180626171633e-01; -1.808110734535587e-01   +4.600932683668322e-01   -3.323312000875081e-02   +6.405234255698181e-02   +2.212145089052117e-01   +6.242315153799019e-02   -5.462274510398342e-02   +1.624692909514303e-01   +1.490616454997791e-01; +2.339193723623683e-01   +3.256903230848970e-01   -2.254052948377290e-02   +2.176232610230708e-01   +3.227212363770915e-02   -3.983034463926751e-01   -6.260458542203597e-01   +4.028355870664171e-01   +3.425828716606448e-01; -1.275031104578808e-01   +2.758683561079431e-02   +8.431291150243825e-02   +6.991517019223237e-01   +1.527983228357911e-01   -9.023025891139804e-01   +2.731227801512992e-02   +1.287655421501760e-01   +9.756327893026881e-02];
L2_L5_iAMPA_netcon = [-2.927964036252990e-01   +2.024965552065355e-01   +4.064658764385734e-02   -3.274095069816256e-01   +2.655981390556722e-02   +2.092272456009660e-01   +1.749649715615570e-02   -1.100916889311011e-01   +2.481782303673915e-01; -3.633272401462583e-01   +2.186738919968723e-01   -3.153243291598847e-01   -1.259734783237124e-01   +2.052107377793395e-01   +4.002914688350063e-01   +5.546124980960241e-01   +5.881589039631354e-01   +3.106925231633251e-03; +6.396406026415954e-02   +1.670124771898123e-01   -2.405136328782796e-01   +3.006463695195871e-01   -6.341889113053374e-01   +7.730733136755162e-01   +4.018344038224689e-02   -1.162386106551700e-01   +7.114129222608930e-01; +3.132402798335042e-01   +3.878024456406300e-01   -2.801525174407705e-01   +1.812778929650055e-01   -1.999147366450725e-01   +8.099695949042041e-02   +1.352694606563031e-01   +5.434762687964937e-01   +6.269212003087554e-02; +4.191359169864598e-01   +5.529579523636718e-01   +1.882265352470829e-01   -2.934670863794346e-01   -1.514211103961066e-01   +1.116445248529424e-01   +3.441401790286420e-01   -7.558350324799475e-01   -2.939235926150151e-01; +2.332122765154066e-02   +1.014197127728827e-01   +1.019971879902131e-01   +3.835428380702588e-01   -4.554444350318418e-01   +1.048957866708606e-01   +7.667755139871352e-02   -5.669655633782638e-01   -4.121343792442966e-02];
L5_L2_iGABA_netcon = [+1.604932471192290e-01   +2.385053979153202e-01   +8.092935605179416e-02   +8.087703556878192e-02   +2.299764395326918e-01   -2.298713634168074e-01; -2.578440600786061e-02   +4.359179691075652e-01   +2.441713916637001e-01   +3.715641530036323e-01   +3.620727748661201e-01   +4.593814864653319e-01; +5.157541135093850e-01   +3.223803263354202e-01   +6.279401681136783e-01   -7.283172272198977e-01   +4.589156655063771e-01   -1.651835322763775e-01; -4.333695885794386e-01   +4.548101254346081e-02   -1.215735502895675e-01   -4.773007029351464e-01   -2.494918438648370e-01   -4.676334740163766e-01; +9.801614526452690e-02   +1.044169960811742e-01   -6.252637787050155e-01   +5.536259369008589e-01   -3.208201018374248e-01   +7.263266699526927e-02; -8.315871067184093e-02   -5.112509588682100e-01   -1.325347090290789e-01   +1.782671368131354e-01   +4.391308730669732e-01   +1.330492318931089e-01; +7.284663086305390e-01   -1.526519479354631e-01   +2.321912333559373e-02   +8.498903609048725e-01   -4.052093649939009e-02   +4.550397950695756e-01; +5.833499819880290e-01   -2.138769441603957e-01   -9.861931708641383e-02   +6.521059496886182e-01   -3.750782517636576e-01   +3.731739424441187e-02; +3.721478924810211e-01   -1.204373263869308e-02   -4.403640590570121e-01   -6.777317238167867e-01   +5.676468971299217e-02   -1.692427203513819e-01];
L3_L2_iAMPA_netcon = [+1.311959684903735e-01   +3.625164969749823e-01   +3.989751196959505e-01   +2.956734490505140e-02   +4.366896074263938e-01   -4.341063322456936e-01; +2.424703984068934e-01   +1.797513716224427e-01   -1.788865972442140e-01   -5.832229089104066e-01   -1.548977653673301e-01   +7.404036585226080e-02; +2.042871400803597e-01   -2.196053471779561e-01   +1.594921137036442e-01   -6.147791923457838e-02   -2.549292691424092e-01   -1.060626454832917e-02; +4.941660595045753e-01   -2.580150774083068e-01   +3.291983129045869e-01   +2.925340105081034e-01   +5.803229326089472e-01   +4.282961700709124e-02; +8.799238786698332e-02   +4.459305415451547e-01   +1.735790535179475e-01   -3.400533786144919e-02   +3.781374604303928e-01   +1.797065230380527e-01; +1.077866791695701e-01   +2.304675753401225e-01   +1.000000000000000e+00   +3.860416114080141e-01   -3.874218514751369e-03   -8.621575118042850e-01; +6.747022542519334e-01   +1.833031522434715e-01   +3.321620625831274e-01   -2.096963531630227e-01   -3.670417068604643e-01   +2.000649457725373e-01; -5.974433291663646e-01   +1.291581293767727e-01   +5.056746083248975e-01   +4.417469010747533e-01   +1.707046176924859e-01   +1.354752586073900e-01; +6.622964962813390e-01   +4.940059261178596e-02   -4.430481733216250e-01   +1.471763836002918e-01   +7.043112464170530e-02   -3.446602149892868e-01];
L2_L3_iGABA_netcon = [+7.381984479385050e-01   -1.581059293881379e-01   +5.298653252453172e-01   +3.053726849462651e-01   +3.042771569647701e-01   -1.681028655608941e-01   -1.215052763760785e-03   -7.536411857148162e-01   +5.617399900381992e-01; +4.031836946505657e-02   +5.297600460199210e-01   +4.063411965371747e-01   -1.753272511034921e-01   +7.667508115886325e-01   +1.580377081891132e-01   +4.654944276160761e-01   +1.417042564103842e-01   -8.516382679601250e-02; +4.306650077397137e-02   -1.462236172000077e-01   +3.595212352608380e-01   -3.829167800213414e-01   +6.753250579140514e-03   -1.251413514328326e-01   -2.328892868358763e-01   +4.567629698098699e-01   +3.597888476373096e-01; +3.585702867298801e-01   +1.248709949743168e-01   +2.677663098883988e-01   +1.809635178134441e-01   -1.585400149932600e-01   +6.040500518993749e-02   -8.502765821008496e-02   +1.191559602232359e-02   +5.071863120847422e-02; +5.405439162463661e-01   +1.678836778560751e-01   +9.043215931169007e-02   +3.839366128986897e-01   -1.594918017048812e-01   +1.285755865315312e-01   -8.965730017599319e-02   -1.068074097343236e-02   -1.677715419536407e-01; +5.488411643009066e-01   -1.616922784845125e-01   +4.152927750546555e-01   -3.447048970229689e-02   -3.793070819430786e-02   -1.098584482981527e-01   +5.131779792389268e-03   -2.886728409549035e-01   -2.345822358097197e-01];
L1_L4_iGABA_netcon = [-5.721738754017597e-01   -1.142648072191855e-01   -2.191236198732565e-01   +3.732582599631805e-01   +1.819900855249631e-01   +7.031339018093896e-01   +4.967871051966817e-01   -1.450541390818794e-01   -3.246772537616446e-02; +1.259508426162959e-01   -4.276791806918055e-01   -5.905226632092585e-02   -2.411094507262281e-01   -7.816188770186514e-01   -1.587236615738328e-01   +1.895495486926984e-01   +1.259910525979099e-01   -1.197993142951974e-01; +3.815579327404742e-01   -1.118218850777677e-01   +3.863214751295396e-01   -9.916635813597658e-03   +7.765917735714375e-02   -4.926271911043130e-01   -4.079677172795907e-01   +3.333142961333213e-01   +4.126079679151034e-01; +2.416754638326647e-01   +6.141096047026931e-02   -6.047832940690282e-01   -2.860997909160147e-01   -3.629706775391323e-02   +6.621492817127680e-01   +6.486865855599849e-02   -7.317151687299885e-02   -2.676731150573445e-01; -2.196269057417517e-01   -1.735200257567588e-01   +4.670530015555313e-01   +3.945724076791585e-02   +6.627495268790340e-02   -1.294803797266885e-01   -2.104717177233339e-01   +3.926759430478866e-01   -5.168760408605901e-01; +1.513142083786591e-01   +2.892873165584762e-01   -1.109811838695201e-01   +6.638092773406656e-02   +2.313756097044881e-01   -3.794316473218000e-01   -1.443876378912145e-01   +1.651651022767055e-01   +9.333740530037121e-01; -1.985619358919225e-01   +4.700464972729289e-01   -5.305308484679095e-01   -2.197044956764774e-02   +5.634108573406184e-01   -9.128136081592193e-02   +2.436641901633678e-01   +8.976183562254778e-02   +2.115380482415700e-01; -3.560736976773686e-01   +4.979970913042852e-01   +3.617863270590703e-01   +4.024574299211650e-01   -1.867548781781722e-01   +6.705072064477334e-01   +4.558055159062379e-01   +6.974159001110938e-01   -2.877381131801676e-01; -2.636595928845447e-01   +3.015170708704089e-01   -1.038387326815936e-01   +5.833126522474306e-01   -2.592761029664101e-01   -1.273908280224415e-01   -4.977252425169856e-01   +4.035174546957708e-01   +5.793625855416019e-01; -1.814169292577718e-01   +9.661348655866289e-02   +2.816353832709782e-01   -4.847265803832880e-01   +4.631445340868912e-01   +3.583201873789871e-01   +3.773885058707330e-01   -3.154552669702195e-01   +6.336240803954581e-01; +2.716344899148087e-01   -4.538051191931729e-01   +3.092786481445369e-01   -6.573417169984858e-02   +3.260630827913824e-01   -1.782917144817835e-01   -1.105197154358521e-01   +1.367318962505482e-01   +2.281189656366346e-01; -2.514714971743094e-01   -1.166577887870088e-01   -2.215424767129577e-01   -2.962513960147712e-01   +2.640521170589024e-01   +4.448034183286362e-02   +4.298324556381642e-01   +4.614099560173371e-02   +2.898707854290172e-01];
L4_L1_iAMPA_netcon = [+2.000557435899649e-01   -2.450932073080573e-01   +2.688149270434620e-01   +4.123878441393364e-01   +7.639577603520770e-01   +2.226677180728607e-01   -1.944334794420274e-01   -2.648146627390529e-01   +2.880706198609067e-01   +1.127096036755385e-01   -1.476032844120675e-02   -2.797621323695655e-01; +1.352036493363853e-01   -5.120705539695826e-01   +1.135432929768482e-01   +5.523927732934082e-01   +2.535181687151259e-01   +1.603087450441907e-01   +2.964655774774500e-01   -2.494707313164161e-01   -7.058837360943751e-02   -1.338447851086888e-01   +3.388962145243540e-01   +1.667956452549438e-01; -2.103399905608774e-01   +1.752560831935158e-01   +1.086345025888959e-01   +3.740375252134003e-01   -1.494176939607200e-01   +1.945690551727372e-02   +1.862693361418900e-01   +1.502005161357799e-01   +4.478563601231920e-01   +1.235151590305997e-01   -2.689417908661275e-01   +4.970052178179429e-02; +4.655205939326013e-01   +1.139478766390668e-01   -1.621918416388716e-01   +7.959781480712483e-01   +9.881954873047419e-02   +2.466180744288507e-01   -7.464935146360749e-02   +4.404129006385764e-01   -1.933442812100810e-01   -2.950135393260345e-01   +4.806024202188325e-01   -4.708188700975698e-01; -7.094393178328229e-02   +4.850358602364953e-01   +1.018668592341297e-01   +4.243813180461448e-01   -3.943845905972206e-01   +2.430597457292904e-01   -3.852479065104937e-02   -2.362618298370186e-01   -4.049975188592822e-01   +5.475584434661795e-01   +1.325535907913826e-01   +7.421715323080558e-02; +6.488923609053437e-02   +3.773432986658682e-01   -2.790437694545022e-01   +3.733019374932861e-01   +2.703124675853407e-01   +1.999250108518325e-01   +1.439426511199075e-01   +6.720461704018317e-02   -3.494526806402775e-01   +2.547569046519829e-01   +5.098683025859116e-01   -3.761196308353822e-01; -2.120161491367774e-01   +2.739208281328936e-01   +1.692668405568446e-01   +3.352716042841120e-02   +5.036449813658669e-01   +3.299868154566876e-01   +1.352087441530337e-01   +7.767210083178655e-01   -6.414721703883627e-01   -2.527583161018127e-01   +7.512402828254521e-01   +7.767897358855080e-03; -2.351199746927432e-01   +5.503453441702166e-02   +2.278894464724361e-01   -5.480006511578214e-01   +7.695408709995591e-02   -3.913472435424918e-01   -5.778017851511905e-02   -1.013327616180278e-01   +1.477112331402957e-01   -1.930907494516819e-01   -2.725034318580692e-01   -4.120658547565715e-01; -1.535118985856198e-01   -4.145710567600644e-01   +1.735661768218524e-02   +1.350190375729863e-01   +2.699264634915787e-01   -1.782838814078422e-01   +3.821200675882307e-01   +5.090080997995243e-01   +5.751310525195874e-02   -1.650300469408658e-01   +1.942831997444269e-01   -1.336924323837050e-01];
L1_L3_iAMPA_netcon = [+1.237563386688515e-01   +5.411008939532618e-01   +2.493901494637256e-02   +1.529782502129468e-01   +4.155620514948238e-01   -3.897683884389244e-02   +2.734676729715152e-01   +6.244170730805015e-01   -4.172802293723871e-01; +3.827288430194624e-01   -3.092234075966711e-01   +5.659493300684242e-01   -2.653999171171234e-01   -4.501364957382942e-01   -1.924077118962912e-01   +2.387647135612059e-01   -3.612887038607471e-01   -3.397470952326878e-01; +3.274308715918292e-01   -1.355722223507759e-01   +4.414754057118465e-02   -2.353846411932298e-01   +2.221510516628893e-01   -5.321169764753153e-01   -1.807282043336355e-01   -1.247494521506926e-01   +2.370492067480945e-01; -5.971509276499010e-01   -1.723612439588085e-02   +1.103700043857425e-01   +5.754181141063160e-01   -4.118623206914952e-02   -3.115636239136811e-01   +1.079456794054981e-01   +2.843372100962429e-01   -1.348357034941770e-01; +7.273608785766510e-01   +2.454757185823554e-01   -2.168857045253515e-01   +3.770145136180354e-01   -4.451825978619078e-01   +1.609458264995471e-02   +2.668735648112721e-01   -1.382310630429366e-01   +1.866790279348697e-01; +6.129060827973556e-01   -5.301046149010205e-01   +1.723049927533265e-01   -7.143751824369438e-02   +4.960253398169322e-01   +5.614621661913439e-01   +4.741742963202303e-01   +7.886135427108343e-01   +3.314094605628116e-02];
L3_L1_iGABA_netcon = [-1.610119007919429e-01   -2.918933629654747e-01   -5.672001707042024e-01   -2.803478163574179e-01   -6.554306092184375e-02   -4.511193281952275e-01; -5.423915460053763e-01   +1.622986397411872e-01   -3.095302205849161e-01   -3.038273627503386e-01   -3.519631250036661e-01   +2.152075216428233e-01; -2.450315661155403e-01   +2.243984888255641e-01   -1.802298677355679e-01   -8.498011537062790e-02   +5.684974960879023e-01   +4.479239067905181e-01; +1.613663427298749e-01   +6.735787759738173e-01   -6.510740565840795e-02   -4.565256997793355e-01   +5.700607780185307e-01   +7.339633321817295e-01; +3.020871115963057e-01   +1.281154186559816e-01   +1.098449115567559e-01   -5.952706282101469e-02   -6.650966370231029e-02   +4.745914451482616e-01; +3.829281868281197e-01   -2.398512862982854e-01   +2.541783537849818e-01   +2.909078479946109e-01   +9.003871228197013e-03   +1.975689552830107e-01; -1.825073384327473e-01   +1.890654254452926e-01   +6.150079500003093e-01   +6.735414951740951e-01   +1.813091523429120e-01   -2.562814069651770e-01; +5.383302976451958e-01   +3.491474336273226e-02   +5.176214994749406e-01   -1.711227247109596e-01   -5.772375581837854e-01   +2.833015867457763e-01; +4.641338652069687e-01   -6.347118904590332e-02   +2.718498714066235e-01   -3.280894960061321e-01   -2.153908959667087e-01   -1.297674962658699e-01];
L5_Input1_iAMPA_netcon = [-3.160715011062265e-01   -2.689043114856716e-01   -1.274409793747528e-01   +5.369614805011903e-01   +2.561593119252167e-01   -4.371726452932134e-01];
L6_Input2_iAMPA_netcon = [+4.848746584083631e-01   +1.723130478336723e-01   -3.566371650992936e-01   +4.650006751824567e-01   -7.095027018744384e-01   +2.886573128492792e-02];
L5_L6_iAMPA_netcon = [+8.911536452096933e-02   +2.881999248178670e-01   +2.674520242181077e-01   +5.818852632045771e-02   -3.161139406566652e-01   +3.817388567924105e-01; +7.538987232138393e-02   +2.744490377418404e-04   +8.662944748387471e-01   +2.357262749496945e-01   +3.472359636775260e-01   -5.389546376093263e-01; -8.584228432405330e-02   +2.603261196652179e-01   +2.927906055606712e-01   +5.557133805105766e-01   +7.618832862835369e-01   -3.839312520747379e-01; -5.832659921512980e-02   +4.208934566984628e-01   -6.818663196381955e-02   -2.860584874386084e-01   -1.931699766368098e-01   +4.419608641402972e-01; +4.413202789661942e-01   -1.744635744658720e-01   +1.435746496225323e-01   +6.308282090304730e-01   -4.656507169859626e-01   +1.302353924968655e-01; -8.139916581939838e-02   +5.666115930778102e-01   -1.491074237320460e-01   +2.074705045469913e-01   +1.573290937917343e-01   -3.845795053663731e-01];
L4_L5_iGABA_netcon = [-6.618393336833455e-01   +5.104907080162042e-01   +1.604922591321358e-01   +4.110866178931932e-01   -3.796274541274900e-01   +3.066758046528808e-01   -1.830041586241548e-01   -2.418720374960593e-01   +4.473460639161729e-01   +4.344358727185126e-01   -5.946929912903814e-02   -1.414573591661070e-01; +2.434905814845749e-01   +6.464222931114247e-01   +6.385751220011713e-01   -9.381366458007454e-04   +8.853182970523937e-02   +1.601705823960319e-01   +6.684155447209580e-02   -3.573839280893001e-02   -2.349415968585865e-01   +2.251657655849721e-01   +5.064664874792983e-01   -3.216473791546380e-01; +1.163307660877723e-01   -1.298847972270501e-01   +4.699059400085292e-01   -4.024963698068703e-01   -2.689998861961359e-01   +4.443525238658086e-02   +3.015461996131787e-01   +5.487771666616257e-01   +2.714669037949322e-01   +2.485362391146737e-02   -3.377142849067009e-02   +4.331572104321201e-01; -4.764532669191921e-01   +8.014474036149721e-02   -2.252748340426092e-01   -4.982483376934826e-03   +2.140195962545509e-01   +5.683694672818176e-01   +9.459555111432510e-02   +1.924457456469536e-02   -2.867140836386839e-02   +3.839441607281571e-01   +6.703696620368356e-01   -6.330576450745035e-02; +1.227191742432547e-01   -2.467946256457850e-01   +3.547503862334016e-01   +1.212009071521911e-02   +5.021573899056314e-01   -6.526644808895533e-02   +2.606252716535870e-01   +1.640432583807664e-01   +1.505935787175581e-01   +4.848659691866342e-02   +7.142823716478904e-01   +2.977161187120639e-02; +5.647822767932266e-01   +1.409770212479736e-01   -5.530264313519708e-01   -7.017429956790311e-01   -1.590321549286719e-01   +1.524868704010301e-01   +3.350291175061810e-01   +5.515246027762015e-01   +4.302246026704842e-02   -1.454792277056627e-01   +2.090527947175827e-01   +1.378853474161625e-01];
L6_L4_iAMPA_netcon = [+5.468398355205631e-02   -4.474983352038430e-01   -1.419496904315963e-01   +2.186897097723515e-01   +2.600100952896456e-01   -1.028123329291476e-01; +1.423664735708250e-01   +4.445624489274152e-02   -4.759708482152413e-01   +8.045687788976399e-02   +5.178253774750227e-01   +4.772109622851780e-01; +7.994871468990269e-03   -4.605395581743698e-01   -3.865711175934071e-01   -3.794487456384984e-01   -7.887405632091404e-02   -1.978778994924803e-01; +3.845502970620162e-01   -4.657501086958276e-02   +1.242297893209994e-01   -3.182726580702531e-01   -3.013291072544123e-01   +1.000000000000000e+00; -3.333738991018758e-01   +5.564008957462468e-01   +1.021697083196608e-01   +2.560229236144688e-01   +1.922130833041899e-01   +1.722070348534338e-01; -3.609027632826431e-02   +5.817566704882942e-01   -4.242824905575080e-03   +3.185036715055149e-01   +3.538891541658019e-02   -4.459214211901905e-01; +2.346691842460613e-01   -2.638355185679855e-01   -3.081715994384228e-01   -1.779864518110786e-01   -4.041219827896920e-01   +2.670111005575588e-01; +2.872375130260351e-01   +3.380275270751606e-01   +5.243278720000076e-01   +4.268570054289331e-02   -1.085810587202379e-01   -4.127248357579136e-01; -2.320328654647496e-02   +2.455133065692326e-01   +3.230244641767389e-01   +4.973251022819377e-01   -2.910975388924649e-01   +2.893886194596816e-02; -2.400162400040295e-01   -3.467690142237181e-01   +8.507126492775108e-02   -2.827579716100930e-01   +4.462393004984498e-02   -1.993124096042329e-01; +9.424034019341601e-02   +7.224203805298504e-02   -2.587742672460298e-01   +1.982462471859785e-01   +6.748215320488722e-02   -2.327582787313130e-01; +8.157080740951628e-01   +2.694271818793575e-02   +1.615190668776553e-01   -1.187969827273662e-01   -1.333616582184986e-01   +7.269145189439395e-02];
L5_L4_iAMPA_netcon = [-4.207545565730894e-02   -1.042896011152268e-01   -4.090614524630685e-01   -2.584057086145580e-01   +6.603007049416978e-03   +3.462752705912924e-01; +3.646236913635229e-01   -3.251032167199706e-01   -3.559883133752462e-02   -2.438478947320841e-01   +2.996316490709756e-01   +5.632216263901511e-01; +1.321384652461199e-01   +2.856935206083341e-01   +2.414172631305162e-01   -2.725677481803284e-02   -4.485804408232680e-01   -2.597444411580280e-01; +1.793052221247148e-01   -2.440192788782867e-01   -8.866704762825528e-02   +3.642419381918737e-01   +4.758034008581401e-03   -7.791592960928338e-02; +5.548058913415368e-02   +5.956046407623968e-01   +7.603008895887189e-01   -2.411762015085700e-02   +3.940976552094894e-02   -1.391365151284229e-01; +3.574399910673867e-02   +1.257391112973354e-01   +5.055865825888564e-01   -2.537839454431334e-02   -5.561345455868804e-01   +7.818401534494297e-02; +1.565497556048113e-01   +1.828002462680547e-01   +3.785509322207799e-01   -7.997695870016491e-02   -2.485017466980224e-02   -2.079957109317207e-02; +4.777195240874588e-02   +4.061323113106911e-01   +4.085111417496633e-01   +5.602019481737120e-01   -8.066104858017565e-01   +4.124335198509189e-01; -4.405461416791906e-02   +3.137328854381526e-01   -2.139237529213146e-01   +1.591756629057723e-01   -1.935865222408326e-01   +1.547488878358497e-01; +4.874671667993515e-01   +6.674103517527161e-03   -2.423153354947286e-01   -3.271995549060102e-01   -4.532307701738479e-03   -2.812409066917704e-01; -2.815351181992049e-01   -5.943321644914966e-01   -1.582879374118655e-01   -3.694322542408561e-01   -1.506166454376289e-01   -4.007248960152982e-01; +4.360518872635801e-01   -1.628538017911715e-01   +1.335166602996146e-02   +1.004015032762108e-01   +4.411771516391869e-03   +1.181675723499543e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
