function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-6.388319084896668e-01   +5.414589254938976e-01   -8.844988233552051e-02   -2.091432691092729e-01   -2.158757153086943e-01   -1.552974297928800e-01   -4.269977361658324e-01   +5.863948441680444e-01   -4.289062388383301e-01; +3.818753008696888e-01   +4.794504541598327e-01   -8.059215198324070e-01   -3.076790017690373e-01   +2.067973764468883e-01   -8.677592147401247e-02   +1.266941424888009e-01   +8.602488252780316e-03   -1.705353278642586e-01; +1.752465317646294e-01   -5.905372815743082e-02   -2.425403937516549e-01   -8.420018165909890e-01   -5.594395536710051e-02   +6.074891666086450e-01   -4.533208614097625e-02   +1.290456968513700e-01   +3.162534861039863e-01; -3.661599619992362e-01   -1.156025558687184e-01   +3.535050426470878e-01   +4.533409519847169e-01   +8.680294331098093e-02   -2.992667165386528e-01   -3.379878407247662e-01   -3.980719582549594e-01   -5.553096267901210e-01; -4.170329085876107e-01   +9.893304023071148e-03   +5.159301900723437e-02   -1.622171377022638e-01   -4.243059422394252e-01   +7.124333815073725e-01   +3.478931713004182e-01   +2.975525608109275e-01   +2.875705742442326e-01; -2.430110683823929e-02   -6.868608320417354e-01   -1.300529454906457e-01   +5.481929290620680e-01   +5.275010775454809e-01   -5.269535564927905e-01   -3.906964563592813e-01   -1.367246783321256e-01   +4.933958945009945e-01; +7.599751078209933e-01   +2.161533986710544e-01   -1.713130802649911e-01   +1.936282928886712e-01   -9.537860227963907e-03   -1.431320393755102e-02   -8.927200789446673e-01   +3.919161337814332e-01   -1.757181255574908e-01; -6.315138138786611e-01   -4.185585808670507e-01   +3.000931455177189e-01   +2.343670636127161e-02   +3.369741022773663e-01   -3.150199178698718e-02   +3.635422056525269e-01   +3.308571844733494e-01   -4.349138137884770e-02; -8.317376066836486e-02   -5.014761214311643e-01   -1.673153982067450e-01   -2.670135392501186e-01   -4.056627438191822e-01   +2.672496589773294e-01   +4.899181840970040e-01   -1.749932995409259e-01   +6.150890031688205e-01];
L1_L2_iAMPA_netcon = [-4.078182456795310e-01   +5.632100226527481e-01   -5.325736404091812e-01   +3.287445351657632e-01   -1.947528992326082e-01   -8.456591445884820e-02   -1.086336750076175e-01   +4.746700442177373e-01   +3.301388573139322e-02; -2.931855698947316e-01   +7.029052994094923e-02   +3.916076525465726e-01   +3.517170881178363e-01   +2.590576426501898e-01   -2.958681577733975e-01   +6.834412301454477e-01   -3.781710764494290e-01   -3.715894393370530e-01; -1.395969063018633e-01   +4.035564519612765e-01   +4.240763709917220e-01   -1.136370731413621e-02   -2.280903937845708e-02   +2.141993132411995e-01   +5.234861789238818e-01   -3.496507226453425e-01   +1.056142966272745e-01; -8.379846076388428e-02   +3.373563420269439e-01   +1.193347664565246e-01   +2.568312443008516e-01   +2.953294327082870e-01   +6.588773111010034e-02   +2.434822273601699e-01   +5.021794441573125e-01   -2.491515651919107e-01; -5.669956189645371e-01   -3.582891260280704e-01   +4.158174592778193e-01   -8.171091995564032e-02   -3.573032613564681e-01   -1.000000000000000e+00   -3.911074088228664e-01   -4.197788661228482e-01   +2.542414193014829e-03; +3.559079474352739e-01   -4.243077909666325e-01   -1.032533102910508e-01   +3.116432551587932e-01   -7.675952568072535e-02   -1.186236667053238e-01   -3.362474547890831e-01   +1.043808554501229e-01   +7.029399741401443e-02; +2.935929905309911e-01   +1.184796124468816e-02   -3.300479187957129e-01   +2.126195273862977e-01   -1.582984008285740e-01   -1.725285705391183e-01   +4.317432025749163e-01   -3.050095181176631e-01   +6.951447282107732e-01; -6.136849673173114e-01   +3.968634971684037e-01   +3.219162116389195e-01   -5.537714659542491e-01   +3.969115341773445e-01   +5.009487205252442e-02   -2.316072522013365e-01   +4.381834399941867e-01   +5.644277161449994e-02; +4.665894312208734e-01   +1.227140577929970e-01   -2.433215590574912e-01   -2.444053960091223e-01   +1.678522576435378e-01   -1.152725997183456e-02   +1.658871768921428e-01   +1.395487227962813e-01   +3.827862574233815e-02];
L2_L5_iAMPA_netcon = [-2.853978571032695e-01   +1.515182064506525e-01   +1.136307033319186e-01   -4.143553041316249e-01   +1.452667719579342e-01   -3.721721371401277e-01   -5.712065189888927e-01   -7.002182261198280e-01   +7.181857008627135e-02; -5.505967790919958e-01   -2.060385929489278e-01   -1.208764552030626e-01   +1.067520949847856e-01   +1.338714309599419e-01   -2.742819191796316e-01   -9.187288312126532e-02   +2.082812008775795e-02   +3.094924602496748e-01; -2.183435444796372e-01   +2.726225377942462e-01   +1.094766797992834e-01   -1.214006332418860e-01   -2.062554069987630e-01   -1.590292571643775e-01   +3.782048111260122e-02   +1.050891672199057e-01   +5.352416031777156e-01; -2.636607084507029e-01   +2.384787898024477e-01   -6.452814795315662e-01   +9.103059301948901e-02   +9.685298916480831e-02   -2.908986947336493e-01   -1.540158868340183e-01   +4.292726267159591e-01   +4.610793857130425e-01; +3.499151346607672e-01   +4.389042772810731e-01   -4.553780054066637e-01   -3.117237121650200e-01   -3.733165744002377e-02   +3.378193390760251e-01   -2.038152463083870e-01   -5.890130035933745e-01   +3.875582100370484e-02; +1.194729493487676e-01   +1.710837283609738e-01   +4.424923042180969e-01   -1.089119008718279e-01   +2.345074829355068e-02   +2.761621819898711e-01   +4.954699182921490e-02   -8.596238342736932e-02   -4.377688178775602e-01];
L5_L2_iGABA_netcon = [-4.642371059163015e-01   +2.991724964223312e-01   -4.279541726581591e-01   -5.240899607972899e-01   -3.683489145751875e-01   -7.859175895715387e-02; +1.235648323531278e-01   +2.427977893298266e-01   -6.291834496258075e-02   +2.902621759568030e-02   -2.999610249272003e-01   +1.255778178988487e-01; -3.442553232396421e-01   +1.946741220698215e-01   +4.226061518871219e-01   -4.876832355296982e-01   +5.280611493602132e-01   -2.823060861425609e-01; -1.965261574233458e-01   +7.317752065719541e-01   +2.884749271353547e-01   -2.047433164366800e-01   -8.738321962837733e-02   -8.176550421378850e-01; +2.991818954087314e-01   +1.199530903392285e-01   -1.601081401704393e-01   -4.397217911356736e-02   -2.779633081845896e-01   +4.241122168009892e-02; +1.682323049965195e-02   -7.107650303361110e-01   -6.583810938953753e-02   -1.329239106876284e-01   +2.006072965439982e-01   -1.730806563498976e-01; +4.896017676221680e-02   +4.872946192864938e-01   +8.704393817942724e-02   -1.095917136492204e-01   -7.538709076885480e-02   +4.030393708377406e-01; +3.976359251044187e-01   -4.108592467416041e-01   +2.227765006019479e-01   -5.690116177839831e-01   -1.253025502846455e-02   +1.661327060166763e-01; -1.965949831510804e-01   +1.755465934336290e-01   -1.527296003019072e-01   +3.498993762509528e-02   +1.397753617868011e-01   +3.649213319563818e-01];
L3_L2_iAMPA_netcon = [+5.426935602218105e-01   +6.033196259016151e-01   +5.328892520441707e-01   -2.825466982558056e-01   -1.091269910452170e-01   -2.115901342577182e-01; +9.773391190907249e-02   +2.833925281668892e-01   -1.362093923220581e-01   -5.767932759828348e-02   -2.114086411343377e-02   -3.009290581049855e-01; +8.068229798037571e-02   +2.792829984118927e-02   -2.074498578687405e-01   -3.519685646382498e-01   +4.560895508657092e-01   -3.071300563140832e-01; +1.955906101418449e-01   -3.091863506291401e-01   -5.503013487382535e-01   +5.002898792767008e-01   +1.417953550690330e-01   -6.911807237021084e-02; +2.596091826012781e-03   +2.887385930479559e-01   -5.244540376544041e-01   +1.829379613074084e-03   -4.177436001294431e-01   -4.146282103260987e-02; -3.691655773100490e-01   +1.134316647779602e-01   +7.948571481606740e-01   +1.066515202325465e-02   +1.462648365000078e-01   -1.832840025669255e-01; +4.916137046013861e-01   +4.904378930741365e-01   +2.072167803859343e-01   -1.960524087613090e-01   -2.516456176426232e-01   -5.040127373604885e-01; -5.757683353577844e-01   -3.095989478737236e-01   +7.855081905655437e-01   +3.094545454983599e-01   +3.338092722809771e-01   +1.829801188160309e-01; +3.861354915558054e-01   -2.139249953392969e-02   -6.175786746662032e-01   -8.034206510890615e-02   +1.338199763690267e-01   +2.482814243611520e-01];
L2_L3_iGABA_netcon = [+3.287671845139136e-01   +8.409188434069664e-02   -4.513213845546850e-01   -2.121800139941993e-01   -8.021964344207277e-01   +1.533672552612868e-01   +1.851446117267005e-01   -5.671483615725060e-01   -8.832351169926653e-02; -1.236922567258729e-01   +2.022494986908866e-01   -6.878262966085712e-02   -3.379627788128025e-01   +1.951454978790617e-01   -1.126799073564635e-01   +1.774672397888190e-01   -6.171526531325917e-01   +2.934257041236688e-01; +4.283240800626925e-01   +4.111291379631605e-01   -2.280474748692170e-01   +6.276998623948840e-02   +3.744677511477987e-02   -4.519970525475877e-01   -6.626548429944998e-01   +4.156212624894267e-01   +2.027274433118501e-02; +2.648256334865505e-01   +1.771312080713026e-01   -1.284762226594308e-01   +2.155711865851963e-01   -3.271395355540022e-01   +3.710825662362219e-01   -1.346744538949551e-02   +4.412133340692456e-01   -4.837153818708212e-02; +4.814658940558542e-02   +1.224358399381617e-01   +6.307667035622853e-01   +3.459080286706002e-01   -7.023894763901315e-01   +9.691873587207800e-02   -4.484613821885697e-03   -9.804569799399918e-02   -3.772564140253922e-01; +1.485101938661060e-01   +4.049486160312137e-01   +1.347580414902118e-02   +2.981635833883897e-01   -2.986188895404472e-01   -3.415188942707694e-01   -8.581806021496945e-02   +1.102858286668899e-01   +5.851671682427126e-02];
L1_L4_iGABA_netcon = [-9.859162595332224e-01   +2.219804764162964e-01   +1.408993042110526e-01   +2.894150326188363e-01   +4.149512856949863e-02   +9.418651522242074e-01   -3.693317900160413e-01   -9.417708420714954e-02   -1.722429601376664e-01; -2.968498815179438e-01   -1.259652461832099e-01   -9.840078639165009e-02   -3.160226363553101e-01   -3.421421403611411e-01   +2.271135289843293e-01   +3.129741812378868e-01   +5.012657369052356e-01   +2.151197016812393e-01; +8.483924378941377e-02   +1.324647891287206e-01   +5.790040082651066e-01   +3.400134351807166e-01   -2.076752746667707e-02   -5.246714680331969e-01   -4.037911880292910e-01   +3.674182110231617e-01   +2.494752763313891e-01; -2.163503812924968e-01   -8.370395783542026e-02   +3.814642121692090e-01   -4.658244585903871e-01   -2.064753940907302e-01   +6.519883882665130e-01   +2.474930570241078e-01   -3.676105744424070e-01   -1.048704637219371e-01; -4.586276476806816e-02   -4.498758352698894e-01   +5.873707289553121e-02   -2.835852911552011e-01   -2.990714182931912e-01   +2.459987735723027e-01   +1.615833115868059e-02   +2.326728372050077e-01   -7.034908422290759e-01; -2.720811160190328e-01   -2.695926215196592e-01   +3.221654775017465e-01   +5.687837674436007e-02   +9.688632374055077e-01   -3.093872053134537e-01   -8.806426638714460e-02   -1.493371776920392e-01   +1.324841436643168e-01; -1.734461244353659e-01   -4.580924764695662e-01   -3.227581140063602e-01   -2.854144672911905e-01   +2.065796711891909e-01   -1.280654801756841e-01   +4.611083202640277e-01   +5.279933640412784e-01   -6.758789112016003e-01; -3.074637178534929e-01   +2.891155964185455e-01   +9.677514697440532e-01   +6.271274665819450e-01   -1.873389727462988e-01   -1.498310968686649e-01   +3.127787307633290e-01   +2.343133838050347e-01   +4.314173450394682e-01; -2.611757070053064e-01   -2.771274295437235e-01   +7.915224973197343e-01   -2.591546865540602e-01   -2.911584518453830e-01   -2.186016395701303e-01   -1.217234097636308e-02   -9.999703070092694e-02   +2.016855787750259e-01; -2.459240031487111e-01   -7.809863438961744e-01   -1.315476367830969e-01   -7.641658162656162e-02   +1.352048437206439e-01   -1.105427014094846e-01   +5.843622520740430e-01   -2.568093309336734e-01   +6.451726589852012e-01; -6.593892492288027e-02   -2.062884412250103e-01   +6.674264074522522e-01   -1.807817498428116e-01   -4.126852017047278e-02   +1.402820947972510e-01   +5.270311575259901e-01   +5.257107789387052e-01   +5.205424874670531e-02; -1.380117379341386e-01   -2.083985815180823e-01   -5.145375815336297e-01   -1.647678483749931e-01   +5.181862255557265e-02   +2.111640249251183e-01   +2.216091727362179e-02   +2.475470757177858e-01   +3.380201648599296e-01];
L4_L1_iAMPA_netcon = [+5.419552877766085e-01   +2.568776840852967e-01   +4.968662515479939e-01   +3.851058623203830e-01   +3.497735839173798e-01   +3.962017429239776e-01   +4.543983578214712e-02   +3.252109396044096e-01   -4.505966577205510e-01   -6.841627926013254e-01   +4.847824206722501e-04   -3.885695430467514e-01; +4.616048151683839e-01   -5.357930212929308e-01   +1.641152019513537e-01   -2.243396566860872e-03   +4.022638002894632e-01   +6.138471184659899e-01   +8.070957179295803e-02   -9.962231257789833e-03   -6.145722954213431e-01   +3.952233095347509e-01   -2.071138614420646e-01   +1.145836158065542e-01; +1.162673062893284e-01   +1.917641896890419e-01   +1.680841130911044e-01   +5.609928303730386e-01   -4.846464039989236e-01   -1.154393678984445e-01   +8.685773758270157e-02   -9.893925649589241e-02   -2.293591369934923e-01   +1.595112899380592e-01   +3.345503407961367e-01   -6.881422124059312e-02; +2.534769583441742e-01   -1.544523227210209e-01   +4.109434363315667e-01   +7.439246719699150e-01   +1.810303497304961e-01   +1.604928749888824e-01   +2.734702004461113e-02   +2.798314162054217e-01   -3.817750459405987e-01   +3.221913542236786e-01   +5.200645949560716e-01   +2.909876781437407e-01; +6.691974083676508e-02   +5.748010546725803e-02   +1.341378745798932e-01   +1.491743653200466e-01   +1.883163193862781e-01   -3.244382758153423e-01   -7.875710864459579e-02   -8.322514412397092e-02   -5.663254700893506e-01   +2.084238772710037e-01   -4.090332726975196e-01   -6.994094422460909e-01; +1.258854009415769e-01   -1.052624472186734e-01   -2.787694122533067e-01   -2.202417353337971e-02   -2.581377478787698e-01   -4.631211420062668e-02   -1.295732233631628e-01   -4.797740947225528e-01   +3.217657224655703e-01   +4.234918151488623e-01   +6.365563018575248e-01   -5.370078565568377e-01; +5.397172199815947e-02   +3.374695541273295e-01   +2.724822858411249e-01   -3.614629114902893e-01   +3.175316349166906e-01   +5.381687341902437e-01   +5.793482144900295e-01   +4.126600434107288e-01   -2.285266426620285e-01   +4.744498014456896e-01   +3.357409929571134e-01   -9.531380010655623e-02; -1.943714018332383e-01   -1.401246411506488e-01   -2.672944682995748e-01   -3.665714671731966e-01   +1.481812089987522e-02   -3.120637537300073e-01   -7.496016884181887e-02   +2.360257845256813e-01   -4.396013711568649e-01   +3.129020468179577e-02   +1.947341830272438e-01   -6.977416834677699e-01; +4.161060941302587e-01   -7.122818733986680e-03   -6.812452994556948e-01   +1.251177471118468e-01   -3.124551891477153e-01   -4.321332940763261e-01   +3.277421061346847e-01   +3.451111946107937e-01   +1.542516194244558e-01   +3.978905289770851e-03   -4.190417112073571e-01   +7.225935306236888e-01];
L1_L3_iAMPA_netcon = [+8.592389508664899e-02   +3.011794006714344e-02   -3.959226427266019e-01   +6.171284107851018e-01   -1.171984059213683e-01   -3.082860493567704e-01   +2.174518715496068e-01   -1.823077653883559e-02   +2.057057509717389e-01; -3.053253350309779e-01   -4.171828184567819e-02   +3.782904180372268e-01   +2.307458289097711e-02   -1.535691070109616e-01   -5.270326044324748e-01   -1.790490789441341e-01   -4.661703316960125e-02   -2.948349003968953e-03; -3.248760297915643e-01   +3.309360447450178e-01   -1.678063029307143e-01   -3.103220397575128e-01   +5.298466408674608e-01   -6.187924607628825e-01   -4.333232518601281e-02   -3.868219683897696e-01   +2.341979817615391e-01; -5.726743822262839e-01   -3.657850065965695e-02   +1.826571284623228e-01   +1.417777755948806e-01   +5.240170036657447e-01   -3.212209833341385e-01   +3.776117363991477e-01   +2.982024489239831e-01   -2.937417299592474e-03; +7.000900301199269e-01   -1.013324677329673e-01   +3.947152959166789e-02   -1.392129504751398e-01   -4.686645459330686e-01   -3.299376869268802e-01   +3.920001281416138e-01   -5.399183534265279e-01   -1.158623845798604e-01; -1.372598698302872e-01   -6.475561531119358e-01   +1.146547522240795e-01   -3.982637507208936e-02   +3.050985742245042e-01   +3.200422657738624e-01   +6.274351205997143e-01   +5.154277777372140e-01   -1.158967566968531e-01];
L3_L1_iGABA_netcon = [-2.718054818402734e-01   -5.170014148156477e-01   +2.660103596281788e-02   +8.778130780815455e-02   +7.381841793899488e-02   -3.446973953444753e-02; -1.746425219800735e-01   -3.910210909791795e-01   -3.293321388188215e-01   +4.126056071843300e-01   -4.499756785045009e-01   +3.854668232615152e-02; -2.450795009196307e-01   +7.703809612339956e-01   +4.290043352806300e-02   -8.063777245435653e-01   +6.367064238083341e-02   +2.684485538264976e-01; +3.838090633322385e-01   -1.353727420658862e-01   -3.016439663577940e-01   -6.165871464156417e-02   +4.859402720287656e-01   +4.102121350743679e-01; +5.260412473028977e-01   -1.997753255490433e-01   +6.069816986666668e-01   -9.122819143577895e-02   -2.198326214047958e-01   +1.398864468781150e-01; +2.160763182311841e-01   -2.767774180528047e-01   -1.548761046392968e-01   +8.898520387932771e-01   +5.597908239540251e-01   -1.551480709236231e-01; -3.520157952130470e-01   +5.676146815778700e-01   +1.851418172524848e-01   +2.810574903572168e-01   -3.401716116844767e-01   -4.648616353212509e-02; +5.846821574422870e-02   +2.681565347850435e-01   -3.066109405662456e-01   +8.769489830636412e-02   +5.519644429686938e-01   +9.480600729325815e-02; -3.006901538692107e-01   +1.231515010783053e-01   +4.656393834080442e-01   -5.330836840959456e-01   -6.590467985062994e-01   +2.574870683877123e-02];
L5_Input1_iAMPA_netcon = [-7.898960408358915e-02   -1.083532770349817e-01   +9.619910736350958e-01   +3.940771284242867e-01   -3.110244089236712e-02   -2.499049412203247e-01];
L6_Input2_iAMPA_netcon = [-1.542711539500122e-01   +5.254059327693605e-01   -6.182764015473978e-01   +5.744059000501911e-02   -3.823441309614100e-01   +9.432237174982679e-02];
L5_L6_iAMPA_netcon = [+4.527763053925155e-02   +7.904227918733689e-02   -3.044493424711405e-01   +5.349068499794184e-01   -2.968078584836001e-01   -2.442572571945950e-01; +2.156021060930624e-01   +1.552936303444023e-01   +9.836041213365027e-02   -1.506346987625025e-01   +6.587200594352418e-01   -1.793486291899146e-01; +1.484229424454177e-01   +1.981988722001163e-01   +7.742224172656942e-02   -1.660173903551162e-01   +1.373818594668919e-01   -1.128993509128901e-01; +4.663556868057853e-01   -1.445562076682271e-01   -3.785024483122765e-01   -7.527730393291423e-01   +2.742461689226217e-01   +1.103390357339868e-01; -4.608052425893678e-01   +1.230351177092970e-01   -5.239924015666348e-01   +2.530890704820365e-02   -4.895512148503068e-01   +7.540411669134273e-01; +8.586589798928636e-02   -3.910767612947648e-01   -2.563707830370787e-01   +8.397235929415771e-02   +9.132104325509394e-02   +3.012845555643837e-01];
L4_L5_iGABA_netcon = [-1.492234650094572e-01   +6.389675432681957e-01   +6.532821974279212e-01   +4.268931435786745e-01   -1.601551520036189e-01   +8.956982225217176e-01   +6.143784576971767e-02   -1.037448574105040e-01   -2.169333502642768e-01   +2.212826158937451e-01   +6.371145027308238e-01   +1.438805580126940e-01; +1.109241183768750e-02   -1.855491985272480e-01   +5.011532844299126e-01   +5.520685403324262e-02   -1.551677000291136e-01   -1.488044013437722e-01   +1.289341036505707e-02   +4.851562537695486e-01   +1.418971311465612e-01   -3.647958523630772e-01   +4.087273366045123e-01   +1.631011708025237e-01; -4.335750933972651e-01   -7.126535906381118e-01   +2.350898448239634e-01   -3.120975066927397e-01   -5.343640427255497e-01   -2.317168791415499e-01   +8.190802767084789e-02   -9.472635042732337e-03   -1.484252704802901e-01   +6.665031487150541e-01   -7.799371976227108e-02   +3.101449272839508e-02; -3.351840788554244e-01   +1.607479462337539e-01   -3.964054531278217e-01   +1.321735292563487e-01   +6.501810725864814e-01   +1.003642427299893e-01   +8.304719078938802e-02   -1.732293425045307e-01   +1.902955199280281e-01   +2.939005855690306e-01   +1.000000000000000e+00   +4.283513279686587e-01; +1.463148676877324e-01   +1.370005841742274e-01   +1.886142118488248e-01   +2.463829179320083e-01   +2.037015791068492e-01   +7.719407143691445e-02   -1.881499370675327e-01   -2.152554394355575e-01   +5.477855973700622e-01   +2.122690185594620e-01   +2.783876624738476e-01   +2.852310693418798e-01; -5.415013123062908e-01   -1.038073543979788e-01   -6.534958742440230e-01   -2.816336860894045e-01   -4.031793070739866e-01   -2.246932946902616e-01   +2.453633935293310e-01   +7.351355906834008e-01   +6.166483748902769e-01   +4.143162159589889e-01   +3.915464763485971e-01   +3.404334948776349e-01];
L6_L4_iAMPA_netcon = [+1.084541416525771e-02   -3.678527068258785e-01   -3.296295490689490e-01   +1.493372058091564e-01   +7.454626878120745e-01   -1.755630703360123e-02; -6.882637096008156e-01   -7.314340481414376e-01   +4.534344845330537e-01   -3.165653023860840e-01   +1.818660188793164e-01   -1.510529144371594e-01; -6.976566622378291e-01   -4.882240364222234e-01   +3.631313784166508e-01   +5.109584169985806e-02   +4.193925523887483e-01   +1.968253223675170e-02; +7.249971441636395e-01   -4.449538128508690e-01   -5.160075669768384e-01   -9.968970317500700e-02   -2.994760931204284e-01   +2.341833203262074e-01; -4.910151748912100e-01   +2.974053226730221e-01   +6.927329844692950e-02   +2.864905352410156e-01   -4.548004074000210e-01   -3.189047382590572e-01; -4.710344933615523e-01   +7.589529450646906e-01   +5.037127741421698e-01   +1.266924060773178e-02   +1.705979893300665e-01   +4.664771572732370e-01; +6.645195134007820e-01   -6.131106338974797e-03   -6.284119642101699e-01   +3.947253371074551e-01   +1.777688276238862e-02   +4.549196217271212e-02; +1.269192627953974e-01   -3.365798595254336e-01   +3.142757981954160e-01   -6.198109441739780e-02   -2.024747287544721e-01   -4.748805767204727e-01; -3.436382588725212e-01   +3.583348325310537e-01   -2.427179549575181e-01   -2.975154178293647e-01   +1.280694581757526e-01   -1.319486191100534e-01; -3.555518633604843e-01   +1.930275357522372e-01   +4.785255959911025e-01   -5.098493707272578e-01   +8.050027306541299e-01   -3.199588174366496e-01; -3.431807241568969e-01   -2.166349843758196e-01   +1.962594583194099e-01   -3.983308155894441e-02   +4.387986998929653e-01   -9.299519036256912e-02; +8.243706504503419e-01   -1.789368690378364e-01   +2.637661521259478e-01   +2.829490520392157e-01   -6.851355945749488e-02   +9.997261132905508e-02];
L5_L4_iAMPA_netcon = [-5.171306408581529e-01   +6.940867638202325e-02   -4.112350828402407e-01   -1.832734351971427e-01   +3.330424803914927e-01   +4.534444215793280e-01; -2.449982605182873e-01   +8.857297194623645e-02   -2.647882384318974e-01   +4.898461342042182e-02   -1.485235546751819e-01   -2.942620606077083e-01; -1.386411554420778e-01   +6.121031994813415e-01   +3.682185286809790e-01   +5.295800884719941e-01   +3.175496270897207e-01   +2.799714675465164e-01; +2.339714184316358e-02   -6.239668145019839e-01   -1.578867295494591e-01   +5.490285099666196e-02   -2.155977731560276e-01   +1.439195798566602e-01; +2.151564522614835e-02   +5.999735934699872e-01   +3.526458780938095e-01   +2.423323080888927e-01   -3.915095482651409e-02   -5.023957813766804e-01; -2.281407253875154e-01   -2.563477188912283e-01   +9.248095853021010e-01   +1.204604217128528e-01   -2.952606734452541e-01   -2.062139182228782e-01; +3.074870230975703e-01   -7.056433541247403e-02   -2.651640079630863e-01   -4.227573091854995e-02   +2.741377894945888e-01   +1.933071423110710e-01; +5.797248132049171e-02   +6.243452060016477e-01   +3.385342926387461e-01   +8.257405052149347e-02   -6.102940334770419e-01   +3.965329184095758e-01; -4.565944330855902e-02   -1.018799355809539e-01   +3.191676670879387e-02   +2.280445033250424e-01   +1.859065955519979e-01   +5.977892941149205e-01; +2.674304812562310e-01   +8.114934825319311e-01   -4.637131357466638e-01   +2.685574367794261e-01   -5.083284125577404e-01   -2.953337300656208e-01; -5.887272633481572e-03   -7.971338151102746e-01   +2.148372461781614e-01   +4.171506424203352e-01   -7.599209986303266e-01   -4.054799491679711e-01; +5.746887828007431e-01   -5.497678714711043e-01   +9.039712456406736e-02   -3.263515327281937e-01   -5.501676899042641e-01   +4.724906726220002e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
