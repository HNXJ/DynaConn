function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-8.579471455207612e-02   +7.119684759472997e-02   +1.327149970580218e-01   -2.837176725831790e-01   -4.315405530752586e-02   -1.564307700228583e-01   +2.847710573024371e-01   -6.454178497211099e-02   -1.627496714066227e-02; +1.379738353853041e-01   +1.393337532900984e-01   +2.931835848133224e-01   -5.168569825177033e-03   +2.578739047221050e-01   -5.616771446196359e-02   +1.207468228836706e-01   +1.412883665285898e-01   -1.522681679051624e-01; -2.684643031093373e-01   +2.636063226008404e-01   -1.147457617361230e-01   +2.588580563804347e-01   -2.060529046505970e-02   +8.701347572772581e-04   +2.561220287790803e-01   -2.031948535364966e-02   +3.342936211005544e-01; -1.986867121100316e-01   +9.579891133006158e-02   +8.567968380723356e-02   +2.389478137084149e-01   +3.998826866107084e-01   +1.510728943582180e-01   +1.170946586021564e-01   -2.332596412252662e-01   +2.579561290862217e-01; +1.980518147100419e-01   -1.258427184071059e-02   +2.744710755645875e-01   +7.445322204375113e-02   +2.959416816844509e-02   -6.757995791711509e-02   +3.093216761395312e-01   -8.460019450433613e-02   -3.710336515374771e-01; +1.823752106984687e-01   +6.362883213823875e-04   -2.163068853615413e-02   +4.174957461547001e-02   -4.547875161851923e-01   +4.054803858597650e-02   +3.025473954208521e-01   +1.430467204828896e-02   +1.330948260981529e-01; +9.540647290683138e-02   +2.518823801911536e-01   +2.846237916883860e-02   +3.874301692267473e-01   -8.824745062556068e-02   +1.063517522053347e-02   +1.315435524472184e-01   -2.139661343426172e-01   -1.845902067242847e-02; -2.894683017722502e-01   +1.168474397598711e-01   +2.263398988371897e-01   +7.948535220004332e-02   +6.098114250985131e-03   -4.744660480145379e-02   +1.109140103496982e-01   -3.850988708660082e-02   +2.332797165214092e-01; +1.095393478318875e-01   -8.571202318557777e-02   -7.162585625024522e-02   +6.848054283407932e-02   +1.051930397763057e-01   +3.115681723787852e-02   +2.652939992297800e-01   -1.231987619850806e-01   +4.457152225277067e-01];
L1_L2_iAMPA_netcon = [-6.925892682997396e-02   -1.778358743784668e-01   +6.305920498773575e-02   +4.070060591304005e-02   +5.109496812164017e-02   -3.725845150819331e-01   +6.551562012533441e-02   +1.156208550629365e-01   +2.881339887618475e-01; +3.639547025961928e-02   +2.864566288019356e-01   +1.766242776041212e-01   +1.570261612010559e-01   +1.089630281123579e-01   -2.355452962146623e-01   -1.070493923907327e-01   -8.889696100678605e-02   -1.731357294826929e-01; -5.134941858600704e-03   -3.834418030944657e-01   -6.658246134089889e-02   -1.854135600060397e-01   +8.334731385896003e-02   +1.683883351371809e-01   -3.373181519523471e-01   -1.160098792707903e-01   +1.093559630301522e-02; +5.374399232935723e-02   -3.571858908423398e-02   -5.171159345575775e-02   +7.428489859364652e-02   -3.770797222013366e-02   -2.163089074233823e-02   -1.570375783110398e-01   +2.099154145576456e-01   -4.031698149103889e-02; +5.406772663998191e-02   -2.236967377117682e-01   -6.246849878417774e-03   +2.206339101447909e-01   +6.139619565170926e-02   +1.045773078318093e-02   -1.405465251927471e-01   +1.451425387041270e-02   +1.078943571956662e-01; +1.905582780334856e-01   -3.023507823379310e-02   -1.189123352436677e-02   -3.181951785545594e-02   -1.896572489783273e-02   +2.199730031998788e-02   +6.352066596815720e-02   +2.822361902991450e-01   +1.282415822747487e-01; -2.271719846141656e-02   -1.780292896962569e-02   -1.110657491590425e-02   -1.386886898019680e-02   -5.174335896088355e-02   +5.314684359746016e-02   -5.357115657480391e-02   +7.622831397415213e-02   +1.504869265966579e-02; +2.150383067818074e-01   +1.894220227891980e-01   +1.353496608889909e-01   +1.928458856340941e-02   +3.650923088063029e-01   +2.017805788842589e-01   +1.593602723466434e-01   +8.007719001786537e-02   +1.631015079021143e-01; +1.492581759683137e-01   +2.640607778874881e-01   +2.273502702079124e-01   -2.122849983268698e-01   -4.584084164423933e-02   +6.007466163702253e-02   +1.688712586274156e-01   +2.367990116771038e-01   +7.662103904287303e-02];
L2_L5_iAMPA_netcon = [+1.035277441919166e-02   -3.150654765416790e-01   -2.820524058912102e-01   +1.621424827826202e-01   +1.166914578168446e-01   +7.179860098050665e-02   +1.907141218475431e-01   +1.074698017990648e-01   -5.104746515534626e-02; +1.394008983836888e-01   -2.703608590253034e-02   -1.662630227681829e-01   +1.501961440838663e-01   +7.079760541969021e-02   +1.174900196520885e-01   +9.400880985744105e-02   +7.890014880220197e-02   +1.459196520333820e-01; +4.877353085817389e-01   +8.446525291183843e-02   +1.461952690863029e-01   -1.596299782741039e-01   +3.730430197094018e-01   +9.446899433329690e-03   +1.186757584984986e-02   +3.427419874665075e-02   -3.186469285872747e-01; +1.990514235940278e-01   +3.348066001845067e-01   +4.481849837539523e-01   -1.645850718022501e-01   +2.729279085679427e-01   -7.957425915864140e-02   -4.387645387809190e-01   -1.338265059885871e-01   +2.531653936380050e-01; +2.002730991362145e-01   +1.937513357598727e-01   -2.951508137732599e-02   -1.070092124615346e-02   +7.201461790431651e-02   +2.651620027077861e-01   +3.288884709880668e-01   -7.806923172886578e-02   +3.294204808660616e-01; -1.275309996784957e-01   +1.176183041516324e-01   +4.624200196998719e-01   +2.148441735041831e-01   +1.486055993656148e-01   +1.428174786414281e-01   +4.705984488362869e-01   +2.232245052910324e-02   -5.966677565278086e-02];
L5_L2_iGABA_netcon = [-2.598415780508929e-02   +9.981254787436465e-03   +1.562814154166879e-01   +2.733651882987858e-02   -1.453203984897730e-01   +5.152953800568089e-01; +2.607262264399166e-01   -2.248325606970414e-01   +2.286294081440988e-01   +1.570220837211108e-01   +2.568238087598196e-01   -7.237637882795044e-02; +3.613663264044519e-02   -1.904569850453486e-01   +1.657043315328595e-01   +3.027848643526002e-01   +2.215229859257309e-01   +1.664510763453783e-01; -2.245363565481145e-01   -2.013379046382000e-03   -1.254433278543616e-01   +2.894348781319299e-01   -2.138401726890442e-02   +1.239698818969751e-01; -1.792832923452647e-01   +6.537526229115988e-02   +1.464417978013757e-01   -1.936250077777917e-03   -8.154193201285388e-02   +2.008717199001639e-01; +1.989006644437931e-01   +1.366284036267790e-01   +2.630267506397394e-02   +4.051860190972910e-01   +1.698567195515805e-01   +4.413897679926712e-02; -2.377531108560104e-01   +5.949459969199258e-03   -6.113365092400536e-02   +1.403592302380791e-01   -6.008521942908385e-02   -1.628960101731369e-01; -3.748440040252437e-02   +1.154137618113551e-01   +2.827342550831575e-01   +2.450275241303918e-01   +2.301943092361083e-01   +3.718046296001953e-01; +2.613046923189619e-01   -1.926248308266358e-01   +2.561898911101971e-01   -1.325520363970310e-01   +1.773609350983239e-01   +4.320532384366516e-02];
L3_L2_iAMPA_netcon = [+3.820687857408314e-01   +1.720327313762257e-01   +1.753021023462898e-01   -7.939619955403390e-02   +8.836221057500326e-02   +6.441682441277520e-02; +2.407083434884524e-01   +4.525910901621741e-01   +1.561115531049003e-01   -1.290971575414349e-01   +1.042769592454945e-01   +2.971840183833118e-01; +2.953121198244137e-01   +2.396202354629333e-02   -7.210216663268822e-02   +2.401047461727072e-01   +2.681283560195268e-01   -6.497343139884193e-03; -4.064265359206677e-02   +3.406797500356166e-01   +1.974285689223388e-02   +1.087234213453610e-01   -1.596190893913752e-01   +1.492879916380072e-01; -2.423387350422347e-01   +1.194516467469998e-01   +2.361964186369373e-01   +1.222239171596759e-01   -2.580043675095018e-01   +1.278055771289672e-01; +2.380490721361494e-02   +1.481210118048864e-01   -7.053761406768441e-02   +9.748098654825549e-02   +2.780050416066059e-01   +2.365899991344093e-01; +1.338380495281924e-01   -2.720201775520921e-01   +8.785149616335387e-02   -2.328157846683388e-01   +1.937207336507606e-01   -1.816568618900904e-01; +4.126280979441579e-02   +2.758420239904514e-01   -3.393519029553415e-01   +1.278491095645141e-01   +1.499008398641614e-01   -1.542273362741106e-01; -4.135197617632679e-02   +1.816881771282658e-01   -1.732285290672503e-01   +1.355861904393171e-01   -1.680066791382125e-02   -5.924130311351797e-02];
L2_L3_iGABA_netcon = [+8.911233646794414e-02   +2.567361694460835e-02   +3.180681447847838e-01   -1.171858334146994e-01   -6.208847760669459e-02   +7.724293720818251e-02   +3.759973699607226e-01   +1.266891275656430e-01   -1.430300941048835e-03; -9.844935049095546e-02   -1.997448980835603e-01   +1.950071960218678e-01   -1.317370833854121e-01   +1.227709190233728e-01   +1.418733402120191e-01   +8.994739355143937e-02   +1.270372551946574e-02   -1.926211925306639e-01; -7.626922922921742e-02   -9.864617383013960e-02   +2.703937241378964e-02   +3.502942669290587e-01   -4.139475381158946e-01   +3.501617589025394e-01   -2.834351323883996e-01   +2.367423601151946e-01   +1.163930954039259e-01; +3.036864578517779e-01   +8.194985994334281e-02   -3.516920732959289e-01   +1.190899322361028e-02   +1.871743071495329e-01   +1.560943344887215e-01   +1.270560454211268e-01   +3.275040708161335e-01   +1.256495217976238e-01; -4.027563674989612e-02   +9.740975941117265e-03   -7.587882657732160e-02   -1.678677967416180e-01   -4.528829154221518e-02   -2.259662079154674e-01   -7.474152675982813e-02   -9.836559381678529e-02   -2.482738815855984e-01; +1.590627554613340e-01   +1.667935213634330e-01   +5.607855318909351e-02   -7.429958092282721e-02   -1.416942391430062e-01   +9.127889135732850e-02   +3.570016749927811e-01   +4.221544025695136e-01   +4.609813324805929e-01];
L1_L4_iGABA_netcon = [+2.854590630002367e-01   -3.720146585053203e-01   +1.583253729242787e-03   +2.720398387627955e-01   -1.606836591655428e-02   -6.368975990335424e-02   +1.502803467933958e-01   -3.546914189551000e-02   -3.220094626074639e-01; -4.893474958493475e-02   +4.957071434083331e-02   +2.742206160809907e-01   +1.937590616516686e-02   +8.839862433729313e-02   +2.470411809028295e-01   +2.691057999639888e-01   -3.870288047184469e-02   -2.209940841947894e-01; -1.634783928317288e-01   +3.906309310409125e-01   -2.365240430717655e-01   -1.107036233769683e-01   +1.775393996827576e-01   +1.909619717122349e-04   -1.422574957740547e-03   -1.044892086647529e-01   -8.807545581207392e-02; +6.828794800053738e-02   +3.611698285878252e-02   -2.217380151028490e-01   +1.213580423283852e-01   +3.128463978000022e-02   -2.737573534149807e-02   -1.944464379302081e-01   -1.753803413201744e-01   +2.413417653925645e-03; -2.103478870899475e-01   +4.970447350070837e-02   +1.803782888488939e-02   -4.076005242715235e-02   -3.994687568252503e-02   -1.260555495019229e-01   +1.103840544783712e-01   +8.661091559527079e-02   +1.243457251051785e-01; +2.485293028814370e-01   +1.097642058391977e-01   +4.014444667338345e-02   -2.998602450703053e-02   +1.504223443211603e-01   +2.304660573518311e-01   -4.189852198878620e-02   +2.338348267961327e-01   +1.164458941246529e-01; -1.304592935805246e-01   -3.050463801994561e-02   -1.968601848551364e-01   +2.557238565613683e-01   +7.603202808900911e-02   -4.901834663967198e-02   +1.821052541877097e-01   +1.979742603938016e-01   -3.882977438309204e-02; +1.832506412318511e-01   -2.099916015144773e-01   +1.512170091485479e-01   +1.559491278775506e-01   +2.512569793463646e-01   +1.569429056822769e-01   +1.465654263470408e-01   +1.258394143685976e-01   +2.524770749033799e-01; -1.163566847175889e-01   +1.217903035088162e-01   +8.313849703734592e-02   -9.174211653497263e-02   -1.251798758734726e-01   +1.111175615141626e-01   +1.590398949104141e-01   +4.471367183645299e-02   +1.921271735967527e-01; -5.251266117077777e-02   +3.021497040457948e-01   +2.118116944121771e-01   +1.222338895612889e-01   +1.242910704003300e-01   +2.143945258579932e-01   +9.389562512439477e-02   -7.897383028710456e-02   -4.962680117696860e-02; -7.141818502908773e-02   +1.411925141816792e-01   -5.638399786462144e-02   +8.120134573424040e-02   -2.434835987725014e-02   -1.841328353365564e-02   -2.807417556428547e-01   -3.403340361107997e-02   +2.802864819694196e-01; +2.065736373231630e-01   -1.902630664995427e-01   +2.456408528578393e-01   -8.891136184236665e-03   +1.872372917295067e-01   -1.369836827966417e-01   +1.648152285432467e-01   -1.238453033433662e-01   +3.697509841225616e-02];
L4_L1_iAMPA_netcon = [+2.536727399040027e-01   +2.414796383231593e-01   +3.139109338058252e-02   -4.464726459014794e-02   +1.334363751443479e-01   +2.510942162447044e-02   +1.266325151728616e-01   +1.058307197500478e-01   +6.530926870656162e-02   +1.594271635862813e-01   -4.457390793027926e-01   -4.231224566564228e-02; -1.071080170000660e-01   +1.679544441005681e-02   -2.231825916306806e-01   +1.547152176355368e-01   +5.243930080321050e-01   +1.728555264396892e-02   -1.802110844067485e-01   -2.802767525347709e-01   +1.879941070108495e-02   +3.175137046730225e-01   -5.396262487371477e-02   -4.570163401243717e-02; -2.446854214525357e-01   +1.844026594559573e-02   +1.852219622637764e-01   -6.570236682895932e-02   +1.494259352097464e-02   +2.685055723733220e-01   +2.444700999789390e-01   -2.337442013462938e-02   +9.037953421042266e-02   +4.108555310586429e-01   -4.286810773309039e-03   +3.190145858576109e-01; +5.604152861435972e-02   +9.685809144121432e-02   +2.931263712923566e-01   +1.429843465937876e-01   +9.778914876437085e-02   -1.187643646182091e-01   -5.986685251167403e-02   +1.347775446070957e-01   +1.674809270478414e-01   -1.730278192601567e-01   +2.359804674430657e-01   +5.327848978056905e-02; +2.146276440042233e-01   +3.957201574960425e-02   -2.285416315458317e-01   +2.051168729233359e-01   +3.499649227336670e-01   +6.746169723250144e-02   -7.373738892391243e-02   +6.019454296266938e-02   +1.506124704591463e-01   -2.298374467448692e-01   -2.647447652773465e-02   -1.610480399943283e-01; -1.282498466608175e-02   +1.469955079560910e-01   -4.429261178628507e-02   -9.303529017928917e-02   +2.630869413829724e-02   -3.079200032145104e-02   +1.319827570012021e-01   -2.824239911159346e-01   +2.845679445549977e-02   +4.124756492157505e-01   -9.460169489737272e-02   -1.773663216337177e-01; -5.615014530015178e-02   +1.792650107378918e-01   +2.160628651719259e-01   +7.768794658906675e-02   +1.839596828399502e-02   +5.153353157759379e-02   +1.605830403901709e-01   +9.510732456687387e-02   +1.840011494062603e-01   +2.739917719553966e-01   -1.511515698347821e-01   -2.201992909435799e-01; +1.727220470788512e-01   +3.754408708032792e-02   -2.294126221844329e-01   -1.758913617071214e-01   -9.071617815361210e-02   +5.542126977259684e-03   +2.837574616791316e-01   -1.656537912623047e-02   -1.904821218168720e-01   +1.274322649195344e-01   +3.595039470890506e-01   +6.777493575092380e-02; +8.909194357222899e-02   -2.764151794701395e-01   +1.246702283990082e-01   +1.288563138441424e-01   +5.188867391806747e-02   -7.141716616377887e-02   +3.866759333146189e-01   +8.911815879214358e-02   -2.542757164432895e-01   +1.164299974558796e-01   +3.571054579336083e-01   -2.625637807249269e-02];
L1_L3_iAMPA_netcon = [-2.275358763918793e-02   -7.128029205514384e-02   +3.387047261972007e-02   -1.587768404441878e-02   +7.587168595258729e-02   -1.847092665386629e-01   -2.140799895930554e-01   +2.476054083617922e-01   -8.424591740866104e-02; +2.803382922778395e-01   +2.276412712329402e-01   +5.249756805174551e-02   +1.335580975039682e-01   -2.199123995138804e-01   -2.246159489589479e-01   +1.907556594821416e-01   +7.202779277030176e-02   +6.577297775561321e-02; +1.498265096196813e-01   +2.092654531085416e-01   -1.556137970103244e-02   -1.349614764428833e-01   +5.169828422188251e-03   +3.014027914716477e-01   +1.926269462927928e-01   +4.986061183424198e-02   +2.564463920989037e-01; +6.054147124488882e-02   +1.811321153827089e-03   -5.950358107689222e-02   -6.111485652972006e-02   +5.403686592316536e-02   +2.075847343895450e-01   -8.248210670123422e-02   -1.031552596768553e-02   +2.940396746388738e-01; +7.808255880016079e-04   +1.905743896413732e-01   -1.369518367830923e-01   +1.066008514690787e-01   +2.733613191585119e-02   +1.693580203574815e-01   -2.039448483781795e-01   -2.020684499667927e-01   +1.361588152105268e-01; +5.674712342442657e-02   +8.659356734768706e-02   +2.937682799241504e-01   +1.295811313658622e-01   +1.901979401624600e-01   +2.526793755542331e-01   +2.926126852276116e-01   +3.415234479215878e-01   +1.820843394676008e-01];
L3_L1_iGABA_netcon = [+9.607551845870477e-03   +8.886723329126286e-02   +1.435401837858271e-01   +2.495693053233273e-01   -1.134506220171939e-01   +1.535820818183957e-01; -2.511823738145276e-02   +2.149385520189411e-01   +3.095958844040369e-01   +2.779302428077486e-01   -3.362855232538973e-02   -9.708297606242740e-02; +4.148300050134503e-01   +5.762922201995764e-02   -2.357914895033550e-01   +3.952186201639897e-01   -2.839655156493393e-01   -3.459973477408682e-03; +1.108326642366310e-01   +4.827395154929022e-02   -2.778599020707647e-01   -3.198675359912276e-02   -1.418478311687440e-01   +4.763734314167482e-02; +2.698448582413426e-01   -8.192498862833375e-02   -1.368383870876619e-01   +1.362844227352009e-01   -1.083028638626178e-01   +2.810478249547581e-01; +4.538591893924437e-02   +1.302755378391378e-01   +1.937380917434928e-01   +1.317775648836638e-02   -1.939537463761515e-01   +1.398222014077188e-01; +1.740100609642520e-01   +1.170973125934747e-01   -5.703655177857148e-02   -3.795721240778088e-02   +2.596105837141928e-01   -3.132259331892625e-01; +1.245867187365238e-01   +2.135750042951424e-01   +4.589081434033817e-01   +5.733948465869695e-02   +1.909346011012770e-02   +1.413360445582866e-01; +1.533640527637304e-02   -6.430634415031988e-02   +1.948993155509066e-01   -1.417678389153280e-01   -8.415876105277716e-02   +1.079221299360581e-01];
L5_Input1_iAMPA_netcon = [-4.468981163728529e-02   -7.372803923045496e-02   +1.857305541570041e-01   -3.693919600237369e-02   -9.859426391996300e-02   +6.097896496602189e-03];
L6_Input2_iAMPA_netcon = [-1.310866057588581e-01   -1.770677900029401e-01   +5.200521304479093e-02   +5.839316300502078e-02   +2.407424770108118e-01   +1.427513740979009e-01];
L5_L6_iAMPA_netcon = [+2.792264009227884e-01   +2.494142293120907e-01   +1.869213341742398e-01   -7.012100882106688e-02   +1.460591576891049e-01   +1.045000201760354e-01; +7.516426945043472e-02   +2.796021072478086e-01   +2.221726977995576e-01   +3.219746942578885e-01   +9.478430254997819e-02   +9.170162420695151e-02; +1.016962509129635e-01   +3.888807550147459e-02   -1.545337712509159e-01   -2.765966790187783e-02   +1.021553567277821e-01   +8.534671613966310e-02; +1.063916042328603e-01   +1.522123921774201e-02   +1.751166549123753e-02   -1.147036911718423e-01   -3.122562834072676e-02   -1.476334911135149e-01; +1.503811980143776e-01   -1.738353941249283e-01   +9.263986030960705e-02   -1.852602203982258e-01   -8.224666921957276e-02   +7.142081207772885e-02; -2.972580595381044e-02   -1.535202907830349e-01   +1.295796321952077e-01   +3.965311229680641e-01   -3.111496599568426e-01   +2.731538350707452e-01];
L4_L5_iGABA_netcon = [+1.653240931386598e-01   -7.379213674142764e-02   +1.465226855193410e-01   +1.194595819466737e-01   +3.005071747428787e-01   -6.898854847920040e-02   +3.479398471413822e-02   +2.869650686422148e-01   +7.712507021510824e-02   +9.935306658085757e-02   -7.735436745463939e-03   -9.574446296742373e-02; -4.657373136539125e-03   -8.312734033580342e-02   +3.330806741716495e-01   +3.435229763579524e-01   +1.774310803476423e-01   +3.039514087220174e-01   -2.112291935761650e-01   -1.711510881356845e-01   +3.216235025557516e-01   -2.310753870741034e-01   -3.033050559229579e-01   -2.084421203399207e-01; +2.602071593195316e-02   -3.669336853241052e-02   -7.292954386238179e-02   +1.104664451220547e-01   +2.096460308493885e-01   +1.387145329592065e-01   +2.525175470915608e-01   +2.625300113758685e-01   -2.460355306099236e-01   -1.599964578126312e-01   -1.025674756787776e-01   -6.442929459507948e-02; +3.054332120048686e-01   -2.117917226111979e-03   +3.857316885619593e-01   +2.453322789619098e-01   -1.426607077660974e-01   +4.148551741526547e-01   -1.213988010708791e-01   +1.421797471981026e-01   +1.177045272836700e-01   -1.283125158056738e-01   +7.606545356680550e-02   +7.589472442582035e-02; -4.349886681262793e-02   +1.912991981844807e-01   -2.100824512482910e-01   -5.122265100080721e-02   +1.656793991254212e-01   -1.289840400280321e-01   -1.081186334057084e-01   +3.157696060876944e-02   -1.580230311377924e-01   +2.208227361508413e-01   +2.854637731684134e-01   +2.019162688710542e-01; -7.173267025533166e-02   +4.073751857857652e-01   +1.394643119721949e-01   -2.177322181526731e-03   -1.137558683616400e-01   +3.589661278227568e-02   -1.838784403879896e-01   +1.344372723052060e-01   -3.525224672098490e-02   -6.557708611731597e-02   +1.031281818574197e-01   +8.554255758790914e-02];
L6_L4_iAMPA_netcon = [+3.303449383757843e-01   +2.293933206866613e-01   -6.335477139632020e-02   -2.887380360335816e-01   -1.193316512504917e-01   -9.594070140697476e-03; -2.139854079733322e-01   -1.336838842176921e-01   +2.595154581114424e-01   +5.079112199438927e-01   +2.920480186209359e-02   -9.325977217429320e-02; +1.549377831244860e-01   -2.505573853322957e-02   +7.193252132738046e-02   +2.424216339667053e-01   +9.649863133743200e-02   -2.108635688114795e-01; +1.479589174367057e-01   -1.541018172398423e-02   +1.995637987267843e-01   +1.823391147041598e-01   -2.803383563350018e-01   -1.079297019857015e-01; -8.650086435894274e-04   +2.731983828403636e-01   -1.706903374051965e-01   +2.777269000766624e-01   +4.221713610087079e-01   +3.847380021032430e-02; -5.958966123963474e-02   -2.141870503725299e-01   -5.264106506897116e-02   -7.873326044546204e-02   -5.085083142183753e-02   -1.336221508365940e-01; -1.956349703783296e-01   -8.321417321988227e-02   +3.975143138457719e-02   -3.699108708951721e-01   +4.463736668896116e-01   +1.186068684625421e-01; +1.443788153044867e-01   +2.145066489842572e-01   +6.462062755670485e-02   +5.451750605308476e-02   -3.617522889575265e-02   -1.661750017047622e-02; -1.215997858126588e-01   -5.823696763599564e-04   +1.296631756882167e-01   +1.450469188428457e-01   +4.121979974886571e-01   -1.454900931523606e-01; +4.098953820040068e-03   +1.133606302630249e-01   -3.122868662014390e-01   +1.268209014051535e-01   +1.107153658321146e-01   -1.841683982788918e-01; -1.975843754796210e-01   -2.072291152471604e-02   +3.517857502738880e-02   +5.083203844004440e-02   +3.085843475387796e-01   +3.521844832709293e-01; +1.646016224146516e-01   -1.038498927636705e-01   +6.937157255508405e-02   -1.726687349309376e-01   +1.774566711084847e-01   -1.499163397574650e-01];
L5_L4_iAMPA_netcon = [+9.456696184787346e-03   -1.622238519986695e-01   -2.304159072872947e-02   -5.275541779465317e-02   -1.916404622990521e-01   -9.773491968495777e-02; -1.931135751362380e-01   +8.605042103616679e-02   +1.144214532615106e-01   +1.816640151831397e-02   -1.239331415852529e-01   +7.147830879530938e-02; -1.293980501241439e-02   +7.722728502213981e-02   -2.764744188165925e-02   +2.251432130840877e-03   -8.606595561048572e-04   -1.919707410215812e-01; +2.135759917902181e-01   -2.187475387123161e-01   -6.612238205560179e-02   +1.866569450428064e-02   -9.971081993221085e-03   +2.612968293573744e-02; -2.305167682070461e-01   -3.692343396683088e-02   +3.399531092042487e-01   +9.718085987628559e-02   +2.199852013050909e-01   -2.227897993611870e-02; -2.834440539657082e-01   +2.594535256465293e-02   +2.076431152558681e-01   +2.080244568752581e-02   +1.581629524391836e-01   -1.583172794497290e-01; -4.748913118807164e-02   +1.768557441588172e-01   -8.557062255870979e-02   -7.934152375960486e-02   +8.508683607004185e-02   -1.161774737115383e-01; -1.106719021447917e-01   -9.593354694920579e-02   +2.837420341639986e-01   +4.620753358379178e-03   -9.973865383624310e-02   +7.711086519815995e-02; -5.879041872965440e-02   -8.470147193939274e-02   +5.997764264853229e-02   +4.095425584069386e-02   +3.321862856284566e-02   -2.233139420325869e-01; -2.165910627321405e-01   -1.524872218883744e-03   +3.020688838055741e-02   +3.576513621336803e-02   -1.864876736275509e-01   +2.771962571782038e-01; -8.423650655558904e-02   +2.737556547690358e-01   +1.570665450617016e-01   +2.764092701750067e-01   -1.571093002237122e-01   +2.987018191778625e-01; +3.923305291081314e-01   +2.020416644076996e-01   +3.925585668522542e-01   -3.047997596760858e-02   +1.158995773015662e-01   +1.967969257089106e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
