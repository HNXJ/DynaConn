function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.774251865141530e-02   +1.665860974342198e-01   -6.012820767491045e-02   +2.679755868529077e-01   +8.902372356813325e-02   +1.774690916518379e-01   +2.668108862991859e-01   +2.215978460367839e-01   +1.525213675073278e-01; +1.118147013482047e-01   +6.710418003802628e-02   +1.117080733300252e-01   +6.579196997113917e-02   +3.259950500395266e-01   +2.114273652524015e-01   +1.949929618903788e-01   +5.371550943219968e-02   +8.231142332542316e-02; +4.964605618141826e-02   +1.437069858454325e-01   +1.419135917397125e-01   +1.192432409097383e-01   +5.366086147508806e-02   +4.050200127314854e-02   +4.617427715715234e-01   +2.309420919478474e-01   +1.434667336357028e-01; +3.444781646852433e-01   -5.440902684038670e-02   +1.529094103606450e-01   -6.857121866554854e-03   +9.803172031820104e-02   +1.308397350398351e-01   +5.350896947960762e-02   +3.018298395099483e-01   +1.740639583084863e-01; +1.394739034104626e-01   +9.803956435398281e-02   +3.223835458446731e-01   +2.051469609182393e-01   +2.495392399589481e-01   +2.675909567388669e-01   +2.352456935786438e-01   +1.102048951603219e-01   +1.747602935299439e-01; +1.544582853367747e-01   +7.523482686336727e-02   +1.807486867792865e-01   +2.165717480203656e-01   +2.334103390211840e-01   +3.260328565161860e-02   +3.388041747401431e-01   +6.940542110228091e-02   +1.620513464133378e-01; -2.581019678777099e-02   +1.573353271892418e-01   +1.688598846359842e-01   +2.179273632706274e-01   -1.380155054939308e-02   +2.063471271394739e-01   +6.407155723051135e-02   +2.787918688119352e-01   +1.993087610674548e-01; +9.266444786912970e-02   +1.554203513247544e-01   +4.368604119837169e-02   +1.096724340939861e-01   +1.962437987309153e-01   +1.285490265038332e-01   +2.187992496369420e-01   -1.224573080197092e-03   -6.760423640620281e-03; +1.270468470441930e-01   +1.347267552187174e-01   +3.289786044645796e-02   +1.624077446646141e-01   +1.085412987315923e-01   +2.774325151554028e-01   +1.509416721233628e-01   +1.058715794137303e-01   +6.280869563038943e-03];
L1_L2_iAMPA_netcon = [+1.930672738235101e-01   +1.955744608628701e-01   +1.289420013188181e-01   -1.865253929728049e-03   +3.296615204749842e-01   +5.408782065849924e-02   +2.707974167915192e-01   +2.172077244406445e-01   +2.692669882774639e-01; +1.769279060743498e-01   +7.504381233084162e-02   +3.319979881481088e-01   +2.151754786111292e-02   +4.249351758184555e-03   +1.290302603659573e-01   +1.935795308170345e-01   +2.231582591782989e-01   +2.348958492039091e-01; -2.457520205148209e-02   +6.072593773605766e-02   +3.011630924634274e-01   +2.214330597720934e-01   +6.242831166914923e-02   +1.092046591312060e-01   +2.139801038114290e-01   +2.371505007646068e-01   +3.936794173049042e-02; +5.219961103820232e-02   +2.381774852756299e-01   +1.860126599598602e-01   +3.846117213537877e-01   +1.348765224616615e-01   +1.073583511668670e-01   +5.101197396605704e-02   +2.934905647246450e-02   +3.317484062983985e-01; +7.900842717567236e-02   +4.121441425360275e-01   +2.133421897571468e-02   -6.209720807577693e-02   +1.344388993223363e-01   +2.594404783734330e-01   +1.203767212919986e-01   +2.278184583951920e-01   +2.453449096456445e-01; +2.207455640341527e-01   +7.983735951388710e-02   +1.593615456124430e-01   +1.225859630272806e-02   +3.503529577928240e-01   +6.203727017481342e-02   +3.508892711247246e-01   +2.931797785803038e-01   +1.291024018989240e-01; +2.682335606931702e-01   +3.598540158204852e-01   -6.341085808562663e-02   +1.628593288822305e-01   +6.651344590436886e-02   +1.587266749914364e-01   +9.893571515533142e-02   +3.574713528643180e-01   +1.051590642642651e-01; +1.551102168214621e-01   +1.595419002850769e-01   -4.611903559522368e-02   +1.417308866265593e-02   +1.772896387965878e-01   +2.003529427713042e-01   +2.211381535479238e-01   +3.236209306038517e-01   +3.284090061723305e-01; +3.182312414091392e-01   +2.449611698925877e-01   +1.178140428940522e-01   +1.169102539328140e-01   +1.700018991737973e-01   +4.342740385123911e-01   +1.108290429069341e-02   +3.880586870474926e-01   +3.484006786751424e-02];
L2_L5_iAMPA_netcon = [+2.562872596460566e-01   +5.026703244942131e-02   -4.851337495652314e-02   +2.939869761549864e-01   +3.068141100426552e-01   +2.178972793708911e-01   +3.014040361637197e-01   +3.059891738303616e-01   +7.986203750341452e-02; +2.372840184554767e-01   +3.648164006141373e-01   +8.867151746273487e-02   +3.395506144266423e-01   +9.418540420634247e-02   +5.771097428931465e-02   +1.505348090570260e-02   +6.630019746027831e-03   +3.214456572053058e-01; +2.192298607754646e-01   +1.484581950666210e-01   +3.822167844561744e-02   +3.557839535705394e-02   +1.499242945716923e-01   +3.440789372425685e-01   +2.314009041979578e-01   +2.256297678841701e-01   +2.087194746327637e-01; +1.056099874251885e-01   +1.375249762210828e-01   +1.236062615828260e-01   +2.515083773350816e-01   +1.738280813198307e-01   +2.733344474927015e-01   +2.424749305981823e-01   +3.443333559923262e-01   +1.177114690669781e-01; +1.592579154283874e-01   +6.410858147695944e-02   +5.893779545873966e-02   +1.469570605207645e-01   +3.050935214423374e-01   +1.014470467475554e-01   +7.828045895413765e-02   +7.456594279852892e-02   +7.918348155567440e-02; +2.540838179989113e-01   +7.759343007495957e-02   +5.798654361000084e-02   +2.723539565515017e-01   +1.046655635153532e-01   +1.679795202334063e-02   +1.366439372754043e-01   +2.779207004261684e-01   +3.022704286452395e-01];
L5_L2_iGABA_netcon = [+1.870776813338416e-02   +4.247184249142699e-02   +2.181227790549972e-01   +1.308668137237669e-01   +9.589811005483331e-02   +4.132723000489599e-01; +2.840008510010673e-01   -4.603004427774915e-02   +3.166882103269168e-01   +9.957709934419556e-02   +2.443328354903389e-01   +3.822184056980143e-01; +4.100475161264738e-01   +2.966584746195430e-01   +1.824020653956632e-01   +1.076473948408765e-01   +1.125894179687388e-01   +7.098216097156591e-02; +1.121926906100371e-01   +1.344167218956555e-01   +1.671320445132110e-01   +7.108976766860234e-02   +2.360580343409238e-01   +4.594578144203233e-02; +1.483454014414431e-01   +2.557770719817589e-01   +2.959879558205025e-01   +1.859022912706125e-01   +9.774029091315350e-02   +2.257836565589333e-01; +3.176825736776183e-03   +1.818903828506065e-01   +8.857582614756995e-02   +2.159117207828311e-01   +1.514438215180590e-01   +1.795811511206847e-01; +4.934470752783157e-02   +1.138177203431772e-01   +3.163847235718538e-01   -3.994221006658508e-02   +2.981325361081408e-01   +1.655413916204839e-01; +2.971394923285798e-01   +1.060479826329333e-01   +4.923876294592641e-02   +3.127401927803303e-01   +1.285894227453140e-01   -3.642640849171472e-02; +1.103195068669753e-01   +1.749629309354968e-01   -6.940964324959500e-02   +2.677803246231222e-01   +9.927275178717782e-02   +1.728268035600924e-01];
L3_L2_iAMPA_netcon = [+4.152536156789281e-02   +1.167446183970137e-01   +2.002094218352771e-01   +7.170679796108792e-02   +4.003385108804626e-01   +2.685098144498939e-01; +6.080710559284909e-02   +7.440050085934284e-02   +1.885353060145566e-01   +3.749285722709239e-01   +1.521268930338624e-01   +1.532864660140016e-01; +1.991654289090616e-01   +1.472479926541953e-01   +9.326270584207594e-02   +7.878307749097214e-03   +1.353661389481896e-01   +1.052285683632998e-01; +1.875912859799606e-01   +1.348602730855009e-01   +5.859590940410629e-02   +1.913418137303497e-01   +6.298614218875662e-02   +2.893887901125896e-01; +1.254956431823276e-01   +3.332542046629848e-02   -5.202648772870409e-02   +2.815469233888163e-01   +3.481202096158881e-01   +3.384533877604153e-01; +2.468550847411226e-01   +5.620274110329627e-02   +8.086425032431950e-02   +4.929661247475342e-02   +1.419467405595100e-01   +1.804928517406606e-01; +1.833585471667397e-01   +2.725309530372420e-01   +4.536413070694630e-02   -2.660854124355167e-02   +1.201481765683173e-01   +7.507194586668010e-02; +6.244692313424412e-02   +3.288474481508924e-01   +3.473196743804821e-01   +1.048021798776148e-01   +1.877840849786088e-01   +1.318594842158562e-01; -2.407054057439761e-02   +9.485276295785866e-02   +1.344155370812009e-01   -4.436964059768810e-02   +2.361125619187993e-01   +2.646654814957168e-01];
L2_L3_iGABA_netcon = [+3.203088966722094e-01   +2.623457475593243e-02   +2.385778155131039e-01   +1.958876637130609e-01   +2.091416453801961e-01   +1.784572964869872e-01   +1.778242781083866e-01   +2.137657659280293e-01   +3.674415305238878e-01; +6.650066826852088e-02   +4.028495964230582e-01   +2.999814013666588e-01   +2.634055550516483e-01   +2.345967167884523e-01   +4.148306219053076e-02   +2.095189005862061e-01   +1.501072352253741e-01   +9.574081467957991e-02; +1.058884023149932e-01   +3.094168988374479e-01   +2.025153825336037e-01   +2.595193932878858e-01   -3.459635409440672e-02   +2.742584991191991e-01   +3.088627835510162e-01   +1.545383448094118e-01   +2.147836363047521e-01; +4.312991571699321e-02   +2.628827993950019e-01   +5.831834943547154e-02   +2.544808518851096e-01   +2.107143478210488e-01   +1.708117402941235e-01   +9.867953691786970e-02   +1.132653989411779e-01   -5.185780037075959e-02; +1.242147168221806e-01   +1.651078157301455e-01   +1.429641765006928e-01   +9.495431442862309e-02   -5.803305608798835e-02   +2.258205365042685e-01   +1.219406616870769e-01   +1.528057061007733e-01   +8.683669839197619e-03; +4.083772438979238e-02   +2.343650945393091e-01   +2.745263486539196e-01   +2.189109219315577e-01   +1.259663157049084e-01   +1.746254939351392e-01   +1.237402543249955e-01   +2.779671482935303e-01   +3.573230915296224e-01];
L1_L4_iGABA_netcon = [+2.738545036849948e-02   +1.413329669813135e-02   +1.084829030209235e-01   +1.193333042408194e-01   +2.130927229385062e-01   +1.062772269928555e-01   +2.942404129989964e-01   +1.113496823085173e-01   -1.821836299410740e-03; +3.035746403856621e-03   +3.009324535980359e-01   +2.971937784495026e-01   +2.011380871740505e-01   +2.347847663151174e-01   +2.473854131894869e-01   +2.728917395674357e-01   +1.928704958781906e-01   +8.335997953971030e-02; +2.462838106774384e-01   +9.851846708823674e-02   +2.031498972254376e-01   +1.457643961403238e-01   +3.264650953890310e-01   -1.618726926632976e-02   +1.075536156832809e-01   -9.789819785514690e-02   +2.023864381379150e-01; +7.199338274838425e-02   +2.276005765957562e-01   +3.417531414984703e-01   +4.529532710239179e-02   -7.548699960315589e-02   +5.743520527904809e-02   +1.526474244051063e-01   +1.788721646536943e-01   +2.851496545105209e-01; +1.282604883802660e-01   +2.499218328627003e-01   +2.092615461019470e-01   +2.674130994082211e-01   +2.535745628650074e-01   +2.653129028962348e-01   +1.076720356241340e-01   +2.183682914949741e-01   +3.498011792399338e-02; +1.353753774156348e-02   +3.155792091810772e-01   +1.950808129547295e-01   +2.195112512710180e-01   +7.574008013826883e-02   +1.934141747365383e-01   +1.949361741901074e-01   +1.903708514704683e-01   -5.911161538569568e-02; +1.426930619631292e-01   +2.080907403320209e-01   +1.895830478433094e-01   +2.861291805606729e-01   +3.426284302094400e-01   +2.007445491659407e-01   +1.443756958662520e-01   -2.939100687943737e-02   +4.570133186076313e-02; +2.217611184633194e-01   +9.582160466682058e-02   +2.195037188063797e-01   +1.738608431051082e-01   +1.931992314792012e-01   +1.656509692566424e-01   +2.147777337318921e-01   +2.308156830181883e-01   +3.045063344581733e-01; +2.268346241485979e-01   +8.862479536452360e-02   -1.272828904045740e-01   -5.152598391564461e-02   +2.278960195278265e-01   +2.180850072439399e-01   +2.041042460027711e-01   +1.296402673586761e-01   +1.243401448933774e-01; +1.183105028512061e-02   +2.689911670169989e-01   +1.924154834433717e-01   -1.128860226550727e-02   +9.985894667668004e-02   +4.341402389577920e-02   +3.174409649295255e-02   +2.561931179904882e-01   +3.550190600535074e-01; +2.834029176679389e-01   +2.473991397393402e-01   +1.930250763579076e-01   +3.010354915081555e-01   +1.162238239017013e-01   +3.178169379415470e-01   +9.226570662198491e-02   +1.223115954621226e-01   +3.152163846041167e-01; +2.301214268326496e-01   +8.746852520103668e-02   -3.143859777969312e-02   +3.355621168912671e-01   +1.813316393446025e-01   +2.170376414107111e-01   +2.243881357114659e-01   +1.086009554333048e-01   +2.508492274046454e-01];
L4_L1_iGABA_netcon = [+1.624634711304574e-01   +1.511895997496234e-01   +2.228285491237995e-01   +1.549893950907543e-01   -2.282857384308658e-02   +2.492957518677134e-01   +3.437053633415213e-02   +9.510181984185248e-02   +3.190470857522142e-01   +8.956314577988618e-02   +6.663390207667386e-02   +1.503634031547771e-01; -1.292314738501006e-02   +1.570595281819846e-02   +1.727457219924718e-01   +2.423787827802192e-01   +1.025116364765620e-01   +1.527972147219089e-01   +4.012168575492570e-01   +6.577746933282246e-02   +3.640829399914310e-01   +7.989483131644591e-02   -2.263125984552724e-02   +4.322749743901280e-03; +1.048670159971089e-01   +2.320231967272356e-01   +2.107992149494751e-01   +6.746357922635275e-02   +2.491509706071227e-01   +2.039044550088555e-01   +6.904656782584045e-02   +2.142063900907713e-01   +2.318039711433871e-01   +1.676100487415979e-01   +9.659267809981820e-02   +9.931854557905138e-02; +1.922676988431039e-01   +3.571882228612394e-02   +1.974113722798029e-01   +1.149006418038134e-01   +8.189852259674210e-02   +2.935139438829490e-01   -2.903515630266416e-02   +3.069282770038496e-01   +1.026802810343496e-01   +2.182298322870747e-01   +3.231733127305737e-02   +3.315373566932252e-01; +3.144458227986719e-01   +4.146516045675770e-01   +2.464158384793426e-01   +6.221333921419771e-02   +2.252670919763302e-01   +1.816825483959206e-01   +6.160237009230328e-02   +9.895867370835483e-02   +1.018316376401001e-01   +4.265473030131841e-01   +2.441170343972391e-01   +3.184867028734301e-01; +1.222601033206395e-01   +5.769250669769831e-02   +9.299591061935303e-02   +3.162407438617623e-01   -2.380499394926719e-02   +7.807554147629261e-02   +2.475549778503133e-01   +4.072157617473716e-01   +3.353918512051666e-02   +2.567625094145258e-03   +6.532583794915768e-02   +5.938355781705776e-02; +1.865741933538091e-01   -3.463360290037676e-02   +8.341490297798766e-02   +1.189043836501946e-01   -7.795968694978056e-02   +1.181743067975219e-01   +7.047953681278352e-02   +3.115723687720530e-01   +7.761679162401031e-02   +2.741705882521178e-04   +1.280748589639069e-01   +2.712789961134398e-01; +3.735831626392225e-01   +1.583197389875491e-01   +3.347623761453044e-02   +2.431720929018247e-02   +3.694410469209909e-01   +1.321344678266467e-01   +3.160353888913932e-01   +1.088325285216164e-01   +2.606778435770409e-01   +3.585112398151529e-01   +2.957935971663788e-01   +1.518075606162473e-01; +2.891264313562757e-01   +8.201288426199557e-02   +2.460333424653517e-01   +1.227265241378911e-01   +3.182285936087609e-02   +1.838074559181417e-01   +2.248429684775122e-01   +3.848201041314738e-01   +2.934725154240816e-01   +1.322786339460696e-01   +5.951234573401662e-02   +7.257157029237876e-02];
L1_L3_iAMPA_netcon = [+1.388888517930745e-01   +2.026744683857578e-01   +2.018493775557950e-01   +2.695941365509456e-01   +1.496358641847054e-01   +2.383809348519215e-01   +7.542939899244962e-02   +9.580295849209904e-02   -2.620577200009726e-02; +1.653908612764381e-01   +2.182420317247927e-01   +1.903329246901291e-01   -1.468937546640726e-03   +5.621811128418054e-02   +9.281044687756962e-02   +4.649160003758044e-01   +1.374263336199002e-01   +2.662491078957893e-01; +2.619191577793509e-01   +1.672056276314765e-01   +9.004510656232073e-02   +3.187918107873521e-01   +1.718652210686723e-01   +3.007598428606414e-01   +1.642848859888699e-01   +3.686490063827377e-01   +2.241307101243141e-01; +2.539715256855896e-01   +1.181024894960862e-01   +5.787952027836420e-02   +7.231371592077242e-03   +2.505351180170550e-01   +2.326812821567774e-01   +4.627175628106384e-03   +2.655170485974351e-01   +2.040242627528252e-02; -1.687884814709301e-02   +1.057879406303027e-01   +1.148556750106904e-01   +1.051346222565612e-01   -2.529671199929054e-02   +2.740693312949260e-01   +2.328504177318032e-01   +1.085385349995646e-01   +2.584574489093046e-01; +1.179101478018310e-01   +2.646052113266352e-01   +1.659913948602524e-01   +5.013999360374745e-02   -1.646269318419128e-02   +2.412460318990256e-01   +2.543075666918820e-01   +2.031902464407195e-01   +1.472121605404448e-02];
L3_L1_iGABA_netcon = [+3.287950084654187e-01   +3.163630308345942e-01   +2.441935370443258e-01   +5.501271279966595e-02   +1.024145028419063e-03   +2.496294375849850e-01; +1.816933924228135e-01   +1.165423012615414e-01   +1.406557486742421e-02   +4.105475421216912e-02   -3.785278132301187e-03   +1.083200643847038e-01; +3.026206110052358e-01   +1.116031459024843e-01   +1.604750144331649e-01   +1.755953955043332e-01   +2.911658818627526e-01   +2.732955764526244e-01; +1.955429494080421e-02   +2.180392128938325e-01   +1.720262937452066e-01   +1.966746546833596e-01   +3.659591461465544e-01   +2.241332735222366e-01; +1.961380073768159e-01   +1.024261437359646e-01   +2.159536924228959e-01   +1.743615592003522e-01   +1.254169010383777e-01   +1.141622531700362e-01; +2.685295136243536e-01   +1.149885722863417e-01   +1.862461163508139e-01   +3.563083583996961e-01   +3.682796379520818e-01   +2.119125821111134e-01; +8.511932255930894e-02   -6.792789142216642e-03   +3.195515399916099e-01   +1.246374816580851e-01   +1.612585623697194e-01   +3.416608361878749e-02; +8.000135975317020e-02   +1.980659987413340e-01   +2.512926348043429e-01   +9.732903344897902e-02   +9.860943029008792e-02   +9.215438819372751e-02; +2.585029557117036e-01   +2.878241297344808e-01   +2.994511601248633e-01   +1.735809219950047e-01   +5.995950056381608e-02   +2.669848189927440e-01];
L5_Input1_iAMPA_netcon = [-4.482169649100953e-02   +2.538884022706168e-01   +2.498145250402248e-02   +9.280028436417367e-02   +1.158917824558379e-02   +3.251478852349136e-01];
L6_Input2_iAMPA_netcon = [+2.144510436810128e-01   +2.661232674563074e-01   +2.122976074039010e-02   +2.253119226707671e-01   +2.322189391790602e-01   +1.914481093836644e-02];
L5_L6_iAMPA_netcon = [-1.124028162486155e-01   +2.278837068234882e-01   +3.387763073266100e-02   +3.199087739624311e-01   +4.352646847116746e-02   +2.514267064380930e-02; +5.457043219455483e-02   +7.956183279048400e-02   +3.344879570659398e-01   +2.385324106497428e-01   +3.727301727346019e-01   +3.297658344260738e-01; +2.904481781938565e-01   +2.035148657648266e-01   +2.082413336804119e-01   +9.145920738470159e-02   -1.465062930469804e-02   +2.496269319744853e-01; +1.360225535685892e-01   +3.137524527972196e-01   +2.489976990274133e-01   +1.259077082084725e-01   +1.349324910142131e-01   +2.792396064435809e-01; +9.712530501750537e-02   +2.411289400966152e-01   +4.051732902796558e-01   +5.623908516497957e-02   +1.305205109997555e-01   +1.687044923200239e-01; +2.851253678014311e-01   -1.372523583174296e-01   +3.362095688418820e-01   +6.623214645257401e-02   +2.606744181556799e-01   +1.898249874823109e-02];
L4_L5_iAMPA_netcon = [+1.011161234771429e-01   +2.515938404785285e-01   +3.879027960769155e-01   +2.288353191497737e-01   +1.212014370441886e-01   +1.021654711089749e-01   +3.268385589764283e-01   +1.066653762043124e-01   +1.777952249495373e-01   +2.207627858739710e-01   +2.811869482264555e-01   +1.782600124193119e-01; +5.240127494581363e-02   +2.972482573686651e-01   +1.111946525546587e-01   +2.740696725524897e-01   +1.338320943848431e-01   +2.484681616947467e-01   +3.884978508749944e-01   -1.865407245184113e-02   +1.737622744001913e-02   +9.767281212522573e-02   +2.105815826021327e-01   +1.232555983005918e-01; +6.977759507660986e-02   +2.699992747886956e-01   +1.013287509116800e-01   +1.358661073483689e-01   -2.591616417233413e-02   +2.970386604504227e-01   +5.267690647509602e-02   +1.432108809632476e-01   +2.426568303371782e-01   +1.566256872225751e-01   +2.372556583945300e-01   +1.364638596853915e-01; +3.142588519271106e-02   +1.988726555338434e-01   +7.719225560051153e-02   -1.535355593046891e-02   -3.728422610865571e-02   +2.810215117220032e-01   +7.755808235465009e-02   +1.155690016173715e-01   +2.073314631746009e-01   +1.625797013846977e-02   +3.411118113274366e-01   +5.789143770264385e-02; +5.124211047155977e-03   +2.502173650694859e-01   +1.537167162966578e-01   +1.991658325717590e-01   +2.055950375762065e-01   +1.696673686736147e-01   +2.470161745878818e-01   +3.887834670694184e-01   +1.720228459502885e-01   +5.809722325288640e-03   +2.826510398134880e-01   +2.539587726620013e-01; +2.111996532131119e-01   +1.694802037797429e-01   +9.386305249534384e-02   +2.669475616918814e-01   +1.838785363704711e-01   +3.584258633933328e-01   +1.913427409068514e-02   +1.624369185855181e-01   +1.073014131519060e-01   +3.003262197941275e-01   +2.267625909728258e-01   +3.170517946429648e-01];
L6_L4_iAMPA_netcon = [+1.721023715007676e-01   +1.100466441822829e-01   +1.669665476864209e-01   +9.216961802923443e-02   +1.665705300219005e-01   +2.150185956115940e-01; -8.017304412600844e-03   +6.058285686290472e-02   -7.478983820833154e-02   +6.097596307146029e-02   +9.693447317279126e-02   +1.581985656176826e-01; +3.014773446467971e-02   +9.408713527842252e-02   -2.320841779399586e-02   -4.480541811460717e-02   +3.207352921657700e-01   -1.955948212810957e-02; +3.183968464832935e-01   +2.444667442737953e-01   +1.934210571753067e-01   +8.867483344451951e-02   +3.595857166227296e-01   +1.476587369171438e-01; +4.222304240533901e-01   +9.538418653206249e-02   +1.734906253399640e-01   +1.019321763007889e-01   +1.743937575683966e-01   +3.028782666568849e-01; +2.684162432653157e-01   +3.060400436822863e-01   +1.811029036264120e-01   +2.173103318959361e-01   +1.642875511280901e-01   +2.840321132038667e-01; +1.710774887175471e-01   +2.611723876327042e-01   +4.748830133227502e-02   +2.535247813729555e-01   +3.831520988024197e-01   -6.265982587839659e-02; +4.358809050438610e-02   +3.192197760192872e-01   +2.923571516766264e-01   +1.797426889416575e-02   +7.253070172733679e-02   +2.781101771659444e-01; +2.890876888662132e-02   +1.177346204847610e-01   +2.844118501769005e-01   -1.537503125466141e-02   +2.025511063606375e-02   +3.859475431637994e-02; +1.396346801033066e-01   +1.799130518099821e-01   +2.378095379516747e-01   +1.305794844445026e-01   +3.757586232158999e-01   +2.213163467782178e-01; +2.435734638738162e-01   +8.233586568326812e-02   +3.692174493436014e-01   +1.671149629288559e-01   +1.552552776760339e-01   +1.385544455793999e-01; +2.197433428532051e-01   +2.725471733666048e-01   +1.981816220218459e-02   +5.951550439476708e-02   +2.135859155773368e-01   +2.557478195975809e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
