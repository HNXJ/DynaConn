function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.190509349632785e-02   +5.171906295653375e-01   -4.483225098278405e-02   -5.329559543694584e-02   -7.462909035961697e-03   -1.706006787126009e-02   -5.362855377763469e-01   +3.879041375175457e-01   -2.542152738471259e-01; -6.020991430993322e-02   -2.584353130874123e-01   -2.443209480608101e-01   +2.825445594217779e-01   -7.534000552396541e-02   -4.113236570918680e-01   +1.969249895630853e-01   -5.217107171525445e-01   -1.240715436579665e-01; +1.662859573736327e-01   +9.978884718855630e-02   -3.401900446515652e-01   -3.034582942173806e-01   +5.174299187279211e-01   +2.327792836394617e-01   -2.313850669207547e-01   +5.071091886418746e-01   -4.652055413269919e-01; -3.091910083896348e-01   -6.545869207358668e-01   -2.640503358458519e-01   +1.227616658661879e-01   -1.599673178143162e-01   +1.077320459492630e-01   -1.562517327578055e-01   +3.195474587781326e-01   +2.295419246425191e-01; -5.063584123000467e-01   +4.227532706765698e-01   +3.892985774113369e-02   -4.077765908674994e-01   +2.985793179465145e-01   +1.309773327324142e-01   -1.102913319528406e-01   +3.543167395047632e-01   +4.784421945368768e-01; -2.995998940057916e-01   -3.344496688905189e-01   +2.060097600027417e-01   +6.196079292040624e-01   +8.818268544943320e-02   -2.136347363114032e-01   +5.005006623002553e-02   -8.511261311457588e-02   +2.344386250974693e-01; +2.511639582413159e-01   +3.051519760778461e-01   +3.935578645141006e-01   +6.066864577164244e-01   +5.380911778219398e-01   -3.808887632788148e-01   -4.730850203863538e-01   +4.001889511995794e-01   -2.695340157388547e-01; -3.381799602210706e-01   -3.631256142135775e-01   -6.774596477680550e-02   +2.735314717364609e-01   +3.424095280823409e-01   -4.567579928557941e-03   +2.871501932260409e-01   -1.112308208277707e-02   -3.034451426925817e-01; +4.889085150917844e-01   -7.920217575167444e-01   +1.412845727910682e-01   +7.667740619233078e-01   +4.251813514279617e-01   -4.373285989719453e-01   +1.881002079077604e-01   -1.769142495395875e-01   +9.371132570615781e-02];
L1_L2_iAMPA_netcon = [+6.935953457046667e-02   -6.441034908293986e-01   -3.447180376320996e-01   +4.433106217000869e-01   +2.094105224938279e-01   +2.386066999742655e-01   -4.754633166718488e-02   -2.007842741009938e-01   -2.294933766459038e-01; -4.293563282804601e-01   +8.363966414654922e-02   -6.727816809933816e-03   +6.203397130155259e-01   +6.369438430684843e-02   +1.356776656593199e-01   +4.944594731961914e-01   +4.008899461801216e-01   +1.766320893264552e-01; +3.852568566916736e-02   +3.295669097454370e-01   +1.133203872379746e-02   +4.575160002514370e-01   -1.898452633557284e-01   +2.154983457636458e-01   +3.326884661450582e-01   -2.375597364200126e-02   -6.612277369528294e-02; +2.409499809060285e-01   +2.582396166224447e-01   -1.212584248916178e-01   +3.519612292607264e-01   -1.363838119282377e-01   -1.924000485102287e-01   -9.753050168872901e-03   +3.207559402425750e-01   +7.172467569951220e-01; +6.732123097925015e-01   -1.506922506689125e-01   -4.572593044842908e-01   -3.124926625193645e-01   -2.799241931345955e-01   +1.385989639867200e-01   +2.849230622400706e-02   -3.028110069936020e-01   +1.406997076311518e-01; +2.854579167868460e-01   -5.902105169594518e-02   +3.717621011792016e-01   +4.777592146648189e-02   +3.151990249559779e-01   -3.072123368402581e-01   -1.271535237299384e-01   -1.882737046082993e-01   +5.541043274920666e-02; -2.517276767621116e-01   +4.769649512558212e-01   -3.107627252257365e-01   +1.706841055369633e-01   +2.645093421731269e-01   -1.429974502119971e-01   -2.061293214694848e-01   +6.141754378497408e-02   +4.571475135107771e-01; +2.378697551595160e-01   +3.043723325313659e-01   +1.507786153046805e-01   +5.426664827262245e-01   -2.986251501338144e-01   -3.008947239047454e-01   -7.298737415076432e-01   +3.508499800690134e-01   +1.352865357944415e-01; -4.297571412856609e-01   +1.985084470006339e-01   +2.050173699250755e-01   +6.466900169358429e-01   +5.902676945523764e-02   -7.347750143372963e-01   +2.189017743034158e-01   -1.794713303007249e-01   -1.706408483216429e-01];
L2_L5_iAMPA_netcon = [-3.866695679682502e-01   +6.806964729996939e-02   +1.044510799838668e-01   -2.513264248476227e-02   -1.763523871122395e-01   +4.993726529492585e-01   +1.986793019091170e-01   -2.515588208180544e-01   +2.506886946182681e-01; -7.062977070070957e-02   +2.730690416243117e-01   -5.648991286826109e-01   -1.193916085612666e-01   +3.171416224390298e-01   +1.156794876984577e-01   +3.573762918174233e-01   +6.410260369379808e-01   +3.629631942006911e-01; -7.295766376304574e-02   +3.877433385893938e-01   +6.714411231795973e-02   +2.558565212208357e-01   -5.055839793513378e-01   +7.359327919581236e-01   +2.052198584420856e-01   +6.681679729673511e-02   +9.325821637383609e-01; +6.570853478624217e-01   +3.788986927935758e-01   -9.577920004912616e-03   -3.312958224004783e-02   -1.168667640788658e-01   +3.037122993029317e-01   +3.963415690134844e-01   +7.559727464811941e-01   +3.377331035693688e-01; +1.483156680272932e-01   +6.664220950931623e-01   +2.639227824345833e-01   +1.871031799797625e-02   -6.014766072839306e-02   -1.174823028861296e-01   +3.048415595152609e-01   -9.260721224848036e-01   -3.694880495998019e-01; +8.197631340043204e-02   -8.813347051576464e-02   +3.714826926743685e-01   +1.233690968686613e-01   -3.419911117563313e-01   +1.263071157259732e-01   +6.913571176196720e-02   -3.576853575618479e-01   -6.281320458755191e-02];
L5_L2_iGABA_netcon = [-1.299335357353488e-01   +1.133806293802898e-01   -2.372321487977277e-01   +5.143856394504046e-02   -2.803161913106084e-02   -4.703462380238508e-01; +2.823058018183771e-01   +1.623814029208903e-01   +1.169415650203348e-02   +5.122535448715051e-01   +3.362377242801149e-01   +2.704972831813137e-01; +7.101185854821985e-01   +3.714392978265099e-01   +5.681615627116976e-01   -5.939427479459474e-01   +2.049940698714519e-01   -2.615499031811160e-01; -9.212610566226447e-01   +2.101409449758426e-02   -2.161733177107346e-01   -5.296513695055066e-01   -1.155547250531004e-01   -2.572991385676161e-01; +4.680847021193706e-01   +2.544748548042670e-01   -5.033544393448799e-01   +7.575294527072282e-01   -1.450095476955407e-01   -2.251500038731406e-01; -2.934542906289275e-02   -2.505014301348697e-01   -3.772052851212213e-02   +1.236670487105423e-01   +3.107983400725051e-01   -8.772033072741925e-02; +5.816446876465036e-01   -5.199635468283828e-02   +3.108711653253288e-01   +7.100712063864256e-01   -4.175716102732840e-01   +5.098408678170504e-01; +4.233538816471718e-01   -1.838705747333168e-02   +2.473611323667998e-01   +6.017679199707642e-01   -5.640528071218380e-01   +1.274653585747975e-01; +5.203137885828993e-01   -4.133349364548777e-02   -2.411488602875077e-01   -6.430202512114676e-01   -1.454408035873586e-01   -2.207989425737249e-01];
L3_L2_iAMPA_netcon = [-9.062909100956776e-02   +2.580065582200104e-01   +2.928239025897778e-01   +1.016701052442037e-01   +3.391663036278311e-01   -4.263113618698401e-01; +4.786319189845953e-01   +5.939314355264664e-01   -4.242329948112819e-01   -4.789398673799344e-01   -1.555590282313066e-01   -2.100588852770434e-01; +2.563572160362040e-01   -8.833945918085226e-02   -8.256794998052619e-03   +8.925397599690597e-02   -3.796715378736676e-01   +2.990985972315629e-01; +4.575770888931195e-01   -3.259417262361169e-02   +1.058458965837104e-01   +2.992972123120442e-02   +5.600185186271096e-01   +2.626653902529077e-01; +2.344793680950041e-01   +4.978871099709696e-01   -8.827408126623711e-02   +1.788224034696871e-01   +7.234295000314747e-01   +4.577590588349700e-01; -2.189862720006397e-01   +9.926756725739642e-02   +1.000000000000000e+00   +1.560907161799807e-01   -2.965494860913144e-02   -7.886957036363396e-01; +9.335911551813710e-01   -3.092717848119632e-02   +3.514374784207990e-01   +5.313238449986288e-02   -3.518085283558323e-01   -8.522205844631851e-02; -4.796134918393530e-01   -1.759560058709008e-01   +6.331878906240211e-01   +7.198494855737563e-01   +8.404332765373047e-02   -2.019290437840225e-01; +6.660380001756067e-01   +3.381076819097295e-01   -3.299473827866135e-01   +4.083622124201903e-01   -7.702115235130511e-02   -2.171899415579574e-01];
L2_L3_iGABA_netcon = [+6.911634714661538e-01   -8.495973910820202e-02   +4.999160036680906e-01   +3.605699293486643e-01   +1.917665835765592e-01   -3.704203475249743e-01   -7.010718593396387e-02   -7.427093931154632e-01   +4.043223977061539e-01; -1.090423767387921e-01   +3.303698997835551e-01   +2.286176739989891e-01   +1.751522858212632e-01   +1.000000000000000e+00   -7.023764980582459e-02   +3.352153474209398e-01   +5.709185276127935e-01   +2.180053725515151e-01; +3.679922939965128e-02   -4.720239263545174e-01   +1.484180208644511e-01   -3.148268737824627e-01   +1.009523423017438e-03   -4.022095812774706e-01   -1.669642226157705e-01   +5.652971822372986e-01   +5.677055081273095e-01; +1.128902383051500e-01   +7.930281844010377e-02   +3.619060380047994e-01   -9.197019633946216e-02   +5.212192077021540e-02   -1.608572171033323e-01   -1.038155841495306e-01   +1.825507952278272e-01   +3.613528432688832e-01; +3.273709131019162e-01   +4.838764118387247e-01   +4.076443024469899e-01   +9.784669106970367e-02   +7.148999308476257e-03   -1.282157174103386e-01   -1.777305066281249e-02   +1.585680671595333e-01   -3.969868733643902e-01; +4.330605950116133e-01   -4.537844874272625e-01   +5.927715835489689e-01   +9.893547080218103e-02   +2.737399244542817e-01   +2.710796856921027e-03   -3.246884276633165e-01   -2.944922293909619e-02   +1.660033916906793e-02];
L1_L4_iGABA_netcon = [-4.579527334708204e-01   -5.844150707853268e-03   +1.738046312382958e-02   +1.357224433671617e-01   +9.751510429746763e-02   +5.359017925856469e-01   +9.778407125281292e-01   +1.338599184236308e-01   +2.635866944548195e-01; -1.174624392402217e-01   -1.868953552487085e-01   +1.270822803578615e-01   -1.174923567046243e-01   -6.086809336187999e-01   -1.457178292890583e-02   +3.961365020656407e-01   -1.696948274982373e-01   +1.820264944104826e-01; +2.544607323650230e-01   -1.508483908080483e-01   +1.541665465570995e-01   +3.678653790687852e-03   -1.276301777234179e-01   -2.644350738072854e-01   -2.756925897227059e-01   +3.309855185701652e-01   +5.844427247249546e-01; +1.763349286151415e-01   +2.571095505209327e-01   -3.624044617915914e-01   -1.930671912113790e-01   +2.851796087915534e-01   +5.022268148667426e-01   +4.673582918639787e-01   +5.414569066182824e-02   -2.255903701022375e-01; +6.858725791506921e-02   -4.394622167696693e-02   +2.426220982887122e-01   +4.284026475282071e-01   -2.746637077859263e-01   -4.722615315285943e-01   +7.099974293830724e-02   +2.126136459867537e-01   -4.670684916943507e-01; -1.535292269925936e-01   +2.871665655819864e-01   +4.383998464669949e-02   +2.664573542559874e-01   +6.057610484362126e-01   -4.605099604963634e-01   +1.767066941636451e-01   +1.454783020115873e-01   +8.451660514352131e-01; +2.046005331903383e-02   +6.161528134158408e-01   -3.038693462069239e-01   +2.801946212494649e-02   +4.509699008941008e-01   -1.022414516533454e-02   -6.049443098142129e-02   +4.043049939703753e-01   +1.594558711695545e-01; -1.724877536293463e-01   +3.541267734569547e-01   +3.725786064054786e-01   +4.289371035461517e-01   -4.459874791448101e-01   +7.779197881486262e-01   +5.753070690708590e-01   +5.338884540179333e-01   -5.540403794269571e-01; -3.745841660868213e-01   +1.038768514978193e-01   -4.150224328811664e-02   +3.436758521585335e-01   -4.274644892262541e-01   -9.373852203009517e-02   -2.495419860183817e-01   +6.547476284470113e-01   +5.201790235584316e-01; -2.856104633942321e-01   +2.580145921871145e-01   +5.514342872001273e-01   -2.342900521497824e-01   +5.201107304640913e-01   +7.272063235941637e-01   +3.485110778472472e-01   -1.765187053403771e-01   +5.112900081934277e-01; +6.628711820565807e-01   -3.238775128828856e-01   +5.569360234758647e-02   +2.477032663774891e-01   +5.529035864681324e-01   +1.460066471743927e-01   -3.636545663250393e-02   +1.378442154697593e-01   +3.893848610385631e-01; -1.562991450905243e-01   +1.367951088077526e-01   -1.419510142834565e-02   -3.866687041092203e-01   +1.599369232386210e-01   -2.755248956155195e-01   +2.040416940883984e-01   +3.289424244298142e-01   +1.308760893623978e-01];
L4_L1_iAMPA_netcon = [+1.134800540067457e-01   -3.254802544972700e-01   +3.212918938835122e-01   +4.052551174130139e-01   +7.657234436422065e-01   +1.484733166987764e-01   -1.411679367684459e-01   -1.210285266801207e-01   +2.801179616174120e-01   +7.862381447523993e-02   -3.066818629559102e-01   +3.810705140488427e-02; -1.038155342317722e-01   -2.765742000226303e-01   +4.722097387825306e-01   +3.122554191902579e-01   +5.042708563275292e-02   +1.993310937687751e-01   +2.642175838136350e-01   -2.345262546248004e-01   -1.376078890102736e-02   -3.325614280383594e-01   +6.756005127487452e-01   -1.495890745508404e-01; -2.768450395269221e-01   -5.422686309320773e-02   -1.794813719547925e-01   +5.851085087443942e-01   -3.999815406287091e-01   -8.672611798371926e-02   +2.387792886372027e-01   +2.821195192430075e-01   +3.099177133354752e-01   +3.961947175964585e-01   -2.033297804413090e-01   +1.889395663018943e-01; +6.257503358817501e-01   +5.490440880920936e-02   -1.156074617496720e-01   +8.878737820656029e-01   +7.677263033447182e-02   +6.517668476449029e-01   -2.680657496921968e-02   +3.740770570351893e-01   +3.765852998803471e-02   -1.618338291996390e-01   +3.451781174768768e-01   -5.643403260061373e-01; +8.219714014898505e-02   +4.021113711344219e-01   +1.806429736404847e-01   +6.123864451539235e-01   -6.842321544100343e-01   +3.159079501281007e-01   -6.705068758047120e-02   +4.581462713521905e-02   -6.219163527696370e-01   +5.022397249488568e-01   +4.647620337408926e-01   +3.355829066056661e-01; +3.620449781839317e-01   +1.398926601961984e-01   -6.197715295693732e-01   +2.158267209981004e-01   +3.204875476277710e-01   +2.822245640027176e-01   +6.087807791011934e-02   -1.200879479394769e-01   -1.832273110905979e-01   +2.606511646430378e-01   +6.389709090413684e-01   -3.727629028448877e-01; -4.052943731925869e-01   +2.211222643585933e-01   +3.164030662175649e-01   -2.985133998895481e-01   +2.781445818631608e-01   +6.114619544656225e-02   +1.788890347539314e-01   +7.345409932228393e-01   -4.293315834105120e-01   +4.079788147221768e-02   +6.196074785758249e-01   +3.954595264848270e-01; -1.119585167923187e-01   +6.803989952639090e-02   +6.465282363015091e-01   -5.223281184187556e-01   +3.861248693635317e-01   -5.923103028573798e-01   +1.850527053222649e-01   +1.943586921073615e-01   +2.253985706745683e-01   -3.448355666938836e-01   -3.074350007212052e-01   -3.953998602939662e-01; +1.197304947475218e-01   -1.268446384752611e-01   +3.024303390753264e-01   +1.363315237626181e-01   +2.779487521667671e-01   -4.514576292549045e-01   +3.475877006350610e-01   +5.111935454378151e-01   -1.544360463992811e-01   +3.721648858515403e-02   -1.008567895531025e-01   -1.606780517724298e-01];
L1_L3_iAMPA_netcon = [+4.410020149231585e-01   +3.177921897601060e-01   +8.129559210538043e-02   +2.936966953050879e-01   +5.603207507058955e-01   +2.836148089767561e-01   +8.225534708158977e-02   +4.639991933241695e-01   -2.755059882244363e-01; +3.275211005372886e-01   -1.781764309825418e-02   +9.827453927801316e-01   -9.110690096233193e-02   -1.811365975777224e-01   +2.495967311040448e-02   +3.867807622278016e-01   -3.099792449048862e-01   -7.246766469984356e-02; +3.471144005196008e-01   +1.347130329621146e-01   -9.714278296541479e-02   -1.300068727011751e-01   +1.662129468834896e-01   -3.338404220854895e-01   -9.560884034009490e-02   +2.237699783667023e-01   -1.138925811256244e-02; -5.185099422438890e-01   -1.799023628244264e-01   +3.662469481806694e-01   +7.681958866675580e-01   -1.641540637023744e-01   -3.679872806738960e-01   -1.105156483285169e-01   +5.678129903724118e-01   -6.859674956758587e-02; +5.502286226532951e-01   +3.911598531236010e-01   +2.834473588047701e-02   +1.812580161250723e-01   -5.338807012972900e-01   -1.537439452667926e-02   +1.252333349715911e-01   -6.524000355366488e-03   -1.033657883208784e-01; +8.162735302943193e-01   -3.506072794638505e-01   +3.228353651452436e-01   -3.277694894440063e-01   +9.041045863585780e-01   +3.086879774313795e-01   +5.668017353723236e-01   +9.091009858084327e-01   +1.119215215447683e-01];
L3_L1_iGABA_netcon = [+8.733689869577294e-02   -2.157991687740454e-01   -3.549878654802600e-01   -1.143301636084236e-01   +2.529406875564469e-01   -6.542697884806968e-01; -3.252193066461409e-01   +1.436465784891944e-01   -4.006035602956357e-01   -6.224179359916323e-01   -4.120555585054316e-01   +3.115927978895240e-01; +3.858807129871328e-03   +5.113197325480314e-01   +3.665142285229595e-02   -1.356662849797845e-01   +6.404008377987186e-01   +5.357923124397999e-01; -1.235075744154934e-02   +4.584802195041273e-01   -2.249491222885954e-01   -4.488032096732966e-01   +3.755944656298071e-01   +7.192769305928193e-01; +2.877678706483354e-01   +5.472324187813488e-02   +3.170379521843438e-01   -1.011194529820504e-01   -1.199072696073723e-01   +7.642618927773197e-01; +4.390565759210358e-01   -2.614673402463446e-01   +4.762560408593353e-02   +4.604088334526737e-02   -3.365744865178646e-01   +5.420041519240580e-01; -9.156178788586589e-02   +2.198978822390464e-01   +7.012684637069083e-01   +6.964729495107684e-01   +1.802029809985518e-01   -1.935664913400613e-01; +3.326707303157045e-01   -1.918747432441705e-01   +2.940414941134539e-01   +1.553534606085311e-02   -5.923644888907310e-01   +1.347135587523008e-01; +3.082163413198193e-01   +2.832608700251625e-02   +3.514193738127150e-02   -3.316850905415292e-02   -5.618270735141213e-01   -1.130929437842040e-01];
L5_Input1_iAMPA_netcon = [-2.000360442256343e-01   -1.748225795081688e-01   +1.535685790552572e-01   +2.838909423569815e-01   +5.278060914369336e-01   -1.941525447689476e-01];
L6_Input2_iAMPA_netcon = [+5.783500507846778e-01   +4.392616961637766e-02   -1.997204532775197e-01   +3.819101958483233e-01   -5.191145002045752e-01   -1.659421706375960e-01];
L5_L6_iAMPA_netcon = [+4.052699490705348e-01   +1.163116561818516e-01   +4.099055322720213e-01   -2.408243605374510e-01   -1.934974940832897e-01   +5.016451373111016e-01; -1.402285447385495e-01   +5.443506789707218e-02   +9.138675064800927e-01   +3.556035368711719e-01   +5.024555798453143e-01   -7.681603406253330e-01; +2.415136295576160e-01   +3.618031913651643e-01   +5.534367082853073e-01   +5.827614781273966e-01   +5.995672541039990e-01   -1.720940788824154e-01; +4.651005177363172e-03   +3.129389200508564e-01   +2.394526680756669e-01   -4.252684816124834e-01   -2.575253148509293e-01   +4.307648022806733e-01; +3.103965242404227e-01   -3.378142931622412e-01   +9.991716335901660e-02   +5.124739968681928e-01   -3.374673914212775e-01   -3.754930934653113e-02; +1.625190250495075e-01   +4.824007140303599e-01   -1.353063328943340e-01   +2.746416040473629e-01   -1.184678800491130e-01   -8.950424523294678e-02];
L4_L5_iGABA_netcon = [-5.858096561398443e-01   +4.665937431844638e-01   -8.626502653075735e-02   +2.578751293320332e-01   -1.618673416246670e-01   +7.296494469228457e-01   -1.800670278312729e-02   -1.464066001505060e-01   +1.887985081850695e-01   +3.145693955417698e-01   +1.454008023449910e-01   +1.923211362211806e-01; +3.831669004854809e-01   +4.216320543302624e-01   +8.212775119438842e-01   -2.550705139536075e-02   +4.469371911411965e-01   +1.161374906638044e-01   +3.160459780358044e-01   -2.202960481674281e-01   -3.730533010344550e-02   +6.550327277695428e-02   +5.226134571314718e-01   -1.414076908501856e-01; -1.832176532283901e-01   -3.064080397059188e-02   +6.833955352312180e-01   -2.930784203157072e-01   -7.271098258811417e-03   +2.859049643066294e-01   +2.205352628587792e-01   +9.778783746705527e-01   +1.689216740311405e-01   -5.384165576873257e-02   +1.092861830001650e-01   +1.843803155988646e-01; -2.545054779564822e-01   +3.987881854950519e-01   +8.005808414799864e-03   +1.292651834582554e-01   -8.324980089891913e-02   +4.075791843110596e-01   -2.091021542481995e-01   +2.680268410597528e-01   -2.228033739835234e-01   +1.493632118344301e-01   +6.205076071761765e-01   -3.298565964453551e-01; -1.362437716343411e-01   +8.593749217535873e-02   +2.315334765819428e-01   +6.336639613963480e-02   +4.068235119439880e-01   +1.416763567551281e-02   +2.169881892923724e-01   +2.432236171456119e-01   -1.776666129945447e-01   +1.694444198917890e-01   +5.545395416264035e-01   -8.370288098804149e-02; +4.223910020010754e-01   +1.785684073642959e-01   -3.390190718164182e-01   -5.605489394001325e-01   +1.914259123251888e-01   +2.291998514532852e-01   +3.358179611385118e-01   +5.020906055471663e-01   +3.809711539264096e-01   +1.005977005602969e-01   +3.769266870540587e-01   +1.921466100123748e-01];
L6_L4_iAMPA_netcon = [-2.119629388283644e-01   -3.741089179771092e-01   -2.587597354248743e-01   +5.915282824372248e-01   +2.847195864497049e-01   -2.627453017087495e-01; +2.710700004213649e-02   -2.032762194292073e-01   -5.060527093757607e-01   +1.584119225839460e-01   +5.851526120912796e-01   +4.078965276538213e-01; +1.608097769495547e-01   -2.929611558186342e-01   -2.232143474776386e-01   -2.754866039746530e-01   -3.596678553701874e-01   -3.498147464729276e-01; +2.251086499766963e-01   -4.056616164168917e-01   +1.865566058281300e-01   -1.641133607016962e-01   -6.345359449923965e-01   +1.000000000000000e+00; -3.181921132768712e-01   +4.549724039677429e-01   -2.546794687517036e-01   +4.752058217228755e-01   +2.228688832606885e-01   +2.406957903150964e-01; -4.140743810749872e-01   +4.707819325865173e-01   +2.203916510807134e-01   +9.828883664598136e-02   -6.585668217463472e-02   -6.537526472929504e-01; +1.034815749581485e-01   -4.761435668895556e-01   -1.618016485891592e-01   +4.740737544845175e-02   -2.924753520904276e-01   +4.461038008693645e-01; -1.103567891137888e-02   +3.828869924928060e-01   +5.505637683745014e-01   +2.964405089542634e-02   -5.546764082784345e-02   -3.312419684743871e-01; +2.724492669790459e-01   +1.060136980454711e-01   +7.060229550053108e-01   +4.907775834181285e-01   -7.242808210029611e-02   +7.933040840433611e-02; +6.968565601759422e-02   -2.211816210420643e-01   -1.352394270888848e-01   -1.308686164037961e-01   +2.856931392744418e-01   -4.167494091862994e-01; +5.053014067136569e-01   +1.285126901334102e-01   +5.733718843215787e-03   +4.582651728626498e-01   +1.039547823286591e-01   -8.493024465225037e-02; +7.090966681723756e-01   +4.135812336631352e-02   +2.701368680465478e-01   +1.317480040122993e-01   -3.130607670432005e-02   +2.809157731544228e-02];
L5_L4_iAMPA_netcon = [+1.112740585596459e-01   -4.379834701061583e-01   -1.574689209591131e-01   -3.014740154886025e-01   +1.213543004358046e-01   +4.427160689699062e-01; +3.894777820503124e-01   -3.551662597669835e-01   -4.445034048858462e-02   -4.369812096336578e-01   +3.454732214651797e-01   +3.666746567299544e-01; -5.471706844110927e-02   +5.111210073553734e-01   +4.494665653113974e-01   -8.822735603976339e-03   -5.360180795043861e-01   -2.437608198868648e-01; +2.121753919302059e-01   -7.962454709933856e-03   -4.156333107209215e-01   +2.163949926128362e-01   -1.200655617724616e-02   +8.193578660256237e-02; -8.466025994322124e-02   +6.091493283525313e-01   +6.174191308048764e-01   -2.249685337165075e-01   -3.305431965845902e-01   -4.624130805150526e-01; +1.215071533893429e-01   +2.623349035529962e-01   +7.756398967471130e-01   +2.299478883138308e-01   -5.030154938595852e-01   +2.157604544777366e-01; +4.660372055739683e-01   +4.813300456092565e-01   +4.745322104253564e-01   +2.365486925086302e-01   -1.458643045198326e-01   +2.549159627175952e-01; -2.581542335528018e-01   +3.278088144656650e-01   +1.353922433374831e-01   +4.201020194192191e-01   -6.202673147950174e-01   +3.282954964060233e-01; +2.438998007759693e-01   +6.826115545387467e-01   -6.434213598090963e-01   -6.178910557447568e-02   +2.089845968865078e-03   +2.046178101324632e-01; +5.484868519134526e-01   +4.155780193924820e-02   -1.791115462717898e-01   -5.047923799641640e-01   +7.650853001273861e-02   -2.130070132806156e-01; -2.589907702587631e-02   -5.424068543607242e-01   -1.698306822928647e-01   -2.041099469510959e-01   +5.150449370231091e-02   -5.007332238392360e-01; +4.554447347301604e-01   +7.527472613766018e-02   +2.612504263189945e-01   -1.102010598621748e-01   -2.688329678002371e-02   +3.893358373394679e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
