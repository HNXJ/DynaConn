function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.676497664420145e-01   +1.598004520011632e-01   -1.748714164500809e-01   -4.313202043999923e-01   -2.383478321628127e-01   +3.970351272345655e-01   -3.498234131499188e-02   -1.006543549508905e-01   +2.703691381678874e-01; -5.018018604485611e-01   +3.222445295328283e-01   +3.882970499730366e-02   +4.931154444624574e-01   -1.178959786044553e-01   -5.656633569905589e-03   +3.479483846092835e-01   -2.647621549661276e-01   -1.779778178160388e-01; -1.215713688365724e-01   +1.557040430106750e-01   +4.732704754563311e-01   +1.699656590953749e-01   -3.174890739880971e-01   +2.455920118242602e-01   -8.880051633742692e-02   -7.417145685372537e-01   +3.522906248603656e-01; +6.244907405037865e-01   +5.331402267390367e-02   +3.691951152378751e-01   -4.437159782007007e-01   -4.731144096212586e-01   -8.135716718314756e-01   +1.324841475105075e-01   +8.800190177612105e-03   -1.114988116164026e-01; -8.169361254814672e-02   +9.350694554060524e-02   +2.655456614907200e-01   -3.438980927382924e-01   -6.524127081429509e-01   -4.399811392621585e-02   -3.330044711639481e-01   -1.605691710470035e-01   -1.960040905006413e-01; +2.798486431695318e-01   +4.127270457698151e-01   +1.384176561544468e-01   +4.993909884588619e-01   +4.593371241028517e-01   -3.096646754073729e-02   -5.235512851578104e-02   -2.176746502933000e-01   +8.706244403750441e-01; -7.232912582796391e-02   +1.685319254084068e-01   -2.273834477219633e-01   +1.784658746288950e-01   +7.197961880795939e-02   -1.647453783800769e-01   -4.047052529420413e-02   +1.067703937573126e-01   -4.343640376973718e-02; -3.744756235573079e-01   +5.787670942306725e-01   -6.461835101566424e-02   -5.928321136344041e-02   -5.338936180810386e-02   -6.921247314232042e-01   -1.283291971002913e-01   -2.823452269067267e-02   +3.824751681402584e-01; -2.049748848111430e-01   +4.820973645526558e-01   +4.115137090606696e-02   -4.702918711675003e-02   +3.576787932096563e-01   -1.557168458691932e-01   +2.723335801842997e-01   -5.127756921704207e-02   -3.459671618310434e-01];
L1_L2_iAMPA_netcon = [-2.343997154588051e-01   +2.794797739497715e-01   +2.086657098118142e-01   +1.613601201530039e-01   +6.704778282489505e-01   -5.116495746126382e-04   -1.231429207518582e-01   +2.492501924065504e-01   +2.711254934919463e-01; -2.706811066748940e-02   +4.130131772029699e-01   -3.779201506360516e-01   +3.257530145200393e-01   -4.692611563568965e-01   +1.406679335659115e-01   +2.441871361041893e-01   +1.565866158643857e-01   -6.569282271626137e-02; -3.497550904166791e-01   -8.467210034545093e-01   +1.271421214175975e-01   -2.606425679846278e-01   -3.417926876980112e-01   +5.510173926375733e-02   +8.832990525758585e-01   +2.513442635948061e-01   +4.375701940732767e-01; -9.191928172135964e-02   +7.935985133700443e-01   +5.521453601757514e-01   -3.642580594258831e-01   +9.490441307339509e-02   +1.522603044220819e-01   +6.804341123287132e-01   +7.082944719069485e-01   +3.644937796673007e-01; +5.718383961360617e-01   -9.713543409686183e-02   +8.860763993629786e-02   +8.643232825226135e-02   +1.597422671685694e-01   +3.230363923991869e-02   -3.460402894494622e-01   -2.114330972765022e-01   -5.302080035790681e-01; -2.574018428150823e-01   -3.778199031202772e-01   -1.930342877742427e-01   -2.535601665367050e-01   +9.670005624936012e-02   -2.110574399807456e-01   +5.836211999527033e-01   -3.620575587028297e-01   +5.012420516777349e-01; +6.755169532921361e-01   +1.345605371298004e-01   +1.659584560590746e-01   +6.019334231750049e-01   +2.917648248563011e-01   +7.404552603165077e-02   +3.842272954088896e-02   +3.130983530098687e-01   +2.840041389738140e-01; +8.769903890898706e-01   +5.085096830047711e-02   -2.143689964319044e-01   +7.050520571395162e-01   +6.076941531930874e-01   +8.833267297836019e-01   +8.325801058145704e-03   -6.131215697714125e-02   -9.205204660980837e-02; -3.704918311209196e-01   +2.663022523438486e-01   -2.008886249953255e-01   +3.231915014973294e-01   +1.082166918783262e-02   +2.571816288738500e-01   +3.257104795714732e-01   -1.957430271241589e-02   -5.828146217533976e-01];
L2_L5_iAMPA_netcon = [+6.345528933263772e-01   -1.929231014242801e-02   -2.444182156717313e-01   +1.976529360401162e-01   +1.169731753414629e-01   +8.963833031223958e-02   -1.605623508261592e-01   -5.963469237911047e-01   -2.094395607285479e-01; +8.607490459772142e-02   -1.900996198497756e-01   -4.338741220995834e-02   +6.090853909076736e-01   -1.200620244629385e-01   -6.617666507794095e-02   +1.165201410439580e-01   -2.250631688726797e-01   +1.908011802891205e-01; +3.390906409844187e-01   -1.724950721548232e-01   +3.135278193406508e-01   +7.680612226354629e-01   -2.837080000302511e-01   -1.120761798624547e-01   +3.631046061361698e-02   -1.957819162372781e-01   +3.993477927890866e-01; +2.866718519096235e-01   +2.760604924000247e-01   -1.756535222062885e-01   -1.211289430623071e-01   +2.298128727168633e-01   +2.127783588665176e-01   -5.892445907035473e-02   +2.760903398504208e-01   +3.769966753499560e-02; -4.907063566244674e-01   +3.642203745326845e-01   -2.833428735129283e-01   -2.358254274392019e-01   +1.716388570655170e-02   -1.892204015174289e-01   -7.191310049459804e-03   +7.424689534469255e-01   +5.130994295940756e-01; +1.107287574489680e-01   +5.111852392909896e-02   +2.217295360100617e-01   +3.156403707740469e-01   +7.341381908044992e-02   +3.918596154516909e-01   +4.214410212443398e-01   -1.839843168538455e-01   +4.566284421033885e-01];
L5_L2_iGABA_netcon = [-4.060887141468481e-01   -5.222321495277167e-01   +7.052820058823354e-01   +3.580578080556615e-01   +1.618794988346575e-01   +6.706660640252490e-01; +2.017998549097851e-03   +2.837347014861493e-01   +1.967963760202902e-01   +1.640085562666348e-01   -1.757803926643475e-01   -2.043726245095631e-01; +3.041140828096341e-02   +2.860050367610911e-02   +4.029213097211402e-01   -1.553834431420451e-02   +1.599724821762883e-01   -4.106553137204576e-01; -3.926249991593287e-01   +1.883442460545117e-01   -4.781611639890671e-01   -2.784240057569936e-01   -3.192331042496906e-02   -7.576721831942075e-02; +3.939430824154481e-01   -3.734963231802186e-01   +1.085046108122129e-01   -4.900619517611319e-01   +8.062307938599193e-02   +4.668602507017076e-01; +1.925021852975004e-01   -1.947823239848631e-01   -2.761126991671025e-01   +6.614713907922815e-02   +1.965294416307145e-01   +6.399782278682515e-01; -3.880700157120598e-01   +1.410263422845666e-01   +5.891461887755093e-01   +1.000000000000000e+00   -7.262940793315406e-01   +9.719733373366121e-03; +2.885323984819755e-01   +3.853006271774752e-01   +2.515356561060885e-02   -4.729758671257091e-01   -1.131912310477148e-01   +4.432057765981864e-01; -1.427463119097419e-01   +3.089211681902477e-01   -4.317636028223636e-01   -1.577782596188247e-01   +6.206938617293086e-01   -4.736714598739818e-02];
L3_L2_iAMPA_netcon = [-1.499318583406245e-01   -1.204210009004682e-01   +1.490335591978368e-01   +3.560006626657296e-01   -1.357610180134798e-01   -2.503376851363005e-01; -1.773507161526856e-01   +3.405831264350493e-01   +2.256541586611027e-01   +3.213902903556044e-01   -2.867768542295235e-02   +7.327466373591059e-02; +6.581157790944756e-01   +5.599832018068280e-01   +2.719387337817789e-01   -4.378161062343328e-02   -5.444823217092104e-02   +2.681957150321213e-01; +3.613872842466618e-01   +2.337922371839004e-01   -4.114293753913531e-01   +8.634975988612342e-02   +7.034969593796518e-01   -3.671805205616426e-01; +2.838141298664029e-01   +1.052602091557833e-02   +2.950802839686770e-01   +2.294133043444238e-02   +3.198435970527109e-01   +3.465085359962531e-01; +5.273452021954042e-01   -1.117865727606870e-01   +5.019099359652109e-01   +2.908358227184967e-01   +9.480417018298526e-02   -1.405715960552029e-02; -6.367929911027609e-03   -3.486998449357899e-01   +4.992092554431325e-01   +1.395722466021861e-01   -8.796993166230803e-02   -6.245610027474163e-02; +1.610811763815522e-01   +8.757004202213712e-01   +2.659234231176300e-01   +6.439914418071191e-02   -7.461391620075894e-02   +2.054831090365399e-01; +3.263094264636934e-01   +9.684650764233892e-02   +2.792718499771353e-01   -1.215096719128532e-01   -9.285549904893875e-02   +7.188003359755388e-02];
L2_L3_iGABA_netcon = [+3.822256975399675e-01   -4.491516150160323e-02   -9.445723857712590e-02   -1.795229445503391e-01   +5.608083471547916e-01   +2.422248282973190e-01   -2.347159429945272e-01   +2.783668019900787e-01   -3.185270252557686e-01; -2.386612996541580e-01   +2.198581175665519e-01   -1.687026760848745e-01   +8.535811230679875e-01   -2.987513629464926e-01   -2.753034979954725e-01   -1.729761322332616e-01   -1.715967242188781e-01   -3.864031129578786e-02; -2.765702370460081e-01   -1.745795808039615e-01   -3.600401310363147e-01   +5.047057679109320e-01   -2.922956155074468e-01   -1.669602716665994e-02   +5.087312639728931e-01   +6.282476544973270e-01   +1.082148673544329e-01; -3.103854443798297e-02   +4.414421817452763e-01   -1.424235721721994e-01   -1.678426114621742e-01   +1.361279405594283e-01   +6.872309300546579e-01   -5.144134295070407e-02   +1.342121304995739e-01   +3.916408485093397e-01; +6.043803553044804e-01   +5.707038252407881e-01   -1.160593123598032e-01   -2.605246596159443e-01   +8.404179077273523e-02   +5.021110673560565e-01   +3.550897395915499e-01   -4.332928312106223e-02   -1.354574830709596e-01; +2.460188192560506e-01   -5.492082729789849e-01   +2.204507620413753e-01   +3.780630667056479e-01   -4.595471958327353e-01   -1.703144576638602e-01   +7.604042766621966e-02   -9.124136746565764e-02   -3.116986369237512e-02];
L1_L4_iGABA_netcon = [-6.563935942561439e-03   +3.358385511979775e-01   -2.272417589737591e-01   +5.343542394868610e-01   -1.796184749464508e-02   -3.019901275666588e-01   -8.056105311942832e-02   +3.238541913943916e-01   -1.253688327184807e-01; +2.826648314619060e-02   +5.211977275860691e-01   +2.155649015433202e-01   +5.138748094910442e-01   +3.270554200023836e-01   +2.218654523142432e-01   -3.535007056374745e-02   +4.009171088512279e-01   +2.569255696413198e-01; +1.196027152823093e-02   -1.010280594070168e-02   +4.914904316371489e-02   +1.191578915064093e-01   -6.298421759924312e-02   -2.448390284542870e-01   -6.271472447590948e-01   +5.710499460019383e-01   +4.505668437640662e-01; +3.789790961776048e-01   +2.301350333436555e-01   +2.106170484077599e-01   +2.132153063021505e-01   -4.339142324078771e-02   -3.204200533231633e-01   -2.621161325333267e-01   -1.014647083283066e-01   -2.702340611178567e-01; -2.103756614092567e-02   -1.744605831260289e-01   +5.497569965911520e-02   -3.602869819989693e-02   +3.942401718831579e-01   -3.092898526203056e-01   +3.437662804347034e-01   -2.954041986663520e-01   +2.521074549811570e-02; -2.667123606998589e-01   +3.865896543583228e-01   +2.004931742858113e-01   -1.022660897550781e-01   +5.574381292241867e-02   +1.449620449843744e-01   -2.010092595672645e-01   -4.071331880596974e-01   +1.059868005205901e-01; +1.826298827578936e-01   -2.119274047773239e-01   -1.145625962956599e-01   -1.850036325865223e-01   -1.245496440316684e-01   -3.350005095864612e-01   -6.894639613212546e-02   +5.443673706015453e-01   -7.327357723365029e-01; +1.516591107329079e-01   -1.051712325337932e-01   -4.743007230624746e-02   -5.055505518188500e-01   -1.469695653132068e-01   -2.351279378364468e-01   +1.503949697343061e-01   +1.437726574672196e-01   +2.919098095317934e-01; -5.552390816425642e-01   +3.229181625272228e-01   +5.258059352214435e-01   +4.839100675106310e-01   -3.004324007769080e-01   +6.633881269215171e-01   -4.124956628635618e-02   -5.816445841721304e-02   +6.984984737703687e-02; -2.975115205544496e-02   +2.979277027762163e-01   +3.144264348276882e-01   -1.786124629922141e-02   -6.822203246669747e-01   -7.137142406708530e-01   +3.109352928067842e-01   +2.436902113482405e-01   -6.402575290860252e-02; +6.393319847059895e-01   +2.441474452903389e-02   -7.804511294013562e-02   +5.465012285887013e-01   +2.985275129929521e-03   +8.301222476614507e-01   +4.772675483968228e-01   -5.336051895388753e-01   -3.364860396269402e-01; -1.736605145196416e-01   +1.534693747937513e-01   +6.687804454366414e-01   +1.806774535756602e-01   +1.339457703294072e-01   -1.301756175711100e-01   +1.800855799021279e-01   +3.735725941663594e-01   -2.283538985705170e-01];
L4_L1_iGABA_netcon = [+4.173496333029806e-01   +4.900890517140153e-01   -1.206026970340362e-01   +2.996448895551331e-01   -1.151351600768607e-01   -8.783938068561465e-01   -1.966310032934937e-01   -8.037486015373842e-02   +7.072450756067378e-02   +2.847310569872025e-02   -3.929385929855795e-01   +4.151248975571729e-01; +8.430930717344966e-02   +4.211023188557879e-03   -2.711428424160843e-01   +4.759118663726083e-01   +6.530453861202442e-01   +7.241203503525400e-01   +3.487155113591946e-01   -1.444211277431695e-01   -7.993739644493323e-01   +3.106828858183919e-03   +2.128811782352897e-01   +1.692316065262700e-01; +8.728543287648109e-02   -1.594585485199185e-01   -6.900677092159045e-02   +2.296916059328344e-02   -1.829428094067585e-01   +1.226409328195584e-01   +3.292191521488270e-01   +2.119961017052598e-02   -1.781584900667839e-01   -1.528188612414324e-01   +5.302788009803484e-01   -1.953817293296040e-01; -4.495357436507603e-03   +3.648283561213874e-01   +3.778747037466645e-01   +3.559739734681428e-01   +7.409760953557658e-01   -2.103840994713275e-01   +2.993773106979291e-01   +1.310962268679186e-01   +5.233251276724988e-01   -2.574101539396844e-01   -3.698845129730896e-02   +1.639626674429012e-01; +4.786324067413025e-01   +1.320936006965467e-01   -4.578932136515980e-01   +2.882210890772841e-01   -7.951172445610141e-02   -4.549165502155852e-01   -1.230818112102856e-01   +3.490816137396173e-01   +7.613117347884836e-01   -2.990000926745469e-01   +3.643074794681671e-01   +3.325308206322538e-01; -2.543329482964420e-01   +6.538490337432032e-01   +2.212588364578162e-01   -1.501294636575961e-01   +3.529043960992920e-01   +1.985061782233253e-01   +4.159754352523332e-02   -5.827486108170256e-01   +4.388132052247898e-01   -2.588898387328906e-01   +2.535012389218552e-01   +1.357787629589273e-01; +2.785258175286109e-01   -6.420096678852287e-02   +2.066593090688693e-01   -4.238022740167847e-02   +2.223137128888538e-01   -1.545008280896248e-01   +3.864058722437216e-01   +1.538791154445053e-01   +6.093928232198679e-01   -5.757263607859633e-02   +7.471609269980013e-01   -5.347395964077735e-01; +5.755801812402401e-02   -4.538530934116999e-01   +7.575569680838796e-01   +7.111342161234657e-02   +8.419154915615701e-01   -5.835769486000801e-01   -3.940683262793110e-01   +8.071044472910591e-01   +6.716519031725296e-02   -4.628800369349008e-01   -3.783039171306335e-01   +1.289969351193430e-01; +6.343140589386426e-02   -3.783227752199669e-01   -5.532822595809457e-01   +4.485976161356680e-02   +5.719726874534172e-01   -1.342524254505381e-01   +8.143059422691634e-02   -3.397880304462593e-01   -2.986556997271854e-01   +1.495156072930430e-01   +3.878527047009616e-01   +8.286859442314908e-01];
L1_L3_iAMPA_netcon = [-9.253597331143829e-02   -6.155933861320245e-01   +2.070030060126435e-01   +1.059147157511817e-01   +1.000000000000000e+00   -6.057228994214503e-02   -2.138268340861319e-01   -4.544561206716834e-02   -2.691676426518981e-01; +5.028087362308283e-01   +3.663050328602804e-01   +3.749896861191326e-01   -1.443549747141950e-01   +1.187560789619622e-01   -2.058657843698371e-01   +1.547486515114835e-01   +2.595675020035308e-01   -1.068045173174597e-01; -2.816118530399109e-01   +5.184839562824826e-01   +8.553211494724881e-02   +4.065948669122968e-01   +4.956214361221805e-01   -2.761502224407923e-02   +1.366541092364674e-01   -4.478370581731606e-01   +1.956520512512500e-01; +2.276951986952532e-01   +1.486707220548682e-01   -1.731960447825861e-01   +1.418467648879734e-01   -3.897407309873446e-01   +4.290371936047421e-01   +1.204839047354721e-01   -3.963145510231607e-01   +2.593600299048875e-01; -1.303295407852111e-02   -2.629000061660142e-01   +1.827790832300360e-01   -3.561645984215153e-02   +2.915226411011626e-02   -4.754105548820167e-01   -1.832948686553131e-01   +7.677014838973728e-01   +8.508338374976791e-02; +3.564739889706775e-01   -1.842354797736786e-01   +1.294016549377383e-01   +8.913014341454110e-02   -1.366412299318147e-02   -9.279037202382176e-02   -2.248043133698011e-01   +1.582198477555334e-01   +2.873668355391429e-01];
L3_L1_iGABA_netcon = [+1.359304197385911e-01   -4.647336589790577e-02   -2.476661990018602e-01   -2.654768458476360e-01   +3.691164554484520e-01   +3.350830294733518e-01; +1.266559605232912e-01   -5.663982349449390e-01   +2.382629937411533e-01   +5.343973205576077e-02   -2.440005453576267e-01   +1.893844466697080e-01; -3.988302371525078e-01   +5.661780417366481e-02   -1.297580970453693e-01   -2.224371698421768e-01   -4.295457902265449e-01   +2.492083419570859e-01; -2.904077267000070e-02   -2.268150914466491e-01   +5.917252760624714e-01   -1.065575046367547e-01   -1.133701113113622e-01   +7.553275217423646e-01; +5.227870655474151e-01   -2.099295084172044e-01   +1.936825202543207e-01   +2.113860900929413e-01   +3.839909679000376e-02   +1.418286101004931e-01; -1.215766622456274e-01   +3.608964643625813e-01   -1.553346170873661e-02   -4.127603948347499e-01   -3.810448687082189e-01   -9.042208859779499e-02; +3.572504145787470e-01   -4.618271578351077e-02   +2.795350695616590e-01   +2.066011153606117e-01   -1.248681613963608e-01   +2.463488644261730e-01; -2.192717231576418e-01   -6.081188536092361e-01   -2.330033812851510e-01   -2.057124916629463e-02   +1.336766967355678e-01   -2.314642935840772e-01; -1.522102180836576e-01   +5.995476666408202e-01   -1.376218466810510e-01   +2.755994944674361e-02   +1.854808616636031e-01   +2.636084737621643e-01];
L5_Input1_iAMPA_netcon = [-6.658863925278512e-02   -2.317873511392304e-01   -3.210024510460341e-02   -1.420567949090175e-01   +3.090297682130046e-01   -1.537362444982440e-01];
L6_Input2_iAMPA_netcon = [-2.894298037088618e-01   +2.269521237453049e-01   +1.425426322001950e-01   +3.595604261808586e-01   -2.095754590371768e-01   +2.161882175907245e-01];
L5_L6_iAMPA_netcon = [+2.137622592125418e-01   -7.740403714186683e-02   -5.441134838504172e-01   +4.408737585701343e-01   +4.620362663484642e-02   -4.018755779528163e-01; +5.148035208433128e-01   +3.967461878619108e-01   -2.985196753706121e-01   -9.392756411971490e-01   +2.559839776725703e-02   +4.213518182764575e-01; +4.776846936872048e-01   -6.712042307132425e-01   -2.284147833729130e-02   -2.370030313509696e-01   +1.078812617882932e-01   +5.436499280549484e-03; -5.137662500311149e-02   +4.448385057610771e-02   +2.970978728675758e-02   -2.082068983088785e-01   -5.800484464988068e-02   +3.137115491185543e-01; -1.049419870432590e-01   +2.062356739711772e-01   -2.833578372529857e-01   +1.387509207896580e-02   +3.784039684457757e-02   +1.264237524473363e-01; -4.390435392432810e-01   +7.181363853076754e-01   +5.402636261867093e-01   +1.380856174789069e-01   -3.251145038635928e-01   +1.213804076430307e-01];
L4_L5_iAMPA_netcon = [-5.114553458149447e-01   +3.556554750612278e-01   +3.464468999349796e-01   -2.774665669607590e-01   +2.263597424734291e-01   +2.506575740434964e-01   +2.772270619744022e-02   -3.315411513589902e-01   +8.094843268042134e-02   -1.518398484442495e-01   +6.533009083700494e-01   -2.830504287892749e-01; +1.643888868087239e-01   +3.943674475842615e-01   +5.840753378456611e-01   +6.041003133415410e-01   +2.965064530626531e-01   +5.796651329158295e-02   -5.117302781159319e-02   -1.491334942879733e-01   +3.417447463945529e-01   -3.682831028262035e-02   +5.156761662721570e-01   -1.316218710354681e-01; +9.210404690502940e-01   +4.761497806591972e-01   -5.811087965485600e-02   +1.773571388772366e-01   +3.180096913616262e-01   +3.568390245930778e-01   +4.724408074685160e-01   +1.832059507385732e-01   -2.985857326433572e-02   +6.879592037633115e-01   +2.240263940501005e-01   -1.179764654862946e-01; +5.896228146789948e-01   +3.538760130471681e-01   +5.879613800590405e-01   -2.378916919035496e-01   -4.906327288423712e-01   -7.517504929112989e-01   +1.067080208796631e-01   -3.388341420334670e-01   +2.612618880984031e-01   -4.320176745939568e-01   -2.528486025524148e-01   +1.320069051059858e-01; -5.385716197345336e-01   +8.052441656777456e-01   -6.006588876827056e-01   -6.044382497357023e-02   +1.148878894482840e-01   +4.198747691006769e-01   +5.122811107813194e-01   +1.937105521259691e-01   -3.764932929126731e-01   -4.362107351512682e-01   -4.802319584844722e-01   -7.730057662760639e-02; +5.376280945333816e-01   -5.077127831510608e-01   -9.453775413365451e-03   -4.994010199883889e-01   +2.733750118154989e-01   +1.831133840857913e-01   +5.011471671917620e-01   -2.823376492257849e-01   +5.207060874258920e-01   +4.093534528175521e-01   +2.683176997736117e-01   +1.558168815454122e-01];
L6_L4_iAMPA_netcon = [+6.777640775830968e-02   +1.449998962733650e-01   +2.312582155357884e-01   +3.591163844972978e-01   +5.731601836839847e-02   -6.557010234651837e-02; +4.961561990440354e-01   +3.155737323390494e-01   -1.014021563312772e-01   +2.629784530864786e-02   -5.807045321475200e-01   +6.052682118550812e-04; -1.422782420456734e-01   +2.541843732042995e-01   +2.912763267807901e-01   +3.614994585528671e-01   +4.675994276476770e-01   -2.884992074354834e-01; -1.682191658571792e-01   +4.929784339146593e-02   +4.178292131427981e-02   -1.609060580274042e-01   +1.735805470001763e-01   -2.377906720305198e-01; -2.865514086569473e-01   +3.390866607400065e-01   +3.625920854441755e-02   +1.761835179636107e-01   +2.326934182065333e-01   +1.335459734660296e-01; +6.286652833126406e-01   +7.959585205921099e-02   -1.482424579520255e-01   +4.072722960815990e-01   +2.878564925847429e-02   +2.637071971145919e-01; -4.672502352109384e-01   -2.400597360379553e-01   +2.353142198602807e-01   -2.361150768343601e-01   -4.635247902334880e-02   +5.383824115686144e-02; -5.729895689669232e-01   -6.693289301734280e-01   +3.336879065621538e-01   -3.000673687591112e-01   +3.586432960805589e-01   -1.249338848148251e-01; +1.877918649527408e-01   +1.711662030243233e-01   +8.527902857695206e-02   -5.383153443552553e-01   -1.348861377264529e-01   +2.663354730917255e-01; -4.542825468318041e-01   -1.225378395517826e-01   +1.358934632775150e-01   -9.545355057795775e-03   +1.323143761350721e-01   -4.462402197622212e-02; -4.095545061370011e-01   -3.593818175918139e-01   +6.612410729651135e-01   +8.623981678399961e-01   +2.941079463784003e-01   +4.900601940344564e-01; -2.091957228675697e-01   -3.052027657861118e-01   +1.454756145414034e-01   +1.705083624080661e-01   +1.992249084069172e-01   -5.454932428407997e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
