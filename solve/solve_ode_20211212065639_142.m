function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.077345370463124e-01   -4.916428034398136e-03   +5.833088363811793e-02   -6.279874006730556e-02   +2.834584085357784e-04   -9.321512755091022e-02   +1.643551737067828e-01   -6.263777596031028e-02   -6.771792517011940e-02; +1.172452972104626e-01   +7.111238214689784e-02   +9.098369556722871e-03   -5.793417097385948e-02   +1.309657253943170e-01   -4.001151555740016e-02   +3.426765801764914e-02   +8.824249549405822e-02   -5.282665906511778e-02; -6.825822572269337e-02   +1.722404030322202e-01   -8.665975115090067e-02   +1.384990087029273e-01   -4.145718104370253e-03   +7.925078660649908e-03   +1.657459245605653e-01   -1.444925154946874e-03   +2.240089346411150e-01; -8.246185092889266e-02   +6.735612603570393e-02   +8.353586969491075e-02   +1.058934828549991e-01   +9.574159921299311e-02   +5.801386375827711e-02   +1.496986522432250e-02   -8.795105299783673e-02   -1.420552197587866e-04; +1.056378596418982e-01   +3.550302609862727e-02   +1.349804336592529e-01   +1.231603312456210e-02   -1.056395865970981e-02   +1.303331418681358e-02   +2.266701393108985e-01   +3.329246123639285e-02   -6.770206918575813e-02; +6.565830398067848e-02   -7.491215609454970e-03   -2.526480214342308e-02   -3.540584670416544e-02   -1.444686968759793e-01   -9.536769063780062e-02   +2.530731695972660e-02   -8.723278446118823e-03   -2.668215871603666e-03; +7.492611624114447e-02   +1.801470758266618e-01   +1.133643891394435e-01   +1.860658328335436e-01   +1.917932875773430e-02   -5.422496173028098e-03   +5.502086200475093e-02   -1.641121719915116e-01   +3.960030340597913e-02; -5.222090340266758e-02   +4.630643272184726e-02   +1.335016780679443e-01   -3.820099174903993e-02   +6.570101967631314e-03   -9.871331293500285e-02   +5.184671152346371e-02   +1.027455436746222e-01   +9.688508591439274e-02; -2.219000423530540e-02   -1.628373405690373e-01   -3.686920167557958e-02   +4.816158268057339e-02   +1.811070321029998e-02   -7.658482930546272e-02   +1.147512993919489e-01   -1.462579219289195e-02   +1.437141319282350e-01];
L1_L2_iAMPA_netcon = [-8.382453262773294e-02   -1.699913627642934e-01   +1.349347541556408e-02   +7.828987983844962e-02   +1.103507611176706e-02   -2.330752893882605e-01   -9.834630316250197e-02   +2.732259903556239e-02   +1.233875085181370e-01; -7.781381859383722e-02   +5.189703695215236e-02   +5.047591092631490e-03   +1.680639714022553e-02   -4.440504009243871e-03   -1.459629066296831e-01   -6.897008240516667e-02   -4.906770260216453e-02   -5.040732004203168e-02; -6.158530766964110e-02   -1.379470255695172e-01   -7.397997572775717e-03   -4.077541522999915e-02   +9.831341303829544e-02   +8.210183203257915e-02   -2.123147584474995e-01   +2.266162364487684e-02   +4.142984276249428e-02; -3.829031892833483e-03   -2.992391914270953e-02   +6.114249616616620e-02   +1.372701080392977e-01   -7.934780725225488e-02   -1.140284369133295e-01   -1.188303822889272e-01   +7.298099756411627e-02   -1.130923200666443e-01; +1.103619062766301e-01   -7.051338452000018e-02   -6.540122522175837e-03   +1.445790647098850e-01   -6.000184249987398e-02   +4.592404960298805e-03   +4.254984439449833e-02   -3.018570885992208e-02   -4.305220850559438e-02; +1.781720967749020e-01   +7.697923105892390e-02   -9.707572791127396e-02   -4.469421478362058e-03   -4.090231701293161e-02   -6.224521264439481e-04   +2.047907739438198e-02   +1.115239338519254e-01   +8.180211917618183e-02; +3.671456474412322e-02   +2.758935534260649e-02   -9.112057856044558e-03   +2.846021119322396e-04   -9.462549860537227e-03   -3.684147230748282e-02   -8.660732025941958e-02   +8.276741205189556e-02   +5.835238427806587e-03; +6.834336602391321e-02   +1.517151471802067e-01   +8.288332527390928e-02   +3.300108760672588e-02   +1.939248103791481e-01   +1.849151419052897e-03   +1.376510767131329e-01   +1.090481518972079e-01   +2.096744907446723e-02; +1.716741686467933e-01   +8.035854967352907e-02   +9.345306211703746e-03   -1.488475637827680e-01   -7.801846307418506e-02   -9.693297658752140e-02   +7.882350772452078e-02   +1.170761957278911e-01   +9.491336534311000e-02];
L2_L5_iAMPA_netcon = [+8.624359632163393e-02   -1.631038849662452e-01   -6.228493075459189e-02   +1.482903705783239e-01   +7.404754428738329e-03   -2.511421125051768e-02   +6.985784335961234e-02   +3.789875558836592e-02   -1.363148822466780e-01; +1.112575481501078e-01   -3.908050205193988e-02   -1.599516618519640e-01   -6.728504263238507e-03   -1.515205373370854e-02   +5.531706768647538e-02   -2.947362148957823e-02   +1.023263084792539e-01   -1.009378673926832e-02; +1.793021197536540e-01   +9.918755172369112e-02   +1.619360704117382e-01   +2.415623556195866e-02   +4.389820931168760e-02   +9.045990403902747e-02   -1.501641299487977e-02   -9.559506620423144e-02   -1.053651275856311e-01; +5.572610640754130e-02   +1.335117450296691e-01   +2.508499337403802e-01   +7.595337878673817e-03   +1.944831007288430e-01   +3.726210771760201e-02   -1.760945767792498e-01   -1.270372172976187e-01   +5.833608124638655e-02; +1.260966562497902e-01   +1.296511684531199e-01   -1.067036761503524e-01   -7.834356592030545e-02   +9.716224737838502e-02   +1.843703704689778e-01   +1.689712026918629e-01   -1.224356620447153e-02   +1.338273175833878e-01; -4.936005279430272e-02   +1.009164415045285e-02   +1.296607964274666e-01   +2.364695398734417e-02   -4.195745621936260e-02   -3.685033291370816e-03   +2.762345825102613e-01   +4.245097006412352e-02   +1.443348337319092e-02];
L5_L2_iGABA_netcon = [-7.412299037515318e-03   +3.068698019495210e-02   +1.087174489199223e-01   -9.347737575712098e-03   +9.037492084450182e-03   +1.973158808560998e-01; +1.574302552821554e-01   -8.710785063323018e-02   +1.005499805558649e-01   +1.402034078031228e-01   +1.179349184948920e-01   -7.542158953521157e-02; -5.215863604515668e-02   -4.537487774908194e-02   +1.338762066950080e-01   +9.304607882368331e-02   -2.112999205290771e-02   +2.643861550130706e-02; -9.399680739997904e-02   +2.544399823485169e-02   +3.760866443609084e-02   +2.352586463583012e-01   -9.093150707931798e-02   +6.015617828747408e-02; -4.202118258222168e-02   -8.226760797933794e-02   +6.829247636989393e-02   +6.258198271286819e-03   -8.194071361478290e-02   +1.006575021547561e-01; +1.387165651646699e-01   +6.282329561488130e-02   -4.270271270010068e-02   +2.080257039783751e-01   +7.073741044278910e-03   -2.906224402255542e-02; -1.680667792186623e-01   +9.610412357743980e-02   +4.791422859633456e-02   +1.367519527053003e-01   +1.398982423542577e-02   +1.558471187415469e-02; +6.554096568236877e-02   -7.878228181984594e-02   +1.695524923131677e-01   +1.892103713701705e-01   +1.572345607847007e-01   +1.444403696304992e-02; +1.833834533622826e-01   -1.652991628291857e-01   +1.673612570274245e-02   +1.910094581183445e-02   +1.187017568555384e-01   +1.243110524646208e-01];
L3_L2_iAMPA_netcon = [+1.763923390214698e-01   +7.982537997728763e-02   +1.251703931751520e-01   -4.727510484010584e-02   +1.149467479693111e-03   +3.018390490466874e-02; +5.996491356565307e-02   +1.829061375359037e-01   -3.151040869017165e-02   +6.775790143013127e-02   -3.380408889741178e-02   +2.239976443572570e-01; +6.496524806961049e-02   +5.888220852866818e-02   +1.328498121592266e-02   +7.100666424619256e-02   +1.684219334146982e-01   -2.491559883334645e-02; -7.399140033872122e-03   +9.960477382153946e-02   -2.055104387544823e-02   -1.428160427958677e-03   +1.402486560068306e-02   +6.640184881737562e-02; -1.880384924421689e-01   +4.238320826881407e-02   +2.502388550190444e-02   +1.199122688465201e-01   -1.212330088269788e-01   +1.853005730061248e-02; +3.682162546217635e-02   +1.608480536280389e-01   -1.072493096060175e-01   -7.006679783396322e-02   +9.689488218800760e-02   +5.621605538411610e-02; +5.824538069733704e-02   +2.540072548868569e-02   +6.463686859518353e-02   -8.100161334085117e-02   +1.269050978735602e-01   -1.090757415804094e-01; +1.222566874428698e-01   +1.684096798443105e-01   -1.870795885003316e-01   +6.640969834411743e-02   +1.552069622209295e-01   -7.793306115795817e-03; -3.375177194114941e-02   +7.622930775374215e-02   -4.680700113512027e-02   +8.574656427806332e-02   -8.858024580230467e-02   +6.429280210524384e-02];
L2_L3_iGABA_netcon = [+4.166117231223819e-02   -2.361220286201244e-02   +1.161618969519366e-01   +1.634234423840828e-02   -3.407754114166855e-02   +1.144811791142321e-01   +7.101087295833811e-02   +1.342380647105079e-02   -1.070650751514461e-01; -4.488626346545046e-02   -1.342972229071102e-01   +7.779125547874000e-02   -8.610586764085819e-02   -2.003837982248540e-02   +3.935538229437872e-02   -1.066612341688293e-02   +6.959586808414907e-02   -2.478679151421101e-02; -6.186276987337189e-03   -2.692216493362487e-02   +3.052655823267802e-02   +1.322263514707547e-01   -1.519317498078133e-01   +1.938429554384079e-01   -1.868947111361000e-01   +1.402710821951481e-01   -2.722855031924523e-02; +2.357044365042084e-01   +4.110762050059455e-02   -1.147284785746885e-01   -1.965973774466073e-02   +5.158148219950422e-02   -7.622581621214227e-03   +1.043649949267155e-01   +1.275449024595202e-01   +1.224266353231173e-02; -8.622505783992260e-02   -3.910731787124391e-02   -1.031458992200762e-01   -1.638120773706944e-01   -8.107442854123100e-03   -5.515162037473231e-02   -5.232213997759880e-02   +2.923945797772503e-02   -1.604234882489921e-01; +8.414833155715377e-02   +7.663449504004928e-03   -9.848634679054040e-02   -8.076606522044952e-02   -4.283867348160829e-02   +1.387176062763794e-01   +1.425808574320791e-01   +2.540044133334062e-01   +9.449955341654621e-02];
L1_L4_iGABA_netcon = [+3.584432164326028e-02   -1.345153726910519e-01   +5.467240679205729e-02   +1.504312462757274e-01   +2.872963478320279e-02   -8.618259802813827e-02   +7.898617776725059e-02   -7.178455854678004e-02   -1.261642851280053e-01; -4.118992074301107e-02   +6.353199156889296e-02   -4.486259855506162e-03   +5.410658428779964e-02   +4.644119599568498e-02   +1.616270370262210e-01   +3.464914137452441e-02   -7.502283469748749e-03   -1.776020004798370e-01; -7.787766292424034e-03   +1.491446101075586e-01   -1.213180714886514e-01   -1.140847984302915e-01   +3.776553195778475e-02   +8.198516231857952e-03   +3.473531456178987e-02   +4.324410553666221e-02   -9.054629165551002e-02; +3.512906014731279e-03   +6.084040188950994e-02   -1.144843615649082e-01   +6.469759106861858e-02   +1.666319907961733e-02   -4.186463528599703e-02   -7.350466586644214e-02   +2.321841637991420e-02   +8.052430178493808e-02; +1.872777774435159e-02   +3.724206727185421e-02   -4.496219950772369e-02   -9.997527298301723e-02   -2.173400758451216e-02   -1.248013776104135e-01   +7.096975048136517e-02   +3.856472613550915e-02   +4.823679511124902e-02; +6.363631019066657e-02   +1.258979594195399e-01   +7.605400971012376e-02   -3.859521266903530e-02   +6.653857734939844e-02   +1.791515673782351e-02   -1.254765677238193e-01   +9.440268014612063e-02   +1.130658675257322e-02; -5.623759046629745e-02   -1.559628782957047e-02   -5.833742518164248e-02   +1.242848951546137e-01   +3.192975334581254e-02   +3.910631760008965e-02   +6.877939373288228e-02   +5.280855879271446e-02   +6.749179509622341e-02; +3.205448684221650e-03   -8.137090824402131e-02   +8.557609537176425e-02   +8.688312962246088e-02   +4.280039874029568e-02   +7.977779971009444e-02   -2.244360836020684e-02   +2.297460810043365e-02   +1.312991495218949e-01; -1.690490696491254e-01   -5.481848721891999e-03   -1.180991458206387e-02   -7.572830020699248e-02   -1.131490086126144e-01   +8.926684752757258e-02   +3.269227114865042e-02   -5.666574702233484e-02   +1.148660761776072e-01; -1.292282564931042e-01   +2.109204462508004e-01   +7.166929879135306e-02   +1.130079991738267e-01   +3.628851005056787e-02   +6.607767058535606e-02   -6.423843163176292e-02   +1.839943821961828e-03   -5.334426732298995e-03; -6.044757312199486e-02   +2.336824526361899e-02   +3.162925653721075e-02   +1.425284668348164e-01   -2.522818502306180e-02   -6.825261684464115e-02   -1.450500865096299e-01   +4.157250555242085e-02   +8.809720903729683e-02; +1.661950253178707e-01   -1.143976268832335e-01   -1.459344792635143e-02   +7.066055820217923e-02   +8.954938069454949e-02   -3.759721905418605e-02   +3.139003107875645e-02   -1.077231165858205e-02   -2.559560544991576e-02];
L4_L1_iAMPA_netcon = [+7.776181771457749e-02   +1.315748707670569e-01   +3.798149575359396e-03   +2.131011488101210e-02   +9.699971034758451e-02   -3.361359794542440e-02   +5.515472401912822e-02   +4.863663270924733e-02   +1.162622678306747e-01   +6.926014267828048e-02   -1.719194711331895e-01   +1.598977936802354e-02; +7.494962366942987e-03   +3.709653511301265e-02   -1.814154116944228e-01   +5.931530285967460e-02   +1.908631971538725e-01   +9.863566438232607e-03   -1.122895078744714e-01   -3.360912100824447e-02   -8.809594998649610e-02   +1.586755295227434e-01   +2.550679408014599e-02   -3.891548480847880e-02; -1.346839691021699e-01   +3.718168135013813e-02   +2.117582757922767e-02   -1.357804359306276e-01   +6.308165189119933e-03   +4.236215517684797e-02   +1.764011563012655e-01   +2.381367320986751e-02   +1.709252746012660e-02   +5.925079266361857e-02   -9.892754666965541e-02   +9.421176123511721e-02; +2.177842255848802e-02   +5.722747679554475e-02   +4.649348782109870e-02   -1.043955867784285e-02   +5.534452706214075e-02   -1.297492973190105e-01   -8.748502020008847e-02   +1.816428809750343e-01   +4.361058426468412e-02   -6.857973596241908e-02   +7.778758933399847e-02   +1.003969257218773e-01; +1.126762427945519e-01   +5.937151921942148e-02   -3.749578808507505e-02   +5.283479491699981e-02   +1.821538477817648e-01   +1.249970672794350e-01   -3.438423605814811e-03   +2.120273277572764e-02   +5.098274128695718e-02   -4.631684983835348e-02   +5.069360106699197e-02   -7.847013341361223e-02; -3.154236290801063e-02   +3.130860160148627e-02   +8.237241704552882e-02   -6.760811624027011e-02   +9.835715550396978e-02   -9.644938068933680e-02   +2.244133689917013e-02   -7.059473885051622e-02   +6.710227427193079e-02   +9.994737606172742e-02   +4.093863136776300e-02   +3.318867702322403e-02; -8.625966582957324e-02   +5.933234604868800e-03   +1.308445863251801e-01   +6.306757085548298e-02   +2.227946467307979e-02   +4.982594651508714e-02   +1.405631004879243e-01   +2.793183751281265e-02   +1.232453493468288e-01   +1.163505311975598e-01   -9.068404346062127e-02   -3.658432560879474e-02; +6.625805349532338e-02   +5.666007122385165e-02   -1.629359570457668e-01   -4.465215385459950e-02   -2.823728443265065e-02   -4.141099546056423e-02   +5.477208202002547e-02   +6.690356891785580e-02   -1.427995321350288e-01   +1.413634116506267e-01   +1.190188808189371e-01   -5.133736179167897e-02; +8.613713728629520e-02   -2.368187670304210e-02   -9.400344412228354e-04   +1.115967715594730e-01   -2.404937626940534e-02   -8.180313945361702e-02   +1.231312010093228e-01   +5.091613641053257e-02   -1.029710225233369e-01   -2.898642358474319e-03   +2.654617881114485e-01   -5.025166060358574e-02];
L1_L3_iAMPA_netcon = [+8.370691516755116e-02   -2.166050473443830e-02   +3.191657120760096e-02   +4.405276829833684e-03   -1.247141612792611e-02   -1.349152043010110e-02   -8.559094298242212e-02   +5.985677359910103e-02   -3.558093727127026e-02; -1.417477472718627e-03   +3.337669582592308e-02   -1.056722537905178e-02   +1.861191390927344e-02   -1.394966012049443e-01   -9.315592377124514e-02   +1.615317229763091e-02   +2.544921678734402e-02   -4.732884436096015e-02; +1.196543298067607e-01   +8.181106921427406e-02   +3.049795672953805e-02   -7.029403654287923e-02   +3.065344773776096e-02   +6.883313838297241e-02   +7.960570030644618e-02   +1.170124482937788e-01   +1.096386409618326e-01; +8.537522163921350e-02   +7.162694144848561e-02   -2.704456957036488e-02   -2.294213217513270e-02   -5.915269000155667e-02   +4.519223562572559e-02   -1.020108486333055e-01   +1.020682674567813e-01   +1.168411643795429e-01; -5.820999443599005e-03   +1.708707902966976e-01   -4.340989089760694e-02   +7.868563036748520e-02   -7.333024833125755e-02   +1.090320542935998e-01   -1.048247205167226e-01   -1.521843412645210e-01   +6.673367485926021e-02; +1.388404486386353e-01   +5.406764000439242e-02   +1.215500661998282e-01   +9.560789901860754e-02   +1.637668666879855e-02   +4.026216381034214e-02   +2.225309681352908e-01   +8.937958830479487e-02   +1.107403630639442e-01];
L3_L1_iGABA_netcon = [-8.136723064047259e-02   +5.924247961252656e-02   +5.650153448408494e-02   +9.024569810711960e-02   -4.327325706885125e-03   +1.699844296817769e-01; +6.925606000474317e-02   +7.690020456589725e-02   +2.624749219455275e-02   +1.101259961433615e-01   +1.721518257360570e-03   -4.871685982232848e-02; +1.225558342641256e-01   +5.164813779058954e-02   -5.344425160975445e-02   +2.042741048890980e-01   -5.044240306876301e-02   -4.536686407103041e-02; -2.934578641596196e-03   +6.914234877683512e-02   -1.117618351607868e-01   -4.120521712279535e-02   +3.571709017640112e-02   +2.448423775293048e-02; +1.879114144141790e-01   +5.750141806797410e-02   -5.511924619948655e-03   +6.072203973306331e-02   -1.252792078029452e-01   +1.136174870488590e-01; +1.938335105010684e-02   +7.249514670163648e-02   +6.076873677498065e-02   -8.877268294277169e-02   -1.658165069992083e-01   +9.634157418622263e-02; +4.368179254964264e-02   +9.467248403260822e-02   +2.479932089721998e-02   +2.961159662893286e-02   +1.238286352519994e-01   -1.418580130592525e-01; +7.812701065506580e-02   +1.186476559855360e-01   +1.902510775717582e-01   -8.496700386811135e-02   -4.763469313593299e-02   +5.345733738845363e-02; -7.305056191385731e-02   -1.000371588707736e-01   +8.734982452503785e-02   -1.470500062960507e-01   -2.165965986991154e-02   +3.286982947197723e-02];
L5_Input1_iAMPA_netcon = [+7.342207312954840e-02   -1.076989004116403e-01   +1.638564470890504e-02   +1.351513880421719e-02   -8.640208922151969e-02   -3.089954617295512e-03];
L6_Input2_iAMPA_netcon = [+2.025587221449209e-02   -2.229658724235723e-02   -3.959199319066151e-04   +5.716424109119009e-02   +5.232335436359509e-02   +1.066662744265637e-01];
L5_L6_iAMPA_netcon = [+2.895448764365833e-02   +5.269090912512051e-02   +1.873074241565154e-01   -3.408677549164042e-02   +1.246718611054435e-01   +1.820789533905466e-02; +6.235699104767779e-02   +1.028339088019010e-01   +1.689843766518544e-01   +8.257009042315640e-02   +1.744914068973860e-02   +1.480406260642725e-02; +1.816210110593309e-02   +2.163374444445167e-02   -5.003855122909200e-02   -8.891019707980599e-02   +9.858813687752477e-02   -2.597479086145374e-02; +9.827133596411966e-02   -1.036077864356874e-02   -1.785517745673601e-02   -1.469930239834630e-01   +3.790271392332255e-02   +2.887848547140259e-03; +1.856176299592892e-01   -4.084522578373391e-02   -5.683535285198601e-02   -1.150304309146348e-01   +4.109594083701958e-02   +5.211891247930759e-03; +4.992190053629628e-02   +1.283351853170147e-02   -1.853509793626022e-04   +1.863527019385704e-01   -1.132085548551167e-01   +1.965319350330920e-01];
L4_L5_iGABA_netcon = [+1.568705330920294e-01   -3.183968281049308e-02   +6.012633177883110e-02   -1.290451932253617e-02   +1.735055100087093e-02   -6.633898497828129e-02   -3.687753772680788e-02   +1.799558280799856e-01   +1.463346111581984e-01   -2.779872083317254e-03   -6.177401502447103e-03   -4.031637783519589e-02; +2.842280421473831e-03   -1.486056500738676e-01   +1.714867994685074e-01   +1.368855837909695e-01   +1.286464120106788e-01   -1.707120864421621e-02   -2.945606857888633e-02   -1.164700278571173e-01   +2.182471378345917e-01   -9.792367707266587e-02   -9.923409490723811e-02   -9.992852406450439e-03; +3.842244309424250e-02   -4.227392988695818e-02   -8.999311023267317e-02   +1.147144471600811e-01   +1.067180732559580e-01   +6.129913283193679e-02   +1.539881338452894e-01   +5.612182289946057e-03   -1.417184573387173e-01   -7.548495495312001e-02   -6.096009352969911e-02   +1.919892869060991e-02; +2.144764511684794e-01   +2.407569096662707e-02   +1.953536215955891e-01   +2.381407516487239e-01   -1.160298374976658e-03   +8.695175737381089e-02   -5.049303076092618e-02   +2.637672626513150e-02   +1.121054022269464e-01   -8.802555532860024e-02   +1.941933642793002e-02   +7.361870464013640e-02; -6.185538764702712e-02   +4.311325811319711e-02   -1.103826100146808e-01   -3.744341753259544e-02   +7.368921074061444e-02   -6.534220400454256e-02   -5.179092987658597e-02   +4.242505804567610e-02   -4.500842663717548e-02   +6.862679482305137e-02   +2.483057905509695e-03   +9.371635151818167e-02; -6.202879421796306e-02   +1.192823266530634e-01   +1.201075274127321e-01   -2.177657752072569e-02   -1.053769446824421e-01   -2.981090745498099e-02   -1.175767688193006e-01   -1.230561896513970e-03   +3.790772361069263e-03   -1.560707318524875e-03   +9.065973784546258e-02   +5.732082100518349e-02];
L6_L4_iAMPA_netcon = [+1.666774724463587e-01   +1.335483669291347e-01   -4.248162019288003e-02   -1.686273467308870e-01   -6.500597256572792e-02   +4.801357836314270e-02; -7.073488452562396e-02   -2.387956554206236e-02   +8.767318627209669e-02   +2.951285322680757e-01   -7.683641196372787e-02   -2.331035455970529e-02; +5.866369931067070e-02   +1.677656571874571e-02   +8.895260980880806e-02   +1.235959876502301e-01   -6.761385835280001e-02   -5.397689427995447e-02; +4.218748581386813e-02   +4.754317060232741e-02   +1.371455689289394e-01   +1.055315083861858e-01   -7.150943090967672e-02   -1.495359295738025e-01; -5.282024629088741e-02   +8.520539568210381e-02   -5.512474614877986e-03   +3.334087999284811e-02   +1.769393602069426e-01   -1.115324338633852e-01; +8.370676149014281e-03   -1.459469719246937e-01   -8.963076857475499e-02   -1.374132804908622e-01   +4.256159397322837e-02   +1.001544260940908e-03; -2.215971094016354e-02   -1.309721286547262e-01   -7.078017216271869e-02   -1.591297397960562e-01   +1.244597270202270e-01   +8.668431797603256e-02; +8.806074942318443e-02   +1.121518760383347e-01   +1.005549568381940e-01   +6.221716553322275e-02   -6.019305717363005e-02   -3.535413890358505e-02; +3.603915621613103e-02   +2.516330223827475e-03   +8.289879935891892e-02   +1.072209443852319e-01   +1.016992256914444e-01   -7.703708214843107e-02; +4.522674473649115e-02   -4.380606475321885e-02   -1.178434726325795e-01   +4.211141524774934e-03   +1.663138168745178e-02   +5.689482796095398e-02; -1.182222238305134e-01   -1.752964677334094e-04   +1.204463032124409e-01   -2.213654395084726e-02   +2.200817221465726e-01   +2.363653322483443e-01; +1.768480426573862e-01   +4.259935938607839e-02   -2.301951619664969e-02   -6.184296218695863e-02   +7.962515755572812e-02   -2.114328629539437e-02];
L5_L4_iAMPA_netcon = [-3.981465038091683e-02   -1.392817720346527e-01   +1.539415615533054e-02   -3.668359672541308e-02   -1.394012370307744e-01   -2.626952631607649e-02; -1.657258405398074e-01   +2.643782797625868e-02   +4.648149274438171e-02   -1.164587770934865e-01   -1.310822010339662e-01   +2.528843562883904e-02; +8.735026366904937e-02   +6.501870930297005e-02   +9.541927688497286e-02   +1.992949188313872e-02   -3.798392337020323e-02   -1.036150808494539e-01; +3.329381428229090e-02   -5.440055626652777e-02   -2.978389905056048e-02   +1.320242658397469e-03   -7.984236858352009e-02   +1.247400404323812e-01; -6.283073931803887e-02   +3.521794034736417e-03   +7.614287981248420e-02   -8.618887857931490e-02   +6.698481316162258e-02   +7.971995635239618e-02; -1.336638915067415e-01   +1.085209574906584e-01   +1.021177213144821e-01   +8.257724648638219e-02   +5.256301991421972e-02   +4.636099283846047e-02; -4.120525085083306e-02   +1.379648160171074e-01   +2.160668594484768e-03   +4.808465781639450e-02   +3.563939438460406e-02   -1.767677070902825e-01; +2.371913516650831e-03   -2.446797210007464e-02   +1.815800289153003e-01   -2.646752271035747e-02   -3.439492133364090e-02   -1.225551167960340e-02; +2.295248322181801e-02   +3.121764868055298e-02   +2.934975895599832e-03   +3.795918870748076e-02   +2.906955793184186e-02   +5.248758173776995e-03; -1.357034819313470e-01   +4.398713192295801e-02   +6.293782792193214e-02   +6.063782332807090e-02   -1.229634397337907e-01   +1.469758410202245e-01; +1.183333276134478e-02   +4.451983308832351e-02   +1.137783575530095e-01   +4.316315134798538e-03   -4.049082349220818e-03   +1.657455791427064e-01; +2.558701949177158e-01   +1.099207930636712e-01   +2.308407918364492e-01   +6.428201113048933e-02   +1.202207476784095e-01   +2.600792821253383e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
