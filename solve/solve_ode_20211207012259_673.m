function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.365298115262132e-01   -3.656622654629119e-01   -4.794350087644320e-01   -5.239050868944285e-01   -4.743354215589410e-01   -4.026366210826023e-01   -5.987954889511832e-01   -7.101968968134154e-01   -5.414505033078856e-01; -5.731848458918206e-01   -3.536797751964668e-01   -5.134489605031833e-01   -4.303886799931242e-01   -5.191246121398664e-01   -4.562735905217618e-01   -7.045668601433651e-01   -5.973072934075478e-01   -4.173234582776962e-01; -5.129330414995040e-01   -3.137303025820158e-01   -5.997895418628805e-01   -6.603147395423850e-01   -6.429846889838748e-01   -5.163405574779701e-01   -6.085556674029893e-01   -4.147434166607188e-01   -5.770636956550330e-01; -5.348411039633907e-01   -3.658947101431729e-01   -6.157594722423880e-01   -4.245295988823704e-01   -3.250557702017332e-01   -4.580044846389817e-01   -5.896831828068272e-01   -2.555467618332999e-01   -5.009010605915438e-01; -5.864791740130680e-01   -4.433517140442746e-01   -2.353075460548027e-01   -3.788715717216666e-01   -3.343241807158507e-01   -5.273335513927914e-01   -4.523272650498019e-01   -5.821146868920868e-01   -4.827294268289715e-01; -4.348643443298808e-01   -2.723130646532239e-01   -3.954446347522963e-01   -5.222140127917768e-01   -4.101087410389221e-01   -4.761585205311629e-01   -7.045114149619935e-01   -6.958491558968429e-01   -3.338185837046367e-01; -4.076803076177823e-01   -4.593271643078050e-01   -5.784037648827063e-01   -6.002056491804388e-01   -6.411352026732787e-01   -5.309566911478185e-01   -4.542477589834460e-01   -6.556251063288228e-01   -6.473438154449174e-01; -4.951225573077715e-01   -6.209021093275988e-01   -5.597804068236485e-01   -4.355391714226729e-01   -4.342279559724594e-01   -3.452373705989684e-01   -6.086189218339478e-01   -7.649540535893520e-01   -5.985255912302029e-01; -6.158090338379856e-01   -5.168946249539327e-01   -5.289711589551115e-01   -3.333557496052338e-01   -4.354926130309570e-01   -2.836883654015887e-01   -4.322661529486688e-01   -4.111774256324980e-01   -4.146816185238403e-01];
L1_L2_iAMPA_netcon = [-4.556945400367800e-01   -4.501568995066088e-01   -4.005004607100853e-01   -5.847891493074595e-01   -6.783850035933312e-01   -4.839665829261781e-01   -3.485201429076666e-01   -5.939884010249807e-01   -4.116569374879607e-01; -3.932184033069477e-01   -5.503865001601875e-01   -4.651995160065135e-01   -4.194425516754609e-01   -5.063589222968614e-01   -6.747816855323406e-01   -4.215356457962179e-01   -5.928975083871423e-01   -2.395170995431460e-01; -5.415986011367575e-01   -3.081902588362297e-01   -6.609882523123917e-01   -4.733568217249389e-01   -2.218405479233832e-01   -6.631322443910546e-01   -5.098163696960583e-01   -4.941433956582911e-01   -6.101962943866833e-01; -3.678490151443149e-01   -5.042200592868304e-01   -7.091824720339124e-01   -5.356738917029706e-01   -3.851387288961112e-01   -6.287511934581073e-01   -7.054006058796772e-01   -5.190194312421356e-01   -4.932218325880852e-01; -5.822640531229873e-01   -3.743473330424754e-01   -3.570618318682636e-01   -3.311256905222943e-01   -4.198823797044383e-01   -7.231686001154903e-01   -4.077062947752986e-01   -5.467253458556741e-01   -5.060987039745698e-01; -7.419207945384092e-01   -4.928014745266922e-01   -6.617651996562881e-01   -1.221873153588766e-01   -5.321377114923880e-01   -4.508247965046842e-01   -4.771787697352320e-01   -2.743610481527773e-01   -6.219012302779605e-01; -4.849740156486806e-01   -4.731443952262108e-01   -3.572685619755792e-01   -5.288773118460035e-01   -4.796193006012726e-01   -6.652713822272476e-01   -4.576364992948405e-01   -5.040500741386912e-01   -4.211296717996456e-01; -1.760779414053648e-01   -5.106154404706300e-01   -4.798538430419708e-01   -4.404254151935352e-01   -3.247809357349057e-01   -4.338180320415772e-01   -3.739842598931606e-01   -2.317193744187838e-01   -5.997278727510583e-01; -7.484829308403912e-01   -5.896340616125557e-01   -5.741047349314844e-01   -6.559179794195500e-01   -1.573855468384787e-01   -6.933430057289404e-01   -4.526236609556852e-01   -6.241946577086117e-01   -4.204547035627289e-01];
L2_L5_iAMPA_netcon = [-5.433751894121569e-01   -3.371752709117507e-01   -6.764424205798132e-01   -3.775604694178420e-01   -5.543643260042628e-01   -5.715884746043171e-01   -6.425593618020289e-01   -2.833147849110803e-01   -6.186264198788370e-01; -4.322863386516644e-01   -5.077737972637910e-01   -5.799417234950468e-01   -4.624315349435781e-01   -5.934707641270810e-01   -6.904308767350003e-01   -4.275807270068238e-01   -4.408737597647798e-01   -6.322561045620355e-01; -4.365549541643685e-01   -3.782722965457257e-01   -4.436063063872054e-01   -2.998425936799712e-01   -3.855027561346031e-01   -2.381706143315491e-01   -4.692624994752153e-01   -6.566056652463094e-01   -4.821060369859011e-01; -5.182507804118051e-01   -3.853684857447091e-01   -3.593192000851974e-01   -4.840569554251421e-01   -7.339254047024952e-01   -4.266868355694147e-01   -5.308780432190755e-01   -5.605588027142556e-01   -5.399108800300348e-01; -5.736688065407494e-01   -6.092928467403869e-01   -5.894689195450952e-01   -5.532260070803601e-01   -6.668164174163489e-01   -7.642590665212421e-01   -7.100485277191709e-01   -5.035624212430022e-01   -4.181842081347842e-01; -3.787693482260691e-01   -5.521627608305998e-01   -5.920932808105895e-01   -3.991219832921167e-01   -4.471441145717681e-01   -5.523117514467565e-01   -5.519248432754338e-01   -5.429836616844680e-01   -4.067127268464139e-01];
L5_L2_iGABA_netcon = [-5.648575024001605e-01   -4.116882839203967e-01   -6.906950659671183e-01   -5.260845758353913e-01   -6.100639549372069e-01   -5.225015963703207e-01; -4.860579268211779e-01   -4.310819234696827e-01   -4.956900806627925e-01   -6.701548859351896e-01   -4.785490914634130e-01   -5.255545356887338e-01; -4.710021355645658e-01   -3.937179274438427e-01   -5.466384272491104e-01   -4.857299145513690e-01   -6.961885793782598e-01   -4.345133607778956e-01; -2.404416218619943e-01   -4.402727977410922e-01   -1.932799182637530e-01   -5.064234002547003e-01   -3.968693960692576e-01   -4.030924501986125e-01; -5.728954870374894e-01   -4.632665597589044e-01   -4.420127670567414e-01   -5.789740539344664e-01   -6.509981908697305e-01   -2.629452059665588e-01; -5.057389999526306e-01   -3.881689500390570e-01   -3.237092854205679e-01   -5.587474171885085e-01   -4.701438385007610e-01   -6.516999826942261e-01; -3.680062293256536e-01   -4.219240532995117e-01   -6.282492906392160e-01   -4.822551638707642e-01   -2.631897578028099e-01   -3.108445938492557e-01; -5.153445848994708e-01   -2.757394131582853e-01   -3.113586179652687e-01   -5.549152969333906e-01   -4.158054095548601e-01   -3.937300104388948e-01; -4.647803313959544e-01   -6.236042426181478e-01   -5.907640632517195e-01   -3.611834765148909e-01   -3.343975979895179e-01   -5.354175471441064e-01];
L3_L2_iAMPA_netcon = [-5.390023463086027e-01   -6.124328055845640e-01   -4.063011400458659e-01   -7.013674431273538e-01   -4.631904810687804e-01   -2.061535509647331e-01; -4.135738001383154e-01   -5.858158410644450e-01   -5.385986530647610e-01   -4.900664249327831e-01   -5.265403070049115e-01   -6.217417302208686e-01; -5.646039224471596e-01   -6.097068005843711e-01   -4.608716877369849e-01   -6.896805965708543e-01   -5.192621596837340e-01   -4.375084969302639e-01; -4.650767617577710e-01   -5.417029423449635e-01   -6.074544947087451e-01   -5.345592330428539e-01   -5.732644441009535e-01   -4.547852284696273e-01; -5.121130774969314e-01   -5.518188324099071e-01   -3.537238642382787e-01   -4.045288578095048e-01   -4.011691198614743e-01   -4.510005604208464e-01; -5.986602294064706e-01   -4.657981012185503e-01   -4.654256477826392e-01   -4.859440129906031e-01   -5.011358356193594e-01   -6.241620970847568e-01; -5.406777472791913e-01   -4.426658889514048e-01   -6.712987961397782e-01   -3.857012769383067e-01   -5.076551566423277e-01   -4.796217196587444e-01; -4.149673116471992e-01   -4.293831257286904e-01   -6.026466882735924e-01   -5.336063904564672e-01   -5.474156850737413e-01   -2.954285019076453e-01; -7.523756697832670e-01   -5.520266022319622e-01   -4.662073607462770e-01   -3.138913803047256e-01   -3.845358296534047e-01   -5.731695653945342e-01];
L2_L3_iAMPA_netcon = [-4.303004278949203e-01   -5.090403357984087e-01   -5.743157566293735e-01   -4.584830024352457e-01   -5.545582421336168e-01   -6.380528229148494e-01   -3.847415986618629e-01   -2.209441848808783e-01   -4.220860840500051e-01; -4.831032714600402e-01   -5.043052654476136e-01   -4.225793067473999e-01   -4.172920124390866e-01   -5.137921534190251e-01   -5.511116291327449e-01   -4.801746812837229e-01   -4.978418358746572e-01   -4.565278276718585e-01; -3.625131865209685e-01   -6.369705108399504e-01   -4.814320373500549e-01   -4.506723327599753e-01   -4.529641937912613e-01   -5.496589696547552e-01   -4.317308703304102e-01   -4.462184648315421e-01   -6.236453797269713e-01; -4.635746600968734e-01   -5.062621018297736e-01   -6.316862917276449e-01   -3.610080469550971e-01   -3.969761498959701e-01   -4.981780170307126e-01   -6.151671899860982e-01   -2.082710720081637e-01   -2.969245252604396e-01; -4.637649340940561e-01   -7.251708580303773e-01   -5.116400943669203e-01   -4.338120836864820e-01   -6.516556974464697e-01   -4.934895248596561e-01   -5.489114979402222e-01   -4.191133828963280e-01   -5.247191160809729e-01; -1.828416355206138e-01   -2.904535382889172e-01   -3.484006915280440e-01   -4.540147658557238e-01   -3.257163981285443e-01   -4.817053405895340e-01   -6.985432389833244e-01   -4.977703287726100e-01   -6.124219036226105e-01];
L1_L4_iGABA_netcon = [-7.042903805832953e-01   -3.841684035878446e-01   -6.535628730649707e-01   -5.218238682946778e-01   -4.426963318906456e-01   -4.483391956760080e-01   -4.509221603961516e-01   -6.328519749728138e-01   -2.386690956637860e-01; -2.958381888791190e-01   -3.718538447295571e-01   -4.950255356082588e-01   -4.684675891341670e-01   -4.929899404266517e-01   -5.141389472852429e-01   -4.724736760238487e-01   -7.433078801594831e-01   -7.184294586093407e-01; -5.836622459927315e-01   -5.773656303516647e-01   -3.947162122096105e-01   -5.549705850987497e-01   -4.776913491331996e-01   -3.036455040774478e-01   -7.335068850023977e-01   -4.585879741122504e-01   -3.378752775768883e-01; -5.075150140782307e-01   -6.076428810700774e-01   -4.549400033721946e-01   -4.325795273849412e-01   -7.523041567278742e-01   -3.385184100360484e-01   -3.926856312650370e-01   -4.972569063841574e-01   -3.505184649433514e-01; -5.137305144025672e-01   -5.371555809591818e-01   -6.065811002925329e-01   -4.680828338138737e-01   -5.283390659965340e-01   -6.018674489199948e-01   -5.998142661552091e-01   -6.787189569876450e-01   -6.272009541823906e-01; -4.990083532233563e-01   -4.355036370079179e-01   -6.210399657203929e-01   -5.038207326158866e-01   -4.325364791544669e-01   -4.602232647211018e-01   -4.408146827113590e-01   -3.996801500823397e-01   -2.889130494448338e-01; -5.819371393099381e-01   -5.561353585321971e-01   -4.667969069121338e-01   -3.718241669120780e-01   -3.613529482085528e-01   -5.490500285441572e-01   -2.890964991410029e-01   -6.071379016247276e-01   -5.183442423531668e-01; -7.325159622504983e-01   -5.444918701987705e-01   -3.111607476824732e-01   -4.438928948343673e-01   -5.234774386659444e-01   -4.198672901011631e-01   -5.032826287518219e-01   -6.052486152070395e-01   -5.735013698454179e-01; -6.393563116710955e-01   -6.034036030801004e-01   -3.086340896491371e-01   -3.604600938540943e-01   -3.839427774760767e-01   -3.381427237916409e-01   -6.567536336770062e-01   -5.177609813450031e-01   -4.092982658317219e-01; -6.478320141881615e-01   -3.384406078104669e-01   -5.493370982834137e-01   -5.741417333057061e-01   -5.634366834365714e-01   -5.575630887476853e-01   -4.402899810358349e-01   -4.423358571468850e-01   -1.158735159724281e-01; -4.946290643211602e-01   -3.837187796783116e-01   -2.719133820769563e-01   -4.674490685909057e-01   -5.047128995330661e-01   -5.490083715652772e-01   -4.101929928507861e-01   -5.347557425849514e-01   -5.592740538738368e-01; -6.838993706213251e-01   -3.596128842070667e-01   -4.847749194841999e-01   -6.029356381460553e-01   -5.288254241408407e-01   -4.199963004891211e-01   -4.853824955167085e-01   -5.843387583233253e-01   -5.051151762783297e-01];
L4_L1_iGABA_netcon = [-3.819496479035055e-01   -3.794013588462018e-01   -7.495977550705919e-01   -4.542102217133920e-01   -5.389150687674239e-01   -6.741402992036682e-01   -5.506411779831016e-01   -6.077054558949553e-01   -3.281299533457338e-01   -4.646158755930823e-01   -5.697651224690414e-01   -5.049321927288528e-01; -2.346293405416132e-01   -5.629884469507010e-01   -4.046463118425259e-01   -4.969821930372182e-01   -5.850373807826761e-01   -6.232792196307729e-01   -4.989236686542121e-01   -5.980579330895113e-01   -2.687191301379539e-01   -3.730750832737860e-01   -5.429856847858208e-01   -4.434794688768323e-01; -4.455894912977983e-01   -6.474760586829932e-01   -6.206407491439332e-01   -4.893031650553403e-01   -6.457938116454732e-01   -5.383467870060077e-01   -5.413175431638505e-01   -4.273666301232436e-01   -3.918444550277700e-01   -3.623846697019467e-01   -6.374499904554574e-01   -5.499324318326029e-01; -5.763455791628023e-01   -6.388117990910211e-01   -4.840788107371945e-01   -5.252317676751677e-01   -6.165505490263206e-01   -4.975824968567635e-01   -4.972550937740568e-01   -5.120366436704574e-01   -4.777788139942055e-01   -5.945866888005861e-01   -1.426585361220362e-01   -4.900368875821975e-01; -6.411213430239342e-01   -5.722374739321824e-01   -5.337971241245479e-01   -3.833277264452988e-01   -4.935436799905906e-01   -6.512131217883631e-01   -2.864438025866732e-01   -4.466988074639769e-01   -4.967968404265595e-01   -4.798242116151640e-01   -3.312725328836861e-01   -5.782233139418325e-01; -5.367789522086751e-01   -3.019171809515661e-01   -3.967057304713675e-01   -5.026636628586698e-01   -4.606780548832734e-01   -3.574812150056252e-01   -5.189398434086607e-01   -4.023844275623569e-01   -6.311336539382789e-01   -3.999132482492109e-01   -4.285152601915463e-01   -7.610828264218193e-01; -3.769214602336572e-01   -6.986913963701863e-01   -4.785677387611345e-01   -4.894587069648252e-01   -6.131141873439292e-01   -5.125914091338243e-01   -6.077541411177371e-01   -6.913151986034130e-01   -3.544262302461673e-01   -4.061162703749395e-01   -4.978490265384399e-01   -7.035377963897804e-01; -6.238112128769034e-01   -4.775992763615222e-01   -4.881576906462593e-01   -3.799143185784991e-01   -7.034977422089682e-01   -6.758552105993737e-01   -2.722501185522431e-01   -4.280951886850173e-01   -4.403717983704292e-01   -6.147628299387013e-01   -5.603191901821457e-01   -3.984815145673103e-01; -7.511270077522093e-01   -6.071086228424627e-01   -4.056445485486807e-01   -7.007459988195963e-01   -6.373137589155627e-01   -2.746628125903706e-01   -4.670295159687573e-01   -3.507649517530865e-01   -4.489984650389811e-01   -6.059475838667709e-01   -4.209952834709781e-01   -5.041493104708065e-01];
L1_L3_iAMPA_netcon = [-5.702741179416930e-01   -3.892539349019074e-01   -5.013755559092242e-01   -6.139540205171822e-01   -7.676887144531764e-01   -5.667012548268867e-01   -4.331444451931898e-01   -4.504913917408072e-01   -4.348359192271398e-01; -6.058442230992215e-01   -3.672538056484806e-01   -5.171685540619743e-01   -5.021023960272341e-01   -5.391850781816560e-01   -5.863192116306967e-01   -3.687498077386737e-01   -7.782209945114408e-01   -4.932481150368774e-01; -5.074615083446840e-01   -3.590767702311250e-01   -5.259377655595452e-01   -2.288372551976151e-01   -4.028042733430227e-01   -7.824335732534357e-01   -2.674781626754809e-01   -7.099373040382005e-01   -7.286500749717899e-01; -3.476328289185177e-01   -4.250062700589609e-01   -4.963579469888459e-01   -5.390549836354184e-01   -3.535193464577694e-01   -1.977753371125422e-01   -4.568922639841756e-01   -7.653346433585442e-01   -3.772638226500963e-01; -5.837605136057741e-01   -6.857990771557897e-01   -5.388422972241603e-01   -5.123465230219665e-01   -6.181890219109946e-01   -2.798273434926625e-01   -5.155707146738430e-01   -2.970288619668194e-01   -4.966751978832193e-01; -5.353992095186084e-01   -3.562090105046795e-01   -6.310747078863292e-01   -5.369883414255068e-01   -6.131933600585296e-01   -4.956961344171573e-01   -4.228197551317222e-01   -6.150168628943920e-02   -6.337854098320352e-01];
L3_L1_iGABA_netcon = [-6.204376310315726e-01   -4.007174824969687e-01   -4.563918055628928e-01   -7.086946788616323e-01   -3.590193987926028e-01   -7.067683008363169e-01; -6.898770452299783e-01   -4.533744387147753e-01   -3.457179873322592e-01   -4.680445256261789e-01   -5.535696997746872e-01   -7.927471618921140e-01; -4.661772187958298e-01   -6.402839695454904e-01   -3.501888698876085e-01   -4.280723998509686e-01   -4.527361991506527e-01   -5.375764237792001e-01; -4.422493885404206e-01   -3.604909441053321e-01   -5.680058442236040e-01   -6.145203455204893e-01   -3.567646410137516e-01   -6.528817300118237e-01; -5.346600668129823e-01   -5.908833814503003e-01   -6.819960890346747e-01   -5.110853424600657e-01   -4.480733467869547e-01   -4.121977032814904e-01; -3.989893601625559e-01   -4.399965881482265e-01   -6.418038243774723e-01   -3.214519933192581e-01   -3.225221630053156e-01   -3.939276723189349e-01; -4.148627899241342e-01   -4.598896541481988e-01   -4.362258831571200e-01   -6.693154469643922e-01   -2.460588051951393e-01   -1.882115113459141e-01; -2.610323909741808e-01   -4.727296413771423e-01   -6.143365246382615e-01   -5.690551757557489e-01   -6.399774836649594e-01   -4.677512583192647e-01; -5.687770841712441e-01   -5.963838762435576e-01   -5.949079276985904e-01   -4.143133997067684e-01   -5.620844674758637e-01   -5.078134118979081e-01];
L5_Input1_iAMPA_netcon = [-4.096653031781456e-01   -5.339884569093654e-01   -5.125444467425742e-01   -4.487570017906793e-01   -5.220803019915538e-01   -7.052624624277634e-01];
L6_Input2_iAMPA_netcon = [-6.659974103739656e-01   -6.863278832347728e-01   -5.022140288165278e-01];
L5_L6_iAMPA_netcon = [-6.110926942855430e-01   -5.620335141107136e-01   -4.216428109855923e-01   -4.410058220652247e-01   -5.835090200395656e-01   -4.599061430207393e-01; -6.285725852153958e-01   -4.616892800827191e-01   -6.075380199492169e-01   -5.407646640367960e-01   -4.374260803181784e-01   -3.441584248482473e-01; -7.188877322838548e-01   -3.446260869854217e-01   -2.833200271303872e-01   -3.895677258733912e-01   -3.816704100240446e-01   -4.457404751425054e-01];
L4_L5_iAMPA_netcon = [-4.066292585216711e-01   -3.989666615588243e-01   -5.058059224834571e-01   -4.015387388083071e-01   -5.188729619233892e-01   -5.183485449130200e-01   -3.399610936064466e-01   -3.672620718426575e-01   -5.680304155188040e-01   -3.531926811102062e-01   -6.881659802638164e-01   -5.215794177634063e-01; -3.893204425001855e-01   -2.867042631698322e-01   -3.083801839436492e-01   -3.564013275406336e-01   -5.007863671523599e-01   -4.928161078956648e-01   -4.658795016242632e-01   -1.610242598654165e-01   -3.901011150746044e-01   -3.626195935990877e-01   -6.765671305167509e-01   -6.754949474401537e-01; -3.350071957065560e-01   -5.630016332348801e-01   -3.160808380761996e-01   -5.344875500745760e-01   -4.562826505626696e-01   -4.951261170647889e-01   -4.596904629875898e-01   -4.239747818700690e-01   -4.950221758433042e-01   -6.039533857256937e-01   -6.018803491495606e-01   -4.199413926156222e-01; -3.048743012590918e-01   -5.065397975771447e-01   -5.664235214609802e-01   -3.254581981086682e-01   -6.235487350548801e-01   -5.210561873388785e-01   -3.492702018685153e-01   -5.732499474025765e-01   -5.406696134623390e-01   -5.963100758645464e-01   -6.631342898402801e-01   -5.123763979928239e-01; -4.018507522388443e-01   -2.998065994926104e-01   -6.755602692661975e-01   -4.661212639772606e-01   -3.812055910127998e-01   -3.520401318743746e-01   -6.007637882617390e-01   -5.494234815953533e-01   -5.127724784973796e-01   -6.944598108156128e-01   -5.225992259132893e-01   -1.877516280425855e-01; -7.510192499648686e-01   -5.490929077990803e-01   -6.915363502568077e-01   -5.907861041943471e-01   -6.037466919510195e-01   -6.344392772432627e-01   -4.210271034751050e-01   -3.952986462149229e-01   -4.786406022739814e-01   -6.980600458791724e-01   -5.130255341742620e-01   -6.534531451676666e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
