function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.408636124610921e-01   -1.404392261085965e-02   -1.330884297292029e-02   +6.601889393626986e-02   -1.661320471929269e-02   -5.423444856101774e-02   +5.845960612445522e-02   -3.174355815005728e-02   +7.445217118279458e-02; +4.826209475325809e-02   +1.141514980783680e-01   -3.484197483450778e-02   -6.554757948003279e-02   -7.662566268695001e-02   -3.510046339684880e-02   +7.438478510050091e-02   +4.433384857000151e-02   +2.691737350901923e-02; -6.780761836627590e-02   +1.817348258430299e-02   -6.732297539401638e-02   +2.857122228410581e-02   -1.010349035689831e-01   -2.744615406615045e-02   +1.067621323092974e-01   +4.052062868304048e-02   +9.822077805941130e-03; -6.362765525658448e-02   +3.603571646782711e-02   +1.902779296736242e-02   +1.031464616060668e-01   -1.290268830487668e-01   +8.849681101055620e-02   -1.164934785720384e-02   -4.449338108989098e-03   +1.301929369703325e-01; -7.056646800437903e-02   +4.531409922492106e-02   +5.247527453323206e-02   -5.220701379561130e-02   +1.071649451861054e-01   +8.521269410698722e-02   +1.445025033964655e-01   -5.679598530907604e-02   -2.027323410972778e-02; -1.457307158132998e-02   +1.126789895933276e-01   -1.250001964778342e-01   +1.189588258093150e-01   +5.642392973016155e-02   -2.614341252821273e-02   +6.667715645781512e-02   +1.323511114466976e-02   +8.546080857390478e-02; +5.205958534888540e-03   +6.491058396101790e-02   +2.057073056126938e-02   +3.755650478787803e-03   -6.354569919965672e-02   +9.444756824357443e-02   +1.943902796831991e-02   -1.176391371629665e-01   -1.501050278602540e-03; -9.726493231133809e-02   -2.767178477596273e-02   +4.559359981504403e-02   -1.155018918541258e-02   -1.087880226464835e-01   -4.233764758611386e-02   +2.941851449867986e-02   -6.739434633516468e-02   +1.648331300755263e-01; -1.947014869343768e-02   -5.442216632776278e-02   -7.477892039474418e-02   -8.049485781791578e-02   -5.313150543213208e-02   -3.542978806979501e-02   -1.748738024178950e-02   +1.083785593788938e-01   +2.897382171762171e-02];
L1_L2_iAMPA_netcon = [-2.119247594949382e-02   +2.592475116585150e-02   +1.010177525108358e-01   +8.565342303473433e-02   +1.051440707362861e-01   -3.560779909877391e-02   +1.832640404928718e-03   +7.115044347091488e-02   +5.116131435758786e-02; +9.501166323679966e-02   +2.603189345187283e-02   -5.449989994477081e-03   +3.653237058593985e-02   -1.796738840571232e-02   -4.911762966491050e-02   -1.434522000019511e-01   -6.535668016391288e-02   +2.622217581167577e-02; +6.278899532961126e-02   +8.266918527077624e-03   -5.760800982280729e-02   +6.024273412736183e-02   -2.356247722378271e-02   +8.286758823071690e-02   -3.010297996132181e-02   -3.794139180411792e-02   +6.146538642761035e-02; -1.149598268269653e-01   -6.822278997001642e-02   -4.263734242501746e-02   +2.470573168540434e-02   +5.609058057910089e-02   -5.264675674636807e-02   +2.186428474137709e-02   -9.048055981038464e-02   +1.443111037384361e-02; -4.371808694660373e-02   -9.670611023131509e-02   -7.224069611358774e-02   +1.334661220208554e-01   -6.591626036681628e-02   +2.853167782863362e-02   +1.755662409270853e-02   +2.304578432074460e-02   -1.316068368364536e-02; +4.028705637211120e-02   +1.033084508692195e-01   -6.625322077940105e-02   +5.876105832825175e-02   -9.000605101036864e-02   -9.428136323370734e-02   -1.969754932603212e-02   -3.806560498221603e-02   +1.245520767879420e-01; +2.812873544837841e-02   +1.591092321099699e-02   -1.492238507273750e-01   +2.376257416386945e-02   +9.885567237654960e-02   -9.050131209086851e-02   -4.184531602121159e-02   +9.885284042244941e-02   -4.582523804111496e-03; +6.178197154569455e-02   -9.434274814615162e-04   +2.725921423706128e-02   +2.018977015721805e-02   +4.179014514541106e-02   +7.975591154837891e-02   +2.106459471883520e-02   +4.011200865819632e-02   -3.929039999641305e-02; +9.731928808734330e-03   -4.081996018259884e-02   -8.102898290326996e-02   -8.597605864281137e-02   -5.046520140874620e-02   -3.700251542791271e-02   -6.038558232205737e-02   -2.993917411770961e-02   -7.649465450561120e-02];
L2_L5_iAMPA_netcon = [+5.050873527936808e-02   -1.104177589777757e-01   +2.009918230360778e-02   -7.324134787059979e-02   -7.175706423921384e-02   -8.126047376480930e-02   -4.167759410034035e-02   -2.598791576651189e-02   -2.147417912376305e-02; +4.872323303360708e-02   +1.257364219919943e-01   -3.732913229587293e-02   -1.181404842373916e-01   +1.431124852716427e-01   -3.180696165905506e-02   -9.746898201425419e-02   +6.171930158690177e-02   -6.349012477315363e-02; +7.144205062498024e-02   +1.176194459532465e-01   -3.352660623917050e-02   +1.981237177721794e-02   -4.133212041654097e-02   -4.223890880230412e-02   -6.728969258880625e-02   -5.528618066426370e-03   -3.386498623610293e-02; +3.798858534977252e-02   +2.974189007576133e-02   +4.176679306545086e-02   -8.369082804436347e-02   -4.401479646827257e-02   -3.966331196887683e-02   -1.043663496578503e-01   -6.625695310150768e-02   +9.119148331894264e-02; +4.632813367993180e-02   -4.197965427427307e-02   -1.139372191665763e-01   +5.446067636710596e-02   +1.148134866619639e-01   -6.724149489628173e-02   +7.634763345304914e-02   -8.658227828434176e-02   -1.043311565099670e-02; -1.184169491396268e-01   +1.056942777212635e-01   -3.411600916555228e-02   -1.009695506507216e-01   -3.682717405139940e-03   -5.464643068398062e-03   +8.141197356716765e-03   -4.542120428027015e-02   +1.123775523658986e-01];
L5_L2_iGABA_netcon = [+6.194546187775519e-02   +2.225668442439708e-02   +3.236425084789164e-02   -4.974034012374434e-02   +8.603156389564794e-02   +7.984405716749660e-03; -1.534544774370169e-03   -8.351041415252121e-02   -3.007871297524705e-02   +2.862758916489412e-03   +5.960814772024022e-02   -1.522465004571711e-02; +4.523872167646630e-02   +1.801280663696280e-02   +1.882010633894524e-02   +1.297724081103079e-01   -1.178509692314695e-01   -4.475930063257799e-02; +5.070490491854240e-02   -8.036340847760101e-02   +4.856263966941688e-02   +1.048480881833058e-01   +4.262779821367753e-02   -2.418892995180848e-02; -2.188819383919074e-02   -3.478354112962619e-02   +3.200784561706843e-02   +1.527060247463708e-02   +6.407307515559854e-03   +1.288185636490303e-02; -7.596421012693674e-02   +1.222972154160943e-01   -1.149738839907986e-02   -3.137810489332837e-02   -5.304330218734163e-02   -1.035583175259226e-01; -8.634034629071016e-02   -2.929983104824138e-02   -2.325719845045058e-02   +9.835035418727879e-02   +7.696381209632881e-03   +1.014372632938293e-01; +1.482289027585014e-01   -1.452823074140295e-01   -6.061926993439697e-02   +1.104428203264412e-01   +2.900117959463496e-02   -4.743502815628273e-02; +6.927718461495992e-03   -2.510326360141523e-02   +6.171618983179641e-02   +3.723206506444982e-02   +1.583346905343259e-02   -2.121874205825381e-02];
L3_L2_iAMPA_netcon = [-7.207549379433871e-02   +6.702578548843560e-02   +1.236149709188829e-01   -1.277900540395231e-01   -8.045792603423448e-02   +3.073041527268970e-02; +6.379477441391636e-02   +1.136054998022566e-02   -2.123989419215020e-03   -4.822765761344743e-02   +1.788050947428435e-02   +1.549373850967704e-01; +7.903188747931023e-02   +2.393522111764863e-02   -1.385894659267280e-02   -5.692631593156344e-02   +1.348559989440818e-01   -3.022332860907737e-02; +2.607507747512760e-02   +3.108419204474173e-02   -6.771097306676702e-02   -4.964097303001267e-02   -3.020673682272380e-03   +7.624514429275748e-03; -6.375579057458938e-02   -9.368464891499166e-02   +6.809180735628648e-02   +4.859777584974979e-03   -1.171084800330779e-01   +1.023491775900216e-01; -2.571631393015390e-02   +3.450395513514462e-03   -4.025455306143833e-02   -1.418662794164038e-01   +4.867661988156904e-02   +2.393867531462502e-02; -1.213544119008990e-01   +2.136428867100073e-02   +6.943594184580995e-02   +6.552169834400588e-02   +1.007127119259641e-01   -1.072795467186685e-01; +1.421729828956966e-02   +9.667136770527540e-02   -1.126835429557873e-01   -1.130031512718096e-01   +7.957030507460876e-02   -5.650534286594759e-02; -4.612788538202865e-02   +1.188133675586080e-01   -1.062313202657097e-02   +7.021394142830885e-03   -1.844467223540486e-02   +4.139975777668137e-02];
L2_L3_iGABA_netcon = [-4.939677890527974e-02   +3.163394838968466e-02   +1.115923600657846e-01   +4.608293443825917e-02   +6.500895489282547e-02   +1.569180587443368e-01   +1.909618938847413e-03   -3.291933991847372e-02   -6.621100520585101e-03; -9.299255974438547e-02   -2.726710679146694e-02   -2.026560198619149e-02   +4.577625265448064e-02   +2.569099027861491e-02   -1.715003983658413e-02   +4.299375809661689e-04   +1.107892632121367e-02   +7.542949034434780e-02; +6.855748205500334e-02   -1.493855478998741e-02   +3.125541759657572e-03   +2.502472666657883e-02   -4.467749238628145e-02   +1.658929024758111e-01   -2.221502685589957e-02   +7.122624709648891e-02   -8.302912098045308e-02; +1.027942649195858e-01   +3.270471983164529e-02   +2.581398003308145e-02   -1.610757135339521e-03   +8.501520372419868e-03   +9.425517567078277e-02   +8.168882151531422e-02   +1.711428097349035e-02   -7.697585687993232e-02; -1.632326143975482e-02   +5.417493198524962e-02   -4.236465150724572e-02   -6.225384334582198e-02   +6.383474009484405e-03   +3.884455445164171e-03   -6.191580282630085e-02   +1.190635413111230e-02   -3.916006386575988e-02; +1.590646589645708e-02   -3.186696340002249e-02   +2.937694893765197e-02   -1.010416733889633e-01   +6.691236550278525e-02   +6.111587362551946e-02   -1.034029234373997e-02   +5.416098616067400e-02   -6.187179322273888e-02];
L1_L4_iGABA_netcon = [-3.300497453603889e-02   -8.708343537538293e-02   +4.407738373208202e-02   +2.405226225503837e-02   +1.024013743970339e-01   -6.148409353496687e-02   -1.942900719576755e-02   -5.623275340328895e-02   -3.297828733257777e-03; +4.921705650586165e-02   +5.296049997739567e-02   -1.408781522384319e-02   -7.437249656162652e-02   -1.565001606963378e-02   +6.373262393985807e-02   +3.507139516443535e-02   -3.725008752353025e-02   +4.533166147397710e-02; -3.873418623624756e-02   -9.842267410491558e-02   +1.491209314108832e-02   +1.022086331264380e-01   -3.422599074453823e-02   -3.175404809374755e-02   +1.657735466740707e-02   +8.136707810748493e-02   -1.231998511810391e-01; +6.186426571697150e-03   -1.910021741838447e-02   +1.303652396855544e-02   +3.533382240900283e-02   -1.713015607909110e-02   +1.418380522375431e-03   -2.852328078071743e-02   +3.299707912536544e-02   +1.167362920919370e-01; -9.231294861047527e-02   -6.490977872809696e-02   -2.390008812994156e-02   +9.909906709704916e-03   -3.897484427752873e-02   -4.650146032634381e-02   -1.471199712895744e-02   +1.017022484241660e-01   -1.173582781458941e-02; -5.739238092434250e-02   +2.312555409762445e-02   +6.149986480214402e-02   -1.007609435075494e-01   -2.426976389813018e-03   -7.667294340156701e-02   -1.071794121546518e-01   +1.016784788915570e-01   -9.171524557474768e-02; +1.093029995859950e-02   +2.469807602895777e-02   -5.412834219095528e-02   -3.678243610679612e-02   +3.523328789340793e-02   +6.177987148057835e-02   -1.086895316798839e-01   +1.525686487807978e-01   +5.583250661010110e-02; +7.539350592924814e-03   +3.393368596930478e-02   +5.754231475339117e-02   +2.761473878608222e-02   -3.532814617305580e-02   -4.909455482290673e-03   +1.118205136076650e-02   -3.598116617866015e-02   +1.164837030576034e-01; -3.031046427520415e-02   -9.691715667856153e-02   -7.717690378027784e-03   -7.797513267570583e-02   +2.791337744010384e-02   +7.586353156718836e-02   -6.447051791199457e-02   -1.164703000268677e-01   +1.000928947425073e-01; -4.392133556240337e-02   +2.167880130161520e-02   +2.142872753732613e-02   +7.700287891833987e-02   -3.220374347125108e-02   +3.747001019551693e-02   -8.287541470905259e-02   +7.904364758709574e-02   +7.576366953402414e-03; +6.282116913431418e-02   +9.074026903967993e-03   +8.123297396148248e-02   +3.819769500717679e-02   -4.581618372971249e-02   +1.854321927697660e-02   -6.345241634563355e-02   +9.512179419363007e-02   +9.024996720579802e-02; -1.211412134926375e-02   -3.564482638240407e-03   +1.346546714958250e-02   -1.186978281583773e-02   +2.089446966353615e-02   +1.280525590810440e-01   +1.189613560179276e-01   -1.450998895716440e-01   -6.058320141759931e-02];
L4_L1_iAMPA_netcon = [-1.081747640019660e-01   +4.236708988491330e-02   -9.093959185218412e-02   -1.113309094768725e-02   -2.698013267608591e-03   +1.205111396229020e-01   -3.274928711494143e-02   -4.272666049310550e-02   +1.105311029643022e-01   -1.038320983180353e-01   -8.345195278163205e-02   -5.386236098148046e-02; -2.822132910912342e-02   -2.189674141774801e-02   -6.063625595694076e-02   +3.701724358199802e-02   -2.996076989042600e-02   +4.184153917164803e-02   -9.179458490259328e-03   +2.060931286864194e-02   +1.037984620959754e-01   +1.048077743791446e-01   -3.872772210544664e-02   +8.431571073204651e-03; -9.227018303102948e-02   -2.814431277981971e-02   +1.003649520615196e-01   +7.593276876128256e-02   +8.971233720678055e-02   +2.945415696452355e-02   +6.833772892682718e-02   +1.571009460249006e-02   +2.234791016153758e-02   +5.105019660028017e-02   -6.464187629386180e-03   -4.477393900154763e-02; -1.008692376876592e-01   +8.882204867552888e-03   -1.476666510889995e-01   -9.666406335011446e-02   -3.412022315856410e-02   -8.700408510364126e-03   +5.580775807801008e-02   -2.256941585450872e-02   +5.236375041532598e-02   +1.020904096316568e-02   -1.908359382317769e-02   -4.424696089921018e-02; -2.511909189080488e-02   +1.128402073712342e-01   -8.218401812971467e-02   +4.170396151348954e-02   +2.186118688203827e-02   +6.029040487101482e-02   +1.876619797128949e-02   +5.424282720250950e-02   +1.300251873375749e-01   -4.250994008356071e-02   +4.043218626805105e-02   +5.054231488040430e-03; +6.585071881270048e-02   -6.022868820228162e-02   -4.837800333694638e-02   +4.642601310006095e-02   +2.921457390723328e-02   +8.492282582730624e-03   +1.153896331860474e-01   -1.484280484490568e-02   +7.040713072414800e-02   -3.587579718356846e-02   +5.602735962006672e-02   +7.032754083005183e-02; +1.279725990979872e-02   -4.809263699120493e-02   -1.568696566057538e-02   -1.240795550813976e-01   +2.388540447366649e-02   -5.168135480918754e-02   +5.940180745945482e-03   +8.174605044900468e-02   -8.933686375622468e-02   -7.190584752707994e-02   -7.781094824810177e-03   -1.309383579809714e-01; -3.671913565572636e-02   +2.955506332504421e-02   -9.004211989744770e-02   -7.797000748697175e-02   -2.980736500500404e-02   +9.632405233030916e-02   -1.172109621639876e-01   -1.210514596299566e-02   -1.631473986603510e-01   +1.370046899352204e-02   +9.523766651001711e-02   -7.870500201681246e-02; +4.447361383907013e-02   -6.369141432088410e-02   -1.605348747839060e-01   +9.902104166744491e-02   +2.104203105442395e-02   +1.349159210663282e-02   +8.106460546615812e-02   -2.566544801203754e-02   -5.161894372918287e-03   -9.508942591580538e-02   +3.185512601077502e-02   -6.836916777496974e-02];
L1_L3_iAMPA_netcon = [-6.237208541731827e-02   +8.380796831535413e-03   -9.356167511024345e-02   +1.025117383937765e-02   -6.765728075455257e-02   +6.369679399643788e-02   +3.149941141530902e-02   -4.485714119225710e-02   -2.512818825193987e-02; -9.731846299035865e-02   +8.387428425736657e-02   +1.022602091846674e-01   +3.179432450316941e-03   +1.706108505738838e-04   -5.556417343157259e-02   -6.480881414475632e-02   +5.502528386374844e-02   +5.519189583542126e-02; +7.790617444017948e-02   -2.032998532054709e-02   +9.793997397101670e-03   -7.046588082334820e-02   -1.009484125985693e-01   +8.985809577951309e-02   +2.223759398412015e-02   +9.853280482695298e-02   -4.614488870982590e-02; -6.822780364722059e-02   +1.042401339800990e-01   +5.775912619706947e-02   -4.915274457347989e-02   +1.260347451192446e-02   -8.704016005072905e-02   +8.779126369835676e-02   -2.203800426892920e-03   -6.548371784726265e-02; -3.871715526140263e-02   -2.402006694963190e-02   +4.056707053981828e-02   +1.318917096271471e-03   +4.993795554707897e-02   -9.125335840567510e-02   -1.088628541295860e-01   -7.110639084674733e-02   +4.126550405092982e-03; -1.247493031436238e-02   -7.936017769072891e-02   -2.657663779843078e-02   -1.050244826487852e-01   +9.503695360066577e-02   +2.091248352272820e-02   -7.374635391118635e-04   +1.361811307932188e-01   +8.381303511013923e-02];
L3_L1_iGABA_netcon = [-7.133877651182209e-02   +5.249016393863076e-02   -2.277229572075646e-02   -2.927110971037734e-02   +2.579252485994896e-02   +8.124577529773071e-02; -5.851694440022701e-02   -4.419416822164779e-02   +7.333425891216265e-02   +3.450548668136438e-03   -1.834468062702395e-03   +2.004346261488104e-02; +5.267638643837544e-02   +9.725928950696149e-02   +2.250634415615542e-02   +5.519841181622773e-02   -5.569120386841121e-02   -1.115031263400919e-02; +6.233993438391586e-02   +9.130469916947441e-02   +1.060430519288319e-02   -6.033203730589287e-02   +7.181355611345502e-02   +6.051006225780152e-02; +1.228517528884142e-01   -6.610311733795855e-02   -1.305103882974092e-02   +4.854331235428356e-02   -1.711557893915475e-02   +4.320866982921034e-02; -3.453973268522029e-02   -6.886781167995087e-02   -1.042585570001548e-01   +7.210626397178264e-02   -1.125171517783145e-01   +9.790767866028578e-02; -1.131680059653628e-02   +4.999602590762322e-03   -3.751791154486674e-02   +1.067221618929610e-01   +3.743812896296363e-02   +8.596456214259734e-02; +1.356199792501765e-02   +1.115392001975582e-01   +1.043744624369405e-01   +3.027068817374793e-02   +4.280853688119250e-03   +1.382468032467173e-01; -1.188224348126887e-02   +4.986442759924824e-02   +5.311904023678104e-02   -7.363834624072940e-02   +3.616967441025374e-02   -3.969552345626159e-03];
L5_Input1_iAMPA_netcon = [-8.094024342587962e-02   +5.633185427265409e-02   -5.050175822720712e-02   +2.668376035727862e-03   -1.042971359636434e-01   -1.359798061742824e-01];
L6_Input2_iAMPA_netcon = [-8.242070705008646e-02   +4.352211880406221e-02   -4.406020985024721e-02   -2.428677553143424e-03   +4.844978991733391e-02   -7.809307198368939e-02];
L5_L6_iAMPA_netcon = [-5.054675707868454e-02   +7.057264214666223e-02   +1.018890802053303e-01   -3.353082283178082e-02   +6.696708286249792e-02   -5.308549327831374e-02; -9.617694409319924e-02   +4.535598007120933e-02   -4.262969776553395e-02   +8.389116269799327e-02   -3.352615191380395e-02   -8.648218681618806e-03; -8.437364743328929e-02   +2.329926710822423e-02   +4.466786389457154e-03   +7.429496811022739e-02   -3.758396109517700e-02   -9.794022186775295e-02; +8.982509348280267e-02   -3.494172184578696e-02   -3.892194050275548e-02   +5.356441125820208e-02   +9.509899906451304e-02   +1.110783434823336e-02; +4.184157453724863e-02   +4.152871412892484e-02   +3.909655608107598e-02   +4.317907251419598e-02   -5.010486090816037e-02   -3.837851056739369e-02; +3.798933407139851e-02   +8.151700460006654e-02   -7.477278254159272e-02   +9.286651886984934e-02   -3.957417356437627e-02   +3.992168661216716e-02];
L4_L5_iGABA_netcon = [+8.411013351251641e-02   -1.139996082250093e-02   +1.836681373507589e-02   +4.074155623676652e-02   -4.094452508769379e-02   +2.998324499589886e-02   +3.642837778135829e-02   +8.519943151751350e-02   -1.291262978962872e-01   +3.870500499089954e-02   +1.374899644380104e-02   -1.759600765450569e-02; -6.886938596228724e-03   -3.804023172074854e-02   +8.399655098433165e-02   -4.045969313135779e-02   +5.036518313048598e-02   -3.565174671205241e-02   -8.011110622987577e-02   -9.579286149386851e-02   +5.357293336113962e-02   -4.656481765908076e-02   -1.478578826314293e-03   +9.126173344436491e-03; -8.326227139667734e-02   +7.432693288240738e-02   -5.044947006382414e-02   +8.255075244805168e-02   +1.137441366807517e-01   +1.191589688590230e-01   -7.321203286819530e-02   -9.754412514168344e-02   -5.708055510485789e-02   +1.763260525885609e-02   -4.611146931932791e-05   +6.335187840215745e-02; +3.380401383899078e-02   -1.071631438318529e-01   +6.997252881612383e-02   +9.280708768166612e-02   -6.531359072610692e-02   +1.697909810747116e-01   +4.996547515628964e-02   -5.141838650166858e-02   +6.879575023954042e-02   +4.338439112039557e-02   -6.677641917262393e-02   +2.306175675636458e-02; +1.875566479663839e-04   +9.426152358257482e-02   +1.991662932731989e-03   -1.193633404157624e-01   +2.344667735414653e-02   -4.065471823123142e-02   -1.217028472125438e-01   +4.847140625190221e-03   -4.862321860117835e-02   -7.390845323507304e-02   -3.506670206764330e-02   +6.947270329256179e-02; +1.953211981900033e-02   -1.387858918382375e-02   -2.031866268957601e-02   -9.092691493438476e-02   -1.459033312620297e-01   -2.794423169746403e-02   -4.075669252092185e-02   -5.359492456993076e-02   -3.436825241397586e-02   -6.046706386498935e-02   +3.985528380282275e-02   -9.596326222120621e-02];
L6_L4_iAMPA_netcon = [+6.887738625608199e-02   -2.463095910455300e-02   -2.373536439581936e-02   +2.512372221626378e-02   +6.984596501984972e-03   +1.435605076085939e-01; +3.674172052546484e-02   +1.002660285796770e-03   +1.771890953901440e-02   +3.460557022234830e-02   -9.765286603347287e-02   +7.748325315406400e-02; +1.372943787279565e-01   +1.231723889581168e-01   -5.064321287760309e-02   +3.484939116790163e-02   -1.735450042805425e-02   -1.146971914110192e-01; -1.242384730903523e-01   +1.027193450064397e-01   +6.250053420309265e-02   +1.501993149025974e-02   -2.193864504520542e-02   -6.632260834794193e-02; +4.240286273338459e-02   -2.520181253431575e-02   -9.155679990624425e-02   -2.252324923762705e-02   +1.976579574965696e-02   -9.187517520577206e-02; +6.701398502645547e-02   -9.273785853972626e-02   +3.431033486629994e-02   +8.085175517721348e-02   +5.871013288515245e-02   -1.056754966080685e-02; +2.053347891991305e-02   +3.924480498403831e-02   -2.983947258740980e-02   -8.636877982712893e-02   +4.008130547307051e-02   -2.171709549954524e-03; +3.476102282581158e-02   -5.608539563646622e-02   +5.950695469621604e-03   +3.472804223347860e-02   +3.310692644592107e-02   +1.873361014401882e-02; -8.747374116478882e-02   +9.587960327178871e-02   -2.531269906211550e-02   -2.913030974057244e-02   -1.440653985358011e-02   -4.514794411728924e-02; -1.342090274567884e-02   +5.012811956271393e-02   +5.512693194139295e-02   +7.547238649523638e-02   +6.694556874853783e-02   -5.421437945114761e-02; -4.680129427815184e-02   -5.746550733770024e-02   +7.336520494165080e-02   +5.036428160954389e-02   +1.051227626947787e-01   +1.863744104840306e-02; -9.740658316079502e-02   -5.981267332977058e-02   +6.424481555684038e-02   +3.740944418527043e-02   -6.015024211479026e-02   -2.339189846097390e-02];
L5_L4_iAMPA_netcon = [-3.650418233971732e-02   -6.539329881448511e-02   +2.458331606132872e-02   +1.284863006939671e-02   +4.877891393227581e-02   +3.600021147878511e-02; -2.446274898843945e-02   -6.640865727148743e-03   -4.628388897752636e-02   -2.374175837961757e-02   -1.594085949971944e-02   -1.469351627537772e-02; -6.186823420796088e-03   -4.993261063916849e-02   +5.961628625248042e-02   -2.515092337463744e-02   +4.185995575620532e-02   +3.306530049027488e-02; -2.720566026830086e-02   +8.598348090181661e-02   +8.467676322932879e-03   +6.057573598182703e-02   -1.969926111960143e-02   +2.179232008051487e-02; -1.462525049704947e-01   +3.267302603306629e-02   +2.538507729523366e-02   -5.172926788238358e-03   +1.002618857889572e-01   -4.734507662860857e-02; -7.406064670131970e-02   -6.250929421291421e-02   +9.080370830212287e-02   +4.527307656737904e-02   +8.538543177425170e-02   -4.172073169450836e-02; -2.118395372165681e-02   +1.911026853999614e-02   -5.673760720493823e-02   +3.037679645427918e-02   +7.741032659959432e-02   -1.126793740046587e-01; +5.357651059566500e-03   -1.222588473307776e-02   +8.436862349178878e-02   +3.159743553670660e-02   -1.313110059997980e-02   -3.984736731332355e-02; +1.193130976554323e-02   +5.438022471576800e-02   +9.311338041096169e-03   -1.203311384068118e-03   -9.535445676498273e-02   -5.761235117440202e-02; +4.700468406292618e-02   +3.738314930623406e-02   -4.840917634399380e-02   -5.673433984427970e-02   -4.227714579045941e-02   +7.428990862621853e-03; +3.655218169098364e-02   +1.286467332148408e-02   -5.957111076478165e-04   +4.703993098109262e-02   -9.707789949976993e-02   -5.741344465049657e-02; +1.473208035921232e-02   -8.025870016359321e-02   +1.924108271472447e-02   -5.512264676388497e-04   +3.332818638852354e-02   +7.278907909163332e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
