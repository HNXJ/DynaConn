function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+8.861755619446332e-01   +6.982390358690429e-01   -2.190211835398763e-02   -1.738305409817762e-01   +7.978987179739594e-01   -6.044618903895814e-01   -2.781678185419765e-01   -2.137799564669619e-04   -5.894660581226260e-02; +8.779790360308062e-01   +2.511341475305068e-01   +3.231063223949904e-01   +2.473355667919965e-01   -7.509206830240059e-01   -3.592551322422181e-01   +8.798690094856205e-01   +5.663573502423461e-02   +4.059139435078452e-01; +2.411639442603558e-01   +4.645605749568311e-01   -1.689825610837341e-01   -4.800882840954760e-01   +4.907234595274417e-01   +4.327523223570138e-01   -6.847921626864814e-01   +4.763330535273030e-01   +5.798237396910328e-01; +4.010369970518504e-01   -9.687179290812772e-02   -2.892128623646243e-01   -2.534853884599708e-01   -9.618078379278049e-02   -7.170701717324623e-01   -1.891525745660268e-01   +5.126285168104346e-02   +5.936687221242336e-01; -6.408712475120057e-01   +7.616004017085659e-02   -1.153880859140539e-01   +5.440936233812677e-01   -4.291282298155970e-02   -1.606971050601379e-02   +5.118999903025276e-01   -3.605934099325128e-01   +7.374164695126725e-01; -3.808739784670217e-02   +7.445217556683013e-01   -6.363346738151597e-02   -1.762986019292360e-01   -2.843238364756262e-01   +6.408575824566285e-01   -4.240358453694014e-01   -1.936255235574834e-01   +7.644592621194661e-01; -4.969411547889447e-01   +5.686486485192751e-01   +8.505193293920549e-01   +2.512972862021898e-01   +8.857659551594969e-02   +8.989263967940027e-01   +4.586288188793108e-01   +7.464765935274087e-01   +4.829958375136284e-01; +8.509349598640304e-01   +1.000000000000000e+00   +3.214717798010525e-01   -5.052954304026571e-01   -3.636200249549923e-01   -2.131208085864688e-01   +7.002707942931422e-01   -7.059382367743718e-01   -5.881013492269482e-01; -6.963826918131348e-02   -6.888856180632837e-01   -1.048441338284189e-01   -1.614660832032842e-01   -6.685218514469787e-01   -3.458795089087214e-01   -1.031518429921833e-01   -1.734263919109231e-01   -3.084277723855361e-01];
L1_L2_iAMPA_netcon = [-1.983887784693050e-01   -1.353881835000623e-01   +2.942504729899303e-01   +7.146817291235860e-01   -4.918248917803864e-01   -2.103789262468910e-01   +1.797498534841433e-01   +5.226185156359825e-01   +3.606410795252384e-01; +3.010290302574391e-02   -2.466872286764083e-01   +8.992082356554327e-01   -7.266434263027119e-01   +4.026450214972690e-01   +9.347850372820390e-02   +7.228922445894939e-01   -4.968192079317985e-01   +1.989855676729796e-01; -7.147271959875959e-01   +3.181094160488759e-01   -1.495105807775758e-01   +7.147311593752982e-01   +3.463875337192526e-01   -2.198666336824433e-02   +3.251402072299591e-01   -1.988954348028148e-01   +9.421339454897497e-02; +8.195510684828570e-01   -7.030924967004122e-01   +1.044513385972057e-02   +2.713540270333871e-01   +1.273170492395588e-02   -3.483509824580188e-01   -7.189631837781034e-01   -4.844973196073069e-01   -1.789198088583352e-02; +2.773446049880069e-01   +5.708868509366811e-02   +1.223678847980884e-01   +9.802965121308964e-01   -1.810547057440062e-01   -2.125574507060411e-01   +5.733108604501550e-01   +6.510804582574274e-01   +2.969167017464032e-01; -8.688373093965246e-02   +5.260500502482796e-01   -3.988211465400540e-01   -1.709930282912784e-01   +4.994295970408746e-01   -6.089473437846417e-01   +8.265590405251423e-01   +6.263498102194980e-01   -6.393672155682231e-01; -4.156354328275290e-01   +4.786011400127189e-01   +4.198346893965606e-02   +2.732254940631279e-01   +4.770860689973099e-01   +7.978845088465180e-01   +8.646929889262538e-01   -1.215081057633727e-01   +3.342666094253715e-01; -4.964624253383866e-01   +2.719167464300827e-01   -4.130123909845806e-01   +4.521133441376125e-01   -6.907263299406052e-01   +5.656164752755251e-01   +6.485051205381134e-01   +3.194573145288711e-01   +1.425973708215993e-01; +1.807561614640249e-01   -6.401003222494699e-01   +1.000000000000000e+00   +5.671571562675094e-01   -3.369123711669737e-02   -4.569123249633369e-01   +3.639999986583553e-01   -4.518976702025122e-01   -8.628229057847256e-02];
L2_L5_iAMPA_netcon = [+4.296355149881164e-01   +8.634563036691322e-01   -6.398533402109599e-01   +9.309308719257214e-01   -2.712309576912400e-01   -1.704383710163381e-01   -5.452411933337536e-01   +9.802023609127954e-02   -5.652062982788082e-01; +7.327526010589769e-01   -5.906513870158531e-01   -5.384112067226719e-02   +8.220006813181174e-01   +2.885704787239315e-01   -2.692185941437906e-02   +8.135472033388197e-01   -3.745935707184574e-01   +8.873667276725065e-01; -4.821092797169592e-01   -2.268638293273969e-01   +2.069090178813926e-01   +7.459393932482191e-01   +2.828774066219767e-01   -5.687990473744663e-01   -2.743003771713044e-01   -2.157365324336194e-01   +7.757242788174925e-01; -6.889189805874603e-01   +8.198260981640121e-02   -3.538136855797686e-02   +4.588091654368629e-01   -4.514724554670883e-01   -5.263579494668692e-01   +8.721353935597859e-01   -6.981074851547953e-01   -1.454123365217358e-01; +7.255494152138174e-01   +2.329929455260999e-01   -3.513791861768679e-01   -4.984842444157756e-01   +1.000000000000000e+00   +7.106193600696628e-01   +7.292699159566521e-01   +4.265855599840311e-01   -8.083915829319245e-01; +5.441867058857149e-01   +5.738166658200767e-01   +1.135323223048897e-01   -7.409826912220556e-01   -7.388851149461928e-01   +9.253862983973771e-01   -3.126489183488199e-01   +1.814372863370285e-01   +3.769689032286280e-02];
L5_L2_iGABA_netcon = [+1.226788301974587e-02   +2.772881877200353e-01   +2.034354040449494e-01   -5.751075999531470e-01   -1.561809382854906e-01   -4.029244509198444e-01; -4.367322284844100e-01   +5.856203134803536e-01   +1.809674927441179e-01   +7.847722561102154e-02   +4.902891266411715e-01   +9.889834148209348e-02; +8.318470730853850e-02   -4.676712843140989e-01   +2.084433432597719e-01   +8.605234627739018e-02   -6.654998321617286e-01   +7.813576539081259e-01; +5.558443413485910e-01   -7.280216539726435e-01   +7.380933757518474e-01   +7.417769736289653e-01   -6.247075023174313e-01   -1.801605843210949e-01; +9.994579039897290e-01   +7.480719270409891e-01   +9.978947828539428e-01   +4.131152116862106e-01   -3.263523972017900e-02   +6.130998970681765e-01; -4.621542231662744e-01   +2.343254080227903e-01   -2.941987052377927e-01   -7.237394132423725e-01   +6.570716160416927e-02   +9.995817869686868e-01; -2.199614221459269e-02   +1.151391920876720e-01   -1.190410194222387e-01   -3.856610830093990e-01   +4.397870529687483e-01   -6.569261310231987e-02; +7.498520307635314e-01   -2.406752953973283e-01   -1.578066128070056e-01   -4.109693340637355e-01   +4.476351453165229e-01   +5.367096241149847e-01; +7.529920005785876e-02   +9.031133920177317e-01   +2.470046183523170e-01   +8.625466572538826e-01   -2.454019017855887e-01   +1.000000000000000e+00];
L3_L2_iAMPA_netcon = [+1.000000000000000e+00   -4.355521478306454e-01   +9.793553437671700e-01   +8.957665443659487e-01   -3.410151469969766e-02   -3.666565932971216e-01; +9.502197379750670e-01   +1.081696003162415e-01   +8.272955076332990e-01   -4.421289141249928e-01   -6.960780879727021e-01   -2.869064758722186e-01; +6.875577443145181e-01   +3.337179546881621e-02   -4.676156829754901e-01   +8.442911834124032e-01   +1.459364442922366e-01   -7.639834478282809e-01; -2.322894422138975e-01   +4.930712537312913e-01   -3.748604631977713e-01   +4.037858498322415e-01   +6.605562309488635e-01   -1.436370278496133e-01; -4.746577937859553e-01   -3.112216606086193e-01   +3.317922849573469e-01   -4.190445512958349e-01   +2.347574896839199e-01   +3.195990141511469e-01; -6.137885131030330e-01   -9.717753296608604e-02   +1.067899790268304e-01   +5.927029594641657e-01   +2.799671149492280e-01   +2.502052858233555e-01; -4.294627108302448e-01   +2.811740644805559e-01   +2.144610626080594e-01   -6.446642027179273e-01   -2.640572310859087e-01   +7.091935715655005e-02; -1.157312200403923e-01   -2.943470753268709e-01   -2.332331584678118e-01   -1.377191898828508e-01   +4.717323944705709e-01   -4.759236188433408e-01; -6.162173488733044e-01   +9.075398042499129e-01   +3.189446275276461e-01   +3.498804038176520e-01   +9.820269988242770e-01   -7.023787805724990e-01];
L2_L3_iGABA_netcon = [-2.258311696191849e-01   +7.396478535661744e-01   -2.904324004964762e-01   +7.010453731868272e-01   -2.987200399024147e-01   +7.344709805636972e-01   +5.089950218761108e-01   -8.188402658664843e-01   +1.874942557805630e-01; -4.207236838120618e-01   +4.950580281614612e-01   -6.393357289605480e-01   -3.649661352494211e-01   +1.318975537304887e-01   +2.259291108882608e-01   +7.086723757534823e-01   -3.745905390245067e-01   +5.916643237869936e-01; -2.786193173699873e-01   -7.895812132093979e-01   +2.506612477236460e-01   +1.000000000000000e+00   +8.056688093606746e-01   -4.051976322853264e-01   -5.956137589087149e-01   +6.263304618688278e-01   -1.170704415837157e-01; -8.367787098670172e-01   +3.732691681080522e-01   +1.154597777846265e-01   +3.235975960410569e-01   +7.371498905867100e-01   -6.848465545621880e-01   +9.134420497475563e-01   +4.070959688268982e-01   +3.726159388513557e-01; +1.699446606299949e-01   -1.971599500934363e-01   -1.123376658524419e-01   +8.481106382600078e-01   -9.595464020010983e-02   +5.985516032783164e-01   +5.400058591833675e-01   +9.126058834717170e-01   -8.449669516934063e-01; +6.598750961616150e-02   -7.382545558551500e-01   +6.424776404477497e-01   -4.570377163688049e-01   +3.000001077590281e-01   -6.128235533917433e-01   -2.206949311048521e-01   -1.859153774858051e-01   +5.748452318912078e-01];
L1_L4_iGABA_netcon = [+8.383474298901750e-01   -5.990293447965297e-01   +4.133648574315544e-01   -2.245020209030504e-02   +6.056001706327218e-01   +7.170536118067112e-01   -3.775983129057229e-01   -5.944449343797199e-02   -2.251455865981279e-01; +1.600831009978884e-01   -2.349534106620999e-01   +2.916496796196273e-01   +5.663096558899483e-01   -4.079315042459350e-01   +4.201545306486601e-01   +2.142411163996473e-01   +4.305527595105649e-01   -3.617092434316977e-02; +2.569348339065577e-01   +3.692877771202177e-01   -7.619258220503392e-01   +2.086288555985691e-01   +7.704791577458326e-01   +6.810059462894416e-01   -5.662730154109115e-01   -5.052313919498230e-01   -1.822169076754507e-01; +2.672625512238058e-01   -5.680488713006486e-01   -3.659208894178851e-01   +3.957687661403305e-01   +5.920635565126198e-01   -4.180742044421982e-01   -1.115574046208866e-01   +2.026061341800635e-02   +3.146388913975917e-01; -7.533807198722251e-01   -3.511930490553164e-01   -5.083262193592861e-01   -7.739284880902225e-02   -4.923176885324377e-02   -6.042941399044509e-01   -2.068450198223028e-01   -6.757547919700270e-01   +4.153194470265241e-01; -2.020171848491186e-01   +7.785497191966105e-01   +8.717186425902951e-02   +3.909294688482324e-01   -6.318509483863339e-01   -3.012244553753999e-01   +7.674802824805874e-01   +4.210171977964379e-01   -4.403963290521886e-01; -6.985344650709713e-02   +8.169820663662385e-02   +9.851237427823053e-01   -7.582062066626410e-01   -3.695456834102424e-01   +6.947276644669155e-01   +2.329853241756324e-01   -2.785793520441309e-01   -1.506815186503420e-01; -6.960314353110002e-01   +8.070202947865002e-01   +3.731077252157029e-01   -5.576952330628689e-01   -1.300499717146903e-01   -7.234567257265079e-01   -1.852184953756452e-01   +6.107950680769714e-01   -4.168565418285340e-03; +8.170383451563468e-01   +7.299738356977896e-01   +1.000000000000000e+00   +1.350366903899403e-01   -6.375903764912225e-01   -4.388918556453726e-01   -2.705771649292379e-01   +8.717539865820108e-01   +5.899542577482317e-01; -4.522905123231822e-02   -5.941004779674697e-01   -8.225748828991677e-02   +3.595971929180425e-01   +2.472573018298571e-01   -7.611580407225756e-01   +9.430523506870663e-01   +5.086880968631554e-01   +8.797585925966901e-01; +3.806532638598001e-02   -4.920847714438376e-01   +8.513299563244034e-01   -4.161010347008908e-01   -1.011247726207138e-01   +1.250171008071917e-01   +5.926997201431727e-01   +5.240392906175374e-01   +5.649852566358059e-02; -4.073012974218885e-01   +5.779026603539973e-01   -6.045828117331962e-03   -1.596838741105107e-01   -3.599120301102870e-01   +1.645280826110695e-01   +6.184221074238685e-01   -3.550656261872513e-01   +1.559757284444547e-01];
L4_L1_iAMPA_netcon = [-3.202137480053215e-01   +4.824132098283762e-01   -8.864804553427950e-01   +9.366820113262461e-01   +4.117535814756290e-01   +6.329661144806613e-02   -5.449284758323635e-01   +7.159857914681272e-01   +4.478784354730108e-01   -4.442976868278121e-01   -4.078078931921217e-01   +7.091061488302827e-01; -2.043125799257800e-01   +8.111656897169572e-01   -5.924285576887118e-01   +3.557502720692688e-01   -6.374773069302978e-01   +2.681293809311098e-01   -4.732109220317381e-01   +6.798041732360834e-01   -4.248802846579580e-01   -7.577508876208929e-01   +4.652368353048152e-01   -4.505705663068013e-01; -8.483223207758889e-01   -4.467795356898828e-01   +1.093038312000569e-02   -7.425693311708332e-01   -1.057333977656242e-01   -1.253977696323028e-01   -5.000724045485374e-01   +3.992127625608722e-01   -5.658727902919770e-01   +7.658767442680656e-01   -8.014026745513082e-01   +8.595184273758767e-01; +3.210241309133711e-01   +4.324145075492011e-01   +1.961171867910731e-01   -4.702912206869027e-01   -2.736530331835386e-01   +5.435352463357395e-01   +1.838864731167792e-01   +1.662533787678072e-01   -2.773926280067364e-01   -7.513775235404442e-01   +6.182878755121523e-01   -4.908054757124373e-01; +7.379516378756527e-01   +1.000000000000000e+00   +1.759393320818484e-01   -3.876612061945350e-02   +4.719994033490092e-01   +4.960635760253355e-02   +5.893162776100538e-01   -4.696464543580884e-01   +6.292348443621452e-01   -4.295326813951221e-01   -5.320734484082046e-03   +3.272123871634193e-01; +8.652516866298607e-01   -2.573518059876179e-01   +6.417730339069107e-01   +1.915711269569742e-01   +7.728477612266089e-01   -1.066244770075917e-01   -3.552644532711818e-02   -1.122596826055110e-01   -4.028165204067828e-01   -3.384276571707198e-01   -4.210745118866123e-01   -2.002214939340869e-01; +8.058305373349590e-01   -6.768580153652748e-01   -8.626734531819883e-01   +4.370885518348384e-01   +1.177292033753749e-02   -7.188203507976773e-01   +6.395331688538843e-01   -5.475195038076212e-01   -1.199037861164157e-01   +1.734640710435780e-01   -6.429306522198093e-01   -1.477038404249796e-01; -7.219420501098635e-01   +1.170452129858204e-01   +7.417440422781545e-01   -1.614400785715811e-01   -7.900999139385007e-01   +5.329598004986406e-01   -1.865774916543276e-01   -4.984943982608904e-01   -6.323689276293261e-01   +2.161917613929373e-02   -6.428944428594181e-02   +1.843785588666663e-01; +3.208640925281365e-01   +6.851740786399163e-01   -8.258146354708042e-01   -2.401751735392195e-01   +9.279013684456310e-01   -2.662372160400386e-01   -7.021874697602721e-01   +7.234775969795887e-01   +6.811600997347528e-03   -6.305401593915503e-01   -4.630554370812237e-01   -3.303324354600930e-01];
L1_L3_iAMPA_netcon = [+2.450139979423702e-01   +1.416596895535294e-01   -1.508638931666743e-01   +6.574972143945331e-01   +1.573091155240156e-01   +4.675687784778838e-01   -4.754752996212980e-01   +9.402145373885232e-02   -5.002462653069976e-01; +8.219031930729860e-01   -4.298954220817637e-01   -5.509700597257500e-01   +7.642127262354237e-01   +6.526686715952456e-01   +5.143998310949744e-01   +8.589331618785967e-01   +1.765676270168874e-01   -3.566760609586030e-01; -2.356253505037741e-01   -3.694132125938332e-01   -5.470407581658304e-01   -6.917820649177339e-01   +3.023890886474492e-01   -6.853899028706865e-01   +9.438425559107517e-01   -5.629226064029735e-01   -7.160596510691604e-01; +8.834542871903920e-01   -1.887398039813863e-01   +8.054838218017405e-01   -8.423426329131593e-02   +2.946113477779673e-01   +2.726344968208765e-01   +3.483419160320322e-01   +4.085947652941820e-01   +7.809356073189935e-01; +7.986947895054457e-01   +9.223087520932248e-02   +1.000000000000000e+00   -5.329682332191601e-02   +6.747111645324738e-01   -4.117848532981188e-01   -2.301945619547040e-02   -5.167330140443802e-01   +8.108077530525089e-01; -5.539838464095705e-01   +4.480544058843050e-01   +8.083125985907570e-01   +5.745251609898939e-01   -1.398303452849411e-01   -5.498573962808039e-02   -2.855962187933641e-02   -2.827133060637457e-01   +7.047826855901635e-01];
L3_L1_iGABA_netcon = [+6.624922775343136e-01   +5.009029259762432e-01   -7.207177084311214e-01   -3.512170185807611e-01   -3.615837925464527e-01   +2.402468354400818e-01; +8.443890028205380e-01   -2.033417428989487e-01   -2.988978417031409e-01   -4.546353838519123e-01   +2.763144381543106e-01   +6.222306748702345e-01; +8.433498847168163e-01   +1.526181958663798e-02   +7.812927612991291e-01   -5.297314257382223e-01   -4.871663383478068e-01   -7.005551007687438e-02; +6.207628895126774e-01   -7.500194194366891e-01   +6.696636098135086e-01   -7.291862400913698e-01   +1.845590988654404e-01   +1.301276069872679e-01; -8.420619524677511e-01   -9.104961278510659e-02   -3.671154188361982e-01   +4.714139236466983e-01   -3.475627471588065e-01   -5.235901275737938e-01; +2.386250091673151e-01   -1.240672390358727e-01   +1.000000000000000e+00   +1.117064708619054e-01   +9.836758457520351e-01   +7.288821724528217e-01; -4.236960872157620e-01   +4.995615318880186e-01   +2.157972709643743e-01   -1.214644413580410e-01   -4.240935026782794e-01   -6.741641316300363e-01; +5.549173587387681e-01   -7.598892840148943e-01   +5.840072442440594e-01   -5.743297273219136e-01   +8.329016353601331e-01   +1.329726525088668e-01; -1.299035778390363e-01   -4.145706076045536e-01   +4.907276366188991e-01   -6.673766543232168e-01   +3.297904346059193e-01   +6.256280143057953e-01];
L5_Input1_iAMPA_netcon = [+4.184885615297445e-01   -2.643225824560444e-01   -8.158427490005525e-02   +1.000000000000000e+00   -3.039470972283390e-04   +6.339704024136856e-01];
L6_Input2_iAMPA_netcon = [+7.404386729922569e-01   +3.316210166391360e-01   -1.000000000000000e+00   -6.571287964271242e-01   -2.411346250345008e-01   -2.342554487808665e-01];
L5_L6_iAMPA_netcon = [-6.331798403730844e-01   +8.811513646129188e-01   -2.713965820217460e-01   +9.864789069628179e-01   -1.810346774514016e-01   +7.323419048872795e-01; +1.442511639665958e-01   +1.490508563686600e-01   -3.347799439749675e-01   +4.650850305626484e-01   +5.547932196452999e-01   +2.066844889012799e-01; -2.910756385068670e-01   -3.361857645794081e-01   -4.127702378548009e-01   +3.373637016611027e-01   +8.063310999690174e-01   -6.946434859097048e-01; +2.733393010409831e-01   +1.031022897129088e-01   -5.422886839773678e-01   +2.807079431636634e-02   -4.045774874501214e-01   -1.152311240145887e-01; -1.859162986326094e-01   +1.000000000000000e+00   -1.840565194547706e-01   -2.407996782867355e-01   +8.285177661087372e-01   +6.396874137345732e-01; -6.863185259750770e-01   +2.510955355481986e-01   +9.501166929355485e-01   -5.387183920446399e-01   +1.659970583272466e-01   -3.269086535149786e-01];
L4_L5_iGABA_netcon = [-5.367521543757178e-01   +8.197175880599480e-01   -8.233679860713206e-02   +4.919396596335413e-01   +5.020511910749049e-01   +3.639283939488454e-01   -2.889769712665811e-01   -2.669563167293004e-01   +1.352692816822561e-01   +4.175547138054576e-01   -6.905140561486434e-01   +9.102563234988518e-01; -5.154980239060778e-01   -2.416514951320562e-01   +1.619006265029923e-01   +6.385172713348881e-01   -4.523926488115037e-01   -2.606173314905346e-01   +6.180045723555146e-01   +6.332217455768261e-01   +1.019874509528753e-01   -5.555423730153511e-01   -5.488647716574601e-02   -6.199746247646467e-01; +1.498944863592293e-01   +8.775786957609538e-01   -2.256735250453169e-01   -2.199465097704673e-01   +2.237472480904263e-01   +8.129399414712525e-01   -3.412772433612234e-01   +1.002791917067103e-01   +4.290805159947445e-01   -4.510219706476690e-01   +2.935711907864693e-01   +2.309806380644580e-01; +9.341137754640094e-01   -7.906223692668224e-01   -4.842995268451580e-01   +7.878255386030618e-01   +1.368001117375713e-01   +3.051514477818645e-01   +9.370242759284474e-01   +4.130550231071682e-01   -6.606295107090971e-01   +3.373566394415868e-01   -5.753217526396721e-01   -2.992565907446449e-01; +8.241775781913303e-01   -5.891621623050622e-01   -7.603555564176545e-02   +1.000000000000000e+00   -6.948421676644924e-01   -3.044528617544094e-01   +5.329535122679815e-01   +7.451474227615710e-01   +8.042202499724563e-01   +6.569698454229548e-01   -6.236443654600599e-01   -5.572951687509681e-01; -4.073424617207551e-01   -1.455301578128046e-01   +8.465600001254742e-01   +6.498696203869337e-01   +5.730486222867561e-01   -2.445316714416511e-01   +7.332910232961775e-01   +4.258480751373562e-01   +3.320822557424837e-01   +3.770301084817848e-01   -4.971570035339093e-01   +8.230014003964675e-01];
L6_L4_iAMPA_netcon = [-7.670040503909946e-01   +3.224492217123713e-02   +8.140773600577662e-01   +2.985613418313706e-01   +7.088036009315537e-01   -6.686416539274688e-01; -1.947500205015231e-01   +1.073380559411925e-01   +5.342780589263597e-02   -2.919590725347982e-01   +9.252036854180999e-01   +3.514404958703198e-01; +3.163810868891381e-02   +7.975004846228848e-01   -6.572643517089133e-03   +5.836699982173050e-02   -5.697297982931443e-01   -1.580797691889780e-01; +4.312376885208917e-01   -1.213738855949615e-01   -5.378084363919839e-01   +3.427625969123594e-01   -1.465290643256946e-01   +4.591331375636596e-01; -8.624616314168581e-01   +8.551913850441499e-01   +3.514095858319187e-01   -4.723915480626235e-01   -6.357057442272565e-02   +3.945156125447907e-01; +7.370374968167271e-01   -5.199852165390177e-01   -5.940860549683071e-01   +3.415960343066050e-01   -2.221515014385804e-01   +5.035658392105945e-01; -2.465105333930924e-01   +2.243368156981239e-01   +1.284398067283271e-01   +6.827395320671218e-01   -5.889724325107640e-01   +5.041274047492005e-01; +1.095495621546274e-01   -1.246068739340396e-01   +4.875968516329010e-01   +2.441612422045192e-01   +7.093848612630871e-02   +9.098543022240914e-01; +2.036392285405728e-01   -2.782896153885761e-01   +9.006456386112471e-01   -2.153353517906419e-01   -3.543214376421217e-01   +5.800645548644375e-01; +6.185760412587026e-01   -1.414621686134084e-01   +2.631840652317772e-01   +4.749908363470001e-01   -7.344532811595604e-01   -2.856105086525643e-01; -1.647280161924198e-01   +1.000000000000000e+00   +8.801933933553231e-01   +2.707465052188573e-01   -1.024272184375995e-01   +1.059318607233785e-02; +3.251127250670210e-01   +6.341292750213597e-01   -2.002595846386504e-01   +3.119623120259171e-01   +1.656187519688374e-01   -2.454781614406367e-01];
L5_L4_iAMPA_netcon = [-5.364966307721478e-01   +3.349630376761317e-01   -6.750760452707881e-01   -1.144450316703945e-01   -2.375681103650634e-01   -9.031296777640817e-01; +2.586088536799062e-04   +6.527347549914488e-01   -6.770073557065045e-01   -3.015948214248437e-01   +4.021034742369042e-01   -7.487234650599069e-01; +7.050562807305123e-01   -3.330263384629615e-01   +8.029807855267574e-01   -1.116375215110814e-01   -1.260360369580880e-01   -6.144981356578758e-01; +9.755869049255039e-01   -1.553611544361483e-01   -2.215527853936972e-01   -5.990172802568573e-02   +6.940411655064955e-01   -7.947241039624547e-01; -5.674339835774114e-02   +9.814092316346139e-01   +7.748813753115429e-01   +3.900757885750266e-02   +6.514900094091880e-01   +3.129346677978557e-01; -3.541794585466546e-01   +4.697596939141133e-01   +4.195254305566648e-01   -8.947244801696224e-01   -9.008101900827850e-02   +4.392297795659372e-01; -7.929465143099308e-01   -5.246518460787358e-01   +8.138580310516015e-01   +3.467079392598941e-01   +1.160586146344488e-01   -1.143435676659779e-01; +3.113249529257295e-01   +3.673574085101917e-01   +3.289838734932851e-01   -6.233982939060052e-01   -6.189696368864179e-01   +8.778238838640037e-01; +7.108317229756402e-01   +5.512566285506221e-02   +1.160896313263538e-01   +1.000000000000000e+00   -1.775862844000171e-01   +6.356134682255398e-01; +7.972567987361492e-01   -6.792223970097667e-02   -4.837388057811788e-01   +4.248507730654913e-01   -6.746854590367272e-02   -3.683528879316987e-01; +5.384141175265683e-01   +2.795576385799639e-01   +2.767853745338464e-01   +7.151535738464262e-01   -7.592636020202602e-01   +3.937416374472401e-01; -6.456093613204651e-01   -9.325848260341077e-02   -5.712636133892234e-01   +7.951647880961369e-01   +2.664838417160575e-01   -4.092558093230025e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
