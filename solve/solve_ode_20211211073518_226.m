function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.778289328609321e-01   -1.606771716024092e-01   +9.866005504052205e-02   +1.392456477093704e-01   +1.231065297752055e-01   +6.330202740075426e-01   +4.825726709518190e-03   -3.254240217988064e-01   +3.574822809004718e-02; +1.594389847744638e-01   -2.187624240252399e-01   +2.337308407819028e-02   +6.765049349972831e-01   +2.306892534612182e-01   +3.901602056233975e-01   +1.283823104777974e-01   +2.568630593553251e-02   -3.668431425161044e-01; -4.395609429277934e-02   -1.629257436246978e-01   +1.150845804856528e-01   -2.465804774508709e-01   +3.141746652092718e-02   -4.112076918771636e-02   +8.186943475603513e-02   -1.438448869297246e-01   -4.248465219584117e-01; +1.851564092040947e-01   +1.906796806263323e-01   +4.216864342222802e-01   +3.727726876486470e-01   -5.564568363952924e-02   +3.570954021372635e-01   -7.464320138693702e-01   +1.782425371193963e-01   +1.735840980662966e-01; -1.995427500148060e-01   +3.786581697305743e-01   +1.570025423296591e-02   +2.363530928660857e-01   +2.926203381195622e-02   +1.216595937391920e-01   -2.142148773189075e-01   +4.937548303553901e-02   +2.072002790042662e-01; +3.272263967359605e-01   +8.582477955847667e-02   -3.240043633307111e-01   +1.386309656344216e-03   +3.840229170198640e-01   +1.436323135254669e-01   -1.684924427860068e-01   -8.051625579397910e-03   -2.703347645705720e-01; +2.040521096873787e-01   +1.590142821175783e-01   +7.782080997014176e-01   -2.224707200356740e-01   +1.156280367884427e-01   +2.020652755325556e-01   +2.247678782815445e-01   +3.504059403750881e-01   -3.530577122466381e-02; +3.656052283407459e-01   +6.468704521719555e-01   +4.362756545785105e-02   +3.158891808042510e-01   +1.109902636817857e-02   +1.075374851342405e-01   +4.834222699237453e-01   -2.477746582578200e-01   +1.388726116709479e-01; +1.155708973075724e-02   +4.021310709013354e-01   +1.000000000000000e+00   +1.385509039009754e-01   +2.585440826294778e-01   -9.618776083580861e-02   +2.968551216981891e-01   -2.175135180059601e-01   +2.237362009148479e-01];
L1_L2_iAMPA_netcon = [+4.338426418389697e-01   +1.372769002957333e-01   +1.988547380943033e-01   -6.836692179815221e-02   -4.118490859918314e-02   -3.187838877294525e-01   -1.210124727422839e-01   -1.653306528958455e-01   +4.723622578750580e-02; -5.921937785721363e-01   +3.267573838644000e-01   +3.374050125006200e-01   -1.980690117039733e-01   -6.449723568929282e-01   +6.659630367714833e-02   +1.077524909222921e-01   +7.737972624886232e-02   +4.777947005995452e-01; -2.396704049001308e-01   +1.085132573234521e-01   -2.533116481193022e-01   +1.617464963281458e-01   +3.469538415228091e-02   +5.104780493616220e-01   +8.170971902413364e-01   -5.181275406937577e-01   -2.902260450935940e-01; +1.419253210204171e-01   -2.713846324985481e-01   +2.320064771718410e-01   +7.864883033082603e-01   +1.530673939162905e-01   +6.149996769060764e-01   +1.639879140371263e-01   +8.274024872397181e-01   +2.086946086961201e-01; -1.269609721240417e-01   -1.292917335308002e-01   +1.779288756021579e-01   +3.124593063192776e-01   -3.198388528926057e-01   +2.182013001332934e-01   +1.458556885126853e-01   +3.465617669201582e-01   -2.781920129359815e-01; -7.274106000110872e-02   -1.388812676946494e-01   +3.560492723007663e-01   -3.156586653307013e-01   -1.653638709154561e-01   +3.372214789969232e-01   +2.452182549233047e-01   -1.455608653329847e-01   +1.969011577997800e-01; +4.272636546513719e-01   -2.694508197287844e-01   +3.702419091758299e-02   +1.851873596877061e-01   -2.299518585723934e-01   +2.162919686736045e-01   +2.387217611168166e-01   +1.723464425779112e-01   +2.398133140574665e-01; -4.504609343730355e-01   +1.501473818914709e-01   -2.076202894528779e-01   +2.230178859311525e-01   +1.115054964421478e-01   -9.561585151280821e-02   -6.165935700826342e-02   +3.317806850268268e-02   +2.305874407120269e-01; -2.594161437121124e-01   +2.862356125480771e-01   +3.949112254932468e-01   +2.203463948941001e-01   -7.525805014467863e-01   -1.807368066544459e-01   -6.263638334254862e-03   +1.320114105546737e-01   -1.193826697432637e-01];
L2_L5_iAMPA_netcon = [-3.078734184886189e-03   -4.390750501262886e-01   -3.934431574932832e-01   -1.525886516809372e-01   -2.093223956487300e-02   +3.621274282165284e-01   +3.080155615488342e-01   +3.232086996927361e-01   -3.231687625435109e-01; -3.632508618276061e-01   +4.327071848306131e-01   -8.844907777518785e-04   +2.034311638778655e-01   -5.769326226624315e-01   +8.509509129576598e-03   -1.026655379075752e-01   -3.604284035821512e-01   +3.419691442739836e-01; -2.087048015314168e-01   +1.573718310863695e-01   -2.574613403879458e-01   +7.574334751297945e-02   +5.726275036643065e-01   +2.015261158584318e-01   -8.298940466163046e-02   +1.325117541400248e-01   +5.694038472476014e-01; +3.374771329886618e-01   +7.395452795027666e-02   +4.150481359953623e-01   -3.271915625930505e-01   +5.241499671445309e-02   +6.715378111359809e-01   -7.447737563889554e-01   -1.272739772645787e-01   +5.192234271188865e-01; -1.897801442427213e-01   -4.951878916923789e-01   -4.178725448899763e-01   +3.062863622943435e-01   -1.796510315529984e-01   +5.964599903687932e-01   +3.815000992457830e-01   +2.265371437539306e-01   -6.581425885636056e-01; +2.431648823234134e-01   -1.048328856002313e-01   -4.073882101259807e-01   +1.981215391164947e-01   -2.735595882300236e-01   +8.905456463882072e-02   -2.162650085888800e-01   +2.092299487757276e-01   +3.633898541502015e-01];
L5_L2_iGABA_netcon = [-4.554176997213112e-02   -2.448883935348469e-01   +3.095366644234795e-01   -3.801331618866531e-01   -1.722837578328952e-01   +3.377147166476693e-02; -1.531889098028762e-01   -1.581553264672383e-01   +3.633687690186816e-01   +2.717179748205082e-01   -6.863125476144039e-01   -5.406855745745761e-01; -5.493876577026410e-02   +2.820067344455995e-01   +2.250289849827696e-01   -9.518261136576067e-02   -1.756243176452772e-02   -2.753797410836433e-01; -4.180208372156049e-01   +4.147587053529988e-01   +4.567057687476135e-01   +2.947840250416305e-01   +5.776800145274964e-02   -6.100144661595360e-01; -4.348505334907494e-01   -9.989965266079941e-02   +2.707642102152146e-01   +2.019842851808346e-01   -3.080209206320849e-01   +2.081948135189289e-01; +1.037466402490852e-01   +2.634376347966619e-01   -2.919105011157773e-02   -1.044436164188018e-01   +4.274365336506746e-02   -8.748279627887955e-02; -1.416071205274147e-01   -6.107745542460654e-01   +5.304718851335241e-01   -1.252423215258523e-01   +2.506274917959143e-01   +4.635882459268570e-01; +2.517829561178150e-02   +9.669899217994675e-02   -1.108849952669217e-01   -1.843580970321419e-01   -1.246905770622755e-01   -8.704859802411534e-01; +3.153634835903478e-01   +2.195691756553477e-01   +6.174691784668925e-01   +6.889746642982761e-01   +2.242447028804852e-02   -2.755717072603275e-01];
L3_L2_iAMPA_netcon = [-3.241735620747547e-01   -2.363075263182126e-01   +2.238974177838640e-01   -1.586098334149743e-01   +2.243995595587346e-01   -6.536284489031584e-02; -7.778772059604294e-02   -4.122678561287016e-01   -2.539711038367222e-01   -1.991036666609012e-01   +2.273077979588160e-01   -1.616857382852421e-01; +1.116288380542905e-01   +4.488164085161239e-02   +2.137987146540674e-01   -4.018247174468714e-02   +8.969767919299247e-02   +5.741445580891263e-03; -1.394031216575249e-01   -9.843360312892740e-02   -2.027579034732057e-01   +9.674821207125782e-02   +3.412639231088523e-01   +1.338899676308600e-01; -1.755425297272950e-01   +4.427146451199072e-01   +5.800606658962341e-01   +1.894847181828780e-01   +2.809218684490685e-01   +2.067074458962223e-01; -1.286812909445215e-01   +4.088479381445319e-01   -4.653883906533415e-01   +4.978795277376150e-01   +2.558598302889751e-01   +4.980831522332224e-01; -3.736028570251895e-01   -3.866468935227596e-01   +2.660650180507797e-01   +8.281331483735582e-03   -2.996879602849025e-01   -3.125128906844262e-01; -1.729708097083643e-02   +1.263743985485588e-01   -2.999900850447835e-01   -9.827627248609273e-02   +2.170924899464455e-01   +2.345707954387165e-01; -9.831932194079060e-03   +2.064051810534472e-01   +2.825176285685124e-01   -1.311394344060752e-01   -3.150280342286624e-02   +4.699954880303024e-01];
L2_L3_iGABA_netcon = [+5.296347753861222e-01   +5.999491379481575e-02   -6.588837995852455e-01   -5.930847440909653e-02   -2.143025144412197e-01   +1.970972236367790e-01   +4.504857843385413e-01   -6.746796174591560e-02   +6.799116507924579e-01; +4.424899174678404e-01   -1.383415032179495e-01   +3.673870396270265e-01   -2.095611303909571e-01   +9.197794377846091e-02   +6.085856827210749e-01   +5.670012939092683e-01   -1.626365474497647e-01   +2.017550659299897e-01; +3.773495200752165e-01   -5.078632991254575e-01   -1.553031081219566e-02   +2.695085695899275e-01   -1.334778885978451e-01   +1.725680876896204e-02   -1.189575898540540e-02   +1.364201874254017e-01   +3.129659750896808e-01; +4.895213864022348e-01   +5.098094378976209e-03   +7.670306363478103e-01   -6.288401492400986e-01   -4.895482454903009e-03   -8.261251382316672e-01   -2.938289946596463e-01   +3.193751154905698e-01   +6.038302776573345e-01; -2.877329968343517e-01   +5.152384411062699e-02   +6.912727949908129e-02   +8.769137306227406e-02   +8.372059948799826e-02   +6.503975158364039e-01   -3.725261047211323e-01   -3.702233218142513e-01   -1.798526156634314e-01; +7.203315824192894e-01   +6.958573111192534e-01   +4.507843677674320e-02   +2.617730282902631e-01   -1.115909243594815e-01   -1.425784785202436e-01   -4.577388487890984e-01   -4.153246998841135e-01   -2.913794568799983e-01];
L1_L4_iGABA_netcon = [-3.828741990416916e-02   -6.067917924367979e-01   -2.432992939452231e-01   +1.365594350764816e-01   +4.487511538968955e-01   +2.066631348650151e-01   +5.130224948868097e-02   -1.423791624105553e-03   +2.443233409336218e-01; +4.324315317624065e-01   -3.826068410900123e-01   +1.557264961111238e-02   +7.185182726126843e-02   +2.763179373163534e-01   -7.940726404299039e-01   -1.007416721238076e-01   +3.005086587073240e-01   +2.954755512814043e-01; +4.592879910217033e-01   +4.344060113093487e-01   +4.612275282007086e-01   +1.586678303599776e-01   +5.761566526126159e-03   +3.887991520765506e-01   -2.832805775916373e-01   +6.430324519499760e-01   -1.081629506663413e-01; +2.766434401700114e-01   -4.898509713046711e-02   -2.089776390912254e-01   -1.503975548680184e-01   +4.450763767646036e-01   +8.847312292570835e-01   +2.367566603602793e-01   +2.919173111054630e-01   +6.728548012205904e-02; +1.862360627873468e-01   +3.463636103570937e-01   +6.068153410739220e-02   +3.260338876548508e-01   +1.543455734854852e-01   -8.237861709070760e-03   -4.553836658371782e-02   -1.604968625623543e-01   +3.862362474586185e-01; +7.866487922562871e-01   +3.233136293297063e-01   -6.782663775766381e-01   +6.874825424543621e-01   +3.783960714184208e-01   -1.755830557723093e-02   +2.472765472833924e-01   -2.028647795689719e-01   -4.254810554766270e-02; -7.051846768722035e-01   +5.996956431438556e-01   -2.410797313992830e-01   +6.268320174471648e-02   +5.517902803792993e-01   +5.681908522084820e-01   +6.170013413825979e-01   +5.339161471402416e-02   -2.195089211865273e-01; -1.629733138835419e-01   -5.110492023082494e-02   +6.471268594267926e-02   +2.291519460875442e-02   +2.165509260600758e-01   +9.430629646167504e-02   +6.279874193048637e-01   +2.904876868111695e-01   -2.481660882754750e-01; +3.654195948458318e-01   +1.099732900671845e-01   +5.508669832660602e-01   -2.749880288585016e-02   -2.339700281655601e-01   -2.161839158170754e-01   +5.599531545488485e-01   +6.699700301756677e-01   +2.530419723604555e-01; +5.871886590890661e-01   +5.998982816640659e-01   +1.701947918322386e-02   +1.512358353174109e-01   +3.173891167700327e-02   -3.546700224445554e-02   -5.527423589086023e-02   -3.435084773012057e-02   -5.794177644533449e-02; +8.827964709032614e-02   +4.748339097105949e-01   -6.307060543477105e-01   -1.456187008480502e-01   +1.582430497353138e-01   -3.464600428693357e-01   -2.860655186355709e-01   -2.693624400878797e-01   +6.632495984824887e-01; +1.955942840263900e-01   +1.579102313124426e-01   -5.442908729538012e-01   -1.208098366408414e-01   -4.895563827442337e-01   -3.217983005958178e-01   -1.321821092284237e-03   -1.498508574488074e-01   -2.416563198260806e-01];
L4_L1_iAMPA_netcon = [+1.576139716714169e-01   +8.724417400012896e-03   +4.829385640300736e-01   -4.223451516834701e-01   +1.851187250508873e-01   +1.771691107898696e-01   -9.079363763976750e-03   +2.254960740772420e-01   -2.938701537462736e-01   -3.960641585592145e-03   -2.552516618265384e-01   -1.595002822217229e-01; -1.584253515676591e-01   +6.439447574792028e-01   +1.323526029283689e-02   +1.438062964344720e-01   -1.291139759806046e-01   +6.750035883031147e-02   +6.381492907890781e-01   -1.384249644763884e-01   -6.070076539056563e-01   +3.579345488073571e-01   -2.104503172656184e-01   +9.352164051979823e-01; +4.516800263308006e-01   +2.922203980970828e-02   +5.496493391849515e-01   +6.345617199845146e-01   +4.913421018324293e-01   -4.071398464897670e-01   -9.139499741855456e-02   +4.325865360107962e-01   +3.809264655455158e-01   +2.003937186809763e-01   -8.705871967846254e-02   +1.691938896451881e-01; +5.561007261719917e-01   +3.896390848938930e-02   -2.142929196787072e-01   -4.211087320658888e-01   +3.889484724783034e-01   -8.184859300386381e-02   +2.597043558220981e-01   -1.603015084883670e-01   -3.485926286872013e-01   +2.241760629527405e-01   +5.669060924807071e-01   -6.696654965572808e-01; +4.039060656410742e-02   +1.774291667181628e-01   +4.772554088259510e-01   +1.381092562967866e-01   -1.130518604466980e-01   -1.636907892309440e-01   +3.017053407150014e-01   -5.795176161119679e-01   +6.930078461287337e-02   +7.063062289489021e-02   -1.872118925582794e-01   +2.776940222505295e-01; -4.872524059981980e-01   +8.398188997896141e-01   -2.913318051065011e-03   -5.497618171217533e-01   +4.138597498278830e-01   +1.914042647133687e-01   -4.393767057756321e-01   +4.667915545411236e-01   +2.178595627893021e-04   -2.216817951704959e-01   -8.726901346673128e-01   +1.868323270585647e-01; +2.301353718518577e-01   +4.683298906473905e-01   +3.950393151237183e-02   +3.356836338871173e-01   +2.829934243400967e-01   +4.219275275226843e-01   -2.892027875676924e-01   -3.665567824465208e-01   +5.230400079081916e-02   +4.502787342138676e-01   +3.204442194408260e-01   +3.212122767093711e-01; +9.497982654804699e-03   -2.226090447072146e-01   -2.409383000090164e-01   +3.065508585858464e-01   +4.187581933123092e-03   -3.690082129654086e-01   -3.571040370605999e-01   +9.327007174138086e-02   -5.279557391286972e-01   -3.279901057417774e-01   -3.536131969671196e-01   +4.795484582698945e-01; -6.385585551222844e-03   +4.347964237532740e-01   -2.081651510426372e-01   +5.540746025049367e-02   -3.946225028393023e-01   +2.388145544061382e-01   -3.098726857951528e-01   -2.652535426058989e-01   +1.294201837618761e-01   -2.434689589799948e-01   +6.461376914841912e-01   -4.603214818577641e-01];
L1_L3_iAMPA_netcon = [-9.663084139687847e-02   -4.031645651101958e-01   +3.097782846107349e-01   +6.922360985974473e-02   -4.284688954425411e-01   +2.225453529612174e-02   +7.530770526848389e-02   +2.486211943939486e-01   -1.666911063546054e-01; +1.030114335686260e-01   +2.259494924013469e-01   +2.819810702896558e-02   +1.961336918646704e-01   -1.477424947297825e-01   +1.510013421340649e-01   +2.530393972036978e-01   -3.500868310085123e-01   -5.332742226283840e-03; +4.165051764834339e-01   -1.394730729572119e-02   +2.465615031738070e-01   +9.578504983272215e-02   -5.120246937188785e-01   -1.723278899805402e-01   -1.851887306206060e-01   +3.752996224419207e-01   +1.811136250753802e-01; +4.121765269226385e-02   -3.472497352085336e-01   -9.641874936383799e-02   -1.103215463570189e-01   +7.055255045268230e-03   -1.074817584141369e-01   +3.425928988580902e-01   -1.264265161348016e-01   +2.554053510704278e-01; -2.902616588593459e-01   +1.308043917587682e-01   -2.263561376131891e-01   -4.619625106163049e-01   +2.529126516508017e-01   -1.541518231813015e-01   -3.238715053112169e-01   -5.700634498950896e-01   +3.741680700787821e-01; +1.428841724431945e-01   -3.974158557855638e-01   +1.459578273384482e-02   +3.994942500344549e-01   +4.147323560956544e-01   +5.399609737301521e-01   +5.297844357754382e-01   -7.440044431482780e-01   -2.944045838933880e-01];
L3_L1_iGABA_netcon = [+5.733159073807426e-02   -2.320203345930426e-01   +2.524272122521621e-01   +2.855622932194637e-01   -6.219962504316126e-01   -3.154854427510663e-01; +4.656572568172417e-01   +6.379531042327622e-01   -2.287523557308092e-01   +2.877576995560893e-01   +3.070806361671852e-01   +7.884100951076173e-02; -2.977487707163275e-01   +4.011258805222642e-03   -3.647503052469971e-01   -2.402446092835737e-01   +4.527710315009154e-01   -2.134305489405643e-01; +1.947959787561003e-01   -3.267048700177489e-01   -9.496679050123316e-02   -4.548767977954726e-03   +1.488572948693233e-01   -1.729435425017750e-01; -4.340051934470507e-01   +5.669180373431815e-01   -1.160023173624929e-01   -1.051411055550517e-01   +8.002389484815202e-01   +4.334946442414950e-01; -2.778019880917945e-02   +1.175263986271393e-01   -2.498376634796784e-01   -2.596605080481842e-01   +2.258327694705710e-01   +8.212391995970822e-01; +2.027657881397699e-01   +3.236210656927412e-01   +1.113519300669303e-01   +6.982231130240290e-01   -1.421541502876104e-01   +1.967805505056198e-01; +3.510991269319530e-01   -6.633347705304085e-01   -1.143318556414210e-01   -3.288004320587328e-01   +2.027400964499652e-01   +5.869461559748002e-01; -4.879065123987437e-01   -5.257244748245996e-01   +2.507611318902893e-01   -4.063566150806386e-02   +2.175253219682161e-01   -2.042918109494863e-01];
L5_Input1_iAMPA_netcon = [-4.391702593626890e-01   -1.759485337386379e-02   +5.153209092532909e-01   -7.085036407898809e-02   -6.080639788354644e-02   -2.756346065472152e-01];
L6_Input2_iAMPA_netcon = [+5.052435268535851e-01   -1.426061465829046e-01   -1.333559554061906e-01   -2.200893162322449e-01   -1.763670906597690e-01   -2.734703250291690e-01];
L5_L6_iAMPA_netcon = [-1.382732344458550e-01   -2.020320117125173e-01   -3.081862006707575e-01   -2.159437586166246e-02   -1.832136967207215e-01   +2.384891444218051e-01; -4.167849152723229e-01   +1.058150386138201e-01   +7.930633575544483e-01   +5.380581641088885e-01   +4.306170671185405e-02   +3.643108671122023e-01; +8.656935499088850e-02   +6.482605093253871e-01   +6.068499212535063e-01   +1.585980156856120e-01   +2.625063274988847e-01   -9.074701761628132e-02; -6.349118026145991e-01   +4.583060249337346e-01   +1.675453327855000e-01   +1.186809436766541e-01   -1.994437640953131e-01   -3.099280325679324e-01; -1.200089855313962e-01   +1.332436536654302e-01   -2.669700054410505e-01   -3.251892764604261e-01   +1.833890723604125e-01   +6.350573930365224e-01; -1.394966315559009e-01   -3.036077926874414e-01   +7.211208915672200e-01   +4.919840430310315e-01   +3.029664550792901e-01   -4.276899610027590e-01];
L4_L5_iGABA_netcon = [-4.104805735406661e-01   +1.529722388698297e-01   -6.853756437868179e-02   -3.396382638988104e-01   +6.624799327558687e-01   +3.112530686145699e-01   +1.988422954300545e-01   -2.075722700582496e-01   -1.280252801926589e-01   -1.650896454696769e-01   -2.901748096160024e-01   -3.172942705904121e-01; +7.829858152495933e-02   -4.092795721106923e-02   -1.023044698068874e-01   +6.002676932444178e-01   -4.858614088739712e-01   +3.380225080884945e-01   +6.091479006898888e-01   +3.041689781627046e-01   -2.481141340103194e-01   +3.375794440470764e-01   -8.837499619891969e-01   +6.080114392047471e-02; +3.023164971304215e-02   -7.883075736632285e-02   -4.515810405602828e-01   +3.325764596760367e-01   -5.860745136105121e-01   +6.387196150779149e-01   +2.711892475285960e-02   +3.246495200234362e-01   +4.147050843624041e-01   +3.613749411895845e-01   -2.731752188613781e-01   -4.070754788278649e-01; -1.383437591808137e-01   +2.362371953575979e-01   +3.677408909167281e-01   +4.676559837439745e-01   +3.354319166466856e-01   +5.208254509720012e-01   -1.348780489944583e-01   -1.321461539776729e-01   +1.997908970690385e-01   +8.641611589062452e-01   +1.418291740807588e-01   -1.123856575471441e-01; -2.043101813383033e-02   +2.523950933324135e-01   -4.461494074358494e-01   -4.224822151056942e-01   +2.250794652433278e-01   -3.592712153468693e-01   +1.338134598124756e-01   +2.404259836834368e-01   +1.372974379756091e-01   +5.776749775469905e-01   +7.043397453624453e-01   -1.457893639534762e-01; +4.964540074603313e-04   -1.772335308315265e-01   -2.078833811462193e-02   -5.887032736897354e-01   -1.877299143648825e-01   +2.798516276841523e-03   +1.334335311898353e-01   +5.104505837900284e-01   -3.212038941596611e-01   +1.361423608814940e-01   -3.371939361350101e-01   +3.328220206076633e-01];
L6_L4_iAMPA_netcon = [+2.564774467654437e-01   +3.814048492972842e-01   -5.660917933374381e-01   +1.346604182252144e-01   +3.854744423315561e-01   +5.510257677442905e-01; -6.161774978847986e-02   -1.539869164532991e-01   +2.174855168803773e-01   +5.225547471322237e-01   -2.327849581213808e-01   -2.863452373252940e-01; +5.390243229302546e-01   -4.552254778718549e-01   +2.698034907594635e-01   +7.225760117387630e-01   -3.662139028174162e-01   +9.100105465835453e-01; +2.294244865221755e-01   -3.110216312072349e-01   +5.700556692019179e-01   -9.012062838557564e-02   +2.936808573413053e-01   +1.355681564565429e-01; +2.518235364046856e-01   +8.147148124610326e-02   +4.962776585998370e-01   +6.921438420579187e-01   -1.797753278248881e-01   +3.978240446267541e-01; +1.065366973829718e-01   +5.869514242192412e-01   -1.498849964516234e-01   -2.726345966510356e-01   +5.178722591348286e-01   +3.286245337516446e-01; +6.570481713958997e-01   -2.058500639888863e-01   -2.186657396773917e-01   +3.000202147676851e-01   +1.343634593412801e-01   +2.977504970462547e-01; -5.123699808321789e-01   -4.393385910025627e-01   -7.870442976359718e-02   +1.617298325101846e-01   +1.479641645389998e-01   +1.463996978384906e-01; -6.635083398196751e-02   -1.128768862287020e-01   +3.607687849219784e-01   -5.552326679059965e-01   -4.217898372308213e-01   +5.888147422322715e-01; -5.595720467252101e-02   -2.210718915811725e-01   -2.830880793489057e-01   -3.172153384312862e-01   +1.913799563604582e-01   +3.588702053358233e-01; +1.060847276362306e-03   -7.059008667979891e-02   -3.798746012093384e-01   +3.538399848132487e-01   +2.303456298577518e-01   +2.654246622316235e-01; -1.464832256902358e-01   -4.413157723228241e-01   +1.666117072524249e-01   -3.674461708272390e-01   +6.642975890457210e-01   -9.112785189925415e-02];
L5_L4_iAMPA_netcon = [+6.222977020597975e-01   +2.658720665014448e-01   -3.528554955669017e-01   -6.317122387902410e-02   -1.913396296201942e-01   +3.786142158581928e-01; +4.214064623193355e-01   -1.646080585667870e-01   +5.952318823031677e-01   +4.475731012012899e-01   +4.846582255448061e-01   +5.702322782283991e-02; +2.155348922189844e-01   +7.562567991282106e-01   -2.366198469646497e-01   +9.824806010184003e-02   -1.077035059579176e-01   -3.495415745079978e-01; -3.718189820054801e-02   +1.338373256505220e-01   -5.174695036151827e-01   -3.589815672692466e-01   +2.171013564606303e-01   -7.683812465464245e-02; -2.646522231760684e-02   +7.005197123341961e-02   -1.844251009853883e-01   -1.831780950377612e-01   +5.637751440473131e-01   -2.817451177094634e-01; +3.257054535572420e-01   +1.323722625188335e-01   -4.984973110765945e-02   +1.043060428743233e-01   -4.955319505631606e-01   +3.806946938914144e-01; +2.546475831465821e-01   +1.739871697561703e-01   +4.021430189779249e-01   -1.626199455536317e-01   +1.621548512008989e-01   -1.325163339919831e-01; -6.532581805973521e-01   +6.435126600262852e-01   +3.289248558633120e-01   -8.776269620830887e-02   -1.880289624051343e-01   +4.010165638772814e-01; -3.735765146360495e-01   +1.061763797733578e-02   +2.256272687999667e-01   +4.225448316718098e-01   +4.359155232707100e-01   +3.653501126533828e-01; +3.781240690166794e-02   +3.516305447786218e-01   -5.656202625640864e-01   +5.880884359136778e-01   -4.280262642077527e-01   +2.149451888977284e-02; -4.601781814611253e-02   -7.432039463193958e-02   +2.458706559528119e-01   +1.473335911043017e-01   -5.575485035995019e-01   -4.197549855576963e-01; -3.351525638537357e-01   -4.705845180166529e-02   +4.732139462856556e-01   -4.452223539689465e-01   +2.324911316142787e-01   +1.739394158641320e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
