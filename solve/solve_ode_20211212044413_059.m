function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.008672875040707e-02   +1.196632602126342e-01   -3.310559372832436e-01   -8.841130441739804e-02   +2.394392155526859e-01   +2.877846595164688e-02   -1.560596582870637e-01   -8.557135735756186e-03   -7.362619244929391e-02; +5.285174823451835e-01   +4.227810279268339e-01   -4.026991937069800e-01   -5.561056225971393e-02   +3.132232017920078e-01   -1.530455615957914e-01   -1.437757709563601e-01   -3.755451629655525e-02   -8.235707655132948e-01; +5.836856043455651e-02   +3.585874249410673e-01   -3.358628800741741e-01   -4.827876889188264e-02   -2.575378312524330e-01   -1.187445657158347e-01   +2.441340351421606e-01   -3.912573932169406e-01   +1.523773518258481e-01; -2.490543637015210e-01   -4.610506554519925e-01   -2.121252868782828e-01   -1.876045516347694e-01   -1.303729219270170e-01   -2.922600463804534e-01   +3.230246472833318e-01   -2.721162469813926e-02   +3.665737654034795e-02; -3.139323585586355e-01   -4.217626531434279e-02   +2.336078689504540e-02   +1.220318271569669e-01   -5.285311505988437e-01   +7.559880245498832e-02   +3.310445978229555e-01   +5.040209158531701e-01   +1.852479788113773e-01; -1.651898673081711e-01   -3.530124089729799e-01   -8.535278393329654e-02   +1.405910897651007e-01   -1.211373384847702e-01   -2.105331244660506e-01   +1.375323317593146e-01   +5.439382738125212e-02   +2.586361569556859e-01; +3.365273163951789e-01   +1.988155410771234e-01   +4.783553775642695e-01   +1.582950370947053e-01   +7.580181233986734e-02   +2.035116567598592e-01   -7.180707999321720e-01   +2.105973598869704e-01   -1.268120632154796e-02; -1.989105731681305e-01   -3.220353729985066e-02   -8.196414791126805e-02   +1.466757525743008e-01   +6.210618157570733e-02   -1.504642953770139e-01   +2.283159493535521e-01   +3.737153051533634e-01   -1.796687993266692e-02; +2.255670038338739e-01   -2.851585585516960e-01   -4.010723264706483e-02   -2.304564062027541e-01   -1.759684668062476e-01   +3.037910707049777e-01   +6.788539856446603e-01   -3.617699766478122e-01   -2.282625848205107e-01];
L1_L2_iAMPA_netcon = [-6.782841089227089e-01   +4.667244445773550e-01   -5.424610199731786e-01   +4.306298588032456e-01   -4.456167546347400e-01   -6.841387201541171e-02   -3.307887723981647e-01   +1.521599964676126e-01   -1.730755470561924e-01; -2.199843651710211e-01   -9.702319487895265e-02   +2.227045849128909e-01   +4.486786701127004e-01   +2.282069767730630e-01   +1.725950334893533e-03   +3.815380236239841e-01   -6.877228329334339e-01   -1.448931191661372e-01; +5.137841546981009e-02   -1.685908417849452e-01   +1.675609119989935e-01   +2.366007410987146e-01   -4.800260592891417e-02   +4.291172999352111e-01   +3.791050777573589e-01   -5.474661428653785e-01   -1.263212860976482e-01; -4.265423124785012e-01   +4.800725849622903e-01   +3.119410274778919e-01   +3.060349911437928e-01   +2.859440580431198e-01   -2.787655802394293e-02   -8.046884280113997e-02   +6.386174395723574e-01   -7.459927704956111e-02; -2.204155593855288e-01   -4.864714548535672e-02   +3.242779803729234e-01   +1.313262522484430e-01   -2.204732753122724e-01   -6.380862723536761e-01   -2.211464435432292e-01   +1.664689861904888e-01   +2.176983396202408e-01; +2.547403780121107e-01   -6.893879379332646e-01   -2.605417491999684e-01   -9.431648650536459e-02   -4.727786567341908e-01   +1.851195185389591e-01   -4.070509590424805e-02   +9.602984895648853e-02   -1.147684519125951e-01; +7.033827157882019e-04   +2.747562051337136e-01   -4.462863577710037e-01   -2.892127280501018e-01   +9.370105882437363e-02   -4.765359611236405e-01   +4.866320996161114e-01   +4.805236943201276e-02   +4.408227743885343e-01; -3.329321920719597e-01   +3.859246091713472e-02   +2.715780351170147e-02   -5.362316727558160e-01   +1.351635564832423e-01   -2.408712166772088e-02   -8.163171056672346e-01   +2.282572836137484e-01   +1.885605966740890e-01; +3.438694778826686e-01   -1.932853670056006e-01   +3.573434130092487e-02   -1.401555337709674e-02   -1.062895068943609e-01   -7.142312199070283e-02   +3.535586728203405e-01   +3.397224176336014e-01   -1.995670287753351e-01];
L2_L5_iAMPA_netcon = [-4.960709595767675e-02   -3.046051357285305e-01   +2.954799653342208e-01   +1.815070450975244e-01   +3.339121518789895e-01   -4.210131322547891e-01   -3.936890017512615e-02   -3.486245393543552e-01   +5.039193243229899e-01; -4.876319869479807e-01   -3.395937479936038e-01   +5.289636988871615e-01   +5.850177358406019e-01   +2.543575234228433e-01   -9.196812436611224e-02   -3.595119292768448e-01   +5.380785557022946e-01   +2.105505750430764e-01; +4.183469103265845e-01   +9.980367120191860e-02   +3.124893259621949e-01   -2.174842194688870e-01   +4.310634273506311e-02   -1.607575575406090e-02   -7.951394286551473e-02   +7.965200138882367e-02   +3.921310997507653e-01; -3.055249491922852e-01   -1.406903953274460e-01   -1.438580683252937e-01   +6.383297279835015e-02   +2.029538287356568e-01   -5.093786513531755e-01   -1.622768436040995e-01   -4.946939388478051e-02   +3.751345195502501e-02; -2.252747985299040e-02   +8.092729926391776e-02   -1.379840701797412e-01   +6.736912095173342e-02   +2.343121209177431e-01   +2.405905022384433e-01   +2.708125833183068e-01   +1.839847354667980e-01   -5.383017179965863e-02; -1.222105585841474e-01   -2.133184952120932e-01   +1.383598662191792e-01   +2.956506344899456e-01   +3.380701951632531e-01   +1.561117313969873e-01   -1.774787397009541e-01   -5.256615504274304e-02   -1.415968955538283e-01];
L5_L2_iGABA_netcon = [+1.063268627801157e-01   -1.346123744460434e-01   -2.603770740723263e-01   -3.257065956941550e-01   -1.432795218378733e-01   -7.373381783161478e-02; -6.927743248387080e-02   +8.592413536966956e-02   +5.498218126166126e-01   +3.573755130224947e-01   +3.879515864801485e-01   -3.806558026640385e-01; +8.383007203488026e-02   -2.229984315542929e-03   +2.756718427631278e-01   +3.919403762832370e-01   +5.867463430578909e-02   +1.592988080428132e-02; +1.499939652946004e-01   +3.534445192917619e-01   -3.241226189282971e-01   -4.576691709043302e-01   +3.437541877666200e-01   +1.194450175753030e-01; -1.312346576118150e-01   -1.153064525838688e-01   -8.490151367814378e-02   +2.247200113421442e-01   -4.810882253294703e-01   +4.854675183188019e-02; -2.566689492638444e-01   -4.158163475092492e-01   +2.131566883878984e-01   -5.647054858140878e-02   +1.414594370588526e-01   -7.397079510969830e-03; +3.427179241084468e-01   +2.418590232767122e-01   +2.484919454597647e-01   +1.322647408404182e-01   +1.790602594134462e-01   +7.404951225707945e-01; +1.377737566642596e-01   -2.164481179759859e-01   +4.144374937884892e-01   -1.086768630849671e-01   -7.098697385539407e-03   -1.040825036525808e-01; +1.946233486554569e-01   -2.074745117312568e-01   +2.469207775854320e-01   -9.868981534175292e-02   +2.601133785171016e-02   +5.916025045590374e-01];
L3_L2_iAMPA_netcon = [+1.568012624665299e-01   +4.065110668610078e-02   +2.198204118866683e-01   +5.177549909594045e-02   -3.285974176487344e-02   -4.287241538992007e-02; -3.532456439277527e-01   +1.466387506795309e-02   -2.754432238669418e-01   -4.952203219750155e-02   +1.882246602251582e-01   +7.175420078965518e-02; -3.442718295143300e-01   +5.979067034902009e-01   -3.822954635604388e-01   -3.924946571836188e-01   -1.051217044638660e-01   -1.446473300500194e-01; +4.899928890465368e-01   -1.990142757362409e-01   -2.217269772734171e-01   -6.773532353170410e-02   -3.054296714958771e-02   -3.738964548669705e-01; +2.354989096607009e-01   +3.030026874990788e-01   -7.044838160897549e-02   +3.851214068481718e-01   -3.154769974210448e-01   -1.244967335585056e-01; +2.085105150022235e-01   +1.346937028608223e-02   +3.040650008954540e-01   -1.022061600666970e-01   +8.427988560533677e-02   +3.943624234398294e-02; -3.357148914267237e-02   +3.403915324388596e-01   +3.494255819788556e-01   -2.716942179114388e-01   -7.478706416510369e-02   -2.139700112098318e-01; -7.300216329351075e-02   -5.030516875142443e-01   +4.911123018057770e-01   -3.608863141524329e-01   -1.504031526384008e-01   -5.359808784368013e-02; -8.528447964565147e-02   -8.480872532756277e-02   -5.251819125132746e-01   -4.812265756601821e-01   -1.021638268937974e-01   +3.375446633131889e-01];
L2_L3_iGABA_netcon = [+3.058717875605930e-01   +1.075576085286702e-01   -1.109787656643171e-01   -7.388927425423680e-02   -4.400368248076603e-01   +1.981427374786134e-01   -7.472282315143304e-03   -9.780331172240080e-02   -7.929111158524361e-02; -1.989924387624085e-01   +3.738806809377389e-01   -1.604124424700265e-02   +2.575829404765008e-01   +4.942319257290479e-02   +2.543542253926946e-02   +7.714055557985630e-02   -5.610994101798544e-01   +1.593981121066983e-01; +5.347043792965157e-01   +3.368985928372030e-02   +3.511200549629187e-02   +3.114190261972319e-01   +4.725897011186819e-01   -1.721313677285314e-01   -4.754761106790589e-02   -5.104151314388539e-02   -3.937593202991635e-01; -3.761349064660700e-02   -3.036686050481502e-02   -3.975506978338046e-01   -1.009050209147178e-02   -4.035287977073709e-01   -1.608529824211118e-01   +1.028602488761067e-01   +2.231499876132248e-01   +2.797129746085219e-01; -6.994458770575446e-04   -3.009462806684117e-01   +4.287021152098169e-01   +2.401152116251455e-01   -3.993381071156046e-01   +5.067492309705537e-02   +2.950023324773877e-01   +2.296260477584324e-01   +4.395312245444195e-02; -6.485503141313707e-02   +5.419270075007369e-01   +4.025506718419074e-01   -2.474299601081593e-01   -6.411218690855255e-01   -2.316313775450826e-01   -3.393007156717029e-01   +4.675043767467607e-01   -1.601784125931928e-02];
L1_L4_iGABA_netcon = [-6.755228260731463e-01   +4.100089006159776e-01   -2.614174404976541e-01   -4.009511064732167e-01   +1.765132921339398e-01   +6.356328229407078e-01   +2.829702701568143e-01   +2.235488944910382e-01   +2.502830230814820e-01; +5.250965832079846e-02   -4.736150703112151e-02   -1.320780974730007e-01   -5.131442104435975e-01   -7.971737073619282e-02   +5.201112471425318e-01   -2.000870182525357e-01   +3.028174512018542e-01   -1.893307231276435e-01; +1.498861277852376e-01   +2.334032183146509e-01   +3.720789500932240e-01   -2.845014835821041e-01   -2.822464671010720e-01   +1.600623990041460e-01   -2.008510999227333e-01   +2.170029368773830e-01   -1.643759360463039e-01; +5.083555420001079e-02   +3.454552541374713e-01   +1.962027431290058e-01   +1.326948483804791e-01   -5.260539930009028e-01   +2.334406166222168e-01   +2.399149825704865e-01   -1.205300498801153e-01   -1.776270389806043e-01; -1.259319122058233e-01   +2.397475363654336e-01   +1.269539613904816e-02   -4.007065353833504e-01   -4.385286668923889e-01   +1.074262236809520e-01   +4.087130223036284e-01   +6.253454896391148e-01   -9.151184532313639e-02; -1.637817578625846e-01   -9.582192657166658e-02   +1.080721396407169e-01   -5.575559724258370e-01   +3.537386968699078e-01   +1.696335649128998e-01   -3.156310223770111e-02   +4.033423223214792e-01   -3.081051251341484e-02; +3.826518985827689e-02   -2.515727843817395e-01   -1.758462064150640e-01   +5.141324127659996e-02   +6.668815920330987e-01   -1.534016540963110e-01   +6.302686070961270e-01   -1.160425659081164e-03   -2.983669238335152e-01; +9.758101914187843e-02   +1.446986519902173e-01   +5.060386425707273e-01   -2.230858900263209e-01   -1.589555478347855e-01   +4.587195374122673e-02   +4.666408591388402e-01   +5.303536663590103e-02   -8.206460553091383e-02; +3.016275676342511e-01   +1.380792996540404e-02   -2.922447218272246e-01   -3.652081752520925e-02   +2.017106980277963e-01   -3.984453607937749e-01   +1.862835681608641e-01   -1.626641313004130e-01   +7.676475338748340e-02; +2.552418156861980e-02   -3.687617782264578e-01   -4.938296173995591e-01   -9.179735665040759e-02   +1.201709220662640e-01   +5.177803052322661e-01   +2.388316345118090e-01   -2.445590527523063e-01   -5.334739276545078e-02; -3.951092667844849e-02   +2.473929937614219e-01   +3.768038751208200e-01   -4.345547081541994e-01   +5.928299699726478e-01   +4.255631001271068e-01   +5.547841509544547e-01   +3.782383434876311e-01   +1.632627633057342e-01; -7.856249548310289e-02   +4.100802845931145e-03   -3.593320083934984e-01   +4.564878722831672e-01   +2.543537173737533e-02   -8.067738093057011e-02   -5.610681697417255e-01   -3.620395763830745e-01   -2.446746476046385e-01];
L4_L1_iAMPA_netcon = [-2.474929431618224e-01   +1.568583946875197e-01   +2.981546933221732e-02   +2.016742716792926e-01   +2.650390824667730e-01   +1.111056256520200e-01   -5.513492145284314e-02   -3.078288386048769e-02   +7.022105423056976e-02   -2.322812154232138e-01   -7.806751963204497e-02   -1.001646634713725e-01; +5.221482276501248e-01   -1.353588066181182e-01   -9.492700387089777e-03   -2.117467695192179e-01   +2.865928422845628e-01   +7.149801400466498e-01   -1.524180928372855e-01   -1.090416950907279e-01   -5.860323690545267e-01   +3.501986614000029e-01   -8.748985687187961e-02   +8.632187011561741e-02; +1.235496830597294e-01   +2.032150659349433e-01   +5.072471662446760e-03   +2.446009527629484e-01   +1.038596022669608e-01   +4.299538681013134e-01   -1.476438891701788e-01   -4.245900882919222e-01   -4.891828020002121e-01   +4.090710743233700e-02   +4.169145819714989e-01   +2.335350464832731e-01; -1.673266697627886e-01   -1.094155498957312e-01   +5.544365893380567e-01   +7.623643065717016e-01   -2.022131824418931e-01   +3.473556249983296e-01   -5.204147254351733e-02   -5.493348393171713e-02   +8.972435443762347e-02   +4.514180007235691e-01   -8.409762085355696e-03   -6.638736976693116e-02; -4.045065411471444e-02   +1.889920242139930e-01   +1.329562786766145e-01   +5.045637325797574e-01   -2.627176635587775e-01   -1.960935853804807e-01   -7.155618077084905e-02   -4.687044437781345e-01   -1.720048346243342e-01   -3.152139489232181e-02   +1.196786956294593e-02   -1.448650702201277e-01; -1.358976072727612e-01   -7.000720678231717e-02   -4.003604060360216e-01   +1.672462986743341e-01   +5.517002877887471e-02   -3.044856407483751e-01   -1.169638473643950e-01   -5.788551217015929e-01   +2.219092279156158e-01   +2.368662255446591e-01   +4.316461932180704e-01   -2.272011620043718e-01; -1.035524464582495e-01   +2.316805591665194e-01   -3.703618793784150e-01   -1.368107148055177e-01   +1.820495055739545e-01   -1.379797553220557e-01   +2.389629386641302e-01   +5.688612876377037e-01   -1.816383047832017e-01   +4.328264693744663e-01   +2.500570369989491e-01   +3.702783076654160e-01; -1.108159408821079e-01   +1.482644822543891e-01   -2.847079913022869e-01   -2.615998446556589e-01   +1.184869326161700e-01   +1.676944829784786e-01   -1.106045744316435e-01   +2.192337674179176e-01   -2.148056184646186e-01   -3.814621350434248e-01   +4.708192371665396e-02   -2.868193033185167e-01; +4.426020312249865e-01   -1.451762370264753e-01   -2.469364371423925e-01   +2.338381898065072e-01   +3.003558290494263e-01   +1.594700061688593e-01   +2.865153271703729e-01   +2.441968738605749e-02   +4.751589066481279e-01   -1.389762306688994e-01   -1.476207169207331e-01   +3.904372558235304e-01];
L1_L3_iAMPA_netcon = [-2.457813083536697e-01   -1.132804310191851e-01   +1.740055229106384e-01   +1.000211663876852e-01   -1.921415386865994e-01   -6.295275774663928e-01   +4.255482548621087e-02   +1.855163986343014e-03   +6.609078670447502e-01; -4.612252738818460e-01   +1.100825077930217e-01   +7.316433575592259e-01   +1.794538994008988e-01   +1.182861605114720e-01   +5.764342726407756e-02   -1.682274656023487e-01   -3.790430525223942e-01   +2.876445744830551e-01; -8.806736554608277e-02   -9.657455013767316e-02   -2.938038865821090e-01   -3.499110047430146e-01   +4.977288023578577e-01   +5.575949613318543e-02   +5.717178789484623e-01   +2.376881552389346e-01   -1.394754593369834e-01; +5.893283365517046e-03   +2.007461074721550e-01   +4.148245109940498e-01   +7.080914455196213e-02   -4.545357170004133e-02   -1.686032174400273e-01   +1.348773070615247e-01   +1.459730320375270e-01   -2.571441448642720e-02; +8.179390776089801e-01   -9.315995788521148e-02   +5.450426027816591e-03   -7.789780405349380e-01   +1.025420936036929e-01   -1.737367414122815e-01   -2.159466186390889e-01   +1.173128294287513e-01   +5.591214150018656e-01; -5.376428743315526e-01   +5.888104064378351e-02   +1.646844950284434e-02   -3.272205011714361e-01   +3.894663760398799e-01   +8.190191952929976e-02   +5.669520768260352e-01   +5.773442107826261e-01   +4.614718160868660e-02];
L3_L1_iGABA_netcon = [-3.743565986494460e-01   -3.858944867080939e-01   -1.320520141565230e-01   +1.624475384980004e-01   -9.344651795669910e-02   +2.214716208655199e-01; +1.621366658788592e-01   -2.957303321013356e-01   +1.206728004633112e-01   +2.024170537990260e-01   -2.162772184996486e-01   +1.289218639065545e-01; -6.545581239833694e-01   +7.468678258109800e-02   -2.640952069564660e-01   -5.894226049908199e-01   +5.425453887530791e-02   +2.955639088638372e-01; +1.882163719713000e-01   -2.227432347196398e-01   -6.278494846310779e-01   -3.577784913457874e-01   +3.559970748185277e-01   -5.643340261815268e-03; +2.751471871591997e-01   -3.150034478550404e-01   +6.014873716047824e-02   +3.278335463848240e-01   -2.378650346460541e-02   -2.091697019891281e-02; +5.388279503893936e-01   -4.450585740954258e-01   +4.349300791350180e-04   +2.153060319857353e-01   +5.092148857379393e-01   -4.170446359523926e-02; -4.261229520066941e-01   +3.226715933865789e-01   +7.487919730276510e-02   +1.111591947871597e-01   +7.224500851686971e-02   -2.290348340345646e-01; -1.603169870382272e-01   -2.929156857026486e-01   -9.372354139328533e-02   -8.152815107294320e-02   +5.682594702187491e-01   -4.355843077472488e-02; +1.105725098840538e-01   -3.131216504720452e-01   +3.734437450711453e-02   -3.837282167061927e-01   -3.091631478411030e-01   -1.884574906043928e-01];
L5_Input1_iAMPA_netcon = [-5.544402071144271e-01   -2.609366461958031e-01   -2.778803011848607e-01   +3.372991758920181e-01   -1.658157465100366e-01   -5.171049907648393e-01];
L6_Input2_iAMPA_netcon = [+1.960069204336342e-01   +1.303205153138665e-01   +2.205537331541994e-01   -2.180071394465671e-01   +8.832587103119496e-02   +3.138677040965849e-01];
L5_L6_iAMPA_netcon = [+7.566682534450386e-02   -2.750442057527516e-01   -3.017526037234322e-01   +3.998973637439474e-02   -2.237017634685887e-01   -5.995039891577911e-01; +2.153869383579662e-01   -1.435496364110597e-01   +1.779955080355837e-02   +1.803354608098246e-01   +3.281294721699901e-01   -1.028572128028830e-01; -4.821647853664396e-02   +3.164219995161446e-02   -7.172108330536618e-02   +4.262752795629723e-02   -1.841582906434076e-01   +5.720923871494821e-02; +8.787731878357141e-02   +1.009900338039670e-01   -5.269906660124608e-01   -7.618054974667896e-01   -8.369761534633932e-02   +1.376133898499299e-01; +1.437893130427560e-01   +3.009310634519288e-01   +1.350545904104254e-01   -6.007614916282371e-02   -4.134113340339616e-01   +2.437692893064092e-01; -1.171431364816828e-01   -5.894550751655850e-02   -1.009350081037357e-01   -8.672283083070369e-02   +6.512898848680893e-02   -1.318187878216176e-01];
L4_L5_iGABA_netcon = [-8.385140614710162e-03   +4.935820189404220e-01   +3.750984558501285e-01   +4.647288915498103e-01   +5.589694859870910e-02   -1.354012957495851e-02   -1.929502596636721e-01   +1.186110021840475e-01   -3.723787054872860e-01   +5.247365085645890e-01   +2.853935776840572e-01   -3.242429901125500e-01; -1.998910651758335e-01   +1.674098471856098e-01   +3.676250045347952e-01   +4.017726991337875e-01   +1.282705951887750e-01   -1.229294777907753e-01   +5.194191043475130e-01   +6.022782777663110e-01   -6.115330303352234e-03   -8.125390827782153e-02   -3.710963862850881e-02   +2.586355957596941e-01; -6.063510512308459e-01   -1.435580330614026e-01   +1.539974848561254e-01   -6.770619477614350e-01   +1.688957735222755e-01   -6.096074909229538e-03   -1.121498554329442e-02   -2.538088417650695e-02   -4.615940886065152e-01   +5.350681330717701e-01   -3.721669622660562e-01   +2.680158393883457e-01; -4.088118923892042e-02   +2.857174520876298e-01   -7.070824376334761e-01   +2.180800543074194e-01   +5.546913313709496e-01   +2.206419285133702e-01   +1.086945074263913e-01   +2.641193507637917e-01   -5.155588788859180e-02   +3.759765289311343e-02   +4.736481214734860e-01   +4.297628992412750e-01; +3.661082210664340e-01   +3.060538873163835e-01   -3.193119236237893e-01   +1.400363201790730e-01   -2.987992791662943e-01   +5.569925496214718e-03   +3.565043708894453e-01   -3.814423143932640e-01   +4.135041766974263e-01   -2.743606065374868e-01   +7.039830284177350e-01   -1.043951514378681e-01; -3.528474639157948e-01   -4.926127303783825e-02   -1.753181524625255e-01   -1.601778277368206e-02   +1.613139075800666e-01   +2.049783293663291e-01   -1.753955602658367e-01   +1.638133497623087e-01   +1.269354962660425e-01   +2.829965206624260e-01   +7.433016971215820e-02   +3.483834663430219e-01];
L6_L4_iAMPA_netcon = [+2.904605708680338e-01   -6.324557747057117e-01   -3.364758248410539e-01   -5.441321029157751e-01   +8.590880914059104e-01   -9.405774710122032e-02; -1.713178860284111e-01   -3.191883898515205e-01   +1.077833155949448e-01   -1.609536430924487e-01   -9.091421126962559e-02   +1.370116087835410e-01; -3.630820819538945e-02   -6.116109161376889e-01   +2.214314090084904e-01   -2.656880736390330e-01   +2.590690609049376e-01   +8.457334907455965e-03; +1.153327759988693e-01   -2.732470380733547e-01   -6.408931590264914e-01   -2.955408809930947e-01   -7.099054462414509e-02   +3.410691450925168e-01; -3.985861912708362e-01   +3.234584142377633e-01   +1.589125690391122e-01   +1.176134460140572e-01   +2.141186872007149e-01   +1.565150503222550e-01; +7.843042992963559e-02   +5.990081650970628e-01   +2.576152113078007e-01   -2.347714775358170e-01   +1.284535070574476e-01   -1.825670218972706e-01; -5.132185807122130e-03   +3.240900847393604e-01   -4.476039094951240e-01   +1.452248321252410e-01   -1.542505708702917e-01   +4.764855909629875e-01; +8.988244001371834e-02   +5.347160686285435e-02   +4.683461394928261e-01   +1.556934640127669e-01   -2.456618277610249e-01   -1.595096020208250e-01; +9.267651609211544e-02   +4.963780895610391e-02   -2.542970251054268e-01   -7.544760038711537e-02   -3.609488224199750e-02   -3.061684654751238e-02; +5.610093200141921e-01   +2.020605864893040e-01   -2.606778502213170e-02   -6.309356345228991e-01   +7.527040278260269e-01   -4.398328332874039e-01; +2.611040248934390e-01   -2.878492422744798e-01   +1.568053731492857e-01   -1.428402069523964e-01   +6.182035923190599e-02   +1.554523301377496e-01; +2.123586643662274e-02   -4.347781342313211e-01   +2.993224312378130e-02   -3.175681412751211e-01   +2.893573549693558e-02   +2.328422124991305e-01];
L5_L4_iAMPA_netcon = [-4.239304529421516e-01   -5.200408469334328e-01   +1.752202142437921e-01   -4.410114271538096e-01   -1.945039698735398e-01   +5.530346864717291e-02; +1.899990637260213e-01   -3.063995881887382e-01   +5.967928752298877e-01   +3.885950550562897e-02   +6.732585056962381e-02   -9.522424022892048e-02; +2.079806425238004e-01   +4.349215188824613e-01   +2.418438365225764e-01   -3.135527707526042e-02   -1.699051000933208e-01   +2.472698279352215e-01; -5.400971028499274e-01   -3.558067468861702e-01   -5.106670153462750e-02   -2.223361672067078e-02   -8.937818326211354e-02   +1.540723074496946e-01; +3.623819613148352e-01   +5.118270899452443e-01   +4.619549160295692e-01   -2.407965246986045e-01   +2.980197507455968e-01   -3.965340602352788e-01; -4.595897539123324e-02   +2.261341356029195e-02   -6.240515684604407e-02   -2.073656844155848e-01   +2.015241807455001e-01   -7.370101900424397e-02; -1.195481557543908e-01   -6.813002746914348e-03   -1.155427905623436e-01   -1.245565781641677e-01   +5.431093258911079e-01   +1.509473884740618e-01; -1.726077026394520e-01   +7.283758615978609e-01   +9.972521061374440e-02   +4.072710742093839e-01   +9.660705141218230e-02   +4.419194301567914e-01; +1.676823741421335e-01   -2.486394578408763e-01   +1.755814702598372e-01   +2.809377823597969e-01   +9.864117500997595e-02   +2.516975781134337e-01; -4.793817936192254e-02   +5.087876003068019e-01   -4.566516918061189e-01   +1.778565692273381e-01   -4.019404375478949e-01   -5.738633932052722e-01; -9.457869550995403e-02   -2.871673125512282e-01   +3.222487636954486e-01   +3.603497899195192e-01   -1.497281485259650e-02   -2.538383197475970e-01; +1.825950630560413e-01   -3.399615764423708e-01   -5.338797200129981e-02   +1.821904685157659e-01   -1.210111363170247e-01   +1.130494281296072e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
