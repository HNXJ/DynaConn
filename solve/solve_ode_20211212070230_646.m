function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-8.178110171984593e-02   +4.557110250793978e-02   -2.909105196830050e-03   +2.507572364741720e-02   -3.961000326854781e-02   -5.280716058648004e-02   +9.417076739925116e-02   -9.225657652124963e-02   -3.484990883774144e-02; +5.750182891334943e-03   +1.384325876052135e-01   -4.852577389306705e-02   -1.305390157527417e-01   -1.284509695009923e-02   -7.685892711852864e-02   -1.429663660163971e-02   -5.861095667473981e-02   +1.818313190176313e-02; -5.358523780281807e-04   +1.262158115516032e-01   -8.845792456711030e-02   +2.227240363558424e-02   -3.698187392639939e-02   +9.233708732237132e-02   +1.191630041455058e-01   +7.292621517192935e-02   +1.668118951956671e-01; -4.811827476546194e-03   -6.863181257162147e-02   +2.707203516060263e-02   +9.215365604495677e-02   -8.285118849978972e-02   +8.357153198931327e-02   +9.892315286479328e-02   +8.169335615027667e-02   +3.992665324707932e-02; -4.079732283689541e-03   -3.065298635243829e-02   -8.181775747574661e-03   -4.607625363300699e-02   -5.376482019563197e-04   -4.446233875193138e-03   +1.418620251369365e-01   -2.338766502629206e-02   +2.570387890488927e-02; +4.484582221617267e-02   +8.455969665115523e-02   -6.964291712488577e-02   +7.376344105300960e-02   -8.916684415885168e-02   +6.167594802470124e-02   +5.172509013355055e-02   +2.042641722791212e-02   +6.590901053160719e-02; +2.310052989797105e-02   +4.146242686108423e-02   +1.244946119391167e-01   +1.004045991027613e-01   -4.444432104520511e-02   +2.201167501088949e-02   -1.613565540259165e-02   -1.429893832454422e-01   +6.261115541117529e-02; -8.805448464556574e-02   +9.604619919210201e-03   +5.949382219374844e-02   -1.890455916583407e-02   +1.191753591540685e-02   +4.417290261583946e-02   +6.466864772424812e-02   -5.543894788997782e-02   +1.184828086628970e-01; -4.516673421463996e-02   +1.542303774297689e-03   -4.110354194521465e-02   -1.937428642204585e-02   -1.869224880844982e-02   -2.489259548085693e-02   +4.312689053510375e-02   +4.306470680320335e-02   -1.680699689204889e-02];
L1_L2_iAMPA_netcon = [-5.778673842613621e-02   -7.857968184094741e-02   +1.256584395436246e-02   -2.466137845036764e-02   +1.896226410518019e-02   -8.193723238953077e-02   +4.833001531782951e-03   -3.441761608501849e-03   +2.376118591635143e-02; +6.359645464851377e-02   -3.453042118939267e-02   +1.360399145864318e-02   -6.579023196132693e-02   -1.427317264872898e-02   -7.764329930980110e-03   -1.121789796353085e-01   -1.024067051811397e-01   -1.028884136351423e-01; -3.315683555228838e-02   -8.937697473143910e-02   -8.957989557745080e-02   +2.950622273280689e-02   +9.427117296728446e-02   +1.131446676081563e-01   -2.225155763609482e-02   +9.177875993568466e-02   +9.623871200214751e-02; -7.110484064379336e-03   -1.871497751529141e-02   +8.444986775531076e-02   +7.343180694406151e-02   -2.711312488421224e-02   -1.130036889790017e-01   -1.267041234020329e-01   -3.860425270252729e-02   +1.815436289976254e-02; +2.878712886540950e-02   -6.917925988763189e-02   -1.312381904149600e-02   +1.445219358642211e-01   +4.070937267873709e-03   +2.421866724958814e-02   +4.549677820124184e-02   -5.941729258150959e-02   -4.142305651192519e-02; +9.213178511035930e-02   +6.055612691146184e-02   -1.374077867613598e-01   +2.035901354993952e-02   +2.661289030217157e-02   -4.243109442673942e-02   +7.581648306590222e-03   +7.805970694780014e-02   +8.489268073063558e-02; +7.037191440091452e-02   +8.883579463528808e-02   -9.341257572567063e-02   -8.812846625618578e-02   +7.412255886833478e-02   -4.639172022076252e-02   -6.131527444489099e-02   +6.787237533549167e-02   +1.918969116459062e-02; +1.352063469531409e-01   +1.347784461563977e-01   +2.336347532174463e-02   +3.355196947815499e-02   +2.742112177458347e-02   +9.144578319009586e-02   +7.165449255466255e-02   +6.911604398276738e-03   -6.048095149629559e-02; +1.653983953568933e-01   +6.169725312558989e-02   +1.332797352896119e-02   -5.650971205566244e-02   +4.141716760899967e-02   -3.370486961790993e-02   +1.730278514763319e-02   +8.484657452431757e-03   -5.931719438758174e-02];
L2_L5_iAMPA_netcon = [+4.433918532696114e-02   -1.099536750414240e-01   -1.112659478604860e-01   -3.934063962654530e-02   -6.467882221262959e-02   +1.195149697734899e-02   +4.794835923369782e-03   +7.803627745218251e-02   -7.128265515803849e-02; +1.187374814681516e-01   +5.813724642536724e-02   -6.984464784188410e-02   -6.406785303659498e-02   +9.317071040155937e-02   -3.278194192891137e-02   -9.200716877317644e-02   +7.475177268202297e-02   -5.411796646568498e-02; +1.270863139269496e-01   +1.011686014129733e-01   +2.562623727570581e-02   +8.860132759678571e-02   +3.100332134491075e-02   -6.181482137350362e-02   -3.598055980804393e-02   -8.067362705225781e-02   +1.624809677164994e-02; -2.480625770504217e-02   -2.156412064575970e-02   +1.436035769050308e-01   -3.042752884759339e-02   +7.395980676677405e-02   +2.042753232872669e-02   -7.910639638150310e-02   -9.753763803510339e-02   +2.673102918008003e-02; +1.328070651583515e-01   +4.766707431604834e-02   -2.170479616697091e-02   -1.664562984981324e-02   +3.366158827773249e-02   +4.756936998308820e-02   +5.131443435443773e-02   -4.531772761409989e-02   +2.877542381617200e-02; -8.070706177888336e-02   +2.081425376726738e-02   +5.684231298604801e-02   -6.773834537212570e-02   -3.191728202928437e-02   -4.573405857331208e-02   +1.332194641311808e-01   +8.413971595226644e-02   +6.363927725315972e-02];
L5_L2_iGABA_netcon = [-3.150982283582347e-02   -2.233426032327256e-02   +1.899855387205213e-03   -9.569867269553423e-02   +9.449401738554415e-02   +1.798568654199405e-02; +1.359988848641249e-01   -1.053342804011086e-01   +5.977303060092026e-02   +5.615190186785649e-03   -4.597006359856162e-02   -1.073705973985703e-01; -1.368019623216087e-03   -7.731502175094741e-02   +3.214635151311247e-02   +1.122504899622283e-01   -9.057478566154403e-02   -1.565318452227583e-02; -7.501881984818898e-02   +5.827305112675971e-02   -2.643040402532105e-02   +1.685931873232909e-01   -5.792537947569754e-02   +1.901595753605432e-02; +2.666212957316360e-02   -5.958736382248014e-03   +1.003163382347118e-01   -6.645187526487913e-02   -1.143382593704704e-01   +4.185349328611457e-02; -9.054343878243887e-03   +7.746256736852662e-02   +2.883660474385946e-03   +1.611499489984317e-02   -9.856593185044903e-02   -4.435507223634909e-02; -9.758239864588862e-02   -7.246956096227769e-02   +9.635732102366916e-02   +4.352147672717078e-02   -5.753993758382241e-02   -1.527092471083166e-02; +1.061478347337055e-01   -1.040422205072828e-01   +4.083672275386779e-02   +7.634620871338972e-02   +6.919508962560778e-02   +7.428840366289341e-02; +9.639424731391497e-03   -1.678944966784184e-02   +4.985678460169207e-02   +7.449592522019576e-02   -4.003357330024070e-02   -9.428394228123544e-03];
L3_L2_iAMPA_netcon = [-1.789036724419700e-02   +4.001624451821946e-02   +1.154264667509509e-01   -6.069775821196884e-02   -6.397267781827368e-02   +2.131659590047202e-02; +2.663409303391601e-02   +1.217856708409176e-01   +3.242053938406956e-02   +6.606520800010876e-04   +6.961668771456450e-02   +1.391631351796009e-01; +2.521796593473988e-02   +7.758106805455270e-03   +4.859833326029348e-02   +6.483081551937114e-02   +1.037011700011041e-01   +5.050880633310096e-02; +1.921581670672498e-02   +1.463704583724951e-01   -8.029363200379140e-03   +3.539345347561587e-02   +1.090622958384909e-01   +9.320688166523707e-02; -1.470365998314183e-01   -1.675435113692843e-02   +9.707832218805626e-02   +6.752154759658173e-02   -1.103710901865454e-01   +7.641604855791061e-03; -1.693933702130964e-02   +3.278786727126683e-02   -3.467507688237272e-03   -1.506936226586008e-01   +6.902237986308750e-02   +4.025599728079281e-02; -3.728893238126401e-02   -7.344993564471254e-02   -5.098321680390320e-02   -3.500660545152538e-02   +2.200776416624864e-02   -9.443631204773364e-02; -6.006838255896921e-02   +3.064287983537833e-02   -1.354873309472353e-01   -4.145049539208117e-02   +1.124171864913717e-01   +2.595212833105084e-02; -3.540876486923517e-02   +4.508975446575226e-02   +8.674391102003125e-03   +6.413709955483869e-02   +2.944008387845120e-02   +1.077081834799410e-02];
L2_L3_iGABA_netcon = [+8.349789500057342e-02   -1.291108314262955e-02   +8.983710559232974e-02   -2.009897101078373e-02   +1.974025121160240e-02   +1.331000988683393e-01   -7.538272105375134e-02   -3.581979065819518e-02   +7.188005904886811e-02; -6.919091540501636e-02   -1.054079301172857e-02   -4.540414433832809e-02   +3.497338863202881e-02   -6.831118814055848e-02   +3.268283846573383e-02   -1.964015432760440e-02   +2.324933431866203e-02   +9.460244177770690e-03; +9.571172585576962e-02   -1.038678741273874e-01   +1.647595632306218e-03   -2.400443545731918e-02   -1.282651601745030e-01   +1.640646488274640e-01   -1.284293625263014e-01   +3.822387516389687e-03   -8.493278216474782e-02; +7.032710685011080e-02   +7.996205593920983e-02   -1.436232176396848e-01   -6.557890767218929e-04   +3.486505635026075e-02   +6.569567520925028e-02   +1.635693743418571e-02   +9.624848044118586e-02   -5.496501282608848e-02; -8.118242859524846e-02   +2.453492188182692e-02   -1.051687214053993e-01   -1.167058805891204e-01   +1.797915054460293e-02   +2.928722582100493e-02   +6.705971405143725e-02   -9.092946055315559e-02   -1.392474061406600e-01; +1.083120902495311e-01   +6.339387347346817e-02   -4.688842688973364e-02   +1.253506218043816e-02   +3.439981032378544e-02   +1.599132980368558e-01   +5.590268923712357e-02   +1.015178006184402e-01   -6.784264030355248e-03];
L1_L4_iGABA_netcon = [-5.924846068961508e-02   -5.011297293334415e-02   +8.081487858642339e-02   +8.924113092038007e-03   +8.661746189774262e-02   -1.027916847218422e-01   +3.714742090809569e-02   -2.385120555958790e-02   -6.994924021145957e-02; -2.606267760176361e-02   -2.967751646757806e-02   -3.948439528163264e-02   -2.890634527047232e-02   +5.467250906388983e-02   +6.847635616734667e-02   -5.012794260804711e-02   -4.369942137445832e-02   -4.819059646074392e-02; -4.838992460313293e-02   -2.194291051101241e-02   -1.072709113045075e-01   +3.286107462406116e-02   -1.965995213129613e-02   -1.070449137742060e-02   -4.644955013258901e-02   +2.030951533409445e-02   -1.182153754005305e-01; +7.254411708621672e-02   -6.658631291390059e-02   -8.305895886780536e-02   +9.056318080217444e-02   -4.783579821849922e-02   -1.392026710608046e-02   -2.462196324679954e-02   -4.464405853740811e-02   +1.444708133920709e-03; -7.421318980680608e-02   -5.842527974913123e-03   -5.284284615605016e-02   -4.378966393071337e-02   -5.900515287349885e-02   +3.272294722753897e-02   -5.859114694676176e-02   +6.332269364600834e-02   +7.276045494238040e-02; +1.004227487554731e-01   +3.273338200806560e-02   +6.658418144560667e-02   -3.860032701870722e-02   +8.240128202597619e-02   -2.753779435598024e-02   -6.364649407905053e-02   +1.080260218351786e-01   -1.423079404598161e-02; +3.457559960531798e-02   +9.315807191448902e-02   +2.248083961739111e-02   +4.165889502599790e-04   +1.011528532918600e-02   +8.542906279637355e-02   -7.047028996851525e-02   +7.650287681732326e-02   -2.038507234645805e-02; +9.836721687337223e-02   -1.322258233608290e-02   -5.118185701655287e-03   +5.877934560647442e-02   +4.055758228530096e-02   +3.744765717211405e-02   -4.060903296831382e-03   +1.010122805232124e-02   +9.364878719903592e-02; -1.406502991084631e-01   -6.752693465829142e-02   -4.013194115487365e-02   -2.612095106024682e-02   -2.590965350696546e-02   +2.290674748174315e-02   -5.673342048366601e-02   -1.261461850872035e-01   +7.009335542819535e-02; +5.708370584675775e-02   +7.286079278498614e-02   +6.370759040023358e-02   -3.500296566219568e-02   -1.655298469879420e-02   +7.728308082005551e-02   -1.365034874922554e-01   +6.301181888803174e-02   -8.511918970090823e-02; -2.673152405681868e-02   -2.060717900718301e-02   -4.642079426156181e-02   +6.392570658450249e-02   +7.579093121529817e-02   -6.929425538830640e-02   +2.061239720693924e-02   +4.211224837411441e-02   +1.200419699961391e-01; +8.998446893097116e-02   -9.238591189269821e-02   -2.898443124337659e-02   +2.788435944586874e-02   -3.606556276253513e-02   +7.702293160739215e-02   +7.707622824272560e-02   -7.176177137304178e-02   -4.184764485179218e-02];
L4_L1_iAMPA_netcon = [+3.343853387420011e-02   -3.795465991199150e-02   +3.190285771715562e-02   +5.738724441450267e-02   -4.761610076690011e-02   +2.257387937810709e-02   -2.142767712131309e-05   +7.909759424252473e-02   +1.448978055373222e-01   -8.362371951721737e-02   -9.393068662596583e-02   +2.353074681117356e-02; +3.322532909302233e-02   +7.194774916550205e-02   -4.370697635924621e-02   +3.925988473913471e-02   +1.283350089577962e-02   -4.662378647235306e-02   -7.397158970712514e-02   +8.359880330418271e-02   +5.989254375626009e-02   +1.544921922638636e-01   +8.954333577628548e-02   -1.159789788437418e-01; -9.636838708248388e-02   +9.365102931326053e-02   +6.522667400579223e-02   +1.525705595189488e-02   -3.708762770151016e-02   +9.000597897418415e-02   -1.412882595820899e-02   +5.673049464526157e-02   +8.750191634388353e-02   -4.115115946619212e-02   +3.660935513054023e-02   +7.516366879905016e-02; -2.665902645262225e-02   +1.018032694589126e-01   -4.795855041774544e-02   -4.317923404618676e-03   -5.644458231853808e-02   -7.080931738705804e-02   +1.553763722160683e-04   -1.285265747775134e-02   +1.701406838473753e-02   +2.913638424742673e-02   +8.571581754811419e-02   -6.903303826321398e-04; +1.206948141487461e-01   +9.170754086508218e-02   -5.640730774903405e-02   +1.131200286809659e-01   -1.128367913111361e-03   +9.675700018405139e-04   +1.288326509513551e-02   +6.358082691664146e-02   +7.078957774105084e-02   +5.374715614918456e-02   -1.764148071111827e-02   -4.862930365706560e-02; +3.542979471253786e-02   +1.166482624341243e-02   -2.713246322880033e-02   +2.511085536659295e-02   -2.756398529980569e-02   -4.635289741226511e-02   +7.292229292713311e-02   +7.194269964777378e-02   +3.257403426829956e-02   +5.371407866015438e-02   +2.764176113653857e-02   +1.101261594347752e-01; +4.062225630397889e-02   +1.391304209976899e-03   -3.509532201889851e-04   -4.786275966444324e-02   +9.242586696347418e-02   +7.548207142681174e-02   +6.614204736162743e-02   +4.291409769650088e-02   -3.914802187743246e-02   -5.757092763266627e-02   -8.223882393975417e-02   -2.626938107077987e-02; -1.333285733299788e-02   +1.173475787804043e-01   -9.093646030348072e-02   -9.795538542326931e-02   -4.498925566540506e-02   +2.769957362268254e-02   -2.375233188497452e-02   +7.637025622246010e-02   -1.815070634318268e-01   +9.504329030971466e-02   +1.499851141165973e-01   -3.121764700551906e-03; +1.009206437827485e-01   +1.946034755571981e-02   -1.057333169928867e-01   +1.255713284755121e-01   -1.978596373012763e-02   -8.735681088970304e-02   +7.563466713431043e-02   +6.697245383632758e-02   -1.073379136966460e-01   -8.101411601409365e-02   +9.510511928715011e-02   -2.922577929290191e-02];
L1_L3_iAMPA_netcon = [-4.810193883284577e-02   -4.739709385282782e-02   -6.052088027321536e-02   +7.506312620719499e-02   -6.688784720040444e-02   -2.981646120553875e-02   +1.466771854438977e-02   -7.650655730790827e-02   -6.460616661822075e-02; -3.442708928595865e-02   +3.712347154870586e-02   -1.785719439787422e-03   -2.877889234863276e-02   -5.498088491374030e-02   -1.574067390079700e-01   +3.831668716784108e-04   +2.653493326669625e-02   +6.113499174797041e-02; +1.435899695764777e-02   +2.478538519601225e-02   -7.469477942754169e-03   -1.312523574773087e-02   -6.420226478726118e-02   +1.073958385403832e-01   +7.175981396454260e-02   +6.111409674222126e-02   +6.976580648132141e-04; -3.643379985187842e-02   +6.925097603815737e-02   -2.866116701893754e-03   -2.972700330260581e-04   +6.776166831717421e-02   -6.500006734861084e-02   +4.606973856769234e-03   +2.445715393781960e-02   -3.373352682567320e-03; -8.561917760489074e-02   +9.671959314705948e-02   +2.284849341744418e-02   -2.409225181613843e-02   +5.036031499824479e-02   -3.100128130833903e-02   -5.481342061391017e-02   -1.270405411530983e-01   +1.116164181820491e-01; -2.631025256495914e-02   +1.995594091769295e-02   -2.601186243465102e-02   -5.489572708668823e-02   +6.274437174630190e-02   +2.680492257369595e-02   -1.499220339828536e-02   +7.122850886847833e-02   +3.806557092886011e-02];
L3_L1_iGABA_netcon = [-6.119978839913387e-02   +4.736852786915145e-02   +8.311310244243490e-02   -8.465744526255712e-03   -7.483738186480224e-02   +7.453786537523105e-03; +2.259792813462493e-02   +7.608785352310950e-02   +9.377697463331558e-02   +2.062972164522055e-03   +9.704421742468138e-02   -4.531900526716127e-02; +1.039437880050822e-01   +7.541882626171235e-02   -2.164107171852464e-02   +5.597523014876277e-02   +2.414218906928744e-02   -3.732284209710488e-02; +1.993471378890730e-02   +3.310269946341415e-02   -1.192664992633924e-01   -9.127527263150306e-02   +7.973535294557681e-02   -2.405297827209837e-02; +1.134980238002495e-01   +8.186212020946959e-03   -5.237754365383068e-02   +1.375946179860065e-03   -9.089417897784206e-02   -4.122108776291279e-02; +5.240605265772070e-04   -7.878192806441052e-03   -3.753817372863801e-02   +1.500120200464440e-03   -1.064628553698009e-01   +5.718651403683241e-02; -7.821889341780758e-02   +1.071433332734769e-01   +6.199534791086216e-02   +6.543491414565641e-02   -1.423473639917178e-02   -3.064827550382509e-02; +2.057208853237298e-03   +8.383176210771574e-02   +9.399052590666847e-02   -4.189327939222161e-02   +1.196364034692043e-02   +7.514886231277086e-02; -3.409091116562613e-02   -6.945036180669789e-02   +2.543635609822186e-02   +1.386674554149083e-02   +2.528053296017019e-02   +5.193440317454064e-03];
L5_Input1_iAMPA_netcon = [-4.018500576207800e-02   -4.374144338819828e-02   -5.209797037183953e-02   +6.592632681334142e-02   -1.641022345629605e-02   -7.619364672959800e-02];
L6_Input2_iAMPA_netcon = [-1.053480352661813e-01   -6.480911554544941e-02   -1.982739146240405e-02   +1.164979407086179e-01   +7.058835231493800e-02   -2.522477843618039e-02];
L5_L6_iAMPA_netcon = [-8.925475460366888e-02   +1.076614568837389e-01   +9.469286721562893e-02   -5.551092394896355e-02   +4.506091210241955e-02   +7.801176279303837e-02; -7.370494153862900e-02   +1.117312984644265e-01   +3.622476968774135e-02   +1.095685201510313e-01   +3.586867994976720e-02   +8.025396017509735e-02; -7.246455176813196e-02   +6.681341632535574e-02   -6.852112046589161e-02   +9.114612733102302e-02   -4.514355911625503e-02   -9.522583552980472e-02; +1.279480180400391e-01   -7.388812338469183e-02   -2.473975530137588e-02   -7.907077951430405e-02   -4.999652588211093e-02   -3.689317996387920e-03; +1.739951691354267e-01   -7.469483497705308e-02   +5.561755819177117e-02   -2.008061841027934e-02   +3.802397933654084e-02   -3.781625666796958e-03; +2.017789767633587e-02   -1.967828721279751e-02   +7.193069921255496e-02   +1.544536640926556e-01   -7.293386015880598e-03   +1.369633448642665e-01];
L4_L5_iGABA_netcon = [+5.110075207160955e-02   -2.631211518477397e-02   +7.319096568700682e-02   -8.595826250363116e-02   +4.381622861072583e-03   +4.804086481953662e-02   +2.540129642131974e-02   +1.064340143654948e-01   -1.516121576374527e-02   -7.215442135266099e-02   +5.503156523062964e-02   -6.585709041779150e-02; -3.354210859325914e-02   -7.235701484942396e-02   -2.119959180241058e-02   -5.788078751108733e-02   +8.204907650436338e-02   +7.291594313862411e-02   -8.929050408370537e-02   -1.073731747622039e-01   +1.814298438569717e-02   -1.014760494768124e-01   -1.279511882015103e-01   +6.498632599066646e-02; -8.090844236884120e-02   +8.886366246010996e-02   -2.053589297072050e-02   +6.440092616259362e-02   +1.096071633548448e-01   +6.903228481458014e-02   -1.673092655454969e-02   -6.119105199295968e-02   +1.094050239216837e-02   +1.652773165068826e-02   +8.151692576608301e-02   +7.112305894110103e-02; +1.118733334606944e-01   -3.948633711277107e-02   +1.592023737871994e-01   +1.409973572433164e-01   -4.814217956925777e-02   +1.063571892256841e-01   +7.104276206961499e-02   -6.646489766297561e-02   +3.632536739943736e-02   +1.765003715419016e-02   -7.306542809670492e-02   +4.642958603693612e-02; -6.313700982737222e-02   -2.056071535544184e-02   -5.008551302491803e-02   -7.948157136433565e-02   -1.106085290310631e-02   -1.581225914180552e-03   -1.105051795826069e-01   -3.919445439376629e-02   -1.169315991165097e-01   -6.892347115053955e-02   -1.994807309742946e-02   +4.349059699681920e-02; -2.639378619273912e-02   +1.337211882273308e-03   -2.913340936387269e-02   -3.081415747789695e-02   -8.411081642336520e-02   -1.553096705996167e-02   -3.004032887449165e-02   -1.519340394169289e-02   +7.939547193533712e-02   -6.731131764682356e-02   +3.031615176513609e-02   -3.082205683555301e-02];
L6_L4_iAMPA_netcon = [+1.106216763468120e-01   +4.152230918377830e-02   -1.241995479415207e-01   -9.640519446940619e-02   -2.150071119511925e-03   +4.869086852311056e-02; -4.375704570808729e-02   +6.532674320360808e-02   -2.703913934942817e-02   +5.648020021923792e-02   -8.273260435794313e-02   +2.626556821552001e-02; +1.131886560574839e-01   +2.527359916816904e-02   +8.022639726277296e-02   -1.770721900005188e-02   -8.818594045156011e-02   -6.802792976445793e-02; -3.521493527704497e-02   -1.932564460304346e-03   +1.192703777874534e-01   +1.155565346282709e-01   -2.111730521886107e-02   +7.279061991407690e-03; -1.063588357802701e-01   +7.622274143046401e-02   -4.012781118693781e-02   -1.017883115400993e-03   +1.409139765926154e-01   -2.951787898031141e-02; +5.408829272091490e-02   -6.421144680086469e-02   -1.982684504187877e-02   +2.740379606399670e-03   +5.881236100918689e-02   +1.107760569624139e-02; +3.070679065798489e-02   +1.257750852348801e-02   -9.243528664460640e-02   -1.033203413808036e-01   -8.670004259108932e-03   -1.330312337947688e-02; +2.653413609574183e-03   -2.272736617580178e-02   +8.326326362264287e-02   -2.064878341863284e-03   -1.125098440673080e-02   -3.489645888313830e-02; -8.086834839451293e-02   +2.376469133650695e-02   -8.197692300042556e-02   -3.648307468232442e-02   -1.753673675154184e-02   -5.808971083207370e-03; +6.977832076886011e-02   -9.743096748689185e-02   +4.800676525927411e-02   -5.750141945330989e-02   +8.166900571079193e-02   -4.689266069259241e-02; +3.251243830333361e-02   -7.747345492061841e-02   +4.115032757734436e-02   -1.006056852759179e-01   +1.243889010276659e-01   +1.908959818451931e-01; +5.711602259128770e-03   -8.039600772232144e-03   +3.774289529899965e-02   +3.517686402278060e-02   +1.630493084121755e-02   +3.721988202973212e-02];
L5_L4_iAMPA_netcon = [-5.348907775117695e-04   -5.080463505332525e-02   +5.948428636997417e-02   +3.600612287670224e-02   -4.171290049548201e-02   -6.581112677864348e-02; -1.000115355992226e-01   -6.748095331187752e-02   +8.072137986448931e-02   +9.864608776279775e-03   -1.232751135015264e-01   +4.477865062392394e-02; +1.255403598924948e-01   +2.876333186755124e-02   +1.002032305986572e-01   -9.762613615711636e-02   -4.815287717710627e-02   +2.922293597442311e-02; +2.099483238004386e-02   -5.283167128680115e-02   +4.911291976490009e-02   -1.584440398186406e-02   +2.128334598793427e-02   -1.571128183664521e-02; -4.767592414360519e-02   -2.180365660205640e-02   -2.355350240907767e-02   -1.092322549386768e-01   +8.706320496968392e-02   -2.009820873716428e-02; -5.874119622136079e-02   -4.027537994044100e-03   +1.350063758625751e-01   +2.761288372811162e-02   +1.059005540183266e-02   +4.671659778725743e-02; -6.914050845150761e-02   +1.578919827720024e-01   +3.167586723704103e-02   -7.361004021753420e-03   +6.098633659378110e-02   -6.108384098862529e-02; -4.045469813355681e-02   +7.276498504175855e-02   +9.423347461588319e-02   -5.709525573001776e-02   +4.888336046974118e-02   +2.392991595840964e-02; +9.296124506313166e-02   +7.152115999309969e-02   -4.316960851052615e-02   +5.596922731551577e-02   -4.906346915582414e-02   -1.037675326338817e-02; -1.418825805166172e-02   +4.391911793014013e-02   -2.082693893516388e-02   -3.936617735648195e-02   +1.705160366252232e-02   +5.169620870343174e-02; +5.201426436043749e-02   +6.255738295094224e-02   -2.721509756875232e-02   +2.616389799525987e-02   -8.033183879837263e-02   +7.409791306571840e-02; +1.539491073507231e-01   -4.438728484769530e-02   +1.646770615928160e-02   -1.991100103217925e-02   +8.321037590574225e-02   +4.672568171469961e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
