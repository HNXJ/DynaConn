function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.176519789279588e-01   -1.876732516997737e-02   +3.407402216203883e-01   +3.835105272396158e-01   +3.761241468621747e-01   -1.360430195539412e-01   +3.173284303186260e-01   -1.684816227569896e-01   +5.855654389959155e-01; +2.163269235585780e-01   +6.941941609967230e-01   +3.364175999911074e-01   +4.716646511911358e-01   +7.927721643468980e-02   +3.360242340548842e-01   +2.886536620525192e-01   +3.056472261319537e-01   +3.541027249114226e-01; +1.507792212900863e-01   +1.131596931806862e-01   +2.419932704011191e-01   +6.334489666613109e-01   +3.597638318772296e-02   -1.841681592502950e-01   +2.725445699041973e-01   +2.347816007242969e-01   +3.198414634094284e-01; +2.017894534393913e-01   +5.991308839759621e-01   +7.314199783917916e-01   +4.756870900483580e-01   +6.627343533132836e-01   +5.536872305552414e-01   +2.910088674724290e-01   +2.400487884101893e-01   +4.006681959474591e-01; -1.251984952745094e-02   +5.275622613703892e-01   +5.690495688950434e-01   +2.563206903831530e-01   +7.279119060429362e-02   +5.421160654522038e-01   +3.424198309157442e-01   +5.192168951446259e-01   +4.958294585908137e-02; +6.475546038835259e-01   +4.146886636151479e-01   -5.375357982115728e-02   +3.537721110785610e-01   -9.291910718808066e-02   +4.691143833248209e-01   +5.080619949874778e-01   +3.835299899667589e-01   +4.284528640872994e-01; +8.967555901606828e-01   +5.869766877155014e-01   -2.650781329441933e-02   +3.579085121722112e-01   +5.308448398767762e-03   +5.219714407407552e-01   +1.261398023787947e-01   +3.429648921220585e-01   +2.534855164542761e-01; -1.212073115683241e-01   +4.438950952060896e-01   +5.120782795197220e-01   +2.800986945466569e-01   +6.322958482889716e-01   -3.158315185709267e-01   +1.726855052521915e-01   +2.102595807111120e-01   +5.175099656464198e-01; +2.001330578404360e-02   -1.649273841227701e-02   +6.970532856816415e-02   +4.072933220726771e-01   -1.193357666472975e-01   +1.984086660849749e-01   +6.985478536413164e-01   +2.762141371901350e-02   +5.009829245056250e-01];
L1_L2_iAMPA_netcon = [+5.772799159472128e-02   -2.357157416498689e-01   -2.310415416272110e-01   +4.708948665779379e-01   -1.459109946399774e-02   -2.130648210424073e-01   +6.521077285208925e-01   -5.492667014818900e-02   +5.904737488483141e-01; +4.198481865683358e-01   +6.375966576295871e-01   +4.175552716900832e-01   +2.294150760895138e-01   +5.502422739527925e-01   +3.697115619817796e-01   +1.281578999856109e-01   +5.880055799413209e-01   +6.153538889638164e-02; +4.701335547134757e-01   -2.856652092927860e-01   +4.263257875823416e-01   +5.223608861131178e-01   +1.600983485215969e-01   +3.811535451192802e-01   -2.600759858400028e-01   +1.985496948404009e-01   +6.565318047219113e-01; +2.968141896073736e-01   +1.357838561989787e-01   +5.606867970030531e-01   +8.409207578996840e-01   +5.468333293799429e-02   -8.810641562139808e-02   +4.695656923852183e-01   -3.333181709005861e-02   -1.659494494137742e-02; +2.053079495415304e-01   +8.043365807954554e-01   +1.335280372023606e-01   +3.296231421915806e-01   +1.027670021690882e-01   +5.958860449280564e-01   -2.117875602504985e-02   -2.013975361163452e-01   +1.213056901287103e-01; +2.973100533966843e-01   +6.527668711620529e-01   +3.139763160853475e-01   +4.028806824762682e-01   +2.139151427426022e-01   +4.643586229008280e-01   +8.961306478745705e-01   +6.639592006942446e-01   +2.220686660808056e-02; -6.208315348708769e-02   +1.966161051768412e-01   +1.345515839340842e-01   +2.632534739288022e-01   +3.915869851745726e-01   +2.983840233182655e-01   +4.662602285568402e-01   +5.733572640026469e-01   +5.487004461362095e-03; +1.202014409961640e-01   -3.033490895358337e-02   +2.781933070263412e-01   +4.704493953687644e-01   +2.902454419401999e-02   +2.378703168371978e-01   +4.428275205422096e-01   +3.619033072183176e-01   -1.088677681272318e-01; +4.694149830326075e-01   +1.701678062175976e-01   +1.634965357830844e-01   +6.169320074880743e-01   -1.999192667840926e-01   -2.537742929113211e-01   +5.219042606801093e-01   +2.702011319435026e-01   +8.232590268432080e-01];
L2_L5_iAMPA_netcon = [+3.570929671184744e-01   -2.503499502652531e-02   +4.487764832036176e-02   +1.290432581729653e-01   +7.873144289428367e-01   -1.682661062063773e-01   +3.570909199848830e-01   +4.416000591235068e-01   +1.727034937349476e-01; -6.878976628691023e-03   +4.868371785387677e-01   +8.487542786028137e-01   +5.616841321112108e-01   -2.824026934446917e-01   +3.489254928496783e-01   +9.491115687289688e-02   +5.620706036114701e-01   +6.517072804921187e-01; +3.976372648610925e-01   +3.028980518003820e-01   +6.323297648320529e-01   +3.372580250084873e-01   +9.332867539789418e-01   -1.470707385543066e-02   +4.044033490547250e-01   +2.829564008479037e-01   +3.476374701134741e-01; +3.522171281189936e-01   +7.761367547952243e-01   +5.177920554015960e-01   -6.041636524990903e-02   +2.460273635266170e-01   +5.516958448156193e-01   -1.473243319194670e-02   +3.098844879502603e-01   +4.806026409449561e-01; +4.266518881135937e-01   +6.935123642966828e-01   +5.388863397162073e-01   +7.967086097239597e-01   +4.745523263779732e-01   +1.191527474008342e-01   +8.536821362770176e-01   -1.095651802307721e-01   +8.382428858388583e-01; +6.392819655233882e-01   +4.520665039044905e-01   +5.047469638342283e-01   -2.586581488310651e-01   +2.276756584744860e-01   +5.200483965323726e-01   +8.669163564803555e-01   +3.225340629218896e-01   +5.630904406517279e-01];
L5_L2_iGABA_netcon = [+2.653965184152380e-01   +5.691613815119130e-01   +4.303546089553077e-01   +6.879968855962084e-01   +9.434407212563620e-02   +1.188414454501878e-02; +6.319874904409528e-01   -2.618929791769992e-02   -2.000054065612586e-01   +5.018975340768662e-01   +2.862930609347596e-01   -1.429559742546925e-01; +1.726384344052964e-01   +4.292098108615174e-01   +8.240999858753559e-01   +5.676765477853436e-01   +5.223159293722309e-01   +5.412431043968227e-01; +5.058411806512426e-01   -4.600903586684209e-02   +3.209482277822137e-01   +7.219107813052900e-01   -1.774053501492867e-01   +2.000010658851723e-01; +1.236676790029173e-03   -1.139626606409248e-01   +1.764605249953227e-01   +2.607894618012721e-01   +7.044605078770320e-01   +3.026943131933715e-01; +2.597685178269771e-01   +1.751669834795444e-01   +5.247199344017017e-01   +3.212748524900540e-01   -1.793097892323142e-01   +4.665119519296737e-01; -4.328231454313572e-02   +2.159931657379331e-01   +1.473553019539058e-01   +5.459259133221172e-01   +1.489747886356353e-01   +5.312017935591622e-02; -1.031271012190629e-01   +1.482350275538181e-01   +6.971616211307542e-01   +5.404902479892630e-01   +4.146057392128726e-01   +8.479973304767070e-01; +6.611542839968373e-01   -6.448758984361366e-02   +4.725956853144923e-01   +8.634976832960092e-03   +2.701992773267687e-01   +1.510736384760762e-01];
L3_L2_iAMPA_netcon = [+7.020767095757011e-01   +2.559570108340612e-01   +3.551038429785435e-01   +3.984892387052185e-01   +3.225516960413488e-01   +3.183216016287892e-01; +2.428365872502778e-01   +7.660524069928937e-01   +4.362402627386768e-01   +2.865285844064422e-01   +6.635010928741898e-01   +9.649150478150981e-01; +6.257703269560758e-01   +5.571597854125285e-02   +4.242903555582888e-01   +3.274169819968917e-02   +2.626715943773014e-02   +3.661663642244196e-01; +7.210245148792348e-01   +2.288957117324118e-01   +1.394181111372099e-01   +9.479373858574447e-02   +3.777654688103575e-01   +1.831597656408539e-01; +1.358535509169134e-01   +3.542602133961508e-01   +3.730237520317493e-01   +4.745493124977281e-01   +9.909322812205325e-02   +4.548775520291403e-01; +2.518989951100726e-01   +4.302603672843112e-01   +4.024486697761856e-01   +5.903077383314325e-01   +7.011087898780036e-01   +4.755829924227076e-02; +2.476374947618874e-01   +4.869294142304131e-02   +2.112435407716009e-01   +3.581145320450468e-01   +6.772552037236623e-01   +4.536964657563536e-04; +2.158311775639460e-01   +4.283571749505776e-01   +9.734529527198149e-02   +3.842914782744311e-01   +6.461949253715173e-01   +5.776984169434699e-02; +3.974295900060546e-02   +7.315283369376022e-02   -3.962966725631242e-02   +6.268103778188989e-01   +8.501582242865046e-01   -5.057396288067881e-02];
L2_L3_iGABA_netcon = [+2.301446139508921e-01   +3.513309308397723e-01   +6.374509625022522e-01   +4.125177108652501e-01   +8.286957461007723e-01   -2.433946053773353e-02   +5.894874856470285e-01   +6.550854335790677e-01   +2.652525185221211e-01; +3.431444678831096e-01   -1.732734123944117e-01   +3.790095068031783e-01   +1.705582636847154e-01   +2.331177001199869e-01   +3.821818267449545e-01   +5.897248119308326e-01   +4.639776258399159e-01   +4.908209077629508e-02; +2.964434010323727e-01   +6.034543382315430e-01   +6.326866473370113e-01   +4.892824929989946e-01   -8.143665460859850e-02   +4.339102226425164e-01   +2.057431460346093e-04   +2.775201314954229e-02   +6.254276641126322e-01; +1.989287551078315e-01   +2.540453183195139e-01   +5.568845412597926e-01   +1.066293388712720e-01   +1.884969905727138e-01   -2.761712701333958e-01   +2.492573368925808e-01   +6.493913558267264e-01   +4.933749943611156e-03; +2.293132347260007e-01   +8.099232574727706e-01   +2.897544620442415e-01   +6.713041557610109e-01   +2.086348420429140e-01   +5.753888524833387e-01   +4.121059438660697e-01   +8.788929463209930e-02   +3.121256178124252e-01; +4.314138474512544e-01   +6.517087711638924e-01   -8.914285382891013e-02   +1.774547875701466e-01   +2.622214974686268e-01   +3.488240034225373e-01   +5.562552323106119e-01   +1.954186569834283e-01   +4.359832856936744e-01];
L1_L4_iGABA_netcon = [+3.536896958883801e-01   -1.868404245160115e-01   +2.561914263786498e-01   +5.313326860504006e-01   +2.079244972862304e-01   +4.983761197869404e-01   +2.808469285406037e-01   +6.328907552443968e-01   +1.507726338843584e-01; +1.828969402509861e-01   +4.571907063893983e-01   +3.146973205820188e-01   -7.605347020806286e-03   +3.364663101271322e-01   +1.776800560567806e-01   +2.210788299924716e-01   +3.900166237175930e-01   +1.523716871377230e-02; +4.242461349182685e-01   +6.046852169792104e-01   -2.170381042670493e-01   +5.700908270820696e-01   +1.685714546948419e-02   -4.194833153798357e-02   +5.239988471576388e-01   +6.432661076849361e-01   +4.571820420860503e-01; +4.550605559590599e-01   +2.748547736303640e-01   +2.414514732945831e-01   +5.398076438239789e-01   +8.367149438280369e-02   +2.263257934432758e-01   +7.302874023946965e-01   +4.386442783363983e-01   +2.985098145151047e-01; +5.789346082722472e-01   +1.138882255769466e-01   +3.985264716701928e-01   +1.977197747103583e-01   +9.071423595073633e-02   +2.060055742730965e-01   +7.350509349473351e-02   +6.752678612968551e-01   +1.085202035362093e-01; +4.936566948435835e-01   -1.368772838597513e-01   +1.582730146441705e-01   -7.664877954289934e-02   +1.467252323838067e-01   +8.164425280761380e-01   +4.236502475425755e-02   +6.455320358358219e-01   +7.012302335997109e-01; +2.684017050059828e-01   +6.494409396484218e-01   +4.308151782272404e-02   +6.980992574491813e-01   +6.054172732263403e-01   -1.298763006398204e-01   -1.985749551408146e-01   +3.895628115009739e-01   +4.936760912662612e-01; +5.792424183795029e-01   +1.268852291268168e-01   +6.177953744743664e-01   +5.018032212714005e-01   +3.965492961880701e-01   +2.973557588960368e-01   +4.255293016841889e-01   +5.394686903632364e-01   +4.277564077241735e-01; +3.934518679995243e-01   +3.277879558913791e-01   +5.469598066809023e-01   +3.692713441111807e-01   +1.963247519391033e-01   +5.004368211099012e-01   +7.949053621936238e-02   +6.516286665954603e-01   +4.194021928386954e-01; +7.037772116632131e-01   +2.995578856364335e-01   +2.252259720357143e-01   +7.239647201192009e-02   +2.510846270848686e-01   +2.414587881067952e-01   +2.030374236530896e-01   +4.427496811930982e-01   +2.821261133791393e-01; -1.902741451049970e-02   +2.736271646826032e-03   +3.742846231034244e-01   -7.369479567108178e-03   +2.403094986122317e-01   +4.278852809616968e-01   +6.435299264428926e-02   -1.789739497596031e-01   +9.692350746079921e-01; +5.260125501921002e-01   +2.006040702490982e-01   +5.022208877634261e-01   +5.474337162089086e-01   +7.738685998680541e-01   +3.866415274214465e-01   +7.253149586316830e-01   +4.581185526524648e-02   -4.334376004971198e-02];
L4_L1_iAMPA_netcon = [+5.058604735406784e-01   +1.077902629785564e-01   -3.522676451017148e-02   +4.152672470908963e-01   +2.790139206609266e-02   +1.523825950377460e-01   +6.497012701953199e-01   +5.569337947388924e-01   +4.370399997972859e-01   +5.906493020760037e-01   +1.445769086231416e-01   -3.942181726781037e-02; +2.002595539765936e-01   +8.094429632121165e-02   +3.550529504446061e-01   +1.935127533993353e-01   +7.163084984729594e-01   +5.764829450680745e-01   +2.354271970438670e-01   -1.077465075442369e-01   +6.210492491230268e-02   +9.105867497253467e-01   -1.115628906362647e-01   +3.377613410163489e-02; +4.409456755536758e-01   +2.567553956598461e-01   +6.146545960911386e-01   -1.992288490993077e-01   +4.920305221990399e-01   +2.702327398815187e-01   +7.106706312675986e-01   +4.253205510561281e-02   +1.102196241580721e-01   +2.762739366071512e-01   +5.456706134469630e-01   +5.664544378722456e-01; +7.721048123380326e-01   +7.775440797128055e-01   +3.172960846101783e-01   +5.356348092982551e-01   +2.568728494313596e-01   +5.458073445859024e-01   +2.782868249906059e-01   +2.946831113497944e-01   +6.268549161214365e-01   +6.411867774277301e-02   +2.382017706602599e-01   +6.503585398798840e-01; +4.252452775428784e-01   -5.810090419570975e-02   +8.927692544928906e-02   +1.145269134681478e-01   +1.793577867047997e-01   +4.165820475969680e-01   +3.892568171678698e-01   +3.556608967875931e-01   +5.681927706170053e-01   +1.533329735389801e-01   -6.214125360120439e-02   +6.444194580782603e-01; +1.102902484904754e-01   +2.913334485636513e-01   -7.904082154042008e-04   +2.026660218386805e-01   +6.670266655858447e-01   -9.398856346170342e-02   -2.599374241905292e-01   +6.069977277299102e-01   +7.460986472662315e-01   +6.247684806391522e-01   +3.876161347072662e-01   +7.537364100391588e-01; +1.166898694132512e-01   +6.357176573639453e-01   +4.351130261875613e-01   +5.440003885607470e-02   -3.769924647709820e-02   +3.075027270132870e-01   -1.449234135685728e-01   +1.969521077897557e-01   +3.972631988134411e-01   +2.342870263812066e-01   +3.141488590778402e-01   +3.670002377695959e-01; +6.590786894378265e-01   +2.966823184475362e-01   -8.013060664454889e-02   +2.310034369472217e-01   +5.718248626299816e-02   +1.496529607239270e-01   +6.182169232124224e-01   -3.544369323239856e-02   +6.947459397299532e-02   +1.660118196328028e-01   +3.750972301396298e-01   +5.776775365362784e-01; +3.327912799238630e-01   -3.581910164366939e-02   +4.787348348309493e-01   -1.234376544423821e-01   -1.416862271496195e-01   +5.632691134056264e-01   +2.486128668922397e-01   +3.125020140846048e-01   +4.969677048382911e-01   +1.003420104452531e-02   +5.165836499223886e-01   +1.640840024231309e-01];
L1_L3_iAMPA_netcon = [+2.706081645281402e-01   +2.010715971239016e-01   +6.726478447155156e-01   +2.898347667858010e-01   -5.694209398057848e-02   +1.194377462706993e-01   +2.337777892868207e-01   +6.539405433549432e-01   +4.918023988399719e-01; +3.744027287539332e-01   +3.624655025347803e-01   +4.363852908982925e-01   +2.248587488129966e-01   +1.468725199500800e-01   +1.841466316444204e-01   +2.868005429665366e-03   +2.589079046559672e-01   +5.601207824927663e-01; +6.239041573425300e-01   +2.681449458519622e-01   +2.773543867923732e-01   +5.102866331645707e-02   +4.202517288853210e-01   +6.060556756666526e-02   +5.474863645910828e-01   +2.693319005866672e-01   +3.491093330530198e-01; +1.713559487554658e-01   +2.690995854165162e-01   +4.384981233017673e-01   +5.480329739857258e-01   -1.971404423817802e-02   +2.836740588632330e-01   +3.229301454972761e-01   +3.597306003286556e-01   +4.201122181126435e-01; +8.564339054901784e-01   -1.094492848969188e-01   +2.040047325027913e-01   +3.293070205731634e-01   +4.557350811879478e-01   +5.663863830217777e-01   +7.424733532728224e-02   +2.085857558298788e-01   +6.399608692507679e-01; -1.669393752209430e-03   +1.811305955167099e-01   +5.778104864993456e-01   +2.954156296856800e-01   +7.069239195070420e-02   +5.017144488393506e-01   +6.754267053569392e-01   +2.621931824854465e-01   +4.556854052118570e-01];
L3_L1_iGABA_netcon = [+5.198509582899294e-01   +2.372863413865067e-01   +6.436607905939201e-01   +5.378902040486907e-01   +2.427635951123572e-01   +6.162201160665781e-01; -3.660513974564369e-02   +4.059598052851910e-01   +1.407418067302058e-01   +1.752309497913223e-01   +1.230155242646907e-02   +7.602976240114148e-02; +1.177357542018960e-01   +7.747774484805696e-01   +2.349806044771444e-01   +4.916834756875703e-01   +2.286086808368920e-01   +5.393555058885524e-01; +6.418590650110093e-01   +3.997708768798048e-01   +3.481725293147047e-01   -3.386015502279663e-01   +3.751778115068672e-01   +3.713017573463703e-01; +4.066285910669474e-01   +2.710170708490858e-01   +4.510127511828284e-01   +4.142980676002677e-01   +3.607753705467238e-01   +6.003415413624000e-01; +4.348865969861537e-01   +5.744830284863395e-01   +7.237362497516775e-03   +7.088141979128604e-01   +3.301923649192752e-01   +2.643629284922482e-01; +2.797638868457891e-01   +2.425587755871345e-03   +1.064253918480073e-01   +2.856643764881955e-01   +3.070389513334820e-01   +1.339138999910497e-02; +6.066428631483021e-01   +5.786436775038188e-01   +4.291954004618119e-01   +5.516817429519818e-01   +2.813174684301825e-01   +1.483563235559411e-01; +1.938955495526907e-01   +3.372829129607274e-02   +2.534650106927465e-01   +5.830309131384827e-01   +4.711163519859357e-02   -1.233332751844928e-01];
L5_Input1_iAMPA_netcon = [+6.345761355671506e-01   +7.345355617430294e-02   +1.238902462119439e-01   +5.929626236855476e-01   +3.247849375783161e-01   -8.162403096775353e-02];
L6_Input2_iAMPA_netcon = [+3.526294650596294e-01   +2.281353720009904e-01   +1.770273228424440e-01   +2.305443050609808e-01   +4.240387580520489e-01   +4.753501374421670e-01];
L5_L6_iAMPA_netcon = [+3.652577883891387e-01   +3.139345635003327e-01   +1.784325391229669e-01   +1.019687734615853e-01   +1.610217850413909e-01   +4.815083816635613e-01; +9.437903360397620e-02   +5.431336185024266e-01   +5.746211252816309e-01   +7.476065389536992e-01   +5.201328480625385e-01   +3.928470869931817e-01; +8.701451524208495e-03   +2.268020553172789e-01   +4.251893735635683e-01   +6.573551700372579e-01   +5.085366451911547e-01   +3.722809056671131e-02; +2.905957484091186e-01   +4.376658309444188e-01   +6.579754350634753e-01   -5.862300098077654e-02   +1.718155968969806e-02   +7.289829161069084e-02; +3.962908899197759e-01   -7.117123731137116e-02   +5.781481423645652e-01   +3.328233758479267e-01   +4.113384604839092e-01   +3.508444493170575e-01; +3.324926851019315e-01   +2.938633450256052e-01   -1.582224447811565e-01   +5.404416040772656e-01   -2.267019882851595e-01   +8.276568179626593e-01];
L4_L5_iGABA_netcon = [+3.232436093662395e-01   +2.827317169294328e-01   +5.428534488054302e-01   +5.374416078494620e-02   +2.596935748198313e-01   +1.371537218474329e-01   +3.181398840779412e-01   +5.422332529338532e-01   -1.363578600267283e-01   +6.228995279473943e-01   +5.496254082310961e-01   +3.800590282897804e-01; +4.071465173365794e-01   +5.548934391083883e-01   +3.827972433137071e-01   +6.486276901669513e-02   +8.757234711211987e-01   +8.206232279221274e-01   +2.899988174327645e-01   +6.522800757640461e-01   +5.053366992329452e-01   +1.500789736292893e-01   +6.840525148077866e-01   +2.118993421060609e-01; +1.871705900510989e-01   +8.624189293038534e-01   +3.830912849371405e-01   +3.598969372871861e-01   +1.110132316320621e-02   +3.584667962072449e-01   +7.430789654767305e-01   -3.514444223406750e-02   -1.500279700488474e-01   +2.220634246175587e-01   +1.041487780594525e-01   +1.630486381180947e-01; +2.465214298797986e-01   +1.126448043191837e-01   +3.482134780179412e-01   +5.115526419309362e-01   -6.866975250120876e-02   +8.696556705584548e-01   +1.045113914000888e-01   +2.424943667860295e-01   +3.180277146113308e-01   +1.195585244220917e-01   +2.478033726776555e-01   +3.673855208747672e-01; +3.468732258652502e-01   +2.007266824732176e-01   +3.560801610846545e-01   +3.840881342290817e-02   +5.234747967978828e-01   +3.093118505298934e-01   +5.791095137852121e-01   +2.639421747274804e-01   +2.082160602407274e-01   +3.918141193232832e-01   +4.954990725054841e-01   +6.514138570799146e-01; +6.981525084571778e-01   +4.900037581015444e-01   +5.337969109409189e-01   +3.665637105811183e-01   +2.630778699612119e-03   +5.957095695567960e-01   -3.957921611526526e-02   +4.621856970335441e-01   +2.119872499507471e-01   +3.264189674593968e-01   +3.614811648406455e-01   +3.584372600677305e-01];
L6_L4_iAMPA_netcon = [+5.784262290875685e-01   +3.666787102611291e-01   +2.314563869612158e-01   +4.343554481173326e-01   +3.231740039771371e-01   +3.893372500441136e-02; +3.893922976879860e-01   +3.564216054290145e-01   +2.718490920351623e-01   +1.865580139100334e-02   +6.179850682484465e-02   +2.378228171456756e-01; -2.793305599925607e-02   +8.607564851921540e-02   +2.531772844435109e-01   +8.805971242829933e-01   +3.768438534864144e-01   +6.054202593364457e-01; +4.829490918111122e-01   +3.319340979161846e-01   +3.493739454246111e-01   +6.517512035998108e-01   +4.276462347733613e-01   +6.924050960568244e-01; +6.802270523239140e-02   +3.097891486800877e-01   +2.119360626759698e-01   +4.773581016093505e-01   +5.162885785404328e-01   +1.457060544241595e-01; +5.072513718462874e-01   +3.643326186040045e-01   +3.636125290788901e-01   +2.107665901280653e-01   +1.700644148054911e-01   +5.460690973579262e-01; +1.927598535721073e-01   +2.989427802557312e-01   +4.313961475549578e-02   +4.238325249172679e-01   +2.957605210488572e-01   +3.219480262013678e-01; +6.595538518161129e-01   +4.320621789686508e-01   +5.266998549266118e-01   +5.309607917433274e-01   -1.226246165260199e-02   +2.542426798654658e-01; +3.078024581446670e-01   +1.175910220579373e-01   +2.672028396443407e-01   +4.228366350452948e-01   +6.022016344432463e-01   +2.045156289665359e-01; +2.595859208686795e-01   +5.396867345375428e-01   +2.649720356539006e-01   +2.385128299665265e-01   +7.160054236676601e-01   +4.146565457708614e-01; +6.433633784553226e-02   -9.269726802661613e-02   +4.072743395738160e-01   +3.734484645640910e-01   +2.909480051240492e-01   +2.883132222994014e-01; +3.279078406161401e-01   +3.390956358913452e-02   +1.726194563723475e-01   +2.109367761795659e-01   -2.827767962764807e-03   +3.806739288159687e-01];
L5_L4_iAMPA_netcon = [+1.503566964062915e-01   +2.882783833745383e-01   -6.977968684051093e-02   +6.502415065376907e-01   +2.690025064859803e-01   +2.176663992706831e-01; +1.959552956730374e-01   +3.624424442919562e-01   -1.425623503165943e-01   +7.575386492563162e-02   +1.212394519509387e-01   +6.255367866813979e-01; +2.379215179281831e-01   +5.254018882883906e-01   -1.416907414585716e-01   +5.906424866834417e-01   -1.709333490374990e-01   +2.315027049891377e-02; +4.764042684289210e-01   +1.802863904004718e-01   +5.353814645010798e-01   +4.735599686351608e-01   +8.313900686385209e-02   -1.374648641509374e-02; +3.989305381607857e-01   -4.701649647516169e-02   +3.169970648238463e-01   +3.025428093008947e-01   +2.472139098572383e-01   +1.817054548574527e-01; +6.150156977738379e-01   +2.137625629142643e-01   +4.844273203544390e-01   +7.156147078517177e-01   +4.110859696358746e-01   +1.730919221219711e-01; +7.677483221698223e-01   +6.236322247397769e-01   +8.768639183818294e-01   +1.727488292402131e-01   +7.046018395913247e-01   +2.828883862360093e-02; +4.572405222403644e-01   +7.450546547020176e-01   +4.357989706077601e-01   -5.792553711199434e-02   +1.953651775792559e-01   +5.613333845487166e-01; +1.349370190650222e-01   +6.482526614861794e-02   +1.605295641424703e-01   +3.300860003829735e-01   -3.422308458358450e-01   -2.004987779496489e-02; +2.869216210974093e-01   +1.869803752733581e-01   +1.676208174432438e-01   +1.950332118246538e-01   +1.786979859981924e-01   +1.806305005612189e-01; +1.810276022283050e-01   +3.039512270428318e-01   +5.075688126050931e-01   +7.579919453727363e-02   +1.562801671499763e-01   +3.925853348529781e-01; +9.845825771329642e-01   +3.084658764210532e-01   +4.529128989609872e-01   +9.730016123990066e-02   +3.614148704813871e-01   +1.383673403759083e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
