function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.321211471083199e-02   +1.004345979107754e-01   -2.226215334595800e-02   -4.231987454141958e-01   -1.856272301393459e-01   -6.881044550013091e-02   -6.172953448522295e-01   -4.718154471796709e-01   -5.886424170008832e-01; -1.342300209669970e-01   -3.347570445525073e-01   -3.036171952648234e-01   -3.463990292837381e-01   -3.009370055258554e-01   -5.070107220239281e-02   -3.871857716182836e-01   -2.916393020061927e-01   -2.217950155806220e-01; -3.537690779285958e-01   -1.231841594383342e-01   -1.770048384784394e-01   -7.144352297670433e-01   -3.562425468982163e-01   -2.917014909011361e-02   -3.783499089313224e-01   +1.781333353044426e-02   -4.447537602477852e-01; -1.920552082819488e-01   -1.171448158375505e-01   -2.029480474067160e-01   -2.171605578542082e-01   +5.643527161257961e-02   -1.000208623604424e-01   -4.377288505470104e-01   -9.443117648870215e-02   -2.335642373767327e-01; -2.320868796612998e-01   -3.849641005871762e-01   -2.852039086527665e-02   +1.773863458685798e-01   -2.735895150017095e-04   -3.634609953885274e-01   -9.122283007199278e-03   -5.544270382155305e-01   -3.632736534292472e-01; -6.341695761094975e-02   -1.318628052817786e-02   -1.079462552009336e-01   -2.887831703811840e-01   -6.548370805252750e-02   -2.512123727118986e-01   -5.141520773809324e-01   -2.846228664684979e-01   +1.378809059854996e-01; -1.256373284350429e-01   -3.161106398450226e-01   -3.634773027138823e-01   -3.632443644976550e-01   -6.635694722380067e-01   -3.624838398604794e-01   -7.980196174957707e-02   -3.784456191439495e-01   -3.179459894546826e-01; -3.706629500978269e-01   -5.313329580127782e-01   -5.120706489950717e-01   -2.872173544625248e-01   -2.255517808507380e-01   +2.424545732422639e-01   -3.676912702591086e-01   -5.932007876109515e-01   -2.269903443568102e-01; -5.623856929374695e-01   +3.965687078228898e-02   -3.908276432189571e-03   -2.416781855539842e-01   -4.285279651856803e-01   +7.728659352062980e-02   -3.599979399285611e-02   -3.510835850310685e-01   -3.986383823496996e-01];
L1_L2_iAMPA_netcon = [-4.013605051998462e-02   -3.033831203380841e-01   -4.065684912034822e-01   -1.807884659884088e-01   -5.940273516446478e-01   -1.703860142679804e-01   -2.127767818453306e-01   -2.072859287344124e-01   -9.121320429623930e-02; +9.961536631432487e-02   -4.309677771652959e-01   -4.014404348304892e-02   -8.509983911836616e-02   -1.360477694141571e-01   -4.497317640716237e-01   -1.383394276343893e-01   -3.367340210684380e-01   +2.750183281022764e-01; -2.035303383200245e-01   +4.050005047075010e-02   -1.820577523843070e-01   -1.561428251652758e-02   -4.889777950449095e-02   -4.642644287170608e-01   -3.898256511891350e-01   -2.971847380254702e-01   -1.967240365101851e-01; -1.056809389187628e-01   -3.356997987325522e-01   -4.320802035160478e-01   -3.781612218103296e-01   -1.811593787455683e-01   -2.194390586307619e-01   -4.336447465689618e-01   -4.320242405064981e-01   -4.793783933085379e-01; -4.142980920411259e-01   -3.589162611213912e-01   -2.484137693898698e-01   -3.026035227207593e-01   -1.870588262338621e-01   -2.201624243823640e-01   -1.236645057811107e-01   -2.027681577522858e-01   -3.871163114395430e-01; -6.559938927270825e-01   -2.706527751722544e-01   -5.949890541143926e-01   +2.859212537104191e-01   -2.745438400811515e-01   -6.467275377565342e-01   +1.978406598107262e-02   -2.546426853838540e-01   -2.476518114385544e-01; -4.148100635035458e-01   -2.725557553488585e-01   -6.853500352590469e-04   +2.382085140774177e-01   -2.330605259950110e-01   -3.079176219702162e-01   -3.638375060719644e-01   -1.711365625850949e-01   -7.223193619687733e-02; +8.255617687275549e-03   -7.547933048456185e-02   -2.572503519808598e-01   -1.957001849981758e-01   -1.242709923076639e-02   +6.517388332425428e-02   -1.344720428412672e-02   +2.609980089657484e-01   -2.489673703053336e-01; -5.972033995450121e-01   -5.011447072593218e-01   -2.023060626957553e-01   -4.357722275210757e-01   +8.946516932610751e-02   -4.318101637878315e-01   -6.982133813887008e-03   -2.979948723926057e-01   -1.587368128400252e-01];
L2_L5_iAMPA_netcon = [-2.043057308258327e-01   +9.985132460083564e-02   -2.706937862642093e-01   +1.423407813184216e-02   -8.524821395293572e-02   -2.130823003344994e-01   -3.820145840298923e-01   -7.307646337348141e-02   -3.415025179062156e-01; +7.673598088448133e-02   -4.198579803642628e-01   -4.085802774096109e-01   +7.394693793953402e-02   -5.531105784048922e-01   -5.834115673849840e-01   -2.341557036486726e-01   -5.111650767417920e-02   -2.025159925701900e-01; -1.899433686248887e-01   -1.861991760067230e-01   -4.089211998201039e-01   -8.389547825064098e-02   -6.456139272781072e-02   +3.189684448459904e-01   -4.167939462618306e-02   -5.517667715189818e-01   -2.812868542197948e-01; +1.845560994718248e-02   -9.705967635365173e-03   +1.065086825490809e-01   +1.327908470621282e-01   -5.384606090613058e-01   +2.706814393149579e-02   -4.580419473222970e-01   -9.347517638024608e-02   -3.923341003018969e-01; -3.967584239271456e-01   -4.369967089227376e-01   -5.102613531924975e-01   -5.182060283549499e-01   -5.205943333837831e-01   -5.003380527117316e-01   -3.088895665230148e-01   -3.891160155956347e-01   -3.196052541761039e-01; -3.760520843639503e-01   -4.525471510058340e-01   -2.961354543972620e-01   +9.112392827685242e-02   -2.802200829633956e-01   -3.711513740176182e-02   -3.766954394403911e-01   -2.431634457767478e-01   +9.990320974369696e-02];
L5_L2_iGABA_netcon = [-2.798886294707750e-01   -2.553058068841922e-01   -5.837201030211592e-01   -2.209857587946866e-01   -3.989509131292453e-01   -2.156088839624667e-01; -1.899100175455469e-01   +6.015044525839383e-03   -3.381555629331457e-01   -4.380083047395497e-01   -3.931335715476480e-01   -1.334065492879341e-01; -3.627860526273244e-01   +3.835499829559721e-02   -4.324491408157264e-01   -9.469601377093767e-02   -6.362354442453071e-01   -1.762706243683492e-01; -1.014758005778992e-02   -1.327893295168669e-01   +9.006021957001371e-02   -2.455810307121276e-01   -4.694095582903923e-02   +1.814203274521525e-02; -3.206473443574075e-01   -3.112264463877250e-01   +9.482186246057310e-02   -1.073821751877998e-01   -3.354870575723891e-01   -4.913850006918123e-02; -2.752552764277182e-01   -2.369457730853010e-01   -1.896163649446470e-02   -3.184119562007275e-01   -1.135072387575414e-01   -4.145869737066377e-01; -2.001893285033015e-01   -2.664189461258131e-01   -4.494536575499056e-01   +4.157927918957630e-02   -1.029581078292892e-02   +2.394939364478314e-02; -4.173015618899610e-01   -2.461070040560778e-02   +1.113544510062222e-01   -3.149641774578971e-01   -1.801985328189402e-01   -1.541052355757383e-01; -2.204630598385859e-01   -6.739519431562673e-01   -5.048633008008814e-01   +7.325629623694312e-02   -2.118084691941366e-01   -1.518685489272300e-01];
L3_L2_iAMPA_netcon = [-3.586845845716030e-01   -3.349236325552964e-01   +7.057191328923912e-02   -6.471331501737330e-01   -1.665550143911983e-01   +2.046938982799593e-01; -2.178137809327869e-01   -4.571247792132467e-01   -1.657504351434423e-01   -1.407358991329412e-01   -3.169699071838327e-01   -2.848570383496908e-01; -3.080265500866101e-01   -4.776736554779488e-01   -3.716312746994918e-01   -5.295032734895426e-01   -1.715909459198789e-01   -2.696266639749893e-01; -2.130792170110206e-01   -3.206845108758757e-01   -4.068827710785822e-01   -1.983154220369159e-01   -6.431863377350786e-02   -2.365863489667382e-01; -1.411234832531075e-01   -3.106608067936597e-01   -3.544832042507872e-01   -1.407708514522986e-01   -6.217359363912481e-02   -4.064582758632853e-01; -6.328724529787353e-01   -2.697953145229681e-02   -1.157914109460224e-01   -7.191972980788928e-02   -4.430839940181996e-01   -3.545832701537773e-01; -2.707990486899687e-01   +2.722632662469744e-02   -5.854381962393842e-01   -4.890350387743242e-03   -2.777827050754479e-01   -4.084850283233663e-01; -7.147771084711647e-02   -1.950965376713974e-01   -1.947591735454727e-01   -5.962862156247943e-02   -2.578358558905129e-01   +8.377692831229395e-03; -6.472587005407195e-01   -1.692676139452287e-01   -2.607941212225959e-01   +1.206572062295915e-01   -2.039318861364383e-01   -4.501595040270643e-01];
L2_L3_iAMPA_netcon = [-2.225954721879700e-01   -1.527107929132254e-01   -2.937841430616023e-01   -6.270710021817100e-02   -4.728251789389343e-01   -6.181694773717336e-01   -4.602045999028743e-01   +2.224685318556537e-01   -1.883482745523970e-01; +2.061340103604927e-01   -5.635052957065294e-01   -3.915889688232095e-01   -3.105469226772603e-01   -1.639443435985445e-01   -2.394880683476992e-01   -1.384228301263694e-02   -3.462425430102943e-01   -3.175703059536090e-01; -2.188599967656356e-02   -3.212343360151030e-01   -2.988962718088399e-01   -3.132137181709436e-01   -4.729300597868927e-01   -3.512365933869845e-01   -2.486840982036916e-01   -1.064665039711500e-01   -1.182516456969938e-01; -2.963289879571765e-02   -4.317041169410570e-01   -2.412233042438983e-01   -1.577621368072956e-01   -2.261339608388478e-01   +1.726378445288307e-02   -4.474668171286852e-01   +6.967153023007869e-02   +1.089365459329404e-01; -1.054148623791487e-01   -5.395292782569080e-01   -4.102464213044745e-01   +1.044989624557281e-01   -4.663668320461247e-01   -8.501243858564281e-02   -2.195603971806791e-01   -1.604846123120109e-01   -5.919279968204598e-01; -1.254118281154794e-01   -3.482557743125660e-02   -3.417393565378061e-02   -3.288423393093530e-01   -8.998648033158392e-02   -5.058678674769169e-01   -5.926571700166059e-01   -7.403895306847973e-02   -2.716173472469685e-01];
L1_L4_iGABA_netcon = [-7.546456034923397e-01   -4.555016769966619e-02   -4.084653022922611e-01   -3.928085474125649e-01   -1.402924844344889e-01   -4.505120151244996e-01   -4.356828948139339e-01   -1.669879572785165e-01   -5.090330490600380e-02; +2.190624291497140e-01   -4.943971511904610e-01   -1.032104405932180e-02   -1.480972958506767e-01   -1.248884886552493e-01   -2.302376527015371e-01   -8.069070942102229e-02   -4.269758178808372e-01   -3.902444927021984e-01; -3.258997226500332e-01   -3.247341343402099e-01   -1.531691814767647e-01   -4.571929181272205e-01   -4.205622983698470e-01   -1.452694598338682e-02   -4.361676054596403e-01   +8.094814988383127e-02   -4.342342865685986e-02; -1.074073900671735e-01   -4.995864454870605e-01   -1.302659009697784e-01   -3.941205119843758e-01   -4.529293106395561e-01   +7.394324674744637e-02   -2.177304849416416e-01   -2.345767094275695e-01   +4.920349465020471e-02; -1.427808326023987e-01   -2.236635718233208e-01   -2.574994223542476e-01   -2.886845684152521e-01   -1.568661364140416e-01   -4.591630244009013e-01   -4.028059400788774e-01   -3.184835467732994e-01   -5.562721350103595e-01; -3.643797520593275e-01   -4.014598271826573e-01   -2.518356632470253e-01   -2.556538545810546e-01   -2.436891328128746e-01   -7.210465285455447e-02   -1.710682492958502e-01   -1.137197343267957e-01   -1.032077516791321e-01; -2.199613903181039e-01   -9.267458287246158e-02   -3.513603213774535e-01   +1.196281422207267e-02   +2.114406659604427e-01   -2.703486781248112e-01   -4.632203397701506e-02   -3.234373594300506e-01   -1.461301388653486e-01; -5.489422859161913e-01   -1.085628328518840e-02   +1.218908768447805e-01   -3.091933239789897e-01   -1.220060345183820e-01   -1.391733166382353e-01   -9.283874412425221e-02   -4.328024047896746e-01   -4.434496221072057e-01; -3.995025306220673e-01   -4.677966451204187e-01   +2.139554605468099e-01   -9.459757011736764e-02   -8.020660662510212e-02   -5.613318253908399e-02   -4.215448314348147e-01   -1.715257065143213e-01   -1.721384478567485e-01; -4.181071745824672e-01   -1.963034242772570e-02   -2.128145982071936e-01   -2.644227220497334e-01   -2.733858799319981e-01   -5.992377448442130e-01   -4.383624723953146e-01   -1.823955323648541e-01   +2.061746490207970e-01; -3.425160714383628e-01   +1.273720400002790e-01   -2.763303702053396e-02   -1.026918701954886e-01   -3.101392106078488e-01   -4.724420156429485e-01   -4.096995781488809e-02   -3.310014492246194e-01   -3.783195786233878e-01; -3.253769073866644e-01   -2.370433707115303e-01   -1.220941060490719e-01   -3.943201192308928e-01   -7.803935217018756e-02   +1.829251768796697e-01   -2.417233082128492e-01   -4.463998644305316e-01   -2.107715239856143e-01];
L4_L1_iGABA_netcon = [+2.037943967373695e-02   -2.387894229380927e-01   -3.551739455796452e-01   -3.205977660144271e-01   -1.459666964766162e-01   -5.456102991507989e-01   -4.585281676994871e-01   -3.442106404997510e-01   -9.206750438731351e-02   +3.026905158698953e-03   -1.649319336016280e-01   -1.222521507651148e-02; -1.612426631779740e-01   -4.712154263224986e-01   +7.472182769912933e-02   -5.519504517121358e-02   -5.143164980184267e-01   -1.120070170955645e-01   -4.112069182244715e-01   -5.495057280616393e-01   +4.710116446862010e-02   -3.981517340556381e-01   -2.943474790430809e-01   -2.904242668085089e-01; -1.783728128941876e-01   -6.979697869387029e-01   -1.795797204441182e-01   -3.871595224373271e-02   -1.991366286918129e-01   -2.961169943204526e-01   -3.385896353543768e-01   -3.530824918648322e-01   -1.400021602196126e-01   +4.767390375986241e-02   -3.882482793872484e-01   -1.801134484535655e-01; -3.601999490724635e-01   -4.963665506682353e-01   -2.104299170348811e-02   +4.231553708162888e-02   -1.016095619249747e-01   -3.358473700612653e-01   -3.245772729425156e-01   -2.582135333866943e-01   -8.652264140264655e-02   -1.792371531001865e-01   +6.282803129102371e-02   -3.849674022735176e-01; -5.494473056413254e-01   -3.122551816762570e-01   +1.527003139868940e-02   -1.211338688579323e-01   -3.655405297377813e-01   -3.448773594085899e-01   -5.747799302393593e-02   -1.076278812210872e-01   -3.996677654574907e-01   -3.346418269178066e-01   +8.959696687718771e-02   -2.649736553325998e-01; -4.872804950756897e-01   +4.378766948027261e-02   -3.660812731820950e-01   -1.384481827113759e-01   -2.057375338553376e-01   -3.501574595596657e-02   -1.845760836399081e-01   -1.290249864857923e-01   -3.522420330651569e-01   -2.993730105974883e-01   -4.770028273463300e-01   -6.774479006803498e-01; +2.802940825749124e-02   -3.806951073666938e-01   -1.294758441816524e-01   -4.889601401878683e-02   -3.530009478276057e-01   -1.122917369743702e-01   -4.149843629110188e-01   -6.595901564442653e-01   +3.252280382991628e-02   -1.849375394767150e-01   -3.076724350862102e-01   -3.783531833739314e-01; -4.022530756248152e-01   +6.097145658157746e-02   -3.110785447737802e-01   -5.903962178497802e-02   -2.809583430649115e-01   -5.331331829706345e-01   -1.962831066263554e-01   -4.329316088203006e-02   -1.085086610124265e-01   -1.406971204510173e-01   -4.719676514933655e-01   -1.870853120899555e-01; -5.706994219656253e-01   -4.206909689688608e-01   -2.233394351824823e-01   -5.234191488296086e-01   -2.525456408596197e-01   +3.032674893901804e-02   -3.047834382449014e-01   -5.269733299822501e-01   -1.450124582956571e-01   -1.211477037578561e-01   -1.345319012973432e-01   -2.450933886120508e-01];
L1_L3_iAMPA_netcon = [-1.816354266567828e-01   -1.366359762339647e-01   -4.832725216249688e-01   -4.713431553646412e-01   -5.704994892134183e-01   -4.182149371858555e-01   +7.689822459582520e-02   -3.762417833249112e-01   +1.654821308299761e-01; -3.817232598225774e-01   +1.297863614253260e-01   +2.135928216191878e-02   -4.242107429565295e-03   -2.484319152925813e-01   -1.745400356798205e-01   +6.184903934468677e-02   -4.237799690001779e-01   -3.053765121236218e-01; -1.557511499648903e-01   +3.324250656547179e-02   -1.947719876888346e-01   -6.075968679619521e-02   -1.807646976548362e-01   -5.657894328850185e-01   +1.441489621964785e-01   -5.155565232648854e-01   -1.694430913634906e-01; -1.557720757442622e-01   -2.350930666287362e-01   -2.581553623196459e-01   -3.854146240242078e-01   -3.295688463762269e-01   -7.356977451724747e-02   -3.611178884289699e-01   -4.428570114598878e-01   -2.170550930298788e-01; -3.422964094713000e-01   -2.387697606074157e-01   -1.999080709843793e-01   -1.341649934641611e-01   -4.378829903150767e-01   +1.564757071348417e-01   -4.682291624448875e-01   +9.127964861913163e-02   -3.350309880468496e-01; -4.726435165163745e-01   -3.250352227383091e-01   -2.385772128603730e-01   -2.466561196755365e-01   -2.934057306002339e-01   +1.690376634058738e-02   -3.502907517105051e-01   +4.940325999030881e-02   -5.052888165302414e-01];
L3_L1_iGABA_netcon = [-1.898274020491947e-01   -2.674480527831917e-01   -2.354078121904780e-01   -6.734122769745914e-01   +8.074787635195169e-02   -6.919098647024789e-01; -2.776155668450490e-01   -1.052957277571342e-01   -1.616785835123464e-01   -4.316368899239217e-01   -5.709672533490178e-01   -7.050652605364738e-01; -1.748840864294419e-01   -3.470809018389224e-01   -7.341983623547066e-02   +6.849340682731714e-02   -2.764240710655158e-01   -1.266491620770973e-01; -2.457912620929787e-01   -7.499454125877608e-02   -4.859821113199934e-01   -4.788513735674871e-01   -1.321278793598981e-01   -2.021384583588688e-01; -3.484299931383057e-01   -3.547663791671359e-01   -5.980719201000739e-01   +6.140419282039664e-02   -9.731292447506783e-02   -3.076610380703801e-01; -8.112403630025630e-02   -4.099017283370971e-01   -1.248207116620946e-01   +1.560465218438993e-01   +3.597366248238491e-02   +3.743782602143803e-02; -1.152109032161522e-01   -3.821767279225723e-02   -2.961349282354520e-01   -4.970996541916151e-01   -3.090909486515650e-02   -1.015974777177797e-01; -1.640932220980769e-01   -4.471334028149232e-01   -4.615659238082677e-01   -3.484785876498960e-01   -4.048635435354545e-01   -7.541915551830858e-02; -3.037125847818151e-01   -3.979646161676177e-01   -4.231594502679835e-01   +7.917948464452844e-02   -5.559648590516538e-01   -3.520308142094019e-01];
L5_Input1_iAMPA_netcon = [-1.988988468392928e-01   -2.039433150013379e-01   -2.476695755336633e-01   -5.488099248402935e-02   -4.177132719363107e-01   -6.932193280929774e-01];
L6_Input2_iAMPA_netcon = [-4.196469344174087e-01   -4.901931000879503e-01   -2.155695957145845e-01];
L5_L6_iAMPA_netcon = [-3.084172864228675e-01   -5.568312164728327e-01   -1.217699549168806e-01   -1.429486848168773e-01   -5.616634144605382e-01   -2.713319245046044e-02; -1.975936047707682e-01   -8.223716507179991e-03   -2.738366510802520e-01   -2.654779362078292e-01   -3.500928613369435e-01   -1.722456693750010e-01; -5.974579345472417e-01   -2.081526633817543e-01   +1.594603566901456e-01   +1.568121087547242e-02   -1.466906890736004e-01   -6.294515040696383e-02];
L4_L5_iAMPA_netcon = [-4.082975005759559e-01   -2.902821045343490e-01   -4.061141944887271e-01   -3.055790233799199e-01   -3.139577651762053e-01   -4.505529177881069e-01   +4.970944250677989e-02   -1.412123412033282e-01   -5.133429760489443e-01   -1.555173065313895e-01   -5.401503235679928e-01   -5.968305602262211e-01; -8.742379769440002e-02   -2.240931705039346e-02   +7.254348660515873e-02   -1.840904864570108e-01   -1.104659582271205e-01   -4.465641627260352e-01   -1.012964263807966e-01   +1.468927939092063e-01   -3.791779327056611e-01   -1.864257000496811e-01   -7.290273455223004e-01   -1.954521449173096e-01; +5.531008363546203e-02   -4.740852604510626e-01   -9.813690581475558e-02   -7.933345949195890e-02   -1.647865470354334e-01   -2.386280813312405e-01   -1.665824726373321e-01   -8.320263989608728e-02   -4.087689376272683e-01   -2.751025501173232e-01   -2.312866460013031e-01   -1.180849412171758e-02; +7.222617350148988e-02   -2.538690532028651e-01   -2.345163289911817e-01   -9.971878909822600e-02   -4.021484879968671e-01   -3.987331498538724e-01   -1.913901266308252e-01   -1.129679586156060e-01   -3.181500541471249e-01   -1.272878778217051e-01   -6.108029382650326e-01   -2.250800028223023e-01; -5.868205580954416e-02   -5.351717481440887e-02   -2.161282989251315e-01   -1.541709034320095e-01   -1.288651992553258e-01   +7.050672587581305e-02   -2.300017504106336e-01   -3.101160798347636e-01   -2.788546261358397e-01   -3.411411614466019e-01   +1.942710167338553e-01   +3.628972743742694e-01; -4.823091756332397e-01   -5.262647053458527e-01   -3.324579581465087e-01   -3.069728123691110e-01   -5.144218522249678e-01   -4.717029698095481e-01   +1.215585630582503e-01   -4.471310381548539e-02   +1.043131224110071e-01   -5.692913545191985e-01   -4.004714383419129e-01   -3.223223714843905e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
