function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.966318885929524e-01   -2.447128459677134e-01   -3.919289672347031e-01   -5.000786390433406e-01   -4.785442171821231e-01   -2.724334740434600e-01   -7.413756301777779e-01   -5.779774604312214e-01   -6.437406866291905e-01; -4.140683471012108e-01   -5.199438894946131e-01   -5.085685870867446e-01   -5.127738754872300e-01   -4.381501557978131e-01   -2.739570875768879e-01   -6.060837596845511e-01   -7.150573277704499e-01   -2.801179470840786e-01; -4.459098207099467e-01   -3.433913275667222e-01   -5.636057530877744e-01   -8.534931453532482e-01   -6.014580440034546e-01   -4.049968044475551e-01   -5.621776833143535e-01   -4.047816860795673e-01   -6.202797739023634e-01; -4.052509317874660e-01   -2.334953614742641e-01   -4.950707251216765e-01   -3.431794074438612e-01   -1.754266787871869e-01   -3.556492241389231e-01   -6.373048693431298e-01   -1.772164823533679e-01   -5.091432284796373e-01; -5.417782657851807e-01   -3.049147528141566e-01   -1.828052877987570e-01   -1.915845418305783e-01   -2.646699695388843e-01   -5.400645217968292e-01   -5.132916758185863e-01   -6.694241079990174e-01   -5.755353231078529e-01; -3.328460869750821e-01   -1.677332596536216e-01   -3.086509367250796e-01   -6.518182650564244e-01   -2.957287136687278e-01   -4.235459426569034e-01   -5.992360721578125e-01   -5.861969065553531e-01   -2.031671301350015e-01; -5.232406599465250e-01   -4.371590653035130e-01   -4.660957606397725e-01   -5.643344048096168e-01   -7.940916211236300e-01   -7.178633461563009e-01   -3.590069566629335e-01   -5.166571901316657e-01   -5.994495534447892e-01; -4.488079531168593e-01   -7.710031578865600e-01   -6.588247709555688e-01   -3.853229564803780e-01   -4.462094140359538e-01   -9.515420347814856e-02   -5.681627043680787e-01   -7.369470870550430e-01   -4.059449179084316e-01; -6.876291617272473e-01   -3.565777419152032e-01   -2.964357910491387e-01   -4.311745645550602e-01   -5.030593158689253e-01   -3.345839756308024e-02   -3.178939986689537e-01   -4.813089318616184e-01   -5.244727989240366e-01];
L1_L2_iAMPA_netcon = [-4.033124242819176e-01   -4.844587529466541e-01   -4.565491334528881e-01   -6.077444728905140e-01   -5.553819630409452e-01   -4.899381155713950e-01   -3.503038317400365e-01   -6.034619878324678e-01   -2.703741861692270e-01; -3.076804082462512e-01   -4.307955207991830e-01   -2.661684787425754e-01   -4.143155191525191e-01   -3.549605035842328e-01   -4.879254391466344e-01   -3.261338387095263e-01   -5.830392566911035e-01   -1.257456121301217e-01; -4.344544434813768e-01   -1.767517779642424e-01   -5.409426231944516e-01   -4.076751023876680e-01   -1.052751547443460e-01   -6.474223548285835e-01   -6.343676293263563e-01   -3.946691566290284e-01   -5.641431394513838e-01; -2.840544713451029e-01   -5.178033782700937e-01   -6.805405145043837e-01   -4.784635471008129e-01   -3.015661853491039e-01   -5.324837467000402e-01   -6.544118494656331e-01   -6.654097307925788e-01   -5.207615192716255e-01; -6.084767968522515e-01   -3.878617959203518e-01   -3.638883377961942e-01   -3.836356817660179e-01   -4.214463039738073e-01   -5.541121547303126e-01   -3.109710350608078e-01   -4.975340992098542e-01   -4.169971755263909e-01; -8.592514847428782e-01   -4.457426895847858e-01   -7.929532829381019e-01   +9.081493558865142e-02   -4.011783639410987e-01   -6.359253119602786e-01   -3.363997153688534e-01   -3.106794582282904e-01   -5.729547516810223e-01; -4.587646014976363e-01   -3.887354984091892e-01   -1.324947955199764e-01   -3.530609566727188e-01   -3.439339403940804e-01   -5.915288988143366e-01   -4.520924763169219e-01   -4.572225867622491e-01   -3.223387030012472e-01; -1.228631833932542e-01   -3.042217636908426e-01   -4.722412501829621e-01   -4.447239312744120e-01   -2.658886061227919e-01   -3.466929146373430e-01   -2.176550461672746e-01   -8.931083064363614e-02   -4.922160774102288e-01; -7.850660383441567e-01   -6.401765565933322e-01   -4.977342299406416e-01   -5.868690102530590e-01   -3.507922808348723e-02   -7.889122384153630e-01   -2.814898559625487e-01   -6.545959112451254e-01   -3.857840408158343e-01];
L2_L5_iAMPA_netcon = [-4.344258955463767e-01   -2.474407729712370e-01   -6.200092338091878e-01   -3.821442733669070e-01   -4.763768941931387e-01   -4.481875194337765e-01   -6.379772667312861e-01   -2.952560843841870e-01   -5.909063705538248e-01; -3.362716423045241e-01   -5.243096069666157e-01   -6.243860406618396e-01   -3.572096115643955e-01   -6.597347496654782e-01   -8.237028075681151e-01   -5.306218668159726e-01   -2.762472623435601e-01   -5.319667794932403e-01; -4.611038168997762e-01   -3.792199628312871e-01   -5.076498828262642e-01   -2.482339636487164e-01   -3.424023963842074e-01   -2.595283383752808e-02   -3.999117416875672e-01   -5.977161786542806e-01   -2.936534777949741e-01; -3.636993937108124e-01   -1.799413272944379e-01   -1.707897632875690e-01   -3.310416947824070e-01   -6.469015285209370e-01   -2.090459336047165e-01   -4.598992709257418e-01   -5.098807662879077e-01   -4.092886016016214e-01; -5.848291772748443e-01   -6.824883289712692e-01   -6.097553471003210e-01   -5.368941544212382e-01   -5.570831204414051e-01   -6.509892488809358e-01   -5.063064901202387e-01   -5.084986867286456e-01   -4.244309860748627e-01; -4.785758508934674e-01   -5.526679066416614e-01   -5.861068047917291e-01   -2.423476162143968e-01   -3.899095816583799e-01   -3.660924301104725e-01   -4.944558036680198e-01   -4.863201763877121e-01   -1.954111482883045e-01];
L5_L2_iGABA_netcon = [-4.755581555300230e-01   -4.336756605413833e-01   -7.980190110320465e-01   -5.157746588698359e-01   -5.654447978768838e-01   -4.430930474609406e-01; -5.404492287658097e-01   -3.599969738733791e-01   -5.489941752789689e-01   -6.194100298919973e-01   -4.894773216408544e-01   -4.888257646453768e-01; -4.185712821435540e-01   -2.192946035760616e-01   -4.964162823215162e-01   -3.791119538209410e-01   -8.083658484046712e-01   -4.496340929802900e-01; -1.803632824686497e-01   -3.736056074787916e-01   -1.233265037751174e-01   -3.392642264463926e-01   -1.943527248461071e-01   -3.915532730801882e-01; -4.350761881197512e-01   -3.662975580323099e-01   -3.357524710914992e-01   -4.356002546946188e-01   -6.470110264671659e-01   -2.803118929501514e-01; -3.032923520491238e-01   -3.782761260044571e-01   -1.862535271302780e-01   -5.990693141991160e-01   -4.820509439987585e-01   -7.295676428558325e-01; -3.048745059816123e-01   -4.805639601993489e-01   -4.769013270261235e-01   -3.632854945065379e-01   -1.869054725780362e-01   -1.696138406506746e-01; -6.756264962553130e-01   -2.381296689473112e-01   -1.793833747837346e-01   -4.567033077389505e-01   -3.893684693956310e-01   -5.029321337395444e-01; -5.566843452771061e-01   -7.064904250183497e-01   -5.914823982780564e-01   -2.879703881169426e-01   -2.900943305616211e-01   -4.342852089107495e-01];
L3_L2_iAMPA_netcon = [-5.278648495421822e-01   -6.135720496157774e-01   -2.573204128556772e-01   -7.960699342805009e-01   -4.346087729677596e-01   -6.337359387538911e-02; -2.727270563106418e-01   -6.248846989781444e-01   -5.800235920243523e-01   -4.311006218940523e-01   -4.711951637069721e-01   -4.187469238525846e-01; -4.957621730349737e-01   -4.489553983866892e-01   -3.997939197630228e-01   -6.809355577172076e-01   -5.141097014960246e-01   -4.573736970970154e-01; -3.873868646690481e-01   -5.384968734622280e-01   -5.044721256852993e-01   -4.418445334002018e-01   -3.184974811768364e-01   -4.427454154942586e-01; -3.974485435504424e-01   -4.846062843226310e-01   -3.823984511697308e-01   -4.744024996995628e-01   -3.169673280193444e-01   -3.670399458253863e-01; -6.442166818429872e-01   -3.383625174759726e-01   -4.349020080278146e-01   -3.316704130050998e-01   -5.284335919782028e-01   -4.642437258425553e-01; -4.727259087245422e-01   -2.926785984902812e-01   -7.451235361851766e-01   -3.382589457995783e-01   -5.347139668236636e-01   -5.572576126147966e-01; -3.403490030014634e-01   -4.848012495739032e-01   -4.697805329925013e-01   -4.078824015106318e-01   -4.434907197604055e-01   -2.278160033763013e-01; -7.407623180056366e-01   -4.655479808975045e-01   -5.979589308963893e-01   -2.932462628853772e-01   -4.188049394149347e-01   -5.382659488802253e-01];
L2_L3_iAMPA_netcon = [-4.425529524197475e-01   -3.280029905696075e-01   -4.955735733861803e-01   -3.771648389522025e-01   -4.990795818868131e-01   -7.261635019118597e-01   -4.215551561065440e-01   -7.883626552597781e-02   -2.543730594362839e-01; -2.196922158387620e-01   -6.084458903089106e-01   -4.457232267773801e-01   -4.737103044568560e-01   -3.680632874352237e-01   -5.787487996236931e-01   -4.568314794068318e-01   -4.279118257333403e-01   -4.968237087985408e-01; -2.019351515469709e-01   -5.669662625485141e-01   -4.661678652201065e-01   -3.901811675916598e-01   -3.678224698356758e-01   -7.228309973099833e-01   -4.723892531504494e-01   -3.849061778673494e-01   -5.937554504439893e-01; -2.308846499748861e-01   -5.648422495256138e-01   -5.412138165125013e-01   -4.250802038207911e-01   -4.031287889671684e-01   -5.051644202344944e-01   -7.346064121304505e-01   -8.089692125898629e-02   -5.756760339739548e-02; -2.945772854813579e-01   -6.994830755531071e-01   -5.582764189391982e-01   -2.631857729256225e-01   -4.720740350023049e-01   -3.014430939712917e-01   -5.038390773025484e-01   -3.570104130747332e-01   -6.197486666880041e-01; -1.793237263762948e-01   -1.762485856468774e-01   -2.085594960758085e-01   -5.369306687208039e-01   -2.823773419504575e-01   -5.671459738651470e-01   -7.797890330191759e-01   -3.590512398135440e-01   -7.104952486026678e-01];
L1_L4_iGABA_netcon = [-7.034155830663762e-01   -2.069611287443765e-01   -4.938522221011971e-01   -4.004721872873925e-01   -3.364975850909534e-01   -4.700250790702734e-01   -5.453897798234992e-01   -4.097339328745496e-01   -1.908030363821287e-01; -1.165329014178998e-01   -5.006598456941930e-01   -4.892514713928289e-01   -4.054190845032208e-01   -4.159527099411522e-01   -6.001373125820287e-01   -3.143879112927397e-01   -6.442593975161904e-01   -7.095464727408428e-01; -4.436763917251080e-01   -5.240801208826562e-01   -4.129044464406259e-01   -6.314987371040099e-01   -5.257671962464587e-01   -2.573636243947466e-01   -6.659511057419271e-01   -3.682368676093809e-01   -3.971535532215739e-01; -3.697429349583631e-01   -6.125750365777600e-01   -3.161093335742218e-01   -4.767062384269803e-01   -7.761514253553852e-01   -2.415846500465489e-01   -5.072643188782653e-01   -5.207823527504023e-01   -2.192506741373529e-01; -4.265741856712998e-01   -4.706931829462930e-01   -5.654302534994869e-01   -4.855094461118180e-01   -3.636617196736214e-01   -6.189041132040618e-01   -5.455782059396077e-01   -4.696826880965237e-01   -6.485728038735905e-01; -5.072317974920886e-01   -5.657879325992564e-01   -5.328819270371808e-01   -4.543628338233797e-01   -3.530376924945616e-01   -4.277100131990992e-01   -3.480451924714564e-01   -3.938718767552677e-01   -2.324484629369727e-01; -4.261760362245025e-01   -4.408553426929140e-01   -4.606719969488988e-01   -2.954893538085976e-01   -2.660308287771517e-01   -5.821344534589412e-01   -1.850217502036451e-01   -5.501955050062608e-01   -3.939415352047899e-01; -7.234679677386101e-01   -5.045651761409232e-01   -2.142744425213653e-01   -5.192450738671658e-01   -3.518909437104493e-01   -3.671804592062660e-01   -3.905320321980623e-01   -6.538982877525134e-01   -5.497856219975312e-01; -7.098483541035345e-01   -6.480277033677603e-01   -3.091963273653869e-01   -3.086244812665809e-01   -3.021284607781877e-01   -2.421657335058273e-01   -6.495635923257070e-01   -4.004703848285588e-01   -1.885427691036297e-01; -5.787462296099725e-01   -3.284698266370982e-01   -5.296718547373774e-01   -5.145850492088545e-01   -5.305786100587122e-01   -6.537313170088510e-01   -4.468117483266187e-01   -4.608922743906613e-01   -5.654835433705385e-03; -4.629156992007400e-01   -1.981848399632871e-01   -2.645382550394817e-01   -3.718840941708481e-01   -5.915254322898419e-01   -6.509175303137776e-01   -2.389408316624977e-01   -3.638708021786653e-01   -5.014294700297448e-01; -6.241124581226136e-01   -4.399754763481983e-01   -3.313473641620546e-01   -5.725735275995166e-01   -3.630271608193918e-01   -2.123965830439606e-01   -4.257677030928382e-01   -5.579308241560889e-01   -3.633949320602049e-01];
L4_L1_iGABA_netcon = [-2.397221763919810e-01   -4.206280500717097e-01   -7.137558551036802e-01   -5.826440685682067e-01   -3.586755034837604e-01   -6.666247066584741e-01   -5.966886232397046e-01   -5.054876721709567e-01   -3.363634465862503e-01   -2.907902478449228e-01   -4.695402272413217e-01   -4.331480672452194e-01; -2.566239060738484e-01   -6.144951409427494e-01   -2.742257124668930e-01   -3.739647402414988e-01   -6.527056281427360e-01   -4.089061404928498e-01   -4.681715458717792e-01   -7.183134411790283e-01   -8.582336475194879e-02   -3.857254745027768e-01   -5.624066401677060e-01   -4.756851173921234e-01; -3.589631072117340e-01   -7.330375693438367e-01   -4.995802672049335e-01   -2.836335058494294e-01   -5.403998820165413e-01   -5.162141713498469e-01   -5.704576178929261e-01   -5.116990545157968e-01   -3.908848765125036e-01   -3.671470315865331e-01   -5.739974666984429e-01   -4.140538139537610e-01; -6.410322445544826e-01   -7.247038396270055e-01   -2.838988677731419e-01   -3.927531933953662e-01   -5.299477325562701e-01   -5.725369800618185e-01   -3.316452678749984e-01   -3.862872229420020e-01   -3.835016732831732e-01   -5.159474296789804e-01   -7.319832175968058e-02   -5.645717821917707e-01; -6.141932440553277e-01   -4.334633754071818e-01   -4.042045774899090e-01   -3.961412587100657e-01   -5.035381275525138e-01   -4.939584355855883e-01   -2.276137326312109e-01   -5.039227148208975e-01   -5.019018234927494e-01   -3.907995051121201e-01   -1.195610197168020e-01   -5.178564531474024e-01; -4.619403798470254e-01   -2.162219989522988e-01   -4.708010866748786e-01   -3.843244052639732e-01   -5.969035324883329e-01   -2.999507902454130e-01   -4.142556150174048e-01   -3.253596010217674e-01   -6.772983720659044e-01   -5.011763420306549e-01   -4.197744241198616e-01   -8.301127610531939e-01; -4.154186144094107e-01   -7.006763262135530e-01   -3.512070441813657e-01   -4.039355693257708e-01   -4.511256049606193e-01   -4.958837353857553e-01   -6.456193318832627e-01   -6.245867341644866e-01   -2.075209696667423e-01   -3.196666071340769e-01   -4.100616376484439e-01   -5.846163003379076e-01; -5.915794452325498e-01   -4.186805231975761e-01   -4.352345827412484e-01   -2.688591790095432e-01   -6.336654962578009e-01   -6.940360969847174e-01   -3.039609956049886e-01   -3.821085453490590e-01   -3.238218987731545e-01   -5.151915703958576e-01   -6.132683076249503e-01   -2.888810057181889e-01; -7.257360446462788e-01   -4.790274453204325e-01   -3.513503370295295e-01   -6.899485921177027e-01   -5.741159163159893e-01   -2.805580999512899e-01   -5.759384179370843e-01   -4.798201479477981e-01   -4.630800851070983e-01   -5.249218530835350e-01   -4.809880722107894e-01   -4.128033027171902e-01];
L1_L3_iAMPA_netcon = [-4.305478937797521e-01   -3.516627832344459e-01   -5.279329944220842e-01   -5.640843295767271e-01   -7.977461109150119e-01   -5.799038201192409e-01   -4.058300816625535e-01   -5.424242277324274e-01   -3.475265320659420e-01; -5.232674695951784e-01   -1.076452716056267e-01   -2.837067660404334e-01   -3.426784434597239e-01   -4.818288640027396e-01   -5.103535929402410e-01   -2.578759144850141e-01   -7.290233318996189e-01   -5.063100572945457e-01; -4.465589557319219e-01   -3.805048746769513e-01   -4.978606336330200e-01   -2.098040069812480e-01   -3.613872889653134e-01   -7.727696344919731e-01   -1.605115187638866e-01   -7.509295449478458e-01   -5.784718674573690e-01; -2.293858894140126e-01   -4.138533842280697e-01   -4.527944672733609e-01   -6.137044882003339e-01   -3.204984177810039e-01   -1.551010022908492e-01   -3.909473269966167e-01   -6.748437870679810e-01   -3.087867053786905e-01; -4.833478959742986e-01   -5.227019244192966e-01   -5.208027112601908e-01   -5.044925391844560e-01   -6.149871479375206e-01   -1.925962543950765e-01   -5.125928564565874e-01   -1.760169559793534e-01   -5.312943299943125e-01; -6.103087100687923e-01   -3.709279438803358e-01   -5.322745889477586e-01   -5.975311231675698e-01   -5.249644943618442e-01   -2.194441494491649e-01   -4.596157674867755e-01   -5.268395009670872e-02   -6.078716343640953e-01];
L3_L1_iGABA_netcon = [-5.606409332398127e-01   -5.014260133162812e-01   -3.794960269720524e-01   -6.478940164768039e-01   -2.690793603009126e-01   -8.296325465095165e-01; -5.339630628576618e-01   -2.816437494964570e-01   -3.232000631899751e-01   -5.246138621701968e-01   -5.929647409007439e-01   -7.764842055230800e-01; -1.774075649682607e-01   -5.487422719370946e-01   -2.959205951522386e-01   -2.399350650139540e-01   -4.529740717894399e-01   -4.693535225446335e-01; -4.735641999990967e-01   -2.416774400008242e-01   -7.004848860883548e-01   -6.223522040821527e-01   -2.015723937302294e-01   -6.338634419565337e-01; -6.147957935775278e-01   -6.757072072462799e-01   -8.476845562644079e-01   -3.066566307634289e-01   -2.894632377835537e-01   -3.912140598075326e-01; -3.914415398431896e-01   -5.713361389527932e-01   -4.864138605543677e-01   -2.499383839516235e-02   -3.636957485070910e-01   -1.935833480596712e-01; -3.835327816131368e-01   -3.050606964184527e-01   -3.962133371756345e-01   -5.561300291907147e-01   -2.770439106363118e-01   -2.221318150638238e-01; -2.367371928716788e-01   -5.636233593707237e-01   -6.662608571168082e-01   -3.322034111668327e-01   -6.006477695076260e-01   -4.667403332313826e-01; -6.667942517217798e-01   -6.627099034082442e-01   -6.617796855877225e-01   -2.551901371692863e-01   -6.319495470012190e-01   -5.346273181341025e-01];
L5_Input1_iAMPA_netcon = [-4.361619107339949e-01   -4.045149243374837e-01   -5.454875437844129e-01   -3.464609697582570e-01   -5.533803611731706e-01   -7.165673754802094e-01];
L6_Input2_iAMPA_netcon = [-6.500210427392398e-01   -7.090447465468307e-01   -4.113164714812689e-01];
L5_L6_iAMPA_netcon = [-4.996124031505635e-01   -5.307965228318222e-01   -2.528668176633780e-01   -4.651570949623152e-01   -7.024773312871296e-01   -2.771729865665791e-01; -5.525488562207816e-01   -4.770883046104212e-01   -5.406878351814931e-01   -5.549369861071197e-01   -6.106229751600186e-01   -4.714314791051374e-01; -7.567129672276771e-01   -3.610739282415595e-01   -1.754305008385069e-01   -2.076242663021065e-01   -5.061705106691666e-01   -3.169116049015519e-01];
L4_L5_iAMPA_netcon = [-4.496585868776892e-01   -4.082673624962641e-01   -5.511932733165522e-01   -4.977204847164506e-01   -5.790982421549666e-01   -5.774186546337433e-01   -3.240452583368306e-01   -3.629318748517795e-01   -7.125540360353494e-01   -3.207299464167223e-01   -7.219266275853882e-01   -6.262328976393112e-01; -2.876955350554685e-01   -1.266536179430521e-01   -2.527143692579802e-01   -3.222246621266411e-01   -4.602030092574231e-01   -5.557483486280143e-01   -5.067470948735041e-01   -1.341672021322743e-01   -3.511920660042767e-01   -4.301223121714581e-01   -7.697206446313865e-01   -5.249000342813811e-01; -3.410479553558932e-01   -4.224830571528342e-01   -2.442361266270358e-01   -3.866855635430952e-01   -3.935072156594906e-01   -3.274890573825179e-01   -3.791399228782385e-01   -1.648751555264465e-01   -4.520137325743734e-01   -5.071465843435030e-01   -5.625715276614108e-01   -4.412654066868740e-01; -1.741010077495741e-01   -3.421353661944469e-01   -4.559193282807474e-01   -2.840590043616488e-01   -6.455411982037262e-01   -5.061089388400506e-01   -3.305839849720400e-01   -4.028423327646498e-01   -4.881895369005247e-01   -4.503424310483140e-01   -8.118147556646028e-01   -5.694358961663407e-01; -3.616592998995103e-01   -1.722282380840491e-01   -5.897338029362158e-01   -3.818834168608411e-01   -3.476453077483971e-01   -2.305709792037016e-01   -4.228979630536309e-01   -5.205723121765312e-01   -4.727140024472259e-01   -5.172023756816048e-01   -2.799244405242198e-01   -9.774681870718673e-03; -7.768296289630781e-01   -5.800109142967171e-01   -5.519592079440334e-01   -4.290292529192338e-01   -7.166497921054986e-01   -5.814059716389504e-01   -1.124011155694225e-01   -2.525009413461855e-01   -2.928880510631542e-01   -7.614948480676215e-01   -6.978140685642211e-01   -6.220581315092709e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
