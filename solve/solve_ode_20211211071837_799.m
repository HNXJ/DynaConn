function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.809989877807134e-01   -2.453399235482671e-01   -1.567845649982495e-01   -6.683703918477589e-02   +3.355950668394765e-01   -5.694728387010668e-01   +2.577714820096005e-02   -2.760692373337450e-01   +4.410199443453891e-02; -3.149232240825978e-01   +2.283744260768221e-01   +1.751605653294296e-01   +1.435065693349660e-01   -2.465997384169671e-01   -1.077574937557699e-01   +4.740461481722754e-01   +4.835695282150619e-01   -2.535152390241059e-01; +4.662220809380892e-01   +7.900117186316772e-01   +1.003693107726815e-01   +2.410469043579074e-01   +1.261897877345932e-02   +2.448663686206776e-01   +2.149021924552024e-01   -8.201706690975856e-01   -1.226450646326076e-01; -1.138304238082130e-01   -1.003907798369680e-01   +4.349578106848122e-02   +1.992753165969081e-01   -1.020360499634200e-01   -2.066922794997631e-01   -6.572800824067199e-02   +4.395932743065489e-02   -4.971733559718831e-01; +5.640443676590179e-02   +4.956099478127075e-01   +3.210316211188529e-01   +8.298163607758140e-02   +3.261812100930070e-02   +3.510138175927636e-01   -1.100922774394621e-02   -1.315260893625841e-01   +2.394255317976878e-01; +2.355966382889090e-01   +1.621901601047243e-01   -1.838650753038577e-01   +4.329568337211702e-01   +3.879127899043809e-02   -9.337106162230449e-03   +2.490739884754758e-01   +5.882218637307222e-01   +7.412948950459833e-01; +4.629020810889596e-01   -1.884733367878648e-01   -5.366219357760984e-01   -1.814609848614292e-01   +5.299742239195642e-01   +1.717698010883321e-01   +6.714633333502337e-02   +1.872342322431726e-02   +3.804679172911454e-01; -5.056055822471529e-01   +9.549370588354126e-01   +1.036083600883977e-01   -2.905947473552914e-01   -1.867813169627758e-01   -7.402264945649814e-01   +5.987752589134940e-02   +1.754481345699332e-01   +3.383910283500481e-01; +9.560102487219943e-02   +5.516644947881132e-01   +3.679217862178480e-02   +8.949254622824809e-03   +2.437421797289526e-01   -6.698186041585649e-02   +1.541035122997016e-01   +5.859871238988071e-01   +8.789291872727875e-02];
L1_L2_iAMPA_netcon = [+4.109573442291856e-01   -8.129524069367164e-02   +2.121504857068968e-01   -4.670622759575954e-02   +5.001869985978082e-01   -8.064806293295820e-02   +1.854802506208765e-01   -4.028395745040977e-01   +7.176064951653780e-01; +1.804431854668086e-01   -1.535615388557754e-01   +3.225864838523254e-02   +6.659269127389801e-01   +2.183129008699937e-01   +1.176382003754607e-01   +4.473434664344667e-01   +2.528886459264024e-02   +2.567835520875711e-02; -1.269898513577644e-01   -4.123710620720643e-01   +3.568808137009115e-01   +1.123842614411885e-01   +2.979016988139013e-01   +7.046730959548173e-01   +4.484827539527040e-01   +2.307830889691095e-01   +3.360628211417984e-01; +1.381689063310164e-01   +5.775894872045080e-01   +1.987806274300631e-01   -2.248301547954749e-02   -1.314516447850226e-01   +2.995997700071266e-01   +4.490016512613161e-01   +5.992385622425824e-01   -4.565946682443548e-02; +3.330161103588622e-01   +8.942147424473778e-01   -1.267891635420676e-01   +3.395564291317644e-02   +1.845530927018991e-01   +3.158444873717945e-01   +9.524155264554363e-02   +2.759114902691390e-01   -2.214760987224873e-02; -1.282823990264670e-02   -2.764470485235468e-01   -1.597750358856219e-01   +8.095140489719096e-01   -1.242520154225286e-01   +1.099883015669786e-01   +7.936982586331640e-02   -5.968029848816286e-02   +6.836689036148502e-01; +5.834689102717372e-01   +2.075768382501501e-01   +3.994808738884940e-01   +3.981876296519019e-01   -1.959134802996336e-02   +6.654623953326846e-02   +3.314303737466389e-01   +7.526237875861419e-02   +2.026372830025288e-01; +5.991094955558433e-01   +2.289096265755947e-01   +1.477319561619955e-01   +6.691936050146730e-03   +2.441194474693840e-01   +4.372910255780079e-01   +2.515763544431431e-01   +4.927210776538852e-02   -8.411123570162449e-02; +1.598204231544699e-01   -2.377552408018788e-02   +4.746314896897855e-02   +1.521682810227767e-01   +2.216521721660460e-01   +1.318374649958686e-01   +9.297602354890553e-01   +4.790524267496877e-01   +1.507816679715080e-01];
L2_L5_iAMPA_netcon = [+5.746040217183714e-01   +3.902995705797753e-01   +4.759590701893651e-01   +3.049670779858631e-01   +5.926765472998905e-01   -1.294786366134662e-01   -4.873353892362612e-01   -7.271778572939709e-01   +1.591085690925389e-01; +1.073706001618590e-01   -2.831264463730684e-01   -6.607892856848795e-02   +4.689324334562155e-01   -1.054086107570364e-01   +5.278610506651982e-01   +1.448232207560466e-01   +2.188789743280793e-01   +1.733146723648223e-01; +2.548428274040260e-01   -6.182255622426264e-02   +5.630229733583275e-01   +6.190803615975630e-01   +3.039137705307528e-01   +4.005733855706863e-01   -9.515457743260582e-02   -1.012165789831658e-01   -1.358273485473563e-01; -2.108575170253921e-01   +1.527016227708982e-02   +3.796690958759101e-01   -3.290425964097605e-02   +6.097203911644727e-01   +9.350740854983815e-02   +2.169396715531988e-01   +2.429357163922262e-01   -2.811360733734203e-01; +3.516279382115311e-02   -8.844921878967338e-02   +1.060282324821362e-01   +3.158722993936634e-01   -3.856937446712631e-01   +1.155859008944326e-01   -7.297023371320130e-02   +1.000000000000000e+00   +4.171247792856400e-01; +6.014252892566666e-01   -1.519842103416668e-01   +3.655822861119958e-01   +4.611560330834661e-01   +4.929570711143366e-02   +2.008582432434946e-01   +1.015257803180549e-01   -1.114475158779346e-01   +6.212191545527141e-01];
L5_L2_iGABA_netcon = [-2.065046291842771e-01   +1.434825169367674e-01   +5.766365544333808e-01   +4.402688097402616e-02   -8.959315743651515e-02   +3.058200754050067e-01; -2.462106858337694e-01   +5.321284452838971e-01   +6.964485634138956e-02   +5.251732106291348e-01   -8.142876090475377e-02   +1.306500617720493e-01; +3.963039215875875e-01   +3.164026901111041e-01   +4.968025020518813e-01   +2.548457613310619e-01   -1.828920556606374e-01   -3.389045318819476e-01; -4.399324218962425e-01   -4.972535924318088e-01   +3.512256535967536e-01   -3.672685141432722e-03   -2.371703465360749e-01   -3.490899367884505e-01; -2.187709300108601e-03   +2.497988996998358e-01   -1.194546794341902e-02   -2.897241394195464e-01   -3.775823334376829e-01   +6.642486000312228e-02; -2.762960493110069e-01   -2.983312473205740e-01   +5.108661181700969e-01   -2.150561547704491e-01   +2.371847983571930e-01   +1.856305953858725e-01; -1.785940270884400e-01   -8.184291159835250e-02   +5.623666413830803e-01   +5.226343874226593e-01   -5.854030400034934e-01   +1.258767045063966e-01; +1.081910373749696e-01   +7.863802195349046e-01   +4.362025386163713e-01   +1.211551792644564e-01   -3.089666726983267e-01   +5.519075440856167e-01; +2.198281774494700e-01   +5.017120471204950e-01   -1.453518307596158e-01   -1.890099968212706e-01   -2.167599477187215e-02   +5.262176150297272e-01];
L3_L2_iAMPA_netcon = [+3.587393836880089e-01   +4.532912783025022e-01   +9.487818746533791e-02   +1.114540468738149e-01   +3.815350636725195e-01   -1.486138297799448e-01; -1.582126363482662e-01   +1.993691698298773e-01   +5.844775368541385e-01   +1.886496265840241e-01   +2.805610708364227e-01   -3.993547694497347e-01; +5.507419310720607e-01   +6.570261668387755e-01   +5.103192633213641e-01   +7.545319301271693e-01   +2.681101322346062e-01   +2.886582405856487e-01; -2.809488413111856e-02   +4.142424414035203e-01   -4.130931779648301e-01   +9.218856502316934e-02   +7.076273219281131e-01   -1.438589812924438e-01; +2.657854449736430e-01   -1.874810967553847e-01   +2.919122849688349e-01   +3.019067305566897e-01   +5.074702428340622e-02   +4.986245660540286e-01; +3.944118793265244e-02   +3.762603650543173e-01   +5.376336809543225e-01   -8.550487152325725e-02   +3.414633344171598e-01   +2.504349651495480e-01; -1.297623526575845e-01   +3.111198452186553e-01   +5.128718587233076e-01   +2.559618777401815e-01   +3.501852921391073e-01   +3.458778863788741e-01; -1.190973261916641e-01   +2.352358670365216e-01   +5.290204241736310e-02   +2.283569930903398e-01   -2.706853031335789e-01   -1.531119966601079e-01; +2.565617548000145e-01   -9.355596184546315e-02   +2.774696942802133e-01   -4.072265024556015e-01   -2.885774360091725e-01   +5.055914835251464e-01];
L2_L3_iGABA_netcon = [+2.849126262879278e-01   -2.773633923672825e-01   -7.091421869916879e-01   +6.301880670909434e-02   +2.115186155267511e-01   +2.532195395063775e-01   +1.710167731236779e-01   +3.876762461008009e-01   -4.726960571425559e-01; -4.351849351329760e-01   -1.566827613034163e-01   +4.252409513803082e-01   +1.720860607116097e-01   +5.528375056938762e-01   -5.437018794323160e-01   +7.440261738724235e-02   +3.244024398908935e-02   +4.429660195689268e-01; -3.534775729563544e-01   +1.142009875733202e-01   +1.144967136941687e-01   +3.293250468808632e-01   -5.815442877912180e-02   +5.285315790453631e-01   +2.775446158457648e-01   +5.798382299800849e-01   +5.273596545793756e-01; -1.618312927536474e-01   +9.451998763995368e-01   +7.009961853963891e-01   -1.281201873961151e-01   +2.830532104185158e-01   +2.270417544707375e-01   +8.286292248660311e-01   +3.050284070662715e-01   +4.785323197911621e-01; +2.919689173993286e-01   +4.007980218424509e-01   -3.616764309389046e-02   -5.514863974271611e-01   +2.473676434874647e-01   -3.187758418465205e-01   -5.390064828686258e-02   -1.364088035922368e-01   +1.243819811826307e-01; +4.477735902400492e-01   -3.699569585079755e-01   +4.777634846830111e-01   -3.781282042791573e-02   -2.499640867769067e-01   +3.206388302484015e-01   +6.653192689938331e-03   +3.128061322021783e-01   +2.301642907318651e-01];
L1_L4_iGABA_netcon = [+1.488245489888814e-01   +4.790738723744342e-01   +6.631798935666806e-01   +3.602351310106710e-01   -1.419472788486058e-02   +1.633414987616189e-01   +3.472686525111710e-01   +8.104836908183967e-01   -2.850288499854286e-01; -2.533583023354830e-01   +4.469088033682957e-01   +2.079888939355936e-01   -8.236013515315933e-03   -1.251199947251102e-01   +1.830224174664964e-01   +6.430803630384721e-02   -8.070256522716304e-02   +2.720714558930799e-01; +9.835738514338770e-02   -2.377906238886180e-01   +3.985095080055903e-01   -3.718373932676849e-02   +9.933333436012204e-02   -2.698598066628733e-01   -1.578439810293192e-01   +4.358614953441844e-01   +4.670929907129738e-01; +1.710953572595433e-01   -2.344808838937337e-01   +4.548653444192634e-01   -7.952153459389091e-02   +1.376025558104974e-02   -3.138171297500090e-01   +2.498662250720050e-01   +1.000000000000000e+00   -3.769444222559817e-01; +1.935099641212550e-02   -2.662078960268545e-01   +5.653157255196154e-01   +6.239438604763087e-01   +3.901643544948703e-01   -1.928216203093793e-01   +4.395560884754265e-01   +1.952074879898862e-01   -4.120987077118166e-01; -3.968855963884626e-01   +4.721433759319471e-01   +4.258215268492851e-01   -3.095251103865428e-01   +3.897610333275177e-01   +1.864006245732814e-01   +5.115198214705727e-01   +6.651087085298020e-02   -6.826957588542307e-01; +8.657016382394035e-02   -1.576249842837437e-01   +1.062639735018789e-01   +3.014111288346981e-01   +2.402162702669000e-02   +1.510993653214103e-01   -3.713117385485853e-01   +7.732436479868629e-02   -7.576437682722537e-02; -2.892074880701733e-03   +4.370257455922594e-01   -7.168845430758555e-02   -4.684669176335463e-01   +3.005548650241417e-03   -4.416720569929209e-01   +1.642220191634454e-01   +3.894513553187722e-01   +1.576347742583995e-01; -2.633448707210090e-01   -1.074186656805436e-01   +2.280400722178542e-01   +4.756769468049739e-01   -2.472350614061733e-02   +7.964060844090468e-01   +3.810685528757208e-01   +2.430348461768319e-01   +2.360472459342721e-01; +1.528264151124562e-01   -7.271037019678943e-02   +8.565671568334920e-01   +5.174112633039406e-01   -7.629204029772362e-01   +6.125738541175710e-02   -8.394753677129022e-02   +3.058075178162930e-01   -9.718977227697791e-03; +7.274570321263932e-01   +4.024842435869689e-01   -2.728810580951104e-01   +7.837068613220345e-01   -2.129990158093967e-01   +6.965004991363815e-01   +4.461511821730115e-01   -6.245384362011071e-02   -1.463488923838860e-01; +1.181217897998589e-01   +9.899281936644916e-01   +3.289943659932311e-01   -2.350993601391521e-01   +4.018059359548508e-01   -1.532748718225923e-02   -2.106554144689603e-01   +9.751853131504640e-02   +3.909422502760605e-02];
L4_L1_iGABA_netcon = [-2.572061523993102e-01   +5.310323708120818e-01   -9.915470453599379e-02   +3.835196898134653e-01   -4.145735078954876e-02   -8.653212385143547e-01   -5.460097004682862e-03   +2.358819131608201e-01   -1.298424988801746e-01   -2.151525491233676e-01   -1.767604019035512e-01   +2.687547111194795e-01; -1.692125524750954e-01   +6.055619620301154e-02   -1.782497260873541e-01   +4.761046561337190e-03   +5.186470186338047e-01   +5.708436820059977e-01   +5.230266392965962e-01   +2.992856750569940e-01   +5.778099722566915e-02   -5.791277959700089e-01   +5.862002626612709e-01   -1.619879546293304e-01; -3.203293204632531e-01   +2.225327184842470e-01   -1.130374348568612e-01   -1.371576207378100e-01   -1.026503648193564e-02   +3.102964169798465e-01   +4.092956672635299e-01   +2.254963142427022e-01   -3.365203997211155e-01   -3.816358346429638e-01   +6.623068026154302e-01   +4.086562930168973e-01; +3.511159338547877e-01   +3.701106064464230e-01   -2.712534796804531e-01   +6.428393373151849e-01   +6.725997287626483e-01   -6.711185693777766e-03   +4.322031144862650e-01   +6.076744479410667e-01   +8.790489235012711e-02   -8.809302277384301e-03   -1.354116946147813e-01   +5.156311711567392e-01; +2.513297841877473e-01   +4.503302427698755e-01   -5.811548259549337e-01   +4.858068933619966e-01   -3.315984784973383e-01   -2.668124220963374e-01   +3.434369598731810e-01   -1.662466533504003e-01   +5.167106404750111e-01   -3.731434550023258e-01   -1.677836628944987e-02   +7.494196486136568e-01; +1.932502411637544e-01   +4.896037570411226e-01   -5.892668614111127e-02   -2.394592783997060e-01   +2.694202361590946e-01   -2.259710477074462e-01   +6.024909569475324e-01   +5.540249188640411e-02   +1.522630053369845e-01   -6.153337392164203e-02   +3.246788384740126e-01   +2.000718792998135e-01; +3.707322648027774e-01   -7.601499821631341e-02   +1.278606540636459e-01   +6.326414919735085e-02   +4.925623805460677e-01   -5.126807650320337e-01   +4.960487522127320e-01   +2.369298897337607e-01   +2.789121294752450e-01   +1.100078876115599e-01   +4.825358771606031e-01   -6.077646976514023e-01; +4.742358463929242e-01   -2.783638264560437e-01   +5.542660504295823e-01   +2.110404228166574e-01   +3.408647132316042e-01   -1.125895577393096e-01   +6.728245618037512e-02   +2.880544594516129e-01   +1.689374025283829e-01   -4.029260060490614e-01   -3.903174023250390e-01   +2.370330214197642e-01; +4.047531212786343e-02   +1.997853784357581e-01   -2.515602457704584e-01   -2.169580082964862e-01   +6.475928485641040e-01   +1.191810885853603e-01   +3.585769941955396e-01   +2.030681828277747e-01   -3.415150326112557e-01   +9.175096186695844e-02   +3.717337875583414e-01   +4.162524248883340e-01];
L1_L3_iAMPA_netcon = [+5.889655380279411e-02   -1.210003618074236e-02   +6.543397775248675e-01   -3.166950878894105e-01   +1.000000000000000e+00   +1.134068771843844e-01   -2.521809121106044e-01   -2.020247238538814e-01   -1.253694774312487e-01; -5.627527904101538e-02   +8.170706946829548e-01   +4.435368144534967e-02   +4.744461897637906e-01   +1.432677859250318e-02   -2.500445638346298e-01   +5.151430105292936e-01   -2.105855352290015e-01   +8.859674263613557e-02; +2.413104485009630e-01   +3.400054712110389e-01   -6.255974640799053e-02   +2.238815196616534e-01   +7.478721570191166e-01   +1.391682381421036e-01   +1.545131329231668e-01   -4.451310307330695e-01   +7.089551601184474e-01; +6.918998360379461e-01   -1.899636427895358e-01   +1.536165158334868e-01   +2.734292623852459e-01   -3.038599040023102e-01   +7.205463495330652e-01   +1.521042939530295e-01   +1.823794809835871e-01   +5.554018975309581e-02; +3.057571551564361e-01   -2.191572990954318e-01   +2.202307852165087e-01   -4.297582242995133e-02   +2.248724957374982e-01   +2.414269213896613e-01   +3.848214340927703e-01   +7.864809215249360e-01   -4.717249071687734e-01; +2.036302912706054e-01   +5.331948467516102e-01   -7.188431036776635e-02   -1.475050721013185e-01   -2.489222222149431e-01   -8.312008190383854e-02   +2.383772686981165e-01   +4.670494713010690e-02   +3.556536109644122e-01];
L3_L1_iGABA_netcon = [+3.983686559398117e-01   -1.725982976381508e-01   -1.412880629429584e-01   -1.602603591364339e-01   +2.395532803161304e-01   +2.634909510201336e-01; +2.602057706160998e-01   -1.328281914143828e-02   +3.369881457078484e-01   +6.912667259710503e-02   +5.437298292567302e-02   +4.435180176375483e-01; -1.092341319932821e-01   +1.750697620998994e-01   -7.078753688672999e-02   +2.771232811794999e-02   -2.416760070851698e-01   -2.874296165030356e-02; +7.731494481990253e-02   -2.260407127096140e-01   +8.830416093442357e-01   -8.807141889411782e-02   +2.717446258443187e-02   +7.107112925112893e-01; +5.083792080682485e-01   +5.714806419299248e-02   +8.519815261448117e-01   +2.709432920020746e-01   +2.557102482934579e-01   -5.877560729926005e-01; +8.833036621029436e-02   +9.374172557379996e-01   +6.011921143818841e-02   -4.074287250899938e-01   -3.658226442816788e-01   +4.949248447914194e-01; +3.453732680261263e-01   -2.503760556823361e-01   +1.384166218190909e-01   +9.114048311837702e-02   +3.214464465862223e-02   +4.423697108067958e-01; +1.313083082249717e-01   +3.128728117121932e-02   -8.650566286037306e-02   -4.644826587312656e-02   -9.912683788235375e-02   +6.527517563568093e-01; -2.000237507887803e-03   +6.322360653836911e-01   +2.752657278532802e-01   +1.275089344868494e-01   +7.361365168098624e-01   +3.936845468921696e-01];
L5_Input1_iAMPA_netcon = [+4.226857325588724e-02   +3.250846750088141e-01   -1.959148697113451e-01   +1.418622868687521e-01   -3.189106701633599e-01   +1.644503989671910e-01];
L6_Input2_iAMPA_netcon = [-4.044228394776082e-01   +3.624579670862638e-02   +4.266041302466572e-02   +1.194633603001825e-01   +3.340526211680029e-01   -2.691501366203878e-01];
L5_L6_iAMPA_netcon = [+3.472459006202019e-01   +5.053772755606878e-01   -2.188657773522320e-01   +8.189733459220309e-02   +4.009021834220233e-01   -1.592116263295326e-01; +3.478049993723061e-01   +9.877975840351672e-02   +3.146475989524444e-04   -3.807419145454105e-01   +1.949568026161234e-01   +6.414027084821565e-01; +2.073587677130378e-01   -2.185608969352499e-01   -2.427058157339841e-01   -1.048112020076345e-01   +3.628664235586595e-01   +3.469274632140603e-01; +5.780105381779557e-01   +2.763939712180354e-01   -2.350780839678449e-01   -4.386183140677676e-01   +1.483948694868970e-02   -1.503515980932194e-01; -1.671889894442001e-01   +1.767178990209738e-01   +8.361349628570700e-02   +1.272433293045712e-01   +7.442304866044355e-02   +2.931768578118177e-01; -5.697913198805024e-02   +6.475962516435431e-01   +5.736504860241363e-01   +2.662208346894620e-01   +4.480580976388265e-02   +4.724788219150569e-01];
L4_L5_iAMPA_netcon = [+2.072875622279472e-01   +1.672329509600394e-01   +7.448225498146038e-01   -2.443121742391872e-01   -3.433425093055188e-02   -4.534595382420503e-01   +5.417057427340681e-01   +3.286426821122431e-01   +2.132253879141141e-01   -2.373333303301222e-01   +2.267936240498083e-01   -1.999669962439499e-01; +8.394263368623583e-02   +4.846246298499358e-01   +1.820804258979123e-01   +2.377224282161595e-01   +4.024300250208997e-01   +2.298800768500184e-01   -4.456171204132952e-01   -6.350609213206253e-02   -2.818889506899274e-01   -4.765895422786949e-01   +3.925641903823167e-01   -6.772652692217286e-01; +4.541019824259402e-01   +6.289814972445383e-01   +2.110518000452364e-01   -1.624339522986971e-01   +3.813222057137151e-01   +9.926608289806559e-01   +1.705286803251280e-01   +1.955927217598804e-01   +3.735592519871958e-01   +5.102129749913661e-01   +5.979612228418875e-02   +5.559197921958399e-01; +3.697673493232212e-01   +1.625041923380257e-02   +8.359181303346237e-02   +9.223821926590156e-02   +2.577474309594519e-01   -1.346235425980521e-01   +4.227967484537680e-02   -1.227557654054693e-01   -2.597646279322421e-01   +2.782995675143350e-01   -8.309838071984935e-02   +2.075092785512059e-01; -1.713994576758847e-01   +3.924073055959396e-01   -1.034745197321400e-01   +3.303547938099448e-01   -1.696191563461044e-02   +3.480720166006515e-04   +4.753884457467142e-01   -3.389007090051983e-01   -1.047215999983964e-02   -5.610393275969058e-01   -2.114311908647515e-01   -5.001374002007096e-02; +4.758341238917876e-02   +2.216135924789478e-01   -4.163166826155577e-02   -4.205437461521283e-01   +1.000000000000000e+00   -3.128238285200717e-01   -1.637978145637426e-01   -1.239489515761956e-01   +7.191395785344284e-01   -1.378961351691264e-01   +3.292244878083447e-03   +8.085163329444878e-01];
L6_L4_iAMPA_netcon = [-3.568993425529318e-02   +5.889372030435716e-01   +4.535998279188050e-02   +5.300679399570000e-01   -8.573147033188633e-02   +1.299311171029416e-02; +1.389341585756869e-01   +8.472315655193554e-01   -5.964629627399071e-02   +2.747678970702688e-03   -1.837522397727666e-01   -3.826708356925745e-01; -2.004161975977745e-01   +3.607266682717232e-01   +3.471090422414446e-01   +5.910300023959132e-01   +6.790370455753435e-01   +2.779013428826968e-01; -2.592985039052486e-01   +5.911890404930006e-01   -1.208269941127408e-01   +2.791472305717128e-01   +3.859420260630119e-01   -8.231923647233147e-02; +4.673797682812784e-02   +4.444107978055453e-02   +1.992814131140073e-01   +4.044967929624570e-01   +2.813820749436620e-01   +7.871299399352989e-01; +4.442416075093385e-01   +4.798380104732956e-01   +5.381096469520514e-01   +8.901924079232026e-01   -2.650136542794120e-01   -1.061655699007227e-01; -1.291055938988324e-01   +5.058738082600568e-01   +4.798310865664054e-01   -2.049899904471625e-01   +4.987512324838246e-01   +4.657074385243170e-01; -2.581817858022935e-01   -1.980395394758241e-01   +2.896309464167512e-01   -5.254556784693938e-02   +4.734629676406613e-01   +6.231010758689504e-02; +1.546616822090478e-01   +1.761078823207279e-01   +5.293968709052468e-01   -4.519343635498487e-01   -2.599071221458223e-01   -4.898577040338557e-01; -1.437267255056779e-01   -6.086168543471153e-01   +7.248922577286772e-01   +1.857328450648875e-01   +1.373250197340032e-01   +4.386712047981542e-01; -9.479943506522748e-02   +1.837828169469187e-01   +4.696604408334987e-01   +3.171708121849872e-01   -1.894776968424388e-01   +2.211220264567986e-01; -5.564586283967499e-02   -3.697172422384469e-01   -6.658186332876173e-02   +3.950495503828692e-01   -1.774568572104661e-01   +2.503353008594870e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
