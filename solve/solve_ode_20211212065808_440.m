function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.238532394477301e-02   +3.855836976957251e-02   +5.624453922805103e-02   -9.169381957662781e-02   +2.286744619508239e-02   -6.678333303537684e-02   +1.739624911844806e-01   -7.919415262889473e-02   -8.298376108694973e-02; +9.183288346243240e-02   +9.768410664407796e-02   -7.803192018381975e-03   -6.967873143534356e-02   +9.372655768771060e-02   -5.576036515717604e-02   +7.004121373949923e-02   +9.957500604127580e-02   -1.244411561309848e-02; -6.572831760367626e-02   +1.523450313366027e-01   -9.761084537213963e-02   +1.159700238111321e-01   +3.203747390325423e-02   +4.022426583283733e-02   +1.118107930937543e-01   +1.052682420242629e-02   +1.543879731995007e-01; -9.673443646912298e-02   +2.639960402478577e-02   +9.931262630695789e-02   +6.383645753089906e-02   +3.801174871043685e-02   +5.215399247596767e-02   +3.367867699405887e-02   -4.631749653916750e-02   -3.272301203161292e-02; +1.256769691152376e-01   -5.433277547276131e-03   +1.151353584059826e-01   -6.428209039617060e-03   -5.654248046178207e-03   -5.446915209395711e-03   +2.117794150935113e-01   +4.510974187443365e-02   -5.063790860629266e-02; +2.000559123518714e-02   -2.579913448697679e-02   -7.222668379689658e-03   -1.370173737556817e-02   -1.478385048198540e-01   -3.325532970919694e-02   +2.096184561917622e-02   +2.152974369678372e-02   +3.524839300122257e-02; +8.877446109654259e-02   +1.477969856896837e-01   +7.247017093583483e-02   +1.591748235575519e-01   +5.199149474301196e-02   +1.425288038607723e-02   +4.542321457778210e-02   -1.424656593242325e-01   -1.036039645842032e-02; -1.838691314847097e-02   +2.082235272830714e-02   +1.382334178505919e-01   -2.564000813354211e-02   +1.157501109947748e-02   -7.017654283479451e-02   +6.177050787120832e-02   +9.198360493427470e-02   +8.781354812291164e-02; -2.251364559521123e-02   -1.514598415010377e-01   +1.470507097529301e-02   +3.162086522771411e-03   -8.424274840394940e-03   -2.640442219344907e-02   +1.282629627896846e-01   -1.950710571306753e-02   +1.259195716002719e-01];
L1_L2_iAMPA_netcon = [-8.107105191939472e-02   -1.589380864885394e-01   -3.407911158909155e-03   +6.056191146085391e-02   -2.982452532531085e-03   -2.248326731593475e-01   -7.328621251189635e-02   +3.942718362995076e-02   +1.163792514197174e-01; -2.530690155050611e-02   +6.169545448938088e-02   +2.415130315790009e-02   +4.045297715191921e-02   +1.096829821130135e-02   -1.094539868241605e-01   -8.924340745718422e-02   -3.158601991535109e-02   -5.037964108609903e-02; -4.359470208468492e-02   -1.464127532253870e-01   +8.657807070964066e-03   -2.883562041178977e-02   +4.120616108119614e-02   +8.657274859816982e-02   -1.731556755979845e-01   -2.572331919470438e-03   +4.093376384839117e-02; -1.437672285134331e-02   -2.707372118308844e-02   +8.760148618136998e-02   +7.980168319779210e-02   -7.982068166226998e-02   -1.289163131664015e-01   -7.626413196424225e-02   +4.514576819378428e-02   -8.582945705200290e-02; +1.307612679328319e-01   -2.541467313735919e-02   -2.431647034352953e-02   +1.333532648839518e-01   -3.327152006166527e-02   -7.598090156350326e-03   +4.348950150989718e-02   -2.417551937858808e-02   +7.390931969404393e-04; +1.247273342871875e-01   +4.746921286665100e-02   -1.103409270142940e-01   -2.699729406233715e-02   -4.732161323353023e-02   -2.920380868351326e-02   +2.318135475792422e-02   +9.054228247630837e-02   +9.588916724818904e-02; +2.964271477738214e-02   +5.829368803484899e-02   -3.649830113427214e-02   -4.049142540317768e-02   +3.000236742041824e-02   -4.661797303268794e-02   -1.075543878003073e-01   +4.949568407602885e-02   +1.422072838694707e-02; +9.138390201591906e-02   +1.174067437873878e-01   +7.697960927135307e-02   +4.035487367411005e-02   +1.376337159873319e-01   -6.884615802931772e-05   +1.080851238179170e-01   +5.200279550635267e-02   +1.058328793925565e-03; +1.710224376868258e-01   +5.939813902690210e-02   +1.849188759800629e-02   -1.273004155488920e-01   -8.740414507776327e-02   -4.939330330907928e-02   +5.519810829962154e-02   +1.134658279886590e-01   +5.805984597319176e-02];
L2_L5_iAMPA_netcon = [+7.378515424136142e-02   -9.151191650645679e-02   -5.491918486101090e-02   +8.059920989829727e-02   -2.857490714926991e-02   -3.248139553750967e-02   +7.300770300571141e-02   +5.394123294983366e-02   -1.045289408606954e-01; +7.149783266573551e-02   -2.557792357691682e-02   -8.451602696246714e-02   -3.606998905695011e-02   +1.435034042494369e-03   +7.002347151753469e-02   -6.719173521954165e-02   +8.782537692724346e-02   +3.465976428632857e-04; +1.400990207473550e-01   +9.078250962382681e-02   +1.321939190309094e-01   +3.107295467607142e-02   +2.259924732991596e-02   +4.149094098030628e-02   -5.563463906186737e-02   -7.493360744690057e-02   -8.044376212969302e-02; +8.341016598673109e-02   +8.465511818466176e-02   +2.108787778726224e-01   -2.196968758754919e-02   +1.120936187427122e-01   +3.518325767573570e-02   -1.321040120393980e-01   -1.234409654014501e-01   +6.866384612561179e-03; +1.202446287382533e-01   +1.021543175223957e-01   -1.145333060914991e-01   -5.295588203831182e-02   +5.486305670542398e-02   +1.896568809039845e-01   +1.178266416223709e-01   -4.529305482380981e-02   +9.828927041779727e-02; -1.369741014455125e-02   -2.992016642561881e-02   +8.780503780572213e-02   +4.138302041745683e-02   -5.131350261525583e-02   +9.565080370980170e-03   +2.049004655615870e-01   +3.166107232182039e-02   -9.417011445036726e-04];
L5_L2_iGABA_netcon = [-3.331395631788792e-02   +6.478163456553943e-02   +7.607667070312654e-02   -2.947997292629786e-02   +3.760398942954984e-02   +1.628879152055459e-01; +9.560720571580919e-02   -8.756931948856822e-02   +1.019891994518748e-01   +1.470742644526465e-01   +6.271920880330376e-02   -6.702903684596903e-02; -4.029000639378236e-02   -2.843329563611603e-02   +1.200757971985545e-01   +4.037567718052063e-02   -3.481565055174207e-02   +5.477108276424920e-02; -8.022089573812274e-02   -2.183721881452920e-02   +3.614034271369561e-03   +1.950828591543821e-01   -7.511705392354208e-02   +4.526517118768703e-02; -5.085685218110543e-03   -3.535348663462259e-02   +1.841660193388971e-02   -3.666566209780513e-02   -5.409996105722017e-02   +1.026488050885812e-01; +8.246909168159408e-02   +1.687891848038017e-02   -1.694868337957203e-02   +1.573586935043487e-01   -1.921442081047970e-02   -2.134766321762862e-02; -1.098966226798852e-01   +4.837837414894704e-02   +7.221319689316039e-02   +1.500129446284205e-01   -2.650358403821673e-02   +2.603805776980730e-02; +6.116334935621527e-02   -3.743505319047490e-02   +1.033855465324477e-01   +1.219096072812919e-01   +1.651752875590946e-01   +8.293690225827165e-03; +1.565376170316488e-01   -8.798240387114374e-02   +2.523996421341588e-02   +1.100683244951340e-03   +9.583724783219838e-02   +1.448356869248723e-01];
L3_L2_iAMPA_netcon = [+1.114327793950416e-01   +4.161045274493647e-02   +6.002695421794152e-02   -5.229902745944523e-04   -2.557947778648740e-02   +4.972972684990493e-02; +2.115043185796172e-02   +1.783962475340352e-01   -2.754813229692255e-02   +2.621360500130489e-02   -3.959290591280817e-02   +2.129440256766541e-01; +6.826005967125484e-02   +6.079848696430817e-02   -2.340984800904434e-02   +1.563056820090573e-02   +1.778154670757106e-01   -5.295013418341026e-02; +3.879257825429010e-02   +9.002450925058147e-02   -3.296660956310454e-02   +3.822936910671978e-02   +3.022086366587348e-02   +6.631185284148222e-02; -1.713839829050857e-01   +6.694943129749418e-03   +2.448043344483380e-02   +6.892634429195181e-02   -8.488802997981383e-02   -2.750817756904562e-02; -2.632540608567924e-03   +1.419408218265823e-01   -1.299424465990523e-01   -9.588068311687094e-02   +3.295976382195473e-02   +7.671053516086995e-02; +7.844033557376726e-02   +2.625359023580159e-02   +5.780782147286353e-02   -3.986254136542598e-02   +7.177323343090435e-02   -1.148573032755313e-01; +6.657612787128039e-02   +1.560004692042122e-01   -1.636472940090953e-01   +8.261926845035455e-02   +8.206715747054712e-02   +3.204036940511468e-02; +3.958678107193327e-03   +7.535806748270649e-02   -7.809570908298855e-03   +8.611147428850405e-02   -7.416596847608627e-02   +7.459336318823213e-02];
L2_L3_iGABA_netcon = [+1.429435472011412e-02   -2.721006902581213e-02   +8.232039364667428e-02   +3.863934605342666e-03   -6.311334391580703e-02   +7.959562610120309e-02   +2.109283425472737e-02   +4.014232543255523e-02   -4.977194838627173e-02; -8.501380289624324e-03   -1.362459946119472e-01   +8.906982812956080e-02   -8.807272170327668e-02   +1.781747405842119e-02   +7.678090983741512e-02   -2.381717818227104e-02   +4.257294432371012e-02   -5.391982292823799e-02; +1.191395047120039e-02   -6.476591734438158e-02   +4.908567259033549e-02   +1.309067058242587e-01   -8.785322083822211e-02   +1.993664146218272e-01   -1.882884487676296e-01   +8.257581702318377e-02   -6.287565634650619e-02; +1.750150891238818e-01   +4.430229992470246e-02   -1.276852192914939e-01   -3.624814425342203e-02   +1.458981835847625e-03   -7.837523092526751e-03   +8.735460567472801e-02   +7.683936559427566e-02   -9.737545827161498e-03; -7.874876078964108e-02   -3.093324859919368e-02   -1.130487272513032e-01   -1.238573664373644e-01   -4.124625983414625e-02   -6.373901255017655e-02   -2.207706204935798e-02   +1.119673017479106e-02   -1.238172472472512e-01; +4.126662501501412e-02   -2.181613979190618e-02   -1.221580381247581e-01   -7.295271183380583e-02   -6.137524709332733e-02   +1.206166038740918e-01   +7.780718769283823e-02   +2.403239859426283e-01   +5.941262206910310e-02];
L1_L4_iGABA_netcon = [+2.644674981972573e-02   -1.093131078162561e-01   +1.901628726792290e-02   +1.225697747015053e-01   +5.861732308059198e-02   -1.040895465380554e-01   +9.813746960897535e-02   -2.589559939724168e-02   -1.082907081757624e-01; -2.291881841664289e-02   +9.126420897037030e-02   -4.333180284160369e-02   +7.800940743022516e-02   +5.518645881580519e-02   +8.736470359283864e-02   +2.702692996098094e-02   +3.767774179402639e-02   -1.455396883233091e-01; -2.129925033198644e-02   +7.705072957393527e-02   -5.204743671473175e-02   -8.536675464457705e-02   +5.215769228703582e-03   +2.864129615020853e-02   +5.527873272516397e-02   +7.817148291150955e-02   -9.690661794882360e-02; +2.860667572162117e-02   +2.436425220259279e-02   -7.281385991776160e-02   +2.224057643172311e-02   +8.347103659561230e-03   -3.713868756586393e-02   -1.033350350888773e-01   +5.867972232772938e-02   +1.927877941448223e-02; +3.411244591296404e-02   +3.197560386701069e-02   -2.076500573478410e-02   -9.371995674808524e-02   +1.061619988526962e-02   -1.075004780559376e-01   +2.206111716445219e-02   +1.596098607172448e-02   +9.785516653414598e-03; +2.467486810052416e-02   +1.211189663247435e-01   +7.864702590807210e-02   -7.364546544996521e-02   +7.863845993729558e-02   +1.706837302966429e-02   -1.437089355904128e-01   +1.032478729984149e-01   -2.171131139098716e-02; -8.244363146078480e-03   +1.237627160518821e-02   -9.023234762537613e-02   +6.136375616601043e-02   +5.574461463308897e-03   +4.862684044453551e-02   +3.997930283748063e-02   -1.258199230888879e-03   +1.508227312707933e-02; +3.439883991721051e-02   -3.193061086722841e-02   +5.141200373959233e-02   +4.731786779294316e-02   +4.843405921832792e-02   +1.051207974048481e-01   +2.295281493896194e-02   +4.858204324141736e-02   +1.152904028368990e-01; -1.043176215316459e-01   +2.303047791481104e-02   -3.147117626712358e-02   -7.657645058499911e-02   -5.634916201184402e-02   +1.024813751758438e-01   -1.570960091514915e-02   -6.635445735424166e-02   +7.954689563492263e-02; -6.665219438181261e-02   +1.644291080555185e-01   +5.924415335213229e-02   +1.139566674379541e-01   +1.874134943213930e-02   +9.085212404396559e-02   -8.518535256835767e-02   +3.613401607935059e-02   +1.751230115245751e-02; -5.700130386359976e-02   -1.892524438756796e-02   +3.305168553234955e-04   +1.049382160030651e-01   -3.012797115461092e-02   -8.245396901793985e-02   -1.338297931802882e-01   -1.875264623881628e-05   +8.828678198419851e-02; +1.227696822460974e-01   -1.251007962352765e-01   -4.217058757665409e-02   +6.519637138921935e-02   +1.010668300801307e-01   +8.594145075511019e-03   +4.740698981875700e-02   -9.324922378154108e-03   -2.125532843163000e-02];
L4_L1_iAMPA_netcon = [+9.208580396083950e-02   +1.115858972523940e-01   +4.189941738949263e-02   +5.989512555302341e-02   +8.062921090029332e-02   +1.629988189128440e-02   +1.814676169221787e-02   +1.179537160387097e-02   +9.713551185750879e-02   +1.167368951446750e-02   -1.589564176436562e-01   +5.531929960661774e-02; +4.762416044518598e-02   +3.008926867558825e-02   -1.771362784305693e-01   +2.779451918467275e-02   +1.230536422858565e-01   +1.635151189367380e-02   -9.474393283650881e-02   -3.939904488880000e-05   -7.700603691001763e-02   +1.532937988628898e-01   +3.359957701253766e-02   -6.864878163829247e-02; -9.577295845481781e-02   +3.674968838563988e-02   +4.951023492501322e-02   -1.274685010469927e-01   +2.542273616377810e-02   +6.636025125178693e-02   +1.219914051707298e-01   +2.732444128572905e-02   +9.100541524578915e-03   +9.091285813319658e-02   -3.509397836060501e-02   +7.764124403126060e-02; +5.948146301915148e-02   +7.579929358399616e-02   +8.219325254992180e-02   -5.270405714952388e-03   +4.921243348108185e-02   -1.181987513891398e-01   -5.017436120601844e-02   +1.165230958887085e-01   +4.747554283457862e-03   -6.190306769071014e-02   +1.067895770743232e-01   +9.862567430556740e-02; +5.938366996034287e-02   +1.825341039142209e-02   -1.466114214647963e-02   +7.333435129651036e-02   +1.232385820613177e-01   +1.103057222979587e-01   -1.782676177198028e-02   +4.529704202697594e-02   -3.774715262984153e-03   -8.267308252138315e-03   +2.858466585001910e-02   -6.709153847921896e-02; -5.853174410242995e-02   +6.280589251239400e-03   +5.034424776410895e-02   -1.119786853461546e-02   +5.417865790933157e-02   -1.220670167831034e-01   +5.031927087271262e-02   -2.571065388477749e-02   +8.168479902145889e-02   +6.756826307909815e-02   +1.017900314856449e-02   +7.117792265880407e-02; -3.490571629480885e-02   -3.622087295919697e-02   +6.953148337977566e-02   +2.773200326124602e-02   +5.507098369955522e-02   +5.447819757236420e-02   +8.324179794104769e-02   +6.200396329795139e-03   +6.505042634820772e-02   +5.649514622387393e-02   -8.021293287810080e-02   -4.733346482912139e-02; +2.949262335890873e-02   +4.616772381713666e-02   -1.661860952517130e-01   -5.134572339078741e-02   -2.789028322007744e-02   -3.634265332556413e-02   +4.038601196116452e-02   +9.063106371877572e-02   -1.574511539060381e-01   +1.142919088923188e-01   +1.137567396308970e-01   -1.889350637255592e-02; +5.579212402128932e-02   -6.429386211141205e-02   -3.963799417577210e-02   +9.596895955955272e-02   -1.835978228796328e-02   -2.326127013018365e-02   +6.898332998915353e-02   +7.743739135920734e-02   -5.282232571482446e-02   -2.080537658455087e-02   +2.361478423661118e-01   +3.049829912503563e-03];
L1_L3_iAMPA_netcon = [+4.614488768058141e-02   -9.508219988535441e-03   +2.246371333678918e-02   -6.986961972217768e-03   +3.243577301891155e-03   -1.130664272496556e-02   -7.510204592367815e-02   +2.077321295947952e-02   -1.989008678863913e-02; +1.634963553955958e-02   +3.406364501925388e-02   +6.037743926269566e-04   +5.831324538403483e-02   -1.401348718827433e-01   -1.038640706836218e-01   +3.772360895674145e-02   -1.707837815162807e-02   -1.910124115661353e-02; +9.213632233517116e-02   +5.992095857407480e-02   +2.475142523562148e-02   -6.823553735202059e-02   +6.139614968374599e-02   +8.085154056998703e-02   +5.030250251003911e-02   +7.263011260072536e-02   +7.180372907509387e-02; +3.603027151682852e-02   +9.544473542939169e-02   -5.658126031956721e-02   -5.994080007776546e-02   -3.199164789497624e-03   -1.933873082884272e-03   -9.647310494955383e-02   +4.686620705278487e-02   +9.111813919346154e-02; -4.609683941232033e-02   +9.893027641410880e-02   -8.470115201716564e-03   +7.192834041808792e-02   -6.044504097169941e-02   +5.221640609977658e-02   -1.275040869950901e-01   -7.815051275829496e-02   +3.446653229545079e-02; +1.104884621145622e-01   +1.351112448343746e-03   +1.097394413060659e-01   +7.521842592861516e-02   +3.640184911132887e-03   +5.614051485043652e-02   +1.469464761353635e-01   +8.559500027554701e-02   +9.620083512739647e-02];
L3_L1_iGABA_netcon = [-7.401320005162818e-02   +6.836075372276393e-02   +5.183082148294622e-02   +4.239707398996508e-02   -1.770773417197913e-02   +1.742485129359671e-01; +5.890622391633137e-02   +2.022858989910146e-02   +5.601639360700150e-02   +9.295617105527207e-02   +2.064540617609995e-02   -5.747019082016855e-02; +1.027908071424707e-01   +8.747256934390935e-03   -4.328154878745096e-02   +1.574222799497078e-01   -5.493260799879697e-03   -5.393410995319606e-02; +4.131348622765959e-03   +9.107303533530026e-02   -9.488361889688640e-02   -5.714053485480926e-02   +3.044891705691924e-02   -2.338699239164298e-02; +1.240760784624692e-01   +1.602999292058512e-02   -4.646825441265535e-02   +4.538276398009333e-02   -1.339992776723756e-01   +1.029858626612946e-01; +2.523280690995925e-02   +2.854097374499918e-02   +6.102919316611989e-02   -3.472451726630574e-02   -1.166387418004370e-01   +1.169566910985503e-01; +4.664331396965076e-03   +4.485790312672977e-02   +4.875014379484389e-02   -1.227431375636278e-02   +8.450910137464142e-02   -1.525413589588850e-01; +8.358960104923013e-02   +6.189270193553081e-02   +1.413847421118744e-01   -1.064580389314674e-01   -7.003882159631272e-02   +4.043857477826338e-02; -7.185491429614242e-02   -1.208772562932885e-01   +5.926594252718063e-02   -1.462137189936987e-01   -6.084181830442939e-02   +2.598966048409295e-02];
L5_Input1_iAMPA_netcon = [+9.030433422556000e-02   -1.040891410900840e-01   -1.927788189459113e-02   +4.226578278448110e-02   -7.629272487882922e-02   +4.016768877163256e-02];
L6_Input2_iAMPA_netcon = [-2.166041805583490e-02   -2.277329104472912e-02   +5.208993280701710e-03   +8.764156027653981e-02   +6.998408732230865e-02   +9.698528940620868e-02];
L5_L6_iAMPA_netcon = [+9.577139823202000e-03   +3.411703512014580e-02   +1.877339736386087e-01   -5.745939756410691e-02   +1.341225459582135e-01   +1.752017206858559e-02; +4.980084380536566e-02   +1.095937660118386e-01   +1.235071870281203e-01   +7.673527630962837e-02   +3.358834288598025e-03   -8.579427873888908e-03; +1.775495584112648e-02   +2.979994722960622e-02   -2.531448408502552e-02   -2.679702697787668e-02   +4.247816518763844e-02   -5.863546993625394e-02; +1.127228403425447e-01   -2.581745229643493e-02   -1.353338284498353e-02   -1.201411751780884e-01   +1.941619481634207e-03   +3.252445459307171e-02; +1.847921766810656e-01   -4.773284579042599e-02   -4.430737006502972e-02   -1.015621876890546e-01   +7.226192415893880e-02   +4.481936793534001e-02; +3.800188786814999e-02   +2.392158221107416e-02   +2.065028115114870e-02   +1.616611283205887e-01   -1.234871925023188e-01   +1.808088267441356e-01];
L4_L5_iGABA_netcon = [+1.306904379188530e-01   -8.893984061489196e-04   +6.798551527585961e-02   -4.202470063534523e-02   +3.867442458061641e-03   -8.721237457079634e-02   -2.552950984655554e-02   +1.484355633219518e-01   +1.488290095789887e-01   -2.588984858995996e-02   -1.301973183728546e-02   +5.106715991210549e-03; -2.909630662215072e-02   -1.080703575855368e-01   +1.601754284620618e-01   +7.345082147450269e-02   +7.203552683589833e-02   +1.156490461172525e-02   -6.063283533127914e-02   -1.075364117534856e-01   +1.864470219915767e-01   -1.160122523401940e-01   -1.138640125698316e-01   +2.479318814250968e-02; +1.464794742861237e-02   +6.682632547987122e-06   -9.280171451429506e-02   +8.985767566004484e-02   +1.184603456942500e-01   +6.335768142612519e-02   +9.072509513957860e-02   -6.460710171324676e-03   -1.309611654117943e-01   -9.985684917870608e-02   -1.076244723864838e-02   +2.495446827906183e-02; +1.321087860012105e-01   -1.881155462557793e-02   +1.721718133164144e-01   +1.729953890749936e-01   -7.997943710926530e-03   +3.685302839031903e-02   -1.388912614398933e-02   +2.150764786358354e-02   +6.152055971529038e-02   -1.008233272644420e-01   -2.584908097696706e-02   +1.739304759774378e-02; -8.874878512260639e-02   +7.080435798615257e-02   -1.166750250792411e-01   -6.317110940573187e-02   +9.122921167817435e-02   -7.187669582384229e-02   -5.879749762199664e-02   +7.566934089292186e-02   -7.168821730456625e-02   +6.255910062578945e-02   +9.292752033709138e-03   +1.189066435493166e-01; -2.664511602348317e-02   +6.510910409092990e-02   +5.411643279589576e-02   -3.733248719669642e-02   -1.249957812678779e-01   -5.555752949244019e-02   -1.141672710000843e-01   +3.261109405432655e-02   +3.909792184783521e-02   +5.139651118313036e-03   +4.403901143498309e-02   +7.711854178584514e-02];
L6_L4_iAMPA_netcon = [+9.701294540951338e-02   +1.389842059221783e-01   -5.507943636717896e-02   -1.349905175619696e-01   -2.748400511795019e-02   +3.329417771658943e-02; -4.780055051841445e-02   -3.910750798192329e-02   +8.695793854609946e-02   +2.089873561298988e-01   -2.883158849860629e-02   -5.959355859852886e-02; +5.469403825855965e-02   +5.043455349663594e-03   +1.148507741285051e-01   +6.806989326362992e-02   -9.941962560202355e-02   -6.272636920342298e-02; +6.054548030662295e-02   -1.899550929116492e-03   +8.117985127129285e-02   +9.383136417317690e-02   -8.348415973063253e-02   -1.196225489338228e-01; -3.724180456942598e-02   +6.583408904803834e-02   -9.011563453367457e-03   +4.100101792475568e-02   +1.543014840859860e-01   -9.826079380100020e-02; -1.787776872240748e-02   -1.136289280411728e-01   -3.917341669491172e-02   -1.154002848061831e-01   +3.932236153999957e-02   +9.690920365855987e-03; -1.397836332386910e-02   -8.497166255751644e-02   -9.811414504031429e-02   -1.610315686395353e-01   +1.352163711577072e-01   +1.031914967682171e-01; +8.412169921913172e-02   +4.495026530732090e-02   +1.214003528895990e-01   +1.139930460224205e-02   -5.150980493611948e-02   -1.005044202212782e-02; -4.127196019245116e-03   -1.322996536651008e-03   +2.861195687620534e-02   +4.386787724292222e-02   +5.574002442907085e-02   -1.754368756930147e-02; -8.563352127243427e-03   -4.357332960376305e-02   -6.789136784521735e-02   +1.984270265053862e-02   +1.570656591015220e-02   +5.896338532044278e-03; -8.094696749439899e-02   +1.256581585764861e-03   +5.992860297084305e-02   -5.472311081507177e-02   +1.814118109157369e-01   +2.199243604491157e-01; +1.626282534965895e-01   +2.240231927331972e-02   +2.077369393834005e-02   -8.892426648896348e-02   +5.377697873661146e-02   +2.925301000816199e-03];
L5_L4_iAMPA_netcon = [-7.443090081319247e-02   -9.411941990544460e-02   +2.494014537032307e-02   -1.290080504314605e-02   -1.345712157666680e-01   -1.905840641194735e-02; -1.059495970445447e-01   +5.404224087368353e-02   +5.626143574518082e-02   -1.381516049863624e-01   -9.860085932427935e-02   +4.970665390901165e-02; +7.523493375844631e-02   +4.384397228557806e-02   +8.340423536216614e-02   -7.740289158643020e-03   +6.193928782076030e-03   -9.062820194189607e-02; -1.615948699490300e-02   -4.512183140616036e-02   -3.986370563185222e-02   -1.220899277793015e-02   -4.003769133861993e-02   +1.078773617743014e-01; -2.064662305290854e-02   -2.432375104236166e-02   +7.815400429879032e-02   -6.957198999858290e-02   +1.594460005328618e-02   +1.932621976691489e-02; -1.042263388463650e-01   +8.843734146455288e-02   +9.286988763724478e-02   +8.809394595537957e-02   +2.843279634846421e-02   +4.120081783867978e-02; -7.643745317571773e-02   +1.438576427357539e-01   +1.998170177064061e-02   +3.004632510319596e-02   +3.377167970747343e-02   -1.071866534555422e-01; -2.708391798718864e-02   -2.395021467111597e-02   +1.274279062887845e-01   -1.450832842607189e-02   -8.995386847355086e-03   +1.553058019224191e-02; +8.124187250985907e-03   +2.282328549164998e-02   -6.414358516233726e-03   -3.211104097102919e-03   +6.169758167939006e-02   +7.332639531285460e-03; -1.359374613210601e-01   +2.103936398667650e-02   +6.365250766067861e-02   +6.057248390365592e-02   -1.160023764694800e-01   +1.506437224594396e-01; +4.888237448602075e-03   +7.804575857045995e-02   +5.167441779062696e-02   +3.830112328959873e-02   -4.020492272569384e-02   +1.056492219572092e-01; +2.101571553937663e-01   +6.869572723621989e-02   +1.529102104452652e-01   +6.212684914535470e-02   +1.187166647887680e-01   -2.260741708134223e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
