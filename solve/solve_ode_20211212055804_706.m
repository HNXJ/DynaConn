function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.477975544422728e-02   +5.462198229689476e-02   +3.553194728560141e-01   +2.758249947872290e-01   +6.676959828926042e-02   -3.295912326515142e-01   +3.146174652966734e-01   -4.955852656982263e-01   +1.004026633815147e-01; +2.112950665084763e-01   -9.389461793465220e-01   +4.099943980201667e-01   -4.448562666740588e-01   +6.201919326488881e-01   -4.260165339205105e-01   -5.149590915152824e-01   +6.908788718910753e-01   -2.621540199596892e-01; +5.314032375614877e-01   +4.636689972659402e-01   +3.703149018711407e-01   +2.349962203392556e-01   -6.217934568483841e-01   -2.876693442218080e-01   +3.726001940410618e-01   -1.794028838652153e-01   -6.316752202177108e-01; -1.000000000000000e+00   +1.982777531183272e-01   +4.383064523459939e-01   -5.179595847835402e-02   -9.158762927172092e-01   +7.055466888896157e-01   -4.979893982362570e-01   -7.265343727878508e-01   -9.634949094658257e-01; -5.823206600610292e-01   +4.946031323752011e-01   +6.835121524911192e-01   +2.772630904007251e-01   +1.124630372321659e-01   -5.244991160397218e-01   -7.516424201730549e-01   -2.005497531094060e-01   +5.265729485110222e-01; +8.248449655032644e-01   +2.660928697564651e-01   -3.186183552087631e-02   +5.860488150477280e-01   +7.248074116088487e-01   +8.309349746398800e-01   -7.864029185212218e-01   -8.658706985844329e-02   +3.283402581781152e-01; +2.012931129199813e-01   +6.931264561260042e-01   +6.451942426698061e-01   +3.732020961385849e-01   +7.086845443439415e-01   +1.419477575161582e-01   -6.387010847583039e-01   +4.977903142468851e-01   +8.757515569761068e-01; +1.883195845157676e-01   -1.866128763741466e-01   +5.723197508364866e-01   -7.030565497056556e-01   +6.024761070077136e-01   -7.110891740323826e-01   -9.250829900337660e-01   +5.634255656480062e-01   -4.824050027518337e-01; -6.165367531276678e-01   +6.808045941143062e-01   +7.232589695427892e-01   -8.519726647302730e-01   +8.224586759579426e-03   +6.312833531340675e-01   -6.064549838567110e-01   -8.771945348391191e-01   +7.812332795652476e-01];
L1_L2_iAMPA_netcon = [-1.249135329085181e-01   -9.906052791154739e-01   -6.105504566699078e-01   +4.965296270633931e-01   -6.012139044207369e-03   +8.165764287175221e-01   +6.955327026466726e-02   -1.444475480105220e-01   +8.534381156391723e-01; -2.826415393017563e-01   -9.013742401974064e-01   +2.562555733406736e-02   -3.107799555826603e-01   +9.271069977797114e-01   -5.463627875998259e-01   -1.706577090273051e-02   -5.055105262238453e-01   +2.869779557556033e-01; -1.000000000000000e+00   +2.387851038732803e-01   -4.043708667944638e-01   +3.296571349949436e-01   +8.380621247900397e-02   -1.136422833559555e-01   +3.910410309190318e-01   -3.796449888050484e-01   -7.238644748959451e-01; +5.156522512516752e-01   +6.013047345590169e-01   -6.349490457875629e-01   -4.832513184269231e-01   +7.706160701045642e-01   +5.321764230162033e-01   -8.435382279409650e-01   -1.334624926080696e-01   +2.728823957868040e-02; +3.981617971519216e-02   -9.568094560986308e-01   +2.597759445577248e-01   +4.509686890343272e-01   -3.895084245659283e-01   -3.335200202462165e-01   +4.585459925359929e-01   +5.008603721988223e-01   +4.603326839813561e-01; -3.104703074157536e-01   -3.551760101964171e-02   -6.329955161156258e-01   -5.107603347004266e-02   -2.403081150607905e-01   -2.899850963390970e-01   +1.042913632479001e-01   +9.339069315762795e-01   -5.801270804037075e-01; -9.494036307740727e-01   -7.068852316583843e-01   +5.131443920344563e-01   -5.956085145692803e-01   -7.522677016948902e-02   -5.013843637620807e-01   -1.139894023335209e-01   +6.207991524436860e-01   +8.930320741511926e-01; +5.308217431018292e-01   +7.847339535830501e-01   -3.402101342015312e-01   +6.377876718015036e-01   +4.101001650896986e-01   -8.069490600484492e-01   +8.301258861431291e-01   +6.009972762367594e-01   -2.106651392382684e-01; -7.211977786729915e-01   -4.782189038798011e-02   -4.569350466725955e-01   -1.183709105946495e-01   +7.412021620582331e-01   +2.722378841973291e-01   +2.869583932204337e-01   -9.131565516315109e-01   -4.493657991981324e-01];
L2_L5_iAMPA_netcon = [-6.590685448839705e-01   -4.019715046975003e-01   +5.395869852759356e-01   +3.014682705794392e-01   -8.396056912614499e-01   +6.926641588407746e-01   -2.561863823581180e-01   +6.486860574163255e-01   +6.657486455857521e-01; -8.794239419728331e-02   -2.625418150427526e-01   +6.571901157881919e-01   +1.524692809327219e-01   -5.318987086975835e-01   +2.215949309981301e-01   +3.002917520958045e-01   +2.077710733556924e-01   +1.000000000000000e+00; -6.183922112138082e-01   +4.108074624311030e-01   +6.836461019587807e-02   -4.386802444240656e-01   -2.810262427925026e-01   -4.891651244763932e-01   +4.322456556426628e-01   +5.971298222352862e-02   +5.171980561873815e-01; +5.303762855064366e-01   -5.437010384193881e-01   -7.964978380377223e-01   +6.701462811857433e-01   +3.771924985287906e-01   -5.832202789740975e-01   -2.421062871248646e-01   +8.600718398034002e-01   -5.156852877017570e-01; -2.850643773556094e-01   -1.368318371592609e-01   +4.136549105108052e-01   +4.159277083265700e-01   +2.579979408921598e-01   -5.509495063235215e-01   +1.270721116347588e-01   +4.066487227628895e-01   -8.464936036870779e-01; -3.917196402894191e-01   -6.708399665672656e-01   +2.201561910597209e-01   +2.179826315476368e-01   +5.639141478592112e-01   -7.426592945994528e-01   -5.232176333113921e-01   -6.575982329391146e-01   +8.845327628311112e-02];
L5_L2_iGABA_netcon = [-4.234388136637546e-01   +1.209363583211056e-01   +2.773933900651566e-01   -5.681588285580754e-01   +5.010908463645188e-01   +6.869787837956957e-01; -8.828467156334162e-02   -5.599574324675685e-01   -8.635806647920191e-01   -6.683134632921508e-01   +1.000000000000000e+00   +6.385841919834138e-01; +4.663862382473850e-01   +5.541239094028124e-01   +8.904926750588308e-01   +2.569846335925222e-01   -3.505558490334388e-01   +4.677810102876805e-01; -2.142661226396991e-01   +4.304817161644316e-01   -3.270525613400226e-01   -8.613865149328505e-01   -6.048153780619295e-01   -3.988539336518282e-02; -9.412070126873623e-01   -6.915234234825035e-01   +7.484806050569385e-01   +2.024837139501356e-01   +5.418653647030821e-02   -7.110107953053924e-01; -1.964693722414019e-02   +8.188446871063887e-01   +2.109956338784230e-01   -1.032694706643129e-01   +3.616140291832491e-01   -2.196275482919874e-01; +3.763419074931389e-01   +2.490319193695242e-01   -8.146742675009269e-01   -7.992070739340021e-02   +4.171562885374956e-01   -4.418527460287464e-01; +3.436467465192845e-01   -7.327389345316655e-01   +4.140904289061566e-02   +9.811884981937801e-01   -6.655454549774598e-01   +3.230302084318764e-02; +3.012610120763132e-02   -2.116322357244803e-01   +9.626073217455481e-01   +5.412044733936680e-01   -3.025432495598782e-01   -5.075971206802854e-01];
L3_L2_iAMPA_netcon = [+1.698334395028418e-01   +2.158740005706994e-01   -1.976891478798795e-01   -3.789186041833876e-01   +8.329948889787795e-01   -5.885667204564926e-01; +2.625963441344479e-01   +1.184983827154365e-01   -4.728379102456149e-02   -3.820215942601995e-01   +4.492787192496488e-02   -5.549582810111703e-01; +6.598679198109697e-01   -9.347335764911352e-01   -6.561591963990301e-01   -5.100407576774134e-01   -7.596915611844821e-01   +2.137721197608674e-01; -8.048053402623735e-02   +4.801291553479082e-01   +8.435273456548388e-01   +7.245630165543555e-01   -1.936816904974241e-01   +3.658161951180156e-01; -6.733789219396615e-01   -2.253338886726522e-01   +6.707648064850381e-01   +8.915625703334340e-01   +1.681389426297820e-01   +3.142287195501516e-01; +7.158563847657679e-01   +5.250354571518284e-01   +6.898810476156068e-01   -8.379317021249424e-01   +4.793359553671398e-01   -1.248520592802108e-01; +4.048242233633130e-01   +9.717768404067748e-01   +5.983086303622605e-01   +6.403206496308529e-02   -2.659360590056104e-01   -8.119532449338750e-01; -6.570034987338058e-01   +8.088013460917998e-01   +7.101029305856987e-01   +1.000000000000000e+00   +4.703507719943257e-01   +1.246864796800499e-01; +1.372237508510803e-01   -7.480459268830754e-01   +7.138265781952533e-01   -8.083511920325824e-01   -6.319273560170604e-01   -8.605357867985239e-01];
L2_L3_iGABA_netcon = [+7.811191928153634e-01   -3.886052203948462e-01   -3.535828089187577e-01   +8.598815293641051e-01   +5.944125102877329e-01   -5.332343242979336e-01   +2.252798487860599e-01   +1.004273245017284e-01   +1.219348972177295e-01; +2.818240892551791e-01   +5.504220322841783e-01   +7.852297627715547e-01   +6.582136294195037e-01   +7.900413104625662e-01   -5.580948190385317e-03   -3.332814273673789e-01   -4.324593501361393e-01   -2.829574252657386e-01; +1.988897586822799e-01   +1.000000000000000e+00   +3.054771683169191e-02   +1.103774312624876e-01   +7.347537312794744e-01   -7.916932803575425e-01   -2.317905398205999e-01   +1.581768634852865e-01   +5.540982110831449e-02; -8.818770871982986e-01   +3.226944298708443e-01   +6.730370263847015e-01   +4.687725530762306e-01   +7.529327179896782e-01   -1.385626629077652e-01   +3.736576929815366e-01   +4.682131384397178e-01   -4.667699879713395e-01; -6.151210514754787e-02   -1.800753431131011e-02   -5.971809532992348e-01   -8.503071655277797e-01   +5.951295945168364e-01   -5.914054054453773e-01   +4.979651170705410e-01   +8.903610458844347e-01   -1.916542808397144e-01; -7.526674622638535e-01   +3.282084565213354e-01   +7.887022043870268e-01   -8.092596344280231e-02   +2.165412238681198e-01   +4.037049868448008e-01   -2.266066006145658e-01   -5.714512693465903e-01   -7.967930507248455e-01];
L1_L4_iGABA_netcon = [-5.257325460297049e-01   -2.044258781552711e-01   -1.904815950400264e-01   +6.839128492555205e-01   +3.309873038098946e-01   -1.269974784857643e-01   +1.570312417839291e-01   -2.381587922919514e-02   +2.275109905599907e-01; +1.745447351028557e-03   +2.711150753692953e-01   -1.108710698914953e-01   -3.974275352934301e-01   -2.614853013027311e-01   -4.024475110451633e-01   -6.576864718344200e-01   +4.108612740956235e-01   -3.871982327899515e-01; -5.016030932464315e-01   +6.531229613426264e-01   -4.772615073324331e-01   +6.862228496130580e-01   -3.966733899643978e-01   +3.865522238755170e-01   -5.988050842441685e-01   +1.269074934175646e-01   +4.801980334779874e-01; -5.720423849102150e-01   -6.677987284722856e-01   -5.594251247075742e-01   -7.439972061246784e-02   -4.018961459844773e-01   +6.507781411781511e-01   -8.553228424620299e-02   -5.429896310063252e-01   -3.593657273503794e-01; -4.630128382967468e-01   -2.079681793312951e-02   +6.031556915456957e-01   -2.795488997055019e-02   -8.311325441290904e-02   +8.125997611752506e-03   -8.040406468173553e-01   +6.251327003686491e-01   -1.241437012576280e-01; +7.299157975574972e-01   +5.205053105788948e-01   -2.234792916063429e-01   +6.241661252092520e-01   -1.439684667788768e-01   +1.306735807548818e-01   +4.120921433969822e-01   +1.276129536919501e-01   -4.344132423774912e-02; +3.425183850515238e-01   -4.062847128755629e-01   -3.991931783095689e-01   -5.561442058170168e-01   +4.177462433737336e-01   -6.124507582043773e-02   -4.903352038789989e-01   +3.974547505673460e-02   +1.000000000000000e+00; +1.725161164966830e-01   -2.513735659510242e-01   -3.872117846644462e-01   +6.713989474008394e-01   +7.525332872414287e-01   -1.842264146737355e-01   -7.684190524831284e-01   +3.140103840847011e-01   -2.158611549575609e-01; -7.710329471031808e-01   -6.225324068199546e-01   -1.740828973172723e-01   +6.376578892995372e-01   +6.637906028285101e-01   -7.270485074895130e-01   +2.377424291691843e-01   +3.193167406614469e-01   -1.882331347184790e-01; -7.957628293569229e-01   +8.312658202163399e-01   -5.176114753169960e-01   -8.990533576179873e-01   -5.436559017224993e-01   -1.344475235848660e-01   +6.897977501366802e-01   -9.670014039305326e-01   -9.215077861139147e-01; +3.735199966570668e-01   -8.224033296949015e-01   -8.275534487283447e-01   -1.872331271606290e-01   +8.170301793611632e-01   +5.347439418352784e-01   -3.204617023016173e-01   +7.700705435600788e-02   -7.403397260129219e-02; -3.696889885806690e-01   +4.472782167613489e-02   -3.224657252366985e-01   -5.547944599539150e-02   +9.744501482429128e-01   +1.441590353834147e-01   +5.634177968563220e-01   +3.336141184242380e-01   -7.956454337552684e-01];
L4_L1_iAMPA_netcon = [-6.807405091688405e-01   -6.012557421976017e-01   -3.871571699960004e-01   -9.765926943695503e-01   -7.806826644432284e-01   +1.807492561625252e-01   +5.397529718728086e-02   -5.405667352318546e-01   -3.750583556243060e-01   -2.894797373399232e-01   +5.810569681669666e-01   +1.147891856858193e-01; +1.000000000000000e+00   -2.325977647040937e-01   +9.146212645192313e-01   +6.207678396392315e-01   -1.794881239382273e-01   +2.397521156216818e-01   +5.328718727679936e-01   -2.527289307775272e-01   -2.832768400146629e-01   -3.720452019892453e-01   +4.323426489633037e-01   -9.213649545372604e-01; +7.298076277328903e-01   -3.489307805602386e-01   -3.979796112679156e-01   -3.665103561924701e-01   -8.999778463864508e-02   -6.355801931658900e-01   -5.609381597215046e-01   -8.018170688929395e-01   -1.167051114299019e-01   -8.202361196045577e-01   +4.495521004456201e-01   +1.344895568913125e-01; -7.039193915776550e-01   -2.727027960733371e-01   -5.807767547428441e-01   +6.587038852861327e-01   -1.731035633218535e-01   +1.520169072889051e-01   +5.384945927517035e-01   -1.307886445214587e-01   -2.612357478215280e-01   +1.732250713966929e-01   +7.617969290223564e-01   +1.725320865350496e-01; +4.537320096179923e-01   -5.412471904640013e-01   +2.517947956556191e-01   -2.108776207839436e-01   +3.620919717913562e-01   +1.091140879172509e-01   +1.037634888896389e-04   -2.168156781103655e-01   +3.873759834391777e-02   +2.186399649108801e-01   +7.352005796430233e-01   -1.005740553063053e-02; -5.355958430904260e-01   +2.035337394066076e-01   -1.644234393781731e-01   +1.005475694245763e-01   +8.205915493208528e-01   -1.513654977044490e-01   -2.013290944807999e-01   -2.052955244083639e-01   -5.092898909140032e-01   -2.526786042330902e-01   -3.555352517185267e-01   +5.756073550447990e-01; +7.196243885787283e-01   -5.714198920440134e-01   -1.404234633368373e-02   +3.709676919293927e-01   -3.401303099257105e-01   -5.709214722556130e-01   -5.052725269618992e-01   +7.109293619278230e-01   +7.284009607427701e-02   -4.971857811626460e-01   +1.311274706914415e-01   +6.944556958072658e-01; +4.642250407010322e-01   -7.267245786323222e-01   +6.860718219322148e-02   +4.874502920069131e-01   -4.750828566206894e-01   -1.379886894828064e-01   -3.674713595931219e-01   +6.983125298743948e-01   +8.353941415624137e-02   +3.348102124739454e-01   -3.824661073265341e-01   +2.209625197304112e-01; +5.725019002413895e-01   -4.283466295776052e-01   +9.800264024642998e-02   -2.878155944727294e-01   -4.659246430861494e-01   -5.828632375007077e-01   +1.654112252034080e-01   -3.604405911484204e-01   +7.179558475530899e-01   -1.982020407640780e-01   +2.886864151763441e-01   -5.629261362139550e-01];
L1_L3_iAMPA_netcon = [+5.370577072178681e-01   +3.163032854406685e-02   +8.932535128480372e-01   -1.837928900911554e-01   -7.094405434610869e-01   +1.678582488108674e-01   +4.984515138746772e-01   +8.722181308583622e-01   +9.636285380911490e-01; +1.068810225521540e-01   -4.342321080187371e-01   -3.804350836506191e-01   -5.994279629036777e-01   -1.000000000000000e+00   +9.355067050111769e-01   +5.472429665863575e-01   +2.885572075199174e-01   +8.589962084455121e-01; -7.787768679193893e-02   +6.917106907688028e-01   +4.414627533792134e-02   -1.424133523764291e-01   +4.253280693706714e-01   +6.445464565571903e-01   +2.084146227637807e-01   +3.454573691650021e-01   -1.278495773338356e-01; -7.383947451317824e-01   -2.476470984048069e-03   -4.859162408836094e-01   -3.267627626673751e-01   +4.225712671051409e-01   +9.892464272770911e-02   -7.226041708590470e-01   +2.570257126083283e-01   +5.890249198744756e-01; -9.387781723354627e-01   +1.888297454148907e-01   -7.278994432040627e-01   -6.118405191462666e-02   +3.657167559457987e-01   +3.479389928684231e-02   -8.594508472636994e-01   -8.001398679712854e-01   +7.883848683430542e-01; +8.046612094227838e-02   -2.360080972774414e-01   +6.971345256675855e-01   +5.497242642092217e-01   +4.275363311121013e-02   +3.712580590142737e-01   -8.958082083425849e-01   +4.915492219547407e-01   -7.714813960635584e-01];
L3_L1_iGABA_netcon = [-6.522762599953099e-01   -7.976629850850361e-01   +4.495956421994704e-01   +1.552069853186324e-01   +1.533887628503897e-01   +8.478269883103569e-01; +8.669637106492221e-02   -3.161123471513103e-01   +2.478937423477696e-01   -7.157432538557083e-01   -8.268484852761431e-01   -3.903318396003561e-01; -8.125993641993948e-01   +8.817360458580026e-02   +4.419382517385084e-03   +1.216372527356199e-01   -4.190495361683305e-02   +2.078039233141244e-01; -9.720446481841937e-03   -3.986886408961927e-02   +7.832680957562840e-01   +4.973789604923416e-01   +4.295990312230155e-01   +8.115986247292524e-02; -8.442830225197211e-01   -1.320523654267485e-01   +5.373492401808323e-01   +4.206723416780990e-01   +9.876791885598857e-02   -9.440738678538611e-02; +4.538028580598854e-01   +5.043975812610912e-01   -1.000000000000000e+00   +6.406066794703692e-01   +6.745777685759180e-01   +3.857508821440951e-01; +3.240969228949311e-01   +2.848543634932996e-01   -7.799721945701004e-01   +3.614676230944668e-01   +5.981495644614674e-01   +4.615168917992101e-01; +1.906579316439597e-01   +3.314991511915269e-01   +5.659964065192039e-01   +9.706776620430431e-01   -2.104674852023334e-01   +4.097162046185983e-01; -6.955132643250089e-01   -7.232303033963200e-01   +1.242491163317704e-02   +7.457165079467344e-01   +4.651890475912565e-01   -4.792152764372310e-01];
L5_Input1_iAMPA_netcon = [-4.131275404763957e-01   +7.489011041861710e-02   -2.368847799740077e-01   +8.316225681591323e-01   +1.000000000000000e+00   +8.872745034938954e-01];
L6_Input2_iAMPA_netcon = [+2.104024085899227e-01   -1.000000000000000e+00   +7.290411275132588e-01   +5.392780481238197e-01   -5.656163773873673e-01   -9.043932187708729e-01];
L5_L6_iAMPA_netcon = [-5.446355354263568e-01   +5.809452588607397e-01   -6.543268834995171e-01   -6.326606510459292e-01   -4.934074952098859e-01   -4.006005447896147e-02; +8.484448284523608e-01   +8.581810215959307e-01   +8.724383219046977e-01   +5.714045289699783e-01   +7.498753661551681e-01   -3.650507385605918e-01; +5.700949119016113e-02   +5.522080410141202e-01   -4.609115765074855e-01   -7.767633722266720e-01   -6.387599630071319e-01   -3.783336390292054e-01; +6.521700727154101e-02   +5.694440906774136e-01   +1.115468271865435e-01   +8.468105381461455e-01   -3.704152798705732e-01   +3.541756844945275e-01; -4.074606015448328e-01   -6.610132133190013e-01   -7.372323202728572e-01   -8.093643224362361e-01   +8.091563854880437e-01   +4.700129167080918e-02; -1.000000000000000e+00   +1.549322835181514e-01   +4.302072030807986e-01   +4.365666943144548e-01   +6.432426124810923e-01   -9.463514080513841e-01];
L4_L5_iGABA_netcon = [+3.151815876403809e-01   +8.970594587431517e-01   +4.477288611267531e-01   +3.010163389469174e-01   +2.539339440023278e-01   -1.130080489165518e-01   +4.405277365138379e-01   +7.321659242936557e-01   +8.220495500901143e-01   +3.565154153986405e-01   +2.562705298124244e-01   +9.618672067435650e-01; -8.515786945442099e-01   +3.409903178181015e-01   +7.863785550741162e-01   +1.597130669894046e-01   -2.085274951266285e-01   -7.026077610910214e-02   +6.020049085236049e-01   -7.731339206891925e-01   -4.742764880081283e-02   -2.837576352839085e-01   +1.972752099451345e-01   -4.112014340503057e-01; +6.529686383041278e-01   +7.110378954017501e-01   -1.047897695600166e-01   -1.444828894951640e-01   -9.417327616292988e-01   -2.526135190389512e-01   -3.572694893355002e-01   +6.275430768285477e-01   -3.389000726236572e-01   -3.881248755152213e-01   -5.796255280529472e-01   +3.905802070506999e-01; +9.465168942000202e-02   -8.029945975693489e-01   -6.499748978709140e-01   -2.760830760991463e-01   +8.991482898094851e-01   +2.357693751919229e-01   -3.287137527103990e-01   +3.358770867998989e-01   -2.865374493559822e-01   +2.644384502163354e-01   -6.293327888763662e-01   +9.842920945135443e-01; +8.197816132740606e-01   -5.888702898470413e-01   -3.064233913137079e-01   +8.956618987059022e-01   -7.953139314102654e-01   -1.014424844630833e-01   +1.000000000000000e+00   -5.906264605017172e-01   +5.368773152313353e-01   -7.318846195589002e-01   +1.464166325531953e-01   +3.849524153348207e-01; +7.811193745129483e-01   -5.452304665922055e-01   +3.533859701342730e-01   +9.882148486210594e-02   +9.574164045456305e-01   +3.280749442888812e-01   +1.410126090423083e-01   -9.926294989353479e-01   +5.324422811062299e-01   +8.435178026843124e-01   +2.639254547872512e-01   +4.882497469987523e-01];
L6_L4_iAMPA_netcon = [+6.381359335009350e-01   +6.014381606709159e-01   -6.279265134549379e-01   +8.010372568660029e-01   +6.072962303696623e-02   -5.887125494530114e-01; +1.847663303175027e-01   -3.968806725935953e-01   +6.225056002775033e-01   -1.045424372429986e-01   -1.726771563685575e-01   -1.000000000000000e+00; +9.869384081904132e-01   +1.354041935119320e-01   -1.145638096167741e-01   -2.600693571501881e-01   +5.763986911937484e-01   +9.311672639911405e-01; -8.057597623973574e-02   +3.209078799102944e-02   +6.069139375592861e-01   +3.614429328619227e-02   +7.492019456387272e-01   +3.026166236731818e-01; -8.617766873234359e-03   -5.378521125925340e-01   +7.063789288584736e-01   -2.288530414964392e-01   -1.128481848090194e-01   +5.566059563633653e-01; -1.951340885118139e-01   -5.450228691607497e-01   -3.997091299127797e-02   +1.585837103622804e-01   -7.463669812745241e-01   +9.555814971266887e-01; -8.778382285739719e-01   -2.466070369825449e-01   +3.577656625325053e-01   -6.908829879144125e-02   -4.260025351609734e-02   +7.738590383966125e-01; -8.555082775778521e-01   -1.180570071457267e-01   -1.284865516037736e-01   -3.306899524458523e-01   -7.903071142294806e-01   +7.805038595728626e-02; +5.169492611111975e-01   -3.248880140314692e-01   -1.106148989772946e-02   -4.260209187477521e-01   -4.912719645129440e-01   +1.173293215461080e-01; -2.462756085420713e-02   +1.078735019786775e-02   +7.829632536211909e-01   +9.271164651149715e-01   +5.629770073550287e-02   -7.453455264073402e-01; +7.186684699047884e-01   +5.033715812783393e-01   -8.298067922846828e-01   +7.534829139592527e-01   +1.032796867814047e-01   -1.725880195716269e-01; -8.986584145322022e-01   -3.114421827650656e-01   -7.033763722016533e-01   -8.914474680767548e-01   +3.224458423560852e-01   -8.180016427448423e-01];
L5_L4_iAMPA_netcon = [-4.690452072455807e-01   +6.089277991662041e-01   -1.754780689931746e-01   +6.899073961979642e-01   +8.989735702150983e-01   -1.192338910621325e-01; -7.685861514282415e-01   +2.674217590593110e-01   +6.788104872615420e-01   +4.863592851489345e-01   +3.481227401826348e-01   -1.989401197430258e-01; -5.910263660693605e-01   -3.614553744716276e-01   +7.276376808649915e-01   -6.264414495185701e-01   +9.956716010505932e-02   +4.694839688191215e-01; -4.441731394224647e-01   -4.276001800502358e-01   +1.624841127041067e-01   -3.959884803030104e-02   +1.728166723798116e-01   +6.059739789249122e-01; -9.616568888848134e-01   +8.871518284056993e-03   +2.888518364730704e-01   +3.535145279391712e-01   +7.892994013336201e-01   -2.128137465470551e-01; -4.700024979694765e-01   +7.057845165551320e-02   -1.608711317181164e-02   -5.118985960883733e-01   +6.275444429965572e-01   -6.811308070539868e-01; +4.282044329432211e-01   -1.329416926440204e-01   +1.000000000000000e+00   +2.567868495009797e-01   -6.622318317992262e-01   -7.594930479557794e-01; +7.180876085704087e-01   +1.468597703339485e-01   -1.939808050901076e-01   +6.590880669473550e-01   +9.360936865747285e-03   +3.157735198273371e-01; -1.616126688089040e-01   +7.537841662952499e-01   +5.756102360367906e-01   +4.845502597311488e-01   +5.008329160630283e-01   -3.560073916065178e-01; -9.224799216318819e-01   +2.455003261913632e-01   -3.168148723758399e-01   +1.962185227258431e-01   -7.861492921131278e-01   -5.164013597328996e-01; -4.106451396924798e-01   -9.550862559472658e-01   -6.128825897467582e-01   +5.538208649575413e-01   +6.729800229493746e-01   +5.859192243991280e-01; -4.446181015726547e-01   -3.741345318104064e-01   +8.927616383348098e-01   -7.912300561921251e-01   +8.693404984247638e-01   +2.883871176537491e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
