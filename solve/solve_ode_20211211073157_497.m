function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.083631374626164e-01   +2.457132987439893e-01   +8.938795327365457e-01   +8.258147688818644e-01   +1.635393076351326e-01   +8.412703609858182e-01   +6.062750805737193e-01   -8.282001481672777e-02   +2.105224501957139e-01; +2.761182066916806e-01   +1.111826182237818e-01   +1.761138195460421e-01   +6.360930432453376e-01   +1.000000000000000e+00   +6.382744136130917e-01   +7.200962354536596e-01   +1.400485498004022e-01   +6.765709606280516e-01; +1.104491980815924e-01   +6.851458284344989e-01   +3.826005976126157e-01   -6.825656115321176e-02   +2.409627942890568e-01   +3.579835218419430e-01   +3.149065442874885e-01   +7.723826570107740e-02   +3.297900052200275e-01; +4.829521314861225e-01   -1.400257133020342e-01   -2.169113820053538e-01   +1.467870901743208e-01   -3.807677014370390e-01   +3.629348258305137e-01   -5.760850616162116e-03   +2.902609487524593e-01   +1.530565425274074e-01; -2.985684231580735e-01   -1.469397315818095e-02   +2.467730275029638e-01   +5.435147600960702e-01   +5.902348397097593e-01   +6.294455007129484e-01   +4.832465317556227e-01   +6.154254510259920e-01   -6.292513180004697e-02; -1.297135583158960e-01   +3.469670205758145e-01   +6.168626581032587e-01   +3.163122591873296e-01   +2.240094122697946e-01   +2.899196442074143e-01   +4.678296734462671e-01   +6.209836760214220e-01   -5.126824609205982e-03; +6.326247630230396e-01   +1.934173365530300e-01   +1.288528440788944e-01   +2.742556361968119e-01   +1.444379793324128e-01   -1.394399794971662e-01   -2.297116208706686e-01   -7.575173095220879e-02   +1.972125361825300e-02; -4.325422885841135e-02   -2.671680336517692e-01   +9.416961059280473e-01   +3.230694088923773e-01   +1.185115680587248e-01   +7.206450338407273e-01   -8.053219290292804e-02   +8.642239457305062e-01   -1.784509440937003e-01; +3.050464652183394e-02   +6.967454225170987e-01   +3.698061936133306e-01   +1.367890730583761e-01   +5.755473243940300e-01   +6.736757197854648e-02   +5.323697509149631e-01   +3.207480847530061e-01   +4.192779821272389e-01];
L1_L2_iAMPA_netcon = [+6.447041897457926e-01   +5.304369591719040e-01   -1.389868000118147e-01   +4.483631045704346e-01   +5.866254714842712e-01   +7.210005328171953e-01   +2.778519912295507e-01   +2.190234791075606e-01   -2.590346258353706e-01; +3.319133544691132e-01   -1.259084831352739e-02   +9.656746845288708e-01   +3.790082671249132e-01   -1.622906060822864e-01   +2.763688908641371e-01   -2.381847104155539e-01   +1.470469379679250e-01   -2.622822036571507e-01; -7.490690944809830e-02   +3.113674118823499e-01   +1.773507168507736e-01   +1.813475486090894e-01   +2.051265671722344e-01   +3.436944672349008e-01   +4.835293168832190e-01   +3.390957512235087e-01   +6.285811748480370e-01; +2.504518714338282e-01   -1.697245016904979e-01   -2.351323876065290e-01   +4.215013527222753e-01   +4.302808203477851e-01   +8.264017048563315e-01   -3.010787550561687e-01   +9.315837754719708e-02   +3.660026751076610e-01; +5.624730418682058e-01   +2.090166885977195e-01   +3.296027135998087e-01   +4.545482055098660e-01   +5.406084932066793e-01   -5.732021399700445e-01   +6.376759684677756e-01   +4.199622650811500e-01   +4.024956472227716e-01; +3.287180841554517e-01   +7.375555927189574e-01   +1.874021105956243e-01   +1.550029808806699e-01   -3.486253006446534e-01   +2.530972985948847e-01   +5.087313513250555e-02   -1.483827868101278e-01   +4.919759312755935e-01; +9.307347413387488e-01   +3.265215021672798e-01   +6.661205421056728e-01   -2.273117535319032e-02   -1.911453686107397e-01   +4.396002879604793e-01   +1.992056423731388e-01   -2.475667360750438e-01   -1.535560822994597e-02; +4.137529047605166e-01   +6.331792263271594e-01   +2.575886762861708e-01   -8.170396349208686e-03   +1.318306701885608e-02   -1.281586557702799e-01   +3.361312295944258e-01   +4.394685557554875e-01   +6.279287821482121e-02; +7.416014993727854e-01   +7.344445320477908e-01   +2.147612558159139e-01   +6.011693087511905e-02   +6.336994170358912e-02   +1.071495074305164e-01   +2.595377551216313e-01   +5.569979516371597e-01   -6.044883735859385e-02];
L2_L5_iAMPA_netcon = [+6.482929479844021e-02   +5.026356511948862e-01   +3.930002860542992e-01   +9.903086266307877e-01   -2.134117576471788e-01   +4.172282723041304e-01   +4.303541280942865e-01   +3.285063888051845e-02   +5.768937312944472e-02; -1.566955143606414e-01   +3.399626765373013e-02   +5.471847544781062e-01   -1.374948244343665e-01   +1.630847381021719e-01   +5.419634098402125e-01   +8.107968205153571e-02   +8.694632701697523e-01   +1.060367112457358e-01; +1.394701768253906e-01   -2.416864552879717e-01   -3.288500865387509e-01   -5.850361367185415e-01   +6.232585804574314e-02   -9.841065257728461e-02   +4.276658552522374e-03   +1.519708575733043e-01   +6.210321763885598e-01; -1.165193296901740e-02   +3.139082942156486e-01   +1.620884526492433e-01   +4.742497405118112e-01   -1.092117184598689e-01   +5.434136638891186e-01   +3.202027583216293e-01   +6.194453376991059e-01   +1.000000000000000e+00; +1.977656074132794e-01   -9.331587721459955e-02   +3.928585585446404e-01   +3.570832778682665e-01   -3.249604170907722e-01   +2.461144596624170e-01   +1.932402362423093e-01   -1.856963077146076e-02   +6.907786596460861e-01; +1.078928678255368e-01   +5.347560561658590e-01   -1.099144484014602e-01   +4.197918351762375e-01   -2.415984776013953e-03   +6.957540078067348e-01   +1.876690387542654e-01   +4.386377602431642e-01   +5.063456632637805e-01];
L5_L2_iGABA_netcon = [-3.830453835314039e-01   +3.131889361745132e-01   +6.850650116305267e-01   +2.318388316216567e-01   +1.644493560366682e-01   +3.270930430799825e-01; +5.355167909657080e-01   -8.008326320191242e-02   +5.119108857868987e-01   +4.839988084607868e-01   +6.840929526204456e-01   +2.490315537131391e-01; +8.871423223325902e-01   +1.203998609189794e-02   +9.142609511651552e-01   -1.925229316364310e-02   +8.780952375699751e-01   +2.316843059095089e-01; +2.757681093651896e-01   +5.328510634543138e-01   +4.744819358061236e-01   +3.915873271486644e-01   +2.896766896553641e-01   -1.276225486196102e-01; +1.382973561649051e-01   +4.871644169324566e-01   +4.737064381371886e-01   -4.331372564068756e-01   -1.141662497819231e-02   -1.671536319798547e-01; +3.218805372203994e-01   +5.459992966365042e-01   +5.989911695864957e-01   +1.612891373826302e-01   -1.724505557530576e-02   +8.407789681740756e-01; -6.139634877331096e-02   -4.423978194187945e-01   -3.510200085048662e-01   +2.780120956549217e-01   +4.238421325684930e-01   +8.547403406184382e-01; +7.299440895265475e-01   +1.544309554897508e-01   -9.902332148907994e-02   -2.713409675608097e-03   +4.139788943321723e-01   -3.300638977628716e-01; +6.291905651084548e-01   +1.755468988413773e-01   +1.906995895059482e-01   +4.927859754396232e-01   +1.778112869074400e-02   +4.477722517065056e-01];
L3_L2_iAMPA_netcon = [+1.728752949046380e-01   -3.456480331587568e-02   -2.135483490088387e-01   +5.772474139394080e-01   +1.743805444758127e-01   +8.207059141778300e-02; +6.041255617189536e-01   -2.308843974653845e-01   +7.946821770885990e-02   +3.502532701382648e-01   +7.268062145840148e-01   -2.375175404182761e-01; +8.086418062219639e-02   +4.766374214787232e-01   -3.557727780383139e-01   +2.317101025502695e-01   +2.043852172296005e-01   +7.605807935941544e-01; +3.197469549022890e-01   +7.552146674778285e-01   +3.573985291555856e-01   +7.414611738480741e-01   +2.525895792379409e-01   +2.914031016582082e-01; +8.680158802137700e-02   +3.711284772414140e-01   +3.619478686181297e-01   +4.238775177950623e-01   +7.712587843794907e-01   +4.120655030086537e-01; +5.811116910745637e-02   +8.185668308016113e-01   +8.469539875398835e-03   +4.838818765078421e-01   +7.646094631051368e-01   +4.415419420983093e-01; +7.614094880173149e-01   -2.603964506787224e-01   +5.947519965740072e-01   +1.834157975557922e-01   -3.230645735898592e-01   -4.689082437641710e-01; +3.933832644910251e-01   +2.987240519574693e-01   +4.022839458143891e-01   +4.204495640702095e-01   +2.611739732155706e-01   +5.559902888005543e-01; +8.081243600602409e-02   -3.841915298193667e-01   -3.131240644756115e-01   +3.728409296928014e-01   +2.875248040385625e-01   -1.734945979670439e-01];
L2_L3_iGABA_netcon = [+8.717592522516893e-02   +2.941971395022569e-01   -1.847422392979352e-01   +6.196008983316621e-01   +1.306300421353073e-01   -1.947474144783483e-01   +2.500591364563847e-01   +1.494638998633780e-01   +3.151684421031026e-01; +1.847090588737373e-01   -3.147890025914596e-01   +9.119042080102697e-01   -4.381516533502663e-01   +3.678914437696847e-01   +8.793869938924553e-01   +3.048844382692075e-01   +5.329570677206109e-01   +1.227252905543983e-01; +8.261014657928905e-01   -6.301687244171449e-01   +1.164720249744586e-01   -7.833839485392041e-02   +2.883677515143770e-01   +2.618238605805133e-01   +2.283291037459380e-01   +2.974400090669507e-01   +4.043709748002348e-01; +8.586958549608155e-01   +2.625878209643414e-01   -3.714065104826200e-01   +7.215110273447561e-02   +6.090936372388283e-01   +8.839343914690991e-01   +2.612958040458968e-01   +3.493479780622778e-01   -2.206612286184568e-01; +4.790621047406787e-01   -4.916415300777482e-02   +4.087064134848120e-01   -7.214535715963173e-02   +1.095995799978877e-02   +5.739946612916691e-01   +6.898874557707223e-01   -1.781844398575827e-02   +8.154326346099849e-01; +1.217389841563654e-01   +6.141343705066129e-01   +3.255538597690820e-01   +5.704300588414271e-01   +6.166637180215178e-01   +5.699922999760640e-01   +5.688397340114326e-02   -4.404828284307516e-01   +3.933991681101243e-01];
L1_L4_iGABA_netcon = [+1.771875843279116e-02   +2.744920546583118e-01   +3.791931900975106e-01   -4.994160754474358e-02   +2.900876096230601e-02   +3.200529026888838e-01   +1.222316646325113e-01   +2.314351660643938e-02   +3.046649075594678e-01; +2.840895015267793e-01   +3.301155619584649e-01   +5.261085721723312e-01   +5.928261415127331e-01   +7.491831116629898e-01   +7.793917815922105e-02   +7.499685953132508e-01   +9.301924766277827e-01   +2.936921067438260e-01; +8.826860002153097e-01   -8.327502818416332e-03   +4.384719432810585e-01   +1.961832467112694e-01   +3.585360861923934e-02   +9.680247603621887e-01   +1.444939315656493e-02   +1.672183309497192e-01   +1.475429251518463e-01; +1.000000000000000e+00   -3.630859868054508e-02   +4.972476895356316e-01   +4.926792049141803e-01   +5.353276100355818e-01   +3.536043467457646e-01   +6.104835466857841e-01   +1.078812222390639e-01   +1.875641842062070e-01; +1.484043984727720e-01   +4.929552197798184e-01   +8.177199100781699e-01   +4.168928111302930e-01   -3.641188934436151e-01   +2.013060362719996e-01   +2.801666207388143e-01   +9.940832288030636e-02   +1.796264307586193e-01; +7.548229295029389e-01   +8.389832426719696e-02   +1.827850634153227e-01   +8.555688447401599e-02   +2.289159671920074e-01   +9.351813664342576e-01   +3.168530715091452e-01   +4.708121730220730e-02   +3.811333549548427e-01; +3.653439159021460e-01   -4.630959507455745e-01   +3.159470114708016e-01   -4.766783493519713e-02   +3.449369217746868e-01   +5.508975260569138e-01   +5.286235601901923e-01   +5.176986071259416e-01   +1.038034528964877e-01; +8.870227553170966e-02   +6.045249941036800e-01   +2.136918353559959e-01   +1.004396694800410e-01   +1.657561604472393e-01   +1.002372432644750e-01   +5.941413018947809e-01   +6.755094627485898e-02   -1.672543820826022e-01; +4.629495691011555e-01   +5.359194666312368e-01   +4.068283764924638e-01   +2.609909344824184e-01   +2.601591639987511e-01   +2.660571159791175e-01   +2.335795186754522e-01   +2.023934952578652e-01   +1.447607825902188e-01; +6.320645733175685e-01   -2.191547465773177e-01   +8.646095085160471e-02   -1.695369372389985e-01   +7.181176110124782e-01   +3.715623387974961e-01   +1.952597625359827e-02   -9.466944108065183e-02   +1.934087562762248e-01; +9.184628647115275e-01   -2.335089316625988e-01   -3.831507294393444e-01   -4.037772761350627e-02   +1.020504255055557e-01   -1.242315214161851e-02   -1.487179977951265e-01   -1.489609744795170e-01   +3.104826016197462e-01; +1.639043640303497e-01   -5.709976659557389e-02   +6.820748437226855e-01   +3.646545529036833e-01   +1.098764610991478e-01   -3.310767048794468e-01   +6.630769738066710e-01   -2.089766376727760e-01   +3.123299942835314e-01];
L4_L1_iAMPA_netcon = [+4.215415010829345e-01   +4.675004920368089e-02   +1.973619366986882e-01   +7.064958458785406e-01   +2.355081562106046e-01   +1.669517491251447e-01   +3.060835118699541e-01   +2.731868051332841e-01   +6.483576480468725e-01   +2.007308695772270e-01   +1.047599626184559e-01   +7.503295675665258e-01; -1.724196999773310e-01   +7.194154763484750e-01   +1.139345021582737e-01   +3.400138678129764e-01   +1.721095544201255e-01   +1.134409147257637e-01   +5.769874593280975e-01   +5.234765484025783e-01   -1.680122011037176e-01   -2.804965767984097e-01   +4.232737865680990e-01   +3.451096362805817e-01; +4.457679659646656e-01   -2.083903522248878e-01   +1.415119832086585e-01   +1.999967100321884e-01   +4.229794962346473e-01   -6.042742593974618e-03   -5.880507661847637e-02   -3.141358720260072e-02   -2.480726674941315e-01   -8.935210960554470e-03   -2.214081780445958e-01   -2.217324141028687e-01; +1.543801651829110e-01   +1.809780690183692e-02   +6.139497345599969e-01   -1.918420783594314e-01   +5.682372285480080e-01   +5.797135709802639e-01   +3.380822121671812e-01   -2.442366412692515e-01   +8.237874469097641e-01   +1.051215321477973e-01   +7.011045962757829e-01   -3.031784094299184e-02; +3.718408295477638e-01   +1.778814704657592e-01   +3.249762328529456e-01   +3.105086807818391e-01   +1.812257000230178e-01   -3.525515444267151e-02   +1.610167397856951e-01   +6.981702661286440e-01   +6.806537075824933e-01   +2.691675204889595e-01   +2.715888824590054e-01   +7.771675405878400e-01; +2.259218739964716e-01   +4.574802611931362e-01   +1.048437213631394e-01   +2.784601634928794e-01   -3.242702949223635e-03   +1.962297905952151e-01   +7.110624465439237e-01   -1.280902271427720e-01   +5.859171582718090e-01   +4.588132062912073e-01   +3.267436232979740e-01   +1.902829847235736e-01; +5.531793824225324e-01   -1.259156123253852e-01   +6.593025271870918e-01   +5.948075173930701e-01   +2.871246669336598e-01   -2.770163052986317e-02   +2.726501075200864e-01   -1.684801465061110e-01   +6.232807784722174e-01   +5.519388128590431e-01   +7.545283251678808e-01   +1.000000000000000e+00; +6.604403239777616e-01   +5.835861112945153e-01   +3.255031447460666e-01   +3.213133896532651e-01   +1.386857735409374e-01   +3.808998812008763e-01   -1.964278407028110e-01   +6.035823679928302e-02   -4.354457692574922e-01   +3.802140601102306e-01   -2.246281350491798e-01   +6.023452271513812e-02; +1.818870257471044e-01   +3.619395885962258e-01   +4.557582754788249e-01   +7.481061554466350e-04   -2.765708460480527e-01   +4.665938658996782e-01   -4.682789646951713e-01   +1.504804358600450e-01   -1.678766224169955e-01   +1.668894834682773e-01   -3.706213795659469e-02   -4.260165166369145e-02];
L1_L3_iAMPA_netcon = [+8.000270730495105e-01   -3.694447688171489e-01   +2.053135994596852e-01   +6.271413928108509e-03   -2.202421438030195e-01   +2.979388614011133e-01   +1.954306766419711e-01   +2.084792532446872e-01   +2.355577412634232e-01; -3.672665526799417e-01   +9.819334994534152e-01   +3.303183864790113e-01   +1.075050354437043e-01   -3.824548434595545e-01   +7.205558725038881e-01   +3.766807851839819e-01   +4.258956183454720e-01   +9.649391634907852e-01; +5.335815997223348e-01   +1.000000000000000e+00   -3.925010526555632e-02   -1.306233254265049e-01   -8.971502672590166e-02   +6.586644061964142e-02   -7.407463555657796e-02   +2.854284619526112e-01   +3.395061067996566e-01; -9.548148344940510e-02   -1.996054604170931e-01   +1.464762630677338e-01   +1.699437486160327e-01   +6.054591296292345e-01   +1.282551571028888e-02   -5.873014865151131e-02   -3.166326848987839e-01   +5.183515134962856e-01; +6.429049606592627e-01   +3.935931360001629e-01   +8.285438589760862e-01   +4.582253682631883e-01   +1.771392083690668e-01   -2.949111262141514e-01   +2.898353900241742e-01   -6.442063174158942e-03   +7.945288546170005e-01; +4.238651009212782e-01   +4.732844409543606e-01   +5.032538696528650e-01   +5.556586184568458e-01   +3.387996871893814e-01   -2.104760244082269e-01   +4.245959594480662e-01   +5.238985915162750e-01   -4.074939430745992e-02];
L3_L1_iGABA_netcon = [+2.671457744410644e-01   +5.980682640679842e-02   +2.711382768679903e-01   +3.011853734350845e-01   +3.256645299388822e-01   +3.218896459111525e-01; +2.946002477321145e-01   +5.209039589363422e-01   -1.569964752267422e-02   -2.417981125474679e-01   +1.237111487158218e-01   -3.914394741653096e-02; +1.878817038588564e-01   +7.142026786586951e-01   +6.406112031512756e-02   +7.233400383863998e-01   +6.341252307417488e-01   -2.212898726902346e-01; +5.551352522551182e-01   +2.112689002944930e-01   +1.000000000000000e+00   +5.330552600087605e-01   +7.391289726691698e-01   +3.341325817340976e-01; +3.396334610589369e-01   +7.232714598500324e-01   +3.666197105892724e-01   +2.245397008668406e-01   -2.719651416317688e-01   +1.163453073998200e-01; -4.020066368629615e-02   +1.132195339540083e-01   +1.459477982608845e-03   +1.267009552894681e-01   +9.352309758604943e-02   +5.049292252668124e-01; -2.800236713269075e-02   +8.513199875566736e-02   +1.081523808020351e-01   +5.773897539293370e-01   -1.063974969608485e-01   +2.346695259758299e-01; +7.918276612726184e-01   +3.916304039205875e-01   +5.283195006265569e-01   +7.217051716744483e-01   -2.566436355882487e-01   +2.217829524562794e-01; +1.146906761060127e-01   +2.739584444147527e-02   +4.627498319581455e-01   -3.968504756737201e-04   -1.805227308882397e-01   +1.981431727710617e-01];
L5_Input1_iAMPA_netcon = [+3.293422779608914e-01   +5.325759371868051e-01   +8.311660083914458e-01   +7.776544300374363e-01   +6.931420731276816e-01   +3.122057935271193e-01];
L6_Input2_iAMPA_netcon = [+2.728218717719869e-01   +6.544234371401381e-01   +4.327955324865243e-01   +9.892882044923930e-01   -2.299244380761559e-01   -6.167225418358679e-02];
L5_L6_iAMPA_netcon = [+5.828488591895739e-01   +9.039384701629850e-02   +1.622670731029314e-01   +1.487902146339846e-01   -1.790409597347212e-01   -2.338695135624603e-01; -5.362009761307055e-02   -8.327365028836176e-02   +8.565595418351600e-01   +5.518679905379296e-01   +4.668956029454988e-01   +1.612400040283809e-01; +9.530699838099668e-02   +2.353627288567632e-01   +3.441820075306214e-01   +7.250034500808099e-02   +2.871672721494561e-01   -2.839913578075146e-01; +2.237773575881186e-02   +2.633557219194478e-01   -6.324121850693952e-02   -1.120747589837218e-01   -8.434964731668858e-02   +4.857731299731124e-01; +6.088471206297663e-01   +3.199995880809872e-01   +2.649341454548437e-01   +7.931912973187548e-01   +2.319955221868187e-01   -7.200169394839280e-02; +1.772050927798539e-02   +4.383774132257536e-01   +7.063913267047373e-02   +6.072274710014156e-02   +1.000000000000000e+00   -1.983523875096267e-01];
L4_L5_iGABA_netcon = [+4.586325692233966e-01   +6.943545232571779e-01   +1.000000000000000e+00   +5.617231369571450e-01   +5.990386435544993e-01   -1.051320670081391e-01   +4.269501760585550e-01   +1.582183314230985e-01   -2.067935412533197e-01   +8.731295861732075e-01   +3.870843105619894e-01   +3.612374267618096e-01; +4.857829577447423e-01   +3.578047499019891e-01   +3.902462958028500e-01   +4.466877453250614e-01   +6.554136919736162e-01   +3.267635626308042e-01   -6.494416346222291e-02   +1.404945895204446e-01   +4.256383433137204e-01   +4.760147968479225e-01   -9.901259683004611e-02   +6.997924499970285e-01; +7.054848577587959e-01   +5.173626861669516e-01   +1.878819126636292e-01   +2.207215039970441e-01   +2.915199834685411e-01   +2.177010384001636e-01   +3.298226223321874e-01   +2.185045946304454e-01   +2.888367381276711e-01   +9.789287742503447e-01   -4.134714348701846e-02   -3.828826179486997e-01; -5.166895282652839e-01   +5.150508423890325e-01   +6.612322962360793e-01   +4.580458331450747e-01   +2.231756100077155e-01   +4.030973504638873e-01   +5.537232973671219e-01   +2.565161900888967e-01   +4.306140562373150e-01   +8.207432559982357e-01   +4.949081610311458e-01   +5.569497203148794e-01; +3.494343551588824e-01   +9.843292101624339e-02   +3.405617976371870e-01   -1.182711419759283e-01   +8.073862253844667e-01   -7.890057609394525e-02   +4.983863562306696e-01   +1.302126827492027e-01   +7.367488696290259e-02   +2.715149511965129e-01   +6.249774494207382e-01   +1.625556344005387e-01; +4.505753768062355e-01   +4.240697029226654e-01   +2.577178035186564e-01   +4.260984667043397e-02   +6.882788384939252e-01   -4.437464282085951e-01   -1.628052799777971e-02   +4.411460074744675e-01   +1.923720405849363e-01   +2.248525517270055e-01   +4.043676628782302e-02   +3.162776623059536e-01];
L6_L4_iAMPA_netcon = [+3.780289103584401e-01   +6.648241054925528e-01   +7.537956824967990e-01   +3.129662808253466e-01   +6.211194069259407e-04   +2.436162947272828e-01; +7.503178018140224e-01   +7.984296398843093e-01   +1.884789782380705e-01   +1.689873275451012e-01   +1.083526187249495e-01   +3.857965100804472e-01; +6.895792402767473e-01   -2.960705118279996e-01   +5.164611309143254e-02   +4.423330481355879e-01   -3.631419942814679e-01   +1.659401669822607e-01; +5.980593716266904e-01   +3.402458605877641e-01   +6.441802681459790e-01   -1.262669186086759e-01   +2.644554247034551e-01   +2.640711133038529e-01; -7.077906182094681e-02   +4.284889608617086e-01   +3.953566964396552e-01   +3.979888286720268e-01   +5.600033669633060e-01   +4.764274809604489e-01; +7.060084325420628e-01   +5.062492726014123e-01   -3.550184968590275e-03   -5.103146866693418e-01   +7.561398743550309e-01   +3.013750548816211e-01; +9.833296793778279e-01   +2.051163973299938e-01   +7.390293541955767e-02   +7.109284409794985e-01   -1.471530548526963e-01   +6.495586742178350e-01; -1.532029563106218e-01   -1.248827402397713e-01   -5.135541729184667e-02   -2.809860267096850e-01   +3.369100419969401e-01   -1.168698131458750e-01; -2.754459735797734e-01   +4.605208830550747e-01   +6.288909415190458e-01   +5.260665911863727e-01   +9.797808943548286e-03   +5.391538401661702e-01; -6.756181947390372e-02   +6.576060784742599e-04   +4.598890605984607e-02   -1.744880203175233e-01   +2.840258234438453e-03   +1.558000356928468e-02; -1.005302431384799e-01   +4.312333989815857e-01   +5.136486300675246e-02   +2.949772622677673e-01   +7.057694956280974e-01   +6.623179045023689e-01; +1.250946508294303e-01   +3.467197596041804e-02   -2.287463707140596e-01   +8.824176892747724e-01   +8.470974496807688e-01   +6.835250813424054e-01];
L5_L4_iAMPA_netcon = [+6.829323299779654e-02   +6.273177084600096e-01   +9.720162815538985e-01   +3.639149907117351e-01   +6.958007164778737e-01   +6.496383776732785e-01; +1.581142344641524e-01   +1.478963104868188e-01   +5.398012844165644e-02   +4.721748850526957e-01   -1.753622363242431e-01   +9.851984987251174e-01; +4.009221091616261e-01   +5.746735770145887e-01   -4.477551503441310e-03   +5.536835549361065e-01   +2.902654402354078e-01   +6.621630264298324e-01; +3.533909448366270e-01   -1.722399202129478e-01   +5.472879903678286e-02   +1.959312326440917e-01   +1.886166619082154e-01   +2.771210845419508e-01; +3.261944443469125e-02   +2.330888806016096e-01   +1.276475205424161e-01   +4.810877018736276e-01   -1.923001684677493e-01   +6.711606299534977e-01; +4.342252383227009e-01   -2.468951342979754e-03   +4.184469930637874e-01   +2.183554395505736e-01   +4.455386279377918e-01   +7.899681316981512e-02; +4.612201823231420e-02   +5.037871292764922e-01   +4.951105374099947e-02   +9.935377785803743e-01   +2.417077877383234e-02   +1.000000000000000e+00; -1.388164199745161e-01   -2.281484359064536e-01   +5.824799286788872e-01   +3.349777001421746e-01   -5.876805402496142e-02   +1.741688056066747e-01; +2.352457004907462e-01   +4.365844188885500e-01   +7.272051922331508e-01   +2.316832667980895e-01   +5.187542159615337e-01   +1.669019735628284e-01; +6.678270226045214e-01   -2.706960666055783e-01   -3.915974928276078e-01   +6.750363697311842e-01   +7.226663642850151e-01   -1.911315774611412e-01; +5.293829814268641e-01   +2.997935597440869e-01   +8.728185396212344e-02   +2.138086064166822e-01   +1.417677346068116e-01   +3.792634944268661e-01; -2.072125678931124e-01   +2.651781559854283e-01   +1.283416938758487e-01   -4.162936768253087e-01   -2.679305586924125e-02   +2.959300019973475e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
