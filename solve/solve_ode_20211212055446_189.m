function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.999860826409878e-01   +6.878381640458978e-01   -5.367522768245963e-01   -4.694649922572223e-01   +6.433029623675605e-01   -7.715034374500142e-01   +5.190545599022336e-01   +3.521755006936071e-01   +3.282847830706848e-01; -1.000000000000000e+00   -8.952795519685897e-01   -4.895926160202067e-01   +3.274015803595181e-01   -9.658671532362749e-01   +6.625071408251646e-01   +3.645686773055332e-01   +5.633563398930557e-03   +1.609854569790913e-01; -1.146667005522471e-01   +8.795102397425463e-01   +2.651521611735745e-01   -7.202537146959189e-01   -1.672335526393437e-01   -4.759285394984944e-01   -3.463690447122374e-02   +4.243318822962360e-01   +8.157012616756028e-01; -8.598735620564634e-01   +2.362445452860453e-01   +6.421343957956824e-01   -3.259973899592527e-01   +4.305146325717290e-01   +4.440489478926666e-01   +3.860543968765185e-03   +7.393450598788688e-01   -5.328845218183228e-01; +4.700436939600339e-01   +7.187886216213596e-01   -1.827906347773829e-01   -1.593645292577720e-02   -4.798355122967665e-02   -2.238561981028061e-01   -7.339089541108332e-01   +7.092318333685509e-01   -5.565957445339832e-01; +5.533543961382028e-01   -8.758271568711097e-02   -7.236440379806142e-01   +1.113341854240102e-01   -1.618560192605870e-01   +5.756834047699944e-01   +7.694640203604984e-01   -6.472212523187061e-01   -7.896984837726044e-01; -6.666737355314786e-01   +3.661472507431204e-01   +8.718335504279392e-01   -9.462469317955094e-02   +8.669141760207937e-01   -7.764678166176969e-01   -4.549510698939230e-01   -5.198761560850882e-01   +1.238820600143512e-01; +6.162579145240891e-01   -3.635127735738390e-01   -7.386217119079537e-01   +6.818525909433689e-01   -8.926571647040793e-01   +9.924101832004850e-01   -5.411379746113217e-01   -4.165732044410223e-01   +8.022897595745224e-01; -1.856833716294479e-01   -1.571251123446630e-01   -2.006538129789119e-01   +5.623223236293702e-01   -4.857636571781241e-01   +3.019665300717144e-01   +8.132606573580181e-02   +5.215691610999533e-02   +9.464944800861073e-01];
L1_L2_iAMPA_netcon = [+5.090040338352426e-01   -3.124997138418943e-01   -5.405350282941935e-02   -3.459363689762849e-01   -9.851754097119654e-02   -6.654426460067059e-01   +6.276621081790246e-02   -3.754010433615177e-01   +6.102965351571057e-01; -5.607919157175375e-01   +1.550273422332206e-02   +7.639176908204338e-01   -2.616623312075160e-01   -5.651502093902646e-01   -5.110293264716772e-01   +2.122621978940906e-01   -1.000000000000000e+00   -8.266910302725137e-01; +2.312066441630353e-01   -6.238546342465748e-01   +8.539966170518718e-01   +1.691565494775926e-01   +5.115365539163235e-01   -7.241899645429488e-01   -3.538098238120917e-02   -7.620589567653950e-01   +5.170239598669166e-01; +5.001428971516640e-01   +2.362120992811645e-02   +1.433278138965374e-01   -9.904350730797916e-01   -5.979695950833902e-01   +4.111891592728544e-01   +1.568090288461253e-01   -8.021753897603902e-01   -8.614909396482369e-01; -6.019250266568020e-01   -1.664444402130261e-01   +7.622416779269386e-01   -4.082684080103921e-01   -1.230868656140205e-01   +8.255620950497623e-01   -7.372707087804220e-01   +8.490127122773355e-01   +6.884270410347219e-01; -7.954574277809336e-01   +2.506713478993411e-01   -3.166292922987227e-01   +1.231372150530967e-01   +4.902672695054035e-01   +5.978854355357079e-01   +7.798340096336409e-01   -1.402623828686340e-01   +6.223434071890157e-01; +1.856535631630392e-02   +8.188129240302268e-01   +9.586948334105474e-01   -5.199380762170908e-02   +1.091795637384293e-01   -9.672591734765977e-02   +4.322392263893984e-01   +1.473926895607450e-01   +2.433745477131238e-01; -1.713615897849078e-01   +9.421391992095669e-01   +3.075998236379825e-01   +3.316568453472455e-01   -2.203318058102651e-01   +2.399826467712218e-01   +8.310445209458359e-01   -5.025964447040088e-02   +4.028425637644442e-01; -4.632916311121243e-01   -8.521974292657950e-01   +3.891018122834438e-01   -2.400321704022573e-01   +4.358519046970035e-01   -7.019482052316173e-01   -5.238498511881553e-01   +7.925904172013561e-01   -4.189741958386587e-01];
L2_L5_iAMPA_netcon = [-8.123867103723769e-01   +4.245065514210739e-01   -8.449066222789432e-01   -9.580866329382008e-02   -1.185643582230862e-01   +7.828278692006637e-01   -3.359347630661615e-01   -4.553011566801193e-01   -5.396147876212237e-01; +7.259633345564894e-01   +7.165376678159465e-01   -1.287635941810402e-01   +7.819156619071660e-01   -3.686920681682934e-01   +3.773193053916555e-01   +7.059834724730772e-01   -3.364467012613036e-01   +1.506329631798423e-02; -3.381875286816334e-01   +5.150683374167152e-01   +1.262457635436670e-01   -3.190678809957539e-01   +3.701862965064003e-01   -1.731076055380685e-01   +6.672069656174021e-01   +7.154850319720414e-01   +1.426708849586909e-01; +6.155826040849118e-01   +2.278269314936488e-01   +7.054646429348275e-01   +9.071938968656985e-01   +3.035145325305449e-01   -3.501487327521242e-01   +7.309578431210818e-01   -8.084382372565824e-01   +5.730748174086838e-01; -1.612277825786716e-02   +2.368143716913028e-02   +1.867663952805412e-01   -3.046454045404378e-01   +7.673838103802939e-01   +6.634617364684838e-01   -1.776799614200054e-02   +5.597281451600228e-01   +7.314654870284852e-01; -6.616465073758245e-01   +7.311971183043071e-01   +1.684633918882281e-01   +1.532839252316333e-02   +7.118929645124245e-01   +9.314095745351345e-02   -4.352258119489253e-01   +6.834460503943035e-01   -1.000000000000000e+00];
L5_L2_iGABA_netcon = [+8.361907675913940e-01   +1.000000000000000e+00   -7.942509132981455e-01   +6.810360635825915e-01   -6.301176505122205e-01   +5.234137076020685e-01; -1.665064072492389e-01   +5.505838706092672e-01   -3.005049183219701e-01   +4.236536716182916e-01   -2.375924928793225e-01   -5.028815976110772e-01; -7.678375052379133e-01   +2.259138183137978e-01   -2.854643306664342e-01   -8.655703665036371e-01   +9.310100720551464e-01   +6.210909722419761e-01; -3.799835079559317e-01   -4.455519725497068e-01   +8.638169252706300e-01   -1.233413303309804e-01   -8.720633726508495e-01   -3.190603374893019e-01; -6.797167837550654e-01   -6.622848575049008e-01   +1.100088603500576e-01   +7.731631441819247e-01   +3.155642183446372e-01   +2.131022743168087e-01; +3.697154083591234e-01   -6.011205371048367e-01   +4.299944724648138e-01   +5.118748459264722e-02   -8.207081386577837e-01   -2.510785916326619e-01; +2.606928718761709e-01   -6.502604205700060e-01   -7.449239652960358e-01   -4.220068567608486e-01   -7.048660927336254e-01   -8.766747802413701e-01; +8.235489140330448e-01   -2.298948437262194e-01   -2.024432364295397e-01   -5.251972541472222e-02   +2.961878098754320e-01   +6.024340350570659e-01; +5.370493683570584e-01   +4.171299161120304e-01   +4.644038475247856e-01   +6.192093341338750e-01   -5.978331188346118e-02   +9.517037421287970e-01];
L3_L2_iAMPA_netcon = [-8.696470694666913e-01   -7.783339417980099e-01   +3.984056445751560e-01   +1.213893373836098e-01   -7.270966463277559e-01   +3.672938078114158e-01; +8.056860626270770e-01   -7.307734294822364e-01   -5.801473734845058e-01   -3.137117179911776e-01   +1.355388105301119e-01   -2.451820989356053e-01; +6.416561772451922e-01   +3.269102169434596e-01   +3.135718042045740e-01   +5.980594124374865e-01   +1.959479076491973e-01   +2.330992590779468e-01; -6.773380132826942e-01   -9.063446953222685e-01   +1.363580128550824e-02   +1.540379438462938e-01   +5.107617423021542e-01   -9.341036144156925e-01; +4.676723815577716e-02   -9.651318062969948e-01   -6.865306302128488e-01   -1.000000000000000e+00   -3.055996059572568e-01   +1.462522696202832e-01; +5.244840197318142e-01   -6.997936172264473e-01   -6.432828783571571e-01   -3.631983487098783e-01   +1.498460091919511e-01   +5.828356161939091e-01; +2.242977393153785e-01   +1.807709206576245e-01   +5.031462400929645e-01   -8.622781624081869e-01   -4.917223488222418e-01   -3.751050345105600e-01; +3.174635337628393e-01   +3.996275999419543e-02   +5.087597383747308e-01   -1.852314455527350e-01   -8.563825527192860e-02   +2.755777502397923e-01; -5.744569290819943e-01   -4.802439602519746e-01   -2.014596677161455e-01   -4.127652688341826e-02   +6.180823096359379e-01   -5.867088164468014e-01];
L2_L3_iGABA_netcon = [-5.707909327215754e-01   -8.948053038133127e-01   +2.191081396631586e-01   +3.499221232926413e-01   +4.078354436084686e-02   -7.644146877783927e-01   +8.397929628711621e-01   +1.425168911090680e-01   +1.562750585095269e-01; -6.121393011050421e-01   +1.539088413422190e-01   +7.174135950939715e-01   -2.666694852530855e-01   -9.565710912125108e-01   -2.706173794991841e-01   -4.897506443814533e-01   +1.815928025350770e-01   -6.479800789097105e-01; +1.959937309076370e-01   +8.655996683353242e-01   +9.372086208147031e-01   -4.598142081908276e-01   -3.807096373380262e-01   -5.711274557039303e-01   -8.078700262259054e-01   -2.003900150381198e-01   -8.197339282071416e-01; -6.613080639689348e-01   -9.524983072097080e-02   +1.071225042427240e-01   -3.356057556474484e-01   +1.221536615858297e-01   +4.242984245974902e-01   +9.336063155850804e-01   +5.826817512919721e-01   +4.096148877177835e-01; -3.524454532591337e-01   -6.515726388804595e-02   +3.465071192368884e-01   -7.127406746838804e-01   -1.131395298141087e-01   +5.409279952975845e-01   +2.614199077998973e-01   +8.702363318796937e-01   +1.494528942362788e-01; -2.480072418986326e-01   +8.787950514525408e-01   -5.583016107091611e-01   +1.000000000000000e+00   -1.628227242084413e-01   -1.946511616038209e-01   +9.061183691673427e-01   +8.022439761615449e-02   +6.563915251428015e-01];
L1_L4_iGABA_netcon = [+6.895784511197282e-02   +1.214569196735667e-01   +2.580873593951797e-01   +1.605648494002424e-01   +8.717304922262693e-01   -3.031124537244022e-01   +3.097111149090804e-01   -1.323038192377268e-01   -3.438741714886833e-02; -3.874005784752484e-01   -1.336235798796140e-01   +7.685752038081194e-01   -5.493310027684741e-02   +1.819754538868354e-01   -5.863699766217308e-02   +7.556368816299546e-01   -9.367182452204899e-01   -6.735945491264507e-01; +6.829135851759808e-01   -8.002085384572218e-01   -7.670999850817889e-01   -1.000000000000000e+00   +6.890145274480770e-01   +3.428417916693923e-01   -1.484970473643474e-02   +8.104971709737752e-01   +6.700270364354554e-01; +1.225051759650887e-01   +5.680951990358390e-01   +1.443120771767712e-01   -2.705661933831650e-01   -7.129400700321268e-01   +4.842319234088399e-01   -2.040478089335218e-01   -7.705577076355620e-01   -5.047492638517423e-01; +5.906181591067119e-01   -9.815986738489191e-01   +9.245180033006207e-01   +7.522321923090164e-02   -5.528735766570942e-01   -6.434273893616052e-01   +1.049721316760601e-02   +6.290348754135531e-01   -3.412075740988223e-01; +1.518437526385053e-01   -5.461332740650646e-01   +5.464636142249497e-01   -8.772683530857126e-01   -6.114980888819104e-01   +5.318921552971455e-02   -5.068335108145637e-01   -3.718900303024467e-01   -4.339929198329025e-01; +3.173500481272903e-01   -8.821622189253385e-02   +5.238897296293953e-01   -6.651537540172019e-01   -5.949676974719685e-01   +7.901363651729852e-01   -9.698213843671998e-01   -3.559113191327694e-01   +1.221293839687094e-02; +5.098940378197286e-01   +9.753319562448244e-01   +4.252004390443459e-01   +5.613201552195984e-01   +6.679786530166025e-01   +8.372028901389984e-01   +5.838972758964642e-01   +9.070823388881686e-01   -3.790043317034971e-01; -6.846189018101356e-01   +8.798780365939046e-01   -9.043754979465457e-01   +2.814868275279953e-01   +4.666510141914642e-01   +3.020579455299818e-01   -2.404667031015861e-01   +5.629627671462858e-01   -4.466225764240542e-01; +3.175844188270892e-01   -1.307345957317126e-01   +2.521932420415651e-04   +1.540354413289730e-01   -6.508258705608864e-01   -1.012659981052782e-01   +7.730891222238285e-01   +4.100699565550292e-01   +1.133745423488020e-01; -5.211290017900546e-02   +1.036763793898273e-02   -2.823794747374075e-01   +1.493535379462861e-01   -7.290749192390188e-01   +9.057929762268819e-01   +2.144173242201714e-01   -2.210067906354944e-01   -3.948395353596285e-01; +6.289640252309018e-01   -8.469811772762839e-01   +5.647247643353892e-01   +3.350602777556195e-01   +9.526929926983594e-01   +4.113316778810119e-01   +7.476259664619205e-01   -2.827335882662058e-02   +5.375305450157783e-01];
L4_L1_iAMPA_netcon = [+5.643725008050925e-01   +2.817280537912128e-01   +5.005971729607965e-01   -6.159352687898406e-01   +9.152259476654941e-01   -6.778944014108697e-01   +4.227933351719501e-01   +2.110785842344503e-01   +9.380466604418013e-03   -4.454666686410821e-02   -1.706871352918244e-01   +8.376401968280530e-01; +5.532094998615331e-01   +6.156097997610175e-01   -5.889095217512306e-01   -6.451999451632058e-01   -5.814083932121855e-01   -5.978324921322403e-02   -6.391297207618448e-01   +2.187262921848260e-01   -5.366067153418051e-02   +3.558344443476880e-01   -5.006672675915674e-01   -8.393445984188967e-01; -7.006865430552095e-01   +6.833948187279216e-01   +2.885206039170034e-01   +6.158196161485040e-01   -9.440640139006602e-02   -1.881915732173227e-01   -2.415537511014223e-02   +3.285477982634670e-01   +4.730161031292913e-01   -3.964919912088126e-01   +1.000000000000000e+00   -3.703317263074935e-01; +8.609309774504181e-01   -7.390105246527903e-01   -2.892623121985372e-01   -1.431177721942225e-01   -2.929277096072436e-01   -8.156297477928179e-01   +2.505338775219172e-01   +3.349557442460091e-02   +3.517044950934781e-01   -9.072671734881972e-01   +3.585424381264099e-01   +2.658972047828637e-01; -5.823712472183622e-01   +4.473904009348743e-02   -2.702558168032513e-01   +4.253058833293157e-01   -8.414076644351219e-02   -4.368093542506583e-01   -9.385437697904540e-01   -3.387424312243080e-01   -7.529688638414227e-01   -3.445269999273665e-02   -1.744063209639055e-01   -3.767809433946087e-01; +9.121633595074113e-01   -5.183177988147185e-01   -6.118671051057407e-01   -5.349328595258281e-01   +1.925807671572712e-01   -5.452775304827187e-01   -7.094365379358794e-02   -1.894160323559642e-01   -3.728070510654120e-01   +3.489317683115689e-01   -7.951592506148584e-01   +2.784633308504227e-01; -7.677218835354381e-01   -4.568551063649884e-02   +5.433547590878279e-01   -6.137565529351010e-01   +8.094308689401069e-01   -5.906214112603057e-01   +1.475511672700322e-01   +8.936260848681971e-01   +5.622230054197433e-01   -6.971643263975860e-01   -2.783017724288849e-01   +3.493409315900214e-01; +7.435338677739019e-02   -5.397030825976362e-01   +4.130414694302249e-01   +1.538375480418361e-01   +6.672105366454456e-01   +6.638499895037377e-01   -7.876075077658105e-03   +7.548506369808720e-02   -8.937242313143977e-01   -2.398661720887518e-01   +6.979370327680455e-01   +2.278628377394759e-01; -5.412484047817470e-01   -2.670662146172990e-01   -3.356181793529558e-01   +8.596141525907496e-01   +1.962056767771414e-01   +1.403613474773812e-01   -5.622246621823868e-01   +8.056000373954224e-01   -3.644562973135639e-01   -8.038996662287087e-01   -7.843772301425237e-01   -3.942475477186230e-01];
L1_L3_iAMPA_netcon = [-5.766189598563514e-01   +3.786001995102941e-01   +6.848303765451436e-01   -9.722681267302697e-01   +3.912119969482157e-02   +8.408137360278877e-01   +3.466173784608593e-01   +7.084473100876730e-01   -2.285798063093103e-01; +8.545476553801743e-01   -6.043949690239322e-01   -4.803998593482869e-01   +2.978741796233161e-01   -8.952449900129059e-02   -2.233925773662021e-01   +1.188145167465413e-02   +2.360202824543844e-02   -8.212068344896583e-01; +5.557054036336815e-01   -9.422316013081327e-01   -8.502771210086654e-02   +1.770068164040570e-01   -2.706426471756903e-02   -2.598109621410854e-01   +7.656688306368105e-01   -6.489607261544804e-01   -4.747228535266725e-01; +4.871375836536314e-01   +8.613153350584284e-01   +7.670559937603610e-01   -7.707277989693115e-01   -6.099409725505275e-01   -4.568639703456846e-01   -7.126172935382803e-01   -2.052697842753164e-01   -3.088139907442053e-01; -7.221616634298600e-01   -7.008364975760396e-01   -4.048879885334042e-01   +3.607853890794249e-01   -9.865657811169822e-01   -3.231670783469452e-01   +7.890533667673172e-01   -5.900562665066238e-01   +2.456654138774683e-01; +4.025780667949733e-01   -7.748001964389616e-01   -5.627736667704017e-01   +9.262431316178633e-01   -4.520819211454178e-01   -5.836970940834345e-01   -1.000000000000000e+00   +6.007974800140099e-01   +1.990446365494713e-01];
L3_L1_iGABA_netcon = [+6.130477853837144e-01   -9.264633421875712e-02   +6.239978748589156e-01   -7.935831619301146e-01   -1.075216356341601e-01   +8.134272677981285e-01; +1.485207179380318e-01   +4.155880895584040e-01   -4.768438909577925e-01   +5.180736956561561e-01   +9.958237747669729e-02   -7.123677247804554e-02; -3.053068359945472e-01   +6.248791332485253e-01   +7.903713025912847e-02   -8.508089826917702e-01   -9.315375484353246e-02   -4.901692236343894e-02; -2.247437068207508e-01   +7.795417446080182e-01   -7.393789943595570e-01   +5.512629679300339e-01   +6.308685135513159e-01   -5.702277391158492e-02; -2.180866076768228e-01   +2.560778126909863e-01   -1.037001436766738e-01   -3.760019269497139e-01   +5.893057219890618e-01   -2.579321117458215e-01; -6.149383125397896e-01   -3.408696247952570e-01   -1.842830071937610e-01   -1.662279180180163e-01   -9.216236916045187e-01   +4.283871598232822e-01; -5.349469477727763e-01   -5.965590397782216e-01   +2.074732965934413e-01   +7.717570230222109e-01   +7.559930899290276e-01   +3.233845011846698e-01; +3.706363472932708e-01   +1.000000000000000e+00   -5.326448220951693e-01   +1.198470415555674e-01   +6.378522899131689e-01   -3.954311174141742e-01; -4.598675504638027e-01   +7.763923751662573e-01   -6.872818416833575e-01   +6.171473329642980e-01   -7.310524703790804e-01   +7.909880860945201e-01];
L5_Input1_iAMPA_netcon = [-1.000000000000000e+00   -6.521655978544608e-01   -5.393856179505607e-01   -8.641684999259939e-01   +3.906940508651323e-01   +5.009349116532937e-01];
L6_Input2_iAMPA_netcon = [-7.563804816437752e-01   +1.000000000000000e+00   -4.690369527097596e-01   -5.173200467497513e-01   +2.162388560845856e-01   -8.727427348362471e-01];
L5_L6_iAMPA_netcon = [+7.838198450895437e-01   +2.947697533571861e-01   +7.094884848581665e-01   +8.278141730886570e-01   +7.361433086067332e-01   -4.122575690330010e-01; +5.361850600409192e-02   +4.446715196338676e-01   -3.898719087109666e-01   -7.041351825651174e-01   -6.855398068594963e-01   +6.542537256124986e-01; -3.006052278488958e-01   -5.302854373227502e-01   +7.250003966219933e-01   +2.030892476505940e-01   +4.787724960796878e-01   +4.572896266303905e-01; +4.748548566020555e-01   -7.502810679969811e-02   +7.259613271728426e-01   +1.000000000000000e+00   +2.267480358016193e-01   -8.035127828816714e-01; +7.180462302741792e-01   -6.135533051731195e-01   +6.799290980413629e-01   -5.718421931109673e-01   -5.479990778914222e-01   -1.971988487069961e-01; -8.865953043223508e-01   -8.701396480929070e-01   +7.432438365877625e-01   +8.478191024654259e-01   -3.513203341138897e-01   +6.698414006319152e-01];
L4_L5_iGABA_netcon = [-3.824730501463902e-01   +1.549019850673393e-01   -2.216669461671788e-01   +3.357809218182821e-01   -3.259769429769534e-01   +4.043985169825142e-01   +8.617025534125869e-01   -6.379349750679769e-01   +7.550233126338940e-01   -5.125522225734862e-01   +6.075381705889500e-01   +4.156144066344430e-01; +1.386004616767291e-01   -6.203511524558578e-01   -4.691292969179351e-01   -4.816396677520496e-01   -6.104329625136933e-01   -4.074914919544558e-01   -2.661049509324443e-02   +5.826184182523606e-01   -3.425957531745770e-01   -7.760626899187408e-01   -7.301927122458951e-01   -5.174746227888944e-01; +1.796451664672633e-01   +7.717404813099401e-01   -8.239769531029013e-02   -3.601940946135199e-02   +3.035910947929477e-01   +4.342707557386450e-01   -1.146585397011541e-01   +4.793180260719822e-01   +8.543479783932970e-01   +9.288511107505588e-02   -2.400547472216448e-01   +4.188881836744207e-01; +8.169519249294100e-01   -3.892031114051974e-01   -4.900148269200474e-01   +1.175649926315042e-01   +7.873261157900240e-01   -8.804972840675095e-01   +1.000000000000000e+00   -3.334541839354129e-01   +3.547044354064434e-01   -2.991132814623840e-01   +4.439704691473869e-01   -3.319110674794573e-01; +6.739455006180016e-01   +1.068146927249160e-01   -7.535771199418423e-01   -9.986942235651287e-01   -6.589892861852017e-01   +2.645985480838531e-01   +3.958166063748689e-01   -7.341401871183012e-01   -2.244958926592525e-01   +1.398288861834600e-01   +1.219685509721131e-01   -1.238172435645810e-01; +3.264482106221273e-01   -4.700192944012684e-01   -9.957106279488477e-01   -5.888064618389210e-01   +1.643132041555083e-01   -4.038917865842962e-01   +5.112636403127225e-01   -4.819831674421685e-01   -5.169005443895688e-01   -6.683538726334686e-01   +7.259067414838923e-01   +2.546440387209037e-02];
L6_L4_iAMPA_netcon = [+2.090641225127277e-01   +7.347477606853233e-01   +7.244880838961379e-01   +3.916593279531089e-01   +7.682818325844535e-01   +5.957237198356776e-01; +7.198739299994124e-01   -9.216666599916790e-01   +2.151735715068637e-01   -4.393245008296939e-01   +9.150017197709011e-01   +3.395952223383084e-01; -8.101933583690551e-02   -2.600604673443558e-01   -4.359446519911114e-01   +1.459109468807095e-01   -8.643765165855235e-01   +5.550805110723461e-01; -8.608061230692389e-01   +7.920902444059892e-01   +7.737784618047432e-01   -3.596519496502582e-01   +6.635491546046233e-01   -4.976022055483854e-01; +6.295927579756936e-01   +5.664600082898480e-01   +5.694346991374564e-01   -4.648393002785287e-02   +5.692286767981795e-01   +5.049585342018272e-01; -8.186339058380288e-01   +9.144324076096439e-01   +7.634490605967504e-01   -5.589006259515005e-02   +9.715454306509745e-01   -6.627416755757032e-01; +3.120303468191706e-01   -4.129161573467454e-01   -1.019395908541999e-01   +6.082493115092666e-01   -2.405201955098820e-01   -1.819243383134022e-01; +1.501031435744133e-01   -3.420970874383698e-01   -1.597554098357183e-01   -3.342622185887482e-01   +2.819113455462174e-01   -8.366858230067723e-01; -4.714860155120434e-01   +1.000000000000000e+00   +2.531356652173684e-02   +9.373991385521051e-02   -6.712291879589436e-01   -4.247539657803115e-01; +6.677979068145312e-01   +6.902726768718135e-01   +1.370741660533315e-01   +1.851881287106703e-01   +5.597702072484563e-01   -3.871868406734990e-01; +4.950418942772265e-01   +3.604018082754048e-01   +9.278905515757313e-02   -6.469396603165072e-01   -9.607717610350092e-02   +1.532703308077772e-01; -4.072471014055778e-01   +8.173783670079635e-01   +3.692532908393196e-01   -7.658999399587274e-01   -2.271865719489645e-01   +6.757002951009152e-01];
L5_L4_iAMPA_netcon = [+4.917845198590163e-01   +6.733107677084840e-01   -3.975046859940131e-01   -5.491375165992756e-01   +7.642483054041201e-02   +8.791749741059911e-01; -1.532408478776451e-01   +2.906445338152383e-02   +4.172310608759727e-01   +5.770993497797740e-01   -2.516669641568323e-01   -4.117588092330753e-04; +5.267936684709483e-01   +2.774736316893775e-02   -4.770662987377766e-01   +3.511230048157538e-02   +7.528911022463048e-01   +5.813284199822588e-01; -2.380041402649393e-01   +6.126625729043145e-01   +1.284769079726976e-01   -2.994240611564907e-02   -6.816224225706993e-01   -3.540976850287845e-01; +8.862614066569313e-01   -3.685143581706649e-01   +4.464099666874198e-01   +3.226957193091796e-01   +3.305671531600570e-01   -5.332671171421670e-01; -5.851775575133044e-01   +1.822691884624161e-01   -2.375499931346324e-02   +8.310236857233749e-01   -4.981993808089231e-01   +2.471920917043058e-01; +3.296832308550006e-02   +1.268702008406055e-01   -7.910486048097827e-02   +7.336261518326821e-01   -4.479521354981649e-02   -7.537098359850601e-02; -3.520355611154353e-01   -5.803926318053208e-02   -7.386171397049629e-01   +4.182994842147514e-01   +6.069854097655150e-01   -7.918105223333715e-01; +6.411912628317689e-01   -7.068604074540891e-01   -2.499984758596332e-01   +7.520223672134436e-01   +8.144045376772527e-01   +9.577486411613262e-02; -3.593255759477141e-01   +9.088581827280371e-01   -6.758937009966004e-01   -4.648055241895722e-01   -7.468317479130748e-01   -2.333270259374395e-01; -3.664706650082799e-01   +3.167229798497535e-01   -8.788184965229636e-01   -1.444475715066621e-01   -1.000000000000000e+00   -4.366004413108215e-01; +4.512401447252028e-01   -6.864182364653935e-01   +4.662628726904635e-02   -3.049715606691406e-01   -4.246812726994734e-01   -7.636910602123452e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
