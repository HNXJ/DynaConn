function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.809034684478700e-02   -8.582062952019165e-01   -6.567618665902596e-01   -2.022473923512219e-02   +1.560638197034729e-02   +8.183589565386324e-01   +8.125676614621642e-01   -4.112202986213030e-02   -9.570292991599882e-01; +2.161786666270795e-01   +9.695777563849375e-02   +1.621160273265643e-01   +5.092967114508175e-01   -4.398764872557981e-01   -8.381250991415791e-01   +9.196227297813905e-01   -3.696487489700722e-01   +6.631081314460351e-01; +2.616884448929270e-01   +7.196968669301204e-01   +3.231948745136093e-01   -7.769015212885153e-01   -2.411996322270027e-01   -8.911821104666011e-01   -8.046568760071428e-01   -2.037453700839076e-01   -6.901929146253167e-01; +3.532270609535818e-01   -8.295487806912376e-01   -4.129409293497144e-01   -9.571169079859719e-01   -7.595847454357090e-01   -8.522131074610203e-01   +5.583441680343666e-01   -2.179017469000333e-01   +9.316625716263464e-01; -3.070234018759376e-01   -7.086268794404735e-02   +9.231104650006835e-01   +8.260772380856682e-01   +6.478174977039947e-01   +1.862810743103186e-01   -2.440126705500850e-01   -4.364076187684013e-01   +5.375984852045287e-01; +3.672993963822269e-01   +7.388206538904822e-01   +5.313650602233753e-01   -3.985981232244671e-01   -7.554024271253346e-01   -1.000000000000000e+00   -8.371320337099963e-01   +6.398526173003315e-01   +2.612111466496468e-01; -9.435327965494402e-01   -5.022011619621591e-01   -8.366887532351657e-01   -3.226029894143936e-01   -3.412932260244683e-01   +1.315041538574040e-01   -6.787001050257834e-01   -3.477412483413632e-01   -3.448054865908567e-01; +8.680865906021085e-01   +7.831627654202935e-01   +4.108795416263789e-01   +6.087102691513455e-01   +8.407799851407065e-01   +1.670502467497305e-01   -4.381077365366672e-01   -3.122310853724851e-01   +8.574613498411254e-01; -7.855862839701919e-01   -2.087924916550997e-01   -4.526026445071747e-01   +7.713767756811489e-01   -9.896725323408224e-01   +1.239331671232476e-01   +6.473784406470503e-01   +1.891649103794333e-01   -2.768744849645622e-01];
L1_L2_iAMPA_netcon = [-7.049017576957256e-01   -3.243631971701222e-01   -8.114324217867411e-01   -7.752300073478922e-01   +9.682054483281746e-01   +7.192423654591831e-01   +1.247394887775792e-01   +5.306923579455960e-01   +5.616608893642525e-01; +7.546374449509095e-01   +9.777378521832911e-01   +8.595605025443370e-01   -5.240821615076872e-01   +4.319178347830356e-01   -2.511820443683617e-01   -6.772358743660778e-01   -7.312949207314869e-01   +1.568000410932869e-01; -8.659607875536098e-01   +7.910520832720142e-03   +5.071475352215360e-01   +2.023684379669583e-01   -4.557172026065189e-01   -5.030549092871875e-01   +8.833187957360158e-01   -2.363132314073520e-01   +1.439712771049987e-01; -1.339376379407706e-01   -8.757763443331609e-01   +4.234333393548905e-01   -3.543956949041425e-01   -9.820036154946702e-01   +2.794741031800606e-01   +2.337219546081404e-01   -1.904678750813537e-01   +5.821789958487730e-01; -9.066977043272647e-01   -3.916185937240684e-01   -1.222889746941489e-01   +3.735761983043757e-01   +2.066936398723280e-01   +7.899824382918228e-01   +3.481663960792802e-01   +4.900172523886895e-01   -4.475194074077691e-01; -3.333979392549473e-01   +4.955303527244699e-01   -1.000000000000000e+00   +4.681685307887370e-01   -7.604118732199507e-02   -5.379990555669785e-01   -5.186082098969441e-02   +6.764930510480130e-02   -8.699446676464163e-01; +2.172772686592298e-01   -4.558917954491261e-01   -3.020384947805039e-01   -5.371050053219172e-01   +1.315208997459247e-02   +2.426497795495418e-01   -9.243251172454284e-02   +5.478569718568187e-01   -5.613563789196359e-01; -3.808252293826266e-01   +9.833136952353296e-01   +4.540135200493062e-01   -4.313343677893356e-01   -5.399630984571550e-01   -3.324445477326895e-01   +3.688709999857088e-01   -4.574365191607713e-02   -2.905936046264692e-01; -8.950248307946322e-01   -2.508144641651484e-01   +1.681288619458706e-01   -1.941730202236828e-01   +3.712494996230934e-01   -5.887990351238600e-01   -7.096760693189198e-01   -4.569420409201912e-01   -2.994164517705261e-01];
L2_L5_iAMPA_netcon = [-6.263363989934809e-01   -5.308351166090691e-01   -8.729404639829865e-01   -4.942075990918517e-01   -8.162758769788979e-01   -5.665139100445800e-01   -1.000000000000000e+00   -2.500285810659760e-01   -1.099899892598983e-01; +6.903106736307932e-01   -8.760132266874747e-01   +2.662273332521793e-01   -9.005322733924008e-02   +1.734828815668449e-01   +5.787792024188790e-01   -6.151486919705309e-01   -6.839444045390661e-01   -6.797982129788850e-01; -6.491422817961858e-01   +5.049547890921553e-01   -6.100601884984943e-01   -6.781213469797438e-01   +6.822824400179427e-02   +7.160711902978014e-01   +3.265282765415178e-01   -6.593875007852210e-01   +1.398028078472188e-01; -8.770302766026485e-01   -4.898352233934023e-01   +8.961092770549430e-03   -4.050679617308485e-02   -4.486210051197214e-01   -8.771740385677776e-01   -3.683437787843189e-01   -4.783872054900856e-03   +1.196674024005931e-01; -5.112967842405172e-01   -7.641267686894798e-01   -2.918075958945963e-01   -6.401409284451359e-01   +2.195055017120604e-01   +4.546460813145162e-01   +5.834855996095873e-01   -5.659294320853281e-01   +3.621078035433830e-01; -9.719738157886004e-01   +8.899561511227737e-01   -4.773386650696252e-01   +9.901218087815011e-01   -5.316754422778636e-01   +7.821991501978697e-01   +5.861726291494342e-01   -3.961708451977653e-01   -5.640021789130416e-01];
L5_L2_iGABA_netcon = [+5.482215273977433e-01   -4.213393512808176e-01   +1.000000000000000e+00   -4.063804245764628e-01   -9.915169877705594e-02   +9.430551512649084e-01; -3.962800414519789e-01   +5.662726797671300e-02   +2.755244835006584e-01   -8.078104723380529e-01   +3.486968762443012e-01   +9.500450359417068e-01; +4.107374954821814e-01   -3.916451036780167e-01   -8.881462442221799e-01   -4.593432924154686e-01   +9.250588434715359e-02   -2.354322841774668e-01; -6.750900263936299e-01   +8.465961331136765e-01   +3.967340139144032e-01   +3.318319485691442e-01   +8.826118762463574e-01   +2.897487530526475e-01; +8.493996985552105e-01   +3.391506138436362e-01   -8.105441243443958e-01   -3.032899164383250e-01   -3.506775530934952e-01   +4.820291445021985e-01; -5.273102174923766e-01   -2.575393576119774e-01   -6.327156622076842e-01   -2.725823638778859e-02   +2.686685501969276e-01   -9.810614265444227e-02; +3.912939105250946e-02   -8.515599801317899e-01   -4.634919000424029e-01   +1.800969166309182e-01   -3.984553671671683e-01   -8.171245020068070e-01; -1.951966615288445e-01   -6.025797952064221e-02   -5.488054771071191e-01   +6.236663834644953e-01   +2.840667522312323e-01   -6.187066819858857e-01; +2.935846243869352e-01   +5.600325001573633e-01   -2.330905052780542e-01   +7.423753715605633e-01   +2.764514639838550e-01   -5.185664605551273e-02];
L3_L2_iAMPA_netcon = [-8.543605409466213e-01   +5.741886765902472e-01   -6.208451607773107e-01   -8.786622123469553e-01   -5.453257454081708e-01   +1.000000000000000e+00; +6.289932808265040e-01   +1.279594148232881e-02   +2.418125199832107e-01   +4.614666978988137e-02   -9.001210491580922e-01   +6.701344030472639e-02; -9.780160955156911e-01   -1.041251630494732e-01   -8.263039902732593e-01   +8.110812351398853e-01   +5.416092479621477e-01   -1.021868237789194e-01; -5.330148431487154e-01   -4.952284242571008e-01   -3.985413222052853e-01   +3.379088679499156e-01   +9.287574082306813e-01   -6.646679983465095e-02; +2.657747557180304e-01   +6.561833658965840e-01   -1.072161764384881e-01   -7.705997803887650e-01   -3.685956330713316e-01   +7.641768609132479e-01; +8.797859783004445e-01   -4.037283842769694e-01   -1.973839158929430e-01   -6.682561428694888e-01   +1.685941526164559e-01   -2.279290769883407e-03; +6.192302922257521e-02   -8.557306829060101e-01   -3.931558327672409e-01   +5.365786719026035e-03   +6.439215767811440e-01   -6.850517614153072e-01; -6.086838806179404e-01   -5.602261428869921e-01   -8.148658689039846e-01   -4.411306767534541e-03   +2.136775474618934e-01   +3.624391074287873e-01; -4.645448799249606e-01   -6.693949879446900e-01   -9.670245753389239e-01   -1.547295834678430e-01   +2.057928072855155e-01   +8.513545021225108e-01];
L2_L3_iGABA_netcon = [-6.425844726846063e-01   -8.805266155263023e-01   -9.793210348539132e-01   -1.120770076618223e-01   -5.749110174511833e-01   -6.087447986869063e-01   +1.393137869729499e-01   -4.526784295111375e-01   -5.759090232038425e-01; -2.173654064779299e-01   +7.725276263660632e-01   +2.244587118160777e-01   -8.660103748569966e-01   +1.590712971901713e-01   +7.602409671353784e-02   -2.474580244140325e-01   +9.627272468242831e-01   -4.077825642442387e-01; +5.347685386984745e-01   +4.216958793073001e-01   +3.161994217472957e-02   +3.433355412125127e-01   -2.693484285765932e-01   -6.674965143526151e-02   +9.094081831926675e-01   +2.749803669484496e-01   -5.860165031111055e-01; +3.374041774531440e-01   -9.441814236874922e-01   -6.423982133725704e-01   +3.417434673758977e-01   -3.512509025711593e-01   -3.952401450431025e-01   +3.621112826963079e-01   -5.425682396850378e-01   -1.653940350142466e-01; +7.721710124113829e-01   +8.234874494626268e-01   -8.054170845629121e-01   -1.000000000000000e+00   +5.662601587710357e-01   -9.527471911756334e-01   -4.273765088435252e-01   -5.921740841723236e-01   +9.268533809968351e-01; +5.672272100896655e-01   +2.420811153821896e-01   -4.978106056267607e-01   -3.324041269847745e-01   +5.116767529901606e-02   +3.743203171772042e-01   +6.271131919516414e-01   -4.228479301369242e-01   -9.858490640574578e-01];
L1_L4_iGABA_netcon = [+3.807793915206742e-01   -2.027375256538068e-01   +2.300997303787075e-01   +3.611264182864785e-01   +2.673266746929075e-01   +9.719702858188111e-01   +1.542787418596576e-01   +7.792127041673733e-01   +3.414891211466338e-01; -4.800012073423260e-01   -3.545779421565023e-01   -8.103525442356418e-01   +8.849229417502945e-01   -9.923790501700669e-02   +1.789094030340775e-01   +6.657079079269764e-01   -5.599667019571628e-02   +4.841258354962901e-01; +4.310771609232720e-01   -6.150154916114061e-01   -5.165648887034805e-01   +6.659080489922904e-01   +6.581514254426234e-01   +1.226010486276094e-01   +1.475277482309534e-01   -7.927806661509489e-01   +3.313943606954104e-01; +1.106878417720013e-02   -4.339818932348159e-01   -1.796160391210861e-01   -1.799561623395430e-01   -1.000000000000000e+00   -6.289485128299055e-01   -8.511838872761486e-01   -9.317199749070667e-01   +5.423063642383187e-01; -2.063332603568132e-01   -9.780502901403189e-01   -1.367394850855800e-01   +8.876429188208218e-01   -1.123084643029078e-01   +2.965424226092443e-01   -1.517492841583836e-01   -5.246320138283113e-01   +3.928113856671873e-01; +9.474101772262651e-01   -5.506807591071800e-01   -2.860363861326435e-01   +4.755706501947631e-01   +8.096927970239849e-01   -5.766648556913180e-01   -9.392644813268223e-01   -9.151994846212819e-01   +3.343941688137873e-01; -3.270052874493253e-01   +6.155863800379505e-01   +7.367404215111490e-01   -8.544914544990890e-01   +4.876472948102859e-01   -5.520532878264082e-01   -2.459975564786389e-01   -4.871514475369557e-01   -7.899301752418512e-01; +6.302588949425947e-02   +6.484440138484728e-01   +8.871371447239217e-01   +6.731352635360277e-01   +5.681138588422551e-01   -2.110630302343715e-01   -7.599846153404280e-01   +9.748278951248298e-01   -9.377624385156233e-02; -7.341327382372550e-01   -6.736633937146185e-01   +7.409722484711507e-01   -4.778406506845624e-01   -8.786251214938166e-01   +2.723146810174659e-01   +3.864019822270425e-01   +7.419275208442208e-01   +5.278689377235388e-01; +1.348247984103647e-01   -4.554672061115100e-01   +9.969398907522719e-01   -1.686379104229259e-01   +6.007859662310437e-01   +4.971358923719801e-01   +2.393880247960753e-01   -5.501247124589205e-01   +5.778275160589933e-01; -7.992018508617054e-01   +9.355984176782072e-01   -5.431005745357581e-01   +3.428200706122640e-01   +2.993670368097469e-01   +4.866299803568045e-01   +2.759972911739103e-01   +6.031766679715910e-01   +2.166681113809900e-01; +3.240333786962262e-01   +3.995012042184853e-01   -1.198316820291034e-02   +6.472790851367921e-01   +8.609345775585769e-01   +5.554110200695536e-01   -3.528363454345042e-01   +7.480994262122487e-01   -2.486958267561915e-01];
L4_L1_iGABA_netcon = [-5.228779431459363e-01   -7.799794107674148e-01   +6.563366592606976e-01   +6.908374211126137e-01   +9.882930864991492e-01   +6.448964011159425e-01   +9.657800877235689e-01   -1.951954638233540e-01   +7.656730667958761e-01   -4.509307480158581e-01   -7.276690510532235e-01   +2.273430806292050e-01; +5.826982365252253e-02   +8.905865097125191e-01   -5.178036753678436e-01   -7.954787298352386e-01   +6.981441186696314e-01   +4.508334575826319e-01   -6.015590765240884e-01   -3.456952501563128e-01   -2.288841020325031e-01   -3.215510331770710e-01   +3.079630615888634e-01   -5.084638094087656e-01; +9.792724587111423e-01   +1.611248050799485e-01   +2.485208203974497e-01   +6.133513070503669e-01   +2.011735357628778e-01   -9.118090153896686e-01   -7.571535494136482e-01   -8.856539139700998e-01   -8.573386700796323e-01   -9.887521557291477e-01   -5.099803034762030e-01   +7.621817578007636e-01; -9.033767202548670e-01   +8.711164147812496e-01   +5.227315365544827e-01   +8.193395942810306e-01   -9.074400294230720e-01   +1.852414185147652e-01   +8.061941625219335e-01   +3.652622287169752e-02   -1.271232388200760e-01   -1.304659476046970e-01   +6.091626442232898e-01   -8.375849416517667e-01; -1.043736129605777e-01   +6.243790284313681e-01   -6.922724596163801e-01   +6.502592218697162e-01   -7.432332751598654e-01   +4.422826345344079e-01   -6.313740500096717e-01   +3.757034764841453e-01   +8.501610693628578e-02   -1.478965808185291e-01   -9.923847612598748e-01   +8.979144581827216e-01; +9.122694077085474e-01   -5.894347360563086e-01   +4.264210394398585e-01   +3.186480677633837e-02   -6.787157549060432e-01   -6.139642788579481e-01   +4.917948040971199e-01   +5.243337742802117e-01   -6.459803551186722e-01   -8.925413623620327e-01   -1.000000000000000e+00   -1.753679996747640e-01; -7.626278708213484e-01   +7.700845887399901e-01   +2.475422884978212e-02   -3.708419654607816e-01   +3.786398475798783e-01   +1.648151691644102e-01   -1.459607993397241e-01   +5.923655640425032e-02   +7.875339966719506e-01   -1.562692865151977e-01   +7.895837690430921e-02   -5.080060774332298e-01; +6.274683677479693e-01   -3.994532443663105e-01   +8.717619538393799e-01   +9.204200748743712e-01   -5.219785853849948e-01   +9.040093726317665e-01   +3.102829141691148e-02   +3.453648853519499e-01   -6.609006793833760e-01   +2.564162830555043e-01   +6.488151452782279e-01   +1.843767386357213e-01; -6.167609606750987e-01   -9.251402352751636e-01   -1.642087918265625e-01   -3.290235051950970e-01   -1.931329008769514e-02   +9.814726875966090e-01   +6.443658183741983e-01   -1.860662107016488e-01   +6.449291221455458e-01   +9.496393603986114e-01   +6.460051352632545e-02   +8.441879090128633e-01];
L1_L3_iAMPA_netcon = [+4.388955368174958e-01   +2.931168446641887e-01   -1.491913043148978e-01   +7.367163236486247e-01   +3.733545158669081e-01   -5.779200100930989e-01   -5.241911557652893e-01   -1.642912223257944e-01   -8.326439575870044e-01; +3.752304671219746e-01   +4.255734957212941e-01   -6.557418004328616e-01   +8.101631356171856e-01   -2.001949069691241e-01   -3.334383455055038e-01   +1.656451082403186e-01   -5.703480327408241e-01   -6.167491853391707e-01; -9.521275821592851e-01   +5.053440511440697e-02   -2.622545765969095e-01   +1.877498703402585e-01   +8.218821995667157e-01   -1.676601029599155e-01   +9.694266978030396e-01   +3.343357872229467e-01   -1.000000000000000e+00; -9.888611276229259e-01   +5.250628749558834e-01   -5.755069634480455e-01   -5.968986685908987e-01   +2.744281062622994e-01   +2.581699387042560e-01   +7.437143441252415e-01   +7.523335525829640e-01   -9.400708911124599e-02; -6.450841450395951e-01   +1.654424121522486e-01   +8.837272749206858e-01   +4.904871536880410e-01   +6.581873081379611e-01   -2.968949777853345e-01   +3.006355158484996e-01   -7.328982008695879e-01   +8.605508829278512e-01; -1.775409433249951e-01   +3.372221241963269e-02   -6.291796541090859e-01   +8.080163783667919e-02   -6.160621995529090e-01   +5.781512791056596e-01   +5.767964375963514e-02   +6.106643234945119e-01   +6.084756438863515e-02];
L3_L1_iGABA_netcon = [+5.097449972042893e-01   +1.773993405357184e-01   -7.393799925626565e-01   +2.096783144392909e-01   -7.117344918585901e-01   +7.419664632098985e-01; +4.155081521450817e-01   +2.995249699426589e-01   +9.421126958625672e-01   -1.013087899037553e-01   +6.085368711086585e-01   +1.120201650110797e-01; -1.761922956196609e-01   -1.229893510434339e-01   +4.300096484729216e-01   +5.861961048223180e-02   +9.097208343131493e-01   +8.683039228791934e-01; +9.695675721304617e-02   +4.898260654166696e-01   +3.738628617551350e-01   +3.416931206578901e-01   +3.173115569818241e-01   +5.662969874341867e-01; -4.379809157003157e-01   -1.290927660840879e-01   +6.231455035528815e-01   -6.126860602443914e-01   +7.326007907283798e-01   -3.248260043664079e-01; -6.367508315174362e-01   -6.407056373748038e-01   -2.837243749309493e-02   +6.326500063123249e-01   +5.555661973879390e-01   +4.272720519644858e-01; -9.137767800241275e-01   +3.746907510429525e-01   -1.000000000000000e+00   +7.122717831865668e-01   +8.279020208164289e-01   +1.268080106182299e-02; +1.121608688933302e-01   -8.111080829821867e-01   +7.368586754064679e-01   -1.936555541375465e-01   +4.504275665604746e-01   +2.146966520968087e-01; -5.750466060632718e-01   -9.516913950353058e-01   +3.587734392438554e-01   -3.408906037146337e-01   +3.437698144196268e-01   +4.168862280434264e-01];
L5_Input1_iAMPA_netcon = [-8.188623991323800e-01   +9.599343391796553e-01   -6.271390057790880e-01   +9.650937713583578e-01   -1.000000000000000e+00   -8.498117219875664e-01];
L6_Input2_iAMPA_netcon = [-4.779195725602601e-01   +1.000000000000000e+00   -8.705380223073956e-01   +9.343081285504387e-01   +7.040278841986054e-02   -8.968852550973152e-01];
L5_L6_iAMPA_netcon = [+1.837774355296001e-01   +7.711540386844732e-01   +9.733490178454000e-01   +6.005990316037835e-01   +4.928831825337048e-01   +6.328144010261405e-01; +7.772111499120248e-01   +4.395380350394473e-01   +9.592030855133971e-01   -7.872978800411836e-01   +3.987666858800802e-01   +2.029379383140514e-01; -8.875482759598199e-01   -8.793153867076109e-01   -7.007354620404952e-01   +5.941601088942098e-01   -6.015586917808196e-03   -3.092037349102634e-01; -7.110187939601738e-02   -5.524319004770576e-01   -9.106517587930942e-01   -1.000000000000000e+00   +1.222402807297958e-01   +8.916002436919265e-02; -9.180694115864406e-01   +1.135654641315298e-01   +6.506515647551797e-01   +3.038554063249143e-01   -5.861290425106014e-01   +3.614169140403503e-01; +4.662180712816786e-01   -2.108045240625080e-01   -8.007507605154085e-01   +8.954840286809155e-01   +5.996115994328236e-01   -2.463314748051074e-01];
L4_L5_iAMPA_netcon = [-6.052994491619229e-01   +7.937664143693595e-01   -7.874122878441216e-01   -8.205103727956516e-01   +9.780545607338400e-01   +5.859338450918621e-01   -3.467695561514035e-01   +1.214254466748208e-01   +1.000000000000000e+00   -3.669865841216706e-01   -9.528131350726775e-01   +6.268184705098518e-01; -2.472837170437504e-01   +9.582985730559104e-01   -2.338593270489583e-01   -4.316050895554868e-02   +1.259541765715541e-01   +3.171816549133036e-01   -4.500885097064761e-01   -3.063757413017414e-01   +6.250358074681548e-01   +6.476606539050928e-01   +6.039921695650645e-01   +9.350265160761206e-02; -2.868490143302665e-01   -2.147115207995174e-01   -4.789197240153458e-02   +3.619859000583938e-01   -9.481543481299290e-01   -2.411697308365360e-01   -2.826060989802504e-01   +4.462119328223672e-02   -9.310873696967985e-02   -3.770985729836575e-01   -3.997179263490369e-01   -6.424332838975514e-01; -3.626992307487931e-01   +7.702564586468109e-01   +3.480226772349607e-01   -9.534426991687018e-01   -4.488254523539626e-01   +2.783135078096551e-01   +5.367101435465873e-01   -1.405688386197449e-01   -7.979319042701889e-01   +6.335457295526371e-01   -4.837937539528631e-01   +1.177346088680606e-01; +2.018268254030555e-01   -8.522910700631154e-01   -8.065775814096938e-01   +5.280922025055013e-01   -9.247059132338191e-01   +8.433128345099556e-01   +9.658571530198165e-01   +8.310879612049599e-01   +3.491033853902807e-01   -1.648254416626604e-01   -3.917747506452390e-01   +7.536013635385130e-01; +1.580730474268009e-01   +4.263496702799969e-01   +8.664463021496045e-01   +6.335082280065670e-01   +3.757578243108502e-01   -2.888855877973021e-01   -7.981940402678734e-01   +7.855058821946865e-01   -6.208708723880829e-01   -5.517589882183234e-02   -3.576892221096077e-01   -4.720766518002752e-01];
L6_L4_iAMPA_netcon = [+3.062074390441314e-01   +8.379206750985049e-01   -9.427154322616247e-01   -8.385602660465418e-01   +7.387701636175170e-01   -6.187718004965395e-01; +4.828146297030263e-01   -5.301526394379815e-01   -1.324960592312572e-01   -8.930776139735499e-01   +7.272203577393227e-01   -1.593196377474052e-01; +1.487388499432485e-01   -7.493822052447127e-01   +5.925254056066178e-01   -1.157687761851951e-01   -5.054899038408688e-01   -1.634695094037529e-01; -9.106059917934970e-01   +5.908604914483403e-01   -5.462040330781081e-01   +5.447100681691620e-01   +2.555198323323427e-01   +8.671623155356716e-01; -8.490896007052741e-01   -8.476238009361982e-01   -6.587663293075194e-01   +7.167694978276580e-02   -5.099106471209025e-01   -3.824475561102625e-01; +3.022771079580853e-01   +1.239480242749585e-01   -9.847843844296423e-01   -1.939980000472634e-01   -6.251385441462962e-01   -6.964232427586647e-01; +3.230323053275730e-01   -2.383646085435059e-01   +8.896254921973837e-01   -9.478020002105483e-01   +7.329422757394553e-01   +7.523921295632049e-01; +3.213230783863357e-01   -6.443741632905741e-01   -1.178499688381504e-01   +5.201800474760366e-02   +8.926824043857855e-01   -8.417144300097793e-01; -6.510083825314019e-01   -4.930371423253717e-01   -5.990058446513334e-01   +5.340190262327790e-01   -6.414346082891205e-01   +1.000000000000000e+00; +1.525511536941371e-01   +2.951523764270584e-01   +8.805841993756908e-01   +9.325779180798220e-01   +4.860275779233977e-01   -4.441458511227873e-01; -9.632833798537098e-01   +4.171763130039103e-01   -8.345317609138427e-01   +7.052464947839788e-01   -9.210451169743674e-01   -1.206070524142710e-01; +5.208403514356704e-01   -8.617215751711369e-01   +9.546713134054360e-01   +7.891873208250904e-01   +1.242489069574794e-01   -4.028133816830850e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
