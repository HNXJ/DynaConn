function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.059312216843344e-02   +3.300510162221743e-03   -3.887567107351632e-01   -2.846619860459184e-01   +1.899539390487266e-01   -2.646123867093646e-01   +5.637773839520805e-02   -1.005735495065122e-01   +3.169286714045998e-01; -3.291207791083822e-01   +4.722939716991737e-01   +2.539333055992055e-01   +1.985562643712344e-01   -7.428130674654546e-02   -2.824988255610020e-01   +4.208134243613122e-01   +7.139253424527714e-02   +2.507384420279479e-02; +3.811909607309240e-01   +7.562649329636267e-01   +2.364162535510991e-01   -1.137599339675466e-01   -2.230058907338361e-01   +2.760901651276171e-01   +1.004619043612403e-01   -7.482578589363411e-01   +2.208313534030886e-01; +1.561896514433178e-02   -2.258989623111238e-01   +7.818108101082821e-02   -1.437288704763645e-01   -2.693365906734632e-01   -4.596052022841349e-01   +1.745524419995316e-01   +8.736333700970131e-02   -6.655913479361021e-01; -1.612236167904203e-01   +5.948693172028532e-01   +4.958506185020234e-01   -2.143639345823601e-01   -4.839742594242020e-02   +1.845285565530488e-01   -2.628652460905720e-01   -4.060150895455031e-01   +1.347731771355114e-01; +1.966599728757428e-01   -1.453531765438510e-01   +6.808170559327892e-02   +3.426792291595372e-01   +1.489644230815176e-01   +3.037190492032429e-01   -1.508614562498359e-02   +2.063286329670315e-01   +6.936023099997382e-01; +5.737309850160008e-01   +1.237464112078259e-01   -6.545982355913037e-01   +1.975964779898277e-01   +5.383349187549310e-01   +8.770357799044837e-02   +1.642240768474360e-01   +3.327147032767336e-01   +1.358660669719116e-01; -3.908471882417078e-01   +8.384322645016969e-01   +1.399098060155746e-02   -3.219179866123179e-01   +9.783861526524626e-02   -8.245758862311588e-01   +1.588196901815485e-01   +1.602705004122065e-01   +3.547362616619745e-02; +1.241669026796646e-01   +5.324106976308317e-01   -5.504726377634740e-02   -1.849216599057038e-01   +2.669077170324400e-01   -3.406602298379540e-01   -2.031245822983976e-01   +5.211694648781322e-01   -2.506633818998423e-01];
L1_L2_iAMPA_netcon = [+2.674039343761689e-01   -3.024532057787168e-01   +2.944204332042767e-01   +1.634618710101200e-01   +3.774458316925078e-01   +7.287889282317576e-02   -2.117004097187278e-02   -4.751369403341681e-01   +8.146452227793436e-01; +7.971720686493791e-02   -2.110947131472103e-01   -5.645515407081217e-02   +5.007859343697018e-01   -6.106141475368301e-02   +1.326710074128378e-01   +2.713422525752127e-01   +1.822701495351174e-01   +2.160370897689657e-01; -1.899764999952809e-01   -5.867883139009292e-01   +2.271480025453559e-02   +1.334509380045892e-01   +4.086132340583646e-01   +6.572572033161679e-01   +5.450537811329754e-01   +1.335742418269069e-01   +5.571902941272207e-01; +1.683271230021988e-01   +7.415284247264075e-01   +1.310883488129080e-01   -4.278613302452736e-02   +1.146443138271246e-01   +1.785192123957885e-01   +5.823066196337023e-02   +7.040915827772698e-01   +2.488177774682602e-01; +3.652007197194881e-01   +4.947632900983211e-01   -3.277755894324942e-01   +2.167959582270828e-01   +2.433960514639831e-01   +3.784285423605754e-01   +1.094237167760561e-01   +4.975971133020443e-01   -2.167888892878305e-01; +1.676835363973427e-01   -1.456487428594644e-01   -4.005653141560882e-01   +5.149175219368871e-01   -1.122694606685530e-01   -3.146551472996202e-02   +3.626993763786020e-01   +2.162060157352134e-01   +4.138408159035187e-01; +7.866373263843003e-01   +4.041261377652748e-01   +3.759697844339783e-01   +4.199120109144426e-01   -2.294275205522403e-01   +1.403128124323478e-01   +2.226769467016004e-02   -4.261250649289061e-02   +3.643296049288858e-01; +5.808676671610815e-01   +4.196194284677271e-02   +1.934161668286838e-01   +2.674233466258786e-01   +3.086360094057375e-02   +6.626541522947769e-01   +3.947773693677051e-01   -1.830674512764349e-01   +1.262853386012092e-03; -1.488214528193325e-01   -8.219581110484772e-03   +1.289184250001151e-01   +2.713995399927849e-01   +2.450724496876488e-01   -2.118402437799725e-01   +9.501192998710450e-01   +9.923236297313354e-02   -1.641568255491865e-01];
L2_L5_iAMPA_netcon = [+5.818029730453143e-01   -2.291039261859207e-02   +4.032884818553427e-01   -3.140352126506504e-02   +3.860838685869521e-01   +9.735198604153011e-02   -3.546498458407386e-01   -7.517934210687331e-01   -2.453433459479801e-02; -2.621506527214033e-02   -3.816014068808540e-02   +8.566438691470288e-02   +2.656037015050957e-01   +8.537911142078729e-02   +7.259141940886924e-01   +1.340204948899806e-01   -1.934109519220073e-03   +1.959320583105652e-02; +2.502055804453260e-01   +1.745585373316149e-01   +4.920842768524585e-01   +7.963767065359155e-01   +2.870715075669860e-01   +5.806503735458897e-01   -4.001365326489800e-01   -1.015923187715690e-01   -1.282573124641788e-02; +3.600546609763858e-02   -4.512355286648280e-02   +2.710988690990635e-01   +1.775929693473486e-01   +1.720307699837651e-01   +1.608051164017638e-02   +2.984689168743352e-01   +4.651438559905909e-01   -5.318696325486268e-01; -1.443834037055788e-01   +4.711874821089647e-02   +3.988525284265910e-02   -6.888173504207107e-02   -6.415488360003783e-01   +2.758285197719266e-01   -2.558226220616605e-01   +6.208793284381344e-01   +5.303793849276108e-01; +2.252014373826820e-01   +6.037365906729181e-02   +1.375804194659654e-01   +4.332811985715312e-02   -2.646393915661617e-01   +2.593921016594000e-01   +4.286463830090438e-02   -2.012877455950193e-01   +7.623083381772996e-01];
L5_L2_iGABA_netcon = [-3.243127785195783e-01   -1.552833075162431e-01   +6.515976237383936e-01   +2.047796743444730e-01   +2.572600435386510e-01   +3.398466999938277e-01; +5.440991141858470e-02   +3.362507535122615e-01   +1.324813701055894e-01   +1.864371188938107e-01   -3.437430120366997e-01   -7.946433104211255e-02; +5.863131774405506e-02   -1.462862683180460e-02   +6.781329747650211e-01   -2.757149712120421e-02   +1.971152399170655e-01   -5.686164515591691e-01; -4.576516606026165e-01   -2.670598631532506e-01   +6.739274366870926e-02   -3.052857730992559e-02   -1.112671790737896e-01   -7.683604874279912e-02; -2.796442596158972e-02   +2.012938580956278e-01   +3.050497150483746e-01   -4.026124590061765e-01   -6.497012637426161e-02   +2.684930188030279e-01; -2.738716468298460e-01   -2.246891224186598e-01   +8.933804091466296e-02   -1.846582202267895e-01   +9.073045429985022e-02   +3.946586900763210e-01; -1.735276104746596e-01   -1.131454395528813e-01   +5.232499523281771e-01   +7.082898079217068e-01   -7.523371442959701e-01   +1.571298906578686e-03; +3.724704522859197e-01   +9.461774527777786e-01   +5.681648586670376e-01   -7.073527914764169e-02   -5.585281656499019e-01   +3.377272602652432e-01; +2.518493565581340e-01   +4.049651137502790e-01   -4.491884688988901e-01   -2.449607315184863e-01   +1.492519223545011e-01   +3.243421531984413e-01];
L3_L2_iAMPA_netcon = [+2.303042985569746e-01   +6.981879966531895e-02   +4.304906193666921e-02   +9.326053055162210e-02   +2.724444508785258e-01   -3.104689203129474e-01; +1.808382623108508e-01   +1.225816909814274e-01   +5.610598483489564e-01   +1.842965476461118e-01   +1.675592970199490e-01   -1.302991983691814e-01; +3.652440730264514e-01   +8.389780464339127e-01   +2.482713188229972e-01   +2.608762722907217e-01   +4.836867495212472e-01   +3.727916323656962e-01; -1.955706580016658e-01   +1.055113426655096e-01   -6.500069953325174e-01   +1.474912225852273e-01   +7.166441953418048e-01   -2.074666399014392e-01; +3.681490362515988e-01   -9.028023538667435e-02   +7.441857190164802e-02   +5.320491266121227e-02   +1.684458118217262e-02   +5.722057271980814e-01; +2.857231749266382e-01   +2.765583720172247e-01   +5.495279254156210e-01   +3.122736338053092e-02   -3.991265221613832e-02   +1.098470000662464e-01; -3.178503577189495e-02   +1.492839330537539e-01   +1.399292143511124e-01   -4.938346277624978e-02   +1.396231313276485e-01   -4.505381141734560e-02; -4.241111759827439e-01   +5.258505522094421e-01   -2.809935310781877e-02   +3.120160300556598e-01   -5.196796318107068e-01   -3.343681597315514e-01; +4.891258195157034e-01   +2.537816548373982e-01   +2.552652216831691e-01   -3.064676413531808e-01   -5.203613232585207e-01   +5.010426337753799e-01];
L2_L3_iGABA_netcon = [+2.714157683736482e-01   -9.164358505641096e-03   -5.195461745529266e-01   +2.055601242831904e-01   +1.041118184007601e-01   +3.242366415380399e-01   +1.209933003158154e-01   +3.516511140082427e-01   -1.992882955287351e-01; -2.498088704701931e-01   +4.499945878957623e-02   +3.880695714042381e-01   +4.188589557726760e-01   +2.981408464553662e-01   -7.349233371094149e-01   +1.382976020626280e-01   -3.750288539874347e-02   +2.384453295152054e-01; -1.667825269195407e-01   +3.392445830143537e-02   -1.220396891366281e-01   +1.693522847548130e-01   +4.484648479038965e-02   +3.211406319168910e-01   +2.593595593903635e-01   +4.890357960959864e-01   +2.948976817241193e-01; -5.696380718154831e-02   +6.147428492787805e-01   +2.502372822441715e-01   -4.324642436109080e-01   +3.173622667240074e-01   +2.005135738305526e-01   +3.754011750070500e-01   +5.668034255791803e-01   +2.707467020717390e-01; +2.751218168712921e-02   +5.946880710733924e-01   -2.856106529807321e-01   -4.116353333386784e-01   -8.777906978930616e-02   +5.819409441584117e-02   +2.918303970974123e-01   -2.266883601975727e-01   +3.021913899678550e-01; +2.470271214144352e-01   -9.084115271314330e-02   +5.890584956655139e-01   -2.434435665208378e-02   -5.757035840958452e-02   +2.136949669568232e-01   -2.774086973763143e-01   +9.359817623562405e-02   +2.329231827198366e-01];
L1_L4_iGABA_netcon = [+3.204251281193363e-01   +1.062063276557360e-01   +2.073671175540369e-01   +4.962736593579332e-01   -1.998983312488916e-01   +3.451256856678267e-02   +5.096000088336171e-01   +5.696183198075736e-01   -3.858933681495977e-01; -3.005964844379295e-01   +4.531200193333856e-02   +6.748771571833802e-02   +1.187244216553378e-01   +1.237211061232416e-01   +1.340304818212774e-01   +3.018804116718277e-01   +9.893098810303931e-02   +3.065459070053111e-02; +9.306067396258258e-02   -4.238328004246996e-01   -5.885943517114300e-03   +3.002621737560522e-01   +8.105700769341695e-03   -1.377316952321528e-01   -2.717107857298368e-01   +6.017757090747791e-01   +6.491014809945588e-01; +4.321932608956226e-01   -2.835394465274120e-01   +3.168058999685784e-01   +2.745323200339923e-01   -9.445884299792835e-03   -8.776377465655735e-02   +3.174802416039899e-02   +5.086180646323311e-01   -5.810640373045299e-01; -3.007127072858681e-01   -4.724266250358778e-01   +4.427663246500460e-01   +2.820106586443646e-01   +6.204772620398455e-01   -4.948836091942305e-01   +4.207113235954214e-01   +2.039056845533103e-01   -2.915705160876040e-01; +1.200595611726113e-02   +5.079912020463073e-02   +3.558114588198037e-01   -4.654677560486253e-02   +4.335705888595559e-01   +3.325127946323515e-01   +5.545392586262352e-01   +2.290324557948059e-02   -2.024718454771705e-01; +3.114348470008624e-02   -3.695222498666575e-01   -1.062575704622366e-01   +3.413823683893591e-01   +2.849781075892637e-01   -5.874933720022604e-02   -5.229628025558337e-01   +2.256462809848609e-01   -3.870244292289627e-01; +5.512802635891434e-03   +6.465247915107941e-03   +5.987691696259329e-02   -4.765251416172499e-01   -1.147389147170060e-03   -6.741350590280140e-01   -8.832409374783803e-02   +1.794330527452218e-01   -5.702189036936248e-02; -4.934417922141178e-01   +2.086127799774789e-01   +3.157232074990222e-01   +5.382952930747682e-01   +2.053193135902528e-01   +7.714327426460289e-01   +1.231476817269484e-01   +5.818032251103683e-02   +4.506535755364645e-01; -1.205951799952723e-01   +1.750778952377959e-01   +7.834832411843119e-01   +3.669080602779331e-01   -7.098849445499437e-01   -2.216587834855584e-01   +2.621300404901603e-01   +2.198544773920466e-01   -6.762628929482949e-02; +3.688269302008260e-01   +6.540386599249419e-01   +2.547533595157583e-02   +8.267041540260023e-01   -1.041540747184059e-01   +8.559793799682365e-01   +3.206112573934513e-01   -3.141279635151313e-01   -7.065004090265227e-02; +3.477965048220541e-01   +7.849242374793264e-01   +2.280592096350565e-01   -3.848994692328688e-01   +7.650582440738588e-02   -2.449095283748734e-01   -5.083099299417838e-01   +8.547256368494591e-02   -3.082692640065293e-02];
L4_L1_iGABA_netcon = [+1.200687824406829e-01   +6.069480405754641e-01   +2.230121009388569e-01   +1.318710822221496e-01   -1.800564782091695e-01   -7.618768613692279e-01   -3.480648268656630e-01   +1.509623250443340e-01   +2.445391213905077e-02   -4.146185247115817e-01   -4.124295081341250e-02   +9.979333163414535e-02; -4.282386886273356e-01   -2.325733111261223e-01   -4.086882639096505e-01   +2.479357168367727e-01   +5.881041776322953e-01   +4.517229602103038e-01   +5.126188660699798e-01   +3.332644554645315e-01   -2.912929793407976e-01   -1.808145517193163e-01   +5.370432131142922e-01   +5.037723651025680e-02; -1.390018534809587e-02   +1.308883717185141e-01   -1.317423169536093e-01   -2.378581539615099e-01   -7.579967417690281e-02   +1.142821283087860e-01   +6.365996071086929e-01   +2.026817235964773e-01   -4.971271598017306e-01   -3.561229646148543e-01   +5.019358979049940e-01   +3.087897021979574e-01; +6.444280546000658e-03   +5.156749634260742e-01   -5.403873252323690e-02   +5.162637993119209e-01   +8.530139731648945e-01   -1.954853168414765e-01   +2.467572653695634e-01   +2.144091086102035e-01   +4.056696232184501e-01   -8.747125113982249e-02   +9.684195134066775e-02   +5.837711773009098e-01; +3.290787726340821e-01   +6.666912382294693e-02   -5.779270573551271e-01   +2.402533692599227e-01   -1.541299038060425e-01   -5.031246810943243e-01   +2.839916206792946e-01   +8.404033595392699e-02   +7.169915861866236e-01   -5.345488895416852e-01   +1.783447801057317e-01   +4.033981823692444e-01; +2.900775255786103e-01   +3.459379996822569e-01   -2.359485169898696e-02   -1.766256661303450e-01   +9.313302353720553e-02   +1.538613427739500e-01   +3.004792296779973e-01   +5.582747537025021e-02   +2.529665123396391e-01   -3.027219127589690e-01   -4.152073476110407e-02   -8.177287624903973e-02; +6.250753220752536e-01   -2.887534393135634e-01   +9.330092490601846e-02   +1.214787364792280e-01   +5.482067819577929e-02   -2.869906578587909e-01   +2.908671456532370e-01   +4.083973655779859e-01   +2.330311905579681e-01   -1.679282907481511e-01   +6.602173104952184e-01   -3.600812127111971e-01; +3.744840871525412e-01   -8.190945270223793e-03   +7.650274178859593e-01   +1.397207173930788e-01   +4.087647847672914e-01   -2.412174574191688e-01   +2.055134819152814e-01   +4.676786240126383e-01   -1.385567924619721e-01   -4.654686088764550e-01   -2.048206257452566e-01   -2.694659904286273e-03; +1.571044509286130e-01   -1.667414752533299e-01   -4.713671662969273e-01   -1.968202421837965e-01   +5.325081725949676e-01   -2.012831789626814e-01   +4.533906350801795e-01   +8.119606059114994e-02   -4.304095114175030e-01   +2.534456548632093e-01   +2.772169279722635e-01   +6.457851156551437e-01];
L1_L3_iAMPA_netcon = [-1.940975179013789e-01   -1.957675790613862e-01   +7.040251366216324e-01   -5.368566141744371e-01   +9.041306544857348e-01   +2.702249716179020e-01   -1.875133424917838e-01   -2.384218998739857e-01   -4.558811058085666e-02; +7.871182511718315e-02   +5.798866299639082e-01   +5.710484627769394e-03   +4.704576839332716e-01   +7.017951659682760e-02   -2.661423287865197e-01   +4.200709860998949e-01   -1.928249296271503e-02   +2.273683908981200e-01; -6.916295500920255e-02   +5.517975360931771e-01   +2.457614083762606e-01   +1.328161841212754e-01   +3.977689201498645e-01   +4.633032521411988e-02   +1.967610114730374e-01   -6.488063968849251e-01   +2.367122224483187e-01; +5.208779484225493e-01   -3.269238484407817e-01   -2.946209341805264e-02   +5.530466354398357e-01   -2.790764215846968e-01   +7.278651993770280e-01   +2.278325467103087e-01   -6.086894154492811e-02   -2.109440435170157e-01; -4.223037330721255e-02   +8.500103746660273e-02   +3.701349906476545e-01   -3.486134600137395e-01   +5.159116684735057e-01   +1.004296329685131e-01   +2.829474831810329e-01   +6.663043270695399e-01   -1.587151097661506e-01; +4.941357257585036e-01   +4.797306462661878e-01   +1.054938201792808e-01   -3.442573739133524e-01   -3.946650499726932e-01   -2.229408665656450e-01   +1.548394676265069e-01   +7.572476202829162e-02   +3.880052076233322e-01];
L3_L1_iGABA_netcon = [+2.746117986313765e-01   -2.920163281679275e-01   -4.386424617743268e-01   +1.430307484697845e-01   +3.201881703530289e-01   +4.335772803958031e-01; +1.972870785756349e-01   +6.268980225326057e-03   +2.455598585078970e-01   +3.351375626483094e-01   +2.665396923065599e-01   +5.058416080433774e-01; -3.319791514111866e-01   +4.026557727301456e-01   +9.328624145252917e-02   -1.317596922517267e-01   -1.898112339015026e-01   +1.255811671798292e-02; +3.148723699412366e-02   -2.399742354423283e-01   +9.322378227954667e-01   +5.086769312703356e-02   +1.976834140698294e-01   +5.611047763279315e-01; +6.590466115706819e-01   -1.415122493703728e-01   +3.414434551009812e-01   -1.252021967851282e-01   +1.902092969282268e-01   -5.218597359321326e-01; +1.556577973743328e-01   +9.028874028669045e-01   -1.671712682150995e-01   -6.698208448499682e-01   -5.797072006200403e-01   +5.611452383871880e-01; +1.717422675510515e-01   -9.707983954277637e-02   +7.169389283430827e-02   -1.776311212101048e-03   -8.277406666296847e-02   +1.789830779948159e-01; -5.006920758325120e-02   +7.127719181831216e-02   -4.641870257547990e-02   -1.009709394126622e-01   +1.568583613946842e-01   +3.517911396717560e-01; -2.679903438185430e-02   +4.944069724260178e-01   +2.979477790359213e-01   +8.537163116927790e-02   +6.467814143979699e-01   +3.704033693903331e-01];
L5_Input1_iAMPA_netcon = [-3.671418835810335e-02   +1.194374696399741e-02   -4.734157169750266e-01   +1.761235863639426e-01   -2.779212905746176e-03   -1.259317266441707e-01];
L6_Input2_iAMPA_netcon = [-3.877647818107290e-01   -1.155782607639686e-01   +5.550535000255063e-02   +2.399586642371386e-01   -4.083853338531512e-02   -3.716448139773812e-01];
L5_L6_iAMPA_netcon = [-4.284946730946643e-02   +1.982720711342534e-01   +2.531513950971911e-02   +3.383860304553676e-01   +3.511011242897973e-01   -4.419209002090713e-01; -1.976435301087631e-02   +3.714418010146401e-01   +1.883106530017683e-02   -5.038384869528106e-01   -7.530725704948962e-02   +5.001509748731168e-01; +5.072675923039165e-01   -3.394738917370388e-01   -4.380674796037085e-02   -4.046559654177460e-01   +2.770584534664818e-01   +6.825952687984249e-03; +4.047190824683027e-01   +5.439786396370946e-01   +1.519972980703227e-01   -3.558621135928139e-01   -7.943180351047062e-02   -4.610041326533763e-01; +5.413117137056722e-02   +4.634131333665242e-01   -2.161671862532187e-01   +3.461270537659027e-01   -1.273692586620155e-01   +2.885389850384968e-01; -2.664922715333133e-01   +4.823291220081687e-01   +5.518703589379683e-01   +4.418442022061911e-01   -3.045817660211844e-01   +3.663621770046459e-01];
L4_L5_iAMPA_netcon = [-1.051244812943011e-01   +2.712932070078244e-01   +5.641750460762777e-01   -5.356383830716336e-01   -6.602575768860985e-02   -3.028318492576739e-01   +6.083700628092051e-01   -1.356627260546522e-02   +3.918611666913344e-01   -1.256689596580527e-01   +4.439257599588228e-01   -3.819994072487858e-01; +1.139589420554643e-01   +6.808556546672607e-01   +4.737646744587660e-01   +8.229618396827507e-02   +3.666405124133734e-01   +2.477503713192626e-01   -3.589443355423974e-01   -2.601042095349477e-01   +6.083394651399968e-02   -1.394861135769197e-01   +4.922826749822398e-01   -5.478146416160993e-01; +6.570576211212904e-01   +7.225769598308789e-01   +7.117990290746871e-02   +9.010197682699647e-02   +3.214718305757766e-01   +9.794388851721647e-01   +2.162784247147346e-01   +4.329975081434809e-01   -4.471651256732578e-02   +6.460070083536815e-01   +1.426580920393225e-01   +2.528271108965983e-01; +5.746638460051969e-01   +2.282503125400623e-01   +3.824722761194383e-01   -2.651181631073797e-01   -3.389407878606410e-02   -3.794844716633712e-01   -2.672639046969930e-01   +1.262205191076554e-01   -2.704516972861412e-01   +2.695543211343719e-01   -3.722199250039373e-01   +2.045699378670416e-01; -2.078061793915645e-01   +4.993027273372188e-01   -3.141274436316942e-01   -7.580766097583325e-02   -2.947596754214062e-01   +1.804184361296167e-01   +3.587285133024796e-01   -3.932839215507700e-01   -1.333886020659583e-01   -6.885501666801498e-01   -2.495655929980619e-01   +1.109980107636799e-02; +3.535548903753627e-04   -7.143551181306992e-02   -2.515156286553462e-01   -5.189680027154142e-01   +7.721152115520931e-01   -3.409221860920382e-01   -4.364924031110147e-02   -8.516697300904115e-02   +6.407182049818735e-01   +2.260969451131030e-01   +2.427829610037920e-01   +3.105703358323102e-01];
L6_L4_iAMPA_netcon = [-3.176991818930691e-01   +1.646206205984118e-01   -1.612765213664829e-01   +6.887385345105888e-01   -1.734720049295225e-01   +8.021806952393000e-02; -6.475195258679445e-02   +5.065690051511869e-01   -9.004838144042512e-02   +2.215070295965757e-01   -4.569786326058549e-01   +2.794322113966824e-02; -2.242776584061021e-01   +1.062405135857776e-01   +1.376426590002409e-01   +5.336897981114656e-01   +7.729153619058580e-01   +2.805415626603190e-01; -1.855475223803148e-01   +3.393112891436261e-01   -2.364511837819178e-01   -1.099392141209777e-01   +6.509707107665839e-01   +1.406211924998388e-01; -2.739840690417467e-01   +3.784843258545731e-01   +4.489091370414018e-02   +4.435363938394644e-01   +2.253413057352284e-01   +3.688323992858838e-01; +5.787334726702027e-01   +2.504401979333918e-01   +4.140875641700896e-01   +7.209336857343562e-01   -2.644162714047604e-01   -1.827701243886982e-01; -1.193618918282554e-01   +4.846993075841900e-01   +4.214794750353780e-01   -1.181060086709999e-01   +1.931042550865895e-01   +3.481417034687999e-01; -3.898527191884759e-01   -3.188038668376048e-01   +4.377906033157226e-01   -1.111204119315517e-02   +2.478093204487032e-01   +3.029064682057756e-01; +4.616507113731546e-01   +4.571292164842083e-01   +1.141549408010796e-01   -5.027477466523100e-02   -2.359554732894616e-01   -2.453096196507064e-01; -7.200930524511920e-02   -6.332596700905919e-01   +3.411416763988744e-01   -1.802356222198038e-01   +1.270103497962513e-02   +4.965003144632552e-02; -4.036503481423482e-01   -1.081752268276532e-01   +3.825191597770549e-01   +5.899418822611768e-01   -3.937348150008056e-02   +4.967595007128428e-01; -1.537462495346487e-02   -4.881292243373723e-01   -1.839200162006934e-02   +1.770664438524971e-03   -8.839605138596793e-02   -1.011850298252604e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
