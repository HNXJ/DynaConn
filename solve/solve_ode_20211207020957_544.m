function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-8.152464534388443e-01   -1.000000000000000e+00   -4.695986252854690e-01   +2.359311761666959e-01   +7.413978652519753e-01   +1.640403758455369e-01   +2.758036605065964e-01   +9.076994656698565e-01   +4.782489068485302e-01; -8.062660111835697e-02   -2.975735560749276e-02   +1.636705482222837e-02   -4.346369522762609e-01   +9.708155556845145e-01   +9.461698440549113e-01   +7.099263147331395e-01   -9.432770342909909e-01   -6.120409413697189e-01; -9.329905195922399e-01   -7.993271699706066e-01   -3.505399101238303e-01   +5.839472258153252e-01   -9.077293832283186e-01   -5.606696873445838e-01   +6.698155130192955e-01   -6.601906596146472e-01   +1.156630587101566e-01; -1.521397096873044e-01   +1.964063497207459e-01   -1.970700223286695e-02   +6.642098790515757e-01   +2.968300205769968e-01   -9.893445791337119e-01   -6.008668916180278e-01   -7.265789205869972e-01   +7.293920925341499e-01; -1.129057128956322e-01   -7.694460548971765e-01   +1.126361072045437e-01   -8.657523460945542e-01   -7.791256753244240e-02   +6.213396382896089e-01   +3.006942357407942e-01   +7.925383846216496e-01   -6.187179302326716e-01; -5.346535885397142e-01   +6.460452029943610e-01   -3.431833373321355e-01   +1.697946180070532e-01   -3.009752804777499e-01   -6.653754853084693e-01   -9.518943100561131e-01   +7.275977001676999e-01   +8.789546485745613e-01; +5.516782900592209e-01   -7.720522587968209e-01   -6.024436796850456e-01   +3.505241108909916e-01   -5.214891468458660e-01   -5.017715907700706e-01   -1.059710764302075e-01   +3.986135004153029e-01   +9.538189946110989e-01; +2.019034947043107e-01   -5.304728305576542e-01   -5.431263629279081e-02   +9.735775508924001e-01   -5.843904085481908e-01   -1.338675662557306e-01   +2.699722465741676e-01   -2.917128212895297e-02   +1.434110865368083e-02; -4.121669017755590e-01   +2.590646723773283e-02   -4.290910396414067e-01   -8.078630731306297e-01   -5.763135738097196e-01   -9.431877073972836e-02   +2.079925285104558e-01   +9.096273316907868e-01   +1.540425397809189e-01];
L1_L2_iAMPA_netcon = [-7.481747834803230e-01   +9.406915453800294e-01   +1.482341485320029e-01   -2.080929674419717e-01   +1.397412138121302e-02   -7.644218900018548e-01   +6.434866734532467e-01   +7.624305636555627e-01   -5.461138613304628e-02; +8.014296718959880e-01   +8.857003441138788e-01   -5.484396754630475e-01   -9.264724294279809e-01   -1.000000000000000e+00   -6.912623360809993e-02   -1.121750211050088e-01   +2.293472513566249e-01   -4.369491764998450e-02; +9.751549552624509e-03   +6.768912519839358e-01   +5.389421030675625e-01   +7.437974476616743e-01   -8.355867475636355e-01   -5.295594683144786e-01   -8.226873984538513e-01   +8.391100581363794e-01   +3.637071138726227e-01; -5.518600455235194e-03   -8.326482463969792e-01   +4.426869002469682e-01   -2.711132263576461e-01   +8.866263309127630e-01   -3.075184889263630e-01   -4.441082914744560e-01   +8.657294215862786e-02   +8.633327541735690e-01; -7.478636863887862e-01   -1.739187216448685e-01   +1.716348380266214e-01   +3.339547057994185e-02   +4.978314821143772e-02   +3.817949222528073e-03   +8.420602319824897e-01   -7.852903271150963e-01   +4.534037864405439e-01; -3.387085344392452e-01   +4.116665211606938e-01   +8.336618217775630e-01   +3.065870940432231e-01   +2.688149785957723e-02   -9.008271478535115e-01   -8.658709784397325e-01   -5.216592299340622e-01   +2.026738739635794e-01; -3.654869894972902e-01   -5.999180649069282e-01   -1.835767230076866e-01   -8.318164244268648e-01   +8.769614454801086e-01   -6.000305184872186e-01   +6.683488401274479e-01   +1.021315044386727e-02   -7.424122156368893e-02; -2.450938390928575e-01   -9.394884863740104e-01   +2.102852930341778e-01   +7.657856578181511e-01   -9.235532412396327e-01   +3.615744472187560e-01   +6.183278010983988e-01   -9.587080407167760e-01   +1.272392168433968e-01; -4.295176457128277e-01   -2.784346907415580e-01   +8.662199490803782e-01   +6.502249355169651e-01   +5.383120315503461e-01   -9.211030700549587e-01   -3.391063932517862e-01   +6.896857239541442e-03   -8.416045877130489e-01];
L2_L5_iAMPA_netcon = [-1.141542369583251e-01   +2.063674853382098e-01   +2.886943425757145e-01   -2.045479225138763e-01   +6.298779982213173e-01   +2.408693838337538e-01   -4.390850359442260e-01   +1.756732964440551e-01   -3.954124260477313e-01; +9.592128415041273e-02   +9.445906679534760e-01   -8.985614088364579e-01   +8.633449814704419e-01   -6.073347827078960e-01   -1.000000000000000e+00   -9.536037029246914e-01   +7.859848092789103e-01   +9.588816523170755e-01; -3.292433419741874e-01   +6.224928443464331e-01   +9.255161900135639e-01   +9.853479370266833e-01   +9.413777322084096e-02   -6.218860894658788e-02   -7.167645714837469e-01   +6.876449791657565e-01   -5.757939871221962e-01; +4.635305365216326e-01   -8.431994476280940e-01   -3.107684246581823e-01   +2.328142188771501e-01   -2.852278329231919e-01   -1.873944012677960e-01   -6.354599581220212e-01   -6.845834556724307e-01   -8.901890362674939e-01; -1.749970672944867e-01   -7.866435710341781e-01   +8.180844317543349e-01   +3.848771700880108e-01   +7.635344862166633e-01   +5.159888948040309e-01   -1.130746442268725e-01   +3.410585853721787e-01   +9.268656653553209e-01; -8.777061822771270e-01   +2.701442955797511e-01   +2.069322307170982e-01   -1.263171207547085e-01   -5.822657099960440e-01   +2.262914393963953e-01   -6.009802468942814e-01   +2.462095093887914e-01   -5.104377244064117e-01];
L5_L2_iGABA_netcon = [-3.587840532494687e-01   -2.152574795584984e-01   +3.158991576021491e-01   -8.913506509692284e-01   +2.265947146676828e-01   +7.235130796175258e-02; +5.503756150870316e-01   -5.701623187465154e-01   -7.413256958192191e-01   +4.689302064291043e-01   -3.270089517247358e-01   +3.975542628853097e-02; +2.855317491372057e-01   +1.000000000000000e+00   -5.671221809092081e-01   -2.785080094404893e-01   +1.035498281202133e-01   +6.040003198521597e-01; -7.217979069661333e-01   -8.673815589275605e-01   -5.848269555037118e-01   +6.979272088103213e-01   +5.976984612930153e-01   +1.719837080578164e-01; +1.061835615798063e-01   -9.032230065858312e-01   -7.594158216581248e-01   +6.820426316843503e-01   -5.155766198821139e-01   -5.349060771456164e-01; +7.283789886205901e-01   +1.085368182211793e-01   +2.932839647901794e-01   +7.495929901764748e-01   +3.803894331456510e-01   +3.216749490911516e-01; +2.909870851961252e-01   +7.051512745339944e-01   +1.196201117421990e-01   +5.655350708049409e-01   -3.801242804382367e-01   +5.092466660227032e-01; -9.016965910929839e-01   -2.427811190717184e-01   +1.674259798165369e-01   +6.585298015445051e-01   -2.693793205052004e-01   +7.461570164638947e-01; +1.740998285447486e-01   +9.070344998360863e-02   +1.754551365378766e-01   +8.393677167928871e-01   +9.050355823504456e-01   -3.266858295669575e-01];
L3_L2_iAMPA_netcon = [+3.866222192675512e-01   +8.008503270173510e-02   +5.317018058686347e-01   +4.583222143814532e-01   +8.717473757709703e-01   -8.394972970514567e-01; +6.939409008418388e-03   +9.993075336425264e-01   -1.774514716942328e-01   +7.551442882926963e-01   -7.302176285407122e-02   -8.731117907753677e-01; +5.356695974590632e-01   -4.861757410884303e-01   -3.812507189229357e-01   +5.968465594423957e-01   +8.203459795631999e-01   -2.898859956658008e-01; +1.133519965109728e-01   +5.847295954844023e-01   -7.975829430997694e-01   +5.719496960171341e-01   -1.000000000000000e+00   -5.162113880154380e-01; +2.436587446396409e-01   +4.738650095974274e-01   +6.106172907943996e-01   +9.644643292675650e-01   +2.011722690034285e-02   -9.102570646917310e-01; -4.796501653158172e-01   -7.042960950712117e-01   -8.184099091097007e-02   +5.808769240243024e-01   +7.615597058866264e-01   -3.117725947533586e-01; -8.070097866671465e-01   -9.209018187769942e-01   -9.105765914189579e-01   +3.563404210159918e-02   -4.837452590268798e-01   -6.045049471295021e-01; -1.829405750378114e-01   +2.057954254725451e-01   -6.151074212245494e-01   +8.997347806279834e-01   +4.071470661343426e-01   +3.956576272082584e-01; +6.197348229635534e-01   -3.994732600950565e-01   +4.900290757148558e-01   -9.238948078871185e-01   +6.952376075586579e-01   +6.436222614071038e-01];
L2_L3_iGABA_netcon = [+7.296444112469969e-01   -4.637707235551039e-01   +6.063994372175271e-01   -2.597295288590986e-01   +1.988143269236246e-01   +3.195062250720997e-01   +5.725313643530685e-01   -1.000000000000000e+00   -9.886783034970942e-01; +9.417648531807183e-01   +5.709414507892404e-01   +3.965934028541631e-01   -4.368556978877271e-01   +6.529424030984298e-01   +2.897037869140888e-01   -9.324509608578098e-03   -6.386113423353444e-01   +5.148100389214743e-01; -9.712804821577169e-03   -3.840041959320822e-01   -8.655103907827023e-01   -9.108068086265830e-01   +3.804057570985955e-01   -8.717669651840591e-01   +1.621226126112442e-01   +8.900063704802853e-01   +1.525154697279296e-01; +2.784362146206255e-01   -3.949317596380053e-01   +6.906912132775369e-01   -8.257402570824333e-01   -8.642994267489570e-01   -6.257380050844853e-01   -2.280747134397227e-01   -6.106721406675963e-03   -8.471539607691433e-01; +1.655134567437393e-01   +7.229179810118859e-01   +6.796560165111726e-02   +7.052044823816797e-01   +7.698140447986568e-01   -9.372189832140154e-01   -2.046420458145375e-01   -7.241984683460962e-01   +6.506257140848625e-01; -3.761160187237020e-01   +5.082790353874056e-01   +4.992358212284426e-01   -3.585883015560257e-01   -1.837239276746310e-01   -4.854958334162484e-01   -1.419765076253780e-02   -4.733599919607519e-02   -4.363073176397833e-01];
L1_L4_iGABA_netcon = [-7.725496909190955e-01   -7.701376037188741e-01   +6.798910435562994e-01   +9.788559169229227e-01   -4.702937492735330e-01   +2.084506346822413e-01   +3.295061085763790e-01   -7.278579034058359e-01   +2.969320592089947e-01; -9.202035657965421e-01   -5.906870486657851e-01   +1.954738075043036e-01   -4.088427069350350e-02   -7.443437921420183e-01   +5.760735107921536e-01   +1.244965356002072e-01   -6.144595977828139e-01   -7.174558732167242e-01; +5.427607224068928e-01   -7.503458217440871e-01   -6.029458895777616e-01   -9.577215529652741e-01   -9.537138741062565e-01   -3.788779522572221e-01   -8.779639755559857e-01   -1.763933402533421e-01   +7.963861285525635e-01; -1.982588034213039e-01   +1.855574336842896e-01   -1.921449725611031e-01   +9.344201317748706e-01   +5.504220118932758e-01   -5.019159183500149e-01   -5.841998639379566e-01   +5.954137211023920e-01   -8.714900728039358e-01; +3.246124606878036e-01   +5.232029130018154e-01   +7.196768421425295e-01   -4.952966609430857e-01   -1.082689601206580e-01   +7.670778080174988e-01   +3.404149652552890e-01   +6.970191735695028e-01   -9.269283750349622e-01; -1.000000000000000e+00   -7.361594180731746e-01   +3.286475558728256e-01   +2.253333296874667e-01   -7.362873946800784e-01   -2.288673041855060e-01   +6.605870224809638e-01   -7.477553842674662e-01   +8.976976843863228e-01; -7.365876625921688e-01   -1.682793613942765e-02   -5.072158407400089e-01   -9.185154644294465e-01   -8.845694450204161e-01   -7.123148197581733e-01   +7.635262625322967e-01   +8.683640286978817e-01   -7.091194787286795e-01; -6.427271236823975e-01   -9.895755639714612e-01   -1.760221897542842e-01   +5.148498127258153e-01   -2.943201034367283e-01   +6.966597137714203e-01   -3.922863102794152e-01   +1.423627791529567e-02   -9.597106992440639e-01; +2.687902016324384e-01   -4.989873542874541e-02   +3.190559858253905e-01   -3.496617476329772e-01   +5.503584629271444e-01   -3.015077201800214e-01   +3.679124466218845e-01   -3.199154255084444e-01   -8.187787305951330e-01; +7.153475885237557e-01   -5.394771589942169e-01   -1.932029150324492e-01   +6.356608225506072e-01   +8.933133623766754e-01   +5.009984376537236e-01   -7.634814036980051e-01   +9.478619355977706e-02   +9.082795314280031e-01; -9.995885463768168e-01   +2.568204883344882e-01   -6.346665468511470e-01   -1.577195496827047e-01   +8.189170041928147e-01   -3.499223739488735e-01   +3.232756815850833e-01   -1.697694610674496e-01   +9.077369144254119e-01; -3.559377152020722e-01   +2.446915915322721e-01   +7.474460826015761e-01   -9.031830034251680e-01   -8.921723503824006e-01   -4.514405906439485e-01   -8.170255939963511e-01   +5.364702459259642e-01   -2.998273589778463e-01];
L4_L1_iGABA_netcon = [+5.722271338612706e-01   -2.719839509449170e-01   +5.542655046594371e-01   -7.176669385593619e-01   -3.721432981347530e-01   +9.359717829074320e-01   +1.235687123724504e-01   +8.743946347202260e-01   -6.914690623108658e-01   -1.800293080242125e-01   +2.365522336619762e-01   -8.281690481845837e-01; +3.916908275785175e-01   +9.604527400497582e-01   +5.894181626899413e-01   +4.416264867840075e-01   +7.572061205761218e-01   +8.173830390475990e-01   -2.278670220622445e-01   -4.938155979002034e-01   +2.135363626195012e-01   +8.054532589563664e-01   +1.131277581206461e-02   -3.236476232604773e-01; -2.271423453371654e-01   +8.257708931625148e-02   +9.549846697603365e-01   +8.192267472931205e-01   -2.766935941260820e-01   -7.464353718882814e-01   +8.522040918357012e-01   -1.668896264218573e-01   -4.211802944121689e-01   -3.071063241091644e-01   -2.500584492323554e-01   +5.991206174002572e-01; +8.603766814548817e-01   +3.785453476724204e-01   +9.986402792631885e-01   -4.128854681522834e-01   +8.164381098842969e-01   -4.906878702199869e-01   +7.092188169602349e-01   +8.642208791859553e-02   -6.446608126278257e-01   -7.624952616122220e-01   +8.758196378241423e-01   +6.198103567065202e-01; +8.881641858711962e-01   +3.227586654215610e-01   -1.034607218978528e-01   -1.538185572373013e-01   -6.422135279602393e-01   +9.944937655252516e-01   -5.727791583856128e-02   +4.084482814523719e-01   +1.000000000000000e+00   +8.933693361117176e-01   -5.787852167467287e-01   +6.549279890512586e-01; -7.550266104151169e-01   -9.772697501512703e-01   +1.608768773030907e-01   -6.342052119453756e-01   -5.927875263951228e-01   +9.890964415650855e-02   +4.576196304904626e-01   +7.107103143413234e-01   +4.733370011435227e-01   -3.717916826794028e-01   -1.858798789870273e-01   +9.300739849958801e-01; +2.410233075170709e-01   +4.529148486143663e-01   +6.111903788321790e-01   +3.862687208833054e-01   -7.953982474934470e-01   +9.360306317460735e-01   -8.153916857570982e-01   +8.596904665449800e-02   -8.156558875914378e-01   -5.631750587575833e-02   +5.165917776649984e-01   +2.099957715460223e-01; +2.047553399052761e-01   +8.653392949618607e-01   +5.867442494435032e-02   -5.131015509730642e-01   +7.099576298883773e-01   +6.874273447880727e-01   -5.423055514426511e-01   -4.742640606806557e-01   -4.209924790614760e-01   +7.686898846000260e-01   -1.512528722603217e-01   -3.800058703426800e-01; -3.993658596910321e-01   +9.120776154920524e-01   +4.140329004342578e-01   +9.482884801137530e-03   +5.383330996863745e-01   -3.312558570691437e-01   +7.982123315188975e-01   -1.796777165789425e-01   +3.199891252725080e-01   -5.689676053691191e-01   -5.096526918226405e-01   -5.470649123556097e-01];
L1_L3_iAMPA_netcon = [-4.162582586757211e-01   -8.593966195775367e-01   +7.514536035369052e-01   -6.199807509114405e-02   -8.004540754695233e-01   -9.387077649715621e-01   -9.360806141129353e-01   -5.886506659752702e-01   +7.823889659829483e-01; -2.441633370735407e-01   -9.774156647868795e-02   +6.163443951254503e-02   -8.150860778061474e-01   +8.885778376470274e-01   +5.599956024950635e-01   -7.928978212143765e-02   -2.161776452538175e-01   -6.420087295762097e-01; -9.381027893275004e-01   +4.750067882373571e-01   -4.630106945066406e-01   -5.452934931587892e-01   -1.000000000000000e+00   +9.070914570300086e-01   -2.989074505502471e-01   -6.138734390046922e-01   +7.614137291216533e-01; -2.203653049754776e-01   +5.985190287558418e-01   -2.254047562751136e-01   -2.103492693295758e-01   +4.109538503383608e-01   +2.824919907819768e-01   +5.495862912461982e-01   -1.052138150436558e-02   -5.138182584424785e-01; +7.156346591785494e-01   -5.309805986848016e-01   -8.799084335353711e-01   +1.180259212699428e-01   -9.843290018300178e-01   +4.242748282480536e-01   +2.449755050509063e-01   -2.534223295050647e-01   -8.097220377273086e-01; +9.160566948749238e-01   +3.782553976200654e-01   -5.813759556630442e-01   -8.652527858627618e-01   -2.950607184858722e-01   +2.146919811501079e-01   +3.757294707936150e-01   -9.449722453891891e-01   +3.744738592253662e-01];
L3_L1_iGABA_netcon = [-5.288340186299649e-01   -7.597128951230191e-02   -8.758982647750191e-01   -4.996156170168005e-01   -1.000000000000000e+00   +3.766370800622786e-02; -2.286142252759601e-01   -8.612483392499918e-01   +8.466266341691582e-01   -9.565991285321646e-01   -2.929599004580700e-01   -1.405855181255085e-01; -4.318273899576100e-01   -3.622955453390824e-01   -9.844173560014475e-01   +5.572431502016462e-01   +6.470559718107656e-01   -8.720014079678184e-01; +2.108366228895835e-01   +1.349867335704027e-01   +5.658728225455597e-01   -4.394738543575179e-01   -4.594484123050933e-01   +6.074438103658411e-01; +1.162408108253466e-01   -3.468165683119456e-01   +4.841567160889718e-02   +4.403190441163435e-01   -1.387768509153761e-03   -2.866100057352813e-01; -1.078995743595744e-01   -3.488257901377494e-01   +1.773711289676708e-01   -8.943274309118902e-01   -9.424854667310304e-01   +5.271174980988399e-01; +9.434241289668321e-02   +5.557361799929866e-01   -2.796806359129099e-02   -9.174551746978910e-01   -3.997123285775689e-01   -1.465925613588503e-01; -6.789315235087581e-01   +8.934444606539237e-03   -2.561398469811298e-01   +6.361029831683275e-02   +4.355664105847445e-01   -2.396946881862592e-01; +5.888307992534727e-01   +1.984747594585712e-01   +3.965097736463433e-01   -3.394029185884287e-01   -7.425611795643938e-01   -7.730570201574338e-01];
L5_Input1_iAMPA_netcon = [-7.713271986662050e-01   -1.000000000000000e+00   +8.379343034823240e-01   +9.199081176837484e-01   -1.258117447724841e-01   -9.023378613810949e-02];
L6_Input2_iAMPA_netcon = [-3.098116485659427e-01   -4.000239523229376e-01   -1.000000000000000e+00   +2.384725924980673e-01   -2.571644993572671e-01   +6.634463109922952e-01];
L5_L6_iAMPA_netcon = [+4.587560585750829e-01   +5.973187468099123e-01   +5.716947082456452e-01   +1.434695544448865e-01   -3.738894256761651e-01   -4.837317521456849e-01; +8.677496703435067e-01   -5.639803868743516e-01   +9.249005550216534e-02   +3.736107979852502e-01   +5.006519256969425e-01   +4.494989684967531e-01; +9.709256248718656e-01   -8.727362387484742e-01   +4.804159938013147e-01   +2.692064027587484e-01   -6.745766949725461e-01   +5.658132888849834e-01; +1.484040622809553e-02   +5.281805669722257e-01   +2.918986435321715e-01   +3.439127816470314e-01   +6.755454834281015e-01   +2.573886433458902e-01; +4.563716078956623e-01   +1.836938896434705e-01   +8.539402031702435e-02   -4.472034624541055e-01   -3.574948453413816e-01   +9.963220393080855e-01; +6.792784787009547e-01   +5.891002112076154e-01   +6.267229583702151e-01   -6.075192006560670e-01   -2.882999930337254e-01   +1.000000000000000e+00];
L4_L5_iAMPA_netcon = [-4.197404768767466e-01   +8.769676868030220e-01   +6.808066094996479e-01   +5.609784801773089e-01   -3.823064588148293e-01   -7.755146392045822e-01   +3.775164795189801e-01   +5.329723879681483e-01   -9.657365742864944e-02   -2.688721460171820e-01   -7.495941962490119e-01   +3.560351215941280e-01; +2.310261330395205e-01   -5.504720370577830e-01   +8.488009604018339e-02   -1.096813181348551e-01   +8.649006128122002e-01   +9.025221585206626e-01   +9.062395906185612e-01   -9.544167149524223e-01   -1.000000000000000e+00   +4.875880166559387e-01   +4.418735558633911e-01   +2.529410538195263e-01; +2.054470188589833e-01   -4.480486158269802e-01   +9.593905535760571e-01   -9.231342685872159e-01   -6.773132591103036e-01   -9.546282681374265e-01   -2.448850207256333e-01   -8.233163731548235e-02   +2.918816898042410e-01   -9.964719584545076e-01   +8.399859816647302e-01   -7.802240600248006e-01; -9.311014056199891e-02   -9.811748374207918e-01   +8.049575600502671e-01   -8.972905289087416e-01   -2.163174129395156e-01   +3.694971567934762e-01   -6.426846450763125e-01   -8.645970616348285e-01   +1.143370660435663e-01   +5.906434851229723e-01   +7.253641855163004e-01   -2.308093558968221e-01; +2.083234697318080e-01   -4.048188350239529e-01   -4.891170801655641e-02   -9.739116160577032e-01   +9.398693826506116e-02   -8.005809987284969e-01   +7.147469044360497e-01   -4.057157006331860e-02   +6.747569046010636e-01   -7.583777156319442e-01   -1.830448051297264e-01   -8.915910875806432e-01; -8.802710369378899e-01   +5.361363785325375e-01   +8.724999169706129e-01   -2.674105259739626e-01   +5.813696012692560e-01   +1.496107862499809e-01   -9.111449796485794e-01   -3.057219464229197e-01   -8.007694439353544e-01   -9.798662057220409e-01   +4.166301974589266e-01   -8.861154888415984e-01];
L6_L4_iAMPA_netcon = [-9.434902618743151e-01   -7.201306802672297e-01   +8.733654156342634e-01   +7.746334765805534e-01   +3.693812413510552e-01   -6.058505544627844e-01; -1.858652947757052e-01   +4.580526655966634e-01   +5.271469230757055e-01   -8.944730774694749e-01   +5.335478791347261e-01   -7.041776996001378e-01; +5.850615356960369e-02   +3.299516909539784e-01   +6.132612615035875e-01   +1.463446780759145e-02   +8.297442439908355e-01   -1.911322437838814e-01; +2.711539972917286e-01   +1.864674057901314e-01   -8.263999609852284e-01   +8.765744346724226e-01   +5.708245745488683e-01   -9.642547084422860e-01; +3.827053108384953e-02   -2.547379440257544e-01   -6.224144265291357e-01   -1.971894232375606e-01   +2.911478083295697e-01   +8.696738708508106e-01; +2.481937585891950e-01   +1.181747295619053e-01   +5.191301178795491e-01   -3.013419285879421e-01   -4.989497805744972e-01   -5.628004076038995e-02; +3.932989946405811e-01   -4.678732191458776e-02   -9.868316558753040e-01   -1.887217960863539e-01   -3.303016162161176e-01   -8.582352041800978e-02; -6.104933467918622e-01   -9.085308459130367e-01   +6.916800445985382e-01   +8.722307207683070e-01   +1.298608289515203e-01   -1.837536354527048e-01; +6.409801750047743e-01   +8.199259059767361e-01   +7.924795844949128e-01   -5.034869562911067e-01   -1.000000000000000e+00   -5.377844873103510e-01; -2.565279439544644e-01   +7.137874395058294e-02   -7.861276291076803e-01   -3.039991660842817e-01   +4.703895010678635e-01   -6.739380502464730e-01; +2.589195458775342e-01   +8.276789127950324e-01   -3.456073520872648e-01   -2.052407648678216e-01   -2.921899695981211e-01   -9.120373320214229e-01; -5.241900729782822e-02   +1.306784510824911e-01   -7.885967075149571e-02   -1.159453599460604e-02   -3.571749845050975e-01   +5.665147228954936e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
