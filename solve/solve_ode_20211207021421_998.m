function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.066905104740573e-01   +5.341233865304723e-01   -6.129926731036980e-01   +6.111993131516419e-01   -5.358499542978955e-01   +4.433337600837119e-01   -5.417699242533459e-01   +6.081292679878972e-02   +2.050817161207585e-01; +2.001681969453239e-01   +9.583347323311103e-01   +5.555297742944603e-01   +5.434720595369266e-01   -4.450897922718587e-01   -2.725502886795836e-01   +1.746195064997661e-01   -3.144001057315087e-01   +7.737661307549891e-01; -4.119171415116707e-03   +7.216730726170911e-01   -6.325054792764345e-01   -1.252585202886718e-01   -3.089300166302040e-01   -5.295472572506020e-02   +1.049585463013771e-01   -2.591094607420046e-01   +1.664618826753564e-01; -6.585926167786357e-01   -6.674457998538690e-01   -5.664895423636496e-01   -8.584517820490456e-02   +6.460707961084243e-01   -1.836088337444798e-01   -2.695546476352710e-01   +3.895937236616668e-01   +4.512877817059379e-01; +8.393804746570859e-01   +3.773186477114849e-01   -1.000000000000000e+00   -5.181307445754667e-01   +3.363430790945659e-01   +1.775771587847655e-01   +6.944883818308749e-01   +8.146593525667631e-01   +2.592060280817225e-03; +5.462781822286606e-01   -2.385270692613856e-01   +1.744650879681421e-01   +3.199002887881920e-01   +7.142656703192157e-01   -5.793064504146450e-01   +1.746604905807010e-01   +1.114469793067900e-01   +8.626679220781622e-01; +1.138323277163957e-01   +5.102462094748602e-01   +2.949178958823965e-01   +3.314818814283081e-01   +6.882778155858806e-01   -2.603410175737410e-01   -8.963518188977465e-01   +3.819453044976580e-01   -4.312433322559473e-01; +7.858183472797069e-01   -5.517501873404537e-01   +5.845112113847544e-01   +9.471487224278425e-01   +4.927651435480144e-01   +7.170171168312687e-01   +2.344792931509366e-02   -2.713519914410462e-01   -5.623595048322250e-01; -4.015270313919101e-01   -1.706837548785512e-01   +5.314857951999283e-01   +5.552919005180884e-01   +2.998663809903880e-01   -5.410383977365403e-01   +7.702736277099723e-01   +6.203998849097170e-01   -6.811033222286420e-01];
L1_L2_iAMPA_netcon = [-1.622069629518990e-01   -4.575286813877343e-01   -6.287951048065592e-01   +3.355103746771110e-01   -3.098758663169007e-01   +6.658304861328134e-01   -8.469813440686493e-01   -3.934898954435734e-01   -5.801814205122310e-01; +8.231679676014695e-01   +6.735810253425425e-01   +4.313900589445173e-01   +8.459328075516681e-01   -4.002706100006066e-01   -5.735464021805246e-01   -5.235573471631311e-01   -7.114580762589325e-01   +2.529580773663704e-01; +1.000000000000000e+00   -6.602935299954689e-01   -1.668313372894712e-01   +6.793616826370983e-01   -6.980838233291298e-01   +2.852523032719263e-01   -5.827027233843174e-01   +6.894679398743786e-01   +3.306246232855752e-01; +6.083173944966916e-01   -1.951156652285481e-01   +7.357250831551211e-01   -4.894373347955996e-01   +8.633811629933291e-01   -1.426311611234449e-01   +4.597410371009075e-01   -8.856801571452749e-01   -3.730959562383685e-01; -6.238214914152558e-01   -3.353001613720757e-01   -8.494551222273398e-01   +4.938803673173780e-01   +8.500774719492001e-01   +4.032150422724509e-01   -2.027940617879050e-01   +2.781512070343455e-01   +8.363280073025463e-01; -6.126715487893164e-01   +3.110887601802234e-01   +5.507312876346946e-01   -6.506277211210429e-01   -7.854195754613019e-03   +3.126807337730628e-01   -8.198389656347933e-01   +3.980633545273075e-01   +5.552862228083052e-01; +3.818925182910887e-01   -7.763054177595134e-01   -5.884641546595043e-01   +4.629589331001588e-01   -6.861801287236911e-01   +5.882443748093029e-01   +7.347060721019800e-01   +8.777678753484547e-01   +9.031174748571416e-01; -7.254231297953246e-01   -2.807380411227319e-01   +3.582972481641965e-02   -5.326546128837334e-01   -2.802931617101630e-01   +2.783843961141816e-01   -6.636157190170776e-01   -7.275578096240957e-01   -5.986031157792613e-01; +8.903997301477340e-01   +4.055829456722042e-01   +8.160008154606633e-01   +4.768482934251522e-01   +1.847966196544506e-02   +2.699505656180400e-01   -6.111762295732391e-01   -1.660492771468770e-01   +1.205043866438147e-01];
L2_L5_iAMPA_netcon = [+5.304058198514202e-01   -1.178949846385406e-01   -1.405962088721225e-01   -4.510727974170868e-01   +3.427653273100367e-01   +2.805233895855547e-01   -6.931480103157907e-01   +1.295840560796631e-01   +1.226790267319363e-01; +1.925717612803714e-01   -8.663311868559154e-01   -2.580433008961158e-01   +8.929150234751650e-02   -5.170499786045956e-02   -6.346986649459780e-01   -7.422419206228275e-01   -6.765395096599602e-01   +1.411763490225316e-01; -2.252712534179444e-01   -9.720236529727109e-01   +7.989743542684808e-01   +6.378717719480774e-01   -1.000000000000000e+00   -4.831026890152342e-01   -3.365637429244510e-01   -5.165137603834322e-01   -8.922781112331666e-01; +6.373614965151134e-01   +4.243838431283432e-01   +5.557342851165643e-01   +8.941551264998658e-02   -3.225578292332737e-01   +3.001730769937109e-01   +6.831921447128592e-01   +2.616361796084519e-01   +7.799855420150433e-01; +4.774006575048806e-01   +4.723187276693191e-01   -3.339344500763314e-01   +3.040249905966171e-01   -4.520600560379555e-01   -1.763781538496884e-01   -7.667340419460249e-01   -3.494987859180954e-02   -9.399182307690830e-01; -1.079726390264320e-01   -8.278608838390155e-01   +6.119421101337207e-01   +2.068524600563725e-01   +4.104815634889530e-01   +6.763543895386828e-02   -3.385717853730380e-01   +8.346790733760021e-02   +1.402488059646356e-01];
L5_L2_iGABA_netcon = [-7.000542374846953e-01   -6.246772603242398e-01   -6.227696456257377e-01   -8.767047711160582e-02   +3.837523320286026e-01   +6.024129426428856e-01; +2.804489909528761e-01   +1.163169966966640e-01   +2.238532730697783e-01   -4.147284754666923e-01   +2.524875616531581e-01   +3.782411429332344e-01; -2.460998284597506e-01   +6.271551150117914e-01   +1.092599328651058e-01   +6.376354106597966e-01   -6.684865879810727e-01   +1.005097773190551e-01; +6.808856932112164e-01   -8.377031905963980e-01   -1.247748232767390e-01   -2.857182396850617e-01   +4.478857190010426e-01   +2.471594821360966e-02; +5.165822227238548e-01   +8.287884370763242e-01   +9.549076489864501e-02   +2.663446640855942e-01   -5.725604645917594e-01   -3.063873592856601e-02; +5.933082611172760e-01   +5.154254353864699e-01   +2.052930685612588e-01   +5.774403643053124e-02   -3.914731549131549e-01   +6.573728326321977e-01; +3.576984872224007e-01   +8.535759464692357e-01   +3.947029324445686e-01   -3.995878830130349e-01   -4.931600981013674e-01   -6.363245556369910e-01; +4.241054449065322e-01   +3.384881641551936e-01   +5.929956326418327e-01   +1.474310270904003e-01   -1.270415330815168e-01   -2.958105788751619e-01; -3.824485899664559e-01   +7.069840922015745e-01   +3.920245601777323e-01   +3.718703868897774e-01   +4.747173187713686e-01   -1.000000000000000e+00];
L3_L2_iAMPA_netcon = [-7.337108058670172e-01   +4.162868443601139e-02   -7.380180890442369e-01   +3.695045653672146e-01   +2.650225766472305e-02   +1.302866587059775e-01; +2.851584895226272e-01   +8.320289435690166e-01   +4.481077352129545e-01   -7.265962737777557e-01   +4.182795204378637e-02   +1.670955097099902e-01; +6.812661620641047e-01   -4.932791948554247e-01   -6.195026135115532e-01   -6.304556585923438e-01   +2.102248188948670e-01   +8.027773776170722e-01; -7.867057912803286e-01   -2.367743501858067e-01   -5.605535386435436e-01   -7.067566804633694e-01   -3.281102753429680e-01   +6.309072510224941e-01; -6.835054557362774e-01   +2.738647369436445e-01   -4.538069011133588e-01   +1.868816840951922e-01   +4.674655929038476e-01   +1.105062428694642e-01; -3.896900958808378e-02   -7.124122565946115e-01   +2.900881782211214e-02   +5.819564124918566e-02   -6.021225056306067e-01   -1.954592020947612e-01; -5.617428782297046e-01   -1.671535652615299e-01   -1.431106800049582e-02   +6.506783360583220e-02   +5.604552542454608e-01   -1.000000000000000e+00; -5.350858582256371e-01   +1.259516612854574e-02   -9.996346028621075e-02   +8.374879457252214e-01   -2.898937674538963e-01   +8.565836952585257e-02; +1.755438265697434e-01   +7.496468909394859e-01   -7.908741381172777e-01   -6.955865049528208e-01   +1.427956172601095e-01   -4.276940419528083e-01];
L2_L3_iGABA_netcon = [+1.000319334431499e-01   +4.592782098685085e-01   +3.084702806079012e-01   +8.841479000737565e-01   +8.350436835428697e-01   -4.989744182541858e-01   +5.598620392813465e-01   +3.152494087357408e-01   -6.851851152212833e-01; +1.725727405510026e-01   -5.259310568171189e-01   -4.166895001301943e-01   -6.051216430884955e-01   -4.900505596677365e-01   -3.492467613749869e-01   +1.981575740654890e-01   -2.405554514009182e-01   +7.597535256585921e-01; -7.179326521454436e-01   +4.550626185606284e-01   +8.758350953222745e-01   +4.686315614480455e-01   +2.890412447560408e-01   +1.000000000000000e+00   +3.939643075391180e-01   +1.782748393916613e-01   -1.514332276819350e-01; +7.366042146462705e-01   -1.800333566597461e-01   +3.255626068060306e-01   +2.493826815473592e-02   -9.304241193189051e-01   +1.656479406575917e-01   -2.279814303786235e-01   +9.857197807776853e-01   +5.433514742768676e-01; -8.170261773243853e-01   -3.954947707546002e-01   +7.171471740538954e-01   -7.975826342758524e-01   -6.883135137732551e-01   -4.539653791896615e-01   -7.819818314430682e-03   +3.879365046783197e-01   +4.404027033931523e-01; +1.513361394806330e-01   +5.643507004913453e-01   +4.522892723994244e-01   -6.301195619879781e-01   -1.557902001118134e-01   -5.825959935171885e-01   +5.638118602328945e-02   +9.884950406604516e-01   +4.152895053070667e-01];
L1_L4_iGABA_netcon = [+4.415308405418120e-01   +6.838950767348916e-02   +2.944375165571152e-01   +9.465552728013321e-01   +7.251570775239534e-01   -3.086264652499673e-01   -6.187854538593122e-01   +6.595436898747098e-01   -9.461336941882439e-02; -3.294080319929040e-01   -7.602803570475228e-01   +8.723104663785697e-02   -9.849460831938089e-02   +7.621128291723127e-02   +7.720896005004486e-01   -1.723567620636965e-01   -8.205861582059950e-01   -8.175633860074789e-02; -1.157350864672822e-02   +3.039241941791929e-01   -5.762449404437644e-01   +7.889614729981048e-02   +4.866835294127706e-02   -3.285002793253124e-01   -6.639070517015643e-01   -1.466883524439132e-01   -8.788440027048013e-02; -5.900758366686472e-01   +5.674574723897515e-01   -7.753939530917578e-01   +1.321076405928137e-01   -6.079679468155682e-02   -5.385782299352233e-01   -8.571825212509755e-01   +6.382492581366701e-01   -2.814457931069701e-01; -7.799246427893722e-01   -4.382936756856886e-01   -7.528936149329013e-01   -4.859278849221379e-01   +3.820053530675142e-02   -2.688295347046298e-01   -5.536460468577881e-01   -6.515944175529459e-01   +7.033170341293862e-01; -2.193975378513528e-01   -1.034419314014597e-01   +2.556233146349415e-01   -4.488638458000934e-01   -5.689166891633297e-01   +1.586950901466062e-01   +8.636066260829509e-01   -3.388807866269333e-01   +7.223341742817538e-01; +8.278172491908485e-01   +6.859717689892514e-02   +8.206952796679275e-01   -5.376062427949010e-01   -2.580656272379014e-01   +3.670153760573041e-01   -3.407882139255703e-01   +6.880590520826619e-01   +1.194122034372168e-01; -5.579575066781676e-01   +2.584042468345174e-01   +6.844821671192629e-02   +7.289841362793263e-01   +6.784592558191360e-01   -2.340892496765626e-01   -4.183614690700680e-01   -1.778431461122922e-01   +1.301907335011285e-01; -4.131069458997813e-01   -2.324911829220141e-01   -2.483109194925123e-01   +2.433999150978014e-01   +7.423645918582822e-02   -9.114197003707807e-01   -3.908812737108024e-01   -7.036269896206965e-01   +9.405064781248097e-01; -4.558360761173251e-01   -4.264162597777905e-01   +5.403266052050648e-01   +2.784050146695169e-01   -7.543381627795266e-01   -9.616435193372960e-02   +2.416925565791766e-01   +4.040951818713830e-01   -1.376912602406754e-01; -1.264526192798402e-01   +4.032681232921256e-01   -2.645541174876489e-01   -4.400917997512939e-01   +3.816080658114003e-01   +7.452232488136188e-01   +3.527373361846133e-01   +2.639652034761398e-01   -9.097864633871681e-01; +3.542051145156018e-01   -8.282080384907532e-01   -6.267948201409467e-01   +6.919583644460844e-01   +4.173757297086802e-01   +4.653797466479274e-01   -9.508674626031256e-01   +1.000000000000000e+00   +2.032576426348073e-01];
L4_L1_iGABA_netcon = [+5.386308781199315e-01   -8.186542668923305e-01   -6.725009275831410e-01   -8.649635727149967e-01   -5.725858339495105e-01   +9.056560857662143e-01   -8.974187784634645e-01   +3.374428690933277e-01   +2.976414338297069e-01   -6.296069680820460e-01   -4.228415301129834e-01   +9.139047847175157e-02; +5.248202592331795e-01   +3.333524824618214e-01   -2.068796278748392e-01   +1.823560749697043e-01   -8.539841415328257e-03   +3.201077270294856e-01   -4.504914200498387e-01   -5.417515155765871e-01   -8.073853875936531e-01   +5.985095285728220e-01   -8.153994328063289e-01   +3.445087060385493e-01; -7.835467734430134e-01   +9.231039309775168e-01   -3.357818865283818e-01   -2.232943761944138e-02   +4.283124649387519e-01   -7.766025348221381e-01   +6.004069625918931e-01   -1.406825805995063e-01   -7.939842015496424e-01   -4.606421958625920e-01   -9.427715979125678e-01   +5.112659800905739e-01; +1.665979394968468e-01   -2.423488848329691e-01   -5.881933162650025e-01   -3.471979282492462e-01   +3.655446880611193e-02   +4.888099309594140e-01   -5.588165499424678e-01   -6.466796628583033e-01   +2.079335958077900e-01   -5.173148648941587e-01   +5.646177573882462e-01   +9.072778094205787e-01; +2.756124117588308e-01   +5.840310530476722e-01   -4.521926162599295e-01   -5.502465521299112e-01   -3.624912229983569e-01   -8.791419496962842e-02   +1.361231195446548e-01   -4.043114021041105e-02   -4.073984304721013e-01   +4.370295636519317e-01   +6.905307874435691e-01   -6.120590550908935e-01; +3.597623175195148e-01   -3.804769181856416e-01   -4.516099746116859e-01   +6.132447358292260e-01   +9.884477868268353e-01   -7.324024842630973e-02   -8.507175333154782e-01   +1.291952266064909e-01   +2.036083302289884e-01   -7.315282163454860e-01   -6.770257526140756e-02   +8.588078867650445e-01; -7.385266449375131e-03   -6.844005943180336e-01   -4.451878048623677e-01   -6.015998557396474e-01   +4.785476790991377e-01   +6.389178522873133e-01   +2.817706240360425e-01   -7.866901322623859e-01   +1.000000000000000e+00   +4.695855744186705e-01   +1.935281105115081e-01   -5.294410482395048e-01; -1.814526963267555e-01   +4.737071993830182e-01   -2.419415693310192e-01   +6.604314335106395e-01   -4.621380394184984e-01   -7.416529736651892e-01   +9.279488438783952e-02   +9.143179609299504e-01   +1.487903750877837e-01   -1.317991712887804e-01   -3.228276289131051e-01   -9.455130253301035e-01; +6.471946913681682e-02   +5.470157053072783e-01   -3.035922363511219e-01   -8.023912757214570e-02   +9.117880489473179e-01   +6.328031277997727e-01   +6.779153400026819e-01   -4.401104089404697e-01   +4.235232999782577e-01   -6.892357193700897e-01   -5.378917352412023e-01   +4.643300687750168e-01];
L1_L3_iAMPA_netcon = [+4.356963933210868e-01   -1.276040206988835e-01   +3.130290185245416e-01   -6.288966240070268e-01   -5.892337008081128e-02   +2.469757049416115e-01   +3.277669650757916e-01   -2.407306494619326e-02   -4.026564177497563e-01; -3.244596212922996e-01   -3.076084820839521e-01   +4.294094913860378e-01   +7.003904030760814e-01   +2.159929523945117e-01   +7.025784136694183e-01   -4.213657053165819e-01   +7.609115863845693e-01   +2.104452639451908e-01; -5.602662997150896e-01   -5.413969211443357e-01   +3.480815597775877e-01   +2.248423662495884e-01   -4.949914130142208e-01   +5.245619913207656e-01   +4.680022233987901e-01   +2.238578943769568e-01   -4.493877583729565e-01; -6.983195468985758e-01   -8.360433643266632e-01   -8.551886789763915e-01   -2.369271525676845e-01   -1.310843947425562e-03   +8.086180284685635e-01   +3.431340937915809e-01   -1.051421798569150e-01   +5.165518683373858e-01; -5.266765603348490e-01   -7.611831768265506e-01   +2.602278758433156e-01   +6.972859995044853e-01   -7.139498752129907e-01   -7.748755195631019e-01   +1.000000000000000e+00   +3.460935164661550e-01   -6.269965396599322e-01; +1.390055693466709e-01   -2.101993934095741e-01   +4.257029120712691e-01   -4.413381773160190e-01   +4.801032233885875e-01   +5.282313010964015e-01   +2.496685913775702e-01   -7.692552481187349e-01   -5.691395423082163e-01];
L3_L1_iGABA_netcon = [-4.302698590408401e-01   +7.355173541497998e-01   +3.612309741337939e-01   -4.030156084197444e-01   -2.365234601865292e-01   -4.234722157168901e-01; +7.618051234533737e-01   -6.118028440717357e-02   -3.986200677827458e-01   -5.846197523367455e-02   -3.601081500065649e-01   +7.323222799407192e-01; +7.019538002093745e-01   +2.040533619260292e-01   +1.412744375125446e-01   -6.841819589966363e-01   +2.055666740993682e-01   -4.010120926550215e-01; +1.803895769662515e-01   -4.582559202700806e-01   +7.689799865274085e-01   +3.189970035699421e-01   -6.607632533922736e-01   +2.903656659076735e-01; -5.606078992059135e-01   -1.636331073492547e-01   +2.904345421598936e-01   +3.278505280211584e-01   -5.280816215539069e-01   -4.180429183739446e-01; -1.945079336753772e-01   +2.875627350694957e-02   +2.366464004797993e-01   -9.205837687942371e-01   -3.944148431805757e-02   -6.655274345373399e-01; +2.436165427728826e-01   +1.751698145055963e-01   +2.434300646837798e-02   +2.302020188404942e-02   -9.233464667372321e-01   -7.203204800523163e-01; -6.094348197016057e-01   -6.661310093806099e-01   +1.790569932755130e-01   -2.691607129609024e-01   +6.867297907555083e-01   +5.113381839214783e-01; -4.879439651374692e-01   -3.666603669807229e-01   -1.000000000000000e+00   -4.962952253777860e-01   +3.474408246452485e-01   +5.365774906062518e-01];
L5_Input1_iAMPA_netcon = [-4.993889966326644e-02   -4.332308779381042e-01   -5.518317621293392e-01   +2.270099880966211e-01   +3.261169754872625e-01   +1.000000000000000e+00];
L6_Input2_iAMPA_netcon = [-6.174304287560558e-01   +2.041794168997891e-01   -4.243828960362210e-01   -1.000000000000000e+00   -3.256485041746590e-01   -1.130953886671067e-01];
L5_L6_iAMPA_netcon = [+1.229181059888578e-01   +2.733648395546082e-01   +3.038771077347381e-01   +5.423674756245784e-01   +3.857150955950941e-01   -4.134530199420974e-01; -9.937158760056795e-01   +4.070478351737128e-01   -7.989533651149051e-01   +1.284654530939287e-01   -4.805756905082068e-01   +4.566603148486311e-01; +4.360928465772287e-01   +2.113596905909916e-01   -3.980693070739746e-01   +3.972343608870350e-01   -9.123247094775108e-01   +4.617983365380899e-01; -5.908922048528072e-01   +6.433596693711905e-01   +3.701473282779619e-01   -9.773204551192434e-02   +1.000000000000000e+00   +8.018937934590707e-02; +7.640960130756541e-01   +8.013660035540479e-01   +9.487739826750412e-01   -2.318359455859766e-01   -4.017003687096871e-01   -6.609993977625349e-01; -3.357076215221150e-01   -6.848417686655121e-01   +3.485519485605657e-01   +6.155561496562978e-01   +6.492642014894594e-01   +4.180735929503953e-01];
L4_L5_iAMPA_netcon = [+2.852383307352847e-01   +1.645276430108313e-01   -2.400528824083571e-01   -3.985299106506459e-02   +5.166591119038594e-01   -1.983644019791924e-01   +1.154085480471498e-01   -3.715746225627087e-02   -5.913860291618187e-01   -2.443367404804515e-01   +2.696193654190416e-01   +8.555781721760283e-01; +2.938712620529026e-01   -2.663679675550930e-01   +2.455380547534870e-01   +2.418607257603365e-01   -2.092220725125070e-02   -4.748315189010984e-01   +6.665519658444559e-01   -8.689663053884281e-01   +6.058109981539542e-01   +1.564880906091378e-02   +4.686058811962035e-01   -3.340955600992080e-01; +6.727524247156432e-01   +2.622685269173456e-01   -2.895642352269672e-01   -1.188475513799371e-01   +1.535400116221589e-01   -5.374726857317124e-01   -2.021988279052399e-01   +2.850672173358848e-01   -9.077267036138953e-01   +3.003404905406978e-01   +3.780601270855479e-01   +7.710442973831505e-01; +1.592008868562579e-01   +7.147002198704197e-01   +3.023612918004379e-01   -4.846476330947725e-01   -6.805656587767229e-01   +5.674924991050752e-01   -1.023206899616296e-01   +9.501532442628551e-01   -2.822203615781573e-01   +1.524330348937337e-01   -2.210641085032863e-01   +1.320617132036405e-01; -5.444358468952746e-02   +6.053314793423686e-01   -2.975037768589810e-01   +1.067894310721672e-01   +2.049211367960156e-01   +1.014502696586569e-01   -9.626167808109605e-01   +3.795283551813359e-01   +7.271019177226211e-02   -1.326436789878315e-01   -6.367998054019443e-01   -1.000000000000000e+00; -5.109359727150764e-01   +8.684090996566300e-01   -4.528629454614228e-01   +3.037135495616326e-03   +4.123396418829194e-01   -5.603071003588812e-03   -4.822706371190080e-01   -6.449078970592154e-01   -4.446660305895976e-01   -6.577917274459887e-01   +6.626605243263818e-01   +3.855736264991186e-01];
L6_L4_iAMPA_netcon = [+2.843312415648875e-01   -6.943051134448619e-01   +6.504194856250336e-03   -1.933929487196742e-01   -6.134945553986243e-01   -7.191661848470324e-01; -8.589424478068821e-01   -9.475460086869099e-01   -5.602765411744108e-01   -5.945454912073248e-01   -3.223522988787518e-02   -6.896040740597298e-02; +7.059265021735102e-02   +6.354816342878183e-01   -4.496193417372768e-01   -3.835312610593389e-01   -5.560691619936134e-01   -4.241122726435645e-01; -3.314039441650559e-01   +5.206156193735838e-02   -6.883340574998880e-01   +2.532602296750184e-01   +7.165974633667135e-01   -1.239483136511815e-01; -1.583952239231258e-01   -7.173894682601242e-01   -1.828382012262974e-01   -2.103905851208347e-01   +2.715499838464588e-01   +1.000000000000000e+00; +1.221385633172046e-01   +6.347048231241638e-01   -3.632419209777882e-01   +4.995075493053707e-01   -5.842358303641814e-01   -9.555030592745922e-01; +2.875474108347802e-02   -5.888916358793067e-01   -4.382837008717649e-01   -5.022454091039387e-01   -5.660570488322217e-01   +3.133418486075590e-01; +2.510816291946179e-01   +4.210149648768928e-01   -8.272452317639776e-01   +4.394132153367626e-01   -4.067019047401856e-01   -8.860204150405487e-01; +1.932611639561931e-01   -7.451957521718054e-01   +2.286000445758003e-01   -3.560559340586062e-02   +3.955214833065117e-01   -6.496571899043205e-02; +1.535833581908893e-01   +2.343668869668457e-01   -5.750962590647895e-01   -8.012777820762601e-01   -6.057817030975418e-01   +9.550267677792166e-01; +1.642425879896826e-02   -2.110688518036409e-01   -1.262269019997856e-01   +7.856266028562275e-01   -4.940359445750375e-01   +1.047020977891993e-01; +2.275196391454198e-01   +5.369215238428049e-01   -5.071158885485859e-02   -5.755949557966045e-01   -1.135702084792906e-01   +9.658233532402648e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
