function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.864149712969642e-01   -3.527132791353830e-01   -1.000000000000000e+00   +6.013696004161470e-01   -4.748332296087917e-01   -7.062762143668805e-01   +2.649376060401132e-01   -4.216122489333556e-01   -7.327977184906620e-01; +3.418905320823474e-01   -8.094057654799409e-01   -5.367609682900020e-01   -3.430947331440548e-01   +2.675812015436987e-01   +4.365822986178420e-01   -2.742061731651673e-02   +4.697027368979080e-02   +5.160672223264450e-01; -3.798042296596006e-01   -8.845266692370862e-01   +7.641515303998303e-01   +9.831334118476671e-01   -5.245305439934049e-01   -8.021574019249177e-01   -1.415971790348486e-01   +6.968623442783383e-01   +4.804798999602275e-01; +9.559504560662959e-03   +6.795301700811367e-03   +4.373214077475359e-01   -7.319426505751825e-01   +3.183869091566111e-01   +5.828932900421288e-01   -7.195307999979895e-01   -7.291468586129332e-02   -5.251048630295979e-01; -5.659166688881508e-01   +1.557252756982644e-01   -7.569090021583244e-01   +3.522993912898240e-01   +4.793421960414335e-01   +7.823760827368909e-01   +5.761506437129273e-01   -2.678336984834758e-01   -4.866377901888009e-01; +6.497260952870960e-01   +7.543341974440569e-01   -3.601715867893733e-01   -2.054313761825116e-01   -4.602954975253206e-01   +5.633878164966399e-01   -6.115901704980108e-01   -5.337255610770992e-01   -7.927853906543824e-01; +1.531471510417889e-01   -2.799897986121840e-01   -4.927751204000710e-01   -5.941736706841951e-01   +8.613652024575016e-02   -2.719769060730682e-01   -6.340020756002528e-01   -6.395318353349078e-01   -8.976726063040906e-01; +6.545169266314090e-04   -4.646743381809910e-01   -5.093089001253356e-01   -6.299501350409308e-01   +6.962011064026897e-01   -7.567879002461785e-01   -4.483620521020349e-01   +5.787452520118129e-01   +5.792809802001444e-01; +7.025438347194513e-01   -6.634568210495917e-01   -6.597931314279015e-01   +8.260170117853012e-02   +2.349414272133158e-01   +7.522144045386832e-01   +7.149399896502291e-02   -4.425746231594079e-02   +1.597783960890308e-03];
L1_L2_iAMPA_netcon = [-1.501689983133319e-01   -2.229357833419519e-01   -3.119600769443784e-01   +9.330703274123608e-01   +4.421747184617542e-01   +6.743891337288634e-01   -9.302396314265848e-01   -5.018878222118250e-01   -3.377286760252677e-01; +9.127044696287104e-01   -8.608241956362310e-01   +8.890122741508761e-01   -7.801451292870545e-01   +7.143949173588242e-01   +5.862389875340345e-01   -1.737930372406628e-01   -2.833263867679274e-02   +6.011766590612263e-01; +3.140326960339478e-01   -5.202492808878828e-01   +6.787656857482539e-01   +2.286749346094869e-01   +1.000000000000000e+00   +3.693852580946082e-01   +7.212542687084972e-01   +7.971450661165242e-01   -4.188624221853402e-01; -9.399556249936560e-01   +4.861001429633784e-01   +6.780516216577145e-01   +3.994137170951870e-01   +3.619433087957195e-03   -7.437917592387827e-01   +7.881436421515302e-01   +1.920204439543857e-01   -1.152467691423116e-01; -4.946763686981562e-01   -2.926900323694333e-01   -4.085270668464078e-01   +3.142245286107888e-01   +9.700641991532617e-01   +2.888652607137760e-01   -8.227559467337696e-01   -6.586860207728781e-01   -4.658591505706131e-01; +4.524721769952515e-01   -4.921765020095618e-01   -2.746178254922558e-01   -2.303749691892202e-01   +4.908906221201805e-01   -4.611092583143955e-01   +1.750559657802769e-01   -2.309881767305792e-02   +4.818262758206446e-01; -6.034733304194529e-01   +5.177909113773883e-01   -5.584709108185186e-01   +6.155146916064083e-01   +7.397838346730610e-01   +1.478691781692897e-01   +5.805752785441398e-01   -2.234338003532527e-02   -4.532182204169510e-01; -7.991333819011571e-01   -3.022573722602228e-01   -2.230105245102817e-01   +3.948010687579476e-01   -4.959604982423904e-01   -2.489320215058776e-01   -7.659974328229548e-01   +1.912263640593804e-01   +4.998380112603092e-01; -6.079418282078531e-01   -7.229778605857603e-01   +2.890650222900344e-01   +1.676193468957893e-03   -5.902139633514604e-01   +7.575599814916368e-01   +7.888327512871078e-01   -7.688277647117395e-01   -4.572516032831124e-01];
L2_L5_iAMPA_netcon = [+3.104381194463264e-01   +3.620627306718797e-01   +4.339394453706193e-02   -7.617820746778363e-01   +4.125543533076615e-01   +1.374389179514210e-01   +3.610434858154426e-02   +3.901496297289927e-01   +7.713767526793167e-01; -5.718177035052308e-02   -4.246807073812769e-01   +1.156789710009323e-01   -2.614414029064976e-01   +7.133349619927537e-01   +3.324960783243493e-04   +7.646317742068295e-01   -8.428923643312820e-01   +8.557641999053075e-01; -5.023172138989002e-01   +3.559865533343872e-01   -2.816292433709211e-01   -2.175762637062318e-01   +4.533381070112723e-01   +1.291305408200420e-01   -4.480143977300223e-01   +5.197656949778854e-01   -5.090971756699672e-01; -3.661356923240330e-01   -8.088455750281492e-01   +4.098912483273067e-01   +3.943327247807148e-01   +3.029909053816641e-02   -4.899669031168685e-01   -4.730743619827229e-01   +5.823377652514793e-01   -5.753541283542447e-01; +7.519143974475858e-01   -9.536559430188134e-02   +7.100853106745422e-02   -6.466970652376769e-01   +3.085462273089797e-02   +3.575067001816766e-01   +9.562781079534250e-01   +7.595846791681805e-01   -7.843848495591449e-02; +7.436804442148118e-02   -5.908952869706562e-02   +8.259056238989511e-01   +9.830896137942131e-02   +5.689949794530699e-02   -5.457608415501819e-01   -1.838894235478962e-01   -6.157886974283810e-01   +1.000000000000000e+00];
L5_L2_iGABA_netcon = [+8.339187811719957e-01   -8.938667035840939e-02   +1.339140588195352e-01   -3.406174016768324e-01   -7.107339270189897e-01   +1.000000000000000e+00; +9.835102604743751e-01   -2.543447480416169e-01   -2.186862834981180e-01   +7.578183932476424e-01   +2.493825448097598e-01   +9.418026517382408e-01; +8.373856964504602e-02   +7.367057390361618e-01   -7.341949997388155e-01   +6.078233045414880e-01   +4.243048622045142e-01   -4.362174009638894e-01; +9.945339291297978e-01   -3.676564669899473e-01   -7.103303226843704e-01   +1.921487703669325e-01   -1.275984224836389e-01   -2.853467059580652e-01; -7.159771714726240e-01   -7.758925544316506e-01   -6.824766540130531e-01   -4.308487375999995e-01   +4.773067859222592e-01   -2.196513451076867e-01; -7.545345001699448e-01   +1.456328852049504e-01   +3.429392184609880e-01   -2.238566218461854e-01   +5.841112619335136e-01   +5.127221475077273e-02; -2.036224683623246e-01   +8.831755606545809e-01   -2.721772420613746e-01   -2.414486790545950e-01   -1.956448136078484e-01   -7.200072082100345e-01; +7.934787141000710e-01   -2.831642482026784e-01   +3.618894417942924e-02   -1.500818071483569e-01   +6.782390581279346e-01   -1.649268910340516e-01; -1.517087755491233e-01   +1.790712245335991e-01   +2.470663809470271e-01   -3.606177521610346e-01   +2.056276887584984e-01   +8.222592792364092e-02];
L3_L2_iAMPA_netcon = [-7.722791695187596e-01   +5.617971755402862e-01   +6.232933010731413e-01   +1.305788154483514e-01   +4.466051450594495e-01   -3.624116860478815e-01; -6.923347507873575e-01   +3.107155207486397e-01   +3.582606310258233e-01   +5.670989721326012e-01   -1.629242735071613e-01   -5.141309415310210e-01; -8.772170195918406e-01   +1.000000000000000e+00   +1.477684895412325e-01   +3.645902771332114e-02   -1.935217783201903e-01   -6.195130306119865e-01; +2.969422220809600e-01   -3.739400042211996e-02   +2.770359089995962e-01   +9.876661778913589e-01   -7.387597712097748e-01   -2.261180186122813e-01; +8.757002700834121e-01   -2.859996251062196e-01   -1.996738338398532e-01   +7.938512690839601e-01   -4.930320769128610e-01   -2.635305492454317e-01; +9.096900130137595e-01   -6.648710031170292e-02   -8.507691542991470e-01   +3.226738402300874e-01   -7.280468445617138e-01   -3.770248189126125e-01; +9.101787466361404e-01   +1.386712712998377e-01   -6.318700982021187e-02   -8.556603274109821e-01   +6.703773201671747e-01   -5.667220553071236e-01; -3.637968902298409e-01   +9.323218186803955e-01   +5.165552994489787e-01   +9.178900091686560e-01   -2.273199373999849e-01   -5.324695832672154e-01; -4.973624750861911e-01   -1.008265622945658e-01   +6.953493943570006e-01   -2.101174057072649e-02   -5.759840831693209e-01   -2.201218958063676e-01];
L2_L3_iGABA_netcon = [+5.118967333545140e-01   -6.449591714393025e-01   +2.425155543109094e-01   -6.550061902821774e-01   -1.842818553207632e-01   +3.580393838758647e-01   +1.362928724372721e-01   +1.000000000000000e+00   +9.084698519091672e-01; -3.807404335460158e-01   -8.870683599638239e-02   -4.524207336528282e-02   -5.245663907940687e-01   -9.767657828245685e-01   -9.465514804567604e-01   -3.762789347332894e-01   +7.349148963558011e-01   -5.485433172654559e-02; +5.608155877101378e-01   -1.149493064157456e-02   -3.348220640676072e-01   -7.598373271254252e-01   +6.350272187160423e-01   +7.046840368762649e-01   +7.364936340530422e-01   -1.672900386082949e-01   +2.905724139929593e-02; -8.455785342500680e-01   +2.249497452686866e-02   +7.872817337076053e-01   +9.558487139126712e-01   +9.378371003947362e-01   +2.499117910023992e-01   +4.384735528615556e-01   -4.329753870435678e-01   -5.979278439307830e-01; -2.979983182536754e-01   +1.881137475861530e-01   -8.128358178713163e-01   -3.917107057061833e-01   +3.090441971478429e-01   +1.457308247780715e-01   +5.991300443604551e-01   +8.553511670854873e-02   -1.383325741686840e-02; +9.677112916444054e-01   +2.056913700854142e-01   -8.702215045861273e-01   -2.029896275383085e-01   +3.337615254886567e-01   -8.216703039579651e-01   -1.471312870606100e-01   -6.512845297863208e-01   -2.089704454348653e-01];
L1_L4_iGABA_netcon = [-3.218364028804122e-01   -1.000000000000000e+00   -5.144753615527154e-01   +2.903423335245711e-01   -2.981175876667707e-01   +6.362861583604281e-01   +4.260020275894066e-03   +6.581352413878068e-01   +1.062651464330188e-01; +5.552058759916074e-01   +1.240551804551230e-01   -8.147916391624055e-01   +8.240538038005786e-01   +2.755600226934352e-01   -3.568286799276396e-01   -4.540995194790672e-01   +4.251799805988407e-01   +4.255848077699350e-01; +8.776125537088217e-01   -3.581009818707890e-02   +2.280881159062884e-01   -7.333298469140013e-01   +8.639011180513100e-01   +1.370476297056369e-01   -3.160978289180199e-01   -1.182385418723763e-01   +5.136135800204420e-01; -7.151427833434487e-01   +2.097495125573037e-01   +2.532289200444831e-01   +3.965462052810442e-01   -1.224721696586818e-01   -5.242459330134491e-01   -2.328694124676339e-01   +2.234365055521737e-01   +9.674858159472661e-01; +1.082492112514141e-01   -1.164172599402818e-01   +5.619068375036366e-01   -9.223341906050351e-01   +4.780847734914932e-01   +4.586922016671353e-03   -4.229992207303422e-01   +7.949492015028713e-01   +2.392721102702331e-01; +2.161019949256401e-01   -6.074992522204680e-01   -2.568967615680376e-01   +5.386840514492008e-01   +1.341291301491191e-01   +9.721887002867086e-02   +6.839155751843906e-01   -1.886108880825539e-01   -2.765881652119809e-01; -6.070013780391823e-01   +6.036616188815574e-02   +7.888725910691132e-01   +5.326614091620600e-02   -8.848032860460737e-01   +6.365375460005033e-01   +4.137263587395255e-02   +3.032969891945595e-01   -7.759798880704315e-02; +2.176828135880378e-01   +5.812196727902122e-01   -1.431414581959940e-01   -2.805595294201557e-01   -7.579079594601027e-01   +7.939421069099691e-01   +6.613011932870321e-01   -3.128812325063587e-01   -2.808563237686164e-01; -9.658676171517015e-02   -3.459002307811558e-01   +9.237359088845579e-01   +4.652015690672811e-01   +5.208696356579445e-01   +7.544636124757653e-01   +8.002139294643387e-02   +3.290741602209844e-01   -4.137318301391888e-01; -9.572496572511643e-02   -6.497328172634865e-01   +2.270309700524071e-01   -4.315042481631930e-01   +2.697780248043499e-01   +3.903920277873476e-01   +8.281460743893762e-02   -1.684947964081428e-01   -5.597382075835330e-01; -1.907630265874398e-01   +5.177031351094864e-01   +1.509242644134816e-01   -4.269187961887824e-01   +3.987217713016846e-01   -2.234216925505813e-01   -1.979439511886479e-01   -3.321339400165889e-01   -8.205837806207313e-01; -4.443890127829177e-01   +5.140383326951899e-01   +5.175734074796396e-01   +3.681275617968426e-01   -2.055975474926651e-01   -1.882332107974204e-01   -5.792230619010520e-01   -5.503404019343081e-01   +1.573279948338927e-01];
L4_L1_iAMPA_netcon = [-2.215869686883893e-01   -9.348763717001482e-02   -2.588888200898747e-01   +6.547544333760207e-01   +1.121370985857268e-03   +2.688678026931665e-01   -5.025344765370769e-01   -4.816115156963320e-01   -8.799744261945578e-01   -8.787005171512920e-01   -7.577503855819615e-01   -8.232534478772855e-01; +1.218262716960585e-01   -6.680363027492323e-01   -2.056752661404152e-02   +7.622804568693036e-01   -6.910559318897574e-01   -7.401747113302196e-01   -6.546449183256993e-01   -6.367484010459951e-01   -2.707062749347097e-01   -6.726991568335777e-01   +4.123295021308118e-01   -6.808345962029435e-01; +7.591734308723231e-01   -3.057573555460232e-01   +6.971194569414231e-01   -1.854691612386108e-01   -6.908472405217987e-01   -5.791298690571695e-01   -8.085171222662482e-01   -3.422851776653113e-01   +2.252011969311192e-01   -3.597084960113734e-01   -6.394139116053078e-02   +9.926412302008509e-01; -4.599347303980160e-01   -4.254653430523063e-01   -5.766405639681940e-01   -3.876821957765916e-01   +9.574383578973772e-02   +4.119815997432610e-01   -7.803308404348221e-01   +1.551279946868709e-01   -2.015837269213474e-01   -3.726936731692688e-01   -8.167209919357312e-01   -5.644538928877425e-01; +2.615273064553308e-01   +1.751292658717900e-01   +2.522413134516773e-01   -1.951866513044837e-01   -7.186862827794108e-02   +5.998094714296687e-01   +1.704801663376101e-01   +1.000000000000000e+00   +1.190084446306742e-01   +3.893387569829595e-01   +4.179164095022693e-01   +1.561426068510262e-01; +9.726723790265233e-01   -2.733731812085838e-01   -2.784168581451664e-01   +8.312061897432717e-01   +8.681343704358665e-01   +4.664560416476401e-01   -1.441369258632085e-01   -2.640956295590463e-01   -5.608904607106242e-01   +7.422093674995566e-01   +2.919341531257967e-01   -5.982685151257675e-01; -1.539404336738679e-02   +4.191107172909088e-01   -9.498096005841939e-01   -5.074811184567385e-01   +8.939361027352344e-01   -1.800280899871351e-02   -7.499288528353157e-01   -4.822909920797510e-01   -6.812551336311791e-01   +8.640419330461122e-01   +1.121812352080400e-01   +8.146136180569408e-01; -8.683433020918304e-01   -2.597958986291272e-01   -2.687276842816486e-01   -7.915230816637102e-01   +6.568063450911343e-01   -3.014170730304216e-01   +4.799124986707166e-01   +1.294472043835053e-01   +4.142476567347582e-01   -2.008713309282956e-01   -1.706423246843532e-01   -1.841779984232913e-01; +3.857591372983271e-02   +6.530654718003903e-01   -7.336808273797287e-01   +3.594164530636065e-01   -8.293116998792904e-02   -4.413075807026252e-01   +7.676089342490865e-01   +6.104285701517213e-01   +1.444334424618454e-01   +3.058351707114795e-01   +7.404996626582475e-01   +5.333178772871022e-01];
L1_L3_iAMPA_netcon = [-8.739702986791803e-01   -2.791277571814854e-01   -7.895802418928199e-01   +5.617245110657096e-01   +3.839929457114716e-01   +9.137429516092190e-01   -7.105876541906817e-01   +2.006281907755777e-01   -5.893110708721406e-01; -9.151730570754694e-02   +7.930125859943963e-01   -7.029444387285918e-01   -4.640367989233818e-01   +3.769266621329813e-01   +2.051857179555243e-01   -2.683479194363848e-01   +2.028811319967684e-01   -4.763334086967728e-01; -5.662756607819088e-01   -7.230563840630384e-01   -1.961515567935099e-01   -5.475992893932360e-01   -5.875358075648820e-01   -8.335656353202482e-01   -1.611719374550623e-01   +6.305058135868190e-01   +6.063416814940443e-02; +3.410214548174607e-01   -4.692548007478449e-01   -6.285237743811777e-01   +7.947898057660697e-01   +9.007190150220538e-01   -1.006907579731794e-01   -9.679806410018140e-01   -9.074553285302349e-01   -9.387066226491493e-02; -1.000000000000000e+00   -6.189734843822524e-01   +7.009587966054545e-01   +9.164332020902974e-01   -6.971134739592943e-01   +7.876775728355804e-01   +7.791442007113109e-01   +4.089630150080047e-01   -5.661454132761392e-01; +6.823450849447753e-01   +1.201703694395854e-01   +5.098895030670163e-01   -2.809230826740530e-01   +3.955517907220761e-01   -4.732202929681076e-01   +4.049429273941445e-01   +5.616727130458825e-01   -7.795433990124380e-01];
L3_L1_iGABA_netcon = [+4.396451631064962e-02   +2.008472300161155e-01   -5.486020310925163e-01   -6.383839460050029e-01   +6.088282476341692e-01   +6.650519451608861e-02; -3.860683789221439e-01   +1.508154846835230e-01   -3.504201879885780e-02   +4.358742832987459e-02   -2.448613210741531e-01   +3.562137904079756e-01; -5.023847766587285e-01   -8.113602074834866e-01   +6.681901320364381e-01   -2.942254519882994e-02   +1.341702430868588e-03   -2.280808317420558e-01; +9.643543764172313e-01   +3.819759046420708e-01   -4.440452785998760e-02   -3.283014779074560e-01   +7.963568654499612e-01   +6.892557228525446e-01; -5.866766043989713e-01   -1.000000000000000e+00   -1.120403358778503e-01   +6.451173861941250e-01   -5.000245621686318e-01   +2.802573047802888e-02; -7.085594827471132e-01   +2.265319225534579e-01   -2.163512608406116e-01   -1.749874846752495e-01   +6.015008818862362e-01   -8.144988947639023e-03; -6.386454329945594e-01   +6.234456513321493e-02   -2.171132608698325e-01   -9.138811647121530e-01   -6.021102174407168e-01   +7.420356824649956e-01; +2.703264224180183e-01   -4.881024153701691e-01   +7.871923059505441e-02   +3.771313125406062e-01   -2.939874238331202e-01   +1.751298287702482e-01; -7.308366205607163e-01   +5.314364911622214e-01   +4.710853818266527e-01   +1.238785380932532e-01   -4.848638114121509e-01   -2.680890568017007e-01];
L5_Input1_iAMPA_netcon = [+6.226618354208261e-01   +5.028025978536568e-01   -1.061640681452459e-01   -1.880373548899588e-01   +1.000000000000000e+00   -5.784682839905921e-01];
L6_Input2_iAMPA_netcon = [+4.520761763114459e-01   -1.000000000000000e+00   -6.386652144801486e-01   +7.402169687937348e-01   +8.150509537023686e-03   +1.600513123231562e-01];
L5_L6_iAMPA_netcon = [+4.596320638524807e-01   -3.743674248308869e-01   +6.720577324795717e-01   -3.257027579121724e-02   +4.190453862552494e-01   +3.856367670099428e-01; +1.573352010167729e-01   -6.163574529705502e-01   -2.709474637508024e-01   +7.385397440497352e-01   -8.418301751189300e-02   -6.149689580210927e-01; +1.272297505927567e-01   -4.440793098649817e-01   +4.422226050885083e-02   +9.571735724426270e-01   +9.516201579000716e-01   +1.000000000000000e+00; -7.225424921260682e-01   -3.482637798643260e-01   +1.900229109744724e-01   -1.225184042825854e-01   -5.788450117307792e-01   +4.771084982332677e-02; +1.120262442864985e-01   +7.158789135294020e-01   -2.599770108731352e-01   -4.532855044594298e-01   +9.032064464113964e-01   +7.580534012243236e-01; -6.465349526917364e-01   +3.613873526521750e-01   -1.258029881170154e-01   -4.713858574003010e-01   -2.066821765377451e-02   -3.764209944318397e-01];
L4_L5_iGABA_netcon = [+7.952367449508962e-02   -4.405012706398962e-02   -6.116925374603189e-01   -5.069734686137898e-01   -8.813831670452054e-01   +4.136846542988361e-01   -7.191876948066497e-01   +8.028119970053541e-01   -5.434706240642532e-01   -7.083026930363906e-01   +6.711162371340780e-01   +2.859382648349070e-01; +2.020663740208178e-01   -7.485537706827198e-01   -7.171906443550494e-01   -7.666729191196913e-01   -1.624890725953481e-01   +6.860316147757027e-01   +1.105421976671192e-01   +8.550486091365908e-01   +5.249522792676538e-01   -1.064170719393323e-01   +3.919767643327695e-01   +4.591286664110545e-01; +5.295035594002320e-01   +1.323453391558778e-01   +8.832085473930729e-01   -6.847063173350838e-01   +1.614423699094691e-01   +9.309996664995498e-01   +4.642810035471560e-01   +1.704963743506819e-01   +7.295878850248322e-01   +7.678486589986575e-01   -9.152620613651072e-01   -1.450095654045834e-01; -6.426275764237251e-01   +1.000000000000000e+00   -7.390828312391746e-02   -9.253062161189920e-01   -9.117391330435960e-02   -3.872552647117626e-01   -6.293891066914563e-01   -2.716714725738413e-01   +9.778251878688077e-01   +8.087669672315682e-01   -4.045288518560630e-01   -8.852592312028734e-01; -8.190186845171336e-01   +9.834827613864529e-01   +5.342648546308838e-01   +1.519381701429033e-01   -5.898445147832152e-01   +9.193168968354014e-01   +2.179028344150192e-01   -3.907876066747391e-02   -8.809838152734244e-01   -2.064530895303928e-01   -3.428425672476616e-01   +6.950735285344235e-01; -9.172048749370978e-01   -4.051277225610919e-01   +7.391545604684604e-01   +5.220400403131752e-01   +5.131505870285189e-01   +8.021535930614346e-01   -7.810961607095124e-01   +5.875988045327496e-01   -8.408458669722838e-01   -9.892179092768425e-01   +1.728679059952190e-01   +7.692848682160875e-01];
L6_L4_iAMPA_netcon = [+5.210811733126026e-01   +7.170083603299033e-01   +7.486819248719071e-01   -6.017431217575769e-01   +2.908548059052139e-01   -6.104373507237174e-01; +3.781070455161194e-02   -7.091254966250107e-01   +1.951961395551792e-01   +2.808516284768982e-01   -4.560928121926032e-01   -7.320895607743703e-02; -6.416965467852733e-01   +6.828923757426083e-01   -4.961483763887887e-01   -7.971235245563595e-01   -3.456529733493039e-01   +4.824344240558309e-01; -3.092908219291105e-02   +6.534793520085304e-01   -1.647805618037106e-02   +7.615053571944407e-01   -6.493521408679204e-01   -3.875892355830176e-01; +6.801426085713508e-01   +6.090338387557230e-01   +3.996209699370051e-01   +8.877778591575246e-01   -5.706941613720965e-01   +3.247725598629101e-01; +8.324521601100560e-01   +7.319523864096085e-01   +4.335123809315350e-01   -2.901493379424166e-01   +7.610185814500218e-01   +7.970051035421086e-01; -3.761149728472232e-01   +7.003448190595893e-01   -5.436324001488568e-02   -9.800736077266945e-01   +4.815041212459470e-01   +7.765379337607488e-01; +5.863484919846287e-01   +5.097156353415959e-01   +4.186090427664826e-01   -3.522935654545519e-01   -5.738642785457036e-02   -9.451373919490695e-01; -6.332608807722123e-01   +5.938625322134244e-02   -7.408293292438576e-01   -1.606809651564050e-01   +5.500635594492166e-01   -3.620823552264231e-01; -7.563635296738289e-01   -1.283281660479636e-01   +9.203400126767375e-02   -1.000000000000000e+00   +5.461582877972674e-01   -6.681940685221270e-01; +6.659366150789030e-01   +5.725855368027142e-01   +8.789842345552333e-01   -9.723223829075232e-01   +4.498616628565824e-01   +6.224843118513455e-01; +2.364921012350991e-01   -2.070402325600141e-01   +6.685860217707302e-01   -6.301612960875008e-01   +5.944801240640599e-01   +4.916282265666326e-01];
L5_L4_iAMPA_netcon = [-3.848523760295361e-01   -2.590715935221514e-02   +6.519156443418552e-01   +4.173651294102909e-02   +2.871227238968452e-01   +5.252705102295150e-01; -3.201539651400856e-01   +5.458661290654132e-01   -5.057331575714105e-01   +2.297514427385986e-02   -4.642858328481482e-01   +2.179235271925690e-01; +5.832058668127019e-01   -6.279918040209512e-01   -8.273470391976218e-01   -5.179401791814567e-01   -9.158510361618016e-02   +1.203701446489199e-01; +2.218220343085313e-01   -3.844705963312147e-01   +1.159034525314445e-01   +7.319238859815791e-01   -1.006753567493082e-01   +2.769625209766691e-01; -3.225583677422953e-01   +2.023141395147688e-01   +3.775999511174500e-01   +6.100378601918006e-01   +3.330936325665599e-01   +5.195562207024572e-01; +6.574811488344041e-01   +5.058244514624232e-01   -1.000000000000000e+00   -7.372035331521659e-01   +7.487147546498872e-01   +5.971062412394686e-01; -5.378621342689232e-01   -8.468123341842246e-01   -3.503194065121762e-01   +5.182519160091666e-01   -7.989402329693734e-01   +8.175812820234323e-01; +4.066014741586823e-02   +7.379689344468280e-01   -4.239352135546676e-01   -6.783908334754980e-01   -6.773251551571237e-01   -7.511755938147339e-01; +3.452517478325442e-02   -1.976095985028118e-01   +5.856801589811347e-01   -5.388019932669692e-01   -6.323751052095035e-01   +2.383973682421743e-01; -6.466567187078042e-01   -1.481911686117733e-01   -1.020059562705171e-02   +1.467939295371983e-01   -5.904886216541483e-01   -3.523337275516081e-01; +5.846732650243460e-02   -2.446478624160546e-01   -2.976487893260906e-01   +2.896331971276462e-01   -2.445930359769055e-02   -6.191221381718229e-01; -1.748184678815273e-01   -4.175259023457800e-01   +3.206928519831335e-01   -7.858230264353744e-01   +7.934451826479834e-01   -3.970918755203156e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
