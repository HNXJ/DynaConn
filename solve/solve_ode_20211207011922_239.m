function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+6.365012270374882e-01   +4.547456463919952e-01   +3.226069480207329e-01   -6.549167027315542e-02   +4.172804942715714e-01   +4.595727130187378e-01   -1.090690267648159e-01   +1.222768703550128e-01   -1.089772025619933e-01; +6.472421354338507e-01   +2.063645068176959e-01   -1.851193351723612e-02   -5.996834567781245e-02   +2.776815388563884e-01   +4.703097566379715e-01   +2.192392015946659e-01   +2.698000525382899e-01   +4.310468866874859e-01; +2.774262118227325e-02   +2.971864053523706e-01   +1.685951624984023e-01   -2.708993870297730e-03   -3.040690849995514e-02   +6.530789337058036e-01   +9.531466608194408e-02   +7.713721569875138e-01   +8.096163105568069e-02; +2.657256314306330e-01   +6.545267119718143e-01   +4.264416122784846e-01   +3.235360276119028e-01   +5.076570746624893e-01   +8.149755898770424e-01   -1.973826683768159e-01   +7.638348754497449e-01   +4.363001579858431e-01; +4.427579393871103e-01   +3.067499165051012e-01   +4.767687166277577e-01   +6.377641176333536e-01   +5.783862883726053e-01   +3.670387587879148e-01   +5.583307623873972e-01   +1.393720538767253e-01   +1.076277860965117e-01; +5.779382314041674e-01   +5.507190841462047e-01   +5.802833300825649e-01   +5.456038335214888e-02   +6.183992597395440e-01   +5.550084232728592e-01   +4.615312372318757e-02   +2.482126213051003e-01   +7.522510952379006e-01; +3.095678876948540e-01   +4.498537003772649e-01   +2.958704404618837e-02   +1.757875826948836e-01   -1.011143249679690e-01   +6.388466168621471e-02   +7.138619054233118e-01   +2.074340282608303e-01   +2.456801624031761e-01; -1.548103276007040e-02   -1.505373917255547e-02   -3.107987672192994e-02   -2.073976496720195e-02   +1.277420216018968e-01   +7.618222429000139e-01   +3.318701909643370e-01   -1.645659434664104e-03   +5.705902454153706e-01; +1.177488352169264e-01   +5.514260571629109e-01   +7.474966062248156e-01   +4.200803000294280e-01   +2.137925364759997e-01   +6.780715792239296e-01   +2.996450774796819e-01   +3.115417872797113e-01   -4.162613970219967e-02];
L1_L2_iAMPA_netcon = [+4.431917258960637e-01   +1.557484104648258e-01   -9.084863349192222e-02   +1.351864817228711e-01   -1.322861507791087e-01   +3.091148082845334e-01   +4.647578547199503e-01   +5.681249633204937e-01   +2.696954898314894e-01; +6.636644828342009e-01   +1.885960753911448e-01   +3.409828832526290e-01   +2.405580603587876e-01   +6.251754871076890e-01   +2.020524799638601e-03   +2.754599170329179e-01   +9.127219992876998e-02   +8.111563859184139e-01; +5.723265503886094e-01   +7.272064245503466e-01   +7.294363202863559e-01   +4.639604887598513e-01   +7.230050945688865e-01   -7.712175669493217e-02   +2.694301322402685e-01   +5.796159255617419e-01   +3.299033057331880e-01; +4.072265754570024e-01   +2.278076428084611e-01   +1.101466752771104e-01   +2.699626894231412e-01   +7.622188028940354e-01   +5.523021230833126e-01   +4.414407821257205e-02   +2.752696203450892e-01   -4.350628571164394e-02; +1.474335454808386e-01   -8.277506133529312e-02   +2.119464001120574e-01   +3.212354100585434e-01   +3.472665480093994e-01   +5.422146663547257e-01   +1.906196760104045e-01   +1.715256177691883e-01   +3.558567012729807e-01; -1.659701465467375e-02   +1.025828242336798e-01   -1.261028178949035e-01   +7.843805653786102e-01   +7.006962676182584e-01   -2.629163534028958e-02   +5.542735021572429e-01   +5.666833022642666e-01   +1.900334803989294e-01; +1.147628940171554e-01   +1.827110639209726e-01   +7.603391548213547e-01   +7.528887067372244e-01   +3.140245349359490e-01   +1.166890939021704e-01   +2.670576403774619e-02   +3.023886682354616e-01   +5.102015318662438e-01; +7.957644406993732e-01   +4.998363563829119e-01   +9.435493108202037e-02   +7.049509705493258e-01   +5.095898825098522e-01   +6.717122142294213e-01   +8.412903083781770e-01   +6.961476522105252e-01   +1.599685160608988e-01; -1.956655371071975e-02   -1.097388398841942e-02   +5.661472176122830e-01   +4.042591457552766e-02   +7.509339952434664e-01   -8.848309946948596e-02   +6.833318640239492e-01   +2.737522516656407e-01   +3.492994944303259e-01];
L2_L5_iAMPA_netcon = [+7.355339360589055e-01   +5.296929524305908e-01   +1.291048532869613e-01   +7.282058079452191e-01   +5.281492789437420e-01   +4.162430199605086e-01   +1.444266211035053e-01   +3.450335844354832e-01   +2.013172482770687e-01; +5.233525741928039e-01   +2.585658571671963e-01   -2.715792766372757e-02   +7.159437282819532e-01   -1.006685804715152e-01   -1.351689537943858e-02   +6.088459102336132e-01   +2.030607009716078e-01   +7.495874182584178e-01; +2.828900016244617e-01   +4.417190176078213e-01   +1.877569517799688e-01   +4.343303239529267e-01   +4.067717309435657e-01   +7.215556184588182e-01   +6.157583135766664e-01   -1.443568661979538e-01   +5.066479387548629e-01; +7.506173250516947e-01   +5.506475401812546e-01   +8.289170489920470e-01   +7.116690132331071e-01   +3.345756606571598e-01   +7.252903123110374e-01   -1.209132770755836e-01   +3.682931702023248e-01   -3.571564557570350e-03; +3.014298369171005e-01   +2.288689690924180e-01   +1.300164372346316e-02   -6.052681793411119e-03   -1.710073895539317e-01   -7.374225256625233e-02   +1.301486890921449e-01   +2.315106047200754e-01   +3.321614842059487e-01; +1.467410696140185e-01   -1.161282712164663e-02   +4.691472136252061e-01   +6.632821503318751e-01   +4.234359139183559e-01   +7.051857562490734e-01   +3.985503114903067e-01   +3.921759724479755e-01   +6.293284272397819e-01];
L5_L2_iGABA_netcon = [+3.313449769997961e-01   +5.367658044903946e-02   -1.382310365601882e-01   +5.925858064729761e-02   +2.353386847294041e-01   +3.830347810687758e-01; +5.596660198371021e-01   +7.486730278548298e-01   +1.973615963092125e-01   +2.477758881730460e-01   -6.584172359852100e-02   +5.405467326053298e-01; +2.313610981776571e-01   +8.060122018753313e-01   +2.126894892240952e-03   +5.697978597200940e-01   -7.535525755729333e-02   +5.697368732619035e-01; +7.607245123872063e-01   +7.812387571746452e-01   +8.922339255140141e-01   +1.761045849726946e-01   +5.696039489068563e-01   +5.849307092811569e-01; -4.285782833358127e-02   +1.947261510594777e-01   +8.791980552645723e-01   +6.059941419561949e-01   +1.073989194665298e-01   +7.971392136799267e-01; +5.023780878849798e-01   +3.804105201098649e-01   +4.389019782102906e-01   +1.415226720458839e-01   +6.778136173276432e-01   +6.413858802464890e-02; +1.895465633651831e-01   +5.765943857187733e-01   +8.764702733489463e-03   +7.248634711628426e-01   +7.540513132364993e-01   +7.035498302629575e-01; +1.363494971404986e-01   +7.012860533350121e-01   +7.946220574885409e-01   +1.929119558620429e-01   +3.382721016882416e-01   +4.480393586152378e-01; +3.554507610522079e-01   -1.509871645134727e-01   -7.435567146109154e-02   +5.587287577487631e-01   +3.825595278065965e-01   +7.723554716474896e-01];
L3_L2_iAMPA_netcon = [+2.326594032481953e-01   +5.525127832434885e-01   +7.615332544392470e-01   -7.197823561864471e-02   +2.060272557576910e-01   +7.055628250479833e-01; +9.435840266128975e-02   +3.848603491677485e-02   +2.664747805580282e-01   +3.696455630961313e-01   +2.518057485241468e-01   +5.981005364981046e-01; +3.994909911805581e-01   -9.430877242338233e-02   +1.026497115258000e-02   +2.522436219407329e-02   +5.748902215216851e-01   -6.149688656724801e-02; +1.425169293001291e-01   -5.767719927862552e-02   +1.695199724280766e-01   +2.075426444086314e-01   +6.732969683130714e-01   +3.752971580469369e-01; +3.208162769268528e-01   +4.960696691356981e-01   +1.125497892129702e-01   +1.459199846462981e-01   +5.096990425725135e-01   -1.129613440705690e-01; -2.054409697250145e-02   +7.065452485517811e-01   +2.018305789462443e-01   +2.388534638478639e-01   +1.860470147233755e-01   +2.382021475000690e-01; +4.672994986868504e-01   +4.515623080827330e-01   -8.207297214857059e-02   +6.724733629397562e-01   +3.916892529620311e-01   +7.407698670703561e-02; +5.859287242797862e-01   +1.040614642188259e-01   +2.222963959526008e-01   +4.973847822767259e-01   +6.072221498216885e-01   +6.035299941684893e-01; -4.753692005880859e-02   +1.407553458574251e-01   +4.447688351495130e-01   +4.954426195964030e-01   +7.470535068524705e-01   +9.355280927674658e-02];
L2_L3_iAMPA_netcon = [+3.146460099414660e-01   +5.984216570012220e-01   +6.882421396346916e-01   +6.498079639513558e-01   +6.338922849809563e-02   -1.130009391323334e-01   +1.581417971353458e-02   +7.274792763877785e-01   +6.799124955669915e-01; +7.842784978828210e-01   +2.006215952211987e-01   -1.373205307907588e-02   +3.068754684864544e-01   +7.722359033434307e-01   +5.009591986186248e-01   +5.222346896524481e-01   -2.149992504633180e-02   +9.637916259641249e-02; +4.881727173322959e-01   +3.460951004676256e-01   +4.793874457304959e-02   +2.870343097330372e-01   +7.610482950647257e-03   -6.821432717984235e-02   +2.963097085131506e-01   +5.919062301658295e-01   +5.024473201976003e-01; +4.280558275419056e-01   +2.263858106754031e-01   +3.137191029753140e-01   +5.282019141550178e-01   +3.641165673591031e-01   +7.996232440097376e-01   +1.023889850187455e-01   +7.431440587118160e-01   +7.434823989276649e-01; +6.091727526478150e-01   -8.839166499377876e-02   +7.846964620152387e-02   +6.987133438342681e-01   +5.256269886278272e-01   +5.919990883996531e-01   +2.623142072235728e-01   +4.662749312077263e-01   +2.246046410687311e-02; +7.120198787306850e-01   +7.564861701630031e-01   +3.926503720607343e-01   +4.079798609760959e-01   +5.659465548392342e-01   -2.646955724230883e-03   +1.448819853611313e-02   +3.720683688671737e-01   +3.561981941790429e-01];
L1_L4_iGABA_netcon = [+3.603377159595453e-03   +8.213984697661210e-01   +1.953537059432433e-01   +4.317179412966548e-01   +5.150638576537465e-01   +2.141307368834813e-01   +1.110463900441511e-01   +7.341773829517626e-01   +4.916811524403271e-01; +6.883856810819701e-01   -7.941413779100791e-02   +6.573697864260380e-01   +4.238459155659755e-01   +7.137629871022499e-01   +7.670472289143740e-01   +5.251504468733714e-01   +6.641653125243613e-01   +4.067237580992198e-01; +2.951288660577357e-01   +2.338124820813430e-01   +1.164904155662752e-01   +1.016499924365496e-01   +3.459612473145084e-01   +4.147540387709688e-01   +1.007517877082592e-01   +5.791445730166301e-01   +6.721547425878134e-01; +6.155786015380269e-01   -1.152104862189176e-01   +2.202173674115015e-01   +6.604190858399160e-01   +2.066726241670858e-02   +5.766523540222874e-01   +1.219789865548147e-01   +3.646964947762454e-02   +8.241676199798532e-01; +4.539036921365167e-01   +4.394445848947369e-01   +1.341143371984158e-01   +2.365324400272426e-01   +4.905955872129206e-01   +3.485140087652138e-01   +7.079221668222169e-03   +3.975381033959230e-01   -1.771614492800427e-02; +1.399617460951021e-01   +3.587807662356021e-01   +4.889137237597777e-01   +3.638221786901218e-01   +1.084684187171011e-01   +5.230588342981999e-01   +2.851314670881357e-01   +3.326380920818971e-01   +6.067591944277169e-01; +4.887738971553869e-01   +4.799860894438998e-01   +2.605919161243506e-01   +7.266827451102712e-01   +7.134549314720063e-01   +3.587497393222719e-01   +8.009488275194026e-01   +4.906671226230499e-01   +4.821956732310523e-01; -7.208686131626306e-02   +4.764835741939015e-01   +8.228648186513994e-01   +2.149443975340038e-01   +3.826949402765698e-01   +2.816985161026730e-01   +6.876764219166048e-01   +5.855553002259101e-02   -7.835241749529816e-02; +2.499597543282237e-01   +5.185035297720075e-02   +7.146588472851974e-01   +6.131376658030729e-01   +5.716554802315341e-01   +4.169298671345997e-01   +1.777608518155063e-02   +3.399335829525566e-01   +7.018629147777701e-01; -1.524576463369469e-01   +7.681958473309186e-01   -6.287192118795443e-03   +5.254030764094307e-01   +4.645279791965673e-01   -1.129001699500491e-01   +9.780406042166151e-03   +7.474030635336970e-03   +7.313266362024565e-01; -7.619947513913954e-02   +6.859272252724222e-01   +6.466738932123340e-01   +7.615084553100270e-01   +4.420787770219337e-01   -8.885019309287268e-02   +4.577406040502986e-01   -5.533950034975757e-02   +9.967184771327570e-02; +3.756463585276195e-01   +6.037003944999074e-01   +5.308990212370036e-01   +1.755317656193348e-01   +6.842413914054141e-01   +5.245709273867519e-01   +4.217919844155122e-01   +4.687689998694666e-02   +5.730080285008101e-01];
L4_L1_iGABA_netcon = [+7.993436427567763e-01   +5.281909545711299e-01   +2.658223277956918e-01   +5.724657217717435e-01   +7.173784845194756e-01   +2.830059745355581e-01   +2.293024245311443e-01   +6.197127633061353e-02   +4.393853982036272e-02   +5.390214196549422e-01   +2.274055381640124e-01   +6.397721781227178e-01; +5.623665065523186e-01   -1.963936493117157e-01   +7.427844792085415e-01   +6.307670548337488e-01   +2.059639982640152e-02   +3.323691280060358e-01   +2.464789079610184e-01   -1.092361174092759e-01   +6.844460496405350e-01   +2.615110374048812e-01   +4.084063999571180e-02   +3.445615459503376e-01; +4.137471945599927e-01   -1.931487162629702e-01   +7.146240838543021e-01   +6.653933469615890e-01   +2.607592197283979e-01   +8.908203212606230e-02   +1.698757592287224e-01   +3.277525529522542e-02   +3.552944188267420e-01   +4.938033440333615e-01   +4.576288529376331e-01   +3.244934677081333e-01; +2.913803593564047e-01   +1.245784138995198e-01   +5.988256590271670e-01   +7.195699094563134e-01   +3.120588303287869e-01   +4.322024625299906e-01   +3.831642902196053e-01   +3.275369787734947e-01   +6.938085615473689e-01   +7.774185632416594e-01   +6.292801533110708e-01   +2.289984586792013e-01; +3.347112772728152e-02   +3.792698818400022e-01   +7.109193111356776e-01   +6.700143549754101e-01   +5.188597024263328e-02   +1.588330421435541e-01   +6.237678666399207e-01   +4.952223138904728e-01   -7.898769969685218e-02   +7.164413495076274e-02   +6.251409996623438e-01   -4.050786424643436e-02; -1.606463263617299e-01   +3.748223760842393e-01   +2.906154299614957e-01   +5.956077522090817e-01   +1.755040861019368e-01   +5.483575749099898e-01   +1.740187439263397e-01   +6.886937595363722e-01   +5.707095567004531e-01   +2.976488522890218e-01   -9.775308752802908e-02   -5.499264360241665e-02; +7.200020184089906e-01   +2.000634077074858e-01   +5.255617387932784e-01   +6.780625800908167e-01   +2.713367903081095e-01   +5.590547062978491e-01   +1.054300577769237e-01   -5.908897280314611e-02   +4.562833160334866e-01   +5.815341941178630e-01   +2.014683763325152e-01   +3.457821392422663e-01; +1.336366709182813e-01   +7.664018302525527e-01   +6.831380153465419e-02   +6.262874456794861e-01   +2.693226176397992e-01   -2.401838273858431e-02   +2.013520687709533e-01   +5.820418325385424e-01   +4.695519491257250e-01   +6.414813845684405e-01   -6.504425986638884e-02   +5.046981879803579e-01; +5.890519702463567e-02   +9.612510031127561e-02   +3.818079730558440e-01   -1.059406357634714e-01   +1.116942368453875e-01   +6.639547858606853e-01   +6.468130716992704e-01   -6.401625901454749e-02   +5.544778663311125e-01   +2.981448936282209e-01   +3.795048560677202e-01   +7.267979186576543e-02];
L1_L3_iAMPA_netcon = [+1.011923489095167e-01   +5.465953479795831e-01   +4.338485545770143e-01   -5.064680288762988e-03   +5.966260105063702e-02   +1.250928233749756e-01   +4.898992753516066e-01   +2.918574244111413e-02   +7.302610432277146e-01; +2.213665991750605e-01   +8.020188495238741e-01   +6.352026004809861e-01   +6.428368090430486e-01   +6.001389944932258e-01   +4.866176182268135e-01   +6.988133246205186e-01   +4.161753518028166e-03   +3.164436622141369e-01; +7.653806205097584e-01   +6.536134296173625e-01   +6.099691101989906e-01   +6.168606459501847e-01   +4.959898990390407e-01   +1.251474145317473e-01   +5.906121106144313e-01   +5.956164264429173e-03   +5.595264931631975e-01; +2.632183930429821e-01   -2.519309547072444e-02   +4.048530014055233e-01   +3.426775950588088e-02   +1.368736154934791e-01   +5.263423627748183e-01   +1.276222277786227e-01   -8.407425585365930e-02   +3.408511039003707e-01; +4.086932635457596e-01   +4.265712329644745e-01   +6.174855856791094e-01   +1.974939846584667e-01   +2.769975891134451e-01   +7.924166322929870e-01   -8.743285369512144e-02   +6.001307296471520e-01   +6.641021203156172e-02; -8.503623271725599e-02   +2.501144823236567e-01   +3.839663907446197e-01   +5.378313867666228e-01   -1.462617451920880e-01   +2.604534950137434e-01   +2.894399226469760e-01   +6.385659904521538e-01   -1.337832961171692e-01];
L3_L1_iGABA_netcon = [+7.970690588088715e-01   +3.283464361630293e-01   +3.167883786596412e-01   +3.022969302840704e-03   +8.157242358555061e-01   -6.246600310719529e-02; +2.877796503771705e-01   +8.466072134245786e-01   +4.587831686781332e-02   +7.501391244273309e-02   +9.690568468722641e-02   -3.109495942636809e-02; +6.197288881406325e-01   +6.048289822613868e-01   +7.372340846671122e-01   +4.134247023696229e-01   +1.783288218345018e-01   +4.525257833900508e-01; +3.396754401553316e-01   +4.542955071775832e-01   +1.237989086379502e-01   -5.858421567722356e-02   +3.509895809352309e-01   +5.147095763679665e-03; +2.802726925133588e-01   +4.399136709483276e-01   +3.050971683799186e-02   +5.286276103451538e-01   +6.667318473596369e-01   +9.935452815719212e-02; +6.475546115161454e-01   +2.491800070202127e-01   +6.765819730216387e-01   +7.511917261816352e-01   +8.163574520171740e-01   +6.076108108051940e-01; +2.403019384704609e-01   +5.539244461352372e-01   +4.077039515691584e-01   +3.733248569019226e-02   +7.152863781598225e-01   +4.497600931442559e-01; +3.025437629171712e-01   +1.088987335601428e-01   +4.486216552182004e-02   +2.443926834024170e-01   +2.206551571543448e-02   +7.363004587457477e-01; +2.640800231056853e-01   -6.805199111805466e-03   +4.872876776229357e-02   +3.502599968005080e-01   -1.756357686750049e-01   +5.336703894992716e-01];
L5_Input1_iAMPA_netcon = [+6.655172690770705e-01   +4.999321170638760e-01   +7.029993571701498e-02   +8.372180349212176e-01   +2.730488636908370e-01   -1.604335718601342e-01];
L6_Input2_iAMPA_netcon = [+3.791213139811678e-01   -2.033539373156301e-02   +1.645222305066682e-01];
L5_L6_iAMPA_netcon = [+1.799890846232217e-01   +1.725669732748730e-02   +4.734397858719718e-01   +4.709694211853057e-01   -6.347671172148198e-02   +5.181092690978165e-01; +4.649499693252896e-01   +7.314453606050109e-01   +2.876358606088990e-01   +4.578530959366366e-01   -7.853969639687444e-02   +3.147739589437216e-01; -7.510704965244634e-02   +3.340476064967602e-01   +8.410632301645116e-01   +5.038596022521398e-01   +1.879118992024278e-01   +4.694855046239840e-01];
L4_L5_iAMPA_netcon = [-2.592148786794202e-02   +4.355281187249067e-02   -4.970081305488413e-02   +3.487598230232660e-01   +1.996523546815429e-01   -1.429885236503206e-01   +7.853409251403369e-01   +3.344331420537272e-01   +5.434403511820543e-02   +4.050024509301626e-01   -1.035841286110960e-01   +6.025427816875578e-02; +7.928529428289501e-01   +5.569516215762130e-01   +8.669089011053871e-01   +1.515178112743186e-01   +2.721048546935895e-01   +2.606229620620654e-02   +3.923917884931567e-01   +6.995603174546974e-01   +1.082000196790850e-01   +5.415720963103735e-01   -4.841064171135039e-02   +3.077807607650488e-01; +7.255803579959327e-01   +3.823224117290161e-01   +4.999935713978219e-01   +7.037555625485807e-01   +4.121937552122326e-01   +3.074199170725874e-01   +4.057939230044053e-01   +2.345643296227207e-01   +1.887471006282446e-02   +2.192555859776096e-01   +3.867833453124039e-01   +6.002344718176718e-01; +8.640524831285283e-01   +2.923058851335984e-01   +3.009181460442508e-01   +4.472936262456099e-01   +2.148382459365380e-01   +3.826956633799006e-03   +6.771126595438014e-01   +6.910707695146217e-01   +3.228200580145705e-01   +2.950747091529773e-01   +2.469157368869665e-02   +1.861392808717025e-01; +3.968333966246573e-01   +6.561297451851659e-01   +3.579607728946839e-01   +4.818964312082138e-01   +4.195284487817841e-01   +6.978970024470728e-01   +2.436392226611916e-01   +3.745749498479166e-01   -4.926759996287957e-02   +2.379432619313100e-01   +8.440936132494722e-01   +8.936232787909535e-01; +4.183400345944051e-02   -7.529943390352342e-02   +9.581427786070937e-02   +3.641632281657973e-01   +1.077369843236964e-02   +1.560724940977359e-01   +7.716804659743888e-01   +6.459794863135251e-01   +6.657387774576238e-01   -5.761923117726717e-02   -1.396745661061320e-01   +5.256840937845692e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
