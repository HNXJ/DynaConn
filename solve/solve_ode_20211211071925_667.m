function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.232392113691526e-01   -5.180496717366762e-02   -3.752218469271990e-01   -1.690276525289584e-01   +1.710910890268594e-01   +1.306192368478885e-01   +6.343895274650665e-02   -1.938221934636268e-01   +2.370497075182698e-01; -1.664193087247592e-01   +4.895620291600993e-01   +4.677373538381924e-02   +1.856865994610279e-01   +9.551126993109960e-02   -4.789404326512398e-01   +6.779775368436660e-01   -2.225004943915140e-01   +3.434964166608170e-02; +2.210437815617119e-01   +4.219827815961047e-01   +3.245926949895135e-01   +2.227357638102870e-01   -2.901170341138917e-01   +3.757308296444485e-01   +2.184748049018614e-01   -6.164391012395989e-01   +2.713351319972730e-01; +3.115795956682968e-01   -3.592645770872107e-01   +8.971910931026586e-02   -3.484954037948896e-01   -3.725630371708392e-01   -5.862179208876367e-01   +3.227749309194528e-02   -1.447300043372085e-01   -3.817826159103390e-01; +6.964934188446278e-02   +4.180637902714088e-01   +7.119990477310300e-01   -4.548043279330477e-01   -3.514857087655148e-01   +8.597448051046042e-02   -4.542563409246393e-01   -5.763780787657455e-01   -1.665408958691132e-01; +2.572355179308397e-02   +1.605355507364948e-01   -2.763371415935783e-01   +5.217885328876859e-01   +1.364716397810756e-01   +1.998235958044117e-01   +6.384759013794697e-02   +2.470884787669395e-02   +7.323953705146649e-01; +3.224840640195472e-01   -1.419072554746547e-01   -3.981945291685240e-01   +1.449168440562663e-01   +3.971200595017357e-01   +2.561329571073648e-01   +5.941966502897167e-02   +5.303239563880121e-01   +3.286905438095653e-01; -1.282486898865024e-01   +9.845221337043786e-01   -3.070499596108151e-01   -1.845649658737552e-01   -2.557042018484096e-01   -7.790547592694173e-01   +1.850845511385036e-01   +2.748870499525939e-01   +5.459060472927297e-02; +7.883728739402671e-03   +3.513927181177011e-01   -2.288697647496522e-01   +6.122886319307885e-02   +4.175765278397547e-01   +6.435463928571239e-02   +8.438096894423375e-02   +2.634800383070241e-01   -4.703000015261882e-01];
L1_L2_iAMPA_netcon = [+1.103897474607392e-01   +6.585844386471765e-02   +3.864719625045477e-01   +4.136745579886271e-01   +3.952042043807770e-01   +2.270483891132029e-01   -3.544405744416735e-01   -1.378278750978303e-01   +7.490478553656177e-01; -1.938737020979754e-01   +8.108713355505726e-02   -6.311344075357041e-02   +2.382565872200964e-01   -3.811519694007476e-01   +3.748239119734779e-01   +3.488984179182600e-01   +1.393785345111015e-01   +2.709190734943552e-01; -3.062822314242326e-01   -7.771105525696913e-01   -3.113866314225799e-01   -5.229483537821837e-02   +2.138518835883962e-02   +4.808217898767498e-01   +6.806773904822545e-01   +6.205450713078876e-02   +4.223844130781319e-01; +1.184356841488183e-01   +9.395183463506447e-01   +3.578962498323553e-01   -2.626268322353211e-01   -2.281080237023386e-01   +2.383795760847587e-01   +3.924652099984668e-01   +4.882051729175775e-01   +6.642841595177573e-02; +4.538150344219447e-01   +8.854898801824684e-02   +6.543762003558884e-03   -1.383457597129286e-01   -7.187473575718423e-02   +2.456036168497639e-01   -2.039688094080230e-01   +1.271416937307713e-01   -4.380905818683010e-01; -7.733505187213741e-02   -2.214202953761791e-01   -2.367594290235093e-01   +1.111482359256511e-01   +8.959411239477125e-02   -3.125749221361419e-01   +5.125537375823530e-01   -1.537098275667944e-01   +2.612293194550239e-01; +8.258404144424547e-01   +5.014853198664413e-01   +5.751708299872877e-01   +3.981541442152134e-01   +3.365362198026073e-02   -7.778251691674758e-02   -6.604977472566922e-02   -3.348854928453357e-02   +6.219980861620076e-01; +6.950093286507176e-01   +2.949719482116206e-01   -7.088668280762822e-03   +4.168847848584379e-01   +3.611413852487316e-01   +8.037666999739723e-01   +2.342308525231393e-01   +5.515835503147287e-02   +3.215232068268929e-01; -1.373043261810591e-01   -5.788911864290061e-02   -4.553002088948260e-02   +1.791507156240751e-01   +2.053521095185721e-01   +8.905455277860372e-02   +5.606379718735691e-01   +3.880610404916551e-01   -4.003567037061583e-01];
L2_L5_iAMPA_netcon = [+5.066946277402301e-01   +1.397978088680379e-01   -1.940424608850860e-02   +1.807565638543909e-02   +2.289562118339301e-01   +2.865756190534462e-01   -5.444762106630811e-01   -6.008779523097004e-01   +1.540633879163513e-01; -1.252485173864788e-01   -1.745889194811821e-01   -2.226615205666851e-01   +3.447463466927223e-01   -2.173277909172442e-01   +3.377631044540703e-01   +1.700086558581611e-01   +1.895500174531607e-01   +7.074372372257803e-02; +2.648863852888517e-01   +1.874672000707587e-01   +1.429452871040439e-01   +5.261377881487503e-01   -1.136594440543432e-01   +2.811558486648432e-01   -4.199944326172917e-01   -2.662157321974743e-01   +3.193329265007304e-01; +4.719883540438158e-02   +1.935738343612745e-01   +1.014559740536378e-01   +7.684704392811537e-02   +8.454823197190552e-02   +1.895493956949183e-01   +1.777443186073944e-01   +1.245554505628033e-01   -3.320826359780753e-01; -1.981719181798930e-01   +1.920594379263346e-01   +1.073015514828025e-01   -2.726454385827688e-01   -3.761488213755919e-01   +1.137317422112194e-02   +1.939558408413325e-02   +4.722808956325800e-01   +7.162003107435601e-01; +2.109772713197983e-01   -2.522976036459603e-01   +2.608440593094687e-01   +7.762698774574600e-02   -2.878333394519004e-01   +3.737440336356670e-01   +2.893238700329469e-01   -2.426423272653492e-01   +3.251511317947930e-01];
L5_L2_iGABA_netcon = [-2.150416842326740e-01   -2.134956864745982e-01   +4.840141601766091e-01   +4.288883111913099e-01   +2.445249236449557e-01   +5.726856216417471e-01; +3.725803144904314e-01   +7.132215877191062e-02   -6.304099617703363e-02   -1.583220748251080e-02   -3.536552787669206e-02   -2.519076476954373e-01; -1.437103736912875e-01   -1.302801390648411e-01   +5.713758301747276e-01   +1.812900482102861e-01   +3.218380552222228e-02   -5.364012691736537e-01; -2.766918968667086e-01   +8.521187247620204e-02   -2.913738810130080e-01   -3.490318951830939e-01   -2.039984324211777e-01   -2.021238847142952e-02; +1.353828945290428e-01   -1.118644977734834e-01   +1.792091887591054e-01   -3.468561043031658e-01   -8.044256148000160e-02   +4.613846485669494e-01; -1.717581638409773e-01   -4.609991795207413e-01   -6.328844060234939e-02   -2.943705160882047e-01   +2.464110710662265e-01   +4.555544899140780e-01; -3.059297459717447e-01   -7.958472532488178e-02   +4.980161572882587e-01   +8.541140112022485e-01   -7.738128798930757e-01   +1.337911022461768e-01; +3.197149919810569e-01   +7.217069638582045e-01   +3.448474346766246e-01   -3.451433345826762e-01   -3.603823077512397e-01   +3.941983345218281e-01; +2.239010952798631e-01   +9.944178784801724e-02   -6.592063314452746e-01   +7.597667268289682e-02   +3.941387574456175e-01   +2.673795018408935e-01];
L3_L2_iAMPA_netcon = [+1.984153767677214e-01   +2.651248898454720e-02   -2.031111066263526e-01   +1.114603749860524e-01   +1.887886757604796e-01   -1.362886787822480e-01; +1.418385717033279e-01   +4.445177255483035e-01   +6.537042266225854e-01   +2.046212009640416e-01   +1.586554676142063e-01   +1.246194282552631e-01; +4.788737337061330e-01   +6.889643461103687e-01   +3.423634444968263e-01   +2.827563960946107e-01   +3.657995726442784e-01   +4.410574437122056e-01; +2.968896435702578e-02   -1.566902894690793e-01   -5.420016249094091e-01   +3.861368022776216e-01   +5.200491248622788e-01   -2.304733946759683e-01; +3.419908975963799e-01   -2.496935432411633e-02   +2.966260221211778e-01   -1.583867796338007e-01   +1.957731674580142e-01   +3.620236721584887e-01; +4.008533621021635e-01   +1.841338882543245e-01   +4.725951192549791e-01   +6.967929819909278e-02   +6.859987712435867e-02   +2.139552589004197e-01; -3.001290131075128e-01   -1.866381703848274e-02   +2.273065092786820e-01   +1.224110033440552e-01   +1.095456181757347e-01   -2.612190633618299e-01; -1.637331240430263e-01   +7.090622021449711e-01   -2.024524903624940e-02   +3.773138407400810e-01   -2.912278524053645e-01   +2.447190760428125e-02; +1.068097881010573e-01   -4.373616431530591e-02   +3.098583852192172e-01   -4.040333807255067e-01   -4.330682409395870e-01   +1.420152747649667e-01];
L2_L3_iGABA_netcon = [+7.878068791944348e-02   +3.172232803992752e-02   -1.696870213472624e-01   -1.315636663525160e-02   +2.930613131516608e-01   +5.629981186283983e-01   +6.695187445835762e-03   +6.055378749928356e-01   -4.683806077923387e-01; -5.218620163209217e-02   -5.306952889980390e-02   +2.249843368111436e-01   +5.982067631873929e-01   -8.643024376470282e-02   -7.035809645612606e-01   -6.130937531037114e-02   -1.149703410253560e-01   -4.580577545119913e-02; +7.697599053949394e-02   +3.232949428742758e-02   -2.306807537229404e-01   +2.049481284166910e-01   -5.414724373079949e-02   +2.605741331848169e-01   +2.808046914511730e-01   +4.949072323870319e-01   +3.471359609804541e-01; +1.539052079151605e-01   +8.253903683693555e-01   -9.643020192254331e-02   -1.457003933501955e-02   +4.935201492212437e-01   +4.125028335798418e-01   +2.515071712224413e-01   +3.384834732504834e-01   +2.275057300011940e-01; +3.173342709055826e-01   +5.873409303426548e-01   +1.301565172811214e-02   -4.789718646829950e-01   -1.126847079679973e-01   +3.611161871853592e-01   +1.266536662445810e-01   -5.635084778940547e-02   +1.229095004508107e-02; -1.203944726803495e-01   -3.070097154743877e-01   +4.814863866698316e-01   +2.538203962619987e-01   -2.444615435536711e-01   +1.897125886883274e-01   -3.328256418955575e-01   +2.831753466265200e-01   +3.517092413628435e-01];
L1_L4_iGABA_netcon = [+2.691325928021011e-01   +1.391674402466219e-01   -1.378609738355223e-01   +3.930641339407644e-01   -4.313402293642474e-01   -3.149742405326949e-01   +2.515578407908322e-01   +3.479721813427631e-01   +2.412469756329838e-02; -1.676499369300172e-01   +3.224382488613020e-01   +3.209709986220595e-01   +3.854550468092668e-01   +2.405136387467660e-01   +1.030929789788926e-01   +5.970440856637407e-02   +7.462518632846424e-02   +2.206504768888131e-01; -2.612932157644854e-01   -1.128479759917103e-01   +6.763778539942041e-02   +2.494552801441015e-01   +5.470729956641504e-02   -1.848507005399985e-02   -4.872632665802577e-01   +2.693033548344897e-01   +7.287178476483481e-01; +2.154500820861326e-01   +2.352594802796043e-02   +1.956757084466886e-01   +5.020522525411388e-01   -1.150058224935640e-01   +1.344773156769938e-03   +1.222332086119976e-01   +3.316038176466485e-01   -2.107177866930249e-01; -2.845372844945033e-01   -6.910987121357349e-01   +3.911260148173618e-01   +1.059001591754657e-01   +7.766359146189863e-01   -4.281810681370065e-01   +4.050767217939001e-01   +3.525700586540068e-02   +1.736402018089145e-02; -1.972016109179429e-01   +1.225300733179655e-01   +5.088532202601213e-01   -3.732504818237131e-01   +3.708400357544855e-02   +4.201874130560930e-01   +1.035528697512570e-01   -3.115871258374647e-01   -3.038654810622074e-02; +1.310078001136382e-01   -4.865606733333278e-01   +1.239754780071089e-01   +1.567762591104581e-01   +1.736729586517407e-01   +5.054456613232225e-02   -1.914567918513575e-01   +3.654247874662723e-01   -5.982113669852949e-01; +3.064863220720434e-02   -1.552086116190497e-01   +2.836975546911248e-01   -5.807390383001362e-01   -2.386307685980744e-01   -2.112139565456169e-01   +6.654898324869224e-02   +4.253095793961316e-01   +1.016481738311566e-02; -4.665686597751101e-01   +3.916577187029836e-01   +4.483771412706962e-01   +5.097345112388065e-01   -1.687882241254883e-01   +8.576379886175213e-01   +3.202733003634687e-01   -2.435062830723048e-01   +4.976860963254353e-01; -2.093208574330353e-02   +4.357457823308914e-01   +3.925251934500353e-01   -1.170523474290813e-02   -8.507602986631976e-01   -4.754789340242248e-01   +5.088860086268038e-01   -2.061141236956671e-02   +2.809515415357736e-01; +4.668499501417041e-01   +2.805064411350701e-01   +8.507078086382427e-02   +5.746404050201278e-01   +9.829581654248880e-02   +8.331334740433475e-01   +1.997329385743945e-01   -5.787563820410833e-01   -7.287669490599555e-02; +1.794648607762465e-01   +3.591650686646675e-01   +4.481142616159289e-01   +1.206863739051078e-02   -1.440228191720122e-01   -1.846127917912624e-01   -1.031793054177692e-01   +3.578717034491350e-01   -3.467872728147902e-01];
L4_L1_iGABA_netcon = [+4.000173811631692e-01   +2.995182229914267e-01   +1.113322594959506e-01   +3.513080909164907e-01   +7.944245859557805e-02   -7.642500264215828e-01   +4.410052137758608e-02   -1.214695933456140e-01   -2.321096920668443e-02   -1.204673968234738e-01   -9.195890642096750e-02   +2.977121682748065e-01; -8.410499728889503e-02   +4.265363948659828e-02   -9.837976984806210e-02   +1.328489138659834e-01   +4.294666198587451e-01   +7.003258012480977e-01   +4.341234957211639e-01   +1.592070611020754e-01   -5.295011563733230e-01   -4.488805494746716e-01   +2.659320371300372e-01   -1.339342184118478e-01; +2.093775537515224e-02   +1.207466351099804e-01   +5.567278476237031e-03   +9.350329451010819e-02   -2.243179538730702e-01   +2.942271594316302e-01   +7.828725331126218e-01   +1.199082721919262e-01   -4.269294883300143e-01   +2.853766049314121e-02   +2.557864315260744e-01   +1.319798976443102e-01; -3.176143302295500e-02   +1.214253393321645e-01   +2.801799066915465e-01   +3.232302570567903e-01   +9.993210450559716e-01   +5.822585826775770e-02   +1.078867487980026e-01   +1.132829731036655e-01   +4.178598743165868e-01   +1.694200243568572e-02   -1.737531943682488e-01   +2.398772223360701e-01; +4.915964552882860e-01   -2.814437601128853e-01   -7.224282647852959e-01   +7.426465407491421e-02   +1.169674802225972e-01   -3.307311665206858e-01   -5.272086378470595e-02   +4.074678249195498e-01   +7.258046750045500e-01   -7.280807552166592e-01   +4.966741083533374e-02   +2.945456880926033e-01; +1.348547991195390e-01   +4.265726253506613e-01   -3.771356333807992e-02   -4.807114097461994e-01   +1.409425277816692e-01   +4.300784679154128e-01   +1.403853370692068e-01   -2.837593698055987e-01   +1.917723079538515e-01   -1.953737555629106e-01   -8.210886570469583e-02   +8.545593964019575e-02; +6.882134395341052e-01   +7.522311228411627e-03   +3.044591786026334e-01   -1.053449855740111e-01   -1.661682024503209e-01   -8.112039502079826e-02   +5.147681412475057e-01   +5.724513495813872e-01   +5.169871379164697e-01   +1.742832750096990e-01   +6.742994129822144e-01   -5.673132428937082e-01; +1.224908668906760e-01   -2.191787424397126e-01   +6.039858250592345e-01   -2.336520763697025e-01   +6.204132554287448e-01   -5.063712978859330e-01   -1.591911913050352e-01   +5.846765752925952e-01   +1.465774491129102e-02   -4.581405906786102e-01   -4.646529596313282e-01   +3.298062614153050e-01; +2.480644770188149e-01   -1.496529528526467e-01   -4.388975453578247e-01   -3.074542648071862e-02   +3.634094043771430e-01   +1.027862780883035e-02   +2.163067982529530e-01   -1.989790598379098e-01   -5.874710216301653e-01   +5.269951783258264e-01   +4.015209767588201e-01   +5.964236323304891e-01];
L1_L3_iAMPA_netcon = [-4.355160925723350e-01   -4.086547292805662e-01   +4.405930173984893e-01   -2.484768053270243e-01   +1.000000000000000e+00   -8.394211092471598e-02   -1.670627793509934e-01   +1.309097029919289e-01   -1.077296029223018e-01; +2.606112344545951e-01   +7.028340519022186e-01   +1.759965200062152e-01   +1.399280537879174e-01   -4.525606695104373e-02   -1.317120351408165e-01   +3.301543779551368e-03   -3.725010079392514e-02   -1.039853176523199e-01; -3.120895468994565e-02   +2.604711960956795e-01   +1.479478054513072e-02   +1.729643572049727e-01   +4.389155308158967e-01   -2.946645843248357e-01   -3.924355947405165e-02   -6.913685831286764e-01   +3.334671163684352e-01; +6.969638680202468e-01   +4.878971352632275e-02   -3.037989219548419e-01   +5.250125924549496e-01   -1.242428443719763e-01   +4.868783752476888e-01   +4.890256845027763e-01   -1.344567581061095e-01   +3.922696475080761e-02; -1.240199449015472e-01   -6.566373191289972e-02   +5.040517767030998e-01   -1.660146327519554e-02   +1.786759821186331e-01   -2.221875820573913e-01   +5.465183791085487e-02   +7.029401860200445e-01   -1.240659472662776e-01; +5.577267417413806e-01   +1.501165553963660e-01   +1.120209563106372e-01   -2.209712657963367e-01   -4.083960369977219e-01   -3.215738927328541e-01   -6.987066186131569e-02   -2.393549020956505e-01   +5.013179982566905e-01];
L3_L1_iGABA_netcon = [+4.506018793237832e-01   -3.446163890249736e-01   -1.003148419314707e-01   -1.454482094525568e-01   +1.213867211853585e-01   +1.078600860894240e-01; +4.344873735313032e-01   -2.822115994991605e-01   -1.024056908302222e-01   +6.856530494410568e-02   +1.637102028732422e-01   +1.120244267197294e-01; -5.241669197219884e-02   +2.054443800618206e-01   +3.137008288001788e-02   -3.983638766953812e-01   -4.796377456512417e-01   -3.712759078450311e-02; -1.534092737202252e-01   -5.147578223639119e-01   +6.557603403154164e-01   +2.940847982372475e-01   +1.071460894948345e-01   +6.800088211790658e-01; +8.376764252788356e-01   -3.161105504993113e-02   +1.453109963176054e-01   -1.098889850106215e-01   -9.575970912110598e-03   -2.313254750245519e-01; +1.564088308104986e-01   +4.972044030857022e-01   -1.194925824846498e-01   -7.290559313966956e-01   -1.889614562607687e-01   +1.117493695941514e-01; +5.127148594538394e-02   -3.696756537538841e-01   +1.418541758003374e-01   -9.152619572099915e-02   +1.459484437578391e-01   +3.573240732401480e-01; +1.005930195200771e-01   -2.904457659700065e-01   +1.552073642025241e-01   -1.103083470535327e-01   +2.610713894723832e-01   +2.689203574033805e-02; -1.893721949423627e-01   +3.881372114455217e-01   +2.125706689161021e-01   +3.737694101479128e-01   +6.526716959563489e-01   +6.378670695270449e-01];
L5_Input1_iAMPA_netcon = [+3.879019814997338e-03   -6.451445287317265e-02   -3.845340486960621e-01   -7.657154470683672e-02   -2.506339366086136e-02   -8.473612600626469e-02];
L6_Input2_iAMPA_netcon = [-2.287011321176101e-01   +2.422350375301923e-01   -3.243478044861230e-02   +4.521528569175945e-01   +1.404791973028019e-01   -1.949537372829810e-01];
L5_L6_iAMPA_netcon = [-1.064499014757894e-01   +3.151068395098044e-02   -2.518470010602846e-01   +2.174728685969817e-01   +2.188107946231829e-01   -4.465880878251240e-01; +2.493823426125810e-01   +4.032170644051116e-01   -5.723485054926554e-02   -7.151426438768007e-01   -3.181735033785206e-01   +5.850188708857189e-01; +6.644793163248263e-01   -4.483387830249371e-01   -2.867780121926493e-01   -4.141841555901572e-01   +3.991406405942934e-01   -2.007445894174202e-01; +2.199420846724822e-01   +3.816999952750067e-01   -2.008500769846979e-01   -4.401710573835772e-01   +8.854395354723266e-03   -7.386388414964495e-02; -7.237792241310226e-02   +4.342899828023422e-02   -2.920387550129891e-01   +6.568515599966518e-02   -3.136561743900345e-01   +7.952956242887305e-02; -1.930832088009168e-01   +6.679148233453451e-01   +4.105144782865222e-01   +5.213396213895534e-01   -4.910669563996357e-01   +2.767883638348966e-01];
L4_L5_iAMPA_netcon = [-2.716857747728545e-01   +1.597079780464430e-01   +7.201990861401881e-01   -7.135531209976108e-01   +1.198097949036573e-02   -7.405213900805574e-02   +2.834656489939403e-01   -2.265881235786461e-01   +3.394165945650189e-01   -3.424015533052135e-01   +3.614491524212302e-01   -1.428434287457005e-01; +1.650006534184253e-01   +4.355564377991435e-01   +4.684697258022588e-01   +3.772795037756669e-01   +9.802653856185004e-02   +4.699594962041118e-02   -2.959219832799252e-01   +5.180335486527099e-02   +1.283127643601195e-01   -4.513901892233067e-01   +6.679622961451639e-01   -5.710199272681772e-01; +7.028956744043358e-01   +7.238673300084231e-01   +4.058876838649166e-02   +1.705565418515222e-01   +1.551766593895044e-01   +5.553760464677480e-01   +4.753632779938077e-01   +5.780670727869561e-01   -9.029032247073260e-02   +8.297019579615522e-01   +1.275923079150940e-02   -4.823637250902041e-02; +6.454120644537625e-01   +4.146947669036199e-01   +3.559170190231960e-01   -4.360369972893631e-01   -3.431037481015867e-01   -6.229389640088587e-01   +1.249497454015925e-01   -2.106111490348290e-01   -4.578049945807813e-02   -8.616096100385739e-02   -5.994589057035509e-01   +7.468503851027018e-02; -3.016982606576118e-01   +6.487963565730467e-01   -4.365066430605045e-01   -3.342081084285707e-02   -1.803785886949168e-01   +2.638042897886687e-01   +4.128699647443405e-01   +1.181902541907720e-02   -1.062957263632682e-01   -2.224591073883887e-01   -2.187115117749593e-01   +5.226465777686035e-02; +2.605794465450405e-01   -3.003676782633963e-01   -3.834074324467409e-01   -6.333849151549804e-01   +8.056544279235680e-01   -2.313098799064226e-01   +2.475820299400466e-01   -3.228067338518227e-01   +1.885802849818605e-01   +5.234681656174041e-01   +3.419279109429670e-01   +3.804474432787225e-01];
L6_L4_iAMPA_netcon = [-3.761316417607998e-01   +1.652297369900247e-01   +3.410008941291467e-02   +2.347899987468252e-01   -1.429839438157643e-01   -8.621720282974124e-02; +1.997445491032074e-01   +1.075770985966030e-01   +5.656965610589690e-03   +4.748651568702716e-02   -6.298844724861303e-01   -1.975255295637134e-01; -4.043301685310982e-01   -1.087093866071489e-01   +2.105012718804562e-01   +3.030149104446900e-01   +9.169196573508160e-01   -3.063381933028880e-02; -7.854923993849600e-02   -3.254130427640095e-02   -7.671769394680278e-02   -2.029861608449879e-01   +1.942485888598887e-01   +4.667438962120242e-02; -2.067360401740498e-01   +2.958076020391582e-01   +2.019853660132304e-01   +6.798081331915184e-02   +4.747388725477391e-01   +4.644531857049216e-01; +7.597127991361952e-01   +3.737425506192154e-01   +2.190892751407866e-01   +4.816696587337655e-01   -1.982573534044366e-01   +1.739294537158907e-01; -1.166439464241593e-01   +1.501052751258299e-01   +3.955071360486306e-01   -4.224730919706563e-01   +3.008188309973724e-01   +6.848442055172321e-04; -3.583776536831720e-01   -4.368010953093208e-01   +1.146724249423534e-01   -1.327733216888470e-01   +7.937919192122350e-02   +9.282658968547158e-02; +4.375704751739158e-01   +2.859811141602652e-01   +2.962243298311595e-02   -2.131012147469349e-01   -3.964041925289046e-01   -9.382300196993015e-02; -1.186494095966187e-01   -4.317985904839950e-01   +4.099268733111054e-01   -2.581352271574604e-02   -1.756010543841080e-01   -1.376969224078809e-01; -3.939842519114164e-01   +2.254179709870764e-02   +5.997192578321359e-01   +6.176232503675323e-01   +2.959038237429797e-01   +2.263447149272931e-01; -5.427328277442675e-02   -1.807336062451014e-01   +2.901615896661745e-01   -1.696333230349219e-01   -3.891277701273911e-02   -3.717282145673951e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
