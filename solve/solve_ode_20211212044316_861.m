function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.119788769265126e-01   +2.154141644141735e-02   -3.260920955519436e-01   -9.438005468008237e-02   +1.278320588055984e-01   +2.603537048370973e-01   -3.992521274461953e-01   -5.578887936639512e-02   -1.296333301069774e-02; +5.801519930893708e-01   +2.952782634893010e-01   -6.478453626572748e-01   -1.317648622606151e-01   +3.678657643486238e-01   -2.457169963216534e-01   -1.395536428084458e-01   -2.183801281752627e-02   -8.311807448446640e-01; +7.214464431101410e-02   +2.316033799946847e-01   -4.609968088979399e-01   +2.905408373487461e-02   -2.602015191181445e-01   +5.566187503612752e-02   +4.092793211765263e-01   -3.870599570490651e-01   +2.359802320600827e-02; -4.147460414913072e-01   -4.279839552653310e-01   -1.908503100201661e-01   -5.985508394161992e-02   -1.454779867982226e-01   -4.234214040797408e-01   +1.810151297404544e-01   -1.585869603813927e-01   +1.468001422083464e-01; -3.240313236151734e-01   +2.420772182061250e-03   +7.068128952253153e-02   +1.947349001411749e-01   -4.381194372320645e-01   +2.269811744336579e-01   +4.158112810675010e-01   +5.457252105861083e-01   +8.486739978739993e-02; -3.446511128961376e-01   -3.861259606418261e-01   -4.056584476867171e-02   +1.700763617914841e-02   -1.428121254204917e-02   -4.479919702553023e-02   +6.657052533808359e-02   +2.332602850981447e-01   +3.161651060050971e-01; +2.936511593403521e-01   +2.461318166252962e-01   +6.205087839392327e-01   +1.258827053844456e-01   +9.147549341307397e-02   +5.560545754021858e-02   -7.087066192349827e-01   +4.239691909139073e-02   -8.398746702417643e-02; -3.609822941260353e-01   -3.746712906851407e-02   -3.632070624993419e-02   +2.325057427727359e-01   +1.765959481331503e-01   -4.088110650532867e-01   +4.058207826822948e-01   +2.902457469726789e-01   -1.704136094849703e-01; +4.092261086858668e-01   -3.159466997539028e-01   -2.780210575700327e-02   -3.088033527862251e-01   -1.506385663887710e-01   +1.428561019749045e-01   +8.814271795607570e-01   -5.656144185787744e-01   -1.056629900087461e-01];
L1_L2_iAMPA_netcon = [-7.584898491975691e-01   +5.339967678646934e-01   -6.063246884659513e-01   +6.299252217250342e-01   -3.470657088125012e-01   -2.839095297597607e-01   -5.315235462284102e-01   +2.702036357910912e-01   +6.207685799888812e-03; -3.261831585724215e-01   -2.420226953032458e-01   +2.883866024298588e-01   +3.649036974118000e-01   +6.834665156149089e-02   -2.008437570899058e-01   +3.332534163138053e-01   -7.005687258548932e-01   -2.963109239531435e-01; -1.316738251138716e-01   -1.127814699154155e-01   +3.139462362262709e-02   +1.476482942957679e-01   -2.889137379321864e-01   +4.105384726589053e-01   +3.182586842472300e-01   -4.481289508689623e-01   +1.694163798970368e-02; -6.031257933896284e-01   +6.176902558608577e-01   +2.904891852686294e-01   +5.834945445875221e-01   +5.759216279767176e-01   -1.840807671830626e-01   -1.624747155544418e-02   +6.567614186419723e-01   -2.038579327506840e-02; -3.581023482473873e-01   +5.994505631912077e-02   +4.259791473748176e-01   +1.223640347384638e-01   -1.185510585832694e-01   -6.632944064133043e-01   -4.622452340642540e-01   +8.280258597468931e-02   +7.819369076259919e-02; +1.167167563451369e-01   -6.958640019441004e-01   -2.338759175249511e-01   -2.883299828896633e-01   -5.074848674004943e-01   +3.563192019823416e-01   +1.391746373367150e-02   +2.031340174587616e-01   -2.173413130791484e-01; +2.377456632417451e-02   +2.430247731926591e-01   -4.758859336669022e-01   -3.445109694777604e-01   -1.240077376903331e-02   -4.099552519820295e-01   +6.888112119107185e-01   +1.680236815708450e-02   +4.464490155692644e-01; -5.162586564657613e-01   +1.618448117941214e-01   +2.143062575338944e-01   -5.455335876024860e-01   +2.951101544112591e-01   +9.739581348168552e-02   -9.038840800370801e-01   +4.837910633646637e-01   +1.429551702662773e-01; +5.304628049546407e-01   -2.040301178537540e-01   +1.530806696628307e-01   -1.571246468777316e-01   -8.807700892229285e-02   -2.143660593671898e-01   +3.828048927279065e-01   +4.108649644436305e-01   -1.842879320826921e-01];
L2_L5_iAMPA_netcon = [-1.375996575400428e-01   -2.338189309863106e-01   +5.373146619488183e-01   -6.996018762879030e-03   +3.040016525252207e-01   -4.249331197499046e-01   -2.692210520560829e-01   -2.013618166989347e-01   +4.905935568863947e-01; -5.503511108049572e-01   -3.341563525838024e-01   +4.359734325237184e-01   +5.013198194279793e-01   +1.365634150596046e-01   +2.880044976880491e-02   -5.182890244058689e-01   +4.366008529892120e-01   +8.901659463669601e-02; +3.894771454067890e-01   -2.462030793462455e-02   +1.536148445715681e-01   -2.005952692311814e-01   +2.027231073779118e-02   +3.252708918816488e-03   -2.001718742838614e-01   +1.364067674136422e-01   +6.670288803866391e-01; -2.605771092601823e-01   -1.561792950023834e-01   -2.352501650493141e-01   +6.107412246918033e-02   +2.508090038969838e-02   -4.394398624671964e-01   -1.156466403634210e-01   -5.985721643738251e-02   +1.376560516307531e-01; -1.342419183596737e-01   +3.180970765756200e-01   -1.214289307996682e-01   +7.752432975308554e-02   +1.857558506732200e-01   +1.352356883938960e-01   +1.555603032931620e-01   +1.309092981645573e-01   -1.694365444103395e-01; -1.220048652655499e-01   -1.008641345448296e-01   +3.060616010682315e-01   +4.997442138307970e-01   +2.718440262306504e-01   +5.550187530956932e-02   -9.092368387685337e-02   -8.429007381023046e-02   -2.434373549835680e-01];
L5_L2_iGABA_netcon = [+1.210479383074377e-01   -2.025294165446245e-02   -1.727433831470069e-01   -3.744767002464004e-01   -1.792476321305968e-01   +1.146121575865134e-01; +1.711154585589811e-02   -1.111601760398588e-01   +5.095005546077762e-01   +2.888922799279846e-01   +4.352246808738846e-01   -5.196772756171066e-01; -1.800920412000717e-02   -4.127227830317254e-02   +4.633984162109586e-01   +2.698470405612057e-01   +3.022840495151106e-01   +7.505678170565139e-02; +3.101445471616848e-01   +4.417444586525898e-01   -1.996355630845521e-01   -4.461452339027069e-01   +2.405651388171344e-01   -9.680815813353227e-03; -3.019450589485558e-01   -1.058329061811455e-01   -2.774850400512696e-01   +1.865151367790061e-01   -4.881204633813258e-01   -1.311876082037076e-01; -2.927630194079103e-01   -3.822266051554725e-01   +6.240073575071220e-02   +7.737951476933791e-02   +8.069877299477435e-02   +6.927095808996994e-02; +3.663890544853176e-01   +3.435911257944517e-01   +5.018607335455179e-01   -2.713045724784535e-04   +1.929562105581884e-01   +8.418450064666005e-01; +4.159493803183646e-02   -4.064734238348531e-01   +3.150339422430073e-01   -9.153620944136381e-02   -1.238928697289602e-01   -3.248802913422718e-01; +4.487394080795674e-01   -3.714382932029399e-01   +4.682845931746744e-01   +6.627867584327415e-02   +1.049651547171689e-01   +6.454785910349160e-01];
L3_L2_iAMPA_netcon = [+1.727957788426576e-01   +2.197831401875425e-01   +1.342872719306049e-01   -1.833946688053519e-02   -2.173199175006474e-01   +6.860589699722230e-02; -2.987456838299780e-01   +8.531510250446683e-02   -4.905315378983568e-01   -8.990274155497555e-02   +2.550931604823644e-01   -7.027757425225428e-02; -5.231441452259057e-01   +7.003632288193781e-01   -4.396899868457103e-01   -7.215802029102447e-01   -1.227909834857844e-01   +1.618437667428124e-02; +5.937021653532201e-01   -9.302842556922486e-02   -3.105035218195585e-01   -6.172781128260318e-02   -9.931971464996062e-02   -3.190474973570031e-01; +1.463246608197979e-01   +3.525251950904107e-01   -1.873302998793996e-01   +2.631331994813058e-01   -4.954480279050908e-01   -2.503683845924617e-01; +9.545812381130347e-02   -2.471472155094502e-02   +4.593406591089819e-01   -1.794922739749971e-02   -2.958269776280131e-02   -1.242426959014636e-01; +4.053304267940165e-02   +5.571679314242449e-01   +2.959480135198395e-01   -2.720869850022616e-01   -1.238816178962062e-01   -4.798993513147382e-01; -2.888106875000601e-01   -4.441637236085327e-01   +5.860663802167003e-01   -4.438436877360900e-01   -1.762168279997284e-03   +9.733203330932320e-02; +1.013491947783657e-02   +3.923036560122996e-02   -4.578096343988907e-01   -4.606915722149449e-01   +8.071643629893044e-02   +5.963379414380834e-01];
L2_L3_iGABA_netcon = [+2.501507731970030e-01   +9.765360341955730e-02   -1.895040651325938e-01   +1.804003130326677e-02   -6.043365323162653e-01   +3.729322176961664e-01   +1.324233586893880e-02   +5.344522400727422e-02   -1.025029822975638e-01; -3.255255164046933e-01   +6.402682604073203e-01   +6.490175773735674e-04   +2.841587232194762e-01   -7.711950615054772e-02   -1.523108970755926e-01   +2.880001724864992e-01   -7.189207204550871e-01   +3.088813698736214e-02; +5.409112137445797e-01   -5.246242955268327e-02   -7.262117593462042e-02   +3.720694706652385e-01   +4.287125773919355e-01   -3.364128409002490e-02   -7.308533143158852e-03   +3.280421399793679e-02   -5.037587639476219e-01; -1.962431727985381e-02   +1.651765188464485e-01   -7.320761138364470e-01   +1.948267322931855e-01   -6.260619750406123e-01   +2.856514112896545e-02   -2.914501328891497e-02   +3.425764845928930e-01   +1.133897904096800e-01; +1.453989369662702e-01   -2.018637616270303e-01   +5.449393953213157e-01   +2.586258457306824e-01   -3.314784615241525e-01   -1.058399880065788e-01   +1.749836848674256e-01   +6.954697845582253e-02   -1.041200060425614e-01; +4.629279059733073e-02   +5.702859351985387e-01   +4.277143531466689e-01   -3.328862569446108e-01   -8.441496147053668e-01   -1.854915402355484e-01   -4.953957518228000e-01   +3.585434693530584e-01   -6.443746454449156e-02];
L1_L4_iGABA_netcon = [-6.715980023193461e-01   +2.886824163900986e-01   -1.360157761174107e-01   -5.111821886651214e-01   +1.269228953339835e-01   +8.504389786686459e-01   +1.477519753605231e-01   +4.337524618005280e-01   +9.745781926451078e-02; -2.838277046843321e-02   -4.842784982210395e-02   -6.039797185289937e-02   -5.819507023846269e-01   +1.462694170804191e-03   +5.264497082463457e-01   -3.701813935318748e-01   +4.163523745069326e-01   -4.080523515699819e-02; +5.598018525444778e-02   +3.411652948214863e-01   +2.616546712542099e-01   -1.890620562517999e-01   -4.873822152411927e-01   +7.493226180168988e-02   -1.608582348773371e-01   +1.075017612296916e-01   +2.905292336297177e-02; +2.304951697757108e-01   +4.843745028191977e-01   +2.830377162940945e-01   -2.263816121628737e-03   -6.032034413945565e-01   +3.730516540046801e-01   +3.343953637991491e-01   -3.726170900252868e-01   -3.784436308142606e-01; -2.435760197019156e-01   +4.298785657578617e-01   +1.300136558611339e-01   -6.982588696757451e-01   -3.583573307569973e-01   +5.259546131718296e-02   +5.154425462728112e-01   +5.771652731430609e-01   -2.712843861359389e-01; -1.507736187296593e-02   -1.128575337839759e-01   +2.203260872191378e-01   -5.120900282180884e-01   +3.049002742575831e-01   +3.732769186067544e-02   -8.440269847701690e-02   +3.085411175496773e-01   -1.659004308299415e-01; +7.805875661067629e-02   -4.553092839483462e-01   -3.766103072549633e-01   +2.442259047539705e-01   +7.419325857934784e-01   -2.237395359115069e-01   +9.215956070838978e-01   -2.993116720472319e-02   -4.210153214900000e-01; +2.658112468095786e-01   -1.440472059271763e-02   +4.845711878265256e-01   -4.321635367792666e-02   -1.416135174798057e-01   +1.477964885840399e-02   +4.036131126641866e-01   +1.588408882519608e-01   -9.647110650074581e-02; +4.220444594179437e-01   +1.704765494520079e-01   -1.965936545340163e-01   +1.662783423213352e-01   +6.269076873891274e-02   -4.683677215232024e-01   +1.119507419954993e-01   -6.139765924491185e-02   +1.543247585096565e-01; +8.698271360436205e-02   -6.584822834270097e-01   -6.526109668743918e-01   -3.151621480280781e-01   +3.143966230459466e-01   +4.810606090527997e-01   +2.700218439504741e-01   -1.064214971558989e-01   -2.642863898124360e-01; +1.457691252840646e-01   +3.823921138517767e-01   +5.372625190312983e-01   -3.906549559594141e-01   +5.647974936703675e-01   +4.191320808393040e-01   +6.990297178499387e-01   +3.898501438159994e-01   +1.311656233116881e-01; -4.587915383037505e-02   -1.349092412921950e-01   -2.660657781924241e-01   +4.316331693031936e-01   -8.289009736199694e-02   +1.103787819598219e-01   -5.112941039822858e-01   -2.266988543663019e-01   -1.035374449083904e-01];
L4_L1_iAMPA_netcon = [-1.204345803652488e-01   +4.199992256393711e-01   +2.536052327142698e-01   +7.138103008661593e-02   +1.180251867882803e-01   +1.128190302565279e-01   -2.213457951288132e-01   +6.386916707812997e-02   +1.851759653082539e-01   -2.859719333279023e-01   -2.879849182686368e-01   -1.601707634776060e-02; +5.172203855695915e-01   -2.948647869667639e-01   +6.313936372045623e-02   -8.515002066556837e-02   +2.183921069831830e-01   +7.735890633829828e-01   -2.876959372908821e-01   +4.432256284967380e-02   -5.738472700331110e-01   +5.503945578938007e-01   -1.132094311354991e-01   +8.040022257848756e-02; +3.643053458664485e-02   +4.450849766141575e-01   -5.955246066740945e-03   +3.938257181293057e-01   -4.506849904198394e-02   +3.864899963541603e-01   -3.192078372490051e-01   -2.986324438005225e-01   -3.954144211998000e-01   +5.158084419366106e-02   +4.922595869876969e-01   +3.379935186700154e-01; -3.433307137014528e-01   -2.458199318124435e-01   +5.187906002116596e-01   +1.000000000000000e+00   -1.075260121774284e-01   +2.214026580829620e-01   -8.923242493097251e-02   +1.632748614975650e-01   +1.407159602075265e-01   +4.453203674519551e-01   +4.793855263618505e-02   +6.317546149726472e-03; -5.222827176560336e-02   +2.297553258252235e-01   +2.439840472772885e-01   +5.476411903991889e-01   -2.844962608524896e-01   -3.002591599133604e-01   -2.659677211421055e-01   -4.168277867767054e-01   -3.415050610347132e-01   -2.558138595419617e-01   -2.069891476408494e-01   -1.651197791763923e-01; +1.903669148996337e-02   -1.190809371629478e-01   -5.806668841395287e-01   +2.056958511868885e-01   +3.297661730537418e-02   -4.784544821074595e-01   -8.675390171718278e-02   -6.637703996517645e-01   +2.022366792665991e-01   +4.052998748367306e-01   +6.595818490203949e-01   -1.744234375967776e-01; -6.195752031564884e-03   +1.991407430711315e-01   -2.387216102297372e-01   -9.420655168848076e-02   +1.876418336471945e-01   -2.335984247780576e-01   +4.285517505892664e-01   +8.124127343134662e-01   -4.189728986101764e-01   +3.754338310271805e-01   +3.812292689146102e-01   +2.409433923336367e-01; +8.768891731877256e-02   +3.658911525774072e-01   -4.221367535552946e-01   -1.391832243003190e-01   +1.451470449741399e-01   +1.312468780452047e-01   -7.309316360773105e-02   +3.542401887592935e-01   -5.001098907876006e-01   -3.986999823412432e-01   +1.032712966551553e-01   -4.796876015610236e-01; +5.844896318954507e-01   -1.766213672181003e-01   -1.369287566070353e-01   +4.089705165487645e-01   +3.049774209188633e-01   +1.736110215532174e-01   +4.558824046765184e-01   +2.227325188408276e-01   +5.888635918539037e-01   +5.889053722690578e-02   -1.002393973337728e-01   +5.867878568848232e-01];
L1_L3_iAMPA_netcon = [-5.254017877028813e-01   +4.741500236440421e-02   +1.615252383245881e-01   +7.979059237658981e-02   -1.734051755734300e-01   -6.755648578717226e-01   -1.365510771656242e-01   +1.038404296438611e-01   +7.693694033103481e-01; -8.105917373016478e-01   +6.729562227974240e-02   +7.683601672855018e-01   -6.724222501466398e-03   +3.779141016520545e-01   -3.222618791951973e-02   -8.413451043029690e-02   -3.382455793661048e-01   +2.460451490698599e-01; -2.993328416455450e-01   -1.298516080267652e-01   -4.323588148696841e-01   -4.650359615861320e-01   +4.744216618399086e-01   +9.831090002465578e-02   +5.886364832864659e-01   +7.083437581768090e-02   -3.681685547700841e-01; -1.332231587612869e-01   +1.101196031997156e-01   +7.352120980096641e-01   +8.238504575075176e-02   +1.540850164213947e-02   -1.695735575114605e-01   +3.478148494228203e-01   +2.672282800120748e-01   +1.005738516617435e-01; +8.424995517694818e-01   -2.965301665434329e-01   -1.467996278530684e-01   -7.800737180078900e-01   -6.514218056849311e-02   -2.458771986822830e-01   -1.157002156710698e-01   +7.976923814427661e-03   +5.627782888364763e-01; -6.620535938398837e-01   -1.055561489363377e-01   +3.496522004242897e-02   -1.751602886431881e-01   +4.290473524337878e-01   -7.221387417421596e-02   +7.234040906770787e-01   +8.274194983090711e-01   -9.506368324188828e-02];
L3_L1_iGABA_netcon = [-2.443684823154494e-01   -2.604363203201405e-01   -7.218644114096393e-02   +1.734431385586667e-01   -1.758056843782585e-02   +3.887036330957189e-01; +3.239805476049030e-01   -3.932285862807800e-01   +1.036721733256871e-02   +3.559995063492958e-01   -3.771772958378220e-01   +2.415203737498208e-01; -7.513925085069093e-01   +1.062141390223380e-01   -1.620859676212714e-01   -6.413135075343231e-01   +4.602250496994817e-02   +4.290449950409517e-01; +1.031842121307047e-01   -3.972404201180135e-01   -6.234174898325291e-01   -4.662094542744987e-01   +5.145420398572310e-01   -7.579707587153703e-02; +1.601727939212695e-01   -4.728322205144950e-01   +1.607826990412345e-01   +3.919018706735332e-01   +9.317064977086242e-02   +1.112936217628024e-01; +4.504080747235662e-01   -4.709590693854954e-01   -1.115200744867985e-01   +3.198579723770987e-01   +5.215219217153790e-01   +1.110817843309141e-01; -5.015709138725878e-01   +5.024394852297709e-01   +8.408545344052860e-02   -5.200534157357162e-03   +6.784481677052449e-02   -1.874903705350452e-01; +1.419470678855350e-02   -1.606258942720358e-01   +3.392908115225679e-02   -2.479402682059228e-01   +6.102215824573742e-01   -2.469830508714265e-01; +8.264126200044450e-02   -2.825137151387024e-01   +2.554626572146805e-01   -5.538957184911779e-01   -2.814016414463908e-01   -2.952537106226327e-01];
L5_Input1_iAMPA_netcon = [-5.670683933073828e-01   -2.320868614252498e-01   -2.635380524866307e-01   +2.444849638475584e-01   -2.519624922499986e-01   -4.331947821504861e-01];
L6_Input2_iAMPA_netcon = [+1.183691514543494e-01   +3.218201324149190e-01   +2.082559621938673e-01   -6.970611136060811e-02   -6.501420498437674e-02   +2.577627483239908e-01];
L5_L6_iAMPA_netcon = [-1.043523947342080e-01   -1.741594436222007e-01   -1.901899608246862e-01   +8.217247644694048e-02   -2.886472184484461e-01   -8.503150962576804e-01; +3.376152436300348e-01   -8.030543232440107e-02   -5.367525661203598e-02   +4.293897093172738e-01   +4.181055297024616e-01   -3.440329595312146e-01; -2.733971425719079e-01   -8.128998453058989e-02   -5.168706613388858e-02   +2.838934206599722e-01   -4.481933653188435e-01   -1.588290067689881e-01; -1.161518655911273e-01   +3.358017955300391e-02   -5.479692486574175e-01   -8.616234300675379e-01   +3.644028510922537e-02   +3.296069808556084e-01; +1.167504493869703e-01   +2.033305029254649e-01   +3.304123816373581e-01   -1.596560197696431e-01   -7.169781842803583e-01   +2.852363987624260e-01; -2.895190551497090e-02   -7.866486677047405e-02   -3.105932230557697e-03   -1.881855740466620e-01   +5.541252479558700e-02   -2.444036639060202e-02];
L4_L5_iGABA_netcon = [-2.814706710267337e-02   +7.400296958689709e-01   +4.366476624292195e-01   +4.479514483931175e-01   -1.551908848877130e-01   +1.848808281127628e-01   -5.416234438271828e-02   +5.708693724267205e-02   -3.824063074906492e-01   +5.744586668768036e-01   +3.896277652615485e-01   -3.935973393394628e-01; -1.682458790252885e-01   +4.375343235372891e-01   +2.341902765245953e-01   +3.316262722251443e-01   -1.027176904896904e-02   -1.272265206560428e-01   +5.748180489290455e-01   +5.246934121778682e-01   +2.156595214774768e-01   -1.430965154753493e-01   -5.762754374435436e-02   +2.005220156499506e-01; -6.310690455429155e-01   -1.889019376876149e-01   +3.298404434699569e-01   -6.356903432401307e-01   +9.182493786047953e-02   -1.440882992886079e-02   -2.176713470115854e-01   -3.946239030110987e-03   -5.260274490031078e-01   +4.390579812602633e-01   -6.269928923407793e-01   +2.214222765527567e-01; -9.256371841280694e-02   +5.331979380961112e-01   -7.319719690844769e-01   +1.827789054624576e-01   +5.135563302132342e-01   +9.656163348513280e-02   +2.252271204401504e-01   +3.211348962273137e-01   -1.164845232375560e-01   -5.869139090364065e-02   +7.933841521705072e-01   +5.106768274403843e-01; +3.427597638122747e-01   +2.300579784546478e-01   -2.136719613841756e-01   +2.848911725887368e-01   -2.817013065744469e-01   +4.800058791323203e-02   +3.290605986604935e-01   -3.060135152703036e-01   +3.611588091674701e-01   -1.742829010455402e-01   +8.782974444989524e-01   -4.182941316029745e-02; -2.957474931429921e-01   -3.878709159016627e-02   -4.363925363777722e-01   +1.334026421014936e-01   +2.574313224036232e-02   +2.519776766731687e-01   -1.556484370208272e-02   +2.698547520451539e-01   +1.329360779182193e-01   +4.699566152504251e-01   +1.253047412842958e-01   +5.861191957300038e-01];
L6_L4_iAMPA_netcon = [+1.714123550445033e-01   -5.895440180336635e-01   -2.724821592343160e-01   -4.777491640619361e-01   +9.107227806377181e-01   -1.439639028956601e-01; -3.527162123750794e-01   -5.657963334110615e-01   +1.030284067996613e-01   -2.295081888320430e-02   -1.285840240229518e-01   +6.777571970382765e-02; -1.683042774691943e-01   -6.025230067805024e-01   +4.785873835166600e-01   -3.968917858069073e-01   +4.074008535772651e-01   +3.833721951000093e-02; +2.264031096904115e-01   -1.689636329908473e-01   -6.913072684414765e-01   -2.703198938845194e-01   -1.516331905091614e-01   +2.657567320412966e-01; -5.487500029177454e-01   +4.008695773177229e-01   +2.984319972590299e-02   +2.118836365737752e-02   +6.202644737290920e-02   +2.942044989598076e-02; +1.500597949517479e-01   +8.914497731363111e-01   +4.781671384241990e-01   -1.091273804722069e-01   +9.330249319890035e-02   +3.059180690487204e-03; -1.602160823691597e-01   +4.396357325572156e-01   -3.493941921516271e-01   +3.332833959561131e-01   -4.101988088797603e-01   +3.810401799488667e-01; +8.317196880149502e-02   -1.643354915278705e-01   +4.343393657187273e-01   +4.675628950978394e-03   -1.345556253879855e-01   -1.675954924675485e-01; -1.126268721110432e-01   +9.669148423745944e-02   -3.228151272210191e-01   -2.751626771139652e-02   -2.050111930100020e-01   -9.871380129574656e-02; +4.805411748912322e-01   +3.532814749805938e-01   -2.008709335054593e-01   -5.531964534644606e-01   +7.743064250556617e-01   -6.588934787613440e-01; +2.282454651000623e-01   -3.646595698119978e-01   +3.233727265631451e-01   -1.291450871885849e-01   +2.372697437656374e-02   +3.982969106360560e-02; +8.090588922219186e-02   -4.086660635306344e-01   +1.408386821637548e-01   -3.323186241109688e-01   -5.149210623614345e-02   +4.267024466768367e-01];
L5_L4_iAMPA_netcon = [-5.444150940757793e-01   -4.832730902589080e-01   +5.877528215457048e-02   -5.943305806770580e-01   -1.729942030994201e-01   +1.254754627328097e-01; +1.332796386834758e-01   -2.958812845974734e-01   +5.568124726661488e-01   +6.719225943546775e-02   +5.900377950905025e-02   -3.516615269636308e-01; +2.765911809007496e-01   +6.177832337586441e-01   +4.225808604192868e-01   +1.959783218051267e-01   -2.504425862123222e-01   +7.747120958711434e-02; -5.621652800006041e-01   -2.251676433397402e-01   -2.956707432803997e-01   +1.576905753401427e-01   -1.702597310702163e-02   +1.335824585259425e-01; +3.213666004132120e-01   +6.622561425074744e-01   +3.556206368373827e-01   -1.669176762591646e-01   +4.119384484218119e-01   -6.439765329503767e-01; +1.347631632007398e-01   +1.245549255073807e-01   +8.159233878926432e-02   -3.473882550137336e-02   +4.181367961193685e-01   +7.167035448593248e-02; +2.565913484691820e-02   +1.801083368305784e-01   -8.976920294896279e-02   -3.169134346624294e-01   +5.055954571495478e-01   +8.326970911880155e-02; -4.177609530087352e-02   +6.904453729594213e-01   +2.795907175878431e-01   +4.182594029738222e-01   +9.616186667893190e-02   +4.365822747002740e-01; +1.712121801464333e-01   -1.495412360563971e-01   +3.729129497310602e-01   +1.257597765132013e-01   -3.474070653224705e-02   +2.365236041805933e-01; -4.484030871115513e-02   +7.202147596763436e-01   -7.266778099933318e-01   +4.734470270013896e-02   -2.753522769040491e-01   -5.937981146035231e-01; -7.601173765347444e-02   -5.549821089345792e-01   +2.766044716318443e-01   +3.583306604497691e-01   -8.355094352668518e-02   -1.305286444786931e-01; +2.890717991411069e-01   -1.986556085204332e-01   -2.634769656159876e-02   +1.838478306365653e-03   -2.061426737317005e-01   +7.378591189728942e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
