function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.293395800930054e-02   -8.345669747151375e-03   +1.657170766468358e-02   -1.373929841249214e-02   +1.186277165601877e-02   +8.242275896755531e-03   +3.116285227504046e-02   -6.224806874997746e-02   +1.831961567002149e-02; +2.132987340603484e-02   +1.046137070261192e-02   -1.680529390463412e-02   +1.577206170310961e-02   -3.561516658264638e-02   +2.377083269977260e-02   -2.092122136809313e-02   +9.721444065202461e-03   -4.775538291251508e-03; +3.148806911401332e-02   -2.462146912166169e-02   -1.721664632073736e-02   +2.797594473108296e-02   +7.247912155290001e-02   +6.832810721144757e-03   -5.868495775787649e-02   +2.632263663582695e-03   +1.176194215596037e-02; -1.738033875467354e-02   -9.329326826746451e-03   -4.424214741678196e-02   +6.146257720545523e-02   +3.710662704092123e-02   -6.304821111425657e-02   +9.557035767222943e-03   +4.290866416285501e-02   +7.425019700009605e-02; -2.328823712255703e-02   -3.086076829047525e-04   -2.650778178308359e-02   -1.978298863583955e-02   +2.591307717894402e-02   -3.494043353116607e-02   +1.331908524584596e-02   -4.009814851901460e-02   -2.144278249034127e-02; -3.585187247459141e-02   +9.725662498032091e-03   -1.631463601256686e-02   +2.685175920555405e-02   -1.470298624557214e-02   -2.600212253713571e-02   +6.297404817352267e-02   -1.587315444309949e-02   -2.258040599647994e-02; +7.429990084064671e-02   +8.138028667905711e-02   +2.469613870872370e-02   -9.031552506705436e-03   +7.345764282151300e-02   +4.545606997376300e-02   -4.849291500991377e-02   -4.823473452171232e-02   +6.066466673271467e-02; -7.912979731198581e-02   +2.642626338857865e-02   +4.462221015194888e-02   -5.231809116240455e-02   -1.943721020416212e-02   +3.969852601616822e-02   +2.763551490241752e-02   +1.218688483903826e-02   +7.182088284403800e-03; -2.033237200522460e-02   +4.659278997576199e-03   -7.051048427388594e-04   -3.280621153819315e-02   -7.317401461031500e-02   -2.843583894051105e-02   +1.000226178386608e-02   +6.063977501629132e-03   -6.022185827909283e-02];
L1_L2_iAMPA_netcon = [-5.426817481458968e-02   -3.659644341249699e-03   +5.930996621062519e-02   -6.132173864640141e-02   +6.093089574423077e-02   -9.248574878136795e-04   -1.537529269758217e-02   +3.622287970137721e-02   -9.446168952481834e-04; +3.046363368065444e-02   -2.753105163720533e-02   +7.819473253219815e-02   +1.879317529701023e-03   +2.216406496829763e-02   -7.477006252467649e-02   +2.373788218617508e-02   +4.086057118651341e-02   -1.298261810635606e-03; -1.030056334075902e-02   +2.872564048625594e-02   +1.709939868834844e-02   -4.342094451891808e-02   -2.674783720508030e-02   -3.138874910386215e-02   +1.874741906452370e-03   -2.158634191588928e-02   -9.579799156398949e-04; +3.920698466439397e-02   +2.564051806120676e-02   +3.012568821566030e-02   +2.313629341638034e-02   -1.862932138694451e-03   -2.576399193034726e-02   +7.172336610265209e-02   -2.428214243417488e-02   +5.132540532806272e-02; +1.639515511820228e-03   +2.988100878979973e-02   -1.226233226210637e-02   +9.863102799509034e-03   +1.549899675116790e-02   +9.595400828128442e-02   +4.133114526110852e-02   +4.954261606764707e-02   +1.124826689972738e-02; +1.245233572620937e-02   +9.863226305174012e-03   -1.087508586861036e-02   +3.710792070914037e-02   +3.442720340781544e-02   +8.981740758672415e-03   +3.088162610550175e-03   +1.614601085211751e-02   +5.973563858001907e-03; -4.397446564383779e-03   +2.009311952180418e-02   -2.126972927076764e-02   -1.723251995303939e-02   +7.387483535527810e-03   +9.247017892235853e-03   -5.077486991975848e-03   +2.375704160455480e-02   -6.262653824623115e-03; -6.005686904173682e-02   +1.960754467646374e-02   -1.286091882174463e-02   +3.362963943141280e-03   -1.718508153921056e-02   +6.274228824783640e-02   -7.255083619339198e-02   -3.545747433876148e-02   -5.916648550119435e-02; -1.583805476305408e-02   +4.971072762117267e-02   +2.532564185904579e-02   -6.797756716679374e-03   +3.313749892827048e-02   -2.824471593699480e-02   -3.432635906210128e-02   +3.523508725266667e-02   +4.824733062133138e-02];
L2_L5_iAMPA_netcon = [+7.585641836175050e-02   -3.357025058275656e-02   -4.327560560213202e-02   +2.051412094095129e-02   -7.680087089540754e-03   +2.614094585878517e-02   +4.602049494828730e-04   -1.065332571160393e-02   -1.051577883709803e-02; +3.726367358226440e-02   +2.172626773323659e-02   +2.809596226284990e-02   +1.135699400640078e-01   +1.579804836066676e-02   +6.507168938971827e-02   +4.065043818906100e-02   +5.975251910871154e-03   +1.398900901997465e-02; +2.761306400233532e-03   +6.876828324444032e-03   +7.955705280146923e-02   +1.709417651255665e-02   -2.005998250406327e-02   +4.732845677325295e-02   -3.728051453740478e-02   -3.015199361895606e-02   +5.081178084557110e-02; +2.708666346194155e-02   -3.653408293984270e-02   -6.201895593040552e-02   +7.907242298339202e-02   -8.640183585115504e-03   +9.684954731266494e-03   +5.377728877256118e-02   -4.471510394154723e-02   +1.894137393649874e-02; +5.716592429549518e-02   +1.674170307276901e-02   -2.788402363193323e-02   +7.175456069327749e-04   -3.237666837659357e-02   +3.171268786234493e-02   -8.936956698550075e-03   +3.593169101096855e-02   -2.337755103149582e-02; -5.581249308091348e-02   -3.580005209921254e-02   -1.843364285705591e-03   -1.860318417574482e-02   -2.195993211029134e-02   +6.466234989619735e-02   -5.323254279658140e-03   +1.745719265615298e-02   -2.301511423784120e-02];
L5_L2_iGABA_netcon = [+4.808687010622585e-02   -2.401377701361941e-02   -1.005987606755586e-02   +4.121459619006280e-02   +5.295965660111982e-03   -6.216422253407787e-02; -1.082648390579546e-02   -2.584190487172746e-02   -6.933742597602736e-02   +6.871998689895172e-02   +2.088490235017651e-02   +3.652819912392775e-02; -1.391230712489869e-02   -2.538408147035258e-02   +7.853478081826673e-02   -9.651854490035017e-03   +7.153211460106312e-02   -1.320851202701736e-02; +2.095496018585057e-02   -1.866721470133415e-02   -9.741773287220510e-03   -3.225005816322352e-02   +8.434904233405984e-03   +2.397636796730241e-02; -2.164572372721140e-02   +2.230108882805030e-02   +5.871267565595046e-03   +9.306600800369358e-03   -2.502249819953363e-02   +2.656222438189863e-03; +1.796374144494969e-02   +3.241720837300329e-02   +3.636369603198920e-02   +3.186259436127298e-02   +4.769478794647932e-02   -2.031670765440072e-02; -7.282821668414850e-03   +1.499380946597741e-02   -3.618038906165163e-02   -3.405547736144685e-02   -5.317747507056327e-02   -3.192678068260150e-02; -5.430064572980234e-02   -5.750969857837296e-03   +7.751949528929186e-02   -3.449825802357059e-02   -1.786947376739655e-02   -8.802047417269816e-03; +4.915327579735976e-02   +2.702123004463102e-02   +3.340099646352140e-02   -3.936252951781916e-02   +5.477696757761238e-03   +3.073214221002146e-02];
L3_L2_iAMPA_netcon = [-5.426104954743447e-03   -3.500395497102502e-02   +6.218213352252007e-02   -1.525484386309948e-02   -3.094212019887081e-02   -7.635937709358154e-02; +1.993747142908319e-02   -1.340764546993215e-02   -1.140238290209242e-02   +2.517400332788401e-02   -3.263017411652565e-02   +6.364398014776981e-02; -1.039610694509462e-03   -3.252307573920310e-02   +1.276116371560109e-02   -1.465063230707779e-02   -1.539893277241880e-02   +1.279855134683091e-03; +1.820920395225924e-02   +2.532046309474903e-02   -1.452182656268605e-03   -1.108662760299375e-02   -6.866765208317217e-02   -2.683740603707601e-02; -3.106991623209529e-03   +3.270265009373044e-03   +2.594940483882644e-02   +2.855844332824792e-02   -1.428790153205413e-02   -5.893895770602677e-03; +4.204987657979954e-02   +4.886338997500541e-02   +1.005520524765192e-02   -2.102779752396428e-02   -5.963144422739194e-02   -4.319960095960855e-02; -4.111663643061895e-02   +2.601081762239057e-02   +4.320796433669690e-02   -1.404078569961074e-02   -2.397234668825738e-02   -1.422948771639957e-03; +9.757489361374570e-03   +3.341985087669438e-02   -4.069603678848775e-02   +1.893596564391621e-02   +2.814097152169985e-02   +1.683436057358020e-02; -3.828684330016490e-02   -2.562829314458775e-02   +2.575391116408595e-02   +3.215451015330940e-02   -1.627461326460767e-02   +2.896055900490570e-03];
L2_L3_iGABA_netcon = [+4.011388387228273e-02   +1.027775075239764e-03   +2.067196460663272e-02   -8.685734257138962e-03   +8.000111573689132e-02   +1.968604854072276e-02   -3.737297364880786e-03   +4.817181407722905e-02   +1.345175980198502e-02; -1.826344585047363e-03   +4.575456329044125e-02   +1.556361139327143e-02   +2.462323417889861e-02   +2.850570074519148e-02   +6.568251546660869e-02   -1.480137377877557e-02   +8.571840015258413e-02   -2.760716716996123e-03; +2.799017225330852e-03   +6.591995319912620e-02   +2.384052645556896e-02   -1.704790103721110e-02   -1.259563625232626e-02   +2.399522442033655e-02   +7.467037391699551e-02   -1.067442912795081e-02   -1.323109754686433e-02; -1.004957172185861e-02   -8.799216790414971e-02   -2.060785898779198e-03   +3.091051315167823e-02   -1.945878905845895e-02   -2.457587779442384e-02   +6.983187361887619e-03   +7.016510733481043e-02   +2.065050398714513e-02; +6.841763659943411e-03   +2.588366647424243e-02   +1.536937458889083e-02   +3.369878688383571e-02   -1.038074154317826e-02   -4.180324441488495e-02   +5.401931354690023e-02   -1.825814769073288e-02   +4.708762812711829e-02; -4.569317608595096e-02   -2.275207235193609e-02   +6.210114954778834e-02   -3.177741657896573e-02   +1.184127106267878e-02   +1.515967595609211e-02   -2.321482871529547e-02   +2.986823842207583e-02   -9.390697421843421e-03];
L1_L4_iGABA_netcon = [+1.330430303393257e-03   -7.715765734415915e-02   +5.270042696805746e-02   -1.887768067643388e-02   +1.707241897787191e-02   +4.928641306361380e-02   +4.833794227774504e-02   -3.634018012944659e-02   -1.510419485617666e-03; +6.642311917555839e-02   -3.951575156550075e-02   +3.192228433423966e-02   -3.020445441419517e-03   +9.843529546788447e-02   -2.402603833501752e-02   +3.846166177064601e-02   -2.384103566932607e-02   +8.466223178520626e-03; -2.007436504583772e-02   -2.606939699928352e-02   +4.137518481108153e-02   -4.839957725873947e-03   -2.904961346746255e-02   -9.279895543726803e-03   +8.760730716998064e-02   +5.527461658017440e-03   +2.220435907037854e-03; +3.088369608889730e-02   +2.425960850779085e-02   +4.765732210094734e-02   +5.235328114554921e-02   +8.137708984625288e-03   -2.119672191218222e-02   -1.935466187653656e-02   +3.210683199746368e-02   +5.160578032706250e-03; +1.820549854423058e-02   +5.508291733060125e-03   -1.217542487280367e-02   -1.595575453224984e-02   -1.939560716355034e-02   +4.154985978631118e-02   +3.770400324612418e-02   +1.913251220752305e-02   -2.901937859452278e-02; -3.533290431955902e-04   -1.623214355785402e-02   +2.141602705836727e-02   -3.013638308279831e-03   -3.392665938565865e-03   -4.543057215547058e-02   -4.922672448892827e-02   +6.064424231511344e-02   +3.518898762612525e-02; +2.875613779132175e-02   -2.622424815810262e-02   +6.202683076302576e-03   +2.034742073045663e-02   -3.711983025388454e-03   +4.153569102079210e-02   -4.539967621992667e-02   -1.739431213335179e-02   +4.083064010603100e-02; +9.125589280772204e-03   +3.213658437765299e-02   +6.494180336212443e-02   -2.588300481468808e-02   +2.001066321213214e-02   -3.935932507254340e-02   +1.210038068359037e-03   -6.097192501925779e-02   -7.376311536987537e-02; -2.218171952655099e-02   -4.177329028119306e-02   -4.497748959426161e-03   -3.534171997069557e-02   -1.166513736833075e-02   -2.031348748192282e-02   +5.531847120774000e-02   -5.500345072230604e-02   +1.317796721988769e-02; -4.277346077840900e-02   -1.164168270664902e-02   +4.342334748221618e-02   +2.849086517928448e-02   +5.632445850941803e-02   -5.638035205144924e-02   +2.565338098821200e-02   +3.070580333452256e-02   -7.937823143409059e-03; -3.200930226264477e-02   +3.774765938634964e-02   +2.067450748138521e-02   +3.517807356889488e-03   -4.395176505658652e-02   +2.914039005816813e-02   +4.045591337885415e-04   +5.518097765672428e-03   +1.588579529039659e-02; +7.708212337948148e-02   -5.168820276105111e-02   -1.182714720594511e-02   -2.691217900305293e-02   +4.584409426207724e-02   +6.956050682379308e-02   +8.625789030909853e-03   -4.799743013385662e-02   +2.711466711011098e-02];
L4_L1_iGABA_netcon = [-5.930904428804989e-02   -8.008810132524218e-02   -1.496663526255398e-02   +5.620440159003344e-03   -2.783240552911843e-02   -2.015695829723818e-02   +1.715657652300281e-02   -2.106947201772493e-02   -6.399932726545442e-02   +2.666358089994645e-02   -4.928110354451621e-02   -8.261066207500469e-03; +3.224464151320795e-02   -3.730505312013889e-03   +2.689066575980067e-02   -6.084978149336780e-02   -2.431085010655733e-02   -1.480676621845792e-02   +7.561465979908197e-02   -6.049506637622786e-02   +3.036924954618056e-02   +1.398053749733932e-02   +1.963749264035232e-03   +4.538446770720179e-02; +7.079337020644149e-03   -1.556818972301122e-02   -2.346386812126251e-02   +5.519423863592546e-02   +4.793793925982048e-02   +3.491090442200037e-02   -4.438313683132359e-02   -6.143916898496941e-02   +6.142560625607851e-02   +4.145677222314206e-02   -4.569215478647258e-02   +2.941253071454153e-02; -3.103143920950954e-02   +4.334694384038394e-02   -3.485940522444714e-02   -1.458305132347630e-02   -8.096279851622524e-04   -2.721244478400283e-02   -2.109761403077417e-02   +2.027328839855508e-02   -4.376919328045958e-02   +5.321515901219636e-02   -4.069815482687074e-03   +6.893960668215889e-02; -6.259748994339595e-02   +2.165626725494344e-02   -1.406914979700576e-03   -3.269653297531089e-02   +3.210429217255636e-02   -2.416146652063158e-02   +3.619747522988893e-02   +8.346561448923286e-03   +7.969541676329381e-02   +3.159737541757867e-04   +2.727985282182744e-02   -3.431677048547904e-02; +2.959914444691568e-02   +2.904158794961761e-02   +1.959751191735054e-04   -1.479316651896396e-02   -2.928703292520694e-02   +1.045097550814129e-02   +2.527347724206864e-02   -3.795175376126159e-02   -4.281341521206290e-02   +4.553970068840001e-02   -5.233961788641692e-02   -3.778605517853870e-02; -3.473867503106359e-02   -2.769052034436337e-02   -6.577176097983739e-03   +4.078493600790713e-02   +2.822305976800974e-02   +4.205967102132009e-02   -1.033349815438945e-02   +1.494714627161450e-02   +6.549757165815580e-02   +6.037066155964746e-02   -2.017587742510756e-03   +3.899157346320686e-02; -8.260844727116766e-04   +1.642302629225913e-02   -2.479442848006595e-02   +1.958410658070677e-02   +8.312298948010555e-03   +5.640697311281698e-02   +1.639405326348787e-02   -9.977130968612889e-03   -7.608798433953773e-02   +1.478716319480146e-02   -4.873061430888854e-03   +4.072409885922456e-03; +3.742468385989314e-02   -5.910411558572047e-03   +1.476501757479799e-03   +5.658690510532575e-03   -1.355125337353900e-02   +1.071421041966070e-02   +1.467787986019871e-02   -2.089426930055023e-02   +7.670763810670786e-02   +4.498899601233167e-02   -4.111455344074780e-02   -5.868335960628586e-03];
L1_L3_iAMPA_netcon = [+2.366532090066298e-02   -3.268596406113003e-03   +6.884604765282251e-02   -4.620696537125224e-02   -6.081786775064721e-03   +1.890238694048698e-02   +2.563694681634259e-02   +7.766882023839350e-02   -2.936216689437834e-02; +8.736423907854744e-02   -5.182501493095402e-02   -2.002195743214536e-02   +1.473071749824982e-02   +3.540171065619677e-02   -3.446116352654714e-02   +1.284351923656356e-02   +2.157744919246799e-02   +1.520651039186464e-02; +3.065524686172883e-02   +7.161115405975786e-03   +1.144885476825575e-02   +2.209404112180141e-02   -5.725262913355042e-02   -2.500263197273637e-02   +8.467925300767516e-03   +4.978739146129146e-02   +6.294976739859157e-02; -2.223447553473371e-02   +4.257252670330616e-02   -1.363512190070224e-02   +7.486919933949038e-04   -4.467305954303373e-02   +3.341335545557386e-02   +2.084058689119926e-02   -3.709825138386018e-02   +1.558217294533563e-02; +1.089201923770824e-02   +7.949192650492959e-03   -4.584525342894518e-02   -1.026828196495001e-02   -1.031300323042567e-03   +4.991078252342956e-02   +5.389305213250146e-02   -3.005536241555670e-02   +1.649880803807590e-02; -1.542832072651253e-02   +3.231005630583504e-02   +5.246987223416705e-02   +3.017245328864121e-02   -1.819542891264609e-02   +1.314488645793814e-02   -4.188375680153981e-02   -3.114209220146671e-02   +2.743799228746183e-02];
L3_L1_iGABA_netcon = [+8.304040770050716e-02   +1.121655857721553e-02   -3.010235564281746e-02   +2.274583206116565e-02   -1.429929679820055e-02   -2.170168732858682e-03; -1.330794416610063e-02   +1.266265605430549e-02   -1.297832886556360e-02   +3.858175618412280e-02   +4.365473708167075e-02   -1.432198799509839e-02; -3.840409678234419e-02   -2.145414725844389e-02   +8.603032199911154e-04   +1.625240375750859e-02   +6.039818547623382e-02   +6.876141135318131e-02; -3.140094934373881e-02   -3.533446845560286e-02   -3.888562873446050e-03   -1.681140552733010e-03   -5.891695219584641e-03   -2.129746985349051e-02; +3.211070160257504e-02   +2.890741663564150e-04   +3.355102884627838e-02   -2.342460155852908e-02   +1.869402646117936e-03   +1.355915749855782e-02; +4.859675418668757e-03   -1.342203566728741e-03   +9.539364751550281e-02   +3.519974434313752e-02   -8.464319679378561e-02   +1.055234087620742e-01; -4.277995347225426e-02   +2.157674509319490e-02   +4.794721397352274e-02   -3.444696566177527e-02   -5.804475141229080e-02   -5.482737536922244e-02; -1.478886284704620e-02   -6.687807711060904e-02   +2.306509834733003e-02   -1.395284327847560e-02   +3.919157046241079e-02   -3.443818853990018e-02; +8.461831215246900e-04   +3.209195433582553e-02   -4.603197335429263e-02   -1.026990663057301e-02   +2.313998022848457e-03   -9.878955590141514e-03];
L5_Input1_iAMPA_netcon = [+5.370124635689730e-03   +4.277211991620589e-02   +3.485887663770808e-02   -2.317361244567975e-02   +9.078970216026589e-03   +1.661487079055797e-02];
L6_Input2_iAMPA_netcon = [+3.972326451263672e-02   +2.302375814129513e-02   -5.950806633398097e-02   +1.842429748273988e-02   -1.327776706773992e-02   -4.516586826987048e-02];
L5_L6_iAMPA_netcon = [+2.449181546179335e-02   +1.532091563167678e-03   +7.956096811001219e-03   +3.382119633361569e-02   -1.183449179964676e-02   -3.016940379603867e-02; -9.265284097720883e-02   +3.602300908157104e-02   +9.596534529097350e-03   -1.745018976245846e-02   -2.743857011509258e-03   +5.613421949009711e-02; +2.705365531424617e-02   -2.212065192967464e-02   +9.625628705913457e-03   +5.449071814795986e-02   +8.601773971210226e-02   +4.307455172334854e-02; +3.408010767966846e-02   +1.051880404133026e-02   +5.542639947790371e-02   -6.806267500909033e-03   -5.107914448420745e-02   +2.941392843225299e-03; +7.858397064401737e-02   -1.315215863222811e-02   -6.887962090969776e-03   +5.588648695515459e-03   +8.167425608128911e-03   -5.394978740493601e-02; +2.178467769294683e-03   +2.034336094900042e-02   +7.557420076026732e-03   -1.060996583421837e-03   -1.082777394330014e-01   +9.271311765553845e-03];
L4_L5_iAMPA_netcon = [+7.948853710030543e-02   -1.576725201287747e-02   -5.388191678278961e-02   +1.170721421054927e-02   +1.887935248636505e-02   -5.794277661617404e-03   +7.002333832798088e-02   -1.800556327900881e-02   +1.996002253661772e-02   +1.375928833265254e-02   +4.998572635238915e-02   -3.082740666377878e-02; -1.155541482655830e-02   -1.666339232385747e-02   -6.091818944452158e-02   -7.079509256155223e-04   +4.226501012410686e-02   +1.838223876397248e-02   +4.214733583630628e-02   -1.683020736545637e-04   -1.090837960702782e-02   +3.076294847887917e-02   +1.461775732270712e-02   +2.305269426622009e-03; -1.873010260906656e-02   +4.008287407253523e-02   +4.522591751558175e-02   +1.208260435341009e-02   +7.143078494635626e-03   +6.837946169342798e-02   -2.343085045895380e-02   +5.103557228817420e-02   -2.339750316138758e-02   +6.042018577634019e-02   +3.316719307422103e-02   -2.303065664141594e-02; -4.944467338826234e-02   -7.655673135226491e-03   -1.851893367129823e-02   -1.112252314901889e-02   -4.587579853812526e-02   +7.344324682644623e-02   +1.293069182371015e-02   -4.147503188896617e-02   -2.317636563428199e-02   -1.924653081676393e-03   +6.858590805550513e-03   +8.203379260712551e-03; -7.220765685966414e-02   +1.338879691542902e-02   +1.742750671962940e-02   +2.136310998533934e-02   +4.135751724060607e-03   -2.890015596765958e-02   -3.085748014585353e-02   +2.237017966875844e-02   +4.871732937514417e-03   -2.751832332623237e-02   +1.293517585982164e-02   +4.232419219912052e-02; +2.239358454142602e-03   -7.710271567922984e-03   -2.627466254411309e-02   -3.866460322049274e-03   -4.885570164462379e-02   +1.080946466204204e-01   +5.829966435514072e-03   -6.057226763540274e-02   +4.834166135028890e-02   +6.713880009096719e-02   -6.495466001732406e-03   +2.433777526390898e-03];
L6_L4_iAMPA_netcon = [-6.013283812482124e-03   -4.290172952334127e-02   +5.270850338712572e-02   -1.431417425517747e-02   -7.481599337208215e-02   -4.185903877007578e-02; -3.046861183299422e-02   -6.956992693394057e-03   +2.944938545494342e-02   -5.963589578371821e-03   -3.937631502827526e-02   -4.542341113453077e-02; -2.784730409344717e-03   +6.451326670630587e-02   -1.882489581777189e-02   -1.630361399351584e-02   +6.295755739576767e-02   -1.470223749308953e-02; -3.216978301529552e-02   +1.892224531643776e-02   -1.040871152064599e-02   -1.782977394006521e-02   -1.351974947271047e-02   -5.463998646425622e-02; -2.601491960841298e-03   +3.439650407078848e-02   -9.138130720328846e-03   +1.459639154311990e-02   +5.336750869243605e-02   +9.914206417902775e-02; -1.523311108940481e-03   +6.794715770872388e-02   -9.485108770471044e-03   +1.168639359686197e-03   +1.172384401196850e-02   +1.148054377167612e-02; -2.074350655252578e-02   -3.598187061879136e-02   +3.854669369823596e-02   -9.693766759916854e-02   +6.485484073874540e-02   +7.062768562342164e-02; +2.235194497239645e-03   -2.217535508121878e-02   +1.269255646976978e-02   +1.153674815005915e-02   -1.471085448463795e-02   -1.732952894707617e-02; +2.034082986854037e-02   +6.611483774475839e-02   -1.898690799713788e-02   -2.775693292349989e-02   +6.237201100547606e-03   +1.890451789847991e-02; +1.061592164295375e-02   -1.503436998828367e-02   +4.430179930222251e-02   -2.372043758043074e-02   -2.269114136645376e-03   -1.257424944512998e-02; -2.339465117616552e-02   +2.739412602783155e-02   +3.520932656015486e-02   +5.925639393345386e-03   -1.082705357036202e-03   -4.123504526826043e-02; +1.627916046222588e-02   +1.631232869010471e-02   -9.896995750426966e-02   +1.997429619378172e-02   +2.812954008652876e-02   +8.394797196594190e-03];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
