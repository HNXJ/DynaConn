function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.178061674363773e-01   -1.770628074190185e-01   +1.940637807192681e-01   -8.520380270141441e-02   +1.962518134791230e-01   +1.920081539635687e-01   +3.065045858461362e-01   -4.089970844153216e-01   +2.510728616259477e-01; +2.894830419510270e-02   +7.329581373513247e-02   +1.796434215237366e-01   +5.973152281181656e-01   +2.780222399693594e-02   -5.982142242010995e-02   +1.248877768307148e-01   -3.374373760180185e-01   -3.587834286997220e-01; +2.639284681930908e-01   -6.814627748309916e-02   +8.457093069459147e-02   +1.203532380393995e-01   +4.595684139139964e-02   -5.793377867363132e-02   +1.581145801126599e-01   -4.278510751638542e-01   -6.071002855885472e-01; +1.771003258861631e-01   +1.584744011750454e-01   +5.487013038483893e-01   +3.120579700961585e-02   -3.276068048132117e-01   +2.609032584968531e-01   -2.182266391174213e-01   -1.778988490462791e-01   +4.086258219302003e-01; -2.117210108651545e-01   -3.625750954403824e-02   -2.985703109993942e-01   +5.464995953917615e-02   -2.883925033474077e-02   +4.345872155538363e-01   -4.883968903410115e-01   +2.925049303450480e-01   -1.639068432797601e-01; +5.034752228362085e-01   +2.447882274824149e-01   -1.117661501422342e-02   -3.140949361042700e-01   +6.080387372439693e-01   -8.861914765669392e-02   +1.765692824478680e-01   +1.426856479174125e-01   +1.591755711064255e-01; +4.259545699521300e-01   +3.104086774232741e-01   +7.390487951489790e-01   -5.291985367097100e-01   +1.802768147730496e-01   +9.257364700183834e-02   +3.373479934283027e-01   -4.785709975444012e-02   -1.599038721307143e-01; +6.071192388914972e-01   +2.775544448259032e-01   +3.442427643766198e-01   +2.963611835251077e-01   -1.993786824458204e-01   -7.624732467320632e-02   +2.012848475623952e-01   -3.316324376051931e-01   +3.748147429583442e-01; -3.451458171680247e-01   +2.419198049974237e-02   +1.000000000000000e+00   +3.669761696001813e-01   +5.401056038438820e-01   +1.432761659818642e-01   -9.879830593552720e-03   -1.534567082689001e-01   +4.169411833603524e-01];
L1_L2_iAMPA_netcon = [+5.088896639278571e-01   +4.258162844116001e-01   +2.077952949480762e-01   +3.124392087936807e-01   +2.512233267197230e-01   -2.744560451680719e-01   -5.491750376461879e-03   +7.068118080028121e-02   +3.924347741846526e-01; -3.118224795807603e-01   +4.560807892014594e-01   +3.940204906675663e-01   +2.106610750233099e-01   -5.848180964355723e-01   -2.961199416264247e-01   +8.993340053630960e-02   +2.167756772158375e-01   +6.235659285964505e-01; -5.683389729044876e-01   -2.721476873608057e-01   -5.692347542789358e-01   +4.456159979241845e-01   +2.838602857520824e-01   +2.684754984241478e-01   +5.079247973990730e-01   -5.594017677076599e-01   +7.714540958748217e-02; -3.491269298711346e-02   -4.634089492323958e-01   +2.925546573620090e-01   +8.471544879150380e-01   +2.308337526002951e-01   +7.236326765835716e-01   +1.470196630088913e-01   +4.568417035373201e-01   +8.578729574122868e-02; -3.274141458051812e-01   +2.262916865901316e-01   +2.708666730569891e-02   +2.399510222044254e-01   -1.065709921096945e-01   +2.820614149440114e-01   -2.608271248354382e-01   +1.855970587492649e-01   -1.760753318474043e-01; -2.089864488143576e-01   -1.016972832365979e-01   -8.339361965683156e-02   -6.098478380064928e-01   -4.428441766936638e-01   +3.634140779462312e-01   +6.054833941043419e-03   +5.535059447466539e-02   +4.907353724803207e-01; +2.377604968470138e-01   -1.951375465974929e-01   +1.454428456779440e-01   +1.955144065687627e-01   -4.552908942730147e-01   +6.446663819220336e-02   +4.718419411149918e-02   +2.146626908600182e-01   +3.279805095069708e-01; -1.564854065794713e-01   +8.726316664610018e-02   -4.654119814755140e-01   +3.556500635893296e-01   -1.221221959032944e-01   -1.367873379143346e-01   +3.461911364400841e-03   -3.265404541895005e-01   +3.546676068007408e-01; +3.589294547444455e-02   +1.192634969430572e-01   +4.783312452493705e-01   +1.749500152045518e-01   -9.538195158397407e-01   -1.151635045063458e-01   +2.066762779624625e-01   +3.720518274333946e-01   -1.101394419725307e-01];
L2_L5_iAMPA_netcon = [-2.263171427697274e-03   -2.335618824106465e-01   -4.122374817370695e-01   +1.066411576368406e-01   -1.308028392941216e-01   +3.922199671167604e-01   +6.884443677823054e-02   +4.370521142418257e-01   -1.126924563579762e-01; +2.081367570547293e-02   +5.983333232191839e-01   -2.826788724131308e-01   -1.961991730859863e-01   -4.936358681229982e-01   -2.875738967286714e-01   -2.147272809600190e-01   -4.165683257769293e-01   +3.709475837954590e-01; +4.416059972867772e-02   +4.865037963678380e-01   -4.355751972304625e-01   +1.564911204442166e-01   +3.197834587903254e-01   -3.626515436515859e-02   +1.159323334860061e-01   -2.106941164370195e-01   +7.216572338553067e-01; -6.824659311450604e-02   +3.265698373363202e-02   +1.767123154852057e-01   -5.228655840975633e-01   +3.891931466339204e-01   +8.025407013933170e-01   -7.886808405955051e-01   -4.142973171316705e-01   +5.203134532144372e-01; +4.648218217700117e-03   -2.375101481400218e-01   -3.308984319198710e-01   +3.020512811844502e-01   -1.857493085255423e-01   +5.116092386949251e-01   -4.183693866288146e-02   +1.794778083111628e-02   -4.037893299348920e-01; +2.561335041310803e-01   -2.754755331521276e-01   -6.401313285249655e-01   +1.186824788022614e-01   -1.578272337131527e-01   +2.190230637061191e-01   +1.672406987640703e-01   -5.633046200944383e-02   +2.007133324739611e-01];
L5_L2_iGABA_netcon = [+4.616926937012250e-02   -5.739481168276708e-01   +4.197193152252960e-01   -1.723668050022675e-02   +9.944399598363088e-02   +9.954862795115448e-02; -4.328891954485081e-01   +1.870877845615696e-01   +4.944678140141843e-01   -1.606914291459248e-01   -3.936854874206007e-01   -5.306581564965560e-01; +2.769472905980264e-02   +3.909856230559856e-01   +2.505550747371639e-01   +2.926703232975157e-01   +6.730910112068256e-02   +1.462103961310458e-01; -6.187113404429573e-01   +6.292156662179270e-01   +3.895300385849325e-01   +3.737755189254874e-01   +1.530702898858161e-01   -3.747876081214598e-01; -5.914877273055515e-01   -1.599131475014547e-01   +3.299607318907911e-01   +9.519906968613601e-03   -4.693343213295187e-01   +2.981822403287155e-01; +7.751132461897826e-02   +2.209551897153883e-02   +2.223376175347360e-01   +1.634773933390890e-01   -3.263063678864307e-01   -3.559788850680101e-01; -4.114455101297445e-01   -4.755491222029453e-01   +1.275673217855963e-01   -3.599973360931205e-01   +2.135056639864406e-01   +4.570244434067064e-01; -2.204803035284932e-01   +1.524474881347260e-01   +3.329243813923473e-02   -3.537056145099750e-01   -4.184217460659614e-01   -5.621849173378042e-01; +1.979371262586684e-01   +2.918020910798812e-01   +2.082225042011873e-01   +8.341257497315238e-01   +9.433699781360546e-03   -8.981062970724241e-02];
L3_L2_iAMPA_netcon = [+3.446533399216017e-02   -1.001339318914016e-01   +2.263918818158971e-01   -2.447583142219165e-01   +5.402968114496931e-01   -2.665227757221492e-01; +1.007209802731197e-01   -3.615401745855261e-01   -1.310718973523683e-01   -1.971901486589907e-01   +2.501034631392314e-01   -4.991915970830738e-02; +1.862373558908944e-01   +4.115639579273314e-03   +2.028882646944964e-01   -4.191994281145922e-02   +2.580066954835681e-02   -3.325521472961367e-01; -4.202937373851098e-01   -6.134049984981940e-02   +1.639342771311134e-02   +3.268424870005307e-01   -1.020692994523635e-01   -1.134968241715648e-02; -4.087793758413473e-01   +6.594478022690523e-01   +8.289575474510607e-01   -7.743977475479277e-02   +2.780399228229641e-01   +1.512722882591180e-01; -4.425827405579916e-01   +5.885002913295563e-01   -8.355445253101446e-03   +3.393053195882082e-01   +9.936514685648948e-02   +2.273480019630159e-01; -2.724127583599623e-01   +1.346947883626975e-02   -6.299978214072047e-02   +1.817760037927323e-01   +1.170731451769511e-01   -6.022143093671398e-01; +2.466889435006179e-01   +3.164646594976803e-01   +9.958018372328598e-03   -2.700826756890444e-01   +3.330471058148579e-01   -4.497292581209827e-02; -1.407415157889942e-01   +2.149181878067921e-01   +1.115641652485190e-01   +7.584890031997531e-02   +1.395574195423058e-02   +2.465496914566916e-01];
L2_L3_iGABA_netcon = [+3.766348609047533e-01   -1.347324506931590e-01   -5.472876215235709e-01   +1.061988993960276e-01   -3.710954721753730e-01   +3.256968936299437e-01   +3.160941924185536e-01   -2.732553528928441e-01   +4.246952844722537e-01; +1.931719993882711e-01   -3.179788222756370e-01   +2.184561321300533e-01   -1.022350871820922e-01   -6.472620868443972e-02   +2.494287209528259e-01   +4.503146706620092e-01   +1.189068207661303e-01   +4.531804996566669e-01; +9.170810862610673e-02   -4.858065746225493e-02   +4.068184880735208e-02   +7.370586742856400e-02   +2.732011876348018e-01   +1.546840778893833e-01   -1.800276678492000e-01   -5.047048660992579e-03   +4.968776890723214e-01; +7.069260368894835e-01   -3.059596261664924e-01   +4.944825176724639e-01   -4.921452429013596e-01   +2.683907278881525e-01   -2.834570071869388e-01   -1.117560719315527e-01   +1.926368916638443e-03   +3.545910495024288e-01; -4.005846753860998e-02   +7.385674191277070e-02   -4.037234946124730e-02   +4.235539930043614e-01   +1.358885534346430e-01   +6.957076031899935e-01   -6.522876619857614e-01   -5.195706308818731e-01   +8.501850087484991e-02; +7.599130793077629e-01   +2.581998418978515e-01   +2.040246996197250e-02   +2.514310180563237e-01   -3.004812262658642e-01   -4.356915740534485e-01   -2.608490844651968e-01   -7.046014772793987e-01   -3.459617950702865e-01];
L1_L4_iGABA_netcon = [-3.696576090072724e-01   -7.454023207672453e-01   -1.898566799959070e-01   +3.408728179842019e-01   +4.913104620368253e-01   +3.653477293744580e-01   -2.852178239597216e-01   -2.518766721986738e-01   -8.929499334413871e-02; -1.189901279977745e-02   -5.120309595730603e-01   -2.132231490241149e-01   -1.413442009916378e-01   -3.168646452360344e-02   -3.175437091540035e-01   +1.598718847119545e-01   +5.302138726564828e-01   +2.249960595369377e-01; +2.965974173614436e-01   +6.684406235601855e-01   +2.563143322611977e-02   +6.497585248231763e-02   +2.065647670701244e-01   +1.232616000375182e-01   -5.333570355768098e-01   +2.085566233613947e-01   -3.490018130337046e-01; +4.774886222765288e-01   -2.851765314667570e-01   -4.405823126682347e-02   +9.666015038428427e-03   +5.373708687490375e-02   +5.009199956366025e-01   -5.995546599800169e-02   +2.920382652742958e-01   -3.119985489008720e-01; -4.125032112957414e-02   +2.984722203546175e-02   +5.720929363283826e-02   +4.160599017448121e-01   -2.148539108510976e-01   -1.990880793058233e-01   +1.595000336442354e-02   -1.958490270121112e-01   +3.369676516814685e-01; +3.906046082080201e-01   -2.490148398688335e-02   -8.117295107687748e-01   +7.618203817840072e-01   +1.262383454730944e-01   -1.548626148970165e-01   +3.921044957276549e-01   -6.741444310471967e-02   -2.977707539883382e-01; -7.480569203949100e-01   +5.419044903598396e-01   -5.018915158380275e-01   -1.843180656389313e-01   +7.295751421381711e-01   +6.905943739665240e-01   +8.356812134337979e-01   +1.155422911053522e-01   -3.888210139346774e-01; -3.824175976508938e-01   +2.614443242001460e-01   -2.092125476455584e-01   -2.241635527193055e-01   +5.111444547506501e-01   +4.049348289097127e-01   +8.187795262510921e-01   +3.790815178779343e-01   -4.810005913928413e-01; +2.021183988242808e-01   +2.491357537218613e-01   +3.018014010693897e-01   -1.121022800720256e-01   -4.962091245258707e-02   -2.941991542489319e-01   +3.455639023613461e-01   +6.461423343943202e-01   +2.647365077498695e-01; +3.626494232665456e-01   +6.088924082767992e-01   +1.104109868233672e-02   +1.676523428391339e-01   +1.630257336233448e-01   +3.134615974830330e-01   -2.241909725896117e-01   +1.507417491312212e-01   +6.272341009490884e-02; -4.664912402500312e-02   +3.658576237620913e-01   -5.060032577666939e-01   +8.935034529151556e-02   +2.438869018386714e-01   -5.144258462091034e-02   +2.501008123114842e-02   -3.294646857276103e-01   +7.483702043849535e-01; +4.978442182987429e-01   -1.349297831316880e-01   -3.599916098807096e-01   -3.326001692512855e-01   -7.010367189956273e-01   -8.948768641839142e-02   +1.060431362187380e-01   -1.568872726036364e-01   -5.547664754228608e-01];
L4_L1_iAMPA_netcon = [+3.041347560762435e-01   -3.329924065586918e-01   +6.933732468827518e-01   +4.007988999715466e-02   +9.554038570651746e-02   +1.954549780318389e-01   +6.626878033941055e-02   +9.253446974383124e-02   +6.263949357359605e-02   +1.147718205637214e-01   +1.674953203914628e-01   -1.579111508960960e-01; -2.145592849445169e-01   +6.243030075674146e-01   -7.796976189321915e-02   +3.468635889096884e-01   -2.257268235216082e-01   +6.853716140050792e-02   +6.987446531649294e-01   -2.444952184276084e-01   -8.077990275502569e-01   +1.176542311121382e-01   +1.581106632669357e-01   +1.000000000000000e+00; +2.486285890256780e-01   -1.674293086662419e-01   +5.933538379249754e-01   +1.374997715101440e-01   +4.791709371781753e-01   -5.029705733031514e-02   -1.279641085643927e-01   +2.622935491739797e-01   +1.850789456128446e-01   +5.034879240565183e-01   -1.172153032977591e-01   +1.352229291162384e-01; +5.785218835279141e-01   +3.583888195062642e-01   -4.603084875529517e-01   -6.108625569962617e-01   +2.027123000306796e-01   +2.969855168306002e-01   -1.652055631730029e-01   +2.646452688917257e-02   -4.156667877865244e-01   +2.191813291830441e-01   +7.887234448018101e-01   -4.477609912698432e-01; -7.664778420465998e-02   +3.358551596057009e-01   +5.515477303239259e-01   +2.716681903072228e-01   -1.687139901228868e-01   -2.304687187979162e-01   +3.550334863237280e-02   -9.586391863639507e-02   +5.978816763476136e-02   +1.964852770365166e-01   -7.073335636947969e-02   +5.075425693905641e-01; -5.258604798164900e-01   +6.283160684700726e-01   -1.671970123557680e-02   -9.859158650440131e-02   +3.716465720808882e-01   -9.730120516660057e-02   -5.885726826288974e-01   +6.903234286197244e-01   -2.150383269993946e-01   -3.668691434362636e-01   -4.813068813559192e-01   -1.085081880347385e-02; +3.111377775539952e-02   +6.940103807071628e-04   +3.978443796603202e-01   -8.076607621244930e-03   +4.757306127876570e-02   +5.005596768203876e-01   -1.733722929457826e-01   -1.025274749106223e-01   +2.265625330925293e-01   +2.920687130297985e-01   +2.028617890770372e-01   +1.257758876818167e-01; +2.224339998365127e-01   -1.890106098171277e-01   -1.315626488192470e-01   +4.269056978787495e-01   -2.512036008922510e-01   +5.284526556570288e-02   -1.231491766461360e-01   +3.169550626124603e-01   -7.279707599217493e-01   -3.915106181468397e-01   +1.256487553197765e-02   +6.924798928907719e-01; +3.500270111631029e-01   -2.059107591987266e-02   +4.464842822321142e-02   -2.909915946412801e-01   -1.383733087816280e-01   +3.131207597091277e-01   +1.288976779127009e-01   -8.394241679118652e-02   -2.382217064813339e-01   -2.329770343099267e-01   +3.952284648998736e-01   -4.708917427150663e-01];
L1_L3_iAMPA_netcon = [+2.774529449524373e-01   -6.122324613165049e-01   +3.763791327037509e-01   -2.218509236772567e-01   -1.417087044496903e-01   +2.069297907501293e-01   -3.057056732988290e-02   +2.327965990329686e-01   +8.362501997437172e-02; -2.001365374007514e-01   +1.537779063297150e-01   +4.029445632238520e-01   -2.141493228298241e-01   +2.634970446727111e-02   +3.465845928083744e-01   +1.942385180218356e-01   -5.378244991105844e-01   -9.223082488233562e-02; +6.243539943899761e-01   -1.894491512245394e-01   +1.023134202393947e-01   -1.687277385309872e-01   -1.208469031077019e-01   +5.261900649572226e-02   -2.635908679321822e-02   +1.278553155248522e-01   +2.343819781162960e-01; -1.734313750789793e-01   -4.383572785763062e-01   +1.160425678518256e-01   -9.137439628502809e-02   +1.118045801336292e-01   -3.639909016836658e-02   +1.566517253335548e-01   -1.464202404127952e-01   +1.703804961117175e-01; -3.740314607490991e-01   -1.538185191178941e-01   -3.005090685094847e-02   -5.200543171215966e-01   +4.839013958785324e-01   -3.423859882139682e-01   -5.037379834952929e-01   -4.593264898763055e-01   +5.907456610930342e-01; +3.510157522269283e-01   -2.027050339986616e-01   -1.074742003494964e-01   +4.069164389811866e-01   +3.033887719099705e-01   +4.006478848782739e-01   +7.703727913589425e-02   -3.418727085647809e-01   -4.369465142256354e-02];
L3_L1_iGABA_netcon = [+2.226500563599613e-01   +1.942620162418346e-02   -9.518454625273676e-03   +7.900826621356719e-02   -1.612341603432263e-01   -4.097216603636188e-01; +6.832920790883068e-01   +1.323796497414958e-01   -4.191911636824808e-02   -7.245302455924518e-02   -3.834983089565652e-02   -2.175683583940943e-01; -8.521378363902091e-02   +1.027888197173761e-01   -4.091910835286294e-01   -3.742169857697857e-01   +2.619723673465523e-01   +1.297308554307929e-01; -2.173693584557009e-01   +1.095123861857920e-01   +2.176666613010845e-01   +1.555391899100357e-01   -6.268343735940651e-05   +1.225011723796831e-01; -2.015489508931166e-01   +4.788031775645341e-01   -3.616150949519890e-01   -1.222348963388132e-01   +7.086145040111411e-01   +2.145711690356894e-02; -2.532153913828069e-01   +3.830045000520352e-01   -1.329052406363811e-01   +8.836088645580442e-04   +2.377513658687122e-01   +4.253529190271936e-01; +2.581043663502930e-01   +2.291855383984004e-01   +1.999997412859097e-03   +2.063512712719779e-01   +9.142482058150107e-02   -3.596925736304896e-02; +1.784672736012149e-02   -5.130130973025713e-01   -3.990981113925506e-01   -5.670960094950037e-01   -1.342389352880825e-01   +7.906235621337125e-01; -4.748038148182925e-01   -4.144592240766158e-01   -1.548468661475326e-01   -3.294319278714325e-01   +3.140441892606938e-01   -2.489147415673468e-02];
L5_Input1_iAMPA_netcon = [-6.596598772662869e-01   -2.494514016508825e-01   +4.104528605408806e-01   +6.513346119042220e-02   +2.593838981062212e-02   -4.277918528463152e-01];
L6_Input2_iAMPA_netcon = [+5.067396798805779e-01   -3.343853106872406e-02   +1.488925475385496e-01   +8.463494742965369e-02   -4.125924687088330e-01   -4.444967527451660e-01];
L5_L6_iAMPA_netcon = [+4.995750736251639e-02   -1.039429733599089e-01   -2.343509889414046e-01   +2.572279694095985e-01   -5.225764339726676e-01   +5.693000408313718e-01; +3.394495677854270e-02   +1.265153306751323e-01   +5.121243960182319e-01   +3.919600229797688e-01   -1.258303067003115e-01   +2.029645207293453e-01; -1.854754922798731e-01   +5.900026111140442e-01   +1.349316747476366e-01   -1.674335429827468e-01   +4.321608888253593e-01   -9.042492565272091e-02; -6.642594835889496e-01   +2.670605187529048e-01   +4.368433467696444e-01   -2.401612550905603e-01   -5.233300031628765e-01   -2.457708579274556e-01; +5.142269395824378e-03   -4.036038672426841e-02   -4.718124327865406e-01   -1.855763943331807e-01   +3.454595342822057e-01   +1.436620928947849e-01; -7.347533368540740e-02   -3.614365163163757e-01   +5.461311668400806e-01   +4.873521550677917e-01   +1.353439322078991e-01   -6.583683193196967e-01];
L4_L5_iGABA_netcon = [-1.703011694732175e-01   +4.825665698594961e-01   +3.142414768949922e-01   -3.032439362431215e-01   +3.015587935544195e-01   +4.213940142333850e-01   -1.295782815936946e-01   -1.816358149402092e-01   -2.358847241432316e-01   -4.968245991558967e-01   -5.654639861618800e-01   -2.255766978521384e-02; +2.628164060338393e-01   -2.929327824165849e-01   +5.578854793806111e-02   +2.222134052040998e-01   -8.506894035721668e-02   +1.192222027850311e-01   +5.963287829889942e-01   +1.153766057787158e-01   -3.130354631770458e-01   +6.225645793304709e-01   -3.824212437628314e-01   +2.840326601555151e-01; +1.789467349687905e-01   -3.444369876794469e-02   -4.702052746997232e-02   +4.195349649715258e-01   -7.979694039141503e-01   +6.381434029141415e-01   -7.878822716469577e-02   +4.563493247207543e-01   +3.181534405066564e-01   +5.665293296411564e-01   -1.179051757101224e-01   -6.136345829895282e-01; +1.529688825311518e-01   -3.434214804038577e-02   +4.650060372835610e-01   +5.904288314072396e-01   +6.519584567475481e-02   +5.681711931298656e-01   +2.012461541756248e-01   -3.911010979019357e-01   +2.024510393908490e-01   +3.524132491734866e-01   +3.343442145165302e-01   +1.566441317282656e-01; -1.253574345111532e-02   -8.886469173709077e-02   -6.331276536664816e-01   -1.543365284093249e-01   +4.473208492282279e-01   -1.211877062221684e-01   +1.915358796701455e-02   +3.915583345128865e-01   -1.149207729819728e-02   +2.489764717135712e-01   +4.033586142869874e-01   +9.201105137753340e-02; -1.304377093041133e-01   -4.141391686592220e-01   -1.267584741387693e-01   -1.215355554132140e-01   +5.806233540980060e-03   +7.902015127215539e-02   -2.097273727805938e-01   +6.106232600089679e-01   -4.295263354884818e-01   -3.886040022089597e-02   -4.970555625119384e-01   +2.709428132309866e-01];
L6_L4_iAMPA_netcon = [+2.584334631193120e-01   +1.141920217615637e-01   -6.312253469576519e-01   -3.300875085827670e-02   +1.158363515735043e-01   +5.634734316042772e-01; -2.677220155487882e-01   -8.695463516490519e-02   +2.882242486678276e-01   +5.112613736012852e-01   -2.063802735080992e-01   -3.037015344287577e-01; +6.400217699844929e-01   -2.606422144345499e-01   +1.911588910271206e-01   +5.144854884210656e-01   -3.071255807277322e-01   +6.724325907771335e-01; -1.029108974008042e-03   -1.364973238859880e-01   +4.000259389038036e-01   +2.804841644683829e-01   +3.256220604814764e-01   +3.065831481523981e-02; +1.872421679747974e-02   -9.700697963757544e-02   +7.178410862178639e-01   +4.195780004799785e-01   +1.641621595941297e-01   +6.396599841963363e-02; -2.309069186518788e-01   +6.273804871888073e-01   +2.017372272308213e-01   -1.538894392285999e-01   +7.018689596849282e-01   -1.032892706816686e-01; +7.982764776864283e-01   +1.621638614021035e-01   +1.045073020503212e-02   +3.692548813586864e-01   -6.825288024564079e-02   +8.168756721031736e-02; -1.145268325048595e-01   -5.671265160479558e-01   -3.073309241034875e-01   +1.832160083314908e-01   +3.369251312211021e-01   +1.340881499079503e-01; +3.115618555392901e-01   -4.567555171318766e-01   +4.316788505370710e-01   -7.226035168765510e-01   -6.491392146248834e-01   +1.339435725053995e-01; -3.811589092809810e-01   -4.534160186752481e-01   -5.806816330813522e-01   -5.947290978824207e-01   -6.955145687063263e-03   +3.373933124764719e-01; -1.614492202144421e-01   +2.570005215593961e-01   -3.885394572674642e-01   +2.678037089486159e-01   +2.784637045427976e-02   -1.252939748250397e-01; +2.337572380116254e-03   -4.889441079534900e-01   -1.375144400421641e-01   -1.146522926142215e-01   +3.869132368800212e-01   -1.835516399461165e-01];
L5_L4_iAMPA_netcon = [+6.832257255393869e-01   +5.053050299693320e-01   -4.206159532098065e-01   +9.697617782843890e-02   -1.726316066734043e-01   +1.324586966308769e-01; +3.757487961483016e-01   -6.022081045053561e-02   +1.646576567082708e-01   +2.896355972069858e-01   +6.058401835918317e-01   -3.210299248588001e-01; +5.120935128611999e-01   +9.267206375442555e-01   -1.667598319481168e-01   +3.260410042975870e-01   -3.087200021860698e-01   +2.652279520909795e-03; +3.473821920549602e-02   -2.013168486842736e-01   -1.207736580718066e-01   -5.725811572539199e-01   +2.157370976954197e-01   -4.175130140014124e-01; -3.715507921067980e-01   +1.545592332347066e-01   +1.520336732848241e-01   +7.566098490450540e-02   +1.268082300015008e-01   -3.795859713061528e-01; +6.239985225992359e-01   +1.642543983187491e-01   -3.363738353653380e-01   -2.936570363422543e-01   -3.333766480924920e-01   -1.506210791318185e-02; +4.468255944143409e-02   +3.598293247721795e-01   +5.368757231376038e-01   -2.487303441755120e-01   +4.328606161844576e-01   -1.365268133434921e-01; -2.112511939501919e-01   +6.452433669954609e-01   +3.318547589790607e-01   +8.121373623831847e-02   -1.853076531503622e-01   +6.206934296818647e-01; -2.109202053466331e-01   +3.063595648400644e-01   -1.565519542857875e-01   +4.038658122258016e-01   +3.115104736476613e-01   +3.584057345548550e-01; -3.145922918996273e-01   +3.975392614353249e-01   -6.217860806560891e-01   +6.139554028191881e-01   -2.334423878814009e-01   +8.150578730284215e-02; -1.732833987930488e-01   -5.672663194190282e-02   +1.971239563161270e-02   -2.424704414255957e-02   -2.987302467135631e-01   -4.175150164905765e-01; -2.831253049778490e-01   +3.234520172785137e-01   +6.915559891027048e-01   -6.433792303158016e-01   +3.927805030841842e-01   +4.099571375380818e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
