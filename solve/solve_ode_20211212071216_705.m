function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.771049336033391e-01   -5.412094414172770e-02   -1.798899023055283e-01   +1.218267103023530e-01   +5.240510963614412e-02   -7.840142749208390e-02   +5.595578349505172e-02   -1.055094686332003e-01   +1.095363418999715e-01; +1.634898745232647e-02   +1.738228645759779e-01   -6.002312542578501e-02   +4.529662322967806e-02   +3.805341071799083e-02   -7.306437840820068e-02   +1.971644152509953e-01   +4.322913325789907e-03   +1.065583852081041e-01; +7.043499554861268e-02   -1.026734999291763e-01   -1.307179614136158e-01   -1.079703527589697e-02   -1.890095219029569e-01   -5.001223946790555e-02   -2.815059389640467e-02   -1.192625673369522e-01   +9.859048464125567e-02; -7.747477338801126e-02   -4.767589582851195e-02   +1.083416418079604e-01   -1.059608907697317e-01   -8.750213289769346e-02   +8.113846331947602e-02   +7.932539336871708e-02   +2.933952713945671e-02   +2.143498365680129e-01; -1.552635282184179e-01   +5.727318824391120e-02   -1.696668997654183e-02   -1.005052238972119e-01   -6.009800695094943e-02   -1.425090658908670e-02   +1.009208371433143e-01   +5.339862686111294e-02   +3.582116135961874e-02; +1.342588561393633e-01   +3.089239589374869e-03   +1.947817914385119e-02   -1.016872247611129e-01   +6.740713076947800e-02   +2.433218173631953e-02   +8.526398901544152e-02   -9.750662799397014e-02   +1.879887696145291e-02; -5.564323162217894e-02   +1.872846124746308e-01   -3.932916490924518e-03   +4.529112134923516e-02   +1.025202408370922e-01   +9.170606323918382e-02   +4.177512635910111e-02   -1.051369982541746e-01   +9.458940384341197e-02; -8.446274709612314e-02   +5.412385066486849e-03   -1.647244558005729e-01   +3.781574909166474e-03   -2.244996496027925e-01   +3.924235931479135e-02   -1.486594569264188e-01   -9.695625765788959e-02   +1.571518500173041e-01; -1.898318530159853e-02   -7.291395115829266e-02   -4.560999396561746e-02   -1.654398583077485e-01   -9.159918020821173e-02   -1.079387986774557e-01   +1.023256690311386e-01   -2.526097149116462e-02   +9.795437245255852e-02];
L1_L2_iAMPA_netcon = [+1.404085010266770e-02   -1.069979937818847e-01   -1.422151047481941e-02   -1.387880410811068e-01   +9.383375188265476e-02   -2.174548487224142e-01   +6.213953272324194e-02   -2.942004812002772e-02   -7.975290764102744e-02; -5.004105090202404e-02   +4.375301683796841e-02   -1.206188138164958e-01   +1.020507393262404e-01   -2.651709696640645e-02   +1.454819808384274e-01   +5.511056074683124e-02   -2.300434997955064e-01   +5.184750579772843e-02; +1.402522603214376e-01   -4.707190414407828e-02   +4.230559517309580e-02   -1.240546258574550e-01   +2.258605770297744e-02   +1.048783242006949e-01   +1.706370459369606e-01   +9.530398836531137e-02   -1.030911500573156e-01; -6.461534167884177e-02   -2.317099278716910e-01   -1.034026038510436e-01   -1.222465345133872e-01   +1.545643016776188e-01   -5.291749060118699e-02   +6.898744034925398e-02   +8.467111253771503e-02   +4.333960315530180e-02; -5.980551697713584e-02   -9.540092114086657e-02   -1.467062509636425e-01   +4.846330647697225e-03   -7.419649226026589e-02   -2.866176454418566e-02   +2.133016604938535e-02   +1.457614726679309e-01   -1.753112984583942e-02; +1.569518435475600e-01   -1.423366831278575e-01   -1.038295286230685e-01   +1.772657366466490e-01   +4.659441640659229e-02   +3.204866311680638e-02   +9.887602423713653e-02   -1.365745985981133e-01   +1.008698962303516e-01; -6.175710070987288e-02   -3.710121430528077e-02   -1.682014251467809e-01   +8.154818377281189e-02   +1.964636849813824e-01   -1.860502958457898e-01   -1.048450608618225e-02   +3.170735803284822e-02   +1.502414896128881e-01; -7.593973030521009e-02   -1.396895686359534e-01   +4.232807851912584e-02   -4.632888471255470e-02   +1.276241629221736e-01   +1.545078590594630e-02   +6.593053993091978e-02   +9.363921717221495e-03   +1.813479482558303e-02; -6.108827235759170e-02   +7.556257805103656e-02   -9.812050101132480e-02   -4.644416317142852e-02   +1.134862138964767e-01   +2.456022233703296e-02   +1.325203939068995e-01   +4.264975009775287e-02   -2.166283517375916e-01];
L2_L5_iAMPA_netcon = [+1.151511368649301e-01   -1.064521130672888e-01   +3.849536473354530e-02   -1.398406996914741e-01   -1.183491809780055e-02   -8.051661001405666e-02   +1.080528804367179e-01   -1.273516708677266e-01   -1.732588174497660e-02; +1.174534863423665e-01   +9.162709746789385e-02   -1.968581232904877e-02   -3.959562719241671e-02   +1.286955015707030e-02   -1.159123593604629e-02   -1.717673912818490e-01   +1.141818239116847e-01   -9.688041247182297e-02; +5.772102732147621e-03   +4.656623081927259e-02   -1.830435358947878e-01   +8.778522703230966e-02   -1.199683834697339e-01   -4.503095867810955e-02   -8.447442368948480e-02   -6.109659578697584e-02   +5.980882499206014e-02; +9.645135073358957e-02   +1.715720824110413e-03   -9.388177338823298e-02   -1.267844675123241e-01   +1.055989103245349e-01   +9.099680092307663e-02   -5.708718826609192e-02   +6.222270243532706e-02   +7.199832417706108e-02; +1.596658617669567e-01   +5.270468622428795e-02   -5.118369726963293e-02   -1.198661566686351e-01   +1.296391583893478e-01   +2.840850027103484e-02   -1.351520149554889e-01   -1.448030381338903e-01   -8.825221206865141e-03; -6.886824833511826e-02   -1.488657695849611e-01   -9.737310466792688e-02   -1.523870649544653e-01   -2.357629316170334e-02   -1.820490211304650e-02   -6.405101523071000e-03   -7.154488742263676e-02   +3.866096796535341e-02];
L5_L2_iGABA_netcon = [-3.253666795471338e-02   -1.333148941853876e-01   -7.938445217943867e-03   -8.891320362470043e-02   -5.651409499666289e-02   -1.591803750734623e-01; +1.185719927171844e-01   -1.140131771562831e-01   -1.698147121958558e-01   -8.514990458617350e-02   -1.770558548530664e-02   -1.132121811547494e-02; -7.605926109696329e-02   +8.893531482438635e-02   +6.422615759266749e-02   +6.288270543566636e-02   +1.017400460812886e-01   -5.855846807108815e-02; +1.069511608290639e-01   -2.947729876676509e-02   +8.314566467962421e-02   -7.895606149133150e-02   +1.637340437608625e-01   +5.157573310003843e-02; +1.198080234851512e-01   -1.178042823917410e-01   -2.948737154483067e-02   +2.650943131417023e-02   -1.293988235595077e-01   -7.178297002449575e-03; -1.332332068319332e-01   +1.057762107098440e-01   +1.411157045237968e-01   +7.091347565580564e-02   -1.352977239697113e-01   -3.302790491727524e-02; +9.936544189029520e-02   -1.017551023658053e-01   -1.694674391541934e-01   -4.076036597597082e-02   -1.508987205854733e-01   +8.486361462031197e-02; +2.288083422600579e-02   -1.319645968387849e-01   -9.181423122259033e-02   +1.855726423182903e-01   +5.719173606653885e-02   -7.254561325254548e-02; +3.574500659591044e-02   -9.224267803064282e-02   +1.155694210022140e-01   +1.677223880508140e-01   -9.359258689505964e-02   +4.664370805883716e-02];
L3_L2_iAMPA_netcon = [-6.837531822793927e-02   -1.204622417094551e-01   -5.040111037389074e-02   -7.112201006742676e-02   -1.618346550134539e-01   +8.021400584489743e-02; -4.855199949890705e-02   +1.271000722496128e-01   -2.081623388342324e-01   +1.188878396669881e-01   +1.532419508469156e-01   +1.385000097994774e-01; +9.845765584250046e-02   -8.323272083699457e-02   +1.864910330444517e-01   -1.692024302773458e-01   +6.061062883636074e-02   -5.618382011513139e-02; +5.147850520263158e-03   +7.455005360367997e-02   -9.538958094563721e-02   +3.732874549871416e-02   +4.568178504732814e-02   -2.264491111270828e-02; +4.240817697937369e-03   +3.800248095660688e-02   +4.187296739278377e-02   -3.424753384970453e-02   -1.675750127389207e-01   +1.312907720699853e-01; -1.556299561552428e-01   -1.865672134912447e-01   -1.029960501453375e-01   -1.870312963493007e-03   -1.834286228208340e-01   +1.514442982130776e-01; -1.008127627410229e-01   +2.861357670810946e-02   +1.321210076319606e-01   -1.225401267660878e-02   +1.324731985729686e-01   -1.592820698995415e-01; +1.061839593377729e-01   +8.271559736441847e-02   -7.951121434158587e-02   -1.545102934620260e-01   -1.270400512892523e-01   +7.643183681566018e-02; +2.829071541208079e-02   +1.334869558814777e-01   +5.977827068769682e-02   +6.696308358967015e-02   -1.011074704957027e-01   +1.085786556830136e-01];
L2_L3_iGABA_netcon = [-1.647934499947593e-01   +1.127382685699509e-02   -4.109994274904374e-02   +2.102296235911876e-01   -1.406658343000028e-01   -2.611568599343178e-02   +1.598070200356438e-01   -2.404898560630021e-03   -5.244360512853723e-02; -7.303410279567034e-02   -1.736832008544324e-01   -3.740641611092035e-02   +9.506954303276517e-02   +4.601035629972031e-02   -8.846970803738005e-02   -7.438617217874749e-02   -1.100604829451868e-01   -2.207562763653060e-02; +2.499535745868119e-02   +8.833713027576216e-03   -1.102202295105194e-01   -1.223841504669594e-01   +1.025553222180108e-01   +4.500453178899152e-02   +1.184157132713817e-01   +3.906945243360226e-02   -1.343232597682719e-01; +1.154331350251387e-01   -9.252543922696611e-02   -7.697993493177707e-04   +1.587247466636058e-01   -1.162681862433751e-01   +6.251880751680847e-02   +8.377956756419784e-02   -1.507024272046369e-02   +1.137709440323132e-01; +1.511179641459187e-01   +3.799823314282186e-02   -1.026037448670478e-01   -1.050011130181939e-01   -1.448075176486475e-01   +2.106211597289271e-02   +9.729016907178462e-02   +4.423789390532956e-02   +4.077968529175755e-02; +4.404420387170976e-02   +8.994312564562376e-02   +8.448613192489228e-02   +6.047383842171621e-02   -1.334010384545338e-01   -3.036358524033226e-02   -1.377086893345761e-01   +1.394779144645203e-01   -1.379834394628858e-01];
L1_L4_iGABA_netcon = [+1.691394155786633e-02   +3.641471944353882e-02   +1.526826341193590e-01   +1.391510564894264e-01   +4.366992022028852e-02   -2.208381009896285e-01   -7.492911726434802e-02   +7.153630080704496e-02   -7.822831533242033e-02; +1.209036268367852e-01   +7.904194046194349e-02   -5.550980649419250e-02   -2.747680992485094e-02   -1.481720383737192e-01   -1.508138492027702e-03   -1.840629007059538e-02   -2.388836000551296e-02   +2.488420299809283e-02; -1.203731022627716e-01   -1.160364713219302e-01   +8.191270000509110e-02   +9.545316505113170e-02   -1.760348006395227e-01   -1.432637077550153e-01   +8.691103247378970e-02   -2.363265763680548e-02   -1.358502790623476e-01; +3.964299914770460e-02   +2.871644236177958e-02   +1.599844452654435e-01   -1.504612172189355e-02   +8.098214711835552e-02   +2.043605511292192e-02   +1.330448645070341e-01   +1.480954429473132e-01   +1.834634420245173e-01; +3.234562601877405e-03   -1.584452215331924e-01   -5.860881047613883e-02   +4.778317116801747e-02   -1.370265603243682e-01   -4.967826314265894e-02   -1.817226930369498e-01   -1.160972879166352e-01   +4.178549801399556e-02; +6.945473561296864e-02   +2.071079047537834e-01   -6.752776254032648e-03   +7.903679773160847e-02   -5.256242870744473e-02   +9.082422275477059e-02   -9.197894205384605e-02   -1.086768277798982e-01   -1.447418184243751e-01; +3.980872785057595e-02   +1.839339633347368e-01   -2.034736609007962e-01   -1.475461836625737e-01   +9.642692077177979e-02   +1.064009815457593e-01   +1.268500883540137e-01   -1.223917078848471e-01   +1.701873269817642e-01; +2.887583852963121e-02   +2.030891101772366e-01   +1.314567364563999e-02   +8.743967578617219e-02   -6.572440779212707e-02   +1.639076093101723e-01   +5.432696859518551e-02   +3.964982211670756e-03   +5.262134633440420e-03; +9.864956614297010e-02   -1.810674453362719e-01   -3.166675526852199e-02   -6.332607064846522e-02   -1.235449580556736e-01   -1.294836513038670e-02   -9.649333024201459e-02   -1.605801724634979e-01   +1.002437981668491e-01; +1.078632502965095e-02   +1.145816132069459e-01   -1.506473473901471e-01   +5.586948411332861e-02   +1.335209307754217e-01   -1.388600982360147e-01   +4.487864656015583e-03   +8.550602144677097e-02   +1.497726516185254e-02; -8.989431221609902e-02   -3.986166754917428e-02   +6.297760993522153e-02   -1.289727779142650e-01   -2.076118584728771e-02   +5.653090080368262e-02   -1.703679804879596e-01   +3.373540651887887e-02   +2.029111108074095e-01; -1.445149015546141e-01   +1.293550295997505e-01   +1.613963078299151e-01   -9.821090175653559e-03   +7.121704589867633e-02   +2.229828548051029e-01   +1.355768068860110e-01   -2.185049772232058e-01   -1.837986006187772e-01];
L4_L1_iAMPA_netcon = [-1.710127667647909e-01   +1.994705908248058e-01   -1.319446852484543e-03   +9.728160338639408e-04   -3.036888390664364e-02   +7.647492769915198e-02   +1.944678098555334e-01   -1.057160454123370e-01   +8.696557027002008e-02   +8.702169106689384e-02   +9.801396781567828e-02   +2.332859747058819e-02; +8.616914000655571e-02   +8.016520066842078e-02   -6.581108301601879e-02   +4.865167302745619e-02   +1.093323818623711e-01   +2.823774111604496e-02   -1.700612513096791e-02   +1.255307973782957e-02   +8.893910142159879e-03   +1.328959199732149e-01   -8.838413861822930e-02   -1.771003544030006e-01; +7.767978370099664e-03   -2.900497870825002e-02   -1.171183289372756e-01   +1.201505112484782e-01   -3.965692286933407e-03   +1.667472113754396e-01   -4.186674646464711e-02   -1.370407466629221e-02   +9.134552211720028e-02   +8.449411378151453e-02   +1.141143072668987e-01   -2.702095729495523e-02; -2.658848222400118e-02   +2.141236385487866e-02   -1.231515930838113e-01   +5.092369713671353e-02   +6.732535688614305e-02   +8.140462460983271e-02   +1.070918034722769e-01   +1.847097948646503e-01   +6.254301334068370e-02   -1.692128115977478e-01   -1.022183241069048e-01   +6.266399536733094e-02; +1.592532497906312e-01   -2.379769433436483e-02   -9.837550070608476e-02   -3.011024450400098e-02   -1.278601566168727e-01   +2.498383542305744e-02   +7.017515190592338e-02   +2.421645814866973e-01   +9.581056372819700e-02   -1.094964186521432e-01   -4.207439984749411e-02   +5.970493281931682e-02; +2.017727412154684e-01   +1.655215797173569e-02   -1.548051716671254e-01   +4.545940076365396e-02   -5.026635541280511e-02   +5.438375010243601e-02   +1.965660163758490e-01   +6.594285221590140e-02   +1.172981805114365e-01   -8.786327217304446e-02   +1.533413876367857e-02   +1.484128549785399e-02; -1.729776607332762e-01   -5.543765504929152e-02   -5.995430024288147e-02   -8.305436822856577e-02   -5.913512860094151e-02   -1.113975061544414e-01   +9.948279831822757e-02   -1.019715767713070e-03   -2.892696196523766e-02   -6.180480851546576e-02   -1.836083582083453e-03   +6.263193962387312e-02; -1.775915173549821e-01   +1.022685978939606e-01   +1.166700894587242e-01   +1.224533843036683e-01   -6.991642998628987e-02   +6.514092825739724e-02   -4.314569192862416e-02   -5.218072416766815e-02   -2.592031220326754e-01   -9.002995258594471e-02   -2.165075056081092e-02   +1.945292818842254e-02; -1.508344271014349e-01   -5.100857613086815e-02   -2.104355167796454e-01   -5.848631311122857e-02   -6.272479975800080e-02   +1.957230339150122e-01   -4.265291272168219e-02   +3.450698237949321e-02   +1.518301824431815e-01   -2.022978285286593e-01   -8.136751288201000e-02   -9.747204999018087e-02];
L1_L3_iAMPA_netcon = [-1.074585234906882e-01   -1.577932217854006e-01   +1.921803866016097e-02   -1.730076006602221e-01   -5.928337407363322e-02   +6.153876812613700e-02   +7.381705565456406e-02   +1.004207812764585e-01   +1.136901378857175e-01; +8.285326450847923e-02   +7.194226815720964e-02   +2.021352646678962e-01   -8.327814336206689e-02   -1.391249792118402e-01   +7.251964595644875e-02   +3.316747103225794e-02   -7.278846040638119e-02   +4.938129073684638e-02; -5.696136984925035e-02   -1.974697159710415e-02   -1.507981164009380e-01   -5.084590660580021e-03   -7.781501671183029e-02   -5.906225163250303e-03   +8.298640010669252e-02   +1.602214600136060e-01   -1.773528734498263e-01; +3.642512840266822e-02   +1.153954023166186e-01   +1.925679300436544e-01   -1.094013136048599e-01   -1.692772256107541e-02   +8.404204202720268e-02   -1.497976529494658e-01   -2.846320279527295e-02   +5.821050004824344e-02; -5.624998676033290e-02   +1.187788342149313e-02   +6.186738053609829e-02   -1.275910297283239e-01   +9.550676827221462e-02   -1.864542322320747e-01   +1.426332340147329e-03   +2.936125015521637e-02   +2.138053686198472e-02; +1.845329771815891e-01   -6.183413475721676e-02   -1.179863047889837e-01   -4.835016338219796e-02   +1.181115015024783e-03   +6.720415411728484e-02   -1.150142778835869e-02   -1.017422783541057e-01   +1.630975355356639e-01];
L3_L1_iGABA_netcon = [-1.299196281462740e-02   -1.146106677449894e-01   -1.221698650393493e-01   -1.355443523071435e-01   -1.692272732617727e-01   +1.353879181132653e-01; +3.645529405860502e-02   -1.562971837949668e-01   +6.071246442894099e-02   -1.384485421580864e-01   -7.879659861783214e-02   +4.055874221992434e-02; +4.482075899676580e-02   +4.107528703992979e-02   +1.818154624205896e-01   +1.165253287507947e-01   +9.737492763775915e-02   -1.729187782492375e-01; +8.352601693372423e-02   +1.363552343666120e-01   +3.090179482773475e-02   +6.380984218586364e-03   -3.151083452413180e-02   -1.258637335940454e-01; -7.918153900708445e-02   +5.710610282270638e-02   -1.003030881589731e-01   +1.191631804773712e-01   -2.789923526499668e-02   +7.387986981887062e-02; -1.657345580426597e-01   -5.178608890901753e-02   -9.180693384327697e-02   +5.336461256976649e-03   -8.796701685036031e-02   +1.122639558671145e-01; +1.237119388018484e-01   +6.199607494153861e-02   -1.127149889661332e-01   -1.611516333957410e-01   +9.273045825855523e-02   -6.573897335769270e-02; +1.369174538005041e-01   -1.371170078995161e-01   -1.376256282385945e-01   -3.924152115714651e-02   +2.087562004395806e-02   +2.238870537079396e-01; -8.595840838268468e-02   +1.954419222680746e-01   +7.480419796260621e-02   -1.177040669804802e-01   -4.019799540098705e-02   +5.605141360230733e-02];
L5_Input1_iAMPA_netcon = [-6.785091269084215e-02   +1.519224232057799e-01   +4.514177149245095e-02   +6.522690858668490e-02   -1.472046771364131e-01   +4.177016940490649e-02];
L6_Input2_iAMPA_netcon = [+4.291675634343041e-02   -3.239234978533927e-02   -6.385590121721323e-02   -1.310089336497317e-01   +1.552559433431607e-01   -1.150591938605476e-01];
L5_L6_iAMPA_netcon = [-7.307443651055902e-02   +9.390891390790457e-02   +1.326009057903510e-01   -5.293581887849585e-02   -1.064283761810773e-01   +1.536034910357749e-02; -1.888731170890844e-03   +9.478020330888723e-02   +7.612553471319113e-02   -7.470399844170447e-02   +7.497848160803577e-02   -4.121108000653247e-02; -1.253790847245230e-01   -1.403456018465082e-02   +3.319063903983233e-02   -9.500996848795218e-02   -7.224593145595798e-02   -1.297094782147055e-01; +6.985529000242570e-02   +3.994097778733788e-03   -2.065677893406793e-02   +2.844846871080349e-02   +1.233539906012298e-01   -9.681153173648809e-02; +9.491427408668912e-02   -5.100547802624853e-02   -7.571215951771848e-04   -4.819515353944505e-02   -6.631133279883966e-02   +6.461537766496481e-02; -2.095294973671322e-03   -9.044444357801537e-02   -1.122202282687679e-01   +2.010955252166628e-01   -1.827813414736298e-01   -3.886792868525482e-02];
L4_L5_iGABA_netcon = [-4.281367961591195e-02   -2.424615424550840e-02   -8.353541186232925e-02   -9.294386253016920e-02   +7.211232285632749e-02   +3.457560233578397e-02   -2.006455022658220e-01   +7.202350982332031e-03   -1.013731991395157e-01   -1.226542777395617e-01   +1.631071180502692e-01   +2.503730213880287e-02; -2.769398953711637e-02   -6.662176932256839e-02   +8.880816753986048e-02   -1.115682378725921e-02   -3.692150798458151e-02   -7.581918710734900e-02   -2.602299995031107e-02   -2.156495322313567e-01   -8.225551525224967e-02   -1.489262086123978e-01   -1.356802045224785e-01   -7.524637905345499e-02; +6.986307474503563e-02   +5.015214834807326e-02   -3.294767633581417e-02   +1.235904942643980e-01   +4.501497501199628e-02   -1.974801882338274e-02   +6.097676337204423e-02   -1.007361279587408e-01   -1.335995477143347e-01   +6.966957229409519e-02   +3.209928374140562e-02   +3.040434612049915e-02; +1.130417747020946e-01   -2.368982471077418e-01   +6.975789412611762e-02   -1.215610275696941e-01   +4.734709004153946e-02   -4.762718649023339e-03   +8.593187216651550e-02   -1.052052799915627e-01   +3.561685359106243e-02   -4.017876139615022e-02   +7.830812593703981e-02   -2.263160584295492e-02; +7.729130238641661e-02   +1.255412532655941e-01   -2.048127526174803e-03   -5.418148434368959e-02   +3.395281128857730e-02   +1.189313964563266e-01   -2.272317052443694e-01   +7.719669943473587e-02   +1.192359362366250e-01   +2.107682453825376e-02   -1.833642212233003e-02   -3.600989427478135e-03; +7.112961491363333e-02   -1.349873861854867e-03   -1.613699458574333e-02   -8.576263650275520e-02   -2.787709104916794e-02   +1.187780061800402e-02   +3.104247959998067e-02   -4.260211741169061e-02   +1.829959490942120e-01   -5.870460702964869e-02   +1.187575600267803e-01   -4.028215246630167e-02];
L6_L4_iAMPA_netcon = [+9.165220418809882e-02   +2.932950012280489e-02   +5.722327714133459e-02   -1.786373236492626e-01   +6.901020702973268e-02   +6.609812333423912e-02; -1.540448164780607e-01   +3.534970104368102e-02   -1.556432254749205e-01   +1.376050315314989e-01   +1.510421956597181e-02   +1.378337455714727e-01; +9.270597308222102e-02   -4.239154017984900e-02   +9.509002994986056e-02   -4.228586445143750e-02   -8.827581373943669e-02   +4.792396866271871e-02; -1.072305979750169e-01   +5.628070738175080e-02   +1.444529483261642e-01   +4.763163545639626e-02   +4.050676957814303e-02   +3.692969523700218e-02; +1.373501264959928e-01   +4.573180554165791e-02   -1.546975457323940e-01   +1.228268406117667e-01   -8.592863205283600e-02   +2.872003305614600e-02; +1.930293643229689e-01   -3.259783139359560e-02   +6.673112895084893e-02   +7.762174530277115e-02   -1.029147252094793e-01   -1.355017541464129e-01; -1.040597157339626e-01   -1.368461716940403e-01   -3.806733692761555e-02   -9.361590027825023e-02   -6.798090064179141e-02   +1.173476922797150e-01; +1.568458706767247e-02   +1.589191134152514e-01   -1.933679427453150e-01   -1.616508846559368e-01   -5.314020319854174e-02   +8.392348789230251e-02; -2.034855248788369e-01   +1.819005176865437e-01   +1.100875107092337e-01   +1.293400803428769e-01   +5.820990297025047e-02   -1.374657577506667e-01; +1.860874794541944e-01   +1.287634567308762e-01   -8.872545716106239e-02   -1.189330896022876e-01   +1.062846879838825e-01   -2.731127679320164e-02; -1.542391545141345e-01   +1.563532960247631e-01   +2.835295224692605e-02   +9.615817590498925e-02   +1.823965568073778e-01   +1.449642324819082e-01; -1.331604659658916e-01   -8.909508400909434e-02   +1.731533457002023e-02   -4.659725157191048e-02   -2.733976779574984e-02   +1.425426012130780e-01];
L5_L4_iAMPA_netcon = [-8.477183618418227e-02   -3.130485250574050e-02   +7.482684349832729e-02   +9.262578304480225e-02   +1.960832347176292e-02   +1.385915812175334e-01; -1.869313257174595e-02   +5.737780223250619e-03   -7.181399537229273e-02   -7.604072044456070e-02   -1.215115536455041e-02   +9.192236001812176e-02; -9.243268737876949e-02   +4.333862267676859e-02   +9.433049430581983e-02   -1.687500946375912e-01   -3.336793394915419e-02   +1.779009449575398e-01; -1.932581912594236e-01   -9.354874075005681e-02   +1.609596602423866e-01   -4.762376873876016e-02   -1.100197023290470e-02   +7.274603279044259e-02; -1.613588208906607e-01   +3.666123060316311e-02   -6.135502127417143e-02   -1.278829768774930e-01   -1.169140411146667e-01   -6.449476487344122e-02; +2.352459580609240e-02   +2.249695393481695e-02   -7.145670010558229e-02   -1.617813743461370e-01   -4.268748343455764e-02   -6.040646876348123e-02; -2.435223718410661e-02   +7.880352766734400e-02   -1.161058945231999e-01   +3.887017451990343e-02   +6.642967099972362e-02   -1.004041374941592e-01; +1.362874336233458e-01   -7.676524261232251e-02   -1.522045661920930e-01   +2.889506894383273e-02   -7.757103974497645e-02   +1.331803674431046e-01; -2.568068479347416e-02   +1.896526666733224e-02   -1.233094603430953e-01   -2.568714091428706e-02   -1.700710112769864e-01   -1.126749918303158e-02; -6.476303715022057e-02   -1.192513571692636e-01   -2.550033890707339e-02   -8.054348411585054e-02   -8.600706206210985e-03   +1.270830041126284e-02; +4.915084831921111e-02   -6.368722755882017e-04   +1.650205456642530e-01   +9.328060235279738e-02   -9.633259493833979e-02   -7.214207102107761e-02; +8.703518376702571e-02   +1.339035785709308e-01   -9.743179350685362e-02   +3.646978344456979e-02   +4.255115779980877e-02   +6.774849673034902e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
