function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.462493850309950e-02   +2.166202665104902e-02   +2.689800408641949e-02   -2.948894881717364e-02   +4.627234461348759e-03   -6.352375891996322e-02   -1.435506314361762e-02   -1.370684827422411e-02   +2.635363025792124e-02; +5.653674960673892e-02   -5.042063876687248e-02   -1.810342938772442e-02   +6.986442642685572e-02   -2.286692462313595e-02   -2.145261862021315e-02   +3.544473003591448e-02   -6.418623171469948e-03   +2.740584036977712e-02; +1.948249865160582e-02   +5.475400859344948e-03   -1.686759832501123e-02   +1.868544861265638e-02   -2.292958993905069e-02   +1.598521734764509e-02   +5.986335720624802e-02   -6.115505089570156e-02   +5.073591723953082e-02; -4.549653927987485e-02   -4.489187813763462e-03   -2.161221806049127e-02   +4.066096147155533e-02   +6.858968663056918e-02   -6.556995535372739e-03   -5.085990991782086e-03   -3.457172094652360e-02   +2.350045632816085e-02; -8.082420827746177e-03   -2.066667269964372e-02   -5.443450351860769e-02   +2.442869951419430e-02   +1.868072749829833e-02   -5.982516551593129e-02   -2.239459763366574e-02   -1.165382449838623e-02   -1.556126189376112e-02; -2.764414043422348e-02   +1.590646086114608e-03   -5.319907794597349e-02   -4.353835972962629e-02   -3.324146438486129e-03   +8.083836802916263e-03   +5.224419684676262e-02   -2.066670368809835e-02   -8.525882669623803e-03; +2.764853701796715e-02   +5.032169965687032e-02   +2.118606646387024e-02   +2.260811340493259e-02   +1.747992811748039e-02   +1.768653961352140e-02   -2.647307736405853e-02   -5.451814793677366e-03   +6.119843183614086e-02; -1.356350255613678e-02   -1.800715475806146e-02   -9.392646494924127e-03   +1.967212418614553e-02   +3.836524024883896e-02   +2.895040970695855e-02   +3.398572246412189e-02   -3.032091925665139e-02   -6.353683006168972e-03; +5.653074203213339e-02   +6.258660262237284e-02   -3.699559914337111e-02   -4.244359039518535e-02   -5.709946706915588e-02   +3.195632861733169e-02   +1.177821473542972e-02   +1.192482920231077e-02   -3.289702169299905e-02];
L1_L2_iAMPA_netcon = [-6.179059277878419e-02   +4.341144342933520e-03   +1.919017232230725e-02   -5.703390389996141e-02   -1.758527790058344e-02   -3.578014609470350e-02   -3.040042013202308e-02   -1.059512001337449e-02   -3.697003066626685e-03; +3.486804348109655e-02   -2.065538930719212e-02   +3.887857663370624e-02   +2.581468216684226e-02   +5.508239992529011e-02   -1.443699014717212e-02   +8.383446806364023e-03   -2.417456385587942e-02   +2.375369810527509e-02; +1.126473975648244e-02   +1.476834382764350e-02   -4.511096917750661e-02   +4.250679267849670e-02   -3.641005771543832e-02   -8.703147342821145e-02   +3.186649677187241e-02   +1.579382444464738e-02   -1.390128451780709e-02; +1.676336524073002e-02   +1.504638129051805e-02   +6.850787114367714e-03   +2.008855841716870e-02   -4.487852716014187e-02   -7.456026230458612e-04   -3.331121333277916e-02   -4.684622206178865e-02   +1.088734312818159e-02; +7.205025530520846e-02   +7.572771355184590e-03   -4.894755758480485e-02   +2.936666022134351e-02   -1.463576104003295e-02   +2.447946611544430e-02   -4.130348167363379e-03   -4.169792633719523e-02   +2.505685211858566e-03; -7.547171969095840e-03   +1.100543324972934e-02   -1.686476668240603e-02   +4.341049811693851e-03   +6.730493868328413e-02   -2.102363690870661e-02   +7.379661379779268e-02   +4.260853419686279e-02   +1.933115317490318e-02; -6.029519523333909e-03   +2.223292403408618e-02   +5.384944621515766e-02   -6.243678897757807e-02   -3.801731831142508e-03   -6.255951898630226e-02   +4.014075306876159e-03   +3.866544369581460e-03   +3.495833907736224e-02; -2.003425164327933e-02   +6.047977643776334e-03   -1.285608935453820e-02   +6.303452247090717e-02   -1.122089540731238e-02   +4.301781208033817e-02   +2.525311144162800e-03   -6.322722788940494e-02   -4.416387130564528e-02; +1.730027323371132e-02   -1.594647255313072e-02   -5.952524007668240e-02   -1.765816228488065e-02   +3.051465054668729e-02   +1.044617666448848e-02   -6.995769284422912e-02   +1.397337460398352e-02   +3.832900326453387e-02];
L2_L5_iAMPA_netcon = [+4.202059952772037e-02   -2.552731106598908e-02   +2.814668943215094e-02   +1.611771004387845e-02   +4.477844027816336e-02   -3.326492238221979e-02   +1.019313518729092e-02   -1.130189463434378e-02   +8.004729555084564e-03; +2.103717477638941e-02   +7.974398163365077e-03   +1.000705060433597e-02   +1.108636837807408e-01   -6.273518546347175e-03   +2.126460590772561e-02   +2.565756836336123e-02   +8.315348123848453e-04   +6.692834952664614e-02; -3.658162995241573e-02   +9.603483402480208e-03   +1.364177931345183e-02   -9.660998685303851e-03   -2.686376878897452e-02   +7.828194842364747e-02   -1.968939908593233e-02   -2.097853082117636e-03   +4.345048332307370e-02; +4.898795632025353e-02   +8.241809725935155e-03   +5.789401645507203e-03   +8.101461577549440e-02   +4.172289381697510e-03   +7.081804841124650e-02   +1.979735061716352e-02   +1.748519585560684e-02   -1.656702863602299e-02; -4.403610862476053e-02   +2.691199272159209e-02   +3.519014176990721e-02   -1.303428506490882e-02   -2.385794624170583e-03   +2.295287074169569e-03   -3.570811874448131e-02   -1.095674251036127e-02   +4.054265652877696e-02; -3.802537936940070e-02   -4.167780641740232e-02   -2.511337883005420e-02   -2.392651440670576e-03   -4.439559014910811e-02   -4.122711462032869e-02   +9.301814803604898e-03   -4.509337262589837e-03   -1.520933349963734e-02];
L5_L2_iGABA_netcon = [+8.930559339816967e-03   +3.837493668477635e-02   -2.108089290520488e-02   -4.055696133467266e-02   -7.480191282053772e-02   -7.923266797281744e-02; +3.197863090040516e-02   -2.534890010163032e-02   -5.150997889764168e-02   +2.947865840075628e-02   +1.610433883175187e-03   -3.487980918413622e-02; +3.764589587591472e-02   +1.939921545825191e-02   +7.773590085589324e-03   -3.237705482379967e-02   +5.103279212998858e-02   +1.588459315571694e-03; +1.463073356606769e-02   -3.019222546576351e-02   +2.505621513039654e-02   -1.114718240139344e-02   +2.887357427694433e-02   +5.335315598936534e-03; -2.928727277119140e-02   +6.111596430963084e-02   +4.530876867904891e-02   +3.327362389193445e-02   -1.265406994389233e-02   -2.585816232997223e-03; -6.143765301330577e-03   -1.160136986886474e-03   +4.505375759503105e-02   -3.064372373396976e-02   +4.769593765203986e-02   -3.460131158908965e-02; -3.494330191569704e-02   +5.415264625477024e-03   -8.145039481279848e-02   +3.563660077555042e-03   -3.954437444196339e-03   +1.875339059824475e-02; +2.131097848097099e-02   +3.916905764392586e-02   +6.165398366617633e-02   -4.033867158269833e-02   -3.375464372086016e-03   -2.222026770313255e-02; +2.234562452307907e-02   +4.803346800342843e-02   +2.504513031654169e-03   +1.241973953408338e-02   +1.288757553822401e-02   +4.121448073165167e-02];
L3_L2_iAMPA_netcon = [+1.016972765562831e-02   -6.174722411475674e-02   +7.898375270858357e-03   +7.714324737138411e-03   +1.911730074349560e-02   -3.243849128654551e-02; +2.092283637516879e-02   +7.891378964397919e-02   +1.553142292835323e-02   -2.232578435445177e-02   +5.645917837830049e-03   +6.097683321654552e-02; -5.636939992042712e-02   -6.022515668666062e-02   -3.786173429954683e-02   +2.729161106180068e-02   -1.057327170837695e-02   +4.036710308408790e-02; +3.968272600679115e-02   +8.892152469398801e-03   -2.112756700388109e-02   +4.525604394410788e-02   -6.519063480581075e-02   +1.235151329101537e-03; -5.762453094334788e-02   -1.366091453396992e-02   +4.868265818002508e-02   +8.738644232027235e-03   -5.454660900729956e-04   -3.220866472566627e-02; +7.974111514295373e-02   +5.634878597829564e-02   -4.324832792694639e-02   +2.772226833201082e-02   +1.250085224116272e-02   +4.203209239197977e-03; -5.975023115514587e-02   +9.966046700658305e-03   +8.281500894879914e-03   +1.335418156427147e-02   +2.302062750934808e-02   +1.539182674826602e-02; +1.694562388880300e-02   -1.818245422572231e-03   -1.830584281346041e-02   +2.984968537641521e-02   +3.693189996234546e-03   +2.449128380527005e-02; -1.537848030920805e-02   +2.827720086498429e-02   -7.040907042337224e-02   +3.917456519481513e-02   -6.087747873982413e-02   +2.897611255033202e-02];
L2_L3_iGABA_netcon = [-3.330392304639499e-02   -2.933041977603362e-02   -3.564125944579043e-02   +1.185465606716075e-02   +8.924399530265834e-03   +5.342931365380409e-03   -5.095808032833210e-02   +1.030335985694372e-02   -1.137997508325703e-03; +1.125802795914529e-02   +3.931750185128131e-02   +3.441539171459003e-02   -2.935436913574821e-02   +1.665234732312263e-02   +3.350397733160873e-02   +1.075996313300600e-02   +4.894716492424705e-03   +5.274237198334669e-02; +4.988227461047096e-02   +1.226278102587956e-03   +4.854055280559631e-02   -5.224835934783248e-03   +4.748616774303876e-02   +4.500416661293739e-02   +3.795266323533380e-02   +2.400982110239656e-02   +6.360745338554273e-04; -4.633501878634795e-02   -7.091196275537726e-02   +2.098413918016478e-02   -5.893349849869069e-02   +1.429874952174913e-02   -7.308113802424065e-02   +4.035348249720764e-02   +4.989958186112362e-02   -1.098024757789198e-02; -3.087869900571249e-02   +1.291181652290533e-02   -2.057107651650963e-03   +9.400027124154251e-03   +1.991027247158377e-02   -5.749820490275736e-03   +6.475205497596809e-02   +1.563123775843398e-02   +8.670793627660642e-02; -8.610782903612625e-03   +2.882884561328118e-02   +4.000746871796375e-02   +3.239988604341812e-02   +4.299764592517363e-02   +1.864480530347392e-02   -1.610751260973232e-02   +1.599742605620195e-02   -6.051301930430573e-02];
L1_L4_iGABA_netcon = [+6.243881663585776e-02   +5.136303842746954e-03   -1.671409626815042e-02   +2.565937140217352e-03   +3.222533383017608e-02   -4.696035897603019e-02   -5.213334258831730e-02   -3.635652195360214e-03   +1.715703606558986e-04; +1.450270009064882e-02   -9.937472785544743e-03   +1.352743070432873e-02   -4.097841036390368e-02   +9.313189363276739e-02   +9.982592388078424e-03   +6.291588466462206e-02   +3.735187620129500e-03   -1.715706275536131e-02; -5.596588994325330e-02   -3.204257810423565e-02   -2.421639815726635e-03   -1.710318848216455e-02   +2.517109469060224e-02   +2.185679763527747e-02   +7.398482397937167e-02   +1.856958650715597e-02   -4.028817095380603e-02; -5.930644235755801e-03   -1.085498032896710e-03   -3.154068579913065e-03   +2.169706692083088e-02   +3.924163434005666e-02   +2.971117081306122e-03   -5.715171898048975e-02   +4.775428195857048e-02   -6.083665535646204e-02; +1.076457294228788e-02   +1.239495831573878e-02   +8.789501783683406e-03   -6.321002685522787e-03   +2.798617974216177e-02   -2.789274773023958e-02   +4.564450199679979e-03   -3.276478163779187e-04   +2.556933423321778e-02; +5.133722101133080e-02   +1.060440685869144e-02   -1.352855304140823e-02   +4.188437335997575e-02   +1.401280443541216e-02   -3.040433278801895e-02   -3.861638896438513e-02   +3.363125159542359e-02   +2.457203657821310e-02; -2.852129896922437e-03   +3.809803290934279e-03   -2.193579858056124e-02   +3.051706548770560e-02   -4.045814190676260e-02   +1.069373090212042e-02   +2.548736809247544e-02   -3.032113827906511e-02   -5.609164109006226e-02; -1.723503306926527e-02   +3.538104109246036e-02   +1.016156052859968e-01   +7.363718491140939e-03   -1.931020124263733e-02   +3.007059077806128e-02   +3.122418649335650e-03   -8.439454251039110e-03   +1.916992944924117e-02; +3.436089397092795e-02   -7.936366529075149e-03   +1.980673416592219e-02   +3.387527199331146e-02   -7.284438082221403e-02   +7.981928548269023e-03   +5.516871209219691e-03   +1.424518559342192e-02   -1.271847443239840e-02; -2.937194948806308e-04   +1.102238791602141e-02   +4.223511335674182e-02   +2.857779665719681e-02   -5.002681670350509e-02   -4.180675075415887e-03   -5.635007882411627e-03   +5.641801325292510e-02   +2.556275089955631e-02; -4.694878479090103e-02   -9.542174192672843e-03   +2.052342549585350e-02   -2.064361390420028e-02   -1.389470237073832e-02   +6.682828408647727e-02   +9.398482725267745e-03   +7.433983112594612e-03   +4.444402711344496e-02; +2.918435111241201e-03   -2.087922046036977e-02   +5.472934093413980e-03   +3.700665995354051e-02   +5.342309435122126e-03   +8.946926908289683e-02   +6.964988063044626e-02   -5.836019797322317e-02   +6.624982106156806e-02];
L4_L1_iGABA_netcon = [-3.487141571394109e-02   +8.696295834485526e-03   +1.619903948099247e-02   +7.605056106832063e-03   +4.401727140401586e-02   +5.718479387352106e-02   -2.961066542278529e-02   +9.651059608143312e-03   -7.287848075834370e-02   +1.805414898519791e-02   +2.469791177635220e-02   -2.573568382377649e-02; +3.566302817830963e-02   -5.830482392759205e-03   +5.992110020141966e-02   -8.125296604122617e-03   -4.104276413912282e-02   -5.623226960698969e-02   +5.737823021598359e-02   -1.613307831379093e-02   +2.216833001992007e-02   +3.755793381963747e-02   +4.800436703720078e-02   -3.525577910242045e-02; -3.166572282452842e-02   -1.900417358103996e-02   +3.532137149883079e-02   -3.238704488657520e-02   +6.120449172211960e-03   +2.850237495473706e-02   -2.199167833207500e-02   -5.926303822380417e-02   -1.906304396658941e-02   +6.140515946747137e-02   +4.123991014853774e-02   +1.313911008317423e-02; -2.996211257154466e-02   +3.701296088496208e-02   -3.394460286122281e-02   -2.700121692055099e-02   +6.656988341468034e-03   +4.077297439409742e-02   -2.246918273583359e-02   +1.593842649745690e-03   +1.397349108494959e-02   +2.425505662710202e-02   +3.858363576431466e-02   +3.333114940019458e-02; -4.862410265740878e-03   +3.968417634972032e-03   -1.255840615305521e-02   +5.196837396660647e-02   +1.132836034972357e-03   -5.093403402163676e-02   +9.115687140702274e-03   +1.834964252716335e-03   +1.269214721697869e-03   -7.988118391598106e-02   +2.453170541207576e-02   +4.955088682604386e-02; -2.976238775391812e-02   +6.897086003535850e-02   -3.254075433259074e-02   +4.006264901402698e-02   +9.697100180712612e-03   +2.798294243957484e-02   +3.223219290713787e-03   -5.220942620439126e-03   +3.699364372032006e-02   +2.059241160356556e-02   -5.275635442358503e-02   +3.151860621365293e-02; +5.602468507906782e-02   -3.787777788303322e-02   -3.569486798912052e-02   +3.549343622604541e-02   +3.933005381666678e-02   +1.020869912966930e-02   +4.451749365323742e-02   -9.423872225916279e-03   +8.366824343210957e-02   +4.709130671335128e-02   +9.746577669699819e-03   +3.211042547850442e-02; -2.324662394798555e-02   -5.274943800860548e-02   +3.536015461713190e-02   -4.675137975915341e-02   -5.722755214572139e-02   +3.697408357101484e-02   +1.168637686597379e-02   -3.892461692951884e-02   -4.665093803669730e-02   +4.654469690170125e-02   +4.269934645880168e-04   +2.235831545993972e-02; +1.581449483280277e-02   +4.009149193251945e-02   -2.261348942269982e-02   -1.082696626194540e-02   -4.124324352829861e-02   -1.305485579329870e-02   +2.139190809060867e-02   -2.469744714465745e-02   +4.193941536636082e-03   +9.567235545952074e-03   +3.483146781019850e-02   +3.947795287056628e-02];
L1_L3_iAMPA_netcon = [+6.706303266301047e-02   +4.558050030156853e-02   +1.633388923871552e-02   -9.765889981860534e-02   +3.125610443893054e-02   +3.305918718395760e-02   +1.991831322176582e-02   +2.490574748447309e-02   -5.321669614713332e-02; -2.574609728424146e-02   -4.653816359113910e-02   +5.570466628318185e-02   +1.171912067219092e-02   +6.520417266136970e-02   -1.446964588542471e-02   -6.029514579368671e-02   +3.169771186923707e-02   -3.648745290709889e-02; -5.713925663701697e-03   +6.007923844525007e-03   +5.892513515861382e-02   +6.423257333270818e-02   -2.719806059051004e-02   +9.188073927505444e-03   -1.577056486866397e-02   +5.928985955094486e-02   +3.047505608895580e-02; -2.569318397601057e-02   -6.114887247815776e-02   -7.924253950654924e-03   -3.333800813613536e-02   -8.294257227085725e-02   +2.138485800751079e-02   +2.189897672809908e-03   -6.277023268066417e-02   +2.125733426819153e-02; +6.738444414891728e-03   +3.549684013439194e-02   +1.863411591875473e-03   +5.109638412896540e-02   +6.222354096576482e-02   -3.082883149873864e-02   +1.225593768710133e-02   -6.626283342178614e-02   +3.019832321623623e-02; +2.945176211600357e-02   +5.696998144680683e-02   +2.324423591183410e-02   -1.291244805441061e-02   +1.644909807106647e-02   -2.077550516064460e-02   -2.947614944830780e-02   -5.724987546136934e-02   +4.432453907759972e-02];
L3_L1_iGABA_netcon = [+4.685538880638800e-02   +4.912759875176134e-02   +5.627722800525181e-02   +4.618214791606731e-03   +4.851554745998680e-03   -7.821037912370613e-03; +1.774644141890573e-02   +3.266919456018710e-02   -4.287192963167578e-02   +7.015726316583970e-02   +1.084973739582761e-01   +1.897307837715641e-02; -3.312514172139706e-03   -5.503098390829420e-02   +8.125314561376220e-03   +2.214659770010605e-02   -2.757104916147515e-02   +2.253923702686484e-02; +3.467751156534474e-02   +1.247168685791842e-02   -7.739978606651683e-02   +2.438902882613038e-02   -1.657343171520084e-02   +7.070085188940436e-03; -5.311903960959340e-02   +1.950619282199158e-03   +7.906381217529468e-02   -1.799871075729229e-02   -2.600549530386658e-02   -5.943583497694774e-02; -6.132475203260808e-03   -4.341237853686178e-02   +6.112071581989966e-02   -2.243710659202532e-02   +5.128796381975270e-02   +8.002101457089117e-02; +2.569502268365794e-02   +3.988819307181192e-02   +3.978628346100324e-02   +2.452462295749514e-02   -1.524944032590476e-02   -6.681070359570972e-02; +2.216635333922106e-02   -2.606369205051709e-02   -4.297752248660335e-02   +1.954285949368079e-02   +3.430902548799498e-02   -1.656387906873243e-02; +1.881107780785893e-02   +7.029273630415684e-03   +5.510242494220949e-03   -1.638447774064496e-02   +4.245659719552495e-02   +2.956613123238225e-03];
L5_Input1_iAMPA_netcon = [+2.762209056935681e-03   +1.720062326710803e-02   -8.299725593472102e-03   +3.164107678662076e-02   -8.245098288230415e-03   +3.636713027176460e-03];
L6_Input2_iAMPA_netcon = [-5.085731699111967e-02   +1.073982364510111e-02   -5.326656459278359e-02   -7.077884518948581e-02   -3.092716735145768e-03   -2.901700731508837e-02];
L5_L6_iAMPA_netcon = [-1.073778958995385e-02   +1.734287154998844e-02   -3.297126452904489e-03   -4.113037365522505e-03   -4.557542417204524e-02   +8.398784319075866e-03; -3.556691780050598e-02   -4.540802290806779e-02   -4.104774840802462e-02   +5.758968200102105e-03   +5.302758439949280e-03   -4.364608574978619e-03; +3.765922337863249e-02   +4.746320581794271e-02   +2.705068190853646e-02   -1.085545002993613e-02   +4.591058344160250e-02   +7.244662105776747e-02; +3.977111314233586e-02   +3.000854113399674e-02   +6.095137632917892e-02   -6.824893887699669e-03   -4.067521198506551e-02   -1.155151439733244e-02; +5.147764594042566e-02   -1.357211341960171e-02   +5.264053565495805e-02   +4.790278999207357e-02   -9.594335466362463e-03   -3.791012542320040e-02; +5.099529604186727e-02   +3.674406618294910e-02   +6.446349994619793e-02   +1.188387290045065e-02   -8.354416575321401e-02   +5.487360953721637e-02];
L4_L5_iAMPA_netcon = [+2.162562378453472e-02   -3.201662094575575e-02   -5.587980044370880e-02   +5.122396300648056e-03   -3.236020167262247e-02   -2.169619958149695e-02   -6.428871101440978e-03   -2.941219995746315e-02   +4.483919066726533e-02   +1.645967698401562e-02   +6.207343559877382e-02   -2.236743504169147e-02; +4.241229341321266e-02   -4.412574320445256e-02   -3.091055391919418e-02   -1.265920187688325e-02   +4.268877382271138e-02   -6.699399253843602e-02   +4.507050015651139e-02   -4.134358898850217e-02   -1.043483406486575e-02   +2.348714875175552e-02   +5.747363832225051e-03   +5.084835920307736e-02; -2.270801104682788e-02   -2.861945306428092e-02   +7.637148283996829e-02   +1.594386746639575e-02   +5.976292435102781e-02   +4.298462354551139e-02   -2.344838287266549e-02   +1.439049645448547e-02   -4.941157536412954e-03   +7.593977695293141e-02   -1.482200454778837e-02   +1.023680525283348e-02; -5.531558615399736e-02   -8.338170427222594e-02   +1.523357357765298e-02   -2.294911813936056e-02   +3.668688989069555e-02   +3.768952111619077e-02   -2.153471914008137e-02   +3.890166871731236e-03   +6.423384190509149e-02   +3.916544056707072e-02   -2.154703229478022e-03   -1.432215060156393e-02; -2.626621956843497e-02   +2.806271484067090e-02   +1.385376144496998e-02   +2.070295061853673e-02   +2.696526629421374e-02   -3.008149984031385e-02   -5.656676181321445e-02   -2.911211344025017e-03   -9.127121235780189e-04   +1.981003299170789e-02   +3.949412081387241e-02   +2.771826762218088e-02; -4.600462061196404e-02   +3.838131165486719e-02   -1.012924948221787e-02   -2.102440436181822e-02   -9.467180660021873e-03   +1.013605460177213e-01   -4.270243926714525e-03   -1.109027425723790e-02   -1.839885712617269e-02   +3.797953847511301e-02   +3.199723778978516e-02   -6.252605728586681e-02];
L6_L4_iAMPA_netcon = [+1.167376477930135e-02   -1.182343272912088e-03   +5.148076073468950e-02   +3.238464307904077e-02   -3.783067051966087e-02   +4.846063855622000e-02; +1.561592856760088e-02   -9.771635722389333e-03   -1.688545597341762e-02   -3.397081717079418e-02   -1.567677012038547e-03   +4.634610997614681e-02; -1.001821503002704e-02   +4.815986277637499e-02   -2.219526454354305e-02   +2.164891266592824e-02   +3.345413883960716e-03   -2.860139429419555e-02; -5.663147920796464e-02   -4.164331366031734e-02   +5.529607211276495e-02   +4.212924486777091e-02   +4.627508650364109e-02   -3.014551883470874e-02; +1.407685462984112e-02   +5.565928421804010e-02   -1.871696147064074e-02   -6.303652426772613e-02   +3.035678189262399e-02   +8.561683234340747e-02; +5.902809168908791e-02   +5.299546323335505e-02   +9.134660844530100e-03   -1.027874711353842e-02   +2.009071628781783e-02   -1.766546861289685e-02; +4.188723890931145e-02   +1.859553183186635e-02   +3.339707943031171e-02   +1.787109218966710e-02   +4.328161853328921e-02   +6.139373952652081e-02; +3.006158854341108e-02   +3.970395531649105e-02   +1.478260962406082e-02   +1.312464813861503e-02   +4.740510454482441e-02   +4.738288267227402e-02; -1.302523435792880e-02   -3.619111341664874e-02   -6.325972794577302e-02   +1.059823143863072e-03   -9.002053278829268e-04   +3.487172433962830e-02; +8.609809343534607e-03   -8.988520425293309e-03   -3.787225805558768e-02   +4.537597042075028e-04   +8.196478946303198e-02   -8.622345255454550e-03; +7.929902969427949e-02   +3.366425406985142e-02   +5.732607716426225e-02   +6.057840518316616e-02   -9.294373933754371e-03   +1.685718874770282e-02; +9.625502674280967e-03   +4.854706043124849e-02   -6.743197827681865e-03   +2.287148570805780e-02   -7.877915859482204e-02   +2.546498928795681e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
