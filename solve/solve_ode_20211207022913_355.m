function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-9.747237002881222e-03   +1.082819418791494e-01   -7.910225112263285e-02   +2.512167062095790e-01   +9.771539194688203e-02   +1.295612718680105e-01   +2.267056110612757e-01   +1.578383343712493e-01   +8.822915084095037e-02; +8.873640563941405e-02   +3.829321437731531e-02   +7.120900867605007e-02   +5.980621348530566e-02   +2.779653998645542e-01   +1.581462020753320e-01   +1.759313824889885e-01   +7.991777923509698e-03   +8.703451122687771e-02; +5.215296477581043e-02   +1.436780932103799e-01   +1.273132909746535e-01   +1.088083290148581e-01   +1.410365077105269e-02   +2.026320483178689e-02   +3.529424582280093e-01   +2.191913998756850e-01   +7.601575204486941e-02; +2.531615856185370e-01   -7.153272922730322e-02   +1.578703489149096e-01   +2.442310490254766e-02   +7.169026345359655e-02   +1.351532486948343e-01   +6.563202492368655e-02   +2.469973677435937e-01   +1.598496241241966e-01; +1.305423110039894e-01   +4.735473692328798e-02   +2.698682970145833e-01   +1.299983705313391e-01   +1.947570900264960e-01   +2.494200936089713e-01   +1.724511733334610e-01   +1.020496980821377e-01   +1.786842027234911e-01; +1.460642739642236e-01   +2.650818154566874e-02   +1.741809848541334e-01   +2.115981747545628e-01   +2.029102804026243e-01   +3.114357639392568e-03   +2.350537873626724e-01   +3.352529966784615e-02   +1.563196262803988e-01; -1.722777952256501e-02   +9.675886636360659e-02   +1.680021877646993e-01   +2.092715843909619e-01   -9.995005059361114e-03   +1.418581426064037e-01   +4.373610179938371e-02   +2.143213107898496e-01   +1.971229641419657e-01; +7.444457889994852e-02   +8.853154685891859e-02   +5.227724522925672e-02   +9.119948669315199e-02   +1.508582538793097e-01   +1.024919929630321e-01   +1.847036052299874e-01   -9.159406326032727e-03   +2.795715152588045e-02; +9.439471703419490e-02   +1.060688728629577e-01   +9.877745275812529e-03   +1.286519610951377e-01   +5.633521659293247e-02   +2.328383919180906e-01   +1.120067674738739e-01   +1.015657206062763e-01   +3.022346131118882e-02];
L1_L2_iAMPA_netcon = [+1.438866431036665e-01   +1.516903328852683e-01   +1.133569236589130e-01   -5.854023813335397e-03   +2.948780566624118e-01   +1.559042981817020e-02   +2.224661659240348e-01   +1.486157858773134e-01   +2.000384013687462e-01; +1.340618525104329e-01   +7.312306836750380e-02   +2.406903327581183e-01   +5.969927209656766e-03   -1.004035289675751e-02   +8.252263678516801e-02   +1.562643069274728e-01   +1.912212662933427e-01   +1.790107538280318e-01; -1.813944490894122e-03   +7.485695198280426e-02   +2.032302067428728e-01   +1.609999190362480e-01   +1.745432717499820e-02   +7.779863161267128e-02   +1.680159813877060e-01   +2.276187521519009e-01   +2.213563096200536e-02; +3.422746007355947e-02   +2.215690657920891e-01   +1.486033142984528e-01   +2.765116520453690e-01   +9.507695753830787e-02   +1.220386125960368e-01   +4.025107893842188e-03   -3.033051764919272e-03   +2.392652731459133e-01; +3.991602421705003e-02   +2.915621368661121e-01   -1.012187100581877e-02   -4.446648680642992e-02   +6.998747450215684e-02   +2.432135714077729e-01   +7.614019515576888e-02   +1.532269581727940e-01   +1.745441974955684e-01; +1.834531073545053e-01   +8.987627978926266e-02   +1.580587899561420e-01   +3.165880434096532e-02   +2.741170442689265e-01   +3.815612863597363e-02   +2.717132414501814e-01   +2.339633554336430e-01   +9.774645903320216e-02; +1.944006524583212e-01   +2.809659133964604e-01   -4.691651585914533e-02   +1.410701816998050e-01   +4.564039319680860e-02   +1.316096769497595e-01   +1.017909276239735e-01   +2.681539501974343e-01   +7.271538146676668e-02; +1.256607828406984e-01   +1.109385250111212e-01   -2.927442107748037e-02   +1.943207379473469e-03   +1.364106285379512e-01   +1.258088911328252e-01   +1.477241617078416e-01   +2.615912541895116e-01   +2.397922913045641e-01; +2.916846156867193e-01   +2.290401668762583e-01   +1.114038353694584e-01   +6.687898765931970e-02   +1.587963370024553e-01   +3.791861981802323e-01   -1.366647528836400e-02   +3.378361383716760e-01   -9.980537313255999e-03];
L2_L5_iAMPA_netcon = [+2.393045921366234e-01   +3.138705689406442e-02   -9.415865688089803e-03   +2.617225452424056e-01   +2.813095183745029e-01   +1.864236157372032e-01   +2.696037148541143e-01   +2.573145895276132e-01   +3.908670799745075e-02; +2.101008159192874e-01   +3.005431310320917e-01   +5.617798084059053e-02   +2.821875562444031e-01   +5.454202249277824e-02   +9.206467418466355e-03   +3.952715862926470e-02   -2.216058081504222e-02   +2.849168851237733e-01; +2.019558038648733e-01   +1.423156431118584e-01   -5.412677012166637e-03   -8.543200489444056e-03   +1.556618661031155e-01   +3.056044907208604e-01   +1.683523770371108e-01   +1.679204876640841e-01   +1.931350529184618e-01; +5.766294574899628e-02   +1.148804667266781e-01   +1.266203822584910e-01   +2.119423454571132e-01   +1.776773257232638e-01   +2.552007369649319e-01   +1.805983616269221e-01   +2.914688695163455e-01   +6.190106163451829e-02; +1.042392408844732e-01   +5.442289813815125e-02   +1.950263041902199e-02   +1.407319013048933e-01   +2.170804245970286e-01   +4.604971971887327e-02   +4.356612823056785e-02   +7.906460462544099e-02   +3.069083092748586e-02; +2.204531121016766e-01   +7.012108981911004e-02   +2.377669441111773e-02   +2.292398936289421e-01   +9.279711553539474e-02   +3.905556671434753e-02   +9.955954697277151e-02   +2.006662017396505e-01   +2.661800525143412e-01];
L5_L2_iGABA_netcon = [+2.125599202584070e-02   -5.041126324437165e-04   +2.015961823009348e-01   +8.362789218941924e-02   +1.152143032953480e-01   +3.522564560797035e-01; +2.278234594465260e-01   -6.499945709006066e-03   +2.198005490784217e-01   +9.982296067361336e-02   +2.252470441643361e-01   +2.895657731533510e-01; +3.149741262807207e-01   +2.694881671182506e-01   +1.838097828787914e-01   +7.578617790721993e-02   +9.691152420113358e-02   +7.665706572074917e-02; +8.498375488263545e-02   +7.069086317718171e-02   +9.688946115165414e-02   +4.546341456670001e-02   +1.544400071174995e-01   +1.001695170402586e-02; +1.223203762622813e-01   +2.350853558107511e-01   +2.032709157576672e-01   +1.190242664009175e-01   +4.842826150100338e-02   +1.919344436138001e-01; +4.770771075067149e-03   +1.562246636204462e-01   +9.501865463468212e-02   +1.841443822216751e-01   +1.546954752929222e-01   +1.159547772181933e-01; +5.830008715112679e-02   +5.827857488664189e-02   +2.286846071196942e-01   -3.919715590542206e-02   +2.546619117474118e-01   +1.000738358507978e-01; +2.435318251143312e-01   +5.921178268359498e-02   +2.686542922522194e-02   +2.797763638836475e-01   +1.081193944011535e-01   -1.220406335961009e-02; +6.980958602738382e-02   +1.408880242621253e-01   -7.896694297862930e-02   +2.310814676511579e-01   +4.057265752037963e-02   +1.753819142102085e-01];
L3_L2_iAMPA_netcon = [+1.919503318687084e-02   +6.882163170697539e-02   +1.215851277743411e-01   +3.380134372387449e-02   +2.910862056525771e-01   +2.206942404398468e-01; +3.496128803036858e-02   +7.507732419357438e-02   +1.153984855956188e-01   +3.126500520779779e-01   +1.400222106356604e-01   +1.105598274876879e-01; +1.252078457030424e-01   +1.034200674778789e-01   +9.074610412702450e-02   -2.794125401743155e-02   +1.140078482115540e-01   +8.432951745085208e-02; +1.260990041364764e-01   +1.379301701232657e-01   +4.592532920285156e-02   +1.726500141900364e-01   +7.043025934622406e-02   +1.974522036726349e-01; +1.161658809864863e-01   +6.125528348960624e-02   -1.655332303985339e-02   +2.420267412099126e-01   +2.588078322404614e-01   +2.573201959410268e-01; +2.050063677320608e-01   +3.855224936592587e-02   +2.874884155656551e-02   +1.235653525676489e-02   +1.425476413095688e-01   +1.752667797083849e-01; +1.188781095183258e-01   +2.101031406315883e-01   +3.171404387316899e-02   +1.578654255805172e-02   +9.562205119270974e-02   +5.490103322355402e-02; +7.403024579863059e-02   +2.561063520117459e-01   +2.587425951844324e-01   +4.839246407925204e-02   +1.300990968076424e-01   +8.415122059247483e-02; -1.170736867142800e-02   +4.121705020581922e-02   +1.347928426637175e-01   -6.723270777857762e-02   +2.236927291905863e-01   +1.860621437241315e-01];
L2_L3_iGABA_netcon = [+2.275081765182015e-01   -1.692301887661556e-03   +1.892129160859631e-01   +1.488147889316815e-01   +1.653184827290717e-01   +1.178870749142304e-01   +1.480267045254194e-01   +2.054676208417210e-01   +2.896860258597523e-01; +4.608081266535382e-02   +2.977920639262238e-01   +2.124408569306709e-01   +2.189832375278032e-01   +1.992072115425346e-01   +3.983312360236572e-02   +1.366208046101545e-01   +1.564449665565635e-01   +1.049433508079498e-01; +5.906453875728672e-02   +2.774033793039200e-01   +1.704069101951234e-01   +1.968638666048437e-01   -8.432422393095003e-04   +1.943493571501308e-01   +2.347548657868504e-01   +9.897767713210916e-02   +1.517003347211647e-01; +1.147416052804250e-02   +2.056352680450899e-01   +3.189056817430754e-02   +2.357572117396997e-01   +1.792031298847032e-01   +1.326994208131647e-01   +7.560761810058599e-02   +9.239255422780435e-02   -4.917118329196264e-02; +1.172575507971315e-01   +1.181216015852603e-01   +9.962261907791241e-02   +1.098989307924044e-01   -1.063623568127614e-02   +1.885116421149637e-01   +7.647395808539932e-02   +9.081126512272743e-02   +2.530883422927684e-03; -2.117813160550791e-05   +2.127502995920658e-01   +2.575644610956864e-01   +1.761683764051073e-01   +1.312904680542215e-01   +1.412421352049839e-01   +8.178351787838051e-02   +2.211130201587247e-01   +2.527351783915477e-01];
L1_L4_iGABA_netcon = [+3.106331621414722e-03   -5.710000926576288e-03   +8.660847396649089e-02   +8.476458686663081e-02   +1.876675497992765e-01   +8.254123977094051e-02   +2.148164594960354e-01   +1.018843463299008e-01   -3.279633793143448e-04; +3.390360083413791e-02   +2.704858519033359e-01   +2.634701454437720e-01   +1.564883714904373e-01   +1.780202269146887e-01   +2.370315107100310e-01   +2.541909197779946e-01   +1.648995770270684e-01   +9.336988426116308e-02; +1.786049400759555e-01   +6.640860616074715e-02   +1.845748021533902e-01   +1.354161232653845e-01   +2.910173581422486e-01   -2.125565986885094e-04   +7.063206598865540e-02   -4.173973472823019e-02   +1.258918368550672e-01; +7.704023868286594e-02   +1.686837738634500e-01   +2.593118677377677e-01   +3.602587979900396e-02   -5.670712404888107e-02   +2.580629036527791e-02   +1.421758400556513e-01   +1.420336399465902e-01   +2.386901456379623e-01; +1.295639394739772e-01   +2.015765116663689e-01   +1.901185593282321e-01   +1.835751670882642e-01   +1.888470994070192e-01   +2.344246575007736e-01   +8.091356919573360e-02   +2.137570380079590e-01   +6.611153810864848e-02; +1.081152027729395e-02   +2.382049196060020e-01   +1.534440760740284e-01   +1.978361700861405e-01   +3.644490006993209e-02   +1.806533150837472e-01   +1.728720429765748e-01   +1.615782657325338e-01   -3.493597749329173e-02; +1.454788292055381e-01   +1.615186620534740e-01   +1.416240638259375e-01   +2.006129337916017e-01   +2.788730888410252e-01   +1.370870884149572e-01   +8.549861872829773e-02   +3.652753002428257e-03   +6.745853323599577e-02; +1.823599335850719e-01   +1.063733461948610e-01   +2.020256234181184e-01   +1.072036726386913e-01   +1.669899445783019e-01   +1.016220443221834e-01   +1.858698729262719e-01   +1.701274290483183e-01   +2.238553739723876e-01; +1.676468625964418e-01   +7.890622855487973e-02   -1.083478913837588e-01   -1.713466803142314e-02   +1.832873855815929e-01   +2.123649960990651e-01   +1.823320530304802e-01   +1.046291202631062e-01   +8.472167519798314e-02; +3.651151598423792e-02   +2.407034741779919e-01   +1.421880349749989e-01   -4.446405205457847e-02   +8.018882845940663e-02   +6.293783761652585e-02   -7.913997359033999e-03   +1.952771794339087e-01   +2.957605106639223e-01; +2.636194863068546e-01   +1.587909868781988e-01   +1.411718089136276e-01   +2.645133507576130e-01   +9.746174048242148e-02   +2.382317083021650e-01   +8.493721096552194e-02   +1.077409206323256e-01   +2.486218578954128e-01; +1.717447540994713e-01   +6.271753304011529e-02   +6.803428494614339e-03   +2.337385694412688e-01   +1.295842622324898e-01   +1.762496861623159e-01   +1.952343630073183e-01   +1.168900207274660e-01   +1.708788738636929e-01];
L4_L1_iGABA_netcon = [+1.368674778700331e-01   +1.526563404357033e-01   +1.466306205772048e-01   +1.170805576709364e-01   -5.019598540052940e-02   +1.882167242753181e-01   +6.319728338291575e-02   +4.456498189433254e-02   +2.404057938852422e-01   +4.227826506033589e-02   +7.676590367118971e-02   +1.034989051371551e-01; -3.405516318185565e-02   -7.770844086457637e-03   +1.534586535063917e-01   +1.715864232094878e-01   +1.038318289989066e-01   +1.006546158028214e-01   +3.422733892382335e-01   +5.558169888650485e-02   +3.268975162237186e-01   +9.501639173648915e-02   -4.896620162056933e-02   +2.427479963463229e-02; +7.553482503722801e-02   +1.538384756136153e-01   +1.917550207235740e-01   +6.294066398841365e-02   +1.688443796879229e-01   +1.382108813335557e-01   +2.387754497170103e-02   +1.890591800534643e-01   +2.030869517138419e-01   +9.961148812485109e-02   +1.055593491707552e-01   +1.058415397026402e-01; +1.868795961084809e-01   +4.328115878233816e-02   +1.340070462719614e-01   +1.146971886973253e-01   +8.969415340050602e-02   +2.058915597774212e-01   -2.879538585244145e-02   +2.096791085548329e-01   +5.525918604434852e-02   +2.110128401550667e-01   +6.492529079795066e-02   +2.875243453492292e-01; +2.186291694389993e-01   +3.566806684517743e-01   +1.678640326807908e-01   +2.469446070541353e-02   +2.098969873216235e-01   +1.079192275437688e-01   +2.999470283152986e-02   +5.130333113440957e-02   +6.260478119553783e-02   +3.328288491264591e-01   +1.777532115032665e-01   +2.156812185068228e-01; +1.181450179200543e-01   +7.398936381236086e-02   +8.716193497610873e-02   +2.601529514250959e-01   -5.645641045625317e-02   +9.491759554059151e-02   +1.662895396561739e-01   +3.031294668298243e-01   +8.337824380938708e-03   -1.956888082964723e-02   +8.852381600611138e-02   +7.821870164422011e-02; +1.604499927715868e-01   -6.664768524386798e-02   +8.742596146416648e-02   +6.694316263187565e-02   -2.431009270171951e-02   +7.591403090871925e-02   +2.544805818412246e-02   +2.783647302175337e-01   +2.721580466683454e-02   -1.349945398393573e-02   +6.561129575557557e-02   +2.144419914123947e-01; +2.869902720270884e-01   +1.611720853814066e-01   -5.474380843581601e-03   +1.615228860609563e-02   +2.736172878057669e-01   +8.535545529858322e-02   +2.597782357161997e-01   +1.144283634691187e-01   +2.128238097407008e-01   +2.987667129058807e-01   +2.242975461250783e-01   +1.037047498663617e-01; +2.492596624000246e-01   +2.817612573408601e-02   +2.306988001598959e-01   +9.181090965484223e-02   +3.903476909524138e-02   +1.766553186295377e-01   +1.922121944305632e-01   +3.389662537022077e-01   +2.169238197235931e-01   +1.006736255561060e-01   +6.396755543885206e-02   +3.518921687053889e-02];
L1_L3_iAMPA_netcon = [+1.482482716880338e-01   +1.569376460328185e-01   +1.664916905562490e-01   +2.410588196886000e-01   +8.616604798000042e-02   +2.076052731745139e-01   +4.323508502895356e-02   +9.079969202044369e-02   +2.015375914802133e-03; +9.724687037764673e-02   +2.074328569402389e-01   +1.174999731171791e-01   +8.903965808140502e-03   +5.750033199905523e-02   +6.395654190815325e-02   +4.038633476342260e-01   +1.276549923785366e-01   +2.204311764218452e-01; +1.958340520517378e-01   +1.513377781945116e-01   +1.091055691111532e-01   +2.787008961017945e-01   +1.007678812307425e-01   +2.255474776690400e-01   +1.552380189532969e-01   +2.874100828022680e-01   +1.488483331415183e-01; +2.399430884800999e-01   +6.499997068201928e-02   +4.588096130389102e-02   +3.140533103465738e-02   +2.004482127479575e-01   +1.997577713021721e-01   +1.118187210532578e-02   +1.851092059018548e-01   +3.497242124904096e-02; -7.441713789792301e-03   +1.156752459884338e-01   +5.791109050006754e-02   +1.181206375957772e-01   -3.129696592688701e-02   +2.257385935289576e-01   +2.088721509989551e-01   +1.226531936547285e-01   +1.909585274977783e-01; +8.393261632701493e-02   +2.309972533688689e-01   +1.701612020682877e-01   +3.412610804081799e-02   -4.169569051482939e-02   +1.552921298741976e-01   +1.753815844745218e-01   +1.732785610189526e-01   +4.128363735967617e-03];
L3_L1_iGABA_netcon = [+2.900393787271234e-01   +2.267500574095827e-01   +2.089966873585788e-01   +1.436921073001007e-02   +1.008856947215969e-02   +2.050440194761720e-01; +1.111817061951586e-01   +9.423820439680179e-02   -9.656593053994857e-03   +6.319003779011201e-02   +7.760085168933879e-03   +6.829831530216868e-02; +2.420795277195992e-01   +8.911901794548434e-02   +1.274756006092060e-01   +1.065411057766927e-01   +2.117936556799371e-01   +2.447770745996692e-01; -9.015847292976144e-03   +1.998026361566533e-01   +1.621085266942401e-01   +1.685506132521720e-01   +2.705011370914545e-01   +1.444680451210391e-01; +1.837288169549628e-01   +6.179310860340871e-02   +1.813319212693791e-01   +1.722105690069483e-01   +9.885458788642092e-02   +1.088096264051980e-01; +2.534509719320235e-01   +1.244062876917068e-01   +1.548304226754428e-01   +2.493878602092017e-01   +3.069271814858667e-01   +1.899706242318823e-01; +8.977853572265557e-02   +3.017230138417119e-02   +2.831026144268119e-01   +1.016943008009518e-01   +1.390857324774547e-01   +3.148868520399575e-02; +9.954458211468278e-02   +1.969928527517273e-01   +2.286770314842951e-01   +1.066621394875168e-01   +5.105355785630179e-02   +9.767468100781580e-02; +1.724594655523523e-01   +2.507687915083293e-01   +2.358883346530191e-01   +1.034391143577634e-01   +7.698774235725915e-02   +2.503969197972267e-01];
L5_Input1_iAMPA_netcon = [-4.307872071162164e-03   +2.086033830463195e-01   +5.460782676856503e-02   +9.254036651133488e-02   +4.659648427947248e-03   +2.656526497416576e-01];
L6_Input2_iAMPA_netcon = [+1.520206046496002e-01   +1.786714112277802e-01   +1.792392387924668e-02   +1.596248386671251e-01   +2.007523634428021e-01   +1.892682351738360e-02];
L5_L6_iAMPA_netcon = [-6.748696948805880e-02   +1.699058639822013e-01   -4.822088692176797e-03   +2.858470113192740e-01   +3.241935891362889e-02   +3.196628291613872e-02; +1.336559878340807e-02   +6.166533662515826e-02   +2.588278799232291e-01   +2.057546357555770e-01   +2.852038122455594e-01   +2.256758539557028e-01; +2.108723090161078e-01   +1.759835427788047e-01   +1.506921854022958e-01   +5.701264829799021e-02   -2.436225713379949e-03   +1.835695930652505e-01; +1.203939990890322e-01   +2.640732229693730e-01   +1.812848900016585e-01   +6.252322792999737e-02   +1.183546787065607e-01   +2.511368693644423e-01; +5.967223311298712e-02   +2.245298367464576e-01   +2.890476658134610e-01   +6.599482308374101e-03   +9.180844888983343e-02   +1.164479868981629e-01; +2.114190584452631e-01   -8.755865212280028e-02   +2.854405330163687e-01   +4.573776639680467e-02   +2.402486936814142e-01   -1.723649898944353e-02];
L4_L5_iAMPA_netcon = [+4.957217256563363e-02   +2.116319714076849e-01   +2.867957356794801e-01   +1.819759272466335e-01   +1.085801996573798e-01   +6.506265866773309e-02   +2.971696618350197e-01   +6.140667813200240e-02   +1.084811100520858e-01   +1.508153914860685e-01   +2.049128666026825e-01   +1.589415869666423e-01; +5.188169047094613e-02   +2.549066078405761e-01   +6.884696567655084e-02   +1.908339674873533e-01   +1.000283461558868e-01   +2.142628725650517e-01   +3.465390497077153e-01   -2.502459575882466e-02   -1.673030721793882e-02   +5.050621722003293e-02   +1.729364578926424e-01   +1.279098096867593e-01; +6.791121877493146e-02   +1.903302839339601e-01   +5.640815828559251e-02   +1.229918852133570e-01   -5.511067110254322e-02   +2.509170670160187e-01   +4.005055177087902e-02   +1.013830813923436e-01   +1.993011250166263e-01   +1.137609465721039e-01   +1.901481288964628e-01   +9.736730729138143e-02; +3.000998114058325e-02   +1.373769335843573e-01   +8.524585546106013e-02   +1.756052346887930e-02   -4.643070460869679e-02   +2.067639183679271e-01   +9.449834116510700e-02   +5.484687829991153e-02   +1.929972261828549e-01   +2.534548643631529e-02   +2.460886774659815e-01   +1.894900064997015e-02; -3.012999547004170e-02   +1.990828651472200e-01   +1.548727650098038e-01   +1.294342968391775e-01   +1.275235134773444e-01   +1.123236339194315e-01   +2.291592294782846e-01   +2.883838641174124e-01   +9.850040743602703e-02   +1.864601227281757e-02   +1.886935940973487e-01   +2.050393986510089e-01; +2.050791252345163e-01   +1.727218444887873e-01   +6.892268660519819e-02   +1.947853681231461e-01   +1.163950076670741e-01   +2.869029626077587e-01   +4.686125293186629e-03   +1.621364674989143e-01   +6.588375968427557e-02   +2.547290454383092e-01   +1.911817914539082e-01   +2.447992157836185e-01];
L6_L4_iAMPA_netcon = [+1.537529592107044e-01   +1.227751643717113e-01   +1.596310028338608e-01   +6.786504700598821e-02   +1.476470237010838e-01   +1.992465287147291e-01; +8.613687778175942e-03   +7.108374857651339e-02   -4.381985291306878e-02   +1.113775156030427e-02   +8.881147092757191e-02   +9.025556046765627e-02; +3.239159424540668e-02   +8.219131216292268e-02   -2.990465379221773e-02   -7.633927529406195e-03   +2.627757932529394e-01   +1.316067417456915e-02; +2.872617996839312e-01   +1.901057107436425e-01   +1.218741661868356e-01   +5.464004402569721e-02   +2.654067397221038e-01   +1.245646807029022e-01; +3.737730462138465e-01   +5.980160197608152e-02   +1.741133607244042e-01   +1.126771177232411e-01   +1.268231591399623e-01   +2.152307713419898e-01; +1.770154884251769e-01   +2.472872351482220e-01   +1.726145284803600e-01   +1.941226039967210e-01   +1.356343315836230e-01   +2.393788200076008e-01; +1.122072666800780e-01   +1.936195301716494e-01   +3.939242418853003e-03   +1.671446557820145e-01   +3.100515440772124e-01   -6.751529752324319e-02; +2.942918883949789e-02   +2.605111073167795e-01   +2.392112170570095e-01   +2.878258912790540e-02   +5.949649914399547e-02   +2.211526746671173e-01; +4.712404449264415e-02   +9.571599112794685e-02   +2.177842314578082e-01   +2.246440768300626e-02   +4.473860859527864e-02   +6.008285508441463e-02; +1.478574241506092e-01   +1.261731934242751e-01   +1.969438397468256e-01   +1.174812365850456e-01   +2.707010153252764e-01   +1.548339203127084e-01; +2.145168514432905e-01   +3.740531538798575e-02   +2.978982931387358e-01   +1.086868832466391e-01   +1.592119162256091e-01   +1.003695802439940e-01; +2.029928395458639e-01   +2.058288026709305e-01   +5.231012502607130e-02   +8.485508133653778e-02   +1.827935519983789e-01   +1.749117923723303e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
