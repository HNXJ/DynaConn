function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+7.352429456676000e-02   +1.121095629378388e-01   -3.255007256850791e-02   +4.698006303946520e-01   +1.601196561757016e-01   +2.705995593533187e-01   +4.350251150779176e-01   +3.444414881020548e-01   +3.695445790800018e-01; +2.836801672391157e-01   +4.733016252557407e-02   +1.336417206526391e-01   -2.870567516789376e-02   +3.975871091820401e-01   +4.459396335971119e-01   +4.179074774038061e-01   +1.496192869933824e-01   +6.270975036736892e-02; +1.449652378715113e-01   +2.697426843203078e-01   +2.808953887468001e-01   +2.632460062786382e-01   -6.496991843395557e-02   +2.990391974845076e-02   +6.232751675872477e-01   +4.564044139615648e-01   +7.071322154984286e-02; +5.143099709989988e-01   +4.315986153338953e-03   +2.475013932004799e-01   -6.819137336081994e-02   +1.973012886876104e-01   +2.554998101220073e-01   +1.858896706560978e-01   +4.543894650178235e-01   +1.622653506586391e-01; +2.584137389977781e-01   +4.801500714322754e-02   +5.026030539486022e-01   +3.420572286590258e-01   +3.697414936681677e-01   +4.607753276282713e-01   +3.551022221706289e-01   +1.873619887785729e-01   +3.230840229239778e-01; +1.757514466784219e-01   +1.193235239950379e-01   +2.294110973270589e-01   +3.501778807678400e-01   +3.376657715093691e-01   +3.474928613503742e-02   +5.145541457445606e-01   +1.813495655526857e-01   +3.504701465300389e-01; +2.211120317955045e-02   +2.996928999942255e-01   +3.041908131852247e-01   +2.999238482547237e-01   +8.162941876344591e-02   +2.174032087216574e-01   +1.647923835121360e-01   +5.050666854329138e-01   +4.670021049994800e-01; +1.304133463839142e-01   +1.153266561962567e-01   +4.357399546411899e-02   +2.345457963680845e-01   +3.470909622961223e-01   +3.180335499319067e-01   +3.859659523593658e-01   +5.669343748262567e-02   +8.966969968544181e-02; +1.914175297612495e-01   +2.085067836044860e-01   -2.856606452109279e-02   +2.143558215513051e-01   +1.563511913625021e-01   +3.523449445295838e-01   +3.080809754361833e-01   +2.064031654470035e-01   +1.693769341401780e-01];
L1_L2_iAMPA_netcon = [+3.192939804807102e-01   +4.291007814660608e-01   +2.540662868242492e-01   +1.448178505956170e-02   +4.961192449828815e-01   +2.535460632108531e-01   +3.679987530734281e-01   +4.052832154533183e-01   +4.023427634003157e-01; +2.932618764309732e-01   +4.010879827585926e-02   +3.790054900471161e-01   +9.131307503853259e-02   +1.669041506778485e-01   +9.070114401161275e-02   +2.822970777974210e-01   +2.519972188040157e-01   +4.681726333843485e-01; -5.309959415183427e-02   +8.330591846542787e-02   +4.471053218681901e-01   +3.908887398425057e-01   +1.448861903623030e-01   +7.604630042278056e-02   +2.179431686294155e-01   +3.288627467907670e-01   +1.701339901360098e-01; +1.226401001894023e-01   +2.296168181470449e-01   +2.281133290686261e-01   +5.448071091050228e-01   +2.770258318931333e-01   +6.977071866229045e-02   +2.082992808300103e-01   +4.914527077174220e-03   +5.115031949079297e-01; +1.482999545762420e-01   +5.607353940299776e-01   +4.356525022416128e-02   +3.049456995138922e-03   +1.992494597278725e-01   +4.061924829065975e-01   +3.209090881598701e-01   +3.461627384561595e-01   +3.718979337606512e-01; +3.588442858711971e-01   +2.934895760501943e-01   +1.278834317149547e-01   +1.193271808462993e-01   +4.623756051210582e-01   +1.323418383062886e-01   +4.454557828697110e-01   +4.318635813435259e-01   +8.861631259624536e-02; +4.930914618178425e-01   +4.181215833428850e-01   -1.047081520939490e-02   +1.661254694902144e-01   +6.876075082875817e-02   +1.058522104743249e-01   +1.659059221781808e-01   +5.827352202335978e-01   +2.209360600400534e-01; +2.462460188871704e-01   +1.712258306757999e-01   +1.084240897115458e-01   +1.066129069661397e-01   +2.703729156791026e-01   +4.566958415863345e-01   +3.932244141721442e-01   +4.683654530565032e-01   +4.608752178380610e-01; +5.176975777512739e-01   +4.024414916466506e-01   +2.762900195869586e-01   +2.329288952535291e-01   +2.727077601519745e-01   +5.890114078031975e-01   +9.887979482360425e-02   +5.658229165324384e-01   +3.217994151758556e-02];
L2_L5_iAMPA_netcon = [+3.994227771598975e-01   +1.206387831629203e-01   -2.578459751948565e-02   +5.078294161371543e-01   +4.238849913211957e-01   +3.382049831078934e-01   +3.859532005311698e-01   +4.926683950900141e-01   +1.479015790919712e-01; +3.336899834035574e-01   +4.144458387818091e-01   +1.224275023700777e-01   +5.263401072131199e-01   +1.105414415778388e-01   +6.630881331812249e-02   +1.036102588797111e-01   +1.270426409067492e-01   +3.960123603864898e-01; +2.060502557153147e-01   +3.027057865994496e-01   +3.620820717844447e-02   +1.201771304519743e-01   +2.048702798357884e-01   +5.010060826718942e-01   +3.775529877986439e-01   +2.606265644929764e-01   +3.422108845266257e-01; +8.636891578381048e-02   +2.868264830482767e-01   +1.927661775675257e-01   +2.540367966761147e-01   +3.006467779709942e-01   +3.774390391849313e-01   +3.686157943894146e-01   +5.176057673899532e-01   +2.672931979570899e-01; +4.026382019203245e-01   +1.199206343954767e-01   +7.535587778617263e-02   +2.515950778134827e-01   +4.781340242262021e-01   +9.527899364274592e-02   +1.855030439247851e-01   +1.204971713177776e-01   +6.173405604063109e-02; +3.962525242107373e-01   +2.147787688791541e-01   +9.343755965797206e-02   +5.265531643999983e-01   +1.141755438343556e-01   -1.527448513264572e-02   +2.817531865594520e-01   +3.777230625626840e-01   +4.635993305744835e-01];
L5_L2_iGABA_netcon = [+5.652004690106057e-02   +1.486994271209395e-01   +3.799282765576443e-01   +1.903621766647929e-01   +2.065129096064766e-01   +4.974516024783284e-01; +4.665789409146991e-01   -6.647062514899917e-02   +4.106914237114612e-01   +7.542398173278145e-02   +4.200893740034461e-01   +5.277226797632825e-01; +5.922405128167363e-01   +3.476842708470474e-01   +1.671613394499640e-01   +8.528675006255598e-02   +2.584750468096617e-01   +1.715715261167247e-01; +1.881281379600312e-01   +2.983145454259349e-01   +3.464301078979078e-01   +4.856656658091395e-02   +5.114387019207731e-01   +5.206091954379196e-03; +3.057946405132152e-01   +3.600096687918159e-01   +4.419697029190235e-01   +3.362478581579588e-01   +1.104919248017236e-01   +2.675780543584333e-01; +1.375426623473048e-02   +4.073220564299858e-01   +8.232220465576219e-02   +3.115567913714449e-01   +2.778887861524075e-01   +2.749834157082895e-01; +9.006129502588375e-02   +3.058673781060269e-01   +4.459927191008932e-01   +4.125563519998135e-02   +3.500667366109293e-01   +2.482168601123584e-01; +5.096385209333267e-01   +1.049688880763369e-01   +1.023673114582952e-01   +5.223114900547181e-01   +1.218380947231061e-01   +2.192248926739455e-02; +1.374972860686982e-01   +1.813378429231555e-01   -8.304577562449870e-02   +4.276619577120269e-01   +8.073391820383473e-02   +3.899271333499346e-01];
L3_L2_iAMPA_netcon = [+5.081610465031146e-02   +2.417873679611636e-01   +3.334844753825593e-01   +1.158456668593540e-01   +5.769932056540530e-01   +3.898678594305697e-01; +1.464419912550270e-01   +1.643130493489624e-01   +3.443042219376838e-01   +4.466405234834531e-01   +2.731519072349672e-01   +1.952616330593448e-01; +2.643292067757699e-01   +1.003073478804155e-01   +2.192707301086466e-01   +6.169281527589697e-02   +1.421298707951982e-01   +2.114881609727355e-01; +3.000552356665529e-01   +1.869275277566508e-01   +1.177446788622850e-01   +2.794951771769850e-01   +1.220513274155041e-01   +4.168570095183858e-01; +5.580483714349402e-02   +1.507027580417304e-03   -3.057931433475294e-02   +4.313435600077282e-01   +4.280911347246724e-01   +4.807361174873421e-01; +4.183817899106507e-01   +9.922425312164830e-02   -1.525892017646284e-02   +2.040031002993385e-01   +2.566288103235472e-01   +2.938072459329317e-01; +2.278435400303953e-01   +4.371122502550023e-01   +2.062063558789962e-01   +8.653894038710212e-02   +1.538921732278252e-01   +1.290110149165717e-01; +1.173023045634347e-01   +4.278966408368799e-01   +4.385454237835691e-01   +2.583880310444695e-01   +4.254489715305632e-01   +2.304261614336517e-01; +1.886719088112850e-02   +2.197384117466239e-01   +2.961440250212838e-01   +2.020440147226122e-02   +3.126619694695235e-01   +4.899885875446305e-01];
L2_L3_iGABA_netcon = [+4.323903073128365e-01   +8.808584697491199e-02   +2.456556208524555e-01   +3.486245693152470e-01   +2.579505515627714e-01   +3.219307558937404e-01   +2.367406158402736e-01   +4.162933987863162e-01   +5.052278444313556e-01; +1.210903542484816e-01   +5.550117748033219e-01   +4.922280301034678e-01   +3.586759900732970e-01   +3.381472787417841e-01   +1.847197369110121e-01   +3.393444193540733e-01   +1.227415770259983e-01   +1.661362330755578e-01; +8.143362824399079e-02   +4.070572778600782e-01   +4.567612793175295e-01   +5.371841114830564e-01   +6.069534454020234e-02   +4.123825869339405e-01   +4.462471632311198e-01   +2.331237759029440e-01   +2.092122795608203e-01; +1.306286549448785e-01   +4.353306763594907e-01   +2.201981478017541e-01   +4.314396018720834e-01   +3.072626274232858e-01   +2.274042857581902e-01   +8.022850538742755e-02   +1.947852442673908e-01   +1.275407921697988e-03; +1.205595303078364e-01   +3.945150950737220e-01   +1.333566797766021e-01   +2.079128735005358e-01   -6.687331190225397e-02   +3.432538031070708e-01   +7.828287110719265e-02   +2.420034156517722e-01   +1.085203428408149e-01; +3.079021469169395e-02   +3.037648456955352e-01   +2.592430680310014e-01   +4.553238070413647e-01   +1.988062829421794e-01   +1.911356571967156e-01   +1.391110023693791e-01   +4.006495190809269e-01   +5.100381513392993e-01];
L1_L4_iGABA_netcon = [+1.390403051590445e-01   +1.259829583335808e-01   +1.418009835369864e-01   +1.059504531466549e-01   +2.949500618725037e-01   +7.616150426846788e-02   +3.673198689978748e-01   +1.479118709156195e-01   +8.546111314605256e-02; +6.796001837994226e-02   +4.214061497061380e-01   +4.175173536961154e-01   +2.777310498224219e-01   +2.235889602213569e-01   +3.166341879646324e-01   +4.487924585511422e-01   +2.165877349644569e-01   +1.407392772833218e-01; +4.254809607547931e-01   +1.538515370749499e-01   +4.021741393765048e-01   +1.289626921040005e-01   +4.032792644291858e-01   -1.706917991903485e-02   +2.057707424565330e-01   -4.944397382777590e-02   +4.432742422015567e-01; +1.245228749988294e-01   +3.574365529072501e-01   +4.635322825803557e-01   +1.255873674055912e-01   -2.740968257523464e-02   +7.870882961414485e-02   +2.991902821763689e-01   +1.387004113757072e-01   +4.571789102689879e-01; +8.860201730839827e-02   +4.893440078284280e-01   +2.865077061698030e-01   +4.208946002665807e-01   +4.219088060797598e-01   +4.939741211143402e-01   +1.178575189455518e-01   +3.508536734528500e-01   +1.400704147968111e-01; +5.239774572741841e-02   +4.681828715472889e-01   +2.379165364317156e-01   +4.204600265781535e-01   +1.603726257392092e-01   +3.725001149363414e-01   +3.177334254862914e-01   +2.419023694328865e-01   +4.151579943239084e-02; +2.159028660536073e-01   +2.655769435796591e-01   +3.268222293604825e-01   +4.714852586609396e-01   +4.964106541532594e-01   +3.367156134765351e-01   +1.523557777102376e-01   -7.171986087939061e-03   +2.038779408823160e-03; +4.177190560843723e-01   +2.045388801729898e-01   +3.426944785390769e-01   +4.224826122299034e-01   +4.042357626813981e-01   +2.321201002520278e-01   +3.548645248897276e-01   +4.293657304430580e-01   +6.295945463893099e-01; +3.602286078586482e-01   +8.912386583669255e-02   -7.226207301734872e-02   -2.587858712693469e-02   +3.444152983958021e-01   +3.124575224703425e-01   +2.804312274023189e-01   +1.486805571830660e-01   +1.604609297199603e-01; +8.318698011131885e-02   +4.667013343000217e-01   +3.449918364244222e-01   +5.274010915550924e-02   +2.203670449992893e-01   +6.233927128000303e-02   +7.977237758317393e-02   +3.763652121829829e-01   +5.302103596181612e-01; +2.916997176983405e-01   +2.414822948067159e-01   +2.015869983809483e-01   +3.557295530699874e-01   +2.220335644449550e-01   +3.667082124464452e-01   +2.703509243064222e-01   +2.498451076703615e-01   +5.050374334032847e-01; +4.503280349962424e-01   +8.305926360503910e-04   -4.902061817677907e-02   +4.193679578685149e-01   +2.800495330387754e-01   +2.961138224984821e-01   +3.163369436744921e-01   +1.515088561124227e-01   +3.561951740078767e-01];
L4_L1_iGABA_netcon = [+2.599266122803962e-01   +2.875008647532712e-01   +2.810034179601968e-01   +1.754990839614401e-01   +2.121036389046511e-02   +4.076205787194342e-01   +1.353301717879073e-01   +7.406763806669553e-02   +3.890359064806039e-01   +1.054326071492273e-01   +1.948468512346055e-01   +2.831355717820218e-01; -1.003761382924694e-01   +1.346892822447901e-01   +2.693861794317700e-01   +4.517709421997073e-01   +1.770307849832356e-01   +1.639220755879220e-01   +5.081090710487373e-01   +1.749657370190937e-01   +5.033084976420824e-01   +1.054453285642890e-01   +8.591210089033410e-02   -4.713535030802309e-02; +2.002837858014216e-01   +3.707667689427596e-01   +3.126781208393454e-01   +1.485547334445790e-01   +3.491774531769265e-01   +3.591395610202066e-01   +1.785948921354448e-01   +4.574384912549995e-01   +3.497587772170142e-01   +3.305326301586335e-01   +2.114341744415420e-01   +2.691764465152862e-01; +3.226466024795130e-01   -7.018083360959776e-02   +3.066922704306383e-01   +2.204430023323495e-01   +2.436765205152799e-02   +3.718405885555723e-01   -1.671461773633670e-03   +5.168795121733385e-01   +2.773034581678855e-01   +3.831911531073988e-01   +5.056887727724661e-02   +4.943665078208709e-01; +4.500478309904061e-01   +5.748866089959948e-01   +3.540178565694180e-01   +1.872401658304225e-01   +2.399814549351519e-01   +3.584794813601438e-01   +1.008209203427976e-02   +2.100849522771525e-01   +9.945367422654844e-02   +6.286530629277780e-01   +4.498015214908845e-01   +4.856542714104323e-01; +7.346584749041732e-02   +2.168556158107711e-01   +1.836360673798072e-01   +4.201404165814732e-01   -1.949031482004664e-02   +2.413971205278215e-01   +4.047879070267191e-01   +5.104013807719058e-01   +7.403313798509149e-02   +9.400858979302605e-02   +1.465733878357021e-01   +7.973226066751321e-02; +3.856550073185542e-01   +2.874603276810031e-02   +1.944315504764774e-01   +1.711858490260455e-01   +4.843319777573707e-02   +2.487731049377225e-01   +1.911047149927755e-01   +4.551212954954586e-01   +1.610210659639085e-01   +1.249955320948382e-02   +1.596515774292576e-01   +4.023875666533932e-01; +5.198896595900959e-01   +1.233258004231398e-01   +1.270722866501411e-01   +8.963071769275223e-02   +4.884513288847657e-01   +1.924030684766243e-01   +3.912584595882028e-01   +2.592306743220595e-01   +5.048625182225066e-01   +4.695122871077413e-01   +3.469201842477355e-01   +2.187830140404241e-01; +4.799296899435623e-01   +1.339210205488606e-01   +3.432055811913007e-01   +2.871706845768109e-01   +1.639147454282523e-01   +2.959580000008565e-01   +2.174453732606759e-01   +5.200513953490323e-01   +4.794314054341122e-01   +3.076541272591650e-01   +1.649433611236251e-01   +1.987037116372565e-01];
L1_L3_iAMPA_netcon = [+1.904348688398839e-01   +3.162256944284201e-01   +3.471946368325673e-01   +3.884889999838311e-01   +1.525851499980378e-01   +3.029677596418617e-01   +1.180062459172789e-01   +2.414863165384482e-01   +5.800908083266473e-02; +2.544838978052625e-01   +2.576869217530198e-01   +3.266514275838027e-01   +5.416734566959021e-03   +9.574587417440081e-02   +9.981995220043052e-02   +6.303707397269496e-01   +5.268208327730210e-02   +4.289844157588680e-01; +3.579518101823532e-01   +1.880270717121283e-01   +1.270114077116448e-01   +3.309315996084109e-01   +3.001773280331959e-01   +4.679977696671447e-01   +2.867713023949958e-01   +5.107079499470262e-01   +3.494371117964891e-01; +2.959942915102427e-01   +2.145811813720456e-01   +7.996766283376019e-02   -6.539259610645354e-02   +3.886381757750830e-01   +4.705771169248814e-01   +1.854994225895335e-02   +4.105348711388620e-01   +1.482580056243588e-01; -2.587118098101095e-02   +2.336296572245281e-01   +1.761309301755334e-01   +2.201420453806698e-01   -5.058650710299498e-03   +3.577261294106559e-01   +3.652686543184733e-01   +1.133497103579049e-01   +2.461053827644894e-01; +2.547281847276320e-01   +4.652635031789125e-01   +3.021039443226541e-01   +1.003880303422186e-01   +4.098677236358398e-02   +2.911863064425443e-01   +5.414893405251244e-01   +2.662403847464270e-01   +7.153075285275996e-02];
L3_L1_iGABA_netcon = [+5.420345932807381e-01   +4.496819934480109e-01   +3.743942185712574e-01   +1.965600512831300e-01   +7.255654949393719e-02   +2.903574384664723e-01; +3.549031340738737e-01   +9.294730603538071e-02   -1.028812059549440e-02   +4.812252155764633e-02   +6.071101468889811e-04   +1.888880095030541e-01; +4.783354013916372e-01   +7.873820800110438e-02   +3.610851276504465e-01   +1.676739368182774e-01   +4.337773269711471e-01   +3.800390786889823e-01; +9.107201097034587e-02   +3.568460820352868e-01   +2.773899784344571e-01   +1.920042579418803e-01   +4.740855960008029e-01   +2.028516201960065e-01; +3.242869758295684e-01   +1.579401578991956e-01   +2.500340657870248e-01   +4.123096860886152e-01   +1.480918510554637e-01   +1.653420051256023e-01; +3.644951520650385e-01   +2.100759666448519e-01   +2.008448258895509e-01   +5.018187680330505e-01   +4.791693436451434e-01   +4.196276178342015e-01; +2.477981331062498e-02   +3.862042183649586e-02   +4.179640985002714e-01   +2.300262923668091e-01   +2.928446405510302e-01   +2.689092123278602e-02; +2.391026849910169e-01   +2.170524965084187e-01   +4.495521261856236e-01   +1.801618775621483e-01   +1.296578286784196e-01   +9.520449330623959e-02; +3.584788648106302e-01   +4.720545986309811e-01   +5.314332252029205e-01   +1.841743824843602e-01   +1.788862827581056e-01   +4.365682240728254e-01];
L5_Input1_iAMPA_netcon = [-6.614709885220327e-02   +3.604856178617939e-01   -3.468854713765314e-02   +2.146545178888167e-01   -1.010078020198971e-01   +5.541533740031916e-01];
L6_Input2_iAMPA_netcon = [+3.840231694666614e-01   +3.533222593459187e-01   +5.961779714927937e-02   +3.141516737311961e-01   +2.234881445400817e-01   +6.295958912634105e-02];
L5_L6_iAMPA_netcon = [-1.389678523810776e-02   +2.740019929864626e-01   +1.175782660359423e-01   +4.207232326710826e-01   +7.378074371753571e-02   +1.345693198857819e-01; +1.119421389380482e-01   +2.356237037189005e-01   +4.984174463253992e-01   +3.733835239136828e-01   +4.798327298404673e-01   +4.825563030411681e-01; +4.328362561530930e-01   +2.828853511341307e-01   +3.457110534307436e-01   +1.733998262221119e-01   -1.457366927902798e-03   +3.877683398302006e-01; +2.993668528081608e-01   +4.791428876849382e-01   +3.254444899059599e-01   +2.161967475264699e-01   +2.467752929978611e-01   +4.242764932122425e-01; +2.342315203913668e-01   +5.104828706993375e-01   +5.065349299114105e-01   +1.076132482059793e-01   +2.226611701113572e-01   +2.581844140275982e-01; +5.628475944389359e-01   -7.732760022363822e-02   +4.453089145840473e-01   +1.700466054468573e-01   +3.610264186973128e-01   -4.472064697153806e-02];
L4_L5_iAMPA_netcon = [+1.770321443869441e-01   +4.476930883698052e-01   +4.312295466501374e-01   +3.921699757602424e-01   +1.959697249441577e-01   +2.286035650145419e-01   +4.171680998359040e-01   +1.052230377655680e-01   +2.303770477421606e-01   +2.183496157793451e-01   +3.819536808881589e-01   +2.339979614561465e-01; +1.117261864476130e-01   +4.364325927921137e-01   +1.712811509155390e-01   +2.756969882034692e-01   +1.575373518618436e-01   +4.275111686228221e-01   +5.864997950809702e-01   +6.425885621381106e-02   +2.191560007868371e-02   +1.218153576905454e-01   +3.321838674788636e-01   +1.795745013756079e-01; +4.908986267964287e-02   +3.724670519866576e-01   +7.267015072892770e-02   +3.141857638377442e-01   +3.525960871380696e-02   +3.368630443277352e-01   +3.027909760466013e-02   +1.728696226433265e-01   +4.078495157525464e-01   +3.116792131786489e-01   +3.943102137863600e-01   +1.205070593839264e-01; +1.126696840953630e-01   +2.818317871114548e-01   +2.647943629799413e-01   -4.562897321675970e-02   +3.231358894699596e-03   +4.787046548973840e-01   +1.196729716186483e-01   +2.005578141664228e-01   +1.677859029961315e-01   -1.204704225195952e-02   +4.009599595954961e-01   +2.570587486944318e-02; +1.655697374833996e-01   +3.825635371935978e-01   +2.099569123999508e-01   +3.117947219605735e-01   +3.747278992385457e-01   +2.869157674725409e-01   +4.063864176799297e-01   +4.418851820359701e-01   +2.524669014506099e-01   +5.491649977095384e-02   +4.543653378026130e-01   +4.194719732149507e-01; +2.831325351414916e-01   +3.531543206563811e-01   +4.058456082623584e-03   +3.382859099680480e-01   +3.589494906480556e-01   +6.093947711244811e-01   -3.908984761745822e-02   +2.663731842672084e-01   +1.335802504537199e-01   +3.868321138014358e-01   +2.902736015950941e-01   +4.275262614377981e-01];
L6_L4_iAMPA_netcon = [+2.541173114381265e-01   +2.713364374580309e-01   +1.884072296688989e-01   +1.149989473231902e-01   +1.279024698298223e-01   +2.895990615773162e-01; +3.489429718443966e-02   +1.063315765578336e-01   -8.888870042106353e-02   +6.023568916610557e-02   +1.447169094858771e-01   +3.201639845351797e-01; +1.078066848650587e-01   +2.519995299686518e-01   -1.002674100972218e-01   -9.412189831141095e-02   +3.925177038228542e-01   +1.390263588208763e-01; +4.045074128639446e-01   +3.930994337806814e-01   +2.241378986405378e-01   +7.512046962208074e-02   +4.337604354740966e-01   +2.175406912478309e-01; +5.740801622876170e-01   +4.123466618676275e-02   +2.603153047836552e-01   +1.335515473633296e-01   +2.714893066630466e-01   +5.159089883859186e-01; +5.069439190445161e-01   +4.618309185381905e-01   +3.374362970415613e-01   +3.447519070075155e-01   +2.010787798092239e-01   +3.615255484767797e-01; +3.424233723569700e-01   +5.128068704990676e-01   +2.168668457248432e-01   +4.823608909082667e-01   +4.516704687601242e-01   -1.481446927309428e-02; -3.736385489984399e-03   +4.348085098905112e-01   +3.978974234912623e-01   +9.262896569855697e-02   +1.579292335317437e-01   +5.579965280683198e-01; -9.116158674552680e-03   +1.305880747638460e-01   +2.929001910616166e-01   -9.616604973760111e-02   +3.506773468395758e-02   +1.243851023834627e-01; +1.517188039834338e-01   +3.725401765424922e-01   +3.457424705627350e-01   +1.796133761648437e-01   +4.747848325557907e-01   +3.439901062576474e-01; +2.843846524436029e-01   +1.742980840740549e-01   +4.754979132397905e-01   +1.659521263408403e-01   +2.243091416186613e-01   +3.878164372153452e-01; +3.907979976244886e-01   +3.488828939560051e-01   +5.735290284532291e-06   +5.387246685944598e-02   +3.398365232016570e-01   +4.946447427295592e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
