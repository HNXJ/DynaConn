function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.271863744980689e-02   +1.645054947667008e-02   -5.831281731425846e-02   +4.291526636151836e-02   +4.498134570861594e-02   +1.604285097464880e-01   -8.273814460168130e-02   -9.807096961842211e-03   +1.981787282486580e-02; +1.787819423193013e-01   +3.921447936054247e-02   -1.336726148937027e-01   +8.227334317217069e-02   -1.016488497671551e-02   -6.896458728594757e-02   -2.708914160277470e-02   -3.968162363810582e-02   -8.396023363609559e-02; +1.159061215980047e-01   +7.259755950272427e-02   -8.152448927240344e-02   +3.823416368245777e-02   -1.557396412437974e-01   +1.343413784344804e-02   +1.198192718372486e-03   -9.242557346812562e-02   +1.368761541011978e-01; -1.085264812385035e-02   -8.932238594455731e-02   -1.632035427166954e-01   +1.355010877869255e-02   -6.629638938302712e-02   -2.989017394940780e-02   +2.477994529727038e-02   -3.009997929450132e-04   -8.704047234573062e-02; +8.594682835914441e-04   +3.001289409278988e-03   -5.447342163039524e-02   -1.009442309444067e-01   -1.509219375946340e-01   -4.998037922546356e-02   +1.603554210115329e-01   +8.434130343915094e-02   -7.430705054558967e-02; -1.004787339028720e-02   -1.517154070683308e-02   +6.296889961970138e-02   +2.536549007041355e-02   -1.051611218295398e-01   -2.637631423878589e-02   -3.212308908572313e-02   -4.923958256755073e-02   +6.463547859186017e-02; +1.162104965484608e-01   +1.412935461260346e-01   +7.575964403965231e-02   +5.555708736252841e-02   +6.089657101794915e-02   +5.113742777524402e-02   -9.565574776887097e-02   +1.144663817697627e-02   -4.426369688301031e-02; +1.647925557251504e-01   -1.407029381906464e-01   +1.713024815217478e-02   +1.002104376293140e-01   +6.867472164301296e-02   -1.093348544851867e-01   +2.168663922663317e-03   +2.307314658520833e-02   +1.131944454631714e-03; +6.107849912671395e-03   -1.911200517917108e-02   +4.177219658423978e-03   -2.890762447596956e-02   -1.553215717033446e-01   +1.244810641240852e-01   +1.265441341054283e-01   +5.558923441887943e-02   -5.764953336254006e-02];
L1_L2_iAMPA_netcon = [-9.235301158201589e-02   +6.238171660994062e-03   -1.074368238894368e-01   +6.360212498284938e-02   -1.387621490272405e-01   -1.174159477638958e-01   -6.704045627586200e-02   +1.082067560994208e-01   -9.296190154766533e-02; -5.158522480104610e-02   +1.134606028032025e-01   +4.209024563201057e-02   +1.185874970078049e-02   -4.549630644883680e-02   +5.737511380030345e-03   +3.770384775393169e-02   +1.352913860834772e-02   +3.871394158607109e-02; -2.219384478690756e-02   -1.182989936976672e-01   +3.708417518253123e-03   +6.611860278374507e-02   -4.979881679666322e-02   +1.386043632738019e-01   +1.570471075182019e-01   -1.128539849637028e-01   -1.911810223617626e-02; -1.140937593193251e-01   +9.039083189288470e-02   +1.050901706888593e-01   +5.184880006556604e-02   -3.950268234866157e-02   +7.035993673384278e-02   -3.347061771870011e-02   +6.299248989813749e-02   -6.098397008582237e-02; -7.415008872363144e-03   -2.301331629593834e-02   -1.056133631803523e-03   -1.741339113821996e-02   +4.706066628796519e-02   -5.268630347740658e-02   -1.528049754496902e-01   +6.381937752242927e-03   +1.638691094397907e-01; +9.102165427748651e-02   -1.112176811589518e-01   +7.954090446052142e-02   -7.088223094079404e-02   -4.796305426275900e-02   +1.199668415887652e-01   +5.831352776786392e-02   +8.041307938473225e-03   +3.285744576646946e-02; -1.947647493716377e-03   +1.546691275383903e-01   -1.622909084884764e-01   +3.370498196468096e-02   -4.500390188448204e-02   +5.191993634561728e-04   -8.909973719926911e-03   +8.711794343486540e-02   +9.020763756790715e-02; -1.782094816760614e-02   -6.115056720850873e-02   -9.048319228570958e-02   -9.007437603251812e-02   +6.573298306260196e-02   +8.957605369870902e-02   -1.452688652152282e-01   +1.201758765083143e-01   -1.055357811187322e-01; +6.451216228594728e-02   -2.378407205415245e-02   -1.940189199272440e-02   +8.706762445144330e-02   -5.925576359052838e-02   -8.976479476233010e-03   +7.311194430743867e-02   +4.853192589665221e-02   +3.305640120680131e-03];
L2_L5_iAMPA_netcon = [+4.312047046580243e-03   -1.034862844728855e-01   +4.244613021966295e-03   +6.290933981822563e-02   +8.736068433984988e-02   -1.045393169181502e-01   +7.292186643383911e-03   -7.114430397949457e-02   +1.210468708365550e-01; -6.887547925442310e-02   -1.210438623773168e-01   +1.342428832478396e-01   +1.152231048292036e-01   -2.324294674333254e-02   -3.576908999342407e-02   -5.514438213294968e-02   +1.911684836262849e-01   -1.100230794931308e-03; +1.785735820368062e-01   -5.381598928667940e-02   +1.497587745099692e-01   +7.921964367098937e-02   +8.313173939640577e-02   +1.692694236285757e-02   +1.642756675547163e-02   +6.033017506529462e-02   +6.740587215806267e-02; -9.234253971480977e-02   +1.086784877284950e-01   +1.054517566509638e-02   +1.326274265040691e-01   +1.541099647970069e-01   -3.677380783514389e-02   +1.530896219331770e-02   -3.437232325771261e-02   +2.886959806743765e-02; +2.845713682598779e-02   -4.190670471706199e-03   -5.403531063302090e-02   -1.051595408372631e-02   +5.521463490051091e-02   +1.059866701127955e-02   +1.790050499654782e-01   +2.200876381320073e-02   +5.113213530612647e-02; -7.871685825903370e-02   +2.624712817951201e-02   +3.898688372222128e-02   +4.199570528133278e-02   +2.836983303357923e-02   +4.807679656076140e-02   -2.451545926627482e-02   -5.763424053253378e-03   +2.205169546901167e-02];
L5_L2_iGABA_netcon = [-3.586991783740583e-02   -4.891738752319605e-02   -8.795136556200531e-02   +2.608104081066424e-02   -5.367856360825912e-02   +4.215299735576805e-02; -7.264588650767256e-02   +2.743305973872746e-03   +1.373700265547982e-01   +7.876772083998401e-02   +2.701389872257295e-02   -2.869435582157553e-02; +6.456374356813344e-02   +1.379337387935635e-02   +9.228625335584482e-02   +1.261907603191916e-01   -7.310872885208701e-02   +2.453865290627504e-03; +1.359308517934625e-02   +1.149107669644947e-01   -1.929970349480005e-02   -1.044329998197738e-01   +5.375754606882435e-02   +9.969152175880902e-02; +3.557394132395654e-02   -1.203715331419871e-01   -2.016217856946514e-02   +8.251292804255777e-03   -7.233288441207704e-02   -3.567125384167032e-02; -5.674751585807137e-02   -7.975916001132878e-02   +5.298443183256492e-02   -4.812429288633709e-02   +4.380075424490784e-02   +5.835826493947126e-02; +7.799859044243924e-02   -4.936447647437609e-02   +5.391232522409055e-02   -2.450939351003517e-02   -1.144992970957690e-03   +1.273665800106434e-01; +1.269843334747272e-01   -7.950354939240498e-02   +8.053956096521177e-02   +7.488634840108857e-03   +5.142306832988843e-02   -6.204062383837235e-02; +9.301465766268832e-02   -4.450369579897728e-02   +1.805289643499048e-02   +1.600533882065450e-02   +8.535927623231387e-02   +1.074933797883023e-01];
L3_L2_iAMPA_netcon = [+7.202509993235562e-02   +5.751877053443576e-02   +6.246362075109008e-02   +1.120859411495217e-01   -6.698715784205511e-02   -4.729170963393611e-02; -3.154935280191366e-02   +1.631998829070254e-02   -1.248633046600424e-01   +4.160245558907244e-02   +1.211166677490567e-01   -1.050428050483256e-01; -1.315537111362364e-02   +1.731704064352814e-01   -1.278865540175546e-01   -4.639938471904620e-02   +1.032613921361819e-02   +9.447879369334153e-04; +3.217769521196920e-02   -6.221689135537558e-02   +5.368571273223986e-02   +7.492880855357215e-02   -7.983777953850407e-02   -3.894733226824190e-02; +1.203894421829350e-01   +1.356572126893921e-02   +2.576300354410269e-02   +8.792423271354481e-03   -5.850743495626315e-02   -2.375324035610522e-02; +6.490673237651134e-02   +3.501855803404711e-03   +1.459200640166674e-02   +2.155373803081351e-02   +1.787031886521860e-02   -9.616736784111074e-03; -6.615221094149645e-02   -3.981167147758145e-02   +3.275588058295965e-02   +7.914935548197156e-03   -5.111201947632048e-02   +7.208438980778917e-02; +2.378887742568218e-02   -1.533429337751730e-01   +2.673013417622291e-02   -1.062387654450072e-01   +9.560658478511078e-03   -4.827662174408225e-02; +3.604432039888950e-02   -2.230668904950775e-02   -4.388038370335704e-02   -8.269364202477425e-02   -1.404190923383569e-01   +9.365488009031113e-02];
L2_L3_iGABA_netcon = [+2.006370163841414e-02   +1.084911999545028e-01   +5.920086076316499e-02   -9.152852822443869e-02   -1.593057528847497e-01   +2.670221397199193e-02   -1.632907227169847e-02   -5.351449816373917e-02   -5.485602792864922e-02; -5.791481007194587e-02   +4.672410905621956e-02   -1.031306100629290e-01   +4.966652009752763e-02   +1.103318376271312e-02   -1.923583232288050e-02   -2.069060431731960e-02   -3.710234320277114e-02   +7.475675854457045e-02; +1.256206292218500e-01   +7.317177944536807e-02   +9.988288975302856e-02   +2.904786401805183e-02   +7.276500687139094e-02   -1.067722413250543e-01   +5.600586361037142e-02   -7.429950945898540e-02   -5.208914656199039e-02; +3.881857677045355e-02   -3.511085572514988e-02   -1.188596869329154e-01   -7.637912052792928e-02   -2.091570111993278e-02   -1.332937591391323e-02   -6.166063810720289e-03   -2.831684333317590e-02   +3.905205120232914e-02; -6.880339799567634e-03   -7.930232041516164e-02   +1.791032808798950e-01   +8.599775150526558e-02   -4.008976476460903e-04   -5.067069273251602e-02   +6.115171679393058e-02   -6.402985114408059e-03   -4.693541178560902e-02; +2.353878538662427e-02   +1.620733204779249e-01   +3.106856020149054e-03   -4.463705812426387e-02   -8.147676845978565e-02   -1.148033557066930e-01   -1.152633235620684e-01   -3.274556119568595e-02   -4.126828687490630e-02];
L1_L4_iGABA_netcon = [-2.176182253385852e-01   +8.884795640773839e-02   -8.269532898738674e-02   -2.553873243472451e-02   -2.441879594767647e-02   +9.799350807990609e-02   +9.048137375130660e-02   +8.792859888967783e-02   -5.712140414137094e-02; +1.038947476241334e-01   +4.032152911089384e-02   -6.000027231247868e-02   -1.485532887427352e-01   -1.426788143369242e-01   +4.085564855316402e-02   -2.872424294204451e-03   +1.198943491458506e-02   -2.832821396442521e-02; +1.079926619819330e-01   +1.153183853951629e-01   +3.915720456428842e-02   -1.826170008034834e-02   -1.344917605964089e-01   +5.593258327980440e-02   -5.072685830550781e-02   +7.824740755870593e-02   -1.042129097193952e-01; +7.621827717269825e-03   +9.965808980584724e-03   +4.836148719473924e-02   +2.292654236236560e-02   -1.250395880750607e-01   +3.588373745568912e-02   +1.540125883726170e-02   -3.330728183637627e-02   -4.562233985388284e-02; -9.585409996322822e-03   +8.041456519500197e-02   +7.022109134443952e-02   -2.098825420494871e-01   -3.113966873919210e-02   -9.446359568682755e-03   +9.509570057896759e-02   +1.043514813307376e-01   -1.246480499378877e-01; -1.213728141261712e-02   -1.757837034017704e-03   +2.135826744716055e-02   -9.552057730040184e-02   +1.363452069980216e-01   +3.289311905738741e-02   -8.009327696451679e-02   +1.171381340068315e-01   -1.005963570945820e-01; +4.845848501660800e-02   -4.309375901957282e-02   -1.099523642670242e-01   +5.741854655620825e-02   +8.707412713464381e-02   -3.903343456010715e-02   +1.277309035327641e-01   +9.169906612273036e-02   -1.074417149438172e-01; +5.670727216605747e-02   +9.913025107676264e-02   -2.754813434456514e-02   -3.221346346170612e-02   -2.992616464629462e-02   +3.617322634070891e-02   +5.237226038166363e-02   +9.261386710991887e-02   -8.888187344443138e-02; +8.944852492814886e-03   +2.271140440573938e-02   -3.281824911258408e-02   -5.309495768715335e-02   +1.800196292577436e-02   -1.310135048059576e-01   -1.304896498465220e-02   -8.555815876774633e-04   +5.369395173143530e-02; -7.910820036186161e-03   -1.523296142916928e-01   -3.219085429954107e-02   -6.768263639925670e-02   -2.884469556623561e-02   +1.579911882428982e-01   +1.040495438074550e-01   -1.455966959640672e-01   +4.664095936526072e-04; -8.569574444293777e-02   +1.167380593603634e-01   +1.494137715564313e-02   -9.275520977731758e-02   -3.778507240085818e-02   +1.173865343021559e-01   +1.403165476217696e-01   +1.191255382232480e-01   +7.152263874492633e-02; -7.160364433898889e-02   +1.800375172194748e-02   -3.110847861844549e-02   +3.949038311889946e-02   +3.782676374312567e-02   -5.394987511634174e-02   -1.390703465655550e-01   -1.035670395755196e-01   +7.308226891075292e-02];
L4_L1_iAMPA_netcon = [-1.955803007075034e-03   +1.450777878126936e-02   -3.703615581954763e-02   +8.145311497421107e-02   -1.228430484103229e-02   -4.831829121499834e-02   -4.154249620056920e-02   +1.062155153931316e-02   +1.066643096072334e-01   -1.126440093319348e-02   +2.318610802880711e-02   +3.546361833692595e-02; +1.634959914484722e-01   -6.056096203759095e-02   +7.097431698601953e-02   +4.150081071585682e-02   +1.212612261262092e-01   +1.703932706978522e-01   +8.150788383575394e-02   -7.234651032944979e-02   -1.202609659737012e-01   +7.901561767156883e-03   -3.044608357365568e-02   +5.214407790772563e-02; +4.410726918564700e-02   +2.559516437083923e-02   +9.283799953346712e-02   -4.350134207841141e-02   +2.413678026195475e-02   +3.556923720585830e-03   +2.224433158610885e-04   -7.884396430770824e-02   -7.244691742157087e-02   -6.344518969671903e-02   +4.376452859946302e-02   +6.677252534917451e-02; -5.621029111747090e-02   -1.039348723139616e-01   +1.744399772687209e-01   +1.123058454472124e-01   -6.246004938585051e-02   +9.750003659328325e-02   -5.581423287475408e-03   -1.016330211155531e-02   +1.600257086830262e-02   +1.639266938563640e-02   +3.353895673444426e-02   +2.721317580122317e-02; -9.134715329466463e-03   +4.696646092178142e-02   -5.615232072814919e-03   +8.564588138394693e-03   -1.129695169137299e-01   -1.183720142805777e-02   -1.760249751020452e-01   -1.102459000063521e-01   -8.485273538889358e-02   -9.610736037288209e-02   +3.214154667589472e-02   -2.036376174384283e-02; -1.296086333539503e-03   -2.056599893519659e-02   -4.254889300394485e-02   +8.079025246961925e-02   +1.829344853928333e-02   -2.094624481989039e-02   +2.171918622023445e-02   -7.915723376290248e-02   +1.331183974294066e-01   +7.393367198564484e-02   +6.048382181850664e-02   +4.088420953485469e-02; -9.899061081642611e-02   -7.526749504130523e-02   -2.902503213492128e-02   -7.452861887509575e-02   +1.081961848906144e-01   +9.382587615068780e-02   +1.191199868883899e-02   +2.817315792794588e-02   -1.483252852487177e-01   +2.820899239724591e-02   +8.725748958478396e-02   -2.054461359674210e-02; +1.271479985583140e-02   -5.317911562090648e-02   -1.665235860371365e-01   -2.348338201714791e-02   -1.141300033581900e-01   -5.255876340512815e-02   +9.382294506237111e-03   +2.325719086882577e-02   -8.779512155318828e-02   -7.811901641148195e-02   -2.690443849983275e-02   -1.427200282928229e-02; +1.225363264324256e-01   -2.722067941003887e-02   -1.095504916746820e-01   +5.947218335010106e-02   +8.454306380037629e-02   +5.912165016996621e-02   -3.747776394885272e-02   -7.333982179517917e-03   +1.458921899280055e-02   +7.461546063997540e-02   -8.693344780499973e-02   +1.822771632873227e-02];
L1_L3_iAMPA_netcon = [+2.865515402714499e-02   +3.150837785513953e-02   +2.090850048094939e-02   -1.737104731823563e-02   +6.183496163568866e-02   -1.589166962774777e-01   +6.514607680524433e-02   +1.497164088757870e-02   +1.027048354915589e-01; -1.513837659603495e-01   +5.563821013020840e-02   +1.161329638921871e-01   +7.776999999500603e-02   +3.802824139581513e-02   +4.501510689002566e-02   -3.054096691691814e-02   -1.109096338441613e-01   +3.875636003588224e-02; -4.525538636611502e-02   +4.889114808992227e-02   -5.268047858255497e-02   -1.336896063441037e-01   +4.811333978630736e-02   +1.607251483586206e-02   +1.139089794143713e-01   +3.512297026552462e-02   -7.613117286784328e-02; +4.189833720508768e-02   +9.243304243037837e-03   +1.168550340217444e-02   +8.763389956118559e-02   +1.877766383342226e-02   -4.812969091064286e-02   +4.055819633751339e-02   +7.098168429303590e-02   +4.488523353730021e-02; +1.239470408217301e-01   +7.186146594065999e-02   -1.936155884145184e-03   -1.247564819504995e-01   +1.046478466809444e-01   -1.139293277478264e-01   +4.541521249094852e-02   +4.696876536280142e-02   +2.680067335707726e-02; -5.611632398507746e-02   +1.419923103003434e-02   -9.556991547359960e-02   -2.945842740918586e-02   +8.787481899969669e-02   -7.538569681412376e-02   +3.399857701997007e-02   +1.098099315898494e-02   +1.976759841846036e-02];
L3_L1_iGABA_netcon = [-4.460463725997876e-02   -6.950137901403119e-02   -4.143880427928927e-02   -1.056556756978633e-01   -6.926932465433279e-02   +3.507425964456617e-02; +7.069134361438467e-03   -1.369798179665422e-01   -1.250822854303371e-02   -1.527372017737277e-02   +1.270026374547319e-02   +4.443457242779189e-02; -1.020820001034626e-01   +5.163124266577334e-02   +4.431861204779761e-02   -1.920253101723542e-01   +2.643306645365353e-03   +1.000165851618662e-01; +8.436988965764812e-02   -3.629933222627459e-02   -5.888326446695702e-02   -2.237301960680380e-03   +9.031053386895055e-02   -3.953331874513986e-02; +1.478976682894315e-02   +4.533431006193533e-02   +4.274584796220415e-02   +2.599280617567978e-02   +7.041031769224528e-02   -1.976665730011705e-02; +1.508348191501052e-02   -9.287151759612484e-02   +1.478777571397836e-02   +6.884410281872627e-02   -1.712083022022628e-02   -1.066429155319755e-02; +1.955222690585128e-03   +1.381166491482301e-01   +7.832863337090112e-02   -3.027369875453924e-02   -6.259970258990459e-02   +8.483395583208007e-03; -2.693973191994963e-02   +2.809968698723587e-02   +7.643801500938607e-02   -1.587985784835660e-02   +5.055076821523877e-02   +7.014910859065440e-02; +8.066953830753586e-02   +2.848568012969329e-02   +8.597683132369208e-02   -9.093489447877658e-02   -1.280909067770545e-01   +3.884099912414932e-02];
L5_Input1_iAMPA_netcon = [-1.017340522174774e-01   -5.185241135649583e-02   -1.625004690793674e-01   +7.838399060492984e-02   -1.662977021132675e-02   -5.635119441251141e-02];
L6_Input2_iAMPA_netcon = [-1.755783594070593e-02   +5.521163652647808e-02   +1.723670139908868e-02   -3.043573601555100e-02   +6.146745686919042e-02   -1.745745035569777e-02];
L5_L6_iAMPA_netcon = [+9.116090012636802e-02   -6.672967453677206e-02   -6.325623652478576e-02   +1.209016121881071e-01   -1.287795061706923e-01   -1.887441359455145e-01; +3.346076620595911e-02   +5.284338287535559e-02   +6.318724751304899e-02   +4.868814032515061e-02   +5.223787335203321e-02   -2.756176828464389e-02; -9.438377662668423e-02   +4.155814299932684e-02   +4.002556185000331e-02   +6.828965325965385e-02   -9.600488650373598e-03   -5.231993267348173e-02; +1.138848816970446e-02   -1.532444103517892e-01   -5.275133144822786e-02   -2.259512102567215e-01   -8.609385129592113e-02   -7.814113881259389e-03; +3.420463690910916e-03   -1.769015746147182e-02   +1.049091560994462e-01   +4.585835053228320e-02   -3.294369207183059e-02   +1.216526512902882e-01; -5.882274508979903e-02   -4.495303410140192e-02   +5.567604931234232e-03   -6.893157858497054e-02   +3.850039499925106e-02   +2.156007262043703e-02];
L4_L5_iGABA_netcon = [-9.497289512448949e-02   +1.913131974178645e-01   +7.654261522205502e-02   +1.669333669990528e-01   -6.397494911001395e-02   -5.471401644310617e-02   +3.959475292106365e-04   +5.243590061654044e-02   -2.751552173420387e-02   +1.057657081824957e-01   +3.954341599318124e-02   -7.535358405727503e-02; -8.515240789752246e-02   -4.922759778076954e-03   +1.874545216237103e-01   +1.254282936178502e-01   +3.920186413616509e-02   -6.952675204432641e-03   +8.269641310006716e-02   -2.548362503614100e-03   -8.157437197906639e-02   -3.864322990264737e-02   +1.473402485753147e-01   +7.520757135503386e-02; -3.297114579029119e-02   +4.425406307501871e-03   +7.144989780016210e-02   -2.867532918871108e-02   -3.852897866143595e-03   -3.835305118891461e-02   -8.911222398519400e-02   -4.541236977727262e-02   -7.850060478929032e-02   +8.887111120750982e-02   -4.819262683504816e-02   +9.907703949231812e-02; +1.440913635616122e-01   +2.933731947657520e-03   -1.022771996781250e-01   +3.553666580031803e-02   +8.947032029918195e-02   -2.188923691631198e-02   +1.384862089408457e-01   +1.213687876912824e-01   -9.689848652828130e-02   +6.373721410823714e-02   +1.258647575923078e-01   +1.870557999008667e-01; +6.415386228075830e-02   +1.308042054148882e-01   -7.632449960004614e-02   +8.109696097954927e-02   -4.097061172632372e-02   -6.192377419315866e-03   +5.087962856755143e-02   -1.072598631388250e-01   +1.649936860311552e-01   -9.472271577581173e-02   +1.723134439344540e-01   -5.187077778612135e-02; -1.064241638239084e-02   +2.395092577486123e-02   -1.063877662499428e-01   -2.481472398658354e-02   +7.638372805217464e-02   +2.041430326441602e-02   +1.043133557797444e-02   +6.479847782377597e-02   +7.112508595954264e-02   -1.588746847317535e-02   -6.239005481438127e-03   +1.332584439289848e-02];
L6_L4_iAMPA_netcon = [-9.177638783891696e-02   -2.005127548019592e-01   -1.047661241404656e-01   -1.060603330476762e-01   +2.116149582471482e-01   -5.038958551418214e-02; -7.675433327886681e-03   -1.325393929874951e-01   +4.127554141516103e-02   -2.130756735391006e-02   -7.944447060500553e-02   -2.567906130403946e-02; -1.484189928158368e-01   -1.488808722611900e-01   +3.451431728869811e-02   +4.468329839132260e-02   +5.774798575127010e-02   +1.245294690726225e-01; +3.542116384969224e-02   -1.295244554741077e-01   -6.862180470089574e-02   +6.012490620680874e-03   -4.421150902323073e-03   +1.018771093617482e-01; +2.496105962176803e-02   +4.004644331850866e-02   +1.052480781695457e-01   -5.415595259587092e-02   +8.525012486486180e-02   -5.116105730015927e-02; +4.285390859636391e-02   +1.054086805761356e-01   +8.952197071216014e-02   -3.491203255367195e-02   +2.437234018233881e-02   -1.047495296360747e-01; +6.439035931156836e-02   +2.332067132890620e-02   -1.077909562787520e-01   +9.502099770283327e-03   -9.473740133630876e-02   +7.668595803003260e-02; +4.798610359060941e-02   +2.798319395153158e-02   +2.714545421059534e-01   +4.474904715107002e-02   -3.288743242297958e-02   -7.331232409622504e-02; -1.092093645897633e-01   -1.301793881384926e-01   +2.754715778196987e-02   +2.649233646324793e-02   -2.736870661462623e-02   +1.552630062954842e-02; +9.775222175558161e-02   +3.350275624204385e-02   -3.098700541014793e-02   -8.030154290040464e-02   +2.108621308989642e-01   -7.834626055068400e-02; -4.598586895608206e-02   -3.423271175418550e-02   -4.774952073795968e-03   +2.889201525902163e-03   +7.637039334363761e-03   -5.705312210762953e-02; -1.059431099918117e-02   +6.393424501816465e-03   +1.038325029014991e-01   -2.113776207327841e-02   +1.762409700032973e-01   +1.692321848487554e-02];
L5_L4_iAMPA_netcon = [-1.370321362442656e-01   -2.304975456617223e-01   +6.617164428077113e-02   +7.876621000624331e-03   +6.610326714510344e-02   +2.492009383544386e-02; -3.840143062504529e-02   -4.688066662776029e-02   +1.203644654525466e-01   -1.824994413012355e-03   +3.908729635218565e-02   +4.043039844584184e-02; +6.658809893924503e-02   +1.664198560176642e-01   -1.129582369183575e-03   +5.395558101469995e-02   -5.578670975196820e-03   +1.063128723545371e-01; -5.996474368724508e-02   -5.654937312062706e-03   -2.452026161859760e-02   -1.399850136852265e-02   -8.126906414884935e-02   -6.656684154360668e-02; -6.825527885262195e-03   +1.138054909099332e-01   -7.447713600625218e-03   -9.704620490705994e-02   +4.994935301005212e-02   -9.205985209534767e-02; -1.431004764234843e-02   +6.249191356020316e-02   -4.060046024533545e-02   +2.975804724120213e-02   +5.043372172313496e-02   -1.506454914654081e-02; +2.477388514396706e-02   -1.093331584113237e-01   -3.689748384217099e-02   -6.156849589530703e-02   +7.286138250618897e-02   +6.840098518663497e-02; -1.742462663492891e-02   +1.070365863373096e-01   -1.427650604536030e-01   +7.984248999002569e-02   -3.800987592442150e-04   +1.609668933312862e-01; -1.691004178515924e-02   -2.070597992291865e-02   +3.085919056649651e-02   -1.057232728088761e-03   -4.878026715890295e-02   -7.112980558153224e-02; +9.692892012879684e-02   +1.187929897358631e-03   -6.304714983362533e-02   +4.007861945075408e-02   -1.322451996859684e-01   -1.080597018591433e-01; -1.211607624859163e-01   -5.409878299723394e-02   +1.121068032245364e-01   +2.806703973307309e-02   +2.826724773131013e-02   -5.521689650406153e-02; +2.761249359681942e-02   -1.402116475633456e-01   -1.348792140468149e-01   +8.793533716908609e-02   -3.936286149020675e-02   +8.901495003360194e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
