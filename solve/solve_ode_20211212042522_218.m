function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.183432968061551e-01   +1.259140517000863e-01   +5.952409528101920e-01   +1.971588736461537e-01   +4.128722499541936e-01   +1.489727079295782e-01   +5.184341505203262e-01   +1.000000000000000e+00   +4.943381891961298e-01; -1.695835926900864e-01   +2.765360730991552e-01   -1.680498460166848e-01   +1.997167794280906e-01   +1.856576675019464e-01   +5.536785692489141e-01   +2.171622305732955e-02   +7.253955648688026e-01   +2.462763860587687e-01; +1.984302413239865e-01   +1.312969125368958e-01   +2.815477623668447e-01   +1.060897546178693e-01   +3.446647067660684e-01   +7.909888263867647e-02   +4.581144788711660e-01   +6.468426553631617e-01   -9.966637666608245e-02; +3.423312356553325e-01   +1.173921799513063e-01   +7.537523804501389e-01   +4.853314889212263e-01   -7.165884115868976e-03   +3.065369933757704e-01   +1.018349077752188e-01   +8.374113181286198e-01   +6.702322348728693e-01; +1.147296610393959e-01   +1.680627374043101e-01   +3.915269381003141e-01   +2.703654590079687e-01   +2.851640014123151e-01   +3.315782675703015e-01   +4.318221591227156e-01   +6.447403274440207e-01   +5.078416055768951e-01; +4.307966842581352e-01   +7.266720256978659e-01   +5.724587853385410e-01   +3.477284705602843e-01   +2.656321840509864e-01   +5.807328908678961e-02   +4.158210933510178e-01   +4.902172739903686e-01   +1.334012311868144e-01; +2.930514159028409e-01   +9.073881647933804e-01   +4.059456050701799e-01   +7.720026590952558e-01   +6.113581164642427e-01   -1.065161622004464e-01   +3.797975976884446e-01   +6.251553593112054e-02   +7.540499694135955e-01; +5.159635490422403e-01   +1.146512176350507e-01   +5.890063174205529e-01   +8.669194795327633e-01   -4.388675423795443e-02   +2.958817289488744e-01   +2.881918738393820e-01   +4.628229663226678e-02   -2.102033612489968e-01; +9.238807586912754e-01   -2.865122230055817e-03   +7.043800778498316e-02   +4.089858699875865e-01   +5.002515954160182e-01   +1.873260900935653e-01   +4.409039015006372e-01   -3.613156203579401e-01   +4.117475644671075e-01];
L1_L2_iAMPA_netcon = [+1.812786698688929e-01   +4.501094315953873e-01   -1.911632165192871e-01   +2.384151081310615e-01   -5.986175877909409e-02   +1.613579122557938e-01   -3.152258402572740e-02   +3.449630359988849e-02   +5.366717211369934e-01; +5.637644632992588e-01   +2.884674786574555e-01   +4.910042690048086e-01   +8.426359348638889e-02   +2.027012239066247e-01   +3.515146540171904e-01   +9.022935426147864e-01   -1.994980815623826e-01   -1.154270352936833e-01; -6.496263678515946e-02   +5.093249234717567e-01   +7.599034835858830e-01   +6.033404446404869e-01   -2.855166307293526e-02   -2.239756969665522e-01   +1.009937012065088e-01   +1.802961166809133e-02   +3.346177728458964e-01; +4.577624684075368e-01   +7.330705776841285e-01   -2.295012117683189e-01   -8.857556377872810e-03   +8.144541435979112e-01   +6.417989659561048e-02   +4.550959654901680e-01   +4.931950829175710e-01   +4.339257507434859e-01; +1.884316997585031e-01   +7.111517189219185e-02   -3.074082991788827e-02   +3.911030345416314e-01   -9.756467475402171e-02   +2.403161983933474e-01   +4.919468863843953e-01   +2.271141760278367e-01   -2.472607623218598e-01; +5.834747946046436e-01   +6.624459005409022e-01   +2.366455144229266e-01   +6.316361373088734e-01   +6.613946733138859e-01   +3.543798414917535e-01   +3.025295281395863e-01   +3.797036806759874e-01   +1.647861407332979e-01; +8.552007178639116e-02   +4.168753275626887e-01   +1.618777676900365e-01   -2.294713257653154e-01   -1.865055705146580e-01   -9.515398949204432e-02   +8.199021184120386e-01   +8.217263442573386e-02   +1.000000000000000e+00; +4.665703120403178e-01   +2.444337191494426e-01   +5.585573175749301e-01   +2.862606342075915e-01   +8.450490112472546e-01   +3.039145242900622e-01   +1.746511477848374e-02   +8.003314317590946e-01   +6.081367032470021e-01; +6.106188491239306e-01   +2.983418043232572e-01   +2.745607586623626e-01   +3.058561973759636e-01   +4.043598799757716e-01   +2.546159428739470e-01   +2.878950058557669e-01   +1.525787905870959e-01   +2.129769345586953e-01];
L2_L5_iAMPA_netcon = [-3.848591189351204e-01   +1.961179335608473e-01   +7.592462744397389e-01   +7.376920386961348e-01   -6.011953368825922e-02   +5.173108355517428e-01   +6.886856752705844e-01   +4.424228913771636e-01   +7.703612306930088e-01; +4.717205624648089e-01   +9.601728546523541e-01   +1.816385294025858e-01   +4.186264909205044e-01   +3.929137433282371e-01   +3.578816406158297e-02   +1.865446519983979e-01   +1.962923573330825e-01   +1.000000000000000e+00; +7.517612303330243e-01   +3.232828822288308e-01   -4.009453860416876e-01   +6.480431105809010e-01   -4.647575298197718e-02   +5.667236676857901e-01   +5.158933315569290e-01   +3.798990120869679e-01   +6.287866923512363e-01; +7.365867370863148e-01   +3.112634079314049e-01   +8.682762038874876e-01   +1.566787584843699e-01   -2.221325102588464e-01   -2.076059999633372e-01   +4.895819699762503e-01   +5.614672266010912e-01   +8.704718503119959e-01; +6.637234746578217e-01   +3.787906737425241e-01   +5.956008217737335e-01   +5.808058527935849e-01   +1.990129649794942e-02   +8.160228370524432e-01   +2.607797548313818e-01   -1.449523347666276e-01   +4.034040533406455e-01; +5.691986535783573e-01   +2.886425180660196e-01   -2.295591087991534e-02   +8.712029754655606e-01   +5.200298213236784e-02   +5.148058604417991e-01   +2.585827166893510e-01   +3.238785015197303e-02   +3.169910246145500e-01];
L5_L2_iGABA_netcon = [+2.364844303654455e-01   +6.082405682679402e-01   +1.119273607134253e-01   +3.993609160114748e-01   -2.119062118581498e-02   +2.454763392891902e-02; +9.520039061823165e-01   +4.772618120253996e-01   +1.974650817453848e-01   -7.024584577143568e-02   +5.639818445566834e-01   +4.654140513088833e-01; +4.674045150762539e-01   +4.754190208177090e-01   +6.587883845590756e-01   +1.000000000000000e+00   +3.875509978223269e-01   +3.332545175049012e-01; -1.316023104925410e-01   +6.379439053467442e-01   +8.099175554547866e-02   +4.368074294097664e-01   +8.796398371749488e-01   +1.768404235480323e-01; +9.454467545372978e-01   +4.278272081417189e-01   +6.699280196718561e-01   +8.505485283301849e-02   +1.024290146183500e-01   +3.809876307406752e-01; +3.646738785615157e-01   -9.575181650268884e-02   +6.209290895417556e-01   +6.513648926956501e-01   +2.634283186085654e-03   +2.749962336160475e-01; +8.628621470633441e-01   +3.636931548135241e-01   +7.466897672380611e-01   +4.450537928865874e-01   +9.084817327967244e-01   +2.625877436148416e-01; +5.018890447773647e-01   +4.183261996428705e-01   +7.638747064617630e-01   +7.205006879406896e-01   +3.049339927838703e-02   +2.193791010228262e-01; +5.570624454997657e-01   +8.256371176901696e-01   +5.782948694876245e-01   +3.509643704567607e-01   -1.929266773856924e-01   +2.817255052310129e-01];
L3_L2_iAMPA_netcon = [-6.275390480250798e-02   +3.532952299541614e-01   +1.585729265987061e-01   +2.020148335309317e-01   +5.274334869342873e-01   -8.345680874873633e-02; +1.940894961868885e-01   +6.806121900082698e-01   +8.084593246202255e-02   -1.782774434448010e-01   +2.464788293461695e-01   +6.528705644550702e-01; +3.171268300310836e-01   -6.664402448292764e-02   -1.015773458210949e-01   +8.489093915684116e-01   +5.570574166000732e-01   +4.149385534987738e-01; +9.769002646975000e-01   +6.383218560297628e-01   -1.201217623071176e-01   +3.125579158093810e-01   +1.000000000000000e+00   +2.033312841007643e-01; -1.163168379782762e-01   +3.663926460966071e-01   +1.795150841811412e-01   +5.749664201625755e-01   +3.148078846396776e-01   +9.906657891216037e-01; +6.033048774817423e-01   +1.668486429357454e-01   +3.534677217164510e-01   +2.008857565123671e-01   +3.332841515910435e-01   -3.170553758389060e-02; +9.609353577970834e-01   +2.173622594963890e-01   +4.574389636163404e-01   +6.845335571344806e-01   +1.472526682570107e-01   +2.597420768079615e-01; +4.356559186774865e-01   +1.109180305088191e-01   +2.252880225399311e-01   +3.735850563157627e-01   +5.651443176551897e-01   +7.904107156387303e-01; +8.197034706546112e-01   +4.316518951338793e-02   -2.538026387860812e-02   +1.261642852529767e-01   +5.404208674118051e-01   +1.484648767543373e-01];
L2_L3_iGABA_netcon = [+4.559373511475309e-01   -1.850796499835766e-01   +2.016874872922911e-01   +8.067394946718990e-01   +9.831479938868959e-01   +7.222598424809102e-01   +7.167758982941616e-01   +2.490866055082112e-02   +5.290694873082994e-01; +1.738943528771484e-01   +6.541941317109574e-01   +2.998070540351280e-02   -2.505461290520291e-01   +1.000000000000000e+00   +1.815761414578184e-01   +3.270559097107817e-01   +8.274423310710810e-01   +1.071864212009348e-01; +2.960883837124326e-01   +3.831589530346673e-01   +9.975760888846371e-01   +5.519555728961809e-01   +8.451960752102106e-01   +8.052015547111424e-01   -2.017554177061930e-01   +7.010381754180098e-01   +5.869075785600391e-01; +2.078031512036093e-01   +1.104581804361012e-01   +4.030632072653339e-01   +9.928808166606862e-02   +4.165812291501956e-01   +2.733485158893631e-02   +3.127961475375300e-01   +5.193914829257782e-01   +4.116533441522032e-01; +8.316449584547042e-02   +2.488638450168288e-01   +3.042443364795034e-01   +2.570162032867589e-01   +4.446380764468493e-01   +3.439637230593029e-01   +6.032424529705668e-01   +5.561064648939739e-01   +3.793730334497243e-01; +5.805307001703920e-01   +7.210146897247014e-01   +2.997166568378788e-01   +7.204097724179211e-01   +6.657297909374469e-01   +5.377143398632568e-01   +1.541799430175908e-02   +8.797249700397192e-01   +4.980814329500596e-01];
L1_L4_iGABA_netcon = [+7.043877350765779e-01   +1.000000000000000e+00   +2.527608012018236e-01   +1.553320337263754e-01   +6.808429995145908e-01   +2.501967173249098e-02   +7.656558082904700e-01   +2.446477346866607e-01   +7.952519228365807e-01; -3.012084963337250e-01   -9.493366981668677e-02   +7.895500865337789e-01   +2.712598155170736e-01   +2.615424683476892e-01   +3.199391721652911e-01   +9.499804597959373e-01   +8.939077277553632e-01   +3.780403477861149e-02; +5.927486827451492e-01   +6.077377847452200e-01   +1.294083855486440e-02   +5.259378368344952e-01   +8.550324224156751e-01   +9.133783121877990e-01   -1.236721521742472e-01   +2.809521550907427e-01   +2.738536650624342e-01; -3.766407769760771e-01   +6.488489391643638e-01   -1.906277381177872e-01   -9.200304313296882e-02   +6.462039576565218e-01   +5.563282380161992e-01   +2.290263984744087e-01   +7.766990772958838e-01   +5.505159026793501e-01; -3.553473826724043e-02   -1.607890826646103e-02   +2.806999962593575e-01   +6.596220664999105e-01   -3.408363411573896e-02   +8.602573727267393e-02   +6.270167633925599e-01   +7.759188744992351e-02   +5.356794625851568e-01; +1.151935935839757e-02   +6.027607188381536e-01   +3.149157404712767e-01   -3.630180881373781e-03   +5.892758253377518e-02   -2.089376137843903e-01   +4.447752128387572e-01   +4.287534224524862e-01   +9.264656032407594e-01; +3.045012840539563e-01   +8.740672445849964e-01   +1.242146617523047e-01   +7.288044842441816e-01   +4.533717592401385e-01   +8.041823302692989e-01   +5.308994469316484e-02   +7.955544383914985e-01   +5.847360023586528e-01; +5.664624413956042e-01   +2.322008694450337e-01   +2.860576152827022e-01   -3.734876184542242e-02   -2.111997641397516e-01   +9.356441434945153e-01   +4.548379799470008e-01   +7.465069062727490e-02   +9.556100398218166e-02; -6.933939394387127e-02   +3.075905882932002e-01   -1.969349543558366e-01   +1.879798932453934e-01   -1.038197695219289e-01   +2.365224024632247e-01   +2.875679687913587e-01   +1.208823890719720e-01   +6.717829281090480e-01; +1.706067751518118e-01   +8.101079340758457e-01   -1.466796712961034e-01   -2.581503460049582e-02   +5.990958007815809e-01   +3.072299678482542e-01   +9.090828943710598e-01   +5.281008185562693e-01   +6.246201588386280e-01; +3.329373636467088e-01   +4.992421944830734e-01   +5.941294223710584e-01   +2.485531811522416e-01   -3.164337957255877e-01   -1.680641327058323e-01   +1.376511251580037e-01   +6.153597201349525e-02   +4.019350241721561e-01; +3.719823964145135e-01   +4.958189443950552e-02   -8.943403414460509e-02   +6.446520809757963e-01   +6.348941894410103e-01   +1.062371197685504e-02   +5.232569950878040e-01   +5.105126137288198e-01   +5.974433838938580e-01];
L4_L1_iAMPA_netcon = [+1.041414410713792e-01   +4.983690836377708e-01   +2.063252853335855e-01   +5.487430979356113e-01   +2.341844095615385e-01   +6.105084040526489e-01   +6.771254239305552e-01   +8.456475218000085e-01   +1.401254075962232e-01   +2.715766378410358e-01   +7.387864367456638e-01   +2.770342614678037e-02; -1.076233441772944e-01   +9.284506282545625e-02   +3.130434050869216e-01   +3.618299553611257e-01   +1.136861772834237e-01   +2.433871666636642e-01   +6.710820180033223e-01   -1.732538553813817e-01   +2.347827752387565e-01   +1.919618429508912e-01   +9.289031447509827e-01   +4.215606260662954e-01; +4.851910655237763e-01   +2.356069990606301e-01   +3.491233808098316e-01   +7.346631841267746e-01   -9.690061119643306e-02   +4.150730851712576e-01   +4.699373616810378e-01   +4.712212841056631e-01   +1.000000000000000e+00   +2.394872668725085e-01   -3.335338518911549e-01   +2.005034185017087e-01; +7.296727988602930e-01   +9.290205836613923e-02   -1.586861624205938e-02   +6.790478636852233e-01   +9.909175061790743e-02   +2.971770221791215e-01   +5.079289463179368e-01   +2.773395358641545e-02   +2.681465492224637e-01   +5.176772601718056e-01   +4.044834826625386e-01   +2.486238052460867e-01; -1.381345276340782e-02   +8.998576744534316e-01   +3.634190664276059e-01   +6.761288796526389e-01   +2.022073188335448e-01   +9.962119368661579e-01   -5.301611048102864e-02   +6.927099510311044e-01   +3.233795325108147e-01   +8.729799638927379e-01   +7.347566708499290e-01   +7.987657906719980e-01; +6.625356678761304e-01   +5.753878809207535e-01   +1.961191657027219e-01   +5.412461134521871e-01   +9.370982877888946e-01   +9.485991628546582e-01   +3.699476575696585e-01   -1.198659918136540e-02   +6.493766468704697e-02   +3.729223910138261e-01   +6.355855727007437e-01   +2.594682490760353e-01; +2.665329446293412e-01   +4.861326486360312e-01   -1.848260398794420e-01   +9.765011834968562e-01   +2.856809457428636e-01   +3.018007060473949e-01   +4.709847501836150e-01   +4.783622341513519e-01   -2.417979619180600e-01   -1.633949608216598e-02   +5.979129652064857e-01   +9.467952080671359e-01; +4.555542394965282e-01   +1.506509525146107e-01   +1.398530231643434e-01   -2.926117254143009e-01   +3.223369848307050e-01   +5.021798133018021e-01   +1.468629685170438e-01   +1.913871280803306e-01   +5.775889319963473e-01   +3.771236410759418e-01   +7.100528190064070e-02   +4.381163008452041e-01; +4.795056277220882e-01   +2.753954341761730e-01   +2.249815206375651e-01   +5.308721424762812e-01   +2.743656436412389e-01   +5.249135382397033e-01   +4.509859709144631e-01   +2.854993993564579e-01   +3.061259513001029e-01   +4.806714584948243e-01   +3.459897771112390e-01   +8.230652175713090e-01];
L1_L3_iAMPA_netcon = [+3.106055958339060e-01   +9.376588558268513e-01   +5.982851691174651e-01   +3.933731564002735e-01   +5.216405712263475e-01   +5.539547829062127e-01   -3.823990049197509e-01   +6.408760526287431e-01   -2.775967192608787e-01; +7.961123137820971e-01   +9.670671196845645e-01   +1.000000000000000e+00   +7.811757049910580e-02   +4.699188807108023e-01   -4.885495335604063e-02   +2.364782674966861e-01   +5.769909161712550e-01   +3.903856747496050e-01; +7.887905261749283e-01   +7.073238146386981e-01   +7.567296971337294e-03   +4.432271746421979e-01   +5.590942375771650e-01   +2.195014818036141e-01   +3.150521110183679e-01   +1.183539399258759e-01   +4.966476269010960e-01; +4.378500128531690e-01   -3.487742032901140e-01   +4.914047707794090e-01   +2.945314368288203e-01   +3.498966045176745e-01   +6.719158014849971e-02   +5.436538921638834e-01   +5.148348213489740e-02   +4.385418522737423e-01; +3.670309797791205e-01   +6.480077461708365e-01   +2.551883408758904e-01   +5.396986556953804e-01   -1.222457091555412e-01   -2.717788058431521e-01   +3.989199671231065e-02   +5.608967884945514e-01   +5.592915473500099e-01; +4.966063145295651e-01   +5.342380716375796e-01   +4.020532891521666e-01   -1.168220724573565e-01   +7.693805265520083e-01   +4.574258704325442e-01   +2.985016888502628e-01   +7.852794154848773e-01   +5.969080972250781e-01];
L3_L1_iGABA_netcon = [+7.659765615350455e-01   +6.273333484199325e-01   +7.144709002317738e-02   +3.652087551188388e-01   +7.217722153467462e-01   +9.781835309805492e-02; +8.642962504187830e-01   +1.506083611694997e-01   +3.995394374718045e-01   -1.619872983438545e-01   +5.590856585893065e-01   +7.887648451837673e-01; +3.310379162101570e-01   +3.671506892836932e-01   -3.889450682082161e-02   -1.678492143104065e-01   +5.565477474705300e-01   +3.604544794129565e-02; -3.124511137269013e-02   +7.033365056942943e-01   -1.598534179745093e-01   +4.372317165648275e-03   +2.747246806655883e-01   +6.277108921813102e-01; +4.076501438138530e-01   +1.091002079724538e-01   +4.587266919708952e-01   -1.857679484768991e-01   +1.899248522402100e-01   +9.066053345888081e-01; +7.059403803863523e-01   +2.455276977206357e-01   -2.414054121522460e-01   +2.849339148434909e-01   +5.289198981123594e-01   -5.431780206506486e-02; -7.766368387760580e-02   -2.584617986755333e-01   +5.958042439268610e-01   +6.415505145353253e-01   +6.226018228886290e-01   +2.029275634361052e-02; -3.035990886929539e-01   +3.410578902160170e-01   +1.000000000000000e+00   -1.534944730931473e-01   +2.493231280940701e-01   +5.140530174355056e-01; -2.387030514426187e-01   +8.820633922682990e-01   -2.712769047321416e-01   +5.987327022223105e-01   +3.807091661646272e-01   -2.525930945943204e-01];
L5_Input1_iAMPA_netcon = [+6.403865920668661e-02   +8.422852792247348e-01   -2.126348447822057e-03   -5.765407589682364e-02   +4.451942345604561e-01   +1.410256536582739e-01];
L6_Input2_iAMPA_netcon = [+6.752160702335659e-02   +1.000000000000000e+00   -4.563395332547509e-01   +2.516872251255977e-01   +1.933711921949142e-01   -8.802480596259159e-02];
L5_L6_iAMPA_netcon = [+4.676866727563752e-01   +3.354715146468463e-01   +9.826149517656011e-01   +8.122006349012405e-02   +8.373180627887444e-01   +5.559943340046665e-01; +7.056546545737648e-01   +7.401190314795816e-01   +4.774347075532614e-01   +4.177740829972397e-01   +8.641727163631908e-01   -7.758657306527740e-03; +5.046747027339884e-01   +2.605844814905955e-01   +2.382762659652269e-01   +4.910521494262004e-01   +9.264053324631615e-01   -3.199037103164280e-01; +1.700865482197631e-01   -3.311356391150818e-01   +6.334233360851393e-01   +7.758858580934701e-01   -3.332163186237337e-01   +4.797839507220730e-01; +6.023712933352057e-01   +4.347671843825940e-02   +7.387685191371408e-01   +9.507517078208241e-01   +3.489369500396323e-01   +4.609195412075470e-01; +4.230349331887484e-01   +1.921347579884458e-01   +5.093733675441808e-01   -1.022439218346865e-01   +1.000000000000000e+00   +6.094435198908604e-01];
L4_L5_iGABA_netcon = [+4.701443365335177e-01   +8.206518628243134e-03   +6.929608053263411e-01   +4.226228698665369e-01   +2.014517455502201e-01   -9.130913598015025e-02   -2.031163527075214e-01   +4.785693328090080e-01   +2.054755962112073e-01   -1.796955713651682e-01   +4.597861900434831e-01   +2.326539089460059e-01; +3.926089820821607e-01   +8.871703520278554e-01   +6.201352944753429e-01   +2.529432802639321e-01   +5.462800352976775e-01   +4.631626487507599e-01   +4.572596784528226e-01   +3.384605888844852e-01   +2.200148224870545e-02   +7.527403477154733e-02   +7.399690601214708e-01   +2.123404960673570e-01; +6.496258108453623e-01   +6.089811880020333e-01   +1.084987801316707e-01   +3.213223699635686e-01   +3.746365908385454e-01   +2.459402243001549e-01   -2.640814830808430e-01   +3.505222045501133e-01   +8.921803837355213e-01   +2.719986576279509e-01   +3.711917113590219e-01   +3.474713059670995e-01; -2.436499621521588e-03   -3.138140610709136e-01   +6.070253698050634e-01   +9.865200108550211e-01   +4.586763246602307e-01   +3.570928405162770e-01   +4.025738453007219e-01   +1.950427678528526e-01   +4.280042892592885e-01   +1.000000000000000e+00   +5.545465534239242e-01   +9.914086900888976e-01; +9.392978097474916e-01   -6.813064875844638e-02   +2.489430140302339e-01   +2.744667745106038e-01   +7.704174286847959e-01   +8.749075167406324e-01   -3.883787309143642e-02   +7.306935955524668e-01   -5.126680011602133e-02   +6.203010671635683e-01   +3.570655099603768e-01   -1.018567999076440e-01; +1.192379766113202e-01   +6.236485733385783e-01   +3.601787278103473e-01   +2.066610055567240e-01   +8.386701150180873e-01   +8.963521012383595e-01   +5.699977580849790e-01   +8.072916399303255e-01   +1.728727401200194e-01   -8.931816598814632e-02   +6.495325674835404e-01   +1.171150893441900e-01];
L6_L4_iAMPA_netcon = [-1.904416536263188e-01   +2.220475472703677e-01   -2.375662863080408e-01   -1.584922022374266e-01   +4.787421921632192e-01   +3.617284777164991e-01; +1.000000000000000e+00   +3.316734610900407e-01   +2.516562189798783e-01   +1.141337465947130e-01   +4.964226034241592e-01   +3.563427544372212e-01; -4.882519817077483e-02   -1.496128365360925e-02   -2.657592005418143e-01   -1.879993371994346e-01   +2.086419376570895e-01   +1.351461868240981e-01; +1.949991929596103e-01   +3.228375263756184e-01   +7.438173154058432e-01   +2.237385362423198e-01   +1.608788175553350e-01   +7.600880329218759e-01; +6.017410780565262e-01   +9.441349076776799e-01   +8.852943298529393e-01   +3.919488732368256e-01   -2.617949459362697e-01   +6.439445179555133e-01; -2.654558313582526e-01   +4.051447684805078e-01   +5.547903916741064e-01   -8.030979806983422e-02   -2.146133882296202e-02   +1.873097026357206e-01; +5.380982827487985e-01   +1.752295613918921e-01   +4.178823721258591e-01   +2.528759349217534e-01   -2.543271458212026e-01   +6.454725567768058e-01; +5.617723770774098e-01   +5.280404002921548e-01   -5.083660384034965e-03   +7.248850732942147e-01   +4.039215050228253e-01   +3.562448236001140e-01; +2.820477610769128e-01   -2.042177891305047e-02   +7.157874872335898e-01   +7.075911968053351e-01   +6.305655442905438e-01   +3.193722240278903e-01; +5.567845077304459e-01   +2.415743456875752e-01   +3.872720985129731e-02   +6.750481543815186e-01   +5.394105489837302e-01   +4.598146547664082e-01; +5.098758913403567e-01   +2.995279350254275e-01   +7.579378836183776e-01   +4.892465275697330e-01   +7.481600014635117e-01   +7.965980682475685e-01; -2.654636089112068e-02   -2.454033462579768e-01   +7.252369749123391e-01   +5.778009675683692e-01   +3.555984399325997e-01   +6.533928363070233e-01];
L5_L4_iAMPA_netcon = [+7.528436641265213e-01   +5.091173104173985e-01   +3.972258183307802e-02   +5.436940277620791e-01   +3.360771140418182e-01   +1.779714544971870e-01; +7.483253876217104e-01   +1.517083138767134e-01   +5.861610883485109e-01   +3.189755747315277e-02   +6.037996491404174e-01   +5.579545793773514e-01; +7.357509465100946e-02   -3.829827703118759e-02   +1.681967078515076e-01   +1.256375699468054e-02   -1.976700725161971e-02   +5.663517085493367e-01; +4.009413387620279e-03   +3.469741707060551e-01   -1.387305513213464e-01   -1.065613830691707e-01   +4.008504307024827e-01   +1.000000000000000e+00; -2.211389278384140e-01   +9.382135976247277e-01   +4.639883577417807e-01   +4.162283487443358e-01   +8.126386606482598e-02   +2.598880689769461e-01; +2.480917719058295e-01   +4.934301220279634e-01   +7.132141906444919e-01   -1.811557037779317e-01   +1.575528816499454e-01   +2.797857991537956e-01; +3.042774104324543e-01   +2.312202445506013e-01   +6.933253771063307e-01   +3.907006016592681e-03   +9.030648918464393e-02   +6.380043157472172e-02; +4.692096706343971e-01   +4.562891574240097e-01   +7.180754891996428e-01   +4.013760753234985e-01   +4.517598296287784e-01   +3.604387022464069e-01; -3.334758549643048e-01   +5.500702452360382e-01   +6.191333998013921e-01   +5.775437412582915e-02   +7.199822475517685e-01   -1.767776793503802e-01; +6.924794342374181e-01   +7.399418076655503e-01   +3.912575594464104e-01   +1.175290403982132e-01   +4.786370501611626e-01   +1.440192160708421e-01; +2.974309725268137e-01   +4.472770656215243e-01   +1.261952915838999e-01   +6.057680671866970e-01   +8.190217154283311e-02   +2.599617890428790e-01; +5.277285114186195e-01   +8.225967553189238e-02   +2.501469937736839e-01   +5.235994800914157e-01   +7.944372589192866e-02   +1.106552881285212e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
