function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.482266176125580e-01   +1.245701225738756e-01   +2.826698395977081e-01   -2.229970796834039e-01   +3.148875527892899e-01   -1.964587200141175e-01   +1.936372276707538e-03   -6.462793672352624e-02   +5.581847186310145e-01; -2.367444380303514e-02   +4.082588816185060e-01   +2.056393884611424e-01   +2.577665481206894e-01   +1.809770499922460e-01   +2.916347267601406e-01   +1.456790122439116e-01   -1.317559705123894e-01   -2.355611499487920e-01; -3.773999546703423e-01   +1.942702502292729e-01   +1.464716298912443e-01   +3.810240302521725e-01   +1.844800696823442e-01   -2.517907504579460e-01   +2.396810939711689e-01   -2.733825703593354e-01   +4.346037861395786e-01; -1.833839540650574e-01   +4.694511884200026e-01   +4.354538615047253e-01   +3.552773376808541e-01   +4.835726266442920e-01   +2.266401635108516e-01   +7.528054658126421e-02   -1.266364129064571e-01   +4.209095679526239e-01; +1.597994999325661e-01   +3.687791397439876e-01   +4.318274541391934e-01   -2.388761456340061e-02   -1.688653417189770e-01   +5.162791599643295e-01   +3.746388659529709e-01   +4.199258289434187e-01   -1.241892987431847e-02; +5.367111045140301e-01   +2.618300730661425e-01   +3.226291336870086e-01   +2.834548358899727e-01   -2.541034995299473e-01   +7.344280476994694e-02   +6.807666681727195e-02   +3.420393237427276e-01   +4.471891149742884e-01; +3.714812487926030e-01   +1.613387012313802e-01   -3.486198495236779e-02   +6.993509541597528e-01   +1.466528669137499e-01   +4.342801216802836e-01   +3.539811108769736e-01   +1.244758951300625e-01   -3.045961929556695e-02; -5.412882426308059e-01   +3.134738512087832e-01   +4.191360879752156e-01   +7.201266417751137e-02   +6.866985565853894e-01   -2.599039749289560e-01   -7.433000687387475e-03   +3.377376307723033e-01   +5.129642350430126e-01; +2.801184921103400e-03   +1.004815099674814e-01   +5.108602004512368e-01   +2.723351028451436e-01   +4.879514117821590e-02   +9.243407859040023e-02   +6.107931588566573e-01   +3.630309436441672e-01   +5.127423678919791e-01];
L1_L2_iAMPA_netcon = [+1.613483748223912e-03   -3.018265169892942e-02   -2.167671611827076e-01   +2.122574010721693e-01   +8.222910799512632e-02   -3.531422965106771e-01   -7.396515490404260e-02   +1.723264897394646e-01   +5.884497148334273e-01; -1.574623537488981e-02   +1.397911636357163e-01   +4.728881025422372e-01   +1.084384031590310e-02   +2.023784155820285e-02   -1.745149926954639e-01   +2.613724423009787e-01   +7.165567565412304e-02   -2.074270545882019e-02; +6.072506268601473e-01   -4.344385856334954e-01   -1.457016087228064e-01   +5.679176568823309e-01   +2.551860034353670e-01   +4.641059518839329e-01   -5.390082856652241e-01   +1.377665856857005e-01   +1.999634272796284e-01; +4.096745559734327e-02   -2.184817502357786e-01   +2.099930590488860e-01   +1.658904280431954e-01   -8.298721177996043e-02   -8.056360640764745e-03   -2.964041561336866e-03   -4.357604564130552e-03   -2.075428313684639e-01; -4.241281819961325e-02   +1.919270016682785e-01   -1.677485614216849e-01   +6.093308153665850e-02   +2.308582104822249e-01   +1.998379696758794e-01   -2.509867720992990e-01   -3.382093706858913e-01   +2.967964573744230e-01; +1.335785016541197e-01   +7.130033113509096e-02   -1.435036309988771e-01   +2.554740539104750e-01   +4.206010716727492e-01   -1.608306606233634e-02   +4.252349309877269e-01   +4.565931923561083e-01   -1.616665468363140e-02; -1.726620422476090e-02   +2.584341505835215e-01   +6.133273946013423e-02   +1.836272257864498e-01   -9.863025891359742e-02   +2.342709964586658e-01   +2.001239562786183e-01   +3.493875496839237e-01   +5.744154577082244e-03; +4.786396231632162e-02   +9.166750550602265e-02   +4.938414011578056e-01   -1.136236900230893e-01   +2.628782170842177e-01   +4.237476249266415e-01   +1.460139185298609e-01   +4.372519163398188e-01   -3.370469486609977e-01; +3.241104905188205e-01   +2.617649029227272e-01   -2.172665451008478e-01   +3.476997497468013e-01   +1.363124185545803e-01   +2.097568266925603e-01   +7.030560699434636e-02   -2.139298396782426e-01   +3.575514535077438e-01];
L2_L5_iAMPA_netcon = [+5.647481465536375e-01   -2.094429501386731e-01   -2.614537463742396e-01   +1.400706409980289e-01   +5.123753742220005e-01   -1.682054823572699e-01   +1.862146607936610e-01   +1.848553229371481e-01   +2.412372431750970e-01; +1.515876144853235e-01   +4.250034736748721e-01   +6.725545906359709e-02   +5.120900043108181e-01   +5.191601640740630e-02   +2.059695527422602e-01   +7.009003976272911e-02   -1.217657582870492e-01   +6.100256280286082e-01; +5.526571226167049e-01   +2.881587268929372e-01   +2.280055894947370e-01   -5.144818517269639e-02   +7.349006647929968e-01   +3.261001220944762e-01   +2.429840084419885e-01   -2.775390013546593e-01   -6.534471465536845e-03; -1.311014556473515e-01   +4.048664141579801e-01   +4.505727107626644e-01   -1.341195092151946e-01   +5.984967807773558e-02   +5.145188511634390e-01   -3.170868351515728e-01   -1.215030805109740e-01   +2.521308610104390e-01; +3.139257901800947e-01   +3.581073889155026e-01   +6.251477172731033e-01   +4.257643209371491e-01   +2.854938264792842e-01   +4.723311457573736e-01   +3.726671837653536e-01   -4.975902043042196e-01   +6.440102335699334e-01; +4.606153857408048e-01   +2.856993431637917e-01   +8.496330440882557e-01   -7.896634421320813e-02   +2.287090384627508e-01   -1.868192992853834e-02   +8.360117141554524e-01   +2.199022679164436e-01   +1.785683719132246e-01];
L5_L2_iGABA_netcon = [+7.488825745860520e-02   +4.054112836572623e-01   +6.100558977026670e-01   +3.854553873685428e-01   +1.640847769426456e-03   +3.786251480492204e-01; +6.775310282302901e-01   -7.005289674637852e-02   -8.367041859713456e-02   +1.929858907384016e-01   +2.215059826488439e-01   +1.706171751461433e-02; +1.907268445785141e-01   +1.453831977224682e-01   +5.496292662545620e-01   +2.436749277019764e-01   +1.146348797199301e-01   +4.900941514556267e-01; -2.170593646047941e-02   -3.196809924853949e-01   +1.432788471496536e-01   +6.534685199504344e-01   -3.563077893251534e-02   -2.413570620275574e-02; +1.967204884376200e-01   +1.181275772004388e-01   +1.823895720404583e-01   +2.394336631784301e-01   +1.172467540702048e-01   +9.832075033466281e-02; +1.596453532180793e-01   -1.096664771478565e-01   +4.542869813135096e-01   +4.156313977388703e-01   +2.065056584033934e-02   +4.232195158559959e-01; -3.671159333376176e-01   -1.530726984632785e-01   +4.254765196300653e-01   +6.836317837273307e-01   +1.249905245181336e-01   -1.022217439195316e-01; +1.626244040001555e-01   +8.255768159323154e-02   +5.871154105559734e-01   +3.848996571892751e-01   +3.556156951407199e-01   +4.999654029164339e-01; +1.471295842219229e-01   -2.052138107821147e-01   +5.736473434282059e-01   -3.013423297737090e-01   +3.588269855180706e-01   -3.599635852552279e-02];
L3_L2_iAMPA_netcon = [+5.509643998814558e-01   +3.107343890875525e-01   +3.567830682583375e-01   +2.890103945308991e-01   +1.848833779535325e-01   -1.677087784655746e-01; -1.792693830337883e-01   +7.739519711265248e-01   +1.623788588422125e-01   +1.569153199286256e-01   +2.541309535249161e-01   +5.664660584119081e-01; +4.896558702663095e-01   -1.578860604242604e-01   -1.221238395685522e-01   +2.286329069823543e-01   -2.048460347313201e-01   +3.407984378584298e-01; +3.790717502373415e-01   +1.386049985002388e-01   -3.198239918675315e-01   +3.400888418154487e-01   +2.720535368493893e-02   +1.754003383889852e-01; -2.798063665209169e-01   +3.159985302809765e-02   +3.517913888100128e-01   +2.815786889962392e-01   -1.719617093356260e-01   +2.954557034700580e-01; +2.088512601818888e-01   +2.287276117516085e-01   -4.140051320502952e-02   +5.970680401674349e-01   +4.170466636865340e-01   +1.652953257313124e-01; +2.872783382511917e-01   -1.014193428455243e-01   +4.005117804765834e-01   -6.535657714204392e-02   +2.606954510794804e-01   -2.529976663072379e-01; -2.433562790175583e-01   +2.115763468499323e-01   +7.550233595637976e-02   +1.510762731146928e-01   +7.009128511685774e-01   -5.909484732313128e-02; -1.405634155091081e-01   +5.460030460266556e-01   -2.913758155258800e-01   -5.554535157415661e-02   +4.263359207140820e-01   -3.617605049677850e-01];
L2_L3_iGABA_netcon = [+3.677440929195427e-02   +1.726172896889093e-01   +4.709794428655861e-01   +2.980225423487149e-01   +4.950156513795156e-02   +3.169046834601191e-01   +3.792948712305200e-01   +2.291236910886967e-01   -1.396778917691370e-01; +1.935945590037382e-01   +1.976664862815130e-01   -1.330135380143718e-02   +4.634782702243512e-02   +2.353747048776514e-01   +3.147620900265309e-01   +7.253881038329160e-01   +5.221967491156401e-01   -1.033586058965072e-01; +2.959161303868800e-01   +3.955130787494328e-01   +2.379103370012112e-01   +1.284718779367138e-01   -4.846606336664117e-01   +2.348891528474968e-01   +1.581168374629469e-01   -6.117449205025665e-02   +1.835323439449999e-01; +5.883992244758818e-01   +4.088186937105172e-01   -2.093416360569077e-01   -6.120967006130895e-02   +5.086132222638140e-02   +2.453932182253706e-01   +1.447297508252324e-01   +3.697737643936984e-01   -1.396568552101168e-01; +3.060145946095671e-01   +1.040512520931365e-01   +3.086607682486078e-01   +2.127730563337027e-01   +6.453628904587003e-02   +5.667704090154768e-02   +2.841558907053590e-02   -3.769094223237964e-01   +1.097965126853626e-01; +3.130162221762753e-01   +1.211054575290392e-01   +7.092742795833183e-02   -3.074164786306660e-01   +1.872251931649258e-01   +2.212872776475855e-01   +4.217630246344789e-01   +2.860145765313924e-01   +4.186650509434327e-01];
L1_L4_iGABA_netcon = [+2.703714190844447e-01   -4.779992715153128e-02   -1.284813510207409e-01   +6.250227129324670e-01   +1.091075233037334e-01   +2.836689019496412e-01   +2.711147710854954e-01   +6.619344144784500e-01   -1.645897614631776e-01; +3.412233301843824e-01   -6.674236268469183e-02   +2.935374003319196e-01   -4.760969982803941e-01   +1.146775920001335e-01   +3.072831789048805e-01   +2.036293062132733e-01   +3.150936335252655e-01   -1.930051725518603e-01; +1.259500653591753e-01   +6.286047442709908e-01   -5.000310323026780e-01   -2.507830095467517e-01   +2.325837729866490e-01   -1.916928232600948e-01   +2.684193646997353e-01   +2.849518823593495e-01   +2.911834272534863e-01; +1.648130902264474e-01   +2.304156874550212e-03   -1.136589707040912e-01   +1.849278103107321e-01   +2.625079212021066e-01   -1.162299562714385e-01   +1.294214486153762e-01   +9.724536644152726e-02   -1.186696763892981e-01; -7.866012101505990e-02   -1.031148899271782e-02   +1.062977597726147e-01   -8.513428692953739e-02   -3.467445991013665e-02   -2.493561587278267e-02   +3.054081314430419e-01   +2.209262405562766e-01   +2.458103369675402e-01; +5.536191525464902e-01   -1.048239659253327e-01   +2.376532759205726e-01   -3.360578627889410e-01   +6.200022932051821e-02   +3.217964377918183e-01   -3.584671310276616e-02   +6.048007436245731e-01   +1.227904844284382e-01; +7.107701920275489e-02   +4.213719760678888e-02   -3.580091555956388e-01   +2.018711346709653e-01   +3.506489392216642e-01   -2.873038412945888e-01   +1.905689019842879e-01   +4.310718096053211e-01   +1.447472717796335e-01; -7.916992334591366e-03   -1.060779529441745e-01   +5.625159593345818e-01   +4.792428036000937e-01   +2.184968184333567e-01   +4.806209451346652e-01   +1.775504254469051e-01   +1.997776322497614e-01   +2.342874205902369e-01; +2.430874506115861e-02   +2.990048610959961e-01   +1.850355445123089e-01   +2.705229965483269e-01   -3.677219679097576e-01   -1.740877631660868e-02   +3.766479865955743e-01   +2.185693031523380e-01   +2.140040631895186e-01; +2.620629518130367e-01   +4.439004448891510e-01   +8.560367885611354e-03   -2.857965182717127e-01   +1.460971468221458e-01   -1.243859608459207e-01   +1.077015495519443e-01   -9.237337992274405e-02   +2.350029304425031e-01; -1.430749575867905e-01   +9.646472746826119e-02   -3.885101911355621e-01   -1.767866640614429e-01   +5.225959819946969e-01   +2.905104265404187e-01   -3.249936192542507e-01   +1.271777186774146e-01   +5.761455111360657e-01; +2.719628156068417e-01   +1.465834722020652e-01   -1.117382795293056e-01   +2.854660859052425e-01   +6.023559233907378e-01   -1.544771662360074e-02   +5.130731161373764e-01   -2.860201066889385e-01   +2.740541664367006e-01];
L4_L1_iAMPA_netcon = [+1.679071919402200e-01   +1.225735426868744e-01   +1.212798383726271e-02   +1.762118470282324e-01   +2.510825736788321e-01   +1.259597880357034e-01   +5.227587234396114e-01   +3.361326690914708e-01   +1.432318440573095e-01   +4.163452992679771e-01   -1.557455223343578e-01   +6.558779908274984e-02; +8.116729779761067e-02   -1.040877302765474e-01   +1.568754941458823e-01   +3.260311769220250e-01   +9.057956006517469e-01   +5.123082839873745e-01   -1.276087123685521e-01   +1.183551529746193e-01   +7.386681026524650e-02   +4.629717943511036e-01   -1.250139124948533e-01   -1.329695584763591e-02; -1.448233025818921e-01   +2.857018795986991e-01   +4.249223300386767e-01   -1.313231906842714e-01   +1.776035380038538e-01   +2.790336117885063e-01   +5.419202364252149e-01   -2.843466235554024e-01   +1.497951984508041e-01   +4.560848755705806e-01   +3.758630187290906e-01   +6.033665614483205e-01; +5.646541053595228e-01   +7.432529386464298e-01   +3.954717295596981e-01   +4.635921327072949e-01   -1.561570981667331e-01   +3.517121277800483e-01   -8.045285828186073e-02   +6.582649025829260e-01   +4.826591058413973e-01   -1.475918119642317e-02   -2.563819916524180e-01   +1.890453975305783e-01; +3.579600446356708e-01   +5.491941465611028e-02   -3.010335604313242e-01   +5.001814099509606e-02   +2.276326079526953e-01   +5.096570281096887e-01   +6.180772103415469e-01   +2.656669675364638e-01   +4.735156745837832e-01   +3.042612069000789e-01   -7.604660274300268e-02   +1.354903004573924e-01; +5.946837432949759e-01   +2.230192581308083e-01   +1.920250776123801e-02   -5.772577412455565e-02   +2.172152216420107e-01   +1.381791181870314e-01   -1.733154384064128e-02   -7.166989209775598e-04   +3.151495662924952e-01   +5.128759959513334e-01   +1.489080871967197e-01   +1.937300328462078e-01; +6.961002867063633e-02   +2.321461740179046e-01   +4.540516135818323e-01   +1.440867532163317e-01   -2.448998038408141e-01   +6.324449711948195e-02   +2.166604148451499e-01   +1.953750762187887e-01   +4.186213854310508e-01   +3.756512380907854e-01   +4.818303179844963e-01   -1.220170237521126e-01; +3.337737565252841e-01   -1.149118019128859e-01   -3.466526939670032e-01   -1.332720345905816e-01   -1.116370931784931e-01   +5.088692998584748e-02   +2.131008125799176e-01   -2.345608481613177e-01   -2.082820632406150e-01   -2.369090718924642e-01   +3.551484986397160e-01   +2.720457611424062e-01; -1.541430964172051e-01   -2.000428575903566e-01   -3.108346096121936e-02   +2.828869160576790e-01   +2.575714578540791e-01   +5.115247748075799e-01   +4.198298549373417e-01   +9.991453648140672e-02   -6.232058069061325e-03   +8.121136088179104e-03   +7.092008435930788e-01   +7.988011046654142e-02];
L1_L3_iAMPA_netcon = [+1.682282537343305e-01   -4.062818450059155e-02   +5.790945368058106e-01   -1.071159688212935e-01   +2.287184814117169e-01   -1.156447782726530e-01   -2.268224061404234e-01   +8.405213493722839e-02   +2.080000917607451e-01; +5.082639175783219e-01   -1.353949057933694e-01   +2.806780067756269e-01   -2.806075151966492e-01   +4.387320159863771e-01   -1.205306326292183e-01   +2.190006515180684e-02   -1.276544655185760e-01   +5.432455225138400e-01; +2.632044528426793e-01   +5.546575651425178e-01   +3.034602738361535e-01   +1.248732541577263e-01   -8.872691920946540e-02   +1.582260674579020e-01   +1.334648413818085e-01   +2.032229483144974e-01   +3.558867259338842e-01; +1.912099221040568e-01   +1.036947600361428e-01   +3.691641883005662e-01   +1.552198108489292e-01   -1.310718377771891e-01   +2.345982963390481e-01   +9.709375845035687e-03   +1.735100712810274e-01   +4.743784208317657e-01; +3.504053137270756e-01   +3.523688284155089e-01   -2.335959484117742e-01   +3.931989312514682e-01   +7.463070695845275e-02   +5.388989958306634e-01   -2.215907122657776e-01   -2.649800954850197e-01   +4.163525970320854e-01; +2.084042430226108e-03   +4.439619555575997e-02   +2.796869741155639e-01   +1.261468712128838e-01   +1.133783478199258e-01   +3.035912511189575e-01   +2.360738071647017e-01   +8.191225851533995e-02   +3.727866325350070e-01];
L3_L1_iGABA_netcon = [+5.963323248842226e-02   +5.395008964346248e-01   +2.400604164108532e-01   +5.629499349135678e-01   -1.287766518747762e-01   +1.140082672392778e-01; -2.927623747652087e-01   +3.128204723037102e-01   +1.454536905815126e-01   +6.445275693454983e-02   +5.811940368557066e-02   -2.305485664017818e-01; +1.388228672377647e-01   +3.262335639467922e-01   -2.923390528319131e-01   +4.264625609744548e-01   +2.101914676827431e-01   +4.470733355822203e-01; +1.183525767497652e-01   +1.329120685657068e-01   +2.112128055876964e-01   -8.075526828933752e-02   -1.834552926798070e-01   +3.062018413764172e-01; +2.974934673330876e-01   -1.600268724424174e-01   -1.169472041704539e-01   +2.114654160814959e-01   -1.988137280479791e-01   +2.912897943026891e-01; +1.065017626206077e-01   +4.534928353890217e-01   +6.449990813830977e-02   -8.379557950771743e-02   +2.035075762598804e-01   +2.636903582250674e-01; -8.036127826703188e-02   -3.793402904145118e-02   -1.017443960078572e-02   +2.447870757762840e-01   +3.087663431286580e-01   -4.112525574873682e-01; +1.514362492542464e-01   +5.409390991133118e-01   +5.488113793906636e-01   +3.935578962662963e-01   -7.665072933251602e-02   +6.385987047935829e-02; +6.065286824970796e-03   -2.463950229252223e-02   -4.954453532622000e-03   +1.559176657546674e-01   -1.620578307357970e-03   -1.434678190542032e-01];
L5_Input1_iAMPA_netcon = [+3.214154440428445e-01   -1.595946875615818e-01   +5.364399131394113e-02   +7.521495786727309e-02   +3.159189723337540e-01   -2.048727421912653e-01];
L6_Input2_iAMPA_netcon = [-8.321120995031500e-02   -1.600645910661100e-01   +4.344069811086394e-01   -1.119102915175188e-01   +3.009679092984030e-01   +1.911823952512167e-01];
L5_L6_iAMPA_netcon = [+7.584909426085584e-02   +2.195026103634789e-01   +2.911930446848824e-01   -2.422286177082327e-02   +1.018407577818856e-01   +3.011644483159453e-01; +1.783828819875851e-01   +5.231833003024868e-01   +2.020475665110835e-01   +7.274360740039024e-01   +6.942146089435974e-01   +2.997167905959166e-01; +1.134557730190203e-02   +1.239667481669122e-01   +4.477171647122055e-02   +4.021599185792795e-01   +1.284981603265450e-01   +3.284434772098558e-01; +3.655342330283586e-01   +2.574032805333583e-01   +7.054535510905935e-02   -4.990695804866661e-02   +3.140753529574480e-01   -1.920985838376804e-01; +1.780911591206215e-01   -1.571887103102502e-01   +5.505101308795037e-01   -2.846417844184212e-02   +1.572591847826317e-01   +2.537685780465349e-01; +3.473958284725934e-01   +5.547165653691710e-02   -1.112749338308078e-01   +6.918951859378762e-01   -3.990721326120570e-01   +5.231965820170728e-01];
L4_L5_iGABA_netcon = [+3.295538839159848e-01   +4.512228666331648e-02   +5.480981485002421e-01   +8.981779985710631e-02   +3.352593613288817e-01   -1.582369701393061e-01   +2.720163232758323e-02   +7.092373223803308e-01   +7.353853484011985e-02   +3.302707118907865e-01   +5.210708572912957e-01   +1.125658240106426e-01; +4.073680287083518e-01   +4.139974034583084e-01   +4.637836218123359e-03   +1.866202399136746e-01   +4.562011346932948e-01   +5.079154688198076e-01   -1.413346691164328e-01   +2.838364017117137e-01   +5.978069310569832e-01   -5.187169629715884e-02   +2.929605441049882e-01   +5.776089196639710e-02; +1.272520436869043e-02   +9.365924849137137e-01   +2.982479247550484e-01   +2.018593096482088e-01   -1.245323826610951e-01   +4.325681186220133e-01   +4.663456987199129e-01   +6.176611058308713e-02   -2.034977330037809e-01   -1.568609079632285e-01   -4.981611736804626e-01   -7.001248725086751e-02; +4.861079735981069e-01   +1.125346805377492e-01   +4.356933799201952e-01   +4.566572205269296e-01   +5.233268111188372e-02   +9.294443388571658e-01   -1.019311966622614e-01   -1.133944274793128e-01   +3.856400627741765e-01   +2.473720687803311e-01   +3.336551303636409e-01   +3.735119714509869e-01; -5.177084136979770e-02   +1.535447266633453e-01   -2.086864569561560e-01   +7.185288076730384e-02   +2.733380853174408e-02   +6.371834077089062e-01   +3.182225243968069e-01   -1.162305554253901e-02   -1.970870451060619e-01   +4.767109675822745e-01   +8.776264827947706e-03   +4.767311302270390e-01; -1.629000257660557e-01   +5.451808167921114e-01   +3.927772853072203e-01   +4.628220986067119e-01   -4.493723671643463e-02   +2.063307632969233e-02   -3.202201328719859e-01   +1.089396186259323e-01   +4.345307360237035e-01   +2.953373196930911e-01   +5.202493547110559e-01   +4.380290615201061e-01];
L6_L4_iAMPA_netcon = [+4.048149461594089e-01   +5.766984540628421e-01   +1.695348571068984e-01   -1.794237191247745e-01   +2.736723453350306e-01   -1.388562643102445e-01; -1.062552489222995e-01   +2.209659763130780e-01   +4.227098645955663e-01   +4.293702478274973e-01   -8.850629387229095e-02   -5.628150273795660e-02; +2.910889216450708e-01   -2.576569356145499e-01   +3.274295687963124e-01   +4.688784588878699e-01   +2.097803575156848e-01   +3.096872835991452e-01; +2.129355581228252e-01   -9.703194618202723e-02   +2.877678692232167e-01   +1.233219357163310e-01   -3.737859143832112e-02   +3.218107057395636e-01; -3.812215493975807e-01   +9.821515398145020e-02   -1.057922484956477e-01   +3.470095142374417e-01   +4.821688465122777e-01   -6.317205932231526e-02; -2.170750651402659e-02   +6.754919985791863e-02   -2.721361198066212e-01   +1.689869374157861e-01   -1.302322386784853e-01   +1.683737161652870e-01; -2.688770150430110e-01   -1.560610460859681e-01   -4.852158471477130e-02   +1.786275700471201e-01   +2.427289844937055e-01   +1.094277380370364e-01; +3.101171430006760e-01   +2.042170954092725e-01   +2.516259686919748e-01   -9.107723493258719e-02   -2.004966190167359e-02   +2.141531428282011e-01; +1.454868658207913e-01   +2.519605612501515e-01   +4.855300052115946e-02   +6.018862778955771e-01   +5.631241429379497e-01   -1.994475438806075e-01; +3.919064685135496e-01   +2.328416256426611e-01   -2.384367540971228e-01   +1.321824877577389e-01   +6.606735010137433e-01   +1.516673499020982e-02; -2.998360159891750e-01   +2.716345385161413e-01   +4.384593114596859e-01   -3.142697187161537e-01   +1.577203083498345e-01   +5.028228640755189e-01; -5.972378377541240e-02   -1.601033936849172e-01   +4.994572815597097e-01   -1.428468810283856e-03   +2.322263327522099e-01   +1.367431536641986e-01];
L5_L4_iAMPA_netcon = [-1.176233923581640e-01   +1.418390316214222e-01   +3.962359307078466e-01   +1.440291427517037e-01   +1.684305496602687e-01   +2.309625590438829e-01; -2.575791581158030e-01   +4.303310311959179e-01   -1.679131175027369e-01   +2.198607412511351e-01   +1.883817825803951e-01   +2.230165906318951e-01; +1.628802507882148e-01   +1.228121842608315e-01   -4.008064335092785e-01   +2.501585720880474e-01   +1.585304592165313e-01   -8.387524533330432e-02; +3.145244197023949e-01   +1.725309984718618e-02   +2.672948756072143e-01   +3.600367463598635e-01   -8.674911523311517e-02   -1.477579415499682e-01; +1.536034872537060e-01   -4.195057045123815e-01   +6.322853857253378e-01   +1.083627218993389e-01   +2.369439558576580e-01   +1.357104106838330e-01; +2.511020310876868e-01   +1.648675101077960e-01   +1.469905652333493e-01   +2.676243448566572e-01   +2.587565770128265e-01   +1.705952616805450e-01; +4.407751037810616e-01   +4.757765843933628e-01   -6.635319797598954e-02   +5.885996379636054e-01   +2.880865143560656e-01   -4.252875236314769e-02; +2.405252596255732e-01   +3.079048300481634e-01   +3.976185387984096e-01   -1.608017219297392e-01   +1.340397165367489e-01   +5.943289434919671e-02; -2.627548573314938e-02   -3.736655016387879e-01   +3.018974414206747e-01   -8.156922113001058e-02   -3.300234326065169e-01   -3.932643280306464e-01; +4.035570683625560e-02   -1.505414835423396e-01   -1.167870978260978e-01   +5.214510108326533e-01   +1.365490282325843e-01   -2.512942496120317e-01; +1.480713139079818e-01   +5.637511485232816e-01   +1.305281418447385e-01   +3.229774170706719e-01   -4.055595344018705e-01   +1.333765843308155e-01; +5.535884675125949e-01   +4.064526697415806e-01   +6.339663287245072e-01   +5.830774370421127e-02   +3.369069794093334e-01   +2.159137537494411e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
