function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.806164648522671e-01   +2.268243541438365e-01   +9.707358115422313e-01   +1.000000000000000e+00   -6.561728491636334e-02   +6.246753880991198e-01   +6.958893641706231e-01   +2.045448125525254e-01   +1.627073712394338e-02; +1.962198170979807e-01   -2.693877558908411e-01   -4.466339897746260e-05   +6.997294260548742e-01   +4.705516742839266e-01   +3.391839527992032e-01   +2.842327232042614e-01   +4.136832897192960e-01   +6.111651429755880e-01; +4.579554173093081e-01   +2.668012041594327e-01   -5.467977122326707e-02   +1.588802351811184e-01   +1.694709793330524e-01   +5.412189952862502e-01   +3.602246396343940e-01   +7.180393809012146e-02   +3.017760433440784e-01; +7.060458875453597e-01   +1.126919569957738e-01   -2.261153914244966e-01   +4.475146203175417e-01   -5.096046781758473e-01   -5.089827667609819e-02   -2.259473796015831e-01   +5.479266024441012e-01   +1.265841465317774e-01; -5.586728829139909e-01   -2.664557981335186e-01   +7.200913366851654e-02   +4.937012423516083e-01   +9.311002049357552e-02   +5.084018592478390e-01   +4.468772714187040e-01   +3.975614214720946e-01   +2.232517102968816e-01; +1.728081939306081e-01   +2.011341967931355e-01   +3.749305544735690e-01   +5.940302528440763e-01   -8.972791369188415e-03   -1.312704199096656e-01   +4.046008111845247e-01   +6.809762146678373e-01   +1.547803885150004e-02; +2.926504380499242e-01   -1.165609492053967e-02   +4.811140822004738e-01   +2.626381956304880e-01   -2.665992964302928e-02   -2.763209388491156e-01   -7.407587259674187e-02   +1.626558172897710e-01   +2.718040507335704e-01; -9.202865448279631e-03   +1.398124497692595e-01   +9.515263873984514e-01   -9.152492137376856e-03   +2.582065528809187e-01   +5.702899480981057e-01   -2.637700543601042e-01   +8.209513551879672e-01   -5.258946284901674e-01; -1.234146082695666e-01   +7.323569937925780e-01   +6.608466327604458e-01   -2.818540962212251e-01   +6.837163563637998e-01   +1.882261149194767e-01   +6.837495711620302e-01   +1.942597492580447e-01   +1.026872197158284e-01];
L1_L2_iAMPA_netcon = [+7.600707554794177e-01   +1.687311534233558e-01   -1.097892499761231e-01   +1.982481362449984e-02   +1.512659755310096e-01   +7.552638134751267e-01   -1.061085739555591e-01   +4.022719756873807e-01   +6.877562596581013e-02; +2.540308507498241e-01   +3.566013657946134e-01   +6.373862178709950e-01   +5.377889110624017e-01   -9.395686385174906e-02   +8.237792820957252e-02   -4.283454200537163e-01   +3.334596673618345e-01   -8.886199552975195e-02; -8.080757718482413e-02   +6.319415523166332e-01   -1.924446649937022e-01   +4.052230684413155e-01   -5.188701666189510e-03   +6.586457307463879e-01   +6.478674328302676e-01   +4.762664651826479e-01   +1.532517563454198e-01; +5.288867277841542e-01   -4.947246782482836e-01   -3.144286608902417e-01   +1.031218388202583e-01   +3.374000298251759e-01   +3.117957656949504e-01   -6.167054842605069e-01   -2.166275777066602e-02   +4.835701665150541e-01; +1.805676818597014e-01   +9.030359211217476e-02   +6.287273599090923e-01   +7.169443318641542e-01   +7.183095487922003e-02   -1.632303342769728e-01   +7.918829086045397e-01   +3.682701863226828e-02   -5.361254162425033e-02; -1.089349207135847e-01   +3.483338662192947e-01   +2.601499412670308e-01   +2.781434377766918e-02   -6.624606317181156e-01   +4.732833142246184e-01   +3.212446386874528e-01   -2.023208757346611e-01   +3.744255133349144e-01; +4.578673696741827e-01   -7.572343649576652e-03   +6.214980805280411e-01   -3.184595134151337e-01   -4.433423153563447e-01   +8.564507192256471e-02   +1.043219355058205e-01   -1.764799839809966e-01   +2.227092079944644e-01; -3.409059306463535e-02   +3.544802653831866e-01   +1.928976916175349e-01   +2.868299615753742e-01   -2.382651849916282e-01   -1.965217802895775e-01   -5.179239269503294e-02   +6.118125012881426e-01   +3.226902138165462e-01; +2.085812873967353e-01   +5.742742289826398e-01   -3.417476091793561e-02   -2.236382232082343e-01   +3.855375523940651e-01   +3.940133687645712e-01   +5.122730948401339e-01   +6.713018795261956e-01   +2.955931724124771e-01];
L2_L5_iAMPA_netcon = [+2.291578085690552e-01   +2.113872852829030e-02   +4.351015449679812e-01   +9.297618271945128e-01   -2.365739102804067e-01   +2.159024533561532e-01   +5.258610084332844e-01   -1.217498861823924e-01   -9.424893871724628e-02; -3.924165472933948e-02   +4.732725599356200e-02   +8.132114367426393e-01   -1.938992193738776e-01   -2.105135659478415e-01   +7.833845745633560e-01   -1.236244284406405e-01   +6.872059976345768e-01   +3.674371240489976e-01; +2.541887916897854e-01   -8.364487684750033e-02   -3.222749550405815e-01   -2.881364782488884e-01   +9.747165979971836e-02   -5.087904488553884e-02   +3.175596617194544e-01   -2.118372042192719e-02   +5.485338105958509e-01; -2.435789943694842e-01   +2.680366788719176e-01   +9.925457012698800e-02   +3.160067384923689e-01   -4.674048642677034e-01   +5.014050364244818e-01   +2.907614437430143e-01   +2.222235338054211e-01   +4.839308462520728e-01; +4.794523299500424e-02   -8.666961801203422e-02   +4.053461991235278e-01   +4.011664975917334e-01   -5.896232215490325e-01   +2.871047187171712e-01   -2.638041299772279e-02   +1.876310499385135e-01   +9.370847904850892e-01; +2.225904827750041e-01   +2.973735280131585e-01   -1.147457820532933e-01   +4.694098973607793e-01   +2.821682246520624e-01   +5.352023472734838e-01   +5.112623501748865e-01   +6.449735229742941e-01   +5.837504787977166e-01];
L5_L2_iGABA_netcon = [-4.482309152425192e-01   -8.865044872452765e-02   +7.267761721844823e-01   +1.806226955450512e-01   +1.159986859309640e-01   +7.126004713502254e-02; +1.965072870386933e-01   -2.535426532691948e-01   +1.034665374194702e-01   +4.698591820473764e-01   +6.753578129930194e-01   +8.207095293482271e-02; +7.870049934020019e-01   -3.740354415891850e-01   +5.656568009858004e-01   +1.669973551541797e-01   +3.215875899710018e-01   +1.434719399441281e-02; +6.097175198852119e-01   +2.114127091672155e-01   +4.747275498084097e-02   +3.757191429392043e-02   -4.184570268493149e-02   -1.161967017461720e-01; -1.119705429856196e-01   +6.257904806337122e-01   +6.596413935422858e-01   -1.379231107663110e-01   -3.449126666330597e-01   +2.300377579947614e-01; +3.808257955520580e-01   +5.248475784457604e-01   +6.132517754603519e-01   -1.704136366645327e-01   -1.545069860836145e-01   +6.003023832654589e-01; +5.519049011323371e-02   -7.435711778575405e-01   -1.132215317619665e-01   +1.119394303584784e-01   +2.532402623318593e-01   +6.387902258439874e-01; +2.074876752699940e-01   -5.495565922227133e-02   +2.611481352232138e-02   -8.783120869041389e-02   +4.187994191761807e-02   -6.060219497298932e-01; +8.773955215574442e-01   -8.380241514005787e-02   +4.689845881264429e-01   +6.338385694682485e-01   +4.732036815465016e-02   +2.028707475857829e-01];
L3_L2_iAMPA_netcon = [+2.199349645008030e-01   -3.683086962052474e-01   +1.123677544859659e-01   +4.373123881662204e-01   -9.564804031169602e-02   +3.612138640249222e-01; +4.577037368342453e-01   -2.368161030475699e-01   -3.109333787473652e-01   +3.827770617885123e-01   +6.235224197729028e-01   -4.473841656735294e-01; +3.706793733568899e-01   +6.838099218407534e-02   -4.226263307722306e-01   -7.029651808028697e-02   +6.435634682589966e-02   +7.413093347083834e-01; +5.820895732891451e-02   +9.694116947779017e-01   +2.213243234532816e-01   +7.037350150301145e-01   +2.671836948585447e-01   +5.524219322283647e-01; +3.453564190701738e-01   +5.960259535096923e-01   +6.673184803346801e-01   +5.522498530168842e-01   +6.445506574953189e-01   +3.186605952031369e-01; -2.500808188545520e-02   +8.994120344823779e-01   -2.461626852202964e-01   +7.378745742511507e-01   +9.178879828716386e-01   +4.391666680551535e-01; +5.399578922237462e-01   -3.871130307298845e-02   +7.634812517183025e-01   +3.891924730829184e-02   -3.191653052610072e-01   -9.497457406376025e-02; +1.890706236930297e-01   +2.051443400250778e-01   +4.594927697254313e-01   +6.614830202110238e-01   +3.189051702865570e-02   +7.257160981096633e-02; +2.856423913012833e-01   -1.103235045003810e-01   +1.409145015848809e-01   -1.348815490732519e-02   +4.542013579870498e-01   -2.672764981847748e-01];
L2_L3_iGABA_netcon = [+3.970609844924292e-01   +1.055734609385005e-01   -3.402175070693276e-01   +5.852906998054971e-01   +2.469367607635427e-01   -3.413262776273427e-01   -1.302653662390922e-01   +1.245990231885593e-01   +5.976975528460892e-01; +3.167076436506810e-01   -3.744959549983987e-01   +3.633560318164251e-01   -5.972747893961934e-01   +5.481031806742549e-01   +5.600643554331831e-01   +5.084187667133514e-01   +7.789052621425374e-02   +4.131086211187625e-01; +9.276686883815083e-01   -1.059818172969027e-01   -1.051583795742883e-01   +1.726809240858624e-01   -1.494641564155390e-01   +2.516890545015861e-01   +2.407310436198359e-01   +3.239860241119453e-01   +3.780300152237136e-01; +1.000000000000000e+00   +1.641820856289324e-01   +2.336235771793588e-02   +2.203362731597825e-01   +2.020066644614790e-01   +4.715101807718849e-01   +3.321062799955609e-01   +1.306053177379480e-01   -1.273826197960116e-01; +4.322278383745904e-01   -2.219223041330383e-01   +2.003179771664499e-01   +4.974565225378514e-03   -1.143966219623641e-01   +7.026098286218402e-01   +6.560792597809394e-01   -1.603732187133506e-01   +5.519374580177444e-01; -1.955181585554767e-01   +1.075690420562228e-01   +4.597351653012824e-01   +2.017731022218093e-01   +7.146679786120158e-01   +5.414902996312743e-01   -1.225089360966508e-01   -4.734687281352287e-01   +1.458831719237330e-01];
L1_L4_iGABA_netcon = [-7.425852886228507e-02   -5.940788785215607e-02   +2.756501515421089e-02   +5.300253901505702e-02   -4.599700861592615e-02   +1.618433659502845e-01   +2.726360915762688e-01   -1.555754619806618e-02   +2.284005575765531e-01; +4.155446352874504e-01   +5.724120813775173e-01   +4.444815680601093e-01   +3.861014864809341e-01   +3.526565236343502e-01   -2.842067933548302e-01   +6.122311273852423e-01   +8.658301088561883e-01   +1.093180105145917e-01; +8.663442830190111e-01   -3.303533275396148e-02   +2.234024019456587e-01   +3.555769747280513e-01   +7.772868675150021e-02   +9.600780989342368e-01   +9.245287369591221e-02   +3.495863520105307e-01   -1.698272779910254e-01; +5.909006383591683e-01   -1.276005908905059e-01   +6.821680450402732e-01   +3.466462426863571e-01   +7.110307563567979e-01   +6.082593502502348e-01   +1.687664852874828e-01   +1.172309607447154e-01   +4.230165409751196e-03; -5.094962855517798e-02   +4.171220249206908e-01   +2.740941962999636e-01   +1.222929216702166e-01   -3.274008264863119e-01   +2.559723968238315e-01   +4.262560025003655e-01   +3.077418640239580e-01   +3.412977385552432e-01; +4.594191456417230e-01   +2.651248495442095e-01   -1.203841748337840e-01   -7.909613436318828e-02   -7.494397594954484e-02   +7.523196722395260e-01   -7.422185083557035e-03   +3.255370196133390e-01   -1.683491585279310e-02; +3.831003076892741e-01   +2.136685183877002e-02   -4.887056692126870e-02   +2.355493310192101e-01   +4.111384077782679e-01   +5.678090609541049e-01   +7.160686703648252e-01   +6.937837925652702e-01   -2.106646898987907e-01; -1.657190561906779e-01   +3.109992367325200e-01   -5.244595135472695e-02   +5.939347446977762e-02   -2.728467767927903e-02   +8.966003592835199e-02   +3.266956977352245e-01   +5.472201727261577e-02   -6.799077974733771e-02; +4.645117888714437e-01   +5.555442256358109e-01   +1.568242210424989e-01   -1.676327901053004e-01   -1.607369413077374e-01   +2.746230566584394e-01   -1.094796478794852e-01   -7.063846778191241e-03   +4.583924766968291e-01; +5.239217021178191e-01   -3.903211883009267e-01   +1.082536886069140e-01   -4.021171848778675e-01   +6.047676003291650e-01   +4.277127257248906e-01   +1.785475992717347e-01   -1.681165968575904e-01   +1.029497242135710e-01; +1.000000000000000e+00   -4.912676472005335e-01   -2.987518501752836e-01   -2.835426986807344e-01   +3.530958609747585e-01   +3.071055182355137e-01   -3.484168620128605e-01   -3.931924140686096e-01   +2.796586813260525e-01; -2.298188520449497e-01   -1.367119396226984e-02   +6.334431160024191e-01   +5.327709804817200e-01   +4.017742004696055e-01   -1.670925891136838e-01   +7.275008989921968e-01   +1.543233758416197e-01   -7.106659359253721e-02];
L4_L1_iAMPA_netcon = [+1.553166746683799e-01   -3.399187936107170e-01   +3.886687707679998e-01   +4.009104531465916e-01   +5.118621669985788e-01   +5.207937047322742e-01   -3.954437136126615e-02   +3.081672148868581e-02   +8.635201189926165e-01   -1.712283650818971e-01   +3.118624606916986e-01   +3.723219763062802e-01; +4.142819921995830e-02   +6.608543390301167e-01   +2.100821203197052e-01   +5.185575132624171e-02   +2.494392382442655e-01   +2.612119162111120e-01   +5.649411075134277e-01   +4.155016909304884e-01   -2.972422022578840e-01   -6.764235052585907e-02   +2.325483467920668e-01   +1.246189334635240e-01; +3.139131821804051e-01   -4.401097801327995e-01   +3.814371368960514e-01   -2.343305346739251e-01   +3.756813454183107e-01   -4.954089321581650e-04   -2.628238944697431e-01   -3.450403194239386e-01   +1.643355357171766e-01   -4.042559408419565e-02   +1.275459373520311e-01   -4.624593196583321e-01; +2.531707666154968e-01   +5.919206507604586e-02   +1.243594369739608e-01   -3.619388757839282e-01   +5.344490834030472e-01   +2.799091655943062e-01   +3.770721430807975e-01   +1.705896142892179e-01   +9.658602939269084e-01   +1.282431825199544e-02   +3.462119875568911e-01   +1.815570311116300e-02; +8.021498510120764e-02   -2.238464050419696e-01   +3.323696119239534e-01   +2.850834252752422e-01   +5.191115963866766e-01   -6.517548217877628e-02   +2.764674880699437e-01   +9.186193842088626e-01   +5.483581886018080e-01   +2.817121148127780e-01   -4.413164200013109e-02   +5.615178361020233e-01; +4.316489057413975e-02   +7.256299218394504e-01   +3.646519341762824e-01   +2.104774685673132e-01   +2.588803392201912e-01   +3.132667818527050e-01   +7.487687369420359e-01   +2.273802290578165e-01   +4.980435998911830e-01   +3.990506333969551e-01   +2.317022584487968e-01   -1.983987884108617e-01; +2.398714951900475e-01   -4.805040025989190e-01   +3.309248222991355e-01   +7.167914081346540e-01   +5.522659514633272e-01   +2.076551290388352e-01   +1.063202398026173e-01   -3.376378664850262e-01   +2.820484053620911e-01   +7.858505034761309e-01   +8.950020025490013e-01   +9.316616322395913e-01; +5.870360794158949e-01   +7.905179522481067e-01   +5.977072936878118e-01   +1.167182315752504e-01   +4.374911979857449e-01   +1.173841859108199e-02   -9.329501457676442e-03   +2.082373546907907e-01   -6.892813220450855e-01   +3.829993269761348e-01   +1.046999764605572e-01   +3.790107083068328e-01; -8.962689326613621e-02   +3.242752763771140e-01   +7.516185073513729e-01   -1.142708754188638e-01   -4.561753394286890e-01   +6.493852811555343e-01   -4.808192436436975e-01   +2.989610925680524e-01   -3.249389962405971e-01   +2.039086961894192e-01   +2.151950261819153e-01   +1.870678547986055e-01];
L1_L3_iAMPA_netcon = [+7.217103438885767e-01   +5.916464992376946e-02   +3.376287002883725e-01   +2.480506172352528e-01   -3.283295075576548e-01   +4.259930062158403e-01   +2.882138644218202e-01   +4.157761704986676e-01   +2.417752271749906e-01; -6.689926932493715e-01   +8.167403892876125e-01   +2.077146521796667e-01   +2.974375204632227e-01   -2.802281902912207e-02   +2.555610406004958e-01   +7.755166316318779e-02   +2.523240073637815e-01   +7.069532277717675e-01; +5.301251685198695e-01   +8.423371976446898e-01   +3.129911776035572e-01   -2.318100009326220e-01   -3.519333559920704e-01   +9.598012408676440e-02   -3.707532014796693e-01   -1.318276058734716e-01   +6.641930295662156e-01; -9.709624087488392e-03   -5.354072509501102e-01   +3.606374935835183e-01   +3.666667088101541e-01   +8.467361508339974e-01   +6.167387953807555e-02   -3.740402203669108e-01   -4.315326366220045e-01   +7.622813577511979e-01; +6.492599635614215e-01   +2.898353821478497e-01   +2.806146865624166e-01   +2.352409177252833e-01   +1.958791611133488e-01   -1.664370452919111e-01   +3.568442072527024e-01   -4.046203768194057e-02   +9.939057489388727e-01; +7.060573670895274e-01   +6.383826851168284e-03   +7.883622057490669e-01   +8.313580231706568e-01   +1.712354250070530e-02   -1.446292780819684e-01   +2.396510299847168e-01   +2.809195077658055e-01   +1.355259994899512e-02];
L3_L1_iGABA_netcon = [+4.355631590443266e-01   -2.036934613088086e-01   +2.687260821943572e-01   +6.105426529690339e-01   -9.552525581645088e-02   +2.217177618815236e-03; +8.677427029028656e-03   +5.630579592004786e-01   +2.404459852874740e-01   -2.768734034698422e-02   -3.526134770690809e-02   -3.464079515057342e-01; -9.389454201075109e-02   +6.401759018260824e-01   -2.583660840081096e-01   +8.176015472685545e-01   +8.603508523563755e-01   -3.740005946574997e-01; +1.180409721037077e-01   -5.380492265037221e-02   +5.997551806575586e-01   +2.242181504940430e-01   +7.133472658755510e-01   +1.420333194319606e-02; -7.201144705844853e-02   +7.919528361475355e-01   +5.934227562058543e-01   -1.967272214597808e-01   -3.300547603069236e-01   +9.903345252481904e-02; +8.470302826745499e-02   +3.348911402932607e-01   -2.104641298656853e-01   +2.406172675397261e-01   -9.642743563617488e-02   +5.731221341007905e-01; -1.041762917232105e-02   +1.488140507726849e-01   +3.963927731757023e-01   +4.610140866425679e-01   -6.511425047750243e-02   +4.937923159195410e-01; +6.991088745658762e-01   +3.947035310533814e-02   +3.840907354398865e-01   +9.241727273160298e-01   -1.132087900121225e-01   +3.379877187734632e-01; +4.325185398264744e-01   -3.318282887814238e-01   -1.535172543248725e-02   -1.461923974249442e-01   +7.746218289483101e-02   -1.776890118560018e-01];
L5_Input1_iAMPA_netcon = [-3.278371560131760e-02   +7.942860956020810e-01   +6.713945859791025e-01   +2.269008185308256e-01   +4.688908059512521e-01   +1.132692896712367e-01];
L6_Input2_iAMPA_netcon = [+4.411166292842913e-01   +2.248262300024566e-01   +7.173906792234150e-01   +6.292501988306088e-01   -1.348621601003377e-01   -6.123005956100802e-02];
L5_L6_iAMPA_netcon = [+8.260748727841498e-01   -2.394595802959345e-01   -2.415884327663244e-01   -2.142261909444497e-02   -3.904715609884101e-01   -3.671050858480952e-01; +1.063435720036036e-01   -2.804467861283278e-01   +6.836748673445069e-01   +5.268389894159287e-01   +2.536993035063496e-01   -1.504683060495338e-01; +6.880813493181470e-02   +5.436973377390832e-01   +2.885412686287808e-02   +1.886832846266393e-01   -5.955776345656663e-02   -5.886580951475808e-01; +2.436082120702670e-01   +3.827765717894747e-01   +2.883325266305837e-02   +2.814259371532406e-01   +1.185643496743377e-02   +7.093961921635700e-02; +4.572528132876888e-01   -1.924991667450987e-02   +6.034510637982021e-03   +8.338265747979250e-01   +5.004705971900849e-01   -5.192124646285202e-02; +6.512433379307814e-02   +7.055866518247185e-01   +1.903900944120448e-01   +2.428889734604007e-01   +7.214030266243261e-01   +8.381464179738130e-02];
L4_L5_iGABA_netcon = [+5.103291055630989e-01   +2.514166489829719e-01   +5.874145385708371e-01   +1.994266993424806e-01   +8.347276423692903e-01   +9.465429072611042e-02   +1.459958193375112e-01   -2.547967804646689e-01   -9.248617651698719e-02   +6.504648219180291e-01   +4.744445965493734e-01   +5.539541235787367e-02; +1.920475188795802e-01   +1.422134697730484e-01   +4.030239737585613e-01   +5.218894909621633e-01   +2.324884542716435e-01   +4.155971039831344e-01   +3.230924162948541e-01   +3.461258267750679e-01   +3.975472789160658e-02   +6.838956674041581e-01   -2.143723424788937e-02   +3.709808533820887e-01; +1.692628467907037e-01   +8.866051090201839e-02   +3.047641005337575e-01   +9.719642720725116e-02   +1.934778215320333e-01   -6.505446676862817e-02   -1.205232152931412e-01   +1.419189714177647e-01   +1.625694799858095e-01   +8.620188453965836e-01   -3.458695084185210e-01   -4.927048029214434e-01; -6.910767765050576e-01   +6.790836503502605e-02   +5.282345371095000e-01   +7.029005459263792e-01   +4.391165858828530e-01   +1.055463262565657e-01   +3.326544906652830e-01   +1.804600179699279e-01   +3.964604317739533e-01   +6.779127903609575e-01   +2.077720314434687e-01   +8.615350003177864e-02; +3.070781166125157e-01   -6.870440827599687e-02   +3.125515225069617e-01   -8.332384498051268e-02   +1.000000000000000e+00   +2.197530444164102e-01   +4.148900848385351e-01   +2.311120548201160e-01   +1.032107436021976e-01   +3.265197909886658e-02   +4.581451638060887e-01   +5.156630671736103e-01; +5.905431665888204e-01   -4.413054884088016e-02   +2.088480343610577e-01   -1.979336479970736e-01   +7.191266143834066e-01   -4.505454267729286e-01   +1.383714999907486e-01   +3.255698187138796e-01   +4.533806291167216e-01   +2.168827526233541e-01   +3.568678695771930e-01   +3.281516464647484e-01];
L6_L4_iAMPA_netcon = [+2.968822943025698e-01   +8.752447203768583e-01   +2.624890164029837e-01   +4.157461142744051e-01   +2.411155621895975e-02   +4.512697835245810e-01; +7.314312956659125e-01   +3.128253391566354e-01   -8.115533891703056e-02   +1.364525130220693e-01   +3.316479227819795e-01   +6.113880196285951e-02; +1.857032127100884e-01   -6.229221417632776e-01   -1.404932386358762e-01   +1.939482661709982e-01   +4.182368980274198e-02   +4.065097796358486e-01; +5.071577417119287e-01   +3.964456130187699e-01   +9.031589175778559e-01   -2.391448466290310e-01   +3.357781458152445e-01   -1.512644309569526e-01; -2.532563508564536e-01   +7.182375218507799e-01   +6.287178258094337e-01   +7.086895225367054e-01   +2.175697635875774e-01   +5.275178346149944e-01; +6.599259776498652e-01   +3.001522844971763e-01   -1.505925019362392e-01   -1.980196488522636e-01   +7.433634538852563e-01   -9.406049507812786e-02; +9.621752517220867e-01   +2.636319755746298e-01   +3.576196595613099e-01   +9.057968450650642e-01   -4.580525867359803e-01   +3.686466158298403e-01; -1.365480009689618e-01   -2.779348812711939e-02   +2.088255761865078e-01   +1.557321933117481e-01   -1.931100046106637e-03   -3.010457629805644e-01; -1.587561875401594e-01   +4.574160500465286e-01   +7.598493355123550e-01   +3.838177015477529e-02   -3.599066853088309e-01   +6.276643998724540e-01; -4.147849096686245e-01   -1.909009372402792e-01   +4.087389494425308e-01   -6.712622072173417e-02   -2.719856196495534e-02   -5.596365829134867e-02; +2.743104851313053e-01   +8.148434995455905e-02   +1.351360095177484e-01   +1.048502231038671e-01   +6.288641457229357e-01   +7.804189451333057e-01; -2.796193629378992e-01   +1.096055902869314e-01   -2.679182876060976e-02   +3.858836051625413e-01   +7.935207703271208e-01   +4.039803915029125e-01];
L5_L4_iAMPA_netcon = [+3.109217452001838e-01   +6.387781088549949e-01   +9.824551252390863e-01   +3.150410485436327e-01   +8.258190358034858e-01   +9.052478319998638e-01; -5.631845725186527e-02   +3.414860494580455e-01   +7.414763148102052e-02   +5.352562664035254e-01   -2.793598896179166e-01   +9.157583378458729e-01; +3.654945431448057e-01   +4.950630409688630e-01   -3.569804916414537e-01   +3.665467067141998e-01   +5.934606879713464e-01   +4.415570503754911e-01; -1.182757735134132e-02   +2.430098854212236e-01   -8.736750638086434e-02   +1.182893572272786e-01   +3.350034203445579e-01   +3.426325931034779e-01; -8.990444048116016e-02   +1.877617513365215e-01   +1.983998680717879e-01   +2.793276847079387e-01   -7.647723326006416e-02   +1.635456254662026e-01; +7.100161609399227e-01   +3.813832158758778e-02   +4.135802348476524e-01   -1.709081660391948e-02   +3.097607015580842e-01   +4.558067256078258e-01; -1.091768379652399e-01   +8.031482999678347e-02   +2.008343082433112e-01   +6.617763452818927e-01   -3.142626903263695e-01   +5.640618414176100e-01; +1.057901317764046e-01   +1.429216271935140e-01   +4.952426419072003e-01   +4.447428449910211e-01   -2.522909283656826e-01   -1.710116765692480e-01; +2.260632240877808e-01   +1.354253071406763e-01   +5.948632313342550e-01   -2.057914673107068e-01   +7.517848069421793e-01   +4.505654095819497e-01; +6.955087162742204e-01   -1.770955637122211e-01   -6.409373770504595e-02   +3.414670743771157e-01   +3.322287481514935e-01   -5.855495401387076e-02; +8.139392914095847e-01   +2.104131672705499e-01   -2.339762562838405e-01   +1.105883455525758e-01   +2.251686294810629e-01   +4.409634165566249e-01; -1.556665959336112e-02   -8.350760413753849e-03   +3.759346669705108e-01   -1.186135504445490e-01   +9.240075050674884e-02   +5.542414441016461e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
