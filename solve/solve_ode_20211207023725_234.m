function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.159642859812755e-02   +4.782520653475972e-02   -4.147678981906218e-02   +4.782236957049039e-03   -4.284957318041380e-03   -2.903185534223560e-02   +3.410989808490589e-02   +1.491573803744520e-02   +3.861850595707950e-02; +5.384605575147527e-03   +3.947624360764099e-03   -5.657574341025260e-02   -5.697681192329983e-03   +3.592792472163762e-02   +1.107245312004261e-02   -3.709430413265150e-02   -9.560199367823411e-03   +2.417066164752293e-02; -8.726211121438777e-03   -1.792531972665875e-04   -4.023152171631337e-02   -4.192835246447853e-02   -4.042206449193454e-02   +1.403218382601512e-02   +2.457374131146571e-03   -2.845650974262316e-02   +5.260473741500467e-02; -1.449633258118760e-02   -4.529523558454897e-03   -2.049468923191845e-02   +4.368401282067215e-02   +2.928147525454602e-02   +4.440333361693390e-02   -3.058293062803429e-03   +1.944977649977507e-02   -2.535355899257813e-03; -4.076641342578257e-02   +8.800928459115950e-03   +1.576560813875486e-02   -3.045347050686742e-02   +1.143116214308253e-02   -1.874044696416622e-02   +5.812756334965241e-02   -2.103498275673545e-02   -1.785754387427975e-02; -1.747667315247918e-02   +5.808105120680704e-02   -7.500125015552112e-03   +2.767810496677575e-02   +5.800043654820294e-02   +3.329415345927847e-04   +5.898978372530191e-02   -2.454331867871094e-02   -1.156618368708351e-02; -6.522780032014576e-02   -2.303700749111232e-02   +6.688761199594845e-02   +5.567181545999058e-03   +2.348593141533850e-02   -1.587735859836996e-02   -1.414811862550065e-02   +2.399201276203665e-02   +2.157189481400357e-02; +6.984889997273888e-02   +6.992309913910106e-03   -7.227616484478519e-02   +4.458378081145552e-02   +3.696709050572070e-02   +1.819359474529132e-02   +6.209360218157677e-02   -3.858682888192408e-02   -3.651508814417795e-02; +5.133645325223028e-02   +6.396017832523269e-03   +1.493759499563145e-02   +2.579087816097101e-02   +2.236549386974576e-02   +1.624518331374370e-02   +1.425730684409331e-03   -4.839113385960988e-02   +3.483211965640103e-02];
L1_L2_iAMPA_netcon = [+2.489564192454329e-02   +3.022941705584376e-02   -2.007747184772337e-02   -2.387492405759244e-02   +3.532806127634178e-02   -2.734626632177621e-02   +1.683828543459763e-02   +5.865071822708236e-02   +2.772394580538868e-02; +8.171173228121600e-02   +6.545112139311188e-02   +5.180512665048267e-02   -2.456680362947663e-02   +4.201204379064120e-02   +5.820469392529033e-03   +7.552527364649189e-03   +1.696975362888997e-02   +8.798601866778204e-04; -3.342355228958974e-03   +3.296438694257057e-03   +7.611387614434588e-02   -6.224944172263969e-03   -2.775393374330153e-02   -1.139973281232983e-02   -1.734099958887259e-02   +5.243429576794369e-02   +2.329738851836665e-02; -2.190088267276107e-02   -1.487956260530706e-03   +6.164780628189660e-02   +1.423110100586611e-02   +2.160636657893796e-02   +4.390602774854998e-02   +3.000477476549464e-02   -1.991989295789241e-02   +2.760214771571259e-02; +1.417139540369284e-02   +3.004413598845431e-02   -5.721752567726950e-02   -7.839230857867932e-04   -1.967073757593112e-02   +5.461163037903285e-02   -7.950141134442836e-04   +4.385537083421543e-02   -1.262666423471744e-02; +2.673580298189839e-02   +2.685657463754280e-02   +8.453640637328862e-03   -1.251147091457334e-02   +5.656636433723689e-02   +3.943127367268613e-02   +3.571467223400256e-02   +3.623736549072445e-02   -2.965756023936190e-03; +2.429830853761462e-02   +1.504758200140885e-02   -8.823603516573839e-03   -6.577336399140897e-03   +2.343576491690884e-02   -2.686148120604543e-02   +3.495191073525315e-02   +4.984640032931632e-02   +7.635596449468169e-04; -1.813140616118682e-02   +1.284772899278612e-02   +4.126802039752080e-02   -4.418987462403497e-02   +7.620857938120264e-03   +2.371645105275257e-02   -2.769065780543375e-02   -1.060629131211323e-02   +2.275301150291838e-02; +6.571774410721526e-02   -1.236516366139061e-02   -3.630907470125315e-02   -3.593996491769703e-02   -2.225340416932939e-03   +2.270983284898262e-03   -5.476899339419710e-03   -9.307537266807706e-03   +3.176971686906710e-02];
L2_L5_iAMPA_netcon = [+3.957367706438088e-02   -1.810294211815534e-02   +6.688182421981816e-02   +3.031729542566112e-02   -6.175659457006029e-03   +3.145103902054904e-02   -5.776910381909577e-03   +5.277045935164038e-02   -6.560308856097295e-03; +9.133298766494940e-03   +3.435696962726181e-02   -1.853453649727178e-02   +2.738119153453433e-02   -4.028446891364794e-02   +1.797814444466415e-02   -2.093510517607799e-02   +1.910478904489327e-02   +1.301159237593152e-02; -3.097795036767281e-02   -4.637641445535608e-03   +1.656831799496050e-02   +1.251837255600152e-02   -1.300845458664740e-02   +6.790032226514942e-02   +2.995089558488282e-02   +1.431137148449875e-02   +5.329688953555776e-02; -6.462667125500601e-04   +7.710843813316087e-03   +6.613695946145910e-02   +8.141916658124296e-02   +5.157407707873606e-02   +1.484745686158848e-02   -5.284140492349656e-03   +3.068803610607806e-02   +6.058172785036309e-02; -2.985909160145650e-02   -7.658722823501076e-03   +9.732315636061398e-03   -2.133331593330559e-02   +2.603427357499647e-02   +3.739294354372152e-02   -1.451075742854775e-02   +2.751517244444612e-02   +5.653060973578782e-03; -2.362366545276074e-02   -5.164134397279661e-03   +6.051449959291372e-03   -2.512078301364418e-02   +1.781477013159025e-02   +4.845286967788104e-03   -1.175339950732607e-02   +9.913781142399904e-03   -1.632666853843452e-02];
L5_L2_iGABA_netcon = [+4.476779619653054e-02   -1.622690263799435e-03   +9.822857446562524e-03   -2.712956592148692e-03   -4.850326031451513e-02   +6.319691331403904e-02; +7.893110467116219e-03   -2.009664372387788e-02   -8.282016962652870e-03   -2.389354217049485e-02   +7.597217837716930e-02   -2.021493140503798e-02; +1.364698238409768e-02   -4.901664617290351e-03   +4.481043226117080e-02   -6.046705883517235e-02   -4.790315746087023e-02   +6.139293039385472e-02; +7.430269997805786e-04   +3.497198447291541e-02   +3.592110307893864e-02   -3.556248688911967e-02   +1.471243242544840e-02   -4.548444429988316e-02; +1.554964574610962e-02   +6.953013216815404e-02   +1.177232473480672e-03   +1.931042918624213e-02   -2.915467211020375e-02   +2.166640036014450e-02; -2.214120286184214e-02   +4.337192499448443e-02   -3.699829923019598e-04   +1.584634125791353e-02   +6.292205296121418e-02   +8.831465360071455e-03; -4.559702772684829e-02   -2.454995073054785e-02   -2.602719422533034e-02   -5.069299082222667e-02   -6.139126369164769e-04   -1.417085225247968e-03; +3.103080089705620e-02   -7.311122381354743e-03   +1.652859314319273e-02   +2.093492376728161e-02   +5.410838474797028e-03   -1.243746338653804e-02; +4.242903599820518e-02   +1.374345183789442e-02   -4.926872645892041e-02   -2.805198398938732e-02   -5.483529080101737e-02   +1.002277425005041e-03];
L3_L2_iAMPA_netcon = [+2.500042181008176e-02   -3.555081096732161e-02   +2.628166093764903e-02   +3.312382982469199e-03   +4.927744947708591e-02   -3.098423412750652e-02; +5.823115495089538e-02   +9.292715087185297e-04   +9.718865144717873e-03   +7.385212529152314e-03   -1.910394935438270e-02   +5.980671616892154e-03; +1.222324230721493e-02   +1.782201547255460e-03   +3.032224888564034e-02   +3.505549757801926e-02   -2.198910533627558e-02   -2.010157686010642e-02; +2.482907738755770e-02   -1.139076054002927e-02   -9.927296468734781e-03   -3.177232047831992e-02   +4.716809840992927e-03   +1.146858849343076e-03; -4.979315297111653e-03   -8.415851355654105e-03   +2.212831575192815e-04   +7.992093212916038e-03   +4.711927669425703e-02   +1.182339220722721e-03; +7.302589523245442e-02   +3.894585952630441e-02   -4.040676991188068e-02   -3.767856997916056e-02   -5.488310804365806e-04   +2.519203633079008e-02; +2.582167691973941e-02   +3.042057156883009e-02   -6.560909154044131e-03   +1.479686499949989e-02   -3.370769570457242e-02   +3.260399877459257e-03; -2.362317156077542e-02   -1.282957403113897e-03   +1.661645000960925e-02   -2.117060775054051e-02   +2.835509626705536e-02   +1.258701795651774e-02; -2.824727991433740e-03   +1.844737168975549e-02   +3.433840540986525e-02   +3.298464093703098e-02   -4.762234906314847e-04   -7.599940009239111e-03];
L2_L3_iGABA_netcon = [+1.020639202706790e-02   +2.254055131326326e-03   -1.065792931777850e-02   +6.635124911400873e-02   -1.468863654249770e-02   -9.778841497880436e-03   -3.876299177888196e-02   +3.794635197219674e-02   +6.596115561304586e-02; -2.614089069320393e-03   +2.669115363626381e-02   +5.828042107077199e-02   -4.127488959847343e-02   +8.107876508318171e-02   +1.500239886167980e-02   -1.755562838197761e-02   +2.528590037607218e-02   +7.820095944701491e-02; +4.843502463750174e-02   -5.068683174512274e-04   -1.996318838831364e-02   -4.875724096471607e-03   +2.683553128720927e-02   +7.312885193875501e-03   +7.122827635302208e-03   +3.939876260493285e-02   -1.932734408937589e-02; -1.627917290310152e-02   -4.841026364614823e-02   +1.989934328671741e-02   +1.682179582934346e-02   +1.286935292456745e-02   +6.181228159185041e-03   +2.962231714298547e-02   +6.774316777801530e-03   -2.652998640544459e-02; -2.295069117365163e-02   -1.019631529115037e-02   +2.106472082731600e-02   -1.940754845500844e-02   +1.222609102832344e-02   +4.252274578280367e-02   -2.620668589431126e-02   +1.906778125479108e-02   -3.849472140927668e-03; -4.257484972502594e-02   +1.503005692677632e-02   +7.970572430963424e-02   +7.558430174021891e-02   +4.478422063932047e-02   +4.313443426640019e-02   -1.921441155763399e-02   +7.563474659853585e-02   +4.916126551133847e-02];
L1_L4_iGABA_netcon = [+3.463682100009373e-02   +3.024555981890771e-02   -4.057264003862807e-02   +4.371239102510349e-03   +6.481268902637005e-02   -1.317014604684926e-02   +5.914398658013478e-03   -2.646088663951950e-02   -2.058537066664501e-03; -3.376744576848650e-03   +2.374287316525036e-02   +7.641277830095872e-02   -4.020071507022556e-03   +5.684347993009523e-02   +5.439582633536029e-02   +3.421477465070103e-02   +5.315054074825214e-02   +3.779539039733951e-02; +1.853223826317881e-02   +3.978687611938807e-02   +2.430866395877220e-02   -8.851497269147265e-03   +7.351165268465094e-03   -3.335447209328175e-02   +3.955818649887630e-02   -2.656064765340148e-02   +6.833988413519110e-03; -4.392580107766321e-02   +1.264728989158945e-02   -1.464073666559100e-02   +1.928041176768936e-02   +4.286235373659967e-02   -2.795648113395255e-02   -3.162605321927725e-03   -3.620391369844304e-02   +1.151929216940481e-02; +3.174605611789512e-02   +7.238407694211951e-02   -1.458398360588902e-02   -2.619019526315710e-03   +6.825920324736258e-02   +1.056889825457245e-02   -3.760344180975073e-02   -3.620556414049791e-02   -6.220120454452714e-03; +5.129010777129375e-02   +3.825143708014269e-02   +3.606977561243806e-02   +5.809639254159055e-02   -2.994460905206456e-03   +8.644396938719162e-03   +2.479160983630838e-03   +3.404870031912639e-02   +1.563001017542089e-02; -1.921586242360616e-02   +2.715307414544751e-02   -1.772525304875396e-02   -3.509963157640707e-02   +5.744917361909786e-02   -2.833481225360411e-02   +1.560353128275708e-02   -3.104935971216947e-02   +3.103196004775230e-02; +3.462895009244316e-02   -2.211124362420458e-02   +5.103340640688044e-02   -1.754838750341181e-02   +2.172229883689636e-02   +6.196664707139902e-02   +4.675899272686043e-02   +3.500960503842761e-02   +8.681844786848081e-06; -2.825994285926281e-03   +2.584550271731136e-02   +2.692400583542400e-02   -4.921540770292554e-02   -1.245386419406399e-02   +5.857942673943771e-02   -6.343864139651392e-02   +4.885630404212721e-02   -2.644384793744271e-02; +4.586514870676822e-02   +3.894852419531798e-02   +1.578735317233301e-02   -1.385914210486719e-02   -3.669175634092627e-03   +6.491848729534291e-02   +1.589917777378897e-03   +1.201540787778827e-02   +2.659160981214460e-02; +2.141027122807299e-03   +6.066877031365159e-02   -2.843718209542566e-03   +1.498707454727201e-02   -3.447295146734881e-02   +4.135366683792607e-02   -8.594055274258813e-04   +4.799288550024498e-02   -9.418954641585186e-03; -4.252703441279201e-02   +3.154016421898800e-02   +6.539420695379812e-03   +2.572678674720838e-02   -1.008263042378422e-02   +6.656222102641096e-02   +6.317576238926981e-02   -1.065468375285670e-02   +4.050148006771366e-02];
L4_L1_iGABA_netcon = [+1.454154088445657e-02   -2.395614143952765e-02   +3.489125948718079e-02   -1.919992744639675e-02   +1.798801240239569e-02   +7.573974312918658e-02   +2.648768348723781e-02   +3.861721553756825e-02   +3.202924370981821e-03   -7.142426798266596e-03   -1.823775284410801e-02   +1.915487181795128e-02; -4.441337803105283e-03   +4.551637653483936e-02   +4.102399498225308e-02   -1.212095866841516e-02   -3.963299250557437e-02   +9.091957725801203e-03   -9.057521718573748e-03   -2.186376591249364e-02   +2.797006026301249e-02   +3.177179338609397e-02   -6.949857490812237e-03   +4.715460089980864e-02; +5.377025280012552e-03   -4.809887886778903e-02   +4.739897397999153e-02   +8.754374211800489e-04   +2.203537193189777e-02   +1.280591320886259e-02   +4.002078957042438e-03   -2.388972378454119e-02   +1.710929754839733e-02   -2.518583637334815e-03   +1.118005714929531e-02   +2.543528000750230e-02; +4.935254231889850e-02   +4.242438483129865e-02   -2.733788693309130e-02   +3.477672769935666e-03   -4.501355574997599e-02   +4.286121948413416e-02   -3.979927313139066e-02   +2.226739823388276e-02   +2.404096843284333e-02   +3.964861930667529e-03   +2.460859067039570e-02   +2.194505721601294e-02; -3.018198122737525e-03   -5.591716064504232e-03   -3.072803037494009e-02   -3.455349029890694e-02   -3.031578740217006e-03   +5.943212641131583e-03   -1.939695271038874e-02   +5.833553368771874e-02   -1.376176461786675e-02   -1.851623188433971e-02   +5.543326363786042e-02   -1.073311594448180e-03; +1.347809780284805e-02   -1.199556241351093e-02   -2.585832028259909e-02   -1.777929500140082e-02   -3.423998148620474e-02   +3.598108230627409e-02   -3.020197660989021e-02   +5.591758917175796e-02   +5.641453218629584e-02   -6.663492463490671e-02   -2.878662720385313e-02   +2.774161758342534e-02; -2.619634289919105e-02   -6.114015208113797e-02   -1.065136920040496e-03   +1.509803560587911e-02   +1.218257912267689e-02   +3.172093311068196e-03   +5.295257098906010e-02   -9.476075395499873e-03   +1.173712514763989e-02   +1.447974280865479e-02   -9.220124578039890e-03   +5.402863142053962e-02; -2.035268685685677e-02   -3.544659581155506e-02   +4.022224956318897e-02   -2.089148687724895e-02   -1.971661083714819e-02   -1.893474390292438e-02   -1.826051492872012e-02   -1.510086179852822e-02   +3.676671805285480e-02   +4.325467809221865e-02   +1.493024167472123e-02   +9.050173491418498e-03; +5.917386043883138e-02   +3.925420644629612e-02   -1.293669780294212e-03   -2.493081909685411e-02   -8.654704185925600e-03   +3.265840027471545e-03   -8.141603608034228e-03   -1.972676825661404e-02   +3.104355905511689e-02   +3.521257606124856e-02   -5.855287743895340e-02   +3.639856718575943e-02];
L1_L3_iAMPA_netcon = [+1.838003859302590e-02   +3.354428912676802e-02   +5.273035006917453e-03   +1.648406386670574e-02   +1.829581492477457e-02   +4.681728848008089e-02   +7.388140233445792e-03   +3.296074622246489e-02   -4.987378291930118e-02; +7.282678525848740e-03   -2.303954208318180e-03   -2.443183242785403e-02   +3.553342813912085e-02   +6.409775906120534e-02   +3.413918447996077e-02   +4.409364866812938e-02   +2.629652551835286e-02   +4.808278055337677e-02; +3.460311982523573e-02   +2.491215484752853e-02   +1.236946050194321e-02   +6.422631368640014e-02   +1.373653664314679e-02   +1.790287574114770e-02   -2.305057763800828e-02   -1.327046305473189e-03   +3.814960210568544e-03; +6.281074315394673e-02   -2.068674224656646e-02   -4.751964340706007e-02   +3.097456464822497e-02   -4.818545932456342e-02   +4.240455332042217e-02   -2.179781155448194e-03   -2.183360100528751e-02   +2.243335907449262e-02; +4.195496894246700e-02   -4.009722234676064e-03   -5.460414074672647e-03   +5.156132009261304e-02   -2.996916095954861e-03   +1.267714394419105e-02   -9.778515850310966e-03   +2.454611759526391e-02   +5.028138923135496e-02; -2.338284059293690e-02   -5.911312977992262e-03   -6.505982005459481e-03   -3.106001272406908e-02   -2.246395589576840e-03   +1.198845101633978e-02   +2.631782100968930e-02   +1.645588377663910e-02   +2.001882753417472e-02];
L3_L1_iGABA_netcon = [+4.808745470122270e-02   +6.845265262862621e-02   +3.833541722870125e-02   +1.185576774280270e-02   +4.320262282565641e-02   -2.756982906003970e-02; +1.613311077713126e-02   +9.805300938823211e-03   -1.336338391468831e-02   +3.363988509187434e-02   +3.099923654837644e-02   -4.819165971671741e-02; +2.370417506518151e-02   +1.667297566615233e-02   +7.120120087271234e-02   +8.245471403750008e-03   +1.418837072118676e-02   -6.016501560314514e-03; -4.833996934182731e-04   -2.130850178989296e-02   -5.441442551423879e-02   +7.957634600896327e-03   +1.150493192483313e-02   +4.852358002805787e-02; +3.778667522629935e-02   +4.241688581587764e-02   +4.799696115083558e-02   -3.362857600872277e-02   +4.443080424765792e-02   -5.617126976337563e-03; +1.446623829005146e-02   +1.523350860309705e-02   +1.290657662432184e-02   +1.625469286579939e-02   +4.903557005401888e-03   +3.825059707710736e-02; -4.615184280582989e-02   +5.041786521074623e-02   -1.568819314996067e-02   +2.494838934439335e-02   +3.401078528789210e-02   +7.567561604078375e-03; +4.241862771421297e-02   +2.348346452028568e-02   +6.469329248358750e-02   +6.240686533777531e-03   +1.266841933769853e-02   +1.447183663466208e-02; +2.346712696584437e-02   -1.244149353635628e-02   +1.519226395180804e-02   +5.668212932130524e-02   -2.944824319272449e-03   -2.800879735805648e-03];
L5_Input1_iAMPA_netcon = [-2.372980459780985e-02   -4.425787898112732e-02   +1.257779135249062e-02   +5.936017993382932e-02   +5.120079192243528e-02   +3.928316989985694e-02];
L6_Input2_iAMPA_netcon = [-1.428428663700979e-02   -5.593349687058317e-03   -7.969678561892519e-03   -5.625688023285622e-02   +5.228400431853607e-02   -1.738414599776834e-02];
L5_L6_iAMPA_netcon = [+3.422224695240762e-02   +3.716617822943192e-02   -3.534242987381027e-02   +4.125878731999861e-02   +4.399404103618692e-02   +8.456099022328984e-03; -4.601781366179969e-02   +1.954663682398861e-02   +1.221744197814784e-02   +3.811872355233133e-02   +8.001549050560181e-03   +5.584173703174346e-02; +5.923420824976692e-03   +5.128315633801395e-02   +3.246007061608822e-02   +1.617514469440582e-02   +3.793412974642756e-02   -5.013358337384883e-03; +4.854484167291286e-02   +1.358235014507379e-02   +5.501843196125721e-02   +2.393408453606483e-02   +6.487200639857879e-03   +7.276678278874672e-03; +4.959595276063371e-02   +6.450607854630512e-02   +6.333119032816212e-02   +2.262657835185944e-02   +5.033508770228099e-02   -1.790333098416022e-02; -6.311541604907931e-03   +1.649854336277384e-02   +6.155091871038042e-02   -1.075850411820161e-02   -3.618690451434230e-02   +3.812553587857009e-02];
L4_L5_iAMPA_netcon = [-3.585861525756681e-02   +7.505463652063081e-03   +1.597044413336678e-02   +4.766255144184307e-02   +3.893222937821623e-02   +1.625012527266951e-03   -1.192267166877307e-02   +5.536816723684497e-02   +2.159198547888853e-02   -5.046587470717531e-03   -8.319036306309611e-03   +4.775715942478171e-02; +1.244418618512785e-02   +1.038991622741237e-02   +2.025516562838391e-02   +3.509583246214786e-02   +3.758613212269648e-02   -1.344002459748461e-02   +6.933310685930860e-02   +8.430775975714153e-03   -3.541419944560736e-02   -3.687457399205320e-03   -4.244064319892236e-03   +5.225863086338582e-02; -2.361127095839438e-03   +3.077560070763225e-02   +5.403110917739729e-02   +5.528944701610275e-02   +3.322421826242587e-02   +2.918346687858736e-02   +3.658893043040722e-02   +2.144887238725711e-02   -4.369629468318655e-04   +3.390237459784680e-02   +4.846903913965838e-02   +5.369795195187994e-04; -9.025060127803446e-03   -2.337294132636835e-02   +5.856040678912960e-02   -2.718416435384896e-02   -1.773585829690740e-02   -2.782449100395097e-02   -3.225980696460908e-02   +4.944639167687202e-02   +3.864886027661458e-02   -2.272326787271961e-02   +2.794368807023471e-02   -2.811005422221902e-04; -2.874198560079296e-02   +3.767796032706262e-02   -3.691082277645037e-02   -9.863190554190271e-03   +1.277702778743379e-02   +4.689400335232559e-02   -1.723721890497913e-02   +8.371127262389221e-03   +6.694462288376526e-02   -3.654519441536593e-02   +3.523321534419482e-02   -2.287334554191250e-02; -4.445054132313511e-03   +2.446398823358971e-02   +9.726491739321225e-04   +7.775217764057270e-03   -3.954913532184477e-02   +5.741356176891177e-02   +5.295610928581247e-02   -8.512795144060628e-03   +3.993578602025875e-04   +5.323783582807425e-02   -5.065507039399684e-03   +2.602538820874026e-02];
L6_L4_iAMPA_netcon = [+3.467111494152499e-02   -6.634779174691026e-03   +1.750731366896193e-02   -3.870351852854539e-02   -2.071487772247480e-02   -2.092052841407959e-02; +8.049298672633577e-03   +3.711580065727443e-02   -2.440794286774725e-03   -4.788067953117287e-02   +1.291137486411716e-02   +2.474120110118433e-02; -1.492086576940263e-02   +4.021497805300218e-02   -3.249273233284088e-02   -1.961835674308188e-02   +3.042861140705539e-02   -2.790767133455158e-02; +5.324979806806326e-02   -1.155195546163596e-02   -5.585835632279528e-03   +2.701667120540599e-02   +2.772282829352143e-02   -1.642317364900110e-02; -1.298836333592176e-02   +1.262861395871042e-02   +6.736802923232534e-03   -1.379440168286632e-02   +5.537547128323804e-02   +5.230483021424920e-02; -3.374615440436175e-02   +6.677236398572867e-02   +1.321390160192172e-03   +3.399884319803752e-02   +2.415908865931297e-02   -1.129589557848629e-02; -2.163848651365981e-03   +5.723778304155318e-02   +5.373185177220557e-02   +2.259715263425109e-02   -5.157699215725692e-03   +1.577919354203519e-03; +2.002038330889271e-02   -3.490448313844924e-03   +4.036274743727521e-02   +6.200545378272382e-02   +3.992432781909462e-02   +7.135633326255178e-02; -2.402410798289904e-02   +7.061654103221830e-02   -4.350257366306101e-02   -3.675048251654633e-02   -1.508625960027881e-02   -9.938101267556940e-03; -3.060636824319360e-02   -5.447068681118547e-02   -3.577406444239607e-02   +4.746026711610317e-02   +5.699257738541223e-02   -2.543283374924792e-02; +4.138191971068072e-02   -1.544055311747885e-02   +7.541330650671775e-02   +4.535710532017442e-02   -6.925713173279145e-03   -2.224327956237217e-02; +5.636665270352516e-02   +1.042272932755707e-02   -3.052207239552483e-02   +2.463557924838002e-02   -3.785465345690751e-02   +1.741210216813631e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
