function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.321409147246433e-01   -5.832943405514585e-01   +3.719795496203649e-01   -6.425786288401312e-01   +4.592741953873032e-01   +9.423743017807552e-01   -6.219296134176215e-01   -7.844626933933170e-01   -7.561097361767863e-01; -7.319987867913265e-01   -3.482836526110959e-01   -6.694774517159044e-01   +2.039959325606465e-01   -9.101345239114587e-01   +3.215003739181993e-02   +2.006272311489701e-02   -3.641673280136314e-01   +4.086714421202848e-01; -9.264785796665656e-02   -7.938013392992343e-03   -1.689894220061007e-02   -8.855306134591444e-01   +4.570039451309066e-01   -8.297440086927419e-01   +6.280851624583559e-01   -8.589368019839030e-01   -5.470457998165391e-01; +6.525267076826075e-01   +3.703905569087544e-02   +8.023699281859820e-01   +4.011504837489003e-01   +1.197789566632641e-01   -5.521816209059045e-01   -7.835761742832142e-01   -6.155967697913975e-01   -9.076957503971458e-01; -4.738231031927345e-01   +1.906240177591554e-01   +6.698710911050281e-01   +5.106619651053512e-01   +3.293267562780707e-01   +6.451726732440866e-02   -8.331270763755468e-01   +6.998302161905151e-01   +4.791313777267933e-01; -5.855793992056526e-01   +2.506153089245334e-01   -1.000000000000000e+00   +5.660183534664298e-01   +3.518433829238249e-01   -8.483994541973320e-01   -5.480191897335714e-02   +3.495229689869547e-01   +6.318279312158165e-01; -9.057150733288095e-01   -2.281998551573785e-01   -3.959241926468849e-01   +4.543092853792284e-01   -1.254103367617282e-02   +2.959658076684574e-01   +7.262700170698025e-01   -1.486388417915405e-01   -2.708822105603859e-01; +8.265181618622376e-01   +2.491650388374340e-01   +5.596484566562969e-01   -1.069495248611059e-01   +2.011034972340471e-01   +7.394823851094522e-01   +1.104994757871517e-01   +2.781412899036004e-01   +1.181774875429608e-01; +3.236571819027206e-01   -5.463956942950100e-01   -8.516875945895647e-01   -5.105792981745157e-01   +5.442263441572286e-01   -1.158834818733747e-01   -2.859773287465779e-01   -6.929123311645042e-01   +1.422913616952497e-01];
L1_L2_iAMPA_netcon = [-1.929832724403056e-01   +6.264138832775117e-01   -6.475497649477059e-01   +2.604449231337845e-01   +1.000000000000000e+00   +7.918062107676747e-01   +6.355610831473137e-01   +5.240685178804332e-01   +6.942704173000155e-02; -4.244139213406695e-01   +7.817820446747351e-02   +5.875841469044515e-02   +2.378037138877905e-01   +4.029087604844513e-01   +4.994174389902089e-01   +5.863574798649863e-02   +7.435360375737445e-01   -8.853421139020948e-02; +3.927532732258890e-01   -1.385542494287071e-01   +4.357443934958726e-01   -7.769188154371852e-02   +4.336411379423300e-01   +8.072523013027241e-02   -6.439022307059542e-03   +3.679505716105421e-01   +7.255538978047734e-01; +5.304137249951659e-01   -8.703428525723190e-01   -3.960299235747855e-01   +6.427785997907961e-01   -6.425543314208153e-01   +9.723816970286430e-01   +6.091552336373991e-01   +9.105799569803977e-01   -8.109523020749420e-01; +4.555676811714843e-01   -5.286470780742247e-01   -1.221342221347329e-01   -1.025023703941407e-01   -2.099502911979132e-01   +1.052855771560919e-01   -4.094821834044058e-01   +1.720059556217287e-01   -8.410025303035019e-01; +9.995731706653408e-01   -5.377152524835925e-01   -9.750200685349627e-01   -2.958362386977319e-01   -9.964486254569660e-01   +4.589375464828661e-01   +9.356501695699191e-01   -4.040752285310384e-01   +5.641099999667418e-01; -5.501163261709833e-01   +1.893665150086728e-02   +1.889873441589416e-02   +1.646201422817505e-01   +5.554883902544748e-01   -8.837984697433706e-01   +3.562747151810335e-01   +4.837895094671713e-01   +7.086834694380171e-01; +3.680055439687151e-01   +7.990877801815354e-01   +4.904626467624719e-01   +7.775432756256064e-01   +5.388643469502061e-01   +6.244975400140393e-02   +3.341829125490543e-02   -6.400297719728362e-01   +1.690936654160131e-01; -6.530212952193764e-03   -1.155293613321564e-01   -2.486030454353456e-01   -8.480561075952454e-01   -1.089282573011902e-02   +9.409444644504558e-02   +8.234341040628084e-01   -3.636460209533960e-01   -8.790165557355388e-02];
L2_L5_iAMPA_netcon = [+2.922737478784271e-01   +7.643451633172579e-01   +4.092253251226820e-01   -1.748497403756073e-01   -7.911943423950346e-01   +5.672124992353006e-01   -1.280976402675002e-01   +2.325246975101466e-01   +1.208647293420553e-01; -1.731192582487160e-01   -1.227039899395245e-01   -1.000000000000000e+00   -9.171051632170247e-01   +8.283836326970812e-01   -7.928960460712414e-01   +8.387807456778489e-01   +5.916517485625262e-01   +4.600459841326450e-01; -2.538792055163933e-01   -3.565210518519046e-01   +7.001975502390091e-01   +5.930933238389735e-01   -9.119008356215587e-01   -9.863333655942726e-01   -4.044033781849055e-01   -3.819950665592152e-01   -5.437514993770549e-01; +8.999297484199231e-01   -8.165597988721512e-01   -3.192882304497341e-01   +5.292926207638149e-01   +8.396561347460560e-01   -7.454881175222950e-01   -6.037489702885921e-01   +4.371582939836359e-01   +6.699752216660334e-01; +6.796079258811951e-01   -2.373709229235245e-01   +9.666120269021858e-01   -5.976933226374421e-01   -1.314733924071962e-01   +5.365335036833101e-01   +1.231076448116648e-01   +8.628389232097540e-01   +1.929399426259392e-02; -2.003717386274189e-02   -1.658133466611694e-01   +7.539120273087391e-01   -7.616796830798935e-01   -3.308501260752616e-02   -2.954635904199381e-02   +6.054420380943160e-01   +2.585142046874320e-01   +7.785426832283801e-01];
L5_L2_iGABA_netcon = [+5.601033384112789e-01   +9.219595223668819e-01   +1.534956181401913e-01   -5.163510141172772e-01   +4.931235090981936e-01   -7.114747462382819e-01; -1.550401488420240e-01   +4.386563950548775e-01   +5.317880117724526e-01   -7.387276062892718e-01   -8.156649257590528e-01   -6.409370679132622e-01; +5.684576980718620e-01   -7.054191592087716e-01   +6.784300191522813e-01   -9.389125667811742e-01   -6.753425600099207e-01   -8.633509078624173e-01; -7.894039892387779e-01   +7.177736294175741e-01   +6.215040612577142e-01   -6.760436505666286e-01   -5.799494889952054e-01   +1.354631859435730e-02; +2.953580080048623e-01   +3.055810704183011e-01   -2.892439799400237e-03   -3.369606054299217e-02   -3.249888741595541e-01   -4.529058629208096e-01; -2.358613078486734e-01   -3.544736346045221e-01   +5.408189108777521e-01   +4.001206075175830e-01   +5.308406042270127e-01   -4.541425295731301e-01; +5.913500029950883e-01   -6.663666857735696e-02   +1.941493524166032e-02   +5.430658070371936e-01   -1.000000000000000e+00   -8.588439680038636e-01; +3.979317822988041e-01   +3.920342501480097e-01   -7.518890064293987e-01   +4.695227887494242e-01   -7.449256525015437e-01   +2.702618754818611e-01; -4.612143017997432e-01   +8.518410311032701e-02   +3.156466134936184e-01   +4.577268197214801e-01   -8.979968207833691e-01   -2.430486768373453e-01];
L3_L2_iAMPA_netcon = [+7.505471594441550e-01   -5.273248650644582e-01   -9.154985192084101e-01   +5.241435083043189e-01   +5.621091689484106e-01   -4.214901643579431e-01; -4.248488660206810e-01   -9.685977420982461e-01   -5.748958507701067e-01   -2.910000529110376e-01   +3.113041747106503e-01   +8.000748191053233e-01; +8.206781058292201e-01   +2.208699532622188e-01   +5.889084683764556e-02   -1.856405659180948e-01   -4.935929886682925e-01   -3.224871022992259e-01; -5.476766757369428e-01   +4.691735313148557e-01   -6.053292594037794e-02   +5.411558472187310e-01   -3.888612521125998e-01   -3.101462977947032e-01; +4.756586390872618e-01   -1.000000000000000e+00   +2.383101526021160e-01   +9.051122367815819e-01   -9.593280961033218e-01   -4.841878876179336e-01; -7.235758422014113e-02   +3.939350272482201e-01   -6.462818938200611e-01   +2.928125628676965e-01   +7.900828591311087e-01   +3.367591705911729e-02; -4.374269845051340e-01   +8.258612089754207e-01   -6.192093668977924e-01   +6.665992481212457e-01   -8.224570364906790e-02   -6.785885231335756e-01; +2.392900479501169e-01   -5.723795290774449e-01   -3.937563758465253e-01   +3.309561350442898e-01   -7.562480668311705e-01   -4.621707829035414e-01; -9.222563114680831e-01   -4.640308100457105e-01   -4.646473133743732e-02   +9.158387899123992e-02   +4.603005445071812e-01   -4.358706184175234e-01];
L2_L3_iGABA_netcon = [-5.747632344522543e-01   +2.507069806798217e-01   +4.281597027423003e-01   -8.532266615578556e-02   +4.658257681222699e-01   -3.274613363150741e-01   +6.043984734222226e-02   +1.381019228496091e-01   -6.050746968179498e-01; -1.005534250635088e-01   -6.316852280646355e-02   -4.030080936646958e-01   +6.921744596547978e-01   -2.328879593083676e-01   -4.531633137734754e-01   -2.181425425165860e-02   +3.959906985877982e-01   +3.690625585530846e-01; +4.044029172955207e-01   -1.119475568117455e-01   +5.538223792026385e-01   +9.210820391993954e-02   -8.236395760596267e-01   +2.481916534334468e-01   -4.172912912122337e-01   -4.755027980828058e-01   -8.458909980371411e-01; +8.581884081441538e-02   +1.739299145491558e-01   -2.603506090799527e-01   -9.153567748342459e-01   +3.109772032229908e-01   -2.896934320786597e-01   +9.212457260070586e-01   -5.330325634784937e-01   +1.687512470471580e-01; +8.387766263917663e-01   -2.044290211464446e-01   +1.000000000000000e+00   -3.550016612003312e-01   +1.175196835541370e-01   +2.336946036275594e-01   +5.631475776945487e-03   -5.281853626426335e-01   +1.505928315094812e-01; +6.337303931392883e-02   +3.574884793495130e-01   +4.172353208382184e-01   -6.473337694048805e-01   +9.493208255442313e-01   +3.979218087958126e-01   -6.134815568972771e-01   -6.238660519509260e-01   +5.998569459302214e-02];
L1_L4_iGABA_netcon = [-1.012066387280238e-01   -4.927529515900218e-02   +7.586925941026633e-01   +2.808608258730688e-02   +9.961259562858508e-01   -1.378250046730833e-01   +4.880998413102463e-01   -3.229149434224336e-01   -2.867390252252265e-01; +9.260804037853330e-01   -2.972866726777675e-01   -7.720135496833207e-01   -7.259264938280078e-01   +3.924324869030407e-01   +3.238696430060594e-01   -9.250087072267918e-01   +1.694282818300447e-01   -7.239140656953362e-01; -2.672149144416097e-01   -3.717454043815208e-02   +6.699296305130192e-01   +4.292933484188426e-01   -2.556856404172060e-01   +4.388285253966742e-01   +4.252703083538065e-01   -8.348865140632856e-01   -7.137317190810650e-01; -8.570397816517703e-01   -3.412767881230666e-01   -6.637019017724493e-01   +3.085465196016345e-01   +9.434803934224248e-01   +4.464030266485407e-01   +6.680861835622303e-01   +8.021357747261445e-01   +3.792027840463826e-01; -6.227464988516653e-01   -6.549340205862412e-01   -7.782753422960140e-01   -4.792766552291179e-01   -5.575796804886551e-01   +4.460335277035881e-01   -6.283519646315601e-02   +9.325339146675596e-01   +2.520030693443516e-01; +3.104838097088761e-01   -2.472166059367780e-01   -1.308995499614201e-01   +7.902768282488374e-01   -5.083428982108441e-01   -2.265868577331560e-01   +7.374819998169135e-01   +2.396032948685390e-01   -2.538298801632812e-01; -7.649449622701511e-02   +5.450288795248446e-01   -6.241592401063769e-01   -8.769229276919005e-01   -1.578659642564147e-02   +6.989219127612463e-01   -6.229548456845716e-01   +1.520204028009536e-01   -3.656082242187903e-01; +7.918212224090134e-01   -4.204997405279241e-02   -7.268482135859590e-01   -6.668465318742566e-01   +5.559106072643855e-01   +1.786347348286350e-01   +5.512801695173953e-01   -1.000000000000000e+00   +2.967534340467986e-01; +6.757807222373143e-02   +4.401589301925156e-01   +5.703792876295244e-01   +5.096311015138439e-01   -2.566261867491733e-01   -6.956453033875870e-01   -4.798749291526163e-01   +8.171201161143066e-01   +3.553316784238068e-01; -8.320520484040350e-01   +5.074062039872607e-01   -3.655716092932983e-01   -2.791888831711850e-01   +7.109252641004999e-01   +3.020444292944655e-01   -1.246851660650010e-01   +3.063489633463489e-01   -2.965104931809277e-01; -6.139742488404812e-01   -5.819091259895730e-01   -5.755791894007346e-01   +3.938664365233646e-01   +8.355055698661646e-01   -3.044524148811418e-01   -6.431858342465059e-02   -6.452741096045277e-01   -2.542142431241302e-01; -2.298529706161838e-01   +4.719914917510984e-01   +6.530230623825642e-01   +8.121646993104405e-02   -4.398808103097596e-01   +1.973350279797087e-01   -2.639888951720289e-01   -2.804274269921725e-01   +2.867730286229094e-01];
L4_L1_iAMPA_netcon = [+7.501470233446758e-02   +2.332183917747931e-01   -8.407784739884975e-01   +1.474833413135681e-01   +5.782959059746530e-02   +6.654179874225362e-01   +7.207877391914025e-01   +5.050297571441472e-01   +5.151351266912554e-01   +2.578859500417384e-01   +8.482888601029994e-01   -9.777038217124774e-01; -9.509141246008349e-01   +4.357245323506525e-01   +7.859534912174555e-01   -1.642484907455588e-01   +4.081813670197040e-01   -2.719196989804955e-01   +7.993916955885091e-01   -5.892018894946567e-02   -3.168854304656735e-01   +7.585545625586361e-01   -4.756356137833908e-01   +1.488223897749597e-02; -3.720660600354069e-01   +5.823206491307052e-01   +4.582239219981135e-01   -8.877314409087158e-01   +4.361795510039013e-01   -8.453634461466406e-02   +2.273732664398816e-01   +5.606239393437251e-01   -7.060407521330248e-01   +5.118718684056502e-01   +2.794061302740686e-01   -6.994700724830877e-02; +1.023479397434231e-01   +4.909986746157986e-01   -6.579508399641734e-02   +6.483753643445151e-01   -7.190583069578863e-01   -4.910157518378474e-01   +3.108568508110675e-01   -2.319194403420510e-01   +1.435547288478003e-01   -3.859243129537517e-01   -8.816406179424171e-01   -7.865001229695260e-01; +4.379076256447364e-02   +5.794136629206385e-01   -8.137579631185267e-01   -8.008059278873797e-02   +3.138178708433324e-02   +1.712264603050814e-02   +4.522225217749615e-02   +3.375582127648158e-02   +2.469419783912450e-01   -2.324590547878421e-01   -2.143417736395977e-01   +3.389792410072047e-01; +4.285669828181782e-01   -5.610165165449724e-01   +1.719124872102004e-02   -6.083013446630434e-01   +5.803495119952871e-01   -6.274613167803464e-01   -1.629815013935973e-01   -7.095837752295122e-01   -3.281714093492474e-01   -4.293037977802664e-01   +1.444874495832026e-01   -4.575042537208889e-01; +7.817776513225726e-01   +5.416099309065195e-01   +4.105451401507157e-01   -3.730032323580585e-01   +5.077906405289832e-01   -2.459972796108303e-01   -6.074719114917758e-01   -1.368592457663121e-01   +3.799783248892069e-01   +2.642251224753953e-01   +4.895935032353786e-01   +1.258011538778134e-01; +9.110320338432379e-01   -8.515850354626143e-01   +6.100849310815195e-01   -4.625865153905937e-01   +1.998082205540436e-01   -8.176013171189276e-01   -3.406776252865983e-01   -7.989025635416472e-01   +6.341938803010845e-01   +7.417120389101924e-02   +7.336110154275973e-01   -9.256576084669601e-01; +1.000000000000000e+00   +2.490506910914430e-01   -8.895472580678306e-01   +4.264406094076413e-01   -6.987796541657904e-01   +1.868895480279494e-01   -6.700628047494501e-01   -2.675260975773696e-01   -6.917646945880278e-01   -6.071349313675872e-01   -4.306653440429106e-01   -3.893301299529205e-01];
L1_L3_iAMPA_netcon = [-5.031107678371469e-01   -7.401276246404548e-01   +4.320200523227423e-01   +3.268243024341086e-01   -7.284280868410469e-01   -6.117414988415351e-01   +7.213682532756683e-01   +4.158789819132985e-02   -4.246448719821376e-01; -7.368278429924108e-01   -1.388991981449688e-01   -1.567522005742192e-01   -7.571061030001023e-01   +3.784179221213930e-01   +8.418712698617912e-01   +5.448827684704231e-01   +5.466892711749985e-01   -1.227549207488646e-01; -4.444574865441117e-01   +6.257514427296970e-01   +5.561011765576880e-01   -1.257170872572794e-01   +7.357795011133107e-01   -8.002320562056435e-01   -4.766394175463377e-01   +1.827009943080561e-01   +8.995958832447464e-01; -4.379774181955962e-01   +8.100138007544337e-01   -2.238254128443524e-01   -3.155661002982014e-03   +5.392234287734742e-01   +8.137537217046535e-02   -8.060240990689110e-01   +1.000000000000000e+00   +2.633516610305066e-01; -3.164910581011101e-01   -1.694705971781951e-02   +4.975902219041795e-01   -3.583513760679339e-01   -2.348532357730627e-01   +5.525935380713716e-01   +3.676097013350255e-01   +3.341602668574272e-02   -9.451789104346934e-03; +4.695272078826937e-01   -4.551802325608653e-01   -1.568078855828904e-01   -5.999736233173351e-01   +3.827577047849913e-01   +7.219543941706347e-01   -7.693013163860026e-01   -8.928939697698058e-01   +8.157387408358922e-01];
L3_L1_iGABA_netcon = [-7.938307961129404e-01   -8.074328721972596e-01   -3.794010194526760e-02   +7.774444902085231e-01   -1.712887685988810e-01   +3.081406507520491e-01; -1.249436913614327e-01   -3.614345331863053e-01   -2.006058628790832e-01   -1.190111794291137e-01   +7.967515449753788e-02   +6.211322271172959e-01; -5.579349123438303e-01   -2.622895692471631e-01   +2.213846291692821e-02   -5.450559688245546e-01   -5.943631196142258e-01   +5.664364548985210e-01; -3.499271521077085e-01   -1.443201968877901e-01   +5.972607046111670e-01   +4.592377904116816e-01   +2.468264054022700e-01   -1.750068423393132e-01; -7.800409384418843e-01   +4.723944735428350e-01   -9.129845331003199e-01   -8.822853584448436e-01   -1.770463491151686e-01   +1.742092106767066e-02; -1.936269016501659e-01   -4.390936502936126e-01   -4.913324225007283e-01   -1.192312187023510e-01   +1.000000000000000e+00   -4.319169013111098e-01; +8.448645420016661e-01   +1.758907577310607e-01   -8.126962510246090e-01   -7.581790843350132e-02   -1.866569504485862e-01   +3.043007392842506e-01; -9.378423166517179e-01   +1.873171494708110e-01   +5.743634589544291e-01   -4.931477316417050e-01   -7.090553750115751e-01   -8.287976222414711e-01; +4.614049279312263e-01   +6.523322600310884e-01   -3.324239112553389e-01   -8.474013247107764e-02   +8.630985808967762e-01   +3.255448054213305e-01];
L5_Input1_iAMPA_netcon = [-2.357853893990228e-01   -5.961200803581421e-01   -1.547000029655362e-01   -7.260269900009474e-01   +1.000000000000000e+00   -2.887813499648266e-01];
L6_Input2_iAMPA_netcon = [+1.000000000000000e+00   -2.202846624630042e-01   -4.920909688908721e-01   +9.548609463901844e-01   +2.501266671864580e-01   +5.553841763103854e-01];
L5_L6_iAMPA_netcon = [+2.036864291716691e-01   -6.515187835861427e-01   -3.537693026299495e-01   +5.853256477193022e-01   -4.674321441047515e-01   -4.529351401791896e-01; +1.650366966187699e-01   -7.208761372845914e-01   -5.388370505052931e-01   +6.022027232481736e-01   +1.000000000000000e+00   +9.530498777592654e-02; +1.034824677102393e-01   -5.158299973732343e-01   +7.657352398333916e-01   -7.513064799733549e-01   +5.502807984598354e-01   +2.516651689833475e-01; +3.332871410811648e-01   -6.432169023283393e-01   +6.473346332720319e-01   -5.332794605889003e-01   -1.627270090462919e-01   -9.422202168465881e-01; -2.241402724191667e-01   +1.089141234816257e-01   -6.436667385929575e-01   +3.937276906985988e-01   +7.871675986424518e-01   -7.430938808013106e-01; +6.455310960110529e-01   -4.740052757878070e-01   +7.026324880929853e-01   -8.153318049784507e-01   -5.849895347147949e-01   +7.362751506354112e-02];
L4_L5_iGABA_netcon = [+8.839562960535510e-01   -4.521799204782549e-01   +4.180429365932518e-01   +3.379374415937124e-01   -2.342972903817824e-01   -9.316967008379532e-01   +8.466665120699207e-01   +8.246717723786355e-01   -8.986682902810951e-01   +8.118966337052681e-01   -6.411828391652632e-01   -9.636499465464609e-01; +1.979399606672319e-01   -1.867553747002276e-01   +2.917956685823382e-01   -3.295612744265792e-01   +9.013232676875316e-02   +6.977340167806722e-01   -2.893510630856416e-01   +2.994039066680920e-02   -7.958966030906859e-01   +9.054905792132563e-01   -4.141611952508836e-02   -4.721701599394343e-01; +9.986577917915842e-01   +9.571927067829037e-01   -5.867786881443070e-01   +7.742283245386470e-01   -7.820212045336022e-01   +9.565661282249520e-01   -8.398361891374557e-01   -9.346912318168292e-01   +1.000000000000000e+00   -1.600835197537048e-01   +2.613362888844975e-01   +5.517142548630732e-01; +6.503450160717951e-01   +2.110776328433507e-01   +1.471922554023528e-01   +8.884696317025520e-01   -4.484881157452759e-01   +1.402793369996104e-01   +3.765719493213910e-01   -2.699848902889479e-01   +6.801170764723895e-02   +7.889711644579849e-01   +8.211305415260841e-01   -5.677843514039770e-01; -3.188546960456932e-01   -9.107809941352001e-01   -7.875494398047059e-01   -7.797792731918115e-01   +5.888820997380596e-01   -5.326863125510571e-04   -5.196573336307381e-01   +9.497075294716002e-01   -7.663308209046641e-01   +2.613383396569472e-01   +6.274297711123200e-01   +3.799303700632143e-01; -2.658617864260329e-01   +8.708269397239783e-01   +9.177719838821736e-01   -7.176745923743932e-01   -5.173654218023765e-01   +4.337068179537076e-01   +5.757117733756610e-01   -2.954317880417239e-01   +2.354535272754888e-01   +5.412965120797846e-01   +2.269160076359154e-01   +9.115094628563136e-02];
L6_L4_iAMPA_netcon = [+6.700403300680027e-02   -2.164695893061431e-01   +3.893423913853409e-01   -8.895062948063442e-01   -1.698780756139276e-01   -2.476188208097547e-01; -7.154283916492578e-01   +9.842653442779730e-01   -7.170273091250172e-01   -3.590362174547977e-01   +1.378803716127279e-01   +7.030602947828987e-01; +1.321158041468567e-02   +6.100857041323530e-01   -5.262287355510341e-01   -2.311096261540434e-01   +7.934174138289944e-01   +6.164843456856087e-01; +5.040869004830496e-02   -4.226575820084382e-01   -7.305631529955610e-01   -4.887777616579635e-01   +5.514696140664221e-01   +7.451689816889974e-01; +4.558459096110370e-01   -2.421023871514087e-02   +9.056521352428263e-01   -3.739818715341072e-01   +9.633547746193298e-01   +3.596448632920589e-01; -1.000000000000000e+00   -2.308263189122070e-01   -4.768107390821402e-01   +2.582851777658002e-01   -7.972542575440036e-01   +5.504506712422020e-01; -8.643454583150669e-01   -4.671241985103392e-01   -3.745908180433899e-01   -3.753867534503959e-01   +4.304759777637097e-01   +5.100303810120671e-01; -2.897475275361561e-01   -6.604299294380211e-01   -7.207191708751804e-01   -7.783768254642602e-01   -1.429051275620220e-01   +2.807978133644545e-01; +1.037641780796339e-01   -7.863456696700749e-02   -8.172054356817076e-01   +7.849296942829223e-02   -5.733609135267952e-01   +6.411930011545629e-01; +5.614793433632800e-01   +4.971536513730823e-01   -8.737439459711149e-01   -7.832545200079392e-01   +4.991920229559835e-01   +3.287507628751445e-01; +9.190298630918297e-01   +4.422350654021943e-01   +5.818337539923644e-01   +7.263436586577839e-01   -2.021429264430241e-01   -3.224691595936678e-01; +3.593206210660773e-01   -4.504817500705932e-01   +3.863642726870254e-02   -6.546169593175381e-02   +8.248525335006780e-01   -6.117107753176992e-01];
L5_L4_iAMPA_netcon = [-8.967976939782828e-01   +9.119361733137914e-01   +7.483212686594097e-01   +8.930169576498332e-01   +5.463622473517185e-01   -3.837650660243487e-01; -1.649091924088531e-01   -6.580332020451762e-01   -2.197603258636597e-01   +4.944741640764075e-02   +2.220584752468820e-01   +4.462434866917000e-01; +8.249958212652228e-01   +1.239275879348364e-01   +8.713192997421498e-01   -5.649828050100677e-01   -5.638744174260303e-01   +8.828997235565640e-01; -8.036858362675653e-01   -6.271511201214123e-01   +7.779573488813605e-01   +1.977306871336439e-01   +4.620547006198385e-01   +2.884119612524340e-01; -2.848819425743326e-02   +8.352966592692371e-01   -6.186568477191996e-01   +2.367607456650807e-02   +7.048034942806231e-01   +5.466000883940775e-01; +5.440930057134172e-01   +1.830109259018962e-01   +1.581091483178398e-01   -7.700372035206287e-01   -8.200151325179346e-01   -2.861615086822002e-01; +5.467517015164085e-02   +4.263695621560440e-01   -3.544973783014098e-01   -1.931074103739480e-01   -1.000000000000000e+00   -3.393483863901343e-02; -6.497463507192294e-01   +4.127837531165526e-01   -1.335953071083297e-01   +1.496797963601953e-01   +2.268065479352555e-01   -1.302572497483432e-01; -8.630752239437243e-01   +7.803126597579546e-01   +8.463022722386518e-01   -6.298661211054986e-01   -6.529808927972272e-01   -3.935900084997986e-02; +2.992676361088915e-01   -4.412105895761146e-01   -9.700887171085724e-01   -4.191214508693430e-02   +1.222695423495276e-01   -3.587853221681996e-01; +2.851016563695331e-01   +7.212384262994711e-01   -7.668888596095332e-01   +1.326021984283970e-01   +8.456962689175747e-01   -6.684209303301498e-01; +7.306041076630799e-01   -9.416561781431868e-01   -9.134742848489144e-01   -5.039403957280101e-01   -5.249702739805256e-01   +8.736326924219779e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
