function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.873661738939543e-01   +7.575166232747925e-02   +3.256733100748013e-02   +1.944448285660149e-01   +2.342112833505788e-01   +1.649471562931164e-01   +4.346048118046700e-02   +1.524148075716154e-01   +6.861485711995499e-02; +9.637849249897297e-02   +4.263395838321785e-02   +1.699709334367471e-01   +8.227918554016536e-02   +1.945119650211667e-01   +7.904503362146387e-02   -1.634658241704936e-02   +1.124600528504791e-01   +6.657749879538846e-02; +5.604029315901854e-02   +1.128147476100929e-01   +1.448450041394994e-01   +2.075225783364870e-01   -2.543941556061173e-02   +1.123935091694899e-01   +1.775004787192138e-01   +1.568380860253388e-01   +9.680195265684258e-02; +7.872432848164385e-02   +2.456123925797348e-02   +5.231452777567530e-02   +1.586828490888883e-01   +1.016856393920092e-01   +1.848940747800720e-01   +1.133212615805748e-01   +1.327200649052361e-01   +2.230057856719373e-01; +1.889999699388671e-01   +2.823995973672067e-01   +7.538390498491511e-02   +1.757553808394739e-01   +1.603833707410472e-01   +1.816370927254661e-01   +1.292215657709876e-01   +2.800982382678781e-01   -1.887717751560142e-02; +2.181822250333827e-01   +2.031851650911353e-01   +1.614771010089109e-01   +1.000347611525636e-01   +2.339461523118533e-01   +7.610731249760219e-02   +2.511433955489594e-01   +2.986874424368502e-02   +1.444609281818355e-01; +2.107706660967296e-02   +2.808666869525293e-01   +2.731929847286781e-01   +1.846373516973285e-01   +2.388329112577890e-01   +7.876954471008063e-02   +1.754359303164849e-01   +7.501435836601389e-02   +1.451287023142793e-01; +8.428518370867331e-02   +2.370101098774648e-01   +3.390901243564381e-02   +5.329720208853217e-02   +2.468156963830701e-01   +2.715701886139881e-01   +1.597162249830724e-01   -3.317738401676795e-02   +1.346986682240022e-01; +1.985441043919584e-01   +8.229587383448901e-02   +1.298143530238623e-01   +2.097726262674997e-01   +1.734038567000940e-01   +1.965847850872178e-01   +1.356074247121807e-01   +3.574520455038455e-02   +2.172400115289388e-01];
L1_L2_iAMPA_netcon = [+3.864361814204702e-02   +1.352834634558591e-01   -5.907178448349897e-02   +2.112875297295711e-01   -4.951405534501285e-02   +2.301401427670172e-01   +7.060179178544550e-02   +3.198832606768576e-02   +2.485905266204374e-01; +1.112700107796247e-01   +1.991879208726171e-01   +2.376210961614902e-01   -3.255673660347447e-02   +2.248854869917781e-02   +6.701406914845601e-02   +2.575540365118036e-01   +7.760702717176307e-02   +1.076504791998244e-01; +5.388193495096490e-02   +8.993868670154748e-02   +3.235357423025421e-02   +1.188758098381943e-01   +1.039993027921009e-01   +1.582412468322655e-01   +1.580189536458186e-02   +1.611772623433848e-01   +8.759317366857849e-02; +2.299021788295248e-01   +2.396624799523309e-01   +2.467123109510185e-01   +2.259962685321453e-01   +1.442318478034575e-01   +1.517376858264317e-01   +2.131387626954280e-01   +1.669144655855050e-01   +1.428406186850145e-01; +1.866627664991956e-01   +3.034082867704891e-03   +3.769034471752022e-02   +1.334386491104262e-01   +1.976577420123772e-02   +2.050949015416896e-01   +1.584090233964738e-01   +3.327423089509339e-02   +1.347631339486673e-01; +1.440060479790565e-01   +1.769500101368945e-01   +2.707809785254190e-01   +2.464568264174855e-01   +2.295101291446902e-02   +1.229679519512538e-01   +9.107590909308932e-02   +1.248052580346571e-01   +1.189491851178983e-01; +2.613016173549421e-01   +2.628118744475705e-02   -3.190368703335650e-02   +1.825750335888656e-01   +1.289353620128733e-01   +2.872817385496279e-01   -6.855091139133851e-03   +1.022066950664578e-01   +1.952667804420570e-03; +1.553931903231253e-01   +1.588940777514551e-01   +5.166422192434601e-02   +2.044208152036083e-01   +7.524146241074132e-02   +1.500974322050354e-01   +2.402112445303773e-01   +4.704914245804252e-02   -5.318795361847903e-03; -1.245922806547400e-02   +4.577194011434876e-02   +1.513248181612662e-01   +2.043237544296673e-01   +2.094595536044993e-01   +5.511099347616333e-02   +2.425379323753686e-01   +2.014376598635583e-01   +2.074649248930207e-01];
L2_L5_iAMPA_netcon = [+2.315228391200832e-01   +1.370071015629654e-01   +1.310919295055643e-01   +2.285810414807782e-01   +2.955333302966342e-01   +2.550363280228399e-01   +2.530533294311779e-01   +1.818914326879744e-01   +1.058838602557549e-01; +1.323722762369019e-01   +9.990774219443763e-02   +2.004353622258044e-01   +1.209464619465092e-01   +5.351084311708830e-02   +2.121047329173827e-02   +1.831031786798640e-02   +9.044586737218373e-02   +1.419594427353038e-01; +8.335095194337999e-02   +2.119563979059926e-01   +9.901025120732074e-02   +2.263912545980463e-02   +2.544614464059551e-01   -1.266793862075374e-02   +1.295767372490788e-01   +2.313347845462698e-01   +9.980856771160745e-02; +1.188478980999695e-01   +1.903235513941189e-01   +6.065737263771984e-02   +2.229035314386164e-01   +2.219610511345551e-01   +2.519673534415224e-01   +2.824164147438794e-01   +2.618143667072867e-01   +2.745328339336551e-01; +1.677064666522503e-01   +1.704686802871221e-01   -1.076447767481400e-02   +2.060610487029655e-01   +2.305818190091011e-01   +1.379926046885984e-01   +1.126084735495273e-02   +1.106955936070511e-01   +2.486822873742792e-01; +2.339951556893326e-01   +1.718835961952719e-01   +1.971133038613098e-01   +9.213250937891011e-02   +1.184409899556510e-01   +1.952450232060466e-01   +1.238665642027591e-01   +1.047592092253385e-01   +2.999300419258286e-01];
L5_L2_iGABA_netcon = [+6.301460155293985e-02   +1.797067672237699e-01   +7.981742113929437e-02   +2.313372908796990e-01   +2.129996552434111e-02   +2.597857185386271e-02; +2.809992513957446e-01   -9.515345887764490e-03   +7.923549875709565e-02   +5.556879762198666e-02   +2.610305789500615e-01   +1.895808574978421e-01; +2.471606766505530e-02   +2.260803687398830e-01   +2.120609664006111e-01   +4.429075009046796e-02   +1.112210403466029e-01   +1.391893782374931e-01; +7.467939956234874e-02   +1.006822427226846e-01   +3.606706272669617e-02   +6.444041712576468e-02   +1.197276985268463e-01   +1.647939831667564e-01; +9.639155961672295e-02   -1.469951993125143e-02   +2.855535141416466e-01   +2.183519560833011e-01   +2.393619162835925e-01   +1.834552551098337e-01; +1.805531324930846e-01   +1.757365669614424e-01   +2.152565544506719e-01   +2.092218535378183e-01   +6.680922695653826e-02   +7.853041710617929e-02; +1.462809210996986e-01   +2.043028821701235e-01   +3.760777013353522e-02   +1.398196442700619e-02   +1.880206120377479e-01   +2.041407818562726e-01; +9.793878502083521e-02   +2.780402280616098e-01   +1.171509264580122e-01   +2.776671601713257e-02   +1.927135115515098e-01   +1.910998771165779e-01; +1.561057434182612e-01   +4.824259738235689e-02   +5.116182568002463e-02   +2.328736033038478e-01   +3.098160325589499e-01   +1.139354486953696e-01];
L3_L2_iAMPA_netcon = [+9.559586298813524e-02   +1.917392166044000e-01   +2.670502492302605e-02   +1.384373472102339e-01   +2.489635095116467e-01   +2.515667721924298e-01; +4.232479921281519e-02   +9.852396424301785e-02   +2.353175419127799e-01   +9.007949219984727e-02   -1.960111113529586e-02   +7.730347786604802e-03; +2.563035000695510e-01   +3.452623681599902e-02   +7.663692285962788e-02   +2.650808085770023e-01   +1.383015691657580e-01   -2.889654511648238e-02; +4.386732911677504e-02   +1.572774587212240e-01   -6.243568964060868e-02   +1.571039562869081e-01   -1.269505113146843e-03   +1.204029178290643e-01; +8.933935697025827e-02   +1.700560348156291e-02   -1.383926176923378e-02   +2.386546289730537e-01   +1.146131838354022e-01   +2.638874655354791e-01; +1.415410454622040e-02   +1.972201750692537e-01   +7.232366068828663e-02   +2.720365445532117e-01   +2.173662907041105e-01   +2.082907596136118e-01; +9.031992276264490e-02   -3.945026661950415e-03   +1.999429982989991e-01   +1.669887820044461e-01   +9.097548189630965e-02   +7.538388801484966e-02; -2.538475493135889e-02   +3.469576628168237e-02   +2.494625133792425e-01   +7.536782232683444e-02   +2.529667790719502e-01   +7.338964129151093e-02; +2.821665214349289e-01   +2.640395036469056e-01   +1.031193846971271e-01   -1.946338088374739e-02   +1.684613851474970e-01   +1.382431988023815e-01];
L2_L3_iGABA_netcon = [+1.133383965228880e-01   +5.824208018463076e-03   +1.783358084480536e-01   +2.272443040534567e-01   +1.717468259710557e-01   +1.083617221950689e-01   +1.927431945556636e-01   +4.584059569504707e-02   -2.404568031587950e-03; +1.959834164060135e-01   +2.597001468037093e-01   +5.991865363812099e-02   +8.217358596221504e-03   +1.354006767761044e-01   +7.244032703714048e-02   -4.189986922022627e-02   +1.430783490873064e-01   +1.081481429199140e-01; +2.252575867390742e-02   +1.152516040602838e-01   +1.896631442652670e-01   +2.048060345525222e-01   +2.729295891848526e-01   +1.422387617149933e-01   +1.095597838274140e-01   +9.429421605538976e-02   +1.790969518632199e-01; +5.657159800100952e-02   +8.732473311790107e-02   +1.058095094945653e-01   +7.697763873790547e-02   +2.059421952230983e-01   +2.126418919564075e-01   -8.619635949355046e-03   +1.144987828562819e-01   +2.822580425320079e-01; -4.937073956205078e-02   +1.960857348733244e-01   +2.243848898460031e-01   +9.656467634150086e-02   +8.273285011441572e-02   +6.224095776876166e-03   +2.442586616061072e-01   -3.769976959031256e-02   +8.968704193503563e-02; +1.174060576289196e-01   +1.646756482479750e-01   +1.442615796372339e-02   +2.003549858939486e-01   -1.280315784688025e-02   +1.802853264403243e-01   +5.145584055367551e-02   +1.845262285487334e-01   +1.409079982260950e-01];
L1_L4_iGABA_netcon = [+6.723386179015436e-02   +1.753916820719282e-01   +1.413723796418555e-01   +1.853402204736041e-01   +6.012409719567600e-02   +2.264855882841640e-01   -1.223762232091740e-02   +7.787644830363563e-02   +3.084800215080755e-01; +2.117584985321382e-01   +9.731868009870158e-02   -2.248078342753774e-02   +1.183531880042478e-01   +2.132386722573822e-02   +1.270025926178264e-01   +7.690408245949115e-02   +1.262514864054178e-01   +2.643855050489028e-01; +1.128657535248906e-02   +8.099941652252297e-02   +2.307454097639204e-01   +1.643362513619758e-01   +8.076565452505893e-02   +1.035030211645797e-01   +1.173474770970801e-01   +1.127064054492512e-01   +2.083286559633315e-01; +1.998967772019082e-01   +2.257208527345488e-01   +1.662228222777311e-02   +7.280894218343423e-02   +2.022298646519864e-01   +3.040192947372464e-01   +2.690491097011233e-01   +6.653495833363343e-02   +2.439765617588903e-02; +1.955109551923794e-01   -4.886319346269966e-02   +1.014217724572495e-02   -1.428610897582459e-02   +2.657781394174999e-01   +2.217950223512444e-02   +9.256489640018892e-03   +9.790224261370675e-02   +2.270634232339740e-01; +1.137197845934016e-01   +1.776714507227469e-01   +1.883268110332185e-01   +4.846053609223909e-02   +6.500592410182712e-02   +9.777712217915932e-02   +1.711456457942927e-01   +2.550681893555073e-02   -2.508371915380200e-02; -1.157876935663854e-02   +1.995344363408420e-01   +1.957841789063034e-01   +2.156054610831844e-01   +2.368038871960317e-02   +8.870425915603579e-02   -7.432734057720221e-03   +9.092631213519975e-04   +2.104712391784046e-01; +2.268072953452961e-01   +5.795077688164643e-02   +1.525470792534161e-01   +1.389736928026243e-01   +9.038787139262801e-02   +1.126162599168199e-01   +4.625281295601105e-02   +1.329963825218456e-01   +9.650341550830155e-02; +1.162387941929302e-01   +8.531655342555253e-02   +9.130877432587560e-02   +1.009352100230726e-01   +8.413557483442007e-02   +1.388758771300780e-01   +2.275853070552152e-02   +1.839377691096266e-01   +2.206764275780548e-01; +5.336084987502153e-02   +3.248936405202187e-02   +1.651557868551489e-01   +1.221643362976500e-01   +2.088091315189642e-01   +5.649244580865960e-02   +1.334245283004695e-01   +1.233363494368100e-01   +1.203891796019449e-01; +7.218911132836744e-02   +5.222647426087052e-02   -6.934239211131565e-03   +2.855260830726625e-01   +1.695363743392600e-01   +1.560955742389573e-01   +2.982882689893979e-02   +1.834940272227595e-01   +1.999795721260536e-01; +7.436530044649937e-02   +2.029979271252910e-01   +1.685882033225484e-01   +1.879968478245033e-01   +1.401885457208924e-01   +3.655671515554977e-02   +8.486714860893282e-02   +5.010031236931775e-02   +1.554255056463638e-01];
L4_L1_iGABA_netcon = [+1.149401597209554e-01   +1.411743544527628e-01   -1.810916202215117e-02   +1.244605744766234e-01   +1.179415457193461e-01   -1.283412714658545e-02   +1.331961659516256e-01   +1.402022590671501e-01   -4.822811595908851e-02   +1.720494111425911e-02   +1.282477593293483e-01   +2.588328362989289e-01; +1.568071434736759e-02   +8.763447739584576e-02   +2.633850066454886e-01   +4.244538684988330e-02   +6.507256816520988e-02   +2.650585961203035e-01   -5.618290388512141e-03   +1.931449254020589e-01   +2.285528210046978e-01   +2.838041039150975e-01   +5.951581137078788e-02   +2.732874521246042e-01; +3.981219616635257e-02   +1.542641516728958e-01   +8.887581818298688e-02   +2.159307548011356e-01   +6.822955398194441e-02   +9.883753112927288e-02   +1.800464526194394e-01   +2.782012326736042e-01   +2.345631075880363e-01   +6.384881652121878e-02   +2.144166006784080e-01   +6.159420423582904e-03; +5.741659284555267e-02   -3.816079109944354e-02   +2.518188948741679e-01   +1.904287398543003e-01   +8.080553347157436e-02   +1.440915333355401e-01   +1.418358828670893e-01   +3.137543930888184e-01   +2.612620864380371e-01   +1.092090248437373e-01   +2.764892954041778e-01   +7.599895051024277e-02; +1.274340220283614e-01   +2.131404464193166e-02   -7.616600595393944e-03   +1.939943324935585e-01   +6.030048040597590e-02   +9.827791050868630e-02   +1.605463697231296e-01   +5.089446348191581e-02   +1.685271753960950e-01   +1.759889348274868e-01   +5.593124585187798e-02   -2.555830465950528e-02; +1.073441978669932e-01   +2.742528864860643e-01   +1.532207018205133e-01   +2.002577810564848e-01   +4.350578939297320e-02   +7.958345978360801e-02   +1.393718829169754e-01   +2.540696242190199e-01   +6.659671557632942e-02   +1.542773455955915e-01   +1.501116891703647e-01   +7.528240136142514e-03; +8.110444649490602e-02   +8.589884831710258e-02   +2.035652104509266e-01   +2.493387344375350e-01   +2.817545618316049e-01   +1.515361709076988e-01   +5.733752766558393e-02   +1.337186409381367e-01   +8.586519633747326e-02   +1.709649246154879e-01   +1.181634944680449e-01   +1.786246007678088e-01; +3.763823300811613e-02   +1.136353611002490e-01   +4.195172991064883e-02   +7.645006276002066e-02   +6.929215392782774e-03   +4.782165835003552e-02   +4.202002993444794e-02   +2.658070770752198e-01   +1.941602413672829e-01   +2.054666146636736e-02   +3.021327337552672e-01   +1.874593826824194e-01; +1.134329977236453e-01   +1.529538553559324e-01   +2.854688737280001e-01   +2.769919842746565e-01   +1.873050993058125e-01   +8.919568134394835e-02   +1.061829543436237e-01   -5.951133055994016e-02   +1.863743716186636e-01   -2.446368191806245e-02   +4.185775173410160e-02   +1.262300504280840e-01];
L1_L3_iAMPA_netcon = [+1.303558531064504e-01   +2.181386719600959e-01   +1.616405184957890e-01   +4.660297334537593e-03   +1.654497128636608e-01   +1.838728650285581e-01   +9.625086535710739e-02   +8.936841457904042e-02   +2.867695489850233e-01; +1.573357291762978e-01   +2.292624451328782e-01   +1.616473877284715e-01   +1.728465936322161e-01   +2.769826743071383e-01   +2.422461037302968e-01   +2.209962405485766e-01   +2.788355778195959e-02   +1.234762997899045e-01; +3.123552496268043e-01   +2.361770436704495e-01   +5.096905427674972e-02   +2.129030169602062e-01   +1.843735085382690e-01   +1.703031811420295e-01   +6.836231165411985e-02   +2.826746730855674e-01   +1.512360294513060e-01; +6.746586392809759e-02   +1.504672618089046e-01   +9.651315599363502e-02   +1.789230738893733e-01   +2.169598077663884e-01   +5.510071664422296e-02   +7.228700463482723e-02   +1.897180395266786e-01   +2.265379927246297e-01; +2.082902165091413e-01   +4.679890896185560e-02   +1.443397915949163e-01   +2.160534360353866e-01   +1.863284850504164e-01   +7.457222224015742e-02   +1.251157096305969e-01   +2.444905538898048e-01   +2.203869830976802e-01; +8.396430179011843e-02   +1.083687703105821e-02   +6.083145696658805e-02   +1.929584695136798e-01   +3.099892735474579e-01   +2.124134105105817e-01   -4.028258717898894e-02   +7.331096946282877e-02   +1.546241295694894e-01];
L3_L1_iGABA_netcon = [+3.774049952346255e-02   +3.889262785390676e-02   +2.088224452205212e-01   +1.466003160431068e-01   +1.332925095198851e-01   +1.868465481969269e-01; +2.838636948149934e-01   +3.136319404783806e-01   +6.962370146588837e-02   +7.619112646422768e-02   +6.983636663044758e-02   +2.362471745281504e-01; +1.983167115385164e-01   +2.409979832949154e-01   +1.102381703751697e-01   +2.324239354241911e-01   +5.325954781763998e-02   +1.012062620817336e-01; +1.729663988502613e-01   +2.524034032587734e-01   +1.589201787523389e-01   +2.441068095336973e-01   +4.863150802456389e-02   +1.440273589690951e-01; +6.871511505564804e-02   +2.272303780903999e-01   +8.687644204122931e-02   +1.104823805665690e-01   +5.314421071683900e-02   +1.996818192114763e-02; +5.088158630622991e-02   +2.270657184075331e-01   +2.229141078658590e-01   +1.009691357600819e-01   +5.968094218574656e-02   +1.486768189397391e-01; +8.306554331622931e-03   +2.700814694547692e-01   +1.279847687955979e-01   +1.390615853447605e-01   +1.539355035030546e-01   +8.841486424187264e-02; +4.777091317846519e-02   +1.037593543947631e-01   +2.845456755115055e-01   +1.460741911217037e-01   -9.242725068655061e-03   +8.832107864330684e-02; +4.485877947964078e-02   +2.042164315503211e-01   +7.230762906470417e-02   +1.052693768384055e-01   +2.155733636492223e-01   +2.264616366623085e-01];
L5_Input1_iAMPA_netcon = [+5.507666761221683e-02   +7.891964613280390e-02   +1.498660279706756e-01   +1.262573663618039e-01   +2.562228121461592e-02   +1.008956819258944e-01];
L6_Input2_iAMPA_netcon = [-2.257936844996579e-02   +2.734043243682002e-01   +1.766485158717972e-01];
L5_L6_iAMPA_netcon = [+3.034033683044167e-01   +6.383154678506056e-02   +1.876375864476654e-01   +1.227901588450180e-01   +2.648465380456081e-01   +1.844487469020758e-01; +1.503702208243111e-01   +8.248506749625577e-02   +1.111488846286394e-01   +1.363699389097704e-01   +2.663269227938199e-02   +2.267510175442810e-01; +2.240172659409907e-01   +7.026019718135348e-02   +1.319132811214029e-01   +1.038264389411540e-01   +6.989640378227055e-02   +1.554343430927853e-01];
L4_L5_iAMPA_netcon = [+2.214334861367314e-01   +2.572231064265290e-01   +1.101174791132946e-01   +8.927187067973819e-02   +6.360760882670531e-02   -7.953531252764379e-03   +4.247802206137311e-02   +1.258270035668678e-01   +9.833087433296182e-02   +1.239184075203143e-01   +1.084043695854626e-01   +4.822251073939215e-02; +2.589504122801152e-01   +3.405565242077470e-02   +1.779047115031980e-01   +6.479505325885780e-02   +8.008850682740103e-02   +8.270961728825570e-02   +1.785876197769292e-01   +6.731834285798101e-02   -3.787053868488759e-03   +1.257316408744224e-02   +8.511135606837920e-02   +3.180855696368588e-01; +7.939347244455267e-02   +1.016205503121980e-01   +5.542061961450845e-02   +8.592718611834876e-02   +3.021795636358595e-01   -2.390794397682065e-02   +1.227677240631780e-01   +1.894093784955412e-01   +8.888448753155699e-02   +2.292249237463822e-02   +2.209714303589544e-01   +2.309450403699778e-01; +1.966291817541993e-01   +1.587136368736915e-01   +1.696652342250385e-01   +1.299859509419501e-01   +1.035346996198647e-01   +8.614698473030687e-02   -1.624016192961624e-02   +1.929495000985871e-01   +8.709379580341967e-02   +1.855765490700696e-01   +1.502164997849544e-01   +2.267925404413271e-01; +1.685754107667173e-01   +2.330892186933536e-01   +2.931550529040038e-01   +3.286035741321715e-02   +1.612894257603140e-01   +2.602792241830482e-01   +2.171406251273725e-01   +2.257768703970708e-01   +2.946302631649426e-01   +7.660905704174842e-02   +1.147566494138581e-01   +2.055130292072082e-01; +1.569365862668737e-01   +2.042378789009024e-01   +1.002893461760722e-01   +1.333005297824906e-01   +1.967834190997703e-01   +3.049773806077201e-01   +1.075218532247740e-01   +1.395116431891892e-01   +2.182695032399711e-01   +2.328635124056594e-01   +2.499050126727932e-01   +1.692079320945807e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
