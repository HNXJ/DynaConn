function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.128292138273170e-01   -3.963395465837242e-01   -6.393055372898466e-01   -3.255345745570022e-01   +1.647670620443563e-01   -5.810845328839991e-02   -2.627445996535433e-01   -1.731840325683276e-01   -3.533109685820910e-01; +1.567132296618964e-01   +1.000000000000000e+00   +8.483637775473757e-01   +9.189923857910911e-01   -4.446307229160519e-01   -4.240010087223602e-01   +2.607987288411651e-01   -8.513546311555124e-01   -5.987925354358116e-01; -5.020318501616593e-01   +4.773865375400661e-01   +3.163082305076053e-01   +1.593677174332943e-01   -4.594451337962155e-01   +5.214113653357697e-01   -6.785312692286943e-01   +4.162293356244632e-01   +4.941209949748767e-01; -5.040458598819634e-01   -4.397280452987745e-01   -6.705949634037037e-01   +5.750938986662690e-01   +7.198493386916162e-01   -7.884017084168332e-01   -4.067872030097133e-01   +4.340280777817672e-01   +6.659748899077518e-01; -6.663374091261921e-01   -4.284988891662692e-02   +7.999319910235120e-01   +4.520740747671316e-01   +7.103605404426413e-01   -3.247931468970453e-02   +4.375580403180924e-01   +1.130009609241284e-01   +1.281179213124142e-01; +3.834181574314192e-01   -5.417413827419820e-01   -5.372885256344959e-01   +2.225138578575162e-02   +9.411153646074242e-01   +2.076636704985194e-01   +4.204267431076310e-01   +5.218971339389010e-01   +9.398383490474014e-01; -2.098508058659337e-01   +4.413326514674399e-01   -3.566205034264632e-01   -6.708646113687726e-01   +8.608343441568592e-02   -8.086840084878590e-01   +3.279815698102285e-01   +1.929378284129722e-01   +6.754975388034657e-01; +3.629076178415390e-01   +7.510531723111787e-01   -2.652665970417866e-01   +4.642087173230371e-01   +3.386778944050994e-02   +3.394724364772372e-01   -6.017685372527296e-01   +1.269776449382400e-01   -4.213696449462313e-01; -6.884842747976784e-01   -8.575351754842452e-02   +5.149215383056378e-01   +8.168334433616070e-01   +9.274670806073192e-01   -2.639575672777803e-01   -2.362830737717534e-01   +6.498375531540203e-01   +8.504001454274994e-01];
L1_L2_iAMPA_netcon = [+5.537633247823860e-01   +3.156008300235581e-01   +4.109303373447816e-01   +9.134183482861659e-02   +5.424169300733785e-01   +8.098287914492925e-01   +3.855130489898714e-01   +2.563870631565223e-01   +9.383201989827797e-01; +2.212937083019924e-01   -6.870420824479618e-01   +5.062937759199203e-01   -2.508705200607719e-02   +9.362854283189205e-02   +3.454992425404990e-01   -8.296803532116096e-01   +8.340297830340909e-01   +8.914518765016567e-01; +6.653394015019543e-01   +6.159081553599280e-01   -4.953793828182546e-01   -2.459172971705033e-01   -6.381412460261138e-01   +5.715576618652475e-01   +6.758181102682818e-01   -1.879848142132034e-01   -5.633041070165555e-01; +6.033662052071151e-01   -6.220716660311573e-01   -1.978653968656705e-01   +1.703594603995972e-01   +9.498719653158715e-01   +5.258973663240768e-01   +5.137367565974775e-01   -1.685342570171811e-01   -5.283723180126222e-02; +3.622926563179758e-02   -3.052677493928957e-01   +5.417758063627562e-01   +3.204271150610717e-01   -4.483788013933065e-01   +3.118241335741154e-01   +1.000000000000000e+00   +2.533238124266900e-01   +6.022903779648435e-01; +4.320907967334512e-01   -5.337306721490331e-01   +4.159557912531165e-01   +8.548835355929861e-01   +1.484626878649404e-01   -6.670935896638240e-01   +4.486468095114399e-01   +8.073483299632102e-01   -3.708824016653223e-03; +6.685988558393451e-01   -2.181133020269512e-01   +9.556238014068501e-01   -6.956278996268286e-01   -1.288547732410595e-01   +3.932051792964193e-01   +1.301825433476167e-01   +7.895313093079539e-01   +2.873130380983294e-01; -1.963079211345427e-01   +5.616866506277961e-01   +5.920099257758190e-01   -5.809046663743317e-01   -6.074124642949432e-01   -3.943884965912177e-01   +1.912957315058628e-01   -1.360593849667126e-01   +2.544312705639659e-01; +2.139456892010037e-01   -1.286566621129456e-01   -5.950903500267791e-01   -6.515420633383984e-01   +3.348716296254076e-02   +3.459783973017725e-02   +5.637772309588911e-01   +7.787560660696038e-01   -6.933640156436405e-01];
L2_L5_iAMPA_netcon = [+7.458667150713079e-01   -6.796423927350310e-01   -7.043150789022238e-01   -7.194162880158170e-01   -4.461264312460875e-01   -6.302289290023207e-02   +2.112369201041868e-01   +9.913216582929308e-01   -3.221611573874387e-01; -2.590679302485460e-01   +9.326709108258375e-01   +7.377697173005883e-01   +2.623167965488425e-01   -5.699994931892436e-01   +7.891420088443553e-01   -4.722619317121976e-01   +3.622484117488792e-01   +5.737890073813291e-01; +2.933004389026690e-01   +1.930443066920655e-01   +4.139161126955563e-01   -5.554266928617346e-01   -6.161335462333013e-01   -3.048820763453943e-01   +4.653863445585499e-02   -3.107427197210989e-01   +3.433839070158783e-01; +6.187303412584363e-02   +4.919832710525109e-01   +9.133027229821714e-01   -1.940525307010623e-01   -3.403342242995114e-01   -5.990479036364754e-01   -4.255282910636569e-01   +5.126251179517836e-01   -6.637643578077516e-01; +8.125874506918310e-01   +6.130410365725273e-01   +1.000000000000000e+00   +2.561584500750613e-01   +2.709303723491793e-01   +2.309880406595358e-01   -4.556814023334156e-01   +9.510657870811370e-02   +7.885565636471064e-01; +3.600715245036105e-01   +6.106011342945987e-01   -3.045197915401454e-01   -6.844010064971324e-01   +8.755365533344325e-01   -2.130432678690750e-01   -4.274886266102524e-01   +6.669447659406518e-01   -1.771137358557867e-01];
L5_L2_iGABA_netcon = [+4.767453987149015e-01   -3.324495898055915e-01   +5.812159123339735e-01   +5.048592606641091e-02   -1.122938904958397e-01   +7.905929222073027e-01; -6.307127224002210e-01   +6.801665708133978e-01   +8.616554963405733e-01   -7.804963820088977e-01   +5.566017149299547e-01   +8.348094952904023e-01; -3.820019039657936e-01   +7.796337680777128e-01   -4.959385032423448e-01   +9.175879197883552e-01   -7.049208752469844e-01   +9.285541723820274e-01; +5.997075051810101e-01   -8.471684036918053e-02   +4.410653644550300e-01   +8.911804233117692e-01   +9.746524988997621e-01   -6.245865012744831e-01; -3.593626318417338e-01   +6.197750616708800e-01   +4.581875529581025e-02   -1.615462461122690e-01   +1.000000000000000e+00   +7.004860091594874e-01; -8.211738051430570e-01   -5.933364058649142e-01   -4.089868097636043e-01   +3.004356905425137e-01   +9.089329241510813e-01   +7.275938730650033e-01; -8.678248155657187e-01   -4.918015517445908e-01   +6.828659276380673e-02   +5.567812068858707e-01   -7.442820615910331e-01   -3.399944507185856e-01; -5.713698858143823e-01   -7.259320376409162e-01   -3.364186544718654e-01   -5.275146134210752e-01   +6.582469700368633e-01   -1.876763227689244e-01; +5.035844782592868e-01   -4.057799965023087e-01   -1.413401326522724e-01   +3.153646850718572e-01   +8.363297369875777e-01   -5.829827969134078e-01];
L3_L2_iAMPA_netcon = [-1.603422872605390e-01   +6.231744717221197e-01   +5.703412567398191e-01   +1.362071611609894e-01   +4.571219181617842e-01   +1.755097526967354e-01; -8.932345122717675e-02   +6.287632300011160e-02   +8.534450098065703e-01   -3.795794277357381e-01   -3.828368749887157e-03   +3.688155379589965e-01; -8.276608406062707e-01   +7.262856386122710e-01   +3.080247928140367e-01   +4.004742981273537e-01   -7.753739776553568e-01   +4.656032011139613e-01; -5.756589040441101e-01   -9.515060563124964e-02   +7.052403760047521e-01   +1.000000000000000e+00   +6.723439300438553e-01   -1.522522267544294e-01; -8.681145361059103e-02   +9.549898454838766e-02   -7.538391930398225e-01   -3.267453600781475e-01   -6.394845022535862e-01   -1.367902789746385e-01; +9.400084675678191e-01   -2.902759643722621e-01   +8.184894392487035e-02   -2.127765841007130e-01   +7.042043812295922e-01   +1.154127699108893e-01; -2.583008277300415e-01   +6.439973877065371e-01   +1.944455430940826e-01   -4.284775361407354e-01   -3.711032592109234e-01   +3.168769547942639e-01; -1.565020732769870e-01   -7.711382775846206e-01   +1.304651361166923e-01   +3.150008038936123e-01   +4.057306810905511e-01   +3.091928955203493e-01; +1.583634256843086e-01   -6.734592210332829e-01   -6.728391968855302e-01   +9.031818259256035e-01   -6.112830255034757e-01   -5.560200608726871e-01];
L2_L3_iGABA_netcon = [+9.122433193495048e-02   +9.102437843294716e-01   -2.439032241381527e-01   -6.718493387164955e-01   +1.000000000000000e+00   +1.416012860261149e-01   +5.959184121408111e-02   -7.617453391157770e-02   -6.718463534534317e-01; -1.341045527850932e-01   +6.999821211267910e-01   -6.579131064963283e-01   +7.196073855691393e-02   +3.831959603782946e-01   -7.100743214809432e-02   -4.618171901312584e-01   +1.689949474052815e-01   +3.331020039770182e-01; +4.392614086592012e-01   +7.343971931705204e-01   +5.720145673584017e-01   +8.268588845633751e-01   -2.850286886416124e-01   -5.523555932131131e-01   -6.115396784465755e-01   +2.801104683749884e-01   +2.986284093942209e-02; -3.936658776416546e-02   +8.822229506735310e-01   -5.776676783784586e-01   -6.036415999177583e-01   -1.642174667069592e-02   -2.174448188027036e-01   +3.525952378935563e-01   +3.068452341214833e-01   +7.315811026243534e-01; -2.723094231504870e-01   +7.907902472813049e-01   -5.675055190544052e-01   +7.616129702368444e-01   +5.181031237029076e-01   +7.448210693649673e-01   +4.451888875060718e-02   -3.495269367925754e-01   -6.347612112215536e-01; +4.442651289265248e-01   +2.474860410128701e-01   +7.933078461433880e-01   -5.820215863930148e-01   -1.523456458302071e-01   +4.590888783821451e-02   +1.682150896794099e-01   +5.433248164009437e-01   -1.169754870569974e-01];
L1_L4_iGABA_netcon = [-1.911467015567293e-01   +6.859861870161920e-01   +4.310286083661600e-03   +5.290713671400601e-01   +6.736689206684913e-01   -6.747567525064408e-01   +3.912439072430937e-01   +3.528871422071302e-01   -9.345536454313678e-01; +7.815815290743146e-01   -1.083879808549850e-01   +7.984434684308099e-01   -4.931317986534527e-01   +8.349568130076647e-01   +3.371708628166654e-01   -8.500688290074773e-01   +1.000000000000000e+00   +6.109040826096040e-02; -4.416568483464482e-02   -3.382767648505213e-01   -7.128969464618736e-01   -4.373861285123030e-01   +4.489940761063830e-01   -2.827040320956104e-01   +5.284606982300791e-01   +1.661901697584027e-01   -4.997911659171940e-01; +1.923290433777419e-01   +4.316859182596520e-01   +7.212533144983949e-01   +7.876363698221277e-01   -2.459881519812070e-01   -3.850438035321465e-01   -5.583237878662053e-01   -5.409401514958182e-01   -3.441554185562291e-01; +1.693286487911299e-01   +8.530216352964451e-01   -4.326846024025838e-01   +7.041054217691278e-01   -5.498509098539686e-01   +3.720344356041467e-01   +3.118579727522257e-01   +6.526097307893410e-01   +3.205802810315110e-01; +2.464772726867631e-01   +6.976808769172411e-01   -6.464521005058144e-01   +5.406554240894340e-01   -7.803026051692655e-01   -2.873210818062253e-02   -1.516706361065392e-01   +6.436901675807205e-03   +9.598410242961566e-02; -5.496401096925455e-01   -5.749952458420670e-01   +2.431717429463583e-01   -1.043189347047240e-01   -2.432954719592171e-01   -4.352596524605584e-01   +4.282815858856621e-01   -4.926501206741936e-01   -6.376527908070193e-01; -8.067691923013047e-01   +6.883115911464459e-02   -2.298217496588892e-01   +5.090012606781328e-01   +7.123471407860187e-01   +1.093473234978492e-02   +8.810505048822644e-02   -7.516304612231101e-01   -8.803403049726519e-01; +2.163592640851660e-01   -2.431427008740181e-01   +7.639904139369668e-01   -7.573509188534029e-01   +9.298830925306996e-01   -6.156357320873569e-01   +2.729463980033296e-01   -1.985750858340274e-01   -3.183773553792901e-01; +9.774527952057197e-01   -1.423935094838915e-01   +8.856274166221085e-01   -5.597503294155814e-01   -4.602107307439774e-01   +6.161820113816167e-01   -2.805361489345024e-01   +8.346620170209800e-01   +6.191887457371308e-01; -6.231935654301431e-01   +4.590957614548557e-03   -5.999341325342882e-02   +1.279574111345425e-01   +9.875149228963044e-01   +4.847052059401679e-01   -2.177730743161282e-01   +8.422125215181603e-02   +9.468276254349589e-01; -1.118490038217549e-01   -9.219603086044217e-01   +8.878743338884605e-02   +5.660519354560981e-01   +9.015993635882860e-01   -8.952980339125826e-01   -3.171310996067920e-01   +6.728548166326824e-01   +7.533752044066747e-01];
L4_L1_iAMPA_netcon = [-3.678238044280516e-01   +6.478659456081737e-01   -4.147599728945464e-01   -1.775187064001883e-01   +1.359830228899445e-01   +4.565467183268013e-01   +9.157425117926000e-01   +7.576023215670408e-01   -3.801758591274773e-01   -4.034058907025599e-01   +2.186396129124482e-02   +3.868464663398950e-01; -1.152390420864205e-01   -4.291429180709939e-01   -1.471328439408261e-01   +2.150782744603267e-01   +7.240998823306988e-01   +2.351340131963213e-01   -4.835088258648998e-01   -7.374708298372301e-01   +3.113290051042933e-01   -3.340825911629127e-01   +1.436475942523461e-01   +1.958341920297189e-01; -2.436653039970654e-01   -4.899416537650098e-01   -3.299445569121751e-01   +4.694469002156312e-01   +3.782661777156973e-01   +9.498020265006127e-01   -3.756263568199170e-01   +6.028348440120811e-01   +7.985326381117476e-02   -5.613261918605179e-01   +8.574514032606905e-01   +6.909612742713027e-01; +1.494919592859797e-01   +1.024397120427902e-01   +1.000000000000000e+00   +6.995771167664434e-01   -3.509081957694371e-02   +9.245421525206191e-01   +8.991986357733756e-01   +5.496179230287219e-01   -4.968817206255958e-01   -3.728264962783277e-01   +5.285903431739921e-01   -4.569182340803133e-01; -1.343822204318910e-01   -3.032749467505687e-01   +4.263585472606675e-01   +1.694055078536933e-01   -3.080506379316337e-01   -3.530928160059603e-01   -4.451646084249377e-01   +9.108274823819423e-01   +6.716696960261399e-01   +3.139516597566571e-02   +2.348484409685324e-01   +5.855239815160367e-01; -4.429270013322882e-02   -5.934298670579603e-01   -2.819994094604298e-01   +3.172243766443598e-01   -1.550848583370346e-01   -3.835678995902984e-01   +8.210727478460836e-01   +3.318445210952606e-01   -7.913929564788972e-01   +4.299645201812503e-01   +8.835225900466918e-02   -8.031314149293387e-01; -2.812583126210612e-01   +6.363911443366100e-01   +6.673761010334276e-01   +6.175178929896548e-02   +7.551296070345054e-01   +7.485835306897078e-01   +3.182065237169763e-01   +7.124886381052732e-01   -6.273008634275118e-01   -6.933112960870037e-02   -6.134355886628957e-01   +9.071841433663058e-01; -2.651350646497281e-01   +5.136868616297577e-01   +3.059973976436698e-01   -5.118017130416133e-01   -5.447828474278533e-01   +5.442643851940427e-01   +3.390475042633422e-02   +9.520490846577132e-02   +4.939111034163250e-01   +5.259147718810256e-01   -8.076004793468838e-04   +8.404192795152016e-01; +6.742432311017569e-01   -6.971456041396314e-01   +5.878215240100088e-01   +7.532917545476617e-01   -3.522173344048221e-01   +3.870643535254262e-02   -3.874534175245266e-01   +6.604995855655336e-01   -3.647143181360054e-01   +4.169485650799472e-01   -2.809854896917886e-01   +7.776434271706564e-01];
L1_L3_iAMPA_netcon = [-4.253029218030785e-01   +6.354863450560018e-01   -4.221013361927101e-01   -4.385382981844575e-01   -4.276614866129793e-01   -3.702193778360025e-01   +9.421080075552177e-02   +7.906303373487080e-01   +5.299804048923651e-01; +7.804564730468604e-01   +9.569885915361193e-02   -2.115879978718618e-01   +1.000000000000000e+00   -7.987632819401223e-02   +6.777449078784250e-01   +1.273629272604913e-01   +1.378291644346840e-01   -6.951911355469706e-02; +9.251973208221868e-01   +7.526878387976035e-01   -8.143146737684950e-01   -4.272419547098730e-02   -4.325696731812942e-01   -8.832837846561858e-01   +7.820802723945882e-01   -2.710634899932544e-01   -5.703536593947216e-02; -3.909912085625295e-01   -6.462027504709943e-01   +6.017866314301215e-01   +2.035500960573822e-01   +1.887247849047220e-02   -5.996097192144454e-01   +3.305238719524928e-01   -3.549247128790788e-01   -8.555635567852562e-01; +6.675367174089354e-01   +2.231129502517017e-01   +4.497606180694990e-01   +1.444164056078886e-01   -9.367879040569022e-01   -6.623646758708892e-01   +4.115128091455384e-01   -5.406600160081628e-01   +5.335270980763706e-01; +8.245873403957484e-01   +6.252906773299396e-01   +6.018118195376191e-01   -6.895615343496667e-01   +5.319934504945792e-01   -3.357954868678436e-01   +3.063447767813967e-01   -1.753356960714400e-01   -8.698639166637497e-01];
L3_L1_iGABA_netcon = [+1.421359074264254e-01   +4.135842284980322e-01   +4.835682328650954e-01   +8.062676649481436e-01   +7.309190975092102e-01   -7.584500302887188e-01; +5.913495185897202e-01   +3.833555434971059e-01   -2.145629037611087e-01   +1.462325441483134e-01   -2.604846759331543e-01   -4.006014642130504e-01; -4.205725473690892e-02   -2.371997615936858e-01   -2.054814887620499e-01   -6.510499053762139e-01   +6.770084336530925e-01   +1.692747272401666e-01; +6.698340926679034e-01   -2.388476548840329e-01   +9.478181550550425e-01   -2.842202886878681e-01   +6.262275305073249e-01   -7.500670444319201e-01; -4.553119558183462e-01   +4.080257873959623e-01   -3.777971544573795e-01   +4.190182848656400e-01   +3.625945467919340e-01   -5.433494451529511e-01; -1.862004006944373e-01   +9.304864743395883e-01   -8.687048572707626e-01   -2.913452977945256e-01   -6.522274613458151e-01   +7.751024583298652e-01; +1.959433909211199e-01   +9.666531508664851e-02   +1.000000000000000e+00   -8.176378793879986e-01   +9.471467126175727e-01   -2.353634166366786e-01; -5.454944547421696e-01   -5.525044216861971e-01   +2.893468575543686e-01   -2.453345365321085e-01   +7.068395228163225e-01   -4.110039874344938e-01; -2.290810556462337e-01   +1.150843742664049e-01   +6.339818570715561e-01   +9.752975418941676e-01   -1.503656245858899e-01   +8.308824596799012e-01];
L5_Input1_iAMPA_netcon = [+1.000000000000000e+00   +3.992628355379694e-01   -4.589619831274511e-01   -6.487031441571396e-01   +8.971583518622626e-01   +6.594984848208337e-01];
L6_Input2_iAMPA_netcon = [-4.500176000000013e-01   -6.293543581118739e-01   +9.743398434386789e-01   +4.811639019384934e-01   -4.672659939155571e-01   +1.000000000000000e+00];
L5_L6_iAMPA_netcon = [+6.660423496322019e-01   -1.798722305013340e-01   +7.767804469810897e-01   +7.303399912320616e-01   +6.398594831529184e-01   +7.957971503906556e-01; -9.423765444008006e-02   +8.540008008714175e-01   +8.551805482352729e-01   -4.922954166771190e-01   -2.716925585167394e-01   +4.651973693518727e-01; +3.500304435299866e-01   +6.492932477356252e-02   -3.407760180130248e-01   +7.837837302291706e-01   +4.216431845060305e-02   -7.158923818969069e-02; -3.647370712616567e-01   -1.945409128734796e-01   +6.198517676792643e-02   +9.732535458420181e-01   -7.668016047551069e-01   +3.340521927780700e-01; -1.482114492569178e-01   -8.424430600825709e-01   -3.095463239047926e-01   -8.737033574890721e-01   -9.403795343980083e-01   +2.537764935162056e-01; -3.737534045875470e-01   -5.586052861905230e-01   -6.652686401016292e-01   +6.178870144012762e-01   -3.112021864808318e-01   +1.000000000000000e+00];
L4_L5_iGABA_netcon = [-4.597650340376238e-01   -1.884672902737652e-01   +9.269102721114207e-01   +9.177322963720070e-01   +2.190357210652356e-01   +3.873998222659160e-01   -2.497409957300170e-01   +1.000000000000000e+00   +8.590540251823218e-01   +6.647776616451247e-02   +8.352118760480614e-01   +6.536462382515076e-02; +7.361248962899425e-01   -1.612037454332569e-01   +7.675384216531862e-01   -8.124207745384582e-01   +4.972908277227334e-01   +8.860587882616207e-01   +7.337129799725817e-01   -2.866194000955771e-01   +7.895910763114086e-01   -6.986312036048657e-02   +9.305463540809850e-02   +1.214361801163112e-01; -2.030931368931603e-01   +1.808506852353675e-01   +1.694913641172459e-01   -8.876750176155830e-02   +4.502479975627433e-01   +5.559366067768728e-01   +4.100398800472669e-01   -4.536456152534223e-01   -2.314709265596120e-01   -5.146791069292279e-01   +5.356699397134396e-01   +4.769905767752920e-01; -4.926697986861185e-01   -6.819819063262473e-01   -5.857647396949185e-01   -7.278970507646731e-02   -8.628853988503675e-01   -2.803436322876912e-01   +1.891019478752377e-01   -2.040129830690720e-01   +6.469264323220616e-01   +1.745087305129095e-01   -2.858763110003457e-01   +9.387263212726102e-01; -1.184808887504189e-01   -4.902635797487446e-01   +9.446830907220673e-02   +9.940274411767828e-01   +7.422938062953122e-01   -1.207243535118456e-01   -6.772753318167120e-02   -7.832291543361833e-02   -7.979576927166597e-02   -8.100663419019827e-02   -1.686157100682268e-01   +3.064590032157317e-01; +7.222777659052486e-01   -7.944557964253607e-01   -3.890558247776530e-01   -9.348641585473570e-02   -3.210776847768730e-01   +7.029520383781767e-01   +4.931731875090984e-01   +4.815102632351220e-01   -7.258663442966982e-02   -3.549639672133203e-01   -7.461508537145725e-01   +7.988868226580365e-01];
L6_L4_iAMPA_netcon = [+3.361431885552354e-02   -6.189202770773482e-01   +9.220502771012369e-01   -3.268657928339425e-01   +6.928387118035317e-01   +1.000000000000000e+00; +5.844993757306089e-01   -7.416489153532539e-02   +2.056316719899569e-01   -3.999845785054435e-01   -5.540769454146546e-01   -3.646580791207993e-01; -6.810926135152758e-01   -3.120222438505815e-01   +9.267796608279425e-01   +2.373515365269347e-01   -2.776378441227044e-01   -5.234345846601948e-01; +5.817275665991063e-01   +4.612730909633381e-01   +8.514817450006665e-01   +6.054636351161108e-01   +8.308437774006446e-01   -8.933904077130669e-02; -1.034352612772937e-02   +4.492247773004139e-01   +6.837646141359439e-01   -7.426018739271302e-01   +5.524640765526830e-02   +7.207752261665598e-01; +8.241425803788005e-01   -4.610577243793899e-01   +9.461097050001677e-01   -2.399600056320982e-01   -1.874872688345915e-01   -2.195079696050218e-01; -3.246518795901512e-01   +6.332832306306839e-01   +8.308624158948220e-01   -5.709880433835901e-01   -8.372570051759298e-01   +1.701671017251340e-01; -3.084461439113045e-01   +5.412979142389204e-01   +7.261955307386844e-02   +8.872694840988480e-01   +6.332467264011074e-01   -5.612689377349876e-01; +1.587182284213449e-01   +6.375571524946807e-01   +9.645461259908807e-01   +5.797771492483247e-01   -4.551578842820605e-02   +8.939387382974481e-01; +8.660119296539367e-01   +6.329975986562404e-01   -7.716697230023016e-01   +7.013176907995962e-01   -2.740664359507631e-01   -8.268784892217798e-01; -5.178178837433438e-01   -6.306070549604320e-01   +4.789804106756619e-01   -4.349785543199593e-01   -5.598311933629890e-01   -9.316635618714690e-02; -4.279408375890136e-01   +5.837317916101662e-01   -2.420590374179611e-02   -2.150719660163381e-01   +2.267037527258102e-01   -4.363880818652734e-01];
L5_L4_iAMPA_netcon = [-6.877920396847654e-01   -1.112830308513805e-01   +4.152612510379199e-02   -6.815273639379030e-01   -2.137859366395901e-02   -7.537704692669153e-01; +1.807503390851579e-01   +5.840533001723587e-02   -4.310719956288328e-01   +6.469248474028827e-01   -8.299769607352715e-01   -4.362410003597446e-01; -2.080590775037255e-01   -3.385954012834834e-01   -2.671744784418517e-01   -8.032929061274048e-01   +7.598001945201847e-01   +4.377703421113943e-01; +1.000000000000000e+00   -4.502777828543230e-01   +8.729880407244173e-01   +7.494676111932325e-01   -5.084383004302662e-01   +2.732301140696504e-01; -7.660654455843560e-01   -5.359793042318006e-01   +3.105179141677782e-02   +8.064351217602189e-01   +1.429417047846251e-01   +3.067927267707314e-01; +2.055018749039166e-02   +4.586137206737860e-01   +6.675410745524464e-02   -1.720899930989784e-02   -6.568349955395049e-01   -6.856283471334118e-02; +7.113363475656327e-01   -7.914188635579185e-01   +4.821413044368527e-01   -1.268746431398715e-01   -2.173594647980460e-01   -2.752780618079102e-01; +7.433582815307830e-01   +3.716544685791837e-01   +8.012532711137801e-01   -5.944892743418737e-01   -7.404805834090765e-01   +3.678006407969203e-01; +1.700590425248933e-01   +1.111079236144629e-02   -8.007130642012883e-01   -1.794055615990834e-02   +3.845877777447168e-01   +6.399857825835895e-01; +4.848032489723355e-01   -3.178527146957170e-01   -7.404827915939437e-01   -5.654886572268506e-01   -4.441235924938702e-01   -7.644928774014677e-01; +5.059436723409637e-01   -3.817022545781484e-01   +1.742925372539501e-01   +5.195710408410046e-01   +7.782623580587094e-01   +8.185532444968796e-01; +3.484039445436669e-01   -2.307766987229045e-01   -8.694931136866610e-01   -4.884850671651527e-01   +4.283019954994262e-01   +5.255262283454984e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
