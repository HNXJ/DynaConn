function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.408465876069008e-02   -4.061633132757848e-03   +1.704337806811392e-02   +8.589125808194650e-03   -2.219339386766394e-02   -3.277775392727084e-02   -4.859152932298957e-02   -4.071882068921499e-02   +1.319961425945091e-02; +4.199562461667408e-02   -5.042950893820953e-02   +3.454439179820816e-02   +3.817310871104253e-02   -1.131443272992289e-02   -2.921060416397774e-02   +3.563988028910937e-02   +1.793025463128982e-02   +7.674701039321820e-02; +2.116504487887921e-02   -4.591052083848232e-02   -3.266119414334116e-02   +2.579070918667785e-02   +4.485303726855661e-02   +3.005526780533466e-02   -1.429493508302267e-02   -1.710202443615123e-02   +7.620694156707067e-02; +3.649866780187271e-02   -4.065157714797542e-02   +7.405435013383786e-03   +6.002491263115114e-02   +4.536281012589322e-02   -2.813650924640971e-02   -1.376150991424181e-02   -2.374241013877064e-03   +3.391749810625800e-02; -4.097798176984727e-02   -1.164316614110255e-02   -4.653866825412872e-02   +7.356461417864488e-03   +3.844946108786759e-02   -7.718900450926837e-02   +4.323448605488887e-03   -5.390672456394593e-02   -2.592468760569786e-02; -6.934236191253669e-02   +1.436902293163164e-02   -5.374321477928905e-02   +7.000672556268489e-03   -1.045753083033274e-02   -1.062233003189528e-02   +3.358122392398909e-02   -4.619812470055332e-02   -1.370751472918389e-02; +4.152554814552383e-04   +7.219517279405699e-02   +1.402065724084471e-02   -1.103130836486905e-02   +3.574544803025358e-02   +1.497546377509624e-02   -4.347415798978138e-02   -3.682199159526331e-02   +3.127293877387972e-02; +1.559556954703511e-02   +9.336891541066570e-03   +1.037862801180924e-02   +1.518339401123059e-02   +8.789651893941163e-03   +3.179765034990024e-02   +1.669353081265450e-02   -5.866004723471224e-02   -9.047082818672631e-03; +7.547202988523856e-03   +5.727800003976524e-02   -2.967097680434552e-02   -3.105069527763397e-02   -2.852165606974061e-02   +3.597094800515661e-02   -3.402880961061708e-02   -9.981633489425981e-03   -7.137917209500223e-02];
L1_L2_iAMPA_netcon = [-8.994958386388779e-02   +2.470454640855123e-03   +3.365120287593269e-02   -8.617505424967148e-02   +9.873660233753273e-03   -8.773884207230825e-02   +6.181792388039295e-03   +4.561793350549303e-02   +6.481641035611128e-03; +3.440977161267558e-02   -2.816588787439012e-02   +3.354342205769439e-02   +1.346335398929765e-02   -7.031915146354768e-03   -3.355872126550348e-02   -1.275804348207010e-03   +1.244671750105519e-03   +2.712212896911093e-02; +7.135077553268025e-03   +5.056508259549047e-02   -3.308737412592223e-03   +7.901686961183173e-03   +8.265056251551710e-03   -7.727477129031414e-02   +3.758912796408574e-02   -1.316364956706137e-02   -1.938423665682067e-02; +6.466817240065317e-02   +5.217316707335091e-02   +1.400355506532673e-02   +3.915443443524049e-02   -2.539477183244294e-02   -2.985202443623471e-02   -6.483773000191616e-03   -4.123311984153659e-03   -1.642971810269438e-02; +6.321677406516876e-02   +1.381102716128125e-02   -2.300552166532990e-02   -3.050406947141503e-03   +6.877902547200762e-03   +4.048126172536402e-02   +2.859350457403220e-02   -6.199026676903759e-03   +2.578421504674424e-02; +1.112586661177842e-03   +3.153762376671657e-02   +1.053381266638840e-02   +2.634035643254082e-04   +5.321878940034720e-02   -9.770845174501948e-03   +6.070857405594388e-02   -2.725434537210807e-02   +4.117862267978932e-02; -1.796036097349546e-02   +2.075698410104837e-02   +5.080778696661445e-02   -5.406258909097480e-02   +2.749056855775915e-02   +1.194789366148330e-02   +3.238262817667312e-02   -8.807616571925442e-04   +4.552613030890826e-03; -3.350426711730642e-02   +9.207791456247678e-03   -5.280756795932470e-02   +3.785037631875668e-02   +1.269487056563672e-02   +5.040353066248728e-02   -2.299436009105612e-02   -3.953597362687870e-02   -6.142198614900427e-02; +5.599276563051356e-02   +2.152110992696910e-02   -2.783361473506114e-02   -3.413105264679898e-02   +6.518161265432446e-02   -8.773229374319489e-03   -4.040875959989975e-02   +1.084209146468984e-02   +3.829244001567107e-02];
L2_L5_iAMPA_netcon = [+3.796823443676429e-02   +1.519812027473129e-02   +2.363470440770181e-02   +3.687407311564696e-02   +4.129418437291714e-02   +1.842781290753671e-02   +5.923658181719046e-02   +2.422823242535774e-02   +2.172667674651783e-02; +4.241026495084806e-02   +4.384122437573007e-02   +2.624084832927472e-02   +8.729935788226861e-02   -2.691515001139344e-03   +2.791442799369601e-02   +5.526135968764644e-02   +3.601086731896506e-02   +4.593008180362335e-02; -1.261298486303294e-02   +4.300305815698659e-02   +4.176729996169362e-02   +1.381187000422401e-02   -3.120833656318533e-02   +1.703839567544634e-02   -4.097172019363528e-03   +2.335879829975616e-02   -1.542642016632633e-02; +2.806384980841824e-02   +2.349883904769610e-02   -5.915225652315766e-02   +7.934665900521495e-02   -1.241433099109134e-03   +4.978857655847053e-03   +4.532731159873409e-02   +1.145935417195489e-02   -6.669743934767959e-02; +2.822588964065670e-02   +2.621330049296380e-02   +2.436435453053413e-02   -3.248915693790544e-02   -1.732019844583826e-02   -2.261352529415396e-03   -3.254688612175862e-02   +1.041392058119594e-02   -9.698037282289142e-04; -6.287334609552657e-02   -5.572880764998626e-02   +1.338919188998751e-02   +1.012381945719992e-02   -2.668683409432209e-02   -1.457775169603184e-03   +5.445695641464576e-03   +5.783427851953286e-02   -6.168138104058425e-02];
L5_L2_iGABA_netcon = [-1.747990570835585e-02   +3.364215302577141e-03   -2.363544865948790e-02   -2.518215428102657e-02   +1.080585906229756e-02   -1.021059149236710e-01; -1.294788015530265e-02   -3.687170617159337e-02   -5.510004159367413e-02   +5.312305130062609e-02   -1.942536219306196e-02   -8.655881682928681e-03; +5.092568683771911e-02   +1.193061146734501e-02   +3.746311199400262e-02   -1.930066016958195e-03   +3.949536579999609e-02   -2.540077244084343e-02; +4.678071814459020e-03   -2.280241444183371e-02   -3.685553638041933e-03   +3.653238973192058e-03   +3.327412141239062e-02   +1.244991208200562e-02; -3.768374725330113e-02   +7.095113590742629e-02   +3.044823599013497e-02   +6.475741225485889e-03   +2.774897909621334e-02   +1.939550678653616e-02; +5.147838441218017e-02   +1.686030476245757e-02   +3.551701492822231e-02   -7.610633126532186e-04   +7.126576420736861e-03   -7.296776224536497e-02; -4.453078649513929e-02   +5.559992587802607e-02   -7.485099348760213e-02   +5.382452899107584e-02   +2.101936116309813e-02   +7.719158954599437e-03; +5.137946189667300e-04   +2.688186879938610e-02   +5.478212096179311e-02   -1.743682262322782e-02   -5.706274845513359e-02   -1.643042059505633e-02; +5.647579592107471e-02   +2.814156019831613e-02   +4.854837575711726e-02   -1.532800015909053e-03   -1.138157162312680e-02   +4.782012572472521e-02];
L3_L2_iAMPA_netcon = [-1.417921547763857e-02   -5.953824114718296e-02   +2.504936599549589e-02   -2.730482076752025e-02   +4.390023291849763e-03   -2.389388327114310e-02; -4.034561581121160e-02   +2.876508685837298e-02   -1.704588186779738e-02   +2.574161344992226e-02   -1.151493102755633e-02   +2.641165921669770e-02; -3.414714442811475e-02   -1.630164038484749e-02   -3.874292949203449e-02   -1.435674423781549e-02   +1.961126327988179e-02   +3.059277353466822e-02; +6.180637436126143e-02   +7.423727400219528e-03   -4.133662578444519e-02   +4.323299758312203e-02   -6.445748275592771e-02   +3.126946722089877e-02; -7.206291089096510e-02   -6.107836804190733e-02   +1.904386036865639e-02   +1.485042288553247e-02   -5.119557782892682e-02   -3.161955681957619e-02; +4.450072853807668e-02   -9.125574974043624e-03   -3.425996464297514e-02   +2.178560392630832e-02   +3.568034169731032e-02   -4.136774299383982e-02; -8.143434387468701e-02   -1.143698283090568e-02   +7.012283011449136e-02   -4.288082465261810e-02   +1.681349242364413e-02   +1.529167584290564e-03; +6.877256921414939e-03   +3.543646774206240e-02   -4.006641130325563e-02   +2.449279733057077e-02   -4.712218652985307e-04   +4.557948107921962e-02; -2.786564344107069e-02   +2.030559055538155e-02   +3.703150396807693e-03   +3.433599540823712e-02   -7.040727714165224e-02   +2.717882372935181e-02];
L2_L3_iGABA_netcon = [+3.669041024231845e-02   +2.687279125769813e-02   -7.385625812005822e-03   +2.344592738837198e-02   +4.689810964274959e-02   +5.271231846591173e-02   -2.371679729832146e-02   -2.555611098348268e-02   +2.658556699820756e-02; +4.368119743119739e-02   -1.952469145199965e-02   +7.517309574122596e-02   -3.023722760422132e-02   -1.916922097294521e-02   +2.322987189747256e-02   +3.620671032125525e-02   +4.925614150746851e-02   +4.879513152430336e-03; +2.882092286096015e-02   +9.836382056773129e-03   +1.839640337668527e-02   -1.287735740562278e-02   +2.204830571396124e-02   +2.000976757979311e-02   -3.725371377575486e-03   +7.217929746649362e-04   +3.482263343333393e-02; -5.611569001457514e-02   -8.416863820321568e-02   +5.747306037388455e-02   -7.681556894793842e-02   +1.941400300613787e-02   -8.471196772980882e-02   +5.660522786716676e-02   +5.213554396632039e-02   -1.584339766460661e-02; +1.357242292138565e-02   +2.688570303707029e-02   +1.269285828442782e-02   +1.054187438295301e-02   -1.741310964528706e-02   -5.956126773350130e-02   +5.444878718836393e-03   +2.355826286874477e-02   +9.378022539395958e-02; -3.495153792563620e-02   +1.166106423736316e-02   +3.575294659329344e-02   +1.587039644007775e-02   -1.116204647508527e-02   -1.989242151518225e-02   +6.237662199938822e-03   +2.344736959805692e-03   -1.900110412145668e-03];
L1_L4_iGABA_netcon = [+3.662676770910406e-02   -4.828960784550067e-02   +7.635314989806826e-03   -9.630882313958715e-03   +2.650385197755957e-02   +3.491917029642612e-03   -1.506268031551730e-02   -3.967315103924837e-02   -1.041789809367566e-02; +1.823501620826570e-02   -1.610999066151571e-02   +5.861957632446110e-02   -3.100164158363239e-02   +9.235455365317075e-02   -1.686335103550216e-02   +6.099207353304174e-02   +2.857401882269016e-02   +2.121454725703587e-02; -1.781861254092328e-02   +3.624827694026099e-02   +3.837954975288312e-02   -1.945414939550553e-02   -4.483164474213552e-02   -4.768345807041052e-02   +5.374784565796573e-02   -3.010112930495563e-02   -3.553610579387693e-02; +1.471210373050800e-02   +2.743760288285547e-03   -3.595366696707218e-02   +2.611998227404343e-02   +4.868216383614061e-02   +2.114693580544898e-02   -2.636841514771303e-02   -6.711040863598468e-04   +7.619315795854762e-03; -1.793932421365830e-02   -2.415029454111511e-02   -5.026184600630643e-02   +1.045332555802296e-02   +2.308915487429974e-03   +2.663593105933561e-02   +3.019174128944334e-02   -3.521635840120173e-03   +2.112243998365359e-02; +9.118336522687818e-03   +4.288288144979470e-02   -7.207476877580183e-03   -4.280787722310261e-03   -5.323859758132972e-02   +1.706846762959536e-03   -1.822479539967401e-02   +3.815932261581733e-02   +4.039794422140446e-02; -2.274365317393873e-02   -5.190970023524850e-03   +7.073570200303038e-03   +2.250345888528801e-02   +3.138385713302051e-02   +6.758288791914032e-03   +1.460283661204088e-03   +2.034852032337808e-02   -4.166078894090436e-02; +2.612396174673039e-03   +4.687458326159653e-02   +1.069560447129351e-01   +2.398104324081697e-03   -9.633996056086284e-03   -3.425973506204622e-02   +7.262514097737323e-03   -1.289956349322425e-02   +1.576924092506506e-02; +1.009941895015050e-02   +3.280953615348385e-02   -8.021644688597788e-03   -1.989747768392810e-02   -5.138033604684106e-02   +1.699968074801113e-03   +4.818236226569535e-02   +1.718758832842102e-02   +1.970029666626104e-02; -3.453660666463813e-02   +1.950394590774793e-03   +2.723790115475730e-02   +2.526009335695217e-02   -2.109408141134814e-02   +2.087535881852283e-02   +4.346478587396778e-02   +5.011989270220112e-03   -3.513446720604613e-02; -1.873826323098994e-02   -2.622487636619175e-02   +2.552434921941057e-02   +2.178702516947455e-03   -4.284031058691495e-02   +6.339275117892165e-02   +3.183924283825425e-02   +2.230484718655910e-02   +8.265489981963403e-02; +4.833670484676869e-02   -1.112327693917254e-02   -1.726146712189770e-03   +1.375680005933155e-03   +3.752182044988905e-02   +1.715229476858501e-02   -7.712632019922179e-03   -6.029523488951352e-02   +5.736119173299412e-02];
L4_L1_iGABA_netcon = [-2.701545826755211e-02   -5.704605085725729e-02   +4.025742941713936e-02   +4.031614618823752e-02   +2.958601108783733e-02   +3.227047612761767e-02   +2.219936172663420e-03   -3.439398454984222e-02   -2.019667375388962e-02   +1.980066926773932e-02   -3.933423605425276e-02   +4.608929057688071e-03; +1.221529558450619e-02   -6.497538831981493e-02   +9.238541427011572e-02   +2.545883228879219e-03   +2.172289426382576e-02   -1.648671965103369e-02   +5.872683922343626e-02   -2.090456313579931e-03   +2.342039445392556e-02   +3.888615281307305e-02   +4.768323430337946e-02   -2.902636682177289e-03; +1.165645378837191e-02   -5.043722818311770e-02   +4.473250380941822e-02   +3.803085562809876e-02   +5.384201675220733e-02   +1.896480451185299e-02   +1.080794977840541e-03   -2.018387195721590e-02   -1.949652119747194e-03   +9.111488778212412e-03   -2.675914427888181e-02   +7.595115037826276e-04; -5.272261009629323e-02   +7.327096560411998e-02   -3.197302564691074e-02   -2.733980554605039e-02   -4.599973788572916e-02   -4.045852930162682e-03   -7.649439154913446e-02   -5.630684536047646e-02   +1.738418948182291e-02   +3.072694648186061e-02   -1.457492111720976e-02   +6.630080145549258e-02; -3.295984268172250e-02   +1.534164586354914e-02   +3.723330584026080e-02   +7.419580853170143e-02   -2.045550380397153e-02   -4.310263703018455e-02   +3.797272338223139e-02   -1.449086680250247e-02   +4.217925205503055e-02   -5.199300202382028e-03   -6.360746162165400e-04   +1.995183369531585e-02; +1.605095467210291e-02   +6.133588533346845e-02   -1.551470684519639e-02   +1.822548920191970e-02   -1.820128175915110e-02   +4.053437428954663e-03   -3.841795258138318e-02   -3.811780415073537e-02   +8.870082975170009e-03   +6.242487268191906e-02   -9.239702437952468e-02   -1.742803963826347e-02; +7.917846431913199e-02   +3.248147532075868e-02   -4.015815034647540e-02   -1.366120941707393e-02   +1.873753345835447e-02   +2.970796126082299e-03   +7.612985101474033e-02   -2.176590035022079e-02   +6.282675957612548e-02   +3.624226402471098e-02   -4.582646846884367e-02   +6.272863317785965e-02; +3.921694325238951e-02   +6.794240279456031e-03   -2.135450744707005e-02   -1.850367699913089e-02   -1.464647651319343e-03   +3.647023055395301e-02   -9.196420827333176e-03   +1.365283970711973e-02   -4.964646644346868e-02   +1.842492863664259e-02   +4.524659039502013e-03   +2.959937645997103e-02; -5.088292796772098e-02   +2.003422027147488e-02   +4.329876081291305e-02   +4.782758067982937e-03   -1.699034162509948e-02   +2.351877164927738e-02   +6.738985873885445e-02   +3.029000649403488e-03   +1.509166423332030e-02   +4.105102791759994e-02   -1.739201408301688e-02   -1.792132739430183e-02];
L1_L3_iAMPA_netcon = [+3.659463963641713e-02   +3.049516891599495e-02   +3.163265361258596e-02   -5.531885147449577e-02   +8.033743881388099e-03   +5.483852937150059e-02   +1.830944713944898e-02   +5.614513089151192e-02   -5.692965395446479e-03; +4.427290097285095e-02   -8.819719667312009e-02   +1.055394722831493e-02   +2.748504079042877e-02   +1.973327170183617e-02   -6.242462782415616e-02   -3.774429801487278e-02   -8.083632381497195e-03   -4.776863923750921e-02; -1.351937035397801e-02   +1.713479111889878e-02   +6.145400336958353e-02   +1.315560444863452e-02   -5.668209932257268e-02   -3.370391317217188e-02   +3.158154941751291e-02   +8.032314379273059e-02   +7.774817269853709e-02; +2.088256016295010e-02   -4.690193763174335e-02   +9.343391900608500e-04   -6.671950520754769e-02   -4.644164577251927e-02   +1.181243596808239e-02   +2.863013432048115e-02   -3.733136479207676e-02   +3.876745071023539e-02; +2.080129938896574e-02   +1.670895956352229e-02   -4.704534043372369e-02   +4.162286404936571e-02   +4.862688891605664e-02   -1.035090607137217e-02   +3.611764862385152e-02   -3.340430416955684e-02   -2.635451837737439e-03; +9.620517134737275e-03   +3.100531498297254e-02   +2.493114600338314e-02   +1.161238259484722e-02   -1.534188134786704e-02   -3.518170354365658e-02   -5.762742561515288e-02   +6.675137823709676e-03   +3.253499541605851e-02];
L3_L1_iGABA_netcon = [+8.455432264203752e-02   +8.626000582222439e-03   -1.944299800471365e-02   -1.043271560619199e-02   -1.237289282934535e-02   -7.556300926366329e-03; +2.498936922499224e-02   +2.916910641342781e-02   -5.867174074048397e-02   +3.721204220535658e-02   +1.015341397070409e-01   +5.626884124726110e-03; +4.803169581582071e-03   -4.819566380123767e-03   +5.525889079891712e-02   +4.355815039726851e-02   -1.124527793909381e-02   +5.534654683452082e-02; +1.184222553137637e-02   -1.806059093632409e-02   -5.168843611826704e-02   +3.271528151722505e-02   +4.100111242682826e-02   -1.202805005847369e-02; +1.750761580969970e-02   -1.753462854360058e-02   +5.043903887560837e-02   +1.920135532326473e-02   -1.701600506074995e-02   -2.586484065405157e-02; +1.595204078204922e-02   -1.602540373709072e-02   +7.145049280210974e-02   +2.066784080048004e-02   -1.153295741325982e-02   +9.018121647954042e-02; +9.640471586471014e-03   -6.742077512982069e-03   +6.930310853810984e-02   +5.633224955418750e-02   -4.033671145031539e-02   -5.208016242575066e-02; +5.321579052236885e-02   -5.267794255758438e-02   -4.530014290717173e-02   -5.936748250136709e-04   +2.978766387676731e-02   -3.193910444195727e-02; +9.540272493945495e-03   +1.782980934992859e-02   -2.171730008388312e-02   +1.566272116437484e-02   +2.033734331215964e-02   -3.880665957194639e-02];
L5_Input1_iAMPA_netcon = [-1.753951094076668e-02   +1.399056468386893e-02   +3.364739120165448e-02   -5.161457889486502e-03   -2.247775343678347e-02   -2.258817347554239e-04];
L6_Input2_iAMPA_netcon = [+1.955894386126396e-02   +6.335838035750018e-03   -4.635470508131309e-02   -8.304974451940277e-03   -3.048126390706191e-03   -6.483358791625549e-02];
L5_L6_iAMPA_netcon = [+3.271338001973871e-02   -1.210027095603637e-02   +3.370259048511257e-02   +1.659165780033847e-02   -7.127134565773663e-03   -1.961371019090531e-03; -1.797820799821405e-02   -9.379274355296841e-03   -1.415035343521429e-03   +2.314002005577956e-02   -8.110729344041973e-03   +6.521798688171034e-03; +1.188094395949080e-02   +4.382841451409743e-02   +5.176150921467802e-03   +3.610412023223655e-02   +6.296801404756087e-02   +6.653820108980749e-02; +7.430754810302542e-03   -5.224995220205659e-03   +5.363823680333025e-02   -4.144680419271057e-02   -4.206335809208261e-02   -9.703604635966364e-03; +4.340855116816706e-02   +6.750416018365818e-04   +3.361435402442682e-02   +8.412915908442251e-02   +4.873214700894948e-02   -6.209380117753197e-02; +2.460258756862852e-02   +2.659836156959147e-02   +4.808294134686141e-02   +2.295362995707505e-02   -8.346907997874045e-02   +5.295380844200881e-02];
L4_L5_iAMPA_netcon = [+2.208214151483437e-02   +1.310567411411598e-02   -2.830523793186526e-02   -3.428892983187343e-02   -5.179786887015035e-03   -2.595507540787714e-02   +2.670659016236943e-02   +8.475669532863560e-03   +4.289193944036386e-02   +4.908836328569857e-02   +5.865472472983250e-02   +1.990346186497276e-03; +1.745901304538972e-02   -3.374397766866549e-02   -5.211007458679894e-02   -3.106596755082083e-03   +4.034619384746960e-02   -4.245538171793194e-02   +2.695521480691994e-02   -3.566140045707773e-03   +2.839589194309746e-02   -6.202147405340983e-03   +7.156735073675667e-03   +1.367256243123920e-02; +2.110092534658201e-03   -3.690451737222334e-02   +7.196530670410592e-02   +3.453934492229699e-02   -2.047980231838792e-02   +6.736548763326822e-02   -3.687033762052182e-02   +1.863644917289690e-02   +4.802724881117244e-02   +2.393615424206181e-02   -5.021264051144017e-02   -9.026044990885416e-03; -2.955110166385555e-02   -1.402582110077742e-02   +3.935430179213772e-02   -8.695499295493840e-03   +5.489506962466882e-04   +4.498823084904294e-02   +2.044941428672754e-02   -3.417745447868482e-02   +6.407260641363025e-03   +3.521880613275383e-02   -1.554115693542021e-02   -4.710963987994587e-02; -1.248434057418834e-02   +7.358940228842401e-02   +5.836862253609218e-02   +3.578823625973330e-02   +2.330197178285711e-02   -2.683005035371639e-02   -4.609425133759877e-02   +1.290448728622725e-02   -3.789869843786223e-02   +4.485141737342185e-03   -1.421987813574212e-02   +2.950075120221421e-02; -6.301112544566322e-02   +2.080694773277797e-02   -3.487811230707789e-02   -3.224051606115139e-02   -6.156266939571016e-02   +9.516205993101023e-02   +4.396181899477836e-02   +7.670611930517917e-03   +3.382945635474419e-02   -4.665722225809000e-03   +1.692798296816322e-02   -9.140422873021138e-02];
L6_L4_iAMPA_netcon = [-2.380623799506959e-03   -3.539183339756837e-02   +9.772575156900103e-03   +1.105670815334019e-03   -6.681856646768534e-02   +2.037294679620891e-02; +2.965028320477837e-03   -1.226836252228386e-02   -4.326100338216259e-02   -3.678478018066532e-02   -3.910292140986635e-02   -3.951865937922825e-03; +2.767936983404697e-02   +4.375644205496265e-02   -1.697398807234306e-02   -2.178795662698384e-02   +1.701455109912227e-02   -3.662885139910634e-02; -8.299412166536232e-02   -4.046247614364607e-02   -1.263479560629590e-02   +5.287923261131994e-02   +5.423054472334787e-02   -8.737527435933561e-02; -1.667499545520484e-02   +3.470793252707120e-02   +3.442286811423890e-02   -6.775115270590940e-02   +6.341676855071456e-02   +6.270649481294088e-02; +1.014830208270088e-02   +4.357246834177091e-02   -8.791586028506108e-03   +3.374962525545515e-02   +2.264366295359951e-02   +1.727327010747009e-02; +1.777387597620245e-02   +7.281496015665301e-03   +2.501300797251150e-02   -2.692911672258602e-02   +9.130295616400630e-02   +8.621648910830958e-02; +1.482317573522517e-02   +1.739243086093967e-02   -1.210083929558546e-02   +2.485124605436021e-03   -1.764000600788901e-04   +7.595836491730288e-03; -3.089613747196640e-02   -2.294087303097907e-02   -3.876305922186782e-02   +2.365658500263512e-02   +1.025771769607454e-02   +4.002622290023714e-03; +3.234001688169332e-02   +4.349380151633172e-02   -1.990581307262709e-02   +1.102725754967811e-02   +1.948361649318275e-02   -5.256145832610230e-02; +2.589618039149821e-02   +4.745889360264642e-02   +5.401109752010934e-02   +3.632017538551498e-02   +3.652921210842814e-04   +3.511069276531417e-02; -1.016276098154321e-02   +3.810709542764323e-02   -3.131520054261586e-02   +1.849838130209203e-02   -4.049108471094033e-02   -4.139947013127102e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
