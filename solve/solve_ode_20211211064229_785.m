function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.377226248114754e-02   +3.934103189286037e-02   -3.580613313750122e-02   -2.418669107253794e-02   +1.450528728228287e-01   -1.581374463593613e-02   +3.632282062561476e-02   -5.530517791460683e-02   -7.036127243217162e-02; -3.392635268545629e-02   -3.141550814945547e-02   -1.987326935357549e-02   +6.381808378268577e-03   +1.182090471372726e-02   +1.138428084204181e-01   +6.763495563347346e-02   +5.460164293900963e-02   +1.172687753268962e-01; +2.818007403338381e-02   -9.165592067935610e-02   +1.298618915814297e-01   +4.419167587201674e-02   +4.670725740306964e-03   -9.063955807146024e-02   +6.174416157047304e-02   -2.968845826608947e-02   +2.549965727534905e-03; +1.199057971208542e-01   -3.774056176274992e-02   +7.347914785011353e-02   -8.485052888360844e-02   +6.684623271629615e-04   +1.968059133183679e-02   -4.627442987053233e-02   +6.045460024771879e-02   +1.370631541363804e-02; -1.768934063497894e-02   +7.155869820080256e-02   +8.339268145732948e-02   -1.324785913468895e-02   +6.521938567846813e-02   -4.132748960315362e-02   +2.636949674766607e-02   +9.165376063036930e-02   +3.681865590713961e-02; +8.149295203018074e-02   -3.728433476035043e-02   +7.223590461742094e-02   +5.383160503663234e-02   -7.634524033921959e-02   +8.407203473629579e-02   -4.958076537942131e-03   +1.073430925827972e-02   +7.655253652943475e-02; +1.160493299418682e-01   +2.914805948253298e-02   +7.783613166344322e-04   +1.415371089401184e-01   +3.892010770709811e-02   +9.429112397698024e-02   -6.312380449711968e-03   +1.313675141838185e-01   +4.940952932602474e-02; +1.117143301876351e-01   +1.021847832030764e-01   +4.485477595140033e-02   +4.589628554675720e-02   -9.097503292878593e-02   +2.779259257671206e-02   +6.203262657463092e-03   +5.729135788235674e-02   -4.962991067826628e-02; +9.665941981857980e-02   +1.840266502005107e-02   +8.802910306805425e-02   -5.930491655527921e-02   +5.881541533248172e-02   +3.454920631728709e-02   +8.144645199226941e-02   +4.037734604515709e-03   +5.366854281197354e-02];
L1_L2_iAMPA_netcon = [+1.026954812142346e-01   +5.456515496469122e-02   +1.345928766230046e-01   +2.620530927212381e-02   +6.682346015122073e-02   +1.046587844123417e-01   -1.847045135310340e-02   -3.925642492270353e-03   -2.069215227617323e-02; -5.446523898255429e-02   -2.540551083006897e-02   -4.572245287094541e-02   +3.454826462569413e-02   +8.011082065552320e-02   -3.949196010000910e-03   -1.706733580934098e-03   +4.656127854253587e-02   +1.543200300668338e-02; -4.178873391494054e-02   +2.495345965906697e-02   +1.282064582246940e-01   -2.112738497489037e-02   +1.117908643352608e-01   +3.832549207491171e-02   +1.310703862359546e-01   +2.959258288773647e-03   +2.804850488548336e-02; +1.935127462752913e-02   +1.026890707144682e-01   -1.417625666964911e-02   +5.194776998158810e-02   +7.118337144474804e-02   +6.767685066194297e-02   -9.584266370243730e-02   -7.231906168480157e-02   -1.176495528255910e-01; -2.188241280487285e-03   -8.263276997698828e-02   +1.086407914966382e-01   +4.136969007952164e-03   +9.178336069143843e-02   +9.655799185078213e-02   +1.222587674341734e-01   +3.267895875184511e-02   +1.647128828779246e-01; +8.645088809740055e-02   -2.203409241781411e-02   +5.600985211548566e-02   +8.567865177779554e-02   -2.886589669164653e-02   -3.086701135713846e-02   +8.290881352955777e-02   +8.918286362813101e-02   +1.471964888128019e-01; +5.570349154284186e-02   +3.109697703522336e-03   +1.022776111119139e-01   -7.200874679807595e-03   +6.542104382896514e-02   +4.972254257110058e-02   -5.933088774080327e-02   -2.570797056833909e-02   +4.620271491771234e-02; +8.406970349401326e-02   +5.667838004840788e-02   -1.322624682359998e-02   -4.329311713188268e-03   +3.519744109435724e-02   -1.818963976573409e-03   +7.183862770193980e-02   +9.711217479755559e-02   -5.280113817070432e-02; -2.446270274044684e-02   +1.060047560369655e-01   +1.942079690029685e-02   -4.289966855815434e-02   +7.878219102964480e-02   -5.233454119310084e-02   +7.900169891133994e-02   +8.566311633008947e-02   +8.938914231088883e-02];
L2_L5_iAMPA_netcon = [-5.197796831235432e-02   +4.972252498503842e-02   +1.112683141155084e-03   -3.757130656337342e-02   -5.292241534258806e-02   +4.969375560240696e-02   -1.885787060150865e-02   -8.330593389006939e-02   +6.484021953228199e-03; +9.119421243724360e-02   +3.450042859936453e-02   +6.753962005526384e-02   -9.458525989811303e-02   -6.797086750364785e-03   +4.206976333105140e-02   +8.428118010950195e-02   -2.179132579569019e-02   +6.500990406649040e-02; +1.427990420929979e-02   +7.267804823849312e-02   -1.719684119873714e-03   +8.592254884465236e-02   +1.281510414611194e-01   -9.924164635469865e-03   +2.039157578499313e-02   +8.090614582607561e-02   -1.227493054803960e-03; +3.571459202823760e-02   +1.190247278640598e-01   +1.323601875505905e-02   +5.742164651958730e-02   -1.808217240229280e-02   +6.513340876657051e-02   +2.272289924645567e-02   +9.138367663433317e-03   +4.921718471926424e-02; +3.524485075126871e-02   -2.377978570415774e-02   +9.737325345242465e-02   +6.313710993344530e-02   +8.707285727188818e-02   +9.914298209924363e-03   +9.496309682303170e-02   +6.603119361615961e-03   +1.746129874336401e-03; +8.452174209822447e-02   -8.360120118465185e-02   -3.042152934616110e-02   +5.315047041369850e-02   +1.325940846810473e-02   +3.148123549630041e-02   +2.523309565155707e-02   -1.737381467046796e-02   +3.147777956112893e-02];
L5_L2_iGABA_netcon = [+1.881848964741577e-02   +1.798893973557310e-02   +1.251411489517031e-01   +1.519564403753412e-03   +1.552725046811942e-01   +4.904283678616064e-02; +5.832177467585933e-02   +1.065096118429024e-01   +6.809890059421289e-02   +4.886401001817567e-02   +4.292093783413003e-02   +1.179126774201353e-01; +1.012901662113718e-01   +1.253462100537019e-01   +1.739905594778597e-01   +5.804268341316194e-02   -2.409072986803905e-02   +5.838709633751633e-02; +7.001018450756710e-02   -1.131338562132282e-01   -5.538236281370423e-02   -1.345379880496994e-02   -8.110407627402229e-03   -2.178561472407826e-02; +5.748066378862694e-02   +1.048907850812149e-01   +1.147444389598699e-01   +1.630528146637000e-02   -5.922982343814649e-02   +4.430013422103105e-02; -9.761560341848960e-02   +7.103974070437120e-02   -1.594747916163610e-02   +8.874955903169920e-02   +4.475467726791035e-02   -1.028924485286574e-02; -4.155296802807432e-02   -6.375911216402780e-02   +4.195731203513287e-02   +4.570663278838055e-02   +5.012116567893599e-02   +1.049203484606281e-01; -5.000947389991441e-03   -1.757676276031454e-03   +1.310417451918812e-01   -3.115380047851111e-02   -3.234546946683425e-02   +1.670523927857175e-01; +6.310023433396136e-02   +8.441323181951929e-02   +2.222592783491426e-02   +3.909289421821585e-02   +4.529704208257077e-02   -1.246971714991135e-02];
L3_L2_iAMPA_netcon = [+4.963697782764540e-03   -7.955242539587835e-02   +1.207511944909072e-02   -2.437936171448917e-02   +3.848768455084879e-02   +8.099735574928800e-02; +2.345587032127545e-02   +2.256066219570506e-02   +3.686830431492981e-02   +6.494990195133393e-02   +3.054734121867700e-02   -6.571078669511980e-03; +2.946254993532604e-02   -4.073084249281141e-02   +4.717765933282954e-02   +1.316410089505990e-01   -4.711269920434191e-02   +3.851486266280271e-02; -3.524232442972605e-02   -9.658607540980119e-02   +1.751560754864137e-02   +6.916705444225309e-02   +2.260586267241387e-02   +2.989130501815800e-02; +1.014408922289333e-01   -4.075820600080042e-02   +2.451690882655102e-02   +5.330277142238134e-02   +2.888945827978110e-02   +1.028210561429145e-01; +1.041719024648085e-01   +4.654713298616243e-02   +2.128026742603251e-02   +8.506827431497173e-02   -9.715248310864080e-03   -4.671730150745182e-02; +1.109307678632650e-01   -4.718043978661685e-03   -2.541861273755754e-02   +1.077658234346623e-01   -1.466276078270100e-02   +4.099447264773889e-02; +3.687360316341785e-02   +6.498879549748561e-02   +4.274387094174666e-02   +4.412919645223376e-02   -6.819957553169406e-02   -5.645819415894773e-03; +8.620594565021225e-02   +8.265730629732330e-02   -8.430143500497446e-02   +4.048955483413008e-02   +1.345902834576389e-01   +5.196368911404892e-02];
L2_L3_iGABA_netcon = [-1.993491213779901e-01   +8.178867468323427e-02   +8.433188361431646e-03   -6.471181680298598e-03   +5.093018532369369e-03   +7.122357082336285e-02   +4.134005505619265e-02   +3.144730413136017e-02   -1.373509820697652e-02; +5.435252202997456e-02   +2.830361374971127e-03   -1.393242578957046e-02   -3.587556749103771e-02   +1.526595355052008e-02   +1.145752873389627e-01   -2.396508274047027e-02   -2.851437919529054e-02   -6.279050196337481e-02; -2.032091240167936e-02   +9.682194152595336e-02   +7.168450349364583e-02   +2.839583183413704e-02   +6.725334175405857e-02   -1.211891363959515e-03   +9.605408582346409e-02   -9.193874628147448e-03   +7.633340010327160e-02; -3.988919087444986e-02   +2.859681132462877e-02   +1.742763012361959e-02   +8.287016674423327e-02   +1.231716807346753e-01   +4.652948855696076e-02   +7.374339112207848e-02   +9.851964391634030e-02   +7.015582387830815e-04; +8.250642073218470e-02   -9.026345865456084e-02   +4.186853361747460e-02   +1.107206829798208e-01   +5.287252381664169e-02   +7.850028182033468e-02   +1.066828729152623e-01   -7.924193544407221e-02   +4.364838477698343e-02; +4.343403077717455e-02   +5.243116076393672e-03   +5.058534661241810e-03   -2.545437933520557e-03   +6.741478934810227e-02   +1.133891850799079e-01   +8.453759345870861e-03   +3.984179765708050e-04   -1.923841209399942e-02];
L1_L4_iGABA_netcon = [+1.057861625151923e-01   +2.624344821535539e-02   +1.445554069514806e-02   +4.219368034695573e-02   +7.255866434530699e-02   +1.650130258987409e-01   -8.786118587195760e-02   +5.708571078972337e-02   -6.436600244183255e-02; -7.215496335747003e-03   +4.054222118730205e-02   +6.606050687241986e-02   +4.980290382760115e-02   +4.280351021813152e-02   -8.065157989708895e-02   +2.932621563238386e-02   -1.925814453882914e-02   +6.109871742296005e-02; +7.216982829664284e-02   +6.363862935925585e-02   +1.325462911016102e-01   -3.318863510378351e-02   +4.710528424929397e-02   +8.160397645273178e-03   -4.348428258709736e-03   -6.226086200461411e-02   +8.059758144700384e-03; -2.638953395991171e-02   -4.664038815152256e-02   +3.993025590376145e-02   +3.119815397086299e-02   +3.937797750179844e-02   +1.105302807104277e-01   +1.935367457467883e-02   +2.569898448400203e-02   +9.556243535643241e-02; -5.740395710344733e-02   +1.056504434154771e-01   -5.866464212929660e-02   -1.218073062043588e-01   +8.048541212140034e-02   -1.410634597608964e-03   +2.683410113936507e-02   +8.924995145897839e-02   +4.749035939742854e-02; +2.331000049623343e-04   +4.636409525210083e-02   +9.065125720713937e-02   +5.517356000047107e-02   +1.025236642146784e-01   +8.676237838399924e-02   -2.295286154307682e-02   +3.285888141025591e-02   +1.009928528310311e-02; +6.956688733620986e-02   +7.724169804729662e-02   +4.728814180740150e-02   +6.249995344250722e-02   +8.625178146282850e-02   +6.917649735027850e-02   +1.240290759600061e-01   +1.394981445461404e-01   +9.597253750368049e-03; +9.255045007665809e-02   +1.219139335924011e-01   +4.696463460737368e-02   -1.651263448918244e-02   -8.145812639186049e-02   +3.478412004596169e-02   +3.335382209278462e-02   +8.530075396396272e-02   +8.855205639224673e-02; -2.406624026654884e-02   -1.509554754810796e-03   +2.656904408425028e-02   -5.851253991548883e-02   +5.052582965859498e-02   +1.196591325285415e-02   +5.677165701094401e-02   +5.030603405887928e-02   -2.971200748207183e-02; +1.710960108316999e-01   -1.542564662540386e-02   -2.032887699107105e-02   -7.809228459786120e-03   +4.264947720572160e-02   +5.737757518703918e-02   +1.266694538882895e-01   -6.341164511298257e-03   +3.060027801595726e-02; +9.402655215190936e-02   +3.899266877789804e-02   +4.384421319458912e-02   +7.202419071106819e-02   +2.041120612660980e-02   +1.834131333390662e-02   -3.233221446059628e-03   +3.888559717038569e-02   -1.439001544363701e-02; +1.004332283910265e-01   +1.448303121242627e-02   -1.466617977853360e-02   +1.100071311000687e-01   +2.904145559011705e-02   +7.337570665622937e-03   +4.854700152795623e-02   +1.085797327012738e-01   +8.701970396269242e-02];
L4_L1_iGABA_netcon = [+7.834024332895331e-03   -2.181509779454863e-02   -2.049146932900030e-03   -2.360344253343342e-02   +1.101318690417104e-02   +1.003097634725609e-02   +2.034171002046505e-02   -1.189030660834774e-01   +5.595234811656442e-02   +4.909203667875991e-02   +1.000826789171967e-02   +2.537986286690843e-02; +9.906095431145251e-02   +1.117353702055402e-02   -5.008248162383246e-02   +3.000725332013548e-02   -1.035135978340817e-01   +6.090250489454874e-02   +6.111271219402416e-02   +4.884452509354172e-02   -4.796907297462398e-02   +6.962520111390691e-02   +1.793988432435221e-02   +5.792546290421714e-02; +1.467140425644671e-02   +6.223354012703888e-02   +6.525826541136308e-02   +3.212959603952156e-02   +1.667555827060321e-02   +7.606047824293731e-02   +4.042219899816650e-02   +5.130468794756362e-02   +1.285238142090320e-01   +1.644307336174517e-02   -6.178662299324254e-02   +1.632132317080093e-01; -3.783511350615364e-02   +7.711128386970054e-02   +8.648039662306792e-02   +3.255809229091259e-02   +6.721720594543559e-02   +5.156479999027500e-02   +3.922988034505169e-02   +8.073302101004623e-02   +3.553420505683274e-02   +1.235438811165707e-01   +1.093898317367276e-01   +4.512623509053058e-02; +5.191111247719259e-02   +1.059971150261735e-01   +6.248953983832466e-02   -3.273060796246075e-02   +3.023916308589463e-02   +1.216878822210311e-01   -9.766525641288476e-02   +1.074017340277170e-01   -5.950600972363696e-02   +7.422413989604987e-02   +4.882364006524959e-02   +6.878550507274238e-02; +3.068434198962734e-02   +8.092930767067170e-03   -2.295024983068093e-02   +1.048764569803347e-01   -4.966960172633695e-02   +8.351535132705785e-02   -9.251745120604879e-02   +2.892595030073378e-02   +4.681674030598384e-02   +9.865879282317415e-02   +2.654485808837655e-02   -8.536921727011322e-03; -3.149705199033925e-02   -3.929858835500220e-02   +5.920561239287329e-02   +1.127860277159831e-01   -1.247249897721856e-02   +1.117433829456178e-01   +1.115624818140543e-02   -9.604126418193457e-02   -1.339743580564095e-02   +8.157262856652403e-02   -1.767379878155661e-02   +2.263343570260895e-03; +9.124242440328902e-02   -1.247164479410509e-02   +9.219253369023127e-02   -1.763208364147965e-02   -3.108232523502057e-03   +3.384890907839251e-02   +1.152862877265975e-01   +1.011809059203471e-01   +5.581045249668631e-02   +6.065323430187026e-02   +1.231770938314533e-02   -2.552141882875483e-02; +1.318459376440727e-01   +7.299349624017247e-03   +1.461368885136019e-01   +8.301621206191424e-03   +1.279293988158182e-01   -2.970365016990559e-02   +8.065696775337607e-03   +1.200005771134552e-02   +1.473786930626189e-01   -6.530500921134649e-02   +3.161887115951231e-02   +9.866425911664686e-02];
L1_L3_iAMPA_netcon = [+8.447911311391626e-02   +1.364821399553003e-01   +6.552849850959074e-02   +9.274597465585697e-02   +1.320430990407090e-03   +6.010170216759001e-02   +1.318104155828488e-01   -6.276371268779873e-03   +4.560076401742050e-02; +1.979783023167738e-01   +1.149854434603686e-01   +6.087157829847614e-02   +1.597323214328027e-01   +3.504952996704690e-02   +2.984512639024526e-03   +1.630583333998475e-01   +6.208789389261622e-02   +1.243292052566421e-01; +1.060028397827831e-02   +4.123657164528120e-02   +1.073880132284651e-01   -3.808297200228404e-02   +4.077628942138724e-02   +4.339501248128523e-02   +1.280122376895304e-02   +5.219390464604408e-02   +6.213192884028881e-02; +1.365371563789091e-01   -8.879806347422914e-02   -6.667821858479590e-03   -7.112883547397819e-02   +1.843569919771793e-02   +3.042187795377914e-02   -2.275836481661150e-02   +1.291847762317203e-01   +6.889047309121285e-02; -2.392967856936559e-03   +7.552954620156827e-02   +1.460690385768780e-02   -1.309668358276727e-01   +9.860197415612833e-03   -2.198773602145574e-02   -1.735689912673975e-02   +3.053163570021949e-02   +3.549082682757829e-02; +5.117016380131478e-02   +1.156956440847580e-01   -2.760561648676589e-02   -3.057883652889715e-02   -4.053310130428632e-02   +6.791946218543697e-02   +2.896761293736362e-02   -1.348584990474341e-02   +9.543688156574169e-02];
L3_L1_iGABA_netcon = [+3.599355156498616e-02   -2.489433752626003e-02   +1.156144717427839e-02   +2.321360878843631e-02   +4.413044007047253e-02   -4.376505806685013e-02; +1.115631142642116e-01   +6.536343631456916e-02   +6.511165307129567e-02   +1.146415129031820e-01   +3.462886454148172e-04   -4.978851565742796e-02; +2.316139910691174e-02   +7.501215462927149e-02   +1.659404330396519e-02   +2.917836684320085e-02   +5.791345196742299e-02   +4.460357220068238e-02; +1.206916924843178e-01   -7.659211120030802e-02   +2.438760025615090e-02   +7.188304969204189e-02   +1.035228190000511e-01   +1.210549274579508e-02; +9.127847364110740e-02   -5.187627043494047e-02   +2.965185422012523e-02   -7.208744569909856e-03   +4.700956804247484e-02   +3.665425972074978e-02; -5.018390238902379e-02   -1.562942008157452e-02   +3.791853525703318e-02   -3.261016739960115e-02   +3.637073849055453e-02   +1.098757520057972e-01; -2.754377488902777e-02   -2.696785928131430e-02   +9.431776572918073e-02   +5.353654944524141e-03   +5.563629174498410e-02   +8.856175796945175e-02; +6.023730838661409e-02   +3.363095446920747e-02   +8.313816564217204e-03   +2.257006141197829e-02   +4.743910711895627e-02   +1.219573415544196e-01; +5.095592816558599e-02   -3.832841675774262e-02   +4.976481695933048e-02   +1.648097622873093e-02   +4.389386214251956e-02   -6.823718966471060e-02];
L5_Input1_iAMPA_netcon = [+5.268204713449947e-03   -4.994569604563901e-02   -1.375739364370922e-02   -7.148829353191308e-02   -7.633793001522136e-04   +7.637797292155597e-03];
L6_Input2_iAMPA_netcon = [-5.308862992682109e-03   -1.303420214390831e-02   +9.100465394160967e-02   +5.882397278961990e-02   +4.587557254898444e-02   -8.760593767437187e-02];
L5_L6_iAMPA_netcon = [+3.703098442961944e-02   +2.056691290882144e-02   +3.979409638769200e-02   +6.485640996963393e-02   +5.175844608880166e-02   +5.239026061433381e-02; +7.396000424478814e-02   +1.208552265923518e-01   -4.821948712357601e-02   -1.013529840872015e-01   +1.208641229960146e-02   +3.320672964172058e-02; +3.536115742258303e-05   +9.313340235327644e-03   -8.730600439050752e-02   +1.159799295831773e-01   +7.555386250791259e-02   +5.048202218318678e-02; +3.676302279695901e-02   +8.205301234409731e-02   +5.835990508137917e-02   +2.078909459790801e-01   -2.869307785455573e-02   +1.159863239424460e-02; +7.812196747800637e-02   -7.917320257807316e-03   +1.084755613060275e-01   +1.170197427338232e-02   +1.271207901751520e-04   +4.190644912406270e-02; -4.099469169851029e-02   -1.394723739288893e-01   -5.341416228106591e-02   +1.366787656809660e-02   +5.991834012394558e-02   -1.503013150807637e-02];
L4_L5_iAMPA_netcon = [+7.233184225276658e-02   +3.104605862749048e-02   +6.922209642096379e-02   +1.255025454415914e-01   +2.150278929510589e-02   -5.296045494476113e-03   +8.274063998019422e-02   +1.357562599253771e-01   -4.265203210673577e-02   -7.832337070640771e-02   -2.827121835928264e-02   -1.301621799453424e-02; +7.016254373669728e-02   +5.467428008244712e-02   +3.316309342916179e-02   +9.231504769207632e-02   +1.044516111854155e-01   +4.884406339118114e-02   +6.960272607599288e-02   +6.881275594631389e-02   +1.273138220554044e-02   +4.476457370698440e-02   +2.413871167784257e-02   +1.561123103840127e-01; +7.470812610879279e-02   -3.136076361998781e-02   -4.483915586054683e-02   +6.097561275531653e-02   -8.387921477434847e-02   +5.355554114298616e-02   -1.211484624527729e-02   +3.467655354540514e-02   +6.417161880945983e-02   -1.094591443892040e-02   +4.452370520112516e-02   +8.802319828613704e-02; +5.868638796368621e-02   -5.825299829670046e-02   +9.690433698223355e-02   +2.182475431958461e-02   +6.313662609242210e-02   +2.399461758580442e-02   +4.882226366082004e-02   +1.265161929417755e-01   +2.304999147481217e-03   +2.145508516901354e-02   -4.513774986079662e-02   +4.599074005255646e-02; +6.227084496140653e-02   +1.071554782726339e-01   +1.082340677515444e-01   -8.611782334891359e-02   +1.180734582179216e-01   +1.351534329899136e-01   +6.435206508833089e-03   +9.634457919734912e-03   -2.912775720361112e-02   +7.032919827558226e-02   -6.903014764227723e-02   +1.294137064447321e-01; -7.202564054656442e-02   +1.590499355819925e-02   -5.762330571314750e-02   +5.086677718771507e-02   +5.212283653284789e-03   +8.889799016463584e-02   +1.558884270837549e-02   +6.455621492345098e-02   -4.582330605715365e-02   +3.220962281395849e-02   +1.276354904950227e-01   +1.010459159113459e-02];
L6_L4_iAMPA_netcon = [+9.932925650415808e-03   +4.130042312335911e-02   -1.239922144356847e-01   +6.183880560935436e-02   +1.668961606947919e-01   -3.666038883316822e-02; +3.735485778610058e-02   -4.363289076610648e-02   +3.107118645573002e-02   -7.673246196105953e-03   +4.982714890503756e-02   +2.876706164460779e-02; +6.228020295909441e-02   +1.391705423299658e-02   +4.038575512515967e-02   +9.467765508752572e-02   +8.995470832671586e-02   +7.126148431179145e-02; +4.282670166984928e-02   +3.516383338754897e-02   +1.658961408659460e-01   +1.115891407818300e-01   +7.950108502018746e-02   +1.057556711383986e-01; +1.861200489919914e-03   -1.143543237943662e-03   +5.204603721873025e-02   -3.466011293467307e-02   +5.698399566103081e-02   -1.363861299407947e-02; -6.096263728311839e-03   +4.427233650280833e-02   +1.693651446469002e-01   +1.076583098646945e-01   +8.010137770641312e-02   +6.197790637138473e-02; -5.949826036622226e-02   +5.299185900633947e-02   +1.653701557028840e-02   +1.079801057654847e-01   +8.462376619029903e-02   +7.252426797674297e-02; -1.386199509090127e-02   +7.721375963588360e-02   -4.711678001291594e-02   +1.185186036985773e-03   +8.050419435177464e-02   -2.045383333234348e-02; +1.552103141609866e-02   -3.192916078485507e-02   +4.346039596436201e-02   +3.834624132708386e-02   -3.703305684483987e-02   -6.513559955806830e-02; +2.152618769840247e-02   +1.146579258675477e-01   +8.389499606908035e-02   +2.300458497187295e-01   +1.648011998618147e-01   -9.669138763438580e-03; +1.473411243397666e-01   +4.661497642216362e-02   +5.027440831668228e-02   +4.179617555846006e-02   -9.215440509842854e-03   +6.272365514160719e-02; +1.092994208134674e-01   +9.946746415111496e-02   +3.328687045877803e-02   +3.595260712327002e-02   +2.019591029029713e-02   +4.770532064179065e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
