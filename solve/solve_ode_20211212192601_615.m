function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.997161855908085e-01   -2.485964219509465e-01   +3.851388459321443e-01   -1.514621539255332e-01   +4.436967782701348e-01   +2.573509858040465e-01   -5.425983883234239e-01   -4.838706206690735e-01   +2.387774980158301e-01; -4.032342638744082e-01   +2.999437697924064e-01   -2.336055000357637e-01   -2.013689348350370e-01   -4.121474655062428e-01   -3.691529025993558e-01   -3.482912323242706e-01   -2.104132599461215e-01   +2.959577931634141e-01; +8.613053343156647e-02   -1.457746165308417e-01   -2.012598862282198e-01   -1.479111063691779e-01   -2.309810548028942e-01   -1.910212962154493e-01   -5.042504401924299e-02   +4.747974019920134e-02   -3.261485619136437e-01; -3.219886119016126e-01   -2.638436199940694e-02   +3.058728195592900e-01   -2.815225262494254e-01   +1.182846946547753e-01   +4.943231208064451e-01   -3.823962338949145e-01   -1.536998266316265e-01   -4.363930829216749e-01; +7.963086258482190e-02   -1.532495072692205e-01   +2.353719548013431e-01   +4.053974384329130e-01   +1.741042189433825e-01   -3.858265578467571e-02   -7.414196557202574e-03   +2.162191002569762e-01   -3.265680727462713e-01; +4.725245365129325e-01   -4.285125870404446e-01   +2.976699921692397e-01   +2.876152794858428e-01   -1.511045168145314e-01   +3.908207487569212e-01   -3.851780492200075e-01   -3.468427756987513e-01   -4.206654589875793e-01; -3.502619895956335e-01   -3.840434948367433e-01   +2.821472236663141e-01   +4.284136716582510e-01   +2.234074556272047e-01   -2.832624990225477e-01   -2.779951451398632e-02   +5.055454746451017e-01   +8.087121476114807e-02; -2.749015467119897e-01   -1.041386821898940e-01   -5.203146222899450e-01   -3.520724412138208e-01   +1.237163855042357e-01   -4.196538458333697e-01   -2.884140681161081e-01   +2.619626793632179e-02   -1.596865915755429e-01; +3.535006049492518e-01   +1.655038902103948e-01   -9.274905194189136e-02   -4.013799799629161e-02   -3.152483113257129e-02   -1.992418877618578e-01   +3.399071986659448e-01   -1.540191378955907e-01   -2.543195446200747e-01];
L1_L2_iAMPA_netcon = [+3.662702130077984e-01   +4.700073716265512e-01   +2.426779899873708e-01   +1.813032091794556e-02   +3.807219445931529e-01   -4.496429761239392e-01   -1.377295611971681e-01   -3.917971092486779e-02   +9.134323659218235e-03; -3.292133449806146e-01   -4.018101476795418e-01   -2.993295043835154e-01   -2.924670814139097e-01   -1.677730484241219e-01   -3.319686192473162e-01   +1.985666068636617e-01   -2.778099479657695e-03   +3.025422949880630e-01; +3.181544794974962e-01   -1.521444663986898e-02   -1.891087845190314e-01   -3.234504411317030e-01   +1.059579669161513e-01   +4.396034807195270e-01   -8.402345532897923e-02   -9.694051606493642e-02   +7.899405722006382e-02; +3.380670826666330e-01   +1.384988827844491e-01   -2.847642460837983e-02   +3.650848458906640e-01   -1.814993278906823e-01   +1.573001280010247e-01   -2.124834329638468e-02   +5.138591368824363e-01   -1.326510278909737e-01; -1.179956332634794e-01   +5.855325114768231e-03   -3.663035014180110e-01   +3.743510435406401e-01   +1.084907498986021e-02   -3.675687026685504e-01   -3.768268997128150e-02   +6.946633230350455e-03   -2.373687610613417e-01; -2.249329625422646e-01   +2.020416326584535e-01   -3.065128000786542e-02   -2.737922184236182e-01   -1.783656592105171e-02   -2.056726105475682e-01   -1.174341310353478e-01   -3.154732389652390e-01   +1.563670809324119e-01; +2.474684087168213e-01   -4.925066976136699e-01   -4.316381098114474e-01   -1.950198258387255e-01   +1.204313212219725e-01   +2.103757770818914e-01   -1.354040601552493e-01   +2.179201305763735e-01   -9.059040410858669e-02; +4.923935480549438e-02   +2.619527119829670e-01   -1.485916078430915e-01   -1.035440009233311e-01   -8.671068001734186e-03   -3.473785781369056e-01   -2.980473793802241e-01   +4.101003097847449e-01   -3.787537925617273e-01; +1.508478959446620e-01   -2.895439398212304e-02   +9.104744446938899e-02   -5.092115990314362e-02   -1.767028013907254e-01   -2.737455406232437e-01   +4.000310083519217e-01   +1.439631914599190e-01   -2.035672997122161e-01];
L2_L5_iAMPA_netcon = [-2.311576228922253e-01   -3.063318097895406e-01   -5.134997491174341e-01   -1.901448021412295e-01   -1.774252798661099e-01   +3.228769395100860e-01   -5.438709773240838e-02   -4.326437262995872e-01   +1.528360126657127e-02; -2.837314349139045e-01   -2.736644968516007e-01   +4.321119122166592e-01   +5.298855185638700e-01   +3.412357039400228e-01   +2.877265884265335e-01   +1.706822166240218e-01   -1.409986460847988e-01   -1.640856529477911e-01; -3.739218431845954e-01   +7.892787690008744e-02   +4.712096622562453e-01   +5.240393590557525e-01   -2.854032507863105e-01   -3.938066816642008e-02   -3.217514094266631e-01   +3.112766609237395e-01   +1.416511092292463e-01; +1.590062507112938e-02   +1.342853516097429e-01   +4.285174746495718e-01   +1.661034589896215e-01   +4.456967736325166e-01   +3.518205940268101e-01   -2.795112540148357e-01   -1.547531908167068e-01   -2.174931433668854e-01; +3.905564866208275e-01   -3.531041703521250e-01   -4.313848205891083e-01   -4.912891205445186e-01   +2.705941326109689e-01   -3.281827712771149e-01   -4.304167718325505e-01   -1.455508491600233e-01   +1.281664555848882e-01; -3.346713451085873e-01   -4.227976601560224e-01   +2.336016318792416e-01   -1.202419963532192e-01   -2.587284553847554e-01   -4.782635526659300e-01   +2.163212394991505e-01   +3.876991196530303e-01   +4.372950715917798e-02];
L5_L2_iGABA_netcon = [+1.560003815162120e-01   +1.767554842988294e-01   +3.782301309156451e-01   -1.207737485239930e-01   -2.603132773771857e-01   +2.321942594851049e-01; +1.856532382494819e-02   -1.414266481399753e-01   +2.532230310063689e-01   -4.455775568830328e-02   +1.692928989636382e-01   +1.845103640270338e-01; -3.985848927883430e-01   +2.735239139378661e-01   +1.277579406072463e-01   -4.040744390840638e-01   +4.320509386944372e-01   +1.649410878336570e-02; +3.381566420936890e-01   -3.928167836121229e-01   -7.656775329496182e-02   -3.019710067947154e-01   +2.777421526769314e-01   -3.313911651664633e-01; -3.334571024171442e-01   +3.223829484824985e-01   -3.439720217303331e-01   +2.085833450136561e-01   +1.515094382185854e-02   -1.827583627095044e-02; -1.311288655775532e-01   +4.240349374380747e-01   -3.996086962523423e-01   +5.276461030959667e-01   +4.491965195765004e-02   -1.375096888139009e-01; -4.915037117894961e-01   +1.636678502804834e-01   -5.749776792231041e-02   -3.893457381338161e-02   -4.056474466472015e-01   -3.461883065161157e-01; -2.717420579976350e-01   -1.933136604172656e-02   -5.950361963388454e-02   -7.512426284579690e-02   +6.149796404193957e-02   +2.574048772683797e-01; -5.004966022812771e-01   -8.161899921279137e-02   -3.365752090192178e-02   +3.445067853907753e-01   +1.289100322081527e-01   +1.666671699571057e-02];
L3_L2_iAMPA_netcon = [-2.798991655752129e-01   +1.392637559313596e-01   +3.025091346972562e-01   +3.154567593954871e-01   +3.189836659408267e-01   -2.539840701709247e-01; -3.726301626029305e-02   +3.067028812896095e-01   +3.128785235816172e-01   +1.190383271338374e-01   -9.263142965648666e-02   +3.284044351236355e-01; +1.153915726471836e-01   -2.222884038809241e-01   +4.069334612544431e-01   -2.349714029090385e-01   -7.960373046024090e-02   +5.140757879310599e-01; -1.116645403801248e-01   -4.258310637529966e-01   +3.360319709819774e-02   -3.645990521182891e-01   +2.539780328680622e-01   +4.273826040448258e-01; +2.263532420699967e-01   -4.290608051071525e-02   -2.328103141161103e-01   -1.211202587219760e-01   -1.047106026551448e-01   -3.703423044020632e-01; +3.500421869946817e-02   -4.737090223330616e-01   -2.850986688364686e-01   -2.826776510779992e-01   +3.932445746682119e-01   +2.370792876603251e-01; -3.798504518876816e-01   -4.242642171223158e-01   +3.742404045386703e-01   +8.100889512295906e-02   -5.684541995874771e-02   -2.303765237044595e-01; +1.840627447539099e-01   -2.962471774732685e-01   -8.987185743544482e-02   +1.710428561975363e-01   +3.137795149925078e-01   +1.275352851758922e-01; +2.465360182800185e-01   -1.113581201813205e-01   +3.057254805186888e-01   -3.135649419886950e-02   +2.877880927761976e-01   +2.291418199497316e-01];
L2_L3_iGABA_netcon = [-3.049055036931595e-01   -2.270275976945628e-01   -4.228688840084919e-01   -1.554117751057260e-01   +2.752358926047090e-01   -3.732417269195819e-01   -2.798228355981928e-02   -3.771532421921666e-01   -9.182370538976301e-02; -3.311293643635910e-01   +1.987463053594134e-01   +4.870029014723151e-01   +4.053320915093498e-01   -3.999475646663467e-01   +3.876684347119011e-01   -1.470887011028578e-01   -1.572496303176914e-01   -1.324561342559689e-01; -1.806522693391906e-02   +3.314307179545728e-01   +2.176879603568943e-01   -2.435500653412724e-01   +1.248954197889279e-01   -3.055453033819764e-01   +3.435472122984754e-01   -1.078494885905260e-01   -3.247601580006079e-01; +2.280649829749068e-01   +4.665247425731936e-02   -2.641628614085694e-01   +3.655368491037332e-01   +3.972309678162552e-01   -3.024741615316789e-01   -2.377012679734900e-01   +3.413555665416319e-01   +4.877314555680932e-01; -4.809060051405037e-01   +4.607734216585115e-01   +2.249127301778032e-01   -9.439830235132554e-02   +1.215172659228857e-01   +1.601762581376520e-01   -9.916893032654613e-02   -3.445741510980280e-01   -2.077715304350128e-02; +1.727160181285626e-01   +3.908343071843396e-01   -8.361022800302395e-02   +4.058939951704069e-01   -5.099490356963122e-01   -3.654489026737119e-01   +1.605089074028818e-01   +1.572597558906192e-01   -3.827996748704717e-01];
L1_L4_iGABA_netcon = [-1.663776892537815e-01   -3.600933105493700e-01   -1.222107047475514e-01   -2.701262010815276e-01   -2.343913076442467e-01   -4.943638584566767e-01   -3.768792484976835e-01   +1.958013507065660e-01   -4.854007360559119e-01; +2.886595131730796e-01   +6.413799060202424e-02   +1.204754390286598e-01   -2.280862770124397e-01   +2.800967095304828e-01   +1.168318873174940e-01   +4.872411974688095e-01   -3.737866219837720e-01   +7.179631803517064e-02; +5.449303570357316e-02   -1.038546842558749e-01   +4.473173757880095e-01   -1.402133223025280e-01   -3.014383013671464e-01   +4.516309305339291e-01   +3.925939311873297e-01   +8.512665868804048e-02   -2.159320544432376e-01; +3.400062746709245e-01   -2.883044010334444e-02   +3.955042601280176e-01   +4.320679678410747e-02   +4.606180116099517e-01   -2.335371245972989e-01   +5.090406319529600e-01   -4.452413548010472e-01   -1.279102175386820e-01; +5.015562702264948e-01   -1.380545127918890e-01   +2.262948747100524e-01   -4.019218490328292e-01   +1.329123463471630e-01   +4.126047746891086e-01   +4.080107962513141e-01   +5.825505763941588e-02   -7.280481438832104e-02; +4.630423106514631e-01   -1.532309273891437e-01   +3.089709581965449e-01   -4.766851599660517e-01   +1.480784911034647e-01   +5.618126137778483e-02   +1.679574671870302e-01   +3.637035055548563e-02   -2.261107789635927e-01; +1.462750400780819e-01   +3.882434891368411e-01   -5.338957447670425e-01   -3.821085795909265e-01   +1.119147855610396e-02   -4.247056488878789e-02   -2.295621109268177e-01   -4.282394668075027e-01   -9.016326604647888e-02; -2.712647563454360e-01   -2.572360589910819e-01   -2.455968647248913e-01   +4.232117487478391e-01   +2.267421262485086e-01   +4.352695177391936e-01   +5.392399837557597e-02   +1.017106177367608e-01   +2.941938942896533e-01; +1.794015300304923e-03   -3.747111648316026e-01   +3.437982396073073e-01   +3.967085677987586e-01   +3.219542774744652e-01   +1.333116388524144e-01   +1.350328909459553e-02   -2.021261705545764e-01   +3.826076244183850e-01; -3.716826938563230e-01   -1.689867604614499e-01   +7.031156572728792e-05   +1.325688002643294e-01   -3.221420467067792e-01   -4.223597710189562e-02   +6.709256033783961e-02   -1.835869169209249e-01   -4.865000297427219e-02; +4.893706460635972e-01   -1.823010052019842e-01   -2.445500244286791e-01   +9.376543210770889e-02   +4.665989817785573e-01   -7.447653315794839e-02   -1.156149348457386e-01   +4.257461689642822e-01   -2.214730011150519e-01; -2.133624888317053e-01   -1.370315385603402e-01   +7.513407787102924e-02   +1.864229523528899e-01   +2.119098935301732e-01   +4.920200394310908e-01   -4.192367152808795e-01   +2.959422962709396e-01   -1.395612592527073e-01];
L4_L1_iAMPA_netcon = [+2.859253997568691e-01   +4.036150004285168e-01   +1.808561791107120e-01   -3.208546936453482e-01   +4.151446264448538e-01   +5.049043645474806e-02   -2.005466011528023e-02   -4.303512867703680e-01   -3.753299043606501e-01   -2.478989408742013e-01   -1.567365304936787e-01   -7.220160852348191e-02; +1.216423807583877e-01   -1.362523117840191e-01   +1.060541777679373e-01   +3.181678445015406e-01   -2.646243954095324e-01   -1.694276621835045e-01   -4.325669892630206e-01   +7.037461650397944e-02   -5.261260750251675e-01   +2.921854655008159e-01   +2.649487371054235e-02   -3.239534308513505e-02; +1.388924295290951e-01   +3.436343975529147e-01   -2.225983007575704e-01   -2.956153998501863e-01   +1.891650321090275e-01   +1.845401151396539e-02   +4.163763423847865e-01   +3.666805625449697e-01   +4.367991226262415e-01   -1.405293789392134e-01   -9.755660695691802e-03   +1.998978162099540e-01; -3.482812209696772e-01   -3.190228976964168e-01   -3.655298158494039e-01   -3.071531705399805e-01   -4.299641347326659e-01   -2.714973254515446e-01   -1.172040020597336e-01   +1.779510814932681e-01   +2.058787220270570e-01   -5.605843601254696e-01   +3.456752241379607e-01   +1.211644061896105e-01; +1.798849772487524e-01   +5.952317646838390e-02   +3.101119767996229e-01   -1.150645168606477e-01   +6.083881145522312e-02   -2.963459915472135e-01   +2.364479765034230e-01   +2.305996532668232e-01   -2.730501490875319e-02   +1.473437672610436e-01   +4.227270967038179e-01   -1.309081000615627e-01; +4.358505099218980e-02   -3.987273562958769e-02   -2.602517100432221e-01   -7.080914157879117e-02   -2.730594671364130e-01   +4.592959887266351e-01   +1.529644755515416e-01   +8.118084993776808e-03   +3.825173827519106e-01   +5.279140432982489e-02   +1.939681557678646e-01   +1.118577557075227e-01; -3.354585390238872e-01   -2.407016360498974e-01   +3.861200125844561e-01   +1.278946647486697e-01   -3.458974523230023e-01   +2.337062690607723e-01   +5.174065414246185e-01   +1.973193631816020e-01   +2.833376947001121e-02   -3.606513048583400e-01   -2.616175778886526e-01   -1.032097257019593e-01; -1.559096548392013e-01   +5.134754360628486e-01   -2.770322838532677e-02   -6.700707516990992e-02   -2.286357309264127e-02   +5.325282131890671e-01   -3.416412511088642e-01   -2.333708976841203e-01   +1.198402695982582e-01   -1.913069330419461e-01   +3.371360885156564e-01   +2.301947813772562e-01; +2.034711787786189e-01   +1.227737265920461e-01   +4.522161302273488e-02   +3.976623498133883e-01   +3.954422542874711e-02   +5.372821333699609e-01   -4.109031875401429e-01   -1.809162326018108e-02   -3.181332097501261e-02   -1.773086500563573e-01   -8.368339437267704e-02   -3.850221134821481e-01];
L1_L3_iAMPA_netcon = [-2.916859633701757e-01   +8.885243680905797e-02   +1.303503298214173e-01   +4.960484649989865e-01   -2.370333471097439e-01   -3.624113230010263e-01   +5.722976933616790e-02   -2.477804387031250e-01   +1.690990411118683e-01; -2.669435550194425e-01   -1.538076095173885e-01   -2.094909022706866e-01   +4.894800386443604e-03   -1.858860040158030e-01   -3.198485584416250e-01   -1.018761632103082e-01   -6.956875977598929e-02   -2.625243233494933e-01; +3.052477901014700e-01   -3.810366472971494e-01   +4.032652352694699e-01   +4.012336361917523e-02   -3.893760092081271e-01   -9.517302322840969e-02   +3.427385446018287e-01   +3.414987980161515e-01   +3.105133236971387e-01; -3.744435454572068e-02   +4.169717825270233e-01   +3.027934905659438e-01   -7.858045300982848e-02   -4.293511924604636e-01   +1.110163640134131e-01   -6.494431149072982e-02   -3.151722013898450e-01   -2.941816745376080e-01; +2.810554589325561e-01   +1.306117689836379e-01   +1.381446405746009e-02   +4.813256801658214e-01   +2.653500822347204e-02   +2.150516901880884e-01   -6.656072160677561e-02   +1.332843504925796e-01   -2.596121919981869e-01; -2.355165549042160e-01   -2.653810443068490e-02   +3.462443044000139e-02   -1.224601679061339e-02   +2.948833749911930e-01   -3.007856448803825e-01   -2.150774053315083e-01   -1.165575283044914e-01   -2.294383777232971e-01];
L3_L1_iGABA_netcon = [+2.158987780463405e-01   -3.183845236194958e-01   +4.618037625694198e-02   -2.850094088906840e-01   +3.472544524556168e-01   -4.106245734057088e-01; -5.721945326401180e-02   -7.175631143278719e-05   +3.625764959062238e-01   -3.290702782289071e-01   +1.201196870993818e-01   +1.845847861057462e-01; +7.966207101890471e-02   +2.614676062351056e-01   -2.851347870603971e-01   +4.707087586659796e-01   -1.501006292089340e-01   +1.853627212651933e-02; -3.584615698701747e-01   +6.422000704443774e-02   +2.518839412414282e-01   -2.999859606301923e-01   +1.119068490380185e-01   -2.016164224940075e-01; +2.162982862670647e-01   +5.318321451259696e-02   +1.676721712012247e-01   +8.928377969526581e-02   -4.351276879669754e-01   -6.906101358102001e-02; -3.579233696237870e-01   -2.358741391816774e-01   -3.503255891923134e-01   -4.291659109221246e-01   -4.620814505162625e-02   -4.252479190346798e-01; +1.827376468029671e-01   -1.641347088382749e-01   -3.491366230115973e-01   +2.744594589805329e-01   -3.554795294094771e-01   -2.994318931261983e-01; +2.072696491690123e-01   +9.235855343471593e-03   -1.572600673167616e-01   +1.082073992279252e-01   -2.548018077058268e-01   -2.153987952007464e-01; +4.141426501463614e-01   +2.454213421576865e-02   +3.107917035258396e-01   -4.119693445710547e-01   +4.209315351102320e-01   -1.392538863226041e-01];
L5_Input1_iAMPA_netcon = [+3.393207294178922e-01   +4.567884288639988e-01   +2.170482642353339e-01   -1.590217977717444e-01   +2.854564106313214e-01   -2.138631981053137e-01];
L6_Input2_iAMPA_netcon = [+4.986774349593302e-02   -4.292864132449254e-01   +3.793172212984790e-01   -4.527411298320152e-01   +2.487879153993220e-01   -2.963049056995374e-01];
L5_L6_iAMPA_netcon = [-4.882220358869630e-01   +2.062873800850353e-01   -3.437969369881076e-01   -7.193274351186846e-02   +3.952201917900365e-01   -3.256349083698421e-01; -6.647652848707525e-03   +1.372763766599560e-01   +3.691593618711991e-01   +3.151039900468234e-02   +6.020902021324603e-01   -2.147580482385376e-01; -8.094065563137312e-03   -4.244518897401795e-01   -1.078854268488010e-01   -4.443473062785977e-01   +1.948210920950487e-01   -3.177469119545424e-01; -1.458508877165773e-01   +1.149610355581299e-01   -1.608677826178766e-01   -1.463177001436722e-01   +2.130812893872382e-01   +1.213169816831796e-01; +1.266070932882432e-01   +9.928820476449812e-02   -1.312713154871790e-01   -1.515895098857482e-01   -4.739695713139787e-01   -1.703832111101275e-01; -5.790439254282113e-02   +2.730036100244050e-01   -1.661155115166256e-02   -2.692789055794033e-01   -2.933882019390920e-01   +4.003134529165696e-03];
L4_L5_iGABA_netcon = [+5.005993781426862e-02   +2.066558201413007e-03   -6.289254233396708e-01   +1.320357219205875e-01   +1.895662126658804e-02   -4.560894641135878e-01   +1.932031956824468e-01   +2.353866906293531e-01   +4.577214736449123e-01   -4.800384731780278e-01   -1.395017913692516e-01   -2.011489376121999e-01; -5.491009052524503e-01   +1.630711296245221e-01   +6.002341207075848e-02   +3.087370747341484e-01   -2.237539142599557e-02   -2.761738367963043e-01   +6.031355244066300e-02   +2.851618234116919e-01   -1.493568071804569e-01   +1.827367789362284e-01   +4.025028322064338e-01   -2.982649504765398e-01; -4.867102427276288e-02   -2.170089339613928e-01   +2.935581188389109e-02   -1.171694452478476e-01   +3.528127790648659e-01   +1.217655368517341e-01   -3.414123116788059e-01   -4.027051508303230e-01   +1.338895837342255e-01   +5.321733985285334e-01   +4.124234807402382e-01   -1.161658572592339e-01; +4.484333422697800e-02   -1.492163370000334e-01   +5.826044067753765e-01   -1.032456408365588e-01   +4.537902552420900e-02   +2.918619496808740e-01   -8.116162733633946e-02   -4.692243659624010e-01   +9.305648526542999e-02   +1.418742367671646e-01   -6.351953013006598e-02   -1.565400220843493e-01; -1.388761734717472e-02   +3.431656730498338e-01   -5.052919066900483e-01   -2.135801903915669e-01   +1.217387753089626e-01   +2.797593172059711e-01   +3.020851600944248e-01   -2.513513756373482e-01   +4.702019770632615e-01   +8.459908274439482e-02   -1.795054290358765e-01   -2.802559015967095e-01; -3.433138941548611e-01   -4.453937793907142e-01   -4.719343747998367e-01   -3.284372829001085e-01   -3.394564773760941e-01   +1.629640624451537e-02   +5.274992209504465e-01   +2.485986086533555e-01   +1.568003743117340e-01   +3.898780105500845e-01   -1.640743138001656e-01   +4.505405602306802e-01];
L6_L4_iAMPA_netcon = [-9.090746987258252e-02   +1.186329087999783e-01   +2.421704210420764e-01   -5.218628075159648e-01   +1.146954785452285e-01   -1.566621900223913e-01; -3.475858946395196e-01   +3.965693853785228e-01   -1.304292543591070e-01   -1.086056071584478e-01   +4.901609066547921e-02   -3.973978303419263e-01; +4.014065136396334e-01   -1.484099557268952e-01   -1.939875964262275e-01   +1.124227324546053e-01   -2.738666154406780e-01   +1.797570636814713e-01; +8.616132676194724e-02   +2.058742550809207e-01   -3.602606234138059e-01   +2.169768763204025e-01   +4.024648057782425e-01   -8.909864810990123e-02; -3.072063669764474e-01   -6.411416702833972e-02   -3.407818086766946e-01   -4.279044952352539e-01   -1.890840310993891e-01   +2.702129097471231e-01; +1.821605388878287e-01   +1.802842390827987e-01   -2.058034411880126e-01   +3.739866412910153e-01   +2.643547304752233e-01   -4.452975525429942e-01; -1.446020444267238e-01   -3.280299301419869e-01   +1.725840383967019e-02   -7.661764166643650e-02   -3.057892164257499e-01   +4.306159201933983e-01; -2.367939187060937e-01   -2.285093917872024e-01   +4.184407874942930e-01   -1.582093435215373e-01   +4.329168975482657e-01   +8.695431384670216e-03; +7.392916079059675e-02   -3.923516170482522e-01   +3.473433683938900e-01   +5.113047055477545e-01   -2.510816339408491e-01   +3.006911228728088e-02; -1.581040672952027e-01   -2.682796832064986e-01   -3.767790641033738e-01   +2.058369500470449e-01   -2.963864431967370e-01   -3.020601777919249e-01; +5.697286610584162e-03   +1.245323216637709e-01   -4.146469747625102e-01   +3.218954230405450e-02   -2.581461552871360e-01   -8.446925122050311e-02; +3.582730997305366e-01   -1.156031757624016e-01   -9.817985716732078e-02   +1.398738345902946e-01   +1.025198164389175e-01   +3.997332185791568e-01];
L5_L4_iAMPA_netcon = [-4.404308728757043e-01   -1.391642544343757e-01   -2.782501366026821e-01   -4.296284568962184e-01   -4.814220455874403e-01   -1.041420074074737e-02; +4.266635232830398e-01   +2.246920278688140e-01   +2.062568350373476e-01   -5.672836356971508e-02   +3.971395732839167e-01   +2.167055083272718e-01; +2.020404676601960e-01   +3.118818255012746e-01   -2.086932354335442e-01   -3.842303601030929e-01   -4.094307269917201e-01   -2.057729963354341e-01; +3.306364153177966e-01   -2.083938540871919e-01   -1.002370719291791e-01   -3.034160279714658e-02   +2.232945739785392e-01   -2.805845802101108e-01; +1.084787268181628e-01   +3.021730586293273e-01   -4.416192018988760e-01   -6.093854633845688e-02   -3.868549926135659e-01   -2.389081304146299e-02; -4.150146818759605e-01   +1.420610648183694e-01   -2.597644254083141e-01   +2.938225708346476e-01   +3.179892341055394e-01   -2.018878446444496e-01; -2.948801099649654e-01   -2.601438699158658e-01   +1.389055590828039e-01   -2.811769585614033e-01   +9.041188677153676e-02   -2.856290880087893e-01; +4.368480416245533e-02   -5.446567313530306e-01   +2.824592630081343e-01   +3.812247011528404e-01   -2.453933430412869e-01   +4.536760191967060e-02; -4.171771715206125e-02   -4.277271257229462e-01   +1.295407130151622e-01   -1.698824226405669e-01   -1.204818402463284e-01   -3.559357819480775e-01; +3.678297417684259e-01   +3.880862067569151e-01   -1.233698088067596e-01   +4.176595081194226e-01   -2.330802478942611e-01   +2.598486980549167e-01; +3.087113803127396e-01   -2.007290719783271e-01   +2.157164180885181e-01   -1.166133667275452e-01   -4.477020902124064e-01   +3.662802930990837e-01; -2.888796000159846e-01   +1.475746582455956e-01   -1.274231869821799e-01   -4.542541892135500e-01   +2.010692697457050e-01   +1.224255878954501e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
