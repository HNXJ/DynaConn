function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.902588584912769e-02   +1.212133913773044e-01   -4.126639406651514e-02   +1.792306698461883e-01   +5.007280820568168e-02   +1.312985196379099e-01   +1.833672393520691e-01   +1.256474997774527e-01   +8.421688395618575e-02; +6.322879428414274e-02   +5.255532591912631e-02   +2.290168812380626e-02   +7.698820819455372e-02   +2.464253515106480e-01   +1.031362715442398e-01   +1.361809684872579e-01   +2.621580193260071e-02   +8.113448492348804e-02; +3.591757618987796e-02   +1.392542363783439e-01   +1.234001622290527e-01   +1.003644471620189e-01   -5.702821954360445e-03   +2.894906913693597e-02   +3.048223189931787e-01   +1.509457692419664e-01   +8.923177456715607e-02; +1.709327263215301e-01   -2.259655747249814e-02   +1.389284593550993e-01   +3.094658822203420e-03   +6.484106557430638e-02   +1.027288213046760e-01   +5.618481676509350e-02   +1.694000412395667e-01   +1.445905395228552e-01; +1.023172905813436e-01   +9.659111698922734e-03   +1.910892262000916e-01   +1.369038324326346e-01   +1.897242699782349e-01   +2.275308058182766e-01   +1.286570034926973e-01   +5.145408202463848e-02   +1.355864478358778e-01; +1.238708522400878e-01   +4.096561094923937e-02   +1.353542317530826e-01   +1.881216119824944e-01   +1.286324321446050e-01   -4.973530628264426e-03   +2.200749833390102e-01   +6.044689832237545e-03   +1.102535127930344e-01; -2.810237534136645e-02   +4.004100086190060e-02   +1.550252724811772e-01   +1.860785012449395e-01   +2.054093750328449e-02   +9.852214303059546e-02   +2.469870684334984e-02   +1.413203779607546e-01   +1.302961623727844e-01; +9.630483232145111e-02   +7.564073171007313e-02   +4.698794910473449e-02   +5.193774843658801e-02   +1.067176285856203e-01   +5.298605379583687e-02   +1.329666894585487e-01   +7.144905285247100e-04   +3.880709178887905e-02; +8.705292776753876e-02   +1.005953290758054e-01   -2.110369956080066e-02   +1.248457126452286e-01   +2.907097373204940e-02   +1.935428213175921e-01   +9.507800771769326e-02   +6.642065660068416e-02   +8.459410482913619e-03];
L1_L2_iAMPA_netcon = [+1.160341504863223e-01   +1.433350704052577e-01   +1.270056304305121e-01   -3.403475682885523e-02   +2.149219990162630e-01   +2.707496901454012e-02   +1.694887724853771e-01   +9.251320094940006e-02   +1.635386124053557e-01; +8.703402217153267e-02   +2.650068757696657e-02   +2.198509107638098e-01   +3.934137048631753e-02   -1.679640865229005e-02   +1.033017751147582e-01   +1.624165987809834e-01   +1.416169660710732e-01   +1.527869420564542e-01; +3.120745824458081e-02   +7.385803265401354e-02   +1.496561068171199e-01   +1.153516289638705e-01   +1.477363681542748e-02   +8.722004774202100e-02   +1.356508680356818e-01   +1.802986929043178e-01   +1.476308052876076e-02; +3.819189142312919e-03   +1.759633913914269e-01   +1.069522031165726e-01   +1.839924207440924e-01   +9.350007508130317e-02   +7.890506829847328e-02   -2.173985349318253e-02   -2.930325448363201e-02   +1.649864689329336e-01; -4.385639120440078e-03   +2.404461193342127e-01   +1.916908481358383e-02   -3.483850837927639e-02   +4.116869444226353e-02   +1.571704749991010e-01   +4.893734052645309e-02   +1.425910047313261e-01   +1.463972942163742e-01; +1.327272253197781e-01   +4.097333864405671e-02   +1.506305066399782e-01   +4.857658125085353e-02   +1.838584872446774e-01   +3.717141493105444e-02   +1.922414129284586e-01   +2.213615100076100e-01   +1.053201075404898e-01; +1.808350897062469e-01   +2.504334236641780e-01   -4.847285839337496e-02   +1.230120914154628e-01   +3.116573268315468e-02   +1.319825185914681e-01   +7.228366295354979e-02   +2.109679493525833e-01   +2.717733279972298e-02; +1.029496251235788e-01   +1.033198959171157e-01   -4.216371596122367e-02   -9.217003734023833e-03   +1.234934460242702e-01   +6.819913949942479e-02   +1.149531638947816e-01   +1.904797826066588e-01   +2.062383988740988e-01; +2.170332122184551e-01   +1.607375609719011e-01   +7.549830256041547e-02   +4.689099666714033e-02   +9.033297536515239e-02   +2.812873553911935e-01   -2.581074368263503e-02   +2.987915548248693e-01   +2.137255138941678e-02];
L2_L5_iAMPA_netcon = [+2.159934569613313e-01   +6.004161441286611e-02   -1.877557917803998e-02   +2.148042427750208e-01   +1.917458425193553e-01   +1.690067860086212e-01   +2.370253472590067e-01   +2.220653315589001e-01   +1.787776351311926e-02; +1.602590138553473e-01   +2.585067771944101e-01   +4.209662651865739e-02   +2.225915364380047e-01   +4.031043998976366e-02   +2.646181685522111e-02   +2.135888410474343e-02   -3.663912353960045e-03   +2.075798274174751e-01; +1.893705665748929e-01   +1.486933437629600e-01   -1.644570468661334e-02   -2.291671706134382e-02   +1.325288235980725e-01   +2.624225387400656e-01   +1.517674276392429e-01   +1.191338424228923e-01   +1.339151755794529e-01; +6.907820030914652e-02   +1.133976043832587e-01   +7.597241127855758e-02   +1.900253254368829e-01   +1.164560128404275e-01   +1.931072115045381e-01   +1.163263980237586e-01   +2.434277918967801e-01   +7.768687555632194e-02; +5.594135636649079e-02   +5.071143780681050e-02   +5.142918176427266e-02   +1.019532092694754e-01   +1.987334270181084e-01   +3.460973166788822e-02   +6.252073013031083e-02   +3.148276622782125e-02   +1.427733675602547e-02; +1.567691955488394e-01   +4.372241269694856e-02   +4.854412241511947e-02   +2.198594578258452e-01   +1.058772192601665e-01   +1.917715901798640e-02   +4.840553242375442e-02   +1.761502506326581e-01   +2.134198583862217e-01];
L5_L2_iGABA_netcon = [+4.449868430027222e-02   +8.769015929667260e-03   +1.534464970501244e-01   +4.065707664103228e-02   +9.943788537391215e-02   +2.569876708037995e-01; +2.153829713351494e-01   -6.085984885328817e-03   +1.707410597916705e-01   +7.360699816267635e-02   +1.504221616271659e-01   +1.977513140662908e-01; +2.830582946888877e-01   +2.021111207411778e-01   +1.447303454777180e-01   +6.210141952665171e-02   +4.950734073239075e-02   +8.003691616596731e-02; +5.943573083709557e-02   +5.077434041841179e-02   +1.033727219428365e-01   +1.409712891304910e-02   +1.422477900013122e-01   +4.459365373269235e-02; +1.064316993458966e-01   +1.560410100851168e-01   +1.458622111904816e-01   +1.251312344571699e-01   +4.273064145028958e-02   +1.498604517761799e-01; +3.092574203870120e-02   +9.026196160969596e-02   +8.440095203370460e-02   +1.469331694983883e-01   +1.219754824074670e-01   +7.007733356523731e-02; +3.424575065138859e-02   +2.529174284884497e-02   +2.125739599595442e-01   -4.627345775967864e-02   +1.914922175864961e-01   +9.196111455760081e-02; +1.747074349816015e-01   +4.546540387651762e-02   +4.911829172172234e-02   +2.291194636072766e-01   +1.229676134038818e-01   -4.485761466326792e-02; +5.974573982675456e-02   +1.198088976337887e-01   -9.379005887685454e-02   +1.716066313587186e-01   +2.560970451144278e-02   +1.368045939457179e-01];
L3_L2_iAMPA_netcon = [-1.651827191596866e-02   +6.538768063119708e-02   +1.087258922802482e-01   +3.484574723198745e-02   +2.386264054351741e-01   +2.118077773125868e-01; +4.516424971153583e-02   +3.228719109247548e-02   +8.125232598590230e-02   +2.650737828206937e-01   +1.073608589659362e-01   +1.079379906348989e-01; +1.315074512807856e-01   +1.046911929142387e-01   +5.957141883780512e-02   -1.176711301248294e-03   +6.246317937771823e-02   +8.851318836074726e-02; +7.717692184669656e-02   +9.854643929147915e-02   +1.813379769784593e-02   +1.269331277999307e-01   +6.936791814069228e-02   +1.933853576601075e-01; +7.175946109285722e-02   +1.980838375142039e-02   -1.039182281560279e-02   +2.245200702183257e-01   +2.371845901418541e-01   +1.908523611144643e-01; +1.713576155257955e-01   +6.559712133594119e-02   +3.872873067434303e-02   -2.194985113948836e-02   +1.012507462889150e-01   +1.520366488978733e-01; +7.386248874985313e-02   +1.490533867914494e-01   -1.132144204752148e-02   +2.798013944991940e-02   +6.075107656956902e-02   +2.703611821178721e-02; +4.919538725556144e-02   +1.768813179026351e-01   +1.800950591226389e-01   +6.927240725802924e-02   +1.338145232631602e-01   +4.431769130067184e-02; +1.397850430891953e-02   +1.791769681770997e-02   +1.197305477656124e-01   -7.591352142238261e-02   +1.519490871377178e-01   +1.227198430652377e-01];
L2_L3_iGABA_netcon = [+1.746933977451642e-01   -2.916984168394425e-02   +1.432702615550785e-01   +1.019886000063578e-01   +1.239049800589239e-01   +1.054021049721268e-01   +1.103291448501227e-01   +1.895632211902872e-01   +2.475776596171630e-01; -3.772407666695690e-04   +2.137060137739800e-01   +1.997054045194869e-01   +1.476942851408910e-01   +1.724090977151752e-01   +6.613074888125040e-02   +7.713984095407903e-02   +1.318617235426879e-01   +1.187385281167577e-01; +5.691254916398091e-02   +2.035824794074608e-01   +1.187667044337787e-01   +1.238801228623626e-01   +2.354471289609940e-02   +1.304538661092380e-01   +2.029332737290656e-01   +6.807928347318212e-02   +9.350776166133898e-02; +2.867976666133416e-02   +1.799210745320001e-01   +5.771042310751402e-02   +1.629620134009586e-01   +1.807667461203305e-01   +1.398925665179728e-01   +5.041320302429866e-02   +1.024748845114926e-01   -3.961658391139586e-02; +1.066151341331037e-01   +9.108510404212278e-02   +4.438667400081184e-02   +1.183616266252734e-01   +2.045492857517540e-02   +1.167875589465021e-01   +3.612176698225498e-02   +8.777807829131308e-02   -2.044742706178410e-02; -7.561707038013569e-03   +1.484920341131108e-01   +2.286931852540898e-01   +1.100751151050034e-01   +1.240071642142723e-01   +1.005103468812202e-01   +9.818842158339267e-02   +1.743763564076368e-01   +2.073976392952262e-01];
L1_L4_iGABA_netcon = [+2.210641976909539e-02   +2.308167295851912e-02   +6.373475692864437e-02   +9.001932510743398e-02   +1.633008781830009e-01   +6.984676711507400e-02   +1.884141915982168e-01   +4.741737718496756e-02   -9.589106125976769e-03; +3.774891362153879e-02   +2.047251161640913e-01   +2.144300399967396e-01   +1.259509792718578e-01   +1.083118080280111e-01   +1.956713250588024e-01   +2.128233370818507e-01   +1.398512822519174e-01   +5.934248901686892e-02; +1.377651115511259e-01   +9.009253339287332e-02   +1.204919681385743e-01   +1.446131405750646e-01   +2.307831436902434e-01   +2.511914038448651e-02   +6.489675052157913e-02   -4.788859131805588e-02   +1.356769000621726e-01; +5.909097650675068e-02   +1.109453185274015e-01   +2.400240473715544e-01   +3.486934618502437e-02   -7.738877275621787e-02   -1.561658529610738e-02   +1.459888995343780e-01   +1.127898027524027e-01   +1.905736386424739e-01; +6.972254827721697e-02   +1.936191143038886e-01   +1.186949488557572e-01   +1.625445371814964e-01   +1.681948546684370e-01   +1.596410060153913e-01   +3.947187347715824e-02   +1.623083430863670e-01   +5.607716664091648e-02; +2.526931634500126e-02   +1.581039281479422e-01   +1.043729274545153e-01   +1.261673489994677e-01   +2.684976337643371e-02   +1.737201518301263e-01   +1.242946493761931e-01   +1.562548794860522e-01   -4.862486234434944e-02; +8.994578627910671e-02   +1.425872901572206e-01   +1.108068076898005e-01   +1.698289000531065e-01   +2.506020621222948e-01   +1.078989580977357e-01   +8.846752357261854e-02   -1.662924545541353e-02   +2.343046365314071e-02; +1.353317797081514e-01   +6.330803436262421e-02   +1.905982417341905e-01   +7.008707024739599e-02   +1.160455627697578e-01   +5.593316746483637e-02   +1.280204682302466e-01   +1.185302799769679e-01   +1.840157645689766e-01; +9.977444740998462e-02   +4.746755833550005e-02   -5.794510802311899e-02   -3.928143747589836e-02   +1.570402506551553e-01   +1.511396355616665e-01   +1.172216332913764e-01   +1.162264916723075e-01   +3.154202384069751e-02; +2.661300450668800e-02   +2.177823318731938e-01   +1.489355593222766e-01   -4.435190273221964e-02   +7.253903304940132e-02   +4.077229261865721e-02   -1.918028229586231e-02   +1.929520011798931e-01   +2.237644712089212e-01; +2.163757229660281e-01   +1.027377020488936e-01   +7.844695861547052e-02   +2.064737310757588e-01   +6.366115217783562e-02   +1.637696593725811e-01   +3.621237507409415e-02   +1.117620557068880e-01   +2.222383788930087e-01; +1.589981025330784e-01   +2.638974542773560e-02   -9.880893676567484e-03   +1.685407715851760e-01   +8.767424412013450e-02   +1.569360656551646e-01   +1.470762669287068e-01   +8.731438877897701e-02   +1.613223852143220e-01];
L4_L1_iGABA_netcon = [+1.293316946841633e-01   +1.206298022359633e-01   +1.539565141308455e-01   +6.643545195677145e-02   -1.165530412137640e-02   +1.580037320199973e-01   +8.767923474191189e-02   +3.496452578384728e-02   +1.666382378116832e-01   +1.483185193746956e-02   +8.703629692373835e-02   +9.196892947761287e-02; +6.030602951101662e-03   -1.557684386853102e-02   +1.329608577342270e-01   +1.118188376983269e-01   +5.095828402423627e-02   +1.103558415152101e-01   +2.890856759377577e-01   +3.433007704664341e-02   +2.922861357646753e-01   +4.490456052071090e-02   -3.333526832062608e-02   +5.276530843120637e-02; +7.502437462779098e-02   +8.925635543827293e-02   +1.381002210072394e-01   +7.542062073549327e-02   +1.476395115134165e-01   +1.201564611275668e-01   +4.600768149666292e-02   +1.473755220057232e-01   +1.897798130503522e-01   +7.250138603130027e-02   +9.496911934682660e-02   +9.915372877366832e-02; +1.595994276431232e-01   +5.450914367559581e-02   +1.368670107240109e-01   +1.051577697291860e-01   +3.875002966106655e-02   +1.991107598473175e-01   -2.529630558744505e-02   +1.372686457508083e-01   +4.539728914357085e-02   +2.051285310667042e-01   +5.369590554097038e-02   +2.569501845157734e-01; +1.792283135275320e-01   +2.979924821841622e-01   +1.335772588312570e-01   +4.641073939665698e-02   +1.502974528181872e-01   +4.944969629137365e-02   +1.140069118563635e-02   +6.593710553305021e-02   +2.431444667715568e-02   +2.500935818495768e-01   +1.545621180585620e-01   +1.445512036498117e-01; +1.126366609562422e-01   +8.023680905080352e-02   +7.015235222989355e-02   +2.208247551979122e-01   -5.142506921116465e-02   +8.042464423396624e-02   +1.452308616992875e-01   +2.683381324396485e-01   -1.389728035094418e-02   -5.087310378141575e-02   +4.534967351950989e-02   +4.351138795737053e-02; +1.259654460058712e-01   -8.674593672689507e-02   +9.215048306759915e-02   +5.957679346026142e-02   -4.211293044384161e-02   +7.140382045844360e-02   +3.331557072836823e-02   +2.048525938560811e-01   +4.700794222951467e-02   -1.319394375419847e-02   +4.889034274291461e-02   +1.765948985345139e-01; +2.604708877870179e-01   +1.070215531780330e-01   -1.486664014033220e-02   -2.421692700998266e-02   +2.135599544234729e-01   +3.290597100578160e-02   +1.704731544000481e-01   +1.156418646811050e-01   +1.742728814878336e-01   +2.402221507355338e-01   +1.997341915648467e-01   +8.778865364600799e-02; +1.928043636839773e-01   +5.225016630339316e-02   +1.563262589496529e-01   +9.611248513662993e-02   +5.160982345467052e-03   +1.100685669127912e-01   +1.312921325532354e-01   +2.924128912308199e-01   +2.080264639776241e-01   +7.658164850145247e-02   +1.536623957999123e-02   +3.033941215732439e-02];
L1_L3_iAMPA_netcon = [+8.158861871516580e-02   +1.615881683605981e-01   +9.848547411894626e-02   +1.767914691800105e-01   +4.716880386921364e-02   +1.427768644179867e-01   +5.480263448948030e-02   +1.088992176316031e-01   +3.712265420604358e-02; +6.011619848095111e-02   +1.602423681209351e-01   +8.608285909358834e-02   +1.309816526259211e-02   +1.422454833184666e-02   +4.180774899186442e-02   +3.030445480258960e-01   +8.241206539679113e-02   +2.046540110877329e-01; +1.374352815351770e-01   +1.259770881838813e-01   +1.100584800226801e-01   +2.490070387855099e-01   +9.882317265913029e-02   +1.605891982903539e-01   +1.390809967974665e-01   +2.557304620195235e-01   +1.313818457475018e-01; +2.219979631675548e-01   +5.597284058275327e-02   +5.285906484759212e-03   +3.848601023737533e-02   +1.387669521834425e-01   +1.308073866033797e-01   +7.588931317072122e-03   +1.578847475707183e-01   +9.917320638753745e-03; +2.337084043287120e-02   +1.142410613913774e-01   +7.950150838950024e-02   +9.773416543850148e-02   -3.422628239884840e-02   +1.490042578503523e-01   +1.445899107825011e-01   +6.773254891481667e-02   +1.384848645797691e-01; +5.137715965680723e-02   +1.874942294786803e-01   +1.172293399299988e-01   +1.826242905208556e-03   -2.194988983740820e-04   +1.582679651514445e-01   +1.262934549381138e-01   +1.131506999180606e-01   -6.718603768595205e-03];
L3_L1_iGABA_netcon = [+2.188547956916040e-01   +1.894747486469409e-01   +1.463446844056292e-01   +6.324425809188220e-03   -6.394311893254088e-04   +1.664278752420938e-01; +7.746418785187469e-02   +8.150491672198365e-02   -1.651899575356267e-02   +4.311160728931425e-02   -7.592196264248741e-03   +7.879763983073799e-02; +2.037186433285498e-01   +5.090745673525973e-02   +1.374477998525732e-01   +6.008048367683171e-02   +1.559534337304229e-01   +1.674737727830294e-01; -3.202673649848767e-02   +1.643511072532116e-01   +1.181193494460646e-01   +1.375949619933621e-01   +2.508511259053947e-01   +1.498484885971732e-01; +1.120859979200935e-01   +3.639093084660337e-02   +1.672792585110442e-01   +1.228171994439749e-01   +1.019068783685165e-01   +8.413531309279358e-02; +2.046951624013350e-01   +1.152725783433913e-01   +9.907205845960759e-02   +1.884292422689658e-01   +2.523518376820010e-01   +1.489096542814605e-01; +5.671988072408283e-02   +8.312539510737238e-03   +2.354649131310408e-01   +6.848131227594151e-02   +7.667658147216103e-02   +1.974695695032202e-02; +5.628058904005608e-02   +1.210565236759411e-01   +1.987174852242699e-01   +1.202294153069645e-01   +4.360215195481841e-02   +8.139709863526164e-02; +1.093454462365346e-01   +2.366260073327035e-01   +1.761586940155324e-01   +1.185829136081148e-01   +9.242705822994648e-02   +1.934044996652247e-01];
L5_Input1_iAMPA_netcon = [+2.384868603533670e-02   +1.673323412773518e-01   +7.642701037358460e-02   +8.039687344546852e-02   -2.542404432071002e-02   +2.042562375771039e-01];
L6_Input2_iAMPA_netcon = [+1.508609563052516e-01   +1.251110881483555e-01   +1.728254763201736e-02   +1.113026267727467e-01   +1.293546875787938e-01   -1.461129157049815e-02];
L5_L6_iAMPA_netcon = [-6.385170584184910e-02   +1.579888517799533e-01   +1.173372045497277e-02   +2.624538441616250e-01   +5.325966775268534e-02   +5.785894032657596e-02; -1.713813275636490e-02   +1.567161205474844e-02   +1.885289915990233e-01   +1.863439025383987e-01   +2.190779542274430e-01   +1.542484335254838e-01; +1.753827306873045e-01   +1.742505552596534e-01   +1.248127730321178e-01   +6.753264249402616e-02   -1.613316563262083e-02   +1.769747413019242e-01; +1.122353592810722e-01   +2.193152035697730e-01   +1.767116840880478e-01   +6.616417128605565e-02   +6.592431256997956e-02   +1.890971200313278e-01; +1.652650037015906e-02   +1.975670717997838e-01   +2.307149356417087e-01   -1.664883601561798e-02   +9.948560412392535e-02   +1.208942095030483e-01; +1.662257687006716e-01   -9.982126007243627e-02   +2.628278490550454e-01   +4.445266483739142e-02   +1.819732016447243e-01   +1.524786214927899e-02];
L4_L5_iAMPA_netcon = [+1.109286967459103e-02   +1.461170300191935e-01   +2.222902106978896e-01   +1.254670291206902e-01   +7.567779259307966e-02   +3.941832339469512e-02   +2.590161412779897e-01   +7.960020282422706e-02   +8.748184426783381e-02   +1.481854123034855e-01   +2.008519430435926e-01   +1.093498032237190e-01; +4.214150486589101e-02   +2.378447009691676e-01   +5.553448032741310e-02   +1.327226815601009e-01   +4.636801124194494e-02   +1.513286916786513e-01   +2.567207787234442e-01   -3.940627901655525e-02   -1.053023763026688e-02   +3.472969349418841e-02   +1.666958722048612e-01   +1.374164685009248e-01; +6.582456004936597e-02   +1.421719378608605e-01   +3.395234242333272e-02   +9.007153175828780e-02   -5.022236864313659e-02   +2.226544024071795e-01   +2.661252486954863e-02   +9.890462955810597e-02   +1.913785534552289e-01   +1.232520403304179e-01   +1.804839244300769e-01   +9.114532564180781e-02; +3.858277437052182e-02   +1.022078042480689e-01   +7.985199205019218e-02   +2.420774726555869e-02   -3.637773257375813e-02   +1.602529959675992e-01   +6.145535365166201e-02   +3.835681509468745e-02   +1.651260301937742e-01   -6.177178264962745e-04   +2.140188116389914e-01   +4.215846362334504e-02; -4.072219008290485e-02   +1.446726066854826e-01   +1.181868072540504e-01   +1.362127094432721e-01   +9.328578282697642e-02   +1.080455213123109e-01   +2.189833894070098e-01   +2.545263323578895e-01   +8.100668054186129e-02   +3.456930987626356e-02   +1.779232293679080e-01   +1.600749020388168e-01; +1.879403911718315e-01   +1.417802161324959e-01   +7.399557402841014e-02   +1.672809833010085e-01   +1.099416292546953e-01   +2.528543528761193e-01   -1.336769189195005e-02   +9.624935024265044e-02   +7.736909978343139e-02   +2.327580810652118e-01   +1.865745964868954e-01   +2.254876073677119e-01];
L6_L4_iAMPA_netcon = [+1.226464244656975e-01   +1.219518374676900e-01   +1.403155181012040e-01   +6.268360462894064e-02   +1.050909500252530e-01   +1.256310363165658e-01; -3.001931728941480e-02   +8.051632804010120e-02   -1.581410435461579e-02   +4.433899891212590e-03   +8.370480417076975e-02   +1.013652487061591e-01; +1.114681567748933e-02   +5.887817718349501e-02   -5.951910633694201e-02   +9.970281845381096e-03   +2.133303471454128e-01   +3.077186529280261e-02; +2.159600255373958e-01   +1.835961246770629e-01   +6.334996699230006e-02   +7.105499911195826e-02   +2.158127100442380e-01   +6.313196465385806e-02; +3.151109509398665e-01   +2.461523421318861e-02   +1.070825060003547e-01   +6.459779765619747e-02   +1.359882818410579e-01   +1.963405738507997e-01; +1.681430430387389e-01   +1.839367543360318e-01   +1.053625661943297e-01   +1.269228223194195e-01   +7.286377597734225e-02   +2.118262450078299e-01; +1.086042124327327e-01   +1.577405383478044e-01   +1.055214201355866e-02   +1.022139597119216e-01   +2.188161038252349e-01   -1.876711527262050e-02; +4.408878010497176e-02   +2.084665848415830e-01   +1.931397924784265e-01   -6.732340142788982e-03   +3.418693550489851e-02   +1.987329092105498e-01; +2.784322605616550e-02   +7.825243736055096e-02   +1.757757565334532e-01   +3.267700826878168e-02   +3.779983690312580e-02   +6.684163521696523e-02; +1.009257813397414e-01   +9.467422254611346e-02   +1.699764142828807e-01   +1.007188012233792e-01   +2.384013940325699e-01   +1.024911491817318e-01; +1.736871412715199e-01   +2.370156337177391e-02   +2.128234220339918e-01   +5.395980731644397e-02   +9.897811870736703e-02   +6.709094030395041e-02; +1.378290655339464e-01   +1.528335195543522e-01   +7.512511657964194e-02   +5.437116112495810e-02   +1.141790252274230e-01   +1.196252286520763e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
