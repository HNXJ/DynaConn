function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.037765629621692e-01   -5.163041929917993e-01   +6.139260291979417e-01   +4.113037335113838e-01   +4.583367654897558e-01   -5.832865166295523e-01   -6.079725314343738e-01   +4.885837505385934e-01   -8.474928160782225e-02; +5.897940267304811e-01   -5.428146143373545e-01   -5.266247854595105e-01   +4.472680414881258e-01   -6.323214392605750e-01   -3.104491708532989e-01   -9.857269461901985e-02   +1.527900797069115e-01   -5.250125390434361e-01; +5.105262350389012e-01   -1.324041432956808e-01   +2.855949864638251e-01   +2.999472121346978e-01   +2.152091763388925e-01   +3.714243474196350e-01   +5.550103909902051e-01   -5.157053451832769e-01   -5.376288064707740e-01; -1.211046011755491e-01   +1.443450955680367e-05   -3.274559722679312e-01   +6.253466692015248e-02   +4.810110790604409e-01   +5.669612814427983e-01   +1.975209463349005e-01   -3.616587519694403e-01   +2.530171371212609e-01; +1.948104102789583e-01   +5.403725036566306e-01   +3.487997510156127e-01   -4.095409530674710e-01   -3.272289916065561e-02   +6.342895289236646e-01   -5.137851134689636e-01   +6.021835114862018e-01   +1.206708688042644e-02; -3.220208441376395e-02   -5.198132489683225e-01   +2.034236334695135e-01   -4.921093020275668e-01   -4.428535812495715e-01   +4.309322100889481e-01   +4.553484392270943e-01   -2.708169159159436e-01   +5.020586559266980e-03; -3.892968252052708e-01   -3.889064738801757e-01   -1.601209991294650e-01   -8.147984288876672e-02   +3.561311723585621e-01   +6.372920555198856e-03   -1.583293710526825e-01   -3.582317808284172e-01   +4.653879710151101e-01; -3.147378190451791e-02   -4.572054230082218e-02   -1.138020835930703e-01   -2.213275099941451e-01   -5.325637375496159e-01   -1.704434874827740e-01   -3.404993239071149e-01   +1.908209140437376e-01   -9.029402246411116e-03; -2.681776450762542e-01   -6.108944703590219e-01   +1.139964512716577e-01   -3.893072378440651e-01   +1.391723812151711e-01   +5.821371454171093e-01   -1.758171529548474e-01   -1.974458611407288e-01   +5.323206885835268e-01];
L1_L2_iAMPA_netcon = [-1.953860605656331e-01   +1.535458019398245e-01   +3.433517762952593e-01   +5.208017798417901e-01   -6.009722104709394e-01   -4.759483173432782e-01   -3.666581641408323e-01   +5.285704585787290e-02   -4.264752222935709e-01; +3.285246052702617e-01   +4.685615307633403e-01   -4.339017784903759e-01   -8.984932562923261e-03   +3.832409313067939e-01   +8.271306851232155e-02   -6.780734619925725e-02   +6.696882241735153e-02   -4.360863919881821e-01; +3.415469820718997e-01   +2.875721698599037e-01   -3.763315887951370e-01   +5.805598995969068e-01   +2.401044927719349e-02   +6.615627038283119e-03   -4.581648894658222e-01   +5.098151777260616e-01   -1.042831428370042e-01; +1.186286453353629e-01   -5.889102795525176e-02   -5.547008750209741e-01   +5.017181307245011e-01   +8.250525499306091e-03   +4.917486984711777e-01   -6.553192874124608e-02   -8.136477156393847e-02   +5.334672272263229e-01; -1.992959196968160e-01   -1.251480562462737e-01   +3.547147769136821e-01   +3.792028748684246e-01   +1.753473203811865e-01   -2.922375242650193e-01   -5.638559175615532e-01   +5.028198534980536e-01   +4.055579525387271e-01; +2.732842340058104e-01   +4.875478241404350e-01   -3.123308175936413e-01   +1.838477858376922e-01   +6.290095848979768e-01   -1.545372234061757e-01   +3.882285636030072e-01   +8.809612314423798e-02   -2.019033591197003e-01; +3.948272835283564e-01   +2.747755506557515e-01   +7.145029682577055e-02   +2.899954668554730e-01   -2.611505700755817e-01   -5.707997286517911e-01   -1.229814590530807e-01   +1.463519994430106e-01   +3.304295223730806e-01; +9.273523665545454e-02   +3.074959104416228e-01   -2.622135382700079e-01   -3.597564729985309e-01   +4.329991484396087e-01   +3.220328558426045e-01   +3.571926463232485e-01   -5.062749923454231e-01   +2.651466514540090e-01; +2.892981356258576e-01   +2.869786991551320e-01   +4.022061558564130e-01   +1.985129149400979e-01   +3.595263928661181e-01   -5.078265042730022e-01   -6.221785601220650e-01   -1.512261339167463e-01   -1.420799786293820e-01];
L2_L5_iAMPA_netcon = [+3.342371751315886e-01   +5.503760784963796e-01   -5.039305649429956e-01   -4.785748147819949e-01   +1.053467845433831e-01   -5.123379584526964e-01   +3.902724408725136e-01   +3.933689189182655e-01   +2.442448428195222e-01; -6.621829175884116e-02   +3.869746280374216e-01   +6.297443279534898e-01   +3.183854261905312e-01   -4.230521128640705e-01   +1.279329698010644e-01   +2.630000177598506e-01   +5.478748740061582e-01   +6.355684001107024e-01; +4.546912225967097e-01   -3.657662612137981e-01   -2.728743047466762e-01   -1.760263033011134e-01   -3.302955110757103e-01   -3.307135726385438e-01   +4.879967306686002e-01   -4.607693285463362e-01   -4.940195094066236e-01; -3.234260854571357e-01   +1.312863813336728e-01   -2.281255939399939e-01   +5.640235147423439e-01   +2.667623302751774e-01   +5.869559431591249e-01   -3.213547078995616e-01   -5.206758477584823e-01   -2.760615771224689e-01; +1.555096048860156e-01   +4.515593372966893e-01   -2.061122205460006e-01   +6.551149741972581e-02   -3.167474991051129e-01   +1.585116791460612e-03   +4.451982276681489e-01   +7.777563543889640e-02   -5.154184378171280e-03; -5.880794846638566e-01   +4.714860032909575e-01   +3.798622276042894e-01   +2.753770998651053e-01   +2.720336242339643e-02   -3.586214801964305e-01   -3.273242249214613e-01   +4.214577848300702e-01   +5.565663571562321e-02];
L5_L2_iGABA_netcon = [-4.949861861156935e-01   +4.990288176578683e-01   -2.888926258058657e-01   -2.020947747585663e-01   -6.004747436475855e-01   +3.983357096832160e-02; +5.582205151125063e-01   +2.028940262943485e-01   +1.996423514416714e-01   -1.846259126698672e-01   -3.252444840554642e-01   -3.469939484615478e-01; +2.173101991572665e-01   -1.247538125855783e-01   +2.970241461751879e-02   +1.827238821919271e-01   -3.409647566921885e-01   +3.147069351874126e-01; -1.597104166097563e-01   +5.866536712225314e-01   -3.237549500014063e-01   -1.368571103788946e-01   +3.368399581973477e-01   +5.384342767607311e-01; -1.557315273278040e-01   -2.542789068525471e-01   -3.668007351369501e-01   -2.285032573346836e-01   -2.980617938541530e-01   -1.904802087601780e-01; -2.664107137037238e-01   -2.592966240280168e-02   +1.331177601689220e-01   -5.173949265000695e-01   -4.252304696810417e-01   -2.355619717209387e-01; -4.042870526763443e-01   +1.435792506413018e-01   -3.370035631924160e-01   -5.337943091465345e-01   +5.280419704368836e-02   -3.615666411855643e-01; -2.099153962850503e-01   -3.761903490828607e-02   -5.714622450718065e-01   -2.495117382028647e-01   -1.053786348015908e-01   +3.577350695193006e-01; +3.614155219763088e-01   -7.349841650931280e-02   -4.390850795662755e-01   +1.458227736543623e-01   -4.798879281013378e-01   +4.954494048523156e-01];
L3_L2_iAMPA_netcon = [-5.125764117940679e-01   +4.635218575947048e-01   -4.445320048190049e-01   -3.736920192887528e-01   +1.843027861487072e-01   -6.213347141908591e-01; -5.979447103255144e-01   -1.961693455450470e-01   +5.677276615600931e-01   +1.460293512356199e-01   -4.170211631237518e-02   +3.775136658422460e-01; -8.610354654871138e-02   -1.280091360703595e-01   -1.376197797150563e-01   +1.022960755756825e-01   +3.818207735201564e-01   +4.278422750933084e-01; +3.499589767940742e-01   -5.324988860926635e-01   +3.930462500333340e-01   +1.844399487472135e-01   -5.838461508734956e-01   +4.653915089437792e-01; -3.449501052717062e-01   +2.853234262406841e-01   +3.855318183814667e-01   -2.753230332266983e-01   -3.348914270039680e-01   +5.325006352526470e-01; +3.967966372656606e-01   +5.977071252332221e-01   +5.595750569885630e-01   -3.126117648619476e-01   -4.042866527112737e-01   -3.818472223414528e-01; -6.863183025343368e-02   -3.130645488964606e-01   +4.354115067874590e-01   +2.934456285696916e-01   +9.001467233488981e-02   -1.184530399807009e-01; +5.893799814202915e-01   -2.265800200591678e-01   +5.362739041613359e-01   +1.101418333995696e-02   -3.928281148572286e-01   -1.628917489215592e-01; +4.766943439008799e-01   -2.077622497961755e-01   -1.096932243743993e-01   -5.235401700137712e-01   -5.016799246209321e-01   +4.487079570633975e-01];
L2_L3_iGABA_netcon = [+1.237180898834857e-01   +1.959296634007641e-02   +9.486184442118113e-02   +5.872161441153512e-01   -2.857497725380950e-01   +3.163469623471528e-01   -1.984598939436720e-01   -5.539686587498461e-01   +3.605139154177065e-01; +6.101960105838898e-01   +4.451297136147939e-01   -4.488126204564792e-01   -7.194878843666515e-02   +1.517089560091894e-01   -5.985416529922423e-01   -5.684457116840615e-01   -5.641708192341920e-01   -2.548551975514048e-01; -9.116710957833729e-02   -3.613428080369090e-01   -3.778349869384616e-01   +3.669993428765284e-02   +1.173580870963592e-02   -6.913797508812702e-02   +3.092666840763132e-01   -2.712732844156998e-02   +5.182082794464975e-01; -5.478408811760744e-01   +5.079096289802097e-01   +1.353751956717637e-01   -4.801990237121527e-01   +5.134899650125294e-02   -1.035164059080621e-01   +3.685990259582118e-01   -3.960285961369749e-01   -2.180516448498955e-01; +4.755185375211902e-02   +5.253081330676070e-01   -4.375574594483140e-01   +3.341292405419466e-01   +1.298138768519611e-01   +8.784218229077713e-02   -1.625136834493692e-01   -5.058993948735920e-01   -3.177810352805732e-04; +1.224771118535361e-01   +7.274403793853034e-03   -2.214049910748632e-01   -1.119870886799306e-01   -5.408627006636731e-01   -3.233863133477251e-01   -3.750191975982858e-01   +3.213902621279467e-01   +4.972143869546891e-01];
L1_L4_iGABA_netcon = [-2.020703123612931e-01   -2.601372496852049e-01   +5.701542945054553e-02   +2.336566814381622e-01   +2.582520024891454e-01   -5.091246355914151e-01   +2.404068462864723e-01   +2.094825014345931e-01   -4.080631578119097e-01; -6.308806498057372e-01   +4.082992825464307e-01   +4.825603764142307e-01   +3.069849633326666e-01   +5.761935679360849e-01   +8.693146881029604e-02   -4.027422146553399e-01   -3.183191228458243e-01   +3.980341655483310e-01; -1.599369014003159e-01   -4.768477603935866e-01   +4.154087513563185e-01   -1.225346773010691e-01   -6.102882236914882e-01   +2.539219809791212e-01   -3.574605082152434e-01   +5.344962002141452e-01   -4.787789967198219e-01; -1.581102546218407e-01   +2.017735774642877e-01   -1.481927451510679e-01   +4.573582657673157e-01   +1.015753298368574e-01   -3.887525345428204e-01   -4.647730447443028e-01   +1.853207764642452e-01   -5.316944575160186e-01; +4.622660845865971e-01   +5.696633876642035e-01   -2.527575209342529e-01   -5.278583640685732e-02   -9.375727601462992e-02   -4.179664959013988e-01   +2.971472399303027e-01   -6.081747996081290e-01   +3.557871783608586e-01; -3.845836234239269e-01   +4.911155428110562e-01   -5.557282768724267e-01   -6.189126087178842e-02   -4.986093724261283e-01   +1.602675425222621e-01   +5.383762755303151e-01   +8.598512067581790e-02   +2.945011246399503e-01; +8.160289047013336e-02   -4.848243755359787e-01   -3.235484291928853e-01   -3.039632710482473e-01   +4.320201212776571e-01   -1.080236903745916e-01   -4.036012108213415e-01   +4.368280706216420e-01   -5.779772164061481e-02; +4.356520815174100e-01   -5.077309218165797e-01   +5.968415046939166e-01   +1.106721156423335e-01   +6.019659696834313e-02   -4.145089518494058e-03   +2.046171148997353e-01   -4.288589945460967e-02   +3.759365457675047e-01; -1.679669470525658e-01   -1.662077276657688e-01   -2.283407884539115e-01   -5.438159458588029e-01   -1.795631068897852e-01   +5.836807978557467e-01   +5.841492799994585e-02   -2.085466797725313e-02   -3.922002455024112e-01; +1.182091568909544e-01   -4.343389194487758e-01   -1.175127308993210e-01   +9.962515541706722e-02   -1.767301091788397e-01   -3.848454041840981e-01   +4.776780456578884e-02   +4.315981991721051e-01   +1.258723004658172e-02; -7.223844298009169e-02   +6.219791917830948e-02   +1.283445390679241e-01   +1.589696266114684e-01   -5.083120863054292e-01   +1.665551078853779e-01   +5.516827170785633e-01   +1.955012488314337e-01   +8.783133291228765e-02; -5.932481696944101e-01   -1.430837299017618e-02   +5.226802981568749e-01   -3.016333955277064e-01   +2.985022278856178e-01   -3.398558803367160e-01   -2.801706734058383e-01   +7.376682676136538e-02   -2.119705634027562e-01];
L4_L1_iAMPA_netcon = [+5.857530017266208e-01   +2.445992438782780e-01   -3.639214006921443e-01   -5.923201886447961e-01   -4.173428856539688e-01   -2.435015666206109e-01   +6.387168630566256e-02   +2.598938422107547e-02   -5.412917756848106e-01   +4.956869562230415e-01   -5.558241274497424e-01   -3.431459852840252e-01; +6.201881221834643e-01   +2.660064990493256e-01   +3.670157412788752e-01   +1.704146092272237e-01   -1.608805028333720e-01   +6.600498732011308e-01   -5.640028772812336e-01   -2.032511513117063e-01   -6.281815840957737e-01   -5.680712393061311e-01   -6.302087300662554e-01   -3.245462171779230e-01; +3.931046228227557e-01   +3.343716231251898e-02   +2.201301144182970e-01   +4.593342728814580e-01   -4.214651007071647e-01   +4.218078015452490e-01   +4.960132568554331e-01   +4.726647365259407e-01   +1.612378604829050e-01   -2.709439912841830e-01   +3.447167873055829e-01   -4.484979233094077e-01; -4.310230985854872e-01   +3.938254882039604e-01   -1.794883890837948e-01   -5.160615306252144e-01   -1.128537381054807e-01   +2.943809433199706e-01   -1.695293562266962e-01   +1.477234289083300e-01   -1.763536661221329e-01   +6.282642342231994e-01   -3.549681766551186e-01   -2.030941846840424e-01; +2.782476600223964e-01   +4.217923351929954e-01   +3.072803686096689e-01   +4.820167498656246e-02   +5.249203969335587e-03   -6.793628801569479e-01   +7.092063171982255e-02   -4.174982177164088e-01   +5.654039511114879e-01   -1.614924598657801e-01   +3.205436156518066e-01   -1.832879867115011e-01; -2.819317346893540e-01   +4.543160132731648e-01   +1.052436963270142e-01   -2.543335182067076e-01   +2.169828201931379e-01   -6.379153525387555e-01   -5.693889142308729e-01   -1.103425062617547e-02   -3.763353319513629e-02   -5.011726512576126e-01   +6.413025270054535e-01   -3.233954283108588e-01; -3.151890368659233e-01   +4.540268405619417e-01   +4.110166757346116e-01   -2.512709819751656e-01   -5.338906795005741e-01   -4.439495419908279e-01   +1.612330735167987e-01   -2.486623979384757e-01   +2.695118826911581e-01   -2.379173749282518e-02   +2.682915796869702e-01   +2.618802363972695e-01; -1.466062878737947e-01   +2.764208668366540e-03   +3.423515957593721e-01   -1.580686185063339e-01   -3.311379210661395e-01   -3.129733728121190e-01   +6.126713908486917e-01   -1.178605666615258e-02   -5.567763374252520e-01   -2.847554408134033e-01   -1.074318036193458e-01   +4.465646151918931e-01; -6.110960986480602e-02   -8.961224705888723e-02   +7.426496310172587e-02   -2.091205538193475e-01   +4.721400137935150e-02   +5.540058638369773e-02   -3.197614226271149e-01   -4.069816200092872e-01   +3.657728340290231e-01   +1.783858645017885e-02   +4.638162220969796e-01   -9.300407469650865e-02];
L1_L3_iAMPA_netcon = [-6.515987159093778e-02   +1.608341189037141e-01   -1.609271280166946e-01   +5.011355442710672e-01   +5.512938140921787e-01   -1.299624849892220e-01   -5.790744755913124e-01   +6.440571139958809e-02   +2.610559154519607e-01; -4.295659532083475e-01   -5.886919788926461e-01   +3.876970572663883e-01   -2.619752488341149e-01   +5.984544274117285e-01   +2.162428093733441e-01   +6.164996226428782e-01   -7.255778866068006e-02   +1.715359169865353e-01; +8.746434053796599e-02   +1.240208503382258e-01   +5.063595006025899e-01   -4.482470362217577e-01   +2.387401348774281e-01   -2.989235621092621e-01   +3.007173207184815e-01   -2.087479221459885e-02   -6.226912329611565e-01; +5.579406279706303e-01   +2.906684609208117e-02   -5.026760005473516e-01   -3.114843406265901e-01   -4.241242259988634e-01   +5.245340643115730e-01   +2.767593976104040e-01   +2.187593169411030e-01   -6.308726801577175e-02; -3.432461388330681e-01   -1.026752848879146e-01   -2.941314277036218e-01   -2.766510373359222e-03   +4.822148327662013e-01   +3.468678742200305e-01   +5.367303608510324e-01   +3.638618376640112e-01   +1.248049567938595e-01; +6.374662640678827e-02   +2.943919813282719e-01   -1.266726391435224e-01   -3.216962298700389e-01   -7.773441329036096e-02   +4.159365055553023e-01   +2.118238947954006e-01   +3.802943603277631e-01   +4.859266965137075e-01];
L3_L1_iGABA_netcon = [-3.420774155164135e-01   -2.971815143939442e-01   +6.110503135477673e-01   +2.108081585681382e-01   -2.125504457635218e-01   -8.045721018686531e-04; +1.876223673780111e-01   +3.955137594285062e-01   -4.128228426015902e-01   -4.685829689629755e-01   +1.345622988580686e-01   -2.399867993945853e-01; +5.617299503284816e-01   -2.408481148477247e-01   +4.891995707908329e-01   +5.669300133045276e-01   -3.216432242759966e-01   +8.501992150102922e-02; +1.274702488072546e-01   -6.411875405100836e-01   -1.333433579790088e-01   +4.637892890157267e-01   +5.983231612202352e-01   +5.948489963872099e-01; -4.687805269718195e-01   -4.366732986283450e-01   -3.639155295913316e-02   +3.698507712322561e-01   -1.577094097353277e-01   +1.618191351475286e-01; +3.147929308104971e-01   +4.362321458953030e-01   -1.463619898611543e-01   -4.155412961848963e-01   -1.911376352127740e-01   -5.172673907525179e-01; +9.363718282018726e-02   +8.768491033496388e-02   +4.350850901982009e-01   -4.252618453123498e-01   -3.129758059612964e-01   +4.150904161932128e-03; -6.421475837708674e-01   -2.630382661562616e-01   +9.427753349464653e-02   -2.742178399849959e-01   -5.396799637765761e-01   -3.726183285934221e-01; -4.383334189545806e-01   -2.163460608473757e-01   +4.170641763962916e-01   +8.996041327320324e-02   -6.288148360874871e-01   -5.691506324106860e-01];
L5_Input1_iAMPA_netcon = [-5.504172250796900e-01   +9.299002311052776e-02   +1.698743519425877e-01   -5.965425462860824e-01   -2.800007067654285e-01   +3.579267603390512e-01];
L6_Input2_iAMPA_netcon = [+1.061551853184782e-01   +4.605864543799533e-01   +5.388977209061110e-01   +4.786234894880823e-01   -3.092540019214837e-01   +3.506880306720554e-01];
L5_L6_iAMPA_netcon = [+6.792126674310689e-02   -4.773241827514936e-03   +1.941051174434447e-01   +2.176074127223095e-01   +4.995420194288452e-01   -3.767026703551981e-01; -2.076142065732798e-01   -4.356370450797318e-01   +2.934445057705216e-01   -8.442446228328504e-02   -9.031586166900112e-02   +4.921197295226910e-01; -5.246459177996902e-02   -2.020858551733922e-01   +3.809173600028408e-02   +2.684696885729932e-02   -4.653807284722034e-01   +9.587892435054592e-02; -3.377501385840509e-01   +4.884622240540549e-01   +4.452958033108062e-01   -2.822148009546930e-01   +3.091839523629719e-01   +1.585231505154106e-01; +1.089439651860885e-01   -5.350647297870197e-01   -2.114782031850171e-01   -3.269397521332865e-02   -2.634699382333848e-01   -1.510214898106870e-01; +4.524147442397094e-01   +4.222489761577568e-01   +1.796174471427697e-01   -3.273121087058920e-01   -2.048436935196563e-01   -2.058776371669879e-01];
L4_L5_iGABA_netcon = [+3.772299652483244e-01   +6.549410909482296e-01   +3.515804758316977e-01   -9.951367566706433e-02   -3.778540593852622e-01   +3.598789421482874e-01   +5.733839269688072e-01   +5.007812778686531e-01   -5.661896808859258e-01   +1.696793042732811e-02   +5.526588687305776e-01   -1.176871436261530e-01; +2.408333351195601e-01   -1.354656053296086e-01   +1.812865512761216e-01   +1.143051804125701e-01   +2.612893995322256e-01   +5.448338936021293e-01   -2.261385643045819e-01   +5.504375101532429e-01   -2.338972652699543e-02   -6.165153562518515e-02   -3.235519819383474e-01   +6.202819600620378e-01; -3.030839010147631e-01   -5.306803360133234e-01   -1.459180801402422e-01   +2.222622519403913e-01   -2.890282790231393e-01   +1.426487090787777e-02   +3.387530616127828e-01   +2.061173080204474e-01   -1.308270598419833e-01   -3.195568303800989e-01   +2.285242479754918e-01   +3.161799144206094e-01; +5.076908904578603e-02   -2.469128648489719e-01   -9.930201716486756e-02   -5.002772433116934e-01   +7.262879159633424e-03   -5.634640877395035e-02   -4.624626900055275e-01   -6.587999648976654e-02   -5.073977969897460e-01   -3.150318472414038e-01   -2.028913750825524e-01   +1.013590937468164e-02; +2.120306990872819e-02   -2.144176570405111e-01   +2.299285831320615e-01   -3.956968449558132e-01   +5.804231961311802e-01   +1.705468696067732e-01   -4.095148756360639e-01   +4.026454568890764e-01   +1.624178503013831e-01   +2.510925981883655e-01   +3.601166293768583e-01   -2.506203817556144e-01; -6.139003431445231e-01   +3.277618682568996e-01   -3.209719816180436e-01   +1.030394955401816e-01   +4.258118852222950e-03   -5.441790441618359e-01   +5.172903532737507e-01   +2.764673732329855e-01   -3.992297853980254e-02   -5.353574454785510e-01   -4.279491319404770e-01   -3.541879572223491e-01];
L6_L4_iAMPA_netcon = [-6.469546834019143e-01   +2.057383415722037e-01   +4.943293049655610e-01   -5.470412996820134e-01   -5.072178443453029e-01   +9.154698042511475e-02; +8.010514017574782e-02   +2.647993157212694e-01   -2.214252698293368e-01   -4.929593380612565e-01   -5.370893388327305e-01   -7.688681181703247e-02; -1.408099175949643e-01   +3.933659952797988e-02   -4.260314323487533e-01   -1.092157437329353e-01   -4.565629022844964e-01   +1.411470633831668e-01; +4.174912629856236e-01   -3.888582676471440e-01   +4.935447593914301e-01   +5.405901914387181e-01   -2.248471153015044e-01   -1.493128059614860e-01; +5.811456561475846e-01   +5.653428279899750e-01   +8.787342468567529e-02   +4.658422414923229e-01   +9.464482686129555e-02   -2.737551032939674e-01; -5.089546109313301e-01   -1.446008885288461e-01   +3.969885316188383e-01   -8.330524849840891e-02   -4.055015904940394e-01   -4.776439338581072e-01; +8.895885587359784e-02   +3.008976329655040e-01   +2.505401797847947e-01   -3.929469337258135e-01   +4.855087451951288e-01   +5.920517030180943e-01; -1.486210379215330e-01   +3.864987997707299e-01   +5.937494766809059e-01   -3.486749144657861e-01   -1.803906645342235e-01   +1.530259239724691e-02; +3.967876762818864e-01   -1.148364637754776e-01   +1.282408029773834e-01   +5.049709322646482e-01   -1.596436115311512e-01   -5.244376890257653e-01; +4.053039789705366e-02   +1.631016589249203e-01   -2.052351181783615e-01   +1.305638434104818e-01   +4.254195614133867e-01   +1.296579732961121e-01; +1.598692516872962e-01   +4.417495859680404e-01   -5.458010392580657e-01   -2.779206492026243e-01   -5.137290677208239e-01   +5.162780565929631e-01; -9.569647621644503e-02   -3.291414895072119e-01   +5.478292930870191e-01   +3.782331108114331e-01   +6.612147349037115e-01   -2.590932578622755e-01];
L5_L4_iAMPA_netcon = [+4.856536571723381e-02   +3.232548543517646e-01   +4.843792601478240e-02   +1.466538510718397e-01   -1.615796869837245e-01   -4.238485542056127e-01; -3.197299255969450e-01   -3.693146378358517e-01   -1.086868441493627e-01   +3.258714638370359e-01   -4.672392381630976e-01   +2.941541134144988e-01; -5.540010917041583e-01   +2.937321767721449e-01   -1.262274400848642e-01   -1.641988486532472e-01   +2.336353972132672e-01   -5.570394732707789e-01; +5.356307589510757e-02   -2.062354235047803e-01   +2.379136465434805e-01   -4.035985603956993e-01   +2.805052623809113e-01   -4.545496899870957e-01; -4.543791342496967e-01   +2.377351570070208e-01   +1.349753294924530e-01   -5.355272352669421e-02   -1.838886031133143e-01   -4.350887016674242e-01; +2.427228452579217e-02   +1.946308031706143e-01   -2.931801949955333e-01   -2.661591306229607e-01   +2.319171146960578e-01   -4.944747960004450e-01; -3.579893586145441e-01   +4.158637092520683e-01   +3.982321499691333e-01   +4.344309955398012e-01   +4.057404013324427e-01   -1.494785596098867e-01; +5.113674537995826e-01   +2.533799872797697e-01   -9.939739655305529e-02   -8.005681416350330e-02   +3.572270096424559e-01   +3.287386794578798e-01; +9.583663576133331e-02   -3.500475732199511e-01   -2.440027473139314e-01   +3.730791174129557e-01   -2.974144793987252e-01   -5.576811281107802e-01; +3.315615518276777e-01   -4.628667860241675e-01   -3.517287872409695e-01   -4.663284865964007e-01   +1.895952540605359e-02   -3.356061490068383e-01; -3.952376335991828e-01   +5.082618481352712e-01   -3.164902764355812e-01   -6.674205464877037e-03   -3.387547703580771e-01   +2.778440561769567e-01; -4.875756333704976e-01   -4.546417301790959e-01   +5.626301984727517e-02   +3.614373722085701e-01   -3.612543055057572e-01   +4.013823050331333e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
