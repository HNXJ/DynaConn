function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.898499041324064e-01   -3.230916309573854e-01   -3.879920650144111e-01   -4.576604287034228e-01   -4.308070558668354e-01   -2.980346376028240e-01   -6.919562954066432e-01   -5.329791669655330e-01   -5.618136744203511e-01; -3.915272723486239e-01   -4.219758133078067e-01   -4.812790674178358e-01   -4.657654553623884e-01   -4.500100941045133e-01   -2.789753909660855e-01   -6.112117836907682e-01   -5.827576857367925e-01   -3.455184485690252e-01; -3.722675448645269e-01   -3.326203337662065e-01   -5.295685262033891e-01   -7.873375030459343e-01   -5.576450425650753e-01   -3.881609887950285e-01   -5.620979304349647e-01   -3.482712145301722e-01   -5.225637728095600e-01; -4.014798595424046e-01   -2.982478886722749e-01   -4.695089408935640e-01   -3.812182149682272e-01   -2.236830169628255e-01   -4.096566197795683e-01   -5.637278352972800e-01   -1.678120105665429e-01   -4.607541127846501e-01; -5.128052639349566e-01   -3.216197597716123e-01   -2.412345471213883e-01   -2.233392144684858e-01   -3.253542752538457e-01   -4.642282509609594e-01   -5.231323657090394e-01   -5.933976818366433e-01   -4.785613877772411e-01; -3.161504302558978e-01   -1.889148929867584e-01   -3.008271835732931e-01   -6.041562411664104e-01   -3.038467089045693e-01   -4.469003691339503e-01   -5.904117739305260e-01   -5.699428853016456e-01   -2.719466253384871e-01; -4.483157636236182e-01   -4.878127627034417e-01   -4.790588527803341e-01   -4.880945823330367e-01   -7.410236435642610e-01   -6.001054732395907e-01   -3.934352089041544e-01   -4.901236524654880e-01   -6.035104969543762e-01; -3.774135012909946e-01   -7.322090732390464e-01   -6.132288448647648e-01   -3.260407275907290e-01   -3.991976642599150e-01   -1.822454271992630e-01   -4.761445663760417e-01   -6.720862594794635e-01   -4.501065811826466e-01; -6.155064562287654e-01   -3.978711192696629e-01   -3.320613920246303e-01   -3.504506032644740e-01   -4.140808930633332e-01   -1.617159350403269e-01   -2.668168603926815e-01   -4.503325930944376e-01   -4.660124384294831e-01];
L1_L2_iAMPA_netcon = [-4.390160967049725e-01   -4.846973041767668e-01   -4.239904876931891e-01   -6.178499427360794e-01   -5.844988223512058e-01   -5.205746853272389e-01   -3.123720544709862e-01   -5.171121268948944e-01   -3.448686624069700e-01; -2.901469987446341e-01   -4.172885936530714e-01   -2.553517648528937e-01   -3.852723943991255e-01   -3.474854317403036e-01   -5.051616145969949e-01   -2.788587944444259e-01   -4.832770612350482e-01   -1.545710696800416e-01; -3.607981044525042e-01   -2.246599898111155e-01   -4.680385064561894e-01   -3.689008154129748e-01   -1.495565402614296e-01   -5.521922047148234e-01   -5.546603039279091e-01   -4.063882096486035e-01   -5.426227978221194e-01; -3.645856453951868e-01   -4.354733160431290e-01   -6.611226168581192e-01   -4.699829879037047e-01   -2.698110614412902e-01   -5.344326477762070e-01   -6.633192537368933e-01   -5.719875411503937e-01   -4.357621039090591e-01; -5.795899607989841e-01   -3.309715515195431e-01   -3.311785813195365e-01   -3.612585691014076e-01   -4.443085209339570e-01   -5.832454456287679e-01   -3.023834831722399e-01   -4.187109894434238e-01   -4.603939089480591e-01; -7.758003041692884e-01   -4.762033122640363e-01   -6.813556364903927e-01   +2.425408367230554e-02   -4.357694663088413e-01   -5.244549439499271e-01   -3.044559898758003e-01   -2.654503622703115e-01   -5.785425600546567e-01; -4.422742701738719e-01   -4.148130980222902e-01   -1.277081321338098e-01   -4.126219456128190e-01   -2.949376140043600e-01   -5.772714220647670e-01   -3.736970683827279e-01   -5.011999453837113e-01   -3.432311217354788e-01; -1.927851368303697e-01   -3.239304924159025e-01   -4.785290536338791e-01   -4.692958992727604e-01   -2.335651789071010e-01   -3.263973289603933e-01   -1.936174071438825e-01   -1.534869499343543e-01   -4.525278550769382e-01; -7.249300224272947e-01   -5.500555777362519e-01   -4.288326134647483e-01   -5.271236298653584e-01   -1.223453242886228e-01   -6.908057751706131e-01   -3.242069332879193e-01   -5.866389697329258e-01   -3.165063338799758e-01];
L2_L5_iAMPA_netcon = [-4.581821893491156e-01   -2.142528281015500e-01   -6.296576550123789e-01   -3.909623430919528e-01   -4.585103002922759e-01   -4.870726367169341e-01   -5.817833267411049e-01   -2.917143612894262e-01   -4.974818004333425e-01; -3.449130474710287e-01   -4.720160237442246e-01   -5.134235149739089e-01   -3.459397213194141e-01   -6.226820476294362e-01   -6.713367165480472e-01   -4.640124982399729e-01   -3.460978783671956e-01   -4.483513554182981e-01; -4.718081615901628e-01   -3.718069453169177e-01   -4.318022371077884e-01   -2.531000044580686e-01   -3.766039982997067e-01   -2.564088014932253e-02   -4.292710363619246e-01   -5.530412491736216e-01   -2.635593961666841e-01; -3.687542342004054e-01   -1.787972687656187e-01   -2.209176057424761e-01   -3.537545720839284e-01   -6.478703642240478e-01   -1.765395422341651e-01   -4.595279959997944e-01   -5.411354773664491e-01   -4.039290131667457e-01; -5.757172479213853e-01   -6.065688900725897e-01   -5.840451117642029e-01   -4.511341339513124e-01   -5.338889323922446e-01   -6.249020827289531e-01   -5.425292774910846e-01   -4.784793692871254e-01   -4.588738758885267e-01; -3.998107143226304e-01   -5.069939970922996e-01   -5.750218087531416e-01   -3.114639847028500e-01   -4.439701793692327e-01   -4.207506563135742e-01   -4.082768303521143e-01   -4.790859691218841e-01   -2.454621654230208e-01];
L5_L2_iGABA_netcon = [-4.855718027563608e-01   -4.192347844676724e-01   -6.930434274102668e-01   -5.122592515704641e-01   -4.633527751622687e-01   -4.581189203926009e-01; -5.078351696943818e-01   -3.600682498817653e-01   -4.991807233373990e-01   -6.172323591221682e-01   -4.403946530114987e-01   -4.562996498496284e-01; -3.627891559202767e-01   -1.901603640561005e-01   -4.257780348516377e-01   -3.967956672791516e-01   -6.769380476101863e-01   -3.751912959026611e-01; -1.986141972770098e-01   -3.026446122151694e-01   -1.746471751666791e-01   -3.019972737299108e-01   -2.531128564351069e-01   -3.964668392568895e-01; -4.873807158057901e-01   -3.501060942483943e-01   -3.542714147147248e-01   -4.210372989443407e-01   -6.295534595739367e-01   -2.674036196141186e-01; -3.479785359800346e-01   -3.283578152514102e-01   -2.305547021729580e-01   -5.423448568822262e-01   -3.993352093443836e-01   -7.117373091945017e-01; -3.025543157533272e-01   -4.610012989924965e-01   -5.103131132579291e-01   -3.227694984867533e-01   -2.288779158813057e-01   -1.436047551447847e-01; -5.475738797945839e-01   -2.730192042457198e-01   -1.859613940534926e-01   -4.823686389632992e-01   -3.804691898056598e-01   -4.420137395431871e-01; -4.623499243136740e-01   -6.737460246230275e-01   -5.547642587152121e-01   -2.609805644185318e-01   -3.050292955114681e-01   -4.148307678141581e-01];
L3_L2_iAMPA_netcon = [-5.474926403196722e-01   -5.682657583177191e-01   -3.353699585811203e-01   -6.448460528781452e-01   -3.960805938581619e-01   -1.710079364562889e-01; -3.515960192109476e-01   -6.168422603707842e-01   -4.896167143329049e-01   -4.007989274056792e-01   -4.177304632399246e-01   -4.332458666705782e-01; -5.156195775611474e-01   -4.893486486246360e-01   -3.500361556006113e-01   -6.462971748286029e-01   -4.662798655457800e-01   -4.100081854002924e-01; -4.081021580123630e-01   -4.780930721417210e-01   -5.251401841258908e-01   -3.713178304268705e-01   -3.788649090289426e-01   -4.569805689751174e-01; -4.196116668020964e-01   -5.044151139588482e-01   -3.661444985725293e-01   -4.065657014092103e-01   -2.835175903680898e-01   -4.045489073290913e-01; -5.451734194884315e-01   -3.748487415200751e-01   -4.806228841437452e-01   -3.370506077262375e-01   -4.544970158249070e-01   -4.883594322071282e-01; -5.019102397262872e-01   -3.291886849122024e-01   -7.124859797966179e-01   -3.457539474640148e-01   -4.593120465389591e-01   -5.679266297656481e-01; -4.041651694146028e-01   -4.375839445566525e-01   -5.117830777404173e-01   -4.440082203680355e-01   -4.221224452731377e-01   -2.523490282008387e-01; -7.256000064958300e-01   -4.903856550477420e-01   -4.974662446659269e-01   -2.914974660222929e-01   -3.994587641445122e-01   -4.557785499431638e-01];
L2_L3_iAMPA_netcon = [-3.847766214105087e-01   -3.562401850803233e-01   -4.074142352107046e-01   -3.614841392203202e-01   -4.911528432350263e-01   -5.993354125758813e-01   -4.058320163758035e-01   -1.706026208864297e-01   -2.821172413105035e-01; -2.872278741301635e-01   -5.341814703008991e-01   -3.700731823056285e-01   -4.170921035170286e-01   -4.134411942168598e-01   -4.898949578279714e-01   -4.229692318947638e-01   -4.673347751555919e-01   -5.344385690071510e-01; -2.506217525574522e-01   -4.796281819182912e-01   -4.551923932443819e-01   -4.185699065480773e-01   -3.233816702763311e-01   -6.031166528801877e-01   -3.928213137769738e-01   -4.348281630020766e-01   -5.426349455943117e-01; -2.896388144486732e-01   -4.599513601215732e-01   -5.383738552223643e-01   -3.457535071699120e-01   -3.337208176068910e-01   -4.434060340991851e-01   -6.190624167509347e-01   -1.657933030121921e-01   -6.495220579058524e-02; -3.583752889916537e-01   -6.921035751856980e-01   -5.417603770718784e-01   -3.289134384633578e-01   -4.598945190292575e-01   -3.273348568236417e-01   -5.241845027750163e-01   -3.081787412106543e-01   -5.285836566523422e-01; -1.542164790755952e-01   -1.953895837709309e-01   -2.309289121229781e-01   -4.677499157130113e-01   -2.754591683126766e-01   -4.842026431501038e-01   -6.864920486808769e-01   -3.713573908334021e-01   -6.537405083860027e-01];
L1_L4_iGABA_netcon = [-6.206230332271890e-01   -2.024924460651269e-01   -4.977519296154977e-01   -4.017004420906819e-01   -2.831325384458582e-01   -4.669580555644708e-01   -4.489834369587282e-01   -4.591446842106918e-01   -1.921644467836252e-01; -1.305730444752200e-01   -4.163900743603465e-01   -4.001639601237236e-01   -3.890472620340963e-01   -4.031033125113448e-01   -5.460021123420260e-01   -3.872204239100506e-01   -6.427970492999570e-01   -6.344948598771704e-01; -4.475924502293879e-01   -4.798353644364857e-01   -3.938785939140596e-01   -5.218876131795328e-01   -4.282568572099631e-01   -2.754251374742841e-01   -5.963686925533018e-01   -4.195466216949479e-01   -3.649811140824313e-01; -3.968350907939998e-01   -5.111113365110748e-01   -2.916977913594364e-01   -4.455967974053067e-01   -6.573346906788813e-01   -3.230635314236744e-01   -4.112873020847456e-01   -5.256651868026625e-01   -2.797032571026462e-01; -3.690124817196597e-01   -4.628469873506099e-01   -5.688274055695488e-01   -4.476823986954331e-01   -4.152303644231189e-01   -5.311987754817284e-01   -5.247210293904286e-01   -5.015667870880137e-01   -5.726730875643808e-01; -4.767664909262969e-01   -4.764643122471466e-01   -5.273285888778872e-01   -3.796159959500998e-01   -4.147862128375557e-01   -4.415169977527779e-01   -3.942073522222148e-01   -4.018970265496575e-01   -2.086337899471831e-01; -4.111649306128174e-01   -4.764275973887551e-01   -4.666453842953091e-01   -2.698860540834712e-01   -3.338525389120225e-01   -5.503017036829729e-01   -2.805233241534437e-01   -5.686278955105787e-01   -3.892644641420505e-01; -6.419842991174977e-01   -4.268650160036477e-01   -2.626905632872549e-01   -4.934423295388786e-01   -4.024072518136380e-01   -4.178327888751103e-01   -3.913807236253096e-01   -6.027166425477870e-01   -5.758113943324827e-01; -6.572920268562988e-01   -5.407762165424649e-01   -3.488679675141309e-01   -3.455132876330339e-01   -2.743486873998238e-01   -2.425864660439125e-01   -6.451612617623198e-01   -3.912923773264769e-01   -2.526069191756604e-01; -5.906413933856099e-01   -2.841036045618458e-01   -4.489930929575912e-01   -4.711921134899654e-01   -5.595815429476750e-01   -5.689816646660153e-01   -3.948100156711239e-01   -3.982246056317623e-01   -9.999565834472650e-02; -3.854305102676173e-01   -1.741264554977605e-01   -2.603995348732501e-01   -3.498407323149499e-01   -5.228480672435277e-01   -5.558089111157485e-01   -3.032296977294204e-01   -4.061911373225871e-01   -4.423088921726322e-01; -5.853326892148550e-01   -3.689620444942113e-01   -3.561225911879440e-01   -5.143301627389950e-01   -3.632235768332610e-01   -1.863196435507159e-01   -3.847618408086897e-01   -5.500897594727622e-01   -3.177733570045418e-01];
L4_L1_iGABA_netcon = [-2.450452082895683e-01   -3.417063307351406e-01   -6.607331543835127e-01   -5.142706016592392e-01   -3.662170166361340e-01   -6.227263909050640e-01   -5.395616317020364e-01   -5.285185871907429e-01   -3.122394686313949e-01   -2.356845016478894e-01   -4.021720780715456e-01   -4.764804506831778e-01; -2.338652851197551e-01   -5.044112518595834e-01   -2.551895485805989e-01   -4.325348957373735e-01   -6.569553971501632e-01   -4.555683678399434e-01   -4.147032226273085e-01   -6.287401716654051e-01   -9.984315610848511e-02   -3.877970641120210e-01   -4.781567878434485e-01   -3.987793448461924e-01; -3.580874573443502e-01   -6.442130202941843e-01   -5.140755706360775e-01   -3.626099301684976e-01   -5.648628336518535e-01   -5.089754847423136e-01   -4.811138389333824e-01   -5.062877403966219e-01   -4.145857080770089e-01   -3.680631651920027e-01   -5.991236300716893e-01   -3.844944014791436e-01; -5.415289188864419e-01   -6.430124691344596e-01   -3.302406420929556e-01   -4.035583367852453e-01   -4.874801541813537e-01   -5.384903605981141e-01   -3.780321327580481e-01   -3.722343844962812e-01   -3.768075084346090e-01   -4.683102236185610e-01   -1.373233796777664e-01   -5.212246638587539e-01; -5.001600571892996e-01   -4.531608342041308e-01   -4.022173806020090e-01   -4.382275839963894e-01   -4.558240924984059e-01   -5.004213043556939e-01   -2.820879424735587e-01   -4.518436849513254e-01   -4.449615909415307e-01   -3.176649601173832e-01   -1.496876342553852e-01   -4.369156487076036e-01; -4.442817244459782e-01   -2.534393959149055e-01   -4.081375212188046e-01   -4.304540298980148e-01   -4.873625606247923e-01   -3.372917446939812e-01   -4.417900990189382e-01   -3.052445175017708e-01   -6.742493130737565e-01   -4.098150176592177e-01   -4.106394767589086e-01   -7.648517213726885e-01; -3.962024978663318e-01   -6.470097037267135e-01   -3.858023602484217e-01   -3.556323630658838e-01   -4.742355362789712e-01   -4.523501204349833e-01   -6.559570066826846e-01   -5.158911055410508e-01   -2.893323129238575e-01   -3.426681583709857e-01   -4.210823215846364e-01   -5.670313539166241e-01; -5.797311709644122e-01   -3.832541662276398e-01   -4.431997093966016e-01   -2.240915309300045e-01   -5.319873500021001e-01   -6.596357258095918e-01   -2.692003752329085e-01   -3.534516456928804e-01   -3.072645557653835e-01   -5.191796021282049e-01   -5.934770545826054e-01   -3.632443446629249e-01; -6.894212057156832e-01   -4.776676646028390e-01   -3.507527981118541e-01   -6.175826024211818e-01   -4.913396710268140e-01   -2.375676642840820e-01   -5.175349167393654e-01   -3.925163773165601e-01   -3.889007548195687e-01   -5.565623259417701e-01   -4.259010926582378e-01   -3.812678648946302e-01];
L1_L3_iAMPA_netcon = [-4.634061595221408e-01   -3.030566309859775e-01   -5.592198640685712e-01   -5.391604092460341e-01   -7.388142444175202e-01   -4.760339073859552e-01   -4.449487059994198e-01   -5.427766062622057e-01   -3.850087447173387e-01; -5.045595566756561e-01   -1.936341128212827e-01   -3.611403405689321e-01   -3.238662534494163e-01   -4.637271085601083e-01   -4.541755474114249e-01   -2.935271756580834e-01   -6.229768811726492e-01   -4.616886452684510e-01; -4.581304939839502e-01   -3.704875442765478e-01   -4.196209914103646e-01   -2.379786781980773e-01   -3.700180351468447e-01   -6.431328390614014e-01   -2.617119670147373e-01   -6.489242929861629e-01   -5.659610850281565e-01; -2.772603494327668e-01   -3.432378469065899e-01   -4.774366350823951e-01   -5.248690583883587e-01   -3.241730645649470e-01   -1.397683763891193e-01   -4.376282369296232e-01   -6.782795831610908e-01   -3.176439827825204e-01; -4.056756896232688e-01   -5.271211396013566e-01   -4.490459841530817e-01   -5.371422923779520e-01   -6.214679096995863e-01   -2.011550188584698e-01   -4.874868582087289e-01   -1.952276902484845e-01   -5.439535438358251e-01; -5.288492427466978e-01   -3.808928928790866e-01   -5.411982202842340e-01   -5.599718653562428e-01   -5.540657598324308e-01   -2.815506885180631e-01   -4.542600891841738e-01   -4.666647886879451e-02   -5.379140019553258e-01];
L3_L1_iGABA_netcon = [-5.467611039606292e-01   -4.327688164837219e-01   -3.273412899307361e-01   -5.529052105168056e-01   -2.308512274209595e-01   -7.792844918967315e-01; -5.160375392882078e-01   -2.842092397048513e-01   -3.564128245513394e-01   -4.272794491617747e-01   -5.392108565219482e-01   -6.674871699751422e-01; -2.449206796985863e-01   -5.674927332605345e-01   -2.659571883433057e-01   -2.776539889536572e-01   -4.257403551301132e-01   -3.992718537396174e-01; -3.961814429479102e-01   -2.884662795892031e-01   -6.072058047837821e-01   -6.003734707409034e-01   -2.741099805778237e-01   -6.110926645072293e-01; -6.057699713458744e-01   -5.536080409643482e-01   -7.335605883183262e-01   -3.214924822378382e-01   -3.048926112277653e-01   -3.273731048251666e-01; -3.422919769021230e-01   -4.957231529151441e-01   -4.976061317234411e-01   -1.255460571492362e-01   -3.793187060215550e-01   -1.790617251729644e-01; -3.404497730944803e-01   -3.017523807696809e-01   -3.404642575151678e-01   -5.677482672943541e-01   -2.318464316302719e-01   -1.879958622524977e-01; -2.248847377993961e-01   -4.842661608198653e-01   -6.355558110075503e-01   -3.917926749553547e-01   -5.405313171222065e-01   -3.959232558360584e-01; -6.189610116682246e-01   -5.539265510839324e-01   -5.649645512470514e-01   -3.159711174951034e-01   -5.686678334287547e-01   -4.340292389340338e-01];
L5_Input1_iAMPA_netcon = [-3.863072925139542e-01   -4.466295408923806e-01   -5.539879721983487e-01   -3.847024350742107e-01   -5.682435682951237e-01   -7.147392987896826e-01];
L6_Input2_iAMPA_netcon = [-6.014377131013515e-01   -6.420867392821481e-01   -4.395497463143845e-01];
L5_L6_iAMPA_netcon = [-5.152659900280973e-01   -5.248102884859277e-01   -2.202233395800554e-01   -4.050294274006723e-01   -6.021799594753359e-01   -2.842623540972128e-01; -5.357145954144108e-01   -4.035076829390924e-01   -4.490074104505868e-01   -5.480292494884093e-01   -4.950041518956650e-01   -4.093267166884840e-01; -6.284887346534094e-01   -4.100873097854224e-01   -1.717427491330856e-01   -2.504593815188447e-01   -4.419565111601605e-01   -3.731397881744852e-01];
L4_L5_iAMPA_netcon = [-3.861759467731143e-01   -4.398415134112818e-01   -5.483000126456347e-01   -4.048366623460387e-01   -5.340741615452306e-01   -5.025163429630284e-01   -2.931572084516205e-01   -2.954101164974841e-01   -6.458360348588892e-01   -2.644668724237508e-01   -6.553011686378066e-01   -5.720352983134229e-01; -3.654364577745124e-01   -2.098138774002272e-01   -2.122918847550447e-01   -3.281173662727562e-01   -4.050765448007001e-01   -4.914470936067749e-01   -5.427772527333142e-01   -1.464466073197583e-01   -3.678817620252288e-01   -3.954724796830811e-01   -7.419418826503840e-01   -5.368690921708092e-01; -3.718666784366471e-01   -4.258171317718327e-01   -2.168462607118204e-01   -3.547816078677079e-01   -3.334480599049803e-01   -3.550770551234786e-01   -3.142192892728354e-01   -2.674570859128074e-01   -4.987535097791172e-01   -4.847206057989882e-01   -4.954306483812733e-01   -4.436592428881619e-01; -1.641958568805676e-01   -3.305878657014252e-01   -4.210755113611095e-01   -3.524368998938141e-01   -6.267552241448286e-01   -5.426784736966386e-01   -3.515522632333277e-01   -4.170601476333598e-01   -5.177862769214328e-01   -4.757740856969384e-01   -6.797795431356852e-01   -5.064381949330852e-01; -3.155375578583489e-01   -1.570743586892356e-01   -6.121820270460275e-01   -3.333619627697570e-01   -3.923937032387889e-01   -2.506019678975881e-01   -4.675057034911642e-01   -4.686005042623814e-01   -5.170938789210809e-01   -5.326008472962805e-01   -3.367228493519026e-01   -1.376484112470301e-01; -7.007997640403706e-01   -5.755009814807700e-01   -5.270133804121295e-01   -4.602037311940912e-01   -6.812198890149724e-01   -4.996743014959364e-01   -2.041395607970411e-01   -2.469638139623244e-01   -3.004661176655300e-01   -7.090914449164338e-01   -5.695959199969345e-01   -5.980334399477933e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
