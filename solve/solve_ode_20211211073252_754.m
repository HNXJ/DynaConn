function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.512353623359970e-01   +7.390294618441530e-02   +5.723380235702317e-01   +1.000000000000000e+00   -9.626942068215125e-02   +7.712316792944719e-01   +3.124764221047270e-01   +2.979541237243496e-01   -2.402230871094024e-01; -3.892084496008238e-02   -3.700990640640273e-01   +8.692168279163344e-02   +2.364233857806372e-01   +2.117381167760798e-01   +1.868886552861611e-01   +2.200764722537785e-01   +5.405716851202963e-01   +1.228960812709084e-01; +5.679451854197906e-01   +4.523200005681620e-01   +2.642229642302480e-01   -4.379096156394788e-03   +4.128336459582219e-01   +5.043758768195090e-01   +4.035935356699114e-01   +1.343841877097972e-01   +1.455659253811211e-01; +5.286123982406774e-01   +4.633890456309978e-01   +1.034473256861896e-01   +3.230712726066379e-01   -2.100707343744437e-01   +2.453233102044636e-01   -2.793956388042167e-01   +7.132036422232542e-01   +1.533104142708220e-01; -4.014823159412619e-01   +1.726554720239997e-02   -2.855817156684344e-01   -1.835320541790752e-02   -3.682687207010290e-03   +2.097793175333567e-01   +6.374897834832753e-01   +9.487318550370781e-02   +4.298518920655598e-02; +6.175284229652009e-02   +3.623385826837948e-01   +6.924782593039067e-02   +3.663328778219390e-01   -1.643811917964103e-02   -3.900877153674326e-01   +6.595180336580464e-01   +6.391877442752332e-01   +1.343763455245811e-01; +3.054577319908804e-01   -2.748180684428377e-01   +6.736537914881265e-01   +1.428689364466026e-01   -3.061967473326375e-01   -4.448441262094209e-01   -1.508012111503474e-01   +4.495496666234525e-01   +5.755877499623198e-01; +1.074964985399175e-01   +4.792557833253843e-01   +5.770082419025402e-01   +6.536879490544292e-02   +2.100254837988401e-01   +5.112586187941068e-01   -1.048105514067661e-01   +4.070323089091864e-01   -4.080746438756180e-01; -3.887649069868186e-01   +7.414962525396132e-01   +7.823673733300097e-01   +1.739680219402629e-01   +2.042434321531452e-01   +1.669276035793235e-01   +6.154267660531346e-01   +3.717981653707875e-01   +6.874259297082459e-02];
L1_L2_iAMPA_netcon = [+8.485173930810632e-01   +1.576971981325147e-01   +1.236378604949302e-01   -2.473403006813264e-01   -1.730781299387363e-02   +4.475038891344122e-01   -2.019748604291327e-01   +6.978045256578171e-01   +2.092728421773799e-01; -8.757529750433446e-02   +6.047254037144465e-01   +8.119856374368988e-01   +6.097811950138117e-01   -2.067083396580951e-02   +3.237642486845838e-01   -3.465527462119177e-01   +2.996927481672580e-01   +2.768045077172487e-02; -3.375611033680142e-01   +5.025405137187364e-01   +2.042881306745152e-01   -1.826406464185804e-02   -2.209884559695568e-01   +6.040130412204420e-01   +7.035151174504722e-01   +5.853625285743942e-01   +1.487743866479520e-01; +2.609556462200718e-01   -5.863263832518972e-01   -5.730522214916165e-01   +9.952499162482373e-02   +5.944216888117360e-01   +4.690700245062934e-01   -2.729803038444500e-01   +3.557537927741150e-01   +7.160945134617738e-01; +4.568988168101264e-02   -4.948346800524210e-02   +1.496549378189528e-01   +7.337142031017718e-01   -1.737350262806241e-01   -2.407138284958229e-01   +6.151170915038215e-01   -1.560929531070345e-01   +1.357404196211703e-02; -4.526401753872276e-01   +3.265593997983705e-01   +3.696330900960543e-01   +2.746774482861916e-01   -2.138324996453574e-01   +6.977419450668376e-01   +4.688926494335048e-01   +7.290258342614289e-02   +7.165330965799949e-01; +6.186686226227451e-01   +3.520054132987021e-01   +4.773668037436435e-01   -3.949992476838100e-01   -3.654918090966347e-02   +2.732283276288539e-01   +4.045117127618766e-01   -2.830544395370524e-01   +3.290719610845776e-01; -2.706953448023166e-01   +5.888871843464780e-01   +2.378993136401998e-01   +5.689834580590993e-01   -3.180798022580867e-01   -5.752737008151689e-01   -1.791945754472112e-01   +3.203154153474178e-01   +4.232904921412883e-01; +1.662785688507419e-01   +6.183353596132329e-01   -4.342113029105608e-01   +1.503413766635897e-01   -9.067539518772177e-02   +3.474459590533367e-01   +8.155178544773922e-01   +8.045549189765526e-01   +4.190932756856793e-01];
L2_L5_iAMPA_netcon = [+1.169134405636740e-01   -1.297487122568875e-01   +5.023591600010076e-01   +5.351102500051866e-01   +1.302436509448279e-01   +1.375816601902171e-01   +2.432362890568553e-01   +2.440761659602947e-01   +3.141315020264800e-01; +1.625181410512535e-01   -2.521821759599434e-01   +7.425906556152019e-01   -3.028710020089287e-01   -1.758469931782398e-01   +2.906895048351881e-01   +6.067141809934389e-02   +3.622973670204565e-01   +5.554971740595407e-01; +3.536452341131373e-01   +3.355672548581924e-01   -3.522024754759295e-02   +1.163346272392123e-01   +6.571781114264928e-02   +7.226361061278855e-02   +5.940046007322610e-01   +9.608241114759200e-02   +8.541032105005358e-01; +1.305383935498048e-01   +3.304030904318027e-01   -1.238386627021200e-01   +5.132124510299482e-01   -5.516662943791808e-01   +4.896424377446735e-01   -8.023264059540447e-02   -1.244262545615641e-01   +6.338227847128702e-02; +2.261445422153664e-01   +3.274661293174551e-01   -3.660648554146900e-02   +1.745752395868068e-01   -3.502047738829162e-01   +3.513370874451059e-01   -9.903510447340040e-02   -1.338152818402573e-01   +4.365038117884329e-01; -7.587397014742961e-02   +3.921492469706829e-01   -3.344304639341751e-01   +4.267755651420840e-01   +5.251386136989042e-02   +1.106662245444663e-01   +8.068166436073165e-01   +8.888592941529061e-01   +4.339268078337811e-01];
L5_L2_iGABA_netcon = [-9.201800392908714e-02   -2.952465523955692e-01   +1.538821679638236e-01   +9.300770652963465e-02   +7.723968459407393e-02   -2.223902367876704e-01; +3.530193926523124e-01   -3.819662086235279e-01   +3.642692104485684e-01   +3.060139986841878e-01   +4.337278291929490e-01   -2.621237879241832e-01; +2.829373452785452e-01   -3.009005355763485e-01   +3.037393538551489e-01   +4.114117292245700e-02   +5.821807627463360e-01   +1.187414656785431e-01; +6.490809219920606e-01   +2.955006644271743e-01   +1.639645641194902e-01   +8.047906564114425e-02   -4.558833935951362e-02   -4.517744869628416e-01; -3.084133017960744e-01   +9.238588351528434e-02   +8.360454250424294e-01   -1.058360004048983e-01   +5.472569018944380e-02   -1.086142657970380e-01; +5.570598570918877e-01   +2.236190158878881e-01   +5.795929168874703e-01   -5.011914281060842e-01   -4.813826897985991e-01   +5.855184300881318e-01; +1.371498013937024e-02   -5.385974605594197e-01   +4.508948378254734e-02   +2.986084086444903e-01   +1.956848375206002e-01   +1.011299316462387e-01; +1.539076067500788e-01   +2.565792778702173e-01   -3.747657226143392e-02   -4.767603312337696e-02   -1.564615330150227e-03   -5.872917442331390e-01; +1.000000000000000e+00   +2.535401612077035e-01   +4.890142231481620e-01   +6.276132062088274e-01   +3.547582773863296e-01   +2.998706019384196e-02];
L3_L2_iAMPA_netcon = [+4.316961038784089e-01   -3.425007563330149e-01   +2.023554604060844e-01   +3.640704881088480e-01   -4.959784071528718e-01   -7.607949190355440e-02; +2.819399604526705e-01   -4.024851437884857e-01   -2.523286533042405e-01   +9.703788805370669e-02   +9.102218186309575e-01   -3.999979035441853e-01; +3.040268602357560e-01   +4.420306137898881e-01   -1.238557845692029e-01   -2.897747247020118e-01   +4.195312273720337e-01   +1.866478202822566e-01; +1.919642431152394e-02   +7.289918234700492e-01   +6.235196238265198e-02   +4.127172250395446e-01   -1.644318002579531e-01   +8.277719883433069e-01; +4.496676266516818e-01   +7.224151931487174e-01   +5.663496908582849e-01   +6.194368729713592e-01   +5.947866455385635e-01   +4.036315835442728e-01; +2.734047918681559e-01   +5.620801333753548e-01   -3.946072553572386e-01   +3.601235102526789e-01   +9.213986926558416e-01   +7.360295881566410e-01; +6.563210259822229e-01   +3.350438480482078e-01   +4.810570798677810e-01   +2.196236237980571e-02   +4.529594385539071e-03   +9.530760957584351e-02; +3.442017555939857e-01   -2.101393238910284e-01   +7.764029958162448e-01   +6.948073247908815e-01   +2.641179261990298e-01   -2.584213942606974e-02; +4.583546505389103e-01   -2.919935985133976e-01   -2.007466542966563e-01   +2.200904128061369e-01   -1.462159248134426e-02   -2.431317206567582e-01];
L2_L3_iGABA_netcon = [+5.343903424518464e-01   +5.620798519921608e-02   -1.833795390639267e-01   +8.305934104128583e-01   +5.345572318924749e-01   -2.221081576786830e-01   +3.005560927152190e-01   -1.226456245601470e-01   +6.065184390190299e-01; +6.702702438341406e-01   -1.598106783936257e-01   -4.867095734396032e-03   -5.994502095556425e-01   +4.555978267191410e-01   +7.191866962380735e-01   +7.500255725944954e-01   +3.882519005525603e-01   +2.846056805261206e-01; +5.665767248440994e-01   +3.275318310119756e-01   +2.458236880061342e-01   +4.931653219186283e-01   +7.772993471364839e-02   -1.483374534385126e-01   +1.556684629309994e-01   +3.805645454971022e-01   +6.179040851350688e-01; +9.271482884714110e-01   -1.288825170119891e-01   -1.848158772774113e-01   +2.115241949049123e-01   -9.831740184896381e-02   +2.505964570718137e-01   +5.486531439062814e-01   +1.538465906842315e-01   +2.142194676260175e-01; +4.136331000123485e-01   -3.332599486882904e-01   +4.181216448736879e-01   -2.237446349854093e-01   +2.416401445435766e-01   +7.755613660746785e-01   +4.920898717326184e-01   +2.412202377864850e-02   +6.844466447375263e-01; +2.589665407563430e-01   +1.979518344165672e-01   +3.438517314281160e-01   +4.154070158576075e-01   +2.522307974670400e-01   +1.560085216373452e-01   -4.494512193800663e-01   -3.200057683464047e-01   +1.233083855690485e-01];
L1_L4_iGABA_netcon = [+1.292712552249700e-01   -4.282117908022738e-01   +3.030118160797058e-01   +1.142498823318725e-01   +3.611727792315084e-01   -2.034102903983410e-01   -1.450664980527496e-01   +3.696142807984031e-01   +4.268547079299607e-01; +6.038328214420869e-01   +7.316959251074426e-01   -5.263195483406918e-02   +6.485683883563133e-01   -1.227722324964374e-01   -6.290668108035773e-01   +1.392062501384011e-01   +3.202066231453490e-01   +4.691365339882645e-01; +9.795082983677185e-01   +5.914612643963055e-02   +7.551274794979328e-02   +3.568963971740750e-01   +2.107748847989754e-01   +5.855822550358483e-01   -3.027770185964612e-01   +5.764614856879602e-01   +1.488018054525418e-01; +4.226010633222930e-01   +2.261587532837585e-02   +5.096840310621630e-01   +4.909007610253876e-01   +3.143551175063222e-01   +8.194954152882249e-01   +2.069631349870140e-01   +5.134519159443052e-01   -3.923879857714987e-01; -2.128909825361095e-01   +2.240016796581365e-01   +5.046121963890302e-01   +3.391987163401596e-01   -2.178481648365399e-01   +3.626636256964222e-01   +5.089881361873780e-01   +3.895427756545335e-01   +5.095758404043811e-01; +6.629155711141386e-01   -9.458185443028208e-02   +1.443773652425427e-01   +1.059070960436414e-01   -9.290681065380760e-02   +5.813229246934691e-01   +5.890989957375769e-02   +5.014520897318473e-01   -3.619418009829787e-01; +1.826282212365103e-01   +3.838897679254013e-01   +7.658979872121191e-03   +6.070232030642140e-01   +5.174064794856843e-01   +8.640670401860123e-01   +3.663123210330173e-01   +3.647477150516527e-01   +1.819271149545171e-01; -1.360354542869878e-01   -2.349348515490615e-02   -3.731285835894630e-01   -1.630004678001875e-01   -3.857334793299009e-01   +4.255445495989666e-01   +2.123394136052499e-01   +3.601130719801130e-01   -1.195949638907225e-01; +4.406477960874577e-01   +4.395738085758207e-01   +2.059086734651928e-01   +9.169642285018109e-02   -3.207067629186295e-01   +4.867494826290536e-03   +1.534712731544672e-01   +2.166385839297917e-02   +4.590843108921008e-01; +7.041789920892758e-01   -4.210918296905301e-01   +3.751864759209976e-01   -6.298430236727199e-01   +5.695095249646468e-01   +7.364198914414000e-01   -5.776873758772527e-02   -3.297436615975939e-01   -5.028776940061916e-02; +4.975984509001841e-01   -5.804268378905407e-01   -4.933947185373114e-01   -1.642235873908521e-01   +3.051601319717846e-01   +1.426189971666377e-01   -8.851034476216976e-02   -3.293402931544042e-01   +6.021302402839191e-01; -1.142857232655606e-01   -3.052460197011941e-01   +1.066340034935362e-01   +1.686487894440283e-01   +5.055692889422670e-01   -8.321498465921258e-02   +3.261097418501258e-01   -1.921414401711055e-01   +2.262652229770519e-01];
L4_L1_iAMPA_netcon = [-2.022710459310413e-01   -2.461481773219008e-01   +4.980154708887764e-01   -2.998414548924028e-02   +1.737507607478035e-01   +1.966196331755098e-01   -2.209474635851801e-01   +8.575582301520640e-02   +8.674957749022616e-01   -2.946720521493151e-01   +1.061712568716029e-01   +7.810071695304785e-02; +3.982573852719636e-01   +3.632129278169176e-01   +4.049512957183994e-01   +3.871477333561644e-01   +2.679583250889073e-01   -5.022660620447447e-02   +6.008219418278351e-01   +2.548315373405274e-01   -6.161249894350910e-01   +3.546271431425856e-01   +7.475621298831932e-02   +3.939784147260280e-01; +2.908727626102496e-01   -4.335192447209453e-01   +6.780312083507806e-02   +9.750354178078330e-02   +5.713138292627437e-01   -3.245100122229372e-01   +6.808270757802748e-02   +1.091988245134012e-02   +3.084861344203756e-01   +4.656972972435266e-02   -2.876957975566604e-01   -2.459831298675458e-02; +5.375352278691847e-01   +4.165577973489227e-01   -3.007178354399710e-01   -2.966297007019434e-01   +3.632825056316857e-01   -1.243083996660591e-02   -9.117695107164164e-02   -5.158831399167318e-02   +6.851827330275186e-01   +4.014196922677540e-01   +3.525930973079222e-01   +2.658183436381844e-01; -3.444495349523160e-01   -8.764756368258379e-02   +2.681925438879302e-01   -8.902696501477314e-02   +7.582152299844213e-01   -3.597436079236678e-01   +2.848774531893853e-01   +6.646778996792735e-01   +7.249064054878308e-01   +2.607641711068870e-01   -2.725260023145878e-01   +6.638370770280466e-02; -2.633981779803009e-01   +7.907784224763715e-01   +2.971340734262765e-01   +8.080440749960555e-02   +1.239259163713113e-02   +2.313169915538443e-02   +6.490765801436671e-01   -8.154520372165361e-02   +3.037820173411709e-02   -5.068323205106257e-02   -2.281600488913699e-01   -2.419402875652492e-01; +5.359825495152633e-01   -1.578395954740340e-01   +5.368335484642852e-01   +6.701928189603893e-01   +8.282770522912175e-01   +5.711491806030848e-01   -3.307996806859723e-01   -6.952974278410651e-02   +2.124029339270633e-01   +4.105695149025050e-01   +5.058085371273302e-01   +5.286663379621748e-01; +3.748945193701021e-01   +8.000854597896520e-01   +9.504848342756739e-02   +1.447935290919178e-01   +6.217120205720035e-01   +7.651438172367343e-02   +3.193902483143575e-01   -4.653290486461722e-02   -8.327260948329840e-01   +1.934482539015133e-01   -1.064016016457598e-01   +5.879504148063437e-01; -3.088724141005052e-01   +5.320527407092077e-01   +2.232276290454706e-01   -2.871274242120259e-01   -6.505053638897876e-01   +6.348531668333816e-01   +8.403446584956675e-03   +5.459506180968496e-01   -6.156846080428335e-02   -9.973060477667647e-02   +2.341699020166284e-01   -2.135298314053702e-01];
L1_L3_iAMPA_netcon = [+5.177105443484803e-01   -2.056982360536088e-02   +5.482578667919016e-01   +2.478550782837164e-01   -1.713846725380853e-01   +3.433575134274120e-01   +1.573550479657829e-01   +2.034452857840710e-01   -7.210726958878820e-02; -5.809763440183418e-01   +4.444187600571546e-01   +3.485345111808956e-01   +6.032291686879208e-01   -7.317495748719517e-02   +3.215636904822877e-02   +2.086027936545384e-01   +4.291321204217882e-01   +6.963623337724953e-01; +6.187496324871794e-01   +1.000000000000000e+00   +4.566508076108358e-02   -5.090887252326557e-01   -3.401867983405727e-01   -2.977300519000237e-01   -1.818352010990699e-01   -6.970698289056702e-02   +6.045527155200576e-01; -3.322132258748138e-01   -3.983606933700391e-02   +2.218810317457310e-01   +2.827027296717759e-01   +5.839395454302568e-01   +2.928712268226924e-01   -5.447822744093120e-01   -4.221045337163245e-01   +9.497466617519489e-01; +1.935090303365713e-01   +2.400566784156599e-01   +1.208805378783089e-01   -5.898635816738593e-02   +5.295271604992324e-01   -4.438281309721780e-01   +5.240030167818703e-01   -4.010869834402241e-01   +3.990412796298476e-01; +9.142700279928343e-01   -2.739744753265268e-01   +8.055286612889587e-01   +2.439788064334556e-01   +3.445322286449737e-01   -5.192878994616925e-02   +9.150310850892998e-02   +1.723145983103643e-01   +1.452435047486357e-01];
L3_L1_iGABA_netcon = [+6.190195259686202e-01   +1.044098537641310e-01   +2.035471726614338e-01   +7.002921817229361e-01   -1.500875441448109e-01   -2.499584022511346e-01; -3.550480473460219e-01   +3.150661143076230e-01   -1.775396806917564e-01   +2.515487732700712e-02   -1.738400127493659e-01   -1.403964520941328e-01; +3.196448077652887e-02   +7.410545418732406e-01   -1.908467449328726e-01   +2.369270462238781e-01   +6.277866902526208e-01   -5.853826304162523e-03; -2.644093648625498e-01   -3.663977281429480e-01   +4.224610252515877e-01   -1.480157520720621e-01   +5.569838695633259e-01   +1.465456156867399e-02; +7.144311128998124e-02   +8.536726887158869e-01   +3.016780560325610e-01   +6.192450431779144e-02   -2.029667821725283e-01   +1.335960321250774e-01; +3.757146027659252e-01   +5.319315705377062e-01   -4.048805451812986e-01   +3.091036752843989e-02   +1.591828096703320e-01   +2.832558371804784e-01; -2.153767180091333e-01   +2.488420106209749e-01   +3.661052899621621e-01   +7.416119062175931e-02   +1.844599803095752e-01   +1.753294391585473e-01; +8.496683435347254e-01   +3.258953492601764e-01   +9.050703690364006e-02   +1.000000000000000e+00   -2.636557701180233e-01   +5.357892777690494e-01; -2.891421011503820e-02   -3.983625692323745e-01   +1.796337460258635e-01   +1.502575977197524e-01   -2.358541978212453e-01   +9.181662308543725e-02];
L5_Input1_iAMPA_netcon = [-3.650905472776915e-01   +6.952293842886557e-01   +5.103507319887590e-01   -9.999410712149331e-02   +6.956727917737621e-01   -5.808653320126987e-02];
L6_Input2_iAMPA_netcon = [+5.941893827276135e-01   +3.491741911739857e-01   +3.106594558342377e-01   +1.711572266022098e-01   -3.048128168201305e-01   -3.267610821891938e-01];
L5_L6_iAMPA_netcon = [+2.664554446294846e-01   -4.156847513396948e-01   -4.842492769757878e-01   +1.093687148195382e-01   -1.256277752982672e-01   -5.076456522848622e-01; -6.806838472336943e-03   +1.156912128132350e-01   +9.341245251519368e-01   +8.040687010726006e-01   +2.329087725596254e-01   +2.400401144249646e-01; -8.306610698423098e-02   +3.268239169492006e-01   +3.089979393494549e-01   +5.330288739521873e-01   -1.139109335966172e-01   -6.201784102618203e-01; +2.171361807317508e-01   +3.022756478538419e-01   -2.742991546906816e-01   +5.779210430790643e-02   +2.056005163112707e-01   -1.566738003670852e-01; +3.062531794958569e-01   +8.464765516312049e-02   -6.684522375525892e-02   +3.302959690656628e-01   +6.595717700750199e-01   -2.408166328062161e-01; +8.475989843546516e-02   +2.705824981166359e-01   +5.683251333482259e-01   -1.262463005170705e-01   +8.931583814819857e-01   +3.726852688485355e-01];
L4_L5_iGABA_netcon = [+3.822063532468559e-01   +3.054733129584198e-01   +5.793587552943080e-02   -9.355531225798147e-02   +3.665834409703382e-01   +3.326869055878866e-01   +1.125901803430384e-01   +1.579333016448369e-01   +1.526642927139027e-01   +1.649939385699677e-01   +7.244934296343448e-01   +4.328980883464865e-01; +3.901964571322503e-01   +2.095395587173862e-01   +1.911913961791068e-01   +7.076824410220642e-01   +4.980702461477282e-01   +7.468652522204008e-01   +5.899330755328551e-01   +3.702766648083045e-02   -1.310781078723982e-01   +7.328376227507343e-01   -8.426630711110261e-02   +2.498050537648877e-02; +4.995406205786583e-01   +2.186796349518373e-01   -1.461062700196339e-01   +1.681322082446140e-01   -9.625164832583555e-02   -2.804540936301362e-01   -2.517890983625446e-01   +8.470061080993685e-03   -3.227194674357059e-02   +5.489905734267263e-01   +1.160992917572902e-01   -1.168043099933955e-01; -8.311642108881849e-01   +9.556797229168806e-02   +6.926856029792046e-01   +9.235094796877104e-01   +3.212841253064075e-02   +1.232759636595274e-01   +5.742004028210833e-01   +3.217593762938495e-01   +2.897512015181427e-01   +8.387176447827042e-01   +8.708086530057733e-02   -1.337976511729954e-01; +5.937826670779012e-01   +3.534927973677736e-01   +4.879102380464039e-01   -2.073536248761795e-01   +5.092637318391768e-01   +2.748805401264781e-01   +3.455012948807694e-01   +3.705694528303762e-01   +2.889881906153254e-01   -1.771423031716849e-01   +1.980057698879584e-01   +1.502291559001454e-01; +7.354280551377816e-01   -3.314569140602975e-01   +1.210563477140797e-01   -4.735289544683565e-01   +4.391349294515725e-01   -3.651157828752194e-01   -1.484282093943498e-01   +5.683676504394967e-01   +1.341825153185243e-01   +7.059260833618505e-02   +4.790469628176789e-01   +1.533203582593121e-01];
L6_L4_iAMPA_netcon = [+4.611956483926807e-01   +4.290210490477149e-01   +3.070282461127508e-02   +5.755896053673181e-01   -1.250763162197156e-02   +6.898699125288800e-01; +3.794116436797157e-01   -1.346584773872075e-01   -3.323116351845485e-01   +4.109601260374081e-01   +1.263961512302439e-01   +1.223274684641155e-01; +1.292833445484238e-01   -7.043826519331597e-01   +1.949222375066683e-01   +2.029188139382753e-01   +1.533574542102113e-01   +6.091210336693793e-01; +6.143568614827574e-01   +6.379292147498641e-01   +6.258165923152610e-01   -3.904442142485254e-02   +1.844928761617453e-01   +4.980930409353983e-02; -2.664179339471035e-01   +4.266366013087305e-01   +6.456568695996338e-01   +6.975258623333365e-01   -2.198265307706861e-01   +6.090919281703966e-01; +5.178824347644446e-01   +2.781744457830879e-01   -2.525555081986863e-01   +1.868029337733214e-01   +7.695893250823079e-01   +2.937562564942299e-01; +8.102565694849123e-01   +3.739988506334982e-01   +3.103298900729827e-01   +1.000000000000000e+00   -3.273723069734254e-01   +2.205392974252619e-01; -4.408913649273781e-01   -2.106591276056134e-01   -1.904432866175690e-01   +1.878478163738849e-01   +3.092793136045807e-01   -3.035372926516701e-01; +1.009702931176575e-01   -4.700598285259457e-02   +9.874502387094685e-01   -3.161259902364106e-01   -4.883439829296415e-01   +3.029932245806402e-01; -4.274470857511464e-01   -4.280077466626911e-01   +4.698707902307390e-02   +3.705435100657556e-02   +7.167245232509563e-02   +1.921361394836093e-02; +4.653844469718301e-01   +6.320933452441162e-02   +3.263266805106631e-01   +1.969673295595506e-01   +6.779237901713941e-01   +7.085470492490361e-01; -3.295060513613542e-01   -7.103011678125561e-02   +1.343523790038491e-01   +6.642849287265608e-01   +2.153262501100832e-01   +5.847707986916261e-01];
L5_L4_iAMPA_netcon = [-4.286007903659311e-02   +4.109902750278422e-01   +5.188808966088450e-01   +3.502930194817703e-02   +6.138861019812777e-01   +3.452815831695205e-01; +1.475862924396799e-01   +4.590175624683432e-01   +1.972225571225591e-01   +3.088946385635109e-01   -5.129803614111882e-01   +1.000000000000000e+00; +5.381987997337351e-01   +6.080460204383370e-01   -6.227423097490808e-01   +4.092301897859585e-01   +9.372984479740828e-02   +1.910272493488520e-01; +3.066854865019403e-01   -6.630200078633912e-02   -1.885255280232851e-01   -2.531999755944285e-01   +4.261251033985132e-01   -3.977603348778576e-02; +4.965358757645525e-02   -1.750646246307674e-01   +7.286682367590724e-02   +3.163018068723230e-01   +9.137971135914084e-02   +5.643042181072595e-02; +6.153013501267797e-01   +1.713210508789681e-01   +1.299919014730885e-01   -2.172296738466342e-01   -9.062771732960664e-02   +5.830865523551988e-01; +2.417145560900374e-01   -1.506970791613345e-02   +1.576583318963076e-01   +6.819425722984759e-01   -5.800548750949793e-02   +5.235709509430456e-01; -7.624151486482655e-02   +4.702175557940620e-01   +3.672898968477247e-01   +3.741344310448683e-01   -7.100937524734507e-02   -2.522788153380880e-02; +1.527491174426346e-02   -1.407848450358785e-01   +2.971090271812282e-01   -4.270923329974906e-01   +4.304633521656900e-01   -4.284071845424398e-03; +2.286862772012644e-01   -4.097956412986652e-01   -4.027457800143074e-01   +5.939617647039139e-02   +5.721207757162275e-01   +1.494901543473612e-01; +5.745689803485694e-01   -1.277146418674987e-02   +1.613925713125297e-01   -2.109570216505472e-02   -1.663528845647304e-01   +6.553388919562741e-01; -1.619060263070714e-01   +1.593673982388989e-02   +3.787966478101888e-01   -4.244654981690387e-01   +1.544816190301729e-01   +2.680481140665144e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
