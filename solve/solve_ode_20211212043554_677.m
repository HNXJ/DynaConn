function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.130661390038045e-01   +5.448862426966571e-01   -3.922943200299724e-01   -7.085548960270528e-02   -1.881029610560280e-01   -2.660052852771314e-01   -3.878760256030122e-01   +2.297760446764489e-01   -6.421282633707402e-01; +4.516681164453311e-01   +4.834970159391943e-01   -3.212936129615547e-01   -5.505587411720204e-02   +4.298698509662388e-01   -1.799098835579312e-01   +3.629790503749569e-01   +2.619876867367319e-01   -4.688257087065535e-01; +7.902663347423110e-02   -3.258221888395195e-02   -3.811888319936307e-01   -6.366915542484198e-01   -3.179555787796106e-01   +4.824015853835117e-01   +1.010650876043706e-02   -2.040660668644803e-01   -2.979088748618378e-02; -3.573273260906629e-01   +5.340929365045426e-02   +1.850255716920868e-01   +7.940434151234529e-02   -2.123222049840239e-01   -5.193305551899255e-01   -4.434134851262869e-01   -2.697185393939884e-01   -5.587556419390168e-01; -5.083421104980123e-01   -2.691956115505714e-01   +1.198586879021157e-01   +1.383357428038798e-01   -6.103733972494712e-01   +3.867337813139832e-01   +3.282899562945037e-01   +4.250347585738912e-01   +2.203411498205385e-01; -1.251107237253158e-01   -5.498838153733103e-01   -2.550198331698562e-01   +1.467388289094060e-01   +7.598737194829457e-02   -1.393820836370934e-01   -1.633654179112808e-01   +1.764961949713839e-01   +4.735255244183761e-01; +3.668228409444306e-01   +1.248414877892442e-01   +2.105451737598244e-01   +4.793719748472505e-01   -1.474256290773733e-01   +2.807758290686224e-01   -1.000000000000000e+00   +6.685684606261147e-02   -4.323250260995696e-01; -4.299011685207795e-01   -5.905210511692499e-01   +4.669111811673903e-01   -1.356889134167740e-01   +4.348840520315745e-01   -2.787416262126828e-01   +3.033248353310563e-02   +3.739115172628253e-01   +2.126286129304390e-01; +2.357397511937075e-01   -2.694644652302194e-01   +1.108523717870309e-01   -1.210232752742087e-01   -3.640992712585127e-01   +4.180182865232951e-01   +6.563849932104391e-01   -4.459070038114283e-01   +2.921152313656326e-01];
L1_L2_iAMPA_netcon = [-5.297585403950466e-01   +6.151095071334032e-01   -6.194444903151547e-01   +2.773727630971855e-01   -1.071663744401679e-01   -1.418253524277336e-01   +3.075237664055497e-02   +2.206420153752063e-01   +2.099318449999687e-01; -5.372632868799162e-01   -2.098557984945572e-01   +5.137782195712333e-01   +3.673887161318878e-01   -1.030406991442040e-01   -3.419917895936700e-01   +6.053940333153792e-01   -6.276484208348526e-01   -5.424362078780209e-01; +1.797237746720864e-01   +4.622337127673477e-01   +4.183243477428161e-01   +1.856273573569483e-01   +5.935979401911774e-02   -8.610317773835172e-02   +9.581484202521806e-02   -4.787698133790850e-01   +3.429669039213999e-01; -3.920495862274185e-01   +2.800091006193169e-01   +3.383363518471397e-01   +4.435572157044133e-01   +7.067700330533205e-02   -2.942582173601554e-01   +3.113869804612862e-01   +6.386417258687688e-01   -1.559714471072812e-02; -7.284818234784576e-01   -1.980695788329251e-02   +5.478151146219526e-01   +1.370171341673123e-01   -3.969001961688293e-01   -9.051433629015300e-01   -6.000390062667991e-01   -4.911848568806354e-01   -9.585818158222718e-02; +3.277735827236600e-01   -5.857142914015669e-01   -6.051549939836626e-02   +1.746928145292388e-01   -3.475054503494147e-01   +7.530755445397362e-02   -1.775188084244004e-01   +1.669866373913724e-01   +9.384612088189734e-03; +4.145074658200027e-01   -1.595259446919934e-01   -4.302995343166044e-01   -4.237795597964170e-02   -3.151772052354184e-01   -2.646355166319858e-01   +6.501744965485068e-01   +7.460659683107998e-02   +6.902379504378533e-01; -7.581343511816279e-01   +5.803531645064088e-01   +5.305431893228723e-01   -3.703763861728948e-01   +4.887944510242272e-01   -1.485838615392809e-01   -5.003032287892519e-01   +2.800055613959522e-01   +1.105287651109686e-02; +4.214860249000804e-01   +1.523805984396269e-02   -2.561499816620841e-02   -1.891807667585432e-02   +2.812355338655950e-01   -1.065447216173670e-01   +1.455515737274901e-02   +3.580650297368859e-01   -2.663206716990383e-01];
L2_L5_iAMPA_netcon = [-1.159184395117212e-01   +1.241061118995175e-01   +3.885989330904555e-01   -3.525396526937701e-01   +4.835869669364601e-01   -6.247188910738349e-02   -1.674742744722113e-01   -3.002947555352662e-01   -1.563653442149881e-01; -7.271744477452430e-02   -3.401141048878938e-01   +1.720144764549155e-01   +2.658233294767940e-01   +2.639089933376262e-01   -3.265081708948169e-01   -1.405710791484494e-01   +6.511216040861845e-02   +1.999545909089126e-02; -1.517583525022083e-01   -5.700763211725252e-02   +1.340435434815330e-01   -2.545603035577799e-01   -3.681562771741821e-01   -7.736468820995231e-02   -1.279355943682718e-01   -1.902841487555934e-01   +4.485131600086749e-01; -5.454989458594162e-01   +7.471907349797162e-02   -4.723206486566612e-01   +2.794046995798969e-01   -2.317874499906216e-01   -1.490526431792540e-01   -2.323986320004553e-01   +2.960651701554949e-01   +6.826912179035887e-01; +2.610487725591232e-01   +5.871670031419491e-01   -5.625392514838395e-01   -5.068249472761438e-03   -9.444926990627635e-02   +4.487133123565740e-01   -2.071609293944115e-01   -2.759546198308257e-01   -5.655154661559636e-02; +4.576104839016853e-01   -5.004688433546373e-02   +3.740987023049915e-01   +3.515642005796966e-02   -2.740045814518539e-01   -1.864871419963429e-02   -2.136587396701242e-01   -2.224022766973779e-01   -2.135371450850924e-01];
L5_L2_iGABA_netcon = [-3.651096469303738e-01   +8.691018131829936e-02   -3.487824521362179e-01   -5.176108407237520e-01   -3.332451659468132e-01   -1.382206835269190e-01; -7.094319745261002e-02   +2.007627204898529e-01   +2.703665229382107e-01   -5.714189780558710e-02   -2.355879124427595e-01   -1.533716558028182e-02; -5.699594514672994e-01   -1.514822114611638e-01   +6.975504287554635e-01   -4.611783013464292e-01   +6.360349314564215e-01   -6.765879066256930e-02; -9.896447937568636e-02   +2.887095602743316e-01   -1.153358254767168e-01   -3.307036935014997e-01   +2.358173399027813e-01   -7.028647873953406e-01; +7.519689652876410e-02   -2.233475977255163e-01   +1.073385571258369e-01   -5.387115546981296e-02   -4.174654545920847e-01   +2.686595468078007e-01; -9.151916973842462e-02   -6.558984872676871e-01   +2.318535745253561e-02   -4.067440980773300e-01   +1.824898024325955e-01   -1.026012485420936e-01; +3.754776673158873e-01   +6.580586676919107e-01   +3.470631655577791e-01   -1.585698517074012e-01   -2.917809720255901e-01   +5.727828888838972e-01; -4.960398703945934e-05   -4.456829307262410e-01   +3.545129427729786e-01   -6.665179672309212e-01   -1.685163019549288e-01   -1.378120748834909e-01; -1.354463905931354e-01   -1.963976384145469e-01   -5.941539704675891e-02   -5.560879193673421e-02   +1.426116767711846e-02   +5.736190337324032e-01];
L3_L2_iAMPA_netcon = [+2.841524441976139e-01   +2.453162598224106e-01   +2.353469996086502e-01   -2.820780768661716e-01   +9.060439662533568e-02   -7.492644541468996e-02; +1.266120212902221e-01   +1.068302882216039e-01   -3.771125710075919e-01   +2.248593098582379e-01   +6.024133919504093e-02   -4.380759044883421e-01; -4.931302977383839e-02   +3.051552152401032e-01   -5.241520100745753e-01   -3.988615147075263e-01   +5.310573578635674e-01   -5.304351969423887e-01; +4.007010400142645e-01   +2.027554401189652e-02   -5.211449751811545e-01   +6.832085379255328e-01   +3.489614707695647e-02   +1.060124935179037e-01; -1.177701899669765e-01   +2.883300776922040e-01   -7.338235677225566e-01   +3.691940005359848e-01   -4.937827330389207e-01   -3.023810606955819e-01; -6.338129203704599e-01   -2.238003123418066e-01   +6.571527676855540e-01   -5.853074866868955e-02   +1.578132672741823e-01   -1.275409071336736e-01; +6.326761006981368e-02   +5.757781388871401e-01   +3.602313026995925e-01   -1.661762934759281e-01   +1.608259868536258e-01   -4.263292544454982e-01; -5.301813252142775e-01   -1.994198301397230e-01   +8.312402545528975e-01   +1.654314778376769e-01   -6.076354338370760e-02   +5.128827390170685e-01; +6.226821422048239e-01   +2.275671708463554e-01   -6.045082620792844e-01   -3.566328270276650e-01   +3.532691352408145e-01   +3.084713627354524e-01];
L2_L3_iGABA_netcon = [+4.994783030147556e-01   -1.825410907430455e-01   -3.303985610170324e-01   +1.635069244953111e-01   -8.816189858956716e-01   +2.728983939916669e-01   +8.287520266650535e-02   -1.562375290640529e-01   -1.391418488009948e-01; -4.706122810159156e-01   +2.655070178033260e-01   -1.679089965118273e-01   -1.341025077517713e-01   +3.530238179532379e-02   +7.007223732070363e-02   +2.509793451471248e-02   -6.687379852835806e-01   +4.330906367421994e-02; +3.572399701665565e-01   +3.099052161527253e-01   +1.102923987098848e-01   +2.742724667006460e-01   -6.751170872291448e-02   -1.021523375001879e-01   -1.965628529886691e-01   +2.536124129819175e-01   -4.439637630225171e-02; +5.129992737595522e-01   +3.163340118360827e-01   -4.175099254363062e-01   +2.526667768591671e-01   -1.921493228497754e-01   +2.617613061594406e-01   -1.555869501109873e-01   +1.539497563421011e-02   -1.637242995764689e-01; +3.412930354768814e-01   +1.038853344019935e-01   +5.318922515391034e-01   +5.974609847800614e-01   -4.149219017147707e-01   -1.502369830501829e-01   +1.790824121992976e-01   -1.727223403874244e-01   -5.866060794049848e-01; -1.970168792589293e-01   +5.983068819930872e-01   +2.229215836975199e-01   -7.350714407612219e-02   -5.034946800384719e-01   -3.325400371361730e-01   +4.101515637830540e-02   +3.843805046782580e-01   -1.951147965571783e-01];
L1_L4_iGABA_netcon = [-7.681224191621135e-01   +1.244713209065290e-01   -1.094141812858633e-01   -8.482740368336315e-02   -2.774476340855766e-01   +1.000000000000000e+00   -3.393989391718978e-01   +6.972718206534136e-03   -4.304857453214796e-02; -3.081726322560731e-01   +1.803873363811804e-01   -1.677517453325736e-01   -1.669860599489427e-01   -5.777167830123867e-01   +2.572099460011915e-01   +1.301751755197903e-01   +4.320752238485887e-01   +4.327751015135427e-01; +3.302720718339563e-01   -9.813393316677056e-02   +4.918774284878246e-01   +3.022972169205209e-01   -2.745568091372327e-01   -6.379450343564971e-02   -4.051710016944905e-01   +1.036055091686499e-01   +4.860502314485168e-01; -1.141954945367363e-01   +2.825960639650833e-01   +1.894795306021922e-02   -1.975543270841721e-01   -1.889732083336148e-01   +7.073206903771661e-01   +4.562039345357498e-01   -2.135313558877313e-01   -2.853866120942130e-01; -3.251002532588748e-01   -9.352558344867133e-02   +6.775423067050278e-02   -4.283700682630799e-01   -5.765554037349470e-01   -6.130730665080675e-02   +2.776568806522973e-01   +5.203949660632765e-01   -2.551927012143636e-01; -7.624283219506975e-02   -5.871054386855912e-03   +3.273251121515600e-01   -1.682739372270566e-01   +6.266548592029233e-01   -3.091559279927124e-01   -3.121410609574881e-01   -1.717820597576520e-01   +2.514053371167832e-01; -7.435351678759036e-02   -5.762000317727065e-01   -3.113674867947906e-01   +7.878835313114031e-02   +4.839317073023414e-01   +2.032287059796890e-01   +6.870528377343184e-01   +2.850594379319232e-01   -7.923246037689360e-01; -1.163254278049710e-01   -9.350279402696192e-02   +9.449260386304965e-01   +1.961108256654028e-01   +7.246705961473517e-02   -9.284103463044936e-02   +1.465008136019067e-01   -5.898921921117464e-02   +2.366286040195370e-01; -1.755436198641011e-02   -2.648070947058224e-02   +2.922680961050362e-01   -2.873188136748569e-02   -1.908033531935755e-01   -4.091670223479943e-01   +6.386253804823998e-02   +4.639784553686006e-02   +7.155230933846646e-02; +1.569779230134865e-02   -6.738079205257443e-01   -2.230291696397235e-01   +3.702288062316168e-02   +2.197178661590020e-01   +2.259411338900039e-01   +2.501262667756102e-01   +3.825581437545886e-02   +2.232695402375910e-01; -6.902837699305277e-02   -7.926336477625870e-02   +5.601159509502363e-01   -1.627601441386666e-01   +1.853285313172975e-01   +9.173502177102014e-02   +7.640152749937551e-01   +1.436663872377625e-01   +2.677713016907675e-01; -1.355803281841801e-02   -4.620027182367527e-01   -5.336874533706760e-01   +1.391925243061505e-01   +1.528909846834817e-01   +3.141076468140576e-01   -9.756008786532215e-02   +1.830767839977852e-01   +1.773012183220163e-01];
L4_L1_iAMPA_netcon = [+8.642756797184531e-02   +3.853440415832787e-01   +4.371108050513708e-01   -1.882078775839491e-02   +4.226490168417143e-01   +3.218468869006205e-01   +3.643702342029562e-01   +3.123984164094031e-01   -3.688768907028789e-01   -8.277430182644751e-01   +1.464778283481078e-02   -4.043064031471371e-01; +3.953060969861810e-02   -1.203003528506156e-01   -2.246849785935581e-01   +4.376100794017521e-02   +5.094967364034253e-01   +7.358959928894648e-01   -1.196966939800741e-01   -1.767145470255979e-01   -7.796885713854780e-01   +1.990258387128618e-01   -3.761800652406596e-01   +2.582269255046012e-02; +2.197096773221517e-01   +4.491673908624895e-01   -1.405076147653257e-01   +2.475820730343571e-01   -3.731317960487997e-01   +4.214407294641850e-02   -2.755741721157649e-02   -3.515017164492040e-01   -2.347904032055835e-01   +3.572938459719917e-01   +5.187989270381466e-01   -2.399679060110358e-01; +7.590953486829025e-02   -4.445291944348334e-01   +6.267026964165419e-01   +7.974341555192132e-01   -2.245768335105112e-01   -1.295184013678543e-01   +3.445188696526683e-02   +4.605701606096865e-01   -2.031989832160777e-01   +4.045715321164315e-01   +7.460281469316252e-01   +1.665044395799067e-01; -1.747869273704086e-01   +3.158701204955566e-01   +3.545684531966451e-01   +3.310675310935591e-01   +3.077982104282272e-01   -5.962726177926359e-01   +2.557939474806322e-01   -3.100266969201379e-01   -6.165096636703018e-01   -2.845681867505517e-02   -6.409677646335221e-01   -2.263444928327384e-01; +4.650581240923063e-01   -2.363994648821945e-01   -5.471247569555643e-01   +6.965660887390476e-02   +1.607441900318226e-01   -1.704209195165224e-01   -1.925621677639649e-01   -6.564911127857966e-01   +8.636423936994989e-02   +1.045481013691598e-01   +5.637104255918235e-01   -6.469086143499562e-01; +2.945593390388199e-01   +8.617595132019179e-02   -3.223861799794933e-02   -5.932342336293914e-02   +1.478943071625612e-01   +4.519977366781864e-01   +4.708633915976383e-01   +5.724482339748292e-01   -4.450100172157168e-02   +5.697610942615965e-01   +6.209203558638983e-01   -3.007739369255764e-01; -3.551035119171152e-01   +2.240767744099440e-01   -3.831693312611675e-02   -1.937469120376343e-01   -1.128158673857235e-01   -3.939845662980522e-01   +2.595634286718729e-01   +4.803829901622753e-01   -2.388466295284891e-01   -3.086508598417906e-01   +2.160751146235762e-01   -6.592791604883794e-01; +2.707876613671082e-01   -2.668262979552344e-02   -3.158444137875099e-01   +4.494534552083470e-01   -1.359669694999261e-01   -2.108755828881342e-01   +5.515919773770410e-01   +3.330887897386181e-02   +2.411064674500317e-01   +3.559527282890858e-01   -2.211426503156377e-02   +8.296765509663560e-01];
L1_L3_iAMPA_netcon = [-2.802101605073534e-01   -2.803747388157703e-01   -2.835794667793849e-01   +1.622777418729640e-01   +1.472271662779417e-01   -3.011785236128807e-01   +1.739668464125207e-01   +1.681419558832462e-01   +3.713670661995148e-01; -4.663868363579636e-01   -1.098933064055387e-01   +5.748321559298637e-01   +4.996488103057446e-02   -1.581512374217867e-01   -1.239040008196221e-01   -2.666975857985380e-01   +1.363802407263284e-01   -1.081623937435394e-01; -1.632272703973654e-01   +6.056825925532077e-01   -1.857961282684261e-01   -4.297719288838802e-01   +5.088288688358216e-01   -5.613520691054598e-01   +2.757294820837960e-01   -5.612676064733603e-01   +1.654964072864215e-01; -4.643963172943344e-01   +1.277191849207454e-01   +2.272023858734434e-01   +1.018138013841027e-02   +5.597312961949406e-01   -5.544515087445686e-01   +4.291374251671004e-02   +2.243422341477294e-01   -2.737212038842788e-02; +7.062025358150312e-01   -7.318163245330452e-02   -2.394250116700927e-01   -4.584216151243674e-01   -3.518945685670197e-01   -4.843810397204357e-01   +4.017384048524002e-01   -6.179495108692099e-01   +5.693098043808770e-02; -4.429938708304455e-01   -4.918709119014891e-01   -8.262612287533426e-02   -2.780291028070024e-01   +4.239839672140402e-01   +5.518518877598702e-01   +8.134069882898453e-01   +7.620129451950977e-01   -5.464479805656236e-02];
L3_L1_iGABA_netcon = [-5.870637109222641e-01   -4.391497557368904e-01   -3.403154322094555e-01   +3.184614391845624e-01   +3.219735065184811e-01   +2.750505986707074e-01; +1.317696506224249e-01   +5.522644159472662e-02   -1.833768921278716e-01   +2.962670384508070e-01   -6.868634971263310e-01   +3.084001234302206e-03; -3.993594636434366e-01   +6.013408828973621e-01   -3.172258348887984e-01   -6.835586715100186e-01   -8.205719378831175e-03   +2.515799411421917e-01; +1.289448761761380e-02   -3.264740746529990e-01   -3.342371147433046e-01   -1.696040416762654e-01   +7.363104934235565e-01   +2.504903196770575e-01; +3.137191588531471e-01   -1.504171459654845e-01   +7.305220849884032e-01   -1.355616226949537e-02   +1.934462295316420e-01   +2.494021255676154e-01; +4.612631598320750e-01   -2.312163384699268e-01   +1.766032580902838e-01   +5.596085661497425e-01   +3.587069835645112e-01   -4.371795728053843e-01; -3.614042328680692e-01   +7.246752344244884e-01   +4.182489652754651e-01   +4.202208498037542e-01   -1.633610831727032e-01   +7.275892205086872e-02; -3.965410896576477e-02   +5.096937675804738e-01   -4.025512342248942e-01   -8.017703345575117e-02   +6.651855775061003e-01   +4.181679432470793e-01; -1.183828529637161e-01   +3.306455737224659e-02   +3.548803055101652e-01   -3.304242854574960e-01   -6.019003816803222e-01   -2.831422882066647e-02];
L5_Input1_iAMPA_netcon = [-2.429136036740641e-01   -1.471499142232973e-01   +4.579876248715638e-01   +5.231716870451375e-01   +2.214279163352819e-01   -1.042419425677728e-01];
L6_Input2_iAMPA_netcon = [-1.184903453978899e-01   +2.854526303684217e-01   -3.350260287438516e-01   -2.775494784034888e-01   -5.345187788493849e-02   -1.277019196291608e-01];
L5_L6_iAMPA_netcon = [-2.985063569512733e-01   -2.498649211369950e-01   -3.035359015996702e-01   +5.900896792811607e-01   -5.234681051964083e-01   -5.100047420764535e-01; -2.626210469962034e-02   +6.775877813513478e-02   +1.899834977660773e-01   +1.688948277012324e-01   +8.173521991772932e-01   -3.243249227410312e-01; -1.805251810995208e-01   +1.235503335929911e-01   -2.878528899871296e-01   +1.952973597579142e-01   +4.875376699201304e-02   +1.948634313500141e-01; +2.242195254996416e-01   +1.258779887279235e-01   -3.607527634408897e-01   -5.621834354512401e-01   +3.829520540934579e-01   +4.278101882976481e-01; -1.728068562083407e-01   +3.284042543739750e-01   -1.876691998048294e-01   -2.035028379360702e-01   -2.666401178185608e-01   +6.368645862158403e-01; -2.222341683595654e-01   -1.396412250322748e-01   -4.413039444366551e-02   +3.980287927540901e-02   -2.687260047831743e-01   -2.007708865028773e-02];
L4_L5_iGABA_netcon = [-1.400740012583856e-01   +3.691052005351773e-01   +5.820018011264385e-01   +2.395374443316204e-02   -1.941400340149012e-01   +8.271529989240300e-01   -2.333237780301875e-01   -1.741361250346485e-01   -5.224298592311466e-01   +2.335252344181363e-01   +3.323771398015974e-01   -1.002160031961296e-01; +1.462581869889442e-01   +2.126220238215569e-01   +6.469887584643000e-02   +3.941217208531055e-01   +1.395155447851650e-01   +1.706570916379657e-01   +3.596035749671224e-01   +7.267819339009085e-01   +4.077486637733862e-01   -2.333729145237786e-01   +1.271944180110577e-01   +7.135216677167461e-02; -5.961510020036312e-01   -2.678064585837373e-01   +1.307126575163164e-01   -1.267720018479604e-01   -1.222331420756725e-01   -2.303481852530519e-02   -1.273413200480894e-01   +2.317728395772301e-01   -1.449931476203180e-01   +8.517882667046932e-01   -3.931427903928184e-01   +1.507392457669063e-01; -5.996375191256156e-01   +4.128383308478930e-01   -5.781614582737479e-01   -3.806381974226428e-03   +5.776337152846279e-01   +1.269063773922059e-01   +1.917523493439165e-01   -3.420824914163987e-01   +6.908069463330796e-02   +2.309271021740122e-01   +1.000000000000000e+00   +4.794653762812385e-01; +4.181518613913594e-01   +1.207739392032199e-02   -3.407652822810722e-02   +5.535871985544670e-01   +2.687886156608900e-01   -2.220769384472713e-01   -7.288156122650719e-03   -3.292942287436023e-01   +7.524419908369090e-01   +3.561406894435716e-01   +4.823161153958754e-01   +2.339738517821029e-01; -3.534063321810534e-01   -5.118688412278503e-02   -5.594099386136980e-01   -2.360531464106376e-01   -5.930743857507452e-01   +5.636924421042024e-02   +6.820300463256986e-02   +8.554087786013224e-01   +3.066809137611368e-01   +5.591509943905136e-01   +4.467070671070040e-03   +2.380130993312236e-01];
L6_L4_iAMPA_netcon = [+2.425936571295984e-01   -6.613144716141377e-01   -3.940237952744845e-01   -2.134212742246925e-01   +6.961974587880118e-01   +3.801650314028053e-02; -5.349839644220280e-01   -6.587990501187957e-01   +1.102250047592797e-01   -9.398725419751464e-02   +2.981328959445955e-01   -4.510990621296136e-01; -7.916665554920908e-01   -5.545707373129579e-01   +1.785389321283445e-01   -1.251172671220669e-01   +5.811574765905327e-01   +6.564360666656219e-02; +3.516292724056788e-01   -2.701563106443299e-01   -3.147539503447289e-01   -4.258991024850972e-01   -3.094100275885509e-02   +1.110094238224088e-01; -5.239870047560963e-01   +3.958501411510751e-01   +2.285059682299458e-01   +1.130674238546194e-01   -1.387019746224364e-01   -2.035701796884457e-01; -2.262437744089062e-01   +4.908735770474222e-01   +4.445205302168612e-01   +2.433382003040599e-01   -2.231179645215526e-01   +2.476976610316839e-01; +7.010138932163326e-01   +2.222085613443485e-01   -3.469836421849656e-01   +6.069539372974622e-01   -6.285075554383773e-02   -5.646423169442215e-03; +4.443374562288718e-02   -1.139925897493271e-01   +2.494142801771628e-01   -4.083185716231164e-01   -1.984508025132140e-02   -1.874712191096240e-01; -2.632797550572801e-01   +1.103331136361928e-01   -2.916386776429308e-01   -1.533128528960065e-01   -1.499030785919252e-01   -4.036412071888738e-01; +4.014641672310332e-02   +3.826404975362834e-01   +8.435267253839007e-02   -5.698257685792359e-01   +7.845134718077931e-01   -4.241615867741596e-01; -6.008504922850469e-02   -2.716264719347395e-01   +3.650651311422407e-01   -7.296585242316153e-02   +1.536515677378257e-01   -1.093310295560201e-01; +4.375579947250424e-01   +5.431758904793663e-02   +2.991278311588664e-01   +2.812417712192085e-01   -2.026502670146994e-01   -8.871028559327186e-02];
L5_L4_iAMPA_netcon = [-4.228986940601228e-01   -2.950866069982059e-01   -1.830038975824726e-01   -7.055944077279766e-02   +3.857774232124704e-01   +1.014493751480095e-01; +1.201724502090281e-01   +1.053895322161972e-01   +1.251611891210902e-01   -1.892027034818278e-04   -2.569709045370537e-01   +7.131210265919583e-02; -3.973447238309542e-02   +6.386577743807016e-01   +5.308638694493488e-01   +2.664311406499034e-01   +9.265331074913347e-02   +1.253460853609576e-01; -1.128097608665711e-01   -3.716216059346376e-01   +1.753559024617883e-01   +1.120891635563081e-01   -2.972514330037462e-01   +4.259065020388970e-01; +1.210183699705999e-01   +3.778210920124522e-01   +6.476967971572931e-01   +3.914084888176302e-01   -3.810419219200288e-02   -6.100009427318820e-01; -3.257175897460218e-01   -1.331445151961557e-01   +3.999543002626584e-01   +1.688087256728641e-01   -1.450194055024479e-02   -2.684662060597158e-01; +5.949789112841338e-01   +1.164539775002580e-01   -2.020825845340561e-01   +1.868552197554095e-01   +2.797787656499960e-01   +4.433754338877161e-02; -1.684914355252023e-02   +7.504557967453880e-01   +5.836683903270639e-01   +3.226232509994248e-01   -3.812717531818249e-01   -2.922507992376577e-02; +8.568996689771216e-02   -1.221465115502555e-02   +3.768469322087349e-01   +4.370428047243282e-01   -5.355800740429437e-02   +6.168674855335239e-01; +5.395020942436390e-02   +7.059121482926788e-01   -7.153023914089627e-01   +2.669126551165935e-01   -5.991798763768740e-01   -3.621344219442322e-01; -3.006938862871636e-01   -3.929415898450705e-01   +9.505173628973994e-02   +5.837760002566306e-01   -7.110258237358876e-01   -3.641629354535103e-01; +2.940059461057185e-01   -6.030816949219999e-01   -2.752561485900365e-01   -3.008500621010706e-01   -7.893964637644366e-01   +2.124788767198965e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
