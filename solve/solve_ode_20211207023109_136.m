function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.289180836392284e-02   +8.911223942233047e-02   -1.176718360825619e-02   +1.126252540248553e-01   +2.216556630515797e-02   +8.205884075576723e-02   +1.181269645553232e-01   +7.682029187384549e-02   +6.745778133402566e-02; +4.176076382555980e-02   +3.423293046595872e-02   +1.787768153860873e-02   +7.422271012569807e-02   +1.786552141719313e-01   +5.967062918800005e-02   +8.282358195936011e-02   -5.482959299312300e-04   +4.499952847997341e-02; +4.954331942196878e-02   +1.003426752491594e-01   +8.544441777181977e-02   +6.081940851642131e-02   -1.742361024642853e-02   +1.776442802922635e-02   +1.975123708152733e-01   +7.837196746901842e-02   +7.120235095204827e-02; +1.203019750458084e-01   -1.094666726679361e-02   +8.965741097546469e-02   +1.997855926321985e-02   +4.654440446077583e-02   +7.277110270026942e-02   +3.523705345660685e-02   +1.037051797488888e-01   +9.212550632420533e-02; +5.245774993529674e-02   +5.333799336366065e-03   +1.100946132236220e-01   +8.665231045380664e-02   +1.327125712017192e-01   +1.446828582787490e-01   +7.637621472219482e-02   +5.006980334004599e-02   +7.788202203091260e-02; +7.271269031385208e-02   +1.843041130350900e-02   +9.539735917400481e-02   +1.446121098935837e-01   +8.242137873366509e-02   -1.782402367337405e-02   +1.573192511592331e-01   -9.142781115725678e-03   +6.860603855756355e-02; -2.067484423391136e-02   +9.581243417024985e-03   +9.104349291813027e-02   +9.601190739392301e-02   +5.249942691114510e-04   +4.589465638834248e-02   +4.059892558772541e-03   +8.425229712350182e-02   +8.939686720936507e-02; +6.911697248324278e-02   +4.753972059661991e-02   +5.913169091140317e-03   +5.648363752691831e-02   +7.758235454719666e-02   +1.832995462422705e-02   +9.357335961391221e-02   -2.276614287663742e-03   +1.443234687556043e-02; +4.860376715957778e-02   +8.388699327748300e-02   -8.395005037901051e-03   +7.222791323614358e-02   +1.555824081964056e-02   +1.398121798288509e-01   +6.423066198257572e-02   +2.929644100363054e-02   -9.888810894492192e-03];
L1_L2_iAMPA_netcon = [+8.607925786754517e-02   +8.655104175102628e-02   +1.004966561721359e-01   -2.861953656981299e-02   +1.289221694867055e-01   -2.834312327076865e-03   +1.096451782094187e-01   +6.079698562265468e-02   +1.157052715338345e-01; +5.257920421646344e-02   +1.877302460151945e-02   +1.162999013163869e-01   +3.595883388698378e-02   -5.577561718713821e-03   +4.887386539412589e-02   +9.981289485459613e-02   +1.066924122412848e-01   +8.020665522342679e-02; -1.726352664134546e-04   +4.078677238172421e-02   +1.027137567617586e-01   +6.391678258464276e-02   +2.621352385455602e-04   +6.951410014720460e-02   +9.556098976113227e-02   +1.285780378901241e-01   +4.829626398873708e-03; +4.275258459957638e-03   +1.045245724251972e-01   +7.026796695273979e-02   +1.180881916878756e-01   +3.862069004731420e-02   +4.801253391319722e-02   -4.134095151020903e-04   -3.580341488187676e-02   +8.595570724897669e-02; -2.859609421728751e-02   +1.678954051300065e-01   +1.472002667435222e-02   -2.369001936257713e-02   +3.639612305723619e-02   +8.213400557414424e-02   +4.810219874128069e-02   +6.923603390276607e-02   +9.077387869605599e-02; +7.823788040329521e-02   +3.733993199770604e-02   +8.720930736590549e-02   +4.899476332803589e-02   +1.074632641084419e-01   +3.157323893882271e-02   +1.159545850153546e-01   +1.377228867716652e-01   +4.597086647826126e-02; +1.232326650673817e-01   +1.523521170187265e-01   -2.300037957390117e-02   +7.094282288579482e-02   +5.623511019691926e-04   +9.233711667873523e-02   +5.964162408715757e-02   +1.282800050128358e-01   +2.354486802138005e-02; +7.513750028704079e-02   +5.894607110147159e-02   -1.903107686307427e-02   -4.318187552143253e-03   +8.672912863368028e-02   +4.496831020903995e-02   +8.103858061763700e-02   +1.041337537025271e-01   +1.434818692017059e-01; +1.436969718833282e-01   +1.010096765474451e-01   +4.010789129705079e-02   +3.718064295271269e-02   +7.776781682264616e-02   +1.843854034807530e-01   -1.588337953345169e-02   +1.874637442459804e-01   +1.382184526820729e-02];
L2_L5_iAMPA_netcon = [+1.492818516382892e-01   +4.656460413033758e-02   -7.181973609973183e-03   +1.377761337390786e-01   +1.340094561293742e-01   +1.048229203150438e-01   +1.363801211784791e-01   +1.356090158045574e-01   +9.398632086769375e-03; +8.496894032412851e-02   +1.571506364677925e-01   +4.476803174800661e-02   +1.310649621733059e-01   +2.479229688521466e-02   -9.658283834562470e-04   +1.169738500667908e-02   +4.795155572025144e-03   +1.328072508145273e-01; +1.062535554494426e-01   +9.348588187003057e-02   +4.187354859195671e-03   -1.988174408170376e-03   +7.642310244306523e-02   +1.691066973844935e-01   +9.494987018997338e-02   +1.011284589244516e-01   +7.390575038851861e-02; +3.568717082420635e-02   +7.432250516896430e-02   +6.882750414391593e-02   +1.265712612976814e-01   +7.038399827872804e-02   +1.051612086286742e-01   +7.274538181547813e-02   +1.505585710079348e-01   +7.389729203478117e-02; +4.415061248024309e-02   +2.021799951371983e-02   +2.050976827488885e-02   +6.979878234726816e-02   +1.215987403150742e-01   +7.595797797318246e-03   +4.170842757884881e-02   +1.573981911956088e-02   +1.827524993493844e-02; +9.608731776369805e-02   +1.031879363230366e-02   +3.651352380653877e-02   +1.365054739221305e-01   +4.556704114884449e-02   +1.690654419217298e-02   +3.424912513765815e-02   +1.081360382429409e-01   +1.501888850026127e-01];
L5_L2_iGABA_netcon = [+1.949957666625488e-02   +2.663698620875269e-02   +8.956045447651154e-02   +1.503375681353223e-02   +5.420758774630727e-02   +1.692810620375031e-01; +1.428466953411592e-01   +3.199605799888857e-03   +9.841450240871412e-02   +4.788290675845385e-02   +8.221007766309125e-02   +1.169889550515583e-01; +1.845871863557404e-01   +1.403066726660636e-01   +9.757111013475353e-02   +4.117729615932516e-02   +1.394581359358959e-02   +6.588006168462361e-02; +1.835166938335017e-02   +2.115080708761653e-02   +7.076775679205309e-02   -1.382753703092712e-03   +8.936028110368445e-02   +1.339454487215131e-02; +7.347560326831183e-02   +1.001049763549421e-01   +8.640614888766292e-02   +8.782374940435088e-02   +2.942246473835531e-02   +7.750722154888334e-02; +3.780030375297487e-02   +6.033640066038790e-02   +4.433666079160037e-02   +1.043505255633647e-01   +7.040087396877832e-02   +4.551022146101123e-02; +3.051718091619597e-02   +3.323061574302914e-02   +1.401994578494176e-01   -2.211073360720148e-02   +1.284109403158530e-01   +6.541542751106438e-02; +1.156300770514552e-01   +1.174400992187364e-02   +4.724173634657426e-02   +1.305382543021005e-01   +6.869591024432745e-02   -2.442591564089044e-02; +4.493064183595464e-02   +8.668180739497285e-02   -6.359029256081752e-02   +9.595488638188009e-02   +1.084800133406436e-02   +8.728748249563557e-02];
L3_L2_iAMPA_netcon = [-2.698386093791295e-02   +2.770905121680580e-02   +6.926583791979593e-02   +4.182166047296859e-03   +1.469541119101273e-01   +1.155094309845165e-01; +4.843725503261135e-02   +2.661658955802020e-03   +5.671058781366534e-02   +1.734378210612935e-01   +7.088349886190591e-02   +5.756311154347112e-02; +7.172636775517249e-02   +6.704417107090442e-02   +4.676710944452490e-02   +1.240520350930762e-02   +4.854801027051837e-02   +6.358190532719174e-02; +5.357340437530147e-02   +7.021611721460941e-02   +4.666987575481272e-03   +7.032593504563832e-02   +4.363673171299939e-02   +1.388219491498860e-01; +3.405500432939586e-02   +1.838103663145763e-02   -6.013071969252431e-03   +1.529841284221378e-01   +1.551105088499548e-01   +1.206317272498393e-01; +1.048547638842681e-01   +2.884916321944132e-02   +1.740435387976329e-02   +3.808784086377800e-03   +5.866757092724043e-02   +7.748531649784286e-02; +6.096017284058287e-02   +1.035002959009853e-01   +8.664668034397215e-03   +3.384989744036728e-02   +3.348633414639735e-02   +3.357736899899187e-02; +3.895142129729157e-02   +1.085113643911857e-01   +9.567526538032525e-02   +5.947542721239922e-02   +8.560378680260161e-02   +3.406860628027679e-02; +1.921685409388854e-02   +2.805330330451871e-03   +5.999531451373815e-02   -3.674014294378903e-02   +8.569704698340894e-02   +8.694723809802207e-02];
L2_L3_iGABA_netcon = [+1.132179894841465e-01   -1.418491211928777e-02   +8.708889766496586e-02   +6.471174342609963e-02   +9.141138828880568e-02   +6.269105889484475e-02   +8.186950275067316e-02   +1.311762155322576e-01   +1.415950141773352e-01; -2.323592737789642e-02   +1.457734877194308e-01   +1.213786538876630e-01   +1.065546738358204e-01   +1.120288060141526e-01   +5.547949192285452e-02   +4.228924585158261e-02   +1.022772105678912e-01   +8.854699714775889e-02; +3.121282020671409e-02   +1.314785968147328e-01   +8.240846018664241e-02   +7.480034558365484e-02   +2.346592961559915e-02   +8.622426897322029e-02   +1.210111859942255e-01   +3.729847554474760e-02   +5.987769308211662e-02; +1.480437886108888e-02   +9.596424871276397e-02   +5.320056847477722e-02   +8.604026381334069e-02   +1.057521439508374e-01   +9.420023659407556e-02   +4.403827493321295e-02   +5.241444205533408e-02   -2.112578608650827e-02; +5.383384321792645e-02   +6.402229332283178e-02   +5.265348617280245e-02   +8.175719864070356e-02   +1.529889282922979e-02   +7.737901038923747e-02   +2.250436687349694e-02   +5.271288114372084e-02   -1.521772326632726e-02; +1.217232366529932e-02   +1.191611306248038e-01   +1.551947676667071e-01   +7.661284162331118e-02   +8.350943171874077e-02   +3.968790127076768e-02   +5.704924385642458e-02   +9.942681834913092e-02   +1.352324368149808e-01];
L1_L4_iGABA_netcon = [+3.959081257988394e-03   +1.905633558796484e-02   +4.875308609666718e-02   +6.420371270573398e-02   +1.286020492797132e-01   +6.095091198336966e-02   +1.125035231196937e-01   +2.407104530074788e-02   -1.273944425781576e-02; +1.745987969996611e-02   +1.269995001805297e-01   +1.560663784194252e-01   +6.631972897356048e-02   +7.281311978421041e-02   +1.198432536622271e-01   +1.514304614819592e-01   +9.039192211541396e-02   +6.004634235703515e-02; +9.324106108270398e-02   +5.913266631920779e-02   +9.966058459680889e-02   +8.764850033721906e-02   +1.250700231985050e-01   +1.094061144453814e-02   +2.758353295362024e-02   -2.888059982501345e-02   +8.615982910530862e-02; +3.882602534142800e-02   +5.600902959125819e-02   +1.378860215959757e-01   +7.182362636396634e-03   -4.611961511976528e-02   +2.516640002015100e-03   +9.340643546141877e-02   +7.882493562694279e-02   +1.171537487645116e-01; +5.204962296101560e-02   +1.380207661708616e-01   +6.048893142267096e-02   +9.827024237910749e-02   +1.140462625957567e-01   +9.715472741004651e-02   +1.055062175348208e-02   +1.010880533390988e-01   +4.410437953991077e-02; +3.345040814576389e-02   +9.732092763033084e-02   +5.538494681031102e-02   +9.005371374385263e-02   +2.554032793102549e-02   +8.940853221342164e-02   +8.147264369726502e-02   +8.897822243431333e-02   -2.992465528365384e-02; +4.745108065319644e-02   +7.786574403387010e-02   +7.427656779201912e-02   +1.018173669278130e-01   +1.777761815365882e-01   +6.825297021462283e-02   +6.911812156857872e-02   -1.466815719905563e-02   +3.342968888127536e-02; +7.562712666271633e-02   +3.535779694386446e-02   +1.190243358949394e-01   +6.032585241458589e-02   +8.965113157085790e-02   +3.872860133525301e-02   +7.493091876969865e-02   +7.028210752445457e-02   +1.123426227758027e-01; +6.483565295695161e-02   +5.067150020617973e-02   -2.699991598736089e-02   -1.564927833414276e-02   +1.004261324319483e-01   +9.094687419676199e-02   +6.757654163608848e-02   +7.652240554371770e-02   +2.375651061105371e-03; +1.176850660095670e-02   +1.323895064051947e-01   +8.582322860438560e-02   -3.476404393155009e-02   +5.378674637896751e-02   +3.897751260759864e-02   -2.942697804401578e-02   +1.094027063870530e-01   +1.216900466636250e-01; +1.448139028182112e-01   +7.161631701198330e-02   +3.396949857058635e-02   +1.166987711482678e-01   +5.183152862316865e-02   +1.243399214661942e-01   +4.407883591412626e-02   +6.208918692165825e-02   +1.517391932750560e-01; +8.967729483198850e-02   +2.502734950392466e-02   -1.784408283341188e-02   +1.245355205441707e-01   +5.150798982654136e-02   +9.649122687133596e-02   +8.396484200269863e-02   +6.441535172133629e-02   +1.090380922572939e-01];
L4_L1_iGABA_netcon = [+7.089478844989613e-02   +7.801832854951958e-02   +9.285035261169187e-02   +4.304838100587619e-02   -2.228523477378430e-02   +9.481586753484086e-02   +5.650399550884833e-02   +6.307566509801906e-03   +9.361939029387732e-02   -5.289297575290191e-03   +4.907048235389904e-02   +4.601643560747770e-02; +1.554426652703794e-02   +4.790803237395442e-03   +1.069018455730049e-01   +6.575190227984666e-02   +3.841697508117918e-02   +8.598466057718610e-02   +2.027439720467218e-01   +3.631727310664817e-02   +1.660473236704482e-01   +2.055014923352301e-02   -2.337749968901200e-02   +5.212490109200474e-02; +5.384644680557583e-02   +6.557255243429559e-02   +7.804789080096032e-02   +4.392658236147195e-02   +8.647924741714605e-02   +7.111373255628836e-02   +8.003275491486342e-03   +8.582947711433368e-02   +1.142388469816460e-01   +4.422011066681735e-02   +5.611324634113350e-02   +7.289672802983162e-02; +9.650036473826509e-02   +3.636454741882535e-02   +8.777400525882367e-02   +7.082292992058094e-02   +3.841800446548888e-02   +1.052042316514205e-01   -1.984141273539946e-02   +8.147990721253956e-02   +3.935063341158593e-02   +1.462459446755759e-01   +4.588357357165176e-02   +1.434174482406075e-01; +1.224109354008320e-01   +1.918652151770217e-01   +8.277056770709917e-02   +4.248268391003558e-02   +9.443230661813991e-02   +4.031897230364603e-02   +3.131585616363774e-03   +5.467812647061297e-02   +2.477317699244797e-02   +1.575004840707436e-01   +1.068406730844933e-01   +9.414752819196007e-02; +6.300979419961962e-02   +3.998175970908582e-02   +6.957703402076550e-02   +1.378650354674054e-01   -4.436770970129524e-02   +6.104404974572899e-02   +1.074019351421191e-01   +1.716198832962231e-01   -8.707569048824960e-03   -2.026245295440761e-02   +2.201560784862292e-02   +1.238044016868102e-02; +6.091834698137311e-02   -7.443305977485050e-02   +7.666189877122274e-02   +3.001414657492359e-02   -2.198986607177512e-02   +5.555638725028284e-02   +1.421304040657100e-02   +1.113688732085345e-01   +3.755099680960167e-02   -9.645614797452131e-03   +2.909291744762925e-02   +1.263684552604935e-01; +1.564967223751202e-01   +5.505297139582874e-02   -1.597331642920817e-02   -3.056974558144701e-03   +1.415235658992516e-01   +1.891724887155552e-02   +1.175993342347900e-01   +7.032048289275911e-02   +1.062569478893946e-01   +1.543698861746103e-01   +1.287874158845191e-01   +4.156472556907133e-02; +1.171433993695920e-01   +5.641766116710978e-02   +9.442896843246328e-02   +7.148150316702334e-02   +6.318610483436320e-03   +4.796682383465914e-02   +7.025024479277972e-02   +2.053860504723136e-01   +1.359156914441367e-01   +4.699241197242850e-02   -5.727659464670052e-03   +2.578233861097014e-02];
L1_L3_iAMPA_netcon = [+4.885292826904546e-02   +1.143671840702687e-01   +5.817328632460068e-02   +1.143491946929385e-01   +4.446369650915782e-02   +9.194059476897287e-02   +4.819811961540268e-02   +8.041065777959426e-02   +3.567548799032587e-02; +2.098687620287613e-02   +9.903071114963316e-02   +5.562449306091820e-02   -1.443177186783051e-02   +1.074892373410683e-02   +2.800553424452350e-02   +1.818585805544376e-01   +4.505285216381449e-02   +1.221104968402874e-01; +8.782880527298954e-02   +7.249732320598876e-02   +6.343180106427715e-02   +1.643630532700011e-01   +5.621819734193732e-02   +1.139485925374087e-01   +8.783896842262506e-02   +1.613675270709230e-01   +6.996086033973470e-02; +1.504329022406786e-01   +2.330814435838276e-02   +7.040030342730833e-03   +1.839322455226858e-02   +1.074132528503062e-01   +8.263822477377833e-02   +2.113987274038799e-02   +1.197969557443760e-01   +2.763609744784674e-02; +1.664667426859921e-02   +6.024747130037524e-02   +3.817570972513018e-02   +7.279919585837089e-02   -2.711885939857603e-02   +1.102608537049628e-01   +8.341356800211980e-02   +3.717414020799652e-02   +7.916516607395631e-02; +1.127574565744818e-02   +1.121888617996687e-01   +6.795224060272886e-02   +4.882337289262090e-03   +1.852659685166038e-02   +8.134145271420884e-02   +8.788616308901445e-02   +6.847454426583327e-02   -5.636514390979515e-03];
L3_L1_iGABA_netcon = [+1.352835906154604e-01   +1.247354641735144e-01   +7.749735028204072e-02   -4.019231658471348e-04   +3.528959752490301e-03   +1.017244618017836e-01; +5.271434693253590e-02   +5.802009358026461e-02   -7.717915706358478e-03   +4.046549460255632e-02   -6.566938337875113e-03   +3.851127339001904e-02; +1.096991548569267e-01   +3.329410821152031e-02   +9.409584176793635e-02   +5.305901011152635e-02   +1.197694712122029e-01   +1.158099654786333e-01; -1.153968489606952e-02   +8.908957925403635e-02   +9.188723159670888e-02   +8.033048452760219e-02   +1.600660538433774e-01   +1.168045917848940e-01; +7.168983452397912e-02   +3.408640777830142e-02   +1.298593414737864e-01   +7.568827266244915e-02   +6.164805697016028e-02   +7.842759522163006e-02; +1.380909286421335e-01   +8.381214209337172e-02   +5.348035602557626e-02   +1.248340860781685e-01   +1.652122835055571e-01   +1.098400497650655e-01; +3.019848802572829e-02   -3.466935048504813e-03   +1.456472689767461e-01   +3.720134825374692e-02   +5.127939905876459e-02   +1.787301512883428e-02; +5.844798616749421e-02   +8.110822775744163e-02   +1.256970896774427e-01   +6.749952926246540e-02   +2.274547315780143e-02   +4.033234038302057e-02; +6.754866285454958e-02   +1.472494619220540e-01   +1.187979581113896e-01   +7.875728882358488e-02   +5.001790382885778e-02   +1.224977639379317e-01];
L5_Input1_iAMPA_netcon = [+8.463066960362810e-03   +1.135167109327368e-01   +5.941549708743930e-02   +6.761406186906306e-02   -3.374824218246726e-02   +1.340714832947170e-01];
L6_Input2_iAMPA_netcon = [+9.675679223855234e-02   +9.330319155003736e-02   +2.269445555036605e-03   +6.661336668915416e-02   +7.435227989123487e-02   -1.007086278937655e-03];
L5_L6_iAMPA_netcon = [-4.997572134024489e-02   +1.178366886285318e-01   +1.629830022994238e-02   +1.868145397050331e-01   +3.218219992440587e-02   +3.263959935738787e-02; +6.617932996734075e-05   -8.141281668648014e-03   +1.099338147499917e-01   +1.286629641964682e-01   +1.436029940093764e-01   +9.169658591117409e-02; +1.199299055776559e-01   +1.161410889371919e-01   +8.289512649941322e-02   +2.379518907243575e-02   -1.039939338084915e-02   +1.055631837600807e-01; +8.581095644392617e-02   +1.540554612986331e-01   +9.919514477852348e-02   +2.682103727294979e-02   +4.683944654064417e-02   +1.105136658224807e-01; +2.984807928013014e-02   +1.386476582445816e-01   +1.292348441572055e-01   +7.848136919787732e-03   +6.011359528653487e-02   +6.696627885482029e-02; +1.213687090111475e-01   -5.574038515564410e-02   +1.870459753326558e-01   +2.944259709732223e-02   +1.129946156518436e-01   -6.899567901849290e-04];
L4_L5_iAMPA_netcon = [+2.174243874412110e-03   +8.813598582872230e-02   +1.419080084145745e-01   +6.156636667362866e-02   +5.345881505240881e-02   +1.141430698730964e-02   +1.598959210688672e-01   +4.980411468278616e-02   +6.231583961459993e-02   +1.006090011226461e-01   +1.260921112297388e-01   +5.190408791607542e-02; +4.400938822858935e-02   +1.604165237483503e-01   +3.651476550983140e-02   +9.891069151343999e-02   +2.907368063287803e-02   +7.642306038154088e-02   +1.638364477718059e-01   -8.577431550274626e-03   +7.538849695971397e-03   +1.530942132091838e-02   +9.986301984760783e-02   +1.130596885426648e-01; +5.204553006335807e-02   +9.676983189360584e-02   +2.118750788600646e-02   +4.591922928070538e-02   -4.174864306905707e-02   +1.470469520213921e-01   +2.249138587147672e-02   +5.435136308937515e-02   +1.107772333124569e-01   +9.021345032866876e-02   +9.963216252448066e-02   +5.026513304537588e-02; +6.906833836677739e-03   +8.811546427352827e-02   +3.614666840909806e-02   +1.111058803019680e-02   -7.227469675984239e-03   +9.617739144851356e-02   +4.201973736975301e-02   +4.284874092587389e-02   +1.211138090021466e-01   -1.911426025995028e-02   +1.409467672723966e-01   +4.848463816630692e-02; -3.521727977227656e-02   +9.954723327646518e-02   +6.908042608741910e-02   +7.888290557885655e-02   +8.148795991609688e-02   +8.501374266628695e-02   +1.345631741216406e-01   +1.673900926623957e-01   +6.024523614591352e-02   +1.614408384472533e-02   +9.714290275115975e-02   +1.007765004667074e-01; +1.123295485949509e-01   +9.124145779992525e-02   +6.202397620854239e-02   +1.021552398202555e-01   +8.705215776385415e-02   +1.695417424915605e-01   +3.921630448660970e-04   +4.400657135943045e-02   +6.351044100377715e-02   +1.529998026535883e-01   +1.183381321613172e-01   +1.543926210236005e-01];
L6_L4_iAMPA_netcon = [+9.275145864488725e-02   +9.745179837665080e-02   +8.578342264302478e-02   +4.516470012023240e-02   +8.437214796039837e-02   +9.694001795395102e-02; -1.689297763700806e-03   +5.076705854253447e-02   -1.002404853156675e-02   +6.794931037143768e-03   +7.402962251252664e-02   +6.123503635186638e-02; -1.153383010223201e-02   +2.554114811827880e-02   -4.825536333644675e-02   +2.836813642347197e-02   +1.492857475851573e-01   -3.388016528206576e-03; +1.341887647687022e-01   +1.162293526146731e-01   +5.712099973746829e-02   +4.968294894382222e-02   +1.254307878275976e-01   +2.340316342095883e-02; +1.990576200458012e-01   -5.937063287455569e-03   +4.882701444416539e-02   +4.727451878184942e-02   +9.301745042352427e-02   +1.199652308201137e-01; +1.155733701687886e-01   +1.227465115382857e-01   +7.732642702394996e-02   +9.078394998313292e-02   +3.690358886751652e-02   +1.414223504805468e-01; +5.967832316042940e-02   +1.062902076011003e-01   +2.053119218208415e-02   +8.451588838472679e-02   +1.421198587498440e-01   -6.004086680353326e-03; +2.230777376813965e-02   +1.387354062799424e-01   +1.243173417719651e-01   -8.062785492246169e-03   +1.105729037506628e-02   +1.378341234905062e-01; +2.209513961903852e-02   +3.330276725819811e-02   +1.127606516153525e-01   +3.029612761494048e-02   +3.540997807868323e-02   +2.850905339419693e-02; +5.218616410231642e-02   +7.162714757079468e-02   +1.117229433478671e-01   +8.551831885846514e-02   +1.719170925327549e-01   +7.239843506814764e-02; +1.209034770260590e-01   -6.892127646748588e-04   +1.480430518733373e-01   +4.810736482956222e-02   +6.177691667221090e-02   +4.723929418701354e-02; +7.997429554775651e-02   +8.240153340667482e-02   +5.612038827972162e-02   +2.987850387140306e-02   +7.987151310614206e-02   +8.650640605708571e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
