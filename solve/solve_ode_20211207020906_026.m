function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.844907662917496e-01   -9.207172927512333e-01   +4.600259961294501e-01   +3.951242626499619e-01   +4.051526172552199e-02   +3.952333051989815e-01   -1.636389084045329e-01   -8.347639399199694e-01   +6.814039601208135e-01; -9.970820656980438e-01   -1.288524489857869e-01   +5.911052614159399e-01   -5.432728913001880e-01   -8.786553838319934e-01   +5.432019185165688e-01   -7.901847820724667e-01   -9.498909360434730e-01   +8.040462283185794e-02; -5.675814715273518e-01   +1.961703588714779e-01   -8.467547583592571e-01   +2.432227335165681e-01   -9.051099242154932e-01   +8.641813506216500e-01   -6.854449024542895e-01   +9.304005127913274e-01   +1.000000000000000e+00; -3.490613177276576e-01   +3.830976599073038e-01   +5.101283972775963e-01   -7.876948567253580e-01   +3.328276511586796e-01   +8.033705983559529e-01   +9.984707437485392e-01   +1.329352047134108e-01   +5.575535572250062e-01; -5.439422301861367e-01   -7.429391897309670e-01   +6.936302143283731e-01   -4.672032383425108e-01   +4.749073612884626e-01   +9.446753885385726e-01   -6.013054122071753e-01   +4.230737605807118e-01   -8.798557869025078e-01; +6.025619338380162e-01   +1.325255239909857e-01   +4.139325374479048e-01   +6.318822814267712e-01   -3.513384534432359e-01   +3.349302533961029e-01   +5.995870015352112e-01   -2.917396818195542e-01   -7.295478538210241e-02; -3.454039749729456e-01   +6.635686716095444e-01   +7.012202153303865e-01   -7.595341590069261e-01   -9.632068560736372e-01   +1.390136974473913e-01   +3.854451638858178e-01   +3.567613116971850e-01   -4.967117215740467e-01; +8.101729440342638e-01   +8.135091281729097e-01   +3.302884468305442e-01   -2.145779834843339e-01   +7.933323776974086e-01   +8.347278189473039e-01   -7.954119474313691e-02   -8.303284012778012e-01   +8.423416803592729e-01; -1.900517027645786e-01   +5.026816851350525e-01   +2.394361079156435e-01   -2.201254595065296e-01   +2.584854516085098e-01   -2.855413230436916e-01   -8.059976247868379e-01   +7.458240177203588e-01   +5.103363442988282e-01];
L1_L2_iAMPA_netcon = [+7.132043131685187e-01   -1.977389933838930e-02   -4.887086490469121e-01   +4.030502726970712e-01   -3.249270744341660e-01   +7.572598674747804e-01   +6.410893027407277e-01   -8.679542446218916e-01   +8.164563930034410e-01; -3.694155158274882e-01   +4.434937407858398e-01   +7.077833815858143e-01   +1.492531229133165e-01   +4.022129487523756e-01   +7.793062328333277e-01   +6.745111768080102e-01   -1.765781798985872e-01   -6.905733064565681e-01; +3.856967029400061e-01   -2.554354734602006e-01   +6.682601246538434e-01   +8.500334127018834e-01   -2.448397213206306e-01   +2.916041772237236e-01   +4.320218411633019e-01   -5.569498887679523e-01   -5.977368397436459e-02; +3.794043578541944e-01   +7.363265560934142e-01   +8.421635352799909e-01   -6.243122332469309e-02   -4.375213045514489e-01   +3.217517035888620e-01   +6.184323718988549e-01   +1.789031673207165e-01   -4.836473495660909e-01; +9.415201635678977e-01   -8.511228262721424e-01   -9.543693406357376e-01   -5.027518017145176e-01   -4.849618151050706e-01   -9.497714944619524e-01   +9.280228020519424e-01   +2.270266316091832e-01   +6.922893129794722e-01; -6.286142490313025e-01   -6.834021180533159e-01   +7.341001336790289e-01   -9.796863374083271e-02   -8.274809792442290e-01   -7.729533668237132e-01   +3.695747630520987e-01   +5.637359994500155e-03   -1.908927468643886e-01; -5.353357306364899e-01   +1.000000000000000e+00   -6.884473264492300e-01   -9.295946336076606e-01   +3.951721585606097e-02   -8.394887045971011e-01   -2.296889283614393e-01   +2.976597054396403e-01   -7.121040793709037e-01; -4.266266948192901e-01   -9.655603630963308e-01   -5.646423256854814e-02   -9.140604499936116e-01   +5.243983820446357e-01   +3.346314338357647e-01   -5.286321792553662e-01   -3.494313834439234e-01   -4.480020324057166e-01; -2.208326771854806e-01   +3.775551894676113e-01   -6.475077898862802e-01   +7.436909903894217e-01   -4.632156880336874e-01   +7.705859267601838e-01   +8.478333409684998e-01   -4.435621708094771e-01   +4.994406633919737e-01];
L2_L5_iAMPA_netcon = [+1.757466720493430e-01   +5.692558217037404e-01   +4.971139929402333e-01   +8.356676352787878e-01   +5.032141623264301e-01   +3.015100490713638e-01   +3.953316335557778e-01   -1.000000000000000e+00   -1.449985407422213e-01; +1.267421951513477e-01   +3.512714090232835e-01   -7.770779072252167e-02   -5.316340752941069e-02   +5.327711990439106e-01   +4.366377793996213e-01   -9.381236062896552e-01   -8.312959922812911e-01   +7.309269512816342e-01; -7.401338423969620e-01   -1.482066313535634e-02   +8.766370101536300e-01   +5.308672793745450e-02   -5.468217546548512e-01   +8.654409710663186e-01   +3.214283543583131e-01   -5.851228371249211e-01   -8.106206293278456e-02; +9.706300737589244e-01   +7.952595906357534e-01   +4.342621096167480e-02   +7.346024302231040e-01   -7.043863718900321e-01   +5.263562885881200e-01   +6.119636039502941e-01   +5.669632661042655e-01   -4.117108174225092e-01; +7.139080766281538e-01   +2.647356846110822e-01   -4.089083284127480e-01   +1.658076426243239e-01   +8.020072314130706e-01   +2.966633768050514e-01   +9.771993592636987e-01   -8.883356998831248e-01   +9.676091637497988e-02; -1.165349186258458e-01   -6.854532175155275e-01   +9.795636891386167e-01   -7.422239716071221e-01   +2.356827470965996e-01   +9.426456730300906e-01   -1.105409408561226e-01   +5.471776370187386e-01   +7.076460015789543e-01];
L5_L2_iGABA_netcon = [-8.957947317332214e-01   -6.653174001841863e-01   +6.802470971119936e-01   +8.097924797096478e-01   -4.031030863953936e-01   -3.075852987783130e-01; +5.703341358273035e-01   +6.793523263509790e-01   +4.636282817608121e-01   +7.362230932418030e-02   -7.727931069909876e-01   +2.113073484441619e-01; -5.125111055801975e-01   +3.563900348441749e-01   -4.136507460611301e-01   +7.482585013693138e-01   -6.432677279206231e-02   +9.988598051915760e-01; -3.910555472205083e-01   -9.620711496529785e-01   +9.041906461480299e-01   +1.000000000000000e+00   +5.869632538959374e-01   +2.911333708545282e-02; -3.273273450457582e-01   +6.687498584684007e-01   -7.511435975081133e-01   -6.722711576097208e-01   +4.710476944142060e-01   +6.026488199748670e-01; +8.762355882834678e-01   -2.472295433092636e-01   -2.930886029708547e-01   +5.777648520462896e-01   -6.468341248266577e-01   -8.094738213672896e-01; +7.050455933413901e-01   +6.183007957190231e-01   +7.183551703835509e-01   -8.975191989425690e-01   -6.205123693109289e-02   +3.760372850697961e-01; -3.318938417789551e-01   -7.780484530632206e-01   -2.409640963628118e-01   -5.482333742798757e-01   -2.813558181863577e-01   -4.546108568072976e-02; -2.221114413123699e-01   -8.672472322102815e-01   -4.264103461803273e-01   -1.071804400018204e-01   -5.386836391704571e-01   +4.459008257946837e-01];
L3_L2_iAMPA_netcon = [-7.933192779019983e-01   -3.258544512231061e-01   -7.187779342927813e-01   -5.845103884189171e-01   -4.924418017053837e-01   +5.513428738713095e-02; +1.000000000000000e+00   -7.090968561154464e-01   -9.897575364066645e-01   +7.680787948977244e-02   -9.640282259080328e-01   -7.064815799528819e-01; +8.645079505604720e-01   +7.584436392223692e-01   -2.671728160645495e-01   +9.934357291420772e-01   +4.128014060820280e-01   -1.316601300357890e-01; -5.244430208284611e-01   +7.774217970351492e-01   -4.739768952047065e-01   +7.910442008983217e-01   -9.123649424445639e-01   +2.962090761277107e-01; +2.343503294615189e-01   +4.399219015460482e-01   -3.777761769330007e-01   +5.644896190298294e-01   +4.826110193785475e-01   -9.827202185667928e-01; +5.768924986004121e-01   -8.944393412775938e-01   +4.362647013236119e-01   +5.792795004094968e-01   -9.401370337504502e-01   -6.065830224046725e-01; -1.457863438226978e-01   -5.079270067539475e-01   +7.174009823192413e-01   +7.656012158860745e-01   -1.442070337382568e-01   -5.347972088077473e-01; -3.028879617275668e-01   -2.827854815734975e-01   -7.413256848675140e-01   -9.181558212247002e-01   -7.336286604264212e-01   -7.755989433175507e-01; -8.135941706403051e-01   -8.714351674709643e-01   +9.613069987235722e-01   -1.962295688452092e-02   -3.508656482836494e-01   -3.574499034144371e-02];
L2_L3_iGABA_netcon = [-9.283976428997109e-01   -2.900605475309225e-01   -2.588046438813904e-01   +7.013396858810167e-01   -5.372217598565614e-01   +9.449012237293842e-03   +4.853296978560630e-01   -2.199525320566527e-01   +9.920257145368994e-01; +1.000000000000000e+00   -4.048583614758534e-02   -6.839431106666385e-01   +2.386588383349899e-01   -8.533371291601843e-01   -5.106178308751224e-01   -1.069753576626241e-01   -7.338090808398445e-01   +9.138115952086305e-01; -4.762962356398529e-01   +7.863956632636202e-01   -4.425913488481946e-01   +9.302724160088009e-02   +2.206042351237547e-01   -9.821122577707104e-01   -9.483678182240154e-01   -3.948792607248136e-01   +9.968297096943955e-01; -5.140846367696226e-01   -5.892351339354445e-01   -1.199806652862428e-01   +6.019004676632799e-01   -1.301877339168685e-01   +7.633174472714206e-01   +6.071732578918022e-01   +8.913893994593349e-01   +1.226307891071753e-02; -6.559578783828460e-01   +9.306811945937672e-01   -3.685247457253820e-01   +8.307428674408607e-01   +8.051623541160757e-01   -4.862285966240837e-01   +2.347670996022731e-03   +1.464428226684923e-01   +3.787923766538550e-01; +8.088854173979648e-01   -5.986041835726182e-01   -6.916211575003333e-01   -3.822811643216874e-01   -3.816733608987933e-01   +8.478605509236804e-01   -7.325834337662485e-01   -9.440242345467699e-01   +6.134962401905727e-01];
L1_L4_iGABA_netcon = [+1.509871601369595e-01   -8.254325100541701e-01   +7.839453921791745e-01   +4.667670516538313e-01   -8.688877163806716e-02   -8.336057039998948e-03   -3.995832383655700e-01   -3.815226495104575e-01   +8.950115412187333e-01; -9.796862250480822e-01   +4.434419654431226e-01   +8.005028224168304e-01   -8.543138133859124e-01   -9.522249671601448e-01   -5.201379517318842e-01   +5.375283917620984e-01   +8.033443263962952e-01   -6.081295063865392e-01; +1.152193653282276e-01   -8.091108664839450e-01   +5.072931726816081e-01   -8.003822293411269e-01   -1.913360551806562e-01   +1.241457240390599e-01   +7.274465535896316e-01   -4.805382887678249e-01   -3.976374630962977e-01; +5.827788516608365e-01   +5.483914418937741e-01   +1.897800630474807e-01   +2.111222461696701e-01   +1.966888393324153e-01   +5.674377835448379e-01   +7.903165821068656e-02   -9.966557821960218e-01   -5.249034944117111e-01; +4.558165634865004e-02   +2.576742612991793e-01   -4.920687899795419e-02   -4.070607940224132e-01   +1.980915988491555e-01   -6.410271553619226e-02   -6.631686667442465e-01   +5.154139420646693e-01   -3.506068723310645e-01; +7.964112622817934e-01   -8.784735698133966e-01   -3.362026438972230e-01   -2.684438516380521e-01   -3.800033586219705e-01   +4.663758585103741e-01   -8.885058811699006e-02   +6.853074543816071e-02   +8.732260475591453e-01; -4.250035951245012e-01   -4.406532405318810e-01   +9.340433514413735e-01   -3.053868545516898e-01   -9.053118910527598e-02   -3.041619479086813e-01   -9.707642220458620e-02   -2.038618011261627e-01   -9.255981681962289e-01; -3.423574766448444e-01   +7.551191253404548e-01   -8.011214636289967e-01   -1.860005316585088e-01   -4.163426598478806e-01   +9.518283295214074e-02   -7.663913785334907e-01   -5.078299875488094e-01   -4.166029886401607e-01; -2.371136141262469e-01   -3.557941866812170e-01   -2.881347203932033e-01   +4.692927075661777e-01   -1.250785744657019e-01   +6.515904746437289e-02   +8.377689207308648e-01   -2.042107171710117e-01   -4.499591912251838e-01; +6.596236912002819e-01   +3.216670581700022e-01   -1.000000000000000e+00   -5.096926256240362e-01   +9.246427510873283e-01   +6.127558124152874e-01   +7.450963800551887e-01   -7.786490413249793e-01   +8.709260254440994e-01; +3.137497550354545e-01   +9.651118815764735e-01   +7.275425779018970e-01   -8.133810203214918e-02   -1.514165955503459e-01   +5.456788967829264e-01   -5.776665439795728e-01   +4.158894406679757e-01   -9.639726733605984e-01; -4.459336329308355e-01   +6.043190904410106e-01   +7.711589304706634e-01   +8.809409568987929e-01   -7.338546257484644e-01   +9.701909688060796e-01   +2.106377968738117e-03   +3.023236568171031e-01   -3.378244575711119e-02];
L4_L1_iGABA_netcon = [+6.818726494006362e-01   -4.289803243460371e-02   -9.058302897622130e-01   -5.307439367335371e-02   -7.024383043882640e-01   -3.504377486124033e-03   -2.221067820144617e-01   +3.560174915561706e-01   -9.663659075577505e-01   -4.409791396625204e-01   -1.662632031973054e-01   +3.881814363441589e-01; -5.872792372302235e-01   -6.052181846956779e-01   +6.160430085399069e-01   -2.208574804352753e-01   +7.052410428230238e-01   +6.096551819252848e-01   -4.760461612311884e-01   +8.883516858623468e-01   +1.433326199828821e-01   -9.681626761503103e-01   -8.284811593819189e-01   -1.756780077317342e-01; +8.027307813256528e-01   +5.299193723133754e-02   -1.359174126923549e-01   -7.058815213938165e-01   -5.095364062233945e-02   -6.611140410528559e-01   -3.398349312613768e-01   -6.424420404789171e-01   -1.107815804429330e-01   +3.284454698611322e-01   -9.728398308184316e-02   -1.959310811537036e-01; -3.913148961364954e-01   -4.675995378508331e-01   +7.039988873675102e-01   +7.230937667315178e-01   +5.582128166596987e-01   +6.788587823554036e-01   -6.321239460137003e-02   -9.978390884675973e-01   +6.829298755877534e-01   -8.423737476107266e-01   +9.177103694834746e-01   -6.838837751848201e-01; +1.629185813807449e-01   -3.137515027499800e-02   +3.672928298416976e-02   -3.566887064741159e-01   -6.125002178786160e-01   +3.695143409982490e-02   -7.344324566035266e-01   -5.030146059472439e-01   -1.000000000000000e+00   +1.713215743906204e-01   -5.387198016077487e-01   +3.388614939607413e-02; -7.359878584373474e-01   -9.379216773755036e-01   +3.500316836954179e-02   -7.118530093623306e-01   +3.707748104054857e-02   -3.616380539994136e-01   +4.446917888750568e-01   -1.567938868125240e-01   +2.013148420036993e-01   +8.488755999552630e-01   -1.634552814279480e-01   -1.573222330512474e-01; -9.786766316867884e-01   -1.088401354306022e-01   +4.485770979771248e-01   -9.515890805398292e-02   +6.062321945252490e-01   -2.998179625696930e-01   -4.779596896597426e-01   -9.937253813261356e-01   +7.664434251730992e-01   +3.148455274931113e-02   -1.610191879008719e-02   -7.665135047115558e-01; +4.806915346013667e-01   +6.373573035159440e-01   +4.791377678091108e-01   +9.441462208800537e-02   +4.708524568494160e-01   -4.950494546079735e-01   +1.244654005823614e-01   +9.856904581976024e-01   -7.894663036923298e-01   -9.668085537053307e-01   +8.962968267991538e-01   -9.394973452762884e-01; -3.497190500326434e-01   +9.823505542685216e-01   -9.351782293602138e-01   -8.882504317419199e-01   -1.778834152729001e-01   -8.074253978628916e-01   -2.542858821803804e-01   +9.465043640159337e-02   +8.055649847278780e-01   +5.992897163320254e-01   +1.466497792697386e-01   +2.115014358960784e-01];
L1_L3_iAMPA_netcon = [-1.491835525806820e-01   +3.411453776195553e-01   -1.236965686114439e-02   -3.331184100477539e-01   +8.574676908979527e-01   -3.953157108836632e-02   -7.010056897811368e-01   +6.096964434480633e-01   -3.448103556714410e-01; +3.536762857525735e-01   +8.559320471127106e-02   -1.957415866208160e-01   +1.509795449272935e-01   -5.087671945639051e-01   -3.022644605882593e-02   -5.803457360456130e-03   -3.635499233700620e-01   +3.660767125635100e-01; +6.766467235709678e-01   -4.066462898687976e-01   -9.310920912334827e-01   +3.177776239488005e-01   +2.650448832569559e-01   -6.801143705909786e-01   -2.832101256540182e-01   -5.532176095234287e-01   -6.568251691657542e-01; +1.786311677281886e-01   +4.527747301976435e-01   -2.074742387660189e-01   -1.000000000000000e+00   +7.601042325957704e-01   +7.430399384366352e-01   +9.952238675231387e-01   -6.229092731639468e-01   +7.491466337310243e-01; -4.128021895146385e-01   -7.644016956039662e-01   +3.012702669490337e-01   -8.231244092815564e-01   +5.077418211205628e-01   -6.351695764856020e-01   -8.910232746781018e-01   -2.662144402187576e-01   +1.638550501611933e-01; -4.374167922736520e-02   +2.661083441235023e-02   +2.515387855939396e-01   +1.224381874103504e-01   -5.471804996725141e-01   +7.995394029681993e-01   -7.864134995091150e-01   +8.514959404509418e-01   +5.613308965416210e-02];
L3_L1_iGABA_netcon = [+2.507784307187825e-02   -5.901478386733394e-01   -5.579786037565987e-01   -1.707029160288041e-01   -1.000000000000000e+00   +1.665118891470186e-01; -4.729899513779414e-02   +3.273811798069204e-01   -6.782377433617096e-01   -1.553126448620538e-01   +2.699528150232544e-01   +6.462316191269660e-01; +8.713905042740852e-01   -1.074626986481665e-01   +9.923935613776123e-01   +4.460354731778803e-02   +2.810529632876903e-01   -1.753607478946304e-01; +7.093755460323385e-02   -3.944465626559533e-01   +4.098064947826879e-01   +5.346483720854598e-01   -9.253688397306377e-01   +7.728091368539995e-01; +3.520872092780971e-01   +1.231117793104281e-01   -3.758528703447144e-01   -3.363500800929763e-01   +6.368499313206905e-01   +1.561268962728738e-01; -1.407088182535357e-01   +7.700456610414542e-01   +6.070839282749483e-01   +5.661665092144971e-01   -7.159647470918817e-01   -7.304197796737822e-01; +7.084141511196592e-01   +7.062389685062385e-01   +7.873923584380075e-01   -4.584742751857906e-01   +4.398395683905046e-01   +9.252712300316298e-01; -3.645931551540891e-01   -7.971308166071961e-02   -3.958633184407269e-01   -1.919469907884065e-01   -9.596373460145864e-01   -9.477858891193177e-01; -4.128672139379114e-01   -2.167310678501656e-02   -9.011502233794141e-02   -2.540323743629739e-01   -9.099102517006643e-01   -9.035124040286374e-01];
L5_Input1_iAMPA_netcon = [+2.638993122880079e-01   -9.747012105000166e-01   -1.000000000000000e+00   -9.709504286298588e-01   +3.917766137706348e-01   -6.924177960754978e-01];
L6_Input2_iAMPA_netcon = [-9.201022946641798e-01   +4.734549804088462e-01   -4.254247446792996e-01   -5.306175701645055e-01   -1.000000000000000e+00   -1.017310099327778e-01];
L5_L6_iAMPA_netcon = [+7.296614890419969e-01   -9.927507492763965e-01   -9.484115875786804e-01   +4.414132755205839e-01   -1.324117757406347e-01   -7.815911789766797e-01; -3.532605129168522e-01   -4.148017105935954e-01   -5.720416233709237e-01   +2.071600513320045e-01   -6.970694830761046e-01   -9.523497475284557e-01; +2.687196012575652e-01   -8.192743612015509e-01   +4.010197947490408e-01   +5.538668529673045e-01   -9.117535215519897e-01   +8.439033820083448e-01; +8.265070374375322e-01   -7.553528773821270e-01   +3.262129329195387e-01   -7.231464394364087e-01   -1.000000000000000e+00   -5.078703961587478e-01; +1.249949730844930e-01   -9.515088157801163e-02   +4.904240265667802e-01   +3.291753079283679e-01   -6.084109244080884e-01   +3.256690794921485e-01; +9.112164614870208e-01   +2.164823841337712e-01   +5.278798149676583e-01   +4.889213429814384e-01   +7.130150440221081e-01   -1.566526401570931e-01];
L4_L5_iAMPA_netcon = [-3.330417052371882e-01   -1.072016705817026e-01   -4.772287489535901e-01   -7.060679350230358e-01   -7.104428591641532e-01   -2.005617825802924e-01   -6.241936443578451e-01   -4.057519692067518e-02   -6.689472447286441e-01   -3.948335491782178e-01   +8.871433707478880e-01   +9.319840127015890e-02; +7.182125754658525e-01   +3.130624299854921e-01   -3.374714596323040e-01   -8.998639995276929e-01   +7.985156865320600e-01   +7.548837051838938e-01   +3.893684258479126e-01   -2.756149162878387e-01   +4.596131828035788e-01   +9.779504432762876e-01   -4.396058563858878e-01   +7.536935934617952e-01; -9.753393631761788e-01   +8.284247330133876e-01   -2.943462543004590e-01   -5.541222880067869e-03   -8.827881102334521e-01   +3.883193705233935e-01   +1.807048296176946e-01   +8.906854057347607e-02   -6.364038970406328e-01   -5.795175813787761e-01   -7.504829861916493e-01   -3.956270250511379e-02; -7.075188483927956e-01   -4.339996477703935e-01   +3.770903608935972e-01   -2.497067344426787e-01   +1.676610715388439e-01   +7.870222890580630e-01   +7.468296549831206e-01   +5.136295336871515e-01   +8.446178301086800e-01   -8.324729924851852e-01   -4.903848710430214e-01   -4.883642631828070e-01; +6.038431376851991e-01   +1.000000000000000e+00   -4.614817415393031e-01   -4.597364220725803e-01   -5.266896764473732e-01   -7.852872816445585e-01   +8.219330354551604e-01   +5.388026066920663e-01   -4.545876403369408e-01   -3.112219047267593e-01   -2.042706776133862e-01   +7.621463434247920e-01; +6.491376008614281e-01   +5.611298960713864e-01   -7.422975212218478e-01   +1.742312586138593e-02   +7.369896162384203e-01   -2.716497299827307e-01   +1.666553182235108e-01   +7.666180317927004e-01   +5.739340866316931e-01   -3.184981653421139e-01   -1.080945440223310e-01   +5.449565262534612e-01];
L6_L4_iAMPA_netcon = [-4.279813265331890e-01   -1.370036535869490e-01   -1.253540183397579e-01   +1.327898486952062e-01   -4.761779010545686e-01   +1.544548762435896e-01; +2.499831989517139e-01   +4.462586355775077e-01   -6.787420132797026e-01   -1.000000000000000e+00   -1.239340553812247e-01   -9.690635539940778e-01; -8.829442103514360e-01   -8.867845871539611e-02   +3.247273344857753e-01   -9.675583976218960e-01   +5.156419426976910e-01   +7.826402079026640e-01; -7.490734817434853e-01   -2.153466763277348e-01   -7.199377161703484e-01   +2.187573896066051e-01   +1.980359939772759e-01   +3.640919883553153e-01; +8.109120845086362e-01   +1.307628445277243e-01   -3.672578166261539e-01   +1.679179311141490e-01   -3.163251961954158e-01   -9.003866366071335e-01; +4.250559273903272e-01   -3.943147843961079e-01   -8.823586657293007e-01   +4.337519598582271e-01   -9.055776002581631e-01   -8.300593148908707e-01; +2.747384301932163e-02   +1.127400876249965e-01   +3.236449312098516e-01   +7.646368148908249e-01   +9.418642653892998e-01   +8.021854993227515e-01; -2.864790296643891e-01   +5.572224843374922e-01   -2.777966839766833e-01   -5.648554662894494e-01   -8.033326343584752e-01   +4.699525671391483e-02; +3.491100873337711e-01   -3.417720757769581e-01   -4.333826211724062e-01   +7.755575196893083e-01   -5.102523646374173e-02   +6.709161987566314e-01; +4.029324560545334e-01   +3.497262974705617e-01   -7.372106825906173e-01   +7.517103506423882e-01   -2.413175568499898e-01   +4.818792339787048e-02; -8.882376247590328e-01   +3.916738831482235e-02   -5.310170176258807e-01   -4.178600043028006e-03   -3.999184277940537e-01   +4.612292290165665e-01; +9.919083549089931e-01   +5.776888586933969e-02   -1.607438833763311e-01   +3.460933632673898e-01   +2.740145130890453e-01   +3.462777849407870e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
