function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.156990829321730e-02   -1.319070840550176e-01   -5.927908183472074e-02   +5.559685117234189e-01   -5.477958590194826e-01   +1.175133912352906e-01   +8.171145386552947e-01   +1.866842130115081e-01   +8.547802966086993e-01; +1.762102936268470e-01   +1.000000000000000e+00   +1.654911746437643e-01   -6.548671467052443e-01   +3.291977976846644e-01   -6.725975329615984e-01   -3.170744347899624e-01   +7.578139681717053e-01   +3.547324266598321e-01; -2.634036642490679e-01   +1.966786271905692e-01   -4.470704081057463e-01   -2.990402682985251e-01   -6.952515766730070e-02   -6.922756993407084e-01   +7.902953218839255e-02   -6.535161860792752e-01   -3.545509720673986e-01; +1.013166759544459e-01   +1.457511964441739e-01   +4.479899063330232e-01   +5.993989146882067e-01   -5.052672638145707e-01   -5.345440626658375e-01   +1.861451397341894e-01   +2.220950652621041e-01   +5.753027957520884e-02; +3.687026807312183e-01   +3.711378641364946e-01   -9.603412417113280e-01   +7.515496117932943e-01   +5.993759991489199e-01   -8.427202402507128e-01   +1.805851221683799e-01   +1.988500236914476e-01   +3.083736022964755e-01; -2.684823060750806e-01   +6.076306617976851e-01   -5.168293627916044e-01   -2.559134276068317e-01   +7.477007632445772e-01   -5.331164524867837e-01   +2.958993161603479e-01   -5.885431507912434e-01   +4.776227223551892e-01; +3.426184605266787e-01   +5.228041808837059e-01   -7.380357495863594e-01   +6.437892562349364e-02   +5.575515450789844e-01   +6.567578613118041e-01   -5.657909979933936e-01   +3.852167512212745e-01   +5.593121162491678e-01; +5.887637230094915e-01   -4.165394357470872e-01   +5.242298140505808e-01   +7.487531068473594e-01   +6.933811081136163e-01   +6.168070725032782e-01   -8.094877063282085e-01   +4.356883569306020e-01   -4.274593625484432e-01; +8.162877982172683e-01   +8.115744212997027e-01   +9.994017103094890e-01   +2.085410021181660e-01   -3.478140470151012e-01   -3.393715922212370e-01   +2.906670107511107e-01   -3.840384036320421e-01   -3.910849134883552e-01];
L1_L2_iAMPA_netcon = [+8.062413381843306e-01   -7.606376697559574e-01   -1.748401785690006e-01   +5.497857040483147e-01   +2.477360486890495e-01   +5.858096336888390e-01   -1.421854956244440e-01   -7.869076078000685e-01   +1.346184818780819e-01; +1.000000000000000e+00   +6.526733539573604e-02   -3.749082065270701e-01   +6.098355127004910e-01   -9.498646488459983e-01   -2.396348159549980e-01   +8.155591239483474e-01   -3.570642652832776e-01   +2.851943206123946e-02; +7.326261978428916e-01   -5.277254720647061e-01   +2.164773488226716e-01   +2.665623965089441e-02   -7.341942716456510e-01   +3.495600710883101e-01   +4.506879725481081e-01   +1.896094953837380e-01   +6.687747215733836e-01; +4.237712037239617e-01   +8.149215879974808e-01   +7.868413167876129e-01   -3.951552459112926e-01   +6.769482272631389e-01   -3.459617193862459e-01   +7.869368663865458e-01   -3.185604841433110e-01   +3.633887561039263e-01; -1.198837357761345e-01   -2.494765173415585e-01   -6.363042824626709e-01   +5.949437655198776e-01   +2.151552180220054e-01   -1.685723557443885e-01   -6.777012546659281e-01   -7.631549468960547e-01   +9.809632169285343e-01; -4.909522805359928e-01   +7.278625231617861e-01   -5.093933284224473e-01   -5.077187099363648e-01   -8.567870603351877e-01   +2.655955822166544e-01   -3.244267776617074e-01   -3.493118783616286e-02   -5.261855711759802e-01; +4.062701542546390e-01   -6.206022500280041e-01   +1.619746825072368e-01   +8.412941555716187e-01   -3.145708811492220e-02   -5.037683268126982e-01   +5.781736641137709e-02   +8.704027518542314e-01   +8.611653653993232e-01; -3.011499669781829e-01   +4.000875429716533e-01   -4.478459369219902e-01   +7.002543195521542e-01   -2.038184162944982e-01   -2.303058772271810e-01   -8.481615763629992e-01   -1.762351403127328e-01   +9.934747885631673e-02; +5.595010703642207e-01   -1.628500080277614e-01   -1.512211752114220e-02   +5.263310042703407e-01   +6.594259890779073e-01   +2.449934117613931e-01   -7.517968539107187e-01   +6.251009360234160e-01   +6.840569383214251e-01];
L2_L5_iAMPA_netcon = [-1.326457461931758e-01   +6.453844541492508e-01   +2.871352247068907e-04   -8.960194576308197e-02   +5.685539186275239e-01   +1.213300651738112e-01   +2.442919862502139e-01   +3.260236543987442e-01   +1.055471142177276e-01; +2.974226979299550e-01   -5.496658753090086e-01   +6.213019400362433e-01   +2.110195826364177e-01   +8.484071042646045e-01   -5.898207917722595e-01   -5.792188257080706e-01   -5.648058801345368e-01   +7.446070569021100e-01; +6.484919941349098e-01   -8.579156911667500e-01   +6.030027959617482e-01   +9.614829588220289e-01   -7.471641244519495e-01   +5.287996388565267e-01   +7.096299845935933e-01   +8.465044838502939e-01   -6.686050346885652e-01; +9.726447699267982e-01   +3.049309557643323e-01   +1.000000000000000e+00   +6.073175872263756e-01   +8.818586432740898e-01   +6.094302173437868e-01   +2.684462418100050e-01   -2.205298097782047e-01   +7.669792951204824e-01; +4.657065006695283e-01   -8.175523978558283e-01   +5.363723767128771e-01   +7.745303250685663e-01   -2.325812078200265e-01   +5.051104110505010e-01   -4.729621858754910e-01   -6.856489313731663e-01   -3.001515314759761e-01; +1.027949153130800e-02   -6.626046356094507e-01   +7.743388696627760e-01   +4.506026769136259e-01   +8.115793705983468e-01   +2.494066799829676e-02   -9.525036833441677e-01   -4.523795326924512e-01   -4.857340190511403e-01];
L5_L2_iGABA_netcon = [-8.189458622832050e-01   +6.927505600952139e-03   -3.250749118811613e-01   +5.383932890217044e-01   -1.845743002916600e-02   +3.781442920325168e-01; -4.869778563399271e-01   +2.889705876481109e-01   -4.475974252454029e-01   -3.094547409425693e-01   -7.337660868765927e-02   +1.943043681750280e-01; +3.188591279025784e-01   +2.905949541354831e-01   -5.639689762216078e-01   -3.391361662075644e-02   +4.461040611000200e-01   +4.248405290774065e-01; +1.497753155624954e-01   -7.343993201959514e-01   -3.000339493512370e-01   -3.416809587092200e-01   -7.328058265591736e-01   +1.253750932910977e-01; +8.711512201148834e-01   +5.522295716957305e-01   +3.855236636288188e-02   -8.670972465057679e-02   +4.840457913133631e-01   +1.000000000000000e+00; +3.017805336122910e-01   +8.443916340041709e-01   +8.306649049159448e-01   +1.850562964081798e-01   -5.157252658278756e-01   -4.757254466328399e-01; +6.367709003565751e-01   +5.057262787253751e-01   -7.369263876234098e-01   -1.263860116885647e-02   +2.823433683389500e-01   -3.667044482057942e-01; -1.071695636627693e-01   +4.047447337729781e-01   +5.682609415719951e-01   +6.556702857918024e-01   -3.533561593862695e-01   +7.460527289890528e-02; +5.507374803269636e-01   +1.811397606664269e-01   +2.476959927772327e-01   +8.843343227232549e-01   -3.627486907074293e-01   -8.252590724731259e-01];
L3_L2_iAMPA_netcon = [-2.187977541522740e-01   -2.712784551328381e-01   -5.814280552739318e-01   -1.844814534640249e-02   -3.669865440264928e-01   -2.082335345146464e-01; +1.049175342146431e-01   +6.046606204283260e-01   +1.000000000000000e+00   +1.989436724354590e-01   +7.078665149105837e-01   -5.564126180699693e-01; -2.486111805401227e-01   +5.179438305890351e-02   -3.678882095159562e-01   -2.425055937002189e-01   +7.469307327225477e-01   +2.658376616965346e-02; -1.698363483883556e-01   -4.479197144902912e-01   -5.403864294267921e-02   -1.674245763724946e-01   -1.143422911738145e-01   -3.386631602958661e-01; +3.972577071289996e-01   +2.398825460554115e-01   +4.704591408000897e-01   +3.366733120909085e-01   +7.331745915645121e-02   +7.781455460471060e-01; -4.660064180088175e-01   +5.119040339176811e-01   +3.691995910635854e-02   -1.236366956394548e-01   +6.008903418014339e-01   -5.281748913172111e-01; -6.384475497636958e-01   +5.627633177267015e-01   +5.610691761694306e-02   -1.248133460559648e-01   +7.438824989816705e-01   -6.030150967550442e-01; -5.308023487671825e-01   -5.408094251121485e-01   +3.721035384938908e-01   +9.904797833129342e-02   -5.993064319492784e-01   -2.374330797369370e-01; +5.250051923678229e-01   +8.038897714461967e-01   +1.305883011264154e-01   -2.303844113941090e-01   +9.831551227525366e-01   -5.891103497721462e-01];
L2_L3_iGABA_netcon = [-6.501023171294517e-01   +5.257539756960128e-01   +6.011211852084501e-01   +1.324550342274588e-01   +8.920889298011495e-01   -1.870352264794656e-01   -3.109693170000113e-02   -4.935939754011669e-01   -1.267156246958612e-02; +2.218795677108011e-02   -5.432956756283147e-01   -7.933350536697903e-01   +3.820039158082327e-01   +7.914175990150744e-02   +2.691936360884834e-02   -5.946126069668950e-01   -5.369102882362407e-02   +1.000000000000000e+00; +2.860018455003585e-01   -5.918906115555487e-01   +6.124207358738433e-01   +6.769444604559326e-01   +6.136865061460286e-01   +4.867657137556652e-01   -2.928224331265284e-01   +3.456290624470066e-01   +7.410741238457009e-01; -1.325694601070897e-01   -8.867391346699288e-01   +6.108964147782996e-01   +5.229671088610770e-01   -4.052863220071682e-01   +9.287088038387203e-01   +8.875560125901932e-01   +4.825247759364162e-01   -3.617119262175327e-01; -9.664681824413490e-02   +4.179482691861338e-01   -4.970859784217025e-01   +3.498825467869656e-02   +3.430655438725049e-01   +4.318988462223952e-02   +5.970180428803901e-01   -4.222860519652606e-01   -4.569555523298383e-02; +8.362360168382107e-02   +4.778400922284676e-02   +7.038498498753135e-01   +2.140865415929897e-02   -3.430173800153887e-01   -6.642449572767397e-01   +1.563836493947464e-01   +7.309784342160572e-01   +3.409230624048298e-01];
L1_L4_iGABA_netcon = [+1.818602962553670e-01   -8.566981267195201e-01   +6.214282195285984e-01   +4.047955446671228e-01   -4.751212444805800e-01   +6.212570132532456e-01   -1.915547754602612e-01   -4.419373962540598e-01   -7.073500944344554e-01; -5.782693576045034e-02   +3.731610707553651e-01   -4.388578983093297e-01   +7.244454249547602e-01   +1.869758122608489e-01   +9.245060919181511e-01   -8.624287019091935e-02   -4.735923501574366e-01   +2.937590895991223e-01; -7.458617369959966e-01   -3.702981821470908e-01   +5.094319868644435e-01   +6.849176900569279e-01   +2.541112428047829e-01   -1.398303355495817e-01   -4.802159357150169e-01   +1.512898932804863e-01   -2.872214593782116e-01; -7.252410118251557e-01   +4.919622170923129e-01   -8.244361272554702e-01   -3.305153170190123e-02   +3.035922764367687e-01   +4.949513083245606e-01   -5.726423565505243e-01   +5.452695932357037e-01   -8.943875273936757e-01; -7.527234835753189e-01   +2.785188621040471e-01   +3.217619053809221e-01   +3.633638299162815e-01   +5.915706866749519e-02   +9.077239604715337e-04   +3.071201459117465e-01   +4.687105965363106e-01   +1.000000000000000e+00; -3.874259565158986e-01   +3.875160942998831e-01   +4.885381334647891e-01   +8.173995662141630e-01   -9.579637046291867e-02   -3.328314299478789e-02   +1.188064521589136e-02   +4.777209215351838e-01   -5.670400274565277e-01; +3.852790203603161e-01   +1.510190588337354e-01   +7.396865452136330e-01   +7.964236203220573e-02   +3.392738368382755e-01   -3.225355764358888e-01   -5.295519297816116e-01   -5.528953976134029e-01   -3.322810219425238e-02; -4.607532874885416e-01   -4.479040818750020e-01   +7.985295133353099e-01   -5.891324995756818e-01   +5.886246995300630e-01   -2.478443385095123e-01   +2.924982829007635e-01   +3.626441351483981e-01   +7.264691133126464e-01; +1.535783634118777e-01   -7.171522798151797e-01   +4.201012287321871e-01   -6.650781282487622e-01   +3.972065095259403e-01   -4.660635216958595e-01   +7.748949286038611e-01   -8.462393756579076e-01   +6.865713978193545e-01; +6.493079277865913e-01   +9.187222355646277e-01   +9.801177746285540e-02   +3.687304377460497e-01   -6.208966994737807e-01   -3.853380735606728e-01   +3.836280463646605e-01   +5.228718436294749e-01   +2.185225013918055e-01; +8.408077532078355e-01   +2.525108407191219e-01   -4.876141784945916e-01   -1.524821909853488e-01   -2.609965358055029e-01   +1.255728409895088e-01   +3.300123103936439e-01   -8.490410958338932e-01   -5.621140230842481e-01; -6.624056212206336e-01   -4.866925810191183e-01   +3.554738065431645e-01   -4.595444462903879e-01   +3.568164494774821e-01   -3.512553554303944e-01   -6.210764836189148e-01   +5.992544784529956e-01   -1.804109911425866e-03];
L4_L1_iGABA_netcon = [-1.973565158519325e-01   -3.070705948502000e-01   -6.627865227601214e-01   +5.659845591564010e-02   +5.562008107329294e-01   +6.085932126474167e-01   -4.385726483492450e-01   +7.239301938898846e-04   -1.330048269044596e-02   -1.878631424396863e-01   -4.868464669250818e-01   -2.725167550863052e-01; -3.996073179432919e-01   +4.108899992145585e-01   +3.671323741082049e-01   +9.177973084209075e-01   -8.979915116835015e-02   -6.867079782095672e-02   -2.258763256590729e-01   +5.281841238575496e-01   +3.507909115616336e-01   -9.312583025235071e-01   -3.200086971499935e-01   -1.781498144464101e-01; -7.247140845607583e-02   +4.890628087126965e-01   +4.385950973983798e-02   -3.725559199383745e-01   +8.394605611313641e-01   +8.203174014126326e-02   +9.870815074476258e-01   +6.223650377794462e-02   -3.078907739591207e-01   +5.427554458810108e-01   -2.199104521983288e-01   +3.163729068748459e-01; -1.825970407560498e-01   +2.002593245735704e-01   -6.418045546404588e-03   +4.492711368042168e-01   +4.333470243416103e-02   +2.749257715604968e-01   +9.243692103026693e-01   +4.569724461400547e-01   -4.710742850672366e-01   -1.424487622231672e-01   -1.666946608553808e-01   +7.031370274004185e-01; +2.606596215940553e-01   -3.209057227586944e-01   +8.625976101426807e-01   -9.104666314618094e-02   -2.864166617213141e-01   -8.680582442558560e-01   -4.463953709894107e-01   -1.320838950600106e-01   -5.062691890556159e-01   +2.916192327257863e-01   +3.696703490828413e-01   -2.008118586697124e-01; +5.230058987345410e-01   +4.125478339164966e-01   -2.861037150155522e-01   +2.865085971888509e-03   +5.516700117129106e-01   -2.177520378050712e-01   -7.795345178041467e-01   +8.094226074211899e-02   -1.603266097424041e-01   -1.612091387698644e-02   +7.638364778758717e-01   +6.869386274857258e-01; +3.741685109216251e-01   -1.689381434460964e-01   +2.475192868916894e-01   -4.470906768412427e-01   +7.700690230625749e-01   +4.068926346479494e-01   +1.281525925575188e-01   -4.390963839996110e-01   +8.605163798265335e-01   +2.819739610305364e-01   -5.402161620364163e-01   -6.162001532534509e-01; +2.118585638260492e-01   -6.961520443957520e-01   -8.719817378326373e-01   +5.542694819151867e-01   -3.221524162805225e-01   -8.232871338791762e-01   +1.446690022887583e-02   +4.896796869130596e-01   +1.933427932258056e-01   -1.732484444409134e-01   +7.440680478478554e-01   -8.774101279249810e-01; +4.856766471097597e-01   +1.045406899609814e-01   +4.419537286616962e-01   +3.859523429217607e-01   +3.386595748465001e-01   +1.000000000000000e+00   +9.474313639142203e-01   +4.957723961759712e-01   -6.027389881519257e-03   -9.867904619441262e-01   +4.392839652475602e-01   -8.540275498936407e-01];
L1_L3_iAMPA_netcon = [-3.340086358930811e-01   +7.137443752579468e-01   -3.185703441435817e-02   -2.493818815052144e-01   +2.021902653891113e-01   -1.665028846158395e-01   -4.462915682413351e-01   +6.765993311077991e-01   -9.004829902572196e-01; +4.617770259782208e-01   +2.445207520226650e-01   +4.945943517985061e-01   +6.902707554319363e-01   +6.513094743742448e-01   -2.291096316641088e-01   -1.214318669150238e-02   +1.000000000000000e+00   -6.687532316173208e-01; -2.114350636209479e-01   -7.115504439907478e-01   -7.411689732828842e-01   -2.121902954976451e-01   +6.148631501397523e-02   -2.455925821719913e-01   +8.218873759690859e-01   +4.388697342940291e-01   -3.854051173264982e-01; -8.194546124494032e-01   -5.202126524454535e-02   -1.138197665204250e-01   +5.030530546968959e-01   +3.688045405859244e-01   +4.629070881095100e-01   +8.033160503229182e-01   +8.320507068133812e-01   +5.341542834410781e-01; -6.742878435038177e-01   +8.374574832474382e-03   +5.725349918718790e-01   +2.936760356766761e-01   -5.814568284059706e-02   -5.162403913739252e-01   +7.593555376824180e-01   -6.262528718412647e-01   -5.061199755908166e-01; +1.116609059947221e-01   -8.676124176784221e-01   +7.000218645213102e-01   -3.796940310297515e-01   -2.220872690073919e-01   +7.578347125162576e-01   -7.928014935045155e-01   -6.128358768136342e-01   -1.941871140842978e-01];
L3_L1_iGABA_netcon = [-2.277050661422906e-01   +8.720514667070620e-01   +1.954470193213415e-02   +6.034029186113260e-01   -5.133519495412889e-01   +1.317749619675389e-01; -4.488495937963358e-02   -2.644077219689790e-03   +2.520162344694151e-01   -9.679450532166725e-01   -7.286406577427975e-01   -5.001748878339141e-01; +4.801969664123929e-01   -5.392964767584296e-02   +5.175447696992268e-01   -5.367044131012172e-01   -7.216521157240786e-01   +3.634492262642967e-01; -3.415270179849245e-01   -6.437500744042770e-01   +3.322752569459249e-01   -4.020575589156416e-01   -2.570301779518028e-01   +3.675492355881149e-01; -2.871513766173207e-01   -6.456072719276347e-02   +5.648820046265611e-01   +2.412660260375929e-02   +7.415993733877352e-01   +3.839576097033600e-01; -3.104036451909677e-01   +1.274802391239134e-01   -4.853886416233935e-02   -5.221491869588725e-01   +8.867562430011663e-01   -2.248099950886279e-01; -6.437752822535342e-01   -4.241653498597927e-01   +1.000000000000000e+00   +4.925256870649115e-01   -4.244296618986909e-01   -5.852668605152220e-01; -2.963736815054922e-01   -6.373560410286223e-03   +6.744406042576719e-01   +1.770736969319334e-01   +1.793856125564080e-01   +7.763569030715511e-01; +3.117354840840637e-01   +4.961528284253124e-01   -5.004618279084243e-01   -6.562858763337154e-01   +2.492850060342132e-01   +3.265529131880502e-01];
L5_Input1_iAMPA_netcon = [+2.802446039770619e-01   -3.181876143724047e-01   +9.689894397248318e-01   -4.216020812117492e-01   +2.917608691690732e-01   +1.000000000000000e+00];
L6_Input2_iAMPA_netcon = [+1.181197295653044e-01   -1.000000000000000e+00   -2.808222102278765e-01   -5.242331170826374e-01   +6.738944206974108e-01   -6.321938871012052e-01];
L5_L6_iAMPA_netcon = [-2.623302638573522e-01   +1.170199438540455e-01   -2.785652878843004e-02   -5.394369494426005e-02   -1.590426054715715e-02   -3.129914028445008e-02; -2.465039888077898e-01   -7.555767166900719e-01   -4.676585154243192e-01   +5.019292448233382e-01   +7.221229648285109e-02   +3.613579590523338e-01; +6.202169293422191e-01   +2.159629018754251e-01   +7.813394879255001e-01   -2.047450787542462e-01   -1.904978441612636e-01   +8.350097252835863e-01; -2.006251819327232e-01   -6.257523069657808e-01   +7.909666747231682e-01   -7.159091901138948e-01   +7.112506500821375e-01   -4.424239710693706e-01; -5.818936573193638e-01   -6.220057270487669e-02   +3.459638522129067e-01   +8.177267084744355e-02   +7.462607822527810e-01   +7.206922328200145e-01; -2.487369938847310e-01   -1.000000000000000e+00   +4.299483798617815e-01   +4.933824868168542e-01   +3.868447172160248e-01   -2.374044997610590e-01];
L4_L5_iAMPA_netcon = [-4.587549413349443e-01   -5.136260332269066e-01   +2.428775771283554e-01   +6.666060027538180e-02   -2.205306895406698e-02   -5.319054954991268e-01   -5.879233874730335e-01   -1.044355374996983e-01   -2.774350370221143e-01   +8.252942406572265e-02   -2.599225884997875e-02   +3.983743199694817e-01; -4.447548729466481e-01   -3.213084765635754e-01   +2.413660597590334e-01   +5.390026658668372e-01   +8.089406529893292e-01   -4.763071284088914e-01   +8.651910435309000e-01   -7.237558580048279e-01   +9.218127045333470e-01   -6.494681454342006e-01   -1.832556427096748e-01   +4.484698886106935e-01; -4.119307198752928e-01   +8.141416621391563e-01   -1.445249263933313e-01   +3.787367243049875e-01   -5.002017969909550e-01   +5.771607043878411e-01   -9.352449386776819e-03   +8.891618970825017e-01   -7.254955582571871e-01   -6.353679024264695e-01   -4.140116055579779e-01   -1.303851916939865e-01; +3.461528260305748e-01   +1.973557849745845e-01   +4.564101360613076e-01   -1.166432358109103e-01   +4.050593260451704e-01   -5.238012172633242e-01   -1.283756847233243e-01   +4.716153138899872e-01   -5.581668208123712e-01   +6.584059762067874e-01   +4.963702732636674e-01   -1.249205014417523e-01; +8.425404198709671e-01   -2.625088160581876e-01   -4.519667935886965e-01   +4.565239189886909e-01   +1.639096160760676e-01   +7.081999478060140e-01   -3.874798811425818e-01   +4.949841535500463e-01   -4.716841941333445e-01   -7.772605073068674e-01   -7.672818084103884e-01   -4.508333541725734e-01; -6.642988237150396e-01   +5.981671748534761e-01   -4.698560085798431e-01   +3.775852032490981e-02   +9.905037774381079e-01   +6.838590139819565e-01   +2.029369068682962e-01   +2.900173981800173e-02   +2.830447925317536e-02   -5.919227119153391e-01   +1.000000000000000e+00   -6.991477266546005e-01];
L6_L4_iAMPA_netcon = [+1.000000000000000e+00   -3.930741757496756e-01   +3.090443494597567e-01   +1.916873050861583e-01   -7.312561541704050e-03   -5.298977118439382e-01; -1.782763289923536e-01   -6.443161379084382e-01   -4.658873183588391e-01   +2.353379470466053e-01   +5.170089828044027e-01   -5.029289255515749e-01; +8.307469930594807e-01   -5.730169607927911e-01   +7.056131648431246e-01   +7.795479011982141e-02   +9.284871457943705e-01   +5.818074925698067e-01; +8.396640349770947e-02   +4.786203325255273e-01   -6.469814439206443e-01   +2.049547965070161e-01   -7.049417700951796e-02   +1.769560874369670e-02; +2.312152647081986e-01   +1.131883132856260e-01   -4.004867016241644e-01   +6.845091640980215e-01   -1.698257404736883e-01   +6.645849579772800e-01; -4.133479751130152e-01   +8.560826487414294e-01   +7.586299817152563e-01   +9.847885145054109e-01   +3.814359666763948e-01   -6.420879690645906e-01; +3.371717536761711e-01   +4.299767840143570e-01   +5.869017529525622e-01   +6.977421755726626e-01   -2.351156190375081e-01   -7.045132256917743e-01; -3.367019378512851e-01   +6.337512915602895e-01   -2.906059112300570e-01   -4.746774367792601e-01   +3.337215331683349e-01   -2.436196644885983e-01; +6.100663409722400e-02   -3.155091656716174e-01   +3.873420084746906e-01   -4.547949736566452e-01   +5.917809308560678e-01   -6.404461386117162e-02; +9.711926262709217e-01   -6.603235049010800e-01   -3.113329004661550e-01   -9.487802989186045e-01   -4.062474396872464e-01   +6.305255264001011e-01; +3.246015761706629e-01   -8.799731226446497e-01   -5.034769221865742e-02   -5.810940552890818e-02   +3.324388174684526e-01   +7.656934354108773e-01; +8.189760855505346e-01   +2.092865069800667e-01   +8.315583892952316e-01   +3.174383085073815e-02   +3.974413322300977e-01   +7.250167014153064e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
