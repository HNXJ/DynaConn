function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.743756673061108e-02   +6.641546292827551e-02   -1.456194621388824e-01   +4.711513702271565e-02   +5.345633392068876e-02   +1.435179189978800e-01   -1.476777705801303e-01   +1.132285764190524e-02   +1.795201335477942e-02; +4.090754970951018e-01   +1.533070842562624e-01   -1.065714185562695e-01   +3.938164242420859e-03   +1.055939231789617e-02   -4.433984909278353e-02   +6.383522749412848e-02   -2.615695834999042e-02   -1.668966228833775e-01; +6.434434784611891e-02   +6.332204449017190e-02   -5.483156825298117e-02   +3.408602244541670e-02   -2.882746929866478e-01   -2.698546325273194e-02   +3.628598216574043e-02   -6.937742690330950e-02   +2.315927757063815e-01; +1.140600604615542e-02   -1.586204698164891e-01   -1.987887247076004e-01   +4.426108392464807e-02   -1.871692987706842e-01   -1.802482455360401e-02   +1.013794517464917e-01   +3.763996855484737e-02   -1.523744223106283e-01; -1.336819702711466e-01   +2.241372479938025e-03   -2.176168897680856e-02   -1.456190019942064e-01   -1.913001771240957e-01   -2.275616156633386e-02   +1.768099671103601e-01   +1.864512432737315e-01   -3.239791801300678e-02; +2.477695778366519e-03   -3.573456326421424e-02   +2.501241613930931e-02   +5.218746998219324e-02   -1.607247506176952e-01   +2.147633649123130e-02   -9.384403524612908e-02   -6.963882269736323e-02   +1.118510742224099e-01; +3.012967547869396e-01   +1.862253547493120e-01   +3.171669543749123e-02   +1.575217911022329e-01   +8.909911621322641e-02   +8.557419981232503e-02   -3.471521358726484e-01   -1.569773497398924e-02   -1.515645170896603e-02; +1.883389922320123e-01   -2.048732575814814e-01   -2.695809121933913e-02   +7.110330777127462e-02   +1.555061192290682e-02   -1.442803736560952e-01   +8.487483830556378e-02   -7.455776249900195e-02   -1.019713010695050e-02; +2.987780923985519e-02   -1.201511713814404e-01   +1.554963951511361e-02   -8.232953054713858e-02   -2.142589291451764e-01   +1.335529559836259e-01   +2.623568788477108e-01   +8.550860288527584e-03   -1.747275396742203e-01];
L1_L2_iAMPA_netcon = [-2.522374424152917e-01   +1.070509515033319e-01   -2.220927420108960e-01   +1.986791280179725e-01   -3.084608699914597e-01   -1.660329148852338e-01   -4.218158664091456e-02   +1.975372216981243e-01   -2.036919212599724e-01; -7.990857769407556e-02   +4.409556495232955e-02   +1.512327874235063e-01   +8.948834611201803e-02   +6.174403460528689e-02   +7.531869443288586e-02   +1.658088966088406e-01   -4.848364507003726e-02   +5.129224741934222e-02; -2.047076162000715e-02   -2.354624488964472e-01   +3.590480103429340e-02   +1.477605479770684e-01   -1.118485659161263e-01   +2.739327868507005e-01   +1.984243477310582e-01   -1.802786957998409e-01   -1.651048357868072e-01; -1.404598094152507e-01   +1.353639413696683e-01   +7.639736526988844e-02   +1.740286009551107e-01   -7.077450948897636e-02   +1.054978982166260e-01   -1.588112125059195e-01   +1.854361185422424e-01   -1.050918301978872e-01; -1.155112656149691e-01   -4.099087941300200e-02   -7.765937372880083e-02   -8.652041377821851e-02   +6.109509515015685e-02   -1.526590797553751e-01   -1.866975840566197e-01   +6.476153956248359e-02   +1.807939716006334e-01; +1.385085811554328e-01   -1.061381631872952e-01   -2.889794060840924e-02   -1.669139257800256e-01   -6.376461596341573e-02   +2.028213538541116e-01   +2.454759204124098e-02   +6.324504961637997e-02   -5.235049602550725e-02; +2.895822556239838e-02   +2.303269224342428e-01   -2.769781879635400e-01   +2.961111411970282e-02   -1.054477242525029e-02   +1.052386136315459e-02   +1.380970029283809e-01   +1.114140674422875e-01   +2.367794772838637e-01; -1.205182648196855e-01   -1.110051738380647e-01   -1.114808043062851e-01   -1.871057662637710e-01   +1.589329369420883e-01   +1.231466117330949e-01   -1.235724714338661e-01   +1.888365029384951e-01   -1.583469665696039e-01; +2.552048181316103e-01   -1.277063330120577e-01   -9.028093277104382e-02   +1.879325086451126e-01   -2.858127092600676e-02   -1.688190014489612e-02   +9.009870697392394e-02   +1.589938827765556e-01   -1.006511166446961e-01];
L2_L5_iAMPA_netcon = [-6.317212404592437e-02   -1.893888380257563e-01   +1.139215909168706e-01   +1.813008717909770e-01   +1.338780238423858e-01   -1.508987175119806e-01   -5.442297533719823e-02   -1.071040791014343e-01   +1.805951540532495e-01; -2.807010908822771e-01   -2.418935572009678e-01   +2.033374535715707e-01   +2.868790113923158e-01   -6.574268247626562e-02   -1.519504608513921e-01   -2.310255117370544e-02   +3.393010050684837e-01   +3.134346657003175e-02; +3.409443370201026e-01   +3.862765645210103e-02   +3.258604938248725e-01   +1.616606379644612e-01   +8.259708052303803e-02   -2.566353036164682e-02   +8.606219299990947e-03   +7.540425274453331e-03   +1.732847025104131e-01; -9.576211983605395e-02   +9.565257333756756e-02   -3.097540648145483e-02   +1.298285393815505e-01   +2.371557499013692e-01   -7.060782516531210e-02   -6.854143879553844e-02   -1.012851111729083e-01   +7.355449786263717e-02; +6.312833865450007e-04   -5.320778580984741e-03   -2.673115953159642e-01   -1.084863305010644e-01   +1.389823299808401e-01   +7.494553799879240e-03   +2.938164982581192e-01   +6.940967942004596e-02   -3.181878299438395e-02; -6.697530363176624e-02   -1.165003725029877e-01   +4.359917468190080e-02   +1.572341198273531e-01   +7.644803725522172e-02   +8.061469184308299e-02   -1.156853757971662e-01   -1.479829841360399e-01   +8.040789394948064e-02];
L5_L2_iGABA_netcon = [+1.834271724537410e-02   -1.134035472158082e-01   -1.387591452499186e-01   +1.117399549349817e-01   -9.175040006433227e-02   +1.855985618165998e-02; -1.716228972517224e-01   +6.320737127839961e-02   +3.764394621576080e-01   +9.296750334558207e-02   +1.075447009510893e-01   +1.723689826163445e-02; +3.282251768034852e-02   +4.894857458083027e-02   +1.503968406778287e-01   +1.372397550709416e-01   -1.537450585934734e-01   +8.192745884586551e-03; -2.202822669396177e-02   +1.464311055053241e-01   -7.979985023651548e-02   -2.339092089018630e-01   +1.978360282722981e-01   +1.471792991581797e-01; +9.520990550568761e-02   -1.012538550353060e-01   -7.075771230448405e-02   +3.048952004489139e-02   -1.756368991608376e-01   -3.808302436319310e-02; -1.101285472405796e-01   -8.350788215082289e-02   +1.051483813996313e-01   -1.359974839705950e-01   +6.724451789861532e-02   -1.199552397646406e-02; +2.780618569303200e-03   -3.630339909478622e-02   +1.480470649840005e-01   +3.283237593520894e-02   +2.392588970467951e-02   +2.269356337663606e-01; +1.418008639412782e-01   -5.563600583672279e-02   +2.084403173632461e-01   +5.563154676779390e-03   +8.953839176965711e-02   -1.229279964374811e-01; +1.637349482327754e-01   -8.572394047991899e-02   +3.650704264372293e-02   +8.532627191634917e-03   +1.396167562560326e-01   +2.878201378680725e-01];
L3_L2_iAMPA_netcon = [+1.002660206963684e-01   +1.757710126161606e-01   +2.332360584142936e-02   +5.806105371791623e-02   -9.622584745078842e-03   -5.785540447747333e-02; -1.075045948120519e-01   -1.002556430621919e-01   -1.173192437849172e-01   -2.455457884260845e-02   +1.976527787562420e-01   -7.885772631090374e-02; -1.304800294274877e-01   +2.424339854299003e-01   -1.652246519300748e-01   -1.943567341681427e-01   -5.196881024775754e-02   -1.185679469948615e-01; +1.167037983205645e-01   -4.547161199264496e-02   -2.323208544180709e-02   +3.913034226737701e-02   -9.199447347767313e-02   -1.098938084274351e-01; +2.022126169270328e-01   +5.727484469623772e-02   +1.016947183092730e-01   +1.042852486211515e-02   +1.259740097329865e-03   -1.626089266807978e-01; +1.622610788205539e-01   +1.169569579724510e-01   -1.235434429938077e-02   -8.183497902156683e-02   +9.285034315390087e-02   -4.153674696853941e-02; +1.028340850679738e-03   -4.528802618418752e-02   +1.742913885753636e-01   -2.969918263239460e-03   +3.921263850954123e-03   -1.137566624772990e-03; +3.063555236714775e-02   -3.720099351331484e-01   +1.458723718290915e-01   -1.129343102445294e-01   -3.559161317386696e-02   -9.084432607792570e-02; +9.278149648281753e-02   -5.495635145878151e-02   -1.498113424545949e-01   -1.915863395444827e-01   -2.619324517644187e-01   +3.249105613451707e-02];
L2_L3_iGABA_netcon = [+1.449812335713291e-01   +2.348229545689936e-01   +5.402414566735078e-02   -2.611016851477317e-01   -1.554739799720359e-01   -8.716621407903802e-03   -5.645580351833143e-02   -1.182081776560945e-01   -6.509795914463046e-02; -1.522139784054913e-01   +7.843692549472515e-02   -2.444485084146769e-02   +9.321800755402360e-02   +4.716718892565707e-02   -5.809160000651439e-02   -1.143316362060936e-01   -2.262896969579703e-01   +1.236688628610385e-01; +2.117409015284792e-01   +4.796938979629711e-02   +4.744621742728249e-02   +3.815875365142894e-02   +2.150932678384077e-01   -1.030650114524980e-01   +4.418302338667741e-02   -1.496233682810919e-01   -1.673509713381330e-01; +1.389993353623471e-02   -8.433363881442207e-02   -1.356215521830988e-01   -1.045003651394323e-01   -3.894023316495342e-02   -1.432628613878100e-02   +3.324605086521687e-04   +5.317173115308688e-02   +1.512305343535174e-01; -3.320714193547819e-03   -1.461732991526051e-01   +2.417112605305140e-01   +1.455814189384579e-01   -9.429463026323405e-02   -1.496410154497496e-01   +8.579729872702511e-02   +1.236722248713603e-01   -6.968042685016262e-02; +4.456027170426816e-02   +1.591708556848456e-01   +2.191133338594462e-02   -1.628085781020443e-01   -8.400539210390318e-02   -2.008494853382785e-01   -1.438977173464339e-01   +1.438970965878766e-02   -1.163356697106635e-01];
L1_L4_iGABA_netcon = [-3.488389966102566e-01   +2.380466729437397e-01   -2.079055204617830e-01   -1.101752574448432e-01   +2.489988073728609e-02   +1.718246216651900e-01   +1.223718968478847e-01   +2.031670597850463e-01   -1.625495545417729e-03; +1.457380310229631e-01   -5.359284153205611e-02   -2.108151244331108e-01   -2.006539501553089e-01   -1.710036756441795e-01   +1.742386767616784e-01   -3.799844252249340e-03   +4.136407610616470e-02   -8.988383055129064e-02; +9.711947443356778e-02   +8.287504741345239e-02   +1.240144196110440e-02   +7.162199405040560e-02   -1.525176479809201e-01   -5.108229582399960e-03   -1.644169917242512e-01   +1.533126883449319e-01   -9.506531021375914e-02; +1.027067410275412e-01   +1.200787202137613e-02   +4.741793710636562e-02   +1.240647674052313e-01   -2.360828836553252e-01   +3.871326872699989e-02   +9.299198186805151e-02   +1.775149261741863e-02   -4.400397367255875e-02; -4.839303047577889e-04   +9.072251997774267e-02   +3.606828192756386e-03   -3.743854506769793e-01   -2.205849976405862e-01   -3.090961037234932e-02   +1.322564084354597e-01   +1.715284031655057e-01   -1.485703424423222e-01; -1.261751336081723e-01   -1.546134522373925e-02   +5.629647349230130e-02   -2.700920035647837e-01   +2.923020041136104e-01   +6.139337959425464e-02   -8.682079234952161e-02   +1.671383294696536e-01   -9.739795063333673e-02; +2.538207538107449e-02   -1.135281287752284e-01   -6.941407118740268e-02   +9.275004108450835e-02   +1.493619565381045e-01   +2.453839607664627e-02   +2.888856019474592e-01   +7.447016430077975e-02   -8.387832088327599e-02; +7.994555415849387e-02   +1.707869076189762e-01   +6.202031512479339e-02   -4.616592104077966e-02   +1.284785423503777e-02   -5.774757162539870e-02   +1.797890370352025e-01   +8.605172668080925e-02   -1.653301792602724e-01; +4.849516155285782e-02   +2.002414223938147e-02   -1.671798498976534e-01   -8.366613221054869e-02   +1.020680834276360e-01   -1.880791091549043e-01   +4.636599502410910e-02   +6.821778981006386e-02   +1.030232904154167e-01; -5.367042643813200e-03   -2.097562232405706e-01   -1.645647510005185e-01   -1.066675977750333e-01   -2.175821493352306e-02   +1.892604798278975e-01   +8.402801738122213e-02   -1.866305703340593e-01   +5.791663066793235e-02; -1.398703761577548e-01   +1.908739127679968e-01   +9.745253930901492e-02   -2.929978829875201e-01   +9.221055541655792e-05   +1.847042790597938e-01   +3.173287149017167e-01   +1.382760102494090e-01   +1.632803784882863e-01; -1.961786431222430e-01   -1.114230177284391e-02   -5.431242408010868e-02   +1.846192702086764e-01   +8.789229828392590e-02   -6.297665405112905e-02   -2.580806318421121e-01   -9.330157384286522e-02   +2.259244795368841e-01];
L4_L1_iAMPA_netcon = [-1.017447711909475e-01   +1.217892912008006e-02   +6.774866708843473e-02   +2.032280507049425e-01   -6.328718693398200e-02   -1.038793277260273e-01   -1.595760514999975e-01   +7.871562148410401e-02   +2.219465123026344e-01   +1.294033010497639e-02   +3.597056536159812e-02   +4.576754327795191e-02; +2.940039470938883e-01   -2.200055119571711e-01   +1.322228109337054e-01   -1.389015829919399e-02   +2.092917031097928e-01   +3.171632210732560e-01   +1.385550022499417e-01   -1.494430831851581e-01   -2.379089567065140e-01   +9.365410918839896e-02   -8.988080244799151e-02   +1.143273523223702e-01; +6.352994774303475e-02   -5.568166959926701e-02   +1.279232574415045e-01   -1.585590549475073e-01   +5.882023932110048e-02   +9.365176353122656e-02   -2.316779681423089e-02   -2.667760146868552e-01   -2.820892131186541e-02   -1.196699941128763e-01   +1.509852733605531e-01   +7.567868562824158e-02; -1.037045492857322e-01   -1.099729097267102e-01   +2.708034543233123e-01   +2.549043854871151e-01   -1.940516949388816e-01   +1.838989468059035e-01   -5.485599643965363e-02   +3.835613508735504e-03   +1.575280241064346e-02   +4.820785713919397e-02   +6.195918480994948e-02   +4.393413829816639e-02; -1.406650620947002e-01   +5.022503785746774e-02   -1.853804622905541e-02   +2.221582746955304e-02   -1.578339702812385e-01   -5.724776703468399e-02   -1.918609752993493e-01   -2.674226145850385e-01   -8.062786609936920e-02   -8.320104302389955e-02   +4.124602868053892e-02   -9.212307076818918e-02; -2.310123006124002e-02   -1.296663764435508e-01   -7.989930236335743e-02   +5.607477458610598e-02   +1.745905868842223e-02   +1.471113156418669e-02   -9.703690076746760e-02   -2.701083988981667e-01   +1.085112742457151e-01   +1.118888723273820e-01   +1.696795499178804e-01   -6.735163943630099e-02; -8.289083051921452e-03   -7.170704217120548e-02   -5.142458501471958e-02   -5.867289610695481e-02   +4.304407066193414e-02   +7.616519859340541e-02   +4.528710716931127e-02   +1.208604688008880e-01   -2.108697421185414e-01   -1.740048677193122e-02   +1.077723885555259e-01   +5.556422548289467e-02; -1.032239285423584e-01   -3.578362370264550e-02   -2.260237444453954e-01   -7.653146578820871e-02   -1.046514200366237e-01   -3.988622499746351e-02   -3.525495965619375e-02   -5.769944697509036e-02   -1.729624864332027e-01   -1.835707926738792e-01   +7.804038429853975e-02   -1.009741941811515e-02; +4.801686633317189e-02   -2.829115734960286e-02   -8.013859455614418e-02   +1.900800333192414e-01   +8.937292735000346e-02   +7.426937926054561e-02   -4.252858501667603e-02   +2.639815530900135e-02   +5.099667890154410e-02   +1.756628398960120e-02   -1.778019697110789e-01   +1.210299941959398e-01];
L1_L3_iAMPA_netcon = [-7.288128352721708e-02   +4.481358923618717e-02   +5.570574214059585e-02   -5.258948717353699e-02   -1.754352588237994e-03   -2.709181448257812e-01   +1.856080188644618e-02   +9.179361521428499e-02   +2.806243337172641e-01; -2.974277325054954e-01   +7.731247842163839e-02   +2.519057689909973e-01   +6.211942943368270e-02   +1.724633983008593e-01   +2.326206531276478e-03   -2.195182164352331e-02   -1.322156408075756e-01   +3.506091813299647e-03; -1.845969512858501e-02   -5.768187053346608e-02   -2.184093245005553e-01   -1.454698015544974e-01   +8.555036789657558e-02   -2.859652513786570e-03   +2.445070419345644e-01   +1.057961501736375e-01   -1.552801299844682e-01; -1.193915704551626e-02   +2.176808518320067e-02   +2.992708907034445e-02   +2.277269638539225e-01   -4.425125505946685e-02   -1.006807906387037e-01   +4.182835948084140e-02   +1.384430401823424e-01   -2.093364579146484e-02; +2.665943559154403e-01   +1.080090983406290e-01   -9.942582990550318e-02   -3.045243819710638e-01   +1.898979379533922e-01   -7.347226102410315e-02   +2.812142963651446e-02   +4.033179333782098e-02   +6.613107444357871e-02; -1.145542723793035e-01   +3.136865381829643e-02   -2.612571084791854e-01   -1.136974181327445e-01   +1.753871182792021e-01   -8.168196865471113e-02   +1.223883732504949e-01   +3.671824259755357e-02   +9.369675777740874e-02];
L3_L1_iGABA_netcon = [-1.168760468722094e-01   -2.337859745550640e-01   -7.014375589972727e-02   -1.299992743351060e-01   -1.507885628084974e-01   +9.223007665147562e-02; +6.479254043838763e-02   -2.870352172611124e-01   -7.802390991360633e-02   +1.006587820457453e-02   -6.150244941944647e-02   +6.276997015065693e-02; -1.690969578591693e-01   +3.965878463774931e-02   -2.829921477816891e-02   -2.956820865763167e-01   -2.179472396137702e-02   +1.321857517729558e-01; +1.493466329053065e-01   -2.074273742739585e-01   -7.968944350571827e-02   -5.861293692481377e-02   +1.714150907839716e-01   -9.301321644185279e-02; +2.199206472912757e-02   -7.254168077800435e-03   +1.308140697521089e-01   +5.078581404163678e-02   +1.148029800017451e-01   -5.637072187274324e-02; +5.036695063726038e-02   -3.082537947798631e-01   +3.049823727171761e-02   +4.004431045047857e-02   +1.328753511479123e-01   -6.949532363757145e-02; +5.026819384134263e-02   +2.755596271138613e-01   +1.476125771792491e-01   -3.107374616401936e-03   -3.842650773536155e-03   +3.334543048465623e-03; -2.428829156770548e-04   +1.002330242375365e-03   +9.394767349624444e-02   -7.589336251698742e-02   +2.370136706075540e-01   +7.926761454377598e-02; +1.779195901911622e-02   +8.043502999337941e-02   +1.298908209479176e-01   -1.246707006927723e-01   -1.474330996590960e-01   +1.311020707252503e-01];
L5_Input1_iAMPA_netcon = [-2.277647450203509e-01   -1.290932158608392e-01   -2.473083411039343e-01   +2.248430659385808e-01   +3.132384330934839e-02   -9.219525076372495e-02];
L6_Input2_iAMPA_netcon = [-6.879527711534836e-02   +6.885744837829560e-02   +1.478156702836476e-02   -7.569498261616098e-02   +1.370750459798865e-01   -2.258690146776002e-03];
L5_L6_iAMPA_netcon = [+6.065552258452425e-02   -4.899645541149354e-02   -1.390071204080917e-01   +2.267789899080634e-01   -1.982287634143021e-01   -2.450162118146578e-01; -5.984088884354705e-02   +1.215512954805560e-01   -6.366137948236893e-03   +6.125133823099315e-02   +3.604589551870133e-02   -1.167764326657120e-02; -1.467674199001998e-01   +1.136338474763504e-01   +3.584327813086083e-02   +6.562404191516007e-02   -3.702671768609229e-03   -1.043958584461559e-01; +9.383485636207051e-02   -1.266654117310660e-01   -3.338774247361558e-02   -4.703744000610435e-01   -7.731582783243210e-02   -1.371652775603891e-02; -6.335867024270031e-02   -1.460781387068471e-02   +1.219764833371500e-01   -1.051795388129750e-01   -3.087367004146804e-02   +1.326769048851711e-01; -2.204076335955518e-01   +1.232566735554171e-02   +5.954530266785205e-03   -1.080198135137393e-01   +7.026969506722923e-02   +1.066340452373521e-02];
L4_L5_iGABA_netcon = [-1.360207874070753e-01   +3.955058359881287e-01   +2.486308191230193e-01   +2.144120869198448e-01   +3.942453744263073e-03   -6.644688715728840e-02   -1.382003909346097e-02   +1.077041724486797e-01   -6.744550633391339e-02   +2.714415175262104e-01   +4.048727523856427e-02   -1.587635264978043e-01; -1.703668699970028e-01   +3.076157109736822e-02   +2.187420714250370e-01   +1.515840138769659e-01   +2.786163427728948e-02   -1.172791922041564e-01   +1.961312930289119e-01   +1.081490584891717e-01   -1.102836764279999e-02   -1.125826567738107e-01   +1.878494340710364e-01   +1.003312521223612e-01; -1.668376517656845e-01   -3.532753178235199e-02   -3.063805410502903e-03   -1.545310329018208e-01   -7.068042152559208e-02   -2.305345412241581e-02   -1.067020967617106e-01   -6.963370060281485e-02   -2.713051649422187e-01   +3.049141079179164e-01   -1.181787847482590e-01   +1.679025223889486e-01; +2.689177835669754e-01   +1.630170117537235e-01   -1.596715793075953e-01   +6.404745998186995e-02   +2.122207490754828e-01   +2.514788764803431e-02   +1.735281329082463e-01   +1.477377673409927e-01   -1.277943350426723e-01   +7.748523877136315e-02   +2.352951292823200e-01   +2.413969378981517e-01; +1.244785471152167e-01   +1.007923551591864e-01   -7.669863430597249e-02   +1.335654682703059e-01   -3.309516643429459e-02   -1.362205453511098e-02   +1.639375524961843e-02   -9.154058472532389e-02   +1.567637528046849e-01   -6.351669860337852e-02   +2.572139586115146e-01   -1.460668452075986e-01; +3.878868986009540e-02   +1.294863399221293e-03   -9.894198843307206e-02   -4.590117747796982e-02   +1.110024924232170e-01   +1.285836295727813e-02   -2.869253933516397e-02   +1.098652581958439e-01   +8.603943183320029e-02   +5.730990890986720e-02   -7.511032513859302e-02   +1.077887772247792e-01];
L6_L4_iAMPA_netcon = [-5.883319618508331e-02   -2.959527817722975e-01   -1.870377957908378e-01   -1.033384338536970e-01   +4.406773023810432e-01   -1.218404787729216e-01; -2.610927652518515e-02   -2.511654699298225e-01   -1.489401997137071e-02   -1.201936177268526e-01   -7.525960183692522e-02   +1.328745971536371e-01; -1.591775041446962e-01   -2.219293535359503e-01   +1.367887646535723e-02   -1.682958129050866e-02   +5.701639365288751e-02   +1.152492100025406e-01; +1.122928515552502e-01   -1.981920868293263e-01   -9.862780705970159e-02   -1.375333485069332e-01   +1.394611593507081e-02   +2.845637514557614e-01; -9.306397828914147e-03   +1.256341813112702e-01   +1.675991412327144e-01   -9.263075218866264e-02   +1.844210837477313e-01   +9.104585550386832e-03; +1.014951751687158e-01   +1.572524392438913e-01   +9.867639255255156e-02   -3.204656961856980e-02   -3.268258664378716e-02   -1.836228851010716e-01; +9.771579127236416e-02   +1.308322440564952e-01   -1.696551302492388e-01   +1.778899801449452e-02   -9.236286252458725e-02   +2.224049499941710e-01; +4.752708511241173e-02   +1.171680973493037e-01   +3.846878331777462e-01   +8.722475653614609e-02   -1.179110538994593e-01   -1.074468028373937e-01; -1.808326046074422e-01   -1.243315045178984e-01   -6.064794532836427e-02   +4.035716382645368e-04   -2.517441089030056e-02   +2.070394446063947e-02; +2.509494838498298e-01   +9.823285073024500e-02   -3.143067560266757e-02   -2.953362804867197e-01   +3.303977683231616e-01   -1.315024055998042e-01; +5.700678057452029e-02   -1.226840986864930e-01   +1.185246802440677e-01   +2.643677532184265e-02   +4.905502415686165e-03   +1.595166902656441e-02; +1.147513520309294e-01   +1.132238353226205e-02   +1.587494157736773e-01   -5.737085949165599e-02   +1.512579361584363e-01   +4.924203524294471e-02];
L5_L4_iAMPA_netcon = [-1.997796399258616e-01   -3.501734399439950e-01   +1.441779857108997e-01   -4.182350381248752e-02   +8.227544442702525e-02   +1.348577158178874e-01; +5.943259125377631e-03   -1.163937940724635e-01   +1.796485745275936e-01   +4.076900044754783e-02   +8.000004745104627e-02   +1.102381741286760e-01; +5.697552129821312e-02   +1.993172280222508e-01   -5.986920312623463e-02   +9.223078070117807e-02   -7.268273805805750e-02   +3.135189049483073e-01; -1.142321961798279e-01   -1.110379024256041e-01   -8.526569943599831e-02   +9.883990184935311e-02   -2.592261443581367e-02   -2.143263427826285e-01; +1.032242416731029e-01   +2.848035081369272e-01   +5.466658645660744e-02   -8.005446327369956e-02   +4.626835911679229e-02   -1.569114295160034e-01; -1.112945402127711e-01   +3.902027456251492e-03   -3.848908022071903e-02   -1.271073216712064e-01   +8.425302004091893e-02   -5.148986783741499e-02; +4.643694849928479e-03   -2.052737714972989e-01   -1.826393732126137e-02   -9.787142975045807e-02   +2.054635381071169e-01   +1.851713691688424e-01; -3.798195852926357e-02   +2.017821437089168e-01   -1.166782446043140e-01   +1.286083277658616e-01   +7.706618502023718e-02   +2.693477652484022e-01; -5.495927459204145e-03   -8.054141235351492e-02   +1.840237508091346e-01   +1.097416266201589e-01   -6.022625755467106e-02   -8.372919559819669e-02; +1.080058672410973e-01   +5.827189054083542e-02   -1.711657685912561e-01   +1.719493455935803e-01   -2.353828925846420e-01   -7.541881760109037e-02; -1.323204527891427e-01   -1.535082641674564e-01   +2.546211923673338e-01   +1.437394263437724e-01   +3.529715547406857e-02   -1.660748339919938e-01; +5.997171371778187e-02   -2.616324913270067e-01   -1.617694456422364e-01   +9.168206907345128e-02   -1.452657422962459e-02   +3.381298002533337e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
