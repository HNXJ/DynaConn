function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+7.253140084112754e-03   +1.355301088462435e-01   -2.075186830041335e-02   +3.567914008399040e-02   +2.323837012283681e-01   -1.799876727339194e-02   +5.058799950454126e-02   -1.807014804880671e-01   -1.169771345927667e-01; -1.043141664590262e-03   -5.006828310070112e-02   -1.267928431136211e-01   +1.002318455995808e-01   +7.590219817372100e-02   +2.000220220027877e-01   +8.412029679858479e-02   +1.395004610965146e-01   +1.429989269162676e-01; +3.071767338419342e-02   -5.396566891719688e-02   +1.869658390703509e-01   -9.915835208592683e-03   +1.257373694513910e-02   -1.509124674095732e-01   +8.527063634139784e-02   -3.475412541403539e-02   +1.154407995451577e-02; +1.419029749223498e-01   -4.837552026048765e-02   +8.537877892816428e-02   -1.037921426392141e-01   -2.601214258717029e-02   +7.437770604856991e-03   -6.387612388147523e-02   +1.227761338972694e-01   -6.801693478911051e-03; -2.929554373819443e-02   +9.594134393789910e-02   +5.358537231281998e-02   +3.046231754428047e-02   +7.816970014669972e-02   -8.839816572318809e-02   -4.195581242114647e-02   +1.425731103553173e-01   +5.442789036758561e-02; +1.204693689004046e-01   -9.641713798021256e-02   +1.370630874427132e-01   +3.021623947387189e-02   -6.042278354624790e-02   +6.840924628633865e-02   -2.310762319166068e-02   +8.048894360218876e-02   +8.488721882441477e-02; +1.610201269654895e-01   +1.052477463876795e-01   +1.876763814502673e-02   +2.156136226263506e-01   +1.632215387665655e-02   +8.713181021543430e-02   -1.923978010945221e-02   +2.324402221477793e-01   +2.880787523371123e-02; +1.739733786987109e-01   +1.543349839106742e-01   +5.202584983740732e-02   +9.332967375348394e-02   -7.051878414416740e-02   +9.731272967241628e-02   +2.046205457201524e-02   +1.136846418861350e-01   -5.315530629198587e-02; +3.178821829923281e-01   -3.708791087566216e-02   +6.465765799075862e-02   -1.251477161034084e-01   +6.259956268103367e-02   +3.586566728735864e-02   +1.372455467744055e-01   -5.296383013533901e-02   +2.937940635538100e-02];
L1_L2_iAMPA_netcon = [+1.993092139925701e-01   +1.244517588537928e-01   +2.091319647546122e-01   -1.860497186221843e-03   +1.356600414298474e-01   +7.206898217221563e-02   +8.964941736843567e-02   +5.117387776806898e-03   -4.296576199316060e-04; -4.885427302995390e-02   -2.860666387047192e-02   -2.574398483633239e-02   +2.327578197215276e-02   +8.596292818573960e-02   -5.289750541785553e-03   +5.493961747897009e-03   +1.865725985166273e-01   -5.983099256365363e-02; -5.247640959834584e-02   +1.498913287811576e-02   +1.914959959779312e-01   -7.641632828881707e-02   +2.106260572610264e-01   +5.341653895425610e-04   +1.600094423208218e-01   +6.949335066033438e-02   -5.325370563862199e-02; +1.020388904292858e-01   +1.727157840069483e-01   -7.348350889530472e-02   +1.202193501577763e-01   +1.012709206944691e-01   +2.965095133191276e-02   -2.218106391588573e-01   -3.776155926011085e-02   -1.016438728550454e-01; +2.263358363006198e-02   -1.031732598795625e-01   +1.268604424825608e-01   +3.919265981497523e-02   +6.319907811626285e-02   +1.846200336539949e-01   +2.081146456530520e-01   +6.104733449520679e-03   +2.259735083871526e-01; +1.574265916190611e-01   -1.186792173395307e-01   +1.752608541590302e-01   +2.279440028861426e-01   +4.297985407861355e-02   -1.091944039638990e-01   +1.289163867941492e-01   +1.103858721261080e-01   +1.624642381240150e-01; +9.347175944824368e-02   +5.558915547705792e-02   +1.913374607737821e-01   -7.951265987384235e-02   +7.674693328080813e-02   +1.085265728523202e-01   -4.978204597442508e-02   -1.677956416938547e-02   +3.977497306787994e-02; +1.194014978633942e-01   +6.969226159502472e-02   +2.401113308037962e-02   +1.427783253956201e-01   +1.089894071118326e-01   +8.558927732491969e-02   +8.839051657089743e-02   +1.651058469486336e-01   -1.189500545037967e-01; -2.340491028976806e-02   +1.495305621108830e-01   +1.052545151813153e-01   +1.014663606288737e-03   +1.605364903895345e-01   -3.272786020356938e-03   +1.355758844815208e-01   +1.548628922442736e-01   +1.462782456195996e-01];
L2_L5_iAMPA_netcon = [-5.204803159539727e-02   +7.039860858487176e-02   -3.631554769037142e-02   -5.727322810719815e-03   +2.069599893009413e-02   +6.921737833188583e-02   +5.061377969273048e-02   -1.373343415289521e-01   -2.524199418400461e-02; +1.567793439590644e-01   +2.470813010225818e-02   +2.536249895744955e-01   -4.534387360996182e-02   +6.593503463374903e-02   +1.449993556179549e-01   +9.628831679938185e-02   -6.873721165825106e-02   +5.953236306286490e-02; +4.169542490618375e-02   +9.527657619454433e-02   -8.590779121782167e-03   +1.251294679003980e-01   +2.181280942523115e-01   -4.503372209062571e-02   +3.299176248393763e-02   +8.699405244356702e-02   +3.771193560093455e-02; +5.581186661542663e-02   +2.258971164038595e-01   +5.282389597037504e-02   +7.386401268674492e-02   -4.238558208970830e-02   +8.628817690816837e-02   -2.819499321349012e-02   +6.122040535783083e-02   +1.514930588067987e-02; +6.287527740301829e-02   -3.967228654444137e-02   +2.000014542484341e-01   +6.562610273246980e-02   +1.150707826167550e-01   +8.545977405725345e-02   +1.380514078662799e-01   -1.189575065042305e-02   +8.677592217812784e-02; +1.217374287323939e-01   -1.667823813066851e-01   -7.601595865400897e-02   +3.038596415476304e-02   +4.052087339088982e-03   +9.229257574942365e-02   -5.332873113703944e-02   -4.241919619839336e-02   +1.436392568848819e-01];
L5_L2_iGABA_netcon = [-1.017648660321007e-02   -2.789135847558259e-02   +2.334620588442043e-01   +6.750127839448963e-02   +2.270983774488223e-01   +1.232624835793332e-01; +7.304931967480652e-02   +1.921170171285481e-01   +1.842997373198709e-01   +4.520031672613812e-02   +1.036736831904319e-01   +1.620270456527902e-01; +1.044209427164950e-01   +1.472107234461151e-01   +2.712510958367876e-01   +1.082681604703784e-01   -7.670548651481218e-02   +3.621069245018292e-02; +1.371674192724617e-01   -1.423121845427627e-01   -7.465506063680416e-02   -5.347262580154644e-02   +5.851878983583247e-02   +1.938306311092826e-03; +9.576508622797447e-02   +1.538713697233110e-01   +2.097279674653408e-01   +5.520095404230072e-02   -3.152566335230710e-02   +1.257955288847786e-01; -1.664977374667670e-01   +1.177919107754083e-01   -1.467749141116905e-02   +1.913298773525952e-01   +5.602980100349989e-02   +4.023296844613944e-03; -1.142107591490766e-01   -7.227869133134798e-02   +7.106650596826936e-03   +1.313769446503226e-01   +1.107433684110732e-01   +1.422056775875509e-01; +2.260327335439070e-02   +3.367702301509325e-02   +2.371205016000840e-01   +4.223566385865848e-02   -2.481248043784846e-02   +2.873307077887181e-01; +1.507566647134641e-01   +1.646070859160179e-01   +5.185135336568884e-02   +1.124156637103617e-02   +1.238765991045822e-01   -3.682802981861309e-02];
L3_L2_iAMPA_netcon = [-9.387959013414333e-03   -7.177545301030713e-02   +1.457676961835297e-01   +9.698669977889710e-03   +1.103817180254572e-01   +1.421622313057559e-01; +8.289051453141774e-02   +5.562948839489089e-02   +5.068552007525506e-02   +6.733480790484270e-02   -1.141972184604859e-02   +1.838917968217935e-03; +5.908995832493920e-02   +2.077226805027101e-02   +3.232459038312235e-02   +1.626997548761946e-01   +3.700238424850810e-02   +8.102757501525719e-02; +1.175003211048319e-02   -1.423009638963624e-01   +2.612974615951617e-02   +6.104817474358155e-02   +3.168438355190006e-02   +1.013021304050676e-01; +2.157807849976641e-01   +2.314511489739509e-02   +1.117497213152171e-01   +8.174595838854659e-02   +4.893361721967374e-02   +1.743003274096899e-01; +1.107629384306286e-01   +1.496549359880869e-02   +3.693202134998701e-02   +2.059765410564292e-01   -3.264735555617252e-02   +2.850051916176803e-02; +2.109570076370815e-01   -1.063896291591416e-04   -1.036878225449592e-02   +1.431535324334309e-01   -5.465467175500549e-02   +1.092069433203371e-01; +4.846526464191034e-02   +1.241203853632171e-01   +1.778088001572536e-01   +1.124647449425772e-01   -1.353452084928115e-01   -3.060112036603701e-02; +1.997856219871199e-01   +7.815072214788650e-02   -1.457748058317942e-01   +8.586404954561082e-02   +2.718183792208576e-01   +7.409392460168782e-02];
L2_L3_iGABA_netcon = [-2.612533622087589e-01   +1.793522449190901e-01   +4.953286946699888e-02   -3.866688901611052e-02   +4.334124312884462e-02   +1.544491926871357e-01   +3.665179807392649e-02   +7.497547811339104e-02   +7.833310393189952e-02; +2.366046317548646e-01   -4.559171193378163e-02   +2.783011911388077e-02   -9.591437654056717e-02   -1.464136156387082e-04   +2.695865969703382e-01   -2.822676909866728e-02   -4.983102453427503e-02   -5.991441999884596e-02; +2.360957525901928e-02   +1.226862952876520e-01   +1.234544109183261e-01   +8.148037485189749e-02   +1.112611263960349e-01   +9.817802182612556e-02   +1.467410558054711e-01   -2.594478281899999e-02   +1.607080857606506e-01; -1.397001511250407e-02   -4.737964267483991e-04   -1.342994990582296e-02   +1.261798819374279e-01   +1.291744116830119e-01   +1.195949865735962e-02   +2.029211400960043e-01   +1.398450765289153e-01   +3.471326784477943e-02; +1.550296371905993e-01   -1.034721864460590e-01   +1.109793512883126e-03   +1.670178100274816e-01   +5.601031388209965e-02   +9.480782872114160e-02   +1.633337056702867e-01   -2.444930758610551e-02   +1.687837407914484e-01; +1.280247048851594e-01   -4.827876114813912e-02   -2.553069626621750e-02   +7.102575097332026e-02   +1.628642038484513e-01   +2.401930562406100e-01   +4.720886993053865e-03   +3.443838416541893e-02   -1.014657722040538e-01];
L1_L4_iGABA_netcon = [+1.981865098389899e-01   +9.274454217943615e-02   +6.965859930102586e-02   +3.365547758027353e-02   +9.234738629473158e-02   +2.399517260060245e-01   -4.372704341337012e-02   +3.962162299325740e-02   -1.273315271424766e-01; +3.426155131628564e-02   +3.366933599261381e-02   +9.465236477652948e-02   +1.466645389406166e-01   +1.171470639567573e-01   -9.147177624756787e-03   +6.879422163445463e-02   -5.372146056340345e-03   +1.235419112898187e-01; +1.181078510175814e-01   +1.117378593044647e-01   +1.217167313465636e-01   -2.408519142945259e-02   +1.571581602218706e-01   +2.537173538754676e-02   -7.461069766391482e-02   -9.820591587329672e-02   +8.256587157548999e-02; -2.360499147487617e-02   -7.553350981327708e-02   +9.312054582825056e-02   +2.023770049543071e-02   +4.297485672261320e-02   +1.935946639168544e-01   +6.571855065724118e-02   +1.056799770435460e-01   +1.623528150144589e-01; -1.056369409116226e-01   +2.028529087464196e-01   -7.154158762729890e-02   -1.833714585358615e-01   +1.261228624754256e-01   +7.464887171592345e-02   -2.273640519762414e-02   +1.958224818750426e-01   +6.620478766539017e-02; +4.788776968778122e-02   +2.789925875113259e-02   +6.866842491790365e-02   +1.391090757612911e-01   +6.173503338208153e-02   +7.613294545514029e-02   +7.891021749097894e-02   +6.120640660878555e-02   +7.850262320416791e-02; +1.139619048670774e-01   +1.449528439796172e-01   +2.665495957151608e-02   +1.569372328500078e-01   +1.471088347478636e-01   +5.972772656626336e-02   +2.221717004876794e-01   +2.141571580453729e-01   +4.573939681092825e-02; +1.052325368165608e-01   +1.945848778379467e-01   -2.375480427478352e-02   -6.617575798503253e-02   -1.563576416279777e-01   +3.911898395016917e-02   +5.496396561810729e-02   +1.194242906682104e-01   +2.011218638024396e-01; -2.868323815362534e-02   -1.522923119197186e-02   +8.340410055536018e-02   -1.011386722609514e-01   +8.416479835596968e-02   +1.817420838862781e-02   +8.699049313475452e-02   +1.988788324974949e-01   -8.073461866910268e-02; +2.439136902147009e-01   +8.965145044951012e-03   +2.473051107169915e-02   +4.975391296599219e-02   +9.426865467067795e-02   +1.062813532251711e-01   +1.094068521256263e-01   -2.009750229102525e-02   +1.908432018849861e-01; +1.192508721932678e-01   +1.005533251009589e-03   +1.210632159851249e-01   +7.885909520680695e-02   +2.041255988294882e-02   +1.784941181789331e-02   -3.887149453444089e-02   +9.595310319408867e-02   -7.415447749411197e-03; +2.169765315264791e-01   -1.696500611133218e-02   +1.567522460366277e-02   +1.619491312332429e-01   +9.061124037690516e-02   +2.169887015161128e-02   +9.921400572846892e-02   +1.688735140880119e-01   +1.813040454504248e-01];
L4_L1_iGABA_netcon = [+1.839779099627527e-02   -5.601020924465184e-02   -7.914397136602377e-02   -1.822358937107053e-02   +5.986393444194375e-02   +4.792126757668593e-02   +1.278173371198592e-01   -9.325797577289710e-02   +7.977088636844022e-02   +1.082843761497065e-01   +1.026170102434067e-01   +1.407071487386082e-01; +1.261989927186950e-01   +2.049670250547482e-02   -1.753224217254063e-02   +7.936953558729590e-02   -8.885923931121877e-02   +4.098461886364196e-02   +1.746000748819493e-01   -1.426251656232664e-02   -6.932232960957826e-02   +1.114928232087854e-01   +2.202983516383329e-02   +1.554811511998165e-01; +4.576197308466176e-02   +9.163816014969198e-02   +1.702282517610934e-02   +1.047467102373669e-01   +1.238686736357922e-01   +1.311602989347941e-01   -1.956269560396025e-03   +1.403855483672828e-01   +1.388887775496441e-01   -3.665151352305066e-02   -3.991648864641942e-02   +1.584654989938936e-01; -6.423475126490259e-02   +6.024530279153370e-02   +1.683921746923323e-01   +1.003921952590756e-01   +1.494884465152825e-01   +1.495791003152624e-02   +1.588291278513981e-01   +6.565299262607530e-02   +6.381742276210675e-02   +1.938530712738190e-01   +1.982723975461716e-01   +1.077598797670793e-01; +2.184344620401598e-01   +1.714210348114513e-01   +1.106153408208283e-01   -4.739099941659166e-02   +1.221384964862990e-01   +1.252523654669746e-01   -2.022033501988270e-01   +9.352309947323831e-02   -8.095111655366580e-02   +1.124193702933639e-01   +6.168922418867441e-02   +8.000162180006290e-02; +1.527841362309079e-01   -1.669843624554708e-02   -7.894656824094690e-02   +1.101560714049816e-01   -6.185909524139015e-02   +1.337104348609478e-01   -8.222518222169367e-02   +1.632846318686583e-01   +6.110461783095902e-02   +1.356559929059037e-01   -2.272836188204249e-02   -1.133057788885708e-01; -8.722330568548580e-03   -4.764298294905089e-02   +1.376054825467005e-01   +2.237725741054236e-01   -1.714412809583613e-02   +1.020515429125123e-01   +4.138563915272052e-02   -1.389241078055121e-01   -4.110513547231105e-02   +1.473482901002367e-01   -1.359017812252237e-02   +3.568755148856845e-02; +2.095135013840743e-01   -2.944959507921433e-02   +2.162658602220856e-01   +2.405392316440536e-02   -7.686097453991410e-02   +1.147255711709772e-01   +1.601600496180518e-01   +2.389492497231400e-01   +8.818091245504639e-02   +7.563156878850433e-02   +6.748343281877206e-02   -6.505898957363289e-03; +1.854714102718737e-01   +7.421221542980083e-02   +1.824617089761266e-01   +2.584567911608839e-02   +1.907324283131157e-01   -3.876519337061720e-02   +2.352901212129649e-03   +8.844470488109753e-02   +1.878322003998062e-01   -7.841368170320417e-02   +1.711744946351954e-02   +1.241009759446896e-01];
L1_L3_iAMPA_netcon = [+1.098813435740935e-01   +1.649047540161002e-01   +1.398950716028595e-01   +1.745972298430278e-01   -3.765110664087536e-02   +1.417439328684698e-01   +2.199004414582939e-01   +9.054110637653176e-02   +1.026237292639068e-01; +2.916572022179110e-01   +1.640830741494366e-01   +1.160184851520222e-01   +2.404108943307154e-01   +2.406020633261190e-03   -1.220919185415757e-02   +2.287421756375422e-01   +9.833127189282953e-02   +2.032117492948654e-01; +9.001348698549770e-02   +8.419110918898852e-02   +1.099957582761236e-01   +4.348235738057380e-02   +6.928349548893331e-02   +3.624481398403720e-02   +1.358917105741129e-01   +9.121880658308981e-02   +1.382528621624539e-01; +2.098939551843057e-01   -1.677179626543725e-01   -5.139788670322769e-03   -5.957614375381368e-02   -5.016967622044396e-02   +8.041364948484962e-02   +7.003794910206178e-03   +1.457792721328064e-01   +1.986609373258022e-01; +1.191356293393491e-02   +8.461049627327151e-02   +4.030198298206882e-03   -1.424838932943179e-01   -8.612561479350585e-02   +8.503613624566828e-02   -3.225873110009542e-02   +7.119467283198067e-02   +1.984349062734110e-02; +1.107769342009237e-01   +1.505736255920307e-01   +2.914795414934119e-02   -3.786770123183913e-02   -3.753920036339432e-03   +2.696589503346386e-02   -4.944474963585547e-02   +1.162601664046062e-02   +2.582174095931379e-01];
L3_L1_iGABA_netcon = [+7.250660696964659e-02   +9.206169718144544e-03   +1.511190615165610e-01   -4.175359854245433e-02   +1.220619333941859e-01   -4.082429917759461e-02; +1.725111087207646e-01   +1.121542143213940e-01   +8.676362881595720e-02   +2.251332948642714e-01   -8.125910138624558e-03   -4.772761468321411e-03; +1.243110243247535e-01   +3.627407552966576e-02   -7.651904643235632e-02   -1.574010588428251e-02   +1.031529222990650e-01   +4.023507939720512e-02; +1.203538443946829e-01   -8.447776419131235e-02   +9.450917931117450e-02   +5.067489285434473e-02   +1.709406296960301e-01   +1.595071384371787e-01; +1.280730717191719e-01   -3.171380504566657e-02   +7.541571223368075e-02   +6.124602852546945e-02   +4.298619838068198e-02   +8.612929701784369e-02; -1.119932884664546e-01   +3.447219222650828e-02   +6.643317254455577e-03   -6.916624800592822e-02   +3.014290022046003e-02   +2.406974036179445e-01; +1.041810255373156e-02   -1.244948641559291e-02   +1.280508652814103e-01   +4.454935231077509e-02   +1.168235135996126e-01   +1.370909000026043e-01; +4.204962021511285e-02   +1.446044976513451e-01   +8.524429025780711e-02   +9.144558219406611e-02   +5.099654132457924e-02   +1.904974721452643e-01; +7.456015224921622e-02   -1.949924672567605e-02   +4.013640748400450e-02   +1.085602426504353e-02   +1.188419772242924e-01   -1.481105638122052e-01];
L5_Input1_iAMPA_netcon = [-3.451720513098314e-02   -8.757322379288453e-02   -6.706391288962912e-02   -1.070341857044296e-01   +9.724901733373745e-03   +5.174551937134974e-02];
L6_Input2_iAMPA_netcon = [-5.658215146628827e-02   +8.034578993639402e-02   +2.799612279293400e-02   -2.230582843960515e-02   +1.312437857078095e-01   -9.169382932982789e-02];
L5_L6_iAMPA_netcon = [+9.229063460715019e-02   +1.026246085531403e-01   +3.811641429512672e-02   +1.097309697216517e-01   +1.552909107861164e-01   +5.481414454117841e-02; +1.220168662027949e-01   +1.506828525855607e-01   -4.491556908384177e-02   -1.034222048807206e-01   +1.036076147930603e-01   +5.479998810157695e-02; +1.670765156510320e-02   +6.939832404705223e-02   -1.208149019309604e-01   +2.470136595639519e-01   +1.526086287446305e-01   +8.333469226045691e-02; +2.562513404504018e-02   +2.655752776939265e-01   +5.314126168270977e-02   +2.950083076341378e-01   -1.281843430087198e-02   +6.545604819737971e-02; +1.292441600471704e-01   +2.113261817796204e-02   +7.852990649420857e-02   +7.575623431047406e-03   -2.183737890943632e-02   +1.294421496495613e-01; +5.895592732428440e-02   -1.338409711132854e-01   -2.885815310193655e-02   +5.924267058753213e-02   +1.219701934494841e-01   -6.619411348670975e-02];
L4_L5_iAMPA_netcon = [+1.024183535069144e-01   +1.289964132046549e-02   +1.714183817994768e-01   +1.801973731606676e-01   +1.757127026605826e-02   +1.821297240111143e-02   +1.852498885902919e-01   +2.186363317798048e-01   +1.193594751812512e-02   -5.590946707099359e-02   -6.773023071721684e-02   +7.224751739378199e-02; +2.072258416295394e-01   +1.265099460181306e-01   +6.169390288086549e-02   +9.984678480105380e-02   +2.019199554610121e-01   +2.650377150339987e-02   +1.055267154326309e-01   +1.107511154360963e-01   +5.184451579156668e-02   +1.039649186294281e-01   +7.892846795467839e-02   +2.654091506208741e-01; +7.685562175794897e-02   -5.140267979642617e-02   +3.079035251656024e-02   +5.798371268327848e-02   -1.098242687710005e-01   +9.777254801887712e-02   +5.976420737958975e-02   -3.073966055389676e-02   +7.084251635543559e-02   +2.203740374726569e-02   +1.391828187593460e-01   +1.161869842997039e-01; +7.877958124778012e-03   -1.088331425175735e-01   +1.374217176674203e-01   +2.944956840666636e-02   +7.106599955019334e-02   +6.115434721536392e-02   -3.395409858149586e-03   +1.600482720206381e-01   -5.059130027569336e-02   +2.136086331322733e-02   -3.719470049198430e-02   +4.876882341778334e-02; -5.763177347514204e-03   +1.575088344836001e-01   +2.177388708814593e-01   -1.440138047048960e-01   +1.596370971886211e-01   +1.645507072839117e-01   +3.407105382148536e-02   +1.080194889573429e-01   +1.993044816703688e-02   +1.223563022596915e-01   -1.457056783623736e-01   +2.348650431351190e-01; -1.397464487365001e-01   +5.497399909446954e-02   +3.355887126144576e-02   -1.162877939243603e-02   -3.651891579927041e-02   +1.378136288968026e-01   +3.084561669070098e-02   +6.071344719900114e-02   -2.133193984394794e-02   +9.907346185825708e-02   +1.595632750641914e-01   -3.648768508681966e-02];
L6_L4_iAMPA_netcon = [+2.504896256694864e-02   +6.525228031395952e-02   -2.152583808683914e-01   +2.119134114713470e-01   +1.771592846307752e-01   -4.078763309558715e-02; +7.204003129006040e-02   -7.757105209007029e-02   +6.384475444493548e-02   +8.136676274527421e-02   +2.719600103867793e-02   +1.620392528371279e-01; +9.218843610183575e-02   +2.175370254421931e-02   +1.300693182539816e-01   +1.178455686500499e-01   +1.075077273958439e-01   +1.470792611500188e-01; +9.772767838887475e-02   +1.442085642216756e-01   +3.101646644158066e-01   +1.598551410919946e-01   +8.110572269937769e-02   +1.926706513735171e-01; +5.969166559704873e-02   +4.702034921033105e-02   +5.318866896191407e-02   -6.589034715159704e-02   +7.166787441045160e-02   -6.418787171511486e-02; -2.961395383136696e-03   +6.395332421211114e-02   +2.282172396913083e-01   +1.447537072584688e-01   +1.714679092262466e-01   +1.371366373973965e-01; -5.657219472601322e-02   +1.500287533777867e-01   +6.919512413718318e-02   +1.612314287705900e-01   +1.121189387017911e-01   +8.569075159548097e-02; +2.764354263528746e-02   +5.349979639163988e-02   -9.510208100947151e-02   -7.951380709696761e-02   +6.798359440858483e-02   +8.639682258007605e-02; +8.385866501239263e-02   -3.285584599984921e-02   +9.629732980958654e-02   -9.845789787833433e-03   -2.290659052732705e-02   -2.024572652982651e-02; -5.722184098860590e-03   +2.272363164919073e-01   +2.307402409900541e-01   +3.110310044341409e-01   +2.492079705659122e-01   -5.419375289291228e-02; +2.118105065563132e-01   +3.405480217171249e-02   +1.574592520927818e-01   +1.033241635039712e-02   -5.735045510903716e-03   +1.853003205198548e-01; +1.593158704321101e-01   +1.031493061602993e-01   +5.092693174264834e-03   +5.789426767488175e-02   +1.176804431225915e-01   +6.851664185523791e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
