function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.048561295131063e-01   +2.201863103539236e-01   -4.191205066517291e-01   +1.050355370081461e-01   -2.242229609119641e-01   +9.857512843201338e-02   -1.779100047185669e-01   +2.633486321992697e-01   -3.139790785236867e-01; +3.155898096152073e-01   +4.865233233277941e-01   -5.758444360556592e-01   -1.229911831049038e-01   +5.087692242390949e-01   -3.799578570337269e-01   +1.530894710649555e-01   -5.844729568734985e-02   -6.979323625974263e-01; +1.159201133859588e-01   +2.761774402389796e-01   -3.235438187229547e-01   -2.908970365210031e-01   -1.197499639020788e-02   +1.605552495602741e-01   +3.464176673960672e-01   -1.677050818810794e-01   +6.188978605971673e-02; -5.479914483089142e-01   -1.572824085173869e-01   -6.881271615946399e-03   +1.493205117093007e-01   -2.536213078951602e-01   -4.918581087070962e-01   -1.499355023068492e-01   +1.235479246511879e-01   -1.537965269139545e-01; -8.360736472132529e-02   +6.549038359322584e-02   -2.442049301271960e-01   +7.824299382986158e-02   -3.510974584028723e-01   +4.715431017003089e-01   +4.509407760786468e-01   +4.421792751392528e-01   +2.441555862120168e-01; -4.355153535778865e-01   -3.952321680511984e-01   -1.103359797512857e-01   -1.604435778876565e-01   -2.231778862274113e-01   +2.369592154407806e-01   -1.414515707515032e-01   +4.926054412984097e-01   +7.131386426283397e-01; +6.229982054249679e-01   -5.290389077302503e-02   +3.801708253270489e-01   +5.266098401963735e-01   +1.097172058571975e-01   +1.452636054615851e-01   -7.111071043283093e-01   +2.606214073966844e-01   -2.588390573070689e-01; -1.327789542803567e-01   -3.562970511058704e-01   +1.307126696189430e-01   -1.124948065146268e-02   +2.429471098489534e-01   -1.985803402834046e-01   +1.448256575420271e-01   +1.817202836023637e-01   +5.214519525855259e-02; +1.612370854996466e-01   -2.970564291621692e-01   -1.763228832662464e-02   -1.123566984043247e-01   -4.106732286622096e-01   +4.384399048503074e-01   +8.737837139361959e-01   -6.604740123824209e-01   +1.198323148056876e-01];
L1_L2_iAMPA_netcon = [-5.790916398615258e-01   +7.845346772394099e-01   -3.773223399150991e-01   +5.496112803756706e-01   -3.933932583125117e-02   -3.709982935219557e-01   -2.956832258890523e-01   +1.509707821672454e-01   +2.828689945110230e-01; -3.672103449798689e-01   +6.878563023993423e-03   +7.682710475206567e-02   +1.809271836233679e-01   -3.161623190011799e-01   -5.455940096902887e-02   +2.761169936148283e-01   -6.406793718927362e-01   -4.848151952029474e-01; +2.639080899224762e-02   +2.647760916630200e-01   -1.039963680617373e-02   +4.077805911855445e-01   -1.233725304635956e-01   +2.210757790295949e-01   +3.367906924450147e-01   -4.257216240589600e-01   -3.871215840496961e-02; -4.743058755186751e-01   +5.704413233799309e-01   +5.555317966506548e-01   +4.844172496951019e-01   +3.966771676395733e-01   +3.046913571304741e-02   -2.017405010804119e-02   +5.036933781400037e-01   -3.285797714725394e-01; -6.300201143380872e-01   +1.717358166114601e-01   +1.354212620845453e-01   -2.357181287722826e-02   -5.458511193261216e-01   -9.496344399653902e-01   -3.926831290697521e-01   -3.141728665469432e-01   +3.511677090202281e-03; +3.047205322784337e-01   -5.939448842899204e-01   -5.542029632039848e-02   +2.470327102162728e-02   -3.227361520764292e-01   +3.545405753660177e-02   +7.522472560303545e-02   +3.129858201771109e-01   -2.111593180144865e-02; -1.053887375483670e-02   +2.229633648310476e-01   -2.588427845811303e-01   -3.367062865100445e-01   +9.493184735299953e-02   -3.285027023960145e-01   +6.508454802193085e-01   +1.297684332736949e-01   +3.530395155178370e-01; -7.458264541438473e-01   +1.485513578606770e-01   +2.095576068747379e-01   -5.594273562912347e-01   +1.360744258117827e-01   +8.418049556415512e-02   -7.183306472300807e-01   +3.722401834119181e-01   +1.756853130666403e-01; +2.935877771273673e-01   -2.439996869778003e-02   -1.796004990641575e-01   -1.953018568700840e-02   +5.044981859750547e-02   -3.756731356643454e-01   +2.740551062565635e-01   +4.303962464899960e-01   -1.080174755751645e-02];
L2_L5_iAMPA_netcon = [-2.744634901971441e-01   +9.036367122001955e-02   +2.935818614061608e-01   -3.176811853844704e-01   +3.288650953495384e-01   -3.915054227900160e-01   +4.159544173432883e-02   -1.937654023486634e-01   +2.172528332126491e-01; -3.374528176151563e-01   -5.175636122707570e-01   +3.554817014714510e-01   +2.664261803513563e-01   +2.455249925115167e-01   -3.465420286512715e-01   -2.886088594198613e-01   +3.465050481169687e-01   -2.153905933389245e-02; +9.681571937393568e-02   +3.809488967758169e-02   -8.174487619191560e-02   -4.635762532686219e-02   -2.902935199820359e-01   -2.797513183348785e-01   -2.363324127099001e-02   -1.048141711975425e-01   +6.442020553894585e-01; -2.518823531250092e-01   -1.943860282770046e-01   -3.881042047405381e-02   -1.297291400691042e-03   +6.140444069241496e-02   -1.593818025771188e-01   -2.288622187919397e-01   -1.086562621743095e-01   +3.824266824721230e-01; -9.474303378149684e-02   +4.979269309046770e-01   -1.260121759609372e-01   -1.135756704288649e-01   -7.934065773497787e-02   +5.664819338206873e-01   -1.083655631490495e-01   -1.326368866750276e-01   -2.071415325154683e-01; +3.578692279855250e-02   +2.299382576209900e-01   +3.596725400404756e-01   +2.506775951744802e-01   +5.018673778457894e-02   -2.984514732251883e-01   -2.853158197308648e-01   +1.819843262848431e-02   -3.667100575907235e-01];
L5_L2_iGABA_netcon = [-1.089005372349626e-01   +3.370517921435887e-02   -3.926392358162203e-01   -5.428976666953014e-01   -3.438795993808307e-01   -2.597222375804249e-02; -2.375169228117667e-01   +2.030457053283705e-01   +3.895445443510883e-01   +2.889348925012779e-01   +1.380935126625143e-01   -2.516910288300700e-01; -3.799376408678877e-01   -2.325830794547282e-01   +2.957187894459323e-01   -4.236373880329841e-02   +4.371824163801769e-01   -3.062142370651236e-03; +4.066740775176658e-02   +3.195397303737745e-01   -1.240218675158481e-01   -3.740674352904406e-01   +1.601755597731901e-01   -3.816632872187893e-01; -5.139676525965577e-02   -2.909579090930499e-01   +4.517405753113655e-02   -2.083144046003029e-02   -2.534524744370799e-01   +1.708341307231521e-01; -3.590458711100699e-01   -7.113508601727582e-01   +3.262857075151985e-01   -2.408007613458146e-01   +3.708685144165041e-01   -9.987359734028592e-02; +1.748000220895423e-01   +2.561439194242717e-01   +5.640328581541078e-01   +8.909402985007003e-02   +4.788108550960463e-02   +7.703904696833983e-01; +1.371563972636196e-01   -5.360491556171877e-01   +5.309831751690846e-01   -4.697367502556830e-01   +9.379988001116921e-02   -2.482378739889531e-01; +1.802024852217116e-01   -1.042246842398682e-01   +2.446648635873601e-01   -2.942784611088777e-01   -1.558082523086665e-01   +6.090443266371424e-01];
L3_L2_iAMPA_netcon = [+1.299511224653621e-01   -9.578529549581433e-02   -9.866128432390947e-02   -1.200094004655400e-02   -3.022484537910652e-04   -2.543177788845186e-01; -1.793471900389718e-01   +5.569587741421316e-02   -6.382750880807990e-01   +2.996262246995551e-01   +4.022472746845778e-02   -6.419518135939173e-02; -2.879365035732872e-01   +5.201786310586295e-01   -7.384822766027308e-01   -5.800870287437202e-01   +1.675664303570748e-01   -3.514474444202639e-01; +5.841979023160981e-01   -2.895227982506444e-01   -7.099717850244056e-01   +2.882186248028970e-01   +2.780044347627091e-01   -1.857956848140759e-01; -7.167821007379824e-02   +1.778300295710442e-01   -5.487534904031025e-01   +1.668893546499079e-01   -5.752522348561653e-01   -1.506793188482420e-01; -2.800280445879605e-01   +1.644271044403883e-02   +2.196381903149578e-01   +2.446419214597064e-01   +4.239712529724396e-03   -3.122018954268541e-01; +1.508034433173501e-01   +3.055172507549871e-01   +3.423770056433917e-02   +5.013759365843096e-02   +2.603127623293252e-01   -2.147125923207950e-01; -4.096588329144787e-01   -1.450032041249044e-01   +5.981565775164607e-01   -2.176246620117923e-01   +1.953629989345135e-01   +2.169700463305211e-01; +2.816091501849826e-01   +3.231832217437725e-03   -1.834544061393384e-01   -6.113198751814677e-01   +1.269836867253923e-01   +3.285990407443510e-01];
L2_L3_iGABA_netcon = [+5.749052797780225e-01   -2.829554966676502e-02   -5.403098437921410e-01   +1.182628843570071e-01   -8.082927220621873e-01   +2.284441499913567e-01   +3.979639651877827e-01   -1.202875514999456e-01   -1.664676886452691e-01; -2.330956602859280e-01   +5.026833934533650e-01   -1.865304861008467e-01   -4.602639814989191e-02   +1.451578933496645e-01   -1.321957736390572e-01   +1.695908691056367e-01   -6.289080981343783e-01   +2.040444345462814e-02; +5.147211668082758e-01   +3.434233190482204e-01   -1.850114818522225e-01   +5.532803047335250e-01   +2.242871230073643e-01   -4.683998086806912e-02   -2.547070570710794e-01   +8.341892117060176e-02   -2.205713525105787e-01; +3.720115912664454e-01   +2.571578368304744e-01   -5.441319559224003e-01   +4.747258945804250e-01   -4.332732809960369e-01   +1.438225051349227e-01   +1.921407130640032e-01   +2.705219963030835e-01   -9.092634126813852e-02; +3.256021005933559e-01   -1.135869967953720e-01   +3.894923784129098e-01   +5.507221156961951e-01   -6.045905603914369e-01   -2.486675162186545e-01   +2.046833243636887e-01   -1.878595734816095e-01   -3.131178384798495e-01; +3.657145307617585e-02   +6.774977436783345e-01   +5.107111813688012e-01   -3.347797180417493e-01   -7.080403910345787e-01   -5.636813346177223e-01   -2.558098865177322e-01   +6.446901551418818e-02   -3.975866187429740e-01];
L1_L4_iGABA_netcon = [-5.535124218320493e-01   +3.051271730622231e-01   +1.898473608605804e-01   -2.485733817047911e-01   -9.741372213331534e-02   +8.241350722759664e-01   -3.438261343200832e-02   +2.636991302730015e-01   -8.806342822196968e-03; -2.667743351908691e-01   +1.376509058654554e-01   +1.045459278689619e-01   -4.566120765680650e-01   -3.654201316456280e-01   +4.246028945358843e-01   -1.081712553769920e-01   +2.449228178009592e-01   +1.731412709628374e-01; -3.423674744374988e-02   +2.242436714507598e-01   +1.663968023954741e-01   +6.914541577885902e-02   -2.705583296141237e-01   -1.117099343996706e-01   -1.726130632234519e-01   -1.101459760200094e-01   +1.382381868622167e-01; -9.960770934221419e-02   +4.592428710501726e-01   +2.770278865268674e-01   -3.696969805788231e-01   -4.807008534595552e-01   +4.405889547549069e-01   +7.142244352148638e-01   -4.243230024887545e-01   -3.778145453689171e-01; -3.189799222954731e-02   +1.378061101360789e-01   -1.787658564732962e-01   -6.535324168488738e-01   -6.577212825867556e-01   +2.375960339096701e-01   +5.648830190045986e-01   +6.000511836515567e-01   -1.326657525002058e-01; -2.270038608001309e-01   -7.006319084737467e-02   +4.210864532596414e-01   -3.550921780248200e-01   +5.714913950088174e-01   -4.075052090647385e-02   -2.005209153952970e-01   +1.629576176449150e-01   +8.536638290232822e-02; -2.384654948857469e-01   -7.842060148777252e-01   -2.238518486293735e-01   +3.228452707206331e-01   +6.933913234472617e-01   +9.378304577348248e-02   +7.867477620950383e-01   +1.756797717395174e-01   -8.361281292362313e-01; -6.827421047924589e-02   -3.216082567542952e-01   +4.292130427911794e-01   +3.046033103189394e-02   +1.572303169705453e-01   -3.045398152176190e-01   +3.367710464758832e-01   +2.529079702226960e-01   +2.653357325213605e-01; +2.721480457474477e-01   -1.010802380131178e-01   +4.230003536195762e-02   +4.239011116824934e-02   +9.494261744324867e-02   -3.533480324081247e-01   -1.882905246730389e-01   -1.157989381487235e-02   -1.312252249545658e-01; -5.502235711524155e-02   -4.538593782839613e-01   -4.534275334651344e-01   -8.531478920914168e-02   +4.167288379557694e-01   +2.012579171215998e-01   +4.071181027567016e-01   +1.474776701143719e-01   -1.235288050309814e-01; -4.519603090897480e-02   +1.586531020256167e-01   +4.150108234085102e-01   -1.300279208061952e-01   +4.154033403596162e-01   +3.771243181358416e-01   +7.096007822884723e-01   +2.202639736286921e-01   +4.986840875608765e-01; +3.210895497346997e-01   -3.865163019413821e-01   -3.105987366709342e-01   +2.101859663192965e-01   -1.353686984681850e-01   +1.890472504985664e-01   -3.846534335651731e-01   +4.401004881010188e-02   +2.595762154789870e-01];
L4_L1_iAMPA_netcon = [-7.049241913567608e-02   +3.999710222114877e-01   +1.513079516603733e-01   +1.770331355396687e-01   +5.213956690623567e-01   +1.874534485618464e-01   +5.382530627011467e-02   +9.355968577510479e-02   -9.270632535259585e-02   -4.768033636508133e-01   -3.257310283740130e-01   -2.624464277416048e-01; +2.787808497208796e-01   -2.017019054671666e-01   +4.247642962168036e-03   +1.811403742023921e-01   +4.530581113649713e-01   +8.128758047433666e-01   -3.017204391601442e-01   -1.736693894673015e-01   -4.771947684613141e-01   +5.045607034680341e-01   -6.683378410784901e-02   -9.965838473006726e-02; +4.557380180777058e-01   +2.204090580307229e-01   +2.217103919747772e-01   +2.476054695835107e-01   -4.650332232166393e-02   +3.847951852213073e-01   -3.523481598065979e-01   -4.878358669585303e-01   -2.719948309858181e-01   +8.660603409819270e-02   +3.515565032343979e-01   +9.380368510826176e-02; -1.528494657686596e-01   -5.186157329253177e-02   +7.580478199615788e-01   +9.774541096589977e-01   -1.705349367414125e-01   +3.628450497785334e-02   +1.297265081294163e-01   +2.433156700867700e-01   -3.227592611317140e-02   +2.093337877530524e-01   +4.424755213694372e-01   +1.464361132663839e-01; -4.342701532242460e-01   -9.553589114975736e-02   +1.460749803171167e-01   +4.744630408620727e-01   +5.984517855011862e-03   -6.826634361789423e-01   -7.862249719125250e-02   -2.036349664655728e-01   -3.373980781822183e-01   -1.908054395662383e-01   -5.111045421438429e-01   +7.200969181147746e-02; +2.951236496046282e-01   -2.339260846392040e-01   -4.077538545245314e-01   +2.982444613108027e-01   -8.987225360268344e-02   -3.654144349986385e-01   -2.357132013992444e-02   -4.708315751821422e-01   -8.738806288840134e-02   +1.802486219888000e-01   +7.413051611189647e-01   -6.226533632800969e-01; -7.356624802126838e-02   +3.669414597182436e-01   -1.871560701024474e-01   -2.920884027998252e-01   +1.377674788419132e-01   +1.091518181727956e-01   +2.482658427473779e-01   +8.001720269379927e-01   -2.305161143756490e-01   +5.809934003004962e-01   +6.646815491626921e-01   +4.814677641152465e-02; -7.720347357902016e-02   +2.905719757052287e-01   -2.407490264817507e-01   -3.056997807299461e-01   -1.998665919648215e-01   -1.747841097667191e-01   -9.110769543613567e-02   +4.030819371894747e-01   -3.918936324013038e-01   -1.635197824652804e-01   +2.019537786234090e-01   -5.566325132736767e-01; +5.504130196107515e-01   -1.632773147932550e-01   -5.488603767186360e-01   +6.962564015381345e-01   +1.427190407849486e-01   +1.116948483665492e-02   +3.524781883425079e-01   +8.323268199140904e-02   +3.818318894742876e-01   +2.069392059648775e-01   -6.835099373905457e-02   +6.614216177995353e-01];
L1_L3_iAMPA_netcon = [-5.159786776299264e-01   -2.863366177804058e-01   +1.091348231154438e-01   +5.918659497828788e-02   -9.231365030356305e-02   -5.308587987186338e-01   +1.337770655772472e-01   +4.431579668812247e-01   +5.479892636968346e-01; -7.101903291179751e-01   +2.313800481137844e-01   +6.995863737608971e-01   -2.196959154487002e-01   +2.161114469829535e-01   +2.409419608123244e-02   -2.234528934513789e-01   -2.418012297656241e-01   +2.947680762242966e-02; -2.134384439951431e-01   +2.488148334971549e-01   -1.351993936288691e-01   -4.222877571277850e-01   +3.850720308153360e-01   -2.544500493298623e-01   +4.030296714014643e-01   -1.055331403684142e-01   -2.176117077274711e-01; -7.395611591881601e-02   -1.931713734693312e-01   +5.251351472292032e-01   +1.577560616884520e-02   +2.348551219204203e-01   -4.446341812887338e-01   +8.379267423836209e-02   +4.228057047077267e-01   +2.399026045725454e-02; +7.973209425757675e-01   -3.959299303360303e-01   -5.382773913621683e-01   -6.159791310358169e-01   -2.722036005405092e-01   -5.749807779636638e-01   +2.600457730407585e-01   -3.679357222854086e-01   +3.844866107535767e-01; -7.034900763767795e-01   -6.784352494626311e-02   -1.072783576156192e-01   -3.191296030499899e-02   +4.467414749261693e-01   +2.929108794539075e-01   +7.740733095610730e-01   +8.076438774252985e-01   -7.238775205511026e-02];
L3_L1_iGABA_netcon = [-2.444664401187853e-01   -5.535162860037415e-01   -8.576799057116449e-02   +2.916796486570314e-01   +2.210831964398886e-01   +1.377538689977152e-01; -3.078305865866479e-03   -2.989959738306693e-01   -2.134360528266225e-01   +1.801593834186772e-01   -2.835779948403780e-01   +4.160834431592010e-02; -6.083135139392506e-01   +2.537144417144505e-01   -5.804427361422607e-01   -8.322306129040836e-01   +3.285123010167612e-01   +4.944928353067000e-01; -1.747458339360445e-01   -1.211375215277443e-01   -3.816177883245883e-01   -2.689484421438592e-01   +3.802520918638096e-01   +2.942737303004100e-01; +3.462710041692598e-01   -2.830438576059203e-01   +5.666730373664046e-01   +2.248207238654854e-01   +1.806956632597885e-01   -7.216694441935145e-02; +5.865133097612210e-01   -1.925518343593277e-01   -2.062684970047055e-02   +2.318900142965279e-01   +3.202310392766320e-01   -1.134509823441837e-02; -3.583574396225865e-01   +5.746657658085993e-01   -7.573981875332036e-03   +2.974970026373857e-01   -9.044631151354565e-03   -1.035390995077295e-01; +9.857296807787148e-02   +1.503582406589933e-01   -3.475564016216596e-01   -3.421008158598252e-01   +6.343476445378124e-01   +1.607554614382872e-02; -4.339778947797188e-02   -3.077966816195099e-02   +5.962200344315380e-02   -5.904417259507584e-01   -2.667027240302824e-01   -2.626456778734691e-01];
L5_Input1_iAMPA_netcon = [-4.078963358545127e-01   +9.727328345910974e-03   +1.716071923116524e-02   +3.851918072332937e-01   -1.052794042459314e-01   -2.046562417322633e-01];
L6_Input2_iAMPA_netcon = [+2.509070241866160e-01   +3.186767434563172e-01   +6.810036808096764e-02   -4.055367943980678e-01   -2.395911233082145e-01   +7.886259749724608e-03];
L5_L6_iAMPA_netcon = [-1.417281201118081e-02   -6.737250879151049e-02   -2.517601332992147e-01   +1.884811658500183e-01   -7.599604009051038e-01   -7.212782604077014e-01; +6.285991888159900e-02   +1.185404627642168e-01   -8.318008429818768e-02   +1.570870426212164e-01   +8.169946935181787e-01   -2.744845723075389e-01; -1.241623856529513e-01   -2.036930410028872e-01   -9.959886617474573e-03   +4.470319041776578e-01   -1.614883004360047e-01   +1.089341394212880e-01; +2.415852194709862e-01   +1.609048868965392e-01   -3.625915594168584e-01   -7.198749572357200e-01   +4.285213415075703e-01   +6.355032732581616e-01; +2.414151993534652e-02   +3.404230600255715e-01   +1.508328890842450e-01   -1.235836625520073e-01   -5.522854409657275e-01   +6.989786134297546e-01; +1.688370948077970e-01   +1.773245184284318e-01   +7.767858546776103e-02   -2.171412953990187e-01   -3.211230634245772e-01   -2.814198570090491e-02];
L4_L5_iGABA_netcon = [+2.068418400576841e-01   +5.115169903670033e-01   +3.765265234969565e-01   +1.445061501171996e-01   -7.705820887392906e-02   +5.334893211776375e-01   +1.978690246409842e-03   -3.278953518966414e-01   -4.709116612476857e-01   +3.217416403634322e-01   +1.036952125939816e-01   -3.626861580034642e-01; +1.924268270751814e-01   +1.348155718856621e-01   +2.235454572287946e-02   +2.872731994597225e-01   -1.964454671358374e-01   +2.560765335997503e-02   +5.594347593700193e-01   +6.612904118421284e-01   +4.958244600456862e-01   -3.735917802296078e-01   -7.720768472425435e-03   +2.133758287083815e-01; -4.499554418375266e-01   +6.190795503559782e-02   +1.616265765252416e-01   -4.510850860519828e-01   +1.310854222784907e-01   -1.729306899375514e-01   -3.949619700245655e-01   +2.296677176769628e-01   -3.568402491672850e-01   +7.621979051504935e-01   -4.268679555960517e-01   +3.315777641893820e-01; -3.219695756009828e-01   +3.751751150399713e-01   -6.731750492739810e-01   +1.730555367197274e-01   +7.160117339599321e-01   +1.157582424048462e-01   +2.080061004644788e-01   -1.347142204326335e-02   -2.753181599492259e-01   +1.613770796372152e-02   +6.154271843672616e-01   +6.253745425903526e-01; +3.037520283882704e-01   +1.387159036679100e-02   -7.672030469791226e-02   +9.881078969389284e-02   +6.115327338897328e-02   +1.547198709120808e-01   +2.637226272895139e-01   -3.681899399890498e-03   +5.265707199643876e-01   -4.616056360129100e-02   +7.172323708052203e-01   +1.970140071721483e-01; +6.068217142587984e-03   +5.958326792971162e-02   -3.722056057420604e-01   +5.738746890557467e-02   -1.939694296806780e-01   +1.438049812553265e-01   +8.052381509914761e-02   +6.903289569319127e-01   -1.019808318490573e-01   +7.482047915822525e-01   -2.384515643418842e-01   +4.187761442942034e-01];
L6_L4_iAMPA_netcon = [+4.123385089926717e-01   -6.229980901136424e-01   -3.504126786456787e-01   -2.354485006085593e-01   +8.717622863045649e-01   -1.031995511579448e-01; -4.883701778484881e-01   -5.369040109310986e-01   +3.486070364964960e-01   -1.980317900681539e-01   +1.205562142429631e-01   -2.359766660355549e-01; -2.951809374046233e-01   -5.802196973549827e-01   +2.598610811020491e-01   -1.323945795185580e-01   +8.027564609255224e-01   -5.738610786822784e-02; +1.921947172187391e-01   -3.084157682614541e-02   -6.032455801059717e-01   -1.783970492722632e-01   +2.868286688016497e-02   +9.870555995564656e-02; -4.945123546403001e-01   +2.441475753170916e-01   +2.530348722897343e-01   +3.979709107399115e-03   -1.166696820595608e-01   +2.563024706315492e-02; +4.402492227095139e-02   +7.262876852600355e-01   +4.530978892220934e-01   -6.670352758543624e-02   -2.731246699455741e-01   -9.857366580331905e-02; +2.151148836814252e-01   +5.087926653753878e-01   -5.858381998878084e-01   +2.424376387068958e-01   -1.272239500840935e-01   +3.219983286104463e-01; -3.083999600824534e-01   -2.525172436608395e-01   +4.407654788401898e-01   -2.687281900140139e-01   +2.363339990223473e-01   -4.954531865240294e-02; -3.580665464220445e-01   +3.313520398850850e-01   -5.612431576393314e-01   +1.472728066583789e-01   -1.055859422584424e-01   -3.650394931523482e-01; +3.012022285298741e-01   +1.804587013328616e-01   -1.702706597796869e-01   -6.873408016389921e-01   +8.045605501098584e-01   -6.460265675970212e-01; +2.114691252004264e-01   -5.379558265823092e-01   +6.522949545304349e-02   -2.916549694718640e-02   +2.828514816165091e-01   +9.701056864298771e-03; +4.049925246239294e-02   -2.878097541443394e-01   +4.252295167723658e-01   -6.538086879792906e-02   +3.342770051818367e-02   +2.075595167309682e-01];
L5_L4_iAMPA_netcon = [-4.343004294213566e-01   -2.008508718855120e-01   -1.601713984513135e-01   -3.459993642432273e-01   +1.317057612671807e-02   -1.688752878824078e-01; -8.385660698840372e-02   -2.458021158734530e-01   +3.932715396585678e-01   -2.679261585823695e-01   -2.201952616416020e-01   -2.820228381367278e-01; +1.942607705453003e-01   +6.163427685810972e-01   +2.964088133235682e-01   +8.858168348231166e-03   +9.230563420076221e-02   +4.057504354577863e-01; -4.176889346773167e-01   -4.732237421955204e-02   -1.153062924708412e-01   -1.271837539274415e-01   -4.723423335811133e-02   +1.174336999411941e-01; +5.211163987182574e-02   +5.979354472757925e-01   +3.338165306665388e-01   +1.406777488849276e-01   +2.113398496463682e-01   -5.636173055299102e-01; +2.359426589136027e-02   -1.225586754935459e-01   +2.362687024730007e-01   -5.132961527816560e-03   +2.111572715819654e-01   +8.818354227889752e-02; +2.751654776306481e-01   -9.480975924116092e-02   -4.739407840555930e-01   -3.556278034692836e-02   +2.322725378652812e-01   +1.721655677425356e-01; -1.775583871104483e-01   +5.697199870500482e-01   +3.750802443098505e-01   +5.676176112864453e-01   -2.847759421645419e-01   +2.660852640018726e-01; -1.929516414675410e-01   -2.465768369616639e-01   +3.359268453514377e-01   +2.756156981475688e-03   +8.054593400735874e-02   +5.606227679715281e-01; -5.664305243161666e-05   +8.882037699086567e-01   -8.824473507700233e-01   +1.033025442462128e-01   -5.760740057827822e-01   -4.987010728923227e-01; -2.600479076377580e-01   -6.360260038645653e-01   +3.670422779194342e-01   +1.742402889305082e-01   -2.265154968820899e-01   -5.609120249762176e-01; +2.486992974409540e-01   -3.277755794741120e-01   +9.606086318382356e-02   -5.458045499697275e-02   -5.313091971841474e-01   +2.638804767530240e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
