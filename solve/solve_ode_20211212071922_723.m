function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.795012583395860e-02   -5.555912704048881e-02   -1.969566422420476e-02   -2.719273258972155e-02   +6.783219893592862e-02   +1.378739933585511e-02   -6.128256275664919e-02   -3.511321823318922e-02   -5.227120867047933e-02; -3.081155383360562e-03   +1.224678809741344e-01   -3.561806155163521e-02   -3.950190656092811e-02   -3.863382113441184e-02   +7.061422959063456e-02   +2.399850748621689e-02   -3.325990178410810e-02   +9.554426721892248e-02; +2.142265006227197e-02   +4.489475062997629e-02   -1.861328729548913e-02   +4.204195538248009e-02   -1.063761030654552e-01   -3.192340750995148e-02   +1.002224585151922e-03   +9.629299341531611e-03   +4.896753380111880e-02; +3.524757279206418e-02   +1.262794182959657e-03   +2.288886179473503e-02   -6.318565375633071e-02   -6.784437220748328e-02   -9.571885779579827e-03   -5.006596287950421e-02   -4.122241072714129e-02   +4.253828744975648e-02; -1.859509259703531e-02   -4.420350675288295e-02   -2.141202102452129e-02   -1.573266513534656e-02   +4.697909898603265e-02   -7.320917158737482e-02   +1.342113385573914e-01   +8.629143011483274e-02   -8.654228153167326e-02; +1.299509136928974e-01   -5.365304692378488e-02   +1.233785515977412e-03   -5.209420347158112e-02   +9.076263748751853e-03   +3.730807762252123e-03   -2.119557299189426e-02   -6.923150885188242e-02   -8.405316466681040e-02; -5.138771830252569e-02   -4.069535665177889e-03   +3.490940213559628e-02   -4.022410842265553e-02   +1.009912707755762e-02   +1.512634219149653e-02   +6.412364985911612e-02   +1.666964593793211e-02   +2.882129658262937e-02; -6.035486113595946e-02   +9.791430251870219e-03   -7.503399909071817e-02   +3.723308634822733e-04   -1.271125697276588e-01   -8.511614968939844e-02   -4.893595987105868e-03   -1.069473166060895e-02   +7.450365105780488e-02; -9.491555682227490e-02   -8.590889246240434e-02   +5.963689454551921e-02   -1.912167943907602e-02   +3.631955807401405e-02   -9.954842437129131e-02   +6.954370869293357e-02   -7.402727705523780e-03   +6.017160884728923e-02];
L1_L2_iAMPA_netcon = [-4.592399947221805e-02   -8.333845626111794e-02   -2.084421377994261e-02   -1.011921243888850e-01   -2.928155110031187e-02   -5.795325920162067e-02   +4.799789144532130e-02   -5.822010106007362e-02   +2.133281319632113e-02; +5.707260346477859e-02   +9.311417509534101e-02   -7.389018986388925e-02   -3.809595181003003e-02   -3.915058407864973e-02   +8.367926755483993e-03   +4.000061151224749e-02   -1.471046745558567e-01   -4.257577580589941e-02; -3.970736428614402e-02   -3.477239538572488e-02   +4.859361781595284e-02   -4.246072087138854e-03   +2.425157014065863e-02   +9.355218535399892e-02   +8.443553129316239e-02   -4.366962354220794e-02   +3.917753535366976e-02; +1.212909020621135e-02   -1.298264980323486e-01   -1.184618645822946e-01   -6.764816227575902e-02   -2.576992000738653e-02   -3.484860624506524e-02   +1.074070797740802e-01   +1.266422020336321e-01   -2.246315954607996e-03; -5.564907921906660e-02   +3.044572055558313e-02   -7.559398799736886e-02   -9.035038192326481e-02   -9.425611240302684e-02   -4.995128321730462e-02   -4.874961708020391e-02   +1.666695874617316e-02   +2.609169695038294e-03; +1.284151964346495e-02   +3.038442817776239e-02   +1.045448949268222e-02   +2.979205236511374e-02   +7.692836691031188e-02   -1.523500248841315e-02   +8.960356459449062e-02   -1.098609865721634e-02   -9.583638265249512e-03; -4.383380865351019e-02   +3.185967390230454e-02   -1.078040160502804e-01   +5.519862656675716e-02   +1.656309402086840e-01   -2.219544788376523e-02   +2.577375270745506e-02   +4.604311576428963e-02   +7.746972078448837e-04; -2.537036815197300e-02   -1.080382322321376e-02   +3.180445403549934e-02   -7.653813093326035e-02   +1.251717112551013e-01   +4.814349807288446e-02   -3.738990485878078e-02   +9.269072591794150e-02   +3.217920513377714e-03; -4.309909810883974e-02   +7.357401090895253e-02   -1.312970503469104e-01   -6.998421030887739e-03   +3.894786877593954e-02   +2.623345879285175e-02   +1.354249147691937e-01   +2.065990570666506e-02   -1.841976043117496e-02];
L2_L5_iAMPA_netcon = [+5.335780806038847e-04   -1.006607661197650e-01   +6.664773849952987e-02   -3.534110657343927e-02   -3.617705245895532e-04   -8.982433070008906e-02   +1.342573905037861e-01   -1.007279692865363e-01   +3.149857198282880e-04; +1.119441641960103e-02   +3.918135951731715e-02   -2.175766953627454e-02   +1.434443674780074e-02   -1.572862263838407e-02   +8.156088435305334e-03   +5.022388194701436e-04   +5.180475802465875e-02   +8.759846457134084e-03; -6.729247855160718e-02   -2.108983785275803e-02   -8.640442943616947e-02   +6.290793554966861e-02   -8.360934535489367e-02   -8.246215410139224e-03   +2.793734139038076e-02   +1.172672175250922e-02   +4.403588319526675e-02; -3.250760403914240e-02   +7.777292769494536e-02   +1.435002441327335e-03   -9.919099529868634e-02   +8.854357759596278e-02   +1.097561112727979e-01   -5.805741687636692e-02   +4.119446077314576e-02   -6.893915933205390e-02; +7.838694702982138e-02   -5.535370156442971e-03   +4.851830349629936e-02   -3.499535757393463e-02   +4.834704269677960e-02   -2.683353170755371e-02   -7.786936929112340e-02   +5.691612623455356e-02   +4.269208565496500e-02; -1.005237189082624e-02   -3.239680499091507e-02   +3.038841037882051e-02   -1.019343840470772e-01   -1.144234024683890e-02   -5.610882773396487e-02   +3.040042202855633e-02   +8.183210014616433e-03   +6.043748734143973e-03];
L5_L2_iGABA_netcon = [+1.146105474677781e-02   -2.648670898943980e-02   -1.330383652858603e-02   +5.886635356213685e-02   -1.528526823871097e-02   -2.953968494508668e-02; -2.022361160211318e-02   -1.213965939620350e-01   -8.039616702541859e-02   -1.044318992738002e-01   +1.800898009736397e-02   +3.709169148183954e-02; -2.001241917268682e-02   -2.557053067203004e-02   +3.281910718062057e-02   -4.913007168067417e-02   -3.275017874470641e-02   -3.518143791348097e-02; +9.419706701379624e-02   -4.866649656474745e-02   -2.065794291534570e-02   -4.275229200028217e-02   +3.357420214542424e-03   -5.954610783117176e-03; -4.106799546922850e-02   +3.654214683775864e-02   +1.248905003237643e-02   +7.379665139448298e-02   -4.236880777510014e-02   +1.569701342764075e-02; -8.676675426242333e-02   +1.741265339085136e-03   +4.916793441321174e-02   +1.005191076149181e-01   -2.285080099794971e-02   -7.257619723756027e-02; +4.727255790138003e-02   +1.610294634905067e-03   -1.323154254448246e-01   -3.917643401623552e-02   +2.795444409975121e-02   +8.810592767197893e-02; -9.325435251823748e-02   -3.378074504716413e-02   -1.691964723385126e-02   +1.235661123912979e-02   +1.037810899557059e-01   -8.030593003969203e-02; -4.369682660872198e-02   -7.819287377061872e-02   +1.164471462724376e-01   +7.730036448218223e-02   -7.903173589456243e-02   -7.780639306747458e-02];
L3_L2_iAMPA_netcon = [-1.135413835341334e-02   -5.989940806902252e-02   -5.044019766886525e-02   +1.160722506086039e-02   -1.982336412319931e-02   +3.329867349769421e-02; -2.065309622430732e-02   +1.009988053528359e-01   -8.246106922381107e-03   +7.497938901339897e-02   +5.897673174919889e-03   +3.458713901329797e-02; +1.018170491413891e-01   +1.585117335931938e-02   +2.300574182133195e-02   -1.106545564946355e-01   -4.527604218744700e-02   +4.639137991721580e-02; -6.002844595800353e-02   -5.696206430214472e-02   -3.184261548323052e-02   +2.839665944002111e-02   +5.556966256951189e-02   +3.803003649111658e-02; +3.193067090686139e-02   -6.472404945298633e-02   +1.122150819558033e-01   -5.351136038447785e-02   -7.403394067848605e-02   +2.188038511511115e-02; -2.316385347716932e-02   -5.136712141486821e-02   +9.190450784531221e-03   +1.409594572629248e-02   -1.148509398919195e-02   +5.938745106459486e-02; -4.607812562679674e-02   +2.807953780660601e-02   +4.971217246440880e-02   +1.233423170035299e-03   +8.183405893457775e-02   -1.072238548279859e-01; +6.497074159019878e-02   -3.367626038466944e-02   -1.141148706576199e-01   +6.129729981442674e-03   -1.012638909156774e-01   -2.262041328368316e-03; +4.005493793720513e-02   +9.898892578264094e-02   +8.627863195085664e-02   -3.645355797905801e-02   +4.934467627855765e-03   +8.198226958432215e-03];
L2_L3_iGABA_netcon = [-4.738938897156061e-02   +4.797317941207485e-02   +7.639228525181026e-02   +4.741857919849279e-02   -2.577301792804063e-02   -4.287317158865658e-02   +1.358649925348105e-01   +4.141448882126954e-02   +5.352111929312229e-02; +4.856774030815624e-02   -1.482936470226464e-03   +4.240586994507595e-02   +1.146893799741775e-01   +2.240942404556792e-02   -4.881063106925415e-03   +5.466861306799806e-03   +7.907505692682133e-03   -2.775201194760232e-02; +1.511757443630905e-02   -3.695439650088836e-02   -1.009217881921083e-01   -1.866440162353896e-02   +3.877824355918488e-02   +4.633919401076361e-02   -3.163314165105560e-02   +6.684912058622772e-03   +3.380404524726592e-02; +3.242643843038957e-02   +7.317754612359314e-03   +7.548143007435254e-02   +6.372458539300842e-02   +2.507644408133650e-02   +8.761894513848664e-02   +9.385047334638466e-02   +4.541188614707375e-02   +1.333899880993299e-01; +4.892920037614180e-02   +7.896983452634870e-02   -1.439138195356782e-03   -2.434206607941841e-02   -8.600636195423203e-02   -2.165341282129515e-02   -5.513295412699730e-03   +8.113421274637342e-02   +8.363681931852071e-02; +7.257170724576870e-02   -5.172265123143868e-02   +1.197606020102411e-02   +2.224897469556335e-02   -1.121549307343123e-01   -9.330721267959668e-02   -8.668366008876809e-02   -1.804500887243258e-02   -1.141478367120859e-01];
L1_L4_iGABA_netcon = [-2.035635129282419e-02   -7.112264783612544e-02   +9.177372897489193e-02   +2.084783170866109e-02   -4.610779218910392e-02   +2.655443715843504e-02   -2.809953472000511e-02   +5.435271569633001e-02   -1.105279615832314e-01; +1.106067052274424e-01   -5.652355321845617e-03   -2.330106877958309e-02   -6.000757842847716e-02   -4.744161079735185e-02   +5.447562650836797e-02   +6.101704760445553e-02   -8.859551394531009e-04   +8.195566545820865e-02; -3.978623297653672e-02   -6.807821663866176e-04   +2.149229938624661e-02   -6.347399187298750e-02   -5.006351703897885e-02   -3.961950087524568e-02   +1.386936324133319e-01   +7.308327184558136e-02   +1.669686886208989e-02; -3.804026171688196e-02   +7.853325802390463e-03   +3.984414827511791e-03   +2.515836811943275e-02   +1.365984272319386e-02   -6.439523352789790e-02   +1.123564989202420e-01   +8.073534628616807e-02   +9.162847138605565e-02; -1.529021976343801e-02   -1.400098984291495e-01   -5.041360885521715e-02   -1.425923546990382e-02   -7.595534735259955e-02   +4.539049757274657e-02   -1.894714418671168e-02   -9.207585819127340e-02   -1.851270081446405e-02; +1.080256067121226e-01   +1.072015319625893e-01   -6.623211213322556e-03   +5.761177999797781e-02   +5.176958827960240e-02   +9.518904463804613e-02   -1.271005291485293e-01   -9.510423964539062e-03   -1.362970154189455e-02; +3.809903448292977e-02   -2.269420418295487e-02   -1.166618438241224e-01   -1.043850849250707e-03   -1.036771289711360e-02   +2.363312755622057e-02   +9.615656698872623e-03   -1.568420229274027e-02   +4.918813141569605e-02; +9.726226794859903e-03   +1.000092943105744e-01   -9.809096373153917e-03   -4.415468524534310e-02   -8.217030877883430e-02   +6.443486094145051e-02   +6.445214632089928e-02   +9.256598922885998e-03   -5.930989547081353e-03; +5.526945189833644e-02   -5.397342211934559e-02   +6.855892863930335e-02   +2.251277152884076e-02   +4.537592782000643e-02   +1.000847293697515e-01   -6.518993242682931e-02   -1.221295309047002e-01   +1.286358744610586e-01; +5.058470870689721e-02   -7.141566137901433e-03   +3.803564657311098e-02   +2.391859245918622e-02   -1.493570912511771e-02   -2.859472766914902e-02   +5.750494736301473e-02   -1.713192709064552e-02   -4.220036076911009e-02; +3.254567922700253e-02   -5.035622571727721e-02   +1.463484196428448e-02   +4.385278896545845e-02   -3.721538694804340e-02   +9.149245492171747e-02   -3.056903819410427e-02   +1.757208831199346e-02   +1.409395255062603e-02; +2.806556282789818e-02   -2.400602244749588e-02   +6.596597125627301e-02   -8.997223514710730e-02   -4.144081197052515e-02   +1.031803221558487e-01   -1.990347315349888e-02   -9.828564237507670e-02   -8.925123485569772e-02];
L4_L1_iAMPA_netcon = [+3.362248293055748e-02   +1.862277869392577e-02   -2.298979331025677e-02   +1.890068034829826e-02   +6.908267032976573e-02   -6.045300808318362e-02   +7.876604736857294e-02   -1.131801563199858e-01   -5.362980506492124e-02   +8.452299814651293e-02   +8.702517500978847e-02   -6.253242120907586e-02; +1.003856276524543e-01   +7.264682611023410e-02   -6.460553271733606e-02   -2.682554798921163e-02   +7.079185538456229e-02   -1.195047981094010e-02   -8.021571376698369e-02   -3.562822798861642e-02   -5.333930413048158e-03   +3.716410509006203e-02   -1.280005985545151e-02   -1.148655980295656e-01; -1.515970357892740e-02   -3.229864781407760e-02   -1.064005662821723e-01   +2.683941642701335e-02   -5.469270281936715e-02   +6.675431528258363e-02   -9.993929618037098e-04   -5.377336613623739e-03   +5.094232008431705e-02   +4.822103284540080e-02   +2.527289901378202e-02   -1.086571579919250e-01; -2.061615126287876e-02   -4.896818016685531e-02   -2.263894185691403e-02   -2.047134823418619e-02   +7.924139536949386e-03   +2.447801479503373e-02   +1.084130269791628e-01   +6.384725270621984e-02   -3.701960430046748e-02   -1.095569383638310e-01   -2.356668055469516e-02   +2.188816744441072e-02; +2.093256464849007e-03   -3.483123425358171e-02   +3.590441366009466e-02   -2.756723294183859e-02   -8.445106165030770e-02   -3.589917454559580e-02   +4.911070795185823e-02   +1.792775855905966e-02   +8.840890412308795e-02   -1.007210693777116e-01   +3.673003348889204e-02   +5.493115120408540e-02; +1.224105496141197e-01   -4.814402052186629e-02   -9.812871489624078e-02   +4.817586891489197e-02   -8.162227277002668e-02   -7.273224647686127e-03   +5.776529007425309e-02   -2.024057151489736e-02   +3.333963150629309e-02   -3.531870867371333e-02   +7.348597069157014e-03   -2.314398860720623e-02; +8.237460268603008e-03   +6.257882512127913e-02   +7.777335364073629e-02   +2.515753848929362e-02   +2.626615579428705e-02   -9.110224972167427e-02   +1.299279623570208e-01   -4.623811825031356e-03   +6.876849597956126e-02   -7.326729134938410e-03   -6.769728741483599e-02   +8.748213661545341e-03; -4.306490994659031e-03   +4.510810173188991e-02   +1.114712075736879e-01   +4.847645569464708e-02   -9.674373973741178e-05   +1.057676567086314e-01   +7.228803473346559e-03   +1.232056573016268e-02   -7.684529178815194e-02   -7.265420763792821e-02   -5.023537400076785e-02   -2.026055938688303e-03; -1.087000710446943e-01   +3.734445799484302e-02   +1.687835107900465e-03   -5.961284710402057e-02   +2.589589472801949e-02   +1.356371659974638e-01   +5.483014708752201e-02   +5.174730256715455e-02   -1.414616214631918e-02   -1.283521354682621e-01   -5.897394938176449e-02   +1.061462976185762e-02];
L1_L3_iAMPA_netcon = [-6.513353570006254e-02   +1.123725602844046e-03   +5.625593149749733e-02   -2.258650876986079e-02   -2.207993912764331e-02   -7.387359425906349e-03   +8.385461975446795e-03   -2.353543365778247e-02   +8.483066052629083e-02; +5.888783875118676e-02   +7.843491777119796e-02   +7.888385576461207e-02   +3.608891469287232e-02   -1.258839843920502e-01   -4.488815125740404e-02   -3.542987187776427e-02   -2.205430333647181e-02   +1.003419990999359e-01; -3.456981444613197e-03   -1.156709730402351e-02   -4.845988034272330e-02   -1.911907188440078e-02   -6.273432425142646e-02   +2.284245828508178e-02   +4.428328787088484e-02   -1.441341416823695e-02   -6.032630400096321e-02; -3.102839707070669e-02   +6.392791876045867e-02   +1.179176907028213e-01   -6.064235514790717e-02   -1.112010946582251e-02   -6.680369904410940e-02   -8.747471988460818e-02   -6.597334704084867e-02   +1.192729609640689e-01; +1.193787645042998e-02   -1.317969154126658e-02   +7.021379255895490e-04   +1.142923610376763e-02   -8.641577866978022e-03   -3.162043867542130e-02   -3.164936710212037e-02   +3.716166481902183e-02   -9.427944767285642e-03; +1.132530879807043e-02   -7.307794566944747e-02   -9.843585365134359e-02   +9.029839804521284e-02   +7.231673941746446e-02   +2.514405424609554e-02   -3.893312093301862e-02   -2.002853010643365e-02   +1.046089220874186e-01];
L3_L1_iGABA_netcon = [+4.230984993295456e-02   -9.135545769626203e-03   -2.637357561798486e-02   -9.511983406135208e-02   -1.144608779569293e-01   +5.368731191407552e-02; -7.232942963453394e-02   -5.405817288147426e-02   +7.371786395883215e-02   -4.329118935685749e-02   -2.578897390321939e-02   +4.141560684391509e-02; +7.634472922677718e-02   +6.549098375285609e-02   +3.295983379901191e-02   +3.295407952646931e-02   -9.000704272755466e-03   -1.036706753514153e-02; +9.876183857347155e-02   +8.396996795129733e-02   -2.411660252253667e-02   -6.191228172504247e-03   -8.316419709191164e-02   -4.971659869820187e-02; -2.206401716585581e-02   +6.813692168204358e-03   -1.153877500758739e-01   +9.492329520017638e-02   -6.658850586228374e-02   +2.429201443540811e-02; -5.041370083955141e-02   -1.071584261837051e-01   -4.181598209771398e-03   +7.134579140890768e-02   -4.881992396117524e-02   +1.099138247258849e-01; +1.013498567393519e-01   +4.377700780684521e-03   +3.371748778039508e-02   -5.863694739820862e-02   +1.222236799635437e-01   -4.760822804829272e-04; +8.508020158636394e-02   -1.086881827572551e-01   -3.908731030285130e-02   +4.549022564026658e-02   -5.903753860667803e-02   +1.275763728823329e-01; +1.966107814903138e-02   +1.413855526965771e-01   +7.751747369142209e-02   -1.560281181344552e-02   +3.114545220884130e-02   +5.865702570190464e-02];
L5_Input1_iAMPA_netcon = [-5.421613859756225e-02   +9.913402563904636e-02   +5.591456530403935e-02   +2.293001057263022e-02   -5.075257202820129e-02   +8.944113063567968e-02];
L6_Input2_iAMPA_netcon = [+1.940136298895819e-02   -1.324059224583831e-02   -5.785921410940224e-02   -1.466435026504239e-02   +9.488968277276509e-02   +1.281728088921340e-02];
L5_L6_iAMPA_netcon = [-5.696272599299498e-02   +8.068991469584429e-02   +1.451884766017841e-02   +1.027996932021633e-02   +1.175769640410321e-02   +7.716220760539792e-02; +6.180247389600132e-02   -4.087446334610056e-02   +3.052103672226361e-02   -3.819844785534223e-02   +7.531450225079780e-02   +2.026522093929197e-02; -5.341554503800726e-02   +8.728605459044088e-02   -7.809965237192780e-02   +4.235013541867655e-02   -1.028402466952879e-01   +9.911531077427645e-03; -7.129472228156039e-03   -7.284866975787895e-03   -4.408829368403045e-02   -5.608677157419963e-02   +1.181960118153192e-01   -1.414152125724044e-02; -6.587508430425874e-02   -7.747179191869207e-02   +8.399381467687979e-02   -8.510290746272337e-02   -8.119173324039049e-02   +6.199682035313710e-02; -4.105907108010130e-02   +1.141314566816666e-02   -1.562210857327659e-02   +4.364660280816550e-02   -9.100301513371706e-02   -5.871254259318210e-02];
L4_L5_iGABA_netcon = [+2.949225210637914e-02   -8.013304251807163e-02   -9.275327026716673e-02   +5.108883120379482e-02   +9.107450884637844e-02   -8.001525859175556e-03   -2.264519047666232e-02   +7.652482079313163e-04   -1.132588662412152e-01   -1.129392770377912e-02   -2.293132971682961e-02   +1.206660954916002e-03; -8.510273616392622e-02   -1.105439704104540e-01   +5.642188983989557e-02   -5.660276592723196e-02   -8.515049164655441e-03   -1.278989117916614e-01   -1.322624175686231e-02   -1.374782123495412e-01   -4.888245022050567e-02   +4.778956559874866e-03   -1.245760811947359e-02   -6.317692088148347e-02; +5.190615114385180e-02   +3.987688753728335e-03   +2.678494440672836e-02   +1.201164807612934e-01   +2.182313976103905e-02   -8.251109938997869e-02   +8.853529285051141e-03   +1.176541271751199e-02   -6.547689881902242e-02   +5.830549851746695e-02   +3.305915775970798e-02   -3.513136625634667e-02; +5.828296598903111e-02   -5.099404577225435e-02   +8.785909300614161e-02   +2.980119605437422e-02   +9.769930016256866e-02   -4.569766858474564e-02   -5.169417275343443e-03   -9.525379388205729e-02   -1.664855588591881e-02   -1.133032275710065e-01   +6.807705947171665e-02   +2.232598657187522e-02; +1.164380288229775e-01   +3.867126669251123e-02   -2.040664961826903e-03   +1.528279146686047e-02   +4.716122041012263e-02   +9.320569263723187e-02   -5.381546985039320e-02   -4.043255133863700e-02   -1.780406152887037e-02   +2.235728864572303e-02   +2.498732143221764e-02   -1.472192416330729e-02; -3.513484404478867e-02   -2.251118835692204e-02   +5.567580193507501e-02   -3.578997680056834e-02   -4.587891577059520e-03   +4.535383775146758e-02   +6.548768295904191e-02   -8.591377990239066e-02   +1.135014270234585e-01   +2.421821399852567e-02   +9.609167190339991e-02   +6.631064450999521e-02];
L6_L4_iAMPA_netcon = [+2.603935082016708e-02   +4.564548060163939e-02   +5.049640866727046e-02   -6.188877793939362e-02   -8.263066140253558e-02   -3.854088534646548e-02; -4.443131699036244e-02   +2.007045641445566e-02   +2.080138747798208e-02   +1.018174335452974e-01   +5.131804298892852e-03   +1.230389758344797e-01; +4.214475149767286e-02   -3.518665773702701e-02   -3.370942661221489e-02   -4.144465612534814e-03   +2.290401040190207e-02   +5.718206074170877e-02; +9.319280975523675e-03   +9.744529387728254e-02   -5.117222210891446e-02   +5.894722532108168e-02   -4.138371356127314e-02   +6.468480835225944e-02; +4.081720597858136e-03   -1.506005464706880e-02   -1.136837473187155e-01   +1.118455951947166e-01   +5.573419350635554e-02   +3.559278583737931e-02; +9.969891352957017e-02   -7.508466125300028e-02   -3.699003347595707e-02   +3.384942706390320e-02   -1.012466696896168e-01   -6.072574972870264e-02; -3.770028936090600e-02   +2.167333208733358e-02   +1.201810205093154e-02   -9.490383528491377e-02   -1.077535376203308e-01   +4.044137480285655e-02; +1.692103574602825e-02   +8.509334472112298e-02   -1.009549324326832e-01   +5.992040059423022e-03   +4.155346232159108e-02   +7.429918356236265e-02; -5.100594728324800e-02   +1.229250630903348e-01   +3.582528731060979e-02   +3.151369903497030e-02   -8.203656892206200e-02   -4.380181732697455e-02; +5.264998131502722e-03   +1.085466537917971e-01   -6.699317490315096e-02   -4.823259910626081e-02   +2.817721168259045e-02   +3.039391689584856e-02; -8.556693229019174e-02   +4.424444566209923e-02   +7.029027060423498e-02   +1.989135017948193e-02   +1.216888158047546e-01   +5.554385244608016e-02; -9.870918940967882e-02   +5.299754398839785e-02   -4.326362204031824e-02   +1.362574475780657e-02   +2.297039610555993e-02   +9.479534395014534e-02];
L5_L4_iAMPA_netcon = [-1.206871013755268e-01   +3.856379515159144e-02   +6.921176494909556e-02   +9.467485623844597e-02   +7.539722756929937e-02   +8.334735105082793e-03; +2.442303653636773e-02   -7.110334078596904e-02   +7.214280968946835e-02   -4.773187450256692e-02   +3.592010937239082e-04   +3.346765662671801e-02; -9.658673294908381e-02   -3.372587806863025e-03   -2.459071938835585e-02   -7.682590279835792e-02   +7.913442493740810e-03   +2.595306875286559e-02; -1.251762901529722e-01   +2.778880961642733e-02   +3.969202615142988e-02   -4.457162234512060e-02   -1.255022496321354e-02   +7.920436874574951e-02; -4.840102672800919e-02   +3.434223270323500e-03   -1.075580259231258e-01   -3.139213344920054e-02   -1.516645676366813e-02   +2.308376116407771e-02; -1.409972851154462e-02   -5.521703538041001e-02   +4.776428376948992e-02   -1.371989461282881e-01   -6.711016214323745e-02   -5.396269845299993e-02; -2.919334511852460e-03   -3.131391116106993e-02   +3.240700132571400e-02   +1.016705971188710e-01   -9.170244298937081e-05   +9.246782252018396e-03; +9.961596790482732e-02   -5.093680415913995e-02   -1.000725654892607e-01   +4.511135560586414e-03   -2.871409430782332e-02   +8.016675196316085e-02; +1.869239513704348e-02   -5.573251411243924e-02   -3.150355966146522e-02   -6.338023284717956e-02   -4.957478682810394e-02   +2.007043971423474e-02; -1.129712920162055e-01   -6.472324197247495e-02   -1.298786680968436e-02   -6.118797284840573e-03   +6.675013091603361e-02   +3.939161372393205e-02; -3.862133743833739e-02   +6.933123675236948e-02   -1.914915158868902e-02   +8.322760810085018e-02   +1.271532257907942e-02   +2.868789153665655e-02; +1.098903730807679e-01   +3.451982113563185e-02   -3.562064430809401e-02   +6.374815354442560e-02   +1.165324717189519e-01   +6.181790953650704e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
