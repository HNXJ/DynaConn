function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.612864686202035e-02   -7.253938764319123e-02   -6.023026410423358e-02   -2.831498692271291e-03   +8.784548164157045e-02   +5.806711926141070e-02   -1.311739998897488e-01   -8.715190147281278e-02   -8.699077650689896e-02; -6.448743453885068e-03   +1.583663481678962e-02   -2.638627070013265e-02   -7.949015849069091e-02   -1.113720283456564e-02   -1.328811458622729e-03   -5.775347638260393e-03   +6.416922279167941e-02   -2.271916342141536e-02; +1.235024991387995e-01   -4.904275802114069e-02   -8.023025719201357e-02   -1.498801072091960e-02   -1.214116157887116e-01   +3.302101387086152e-02   +5.547623399881597e-02   -7.592026685496661e-03   -3.044587168899704e-02; -5.116391109576242e-02   +1.059879648537683e-01   +3.187246599924259e-02   -4.271770071570163e-02   +3.874578623379252e-02   +8.663407799580347e-02   -5.983457890291204e-02   -1.142228895110418e-04   -8.127918223272156e-02; -3.683217671605702e-02   -6.931877510591646e-02   +5.599860982102016e-02   -6.217886583207025e-02   -4.386756330908576e-02   -8.503017812561170e-02   +1.304635003502627e-01   -1.887543190145047e-02   +4.237086247751367e-02; +4.805232732523581e-02   -6.190192286288254e-02   -1.383483975785532e-01   -1.432933464880515e-01   +7.357466418632552e-03   -6.895106268014276e-02   +9.932628491959455e-02   -3.648630176683592e-02   +5.319547422608974e-02; +8.096109895979663e-03   -4.852470010038979e-02   -1.135717724752917e-01   +1.362543325805574e-01   -8.202288871659565e-02   +5.732256886907169e-02   +6.697405553085051e-02   +9.322386367695752e-02   +1.140431589745472e-01; -2.645636979917488e-02   -6.137528514045636e-03   -1.279777087777809e-01   -2.924563007113200e-03   +1.187151722003050e-02   -6.565991642432562e-02   -3.778453584170832e-02   +9.331512024110561e-02   +3.087740018856621e-02; +5.715512069610009e-02   -1.210838829769069e-01   +1.165217788974721e-01   -1.364183381907534e-02   +1.031201532014793e-01   -5.810067813695596e-02   +7.305857356124046e-03   -1.179673049830672e-01   +1.543586649330873e-03];
L1_L2_iAMPA_netcon = [+6.285182881044987e-02   +1.607508788067004e-02   -4.296332780024803e-02   -1.096895082218597e-01   -7.712413564198002e-02   -4.895973941423408e-02   +4.664710515739576e-02   -5.252498282822447e-02   +8.795517317018571e-02; +5.901473031026435e-02   +3.116885126795504e-03   -1.014293844868898e-01   -1.349692728488197e-02   -1.075821290834449e-01   -6.460085860516494e-02   -4.052541594549249e-02   -7.431935779241375e-02   +6.263077026841446e-02; -6.860698011961502e-02   +7.579290981826553e-02   -2.191779039625714e-02   -1.227615571352621e-01   +7.854255994820333e-02   +1.105410577755753e-01   +7.912165291609229e-02   +3.628427122643903e-02   -9.683997212458788e-02; -3.834040714754284e-02   -1.441199536781596e-01   -8.590617247508014e-02   +6.206722246313074e-02   -1.407948092144157e-01   +7.986307744364794e-02   +4.336170826454128e-02   +6.990418742912072e-02   -2.238710644620829e-02; +7.281037282040254e-02   -9.618849378000019e-02   +4.793876999212141e-02   +6.434853120412067e-03   +6.823270635300058e-03   -8.804968648652492e-02   -6.219297995684076e-02   +8.887866866893268e-02   +4.919157990397401e-02; +1.908877206658306e-02   +7.782051959646130e-02   +1.549079920889197e-01   +1.678492618515853e-02   +1.527921190914396e-01   +1.880909905618957e-02   +3.712012697703476e-03   -6.122024641411124e-02   -2.951174583341798e-02; -6.649261617018957e-03   -4.292492839502877e-02   +4.179111177464401e-02   +4.549622778236319e-02   +3.593862439936632e-03   -1.258707039301090e-01   -8.151046726147111e-02   +4.716287956109621e-02   +2.174288418523146e-02; +1.217874652269442e-01   -7.840251765463112e-02   +1.453081080284470e-01   -1.177977498674248e-02   +1.351518039695375e-01   +2.262011008413939e-02   +6.901347220847869e-02   +1.954032395727954e-01   -1.287916065871625e-01; -8.285420784421506e-02   -7.870656732386636e-02   -1.377100115494156e-01   -3.369269629987080e-02   +1.020938676758633e-01   +3.372744678196326e-02   +1.705088516892957e-02   -8.967403782417052e-02   -1.497913042607840e-01];
L2_L5_iAMPA_netcon = [+1.213904009034978e-01   -9.386976399819853e-02   -9.625469827873304e-02   +2.625070823877951e-02   +1.522249769074467e-01   -1.256796979425293e-01   +2.959271564599464e-02   -6.031808101468374e-02   +3.775280822864295e-02; +2.998160233975483e-02   +6.493129152332146e-02   +5.627492552778843e-02   +1.008229246480057e-01   -6.404348333717252e-02   -2.799513750714072e-02   +1.415724387566720e-02   -7.823756285392387e-02   +8.108699230163535e-02; +5.308895338965870e-03   -3.144100063181388e-03   +3.947319553364442e-02   +1.880687006290966e-01   -7.166545743858288e-02   +6.072614968992487e-02   +1.183925955072499e-02   +1.142683193163648e-02   -4.793969557931468e-02; -1.496386982409119e-01   +1.369997488003014e-01   -5.102682038559472e-04   -1.993467935180195e-01   +1.550565126960174e-01   +1.244224528273460e-01   -9.862168329396373e-02   +1.232600739023858e-01   +7.375599929756901e-02; +1.291792394694680e-01   -7.750388917449633e-02   -3.550977656565020e-02   -4.622295532686241e-02   +8.454025709647098e-02   +1.779991472701241e-02   -1.045252063428209e-02   +1.078585812780089e-01   -5.607134347257013e-02; +5.546159604398805e-03   -1.517684016583647e-01   +1.211896236561145e-01   -1.112695250366523e-01   +1.635866497998864e-02   -1.153881320997922e-01   -3.108676922830526e-02   +4.877681463376946e-02   +1.303069633518983e-01];
L5_L2_iGABA_netcon = [+8.174772358245999e-02   +2.153544656139380e-02   +1.702032188933365e-02   +7.231883733149430e-02   +3.628474002061646e-02   -2.510344206042675e-02; -6.305965406189275e-02   -1.582719037209037e-01   -1.538432821061987e-01   -1.354087554387364e-01   +1.586381346609135e-02   -6.917809402224817e-02; -1.053761812588459e-01   -3.336208158931722e-03   -1.228331662194596e-02   -6.451292281432720e-02   +7.322014932917607e-02   +1.046598955198403e-01; +1.373428070691249e-01   -1.210630905290475e-01   +2.122505807541018e-02   -3.287881851731199e-02   +4.541126479620157e-02   -1.997055372293627e-02; -2.474204029557061e-02   -9.544945324380801e-02   +7.082314735294534e-02   -3.313295003639301e-02   -8.311969832884943e-02   +7.696706636076422e-02; -1.359243236433432e-01   +1.027676678997978e-01   +4.604867573063006e-02   +1.138340956750936e-01   +6.166421711238457e-02   +6.445090809075056e-02; -8.878073690683834e-02   -1.071551468644677e-01   -6.402017583732650e-02   +1.010256716293496e-02   +6.378994882764024e-03   +1.096381900240322e-01; -1.213907156862783e-01   -1.231045560003767e-01   -9.552970664573468e-02   -4.987780517183903e-02   -1.662963936844272e-02   -4.431064608347128e-03; -1.257503517634080e-01   -3.338334652642736e-02   +2.129198370102998e-01   -1.467474853618922e-02   -1.879372490305712e-01   -3.729264540853482e-02];
L3_L2_iAMPA_netcon = [-1.592758927376298e-02   -8.473192389578851e-02   -8.503170911505140e-03   -7.867172019340891e-02   +7.707318888612240e-02   -4.998005671228239e-02; -6.863214792846323e-02   -3.196862523833968e-02   -3.587146001714300e-02   +2.060144460570204e-02   +3.597182155916982e-02   -1.297578483204007e-01; +1.296961623636512e-01   -3.044248174982791e-02   -5.393118961562249e-02   -1.599991290740856e-02   -4.268045584989247e-02   +6.446656406892305e-02; -2.019560909455335e-02   +3.572532985018438e-02   +4.342338713854318e-02   +8.074261163554275e-02   -3.017896115351609e-02   +1.084855078151372e-01; -9.757259057808793e-02   -1.999984981489090e-01   +1.948659333718508e-01   -1.082242768534227e-01   -5.663997201422644e-02   +3.575542695139454e-04; -5.126644768455789e-02   -8.596096642808568e-02   -1.265479185243673e-01   +7.576374766786138e-02   +1.429017745455038e-01   +9.805402440578620e-03; +5.056837840339601e-02   -8.289356862761364e-02   +5.671432969704410e-02   +2.988936104302108e-02   +1.342680609591194e-01   -1.362750092127678e-01; +6.161105349767004e-02   +4.573009186253581e-02   +5.581656881585436e-02   +3.310807452758633e-03   -1.712574795680913e-01   -1.150375730336956e-01; -3.079005186647522e-02   +1.036890820861780e-01   +1.089454215322505e-01   +1.072797654159146e-01   +8.771508629145619e-02   -3.102521543644773e-02];
L2_L3_iGABA_netcon = [-9.587513269044312e-02   -5.570323664432978e-02   +4.197616757171887e-02   -5.705823729630553e-02   -1.040893174715833e-01   -2.741375271370464e-02   +6.296851162798096e-02   +5.316239731475892e-02   -4.168927010326411e-02; +8.977297219915917e-02   +6.901126507072355e-02   +1.401533684648453e-01   +1.491410350729787e-01   -5.715610904388565e-02   -4.539680595470948e-03   +9.165269452839137e-02   +7.743063882696785e-02   -2.893315317588341e-02; -7.060762190646221e-02   -9.442138822912505e-02   -7.898574318190067e-02   +9.654474077731379e-02   +3.327896581341890e-02   -2.531149895509677e-04   -3.622375124903152e-02   +1.001745169205538e-02   +8.188170285003864e-02; -2.322940039559356e-02   +7.611248484222514e-02   -9.062065252157515e-03   +8.974360801974687e-02   +7.633155533634020e-02   +6.609180107787105e-02   +4.031082034576638e-02   +1.395960587522121e-01   +1.818215170669947e-01; -4.625352807832660e-02   +8.910704902293619e-02   +2.249402652224611e-02   -1.118340941125963e-01   -5.281151481171553e-02   -5.412436422524210e-02   -1.513453900312415e-01   -4.215100346501670e-02   +1.355358774517075e-01; +1.328849994397757e-01   +9.475276758630950e-02   -4.205050222389820e-02   -5.684968888129081e-02   -2.025541134959679e-01   +4.221686634646764e-03   -1.573710786390227e-02   +7.692466601799567e-03   -5.150274165424291e-02];
L1_L4_iGABA_netcon = [-2.321596243880820e-02   -1.601169125588255e-01   +1.457426614163605e-01   -2.303412793589328e-02   -1.148702121955332e-01   -5.805914574546239e-02   +8.051961753916781e-02   +7.670859896965049e-02   -1.464136290904169e-01; +2.331927106145310e-01   +3.735414539094988e-02   -1.334878896439328e-01   -9.236904984426103e-02   -9.700583166468654e-02   +2.162597704006570e-02   +7.524923607543875e-02   -5.603978838609676e-02   +4.497101513775359e-03; +6.549572845496662e-04   -1.285976963635093e-01   +1.134805344730404e-01   +4.887770755856232e-02   +9.724479792400478e-02   +6.371314430726072e-02   +1.776816920440114e-01   -5.191027000578041e-02   -6.110410603145704e-02; -1.019893914319219e-01   -3.300857776679805e-02   +3.640075639203840e-02   +5.538871521013247e-03   +1.330871636260557e-02   -2.151228253401186e-02   +1.124737442199687e-01   -2.522787282042067e-02   +1.705760665576014e-01; +4.709380075620711e-02   -1.182023612520258e-01   +8.096556557674861e-02   -1.282359611594141e-01   -4.776904654337101e-02   +1.050192391128246e-01   +3.876753071973875e-02   -1.523919439829386e-01   -2.839689632622610e-02; +1.040065935666936e-01   +5.225397064879251e-02   +1.509584592273682e-01   -6.065246322913165e-02   +3.989386723776240e-02   +1.797186152894316e-01   -4.028163312828512e-02   -7.155357286842252e-03   +1.336640441469440e-01; +5.058578243672125e-02   -6.551768952058845e-02   -1.451773776243153e-01   -9.097877436524082e-02   -4.587898097576468e-03   +1.042706089526919e-01   -1.136002990728121e-01   -2.743035834557347e-02   +1.559312611703893e-01; +1.519527124287425e-01   +1.055913169148236e-01   -1.148149171214305e-01   -2.097886203187710e-04   -1.270048599462140e-01   +1.022683970005429e-01   +1.112229382060407e-01   +8.396760668633521e-02   -1.162205536000439e-01; -7.470136393141935e-02   -1.225478013256410e-01   +2.759206860326562e-02   +8.374611894176237e-02   -9.335585301332790e-02   +5.781446772837158e-02   -6.280380309664646e-02   -5.540485874818061e-02   +7.048790234407479e-02; -1.565314925626244e-02   -4.186254815732730e-02   +1.159252838234768e-01   -9.544734462948817e-03   -8.358709070484857e-02   -5.202702473228069e-02   +9.111303696064016e-02   +1.406367300355146e-01   -2.726972343109853e-02; +7.765259605930380e-02   -7.436909612348232e-02   +1.003151137625531e-01   +1.436137134109648e-01   +5.014537731260229e-02   +7.044858504882112e-02   -5.747411950358145e-02   +8.461913857430539e-02   -5.112771915252937e-02; +1.213765636890812e-01   -7.583327161941254e-02   -6.870364047608156e-02   +6.909602541121464e-03   -1.615500121065117e-01   +2.015423998157185e-01   +7.274894282757093e-03   +3.833726490031423e-02   -1.331148228261780e-01];
L4_L1_iAMPA_netcon = [+8.089424793722799e-02   +7.182895790446406e-02   +7.391626425544594e-03   -5.578344017512755e-02   +1.644886492776859e-01   -3.139422572481364e-02   +1.075288552517691e-01   -3.684912009989067e-02   +6.425891727706644e-03   -1.408676513924957e-02   +5.571455705788922e-02   +1.456539343879652e-02; +1.409979619079838e-01   +1.207145084087779e-01   -5.674190548107899e-02   +2.896038821151228e-02   +4.017097667488287e-02   +6.270894544045968e-02   -1.531679326807831e-01   +1.098285567090528e-01   -1.442403392185057e-01   +4.909706674691203e-02   +2.809435493606187e-02   -6.990766125238003e-03; +2.896618219120736e-02   +1.890328850257992e-02   -2.179213810549092e-02   -3.312848065546310e-02   -9.683272090424444e-02   +1.574455332784811e-01   -5.807364297111806e-02   -7.974153219487617e-02   +7.344875826437525e-02   +3.789921044582791e-02   +5.646744553396093e-02   -7.764636526660716e-02; -4.304481463456633e-02   -1.402752171047574e-01   -1.377949203408696e-03   +1.533022121333500e-02   -1.240646934001215e-01   -4.667791182959408e-02   -7.471764804583815e-02   -6.161384527480619e-02   +8.629619603765182e-02   -1.385741989771357e-01   -1.167320516487558e-01   -1.076411030590582e-02; +1.029980309097243e-01   +4.977478459297213e-02   +1.071619121193678e-01   +5.414155768155744e-03   +3.669247285966209e-02   +7.951785019408918e-03   +5.318401309199315e-02   -1.404086061762404e-01   +6.018482948265881e-03   -3.060548719126693e-02   +2.650001174483426e-02   +1.644279261399848e-01; +4.058160010201653e-02   -1.082267005074471e-01   +3.400725593917996e-02   +1.358782789335479e-01   -7.626871438488046e-02   +4.078990777882686e-02   -3.018052040693376e-03   +1.137783862767370e-01   +3.677288173759866e-02   +9.842036244190479e-02   +8.745299480580003e-02   +8.891552118263818e-02; -3.120087087997169e-02   -8.603924595711585e-02   +2.244065413009897e-02   -3.586634898989550e-02   +2.437008076088075e-02   -8.017017875250897e-02   +1.218928646683720e-01   -8.017381384142380e-02   -2.837573329082240e-02   +7.105203195996636e-02   -1.697104729449586e-01   +7.094449940965235e-02; -5.645217930025168e-02   +1.399743974173604e-01   +4.602686856842515e-02   -1.193888649865386e-01   +2.914120902892555e-03   +1.496350658375106e-01   +5.685368719803476e-02   -7.533382956891408e-03   -1.906578138065124e-01   -1.163944996499804e-01   +5.673924803625376e-02   +1.213327669501049e-01; -6.728916025172291e-02   -6.062277998208476e-03   -7.627314911274638e-02   -5.989497244819631e-02   -1.264587504675814e-01   +1.301999614121382e-01   -9.604624359965684e-02   -7.464091168979423e-02   -2.430231894456625e-02   -3.508668603837543e-02   +2.075656226364657e-02   +6.822852603345711e-03];
L1_L3_iAMPA_netcon = [-1.023580722495227e-01   -7.639808792214187e-02   -3.867021572211863e-02   +4.403114471652275e-02   -1.104517054821317e-01   -9.083278114102709e-02   -7.831760029707983e-02   +1.326171400920245e-02   -4.019228677241348e-02; +1.045921170682011e-01   -8.281539171065638e-03   +1.550303636984198e-01   +1.691994139583826e-01   -1.745485511230025e-01   -2.212392962550681e-02   +7.697309979683049e-02   -4.984922936709510e-02   +1.892212034818091e-01; -6.968437555659306e-02   +1.054331395427000e-01   -4.633513153772185e-02   -1.181727655709190e-01   +5.335791669999234e-02   +8.384633254878937e-02   -5.086639301941431e-02   +1.006881299196052e-02   -1.168930293491363e-01; -9.902182929962228e-02   -3.407775119025429e-02   -2.458284957864362e-04   -1.031775550155972e-01   -1.061476196352397e-01   -1.476195298309715e-01   -4.958430601757373e-02   -5.867287395630975e-02   -2.706255472053753e-02; -2.453077467738685e-02   -3.028917418530098e-02   +8.404243495130646e-02   +7.109082282972212e-02   +7.829604795141146e-02   +1.097709094078171e-02   -5.463802103603013e-02   +4.178878792278417e-02   -2.037947188247661e-02; +4.126609655065164e-02   -1.501312062538664e-01   -2.579955036965009e-03   -6.482141096035525e-02   +1.162958495519216e-01   +1.280147860442071e-01   -7.628859742272065e-02   +4.079352764771618e-02   +2.463333735081880e-02];
L3_L1_iGABA_netcon = [-8.552886218804169e-02   +4.406975819766568e-02   -4.932298854137636e-02   -2.129533376995605e-01   -1.421825163300800e-01   +5.356831252337019e-02; +4.059766660466958e-02   +4.117838468972318e-03   -1.031061551237654e-01   -2.590601939826846e-03   -3.780864164412469e-02   +7.459547133050379e-02; -7.955653036717525e-02   -4.349786748266950e-02   +2.703202674791105e-02   +4.564276370480320e-02   -3.951609751887554e-02   +7.683080536399201e-02; +2.697577881927933e-02   +4.214289511012735e-03   -4.962320803936951e-02   +1.824206742415615e-02   -1.809176609267480e-02   -1.017008653025707e-01; +3.856324964882379e-02   -4.443424935219861e-02   -1.273178539284700e-01   -5.288766281964700e-02   -9.396382217463885e-02   -4.416463226708547e-02; -1.141045692423038e-01   -1.579665832363327e-01   -3.604688046123976e-02   +1.516400012506846e-02   -1.343663763364989e-01   +3.118293550868864e-02; +1.448339900048451e-01   -1.169274309119991e-01   -8.456416401486044e-03   +6.703066616042194e-03   +1.314277853427409e-01   +7.090507665074816e-02; -5.581636552163509e-02   +2.618054130035151e-03   +6.959167003649373e-02   +2.780193528258738e-02   +5.548525923955785e-05   +7.661026650329862e-02; -6.984725873024527e-03   -5.351018854774963e-02   +1.568168391097369e-01   +3.117951041414121e-02   -1.285295265925542e-02   +5.397918505697646e-02];
L5_Input1_iAMPA_netcon = [+7.203989629496022e-02   +7.254325378484987e-02   +8.406426284761198e-02   +9.339338012869380e-02   +6.568964635911628e-02   +3.093059055684403e-02];
L6_Input2_iAMPA_netcon = [-7.320752488724369e-02   -2.379777137819956e-02   -1.729854847887100e-02   -1.940689525935484e-02   +9.428157020601682e-02   +7.703999402331295e-02];
L5_L6_iAMPA_netcon = [-2.831528699290493e-02   +5.903997032609296e-02   +1.885331505867130e-02   -4.618329383243145e-02   -2.384023032914290e-02   -3.149966036478303e-02; -1.136574728609860e-01   -7.257520923274041e-02   -3.022524492673544e-02   -5.134268916660475e-02   +1.710002391781623e-01   +5.910691580267831e-02; -1.177434806474369e-01   -3.073016705069237e-03   +1.640091184480037e-02   -2.538379735330262e-02   -1.215759051041795e-01   +7.849138580103993e-02; +6.588475523320603e-02   +2.280532734060162e-02   -5.885386139962298e-03   +6.756566495911585e-03   +1.208299316136840e-01   +1.082905497482717e-01; +1.885402841255046e-02   -2.289419773510120e-02   -6.562756884235407e-02   -6.738893451460452e-02   -1.266957251361485e-02   +1.133112028092345e-01; -1.007206480165243e-01   +5.551426385496128e-02   -4.899065396882537e-03   +1.276575256258378e-03   -1.947353337711586e-01   -6.481312470956153e-02];
L4_L5_iGABA_netcon = [-5.547082205712477e-02   +6.603731298167329e-02   -2.080305074540549e-01   +1.445893747614108e-01   -3.937036192632260e-03   -1.198572572633164e-01   -8.054398636718405e-02   +9.743880863333269e-02   +2.838473313727640e-02   -9.651764794478251e-02   -4.262594455697502e-02   +6.160673685518345e-03; -1.677227050726958e-01   +4.210362774883601e-02   -8.140274134427766e-02   -1.395207139018107e-01   -6.962715763777474e-02   -5.068430544666012e-04   -1.482404744135689e-01   -5.657159440383408e-02   -1.545299537164815e-01   -3.489180722665486e-02   +3.685450107717481e-02   -6.832811168044923e-03; +5.353249607167919e-03   -9.607164129474105e-02   -7.285787792868491e-02   +3.766575615647428e-02   +5.372215867468979e-02   -1.045160411444140e-01   -7.732014791289912e-02   +2.943592735717185e-02   -2.037041303926112e-02   +1.214765625122844e-01   -2.566759046877930e-02   -4.893603776388628e-02; +1.515893356676643e-01   -2.641111768207402e-03   +1.859868530031489e-01   +9.598657680436995e-02   +1.180287524884979e-01   +5.736462595834876e-02   -3.567741469598130e-02   -1.490479426582882e-01   +2.073443636711298e-02   -1.395201595471816e-01   -6.059982910455720e-02   -1.052566426058885e-01; +1.913403150001401e-01   +8.788181228646139e-03   -1.128148452067097e-01   +6.055846756696205e-02   +1.119850796436486e-01   +1.303135864275770e-01   +1.102015879472361e-02   -2.636298305144852e-02   +2.460487109355301e-02   -5.876577339198868e-02   +8.092346537077395e-02   -2.495895824611128e-02; +7.332536622678029e-02   -1.774781148404724e-02   -1.081907904249081e-01   +4.646785531677478e-02   -5.543964054058623e-02   +7.211450877611125e-02   +1.129712641545054e-01   -1.465574902704498e-01   +4.943055534951021e-02   +5.779959649399199e-02   +1.463565914660843e-01   -1.246619169098783e-02];
L6_L4_iAMPA_netcon = [-1.914244628748381e-02   +2.128816753644748e-02   -6.812966804783399e-02   -1.832212604842870e-01   +4.377363689883321e-02   +8.730549632595365e-02; -5.682051366351335e-02   +4.195572951655421e-02   +9.321372282701851e-02   +1.618223721371241e-02   -8.124913118266566e-02   +7.460347278947893e-02; +1.432864322145522e-01   -3.049988018183350e-02   -8.088657269808040e-02   -2.458485836684098e-02   +1.502579998568554e-01   +1.000307035292656e-01; -9.729171822949775e-02   -3.508407200861978e-03   -1.249995124485019e-01   +7.139560587468015e-02   -6.382645057324533e-02   +1.677086441005307e-01; +1.153321153609726e-01   +1.338445231306121e-01   +5.706890305636873e-03   +4.314682835633923e-02   +6.155469995645992e-02   +3.200101869688876e-02; -5.934952036525698e-02   -9.636658239143467e-02   -4.660305615963474e-02   +1.279558517912354e-01   -1.666957872140182e-01   +1.272938967197344e-02; -2.562351166679977e-02   -6.711931189589324e-02   +5.933772438357003e-02   +7.343518684413933e-02   -4.473033804307189e-02   +6.028867035841039e-02; -7.726451688808156e-02   +1.449003659484128e-01   -4.697743453243271e-02   -1.233258867682723e-01   +1.519739765222441e-01   +1.832503367162783e-01; -4.542513065115754e-02   +4.789602110647036e-02   -3.039706703230734e-02   +1.098396050816119e-01   +4.711770524720382e-03   -6.195173149752305e-02; +4.433382569544002e-02   -4.995413104111428e-02   +2.558156694658147e-02   +5.386360032057116e-02   +9.049486882643684e-02   +5.951357491127915e-02; -1.086464114302108e-01   +9.377527850620400e-02   -2.415389080860383e-02   -4.088685002133886e-02   +1.891991323941486e-01   -1.098443922992860e-02; -1.818329641168222e-02   -5.918176573855594e-02   -9.130971488149224e-02   -1.448027479248562e-03   +1.424261315871507e-01   +4.230247259086052e-02];
L5_L4_iAMPA_netcon = [-2.692382650581287e-02   -1.330566305711840e-02   +3.258513935114296e-03   -2.296273602263214e-02   -7.176610780077133e-02   -1.504965698062288e-02; -1.989266904943614e-02   -1.870020653087128e-02   -1.916890136367709e-02   -1.247926107063857e-02   +5.159246564463787e-02   +5.961996128645650e-03; -7.960866755302778e-02   -2.542417424796526e-02   +2.606953753071594e-02   +9.682172786862918e-02   +5.636956308407176e-02   +6.909785277282587e-02; -1.423828995518076e-01   +8.582899750162991e-02   +1.178477465906365e-01   -3.177048606009887e-02   +7.298081688517236e-02   +7.464929012576685e-02; +9.299343989725917e-02   +1.421065474920763e-01   -6.866193774439970e-02   -2.416874264978106e-02   +1.281471935227021e-02   +4.674287175556911e-03; -6.951389811271905e-02   -1.215746473535378e-01   +2.523201179631472e-02   -9.006683690224479e-02   -1.250197573956422e-01   -3.927803990732267e-02; +7.948618343270283e-02   +9.131235915468511e-02   +5.323690624831334e-02   +1.397962166353557e-01   +1.321857643668217e-02   -1.221255656319453e-01; +2.635480757102768e-02   -1.192742510241644e-01   -1.542399674212457e-01   -8.424177902717449e-02   +5.197709575064065e-02   +4.737649052968972e-02; -6.074828642712131e-02   -1.096211607125613e-01   +1.178471559974706e-02   +7.031675406737928e-02   +8.157617320600201e-02   -1.728836043059776e-02; +1.035511258354041e-02   +1.135054395921945e-01   +2.272983106764837e-02   -5.140483981961733e-02   -6.910475173993073e-02   +1.273157597360982e-01; -1.949102258973039e-02   +5.636122724123296e-02   +1.259690843049379e-01   +5.280105412855949e-03   -8.107724780415698e-02   -6.148893239555879e-03; +1.240267941656944e-01   +4.888904354500315e-02   -6.000927748362000e-02   -5.098911535497459e-02   +1.786431417564776e-01   +1.293736570811116e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
