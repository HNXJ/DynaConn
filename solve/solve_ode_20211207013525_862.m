function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+7.455687419694347e-01   +2.458277476557901e-01   +2.836689073124414e-02   +4.548180157633784e-01   +5.785930142742943e-01   +7.527633976703451e-01   +2.444444574634041e-01   +3.944016759183188e-01   +4.339919551519072e-02; +2.569834369343561e-01   +3.374734059898155e-01   +6.345450154575192e-01   +3.269821244691197e-01   +7.795446857708125e-01   +3.808085506457917e-02   +2.399480024949057e-01   +5.555032203265620e-02   +3.786183347294164e-01; +4.515789491348816e-02   +4.693170995493223e-01   +2.302835076058308e-01   +6.748652851177428e-01   +9.563910536077903e-02   +4.225161701151088e-01   +4.649804394992002e-01   +5.392988131517001e-01   +9.168320891954745e-02; +2.686315100396808e-01   +1.272896025823951e-01   +5.089015725214661e-02   +5.790978903600719e-01   +2.040040759205885e-01   +3.985124112652961e-01   +1.548962566240895e-01   +3.706125350965776e-01   +5.767439191139327e-01; +4.739103951343941e-01   +7.593579785551966e-01   +3.626275576625684e-01   +3.992209422756780e-01   +5.535628931705677e-01   +3.695606029077105e-01   +2.188770893732485e-01   +7.565081253965258e-01   +8.243597750209934e-02; +4.191823841039711e-01   +5.968412655125452e-01   +6.368980305866228e-01   +2.463764837669640e-01   +6.288576456556910e-01   +2.396161781500230e-01   +6.256030018529970e-01   +8.606513051138782e-02   +4.440471977404184e-01; -1.929134645020498e-03   +6.859470417644862e-01   +7.022159320652245e-01   +6.303957526064334e-01   +6.928513176269309e-01   +8.864422077807606e-02   +6.051968655910241e-01   +3.020523128259625e-01   +2.553636045700498e-01; +1.602111061966342e-01   +7.177181771481590e-01   +5.434691890373799e-02   +2.049064728675268e-01   +6.205981440437633e-01   +7.289962202644934e-01   +5.272968303230128e-01   +9.893834059395727e-02   +5.012384951082827e-01; +4.829735176614914e-01   +2.156488226247605e-01   +4.592261705638329e-01   +6.418609017291695e-01   +3.991382174631283e-01   +5.820042592978579e-01   +5.614039193719166e-01   +2.834345405628218e-01   +7.340559729726028e-01];
L1_L2_iAMPA_netcon = [+7.173032873797809e-02   +3.836059956167323e-01   +4.004317736501008e-02   +3.516813518962527e-01   +9.853850030850848e-02   +7.559285684691902e-01   +1.214492078179348e-01   +2.450028389030792e-01   +7.175702423902862e-01; +5.368481846269040e-01   +6.429240964504958e-01   +6.414775332741935e-01   +1.849347202560246e-02   +1.172344605886107e-01   +4.162817036502474e-01   +5.045137583939736e-01   +1.944189029720626e-01   +5.237620306602697e-01; +1.792993132982699e-01   +2.104682108368507e-01   +2.157949249032923e-01   +1.050348964128276e-01   +2.635787194858655e-01   +2.032997975056480e-01   +2.968434621642620e-01   +3.665199366935374e-01   +3.631262814597102e-01; +7.113284520767919e-01   +6.423368974579244e-01   +6.583282624316066e-01   +7.524225083131323e-01   +4.605526762180648e-01   +3.233391680089848e-01   +6.432336275756625e-01   +4.085172489254051e-01   +5.351050432505208e-01; +5.241132982201969e-01   +9.108053107899977e-02   +1.448358188811865e-01   +4.115260694747040e-01   +1.469690710447329e-01   +5.349127257671271e-01   +5.452603116652021e-01   +1.663213815813505e-01   +3.503894416349557e-01; +4.315762004585316e-01   +3.977053208949184e-01   +7.788024928105450e-01   +7.574969893960019e-01   +7.164406771377591e-02   +3.067503499595893e-01   +1.604571855331341e-01   +4.533005005333966e-01   +3.488449944949850e-01; +6.559251264632219e-01   +1.792694700098495e-02   -6.987380745927539e-03   +4.921168212633937e-01   +4.169506624951030e-01   +7.610421682407723e-01   +1.863007501098009e-01   +4.577631506360358e-01   +2.015419938044789e-01; +3.246016459102344e-01   +4.945574222027200e-01   +2.736615024638070e-01   +7.324516777430744e-01   +2.735204781956563e-01   +6.268377396347687e-01   +7.278336955977311e-01   +9.000629299302410e-02   +7.497781239300227e-02; +1.904593471555507e-01   +1.839989926574123e-01   +4.115296658783441e-01   +6.717534504611651e-01   +6.884673117073400e-01   +2.201729702266080e-01   +6.811984751403893e-01   +6.665121989247786e-01   +5.130225326566761e-01];
L2_L5_iAMPA_netcon = [+5.043540851831705e-01   +3.934817642887650e-01   +3.589188167473045e-01   +7.584296675993800e-01   +7.330094047017025e-01   +6.347622939011790e-01   +7.350939479396315e-01   +7.806697974697785e-01   +3.312351577657280e-01; +3.414113173372293e-01   +3.818908563132158e-01   +6.039174598050480e-01   +4.797130479700545e-01   +2.693613983295651e-01   +9.052260381989728e-02   +1.025870162830682e-01   +3.599768912907866e-01   +6.716091407971981e-01; +1.578996291572711e-01   +5.423267972356040e-01   +1.974775325153506e-01   +9.021207936883738e-02   +7.174654670847603e-01   +1.593771874903183e-01   +2.823461404043696e-01   +5.010264623774303e-01   +3.996179436974325e-01; +2.649539212329703e-01   +5.450156465749869e-01   +3.526949232418318e-01   +6.563709952768806e-01   +6.127093095874439e-01   +6.811521396606129e-01   +7.404329636585665e-01   +7.022822541747406e-01   +7.480510939501835e-01; +6.878456387589326e-01   +6.606881136327527e-01   +7.015860611395162e-02   +5.872670789041277e-01   +5.699611793257786e-01   +5.705281103764420e-01   +5.345041078261305e-02   +1.969054956534499e-01   +6.203503159001782e-01; +7.266649647105171e-01   +5.003177581985995e-01   +6.550143811952609e-01   +3.056243050441197e-01   +3.474589971855984e-01   +5.625028560666447e-01   +5.795468835281232e-01   +1.891983006259044e-01   +7.665820452439368e-01];
L5_L2_iGABA_netcon = [+8.227248925379389e-02   +6.957628437495821e-01   +2.880401130721014e-01   +6.710577943023723e-01   +2.136665974827321e-01   +2.219001708623443e-01; +7.718038223875674e-01   +1.060174664390293e-02   +2.732194998601002e-01   -1.973525952821965e-02   +7.113341543253524e-01   +5.397409404931044e-01; +1.704838703030098e-01   +6.206169561607378e-01   +4.200948694930854e-01   +9.358354737982363e-02   +2.143697410138913e-01   +5.108873326236381e-01; +2.283412544586161e-01   +2.928123463253290e-01   +4.729275767646240e-02   +1.160223664419684e-01   +2.018765855910463e-01   +5.555954301243867e-01; +3.393047685610365e-01   +1.476568107785186e-01   +6.826992095679039e-01   +6.715199614154104e-01   +5.225969061088251e-01   +6.070956352331626e-01; +6.528218036521449e-01   +5.883519000462635e-01   +5.444324897170888e-01   +5.225992546081204e-01   +1.491941750758835e-01   +2.469636947424486e-01; +1.695644108748163e-01   +7.339023445758265e-01   +3.912798425452128e-01   +7.041080813117283e-02   +5.964354238938900e-01   +3.686372093785772e-01; +2.403648555765419e-01   +7.558695324511074e-01   +1.513908420439860e-01   +1.687238001705702e-01   +3.699417071306182e-01   +3.410041444347818e-01; +5.420280502396180e-01   +2.883155699239688e-01   +1.566203288726518e-01   +6.226694586398845e-01   +7.942292028071922e-01   +3.647867566534587e-01];
L3_L2_iAMPA_netcon = [+3.428164760936158e-01   +6.470361439596227e-01   +2.420603246189905e-01   +4.509614667227954e-01   +7.878616109308174e-01   +6.723660329886695e-01; +1.764766323768091e-01   +1.795278791031996e-01   +7.099268473422816e-01   +1.721044459543314e-01   +7.245840663328997e-02   +6.612098752675356e-02; +6.510481768745464e-01   +2.451060372204619e-01   +2.965972128695200e-01   +5.833520118684442e-01   +4.218857329941880e-01   +1.983440405457171e-03; +8.126139836252984e-02   +3.289163062287674e-01   +4.405468555667094e-02   +6.195655839608685e-01   +1.991893947371145e-01   +5.223020428776356e-01; +3.939223097652355e-01   +2.134396258150399e-01   +4.298160409564764e-02   +6.587668172468357e-01   +1.881749235368237e-01   +7.477009801270260e-01; +1.278142635096524e-01   +6.700557472080511e-01   +2.041547312105000e-01   +7.772526985322861e-01   +6.538378750291072e-01   +5.094723195428008e-01; +3.174070776175959e-01   +6.006952757682114e-02   +4.312617499711336e-01   +4.523469138452740e-01   +3.620374356198831e-01   +1.787224795946549e-01; +6.270338864056496e-02   +2.745791691871626e-01   +7.314148366007113e-01   +1.733952144111812e-01   +7.760497933586175e-01   +1.048327175450018e-01; +7.369364311563631e-01   +7.705360474223244e-01   +2.616973682529652e-01   +8.220543476873117e-02   +6.063735143672792e-01   +4.722649783893670e-01];
L2_L3_iGABA_netcon = [+4.811263082560550e-01   +7.054696989200969e-02   +4.897251721952026e-01   +6.263431005308838e-01   +7.622122141666933e-01   +4.756192198856599e-01   +7.009591410726146e-01   +2.543413404486294e-01   +3.155498185406614e-01; +6.779720808345142e-01   +7.068273860655278e-01   +6.100504941013009e-02   +1.095923229559589e-01   +6.003866127561244e-01   +5.884880562559502e-02   +2.401236501463757e-02   +3.553224908777468e-01   +2.244185354171721e-01; +2.025191926138780e-01   +3.200832575939285e-01   +4.390186260645872e-01   +6.934243958298026e-01   +6.339290561683297e-01   +2.078254344478394e-01   +1.381351026924817e-01   +2.465762773982842e-01   +7.360278995905589e-01; +1.842229149779376e-01   +3.423313015385107e-05   +1.764758935761242e-01   +2.202408324917947e-01   +5.568660828620347e-01   +5.837438141619916e-01   +8.794062538165420e-02   +4.099035773565048e-01   +6.604381011419129e-01; +1.073077117833652e-02   +7.190907629154533e-01   +7.693313019608309e-01   +3.670442579486363e-01   +2.472695758409311e-01   +1.655598764424728e-01   +6.465450319469002e-01   +8.030809369735434e-02   +2.704840064201506e-01; +4.663972779986743e-01   +6.603717533229587e-01   +1.739738177681273e-01   +4.577326848571111e-01   +4.122620895729969e-02   +2.978579276788985e-01   +1.146271001944462e-01   +5.607842295197871e-01   +4.071342534652621e-01];
L1_L4_iGABA_netcon = [+3.137084058794049e-01   +5.228892352193958e-01   +6.902903340942891e-01   +5.972941336460375e-01   +2.502059193722088e-01   +4.203307296812045e-01   +5.551009860428020e-02   +2.828970650994763e-01   +7.793718562215676e-01; +6.222451217166235e-01   +3.182790480146532e-01   +4.018058494965037e-02   +1.389602396745449e-01   +1.429630435596853e-01   +5.145214891805697e-01   +2.681180273023317e-01   +3.245356174868564e-01   +7.348731614585448e-01; +8.642327366996082e-02   +2.479881705368033e-01   +7.078856827817978e-01   +5.711015237694111e-01   +3.445301077616671e-01   +3.524512936781166e-01   +5.886076251941970e-01   +4.583494028185072e-01   +6.172639596797124e-01; +6.949906958483164e-01   +6.456586296691422e-01   +1.856295025945228e-01   +4.576335160418655e-01   +5.207513639240696e-01   +7.355519095610353e-01   +7.277480872584036e-01   +1.164209510280705e-01   -1.466128735306310e-02; +4.582699733815197e-01   +4.836980304135769e-02   -1.148095001257784e-03   +9.178837985396722e-02   +6.559077025013559e-01   +1.460574511050282e-01   +2.263968126713527e-01   +1.964842937606210e-01   +4.305633842148421e-01; +2.749795893867180e-01   +4.785327790891648e-01   +4.140150169960713e-01   +1.274697427652072e-01   +2.059106140677822e-01   +2.558703189296478e-01   +5.481391242721434e-01   +2.271299231643596e-01   +4.579253220222436e-02; +1.519154458883479e-01   +5.448771027948318e-01   +4.699886267350061e-01   +4.928490122599476e-01   +5.956846097331860e-02   +2.094555855412692e-01   +1.824130852093999e-01   +1.105085797434940e-01   +6.958449632333557e-01; +5.356940398752387e-01   +1.179406019348339e-01   +5.397206561285938e-01   +4.837818846662016e-01   +3.108979181564695e-01   +5.367370687581797e-01   +2.830624644022685e-01   +3.165395950579969e-01   +2.198478512850661e-01; +3.276009444245783e-01   +2.142310776899673e-01   +2.480764817103507e-01   +3.914748232313759e-01   +1.154167754265820e-01   +5.677903277720359e-01   +1.039062342303798e-01   +4.164170169831976e-01   +6.819094747732212e-01; +1.873278419928525e-01   +1.765987774101070e-01   +6.285426141443977e-01   +3.592887880615543e-01   +6.973997187113108e-01   +2.825709703853199e-01   +5.350864936177038e-01   +1.725701910822244e-01   +4.276484959753577e-01; +1.991509105348130e-01   +3.917895826490222e-01   +1.281322172772893e-01   +7.179765968644686e-01   +7.928765433212475e-01   +7.198950115339305e-01   +1.080300365454482e-01   +4.157765817017174e-01   +5.901653900935875e-01; +3.987590922122675e-01   +7.751964306163738e-01   +4.215686340005828e-01   +5.252909582028190e-01   +3.350227706886048e-01   +1.915487151366173e-01   +3.883337360753976e-02   +1.468761377817443e-01   +5.802631231135582e-01];
L4_L1_iGABA_netcon = [+4.501850267879284e-01   +4.147596477796222e-01   +7.885488200420536e-02   +4.663862661390545e-01   +2.268895663343144e-01   +2.014782310131306e-01   +5.101448555247475e-01   +4.819453360801259e-01   +6.909441268452338e-02   +2.374318443550310e-01   +3.611227770441202e-01   +6.623326742362848e-01; +5.929340415450652e-02   +1.880046750126014e-01   +6.829521913883516e-01   +1.203536745905456e-02   +1.592118374323994e-02   +6.899750136563381e-01   +1.835581012785970e-01   +6.331891022373807e-01   +6.239756793344308e-01   +5.803066037290927e-01   +8.610072377543898e-02   +6.816595346549936e-01; +8.648996371337653e-02   +2.480263612131623e-01   +2.936081353413753e-01   +5.740863421887249e-01   +2.170286592407863e-01   +2.395380672044333e-01   +4.605437752682316e-01   +7.359201670450580e-01   +7.299349425438508e-01   +1.742501099262890e-02   +4.130558756916294e-01   +2.284383021899967e-01; +2.431606838201380e-01   +1.696170542402363e-01   +7.598127005259040e-01   +7.518243469204056e-01   +2.760676360486968e-01   +6.570959211136652e-01   +5.927003302361271e-01   +8.200296637754166e-01   +7.214352920549894e-01   +2.080273758391606e-01   +7.495363807517069e-01   +3.946202025555524e-01; +4.421584552085773e-01   +1.738052278709258e-01   +2.034882122626685e-01   +6.295714621129181e-01   +2.304745188406578e-01   +3.386221638464806e-01   +3.532546917916441e-01   +2.760508024992627e-01   +6.651533347942947e-01   +3.788012761185595e-01   +2.694306251800585e-01   +1.841073303908815e-01; +1.585052117397944e-01   +7.010352625618483e-01   +5.041485909322546e-01   +7.831841588070623e-01   +3.349533574437307e-01   +2.735337603396681e-01   +4.829747170991707e-01   +7.030507311423287e-01   +1.593982231550234e-01   +3.768852434419843e-01   +5.873550612642012e-01   +1.550761869189624e-01; +2.351371966623327e-01   +4.703153360179274e-02   +6.699492335825331e-01   +5.133890030034358e-01   +7.348710434775124e-01   +5.540640517991600e-01   +2.615071136669035e-01   +5.232917968670852e-01   +3.891142877097141e-01   +7.953298015586610e-01   +2.498765879839632e-01   +5.957912725258266e-01; +2.643560464159064e-01   +2.598382014562007e-01   +8.862692158787698e-02   +3.304663104045168e-01   +1.703839578089511e-01   +3.123479413763426e-01   +2.493707500247989e-01   +7.035060836581101e-01   +5.508212465600261e-01   +1.247760170367970e-01   +8.165913117024435e-01   +6.978048395580000e-01; +2.680867580690708e-01   +4.087404818953462e-01   +7.780605637092146e-01   +6.939133822934100e-01   +4.203177758405550e-01   +3.397015317771546e-01   +3.585131408828413e-01   +7.153098920315680e-02   +5.035913773218776e-01   +3.643747072760058e-02   +2.681511002480955e-01   +3.041941361240421e-01];
L1_L3_iAMPA_netcon = [+4.407484180148949e-01   +5.189678562338677e-01   +6.284833011477094e-01   +4.076427191864799e-02   +5.838408495904196e-01   +6.737226738416394e-01   +5.792055999610993e-02   +4.273664462328838e-01   +6.854465050830416e-01; +3.445736302592745e-01   +6.348179412851490e-01   +5.943924174418161e-01   +7.258672003059685e-01   +8.110515548765183e-01   +7.116278740360480e-01   +6.613188349626017e-01   +3.559978909416349e-02   +4.876573322011004e-01; +6.664467592917305e-01   +6.570368750122734e-01   +2.976610467983670e-01   +4.566815327080329e-01   +6.079997739809863e-01   +5.080590457819850e-01   +3.110053488957327e-01   +6.890536515183725e-01   +4.405735230929236e-01; +1.078720266637827e-01   +6.043092693351790e-01   +3.297914679612272e-01   +4.881401363881151e-01   +5.864896131741424e-01   +1.076708228971613e-01   +1.527117041564760e-01   +6.218236101565852e-01   +6.575530140585644e-01; +4.615247360264819e-01   +6.632202737813614e-02   +6.213031042583977e-01   +5.304218229783414e-01   +7.018025929230683e-01   +1.107958201281449e-01   +3.170106485903466e-01   +7.121840346098248e-01   +4.147497016520325e-01; +2.784066811190181e-01   +1.147139794587522e-01   +3.572720161068874e-02   +5.505920693505402e-01   +8.025061791850260e-01   +4.596921123092159e-01   +1.397490724870060e-01   +4.038042947920009e-01   +6.020600420031066e-01];
L3_L1_iGABA_netcon = [+1.636485350940485e-01   +1.396997151748530e-01   +6.345253884547720e-01   +3.158451745312035e-01   +5.146111525464778e-01   +7.524577651785371e-01; +7.692775768420584e-01   +8.185824427656794e-01   +3.015683470671822e-01   +3.635617005126443e-01   +2.225739371093283e-01   +5.216733780725573e-01; +5.911397095330915e-01   +6.234919070665594e-01   +4.213258262364993e-01   +7.062694822173610e-01   +3.566086303952196e-01   +3.426025145135675e-01; +5.664981822258442e-01   +7.988227787376430e-01   +5.456776030182305e-01   +6.117974277652601e-01   +1.528306439274828e-01   +4.364605131892841e-01; +4.008393736830238e-01   +6.755577564417844e-01   +1.946204073864074e-01   +3.908284717134891e-01   +1.547051528932957e-02   +2.068651125740314e-01; +3.022861368707298e-02   +5.890712435980237e-01   +7.481073166371517e-01   +1.337331828202962e-01   +3.554183517401180e-02   +4.561169352831512e-01; +1.413700144660520e-01   +7.486669119337660e-01   +3.495751927032181e-01   +3.394454969835066e-01   +4.839741271115544e-01   +5.204887491685859e-01; +6.213488694712263e-03   +3.463830682042709e-01   +6.670623868931602e-01   +3.428926332869306e-01   +1.070860932104466e-01   +3.170645034994764e-01; +4.374401010523027e-03   +7.285344878030575e-01   +3.697894188608742e-01   +3.011917998078069e-01   +5.458985814755459e-01   +6.409996898008141e-01];
L5_Input1_iAMPA_netcon = [+2.851746333323134e-01   +3.235354728050441e-01   +6.045474816708327e-01   +2.793544899312239e-01   +1.625153307336047e-02   +3.656420642779480e-01];
L6_Input2_iAMPA_netcon = [-1.186866905841608e-02   +6.519921304067047e-01   +4.782646758520998e-01];
L5_L6_iAMPA_netcon = [+7.506129302697935e-01   +6.371743417894379e-02   +7.186467986496657e-01   +5.619797633860626e-01   +7.792024390643176e-01   +4.513968490543975e-01; +4.474271664812441e-01   +3.684642998291517e-02   +4.972787887593003e-01   +1.846750649946245e-01   +1.840394767191602e-01   +6.223942017191829e-01; +6.832510634788855e-01   +2.902005205033037e-02   +1.943500915823035e-01   +1.583756449078016e-01   +5.369718705274431e-02   +4.785235104642518e-01];
L4_L5_iAMPA_netcon = [+6.582327849022330e-01   +6.645524371588296e-01   +2.379057583809096e-01   +7.587795760029600e-02   +1.557328334433754e-01   +4.380123436232995e-02   +2.852594782853820e-01   +3.120622074710446e-01   +3.248974268697775e-01   +3.944599858099918e-01   +2.587208941569915e-01   +2.021423163203939e-01; +6.507574963215611e-01   +6.959910678234864e-02   +4.209154022534395e-01   +6.005746585121099e-02   +1.480919738580638e-01   +3.595503848528276e-01   +5.617842545909255e-01   +3.056475797553432e-01   +1.219511751646973e-01   +1.002724854113992e-01   +1.075035334863365e-01   +7.399687171410105e-01; +1.010520707045579e-01   +4.656811810742780e-01   +1.352115349137711e-01   +3.616731635963821e-01   +7.311236349067707e-01   +2.513250528811389e-02   +4.065544321583054e-01   +6.083810335792269e-01   +4.831514855862742e-01   +1.769230232206753e-01   +4.953505692190185e-01   +5.154051780653359e-01; +4.539053091429257e-01   +3.231640922008699e-01   +5.230911836824064e-01   +4.771236731373056e-01   +5.319540609693093e-01   +6.453746130619126e-02   +4.999864859022934e-02   +4.961177513113404e-01   +1.404722584521476e-01   +3.520280080594636e-01   +3.589863594302204e-01   +7.506960286278389e-01; +5.939688695307600e-01   +4.886414201175457e-01   +7.210626453850540e-01   +2.220501748931075e-01   +2.945625994841759e-01   +8.101429842699234e-01   +6.605116418526352e-01   +7.476080169219471e-01   +8.001063915598555e-01   +1.165219571284308e-01   +3.002661352701927e-01   +6.239986849967882e-01; +2.461001950412571e-01   +6.297308800630945e-01   +1.656848291560802e-01   +4.466004553954719e-01   +7.244443083214652e-01   +7.359905067109180e-01   +1.699902999164588e-01   +5.174060244082710e-01   +7.456475086798232e-01   +5.074850049368813e-01   +7.874804935023919e-01   +6.072055637880679e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
