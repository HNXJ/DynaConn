function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.915844665803610e-01   +4.692605080556580e-02   +1.433470020014853e-01   +1.602292949859932e-01   +5.153086465315148e-01   +3.485154999525102e-01   +5.547231539662971e-01   +7.620894369056088e-01   +2.103324430205358e-01; +1.914423436299036e-01   +3.465630135591892e-01   +1.659179802305667e-01   -4.371143271089883e-02   -1.567902349366445e-01   +1.265725813684934e-01   +3.193757182623123e-01   +6.632633577420931e-01   +6.592008411515990e-02; -1.286907671987663e-01   -1.235949980586530e-01   +8.788230429780239e-02   -7.460650298556923e-02   +5.218065400149501e-01   -4.670333479747114e-02   +5.006946181940435e-01   +6.233088069430800e-01   -3.706564968065891e-01; +2.043609380026127e-01   -3.480843996002581e-02   +2.884306728787344e-01   +4.548380900930698e-01   +1.468482241138926e-01   +1.079433948034731e-01   +2.969056701418069e-01   +7.542469827745898e-01   +7.747400891702876e-01; -1.144229898687614e-01   +2.285647409264962e-01   +1.570864503243716e-01   -3.792847195999446e-02   +2.778848116623479e-01   +4.145710281654021e-01   +6.160740237301043e-02   +4.348393843934800e-01   +1.339419301510680e-01; +3.823671411050748e-01   +8.646207547717841e-01   +7.631725437489583e-01   +5.512069357266836e-01   +1.984368796035369e-01   +3.018045331625621e-01   +1.864707425673026e-01   +3.459178540232820e-01   -1.542065780933169e-01; +1.007220906672541e-01   +4.728348501841648e-01   +4.680017338178278e-01   +8.702453063859173e-01   +3.532264144357169e-01   -2.255737290171206e-01   +5.087397163426050e-01   +3.017660401428244e-01   +3.680435902710827e-01; +5.067759553232923e-01   -1.674084661543808e-01   +6.825294108058408e-01   +7.838659404300816e-01   +2.219540396314948e-01   +1.628372781583342e-01   +4.830650481635157e-01   -2.186920749679998e-01   -2.485790803594903e-01; +9.634599027918811e-01   +1.005159046390506e-01   -5.035451717791711e-03   +8.655401359892856e-02   +7.283379258203468e-01   +4.110182023859653e-01   +6.204348170440388e-01   -2.019309890574176e-01   +5.692988885735303e-01];
L1_L2_iAMPA_netcon = [+2.856341096686961e-01   +6.005016341373067e-01   -4.556739915180226e-01   +3.781988707445634e-01   -4.664173278538659e-03   +1.225237540594314e-01   +2.191942202223318e-01   +3.541875850453327e-01   +6.102390840485681e-01; +1.940718105871580e-01   +2.650537587416618e-01   +4.571424222662308e-01   +3.708868726847757e-01   +4.041589610605666e-01   +4.949029344132513e-01   +6.102483332996295e-01   -1.075025199535632e-01   +6.353827564169347e-02; +2.924130592655185e-01   +7.374202303154578e-01   +4.570384790627184e-01   +8.022467718642072e-01   -6.191822732777998e-02   +4.653849445401270e-02   +3.078069634652124e-01   +9.824071692350041e-02   +5.821861931845447e-03; +4.985503203164108e-01   +4.415767624060866e-01   -1.448018932693683e-01   -8.800453611146430e-02   +6.803224318226466e-01   +1.423791003715870e-01   +2.854844301287688e-01   +4.054626019694322e-01   +6.684606960127758e-01; -2.814476701810190e-02   +3.191055893736291e-02   -3.514497753581808e-01   +1.532242202033375e-01   -1.877618407263130e-01   +3.714563999779863e-01   +5.014730365025093e-01   +4.699511666068430e-01   -2.611163755314715e-01; +7.076222452890296e-01   +6.492788314031260e-01   +3.875921509863818e-01   +4.129112975771867e-01   +2.914097463204370e-01   +2.170359674216163e-01   +1.274186886473524e-01   -6.614039996434886e-03   -1.663454547719916e-01; +5.480661192252675e-02   +3.353047609953104e-01   +1.759184072631189e-01   -3.316748857778971e-01   -1.303016312105526e-01   -8.987249766976292e-02   +3.294343619629229e-01   -1.142881528485961e-01   +1.000000000000000e+00; +5.452589914870160e-01   +2.700399941638693e-01   +2.405239782976162e-01   +5.370438097267908e-01   +4.764835355661025e-01   -3.035893277053370e-02   -2.943620999988573e-01   +4.268208454624882e-01   +6.151240558492577e-01; +1.483909474843353e-01   +3.208424083616874e-01   +1.409459113978478e-01   -6.183297432136309e-02   +4.131837388426052e-01   -1.195207754062526e-01   +8.991511300017584e-02   +3.378744278499787e-01   +3.629593034752454e-01];
L2_L5_iAMPA_netcon = [-5.759183567986124e-01   -9.958245158492346e-02   +3.883302064952615e-01   +7.965653121245194e-01   +2.414639882873616e-01   +3.699529676075966e-01   +8.548314780522948e-01   +6.172443436192311e-01   +6.005376918275872e-01; +1.205165140946803e-01   +8.795883879895479e-01   +3.687224892258839e-01   +1.917853877199004e-01   +2.938812859250786e-01   -6.737108435361763e-02   +3.404283433748160e-01   +3.001137878012587e-01   +8.510630882104278e-01; +4.622929678424531e-01   -7.030977922346771e-02   -1.592425465012147e-01   +4.037923202186314e-01   +9.316804223207104e-02   +3.895967597948585e-01   +2.225669043866559e-01   +8.020609535116136e-02   +7.007743021131427e-01; +3.961561728781875e-01   +4.560210829575501e-01   +5.232782437024779e-01   +2.646705781564380e-01   -2.776125974405290e-01   +2.435782318738361e-02   +5.742726752014807e-01   +5.876326017557245e-01   +6.628521744683366e-01; +5.008167139955667e-01   +2.804851888272402e-01   +6.607283304088349e-01   +5.481110867982929e-01   +8.509755578060096e-02   +4.564762880662263e-01   +5.328340541808836e-01   -1.707402967970841e-01   +3.026681796206203e-01; +9.664120190181785e-02   +2.320227380521904e-01   +2.157727432405345e-01   +6.682144206020251e-01   +1.393022669762738e-01   +2.987955143059729e-01   +3.832719307955563e-01   -3.145977697049239e-01   -2.004552999105980e-02];
L5_L2_iGABA_netcon = [+2.689915098840681e-01   +3.018724122544991e-01   -1.013746820646954e-01   +4.766251935826749e-01   +2.123027730548765e-01   -1.536891127870644e-01; +9.610057442939390e-01   +9.473432558817511e-02   -5.711063456302689e-02   +3.178863637225858e-02   +6.814647342888269e-01   +2.335524805355145e-01; +1.222037002851686e-01   +1.475243773002527e-01   +2.021568781601637e-01   +4.685037627213218e-01   +3.603305788112242e-01   -7.114974813854744e-02; -2.468858902923899e-01   +6.263054086981588e-01   -1.805063888344924e-01   +3.545683161429144e-01   +5.267672771569581e-01   -1.102039626089201e-01; +1.000000000000000e+00   +6.724824235754055e-02   +5.822970688729580e-01   +2.857191616347946e-01   +2.801369895669457e-01   -8.801671767394745e-03; +3.219217406533315e-02   -7.766034318059059e-03   +4.287920967624480e-01   +1.551900160281221e-01   +2.654233356278224e-01   +1.685401139587367e-01; +7.192464096667985e-01   -4.861202960425786e-02   +4.895112997719642e-01   +5.620794160082538e-01   +6.966539938973039e-01   +1.253724810172763e-01; +3.226144812202991e-01   +3.733252501417388e-01   +7.118205175664472e-01   +8.262497261994484e-01   -2.324086523188021e-01   +4.683442752426377e-01; +2.518886292610261e-01   +8.505864849079411e-01   +5.041424316352228e-01   +2.184975514598492e-02   -4.616251285305342e-01   +3.324278932088470e-01];
L3_L2_iAMPA_netcon = [-3.644865584602898e-01   +9.095238064563481e-02   +1.328276769591996e-01   -9.539672450074674e-02   +3.149498773109054e-01   +1.362371573199028e-01; +3.914608341607776e-01   +6.113877231295053e-01   -2.637288333540810e-01   +1.539684067419536e-01   -7.422155325736585e-02   +2.349423693801831e-01; +1.507870010472676e-01   +3.439803275251219e-02   -3.569547201380239e-01   +5.702031010768950e-01   +3.974872902094687e-01   +3.086539243458870e-01; +8.717104173926536e-01   +1.750302835114097e-01   -1.878699333205442e-01   -1.731398693968608e-02   +1.000000000000000e+00   +4.499836990018017e-01; -3.040066332861990e-01   +4.292025740570850e-01   -1.305103351566991e-01   +1.163986328367804e-01   -1.218531750367119e-02   +8.517366750521309e-01; +1.979945808498271e-01   -6.199142765776656e-03   +4.229901494766014e-01   -4.450931379759907e-02   +2.920553617414782e-01   -3.215078867029612e-01; +9.914539424647312e-01   -1.572695339129190e-01   +4.039349402368070e-01   +8.228960621337389e-01   +3.328703489478096e-01   +2.606884645957451e-01; +4.385019811221585e-01   +2.839706410266537e-01   +1.064186156359797e-01   +1.661758566161566e-01   +9.923646300904845e-02   +8.295860385497966e-01; +7.883389010707252e-01   +1.393681127530866e-01   -3.330633799174533e-01   +2.157088417876788e-01   +5.099374338721498e-01   +2.423288528627606e-01];
L2_L3_iGABA_netcon = [+4.711826796635895e-01   -1.784941096897724e-02   -2.220982389378084e-02   +6.514668807514938e-01   +9.046967379256342e-01   +4.753040362832926e-01   +2.646403004717203e-01   -2.175954794935125e-01   +2.815051712786734e-01; -1.091682421490930e-01   +5.832413329282510e-01   -1.304498554243516e-01   -5.652723196100426e-02   +1.000000000000000e+00   -1.633224766320567e-01   +4.781614106115210e-01   +9.527427639026884e-01   +3.185043658499320e-01; +1.939897701817072e-01   +4.191162672687601e-01   +8.773021522893396e-01   +9.870431472370204e-02   +3.097321420684817e-01   +4.684811756320877e-01   -3.480409671132387e-01   +7.029895823839402e-01   +6.977600382925774e-01; +2.094747652073813e-01   +3.582316984635399e-01   +5.063773587381591e-01   -1.527552295202254e-01   +1.952394577620729e-01   -3.199562666404620e-01   +3.662267704432293e-02   +1.953475209636201e-01   +1.346228220463182e-01; +3.623600816682588e-01   +5.216863254273640e-01   +4.237865369772840e-01   -7.054816710309440e-02   +7.807046466431888e-02   +1.008021616001267e-01   +2.238182254627627e-01   +2.534322376677048e-01   +3.097755972957443e-01; +7.850402232463550e-01   +7.063498712972442e-01   +2.954408210032955e-02   +7.569047263770167e-01   +7.922530601495492e-01   +7.540094757562917e-01   -3.092748955728024e-01   +5.869276410418448e-01   +4.417834598711264e-01];
L1_L4_iGABA_netcon = [+4.453213346682661e-01   +8.489034035334463e-01   +2.335930177177691e-01   -7.314484781144448e-02   +3.956644757554743e-01   +3.142512337888190e-01   +8.071853089496298e-01   +2.802120967927325e-01   +8.950172140731905e-01; -2.552857472928777e-01   +7.895039579580272e-02   +5.903784099209142e-01   +3.175255421344297e-01   +2.673394900018022e-01   +4.180022577800334e-01   +5.266853562296230e-01   +4.267228948576025e-01   +2.192418708203454e-01; +3.904972896405690e-01   +5.200179848712592e-01   +6.324114965944314e-02   +6.929604822410557e-02   +5.272168782856347e-01   +1.000000000000000e+00   +8.755768329311371e-02   +5.719258296663521e-02   +2.012843936734217e-01; -8.503552329557465e-02   +7.205244697887071e-01   +1.204244467738439e-01   +1.662582489509902e-01   +1.633431477095218e-01   +9.541804818249577e-02   -1.433803387672455e-01   +4.946006181136302e-01   +8.970706427719791e-02; -4.671065748093998e-02   -1.636290736155870e-01   +2.048021932120963e-01   +6.781537588900327e-01   -2.360042903314120e-01   +1.106570591019045e-01   +6.899700201836035e-01   +7.094273901003142e-02   +1.730734274520060e-01; +5.460595611653715e-02   +2.748693430972218e-01   +1.229087922877816e-01   +2.556301610775663e-01   +1.238605451226092e-01   -4.152957570401983e-01   +2.556076282160682e-01   +4.307746707363449e-01   +8.536179855057291e-01; +2.730499920310446e-01   +8.590860249366586e-01   -1.187869377090989e-01   +6.035153997811006e-01   +5.008514043186717e-01   +4.423347840725778e-01   -2.694829584097606e-01   +7.925579927185229e-01   +5.148681219577754e-01; +2.875097128292469e-01   +4.938409310306624e-01   +1.176339832003650e-01   +2.501024896957903e-01   -2.291895958058271e-01   +7.932288863622078e-01   +3.778344560291035e-01   +7.061930684600937e-02   -2.692188311632131e-02; -2.355132426383187e-01   +2.070860193688247e-01   -3.863541276698143e-01   +9.762508079563808e-03   -2.159874874657266e-01   -7.523441009145132e-02   +8.134923453219566e-02   -1.297040680716689e-01   +1.918659156471636e-01; +3.166671227471807e-01   +6.423501327438287e-01   +1.138700815779713e-01   -2.964002931228023e-01   +4.197730403639047e-01   +3.929288669753401e-01   +6.126260157348272e-01   +5.760837812900649e-01   +3.368360579505956e-01; +7.735185239224132e-02   +1.791290982793960e-01   +5.173389096934740e-01   +8.458553556165936e-02   -4.296662542078726e-02   -1.234934498113226e-01   -1.970370216749302e-01   +2.340456580791742e-01   +4.367919041203809e-01; +2.380952803217185e-02   -1.600430307006743e-01   +1.252797158871983e-01   +4.234366187561302e-01   +5.172594131538553e-01   +2.904555526329706e-01   +6.036614983209980e-01   +1.612301157018921e-01   +6.197422663933457e-01];
L4_L1_iAMPA_netcon = [-2.415398745812410e-01   +2.580639609619356e-01   +2.855329557839759e-01   +5.446182577618955e-01   +4.145972535721366e-01   +5.723445157358115e-01   +6.368171007491048e-01   +7.601302879716616e-01   +2.058426741743623e-01   +2.495782866512747e-01   +2.708082472058811e-01   -1.016931062152179e-01; +1.183515016243249e-01   -2.214338166244093e-01   +4.569649915769672e-01   +1.986523818322909e-01   -1.152566287598060e-01   -2.513974881170260e-02   +4.014502644701281e-01   -2.131479310560395e-01   +3.980628761636056e-01   +2.418804434067879e-01   +9.174204733544284e-01   +5.917639985443283e-01; +2.184788411413565e-01   +2.753247616724920e-01   +5.208760486649404e-01   +8.368488930202830e-01   +2.579728339628320e-01   -2.310131816992734e-02   +8.815398940187251e-02   +6.519856177895443e-01   +6.105922704688821e-01   +3.893755300564057e-01   -3.314981917264607e-01   +4.350282798263197e-01; +3.082406815669910e-01   +3.200957806345250e-01   -1.261640054842584e-01   +7.989169749099059e-01   +7.698609553234308e-02   +5.441558907301620e-01   +2.952544151658815e-01   -2.585039260087360e-01   +5.349266335463012e-01   +4.214070542569558e-01   +5.912342105743713e-01   +1.132311676578465e-01; -2.435227436860143e-01   +5.371653271302053e-01   +4.794164075710416e-01   +4.053322187912269e-01   +7.375344160459965e-02   +1.000000000000000e+00   -3.437196807080753e-01   +3.812247664408502e-01   +4.941421018009169e-01   +4.835042852162856e-01   +3.425589718615880e-01   +7.853608578666436e-01; +2.277009609632057e-01   +2.241006066658373e-01   -5.483652031041254e-02   +1.813414525668109e-01   +5.250810474860080e-01   +5.300369120806078e-01   +6.523445280507677e-02   +7.502933197941893e-02   -1.599771638398571e-01   +7.052607098349060e-02   +3.057918460499840e-01   +6.777798220119131e-02; -3.252093969969897e-02   +2.567544452152101e-01   +1.393591188224652e-01   +4.399355054013494e-01   +1.050148201606609e-01   +1.786674762311848e-01   +3.240102533706113e-01   +6.551711822041040e-01   -5.017579597082847e-01   +2.462804138822914e-01   +7.742152483956887e-01   +8.277804995831156e-01; +6.388151087870650e-02   +1.901527751359942e-01   -1.296627373293071e-01   -3.115322270924001e-01   +4.255093490697014e-01   +2.493731394992287e-01   -6.416489289149233e-02   +2.830927472407432e-01   +1.617248683699222e-01   +9.860354093377748e-02   +3.213059681178473e-01   +3.097974218154846e-02; +4.658189660713132e-01   +5.793790811179717e-03   -5.307406053715278e-02   +7.150033104725125e-01   +7.704918572050719e-02   +6.918094960549269e-01   +2.721422567039934e-01   +2.234490523619296e-01   +1.820148612960554e-02   +3.741201080484938e-01   -4.996192219372429e-02   +7.042368707892920e-01];
L1_L3_iAMPA_netcon = [+4.345931065754813e-01   +6.331353754447190e-01   +6.391538989798963e-01   +1.945567027915448e-01   +5.650290023604758e-01   +4.885347653049491e-01   -2.182422921370664e-01   +4.771541306495855e-01   -7.506312357629821e-02; +6.582240824014586e-01   +4.166770207839375e-01   +8.547073190779017e-01   +2.124045697581243e-01   +7.206768579689948e-01   -6.567468412820959e-02   +9.794759490327658e-02   +7.301308169907885e-01   +1.594034585057152e-01; +3.094030454857108e-01   +6.047508382012272e-01   +1.434288241489432e-01   +3.624729651074806e-01   +1.803759469158351e-01   -1.098936979156230e-01   +6.092278649890612e-01   +7.948068277409931e-03   +4.023005959554573e-01; +4.514914433071616e-01   -9.093031380556951e-02   +1.849447602545797e-01   +5.540592122231861e-01   +5.676135210674561e-01   -1.293730129828465e-02   +1.348789964116719e-01   +8.448250687242539e-02   +2.000264203884367e-01; +5.267812144849292e-01   +5.970638085284018e-01   -1.547094775358830e-01   +2.005375369709969e-01   -1.898551888448123e-01   +1.736006614799329e-02   -9.805026556070581e-02   +3.444422500640214e-01   +2.087913570483213e-01; +6.463645275570824e-01   +6.733177176746409e-01   -2.161094353823317e-02   -2.289945844588944e-01   +7.475364378191679e-01   +5.556252280830295e-01   +3.351113740221205e-01   +7.097330826825879e-01   +3.946074205363785e-01];
L3_L1_iGABA_netcon = [+6.311182718479721e-01   +1.956295816253326e-01   -4.658109382286234e-02   +5.150647025861536e-01   +3.014287724980451e-01   -4.503341963988804e-02; +4.417931250256155e-01   +2.352720449514090e-01   +1.169242503872846e-01   -3.257296271599639e-01   +5.962409346665685e-01   +8.675106784058143e-01; +2.396116871637582e-02   +4.000628376738263e-02   +7.955025917524940e-02   -3.585281749895078e-01   +5.458518300018170e-01   -3.378960375409268e-02; +1.154667630573856e-01   +2.770852235496251e-01   -4.505088231137360e-01   -4.085194951623661e-02   +5.761477297435675e-01   +7.608795981090910e-01; +4.182198014101104e-01   -2.593252373792534e-02   +3.851470825614958e-01   -3.899251856451690e-01   +1.685305758855948e-03   +9.171748517115549e-01; +6.540013943253690e-01   +3.261749168701267e-01   -2.200214236591209e-01   +1.152598567426999e-01   +3.316390034850165e-01   +1.680144506129808e-01; +1.112935326892763e-01   -4.498687381806413e-01   +3.032810695915450e-01   +1.993298158072342e-01   +7.777393692244704e-01   -2.987294300133468e-01; -4.137726657386638e-01   +4.615710267990278e-02   +6.840803204586768e-01   -2.560295048371043e-01   +9.433541058795880e-02   +1.496021605437626e-01; -2.053740825799922e-01   +5.915078453875876e-01   -5.202654259516374e-01   +7.185784701545946e-01   +3.175942783707743e-01   -4.839929864924828e-01];
L5_Input1_iAMPA_netcon = [-2.129605217405058e-01   +4.750970843929544e-01   +2.318071026640563e-01   +1.113059047989265e-01   +6.563727729278810e-01   -1.638415951044294e-01];
L6_Input2_iAMPA_netcon = [+2.959115202586375e-01   +1.000000000000000e+00   -3.735378971058733e-01   +4.163898600658898e-01   +4.093212431986214e-02   +1.701521895305333e-01];
L5_L6_iAMPA_netcon = [+4.159238670396278e-01   +3.267297122313009e-01   +9.764607145666079e-01   -2.827782163449962e-01   +4.238368432826743e-01   +2.610142961508757e-01; +5.487836669987077e-01   +7.428883326391151e-01   +6.433046464137021e-01   -1.350875131911178e-02   +7.896384727974552e-01   +8.204375926737481e-02; +7.307556007004457e-01   +1.347783015730731e-01   +3.653174589615785e-01   +6.291919405269295e-01   +8.810121295546995e-01   -5.676347377782579e-01; -1.241061569467877e-03   +1.407537962811117e-02   +6.091139017406548e-01   +2.988559771636221e-01   -2.894685742735906e-02   +4.928077778156930e-01; +3.249743905445677e-01   -9.389415114005184e-02   +4.341972270439679e-01   +6.791626113005018e-01   +4.092751005461392e-02   +1.137187630250414e-01; +4.390205375048963e-01   +4.173905380040335e-01   +7.585690204552540e-01   -3.281811658943044e-01   +5.195058080144552e-01   +6.118040820649966e-01];
L4_L5_iGABA_netcon = [+6.500548887552121e-02   -1.616015195574751e-01   +5.159254490826195e-01   +8.648363354081506e-02   -7.414231966336360e-02   +1.593849266020445e-01   -3.813759018057304e-01   +5.540235541996799e-01   +2.281432542678005e-01   +1.904421331419023e-01   +4.350622636830567e-01   -6.845996757417327e-02; +3.186708629306610e-01   +6.510490802025091e-01   +8.261565111730917e-01   -7.305938197562395e-03   +6.769083622497030e-01   +1.839470302327172e-01   +5.729426694113162e-01   +6.778042368049064e-02   +2.250014872634627e-01   -1.048789277612787e-01   +8.030639893792438e-01   +8.839300473051655e-02; +6.344678918289937e-01   +8.263300071565537e-01   +1.463061469928155e-01   +1.628647571645337e-01   +9.548620914641462e-02   +5.478523078419386e-01   +6.189904279749775e-02   +5.418022678264567e-01   +8.729715292954052e-01   +3.163255650680200e-01   +5.368131726784751e-01   +2.909989181007439e-01; +2.286449695646738e-01   -8.712886298678763e-02   +7.370382286498256e-01   +6.654302366363726e-01   +6.816772281576520e-01   +1.919679827353193e-03   +3.324353910906973e-01   +1.545444054343637e-01   +4.862038788579165e-01   +5.002599172393223e-01   +7.368392169629406e-01   +8.240250287778741e-01; +5.671522575950270e-01   -1.732535193413041e-01   +4.406058511319439e-01   -1.196136485912880e-01   +6.039447215315924e-01   +7.172353175622763e-01   +5.107706884498461e-02   +7.831532474726604e-01   +2.629268814006028e-01   +5.088036341163814e-01   +3.778833751619542e-01   +1.088125992248206e-01; +3.051772858442091e-01   +7.210051152512721e-01   -1.978667328200873e-02   -1.881533758308126e-01   +8.963596110725534e-01   +6.721350858699930e-01   +3.225209994725993e-01   +9.804674957052385e-01   +3.219228395648908e-01   -4.115128002922734e-01   +2.522203821094066e-01   +3.299186675185516e-01];
L6_L4_iAMPA_netcon = [-3.908805619865388e-01   -9.595014037008320e-02   +1.033429283115508e-01   -1.488207740798015e-01   +4.334196672866849e-01   -8.484586448488540e-03; +4.597807416530575e-01   +1.038182178536197e-01   -1.250706451018921e-01   -7.082230023261582e-02   +9.411253690926408e-02   +3.406428469636095e-01; +2.954827562226310e-01   +3.313166203574435e-01   -3.997565050632543e-01   +5.770662878699512e-03   -9.690731971893046e-02   +3.678296691558706e-01; +1.652835150718329e-01   +3.923163227172786e-01   +4.391487812015995e-01   +3.371798069491939e-01   +1.283794143656765e-01   +4.657439949390676e-01; +4.457379117457537e-01   +6.840507514624563e-01   +6.402315201690417e-01   +4.244965267132196e-01   +1.262957217148517e-01   +5.733532032211828e-01; -5.279558281181977e-01   +7.686881804535722e-02   +4.313976325954861e-01   -3.077886976542240e-01   -9.690483142596028e-03   +3.754132754039070e-01; +3.458200581130269e-01   +4.306425029787477e-01   +9.444478297271641e-02   +3.395100638356296e-01   -3.120460953429331e-01   +5.997817862114481e-01; +5.581228393986537e-01   +7.739727199485067e-01   +3.426910528084893e-01   +4.357190288752770e-01   +3.277020967172395e-02   +4.025323784517917e-02; +4.396862937662100e-01   -8.418773879358421e-02   +8.777680260231837e-01   +5.563794225237554e-01   +2.341500320610205e-01   +1.964963005380927e-01; +2.395040203641924e-01   +1.696599527640393e-01   +2.289602846251491e-01   +3.583424586778009e-01   +3.553116569767149e-01   +6.136432200278295e-01; +6.768191743738405e-01   +2.842611588703324e-01   +7.283980877530487e-01   +5.234186109371919e-01   +6.825569389105229e-01   +9.800066496235700e-01; +2.116642306909054e-01   -1.480627950102378e-01   +7.607663627982305e-01   +2.553985379573627e-01   +2.831382096346480e-02   +6.971313928296897e-01];
L5_L4_iAMPA_netcon = [+6.749844975372574e-01   +3.962995168025698e-01   -1.832533037358410e-01   +1.471818049995253e-01   +5.312329405596565e-01   +1.415600978649928e-01; +3.137956323569364e-01   -1.351506992585243e-01   +3.710211196024452e-01   -1.041759959839566e-01   +6.238300081041059e-01   +7.078923511015897e-01; +3.534374597112999e-01   +2.721102906290745e-01   +1.437445603122893e-01   +2.966154083662035e-01   -2.548683917870768e-01   +5.862204425622140e-01; +2.293019374421757e-01   +5.673591760407799e-01   -2.463587978908838e-01   +2.381800238652075e-01   +4.681762384002654e-01   +6.607328989971519e-01; -2.851917200803242e-02   +7.907412441113547e-01   +6.247637239127132e-01   +6.609779058731017e-01   -2.951899990511352e-02   -8.101905257890143e-02; +4.901311294922017e-01   +4.091224933728689e-01   +5.157116437675505e-01   -4.568211133645014e-02   +1.706352349687755e-01   -1.905451261022531e-02; +1.465365162201534e-01   +5.347840820802519e-01   +5.063887877565657e-01   -5.261992464278504e-02   -2.675354509153313e-01   -3.012524567932057e-01; +6.789240709977626e-01   +6.622911686069892e-01   +4.876957647589839e-01   +2.683490754507825e-01   +3.433887383795348e-01   +1.611071716268836e-01; +8.456555142370598e-02   +6.185683835922007e-01   +3.270520546997757e-01   +1.667837547194025e-01   +6.412903353190917e-01   -1.310803629654184e-01; +8.790829341536626e-01   +3.686286995129512e-01   +2.971775352173758e-01   +7.251291073627973e-02   +1.409550576395653e-01   -1.730731212063616e-03; +5.095482193573553e-01   +3.228472347404863e-01   -2.836142600927138e-02   +7.339278200027100e-01   -2.659102455992338e-01   +2.417823255723723e-01; +5.896961717967952e-01   +3.441128559339553e-01   -6.262984329181825e-02   +5.539856172166409e-01   -2.770314320584505e-01   +2.544196552148955e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
