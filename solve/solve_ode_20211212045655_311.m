function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.889030628325032e-02   -3.270363383490213e-02   -2.330033473611379e-02   +4.365314372740361e-03   +1.884247906491429e-02   +3.063280591625641e-02   -1.182160781588581e-02   +3.210080559772165e-02   -4.059488785459081e-02; +6.149874918935896e-02   -6.446958671482143e-03   -3.248920064709565e-03   +5.150307673148097e-02   -2.420140144046979e-02   -7.950479188981914e-02   -4.008179363216903e-02   +3.737701141065461e-03   +8.503865686208948e-03; +8.010903566495600e-03   -3.627806223482685e-03   +4.909852987804407e-03   +3.859589179531685e-02   -4.097321274312890e-02   -4.465145916600364e-02   +4.001020796220375e-03   -5.814997243905327e-02   +8.887050193800849e-02; -7.207802228087496e-03   +1.592078111459981e-02   -5.226338767575137e-02   +2.171942475302134e-02   -3.270554066551642e-02   -4.812330633955711e-04   +3.680759362897441e-02   -2.291018325874809e-02   +1.866661651307641e-02; -4.720370215737096e-02   -5.570197632775241e-02   -2.732190147035684e-02   -5.478328763392074e-02   -4.135302867671997e-02   -3.002874431244806e-02   +3.634617792326425e-02   -3.140599225051877e-03   -8.924067197615912e-02; -3.024273655680912e-02   -3.444426310132419e-02   +3.507281604295701e-02   +4.131280971366345e-02   -4.002282688833875e-02   -7.916640709504481e-02   -9.785173863053866e-03   -5.564373101682621e-03   -2.397052302252490e-02; +2.974306525996329e-02   +7.059222717383370e-02   +5.516059657687927e-02   +3.410451554223212e-02   +4.179825254339854e-02   -3.073041343949447e-02   -2.874636336255990e-02   +5.736567591747622e-02   +1.409862665074888e-02; -7.770223094899179e-03   -5.160637739218939e-02   +2.216342866165660e-02   +1.084703071176703e-01   +1.444743347593407e-02   -3.817182798503761e-02   +2.818293097260305e-02   +1.804361636323016e-02   -8.156904134187702e-03; -1.112215537135639e-02   +4.794651150406851e-03   +1.082685742553049e-03   -1.446880333683803e-02   -8.224222897824610e-03   +5.650295401567965e-02   +5.266481163486519e-02   +6.588972993421328e-02   -4.700954150431388e-02];
L1_L2_iAMPA_netcon = [-3.342141209855973e-02   -4.395407633448695e-02   -1.665132667911530e-02   +1.467387797443150e-02   -8.890513043196342e-03   -1.203799079140440e-02   +1.985716199858008e-02   +4.310198220518719e-03   +2.197716310490823e-03; -4.297242619429997e-02   +2.955619687999606e-02   -3.558647062659157e-03   -3.081468499996395e-02   +5.918279273479578e-03   -3.918813468009604e-03   +6.311414421753223e-02   +1.811825542789042e-02   +3.782549874039869e-02; -3.118230126655101e-02   -7.051810727478645e-02   -7.522501468704165e-02   -2.224745613521861e-02   -8.274770270607704e-04   +3.656832159420094e-02   +1.219934677894298e-01   -9.950951801729988e-02   -3.717692971120894e-02; -8.060711442568785e-02   -1.900373942424351e-03   +1.004638488418716e-01   -4.572796548187131e-02   -5.655388566658728e-02   +5.129303883507901e-02   -4.003553802026128e-02   -5.534694856821208e-03   -5.289778519521632e-02; -2.628862842459218e-02   +5.108955196928876e-02   -2.308785366928143e-02   +4.081827641651235e-02   +2.913037494812656e-02   -9.599111940734791e-03   +2.891813719133319e-02   +3.042770411540198e-02   +2.736234712312041e-02; +5.175798874475707e-02   +1.678243346918172e-03   +4.153793807847742e-03   -3.489134289947689e-03   +2.161973493824988e-02   +3.007805591457211e-02   +2.898724890175013e-02   +1.730376247592663e-02   +4.118376721187272e-02; +1.845420535922703e-02   +6.718457523289538e-02   -5.117411217382492e-02   +6.566538881810916e-03   -2.277982281087382e-02   -4.169508816631452e-02   -2.309468320572262e-03   -4.097485108317363e-02   +5.886733365327582e-02; +1.025394449240840e-02   -1.683420347150033e-02   +1.284827358212450e-02   -8.860097176214170e-02   +2.102016081230796e-02   +3.082177639097124e-02   -6.458362715000407e-02   +6.536310904074753e-02   -3.197368852513073e-02; +2.043290531358840e-02   -3.276016198385480e-02   +1.748502202322372e-02   +5.388814367373536e-02   -8.908671752711962e-03   +2.611941512272159e-02   -3.199682697364686e-02   +5.864780863008713e-02   -9.459151896224231e-03];
L2_L5_iAMPA_netcon = [-1.138898583748186e-02   -4.909280473075171e-02   -5.347978731457846e-02   +2.935225170225264e-02   +2.337175678156457e-02   -4.937282796791125e-02   +2.519142657552811e-02   -3.344863421778179e-02   +6.955816004382977e-03; -5.362693371399464e-02   -8.006822675277200e-02   +5.256510022801700e-02   +2.392182880113789e-02   +4.476877029122500e-03   -6.770177968292317e-03   -1.563895663656476e-02   +1.021225036966638e-01   -5.379184853896880e-03; +1.231504415682304e-01   -2.989266870510899e-02   +6.698764383121630e-02   -3.372195275564082e-02   -1.392282134812679e-02   -2.431351156493458e-03   -1.006708183742808e-02   -2.929648484699834e-03   +7.265361348499176e-02; -1.824979489641965e-02   +5.657670926010493e-02   +1.810926045643646e-03   +7.409381579692935e-02   +1.822951359139444e-02   -6.238966464622417e-02   -8.532389705992217e-03   -2.825175256887658e-02   -3.472452049981140e-02; -1.158788995272507e-02   -4.293950276872815e-02   +4.913630547650434e-02   +1.344074362345299e-02   +8.800461077901636e-02   -2.796645559959322e-02   +1.101540864203192e-02   +5.236307284333742e-02   +1.495766004043464e-02; +4.392584250791717e-02   +2.959834453274843e-03   -4.513417313847830e-02   +1.572340962937683e-02   +1.570680588181810e-02   -3.223936611307736e-02   +1.897279188685134e-02   +1.096493722919363e-02   +4.106273477779908e-02];
L5_L2_iGABA_netcon = [-7.030894943326796e-02   -4.209578756187338e-02   -1.312300911758097e-02   -4.375045440604339e-04   -3.544164625567515e-02   -1.298955852850126e-02; +1.337278101563931e-02   +4.947917703684699e-02   +7.012273657855478e-02   +1.059412184136437e-02   -1.036010594587140e-03   -1.345015853714958e-02; +2.942792946199171e-02   -4.652393570261201e-02   -1.562994804725538e-02   +4.073256873091703e-02   +2.621147491883930e-02   -3.765356589170348e-02; +3.289298326505390e-03   +7.463906801200720e-02   -4.182473589204959e-02   -6.200383435531028e-03   +3.149405847204668e-03   +7.592860685131093e-02; +3.760936286816652e-02   -1.235887935518063e-01   -2.634916903202615e-02   +1.114245447279088e-02   +1.344223784252218e-02   -3.682651190296632e-02; -3.965791244117989e-02   -2.735796134494058e-02   +1.016597249288837e-02   +6.069222468213073e-03   -4.881366295970208e-02   -3.378586837441275e-03; +3.225439294504166e-02   +4.686536070023670e-02   -2.157910161577670e-03   -4.558262142352744e-02   +2.059772310957711e-03   +4.140473415909816e-02; +3.951531607800984e-02   +2.203536445291968e-02   +5.582564286339953e-02   +6.961328747222827e-02   +4.509804874296395e-02   +3.293388877265054e-03; +1.321897646837767e-02   -2.745860098541075e-02   -1.800812458883884e-02   -2.882596384720976e-02   -2.204281299321781e-02   -2.914593402463531e-03];
L3_L2_iAMPA_netcon = [+5.196265039042334e-03   +1.220126156107343e-02   +4.325031996728071e-02   +4.809247480624234e-02   -2.738501189988662e-02   -1.005517254492352e-01; +3.204150381697393e-02   +5.785009847495873e-03   +1.940955750489363e-02   +6.281972360164371e-03   +3.388852162782615e-02   +1.529960382965810e-02; -2.722916020066526e-02   +6.350432907362613e-02   -4.659836311188575e-02   -2.804971655949612e-02   +2.711687227036021e-02   -6.382757985785727e-02; +2.560419633943038e-04   +3.820611497350121e-02   +6.981217950204373e-02   +6.654496863959053e-03   -9.202764896270255e-02   -2.411907377345943e-02; +7.913795012596872e-02   +2.003880542710988e-02   +8.023313099586447e-03   +4.015900347178653e-02   +2.903949195095231e-02   -9.239879432405722e-03; +9.477746940180325e-04   +8.539468350682044e-03   +4.815359644531260e-02   +4.215077261630454e-02   +5.734443621584148e-03   +1.846526006259411e-02; -8.684468070184026e-03   -3.373652266810585e-02   -5.618856726518510e-02   +6.755448296096323e-03   +1.892896449065304e-02   +5.548014337474472e-02; -2.404173480766290e-03   -4.865927045534980e-02   -3.892758713597234e-02   -6.125289355179991e-02   -4.867184372800223e-02   +4.605463884977880e-03; +1.078633190663384e-02   -3.925051448455480e-02   -4.417152213359071e-02   -3.506467363236857e-02   -6.557734650428872e-02   -2.336808290644379e-02];
L2_L3_iGABA_netcon = [+1.244410081078756e-02   +5.398525946932454e-02   +4.125772005460222e-02   -3.034981541002403e-03   -9.956178896020249e-02   -3.849712715421862e-02   -5.240491698990538e-02   -5.038272218530027e-03   -8.319152731840551e-02; +1.525138154442214e-02   +2.271490070563809e-02   -3.658566083512736e-02   +7.611120732938056e-03   +5.166729779160651e-03   +2.273179987164430e-02   -4.073802311203113e-02   -9.484040141230445e-03   +7.058877347583076e-02; -6.804588340810300e-03   -7.642962377312329e-03   +4.539668105724808e-03   -5.951603824126410e-02   -2.891641090440798e-02   -6.729833389735676e-02   +6.270701961116927e-02   -3.615043589451315e-02   -7.261413123628699e-02; +6.078590338849763e-02   +5.609221872795455e-03   -9.421765763132511e-03   -4.722696877826711e-02   +1.415234215745559e-02   +1.745669848820643e-02   -6.971445638845908e-02   -2.644841891959938e-02   -3.711070686355424e-02; -1.241474742671921e-02   -2.006816910696090e-03   +8.479452955297388e-02   +2.080022750473600e-02   -1.856087935117983e-03   -5.033192952956468e-02   +2.660564452957977e-02   +1.185885769300397e-02   +2.350803622414211e-02; +4.710779035781103e-02   +4.348998700584956e-02   -1.956933697715005e-02   +8.993305033694710e-03   -5.909273303269173e-03   -5.841003745129238e-02   -1.271488416734577e-01   -2.920976709957460e-02   -1.967154175814280e-02];
L1_L4_iGABA_netcon = [-1.079534719096016e-01   -1.839061679662595e-02   +1.185880428098441e-02   -5.218849595373339e-02   +3.184345843267863e-02   -1.434007797348772e-02   -1.290160721913805e-03   -2.173682505176509e-02   -2.131636858186640e-03; +7.356993649972676e-03   +1.791361728486263e-03   -3.636126677516720e-02   -1.651114062220934e-02   -4.726442067854347e-02   -2.291457476019017e-02   +4.482681622719064e-02   +1.834556007037558e-02   -2.429985137167553e-02; +3.696523586225545e-02   +9.885007122753692e-02   +8.765982613952683e-02   -9.998391838305929e-03   -2.793157680491314e-02   +2.476357581865538e-02   -3.691529818837263e-02   -2.463526244764289e-05   -2.241518014303899e-02; -3.553954591191592e-02   -2.432458757842922e-02   -3.434230181219701e-03   +2.967630804701639e-03   -1.502067126655274e-02   -7.684407386889395e-03   -3.405440784931760e-02   -8.522250161936626e-03   +1.404727763309343e-03; -2.901160387584625e-02   +2.626010383480241e-02   +3.898012532605077e-02   -8.748907026747801e-02   +1.793842600295402e-02   +1.695157544905862e-02   -5.187863155735842e-02   +2.021634937342244e-02   -6.935525891587591e-02; -3.260172178279026e-03   -1.922388916487512e-03   -7.649002917257746e-03   -3.402744274077481e-02   +6.593360415173548e-02   +3.522216320944972e-02   -5.466604449675070e-02   +4.154439161109136e-02   -7.001165714259616e-02; -2.685645666320226e-02   +8.333911633906796e-03   +1.721156104276260e-02   -2.650854048052732e-02   +2.294086226930713e-02   +8.234364319768279e-03   +5.653970778022401e-02   +4.876248269884227e-02   -3.489999088323154e-02; -9.536189607580937e-03   +4.388800523329090e-02   -4.669592612475128e-02   -1.492435605688533e-02   -1.839378564150029e-02   -4.215008622422585e-02   -4.627057157215669e-02   +7.903863295145259e-02   -1.333018989928304e-03; +2.563189700479573e-02   +5.630622846358563e-02   -1.151497892018761e-02   -1.556324643598361e-02   -4.109029597671753e-02   -1.413630397921499e-02   -1.428707473345063e-02   -2.233632824288699e-02   +4.390996280024288e-02; +1.727307522704295e-02   -8.229001599902133e-02   -8.700171758554653e-03   -5.671255032773223e-02   -1.542316241314986e-02   +4.529507501733515e-02   +4.773683296787207e-03   -6.590224966755631e-02   +3.522011202851292e-02; -5.927392314623051e-03   +5.539698446474245e-02   -1.811021914866046e-02   -6.934957561740923e-02   +2.292482211961218e-02   +9.481151827995225e-02   +1.060174912295839e-01   -1.389203100400039e-02   +9.203310855101861e-02; -2.034982336675605e-02   -1.545321960406698e-02   +8.849878786598687e-03   -9.521750815491975e-03   -1.898114931592511e-03   -1.225456473540278e-02   -8.878622013131478e-02   -7.404499968710349e-02   +2.831401176867939e-02];
L4_L1_iAMPA_netcon = [+3.449840568688856e-02   -2.564380612631584e-02   +2.815996004191413e-02   +7.452915022839013e-02   +1.251553640903961e-02   -6.815140918255616e-02   -2.841053443194851e-02   +6.606884438284412e-02   +6.233651563592701e-02   -1.216332655461658e-02   +3.787216328796483e-02   +2.234397965552524e-02; +6.640971427401754e-02   -4.101984471158458e-02   +4.984207693366402e-02   +8.522720857247862e-02   +4.050329168943050e-02   +1.053310250608285e-01   +6.235238368778638e-02   -6.294718201992655e-02   -7.393205920353864e-02   +1.378624979563531e-02   -5.123959956069783e-02   -2.550505385742334e-02; +1.700813073876425e-03   +1.704520462500253e-02   +4.447899417066747e-02   +2.182489721419277e-02   +1.304181553274165e-02   +4.624588069193591e-02   -2.822668979356776e-02   -7.224796171189470e-02   -3.447135574475470e-02   +5.248921337334531e-02   +5.932171689301206e-02   -4.348371134610080e-02; -4.610563434838885e-02   +7.817639583301107e-03   +1.384141386929839e-01   +2.623935732335881e-02   -2.454185428031641e-02   -5.844307115432275e-03   +3.424864537308994e-02   -3.740544684724205e-03   -1.988543716182076e-03   +3.582059989590197e-02   +5.822651297886678e-02   -5.373674823805436e-02; +3.679058916569165e-02   -7.968237632327839e-03   -7.515135221637753e-02   +3.728271442753841e-02   +7.431748759716375e-03   -6.302583031494643e-02   -1.361584106444825e-02   -7.765911087074523e-02   +2.749086972120446e-02   -9.088489623652021e-03   -9.940900083399385e-03   -2.789944053446070e-02; -2.860276271090579e-02   -2.249798409837868e-02   -2.620102651225956e-02   +1.249302729980825e-02   +4.690408185883162e-02   -3.595136557647271e-02   +2.010344367814683e-02   +1.811722263204298e-02   +4.571183901192917e-02   +4.846044242310044e-02   +7.561301604115950e-02   +2.192966282128813e-02; -2.225182755913775e-02   -2.538861784925358e-02   +2.190207063828098e-02   -5.991593457258625e-02   +3.110128891644503e-02   +1.710121310035820e-02   +1.651500930553437e-02   +5.887617471897776e-02   -6.318378830966360e-02   -1.906008778248813e-02   +9.676412860831894e-02   +2.586983430752197e-02; +2.364224202060090e-02   +1.533107502739589e-02   -5.428724023043582e-02   +1.890746908750097e-02   -1.119873999736001e-02   +8.269430589149113e-04   +1.284812698671318e-02   +3.506348007745605e-02   -1.667870893158740e-02   -3.560406811299685e-02   -1.269556267362210e-02   -1.350506835625373e-02; +2.931179266212502e-02   -6.156243493314034e-02   -6.126392687335586e-02   +4.544382798635382e-02   +2.765061950305637e-02   -3.565980449784495e-03   -1.856186647832627e-02   -4.847861292767373e-02   +7.287231751957730e-03   +2.408217416612841e-02   -5.242120120822689e-02   +9.041831462864450e-03];
L1_L3_iAMPA_netcon = [-7.741506154058246e-03   +3.217974890042097e-02   -1.968104384695838e-02   -4.419039914967721e-03   +2.680146068418690e-02   -6.749571887507590e-02   +4.230300364036223e-02   +7.064244468040240e-02   +8.989999032854031e-02; -5.784120237482223e-02   -5.137194918129136e-02   +1.258183925319763e-02   +6.016533695808661e-02   -3.275225531825018e-02   +3.123104001551441e-02   -4.801180913927737e-02   -2.905596949823259e-02   +9.279422823157560e-03; +2.296562227548187e-02   +2.001672666637429e-02   -5.756323179328532e-04   +1.001853093608201e-02   +5.578540432550005e-02   -1.510996520129030e-02   +7.114013370962097e-02   -1.149938871820038e-02   -3.533734682676311e-02; +3.944037787525556e-02   -5.307901297565528e-02   -2.626358933741078e-02   +4.622911234370273e-02   +5.556020709351418e-02   +1.688656402250267e-02   -4.084142549868500e-03   +2.068744899877387e-02   -2.290950753177055e-03; +7.405253417513867e-02   -1.421686996029559e-02   -7.739961518628685e-03   +1.120655268526463e-02   -7.612576531497168e-03   -5.175509236821837e-02   -1.534456520647980e-02   +2.778177704425965e-02   -3.044928292172257e-03; -6.634578007190407e-02   -1.526582733268710e-02   -3.391764151944408e-02   -4.618638720590192e-02   +7.077275679711539e-02   +7.218537935744125e-03   -3.303096290760646e-02   +1.311612811053749e-03   +2.663126216876904e-02];
L3_L1_iGABA_netcon = [-6.000222338078628e-02   +2.573827199811219e-02   -3.194526088054043e-02   -4.877512724499485e-02   -2.495730413751594e-02   +6.718132010759553e-02; -4.647055685439809e-02   -1.061494130391520e-01   -3.062058575195219e-02   -2.011347473750712e-02   -1.744106241558998e-02   +8.921825410732541e-03; -3.286953383030082e-02   -5.328568692445887e-02   -4.858514357848585e-02   -6.075524294272697e-02   +2.141039720741871e-02   +8.066165101818233e-02; +3.576240833456107e-02   -1.149903224071360e-02   -6.915494059920832e-02   -4.164389983027425e-02   +2.139312208092981e-02   +7.213851068632118e-03; +3.425957138021938e-04   +4.980343874436685e-02   -1.876940052536987e-03   -6.235462367542113e-02   +6.302846655594818e-02   +1.855747184094499e-02; -6.463993477486094e-02   -9.262146277468748e-03   -1.412019893797145e-02   +7.206739518991473e-02   -3.547701223770016e-02   -2.498604549808914e-02; -6.849545192043914e-03   -2.278677305933871e-02   +2.565123527697111e-02   +2.922884311963141e-02   -3.730394194052013e-02   +2.308086456332255e-02; -4.066821363883324e-02   +3.572126022083347e-02   +3.065630760923040e-02   -2.458169592812507e-02   -1.564920909442143e-02   +5.168046826964006e-02; -2.862616006623428e-02   +8.652558306210680e-03   +6.535015183055135e-02   -5.844523372226199e-03   +2.439680317209404e-02   -2.222639203787082e-02];
L5_Input1_iAMPA_netcon = [-5.232443857723333e-02   +3.443930519696208e-02   -5.355808813116066e-02   +1.578683871131707e-03   -3.875881858422166e-02   -2.406614351715810e-02];
L6_Input2_iAMPA_netcon = [-2.062616236672431e-03   +1.001465183684903e-02   +1.097519799460094e-02   -3.569025838372437e-02   +7.473015779857936e-02   +2.365138837235808e-02];
L5_L6_iAMPA_netcon = [-2.775358498991956e-02   -5.749890723760000e-02   -6.091445031665295e-02   +1.465762294705519e-02   -1.171756598078571e-02   -4.860056483343066e-02; +3.778066682930244e-02   -1.943290382680006e-02   -1.351698012179779e-02   +3.880226829379157e-02   +7.934547106171863e-02   +4.125467984811137e-02; -5.869089701348323e-02   +5.144861450504305e-02   +2.111500791729407e-02   -1.941646610733196e-02   +2.187872619981510e-02   +4.526556495802658e-02; +1.676957245324071e-02   -4.360420068600260e-02   -5.569768738273916e-02   -6.879144814481310e-02   -1.433774050059501e-02   -1.501482730558513e-02; +5.942796678298530e-03   -9.457961549194736e-03   +5.818487232489094e-02   +2.752451891794734e-02   -2.981006622798174e-02   -2.667235952586542e-02; -5.931935808330133e-02   -3.246918538361868e-02   +9.364849955806283e-03   -3.779869712997539e-02   +3.131439079560905e-02   +6.883938346931910e-02];
L4_L5_iGABA_netcon = [-4.764866160397500e-02   +9.502499829323005e-02   +5.679246874168387e-02   +2.620747906534991e-02   +2.245326447178517e-02   -3.730736911341656e-02   -8.578441936434089e-03   +4.639733512669840e-02   -1.298428797364957e-02   +2.601694303436464e-02   +3.396287178617006e-03   -9.664716504481256e-02; -4.922022127822030e-02   -1.530118513487672e-02   +5.615000704873008e-02   -8.680724051382522e-03   -3.864802293355420e-02   +2.219184638417830e-02   +3.897509048107689e-02   -1.549815178565166e-02   -2.019033443183552e-02   -3.368906389939322e-02   +2.514614877742070e-02   -3.197472233394014e-02; -2.484210825651776e-02   -4.479031430696428e-02   +1.229612981551359e-02   -1.730658304155096e-02   -4.914187494434177e-02   -3.125804384063365e-02   +3.049677908695538e-02   -7.086553131560816e-02   -6.355304920206484e-02   -4.539099747726566e-02   +3.262278480701414e-02   +6.159963783623169e-02; +6.562082044065107e-02   -2.703535148653795e-02   -8.086254233114000e-02   +2.407197808489701e-02   +2.315377653637677e-02   -6.160061534047606e-02   +2.951063626319243e-02   +1.065791548605138e-02   +2.153420135776457e-02   +6.383112306043824e-02   +3.814744664158080e-02   +1.092310982666401e-01; +7.249717779300982e-02   +1.176563226176097e-01   +3.724804400595278e-02   -3.401493940021352e-02   -2.731676584213784e-02   -4.181923405346588e-02   -1.595093424580645e-02   -4.163217850193131e-02   +1.694036503547745e-03   -2.563844167646220e-02   +1.650965590382927e-02   -7.329807541681159e-02; +1.613470215225236e-03   -3.568551008716572e-02   -3.928447169526678e-02   +7.663730772701428e-03   +5.956778430941943e-02   +3.337414877719225e-02   +2.411890555818728e-03   +2.752579420852285e-03   +3.415752239462905e-02   -1.442705466715113e-02   +1.694715629807979e-03   -2.900787211218248e-02];
L6_L4_iAMPA_netcon = [-7.567868274708242e-02   -1.100554518594659e-01   -5.788003194304107e-02   -4.644220320013386e-02   +3.022780007219261e-02   +1.740303282139889e-02; -2.034880394883298e-02   -1.158443704707057e-02   +2.772424056369929e-02   +5.995391881931527e-03   -6.235834793338682e-02   -3.516082348775355e-02; -5.975034531539115e-02   -3.493239161055899e-02   -2.054308964593565e-02   -3.062018825669356e-03   +1.303507677308139e-02   +5.985161261914457e-02; +8.655274378671016e-04   -9.679512524762574e-02   +4.402437031585451e-03   -1.520119010814171e-02   +3.183837066512062e-02   +3.488627301278796e-02; +3.645389115663561e-03   +2.263148763841081e-02   +3.076654249281863e-02   +2.128906349785568e-02   +4.438329583636871e-02   +2.678884002196651e-02; +2.001995383076832e-02   -1.991610317966341e-02   +1.270421370768503e-02   -9.303115027161721e-04   +2.674801148718096e-02   -5.378713362839548e-02; +6.603862474608507e-03   -6.207032866425600e-02   -5.977038779782191e-03   -1.547866566639567e-03   -1.583678109964432e-02   +8.550152464456039e-02; +2.833130368517582e-02   +3.831467815997795e-02   +1.156746919568366e-01   +1.930043093886749e-02   -2.138499335284212e-03   -1.610848374021029e-02; -2.047744667352881e-02   -6.845868924459123e-02   +4.254769975297583e-02   -3.541114235874621e-02   +2.349858922713424e-02   +2.614978412262425e-02; -3.358905255564415e-02   +3.630943591860391e-02   -2.886829713797940e-02   -6.788131285239032e-02   +4.890871897902491e-02   +6.849794892499608e-03; -5.565491638335258e-02   -4.854370995524904e-02   +1.301610597163809e-02   -5.505102562603929e-02   +3.374422028569009e-02   -1.288396486779581e-02; -1.573043531842593e-03   +2.043087112261276e-02   +6.557994836307451e-03   -1.810480311837454e-02   +7.674654888638721e-02   -1.950254513293938e-02];
L5_L4_iAMPA_netcon = [-4.975255507611839e-02   -6.548243704309986e-02   -1.583502896335021e-03   -7.680884038198353e-04   +4.798345050173475e-02   -3.679824883071577e-02; +2.055490032123564e-02   -4.296891411999621e-02   +2.968825872994926e-02   -5.786608067443978e-02   +6.886130083872978e-02   -1.375504427244587e-02; +3.074095214408352e-02   +8.743911333869331e-02   -6.820918894897925e-02   +5.850779215582261e-03   -6.269869519121481e-02   +2.930547477611745e-02; -1.541868375787164e-02   +7.354384386482235e-03   +2.150171513932998e-02   -2.304908692026016e-02   +8.885525065502390e-03   -1.831319400751768e-02; -4.340607850868951e-02   +3.870761709050138e-02   +1.769747490709535e-02   +4.108836304297750e-03   -5.215829700023022e-03   -5.818969897689278e-02; -3.884266843711622e-02   +3.996848936467055e-02   -6.056516568682238e-02   +1.441125738002239e-02   +4.276041647161499e-02   -2.328021480572985e-02; -2.975513270987569e-02   -5.333780564640914e-02   +2.198299072413266e-02   -7.035322330248105e-02   -4.490133512747510e-02   -1.921557934170920e-02; -2.449877046626653e-02   +4.588079718682014e-02   -2.023610054670553e-02   +2.946388926703488e-02   -6.526653342830399e-02   +4.643070998163883e-02; -6.000374791023780e-02   +6.381367924951327e-02   +1.661455786535085e-02   -1.850186746369843e-02   -3.695416122236803e-02   -6.095604633002387e-02; +6.376391178991818e-02   -3.894161477126408e-03   -2.559921377569076e-03   +2.786975357038234e-02   -3.803450496281518e-02   +6.596516642338754e-03; -3.814079687005831e-02   -3.257516909497217e-02   +8.296395497635563e-03   -3.054201696229321e-02   -2.385122139152190e-03   -5.002956526615375e-02; -2.521230224387203e-02   -2.996407948938029e-02   -4.289846539891652e-03   +3.405781869143669e-02   -7.343111985666609e-03   +2.547769752014795e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
