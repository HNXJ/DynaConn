function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+7.245838732695936e-02   -2.133830063977030e-02   -3.537350520952311e-02   +2.390413718912204e-02   +1.092192775610254e-02   +7.700700393701004e-02   -1.734962992640549e-02   +2.064661206592472e-02   -5.135753656632405e-02; +1.230305236605392e-01   -3.498081501105545e-02   -5.930897880828237e-02   +6.597731254177855e-02   -6.264502295283991e-02   -9.257861616742065e-02   -3.125249990501700e-02   -2.038597256995347e-02   +4.422294521163942e-03; +3.985965908254161e-02   -1.844072968874359e-02   -5.465033801206442e-02   -1.913782811957614e-02   -8.315605892667932e-02   +2.130459997775039e-02   -8.492032691489536e-03   -6.267272709087827e-03   +4.742707790185008e-02; -3.570481693289920e-02   -3.133416860234008e-02   -6.575459158807072e-02   -1.466070680252825e-02   -3.826856561803244e-02   +9.763577618195487e-03   +5.394472916639879e-03   +1.751914300798087e-02   +1.553221604375761e-02; -2.741705658428138e-02   -3.947699597616754e-02   -6.779090399065107e-02   -6.874648407082977e-02   -1.963109984032492e-02   +1.095243509362391e-02   +5.340954862273965e-02   +1.312985782946052e-02   -4.096666197655507e-02; -1.129058169707922e-02   -3.487642006176835e-02   +3.337431148524932e-02   +1.218799846776488e-02   -2.034944085129126e-02   -7.479998406058820e-02   -2.040666748944923e-03   +6.563070674740606e-03   -1.939913129247253e-02; +1.057276956018794e-01   +1.303442496180345e-01   -9.272083068976054e-03   +5.984206930735017e-02   +1.464055872289461e-02   +1.462396319186023e-02   -5.504095608601994e-02   +4.092683631214489e-02   +5.541604684834936e-03; +6.005898911686885e-02   -9.544885982577621e-02   +1.852443242455884e-02   +1.096494124528486e-01   +4.420591945474120e-02   -9.703429394256018e-02   +1.959737008462905e-02   +2.975084148649559e-02   +1.638770664115416e-02; -9.301875156778938e-03   +7.995791501813667e-03   +3.116306158141050e-03   +8.525957420464558e-03   -6.740056010974516e-02   +8.483109063891624e-02   +6.685870397431043e-02   +3.380801877929371e-02   -6.429671247555291e-02];
L1_L2_iAMPA_netcon = [-1.779769374554282e-02   -2.050299537172782e-02   -3.655991320994713e-02   +3.737634187226997e-02   -6.534155318033232e-02   -4.306124137231739e-02   -3.619542725703586e-03   +9.604133883331520e-02   -4.138555202179945e-02; -4.406383383720895e-02   +6.203937418187491e-02   -5.135091916446039e-02   -7.360350534281386e-02   -8.683823557643980e-04   +9.173480521456102e-03   +3.581847559700781e-02   +9.168419906564768e-03   +5.112829457707945e-02; -4.560242820995352e-02   -7.951792225895286e-02   -2.482077300066023e-02   +6.663452778685495e-03   +3.728834157656481e-02   +7.055456514292657e-02   +1.260484511422037e-01   -8.522174460243521e-02   -1.565648180913425e-02; -1.001155556066201e-01   +3.776603957873895e-02   +8.968848915747776e-02   -2.668293485250810e-03   -5.616571497016552e-02   +6.892968941549556e-02   -4.716745731471039e-02   +3.817332049057326e-02   -1.021449174743271e-01; -1.442467408727138e-03   +6.522703352582732e-03   -1.830875546632629e-02   +2.918674812060906e-02   -1.250773219669218e-02   -6.213049494942435e-02   -2.264920905633955e-02   -2.007461779298121e-02   +6.884970222866631e-02; +1.521115814345231e-02   -2.641763077986496e-02   +1.270664768500149e-02   -1.059979430258464e-02   -2.884320222684623e-02   +7.587497499167660e-02   +3.165278391939183e-02   +2.518604629126175e-02   +3.151448297594454e-02; +5.612406321422460e-02   +1.278251359919045e-01   -8.366402494611698e-02   -3.040704363937958e-02   -3.913276538057019e-02   -3.435741695788487e-02   -1.220701874967014e-02   +2.879153823878838e-02   +6.798720081687762e-02; -3.022886625438450e-02   -5.519081146173629e-02   -4.877243690106076e-02   -6.696319764482861e-02   +2.713610007581022e-02   +3.379894323359812e-03   -6.573431149331710e-02   +4.445508582707679e-02   -7.041093624501671e-02; +2.203105642836335e-02   -2.927216158433660e-02   +3.946708553091357e-02   +5.725872804839398e-02   -4.892866107341801e-03   -1.349258289204269e-02   +2.404941834680741e-02   +2.030921018654595e-02   +4.078446726785083e-03];
L2_L5_iAMPA_netcon = [+1.221420123552795e-02   -6.860166013696542e-02   -2.299032319072405e-03   +5.249049494324830e-03   +3.862040420454184e-02   -6.444100280476700e-02   +2.757632619032604e-02   -4.167955347395331e-02   +6.197197582423571e-02; -6.457568009268043e-02   -7.155696668203965e-02   +1.124886127104627e-01   +6.529066475398956e-02   +1.415038898082345e-02   +2.097444809167739e-02   -3.058288046935618e-02   +1.402231181684802e-01   +1.708312605865916e-02; +1.424360478731787e-01   -4.847499924205353e-02   +3.369339816142489e-02   +5.608020764895531e-03   +1.979660894861723e-02   +3.724294129398385e-02   -1.280748107728449e-02   -1.264272335200349e-02   +5.035988950881513e-02; -2.413406785693200e-03   +7.100760526116512e-02   +2.081021714559270e-02   +9.446995669763525e-02   +6.562929055773606e-02   -1.041978059603080e-02   -7.734292292174755e-03   -7.831810667242067e-02   +2.822236548958049e-02; -1.644534677784905e-02   -5.710194247582875e-02   +4.469024409614608e-02   -2.373550349190807e-02   +4.693466297568120e-02   +8.424387743527186e-03   +7.623561025441522e-02   +4.333930467290154e-02   +3.277307013679390e-02; -1.586569006890415e-02   -3.125709937458271e-02   -1.134030780011070e-02   +3.038392265185167e-02   +1.029284410226881e-02   +6.274863976731421e-03   +8.977865399384808e-03   +5.452603859841133e-03   +5.611557152770399e-02];
L5_L2_iGABA_netcon = [-5.379809842458756e-02   -5.091931361847930e-02   -3.495035970774536e-02   -2.819189764744828e-02   -8.061452106863685e-03   +5.357656400203260e-02; +2.574967244634236e-03   +2.181637069776306e-03   +1.120467107204914e-01   +3.794835723484108e-02   +8.603534339190280e-03   -3.136108770155761e-02; +6.318245159513403e-03   +1.983317886303859e-02   +6.008076988310984e-02   +7.483481134937264e-02   +3.326833267972982e-02   -3.339407144411195e-02; +2.626747339829579e-02   +7.657765818139650e-02   -3.983436324308620e-03   -1.505074291332902e-02   +6.357499162718155e-02   +3.864155940943290e-02; +2.019775323981731e-02   -1.056606400411234e-01   +2.320397754123594e-03   +1.760565348140737e-02   -4.317012811234028e-02   -3.432534207931663e-02; -7.736833264963996e-02   -1.465658055730685e-02   +4.339638662454985e-02   -1.054525048383123e-02   -1.439915686520481e-02   +2.883023880234908e-03; +4.383238580682181e-04   -8.842305304858047e-03   +4.237872479175567e-02   +1.964369254000208e-02   +3.529588788461574e-02   +5.107879724854060e-02; +5.879601868889770e-02   -2.712329231056963e-02   +5.542956858268129e-02   +8.843638853164290e-03   +3.649302912958705e-02   +2.888934737295117e-02; +2.624333259864624e-02   -5.646110178147518e-02   -7.471074062221306e-03   -2.479331038800945e-02   +2.255353779162262e-02   +1.118866263232715e-02];
L3_L2_iAMPA_netcon = [+8.309422851407496e-02   +1.514840796867986e-02   +5.995846945520752e-02   +5.801723541500547e-02   -2.302232747423555e-02   -5.574244772977163e-02; +5.348805584549432e-02   +5.037406005692961e-03   -3.672232135239555e-02   +3.749239600289493e-02   +4.505560500314766e-02   -3.181442768208256e-02; +2.670039535748844e-03   +8.363251241809087e-02   -4.418519474627572e-02   -3.873904836921162e-02   +8.104801184092016e-03   -3.224830730085158e-02; +4.158335345533878e-03   +3.537650916732436e-03   +2.380251791729780e-02   +9.178106455217945e-02   -8.995161149255584e-02   -2.895442662345403e-02; +8.160879903947624e-02   +2.976757386275792e-02   -4.403566790321946e-02   +2.445609486714910e-02   +2.688204339124510e-02   -6.004660396804331e-03; +3.923060685383267e-02   -5.297365477851024e-03   +5.377849911769329e-02   +1.332778109303052e-02   +1.008612310775646e-03   +2.680853604702681e-03; -4.364594859753001e-02   -2.568840520887219e-02   +4.724041836355070e-04   -3.086115248352138e-03   +1.505223016580610e-02   +7.633285755179085e-02; +3.138129320223510e-02   -7.608404516703424e-02   -4.107065628266997e-02   -4.636321040220828e-02   -3.043749489491915e-02   -4.496242431281713e-02; -1.545444369914518e-02   -8.036076180595858e-02   -6.883190609030296e-02   -6.849781576074129e-02   -8.933807533847207e-02   +3.316146691000983e-02];
L2_L3_iGABA_netcon = [-1.108298465149468e-03   +7.202718237275821e-02   +3.269695017515756e-02   +1.633294872319245e-03   -9.693773490547009e-02   +2.640105233279941e-04   -4.897362685845330e-02   -3.505776304958564e-02   -6.600016255184328e-02; -1.019519114696679e-03   +1.658111113672037e-02   -2.021354980153904e-02   +2.696764865757883e-02   +1.533312499870031e-02   -7.900614247776626e-04   -2.229343897828171e-02   -1.466444985969442e-03   +2.626317798135829e-02; +7.360531313112528e-02   +2.881865151932392e-02   +6.950963683277459e-02   -1.243127500488064e-02   -1.667983340353616e-02   -8.249563384990100e-02   +6.727233187850658e-02   -8.340035984383359e-02   -4.379068064202308e-02; +6.158361524725708e-02   -5.629110766979316e-02   -3.632246527312127e-02   -8.443762788265899e-02   -2.633508622766508e-02   +1.429458876348204e-02   -3.872521499512444e-02   -5.830267922062687e-02   -2.590007663581199e-02; +2.042122100940659e-02   -3.713819539343637e-02   +1.401969416784011e-01   +2.567037448214807e-02   -4.222358754474813e-02   -3.545335350450650e-02   +4.300964336160737e-02   +1.296714105489583e-02   +3.869490765277347e-02; +5.896392139755568e-02   +5.140744382592626e-02   -3.612876325284155e-03   +2.638963620395126e-02   -7.138709770493311e-02   -8.140810085146169e-02   -1.126144436627951e-01   -2.641923026510183e-02   -1.116085114917979e-02];
L1_L4_iGABA_netcon = [-1.188979412297028e-01   +2.858671624554024e-02   -4.836007335621088e-02   -3.464901225267213e-02   -9.680071928654013e-03   -2.747285997213067e-02   +5.166145396644534e-02   +2.705610118976649e-02   -1.561799232118265e-02; +3.909308006616151e-02   +1.463021533317563e-02   -4.637645754657968e-02   -8.649901022015667e-02   -7.526968291783720e-02   -1.156127032309540e-02   +3.770906816014448e-02   +1.820307072824557e-02   -1.038550236020619e-02; +8.462722630123203e-02   +9.044943339275827e-02   +4.805390740628071e-02   -3.033094766027539e-02   -4.449728787705384e-02   +2.199805562084464e-02   -3.174057582099263e-02   +5.053894468311017e-02   -5.038661438986983e-02; -2.279703055572678e-02   -1.567802496212310e-02   +2.448119812130381e-02   +5.392417255894016e-03   -2.558774910825433e-02   +2.121501694289566e-02   +1.801320850880232e-02   -2.621649020859648e-02   -1.179617974128399e-03; -4.053384628623232e-02   +4.781019460327479e-02   +2.210075212194058e-02   -4.618985275316811e-02   +2.033335348809210e-02   -5.845279710160644e-02   +1.958768150178052e-02   +6.852263310176522e-02   -5.865791476493550e-02; +1.271481024490803e-03   +4.509220794100500e-02   +3.259060609240853e-02   -5.858311991853467e-02   +1.008132675781888e-01   +1.389292574075918e-02   -1.081265801952852e-02   +9.677396238856398e-02   -7.002356912835932e-02; -7.308822086962150e-03   -2.676926581217652e-02   -1.196055508100287e-02   +3.055222738935635e-02   +3.445373059229653e-02   -3.694425641116054e-02   +5.842384586821706e-02   +3.456983613916058e-02   -6.169547094392295e-03; +3.947080201079166e-02   +3.807037710329034e-02   -5.072324760183759e-02   +2.688169004775205e-02   -1.477303427495287e-02   +1.096060698354360e-02   -1.530131265531214e-02   +6.751801682731730e-02   -3.062544626602276e-02; -2.505923182837796e-02   +3.291875805194705e-02   -3.518541141789221e-02   -2.736545431164635e-02   -8.365037643884684e-03   -1.957429507872878e-02   -2.391785533120915e-02   +1.147220223357249e-02   +2.229621139358186e-02; -2.929841768912898e-02   -6.360642306606729e-02   -5.683845752046320e-02   -2.532530749284425e-02   -5.595114911101230e-02   +4.171615281901948e-02   +5.589053845826984e-02   -6.628603391725497e-02   +2.787795773932109e-02; -2.733215228386627e-02   +7.595244637752503e-02   +3.264946566274848e-02   -4.894376157606418e-02   -5.619674602667742e-02   +1.152042467335622e-01   +1.071506149783089e-01   +6.252562586400258e-02   +7.069722134692412e-02; -3.383046780646810e-02   +2.927544783005743e-02   -1.721951710335906e-02   +3.351290971619187e-03   +2.898783978700551e-02   -3.869738649659019e-03   -8.119347145279422e-02   -5.582710905038940e-02   +4.662122885893272e-02];
L4_L1_iAMPA_netcon = [+4.500657159627772e-02   -3.125608680054469e-03   +2.576960208920737e-02   +4.184246663991251e-02   +4.533495785281446e-03   -5.185336467425471e-02   -2.493645422442639e-02   +6.242503118306257e-02   +1.140925082237983e-01   -5.190004567885844e-03   +2.177337072194954e-02   -1.080806592028757e-02; +6.980774553458241e-02   -4.412333393545055e-03   +8.659434042669464e-02   +6.149712717627311e-02   +4.201909709882482e-02   +9.238102252965893e-02   +3.142252646466919e-02   -2.045992758428371e-02   -1.032877388963427e-01   +1.142299206089814e-02   -1.450450986241892e-02   -3.155462809653283e-03; +3.329056352165258e-02   +1.463926848623235e-02   +6.970045888748871e-02   -2.978075171306904e-02   +6.001834613709722e-02   +2.963637981490003e-02   +1.303724298647663e-02   -5.804621007402555e-02   -5.086953636121148e-02   -1.510992541460266e-02   +4.291877921483118e-02   +5.695552012951000e-03; -3.190594065364250e-02   -7.922242754337055e-02   +1.458332541794457e-01   +6.264967421139418e-02   -1.038181979851349e-01   +1.362769777656538e-02   +1.846207202341842e-02   +1.326445991782179e-02   +1.302133598448445e-03   +4.607236154707863e-02   +4.143770053886186e-02   -2.435514016822640e-02; +1.370685761377024e-02   +1.560955143417970e-02   -3.510139364518571e-02   -2.021227899192437e-03   -2.870756405188246e-02   -9.895104622410014e-03   -8.977390863313522e-02   -6.311943457078312e-02   -1.767555816161108e-03   +1.376907735157177e-02   -9.410422690637334e-03   -1.738820754418746e-02; +1.266558884663953e-02   -2.931663359282262e-02   -3.914930361834595e-02   +7.650463596123196e-03   +6.795608232632447e-02   -2.788106297096460e-02   -5.512647375287477e-03   +1.087619018230061e-02   +1.033292538557544e-01   +3.164138314890308e-02   +3.195228917826521e-02   +1.734767097569499e-02; -2.753864760633232e-02   -5.365416568481010e-02   -3.660033151053612e-03   -1.019292972811221e-01   +6.879578215883610e-02   +5.207070106724177e-02   +2.368650100756671e-02   +3.418345923990562e-02   -1.102723460816941e-01   +3.002291317756968e-02   +8.891797144427983e-02   -4.392531590715704e-02; +2.546377386808318e-02   +5.835935972672780e-03   -1.037914261080583e-01   +9.595229252388527e-03   -7.626792891092246e-02   +2.109275585098285e-02   -4.359410218125302e-03   +2.458606983135570e-02   -6.320134809742332e-03   -7.493988561660631e-02   -7.316206079471768e-02   -3.284715185555908e-02; +3.891401024462478e-02   -4.633048489481446e-02   -6.161294579101713e-02   +7.135570365671839e-02   +8.555543390758907e-02   +2.004454140328915e-02   +1.096242013706497e-03   +1.430470610523965e-02   +2.005379319361218e-02   -6.303944764536017e-04   -3.421810437848094e-02   -1.392986316890061e-02];
L1_L3_iAMPA_netcon = [+7.989021293690500e-04   +4.299335557468265e-02   -5.288737215899016e-04   +7.798528166437519e-04   +6.474985369704818e-03   -4.421289118216549e-02   +5.212818397894431e-02   +4.121271485280462e-02   +1.016971892121147e-01; -3.028159179112848e-02   -2.309523002816264e-02   +5.522868909374205e-02   +3.407743695689001e-02   -2.679028894610644e-02   +3.194460191568700e-02   -6.734038475538726e-02   -1.449988286128279e-02   +2.670267434585815e-02; +3.157391651667847e-02   -1.902694228724106e-04   -6.200445445177259e-03   -4.828294164352973e-02   +2.240378536330834e-02   +6.101418455640020e-03   +9.077946277514612e-02   +2.412229774352237e-02   -3.958739240687724e-02; +7.208648687938956e-03   +9.300607779239951e-03   +1.127587012799568e-02   +1.537338739436284e-02   +6.713882417643874e-02   +1.417445665943208e-02   -4.304675185852390e-02   +3.074833219245498e-02   +3.352628752132356e-02; +5.442678853010642e-02   +3.617071405339223e-03   +1.590839177054312e-02   -2.365867685114339e-02   +5.210192466054403e-02   -6.656607187445975e-02   +1.361629262580547e-02   +1.152787358301469e-02   -2.314074804750632e-03; -7.751518493173840e-02   -4.435968251693243e-03   -4.551651498644255e-02   -1.308167553112731e-03   +6.200129510558475e-02   -7.489267366212539e-02   +1.612330885935854e-02   +7.287674229877708e-03   +3.973904353363814e-03];
L3_L1_iGABA_netcon = [-3.897051334184586e-02   +5.959962461834705e-03   -3.232910320143752e-02   -9.784047568269322e-02   -3.832929722289052e-02   +8.207369458805644e-02; +8.130576187341775e-04   -8.140656688210247e-02   -5.345964814266888e-02   -4.342663535856522e-03   +5.183504294463048e-02   +2.049654868918331e-03; -7.977331414683934e-03   -2.686162796251799e-02   -3.065548949873581e-02   -6.378390122042413e-02   +3.671306668127326e-02   +7.350642456226524e-02; +1.065680053973364e-01   -1.980065009831933e-02   -8.881361239310701e-02   -8.796627496863992e-03   +3.255447850924165e-02   +2.815406876782288e-02; -9.033273739147141e-03   +1.696707115416169e-02   +2.613177610867735e-02   -2.780594520284139e-02   +6.651917810213767e-02   +5.059332745440185e-03; -2.545617000207361e-02   +1.509183012950448e-02   +1.542341923292315e-02   +6.489507435499602e-02   +4.996020291925894e-03   -9.094962715736912e-03; +7.316819634531235e-03   +3.922448117970000e-02   +1.487706817646844e-02   +9.035127879703723e-03   -2.879920450752217e-02   +6.961743516397693e-02; -2.171846994297793e-02   -8.249996334292325e-04   +1.616189020778244e-02   -2.003977409989350e-02   +2.931776134921359e-02   +4.628097929089049e-02; +3.895470936929181e-02   +3.939069325695061e-02   +6.388250236541926e-02   -5.122007148384614e-02   -2.925591170372091e-02   +1.337171424461444e-02];
L5_Input1_iAMPA_netcon = [-8.760701701464815e-02   +3.640161486169036e-02   -6.616322859316735e-02   +2.609841093715570e-02   -9.913819356857874e-03   -4.529754174938853e-02];
L6_Input2_iAMPA_netcon = [-1.098573753750138e-02   -7.664622363970499e-03   -5.306877572342342e-02   -2.131737910464483e-02   +4.480542211594452e-02   +3.310970466272883e-02];
L5_L6_iAMPA_netcon = [-1.174552638766409e-02   -4.098665406015246e-02   -7.061617391669057e-02   +2.807272837204086e-02   -5.254259470201557e-02   -5.833715489652828e-02; +4.547557306224143e-02   +4.190832889008725e-02   -4.709026013779340e-03   +4.193871792352689e-02   +6.280631593761424e-02   -2.459573182344952e-02; -8.778854371826982e-02   +6.609860835510738e-02   +6.391714968458295e-02   +1.053001330728201e-02   +3.414389234457808e-02   +1.326955021328561e-02; -1.046333944213654e-02   -6.349127770040010e-02   -1.748728318025299e-03   -1.183622627125340e-01   -7.017062677798830e-02   +1.756567076976846e-02; +4.409174129023835e-03   -2.864569196100309e-02   +1.083625003040992e-01   +1.618306369303714e-02   -7.592428478148142e-02   +6.235362913663019e-02; -5.190352982909217e-02   -3.102802257328221e-02   +3.179568525498544e-02   -6.525627507440004e-02   +3.029608326777151e-02   +4.677252792719027e-02];
L4_L5_iGABA_netcon = [-3.006540046854081e-02   +1.202364550539561e-01   +6.596333484995749e-02   +8.766436842156954e-02   -3.609960664376161e-02   -4.299162579867144e-02   -5.191035134036064e-03   +2.874073001199702e-02   -1.073016235172187e-02   +2.263548071745995e-02   -3.226685525430140e-03   -1.120370036588377e-01; -6.155077784880132e-02   -2.650239939984379e-02   +1.303827626226543e-01   +3.119787721133524e-02   +2.663309466198040e-02   -6.838224509155943e-03   +6.576320637073242e-02   -7.239427460821328e-02   -5.709795551783977e-02   -4.152610468463380e-02   +1.269818410513429e-02   +4.143589417996228e-02; -4.552481607461392e-02   -5.921571199215955e-02   -1.253461680016044e-03   -4.222841351190838e-02   -4.177129082708146e-02   -2.702416633195271e-02   -3.068357657735064e-02   -1.307713334801534e-02   -5.297762502826393e-02   +2.256148224191054e-02   -2.452129525863552e-02   +2.768912356357344e-02; +6.756329974861594e-02   -3.928321939596089e-03   -1.087857910512856e-01   -4.867369498026568e-03   +2.879112444761749e-02   -6.542266200444469e-02   +8.743506164684409e-02   +4.173126699964955e-02   -3.562903369090211e-02   +5.738466068998115e-02   +3.480574404401440e-02   +1.276417335596713e-01; +5.093044954450184e-02   +1.004508577780261e-01   -2.776310344910660e-02   -1.294289684486408e-02   -3.134663452019959e-03   +1.618277797926234e-02   -1.474464322649001e-03   -6.513652945889498e-02   +5.831490247832385e-02   -5.172742885498550e-02   +6.779337451832940e-02   -2.808984227664812e-02; -4.112431523529133e-03   -3.260704185560104e-02   -2.514455855163227e-02   +4.333374770595311e-02   +8.787830565822052e-05   +1.486784310020293e-02   -4.792660777365941e-03   +1.615051631347712e-02   +6.029389991397621e-02   -5.266045131160569e-03   -2.444506037295165e-02   +2.268793246912207e-02];
L6_L4_iAMPA_netcon = [-2.417525157849707e-02   -1.505528640109922e-01   -5.052440387896112e-02   -6.275293504886775e-02   +1.211937450362289e-01   -5.955052010005249e-02; -5.348733219088814e-02   -3.825670234148067e-02   -7.610047261686313e-03   +1.907682567866885e-02   -2.611055870604359e-02   -5.015551657634678e-03; -7.641600584760019e-02   -9.775752804097282e-02   -7.620225106319822e-04   +8.688742949377687e-03   +4.152838493144575e-02   +9.754286916579619e-02; -3.485638064505786e-02   -7.145411208791631e-02   -2.553285734814568e-02   -2.273058791813741e-03   +1.893981261896630e-02   +6.800724317358720e-02; -4.485051440793818e-03   +2.966885166012170e-02   +1.426429325539220e-02   -2.243587592111791e-02   +7.416057611552052e-02   +6.603423529148375e-04; -3.572361237940237e-03   +5.005259546500190e-02   +5.269941710062503e-02   -2.591809981586956e-02   +1.028485680601309e-02   -5.900262335057359e-02; +3.613877172709509e-02   -3.017950929511066e-02   -3.985123115929592e-02   -2.763661654601741e-03   -6.439895324462837e-02   +9.304946403096867e-02; +3.273898390106275e-02   -1.017395844401126e-02   +1.674812339978158e-01   +1.279611161695885e-02   -5.224314483366482e-02   +7.825967669442106e-03; -1.603099666401085e-02   -1.318001973421801e-01   +4.357446746990604e-02   -5.515745721434366e-03   -6.720341000834323e-03   -3.245942870206631e-02; +1.387170510441347e-02   +1.404490142079697e-02   -3.686757591320337e-02   -6.481366350659944e-02   +1.465417297190028e-01   -3.181587671045842e-02; -4.481024903577568e-02   -6.450042380902882e-02   -3.614963335744956e-03   -4.512320537206262e-02   +2.380787395456870e-02   -1.302818070492644e-03; -1.311309283058529e-02   -1.998540919698098e-02   +6.143567678071798e-02   +4.696106475625357e-03   +4.549643100957657e-02   -8.469874464208629e-03];
L5_L4_iAMPA_netcon = [-6.115331535938367e-02   -1.185692790836995e-01   +5.826838861418954e-02   -3.042725645469748e-02   +7.828717409187053e-02   +8.014181083659366e-03; -1.957004900744377e-02   -3.973448096930876e-02   +6.211805473301042e-02   -3.557585215713516e-02   +7.242689013094245e-02   -3.173620732817375e-02; +3.643268038517265e-02   +7.161182895981404e-02   -6.584438787921504e-02   -1.672046436829725e-02   -5.755086697250656e-02   +8.314146725611832e-02; -3.364106278359662e-02   +6.954215664321067e-03   +6.808923732967431e-04   -2.268076742329306e-03   -7.523768989415927e-02   -2.311781713314544e-02; -4.987905461350584e-02   +6.874785699325531e-02   +1.259082546479748e-02   -5.310066042099478e-02   +2.732098686300290e-02   -5.301587900214377e-02; -7.512857006298565e-02   +7.570067779950275e-02   -2.613479778046279e-02   +3.185609534191550e-02   +1.006829090008074e-01   -3.558589890438776e-02; -1.549314192395212e-02   -2.012155680521282e-02   -4.973734641743191e-02   -5.758190729547897e-02   +9.695532712040662e-03   +1.476500172622972e-02; +1.051795501019352e-02   +8.240155854981236e-02   -4.219614620039466e-02   +7.779093448602206e-02   -2.713147893999190e-02   +6.790067365075475e-02; -4.907833436300546e-02   +5.572066834538071e-02   -1.410130146819571e-02   +1.582576629074185e-02   -3.948490228921404e-02   -4.628828281087376e-02; +6.142196284041600e-02   -7.001890518411137e-03   -1.406413717275261e-02   +3.950021295067551e-02   -2.501652543226870e-02   +4.531512783142195e-03; -5.019304011207725e-02   -6.764183598486419e-02   -2.465452850795985e-02   -3.702666227671852e-03   +1.483828346896789e-02   -6.657615583752699e-02; +2.162334182184319e-02   -2.362692245720226e-02   -8.767654484175127e-02   +2.715132681007620e-02   -1.102792860635229e-02   +4.614466713683820e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
