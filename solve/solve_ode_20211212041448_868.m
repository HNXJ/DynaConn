function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-9.563158520136882e-01   -8.966063888327263e-01   -9.062862897329742e-01   -9.017977179974889e-01   -9.141758906888989e-01   -9.329896375515047e-01   -9.505771725085023e-01   -9.698532188031429e-01   -9.336896435636388e-01; -9.482830346701385e-01   -8.821005703205682e-01   -9.441732243846304e-01   -9.190672303036569e-01   -9.224491979025299e-01   -9.729102694298557e-01   -9.454557403574471e-01   -8.694570866774496e-01   -9.883106065956597e-01; -9.675750800886703e-01   -8.928443704598492e-01   -9.400676492787672e-01   -9.097023850142154e-01   -9.027061583859267e-01   -9.455578785733194e-01   -9.315163631993533e-01   -9.658658273868447e-01   -8.682691374590739e-01; -8.901347638856468e-01   -8.934165004023994e-01   -9.215663020285255e-01   -9.712496267925854e-01   -9.417204038634071e-01   -9.063226467120873e-01   -9.529641605854113e-01   -9.691748928643076e-01   -9.913851456199169e-01; -8.957559982392960e-01   -9.881094982018178e-01   -9.818402431109096e-01   -9.084115262708238e-01   -9.875681611801203e-01   -1.000000000000000e+00   -9.278151869870389e-01   -9.754168664168537e-01   -9.926336347465482e-01; -9.593913197402317e-01   -9.722109004888601e-01   -9.839952733897219e-01   -9.330124527960275e-01   -9.264082206404590e-01   -9.221183028625245e-01   -8.721720845453230e-01   -9.164509824146436e-01   -9.949641797482949e-01; -9.359098737426750e-01   -9.828298377515053e-01   -9.504431937211426e-01   -9.712321485736064e-01   -9.387099247365457e-01   -8.749373456212864e-01   -9.942484400699307e-01   -8.928096550820647e-01   -8.779837203455428e-01; -8.780088472458840e-01   -9.612903297310139e-01   -9.056201615954174e-01   -9.458592446485347e-01   -9.713287575178254e-01   -9.550138000073877e-01   -8.821197258896712e-01   -9.292790683424514e-01   -9.264292762635786e-01; -9.020084406148875e-01   -9.794164732368121e-01   -8.893102529063098e-01   -8.657352977707707e-01   -9.255577967935886e-01   -8.723586071503663e-01   -9.951775035074029e-01   -9.423305275771425e-01   -9.010807846792596e-01];
L1_L2_iAMPA_netcon = [-9.767211102767934e-01   -9.151886998414924e-01   -8.660492607719585e-01   -9.262261884584532e-01   -9.475660210679415e-01   -8.831748000946983e-01   -8.646763034904260e-01   -9.970763637454717e-01   -8.894510322402349e-01; -8.803112474718454e-01   -9.530778609282065e-01   -9.265830269346157e-01   -9.845634323188601e-01   -9.360113005039548e-01   -8.793423607644533e-01   -8.910271289117808e-01   -8.964808464469063e-01   -9.031232622149398e-01; -8.685376988075428e-01   -9.462611518665177e-01   -9.110792279060846e-01   -8.977280346941674e-01   -9.207367807128348e-01   -9.059611762429082e-01   -9.428453485477549e-01   -9.845640402068409e-01   -9.806929209975342e-01; -9.715664554513304e-01   -8.781164898124642e-01   -9.583243445240133e-01   -9.689766191167928e-01   -1.000000000000000e+00   -8.938591038725290e-01   -9.346513373145010e-01   -8.656324057797615e-01   -8.879319403843741e-01; -8.838830874236137e-01   -9.785871895645729e-01   -9.149668994095027e-01   -8.892900435756481e-01   -8.704715439144091e-01   -9.367745663551634e-01   -8.900513048887814e-01   -9.295750242292684e-01   -8.757402566938143e-01; -8.808767362369471e-01   -9.969874127965666e-01   -8.936259672412463e-01   -8.913089077878009e-01   -8.805713947996144e-01   -9.964270809830675e-01   -9.613142893672116e-01   -9.421026671009661e-01   -9.598900953297640e-01; -9.065006027941294e-01   -9.597522862583654e-01   -9.539769134304056e-01   -9.875678246684751e-01   -9.000689459216065e-01   -8.956812178031274e-01   -9.068750274324183e-01   -9.683149671414305e-01   -8.751908145634153e-01; -9.353759436401714e-01   -9.080577567902013e-01   -9.927953690555161e-01   -9.980398032211383e-01   -9.182315946321806e-01   -9.583268939022974e-01   -9.674393199642676e-01   -9.014260645287512e-01   -9.504202144884648e-01; -9.002110876035330e-01   -9.859248624145330e-01   -9.013562926650904e-01   -8.639992437821031e-01   -9.471738836595189e-01   -9.695107088318723e-01   -9.503622619227656e-01   -9.120705548543737e-01   -9.316995814255483e-01];
L2_L5_iAMPA_netcon = [-9.458614778588520e-01   -9.574813584781811e-01   -8.679589614459965e-01   -9.749444348185085e-01   -9.166771029316727e-01   -9.406396243967156e-01   -9.834971662887103e-01   -9.264468465210749e-01   -8.762182034787906e-01; -8.712822698913539e-01   -8.844376422073950e-01   -8.824028143690046e-01   -9.034124889685484e-01   -9.424552760305467e-01   -9.817510368551465e-01   -9.441345117955121e-01   -9.396590700114343e-01   -9.122992497137048e-01; -8.792743136267310e-01   -8.929793231578895e-01   -9.638662073359732e-01   -8.906359278888368e-01   -9.766023976439246e-01   -9.217346251295391e-01   -9.074226543567624e-01   -1.000000000000000e+00   -9.711297526985658e-01; -9.621985844748566e-01   -9.787500719978549e-01   -9.043274101487494e-01   -8.667810114978816e-01   -9.832945298862333e-01   -9.893633349604546e-01   -9.643889487220759e-01   -8.873972185876731e-01   -9.221874216925644e-01; -8.824287493877044e-01   -9.791502373286594e-01   -9.053018865668458e-01   -9.142927722303876e-01   -8.863007711003006e-01   -9.016074402051725e-01   -9.253521906172827e-01   -9.732189040580023e-01   -9.364920654663005e-01; -8.901019157916945e-01   -9.628320154214799e-01   -9.556897647388428e-01   -9.743641485571168e-01   -9.158643113983607e-01   -8.774005125467590e-01   -9.309057407327855e-01   -9.759882867833077e-01   -9.723385356579004e-01];
L5_L2_iGABA_netcon = [-9.382708373989237e-01   -8.869914149678015e-01   -9.992880947708020e-01   -8.877145029016075e-01   -9.781592443964846e-01   -8.750268585479416e-01; -8.917700524632345e-01   -8.752766044991356e-01   -9.157447979626780e-01   -9.103251976248388e-01   -9.940337930047367e-01   -9.240204285738052e-01; -8.841743004064249e-01   -9.062735888167824e-01   -9.104738970520584e-01   -9.258020475256167e-01   -9.234478943867886e-01   -9.931777237502751e-01; -9.276094402526618e-01   -9.955829520834261e-01   -9.121698698304144e-01   -9.801179856636913e-01   -9.327244179691488e-01   -9.215743777959406e-01; -9.949896767434878e-01   -9.639227710193604e-01   -8.793478909480613e-01   -9.885042782322224e-01   -9.006579599404412e-01   -8.987105330713347e-01; -9.038146804445705e-01   -9.312106104981898e-01   -9.423752711633433e-01   -9.542387975319534e-01   -9.706680197305063e-01   -9.264204412411490e-01; -9.394276907920283e-01   -9.097056775229080e-01   -9.171057119623062e-01   -9.577934932383475e-01   -9.762386517471601e-01   -9.845979783777290e-01; -9.343728410898174e-01   -8.773574415994301e-01   -9.553932799792043e-01   -9.913761126049078e-01   -9.073758136779315e-01   -9.569651078738880e-01; -9.182312052055316e-01   -9.423733078553836e-01   -9.150170676013203e-01   -9.891602864542434e-01   -8.731630200512224e-01   -1.000000000000000e+00];
L3_L2_iAMPA_netcon = [-9.342084035507527e-01   -8.761208116900638e-01   -9.877146140243730e-01   -8.981475194454479e-01   -8.918639686350797e-01   -9.050941974181717e-01; -9.091500398603478e-01   -9.350124324408937e-01   -9.361539378889683e-01   -9.493813234410815e-01   -8.752415638948990e-01   -9.911874644487874e-01; -9.300399414809539e-01   -8.892956772092747e-01   -9.058091567673641e-01   -9.121171016564900e-01   -9.554986161859277e-01   -9.869321413320583e-01; -8.863666068460238e-01   -9.609370245002243e-01   -8.948260589707986e-01   -1.000000000000000e+00   -9.043033968267845e-01   -8.844917873916400e-01; -9.874358357930773e-01   -9.101661130076835e-01   -9.055751441478699e-01   -9.700896289756840e-01   -8.956022718227374e-01   -9.078868628937443e-01; -9.895679990959083e-01   -9.753278231917237e-01   -9.739320519027918e-01   -9.879991632009066e-01   -9.472408545351786e-01   -9.352854910690833e-01; -8.823034488355699e-01   -9.666464929706264e-01   -9.973888671502459e-01   -8.998039071849399e-01   -9.244387807531372e-01   -9.514053594530304e-01; -9.959652396413993e-01   -9.869421440115110e-01   -9.248720411586862e-01   -9.694911001472538e-01   -9.037573579785741e-01   -9.270580912690166e-01; -8.717792775249025e-01   -9.463907324178843e-01   -8.942387217244920e-01   -9.826041807732614e-01   -8.726381429868811e-01   -9.086358332567354e-01];
L2_L3_iGABA_netcon = [-9.396997911067811e-01   -9.415736731683259e-01   -9.045949690832646e-01   -9.576715705741106e-01   -9.274805674121509e-01   -8.705810804373321e-01   -9.187946286119825e-01   -9.361198618120853e-01   -9.354769715123655e-01; -9.661452043029550e-01   -9.731469114283960e-01   -9.841724408663706e-01   -1.000000000000000e+00   -8.817934654992374e-01   -8.870859882174814e-01   -8.790302046825061e-01   -9.794176615631740e-01   -9.671887990676731e-01; -9.784733765705530e-01   -9.884386690790767e-01   -8.949117516731471e-01   -8.703058099507234e-01   -8.834368058952918e-01   -9.746877832628810e-01   -8.864834802304179e-01   -9.302919997621302e-01   -9.907577948062447e-01; -9.035622692667143e-01   -9.393042350463700e-01   -8.806261862506082e-01   -9.092712180895741e-01   -9.089614620796378e-01   -9.473273235089474e-01   -8.826275471449712e-01   -9.543314462372793e-01   -9.712276423209153e-01; -9.870518529623344e-01   -8.756916903674479e-01   -9.002035531485502e-01   -9.648057413401911e-01   -8.902485983446415e-01   -8.696003412538991e-01   -9.964843503028493e-01   -9.520385674028730e-01   -9.497738019569790e-01; -9.813221256348656e-01   -8.631583133158234e-01   -9.290319528507244e-01   -9.041698275541002e-01   -8.808394306235374e-01   -9.744293854429271e-01   -9.870885721457791e-01   -9.253369561239017e-01   -9.425324358361504e-01];
L1_L4_iGABA_netcon = [-9.177110344834319e-01   -9.554707190277999e-01   -8.728825580466955e-01   -9.341000669339051e-01   -9.121283016593830e-01   -9.944261364395832e-01   -9.600679371518368e-01   -9.339756215168654e-01   -8.682080279002495e-01; -8.959396951908671e-01   -9.964773329306091e-01   -8.830244590860016e-01   -9.973344585823680e-01   -9.064288543567739e-01   -9.706623297234939e-01   -9.220719235894325e-01   -8.924295832294905e-01   -8.833617689515584e-01; -9.599399467432628e-01   -8.826168561807796e-01   -9.686978465772508e-01   -8.658746734295014e-01   -9.935644743747796e-01   -9.668091303980955e-01   -8.733843235397296e-01   -9.995439575253381e-01   -9.103695504504529e-01; -9.715243112220411e-01   -9.192899780796949e-01   -8.719854444624949e-01   -8.905934427916292e-01   -9.717555362562347e-01   -9.897734864690672e-01   -9.490452974839989e-01   -8.947936894386196e-01   -9.713969225037371e-01; -9.556196572910449e-01   -9.235585835972980e-01   -8.716779125763867e-01   -9.383568878991030e-01   -9.633817837495684e-01   -9.691105707367069e-01   -9.506338605563281e-01   -9.540404852812707e-01   -8.810323108757371e-01; -9.937136957867675e-01   -9.812553073037377e-01   -9.146291970269648e-01   -9.461425322853027e-01   -9.326732100961492e-01   -8.748421424475976e-01   -9.294834777134868e-01   -8.996055045042783e-01   -8.798241103681335e-01; -9.281123311911563e-01   -9.985642666450228e-01   -8.707469692904646e-01   -9.049727481017322e-01   -9.198757691822311e-01   -9.810565870896073e-01   -9.140810723262752e-01   -9.864222594575112e-01   -8.966728557763946e-01; -9.275483600205817e-01   -8.738135310271916e-01   -9.754111455564755e-01   -8.736909056806272e-01   -9.578562302017243e-01   -9.742937097411644e-01   -9.676147072524868e-01   -9.533359652557472e-01   -9.577380494963530e-01; -9.493809984351468e-01   -9.083689355078792e-01   -9.913692524003036e-01   -8.673125618678931e-01   -9.692409550944857e-01   -8.815324310973612e-01   -9.897395157776275e-01   -9.511037172317431e-01   -1.000000000000000e+00; -8.915123370893241e-01   -8.969419010879146e-01   -9.178847261858091e-01   -9.663849523050182e-01   -9.964161524372303e-01   -8.985529400204743e-01   -9.921263221505411e-01   -9.081356836176840e-01   -8.817564988072093e-01; -9.233371206645625e-01   -9.969155290757684e-01   -9.153331495540902e-01   -9.387235179432618e-01   -9.221863034973747e-01   -9.407712546649990e-01   -8.850558793520139e-01   -9.106881441910804e-01   -8.736649215801450e-01; -9.209799035131930e-01   -8.863447206074596e-01   -9.080614306667402e-01   -9.391125899001669e-01   -9.903289727042830e-01   -8.950892407958015e-01   -9.576675508419560e-01   -9.215654312873203e-01   -8.914483174466958e-01];
L4_L1_iAMPA_netcon = [-9.730739688818195e-01   -8.799923425988060e-01   -9.056763289511300e-01   -8.702927290815102e-01   -8.799324805659714e-01   -8.893773392553899e-01   -9.606294166795653e-01   -9.487180811905719e-01   -9.819994124335069e-01   -9.578209001645559e-01   -9.581658754239407e-01   -9.792572004782328e-01; -9.619339465494133e-01   -9.494239847051338e-01   -9.351306637889686e-01   -9.364732628552945e-01   -9.269846426109192e-01   -9.496279676383957e-01   -9.525438443246959e-01   -8.794508299720105e-01   -9.284715108740775e-01   -9.521114840103232e-01   -8.698836269522530e-01   -9.206933923501650e-01; -9.119913383758842e-01   -9.202068143469487e-01   -9.665733010620908e-01   -9.177415097638434e-01   -9.553397169431762e-01   -8.788060465260062e-01   -9.100667670516623e-01   -9.410236051407269e-01   -9.001371177414179e-01   -8.704288229610541e-01   -8.877423220564300e-01   -8.726353248012103e-01; -9.966997991005785e-01   -9.105678415684032e-01   -8.846285237741609e-01   -9.226295208175874e-01   -8.848632523174801e-01   -9.805007696196182e-01   -9.473406870090404e-01   -9.750367383549846e-01   -9.709922707717782e-01   -8.989204369796384e-01   -9.074692223380347e-01   -9.677274563508943e-01; -8.836722946799377e-01   -8.772034936399764e-01   -9.036876658373131e-01   -9.118907814201153e-01   -9.620935633278995e-01   -9.050211451840713e-01   -9.193950743078038e-01   -8.945422023331129e-01   -8.901807627511772e-01   -9.395045070413390e-01   -8.839927474807699e-01   -9.364333384217608e-01; -9.934285225575915e-01   -8.641712661007348e-01   -9.570076798279282e-01   -9.141305984962412e-01   -9.763893894383726e-01   -9.031326095609805e-01   -8.673153302827999e-01   -9.560250093534977e-01   -8.784593878285805e-01   -9.675933148723304e-01   -1.000000000000000e+00   -9.353254710086983e-01; -8.825254191688918e-01   -9.376040320913360e-01   -8.763198701460619e-01   -9.715957888985333e-01   -9.183679453146121e-01   -9.237366326320934e-01   -9.595065785194485e-01   -9.156437107418738e-01   -8.722940824229475e-01   -8.713667111351800e-01   -9.609822118833400e-01   -9.357410693497490e-01; -8.825685647304963e-01   -8.987541526601524e-01   -9.781580542968205e-01   -9.852034385531628e-01   -9.556686602170907e-01   -8.832669684085248e-01   -8.955153817573601e-01   -9.763716107498860e-01   -8.711385942557270e-01   -8.903362435554985e-01   -9.264438658733105e-01   -9.726973209770903e-01; -9.669569336860907e-01   -8.816114361780005e-01   -9.609699589345678e-01   -8.887645938993298e-01   -9.247178075929259e-01   -9.772476227332562e-01   -9.385590418435437e-01   -8.958665903533083e-01   -9.437042621289259e-01   -9.018702258643769e-01   -8.672907666818570e-01   -9.779641351954920e-01];
L1_L3_iAMPA_netcon = [-9.341334225588886e-01   -9.049275235706520e-01   -9.359508520926402e-01   -9.762806003053486e-01   -9.525103429551907e-01   -9.949632349313703e-01   -9.634867024374871e-01   -9.114096351831132e-01   -8.824883678247665e-01; -1.000000000000000e+00   -9.345270474886050e-01   -9.602742390540133e-01   -9.169449686975607e-01   -8.860603159262962e-01   -9.332575379791350e-01   -9.142929497875426e-01   -9.324209415607939e-01   -9.880396669033314e-01; -8.748185179931546e-01   -9.246890448257017e-01   -8.794965186719857e-01   -9.946286517613246e-01   -9.639148144384395e-01   -9.087489164123057e-01   -9.013837317559403e-01   -9.343077615893921e-01   -9.140941097613032e-01; -9.066234716834817e-01   -9.461682738487641e-01   -9.759810586041370e-01   -9.644120431614889e-01   -9.691541733502099e-01   -9.225239997319388e-01   -9.836397874614481e-01   -9.189604588771064e-01   -8.721521417965574e-01; -9.965595187680371e-01   -9.729773058662322e-01   -9.530567959519793e-01   -8.924787169462579e-01   -9.863125936952352e-01   -9.538524727872569e-01   -9.189212046528713e-01   -9.792566678399341e-01   -9.381076542141492e-01; -9.675731139021774e-01   -9.976078783837752e-01   -9.553946747508808e-01   -8.999210317451709e-01   -9.231870328606846e-01   -9.506124770244829e-01   -9.340376872640188e-01   -9.338632207604473e-01   -9.365022718972166e-01];
L3_L1_iGABA_netcon = [-9.634750176672738e-01   -8.733455875857857e-01   -9.765554590565492e-01   -9.387907440347908e-01   -8.745219012774798e-01   -9.507690635322845e-01; -9.530338754057744e-01   -9.805820219356338e-01   -9.454104090010124e-01   -9.902379609313405e-01   -9.998188853118248e-01   -9.509735848239427e-01; -8.755274640171580e-01   -9.212537048562174e-01   -9.374196637433098e-01   -8.676136685814031e-01   -8.757086165183021e-01   -9.100857581179660e-01; -9.759638752392016e-01   -9.401466185407572e-01   -9.793970537098564e-01   -9.119285840512369e-01   -8.738188801046789e-01   -9.467143213390913e-01; -9.565046658847254e-01   -9.844337872581475e-01   -9.305856573061335e-01   -1.000000000000000e+00   -9.730422703369129e-01   -8.757464683007952e-01; -8.993300574102404e-01   -9.927154874771221e-01   -9.228697218916868e-01   -9.896121251957147e-01   -9.639166463344536e-01   -9.735525987999425e-01; -9.711994926308964e-01   -9.235586467050361e-01   -8.880749650779497e-01   -8.841139559137464e-01   -9.935663836571812e-01   -9.603295195700705e-01; -8.685026846775563e-01   -9.944522016423146e-01   -9.884709079243923e-01   -9.037418022351349e-01   -8.785558847750767e-01   -9.316884779260380e-01; -8.967196561189740e-01   -9.839498596663191e-01   -9.883888343712406e-01   -9.041791987446768e-01   -8.879196767953936e-01   -8.726228788403886e-01];
L5_Input1_iAMPA_netcon = [-9.918065100778367e-01   -1.000000000000000e+00   -9.719998182548033e-01   -9.608944480362217e-01   -9.592237536491941e-01   -9.366988600323178e-01];
L6_Input2_iAMPA_netcon = [-8.800358259159238e-01   -9.334951903354713e-01   -9.964358957909161e-01   -9.921111972378027e-01   -1.000000000000000e+00   -8.968186631322529e-01];
L5_L6_iAMPA_netcon = [-9.666547548110914e-01   -9.141056316436990e-01   -8.735211175009641e-01   -9.670930190653818e-01   -9.330290204253192e-01   -8.801914213686670e-01; -8.857804994771216e-01   -9.561437588680428e-01   -9.468399001141439e-01   -9.839866502703768e-01   -8.673580821118694e-01   -8.834033725434032e-01; -9.644765651794617e-01   -9.434747577451624e-01   -8.919185426643822e-01   -9.886796398781804e-01   -1.000000000000000e+00   -8.805336592992311e-01; -9.005478598728062e-01   -8.948405779335794e-01   -8.767103595174895e-01   -9.030302711955517e-01   -9.041059208076246e-01   -9.930237606159148e-01; -8.693736800825985e-01   -9.035535308271179e-01   -9.553131710712587e-01   -9.969101244784324e-01   -8.646275038273202e-01   -8.784931449710561e-01; -9.479580092057052e-01   -9.889397851401699e-01   -9.406434479237327e-01   -9.605179054782315e-01   -9.097708382445681e-01   -9.475123030338791e-01];
L4_L5_iGABA_netcon = [-9.787044158925199e-01   -8.931699464633899e-01   -9.879335320230153e-01   -9.412562233133779e-01   -9.807914919572469e-01   -9.527143854925324e-01   -9.106255142609275e-01   -9.117115715526670e-01   -8.860360358401073e-01   -9.752377537534529e-01   -8.716492897758084e-01   -9.283356950984789e-01; -9.740652034057842e-01   -9.182317977053253e-01   -9.372096758600097e-01   -8.960511658471892e-01   -9.030986639111673e-01   -8.969471276361571e-01   -9.539832797751352e-01   -9.938924158726896e-01   -9.996606357624954e-01   -8.914373361138725e-01   -8.807003377213785e-01   -8.679499540952021e-01; -9.563543428028068e-01   -9.407472206821675e-01   -8.676052966743653e-01   -9.223921709927770e-01   -9.218731450053003e-01   -9.917320833956537e-01   -8.678926228159533e-01   -9.218925944911683e-01   -9.656037845722463e-01   -9.685666194879666e-01   -9.233423233881030e-01   -8.672875746997745e-01; -9.982583482966004e-01   -9.944402481852151e-01   -9.439674557832208e-01   -9.512134172320144e-01   -9.407895424185182e-01   -9.016505707128001e-01   -8.819116117069032e-01   -8.790912630314618e-01   -8.946860075769690e-01   -9.333247835718927e-01   -9.837322900409867e-01   -1.000000000000000e+00; -9.293062964207669e-01   -8.763526996156762e-01   -9.252894473022618e-01   -9.191347484129857e-01   -9.831346024299278e-01   -9.344219740871941e-01   -9.657250458031552e-01   -9.115138824297363e-01   -9.493303062655543e-01   -9.606857286760244e-01   -9.883081704813929e-01   -9.840553995908475e-01; -9.465713141383727e-01   -9.375307444029037e-01   -8.704187479482036e-01   -8.999742955795661e-01   -9.378525478896544e-01   -9.012772508601417e-01   -8.966571221153276e-01   -9.735103536523161e-01   -9.417684073266198e-01   -8.980805845267412e-01   -9.608279605765407e-01   -9.834901074933207e-01];
L6_L4_iAMPA_netcon = [-9.021185865024107e-01   -9.724350087359753e-01   -8.873546042859637e-01   -8.741671583286793e-01   -9.205547541627510e-01   -8.831168670048387e-01; -9.248570731680118e-01   -9.710395495317867e-01   -9.305605025434996e-01   -9.426535963584585e-01   -9.473599481209934e-01   -9.254219465629328e-01; -8.791189022085508e-01   -9.069351613343323e-01   -9.953057379704391e-01   -8.714345457444952e-01   -9.121403733601021e-01   -9.402908649851335e-01; -9.101539930793336e-01   -9.202591712286414e-01   -9.827027663202278e-01   -9.432707208625277e-01   -9.483942131595573e-01   -9.694238986864093e-01; -8.761520867427965e-01   -8.747215411487048e-01   -1.000000000000000e+00   -9.568016028640478e-01   -9.621356314100684e-01   -9.484999093675370e-01; -9.083955453575292e-01   -8.933865298884016e-01   -8.824601355283163e-01   -9.848849139737815e-01   -9.719117261531074e-01   -9.358072095153542e-01; -9.410542265288023e-01   -9.237777102010969e-01   -8.939008534446268e-01   -9.684345750578063e-01   -9.979505926971253e-01   -8.784639024659207e-01; -9.616563370127049e-01   -9.373318013058581e-01   -9.749563082681845e-01   -9.000246327670460e-01   -9.975976878378107e-01   -9.841118633893682e-01; -9.947177519534659e-01   -8.693443540815390e-01   -9.827744656332741e-01   -9.730380768746243e-01   -9.651094518711570e-01   -9.311235089953075e-01; -8.760928403078592e-01   -8.852949407613603e-01   -8.826553837295278e-01   -8.802550766705889e-01   -9.471519981156725e-01   -9.442066598634704e-01; -9.277465846512374e-01   -8.979960455256393e-01   -9.300515263760802e-01   -8.934261103224720e-01   -9.565740890478344e-01   -9.277989684973343e-01; -8.754406270992346e-01   -9.394447160119185e-01   -9.849899817010849e-01   -9.385697234074997e-01   -8.692578241713668e-01   -9.677037736751256e-01];
L5_L4_iAMPA_netcon = [-9.613610162535290e-01   -9.808119222593485e-01   -9.828413285477375e-01   -8.637378136304370e-01   -9.363651646157253e-01   -9.146156450245919e-01; -9.269537635213512e-01   -8.922065559860324e-01   -9.696845206234161e-01   -9.704940846223339e-01   -9.284500598309486e-01   -9.830029150576861e-01; -9.484306540900604e-01   -9.993262566816654e-01   -9.938772429567452e-01   -9.004243898405226e-01   -9.100643228902343e-01   -8.953719436830646e-01; -8.980079586185726e-01   -9.083343717836049e-01   -9.230440966578727e-01   -9.460731556041568e-01   -9.436642288287476e-01   -9.464567257234041e-01; -8.874229805570815e-01   -8.989037285220078e-01   -9.411440105536804e-01   -9.027000176524406e-01   -9.730106863027156e-01   -9.765946621967990e-01; -9.838750300313858e-01   -9.433953337722405e-01   -1.000000000000000e+00   -9.829527797123233e-01   -8.678484178297095e-01   -8.975721339003698e-01; -9.622586193583204e-01   -9.498050857993486e-01   -9.283716659136148e-01   -9.447737716227681e-01   -8.733217727722895e-01   -9.261191776805691e-01; -9.372931046383316e-01   -9.422108588167454e-01   -8.918978380013658e-01   -9.874764222253921e-01   -9.819635140905014e-01   -9.676276925591755e-01; -9.398768407149570e-01   -8.636386273177076e-01   -9.933648414751022e-01   -9.333190459536561e-01   -9.989172268826709e-01   -8.720022947444674e-01; -9.983309603802597e-01   -8.993147432539139e-01   -9.166857033890132e-01   -8.999999611901225e-01   -8.789489634231720e-01   -9.406281513232072e-01; -9.128832144592814e-01   -9.136481678506491e-01   -9.716384854096298e-01   -9.471393434541384e-01   -8.729909127378596e-01   -9.384927567778835e-01; -9.722515692164582e-01   -8.919512492624663e-01   -9.827869341502989e-01   -8.972906064887489e-01   -9.714962703981631e-01   -9.489737773060642e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
