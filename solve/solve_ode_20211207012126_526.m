function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.902387486746586e-01   -2.308448246889022e-01   -3.934588181997174e-01   -5.483731254315802e-01   -4.813840072604213e-01   -2.772983565140525e-01   -7.925810282401401e-01   -5.970799307389916e-01   -6.670161674715887e-01; -4.267915620832484e-01   -5.408338124192246e-01   -5.406936860266675e-01   -5.147259357758346e-01   -4.753599566848921e-01   -2.553302744899100e-01   -6.727236124613406e-01   -7.597533229434283e-01   -2.926196235147100e-01; -4.552278577011158e-01   -3.607066685999148e-01   -5.804729645600393e-01   -9.015363308871090e-01   -6.427987181726611e-01   -4.074557144323752e-01   -5.693866995551147e-01   -4.272794303839541e-01   -6.475387298350124e-01; -4.006974532383944e-01   -2.553797412979765e-01   -4.981106545828816e-01   -3.720605757228614e-01   -1.505764920846959e-01   -3.632459716019187e-01   -6.543148407797302e-01   -1.585218035816174e-01   -5.470909624461647e-01; -5.963100841103770e-01   -3.118276101835872e-01   -1.637398203536099e-01   -1.854960972408732e-01   -2.448642905795179e-01   -5.883128546224776e-01   -5.351903466816985e-01   -7.369762089989982e-01   -5.890273534924789e-01; -3.538143730584233e-01   -1.792936809495179e-01   -3.007680392362868e-01   -7.020102177741286e-01   -2.835724611849890e-01   -4.582851769327168e-01   -6.106108907517687e-01   -6.483655670787274e-01   -1.959686601961352e-01; -5.375801641974318e-01   -4.449281363654772e-01   -5.118175213337198e-01   -5.757711270739612e-01   -8.740657816240083e-01   -7.942479487096141e-01   -3.817141432443029e-01   -5.536566824761392e-01   -6.444416991535664e-01; -4.481419633503174e-01   -8.030211412367132e-01   -7.001706015628242e-01   -4.039693613255654e-01   -4.680022222582130e-01   -5.728563103629417e-02   -6.039149963879190e-01   -7.793667207121673e-01   -4.362002592817204e-01; -7.496140630524037e-01   -3.593954330169111e-01   -2.995463180658031e-01   -4.631459368570893e-01   -5.447197392851908e-01   -1.317855457145327e-02   -3.086098146340072e-01   -5.024885268472091e-01   -5.558076768062254e-01];
L1_L2_iAMPA_netcon = [-4.190438188070267e-01   -5.021022544127068e-01   -5.021949231265084e-01   -6.256109473047646e-01   -5.639015636566657e-01   -5.294417785700971e-01   -3.344409749600843e-01   -6.448627030251297e-01   -2.560907736357473e-01; -2.863686668232079e-01   -4.733727629951993e-01   -2.947880953349212e-01   -4.164476250507287e-01   -3.619095795484316e-01   -5.280784718546689e-01   -3.490170421595076e-01   -6.144892445840516e-01   -1.026614893853308e-01; -4.775535714249524e-01   -1.960837397311221e-01   -5.685019007218548e-01   -4.500582911927048e-01   -9.095693579646599e-02   -7.127621015033176e-01   -6.781773860501927e-01   -3.855317496630629e-01   -5.911607647570294e-01; -3.113514428316652e-01   -5.390198932585419e-01   -7.252777592894734e-01   -4.947006890018590e-01   -3.222890100819602e-01   -5.383302305214226e-01   -6.887622133009723e-01   -7.003786535435402e-01   -5.404345546583588e-01; -6.356860869828411e-01   -4.296851262231720e-01   -3.826233808031028e-01   -4.257440906907177e-01   -4.623527641247034e-01   -6.001657286980338e-01   -3.278240637263298e-01   -5.059605590956445e-01   -4.326209552016734e-01; -9.481833208655304e-01   -4.860698276067776e-01   -8.454726014542981e-01   +1.440573606693501e-01   -4.356223052174508e-01   -6.899231196360929e-01   -3.254309016266243e-01   -3.279885648729504e-01   -5.915069050760501e-01; -4.967314854069299e-01   -3.849150589913988e-01   -1.342132091266443e-01   -3.494141696258143e-01   -3.598053128604551e-01   -6.298918242816356e-01   -4.991448281910218e-01   -4.887307351163188e-01   -3.574231081196219e-01; -1.326052003839366e-01   -3.111232143178543e-01   -4.899945321214907e-01   -4.662949826532769e-01   -2.943766428414309e-01   -3.627069379986873e-01   -1.910966761978513e-01   -7.670981829986696e-02   -5.227026765504815e-01; -8.528315488532966e-01   -6.934880365761162e-01   -5.498928211422807e-01   -6.261779255307245e-01   -1.206915895854453e-02   -8.442853124962444e-01   -2.652436204518442e-01   -7.128299337016590e-01   -4.047416577921007e-01];
L2_L5_iAMPA_netcon = [-4.647106139960456e-01   -2.676790591664132e-01   -6.793335233577626e-01   -3.746962366848794e-01   -4.847947053090473e-01   -4.642974168912499e-01   -6.892061644175588e-01   -2.891951256066717e-01   -6.197783787310609e-01; -3.707048625714151e-01   -5.398820128242272e-01   -6.437379304369132e-01   -3.506678708785990e-01   -7.025265920716495e-01   -8.720870974646445e-01   -5.867992871684981e-01   -2.525744691982373e-01   -5.366358416016316e-01; -4.650723623670071e-01   -3.872964909667792e-01   -5.627738480762203e-01   -2.303951607357360e-01   -3.350619689557618e-01   +1.088106759890164e-02   -3.981411267735946e-01   -6.586428544584813e-01   -3.104995410387999e-01; -3.628769977640223e-01   -1.856717552925946e-01   -1.575821206938065e-01   -3.143094393156597e-01   -6.992191443051060e-01   -2.258937347623749e-01   -4.634969858811995e-01   -5.284152677022567e-01   -4.429095325199700e-01; -6.027900341840569e-01   -7.108367132084836e-01   -6.642300238945188e-01   -5.778035197120804e-01   -6.087789899938516e-01   -7.110280026754472e-01   -5.261657916533737e-01   -5.182317246527492e-01   -4.507613993075936e-01; -4.963981376519132e-01   -5.786122915507524e-01   -6.254065043548361e-01   -2.332802182912180e-01   -4.174308791193644e-01   -4.029841643606550e-01   -4.981465679992892e-01   -5.043631081093540e-01   -1.637414375295509e-01];
L5_L2_iGABA_netcon = [-4.974079917685945e-01   -4.433752085666806e-01   -8.528505089814624e-01   -5.182129552316250e-01   -5.899723378028492e-01   -4.441840403126716e-01; -5.622439073202115e-01   -3.964644766950043e-01   -5.747570853520008e-01   -6.666620713415998e-01   -4.927470307840562e-01   -5.047682776188014e-01; -4.140591710454329e-01   -2.251058013784566e-01   -5.277506125684365e-01   -3.892700074815632e-01   -8.440078977323460e-01   -4.928386769831392e-01; -1.896537016366114e-01   -4.117182943509099e-01   -1.223446155737737e-01   -3.283363411880651e-01   -2.122361938800079e-01   -4.129433482764331e-01; -4.723572574737973e-01   -3.961920058294897e-01   -3.567969696502115e-01   -4.292610196910265e-01   -7.083475077726684e-01   -2.979963841546300e-01; -3.105397408151455e-01   -4.065688200445868e-01   -1.964493576572126e-01   -6.149825328726816e-01   -4.893178937916964e-01   -7.691664086370027e-01; -3.093522046053178e-01   -5.304207667057200e-01   -4.782186053016672e-01   -3.524516684673863e-01   -1.983506305897152e-01   -1.781899727833514e-01; -7.202217168584939e-01   -2.292836241976396e-01   -1.983528258311107e-01   -4.626524696573340e-01   -4.008808471636079e-01   -5.456371199135384e-01; -6.017510690554698e-01   -7.519573235369770e-01   -6.093923954697331e-01   -2.714909477354507e-01   -2.840224996181993e-01   -4.440217670748512e-01];
L3_L2_iAMPA_netcon = [-5.576268569621363e-01   -6.560517700847165e-01   -2.655969049867188e-01   -8.591882952891736e-01   -4.387426322098510e-01   -2.604314194514082e-02; -2.921785018457498e-01   -6.638060423067813e-01   -6.101905479897589e-01   -4.251860408232738e-01   -5.021497181431760e-01   -4.170394965022334e-01; -5.421717615100945e-01   -4.894360495860521e-01   -4.115636637028248e-01   -7.146517494929692e-01   -5.241399652798402e-01   -4.815871606378205e-01; -4.213176650387435e-01   -5.703390223824916e-01   -5.183434429395908e-01   -4.663174388730206e-01   -3.018608350117338e-01   -4.639439429778767e-01; -3.954875107320655e-01   -5.238241279395481e-01   -4.197818902587427e-01   -4.929553144795346e-01   -3.297772816177963e-01   -3.712651680318113e-01; -6.938619515607172e-01   -3.385161251366769e-01   -4.347147621092676e-01   -3.657083929682067e-01   -5.443902042085893e-01   -5.076909588034136e-01; -4.873097278560239e-01   -2.799551948098613e-01   -8.001358621259967e-01   -3.251000887293098e-01   -5.555959467644070e-01   -6.101985112129511e-01; -3.436496915925608e-01   -5.198692405683714e-01   -4.936505924777222e-01   -4.392996843191384e-01   -4.860826905026356e-01   -2.294301708027778e-01; -7.988816870450816e-01   -4.717201547077507e-01   -6.341022174936313e-01   -2.973479298873086e-01   -4.133279243470556e-01   -5.630996280538569e-01];
L2_L3_iAMPA_netcon = [-4.483750432889628e-01   -3.632214756856543e-01   -5.389246883461367e-01   -4.155744125586831e-01   -5.266635992609907e-01   -7.581259518689003e-01   -4.621048632977758e-01   -6.109838528271112e-02   -2.360225205742754e-01; -1.932602175622521e-01   -6.217368921580618e-01   -4.747524901139760e-01   -4.898258362602362e-01   -3.542570341693597e-01   -6.254166069285656e-01   -4.637220139374780e-01   -4.637517771780402e-01   -5.441632864772769e-01; -1.969471327604907e-01   -6.138870713209759e-01   -5.090342019729388e-01   -3.899019318959760e-01   -4.001916618842506e-01   -7.587485767428540e-01   -4.793972175909126e-01   -4.273882638703236e-01   -6.165591391442857e-01; -2.087493101982044e-01   -5.898937104926179e-01   -5.674034054104411e-01   -4.183936217105699e-01   -4.471605193596520e-01   -5.278683656869279e-01   -7.628770332734439e-01   -5.301461999090428e-02   -3.308359704574289e-02; -2.874984675553865e-01   -7.623675490138886e-01   -6.020073484179693e-01   -2.666674126463742e-01   -4.898613042950578e-01   -3.029723728407456e-01   -5.197850210867333e-01   -3.430234533782092e-01   -6.520245395190208e-01; -1.560059064729894e-01   -1.950722888085474e-01   -1.788450077791712e-01   -5.496932995270999e-01   -3.091631349337697e-01   -5.999929080075914e-01   -8.619031838316032e-01   -3.842082366136718e-01   -7.456691037220730e-01];
L1_L4_iGABA_netcon = [-7.452211536948558e-01   -2.230172296210199e-01   -5.130383811750598e-01   -4.271020760035985e-01   -3.202930840640081e-01   -5.083731577072721e-01   -5.576240878137203e-01   -4.478131967013410e-01   -2.096653727135597e-01; -1.226374756932496e-01   -5.417837503326522e-01   -5.405392230493025e-01   -4.415812680761530e-01   -4.133992328115301e-01   -6.495305575578584e-01   -3.483805425037212e-01   -6.782712942813801e-01   -7.808862567177195e-01; -4.488715422675918e-01   -5.705364951817680e-01   -4.058634441312080e-01   -6.802602719884125e-01   -5.367441779902254e-01   -2.467007360774971e-01   -6.868625950249236e-01   -4.031476878611315e-01   -3.953444252241310e-01; -3.902219036656514e-01   -6.739466573395242e-01   -3.204720774752298e-01   -4.935447267532697e-01   -8.479389867550506e-01   -2.190685495156435e-01   -5.107402168675308e-01   -5.352360110748077e-01   -2.123166918936655e-01; -4.400674015652032e-01   -4.883622093122317e-01   -5.784107424642696e-01   -5.206166174635584e-01   -3.702331892072260e-01   -6.717273205928361e-01   -5.927575786678513e-01   -4.736575351575816e-01   -6.736129455659902e-01; -5.261944664715531e-01   -6.154780717999506e-01   -5.571495441597639e-01   -4.858757600289407e-01   -3.649539012944701e-01   -4.726276956921643e-01   -3.390396206506885e-01   -3.839816993346079e-01   -2.192492640727589e-01; -4.658256506977441e-01   -4.589817597276137e-01   -4.796747362244832e-01   -3.011191004893645e-01   -2.649303555345018e-01   -6.292758090255993e-01   -1.771864130788850e-01   -5.726947754635010e-01   -4.168029565067405e-01; -7.860392195273952e-01   -5.540080706856203e-01   -1.942348464029682e-01   -5.687433466480951e-01   -3.871748443707543e-01   -3.622541348175209e-01   -4.087879016082278e-01   -7.221980966463966e-01   -5.608248794852635e-01; -7.766681100734334e-01   -7.035466117518618e-01   -2.995188391692140e-01   -3.267170276585315e-01   -3.307755627975053e-01   -2.651506834830779e-01   -6.943048777071896e-01   -4.088406182328213e-01   -1.977144221778877e-01; -6.404888889356313e-01   -3.265585708383412e-01   -5.407214870152182e-01   -5.714779108658542e-01   -5.837338482646733e-01   -6.781273986028874e-01   -4.900636630748620e-01   -4.838200925433097e-01   +2.569670097903386e-02; -5.086500378074175e-01   -2.054201911318484e-01   -2.454413559841225e-01   -3.964167858160329e-01   -6.330467818148511e-01   -7.071490184874862e-01   -2.261249330836974e-01   -3.852579699688518e-01   -5.056696476426574e-01; -6.734658099810118e-01   -4.631891286499114e-01   -3.145190155316674e-01   -6.333442547871228e-01   -3.987598339855490e-01   -1.821722348561871e-01   -4.228487867554072e-01   -6.089902465453103e-01   -3.872425029793181e-01];
L4_L1_iGABA_netcon = [-2.396693503930275e-01   -4.214231397414693e-01   -7.547624399800618e-01   -6.122931940112134e-01   -3.771408896165251e-01   -7.345522420456171e-01   -6.201265443897077e-01   -5.101108066197360e-01   -3.685731615194892e-01   -3.127488057795451e-01   -5.136432819371884e-01   -4.757738266019491e-01; -2.766958272073605e-01   -6.774113373517140e-01   -2.563998489556412e-01   -3.989291271107385e-01   -7.001075245381935e-01   -4.006769593032002e-01   -4.942166704313253e-01   -7.657453392888542e-01   -8.402043516673141e-02   -4.052158372579401e-01   -5.695395499095739e-01   -4.773639451606210e-01; -3.796354061130837e-01   -8.077314719899288e-01   -5.251813876692694e-01   -3.128056638520166e-01   -5.582437680881294e-01   -5.716968735042662e-01   -6.313291271979565e-01   -5.519769879631630e-01   -4.226402786410089e-01   -4.016062255451276e-01   -6.014818792925954e-01   -4.069098416745214e-01; -7.036305272324878e-01   -7.654248299240232e-01   -2.642878021640854e-01   -4.161817331547530e-01   -5.457476053416831e-01   -6.196304365306284e-01   -3.439634301159436e-01   -4.051945112554866e-01   -4.239396230502234e-01   -5.508066294419821e-01   -3.276544489465182e-02   -5.734040417339794e-01; -6.728640705667619e-01   -4.465117970743104e-01   -4.042829034131729e-01   -4.254225197821667e-01   -5.053409899357734e-01   -4.961666518664196e-01   -2.297174956379234e-01   -5.132570398617413e-01   -5.353274391070859e-01   -3.811530183545683e-01   -1.170807813019944e-01   -5.619654701612682e-01; -4.975452748408866e-01   -2.118880821911426e-01   -5.193857057009014e-01   -3.956825465781016e-01   -6.450643778517871e-01   -3.064360548063992e-01   -4.276582435159514e-01   -3.457714648147250e-01   -7.207959740970450e-01   -5.375412891543422e-01   -4.306127409875122e-01   -8.816599354728681e-01; -4.273683536942676e-01   -7.257993850651524e-01   -3.860379170424517e-01   -4.234371591176888e-01   -4.940332589767712e-01   -5.412002259854479e-01   -6.732573554553019e-01   -6.719420785702080e-01   -2.012463164806706e-01   -3.063740805026839e-01   -4.126187256936642e-01   -6.405502597580329e-01; -6.314753192186038e-01   -4.603384693832029e-01   -4.745202567342487e-01   -2.755431651627801e-01   -6.485694505793761e-01   -7.297219466972746e-01   -2.890444305166273e-01   -3.995926189692794e-01   -3.370397297366066e-01   -5.626930124687189e-01   -6.650427237317071e-01   -2.814198394363850e-01; -7.625282203116152e-01   -5.005009448944088e-01   -3.402871217223580e-01   -7.407188169884252e-01   -6.097264007478300e-01   -2.984657855537030e-01   -5.866981351012973e-01   -5.016038193830181e-01   -4.796238378407684e-01   -5.507564363993318e-01   -4.959506652218723e-01   -4.379990013503402e-01];
L1_L3_iAMPA_netcon = [-4.766924399817699e-01   -3.365506304620712e-01   -5.572095204532683e-01   -6.068721437176718e-01   -8.740028608574117e-01   -6.165458837498299e-01   -4.105340857311854e-01   -5.905643470867461e-01   -3.779001811827070e-01; -5.763253640326363e-01   -9.236581701978082e-02   -2.609425173519763e-01   -3.510539873605958e-01   -5.305425615843047e-01   -5.374542019201478e-01   -2.535419230475579e-01   -7.817566924862804e-01   -5.258195235887875e-01; -4.547029696151040e-01   -3.758735238157943e-01   -5.488049557106387e-01   -2.303464053948028e-01   -3.591266066423411e-01   -8.079702491363414e-01   -1.511524506744217e-01   -7.982040349223722e-01   -6.324386942782294e-01; -2.448817382488374e-01   -4.258794861700012e-01   -4.613670281027544e-01   -6.310681915855659e-01   -3.518746317296147e-01   -1.597555262795550e-01   -4.242133346704032e-01   -6.964759376158038e-01   -3.417515971084994e-01; -5.058470996480010e-01   -5.716568615960481e-01   -5.260594295604971e-01   -5.343139915530760e-01   -6.638295379234449e-01   -1.785071820265010e-01   -5.634662119933269e-01   -1.946686029273771e-01   -5.657110443621887e-01; -6.312647694702265e-01   -3.730001585456086e-01   -5.846217923051572e-01   -6.435254337368514e-01   -5.697666260488996e-01   -2.300356282532021e-01   -4.916005853976086e-01   -4.690074266949285e-02   -6.426423002306891e-01];
L3_L1_iGABA_netcon = [-6.011703902756458e-01   -5.389251789245638e-01   -3.854497202349239e-01   -6.925621524662425e-01   -2.805763677931248e-01   -9.159119568632063e-01; -5.609424946935664e-01   -3.018147962948903e-01   -3.227608670531969e-01   -5.650737092651255e-01   -6.060963732664486e-01   -8.158855287136958e-01; -1.951540018890610e-01   -5.595478577586838e-01   -2.910760773940801e-01   -2.228672862139567e-01   -4.978002181671803e-01   -4.956707662867041e-01; -4.855957952203379e-01   -2.677075664469555e-01   -7.351945090586162e-01   -6.860940121673256e-01   -1.895137323312562e-01   -6.820496195719137e-01; -6.405730168694100e-01   -7.125217543443249e-01   -8.887881578583381e-01   -3.005829253290248e-01   -3.124341311467130e-01   -4.253818677935217e-01; -4.133066657719517e-01   -5.942214036398952e-01   -4.878613381512028e-01   -2.495444247759357e-02   -3.595141290890361e-01   -1.813090063133720e-01; -3.710818609664044e-01   -3.104443558848108e-01   -4.056267290604933e-01   -6.162589006565254e-01   -2.785904564663273e-01   -2.426508277749071e-01; -2.412326931234395e-01   -5.792350887948361e-01   -7.147554407077319e-01   -3.566502545217733e-01   -6.262550331958070e-01   -4.989933047001374e-01; -6.903815759990630e-01   -6.884530152627820e-01   -6.915992563597346e-01   -2.452984174834264e-01   -6.922833061996244e-01   -5.471999066360833e-01];
L5_Input1_iAMPA_netcon = [-4.685654914959414e-01   -4.297375151331186e-01   -5.630839953065399e-01   -3.770314231492999e-01   -5.812554397419532e-01   -7.736727146438018e-01];
L6_Input2_iAMPA_netcon = [-6.950149225076170e-01   -7.514418006143539e-01   -4.257347946041935e-01];
L5_L6_iAMPA_netcon = [-5.293518061274896e-01   -5.449638841071467e-01   -2.573979615600475e-01   -4.991364896704718e-01   -7.355073540918472e-01   -2.821239159103709e-01; -5.848137297103153e-01   -5.146649295995824e-01   -5.593625519868540e-01   -6.035422024030612e-01   -6.239680284820966e-01   -5.068264294375018e-01; -8.005563415231383e-01   -3.742478859681394e-01   -1.761785165563512e-01   -2.270048585380188e-01   -5.144813881497265e-01   -3.412100524647190e-01];
L4_L5_iAMPA_netcon = [-4.944664538130685e-01   -4.529735488800749e-01   -6.032395559741838e-01   -5.078517110505897e-01   -6.149637439011688e-01   -6.231964488921213e-01   -3.365946847920294e-01   -3.708924377316437e-01   -7.904739207187116e-01   -3.080395869862383e-01   -7.935753883998474e-01   -6.643046994002898e-01; -3.113568363366789e-01   -1.324686426373001e-01   -2.513867449778663e-01   -3.206332806577127e-01   -5.079451828411462e-01   -5.919884016189888e-01   -5.265396074681488e-01   -1.435130615992140e-01   -3.574614698950036e-01   -4.469284575229518e-01   -8.276317259094791e-01   -5.653833174571915e-01; -3.578645479021795e-01   -4.238327803804302e-01   -2.529270596152379e-01   -4.045574770560116e-01   -4.283849448127326e-01   -3.144967300293803e-01   -3.856035499354987e-01   -1.378592698859384e-01   -4.611801724140189e-01   -5.319658455011151e-01   -5.755764422951340e-01   -4.486448679065154e-01; -1.456211173561349e-01   -3.343917773765658e-01   -4.545490894521954e-01   -3.099026511404868e-01   -6.718573347122987e-01   -5.423413870479357e-01   -3.641848573845761e-01   -3.993002860727606e-01   -5.097212525402459e-01   -4.451762179280211e-01   -8.945380692191534e-01   -5.845804658018527e-01; -3.538301220630961e-01   -1.907831023704070e-01   -6.544311148455872e-01   -3.839761120650038e-01   -3.506355966201051e-01   -2.347583990585129e-01   -4.675489519536791e-01   -5.518837756762704e-01   -4.743422787980100e-01   -5.340958489268637e-01   -2.810780711676210e-01   -7.155432756843268e-03; -8.389385196095074e-01   -6.258664130394400e-01   -5.946960302884707e-01   -4.291985859302552e-01   -7.425289984952668e-01   -6.182287870154874e-01   -1.077108643650855e-01   -2.444357034776454e-01   -2.954219073445699e-01   -8.287452172451482e-01   -7.508960950126891e-01   -6.620637920860774e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
