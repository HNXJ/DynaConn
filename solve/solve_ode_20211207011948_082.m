function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.213066493362652e-01   +3.132143555985564e-01   +1.360303881909244e-01   -2.133882855451972e-01   +1.989991467863385e-01   +2.900587785876480e-01   -2.922716691697901e-01   -1.807561394118463e-01   -2.371551879455964e-01; +2.785004434246763e-01   +1.225563025513322e-02   -2.121399735995063e-01   -9.932076082962307e-02   +7.309285932005652e-02   +2.255800144670454e-01   +2.905431271685341e-02   +1.049830074026385e-01   +2.126885213628212e-01; +1.073307674873817e-02   +1.052018509095684e-01   +4.682863727282301e-02   -2.548568265557921e-01   -2.290595006055715e-01   +3.518493796227026e-01   -7.791479310696375e-02   +5.257468995840517e-01   -2.182185007660057e-01; +6.463283148814172e-02   +3.981390213821209e-01   +1.956688774309884e-01   +2.123145005917376e-02   +3.953517156482220e-01   +5.918575189689923e-01   -2.307755502642485e-01   +5.561385494193938e-01   +3.084697775226092e-01; +1.907394896191577e-01   -2.291062184552466e-02   +2.378394349188412e-01   +4.846268371346442e-01   +2.705857109767758e-01   +1.138781392660058e-01   +2.706616681990900e-01   -3.755051929009560e-02   -7.263553148816826e-02; +3.577385307861733e-01   +3.438451380160589e-01   +3.367428553169891e-01   -8.761896184313844e-02   +3.980938191336835e-01   +2.263727386018095e-01   -1.327693385432796e-01   -1.734410849459005e-02   +5.580391364674383e-01; -5.117551975789406e-03   +2.006319945984807e-01   -1.880221286962884e-01   -8.422159192534540e-02   -2.327590398643825e-01   -4.582125940297178e-02   +4.815327103442566e-01   -6.345587719633831e-03   +3.332484119525914e-02; -4.105765585602285e-02   -1.824540608265939e-01   -9.652591678859619e-02   -1.983019612499055e-01   -1.224697452302455e-01   +4.102852121755942e-01   +5.668368627458389e-02   -2.637574806090026e-01   +3.076722592544602e-01; -1.216870603724285e-01   +3.099700447473661e-01   +4.889238614806391e-01   +2.161874069083315e-01   +5.471924286194106e-03   +4.408502815525057e-01   +1.529153654086835e-01   +1.416433725470181e-01   -2.366080528406312e-01];
L1_L2_iAMPA_netcon = [+1.508780187924114e-01   -8.390375369131879e-02   -1.780480158416466e-01   -1.947643414537890e-02   -3.626146924030343e-01   +6.630719892520473e-02   +3.090138450442292e-01   +3.363427472804920e-01   +1.900739507983704e-01; +2.907985293178778e-01   -8.968651134741182e-02   +1.208932133090840e-01   +9.525196250387900e-02   +3.251477128405372e-01   -6.927855575520132e-02   +5.913799616251478e-03   +6.221558637668594e-02   +4.614667308555954e-01; +1.966924725098861e-01   +4.243887370063598e-01   +3.670850874315111e-01   +2.463153194397806e-01   +4.472362879672098e-01   -2.364782673669594e-01   +5.542618971270377e-02   +3.303882752622960e-01   +1.851511157199182e-02; +1.871797505263285e-01   +5.205269777399284e-02   -3.844038044426527e-02   +1.762015750788594e-02   +4.383302353456589e-01   +2.101173207643579e-01   -1.119624099955898e-01   +2.376552186723602e-02   -2.904317841459659e-01; -8.086423803227506e-02   -1.928158028230620e-01   +4.333886470898485e-02   +2.119892962340679e-01   +1.389189383619360e-01   +2.303741561253616e-01   +1.429333423434564e-01   -5.792411223983088e-02   +5.308316294709425e-02; -2.304042320875449e-01   -7.064862458419787e-03   -3.095607990850967e-01   +5.438661579891132e-01   +3.790922680719450e-01   -2.656942765239052e-01   +2.847769605980049e-01   +1.858544452505947e-01   -2.231482837408177e-02; -4.265481163426450e-02   +1.875724475830568e-02   +4.932801865332063e-01   +5.298027044918053e-01   +2.410901612823645e-02   -1.116182644516834e-01   -1.992438242225040e-01   -1.451413680828963e-02   +3.109155206748298e-01; +4.636902787416149e-01   +3.317111757864131e-01   -8.699456247404812e-02   +4.791721898013427e-01   +2.274652384237620e-01   +4.379224852822844e-01   +4.688322446534222e-01   +4.595278879902321e-01   -1.351360779489512e-02; -1.912396978594195e-01   -1.479225037516386e-01   +3.785969285670083e-01   -8.583290886251824e-02   +5.279210475887177e-01   -1.760075451840458e-01   +2.591814476966597e-01   +1.439690742531570e-01   +1.880285592474901e-01];
L2_L5_iAMPA_netcon = [+4.046791749884386e-01   +3.352921872737730e-01   -1.001830976930233e-01   +5.013083947802758e-01   +3.524166428584948e-01   +1.530551310499525e-01   -1.350633405250116e-01   +2.397135245943930e-01   +2.542890924773801e-02; +2.474887828553257e-01   -3.702463341662679e-02   -2.054325788986707e-01   +3.741821322674832e-01   -1.449444805971204e-01   -2.346575879606731e-01   +2.167725581614111e-01   +6.741211430032649e-02   +3.412736528405452e-01; +1.152790109403162e-01   +8.360128631990511e-02   +3.643845808493734e-02   +2.498116338629093e-01   +2.484890863376217e-01   +4.746923835041070e-01   +3.622696916965021e-01   -2.884142836813014e-01   +1.985605390641526e-01; +5.432043107065890e-01   +3.006645716664904e-01   +5.295764117317151e-01   +5.140962279818281e-01   +7.818455627606892e-02   +4.748060002333222e-01   -2.084974954619694e-01   +1.842148231237748e-01   -1.223237417299823e-01; +4.661868588730522e-02   -3.147039573444685e-03   -2.160086647232203e-01   -1.683315284659057e-01   -2.642791074269798e-01   -2.456335012476857e-01   +2.531855079421885e-03   +2.579441029715289e-02   +7.221382835663601e-02; -3.261540186232187e-02   -1.680151787206471e-01   +2.221630522975845e-01   +4.434895063908019e-01   +1.523820956827467e-01   +4.139306337129335e-01   +1.494770546907651e-01   +1.591366915759475e-01   +4.369669950007138e-01];
L5_L2_iGABA_netcon = [+2.164571901944663e-01   -1.112973437683943e-02   -1.677661747110820e-01   -5.141506093664862e-02   +8.314422383974540e-02   +2.104269962336347e-01; +2.103210713225708e-01   +4.155016668496836e-01   -3.371020833166507e-02   -5.058633639567156e-03   -2.534487661724975e-01   +1.692290407073400e-01; -3.645520685699287e-02   +5.531741803691077e-01   -2.643633819234022e-01   +3.874189742596327e-01   -1.665829108513093e-01   +2.453648605733029e-01; +3.934264365033245e-01   +3.862451828408309e-01   +5.232840631761475e-01   +5.241451786930246e-02   +2.652378293154651e-01   +3.917283939713372e-01; -1.532226758507673e-01   +6.349723525867698e-02   +4.483648380790007e-01   +3.428335110913786e-01   -3.893083295691163e-02   +5.321662657490054e-01; +2.952431340077750e-01   +7.223410049900533e-02   +2.507078247984853e-01   +9.898996285005920e-02   +4.814382904476012e-01   -1.197429618814946e-01; +5.586023785975725e-02   +2.623880534544958e-01   -4.166818618068301e-02   +4.808474090130636e-01   +4.084886527770388e-01   +3.030775260944204e-01; +2.546855925067151e-02   +3.343465243653930e-01   +5.072672705082424e-01   +5.117569505360348e-02   +1.363560037314951e-01   +1.956908310235985e-01; +9.434522881673466e-02   -2.680772623239439e-01   -1.575979703487254e-01   +2.873386399950882e-01   +1.858079454989917e-01   +4.652453618448441e-01];
L3_L2_iAMPA_netcon = [+6.961537184604738e-03   +2.273218682372511e-01   +4.749895227601039e-01   -1.728862591480056e-01   -2.542640760923705e-02   +4.143699826465316e-01; -7.179416189037219e-02   -1.063538649202915e-01   +1.444818802264364e-01   +6.781913918925978e-02   +4.383117131926365e-03   +2.676565132111051e-01; +7.683305117946401e-02   -2.657592906153399e-01   -1.487197744811951e-01   -2.156006595873173e-01   +3.079565717299919e-01   -1.991505298586931e-01; -2.855243277553970e-02   -1.194154915794530e-01   -2.728258193585337e-02   +6.813580451273038e-02   +4.213826375821321e-01   +1.130408880485480e-01; +2.287966966166093e-01   +2.177789296168784e-01   -6.844705424481629e-02   +5.317767381013282e-02   +3.243368533130654e-01   -2.627530444608795e-01; -2.576490697331864e-01   +2.941994261156848e-01   +5.091008542939156e-02   +7.174068985316867e-02   -9.160519430488520e-02   +5.192998071606300e-02; +2.167229898865711e-01   +2.822451144782440e-01   -2.563459753286989e-01   +4.791327325585634e-01   +1.944798933149353e-01   -1.275577631066676e-01; +3.097597518182065e-01   -6.844731760893129e-02   +2.027229521496246e-02   +2.272280089481887e-01   +3.017065868521046e-01   +3.398285930882856e-01; -1.551523799395208e-01   +5.578504619803715e-02   +2.448776896687368e-01   +3.248533196060071e-01   +4.141604184460824e-01   -3.445202336840852e-02];
L2_L3_iAMPA_netcon = [+4.387285614288089e-02   +2.785253744364035e-01   +3.283364447188061e-01   +3.655922001481790e-01   -1.375009130546019e-01   -3.010583873840805e-01   -1.257502645896287e-01   +5.485388220316985e-01   +3.017220701393283e-01; +6.037579833614690e-01   -1.228267961103056e-02   -2.135285103566846e-01   +7.412675402345234e-03   +3.602400035108636e-01   +1.514274965716022e-01   +3.515246539493440e-01   -2.706159873908814e-01   -6.483212830989601e-02; +2.098387912012247e-01   +1.420243867124917e-01   +1.336827842371673e-02   +6.932533333676523e-02   -1.557446824135063e-01   -3.336573310964274e-01   +1.610501197940362e-01   +4.078481315916541e-01   +2.466800815381541e-01; +2.580495773498387e-01   -3.608758506924217e-02   +2.120173588033053e-02   +3.370058553212491e-01   +1.445288270787013e-01   +5.695089621587671e-01   -9.712724696041616e-02   +4.362190964661830e-01   +5.270621448296213e-01; +4.097141846701048e-01   -3.418832814965591e-01   -1.703250699362228e-01   +5.001383887516759e-01   +1.592226286429583e-01   +3.482820128274592e-01   +1.597791687207938e-01   +3.364806734604899e-01   -2.034119620742759e-01; +4.566125613307661e-01   +4.802462694932977e-01   +1.036307706875671e-01   +1.417251399169912e-01   +1.928976650426701e-01   -5.788683138268979e-02   -1.655090288687727e-01   +5.650439739405172e-02   +7.270325328118672e-02];
L1_L4_iGABA_netcon = [-2.580269545609891e-01   +4.634690549691338e-01   -4.669800334168982e-02   +9.693195931003058e-02   +1.930807523706690e-01   +1.406090948626675e-02   -8.406430070659257e-02   +3.596492452918756e-01   +1.840459355057158e-01; +3.863496446672353e-01   -1.916531954840955e-01   +2.801994074057626e-01   +2.936707601532048e-01   +3.888716066967592e-01   +4.514224590046226e-01   +3.166145995889070e-01   +2.497804039335741e-01   +1.212182519577606e-01; +2.636901226960249e-02   +5.504144948889084e-02   +6.883343250559765e-02   -1.933646739805356e-01   +1.637815122029712e-01   +3.036841082128804e-01   -4.618083740116204e-02   +3.471645651150669e-01   +4.189286579290966e-01; +3.343596039962650e-01   -2.389445271659502e-01   +1.405158181400560e-01   +2.386482283723343e-01   -1.122294349778960e-01   +3.586001912621984e-01   -4.111859837485821e-02   -1.110784618546584e-01   +4.776975905665017e-01; +2.490736043129398e-01   +1.811032798756830e-01   -8.519972599449038e-02   +4.595116510474570e-02   +2.720130577008091e-01   +9.263315246812971e-02   -3.759015057785794e-02   +1.533906975137749e-01   -2.017551715422293e-01; +5.348535056381651e-03   +7.004866678988413e-02   +1.923265403947025e-01   +7.103403599683980e-02   +5.194128850891356e-02   +2.315917637100040e-01   +3.383706071328794e-02   -1.413974476089942e-02   +3.264556113941009e-01; +2.477646024157376e-01   +2.350714838584724e-01   +2.636864488943447e-02   +4.165383598280396e-01   +5.012843749909690e-01   +1.202105054699386e-01   +4.578220232157476e-01   +1.803121506043313e-01   +1.622220416269814e-01; -1.693453227086136e-01   +3.134435368135268e-01   +5.702919247337024e-01   +1.762944270228421e-02   +2.718864753043190e-01   +3.611949642999442e-02   +4.459410404040424e-01   -1.319151684591693e-01   -1.447603597021270e-01; -5.953825125810029e-02   -7.683649938360963e-02   +4.851336679410819e-01   +2.119486025529634e-01   +3.749911687704581e-01   +1.961656278427342e-01   -1.591359627289028e-01   +1.762937313378741e-01   +3.869675198619366e-01; -1.576363188465590e-01   +5.250563081430006e-01   -1.072379002313850e-01   +2.046278806022474e-01   +1.770738528228625e-01   -3.759452086353362e-01   -2.069157809108045e-01   -1.415087573595128e-01   +4.436106952456371e-01; -2.023003576157095e-01   +3.712521933094458e-01   +2.671817541318777e-01   +5.695396610969607e-01   +1.510431455424656e-01   -1.828325580483453e-01   +2.905678924702172e-01   -1.485863701000706e-01   -1.363381565400058e-01; +8.704553610971033e-02   +2.346329960154034e-01   +2.717244981400841e-01   -1.989847860154437e-03   +4.606766599447490e-01   +3.964278997183106e-01   +2.213865526137721e-01   -2.042933930499185e-01   +2.571401622912411e-01];
L4_L1_iGABA_netcon = [+4.294574309791473e-01   +1.467606451903976e-01   +9.630446972488392e-02   +1.774916722128955e-01   +4.508687819020127e-01   -4.574405719153160e-02   -4.892340478475907e-03   -1.575595307660390e-01   -4.657738161129894e-02   +4.021583854169423e-01   -6.415289360548391e-03   +4.263806796252252e-01; +2.078943103301313e-01   -3.064833848137278e-01   +3.848620967486928e-01   +3.146284462567308e-01   -1.275187146404272e-01   +2.335513383880769e-01   -1.340482843020567e-02   -3.344418363879422e-01   +4.071201979022601e-01   -5.622751534072162e-02   -2.028484534245161e-01   +5.724610919430412e-02; +2.940258311820326e-01   -3.237280137119232e-01   +3.933506762568290e-01   +4.048212332743112e-01   +1.451676970065595e-01   -7.079409314101576e-02   +2.357178483075035e-02   -1.253914445788373e-01   +6.257268965876790e-02   +2.746192495809824e-01   +1.906926312126639e-01   +8.736251680705408e-02; +4.193055577259362e-02   -1.201022468967534e-01   +3.327656590963888e-01   +4.475570801378956e-01   +1.935663467619633e-01   +1.699229332924575e-01   +1.278413208296399e-01   +9.839671711765489e-02   +3.899422695507221e-01   +4.537744532953589e-01   +4.416472442902333e-01   +3.316280461172851e-02; -1.337649096654662e-01   +1.750831007640456e-01   +5.215528535271059e-01   +4.377080925668371e-01   -1.207643068691755e-01   +1.797360491360725e-02   +4.163261839777009e-01   +3.674447353550527e-01   -2.530573741250586e-01   -4.754426413039987e-02   +4.655494553848448e-01   -2.193755908920263e-01; -2.055685595004393e-01   +1.545784552857191e-01   +9.048016471930737e-04   +2.946451085017808e-01   -3.832624365469363e-02   +2.905110160318716e-01   +6.038174304177629e-02   +3.633886612007560e-01   +2.170633383400648e-01   +8.732114437546362e-02   -2.444373090177830e-01   -2.318292041227915e-01; +3.323038000211038e-01   +6.163653578760264e-02   +2.837188881871440e-01   +3.030621421981630e-01   -1.002988588520690e-02   +2.900415941226871e-01   -1.265089937734271e-01   -2.412138933379542e-01   +2.154586751990604e-01   +3.168776139524379e-01   -6.833944079781187e-03   +2.100019471994644e-01; -1.654298165202214e-01   +5.176363286286013e-01   -5.891885205039846e-02   +2.706994906794865e-01   +7.877055575751729e-02   -2.716864132242590e-01   +9.422658550931148e-03   +2.295519500405976e-01   +1.750359911849768e-01   +2.497486322592056e-01   -2.278057634994027e-01   +2.891417510223775e-01; -1.919099870950104e-01   -2.662798249525598e-02   +2.164307926397820e-01   -3.343164340740377e-01   -7.363349294579472e-02   +4.394944101661488e-01   +3.211440200177295e-01   -2.407301487034319e-01   +3.218923312784933e-01   -1.598355321653371e-02   +1.881748468500935e-01   -1.156999698859848e-01];
L1_L3_iAMPA_netcon = [-8.212938903097312e-02   +2.004158472406199e-01   +7.757775787822299e-02   -2.936997765457672e-01   -1.312016969168044e-01   -7.053495909739786e-02   +3.409521706918723e-01   -1.073001411143698e-01   +4.761694892276862e-01; +1.235159169376960e-02   +5.435629267677391e-01   +4.861345037593466e-01   +4.378578735974117e-01   +3.229595879617319e-01   +2.834954093826123e-01   +4.359507087410748e-01   -1.067104474261274e-01   +1.329222022027746e-01; +4.872134826255323e-01   +4.151410929821070e-01   +3.030790426053923e-01   +4.012267053693157e-01   +2.527581350124015e-01   -1.679809630755967e-02   +4.272281768801717e-01   -1.597951509870552e-01   +2.692320986922227e-01; +1.186683715532980e-01   -1.869360039619088e-01   +1.259339388985604e-01   -6.918119213194236e-02   -1.710330100460646e-02   +3.137351043740446e-01   -4.947077418514765e-02   -2.069744390535808e-01   +8.445261459055271e-02; +2.397129269309850e-01   +1.817049291315403e-01   +2.716299316071193e-01   +5.996570613307153e-02   +8.075204957606318e-02   +5.180995564529803e-01   -2.805038603088920e-01   +4.719289661611997e-01   -1.589041866645235e-01; -2.732506110760756e-01   +6.750845300232247e-02   +1.437658033532407e-01   +2.973723248733665e-01   -2.998764236420800e-01   +1.688138437285870e-01   +6.439574650539336e-02   +4.354532986675185e-01   -2.008229130032872e-01];
L3_L1_iGABA_netcon = [+3.955254008626377e-01   +9.201685617992726e-02   +9.360443831284475e-02   -2.870663604629679e-01   +5.124165077212413e-01   -2.811712802514025e-01; +3.446889076945660e-02   +3.801685759942635e-01   -4.282459216719166e-02   +3.228449019465931e-02   -1.647415414678232e-01   -1.872139038242335e-01; +3.090629954909506e-01   +2.969575070781321e-01   +3.634427448664566e-01   +1.764629705580166e-01   -6.236263375545503e-03   +1.064819651380268e-01; +2.520672098846766e-02   +1.750406475875550e-01   -1.617920347233654e-01   -1.264692471421212e-01   +9.855438234625817e-02   -2.413487225364853e-02; +6.231805775020580e-02   +1.359962936648199e-01   -8.135272730184556e-02   +3.352960286606937e-01   +3.804407465310305e-01   -9.256135220832068e-02; +3.739448014163573e-01   +5.780153699688556e-02   +3.630498316519655e-01   +4.326383225185773e-01   +3.855706525285191e-01   +3.500408262913589e-01; +1.432555468464741e-01   +3.201721394136181e-01   +2.093970712423520e-01   -1.591691275605058e-01   +3.934276983809420e-01   +2.213636393542245e-01; +1.077084736633233e-01   +4.293985193939929e-02   -1.931807772545192e-01   +4.195634961244041e-02   -1.042489478157630e-01   +3.728268890590276e-01; +6.082778469065912e-02   -1.504834518787539e-01   -1.215575351398017e-01   +1.638572589293339e-01   -3.438387798056161e-01   +1.995425450130235e-01];
L5_Input1_iAMPA_netcon = [+4.393519075836582e-01   +2.600318570305820e-01   -9.808108397232396e-02   +5.031086856927413e-01   +6.036223262271917e-02   -3.456796513908995e-01];
L6_Input2_iAMPA_netcon = [+1.236612152916860e-01   -1.844490130973354e-01   -9.548704930909209e-02];
L5_L6_iAMPA_netcon = [+5.406572356300918e-02   -2.172861930516109e-01   +1.573125002014028e-01   +2.131083186450445e-01   -2.492868078343024e-01   +2.876339530836585e-01; +1.520685172775383e-01   +4.686686157102530e-01   +3.360605985062910e-02   +8.856988053261056e-02   -1.447275771378860e-01   +2.710101637177481e-02; -1.639767275211121e-01   +2.163680816475389e-01   +5.455601046404388e-01   +3.549175719721507e-01   +9.832561952804084e-02   +1.909391067624470e-01];
L4_L5_iAMPA_netcon = [-6.284994674951380e-02   -5.671794688169988e-02   -2.473122530538616e-01   +2.017610656829417e-01   +5.235897930826517e-02   -1.261609224345014e-01   +5.920724771043114e-01   +1.812532307767533e-01   -9.297272991881773e-02   +1.729837016148114e-01   -2.749283228945776e-01   -2.184450539045012e-01; +5.133241795655414e-01   +3.290844757507536e-01   +5.826346414628651e-01   +5.824617956906208e-02   -3.353531478440343e-03   -4.199184319307133e-02   +1.825782167393999e-01   +4.740609411983222e-01   -5.766485154246716e-02   +2.599142156922803e-01   -3.045799049010328e-01   +7.280863925597926e-02; +4.239293260906725e-01   +6.861961970517107e-02   +3.102472916309220e-01   +2.954957872163907e-01   +2.298252568779597e-01   +6.294191513276969e-02   +1.988699217996257e-01   +1.218497546484384e-01   -1.268750502332122e-01   -1.143012337037341e-02   +1.698167370463338e-01   +2.863794150849307e-01; +5.014320448242481e-01   +4.797931957700466e-02   +1.139113968497355e-01   +2.391781088001887e-01   +7.664478357382207e-02   -2.229916623940019e-01   +4.167684709015548e-01   +3.875840422152627e-01   +7.323748171757857e-02   +9.161417262173398e-02   -1.552629549170542e-01   -4.958059395755442e-02; +1.881520923810914e-01   +4.089898622812689e-01   +6.721913315362193e-02   +1.591235433527697e-01   +2.415568217371873e-01   +3.801339312674328e-01   +1.459286977143193e-01   +1.295285486304337e-01   -1.650363170267994e-01   +5.099742307335028e-02   +4.661019982709422e-01   +6.438896011352937e-01; -6.781166994804334e-02   -1.971644943725856e-01   -1.824015197782679e-01   +1.306640376513311e-01   -1.616344664222893e-01   -2.288109421221893e-02   +5.001712329243372e-01   +4.160993186957488e-01   +4.538852883410313e-01   -1.980400884783761e-01   -1.766738009401868e-01   +2.441822494809416e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
