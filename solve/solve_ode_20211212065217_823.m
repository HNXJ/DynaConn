function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-9.963624194851914e-02   +3.829517373323907e-02   +7.316512537158915e-02   -2.666409730031042e-01   -5.523776483690163e-02   -8.360254747168747e-02   +2.068750405149903e-01   -5.959986815339110e-02   -1.170012390997149e-02; +1.330306536031187e-01   +1.044278469170054e-01   +1.911282159015759e-01   +3.318511759939363e-02   +2.425720094035421e-01   -7.012151883022115e-03   +1.004859686076555e-01   +1.312785958553199e-01   -1.645293777111355e-01; -2.166464603025376e-01   +2.243676954766115e-01   -9.033532395889002e-02   +2.386576881005244e-01   -5.288617304305136e-02   +1.171410118680930e-02   +1.937568226976955e-01   -1.745368217405555e-02   +2.677677370149231e-01; -1.175511170204107e-01   +1.034551198262030e-01   +5.533385079800075e-02   +1.857178054827533e-01   +3.056420557070018e-01   +8.514145437309398e-02   +8.239826429451284e-02   -1.492647747663079e-01   +1.731072391218501e-01; +1.711691103411656e-01   -5.224739437485974e-02   +1.768261947900267e-01   +1.005159335099657e-01   +6.005103898447989e-02   -7.855596267797586e-02   +2.749245012001255e-01   -6.032602452345442e-02   -2.960406258419641e-01; +1.480438436505130e-01   +2.766918130421436e-02   -5.760613787212449e-02   -5.450068110820085e-03   -3.253099680882034e-01   +3.088797981900643e-02   +2.020977931630890e-01   +5.636560471417247e-02   +1.448653222345738e-01; +1.217501631407769e-01   +1.857359513497512e-01   +5.263456299934502e-02   +2.742977016799920e-01   -1.030811690993838e-01   -3.870733109272456e-02   +1.000611797610219e-01   -1.804389767301580e-01   +3.268850297514013e-02; -2.051907396808095e-01   +9.787296721014642e-02   +1.994456808934260e-01   +4.171291269946509e-02   +1.184083931140010e-02   -4.171358598779609e-02   +9.018211725250004e-02   -5.853461017833808e-04   +1.718327486535156e-01; +4.483582126905946e-02   -8.393395797111304e-02   -5.446501735707916e-02   +5.403955318466588e-02   +3.731923144936401e-02   +6.582316435970792e-03   +2.244306507179856e-01   -1.316001183550558e-01   +3.906163663234591e-01];
L1_L2_iAMPA_netcon = [-1.270334419041118e-02   -1.849706089628327e-01   +5.161790398018043e-02   +6.857580710091282e-02   +6.979332065983326e-02   -3.140040005018381e-01   +2.998227323713077e-02   +1.152051446674383e-01   +2.098530413966203e-01; -5.611557168675181e-03   +1.833158800523077e-01   +1.520429773110225e-01   +8.199592010371187e-02   +7.743657988912336e-02   -2.204048079268256e-01   -7.587988677336406e-02   -3.716172087732927e-02   -1.519264240668437e-01; -4.308357719852049e-02   -2.744771805760313e-01   -7.974748019861577e-02   -1.091886392645792e-01   +1.025475266084371e-01   +1.732864730608303e-01   -2.608511451180718e-01   -8.804342568849878e-02   +4.127731778082143e-04; +7.603360110078206e-02   -3.970431248436931e-02   -2.737615559750015e-02   +8.623488701855832e-02   -6.388815878631454e-02   -4.753143410570485e-02   -1.565266825649025e-01   +1.775863379529092e-01   -5.626705472106482e-02; +4.319710013185624e-02   -2.158488809696509e-01   -1.061283915610303e-02   +2.237039067916556e-01   +4.133997362274845e-02   -3.651930032083006e-02   -6.871256870675954e-02   +5.608663944390969e-02   +1.055983826363977e-01; +1.719512563464955e-01   +1.082429215465458e-02   -2.554595034871130e-02   +6.648558286068133e-03   +1.715178094780402e-02   +6.027487510759773e-02   +6.077139231061261e-02   +1.861654973309696e-01   +1.239728184050746e-01; -1.649739180676433e-03   +2.456842236346722e-03   -1.501700039283745e-02   +9.531789018617927e-03   -2.525527474027242e-02   +1.745088411267843e-02   -3.594750369008589e-02   +9.033173537905717e-02   +4.571252349811267e-02; +1.847930233717515e-01   +1.287741649988806e-01   +1.380118578272022e-01   -2.151273252793146e-04   +2.956992796535976e-01   +1.447462201728233e-01   +7.915060092987301e-02   +1.042093785902635e-01   +9.585316566434290e-02; +1.467709283766554e-01   +1.785540568767955e-01   +1.924381004599442e-01   -1.646680762309796e-01   -1.931694830804464e-02   +9.390538252048990e-03   +1.268084898042218e-01   +1.506164097083834e-01   +7.268094768578784e-02];
L2_L5_iAMPA_netcon = [+3.280675098386449e-02   -2.338274034543098e-01   -2.635475170175701e-01   +1.198140631963425e-01   +7.418895074747500e-02   +7.604765673286723e-02   +1.773093396524841e-01   +1.025484817459489e-01   -6.648550242940933e-02; +1.334921881199810e-01   -4.585880548533650e-02   -1.358585440496990e-01   +9.880646718783040e-02   +1.265355516063296e-02   +4.782100574463245e-02   +7.395053368691409e-02   +8.892187642429555e-02   +1.017644210819821e-01; +3.943609501094458e-01   +7.278643430570976e-02   +1.555310572907593e-01   -1.206933995524204e-01   +3.047663883364128e-01   +5.034522947024948e-02   -4.805104580843253e-03   +5.181304296772436e-02   -2.100677113112384e-01; +1.475152706661931e-01   +2.985072283262236e-01   +4.060507926584183e-01   -1.459142158150534e-01   +2.221304214522872e-01   -3.387674371318283e-02   -3.335748073479602e-01   -1.476166415804077e-01   +2.045129064608689e-01; +1.922036904415247e-01   +1.342887724866734e-01   -2.786697952424386e-02   -1.442326122468269e-02   +5.444114058887237e-02   +2.300627734707461e-01   +2.175267051522033e-01   -6.860192311548680e-02   +2.795731119335104e-01; -1.155576941555431e-01   +1.329358346930427e-01   +3.308460178015725e-01   +1.933671646880062e-01   +1.147419830905081e-01   +1.259238013039490e-01   +3.725539054908382e-01   +2.340069239003546e-02   -1.016917640165607e-02];
L5_L2_iGABA_netcon = [-4.960151571545009e-02   -2.768763383082270e-03   +7.980301861995012e-02   +2.800291420577736e-02   -1.227227761749432e-01   +3.931132260314996e-01; +1.934507602299854e-01   -1.431990320116519e-01   +2.234920924057907e-01   +1.311820753702338e-01   +2.141407035013319e-01   -2.648513170299851e-02; +2.672390604206721e-02   -1.780157796322395e-01   +1.498102797022702e-01   +2.022330565612560e-01   +1.669206201836304e-01   +1.191979228837716e-01; -1.670835804554023e-01   +2.455827466207806e-02   -8.050030361731407e-02   +2.561606998934591e-01   -6.530443493846033e-02   +6.713857046508476e-02; -1.572008589441685e-01   +8.303471122634354e-02   +1.169968828392772e-01   +3.850078796216860e-02   -8.515264031485278e-02   +1.378342270096642e-01; +1.359935528830595e-01   +1.175288221749292e-01   -1.942093289513963e-02   +3.523171821138906e-01   +9.271412487483437e-02   +4.491262373218832e-02; -1.656767081988397e-01   +1.293464072257073e-02   -8.969202390848001e-02   +1.402672572626661e-01   -4.454507084277742e-02   -1.433390939510842e-01; +5.679452048537523e-03   +4.910923864971483e-02   +2.047636832188349e-01   +1.943583861925705e-01   +1.439139949407811e-01   +2.610613276988752e-01; +2.478707887502443e-01   -1.329219949385130e-01   +1.643341042758941e-01   -1.265948771193926e-01   +1.435652701095122e-01   +6.672944427088877e-02];
L3_L2_iAMPA_netcon = [+3.533737802089795e-01   +1.287652313053337e-01   +1.044597500673785e-01   -6.827000107346412e-02   +7.865787697703473e-02   +8.201735128670587e-02; +2.267685433461682e-01   +4.087831674851480e-01   +8.627533126489734e-02   -5.931342220026876e-02   +3.462452380499174e-02   +2.453038892165554e-01; +1.894046461223581e-01   +1.152143777889191e-02   -2.464704782287223e-02   +2.391899969557957e-01   +1.689892248409607e-01   -2.599471110176251e-02; -2.662369285753102e-02   +2.522221482458957e-01   -3.282644605425590e-02   +1.145939845641600e-01   -7.931339063952968e-02   +7.073416495300568e-02; -2.237826499819839e-01   +8.513937208461919e-02   +1.840420172255862e-01   +1.194735438276046e-01   -1.798288411713314e-01   +8.376616499977640e-02; -1.135656719624984e-02   +1.599478060673429e-01   -2.805733417654355e-02   +9.181463595567856e-02   +2.123379719491736e-01   +1.910458336095284e-01; +1.054867472498518e-01   -1.706063908582186e-01   +3.951125950727456e-02   -1.867362553084140e-01   +1.600400754271126e-01   -1.406077730006018e-01; +8.057139022492199e-02   +2.676663650991898e-01   -3.192349968966160e-01   +1.219608914072242e-01   +1.580066474242323e-01   -1.196158299966782e-01; -2.284315561271037e-02   +1.880914006052325e-01   -1.699389511525349e-01   +8.700708373574381e-02   -1.681229804722665e-02   +1.015881222129845e-03];
L2_L3_iGABA_netcon = [+8.741076196546085e-02   +5.155487270175574e-02   +2.075022404793762e-01   -6.334105353655667e-02   -5.680621377280100e-02   +9.839557715273728e-02   +3.458924880982190e-01   +7.430301425996000e-02   -3.214994975860170e-02; -1.072171910350490e-01   -1.902386248931029e-01   +1.507889637162207e-01   -8.332959796119593e-02   +6.602222379262553e-02   +1.516381360800403e-01   +2.669766617440126e-02   +4.567174502634990e-03   -1.370326513959623e-01; -3.683806173971770e-02   -9.383839907387515e-02   +3.554142559481688e-02   +3.274921637417271e-01   -3.372525931612155e-01   +2.940096800373754e-01   -2.753377359484852e-01   +1.767379042789328e-01   +7.169724874227176e-02; +2.575836627730438e-01   +7.306688688396094e-02   -2.472640954023647e-01   +2.876667500082320e-02   +1.129920633257447e-01   +1.011546321358343e-01   +1.179524389143446e-01   +2.538297025393741e-01   +5.478366149699561e-02; -2.467707277810890e-02   -1.170966039551554e-02   -1.095464229238953e-01   -1.337040291991444e-01   -4.504682710673636e-02   -1.393978921392821e-01   -4.888495686857421e-02   -4.678171030554436e-02   -1.814027705490497e-01; +1.602650296483557e-01   +8.745967680356231e-02   +1.933691862492715e-02   -1.033299674125231e-01   -7.830116284205370e-02   +8.137321265053601e-02   +3.113047612704735e-01   +3.790700141533412e-01   +3.471182453612381e-01];
L1_L4_iGABA_netcon = [+2.647188932236182e-01   -3.336849179222785e-01   -4.001642309285600e-02   +2.612456027415689e-01   +1.086883456770333e-02   -4.654756028053952e-02   +1.593974612908371e-01   -4.629358906761641e-02   -2.610136206219859e-01; -2.915667668515350e-02   +6.837571102870892e-02   +1.770697444755447e-01   +1.584907957816195e-02   +2.411317006593908e-02   +2.187618207139609e-01   +2.088412144363451e-01   -3.627797921322481e-02   -1.330445064518586e-01; -1.342534279439686e-01   +3.498083913166127e-01   -1.549890034946723e-01   -5.818990504915583e-02   +1.889237868706394e-01   -1.437080128629929e-02   +1.655243540312824e-02   -9.986913752615836e-02   -9.332585711410805e-02; +9.388300563132176e-02   +7.121306199208410e-02   -1.921541193701209e-01   +1.066683130471554e-01   +3.617774225957420e-02   -3.839384947961696e-02   -1.769534182729010e-01   -1.095931210883167e-01   +4.229813315472850e-02; -1.315976033116787e-01   +5.466544948263434e-02   -1.719145381879664e-02   -4.032423548242546e-02   -2.325534951732201e-03   -6.951228577742631e-02   +1.090926730820961e-01   +7.261943129411383e-02   +1.195944215815286e-01; +1.852286955931069e-01   +7.622347555348671e-02   +2.481621221776992e-02   +1.866398678379915e-02   +8.182582433524888e-02   +1.737713536039656e-01   -2.785825596514175e-02   +2.189702512930172e-01   +9.623082478371671e-02; -1.335096351351742e-01   -4.774890077099473e-03   -1.599277178983183e-01   +1.795517892867066e-01   +1.541366940609285e-02   +2.416607983730355e-03   +1.782476563340261e-01   +1.707499980385994e-01   +4.798471083945280e-04; +1.214466602747250e-01   -1.675738308958711e-01   +1.367755704113792e-01   +1.224301864078751e-01   +1.685724595870013e-01   +1.637003042345957e-01   +8.034258632169516e-02   +1.246074373966113e-01   +1.748641495287993e-01; -1.260762763049681e-01   +1.413830198161225e-01   +8.503465828303670e-02   -9.794066807919308e-02   -1.197030475170116e-01   +9.304233241931174e-02   +1.611594799306884e-01   -8.449406190801714e-03   +1.702172254499107e-01; -5.357004070642891e-02   +2.762490745793474e-01   +1.355646975864848e-01   +1.388888520444252e-01   +7.761433976650828e-02   +2.114228257742838e-01   +5.845917013112673e-02   -1.973145918153651e-02   +9.000511609468242e-04; -3.206711913896476e-02   +7.771785265677916e-02   -3.479616845737787e-02   +4.262189747169118e-02   -1.511060595680554e-02   -4.709420334013757e-02   -1.984222701974322e-01   -5.538217792397514e-02   +2.292699802840384e-01; +1.226857558774753e-01   -1.835143956377298e-01   +1.598378621726884e-01   -1.295575212323430e-02   +1.981926469414665e-01   -8.519733666712945e-02   +1.286886902459296e-01   -5.165426485126868e-02   +8.243046645071837e-03];
L4_L1_iAMPA_netcon = [+2.331447949184507e-01   +1.663651491573166e-01   +4.729018699505694e-02   +3.948993232360004e-03   +7.392426364087187e-02   +5.196137464824626e-02   +9.935715262448541e-02   +1.276348260989698e-01   +6.442213230598229e-02   +1.527221404211463e-01   -3.707452940228931e-01   -4.940924922805234e-04; -3.825413873850397e-02   -3.074020739012376e-02   -1.696748605353479e-01   +8.423477919470512e-02   +4.150291105231689e-01   +4.971158942380044e-02   -1.804482668563672e-01   -2.329065826319484e-01   -2.123432237685466e-02   +2.948231101391456e-01   -6.727528231118554e-02   -3.078523537828521e-02; -2.147886182404692e-01   +3.342290325781045e-02   +1.277919964864361e-01   -8.664153068992977e-02   +2.438273860331756e-02   +1.914618618303498e-01   +1.480690319777273e-01   -3.335635148752136e-02   +6.381850794138251e-02   +3.642429380526491e-01   -1.807794440566077e-02   +2.800039633642512e-01; +3.936391779286134e-02   +9.368518468196883e-02   +2.427555120699804e-01   +1.304771780526150e-01   +4.288121263147757e-02   -9.063369052394164e-02   -8.684489716101899e-02   +1.317044798383773e-01   +1.082426927766251e-01   -1.451817085176959e-01   +1.874497916680203e-01   +1.958033998332487e-02; +2.063131848959236e-01   +6.805268594613274e-02   -1.723767440060482e-01   +1.558912248140571e-01   +2.837871650412351e-01   +4.180068904753458e-02   -5.510715364628328e-02   +5.250936838807320e-03   +1.433141401157262e-01   -1.354104900559931e-01   -2.831170999992932e-02   -1.089031233345017e-01; -3.486005507815305e-02   +1.386409389708658e-01   +3.534501689977931e-03   -3.103426251813239e-02   -7.654195986186052e-03   -7.302901220670449e-02   +1.164834959587815e-01   -2.017078653173951e-01   +6.922976261271271e-02   +3.214983916248502e-01   -1.198014595330174e-01   -1.028832205594936e-01; -1.115056073642255e-02   +9.840232321517786e-02   +1.789682117787183e-01   +3.835789589205850e-02   +2.331477018702621e-02   -3.220624211854296e-03   +1.588785012968155e-01   +3.553878404252454e-02   +1.733345024840968e-01   +2.408658582590739e-01   -7.682782790097564e-02   -1.547760862465355e-01; +1.562545275003634e-01   +6.662614235347530e-03   -2.014842620253242e-01   -1.659696013918636e-01   -4.581487577423453e-02   +2.276691447282841e-02   +2.019559006205468e-01   +1.993509924459887e-02   -1.373207762223893e-01   +1.501421228978209e-01   +2.794663441019041e-01   +6.544319770078494e-02; +4.292255498249670e-02   -2.624645475482794e-01   +1.121745116182524e-01   +1.415734589891933e-01   -4.850532591384280e-03   -1.013701219963453e-01   +2.701515043887090e-01   +8.623017549881717e-02   -2.133324640109372e-01   +6.797027730219554e-02   +3.337811597021479e-01   -5.270800470001381e-02];
L1_L3_iAMPA_netcon = [-3.053535891797774e-02   -4.165321429372467e-02   +5.996651282203196e-02   +2.960001681483481e-03   +5.400646458821741e-02   -1.471446945049107e-01   -1.732850965930858e-01   +2.147889712281716e-01   -4.153321006692770e-02; +1.864520484770648e-01   +2.178764888715352e-01   +5.389776005006330e-02   +7.489151076942950e-02   -1.907090478220230e-01   -1.465460903816356e-01   +1.565142087251485e-01   +1.871800012426697e-02   +6.376939779238215e-02; +1.443549600367214e-01   +1.474263304578915e-01   +9.463790468659770e-03   -1.310912517440377e-01   +1.958975275504975e-02   +2.232670735742831e-01   +1.068733951775862e-01   +1.284592143532249e-02   +1.566093486693018e-01; +3.997401693826851e-02   -1.773040825093455e-02   -3.197817583825138e-02   -6.886585616752113e-02   +1.636125388525395e-03   +1.727737839076376e-01   -1.126250444072104e-01   -1.280731254620890e-02   +2.513608566163169e-01; -4.779641540756564e-02   +1.990367227311503e-01   -1.188879459048750e-01   +1.115528600812362e-01   -2.244883963071269e-02   +1.384133341757981e-01   -1.989552925303511e-01   -1.599594534282907e-01   +1.531918058817922e-01; +3.821893330937919e-02   +3.156083400215967e-02   +2.781589831323988e-01   +1.428660565642438e-01   +1.165200712535885e-01   +1.728096905619728e-01   +2.485664471780266e-01   +2.692074956379603e-01   +1.207739663636071e-01];
L3_L1_iGABA_netcon = [+4.589976012795595e-02   +5.177955161777856e-02   +6.786895337687043e-02   +1.688926657088534e-01   -9.356178804426170e-02   +1.621972944507900e-01; -1.399431910291290e-03   +1.948024991647018e-01   +2.058517248958813e-01   +1.801221102075707e-01   -4.034627393298180e-02   -6.434199450367968e-02; +3.665934081236320e-01   +5.714156719276116e-02   -1.618773948340844e-01   +3.251195059320969e-01   -2.061207954448186e-01   +3.162343750214251e-02; +7.289314281735382e-02   +6.683570558679350e-02   -1.938180243208515e-01   -2.266318608554853e-02   -8.385508823517723e-02   +2.392963105351104e-02; +1.950489598356717e-01   -4.846788462578483e-02   -9.101979347358857e-02   +1.346903424241368e-01   -1.239543080740746e-01   +2.688981209217982e-01; +6.472558519552860e-02   +7.620137463361366e-02   +1.150942757962437e-01   +1.518671539373694e-03   -1.768444498653578e-01   +1.227595783317390e-01; +1.371703334230897e-01   +7.392277069189081e-02   -5.908871192311319e-02   +7.877344961023117e-03   +2.030130200122367e-01   -2.970542933138657e-01; +1.317366469548599e-01   +1.261628940210870e-01   +3.818452416182302e-01   +1.236770943364948e-02   -1.247909779328397e-02   +1.399895676311506e-01; -1.766679439904485e-04   -7.558236348571189e-02   +1.575946692979411e-01   -1.027424807216017e-01   -7.328095673130862e-02   +5.449789080071461e-02];
L5_Input1_iAMPA_netcon = [+4.888197562667888e-03   -1.056097694750911e-01   +1.127619239984540e-01   -3.442128578544978e-03   -1.068315816199424e-01   +5.798358854759893e-03];
L6_Input2_iAMPA_netcon = [-1.230162977928094e-01   -1.318951724387244e-01   +5.876620335249173e-02   +7.626072957274295e-02   +2.366844671614743e-01   +8.364016661990901e-02];
L5_L6_iAMPA_netcon = [+2.201287546057049e-01   +2.258844543571896e-01   +1.297434942447082e-01   -9.477483899087177e-02   +1.180731816951460e-01   +1.034639091517287e-01; +6.201267406171660e-02   +2.519531598914711e-01   +2.208199623178387e-01   +2.395783579707306e-01   +5.429661322696440e-02   +6.375251616954185e-02; +1.287398974544783e-01   +1.888117607471845e-02   -1.248584054541678e-01   -1.063405825586318e-02   +1.197054819946756e-01   +8.003462702516635e-02; +4.321957376713744e-02   +1.058529109130366e-02   -8.825480095231051e-03   -8.446169167250352e-02   -6.192170736095080e-02   -7.482485896826700e-02; +1.523103891226348e-01   -1.009052989532051e-01   +2.686516584781981e-02   -1.217498688914123e-01   -1.042315960697347e-01   +2.828038431906113e-02; -1.832729334827380e-02   -1.053465421244814e-01   +8.568094569019938e-02   +3.595958629255434e-01   -2.875378700553841e-01   +1.915609578970815e-01];
L4_L5_iGABA_netcon = [+1.243703084854992e-01   -6.844538690950439e-02   +1.483795647879146e-01   +9.343458852119786e-02   +2.120604116335124e-01   -5.655203413032439e-02   +3.056822503526199e-02   +2.646470402717874e-01   +1.033484985394174e-01   +4.426154502584872e-02   -1.778804321733945e-03   -9.509997511498874e-02; -3.362819359550551e-02   -1.051609943430230e-01   +3.053753358584695e-01   +2.697238139841678e-01   +1.405388061400845e-01   +2.104821229023238e-01   -2.027740489626139e-01   -1.557242206229010e-01   +2.916780300032080e-01   -1.395715483917552e-01   -1.969449977365344e-01   -1.906338681350883e-01; -6.164527800706102e-03   +4.752210574524181e-03   -1.021329900538654e-01   +9.170990430631699e-02   +1.231677791338559e-01   +9.275102138749153e-02   +1.713299559054078e-01   +2.415051581558966e-01   -2.402636632240533e-01   -1.464438552983140e-01   -4.219306619621950e-02   -6.621705329980111e-03; +2.792974599779594e-01   +2.954741509763300e-02   +3.265584049776430e-01   +2.276093120931878e-01   -9.211154060843948e-02   +3.175989290723476e-01   -5.914556980011808e-02   +1.440871014179449e-01   +8.056014325728646e-02   -7.482060370950333e-02   +2.026080474759469e-02   +2.305620692145915e-02; -1.871925320830478e-02   +1.231236515446029e-01   -2.055954743648105e-01   -6.316494918417588e-02   +1.288097886112159e-01   -5.630346249168602e-02   -6.934015807176899e-02   +1.217475638227040e-02   -1.490932972304664e-01   +2.046097822828619e-01   +1.990540745458063e-01   +1.519415635002360e-01; -5.110507414052037e-02   +3.188503671299253e-01   +1.326152343539531e-01   -2.470646666770903e-02   -6.403446435531018e-02   +3.379016781455580e-02   -1.824047654198453e-01   +9.898526949579747e-02   +1.337500916233490e-02   -2.182136108312731e-02   +1.261079925063046e-01   +3.811885812445999e-02];
L6_L4_iAMPA_netcon = [+2.400064260784145e-01   +1.918890541265953e-01   -6.527243277368981e-02   -2.491423651088760e-01   -1.165332254556536e-01   +3.234790830382436e-02; -1.862699249677001e-01   -7.568649200609233e-02   +2.239967068411161e-01   +4.416809635574978e-01   +8.225220428979793e-03   -3.029500341330454e-02; +1.532090717805953e-01   -2.374594241639191e-02   +2.436521006338258e-02   +2.405477183895406e-01   +3.673489506263359e-02   -1.462024891347351e-01; +7.488992107401596e-02   +1.733235755766738e-02   +1.658284388808076e-01   +1.294229875293032e-01   -2.479620498494416e-01   -5.765058362973971e-02; -3.628826596415166e-02   +1.986673801164404e-01   -1.378605573349599e-01   +1.779003216195969e-01   +3.364231901165673e-01   +8.401874034167200e-03; -6.657417151048167e-02   -2.144816400566144e-01   -3.225002906467532e-02   -9.971562132960535e-02   -5.248296677597353e-02   -7.019542672397155e-02; -1.328121514311300e-01   -5.818719996139203e-02   +5.722329296435340e-03   -3.313744720304048e-01   +3.238205483181971e-01   +1.176835683387276e-01; +1.473833098785481e-01   +2.168142223068010e-01   +6.432626087552004e-02   +8.272232448345926e-02   -1.577955372671984e-02   -4.764895554763295e-02; -8.197041393106272e-02   +7.011683440395478e-04   +1.266413630487600e-01   +1.550474326969999e-01   +3.039392542801258e-01   -9.254051043193169e-02; -3.600302215158074e-02   +8.065768379714511e-02   -2.482367863682370e-01   +9.214363916509540e-02   +1.179613646184390e-01   -1.406423808840971e-01; -1.134320635949205e-01   -2.751226532187972e-02   +6.610907497495164e-02   +3.663743077701711e-02   +2.687907150010405e-01   +3.280493578291729e-01; +1.488149995575752e-01   -5.205670718353887e-02   +9.632298930297570e-02   -1.010050722289823e-01   +1.643434809482646e-01   -1.523398078385538e-01];
L5_L4_iAMPA_netcon = [-5.269309501962099e-03   -8.581826033085982e-02   +3.222060304892995e-03   -6.852410338154509e-02   -1.808694779589366e-01   -5.192532622972659e-02; -1.120777441777956e-01   +9.737576933291039e-02   +6.493961300575488e-02   -3.021810716275757e-02   -9.027727051979145e-02   +8.974491143857995e-02; +1.546623827344945e-02   +2.838216935892881e-02   +6.814926962234992e-03   +3.157135374265788e-02   +3.058344509128805e-02   -1.871309144880982e-01; +1.453156872074666e-01   -2.076242930083443e-01   -3.738742883652245e-02   +3.799316582941858e-02   +8.007050888298667e-03   +4.151190403199832e-02; -1.375657311800679e-01   -2.931244422312617e-02   +2.540024321087155e-01   +2.897744760707941e-02   +1.950711119998440e-01   +3.050285456669816e-02; -1.897080184553603e-01   +5.591522718405376e-02   +1.836686210144333e-01   +2.733625956171927e-02   +1.248356520069994e-01   -1.039927543160524e-01; -4.805556450700185e-02   +1.588184674894999e-01   -3.079480243139530e-02   -1.090665044456773e-01   +4.784344055572641e-02   -1.155330932948413e-01; -9.512109098498241e-02   -4.179748575165062e-02   +2.394230565873659e-01   -1.391718579052390e-02   -6.780656288206831e-02   +6.806769802656490e-02; -7.367495266523565e-02   -4.554473834975307e-02   +3.886935105092006e-03   +2.419091930673196e-03   -2.048084099155852e-02   -2.081654842368049e-01; -1.752381705774769e-01   +2.344133358021642e-02   -2.413024863696077e-02   +6.257116560315136e-02   -1.400087153085036e-01   +2.288010779525457e-01; -2.908708829878543e-02   +2.269669164979353e-01   +1.249837388237011e-01   +1.753477192116528e-01   -8.122896106154515e-02   +2.079882228345400e-01; +3.001022893688170e-01   +1.754855081753350e-01   +3.042207627339655e-01   -1.799861854725331e-02   +1.378342117901713e-01   -3.278362772690410e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
