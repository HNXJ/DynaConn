function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.015453008640780e-01   -3.279774727135547e-01   -4.271972085368472e-01   -4.685667964896195e-01   -4.253432116824432e-01   -3.579416987028510e-01   -5.361434532882338e-01   -6.347792127800062e-01   -4.870228474097262e-01; -5.132300682524450e-01   -3.144459400103618e-01   -4.599303516807350e-01   -3.842319593518784e-01   -4.651199466761091e-01   -4.102982163136500e-01   -6.300184806860137e-01   -5.347906434175735e-01   -3.716972066453252e-01; -4.610370356539939e-01   -2.817784583901308e-01   -5.382820615281562e-01   -5.906753024166599e-01   -5.756270492817117e-01   -4.630290587365990e-01   -5.452796881946441e-01   -3.711697029120410e-01   -5.184447316572999e-01; -4.807677738352931e-01   -3.282109976408811e-01   -5.492447217161756e-01   -3.800342580851205e-01   -2.901074346725869e-01   -4.116669787876094e-01   -5.282256671456216e-01   -2.255362276598809e-01   -4.488455282694352e-01; -5.245435327750395e-01   -3.948554493854132e-01   -2.099206219841115e-01   -3.370469641216441e-01   -2.970085388389804e-01   -4.704964485558583e-01   -4.050960674761690e-01   -5.213040394490208e-01   -4.315513861195348e-01; -3.897871283437732e-01   -2.417971909418412e-01   -3.525017264317927e-01   -4.676433068987567e-01   -3.660102854128255e-01   -4.276087379512785e-01   -6.338206885567572e-01   -6.257312804513090e-01   -2.973533813045466e-01; -3.649089934045360e-01   -4.109134453309891e-01   -5.166276059911523e-01   -5.380079509933865e-01   -5.729414468172278e-01   -4.730709684744701e-01   -4.074245443511041e-01   -5.888725140292220e-01   -5.805212290606796e-01; -4.440452103664027e-01   -5.569780134098130e-01   -5.026081619487617e-01   -3.903954076443670e-01   -3.893210008544956e-01   -3.088529733390761e-01   -5.449994376885190e-01   -6.878809082330425e-01   -5.348106652534325e-01; -5.492889002917773e-01   -4.627743981003661e-01   -4.727022780098225e-01   -2.996346133567593e-01   -3.890784257990992e-01   -2.545398537065902e-01   -3.863719566739587e-01   -3.699028507874044e-01   -3.685554438131120e-01];
L1_L2_iAMPA_netcon = [-4.065546583620960e-01   -4.041676754800714e-01   -3.565709842942270e-01   -5.256575095275166e-01   -6.103088471439739e-01   -4.333465663638472e-01   -3.131011681083271e-01   -5.310542431645850e-01   -3.680409541639023e-01; -3.508211986522258e-01   -4.913393460515167e-01   -4.154243187000054e-01   -3.751996968504149e-01   -4.529566843288229e-01   -6.053252479247105e-01   -3.752546409241785e-01   -5.288699516901849e-01   -2.127568377093223e-01; -4.850897118457611e-01   -2.741066427503541e-01   -5.915386621451931e-01   -4.232705318075197e-01   -1.963753913143105e-01   -5.953244049189295e-01   -4.548832068097275e-01   -4.426013329581287e-01   -5.488935110374982e-01; -3.290515814525696e-01   -4.531151958569452e-01   -6.352897312496972e-01   -4.792592263578918e-01   -3.457712683634523e-01   -5.624699567801952e-01   -6.304938234724544e-01   -4.621560505087829e-01   -4.395308839788670e-01; -5.198767956941307e-01   -3.365246854586016e-01   -3.178370149012792e-01   -2.971039284819247e-01   -3.775831462291988e-01   -6.460821786796404e-01   -3.633580147499411e-01   -4.874973723708880e-01   -4.514126813044723e-01; -6.632256548160247e-01   -4.422222107516040e-01   -5.934228611816039e-01   -1.053381090241314e-01   -4.748190929630822e-01   -4.055940084883631e-01   -4.265140905580787e-01   -2.427117662858168e-01   -5.565886909944306e-01; -4.351829385010412e-01   -4.241720625613346e-01   -3.169673077571033e-01   -4.743969050114940e-01   -4.303052590803136e-01   -5.951221176455358e-01   -4.071360150255428e-01   -4.491864287432891e-01   -3.767825566702609e-01; -1.570789108472288e-01   -4.576277147362584e-01   -4.272177815111413e-01   -3.920314908162851e-01   -2.891303052602561e-01   -3.883824204929155e-01   -3.320143922306096e-01   -2.061026146166100e-01   -5.360930568689963e-01; -6.735490963565275e-01   -5.294051093130600e-01   -5.126257683992013e-01   -5.872432319821878e-01   -1.370420510443845e-01   -6.203166643748645e-01   -4.060134317625356e-01   -5.584074886081589e-01   -3.748615995491092e-01];
L2_L5_iAMPA_netcon = [-4.886916380366987e-01   -2.984886025244139e-01   -6.054108577201914e-01   -3.394232308803897e-01   -4.987203590427204e-01   -5.119588495560106e-01   -5.736199517282766e-01   -2.548411032365375e-01   -5.536668421036692e-01; -3.873804534669604e-01   -4.547648305717135e-01   -5.197527591997095e-01   -4.120853173005029e-01   -5.302191808861421e-01   -6.172618686451740e-01   -3.819386325362164e-01   -3.929640872218170e-01   -5.644292686453697e-01; -3.890183467326943e-01   -3.384459215183688e-01   -3.978266917800248e-01   -2.683741577060572e-01   -3.450977362461081e-01   -2.137679365268982e-01   -4.210745442435879e-01   -5.891579107248949e-01   -4.335927973835495e-01; -4.636130580213451e-01   -3.439807221980229e-01   -3.213272749729938e-01   -4.342628793006834e-01   -6.589235369254806e-01   -3.802744275455339e-01   -4.746805421871360e-01   -5.032415538544687e-01   -4.830117686026104e-01; -5.129638545493717e-01   -5.434470139003139e-01   -5.289047305360691e-01   -4.934082482117118e-01   -5.974016144640797e-01   -6.862679727298292e-01   -6.367820819608133e-01   -4.504777915596388e-01   -3.721126414972531e-01; -3.366009640385316e-01   -4.959749314472611e-01   -5.286829147158520e-01   -3.584651757265392e-01   -3.977566617906050e-01   -4.936452058444751e-01   -4.963405280066906e-01   -4.874618762356024e-01   -3.622576090781252e-01];
L5_L2_iGABA_netcon = [-5.066113447125851e-01   -3.672768404289223e-01   -6.215367334372510e-01   -4.710565928375393e-01   -5.468588275787835e-01   -4.664345478747554e-01; -4.336041381301718e-01   -3.860870481067140e-01   -4.441139798711079e-01   -5.994939018270946e-01   -4.301301927290764e-01   -4.714164390495705e-01; -4.208538381117116e-01   -3.518665560510893e-01   -4.908958544976156e-01   -4.364193169618945e-01   -6.237818763327838e-01   -3.888279089162665e-01; -2.153684474224255e-01   -3.927551032512822e-01   -1.736300532839861e-01   -4.541909522114344e-01   -3.526620756438939e-01   -3.585938896018119e-01; -5.143955513726346e-01   -4.132303652544523e-01   -3.938752886445124e-01   -5.174367712553207e-01   -5.821168716163333e-01   -2.361724829113485e-01; -4.547492401142093e-01   -3.462582684038091e-01   -2.888678642680172e-01   -4.989745956208308e-01   -4.218873023870327e-01   -5.864434081100752e-01; -3.269951627773848e-01   -3.794722922654171e-01   -5.646975463368412e-01   -4.297503211093748e-01   -2.367369397160108e-01   -2.763545685419406e-01; -4.608990864277023e-01   -2.460429531491466e-01   -2.754423127741716e-01   -4.967623601672135e-01   -3.713078441019167e-01   -3.494454339990554e-01; -4.179203616883426e-01   -5.611679757973743e-01   -5.311439753614819e-01   -3.227922457271272e-01   -2.968708935181688e-01   -4.812782641779999e-01];
L3_L2_iAMPA_netcon = [-4.806153507956957e-01   -5.506624013288682e-01   -3.655775166156650e-01   -6.262724259463176e-01   -4.143245711520901e-01   -1.852442686846789e-01; -3.720420619954283e-01   -5.248611358834365e-01   -4.805642960538336e-01   -4.374982800948036e-01   -4.707301361300982e-01   -5.577885768653771e-01; -5.052597208920110e-01   -5.453999814584711e-01   -4.109932066170255e-01   -6.199041908861006e-01   -4.656719523356523e-01   -3.922867511801891e-01; -4.151058225736160e-01   -4.868555319992215e-01   -5.447057846331336e-01   -4.762744444582434e-01   -5.154410967249419e-01   -4.073195082189478e-01; -4.593176239812198e-01   -4.925851116549216e-01   -3.144803496130835e-01   -3.639039438072142e-01   -3.604696330562981e-01   -4.054275521787303e-01; -5.349318308083774e-01   -4.158648612690252e-01   -4.151400047373499e-01   -4.348816998836547e-01   -4.465778724708483e-01   -5.611417737668123e-01; -4.861901200838935e-01   -3.941278500065239e-01   -6.027363048566625e-01   -3.464657738254919e-01   -4.553550815526746e-01   -4.277226577433470e-01; -3.722796000018400e-01   -3.827357147714673e-01   -5.421436446522025e-01   -4.790379893231302e-01   -4.902360685368247e-01   -2.637229609397158e-01; -6.722170420812359e-01   -4.935882468898031e-01   -4.159444844095209e-01   -2.806486435045516e-01   -3.456183309247751e-01   -5.119343501203293e-01];
L2_L3_iAMPA_netcon = [-3.839887294846362e-01   -4.547909835773243e-01   -5.164304613713465e-01   -4.088382457197748e-01   -4.963628186939720e-01   -5.711387967957876e-01   -3.428386470271683e-01   -1.939714617942877e-01   -3.772229022577731e-01; -4.298781421994745e-01   -4.489073327157769e-01   -3.784617453558174e-01   -3.722827775348500e-01   -4.609170273281455e-01   -4.926422046529042e-01   -4.304763715486712e-01   -4.446093096240186e-01   -4.087639159702729e-01; -3.253390560207746e-01   -5.715644840918270e-01   -4.293442831430305e-01   -4.020402582659080e-01   -4.067490578987126e-01   -4.943539887709473e-01   -3.874830966675522e-01   -4.010948707272018e-01   -5.596917957615080e-01; -4.154146488201886e-01   -4.528894081963609e-01   -5.678474483378279e-01   -3.206638287233305e-01   -3.540453041991134e-01   -4.449785655049551e-01   -5.504747561791531e-01   -1.846331925217421e-01   -2.660263122937086e-01; -4.128400996398492e-01   -6.491913058501636e-01   -4.571321046709657e-01   -3.856893689268358e-01   -5.844533705585898e-01   -4.425819800413388e-01   -4.907529342030333e-01   -3.745150531229361e-01   -4.710354472480449e-01; -1.604740088859380e-01   -2.578483599611655e-01   -3.102269147647568e-01   -4.085034794942339e-01   -2.925738909405286e-01   -4.334746988528536e-01   -6.276447651177637e-01   -4.439825402462566e-01   -5.497043720549430e-01];
L1_L4_iGABA_netcon = [-6.312234180208576e-01   -3.447747216141410e-01   -5.851542576050330e-01   -4.670836258109174e-01   -3.968145684802766e-01   -4.004941678123334e-01   -4.017757760592783e-01   -5.651455989405482e-01   -2.100090948038944e-01; -2.622735914769876e-01   -3.322743565107474e-01   -4.448399732590739e-01   -4.170959035711270e-01   -4.398035042859394e-01   -4.602173484755208e-01   -4.205964540326745e-01   -6.677680309537809e-01   -6.416615789605730e-01; -5.228238505092793e-01   -5.164233941105422e-01   -3.520880244498060e-01   -4.951295828671617e-01   -4.275618826219281e-01   -2.728271597524972e-01   -6.578500089154397e-01   -4.108131502714195e-01   -3.021890209760607e-01; -4.545966221435584e-01   -5.445028806586680e-01   -4.092629916790785e-01   -3.863938051479722e-01   -6.761100492378238e-01   -3.043827874555178e-01   -3.510047235137778e-01   -4.458158349140728e-01   -3.152507384828507e-01; -4.573629520684144e-01   -4.833360119177210e-01   -5.427074101193371e-01   -4.197753799390937e-01   -4.722225001622439e-01   -5.389627254373220e-01   -5.387587256403781e-01   -6.088976547605736e-01   -5.608217583350297e-01; -4.443637867921494e-01   -3.876712015134983e-01   -5.578644570651867e-01   -4.518051050778059e-01   -3.871845302878749e-01   -4.103404129587913e-01   -3.937515509906065e-01   -3.579588535541232e-01   -2.578759890508642e-01; -5.221741061508902e-01   -4.956056308462282e-01   -4.188982439459887e-01   -3.303510431687086e-01   -3.219753780782685e-01   -4.940130302665779e-01   -2.586046959231089e-01   -5.450678649905818e-01   -4.663672328070081e-01; -6.574492057143089e-01   -4.854387149075933e-01   -2.782386288906867e-01   -3.982924027697182e-01   -4.700644629245311e-01   -3.733853593787410e-01   -4.480439471623980e-01   -5.446193915888113e-01   -5.154139053908462e-01; -5.745775428642000e-01   -5.398195768693589e-01   -2.752191108469693e-01   -3.209569891431185e-01   -3.409526144425333e-01   -3.001556929514655e-01   -5.885238993492078e-01   -4.611325334764271e-01   -3.664162948835740e-01; -5.826558219146545e-01   -3.001541073647170e-01   -4.923203419504206e-01   -5.133002315807371e-01   -5.051942016830985e-01   -4.981950279656841e-01   -3.913730767518953e-01   -3.957960502615751e-01   -1.031868143294290e-01; -4.444967297128809e-01   -3.430908806194641e-01   -2.436041535150689e-01   -4.203993246105023e-01   -4.525365926171095e-01   -4.910155285830541e-01   -3.658246521556188e-01   -4.765158057582992e-01   -4.985083491188818e-01; -6.110195163644779e-01   -3.187667899445770e-01   -4.339800061083026e-01   -5.411377008733879e-01   -4.740641574239990e-01   -3.760400806487157e-01   -4.341554189570904e-01   -5.240533994221037e-01   -4.498493983706985e-01];
L4_L1_iGABA_netcon = [-3.413574771831296e-01   -3.400808492598127e-01   -6.725533782611790e-01   -4.045120801725558e-01   -4.843934729069101e-01   -6.024788509827913e-01   -4.907229844478220e-01   -5.461475045295532e-01   -2.906141412714069e-01   -4.139481863508629e-01   -5.115291958689528e-01   -4.542372732286627e-01; -2.070058586097731e-01   -5.059894870438594e-01   -3.610779608402589e-01   -4.472816799960511e-01   -5.235091534513817e-01   -5.607793656285882e-01   -4.441685951617784e-01   -5.337002115875490e-01   -2.379069653811434e-01   -3.332754297263314e-01   -4.859098030253054e-01   -3.985215872243722e-01; -4.002648607601562e-01   -5.786705503278349e-01   -5.574125307718457e-01   -4.361722310465759e-01   -5.782034772741548e-01   -4.843512028648634e-01   -4.823498953081288e-01   -3.801846893781786e-01   -3.520349462531906e-01   -3.251688575884834e-01   -5.719370575129762e-01   -4.926255014671225e-01; -5.153851194635231e-01   -5.721207883917372e-01   -4.340888269825292e-01   -4.720239336821538e-01   -5.516561213306982e-01   -4.477222193300763e-01   -4.431762924377630e-01   -4.575957994599419e-01   -4.252269545825116e-01   -5.348308924894694e-01   -1.273992192083289e-01   -4.400676716901875e-01; -5.721262719292241e-01   -5.148884086485123e-01   -4.756458453246094e-01   -3.435053133662760e-01   -4.426876275698493e-01   -5.858429218684198e-01   -2.542692042034018e-01   -3.985857328425846e-01   -4.449177088819790e-01   -4.294547317446883e-01   -2.958996236789363e-01   -5.175141828523782e-01; -4.816567976773897e-01   -2.680727300316469e-01   -3.525449036829823e-01   -4.497554640428174e-01   -4.107872266311482e-01   -3.196380955795957e-01   -4.659276999559913e-01   -3.586523640601681e-01   -5.655293903405981e-01   -3.594881099917391e-01   -3.816588559966830e-01   -6.834751552099210e-01; -3.357884944973104e-01   -6.240300530812003e-01   -4.276884217658612e-01   -4.386731364628469e-01   -5.516807028799514e-01   -4.603312655426488e-01   -5.454353201524550e-01   -6.196959541840994e-01   -3.145090932107213e-01   -3.653542881780875e-01   -4.442440150246746e-01   -6.294156337823167e-01; -5.602927120332246e-01   -4.256553215793294e-01   -4.357243989428445e-01   -3.394324676314701e-01   -6.307715956079750e-01   -6.034881264031599e-01   -2.444613925525489e-01   -3.813870976070148e-01   -3.933099493508325e-01   -5.510637499175335e-01   -5.004394471043448e-01   -3.570746889849442e-01; -6.749585960886669e-01   -5.458613415589332e-01   -3.629507974366702e-01   -6.289914463082400e-01   -5.724703350481082e-01   -2.426025201882053e-01   -4.176571401545044e-01   -3.154667752427828e-01   -4.009482231485180e-01   -5.424997551173534e-01   -3.744384916993551e-01   -4.520913881346668e-01];
L1_L3_iAMPA_netcon = [-5.096711565750375e-01   -3.468408588358076e-01   -4.492459966281747e-01   -5.509606002858783e-01   -6.874550556801882e-01   -5.052476755386407e-01   -3.851087718966202e-01   -4.036212374602201e-01   -3.865603581342397e-01; -5.441814903131316e-01   -3.295337696644959e-01   -4.627684862033626e-01   -4.478414875262525e-01   -4.832570113220958e-01   -5.228115858643263e-01   -3.298423514289913e-01   -7.002926746389421e-01   -4.401945085654428e-01; -4.564405694672262e-01   -3.226515061433776e-01   -4.712879108774143e-01   -2.045082274812454e-01   -3.601440548572116e-01   -7.033274761294048e-01   -2.363336620487832e-01   -6.341264787147475e-01   -6.547290401602959e-01; -3.095495947726757e-01   -3.790969679230936e-01   -4.434312094141462e-01   -4.824568196668088e-01   -3.151166835501548e-01   -1.776876195343711e-01   -4.089124555648026e-01   -6.853867726522059e-01   -3.374079122395294e-01; -5.220596404860616e-01   -6.162275948074687e-01   -4.816580339519591e-01   -4.580817823210733e-01   -5.537642519887710e-01   -2.469447242840129e-01   -4.617096814968431e-01   -2.655552857123868e-01   -4.447430947590768e-01; -4.813451974268625e-01   -3.161920859436556e-01   -5.664073365409106e-01   -4.818667291728331e-01   -5.508168320682111e-01   -4.419216207289346e-01   -3.774236204914015e-01   -5.288516583610505e-02   -5.703512055479608e-01];
L3_L1_iGABA_netcon = [-5.554654600366037e-01   -3.577984308346975e-01   -4.085152084631474e-01   -6.354051687832486e-01   -3.230202680145985e-01   -6.327476545376092e-01; -6.195495867292575e-01   -4.077609516530973e-01   -3.096120910653616e-01   -4.209635693411563e-01   -4.943421761231475e-01   -7.100828687018980e-01; -4.148394223111398e-01   -5.753076237057028e-01   -3.138514280088541e-01   -3.812810914825197e-01   -4.067828590917549e-01   -4.818790613308957e-01; -3.953155073356755e-01   -3.219253727414852e-01   -5.108050945616327e-01   -5.528628550266500e-01   -3.194981523535625e-01   -5.831019363411588e-01; -4.798550037688614e-01   -5.302208046792909e-01   -6.136833627624421e-01   -4.556091520808632e-01   -4.008207610660736e-01   -3.690644304360974e-01; -3.547242921179012e-01   -3.924047284167065e-01   -5.737942755731138e-01   -2.858071929500774e-01   -2.902525869594775e-01   -3.497416307091143e-01; -3.720581005053122e-01   -4.103139743778530e-01   -3.880508354112507e-01   -5.980555147043420e-01   -2.210190915047895e-01   -1.652155542808125e-01; -2.331711358200368e-01   -4.212581637146678e-01   -5.506329124565728e-01   -5.115206212530555e-01   -5.739687562045558e-01   -4.193944927849479e-01; -5.077709404842655e-01   -5.324650043223101e-01   -5.331454805884662e-01   -3.691840090797799e-01   -5.018994403941242e-01   -4.539550475340332e-01];
L5_Input1_iAMPA_netcon = [-3.642759371143784e-01   -4.799352212250536e-01   -4.611127705394488e-01   -4.012640510331210e-01   -4.656501884915287e-01   -6.339561788293223e-01];
L6_Input2_iAMPA_netcon = [-5.973621429583897e-01   -6.173554528718144e-01   -4.510864534183962e-01];
L5_L6_iAMPA_netcon = [-5.496728184539174e-01   -5.010791188456418e-01   -3.780668790095084e-01   -3.944514168306447e-01   -5.227997532537619e-01   -4.090584509064210e-01; -5.620729735820590e-01   -4.145817375402713e-01   -5.436490140633548e-01   -4.856529238827691e-01   -3.927886686061753e-01   -3.071835368713993e-01; -6.428126320388159e-01   -3.091711311300493e-01   -2.541174395607873e-01   -3.474658535319470e-01   -3.415394886381874e-01   -4.010344576486093e-01];
L4_L5_iAMPA_netcon = [-3.652672309646584e-01   -3.567420183773996e-01   -4.533124460288380e-01   -3.613107086982846e-01   -4.634276820221624e-01   -4.629840722103226e-01   -3.052447400166484e-01   -3.282235501986452e-01   -5.070708383216815e-01   -3.139378744258505e-01   -6.147258115016228e-01   -4.663299558881278e-01; -3.459740015256935e-01   -2.544483977039514e-01   -2.727443588351816e-01   -3.205238818982695e-01   -4.463954335975071e-01   -4.418615732351657e-01   -4.173132293444436e-01   -1.421486716738322e-01   -3.497247060581318e-01   -3.220411453127794e-01   -6.085033838648620e-01   -6.070116515070285e-01; -3.014139799159898e-01   -5.062058377278164e-01   -2.826798476722813e-01   -4.791028553294664e-01   -4.099851683520820e-01   -4.439809661190731e-01   -4.104741283606879e-01   -3.782405684740042e-01   -4.447420548989982e-01   -5.421356346864494e-01   -5.401356604947692e-01   -3.731532663719631e-01; -2.728741207262248e-01   -4.554844067098640e-01   -5.055966587904664e-01   -2.897832446942443e-01   -5.586367341869540e-01   -4.665747317985255e-01   -3.125672854559797e-01   -5.144623717630555e-01   -4.849637288208516e-01   -5.358909081007855e-01   -5.961235756611263e-01   -4.561746779257325e-01; -3.584129634620949e-01   -2.696544207046686e-01   -6.048561000686201e-01   -4.190966732358865e-01   -3.426405355921430e-01   -3.168245588729774e-01   -5.393145040346736e-01   -4.941676903265115e-01   -4.574763809047896e-01   -6.244652664942756e-01   -4.685856493186858e-01   -1.688821709093562e-01; -6.710829805852949e-01   -4.938686064895738e-01   -6.213198066425668e-01   -5.291110585064905e-01   -5.410572664952018e-01   -5.662178183693746e-01   -3.756070538925109e-01   -3.551033911852657e-01   -4.291070130823368e-01   -6.275964912872191e-01   -4.613603647747795e-01   -5.835885796505759e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
