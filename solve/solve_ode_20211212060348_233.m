function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+6.188895954990771e-01   +7.343330227746188e-01   +6.161627020907013e-01   -3.431331238725346e-01   -6.285014290635026e-01   +5.321269271638259e-01   +1.753257217140316e-01   -6.287533280398683e-01   +4.033159937431255e-01; -1.603228356499605e-02   +6.691823807557246e-01   +2.462669999021601e-01   -4.525429217542706e-01   +2.425114936317404e-01   -2.245661195670742e-01   -7.400438199405561e-01   -5.107453420099619e-01   +2.494645647651646e-01; -7.263333097822983e-01   +2.852111985434307e-01   -2.903221451767381e-01   -2.796172828121682e-01   -1.218971488763443e-01   +7.650330927268264e-01   +8.136905322566387e-01   +1.546733276665163e-01   +8.976505633941894e-01; +3.525020161931256e-01   -3.627846152733046e-01   +5.568822586111623e-01   -1.000000000000000e+00   +2.126981306015713e-01   +7.643713675014834e-01   +1.636722059249821e-01   +7.138061995822875e-01   +1.923521967849556e-01; -4.226290282282719e-01   -5.143803837910421e-01   +5.276117133808882e-01   +5.849691175714293e-01   +4.025184232724744e-01   +4.986402434987006e-02   +9.509817080918439e-01   -9.425556771355968e-01   -1.276001683192884e-01; -7.774493237557250e-01   +6.295995160987549e-01   -2.742677464413449e-02   +6.795264481541277e-01   +7.387331438678629e-02   -1.450290776362627e-03   -9.431198290603148e-01   +3.939265371455039e-01   -1.775094522037324e-02; +9.357663356639088e-01   -4.488203559632238e-02   +3.921071545761633e-01   -5.491532490701503e-01   +3.642775356747593e-01   +3.432617332203473e-02   +1.601819617065408e-01   +6.567497291469750e-01   -9.205413717197276e-02; -9.276138692818504e-01   -5.625554090508351e-01   -2.886201503264202e-01   +8.496031030342636e-01   -4.648435137977735e-01   -4.587177749920780e-01   -3.786913750622071e-01   +5.075307913781285e-01   +3.630462504760087e-01; -8.187491143386613e-01   -4.727551700211390e-01   -3.511050418540385e-01   +8.514650777350790e-01   -1.999753768926042e-01   -2.847642610163260e-01   +4.624201139040496e-02   -5.955606558009493e-01   -2.573711312745856e-01];
L1_L2_iAMPA_netcon = [+4.725395009980213e-01   -4.828423219515668e-01   -1.782120627437466e-01   +3.907274116655337e-01   +7.811966085726288e-01   -2.435083718486357e-01   +1.181129444017158e-01   -2.162214553176866e-01   -1.626416600418529e-01; +8.935764300555106e-01   -4.068606579426081e-01   +1.000000000000000e+00   +4.060161079623059e-01   +6.006129826657494e-01   +7.436072911797692e-01   +4.942124980947648e-01   -3.653391072725815e-01   +5.925987220282720e-01; +2.370427181983337e-01   +6.933468850485075e-02   -5.453328445943291e-01   +3.692485438460427e-01   +4.815433779968345e-01   -4.751561709745186e-01   +2.080757220927240e-01   -5.922369597565387e-01   -9.082659998783045e-01; -8.677325415432351e-02   -2.697688254611808e-01   -5.282004297111463e-01   +5.478913057020935e-01   +1.345228717755088e-01   +1.905107466779566e-01   -5.166422074558513e-01   +5.983012911141767e-01   -4.687062211425368e-01; -6.306482304826153e-01   +1.316250565352256e-01   -6.996604994950295e-02   -7.292631923241382e-01   -6.423357050495810e-01   +6.963151238052804e-01   -2.137658959033147e-01   -2.568546812635272e-01   +1.270686009596133e-01; +4.357338775289994e-01   +1.646969821655599e-01   -6.040943335000202e-01   -8.606262098605093e-01   +9.336310312483176e-01   +7.828352067745245e-02   +3.410621002696830e-01   +5.465931468342522e-01   +4.171735526946226e-01; +1.999867511223746e-01   +5.949580318517860e-01   +3.501957800849417e-01   +7.554091657272513e-01   +5.774579258011933e-01   +3.337131306568699e-01   -4.323175487027522e-01   -7.540955514337746e-01   +7.540976808914186e-01; -1.698926209573156e-01   +7.521315854300434e-01   -4.999171230394092e-01   +4.421036327511164e-01   -6.561692861031845e-01   -6.462385496302142e-01   -3.380300609682527e-01   -7.211530883118635e-01   +5.382169591836189e-01; -6.346227628240272e-01   +2.304685632467442e-02   +4.899124737297169e-01   -3.267773144507661e-01   -8.496229758703016e-01   -7.034529389874374e-01   +4.747594586694863e-01   -9.599927287602089e-02   -9.191954384220445e-02];
L2_L5_iAMPA_netcon = [+5.098686181853068e-01   -7.742559001092755e-01   +3.292604929177426e-01   -1.654794603166697e-01   -7.361801521168730e-01   +6.915921212047181e-01   -7.247569042717381e-01   -1.325227985261443e-01   +8.502755727007291e-01; +4.315484480426965e-01   -5.827637868807387e-01   +1.539752017654835e-01   +8.496531717884741e-01   -3.857484762574341e-01   +3.281368776362723e-01   +9.278640657447342e-02   -5.376218037110466e-01   +4.498327345847011e-01; +6.531311161601920e-01   +6.783733039701021e-01   +6.012992494175498e-01   -4.572670453565476e-01   -2.002767627952437e-01   +5.848618302479311e-01   -2.785271016405736e-01   +3.019454086537947e-01   -2.487949622378327e-01; +6.925410595186923e-01   -1.078650343756316e-01   -6.534801795181232e-01   +7.470107583923660e-01   +3.778569327013897e-01   +3.824796855447271e-01   -1.221877280938023e-01   -4.685767164430106e-01   +6.222658269023340e-01; -7.113951276128886e-01   -2.249655702359397e-01   -2.190151608386663e-01   -7.223930281676137e-01   +7.946902689161613e-01   -2.537207360724011e-01   -6.460119493164490e-02   -5.162517612465086e-01   +3.829544924344633e-01; -7.652736558944117e-01   -2.830299280056233e-02   +1.000000000000000e+00   +7.252308413023072e-01   -1.042177948574842e-01   +2.067864672457865e-02   +6.301885734061117e-01   -5.072829956847752e-01   +7.005307777979073e-01];
L5_L2_iGABA_netcon = [-5.218070257848602e-01   -9.813430528963665e-01   -2.484031654245001e-02   -4.098588442788758e-01   +8.173057511772264e-01   +9.386899182781090e-01; +5.450477330178501e-01   -8.153163482935174e-01   -4.728706646844460e-02   -1.520089340242562e-01   +9.119375229681805e-01   -5.007131382336476e-01; -2.820453765707128e-01   -7.986033792026560e-01   -8.517764061966182e-01   -4.197421633562319e-01   +7.453692008017098e-01   +9.574980150063137e-02; +4.650243868146354e-01   -1.239197601061467e-01   -4.674851067797459e-01   -6.637514233806832e-01   -4.223670652483732e-01   +8.787139062619348e-01; -1.380301984336713e-01   +2.100426672731551e-01   -6.350082248411862e-01   -5.112631650891312e-01   +3.657135764377951e-01   +3.758290895663113e-01; -3.331835432612560e-01   -9.028773314966928e-01   +8.538451813728506e-01   +8.764710292629219e-01   +7.529374624198549e-01   -2.317318462001424e-01; -4.448890798312982e-01   -4.590304040390548e-01   -7.837448546874100e-01   +1.137054751617089e-01   +1.107720298295149e-01   -1.418590041875861e-02; +1.000000000000000e+00   -6.905133661447701e-01   +6.755795019967510e-01   -7.623994878463275e-01   +3.974230246067207e-01   -8.656070725766232e-03; +1.127292985113789e-01   +9.039151243399998e-01   -7.947044494750566e-01   -3.969859176058429e-01   -4.635672605172702e-01   +1.584982901988418e-01];
L3_L2_iAMPA_netcon = [+6.586347820736328e-02   -6.556618369311294e-01   +8.851933842335686e-01   -6.843649465136493e-01   -5.287603518638687e-01   -3.147633233804527e-01; -7.616960627838638e-01   +7.217446786496690e-01   -5.920629351639216e-01   +2.691431354797385e-01   +7.497185858357915e-01   -6.387623803556158e-01; -3.911973209598695e-01   +9.684682457902675e-01   +7.954822535398712e-02   -6.379186077459598e-01   +2.635455885264849e-01   -2.277969591883746e-01; -9.631211632910805e-02   -5.039318611553019e-01   +2.268642442165554e-01   +1.852345346782277e-01   +3.981421440254305e-01   -2.628588071133197e-01; +2.454248380889893e-02   -4.962653035936087e-01   +7.034294736723006e-01   +9.031421751806027e-01   -2.138422737236313e-02   +3.684014436130339e-01; +1.000000000000000e+00   -6.258858230652883e-02   -4.826709113956469e-01   +7.088297323396645e-01   +3.745146298109845e-01   +1.802717380313586e-01; +3.257049877909504e-01   +5.723730808730912e-01   +4.820724608982491e-01   -4.301865196862677e-01   +4.815527935803138e-01   -7.658845227107783e-01; +1.572726323304402e-01   +4.545039972032781e-01   -4.182778402556304e-01   -6.844662657190861e-01   -5.355931402154842e-01   -8.847103243767410e-01; +6.670068226245860e-03   -4.152744209603960e-01   -3.631914447604679e-01   -5.372176381611550e-01   +6.318355626968329e-01   -8.670053876545183e-01];
L2_L3_iGABA_netcon = [+5.236902450668763e-01   -2.724685038084946e-01   -2.011553905718145e-01   -7.545135723357952e-01   +5.367044189750216e-01   +6.647874462022100e-01   +2.511403689746695e-01   -6.325523644017699e-01   +1.920689630557943e-01; -9.241475746002222e-01   -4.373809684163021e-02   +6.745972549415531e-01   +7.089980396123674e-01   -5.481354114420529e-03   +5.863212033285246e-02   -4.349458842540408e-01   +2.393402175148660e-03   +2.876400605219207e-01; +3.727882998157673e-01   -3.817331795163034e-02   -8.125748160599188e-01   -8.075595315484828e-01   +9.436226828545051e-01   +1.154530440223823e-01   -6.842810435002866e-01   -7.690210509899420e-01   -2.746767023327087e-01; +5.602721972150004e-01   +3.922034395125672e-02   +3.386523750928729e-01   -5.875997032807047e-01   +1.000000000000000e+00   +6.192181019573678e-01   +8.044188536131974e-01   -7.408091602570593e-01   -7.897269359475396e-01; -5.617512808743850e-01   +1.038407564477804e-01   -5.146161637040683e-01   +5.805830750230179e-01   -1.868871472665997e-01   -4.077213418801335e-01   +4.785748440526505e-01   +2.906325653535556e-01   -7.164460292417584e-01; -1.485618384556368e-01   -7.946947903449917e-01   +6.271013761455178e-02   -5.296832979791990e-01   +4.110304083152761e-01   -9.321025954392855e-01   -6.825968351309541e-01   -3.321654006249303e-01   +3.529111895136736e-01];
L1_L4_iGABA_netcon = [-5.786268135394201e-01   +4.976241155993943e-01   -5.135174481906269e-02   +1.580643720205829e-01   -6.015806853010777e-01   +3.089400613343525e-01   -5.525996588805995e-01   -5.066129356225787e-01   -1.747531807097816e-01; -4.693986466828795e-01   +7.839760696387793e-01   -7.909611511942028e-01   +6.357915306822510e-01   -7.312785722983509e-01   +7.794614632843238e-01   -1.102374414087154e-01   +2.900678835622697e-02   +9.257663251260099e-01; -4.834591857209204e-01   -8.548442027047780e-01   +7.075090048458994e-02   -9.773281647582889e-01   -7.446905352235469e-01   +6.131358466033943e-02   -6.748374731164928e-01   +3.184356553445226e-01   +8.939627732551646e-01; +2.922857273908061e-01   +2.618043084614053e-01   -2.662632487317912e-01   -1.611139685793278e-01   -2.797999873674580e-02   -4.216359136867855e-01   -8.615588431987954e-01   -6.139151804164146e-01   -1.699008169494611e-01; -2.701780965511499e-01   +3.999505637976280e-02   +8.269387892099685e-01   -5.428617239805642e-01   +2.231292888454434e-02   -4.224738893811910e-01   +4.086283637915001e-01   -3.645465202262739e-01   -8.768398519166858e-01; -3.241288570181409e-01   -7.855715207310644e-01   +1.467685351137144e-01   +5.889582367808855e-01   -8.864526955385691e-01   -8.653514322260016e-02   +3.645535582251935e-01   -4.922504193575969e-01   -8.856646106819036e-01; -2.553724643211081e-01   -8.806900198631381e-01   +1.445888907587222e-01   +7.153187164151310e-01   -7.239867413206703e-01   +1.000000000000000e+00   -4.311753503007194e-01   +3.657567520702759e-01   -3.375690207430456e-01; -5.643224040664293e-01   +9.494549261100050e-01   +4.289900504397585e-01   +7.527008339831920e-01   +6.801378670656819e-01   -4.586886003305318e-02   +2.078840629936461e-01   -6.047661140955950e-01   +1.094408732819649e-01; -3.306792274433020e-01   +7.308546353060248e-01   -1.151883906305272e-02   -3.613094676450841e-01   +3.068375511669035e-01   -3.395900333680092e-01   +8.375309580801321e-02   +8.900614872182583e-01   -1.953932905825735e-01; +5.050173683342991e-01   -1.533445109507286e-01   -3.585489567180065e-01   +6.128333894093733e-01   +5.391677715010124e-01   +7.615517612380517e-01   -2.030182264150157e-01   +2.051957699180953e-01   +3.495915757917745e-01; -3.215477655566535e-01   -4.345457210718944e-01   -3.989696833105424e-01   +4.348010566171114e-01   +4.449566940397691e-01   -9.610200194864136e-01   -6.232601466986338e-02   +6.470394480847507e-01   -1.333545157547861e-01; +4.687819914530576e-01   +7.448369920113206e-01   -3.791885494346789e-01   +4.242379093823850e-01   +6.367770564547611e-01   +6.400782050174975e-01   +4.974462815640757e-01   -8.315772741599944e-01   +7.896693428476238e-01];
L4_L1_iAMPA_netcon = [-5.120683316323595e-01   +5.683185390555978e-01   +5.766273895131404e-02   +8.202119279525353e-01   +5.320972761819570e-01   +7.400545662436495e-01   -1.472410394787693e-01   -6.206786778291409e-01   -1.838351166940927e-01   -1.000000000000000e+00   +1.865156572265115e-01   -2.425952766400045e-01; +8.342410612992791e-01   +6.344006997204714e-01   -3.932850886852159e-01   +5.254540453491559e-01   -8.720437164500735e-01   +6.171319716227276e-01   -5.740007433948212e-01   -1.624800279486543e-01   +4.231539333329442e-01   +1.128408464369458e-01   -4.972976266099379e-01   -2.155191260879161e-01; -2.306688094993056e-02   +3.151242734391075e-01   +2.382984570580897e-01   +6.882222265058558e-01   +3.719371057658635e-01   +8.916863482282864e-02   -9.706875596223165e-02   +1.334969732825150e-01   +8.440592066348542e-01   +7.779093023158085e-01   -4.911884187272758e-01   -1.488339003638801e-01; +4.619871660275338e-02   +7.489694651085568e-01   +2.659324867616518e-01   -7.307785119410549e-01   -6.645037459450629e-01   +6.297806366793923e-01   +1.663594094187247e-01   +6.232404422750182e-01   -8.200860306304757e-01   +7.658052956840218e-01   -5.995730451884975e-01   -9.535752017447836e-01; +8.919089736061170e-01   -4.418364153755134e-01   +5.086366832267984e-01   -1.863667183774485e-01   -1.059150728800564e-01   +9.468524069547373e-01   -3.820607712888899e-01   -1.515889536082597e-01   +4.408273968888097e-01   -7.890129324774638e-01   +7.042119117663979e-01   +4.973541431368004e-01; -2.078488816151184e-01   -2.933549623794718e-01   -2.744309243334760e-01   -7.213504884805881e-01   +4.116140807105015e-01   -7.431651218026932e-01   +1.101932919387727e-01   +8.356997584164971e-01   -8.569151333112052e-01   +5.375749818926854e-01   -8.074221172938408e-01   -3.594710186738850e-01; +5.797827756865871e-01   -6.220068001915666e-01   +7.356776410131045e-01   -6.319119354232799e-01   +1.265888898993240e-01   +7.755370132935459e-01   +2.171214208927280e-01   +5.940548271366869e-01   +1.247558019581554e-01   +2.197732031913465e-01   -8.013904540782989e-01   +8.545208364304395e-01; +4.015586305568472e-01   -5.837479288455215e-01   +5.084349535735749e-01   +1.068651353235123e-01   +4.001970034312907e-01   +4.591675590386097e-01   -7.883648488039390e-01   -1.150946948901428e-01   +6.770002610199113e-01   +6.394762913222151e-01   -3.552305235257219e-01   -4.196765353478607e-01; -8.886871272603212e-01   -3.993028041656049e-01   -2.741046375095896e-01   +8.215588791702968e-01   +5.400081442444047e-01   -4.359501865762173e-01   +4.738865085082279e-01   -7.998155122558310e-01   -4.387895302822574e-01   -8.194872549325821e-01   -4.196338772003386e-03   +9.603873408927787e-01];
L1_L3_iAMPA_netcon = [-9.393501694428834e-01   -5.866219424524746e-02   -4.585174561652857e-01   -6.094480405286743e-01   -2.333275161159523e-02   +1.000000000000000e+00   -6.188502074512187e-01   -4.092283103303044e-01   +1.386185353823406e-01; +1.828964718003761e-01   +9.362540581182226e-01   +4.279465537777498e-01   +2.912325915133244e-01   -7.526392493185728e-02   +5.960487134847486e-01   +8.357508747956038e-01   -2.247217005212285e-01   -6.786872710122428e-01; -8.510148376220925e-01   +4.614536850201941e-01   -3.958909172979657e-01   -3.481817492401323e-01   -5.233175957995294e-01   -2.830120620837441e-01   -8.495537219974508e-01   +1.913046974064165e-01   +2.732674793431095e-01; +7.848128640243593e-01   -9.288234183417892e-01   +6.433620154889658e-01   -1.541601166888340e-01   -5.829243228416509e-01   -5.296404543943927e-01   -8.896489989882576e-01   +4.985674003859233e-01   +5.601605087691333e-01; +1.929001849620761e-01   +8.746954528526654e-02   +8.164097131809719e-01   +7.149661837537461e-01   -6.598383307197511e-02   +1.664601015899549e-01   -4.803833416216345e-01   +5.104823380197542e-02   +5.202655777231070e-01; -6.581243865663015e-01   -6.795539852240577e-02   -5.395867405967332e-01   -2.666268764860167e-01   +4.415870171292329e-01   -9.016569354516072e-01   -1.089680592926316e-01   +9.041255579848366e-01   -8.540507325678236e-01];
L3_L1_iGABA_netcon = [+4.151442877715620e-01   +6.368611610156347e-01   -2.538657831965064e-01   -5.178179746391733e-01   -5.482395615413399e-01   -5.204950150189777e-01; +1.877075477771272e-01   +7.633562873957578e-01   +4.173562225462178e-01   -5.518363067529465e-01   -2.636210944447341e-01   -4.256844576468375e-01; -4.469494806932908e-02   -2.928431427145278e-01   -1.965508770795919e-01   +9.485350308681136e-02   -8.484100329204676e-01   +2.673470088602371e-02; +9.083528893092684e-02   +2.761934556852962e-01   -6.447929054396008e-01   +4.113043990104169e-01   +6.726722720777929e-01   -9.205062065334008e-02; -3.083001415654431e-01   -8.150409468141064e-01   -7.315979009695067e-01   +4.644438017019122e-01   +8.147912810324544e-01   -8.005324296345813e-01; -1.039209480611798e-01   -8.518014487368422e-02   -5.228099694454467e-01   +1.076719344419613e-01   +1.570136988036678e-01   +3.392863395331273e-01; +3.170669022260777e-01   -4.109542286827618e-01   -7.928689354279171e-01   -1.000000000000000e+00   +1.285111015304224e-01   +8.862661870007891e-01; +6.258945117534378e-01   -9.070801227390919e-01   +5.259251020189911e-01   -2.896199542492908e-02   -4.730017269707251e-01   +8.305817371572071e-01; -4.705265680038748e-01   +6.792754132023389e-01   +7.373042527455089e-01   +6.426708082773088e-01   -5.831664397589889e-01   -4.149573716878847e-01];
L5_Input1_iAMPA_netcon = [+1.000000000000000e+00   +5.294410259325626e-01   +5.391590808087362e-01   -4.440961296717212e-01   +9.835919580669767e-01   -1.507495455484193e-01];
L6_Input2_iAMPA_netcon = [-2.094827169672265e-01   -1.000000000000000e+00   +2.064064927183207e-01   -8.850592544556184e-02   +1.996177285666358e-02   -4.329917260731513e-02];
L5_L6_iAMPA_netcon = [-1.463597685318644e-01   +5.522653301760809e-02   +7.060536094705704e-01   -6.424794449184866e-01   +3.707008155436815e-01   -1.184945694297764e-01; -6.114593734208332e-01   +5.855505642290296e-01   -1.000000000000000e+00   +3.684727267505956e-01   +4.938235441457867e-01   -4.980869854576155e-01; -3.830528527482346e-01   +8.907465876973600e-01   +9.294789005875893e-01   +5.697315185394759e-02   -5.868906367883708e-01   +8.196112610730506e-01; -3.227706962568768e-01   +8.080346997346418e-01   -7.869513689684651e-01   -9.382464564741042e-01   +4.076341240156199e-01   +2.638630027941597e-01; -7.997634244952418e-01   -5.112401157628782e-01   -5.675203915538126e-01   +2.619707202647508e-01   -5.600962704950355e-01   -7.609735647981205e-01; -6.142625590878862e-01   +9.449659681112687e-01   -5.738312376840456e-01   +7.089580303607427e-01   +1.130261330245187e-01   +7.567400851143993e-01];
L4_L5_iGABA_netcon = [-1.063083867413584e-01   -3.366736126605916e-01   -7.350103467965583e-01   -7.245806204565676e-01   -4.405603332113256e-01   +1.836088740668694e-01   +3.839323940082605e-01   -5.037593403390846e-01   -4.862965217368304e-01   -4.414657849605992e-01   +3.117814621250007e-02   -4.955476860975266e-01; +3.828686222835662e-01   -6.736487345778911e-01   -5.967389857982543e-02   +1.697185567198609e-01   +3.287186930389344e-01   +1.350737686443631e-01   +3.812977955022833e-01   +5.818349503322158e-01   -3.556475266697010e-01   +6.088174853313085e-01   -5.317308631558328e-02   -8.370994770258135e-02; +5.032463733940533e-01   +3.350197742174675e-03   +2.902148716481875e-01   -1.269704610688725e-01   +9.288832002597444e-01   -6.010840195570976e-01   +9.506014498856857e-01   +5.155397586746844e-01   -2.084483285768348e-01   -5.128676069176351e-01   -8.378529398652034e-01   +3.191809739875953e-01; -3.688955114954141e-01   +8.668152559834519e-01   +2.062162731625788e-01   -7.231558286453980e-01   -8.869426605959474e-01   -4.479199577158042e-01   -3.505953494646150e-01   +9.743797948918585e-02   +3.873042377117226e-01   +4.082868055141994e-01   -9.259733821717044e-02   +5.272254951276153e-01; -5.399843224257804e-01   +5.130750797352391e-01   +1.117586845938438e-01   +6.428903572166733e-01   -1.000000000000000e+00   -7.183820581338919e-01   -2.508096329676208e-01   -8.803693609240539e-01   +3.264286880519218e-01   +8.122687216161641e-01   +4.938650991395288e-02   -6.945656464302277e-01; -6.374250393831878e-01   +2.798648613266134e-01   -6.677703341730830e-01   +7.329981677707625e-01   +7.745077868285160e-01   +6.538050616743417e-01   -3.684188222862052e-01   -3.902963977416781e-01   +1.020254387830612e-01   +7.582088747493237e-01   -1.596270272900200e-01   +3.542331044091883e-01];
L6_L4_iAMPA_netcon = [-2.842208019107945e-01   +5.421853626268708e-01   +7.647919445494126e-01   -6.501150860052832e-01   +8.391412583431843e-01   +5.219747398090393e-01; -3.552253775056114e-01   -5.073244622967639e-01   +4.591827488400912e-01   +1.905569253940599e-01   -4.081017653867682e-01   +4.254056216945633e-01; -1.028815403354251e-01   -4.646127710633415e-01   -4.062747645953301e-01   -4.558044476754011e-01   +2.051261027953630e-01   +5.140596409041550e-01; +7.508550325715450e-01   +6.836067625609628e-01   +1.030806351368154e-01   -3.508172061992677e-01   -1.356462247728150e-01   +4.368669442209123e-01; +5.882529100939897e-01   +7.771923577691101e-02   +7.544648026988452e-01   +3.976452747422979e-01   +2.587267802102279e-01   +4.298664397427674e-02; +2.226576328242043e-01   +7.148570588226368e-01   -1.359333055135221e-01   +3.055794698782768e-03   +3.597947405496728e-01   +8.457959943550426e-01; -8.159346145201658e-01   +3.629415435945033e-01   +5.924818790831431e-01   -5.225460593681537e-01   +7.657594467163986e-02   -5.745520501445871e-02; -7.500686657492684e-01   +9.222889513355836e-01   -7.107174718091808e-01   -6.977881912474906e-01   -5.713204254549763e-01   -8.500099899213081e-01; -6.843497986312620e-01   +5.474674243553119e-01   +1.717616436561896e-01   -2.884172550591869e-01   -7.702999055805733e-01   -5.723906368664792e-01; +4.790449522085627e-01   +4.305903119359288e-02   -5.387257528229970e-01   +1.081216812398083e-02   -6.636291707971438e-01   -2.349186013009845e-02; -4.314500279904976e-01   +1.000000000000000e+00   +3.809911368903352e-02   -1.288184077843627e-02   -8.044129943243418e-02   +3.719945018673710e-01; -7.102670697756827e-02   +6.481378689545696e-01   -7.281866226863158e-01   +5.958241304533969e-01   -8.582051701293528e-02   +5.919078529028774e-01];
L5_L4_iAMPA_netcon = [-9.302598890087300e-01   +8.516631814045754e-01   +7.779713821168472e-01   +7.368465189251014e-01   +5.823473143747081e-01   -7.229196490779314e-01; -4.655728434156493e-01   +6.308807778526387e-01   -7.093312709631965e-01   +4.609734121388790e-01   -4.263412044721273e-01   +5.711928994013312e-01; +2.946270047516084e-01   +8.425206018751914e-01   -3.192765081165486e-02   +3.200147299767792e-01   -8.526467666777479e-01   -8.427059914962457e-01; +6.558117166624405e-01   -4.638296013273639e-01   +5.515716972289461e-01   -6.818609120023331e-01   +4.291978799862645e-01   -1.989813821413555e-01; -5.524871850009295e-01   -1.933465950580504e-01   +4.219586975533788e-01   -1.893587356976741e-01   +1.710908609344326e-01   +9.754607194006535e-01; -4.540890253321463e-01   -1.657807040255562e-02   +4.437738051289918e-01   -1.000000000000000e+00   -3.527308044688633e-01   +2.938027844042334e-01; -1.416750789941159e-01   -9.213934294965904e-01   +3.278893178618046e-01   -1.217396490514719e-01   -4.784970740574537e-01   +7.083573972930397e-01; -2.637403324789006e-01   +2.595757104280147e-01   -9.209171814281312e-01   -5.359372418294027e-01   -1.482927939969058e-01   +8.098976113013208e-01; +2.000860869320167e-01   +7.604764093317531e-01   +6.709072029551684e-01   +4.930109957992687e-01   +2.091338023096120e-01   -3.723589015528486e-01; +4.678386603891588e-01   -9.374972906952268e-01   +9.532497891588678e-01   -6.517192560522761e-01   +3.569361914876842e-01   +1.607803162099878e-02; +6.363587571696149e-01   +2.543231986340048e-01   +9.067626859268907e-01   -5.108429204631638e-01   -4.291095027002515e-01   +2.166857805108558e-01; -2.552914502872713e-01   -1.216740087027673e-01   -6.158372962969250e-01   +6.796855967492531e-01   +3.617912258944856e-01   +2.491867872485317e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
