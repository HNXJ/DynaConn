function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.984111236827875e-02   +6.598439339051573e-02   -6.578087863613061e-02   +3.898719967631512e-04   +1.979509256165096e-01   +1.437703834537763e-02   +2.991026809931152e-02   -1.075887099677073e-01   -5.074801914697329e-02; -4.180303486041832e-02   -6.263288938639811e-02   -5.112500060443385e-02   +2.624010176352197e-02   +3.966821445738430e-02   +1.607021074324654e-01   +1.084645234097694e-01   +8.883023472267004e-02   +1.174460609272314e-01; +6.016158186897747e-02   -8.368311923520647e-02   +1.444315555388588e-01   +5.088228288987880e-02   +2.310331857861896e-02   -1.413044274287343e-01   +7.383201417718263e-02   -3.164823292428817e-02   -3.883936154947849e-02; +1.068637534891098e-01   -3.811947937865644e-02   +6.146302434456804e-02   -8.201543006822698e-02   -2.803806416104736e-02   +2.235562866012869e-02   -1.773656292245078e-02   +1.173803501348374e-01   -3.731915775375263e-03; -3.555295878566446e-02   +8.328126749777801e-02   +8.099841730974058e-02   -4.126465495236535e-03   +4.978757306306971e-02   -3.463484092059220e-02   -4.469895834889761e-03   +1.065997971528701e-01   +5.462183548803801e-02; +1.362925461328511e-01   -8.861767300010145e-02   +4.898415195328915e-02   +4.982220275011176e-02   -7.580434847370507e-02   +7.855668436652344e-02   -3.302440122699622e-02   +4.265339640980505e-03   +6.292526128934386e-02; +1.322669203676771e-01   +7.429291336905862e-02   +3.752039323612508e-02   +1.772733029680550e-01   +1.813693022047418e-02   +1.094286912321903e-01   -3.148924661783884e-02   +1.494723590643026e-01   +2.918152135705166e-02; +9.681050004210455e-02   +1.183181858854630e-01   +1.605188616342465e-02   +8.209220050477080e-02   -7.873914240114314e-02   +2.370207650820104e-02   +4.469359674241220e-02   +5.144270393531646e-02   -2.799607683329815e-02; +1.425271564194399e-01   +1.720241576740607e-02   +7.041372601120707e-02   -5.833271809637426e-02   +8.050583763482963e-02   +3.124536305849929e-02   +1.118909640831714e-01   -1.621546088313601e-02   +2.341125322182517e-02];
L1_L2_iAMPA_netcon = [+1.223830814332074e-01   +6.539492511254426e-02   +1.321351146408576e-01   +1.009075367328010e-02   +1.052124309718142e-01   +8.516093259318031e-02   +2.213370530439454e-02   -4.754653728101803e-03   -1.939408602008813e-03; -5.604036668037962e-02   -1.550014377895388e-02   -2.059373222029164e-02   +1.378125820726275e-02   +1.061820888201034e-01   -1.472861876210928e-02   +2.633522818197844e-02   +9.782385955805031e-02   -4.891063959443488e-03; -4.526349072289051e-02   +5.875355888564625e-02   +1.640409934806760e-01   -6.040051969318404e-02   +1.569165840942054e-01   +4.108387159584314e-02   +1.574464871329390e-01   -2.166072730021135e-03   -8.380928486209013e-03; +6.496532846992416e-02   +8.781764520367213e-02   -3.795690171579554e-04   +7.800761866095704e-02   +1.031291112816776e-01   +6.288649035991035e-02   -1.389585477146808e-01   -5.818862147740309e-02   -1.198024621521353e-01; -1.083058404998482e-02   -6.904474236497818e-02   +9.476476808839875e-02   +3.660279247074209e-02   +9.228994980127810e-02   +1.018410421967421e-01   +1.363015221311024e-01   +8.377722090100039e-03   +1.836816628357092e-01; +1.011055288605592e-01   -5.250800662449667e-02   +9.232896493654259e-02   +1.491469259072465e-01   -5.102124980351577e-03   -6.739625391244890e-02   +7.962807718201595e-02   +9.511875244709872e-02   +1.507172907406043e-01; +4.561814208878340e-02   +3.077228523324208e-02   +1.016376995616142e-01   -4.964590832828433e-02   +9.317554470105051e-02   +4.403692851311380e-02   -5.885015560587412e-02   -2.146650784971160e-02   +3.998697416380627e-02; +6.117526791526022e-02   +2.613200485112994e-02   +1.023602435154836e-02   +3.679124300229931e-02   +1.816969150783239e-02   +3.184927637129075e-02   +5.642823157598625e-02   +1.211424066717938e-01   -1.031740904548961e-01; -1.298390274356049e-02   +1.218547709697274e-01   +4.495297431478831e-02   -3.660034005526547e-02   +1.197874817254738e-01   -3.594443816507907e-02   +7.842143230424864e-02   +1.467133461296297e-01   +1.178881014624851e-01];
L2_L5_iAMPA_netcon = [-4.297228240377589e-02   +3.176307898626778e-02   -3.790938692800165e-02   -8.379045011084524e-03   -2.405768141499959e-02   +9.089427745872178e-02   +1.634200827802420e-02   -1.293172683777469e-01   -6.482313262793676e-03; +1.083746839742465e-01   +7.825644943975463e-02   +1.284439062322362e-01   -8.367072814961497e-02   +2.676626791678545e-02   +6.465925657136500e-02   +6.572362414523439e-02   -7.082978520722684e-02   +3.922633961618264e-02; +3.292549388499711e-02   +8.088694855023622e-02   +8.433624166587607e-03   +7.284057099613980e-02   +1.568272225852554e-01   +1.844473832486195e-02   +3.806326396076976e-02   +5.983486025712312e-02   +1.884522837493188e-02; +2.987193873694758e-02   +1.743389109828433e-01   +1.513088154712904e-02   +3.408161162729313e-02   -2.576317483453601e-02   +4.669264690693946e-02   +4.516797143846971e-03   +2.760177565188532e-02   +3.236895219566527e-02; +2.809516352869354e-02   -5.286524716683111e-02   +1.293641457180581e-01   +3.722775314063884e-02   +1.353249552633492e-01   +1.683711380236785e-02   +9.208789785151450e-02   +1.694609279935434e-02   +4.410211433780512e-02; +7.733408760642345e-02   -1.140681182134378e-01   -5.326506119795398e-02   +3.440925754046711e-02   -9.711671183567472e-03   +1.354951783317194e-02   -4.104595010756204e-03   -1.515916459616322e-02   +3.697706675080666e-02];
L5_L2_iGABA_netcon = [+4.197514531793300e-03   +9.506880609978310e-03   +1.470954532882264e-01   +1.458009411211247e-02   +1.896632094952257e-01   +8.795844001813985e-02; +4.141110585087585e-02   +8.867093618522863e-02   +9.324214830056954e-02   +7.846936831889577e-02   +5.769303413314217e-02   +1.074694472938014e-01; +9.857425542662698e-02   +1.155707157832822e-01   +2.352124035615730e-01   +8.389178523966764e-02   -6.434790770556327e-02   +5.592718795459986e-02; +7.269793869789810e-02   -9.760279989552370e-02   -1.041760085654654e-01   +1.694857499608203e-02   +1.026191839783130e-02   +1.378182128425338e-02; +5.637648514393197e-02   +9.727791608511541e-02   +1.739146128851676e-01   +5.494639807133470e-02   -4.613001924422004e-02   +6.568323147193006e-02; -1.239521790826652e-01   +9.149807678994648e-02   +1.981514106113915e-02   +1.211357139976200e-01   +2.134678217682808e-02   +1.094104333873489e-02; -6.557836796105865e-02   -1.012280050719457e-01   +4.170262207613254e-02   +1.004034862603080e-01   +5.615587757638095e-02   +9.585835303335939e-02; -1.627685405568250e-02   +2.746196297924474e-02   +1.853027646373996e-01   +5.509976844847053e-03   -6.404702415266507e-03   +2.208737983106010e-01; +8.915644814187638e-02   +1.098028497999026e-01   +1.213805742802157e-02   +6.371765972149467e-02   +4.207908839890726e-02   -1.759588520335021e-02];
L3_L2_iAMPA_netcon = [+1.545027572309143e-02   -9.301648729147008e-02   +5.468585981550521e-02   -2.047663574873966e-02   +1.961529171443374e-02   +1.014588512299989e-01; +4.906088730037732e-02   +2.930282619899243e-02   +2.346023283258362e-02   +4.803722145056491e-02   +2.649838376754915e-02   +1.330042954741111e-02; +2.467638711641096e-02   -3.583614450244178e-02   +2.354626393204489e-02   +1.298064263725035e-01   -2.635248597749349e-02   +7.264578480057884e-02; +1.100006016255428e-03   -9.406031680572169e-02   -5.057751396184778e-04   +5.202695673740419e-02   +3.826067440108464e-02   +3.096655242886738e-02; +1.525096165281698e-01   -1.906260303939599e-02   +7.509268277644844e-02   +4.501250821543718e-02   +1.215338693003679e-02   +1.579976030388122e-01; +1.004177753049588e-01   +3.869852200346286e-02   +4.210852472994831e-02   +1.290645689493954e-01   +7.481409686254041e-03   -3.370742462317484e-02; +1.032911983610737e-01   +2.773287064784854e-02   -5.117325293272106e-02   +1.072476198564660e-01   -1.865265139391621e-02   +3.280972996755931e-02; +6.305708199018253e-02   +6.358086130815316e-02   +7.797124814273457e-02   +2.215965970679529e-02   -8.863191443084781e-02   +1.196874498286610e-02; +9.110411151448877e-02   +6.991688723485831e-02   -8.995961486905170e-02   +6.057216161668395e-02   +1.501756087508131e-01   +6.265934758501920e-02];
L2_L3_iGABA_netcon = [-2.044732895943637e-01   +8.965065830625310e-02   +3.816056804513990e-02   -3.350237271155170e-02   +5.164037212681950e-02   +7.366290620583547e-02   +4.082549152228594e-02   +7.861358169567273e-02   +1.338790014593291e-02; +1.017699826103629e-01   -2.057080362858732e-02   -2.523740413788381e-02   -3.847713225877636e-02   -4.022252338167066e-03   +1.844291122331130e-01   -4.407799206752532e-02   -4.705440537105461e-02   -6.370554244341452e-02; -1.731520460723398e-02   +1.017783238065779e-01   +6.703602580579709e-02   +5.548334857016467e-02   +1.019207142087716e-01   +3.435552134024528e-02   +1.125243814007779e-01   -5.385193269015692e-02   +1.198743382609705e-01; -1.504338262683243e-02   -7.049088602645529e-03   -1.372267650756481e-02   +1.171487835322543e-01   +1.216594031305100e-01   +2.644668328162419e-02   +1.232617200472496e-01   +1.174357725487152e-01   +3.897283090341420e-02; +7.534009125274405e-02   -1.139656818329122e-01   +2.363550338818839e-02   +1.530636270109532e-01   +3.155415673726057e-02   +7.082606673301886e-02   +9.313483099262414e-02   -5.701456566734514e-02   +7.025119271582944e-02; +5.012871413608437e-02   -2.037633814662625e-02   +2.836188394703055e-03   +2.809204547894770e-03   +6.413776436745304e-02   +1.869730421208125e-01   +1.624007318162044e-02   -3.045878135908168e-02   -5.352429704389004e-02];
L1_L4_iGABA_netcon = [+1.349098742479583e-01   +4.917348375485357e-02   +5.791905585918765e-02   +4.777694087084092e-02   +9.246581815122007e-02   +1.667384432508008e-01   -8.225671260652322e-02   +5.774779519297513e-02   -7.686629730269287e-02; -1.138218799591095e-03   +1.194966070671223e-02   +1.211760838253114e-01   +1.027337106254186e-01   +4.344663239491661e-02   -6.294650350310246e-02   +6.568071101218262e-02   -6.941787911465326e-02   +7.067156505633471e-02; +1.117301144631612e-01   +7.259825806984870e-02   +1.259955009913419e-01   -5.011177135296317e-02   +8.506406059816365e-02   +4.131993983182659e-02   -4.277766914349893e-02   -6.150504282387143e-02   +5.044551133781848e-02; -4.503045164322809e-02   -3.194513120493974e-02   +5.170209853044296e-02   +5.195508619576732e-03   +3.629837302003366e-02   +1.417611816365661e-01   +4.182666320286059e-02   +6.170732666554935e-02   +8.639504832870405e-02; -3.836525966877164e-02   +1.346097096684457e-01   -6.361458182927593e-02   -1.073096151065980e-01   +1.177538263854256e-01   +9.476752480373000e-03   -6.977145463164101e-03   +1.463155685761141e-01   +6.116102795695645e-02; +1.056658383754606e-02   +1.756095147679683e-02   +1.013009431067492e-01   +8.849104241854309e-02   +8.726686888036210e-02   +9.941390008893509e-02   +6.688218078338241e-03   +5.332966666934321e-02   +2.275596156559996e-02; +6.292372658289073e-02   +1.323442864554479e-01   +1.825141244176256e-02   +1.075246993890564e-01   +9.591623213851583e-02   +5.794601316640158e-02   +1.260131459982379e-01   +1.759963547237189e-01   -2.058071438789617e-03; +9.808678209467599e-02   +1.405018447191090e-01   +1.818436806252797e-02   -6.234412962599453e-02   -1.026853324566823e-01   -1.234055920934230e-03   +7.814205232265937e-02   +1.018407277051437e-01   +1.176190246267613e-01; -2.438293950754898e-02   +2.556988102532087e-04   +3.462762615186006e-02   -5.245488998309310e-02   +2.280130398205604e-02   -1.136216170479099e-02   +6.430626303338015e-02   +1.058590867104512e-01   +5.301836006522523e-03; +1.729949923717845e-01   -4.350488968283790e-03   -8.135656259620188e-03   +4.013491779820119e-03   +5.148554449375281e-02   +9.965157952298148e-02   +1.189493291561468e-01   -4.533055792470138e-02   +8.365333337132654e-02; +8.559297523264534e-02   +4.941216525845182e-02   +9.614015980284128e-02   +6.682661650165746e-02   +1.798242864882575e-02   +5.362205233826403e-02   -1.201061176724293e-02   +3.186303349434533e-02   -2.494025350835410e-02; +9.781774778804590e-02   -2.012494191356924e-02   -6.691084205004343e-03   +1.258419953238706e-01   +4.310239453735255e-02   +1.397229331079633e-02   +7.038883578723962e-02   +1.161740935971512e-01   +1.413429273584186e-01];
L4_L1_iGABA_netcon = [+1.339691023865610e-02   -6.230076238675102e-02   -2.865256888080677e-02   -2.578501989307279e-02   +2.048398452338726e-02   +9.729628556865242e-04   +6.545592255293822e-02   -1.054953779654941e-01   +3.477351451985872e-02   +8.544683004963782e-02   +3.423904534189594e-02   +4.904060977720774e-02; +1.053270565862474e-01   +2.869651062283956e-02   -3.664113507707660e-02   +4.977391621523814e-02   -8.612615272620161e-02   +5.033898642832715e-02   +8.824194886108576e-02   +3.510434377367409e-02   -6.146471047084977e-02   +5.756999145640686e-02   +3.549765404782346e-02   +7.181810562893719e-02; +2.493452786677335e-02   +7.288923807432483e-02   +4.339987314565621e-02   +7.053405222276611e-02   +5.321510571616931e-02   +8.233312067908076e-02   +1.525905071535819e-02   +8.077539655094289e-02   +1.214209959012016e-01   -1.426185205116506e-02   -7.000411965955369e-02   +1.638404914748166e-01; -3.538435206401912e-02   +5.209629939100460e-02   +1.122785001946102e-01   +5.862379647110862e-02   +6.777822701405777e-02   +3.503460617974297e-02   +7.380342471887458e-02   +9.461362973155160e-02   +4.042975323512526e-02   +1.294849645521471e-01   +9.265617484500369e-02   +9.323242330297954e-02; +9.144278202359747e-02   +8.750191955761710e-02   +1.151244889882245e-01   -4.715826886875461e-04   +6.273320277299950e-02   +1.166404153668227e-01   -1.646963230943187e-01   +1.164844759361197e-01   -1.012858099806804e-01   +9.222896203425444e-02   +3.992578607889385e-02   +6.115166581333007e-02; +5.750944947848433e-02   -7.481468845186674e-03   -1.827927064800434e-02   +1.055148666307569e-01   -5.870399448464470e-02   +7.327692875283347e-02   -1.019590478963732e-01   +6.930589356295325e-02   +8.423214356550242e-02   +7.850566796064944e-02   +3.195994060472991e-02   -4.820627723789665e-02; -4.199243043947579e-02   -4.199469277091530e-02   +1.118056774744742e-01   +1.244110247229978e-01   +3.203114388906100e-03   +9.742837616144315e-02   +6.983335566448127e-03   -8.985186499786965e-02   -5.959220419735817e-03   +1.264422102989196e-01   -2.529820349791476e-02   +3.239785923260712e-02; +1.036112907415941e-01   +1.141627233566414e-02   +1.281373614074595e-01   -4.640714165761756e-02   -4.728342068585577e-02   +7.161263749443442e-02   +1.238644108552429e-01   +1.319942241612734e-01   +9.719163185257454e-02   +3.132197213962577e-02   +1.586477841679581e-02   -1.635184389693241e-02; +1.688995232181610e-01   +1.368606927280788e-04   +1.464196886521159e-01   +6.245399552815084e-03   +1.566920342650361e-01   -1.215628139479220e-02   -1.975306517753238e-02   +4.248349373537040e-02   +1.477199961212062e-01   -8.850203404621657e-02   +1.734054526794983e-02   +8.872572851446414e-02];
L1_L3_iAMPA_netcon = [+6.521819331097037e-02   +1.607151718954616e-01   +7.677971033628365e-02   +1.273683440274164e-01   -2.850628438676270e-03   +1.107229867357282e-01   +1.893661943373894e-01   +2.200095352266761e-02   +2.405553287620168e-02; +2.237793174329923e-01   +9.834710492324826e-02   +9.917233262348737e-02   +1.667560188418716e-01   +1.144436106782504e-02   +3.133072506048341e-02   +1.620077430210685e-01   +9.279975694890548e-02   +1.294557398981891e-01; +4.781831538546946e-02   +7.536568425175363e-02   +1.148822123845981e-01   -1.032451252816314e-02   +5.047342893923913e-02   +8.041497419806967e-02   +3.605109068058338e-02   +6.076288103571445e-02   +1.157018417437692e-01; +1.428179352212088e-01   -1.357292827783877e-01   +1.519822120967739e-02   -5.288437204330600e-02   +9.982553182743169e-03   +4.258795786949078e-02   +1.700140571309725e-02   +1.352687576687751e-01   +1.154905343929683e-01; +3.962580463181148e-02   +5.171543895585493e-02   -2.717770480040289e-02   -1.481712724345059e-01   -2.289733348257615e-02   -5.512291557568855e-03   -4.633044024495016e-03   +7.062527542320290e-02   +4.138709673733262e-02; +4.895738247680521e-02   +1.410828365352451e-01   -6.019915687197785e-03   -5.782972546731076e-02   -3.082859643334320e-02   +4.792063959603583e-02   +1.567094220652557e-04   +2.303171953574220e-02   +1.472443798786804e-01];
L3_L1_iGABA_netcon = [+3.811984485438052e-02   -3.847242743122944e-02   +3.067974600623079e-02   -1.368396353843757e-02   +5.752128064431791e-02   -2.058644375077305e-02; +1.577981461752112e-01   +9.209692320895242e-02   +9.627461196254139e-02   +1.395094354442013e-01   -5.170611374031571e-03   -5.770670176222321e-02; +3.653701968576052e-02   +5.396962428986531e-02   -3.947423765304423e-04   +1.222891330421699e-02   +1.041927056695919e-01   +1.886878682803632e-02; +1.140241238651162e-01   -9.085613151821348e-02   +1.413350650999303e-02   +6.826296906600252e-02   +1.494997462502246e-01   +4.381375617056070e-02; +9.424906610043791e-02   -3.450176681485547e-02   +1.671524994439238e-02   +1.394448892545613e-04   +7.678381714737315e-02   +4.431133617243189e-02; -9.812857471687716e-02   +2.505143188010137e-03   +2.936367891565294e-02   -1.624305273207019e-02   +5.687468046579021e-02   +1.554425809088080e-01; -3.931154187301410e-02   +1.201255437300553e-02   +1.083091011053445e-01   -3.073363380658275e-03   +4.589842683199715e-02   +1.085273751335626e-01; +4.909518798296675e-02   +6.197949618704531e-02   +5.040061605743960e-03   +4.200298573710429e-02   +4.806321297333445e-02   +1.175082174204886e-01; +4.178666572810422e-02   -8.330503825751347e-03   +2.517358207617708e-02   -8.140562023066018e-03   +8.451875961295767e-02   -9.253557586104330e-02];
L5_Input1_iAMPA_netcon = [-4.556579592568812e-03   -4.575552612403501e-02   -3.787209399618832e-02   -4.823915243200335e-02   -1.753543986422911e-02   +3.894576734157401e-02];
L6_Input2_iAMPA_netcon = [+1.233120631479180e-02   +1.957104591212165e-02   +7.114109466953245e-02   +4.398377379466848e-02   +4.945767811783313e-02   -7.974541511216317e-02];
L5_L6_iAMPA_netcon = [+6.287479168579924e-02   +7.102982830462741e-02   +2.598407560379978e-02   +4.773626378722338e-02   +8.944381643377357e-02   +6.609821675971753e-02; +6.906181926030239e-02   +1.083431983917955e-01   -5.669263599448154e-02   -1.198725650984557e-01   +5.317946746362633e-02   +3.733571604916384e-02; +1.129758189894758e-02   +3.042368264368603e-02   -9.973704248794912e-02   +1.296742924696512e-01   +1.132808804941109e-01   +1.056765462907635e-01; +7.130060379612238e-02   +1.163899643161059e-01   +4.214241392331552e-02   +2.233127296650573e-01   -8.021994764639991e-03   +3.993678441169837e-02; +7.494048301166087e-02   +9.705865638761831e-03   +9.004914039750218e-02   +3.075387861768448e-02   +4.861945659818379e-03   +5.473894327515485e-02; -8.256255772944233e-03   -1.291029102798774e-01   -7.484528799113203e-02   -1.501229297304927e-02   +8.246437450952310e-02   +7.538834651657188e-03];
L4_L5_iAMPA_netcon = [+9.910439398901760e-02   +3.240535624197919e-02   +1.051255623136454e-01   +1.389121562750201e-01   -1.440186984078276e-02   -1.839753190648271e-03   +8.786004160566445e-02   +1.682570540912533e-01   -5.290210870377127e-02   -7.586236755525520e-02   -4.316694695956694e-02   +1.210863019421913e-02; +1.269016748987473e-01   +7.748713267765971e-02   +2.387643384045924e-02   +7.981957933485334e-02   +1.028582250369120e-01   +6.870592258529687e-02   +1.007250432334870e-01   +8.580749706218688e-02   +3.101915480238318e-02   +7.432683364374534e-02   +4.842757197594100e-02   +1.587273450178694e-01; +5.336453553982978e-02   -2.146975575710544e-02   -3.350861846802061e-02   +5.034059459257489e-02   -7.669958961539111e-02   +5.185049395271227e-02   -1.835731123904110e-02   +3.369913467539990e-03   +7.462118975537546e-02   +5.821423821529836e-04   +9.856216697905153e-02   +8.804612854234534e-02; +4.350476478168309e-02   -8.423540815686373e-02   +1.374894132957039e-01   +2.931918142688782e-02   +3.811563052484238e-02   +5.589344480909135e-02   +2.481040922389346e-02   +1.164321248508212e-01   -3.213746537005242e-02   +5.083633929354589e-02   -2.343540811174387e-02   +6.259967169698288e-02; +4.068898007717148e-02   +1.300576882569359e-01   +1.455624684878159e-01   -1.092376721120185e-01   +1.276139499185275e-01   +1.235611069684837e-01   +6.207077993091795e-03   +5.379883129757807e-02   -5.200500259348337e-02   +6.534778118093919e-02   -9.569577288846452e-02   +1.191317697104158e-01; -7.480968141927531e-02   +3.170406980926534e-02   -2.635050318841783e-02   +4.732723366408198e-02   -1.958141327773642e-02   +8.002717063915725e-02   +1.926030411499035e-03   +5.625479560897616e-02   -2.473551261522317e-02   +8.327644438340129e-02   +1.216015408697379e-01   -2.387575217454587e-02];
L6_L4_iAMPA_netcon = [+3.082356766610199e-02   +7.346836892990724e-02   -1.696566858906746e-01   +1.124289980753215e-01   +1.662915195203154e-01   -1.929454951105305e-02; +3.176480425453139e-02   -1.606703378223902e-02   +7.949277460965570e-02   +2.980262652517374e-02   +2.408025494504121e-02   +3.673315363742261e-02; +3.616394436150978e-02   +4.799409821143505e-02   +4.033137531803840e-02   +1.308296197385237e-01   +9.730543742512048e-02   +1.224999530533094e-01; +8.855866630545683e-02   +7.637811235977876e-02   +1.636068546957485e-01   +1.257256280065583e-01   +6.083427284332910e-02   +1.400419209745055e-01; +3.397443476049433e-02   -1.813309365118733e-03   +4.483141156029181e-02   -2.975400118101003e-02   +3.368989904665058e-02   -5.238301696132397e-02; +1.919794721132270e-02   +8.364865434048102e-02   +1.768630812566474e-01   +1.081888862429775e-01   +8.230470081485047e-02   +4.866464054136496e-02; -3.232931197135762e-02   +6.815258812247495e-02   +3.558686371757885e-02   +1.047574094767331e-01   +8.079975360296993e-02   +4.605744197871849e-02; +1.214803299051456e-02   +7.133260814046465e-02   -4.980692745368769e-02   -2.603101840797024e-02   +8.190855577377536e-02   +1.933499252593809e-02; +1.475860213311790e-02   -1.791902638776908e-02   +3.168525738265125e-02   +1.655383337883944e-02   -6.954919778458366e-02   -5.550684625331800e-02; -8.374755404409195e-03   +1.213603870511785e-01   +1.340350081312543e-01   +2.542573953697271e-01   +2.143533247595225e-01   -4.013194818705518e-02; +1.796756297929394e-01   +5.699216164441358e-02   +1.019397994284189e-01   +8.520600830054700e-03   -5.233987451998671e-02   +1.225847685584228e-01; +1.050746957558200e-01   +8.163650705082945e-02   +6.220564157849102e-03   +7.755326331460979e-02   +4.697025505217984e-02   +1.016542326040421e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
