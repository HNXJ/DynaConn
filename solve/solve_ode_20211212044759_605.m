function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.980346316206029e-02   +5.740838977243029e-02   -1.912752806202253e-01   +3.533416257617492e-02   +1.367466545226555e-01   +1.984894750130696e-01   -1.355770899900430e-01   +6.916738924975344e-02   -6.106270685260110e-02; +4.979115222539133e-01   +1.202135389185121e-01   -1.123050125955971e-01   +4.000811189784984e-02   +2.940220217701504e-02   -2.165872707892241e-03   +4.682603305446153e-03   -8.023631556971429e-02   -1.637244425018328e-01; +1.680340766395778e-01   +1.032162674872122e-01   -3.483858721064129e-02   +4.736648805602621e-02   -3.267661119925411e-01   +3.094844585124480e-02   +1.384148349704511e-01   -1.641388784530665e-01   +2.157041345178893e-01; -1.487193690142706e-02   -1.935203087583403e-01   -2.517095527331693e-01   +2.438224093917274e-02   -1.635492400694630e-01   -7.879503140222086e-02   +9.096562435677157e-02   -1.068183966292184e-02   -1.179069723682149e-01; -1.172560244524286e-01   +5.378361167411980e-02   +5.151740042859092e-02   -1.005229236037672e-01   -2.602611433727076e-01   +5.612806559567169e-02   +1.407069499765730e-01   +1.516306968995316e-01   -8.058593222178972e-03; +6.728336361555284e-02   -1.328368256125453e-02   +2.132362434919317e-02   +4.219462661853961e-02   -1.366975211061695e-01   -4.889269429968696e-02   -4.110843926949443e-02   -6.696225879024638e-02   +2.392878873736269e-01; +3.432054537384240e-01   +1.402126841987345e-01   +7.289432881798323e-02   +1.146354108027630e-01   +5.743341997954132e-02   +1.257607151991162e-01   -4.317932382188068e-01   +7.746622862109519e-02   +4.817256036755460e-02; +1.622190303781706e-01   -2.242844172428863e-01   +4.129827174708450e-02   -4.983852770883146e-03   +7.379948422001721e-02   -2.345630760431200e-01   +3.454080160788225e-02   -4.105532224806079e-02   -1.027371703787565e-01; +1.417109031073294e-02   -1.635472362539642e-01   -2.778665242086629e-02   -1.100407994673629e-01   -3.338546935765406e-01   +2.174674812195981e-01   +2.582829719497519e-01   -4.107310623582551e-02   -2.122583187112179e-01];
L1_L2_iAMPA_netcon = [-3.854868996009420e-01   +1.399697264930785e-01   -2.394472945491855e-01   +2.133183408057990e-01   -3.599650807025893e-01   -2.328261446494578e-01   -4.388775514369114e-02   +2.363705656302211e-01   -2.455050620179970e-01; -1.331887131197046e-01   +1.251298524596974e-02   +1.408340795795278e-01   +2.106606786576995e-01   -6.589587608502250e-03   +1.619692559908365e-01   +1.133695490877585e-01   -1.490209839129391e-01   +8.096072526944306e-02; +2.460891876320435e-02   -2.259162996237651e-01   +2.920231797477885e-03   +1.377121861069559e-01   -7.025609849181079e-02   +3.592628572066217e-01   +3.046446960884136e-01   -2.890147726788904e-01   -1.265214983059853e-01; -1.109852656646654e-01   +8.718523246736236e-02   +6.193316236850034e-02   +2.517006107982958e-01   -6.997260717817802e-02   +8.525054993868389e-02   -1.818373518619187e-01   +1.626526958273387e-01   -1.493015944727180e-01; -5.351381082195437e-02   +2.710793248434116e-02   -4.244864183188325e-02   -6.837249450837307e-02   -1.713596320293470e-03   -2.171747321331805e-01   -1.849475919915668e-01   +1.269707019207092e-01   +2.485572630412180e-01; +1.076132361602273e-01   -2.166619274590151e-01   -1.877144342099329e-02   -1.492777599797793e-01   -1.447963970202827e-01   +2.218910902421831e-01   +2.902513228561897e-02   +4.242524423005661e-02   -3.155519265525829e-02; +9.572197599549326e-02   +2.321332274783354e-01   -2.560818007834778e-01   -4.153681070017549e-02   -4.509481778527928e-02   -5.276191343248794e-02   +2.666360544783054e-01   +5.456388206519408e-02   +2.599412402250532e-01; -2.085107394172468e-01   -8.023404772696038e-02   -4.966486464980896e-02   -2.491674465648134e-01   +2.058664102245681e-01   +1.404530918055481e-01   -2.456908863837956e-01   +1.950940416822946e-01   -1.327061531537326e-01; +2.585788951338989e-01   -7.164125578740993e-02   -1.886695803260837e-01   +1.419769555452019e-01   -1.045834991572453e-01   -3.132107561484825e-02   +1.811690915282392e-01   +1.160423295291020e-01   -1.343372881215691e-01];
L2_L5_iAMPA_netcon = [-3.532213016016943e-02   -2.739043653920834e-01   +7.233646169617719e-02   +1.276723035558613e-01   +2.160083329592051e-01   -1.845002635499672e-01   -1.112526808188147e-01   -1.454959231742134e-01   +1.465738963861424e-01; -3.020807500341046e-01   -2.192229459368898e-01   +2.636018592298026e-01   +3.018734509917568e-01   -4.850800463102462e-02   -2.500657645533347e-01   -7.314980285281024e-02   +3.700028734109511e-01   +1.098992395689186e-01; +3.332818585881759e-01   +1.718054449476751e-02   +3.285556442489608e-01   +1.442510651620015e-01   +4.519352843956603e-03   -9.892385378450871e-03   -8.294966247941460e-02   -2.350065262057787e-02   +1.780154643842453e-01; -8.785186383893193e-02   +1.175284663480233e-01   -5.388573529736301e-02   +9.963805547447530e-02   +2.999075450308994e-01   -9.211958087716202e-02   -5.643435462595971e-02   -1.136610633231223e-01   +6.695659512947233e-03; -9.724938924998948e-02   +2.086487110429471e-02   -2.615002706122847e-01   -8.795613182011948e-02   +1.681440561527880e-01   +6.754283436799650e-02   +2.770772686937288e-01   +2.987172626559766e-03   -3.573616294626834e-02; -1.248030907750715e-01   -8.833527536269115e-02   +4.576896175842148e-02   +1.840138746507908e-01   +1.739151877702873e-01   +8.449636390312905e-02   -1.739614270433447e-01   -1.106601934829796e-01   +2.383656298249950e-02];
L5_L2_iGABA_netcon = [-5.911945362684180e-02   -1.465732086916611e-01   -2.675064426769081e-01   +9.715888182438639e-02   -3.409646436254337e-02   -2.702217196136718e-03; -1.248161586649138e-01   +3.622620155608824e-03   +4.688564303260220e-01   +4.897592016370044e-02   +1.368610529813739e-01   -3.386500987126706e-02; +4.275193366742525e-02   -3.679517082792054e-02   +1.788668074672333e-01   +1.936730135373533e-01   -2.437447702690601e-01   +3.348639099387669e-02; +5.774808899044490e-02   +1.422280814177489e-01   -1.610519221112176e-01   -2.135652327088567e-01   +1.833225657094583e-01   +1.659245682409725e-01; +1.771259922449118e-01   -1.430586380015001e-01   -1.136748654736321e-01   +1.259336456102416e-01   -1.288306848932655e-01   -4.813854706708606e-02; -1.444059844674315e-01   -4.811305189584807e-02   +8.722168087103865e-02   -7.571408944950085e-02   +1.136839426945020e-02   +5.672520941788258e-02; +6.406466043941020e-02   +4.619218795968962e-02   +1.932093108945946e-01   +7.209755991007524e-02   +3.469957039549514e-02   +3.179136266522549e-01; +9.269638813243719e-02   -1.606614136976700e-01   +1.922938952225465e-01   +2.417576896917072e-02   +1.418464190026336e-01   -9.864670775367992e-02; +1.922527818961203e-01   -7.495033148693898e-02   +5.540077555827719e-02   -8.272996173087234e-02   +1.714214997358630e-01   +2.670653543160013e-01];
L3_L2_iAMPA_netcon = [+1.332697367732929e-01   +2.005331463773736e-01   +8.726654114950486e-02   +1.414206736419668e-02   -1.616291484733953e-02   -5.383178335081257e-02; -9.453805464997614e-02   -1.353818037319056e-01   -1.406734673225427e-01   +2.260257294005734e-02   +2.714446616043103e-01   -1.316279971834897e-01; -1.284270077307840e-01   +2.943335387888465e-01   -1.569995314089889e-01   -2.561911836105583e-01   +1.276051449864032e-02   -2.327886494963904e-01; +1.610248241553970e-01   -1.380485551030621e-01   -1.121000724853224e-01   -2.349755850018201e-02   -6.816105294676011e-02   -1.661228508387428e-01; +1.934842636610311e-01   +1.332095928316633e-01   +4.955042691510621e-02   +9.978573632535342e-02   -2.719502659525512e-02   -2.148296423270535e-01; +2.842036779937076e-01   +1.042208554163706e-01   -8.891933941924016e-03   -1.080681036405242e-02   +1.345662900319025e-01   -1.202241923725242e-03; +9.911160560723506e-02   -8.067157561191751e-03   +1.891863076501381e-01   -6.746959969108206e-02   +9.849892612520689e-03   +4.282002770116388e-02; -1.672784859912285e-02   -4.292698237637690e-01   +2.750048036632052e-01   -2.202807051613082e-01   +5.378018892077282e-02   -1.318658722287376e-01; +5.188066895033272e-02   -8.524844770234809e-02   -2.866842667296054e-01   -2.293809766439690e-01   -3.111719226615251e-01   +5.863404160659501e-02];
L2_L3_iGABA_netcon = [+1.752388818153042e-01   +2.005305535904541e-01   +4.200451284111976e-02   -2.422206869016529e-01   -1.030866490087038e-01   +5.265061268249433e-02   -6.138228693220543e-02   -7.649845943669387e-02   -1.687052258267842e-01; -1.500590662419299e-01   +1.023304560600338e-02   -1.237293732865572e-01   +1.856883863831566e-01   +1.213901389225554e-02   +2.356665304290043e-02   -1.309499833418556e-01   -1.890684792402408e-01   +8.717362319385610e-02; +1.988109852690551e-01   +6.566394398314616e-02   +1.142979423797564e-01   +1.294965635230587e-01   +3.297124015823541e-01   -1.132326508035742e-01   +1.156262416282704e-01   -1.557791453863047e-01   -2.043766080752120e-01; -1.002561311077348e-02   -8.732468735366924e-02   -1.019964037393781e-01   -1.605991211966444e-01   +6.741906250829821e-03   -1.148164638769447e-02   +6.118522478340616e-02   -1.191398451631210e-02   +1.234916018306994e-01; -7.442782390037336e-02   -1.514774407323072e-01   +2.284631400350426e-01   +1.783604504994115e-01   -1.556519243069440e-01   -1.024268915068382e-01   +1.674069734745064e-01   +1.620400333639547e-01   -3.517954848969586e-02; +1.937315718271394e-02   +2.880291714482489e-01   +1.002226338349643e-01   -2.916897939796241e-01   -1.287337868372607e-01   -2.415012353247650e-01   -1.583216179036742e-01   +1.238691198325592e-04   -1.428430683578978e-01];
L1_L4_iGABA_netcon = [-3.488286152162010e-01   +2.519166880354432e-01   -3.445545646708127e-01   -1.234402255385848e-01   +2.948264315317660e-03   +3.091009759700505e-01   +2.006196225341929e-01   +2.321685889767454e-01   +9.086683083343901e-02; +1.719640728988654e-01   -5.429064279962804e-02   -2.448439707557454e-01   -2.989501587202438e-01   -2.332014125306669e-01   +1.329245834914093e-01   -3.531817351895320e-02   +1.362610180022698e-01   -1.361425877862192e-01; +2.032016526996579e-01   +1.587113105148969e-01   +1.664904446203563e-02   +2.255176784438636e-02   -1.919382025686301e-01   +4.519200379233446e-02   -2.440857932561290e-01   +1.010059699477574e-01   -1.956206602374649e-01; +5.072554262361083e-02   +1.127617197821737e-01   +6.704066948687186e-03   +6.321659782000484e-02   -2.732287841731973e-01   -6.977917453065198e-03   +1.323835942993788e-01   -5.997270820557276e-03   -1.172491902910686e-01; -7.223096368464312e-02   +1.597432277475612e-01   +4.244413084114031e-03   -3.891647843316240e-01   -2.227400360655850e-01   +5.448160250979327e-02   +1.459880967748223e-01   +2.836034399010696e-01   -2.262077560238260e-01; -9.141297699178087e-02   -3.041268374171464e-02   +1.058453838886159e-01   -2.683936648677853e-01   +2.946915874366685e-01   -8.633963271241905e-03   -1.424173715129604e-01   +1.664081946399500e-01   -1.618413762473847e-01; +2.324409643699304e-02   -1.037458928283648e-01   -1.022455818210730e-01   +1.640313009442702e-01   +1.819669488390096e-01   -5.668157624760936e-02   +2.621948514664666e-01   +5.336127061283140e-03   -1.485959902212696e-01; +1.817774487855389e-01   +2.162022586314472e-01   +7.776642979893370e-02   -1.511007064861600e-01   -4.803703919003201e-02   -5.691949810703605e-02   +1.844634219367389e-01   +1.492787990633797e-01   -1.266593409049619e-01; +4.676647233698412e-02   -1.530168322619595e-02   -1.415727114950929e-01   -1.603532346424751e-01   +7.474390440328163e-02   -1.413262277940288e-01   +1.132775610720277e-01   -1.010666900018319e-02   +5.182733232180324e-02; +6.346197573840935e-02   -2.467981501192663e-01   -1.314924813463234e-01   -1.423873212212843e-01   -8.347212356938377e-02   +2.159009275027121e-01   +1.921571869793623e-01   -1.562525062000045e-01   +8.985110471287394e-02; -1.178854311769919e-01   +2.609042264696703e-01   +2.038555263621762e-01   -4.338321248604101e-01   +8.115946076337963e-03   +2.671308020941322e-01   +4.561234638844728e-01   +9.184042078164542e-02   +1.886997677690458e-01; -1.800454371565527e-01   -7.685595651700730e-02   -1.119102505677499e-01   +1.485515630103348e-01   +8.932744457422254e-02   -1.021760222509521e-01   -3.098867711216945e-01   -9.854144118049223e-02   +2.123437014135675e-01];
L4_L1_iAMPA_netcon = [-8.577637398509326e-02   +4.522974243107995e-02   +8.579220651218272e-02   +2.874733061939713e-01   +9.109200946753118e-03   -5.660907723970701e-02   -1.914799806026520e-01   +7.473959996386770e-02   +2.822012750181929e-01   +7.244800620275686e-02   +4.955288974204703e-02   +8.529642763623650e-02; +3.829848957245841e-01   -2.165146528814380e-01   +1.929578192826295e-01   -4.606386139528321e-02   +2.373696476879515e-01   +3.680419188778878e-01   +1.539082006098046e-01   -9.016591712570611e-02   -2.380756553938496e-01   +6.180873319038445e-02   -1.250121659016367e-01   +5.225330453391102e-02; +1.526558936968969e-01   +1.409338645433207e-02   +1.118175590661480e-01   -1.210298122639853e-01   +9.563116842654194e-02   +9.466677952466439e-02   +8.025026895379872e-03   -2.368336104059156e-01   -8.765283056661217e-02   -1.550901106018895e-01   +2.500702996354624e-01   +1.197628185844512e-01; -8.781475103374900e-02   -1.598614789732250e-01   +3.156156717857164e-01   +3.778358008221031e-01   -2.618481214394938e-01   +2.295336419693542e-01   +1.389491589959653e-02   -2.057033211792098e-04   -5.200256592108252e-03   +8.282706224385530e-02   +6.087729962150068e-03   -1.042198389710658e-02; -8.280712423563687e-02   +1.355024793348722e-01   +2.320316053333141e-02   +1.024040205977922e-01   -2.602200464511356e-01   -5.394773926751369e-02   -1.582640455090003e-01   -3.074699229125145e-01   -4.094200053719864e-02   -1.261453842776806e-02   +8.693411058437905e-02   -1.802758585100125e-01; -7.378671219148313e-02   -6.243709890523667e-02   -6.011542615108030e-02   +7.998374728579764e-02   +1.040243870486512e-03   +6.476754092922167e-02   -1.751466447934002e-01   -2.420890615874089e-01   +1.225018921700123e-01   +1.594437857350265e-01   +1.705516342876905e-01   +5.563016902237664e-03; -3.120570758737053e-02   +2.916441913079508e-03   -8.633440120063580e-02   -9.588410216882939e-02   +1.332099100436855e-01   -4.205198858399678e-03   +3.366317349931795e-02   +2.242194944647492e-01   -2.094616316250920e-01   +1.850986973909208e-02   +1.524715593046489e-01   +1.100472395803876e-01; -6.529418243551594e-02   +3.895127927349866e-02   -3.229062550822656e-01   -1.137909190739976e-01   -3.862857132874842e-02   -2.169661812613704e-02   -7.672930778930057e-02   -1.425913206345802e-01   -1.603821368848129e-01   -2.882863060015988e-01   +8.949111603830376e-02   +3.121088931155487e-03; +6.437129363279434e-02   +4.412048800079671e-02   -9.262459312773690e-03   +1.755590546582084e-01   +7.593415924022877e-02   -6.606356174498798e-03   -4.647089043705782e-02   +4.757459691987848e-02   +4.518308724343759e-02   +8.397914621766450e-02   -1.517685449172548e-01   +2.129460653067272e-01];
L1_L3_iAMPA_netcon = [-1.090680850165921e-01   +1.002693234467562e-01   -2.872409325768263e-02   -1.461950431719217e-01   +5.575027367572701e-02   -3.979118039059988e-01   -7.221262310921184e-02   +1.176303287728536e-01   +3.666243031150245e-01; -2.974879995718756e-01   +1.159935609822092e-01   +2.526539377670304e-01   +2.878383200324677e-02   +1.367161214564980e-01   +8.109694940552380e-02   -7.691401261647468e-02   -2.126360094449522e-01   +3.591561780286481e-03; +2.791443691189741e-02   -5.951243850872345e-02   -2.972859430688519e-01   -1.107867750565586e-01   +1.371327971494019e-01   -2.128346327024651e-02   +3.478852811490679e-01   +1.928619657683167e-01   -1.228794354086512e-01; -2.825875758279961e-02   +1.249553254709940e-01   +3.890916654776620e-02   +1.937221994780673e-01   +1.435991098559251e-02   -3.253407880447938e-02   +5.829453123015192e-02   +1.596568251591648e-01   -1.021179318081654e-02; +2.348725370437136e-01   +1.150604377724498e-01   -1.185557338665219e-01   -3.175687261311820e-01   +2.060616064910626e-01   -3.215338028543882e-02   -7.936989156671688e-03   +8.931498860557459e-02   +1.819287851811191e-01; -1.301183695847986e-01   +3.781419188766051e-02   -2.388111209945770e-01   -1.839698970898302e-01   +1.522972230810435e-01   -1.461366115906715e-02   +2.497439178424581e-01   +6.990128740513035e-02   +1.161394581362781e-01];
L3_L1_iGABA_netcon = [-2.126701718045385e-01   -2.808802138557116e-01   -1.381089898883505e-01   -7.083987603816140e-02   -1.599307454137022e-01   +1.614979756812119e-01; +8.131080342517479e-02   -3.270693783488388e-01   -1.509856719052091e-01   +7.683351894976048e-02   -1.509661980226446e-01   -1.703401890921080e-04; -1.789820452844808e-01   +8.643484664416383e-02   -1.006359853739842e-01   -3.821469376745029e-01   +5.029955061255936e-02   +1.518113314881979e-01; +1.503771484848427e-01   -2.858271533486387e-01   -1.863764118179579e-01   -1.576219308212577e-01   +1.532321488778288e-01   -9.658704867585535e-02; +7.348970090375112e-02   -2.172473862729594e-02   +9.301838977745916e-02   +1.101807829272700e-01   +9.183504012454755e-02   -1.257739679750008e-01; +1.311485323281084e-02   -3.363836087108749e-01   -7.073394652589639e-03   +1.396253270791614e-01   +1.393981960179145e-01   -6.903895637197643e-02; +9.081012327637233e-02   +3.143899939227053e-01   +9.248634965185661e-02   -4.092363018100960e-02   -8.488458171750327e-02   -5.747091205132802e-02; +6.086799218648635e-02   -6.088291382272589e-02   +7.748669659552807e-02   -7.133040454458034e-02   +3.048203683419336e-01   +1.667125230163870e-02; -6.194241355322708e-02   +2.855372923733247e-02   +1.587716758882628e-01   -1.092481323164025e-01   -1.014197628475855e-01   +1.825072031641459e-01];
L5_Input1_iAMPA_netcon = [-2.067557017747572e-01   -1.185152463997363e-01   -2.493388865960930e-01   +2.422027269941541e-01   -4.018550331104567e-02   -1.095382409566085e-01];
L6_Input2_iAMPA_netcon = [-4.267249300643608e-02   +6.303123608389713e-02   +1.386001721609403e-02   -3.270952627647356e-02   +1.766996376395338e-01   +8.112064454218487e-02];
L5_L6_iAMPA_netcon = [+1.837460475304677e-02   -5.367419492426653e-03   -2.346346308941619e-01   +2.004007070511243e-01   -1.766277529847376e-01   -3.822788316585285e-01; +2.427823758072432e-02   +9.772953096762241e-02   +4.912176739590993e-02   -1.671059653846350e-02   +8.664518504337348e-02   -4.879343367759661e-02; -1.765729818243341e-01   +1.116003804953113e-01   +1.297626219763780e-01   -4.023257382317014e-03   -6.453990664775326e-02   -8.404931298387494e-02; +1.486832723341148e-01   -6.118719829914011e-02   -6.637487239166047e-02   -4.910646261382798e-01   -4.921895320417638e-02   +1.030591179295098e-02; -4.410898679414701e-02   +6.754370289713185e-02   +2.191339527213410e-01   -6.526428434169718e-02   -1.357675430699733e-01   +1.525481761215384e-01; -2.481510150255914e-01   -5.856321009491035e-02   +1.458337640746236e-02   -2.117570510103165e-01   +5.008023773021048e-02   +9.815055470315874e-02];
L4_L5_iGABA_netcon = [-1.328827212366935e-01   +4.023888601407176e-01   +3.709493014475291e-01   +3.349075208498880e-01   +6.084021906959956e-02   -1.307256912358638e-01   +2.528572565150968e-02   +9.027494992195757e-02   -3.346208532975659e-02   +4.088851614292874e-01   +1.097309325655901e-01   -2.470476742031401e-01; -2.620879933609852e-01   +7.633046604893090e-02   +2.522110748041407e-01   +1.103462411752884e-01   +6.928203543384054e-02   -1.949429697433221e-01   +1.799646899406343e-01   +1.623680266996181e-01   -1.039188030674865e-01   -4.860312624740330e-02   +1.410752083962278e-01   +2.834980645640491e-02; -2.681913839817781e-01   +3.821257396959325e-02   +6.479833670497093e-03   -2.778839510152238e-01   -3.269379985557051e-02   -4.188680912550757e-02   -1.474960655243790e-01   -1.862025181079909e-02   -3.564556618577809e-01   +3.160732648867021e-01   -1.899118557120543e-01   +2.043491826903994e-01; +2.438254975454527e-01   +2.199328082517843e-01   -2.816264521905836e-01   +6.777166609971816e-02   +2.239637751625466e-01   -3.289396662231383e-02   +2.271514461200847e-01   +1.082355153354562e-01   -8.218804760630022e-02   +5.479123690665502e-02   +2.274277178012145e-01   +2.275670355606807e-01; +2.184939364574818e-01   +1.249635395713200e-01   -1.778024306776519e-01   +8.787806343257652e-02   -1.782205938058469e-02   -1.425054941652151e-02   +7.137306421890972e-02   -1.597052316703483e-01   +1.274279816585236e-01   -1.275852744728126e-02   +2.613791207939975e-01   -1.774021023392214e-01; +5.442960510749577e-02   -1.957693324210849e-03   -1.199409828161691e-01   -6.237301670147649e-02   +1.608888853404691e-01   -2.883047842201839e-02   -7.625228863837666e-03   +2.086004200116899e-01   +1.883209446816619e-01   -4.175257707005577e-03   -8.454017620745659e-02   +8.224574697845731e-02];
L6_L4_iAMPA_netcon = [-6.010692595896643e-03   -4.331249111724664e-01   -1.457041695073192e-01   -1.720089359860219e-01   +4.711189536657935e-01   -6.112870519498680e-02; +6.317711765828905e-02   -2.151047572822365e-01   -2.216796660896232e-02   -1.150342293042165e-01   -1.779768828590791e-01   +2.242421572973353e-01; -1.265216567803831e-01   -3.182732824324838e-01   -3.605836312876960e-03   -8.436291465229624e-02   +4.790702804417468e-02   +8.959199010131016e-02; +8.753928198364840e-02   -3.419008989919767e-01   -1.165455322447686e-01   -2.003521334495714e-01   +5.060393985714014e-04   +2.891032278353410e-01; -8.549285756400071e-02   +2.035980952338098e-01   +2.019268264923405e-01   -1.033544413957548e-01   +1.413613575478572e-01   +9.008906816326423e-02; +7.925100703322442e-02   +1.351967557926712e-01   +4.980237886494453e-02   -1.202939347028102e-01   +2.030443100751681e-02   -2.366366024006534e-01; +1.064621586174536e-01   +1.685589652236410e-01   -2.037000032926128e-01   -6.770307005286698e-02   -7.305308468565877e-02   +2.647750431560947e-01; +1.826757014579850e-02   +6.533963378803742e-02   +4.327393183776496e-01   +1.583974461324566e-01   -1.982726329379220e-01   -6.976326024300247e-02; -1.292132857724304e-01   -2.286446832469371e-01   -8.682146692284504e-02   -7.131538880193115e-02   +4.970469538248005e-02   -2.141837742708483e-02; +3.303158779256712e-01   +5.504954411402196e-02   -4.915068364733824e-02   -3.233720534309620e-01   +4.233639909047168e-01   -1.668728737854632e-01; +3.069672003523931e-02   -1.397328371428104e-01   +2.309450582737888e-01   +4.099375080460316e-02   +6.747860130577493e-02   +1.090001039405498e-01; +4.737380822594875e-02   -2.524194452813098e-02   +2.044702403143459e-01   -1.217190690474356e-01   +9.247110779590002e-02   +5.502941712281674e-02];
L5_L4_iAMPA_netcon = [-3.020882373238357e-01   -3.601470175929501e-01   +1.704831373849869e-01   -4.161955410511008e-02   +1.244478712572119e-01   +1.801884647063323e-01; +8.281834062631779e-02   -2.228858099406658e-01   +1.703830317766550e-01   +5.568763018553897e-02   +1.525688123765793e-01   +8.434617604884602e-02; +9.441785273319338e-02   +3.199629475084554e-01   -3.799995591958150e-02   +6.709707391047132e-02   -6.202896543137275e-02   +3.648124687432150e-01; -1.828532313144058e-01   -1.665701154509470e-01   -1.274488736100438e-01   +1.050277002465265e-01   -1.216244425796617e-01   -1.805108241734834e-01; +1.978630124310826e-01   +3.328429510127806e-01   +1.605037948565568e-01   -2.940623634265983e-02   +7.109538931258128e-02   -2.256616109046098e-01; -9.743789836523707e-02   -1.596324271374951e-02   -6.052698945606630e-03   -7.893414767110077e-02   +1.834691896958155e-01   -1.187485136492555e-01; +9.490448940686591e-02   -1.566841727126119e-01   -5.228042097601711e-02   -1.694845054937934e-01   +2.110637093336889e-01   +1.344931469446695e-01; -2.659404669337454e-02   +3.028616369060843e-01   -1.748046387875823e-01   +6.129994211120390e-02   +1.112204966086303e-02   +2.415009320436827e-01; +8.910166945782605e-02   -1.525850594033053e-01   +1.688860324202597e-01   +8.590749898398989e-02   -1.048464771570681e-01   -6.171283758498482e-02; +4.353233835967100e-02   +1.620506869773764e-01   -1.626738591523747e-01   +1.214449730328789e-01   -2.862039788771362e-01   -1.028887920278153e-01; -1.028796602015396e-01   -1.113517913816712e-01   +2.579758752008607e-01   +1.600735402322440e-01   -1.140485889979191e-03   -1.944313970460441e-01; +7.685064212968273e-02   -3.452095656912670e-01   -1.969751996227744e-01   +6.416597814702558e-02   -4.562722364359806e-02   -1.951886060257590e-03];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
