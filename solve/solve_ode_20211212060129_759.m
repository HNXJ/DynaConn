function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-8.007369451447220e-01   -9.143840979416427e-01   -6.830890484428975e-01   +5.381643179134151e-01   -1.367938681167489e-01   -1.219922735962141e-01   +6.242751865312496e-01   +6.460335895547424e-01   -9.004882562900898e-01; -4.366596089045446e-01   -8.799701409587825e-01   -3.848111641019554e-01   -1.689942577761379e-01   +2.037153077716582e-01   +1.420197469222659e-01   +8.119044513113517e-01   -3.220151246335370e-01   +6.236852509738490e-01; +2.567588846916997e-01   +4.773221291841968e-02   -5.361208630642619e-01   +6.386401114305370e-01   -4.383300330061095e-01   +3.871119206240559e-01   +1.128632182924899e-01   +1.540648075789037e-01   -1.842819078132120e-01; +4.953074310827579e-01   +4.488490099497033e-03   +4.412270214744067e-01   -3.196876950363069e-01   +2.715411869111172e-01   -1.123091052644441e-01   +3.485120597768359e-01   +3.265071271198576e-02   +4.535695954838762e-01; -7.622499123043282e-02   +8.480043237762923e-01   +6.700983015798639e-01   +3.867568791238862e-01   +4.918429572067546e-01   -4.583214942769113e-01   -8.493932011942309e-01   -1.854689410621890e-02   +2.775251154700091e-01; -4.857073200754747e-01   -8.224262108232974e-02   -1.292292889648271e-01   +7.514912187855661e-01   +7.963000068754899e-01   -7.623467444474932e-01   +2.486794917132152e-01   -7.048714670259735e-01   +2.107264523305258e-01; -1.000000000000000e+00   +7.898870979431314e-01   +2.037617589155440e-01   +3.425025637073617e-01   +6.135600420173043e-01   -2.738072635282447e-01   -4.277217997312198e-01   +2.490642203129456e-01   -3.403510821780536e-01; +7.617853613104383e-01   -4.432264690621471e-01   +3.594474280603649e-01   -4.525428670634919e-01   -1.342775812761258e-01   +4.643770433651287e-01   -5.712248633237650e-01   -4.220792628230338e-01   -4.345225762748732e-01; +2.702708207724999e-01   -6.414300027847621e-01   +3.282297414855788e-01   -8.538799372471738e-02   +7.045887707380453e-01   +9.693152682382494e-02   +2.101625628676663e-01   -6.468236582405673e-01   +1.408022756720395e-01];
L1_L2_iAMPA_netcon = [+3.982373516386890e-01   -6.738613086552422e-02   -6.947314740996505e-01   +2.594596452311898e-01   -4.844695845553341e-01   +1.000000000000000e+00   -3.855849511379846e-01   +4.914823060832774e-01   +4.009420250926226e-01; +2.111827658481250e-01   -6.536586949252489e-02   +1.494602451545934e-01   +4.914147376883503e-01   +5.235619843396058e-01   -3.128152516802232e-01   +2.481206759675066e-01   -3.999442952466243e-01   +8.523877638539709e-01; +6.177646895777695e-01   +8.233043572077644e-01   -5.287765953895107e-01   +6.547276746420240e-01   +8.483957877416394e-01   +8.975315631070877e-01   +6.671874336455266e-01   -1.474388444966414e-02   +5.822661029124517e-01; -5.112786502735718e-01   +3.469619232926623e-01   -2.850190856895858e-01   -4.758336937127706e-01   +3.193043192468890e-01   +6.108058565282439e-01   +2.179477768795784e-01   +1.297258392305989e-01   -3.594623330761567e-01; +4.145490522842307e-01   +5.121183619873083e-01   -1.711766226233890e-01   -7.284000223642640e-01   +5.921574341059104e-01   +8.504782615467384e-01   +1.478888550233860e-01   +8.374246739714779e-01   +1.578328985167280e-01; +7.040041275674411e-01   -4.653169532490175e-01   +6.713864651083870e-02   +7.729514798544199e-01   -1.393245429211852e-01   -1.177660653847901e-01   +6.539604395576716e-01   -3.224074933919131e-01   -3.419139082481406e-01; +4.329159752885350e-01   +8.737927767050057e-01   -8.593310408424266e-01   +2.661026056161201e-01   +8.375116766668664e-01   +5.712109994515392e-01   +5.037031580146840e-01   -1.199096478620222e-01   +6.280602322715534e-02; -5.968928791415534e-03   +8.424747777310503e-01   +3.776416706668247e-01   +5.349312211139703e-01   -8.606552335854306e-02   -8.664919443576146e-01   -7.748916456276799e-01   +3.662099946907198e-01   +6.530724919582209e-01; +3.992269494505526e-01   -8.609841778339493e-01   -3.847448748874620e-01   -3.788072016979627e-01   +7.868936228849379e-01   +7.309445185192246e-01   -7.053760966150137e-01   -6.809248146853563e-01   +3.977724661171554e-01];
L2_L5_iAMPA_netcon = [+1.559680118024795e-01   -1.465175108519349e-01   -3.587452159643487e-01   +1.582336333293765e-01   -3.731398450658325e-01   -1.038765088532480e-01   +5.947373905462952e-02   +6.981784563946672e-02   +9.488739204036046e-03; -3.693311824638663e-01   +2.395039117925301e-02   -3.659117302860735e-01   -9.678880722656927e-01   +3.571546738287173e-01   -5.942702097356924e-01   -6.295300924656462e-01   -6.921156857739512e-01   +8.554977349920505e-01; -5.318026462543085e-01   +8.037247673920557e-01   -2.953513208093534e-01   -2.320415303913947e-01   +4.737462153635241e-01   -6.555406898655273e-01   +5.372973291709834e-01   +5.966321890571373e-01   +3.061780080265960e-01; +1.000000000000000e+00   -4.770718621288261e-01   -9.162415178421712e-01   +2.097203547354132e-01   +6.540285186901034e-01   -5.188464962316491e-01   -9.235815831231472e-01   -1.638244220600479e-01   +4.754344038693232e-01; +9.754764699149917e-01   +7.922637559347502e-01   -6.110920386045455e-01   +4.315911918782357e-01   +2.576110854980648e-01   +8.942499128222225e-01   +3.978392649919781e-01   +6.849489414657773e-01   -8.277733371106559e-01; -2.009752516454126e-01   -4.702332409454387e-01   -5.296105390660881e-01   +5.194228112247756e-01   -1.548610199852670e-01   +3.822815839853514e-01   -1.351629181381382e-01   +6.581462573838592e-02   +6.765419035525431e-01];
L5_L2_iGABA_netcon = [-1.693360268665674e-01   -2.418616042801855e-01   +3.459636331402643e-01   +7.871229773014234e-02   +2.502132528204712e-01   +8.668090015023394e-01; +4.935110968912503e-01   +4.077719330983713e-01   +7.022203805421558e-02   -7.895469811124848e-01   -2.125157346115816e-01   +3.204740055546620e-01; +9.745506334687909e-01   -5.386728438206259e-01   -6.870476626165384e-01   +5.029854223195815e-01   +2.905137088990692e-01   +5.892626955087249e-01; +6.180498011562885e-01   +6.885332993079947e-01   +4.948014945165718e-02   +4.883960010846804e-01   +2.753577360304465e-01   +1.891217147008932e-01; -2.827865467530664e-01   -4.814722948810434e-01   -8.964120541367414e-01   -6.700511069188626e-02   +4.533331662403798e-01   +1.098459099142511e-01; +1.045615904215186e-01   +5.524116374371741e-01   -1.937915979867718e-01   -6.331352836168599e-01   -1.076618248423512e-01   +4.702991892375933e-01; -1.387890502277516e-01   +7.909854480771178e-01   +1.468235664307835e-01   -5.761560576633342e-01   -7.328425864874373e-01   -9.903416836257383e-01; +4.136722929742315e-01   -3.302892933422092e-02   +6.273547777725651e-01   -7.372505871400373e-01   +5.410073972794425e-01   -6.732534697162085e-01; -6.921553297430769e-01   -6.021465733930989e-02   +1.000000000000000e+00   +4.792881147639634e-01   -2.203992283044579e-01   +7.282188827010269e-01];
L3_L2_iAMPA_netcon = [+4.182316596897691e-01   +7.933858991445571e-02   +5.729834243991825e-01   +7.462411059928088e-01   +1.000000000000000e+00   -1.634580647117511e-01; +5.085352511434595e-01   -1.212224648023857e-02   -1.110506074997417e-02   -1.582312600793404e-01   -2.712084126002798e-01   +4.816249853434887e-03; -6.768497961817597e-01   +6.457841256027863e-01   -1.454301065367609e-02   -2.888450059665319e-01   +3.862935197753818e-01   -3.685733193488167e-01; +1.264046345819875e-01   +1.635791129072499e-02   -7.652830431218662e-01   +8.932217258579038e-01   +8.334516969328373e-01   -7.448003280036128e-01; -2.286433569886563e-02   -1.025117619626179e-01   +6.684273349466861e-02   +2.569229348460170e-01   +5.906980559758158e-01   +1.437080772885875e-01; +4.516311108742705e-01   -4.767894094707689e-01   -1.653223593201020e-01   -7.981353862696583e-02   +6.043401302949599e-01   -6.495231740123922e-02; +5.644180180954684e-01   +8.630757216687208e-01   -1.340253274238457e-01   -7.342025400154416e-01   +5.999149478008968e-01   +2.769358994346319e-01; +7.952324898546438e-01   +6.473738205950073e-01   +5.581617305946941e-01   +1.889425566053878e-01   +3.229954445005845e-01   +1.741875841482995e-02; -7.800714467666410e-01   +5.770306541916927e-01   +7.623198931524503e-01   -7.529840770815611e-01   +7.321490512889962e-01   -9.445454888636888e-01];
L2_L3_iGABA_netcon = [-7.514438459597070e-01   +6.389341382863438e-01   -8.332245424121852e-01   -5.873942683720705e-03   -1.965307559295053e-01   -6.517896723727566e-02   +7.103380923750195e-01   +9.201014052805460e-01   +3.197948583966141e-02; -3.406625371389427e-01   -7.776112335323323e-01   +6.168666010918910e-01   +1.665991930819207e-02   -3.267611490488896e-01   -9.605677294361348e-02   +6.976078271824856e-01   -4.297378681120669e-01   +1.476835446616251e-01; +3.156754218535696e-01   -6.314520947539611e-01   +4.154666509624595e-01   +5.133769390615517e-01   +4.260588598435821e-01   +5.934309897962636e-01   -8.850392278827496e-01   +1.707922134207040e-01   +4.473162854095455e-01; -3.683838230263427e-01   +3.067582632015292e-01   -5.799565008037186e-01   +4.602299335540638e-01   +3.301263686528818e-01   +5.557587710961800e-01   +1.000000000000000e+00   +3.594364351321775e-01   +7.563454289040796e-01; +3.281558046651882e-01   -9.507705524473897e-01   +1.868313575454622e-01   -8.390730197288512e-01   +2.161688715965190e-01   +2.129506002546020e-01   -9.193635232384154e-01   +3.415481787764344e-02   -6.652363576133868e-01; +5.569738831189720e-01   -8.811895439794509e-01   -5.027928766730815e-01   +7.645660268583626e-01   +6.771352840819597e-01   +2.049289366194160e-02   -1.807292843784287e-01   -7.609538690332491e-01   +6.468522308453829e-01];
L1_L4_iGABA_netcon = [-5.822376907758006e-01   -8.201759666863785e-01   +8.931785406527288e-01   +5.979736953912050e-01   -4.344686673779541e-01   -5.190341990478468e-02   -3.292244178847441e-02   +4.855861282240551e-01   -2.730615105811174e-01; +4.974884455712133e-01   -5.610009442348138e-01   -6.564757587416251e-01   +5.974557474100125e-01   -3.465584218203310e-01   -1.381522398328221e-01   -1.000000000000000e+00   -7.046788634222232e-01   -1.367080359589672e-01; +4.931569149558088e-01   -6.025199466994385e-01   +3.584917028292439e-01   +3.419322118136484e-01   +2.181155544721536e-01   +7.690597622211366e-01   -3.186334271201706e-01   +7.149738028565159e-01   -3.616250913887180e-01; -4.562928132433358e-01   -7.094657015584234e-01   -5.736229869123144e-01   -4.357015187738220e-01   +2.633439610198549e-01   -7.887701384761319e-01   -6.979350855452376e-01   +7.147273730297066e-01   +8.639766888147679e-01; -5.644454203921925e-01   +3.857684481067701e-01   -4.026758620927009e-01   -5.479402787203046e-01   +4.500183786577721e-03   +5.070857891368907e-03   -4.205712151875841e-01   -3.222023068675872e-01   +8.366715405842987e-01; +5.574747467584833e-02   +5.539418630275350e-01   -1.723145729654500e-01   -2.506510881656341e-01   -8.379578984274699e-01   +6.153084631126874e-01   +6.837139470938784e-02   -6.659354153236891e-01   -2.732721894070940e-01; -7.715354313446328e-01   +6.195903685301858e-01   +2.866507794881654e-01   +6.778787740796577e-01   -1.147665977131730e-01   -4.142000464346877e-01   +7.287482459346954e-01   +4.705951350487322e-01   +4.175914264366932e-01; +3.928522857856503e-02   -1.052878783418406e-01   -2.763542568562761e-01   +4.606129269703282e-01   -4.834032695527921e-01   -4.643929411663159e-01   +3.346860040475776e-01   -8.651794527941652e-01   -8.677168683744463e-02; +5.342573108166653e-01   +4.126164169452876e-01   +6.621820259828489e-01   +2.998754540571072e-02   +9.484562722746882e-02   +5.753520514134796e-01   +3.149703237532583e-01   -3.921482877606099e-01   -2.094253533313795e-01; -1.562932093196147e-01   -5.835470419179328e-01   +7.514536284294422e-01   +1.793937599955341e-01   -7.085771621010317e-02   -6.495847709671365e-01   +3.961569380913839e-01   +7.185978576964465e-01   -7.744301633860872e-01; -6.163363236521432e-01   +2.015730592792302e-01   -5.962634279040012e-01   +5.153757131014849e-01   +7.287438377016767e-01   -1.670156725197861e-01   +6.826180436745756e-01   +5.065170561541680e-01   +1.568993785721005e-01; +3.880690402792130e-01   +6.301655962997373e-01   -5.565669090181092e-01   -7.003854268531680e-01   -8.991793986840528e-01   -1.927688290575833e-01   +7.242459779261847e-01   +4.505918445198942e-01   -7.559546472491969e-01];
L4_L1_iAMPA_netcon = [+3.883636511822118e-01   +5.570584565212439e-01   -4.906305412475263e-01   -5.858988466178691e-01   -4.459393878632384e-01   +8.539720552228929e-01   -2.197177366201337e-01   +6.088301196462639e-01   -2.524404233116148e-01   -4.798661196593376e-01   -8.616780110128076e-03   +5.020233067507165e-03; -3.620011524877461e-01   +5.180834053160159e-01   -4.664638655506765e-01   +6.732071915485237e-01   +1.491542319969393e-01   +3.533670416997546e-01   +1.000000000000000e+00   +6.811867538574536e-01   -3.224116655209190e-01   +7.116121940411375e-01   +4.844270196585360e-02   +1.592455069624466e-01; +2.440904601052624e-01   +3.375414505498632e-02   +5.012414353784691e-01   +2.394739876540452e-01   -3.362857196801888e-01   +5.463730688102558e-02   -7.599514290437981e-02   +2.111802472886057e-01   +2.366292524103673e-01   +2.808418350530141e-01   -2.897570561583403e-01   +7.285044384884928e-01; -1.773405878766663e-01   +3.840605646096180e-01   -2.010064708332607e-01   -3.787082461239952e-01   -4.573974848757464e-01   +6.161269042511517e-01   -3.150270067955568e-01   +7.321146876123883e-01   +2.426309055041471e-01   +7.258179016906658e-01   -8.130849422943324e-01   -8.210765414182342e-01; +4.129630231436430e-01   +6.300552937381595e-01   -7.322087831133280e-01   +9.297117674613978e-03   -3.281099540224333e-01   +5.914336471149404e-01   +6.616912938620740e-01   +7.076716453890631e-01   -7.566426774309106e-01   +1.125484700627642e-01   +2.024669713632313e-01   -4.351922600274657e-01; +5.900797763091664e-01   -9.274919651680481e-01   -7.529362065020713e-01   +5.236690945062382e-01   +3.451987191909783e-01   -9.274361656315782e-01   +6.905787475943371e-01   +6.282828337931473e-01   -3.363603316903559e-01   -7.707002845165212e-01   -5.203967997752287e-01   -5.831621951150757e-01; +1.761908179948796e-01   -5.813056102159969e-01   -7.771719260223466e-01   -1.832610226422338e-01   +2.982432970226194e-01   -1.263170896915100e-01   -8.182644591000989e-01   +8.208361569525813e-01   +4.885497059745957e-01   +2.159508315456751e-01   +4.414077804428754e-01   +6.186234144709116e-01; -1.040871039110055e-01   +5.072681217033684e-01   -5.179261548625027e-01   -7.771751655199456e-01   +7.825895495294709e-01   +5.687266928910372e-01   +3.345713770046540e-01   +6.585895362195640e-02   +6.322328873021457e-01   +1.372389664757732e-01   +2.195110807825795e-02   -2.020044508925226e-01; -2.232044632748544e-01   -5.968190766299828e-02   -7.934793102651680e-01   -1.075463563076921e-01   +4.506728810490000e-01   +8.383983179228320e-01   -1.931702774340382e-01   -3.460020928733239e-01   -5.528662341560565e-01   +5.937053157319735e-01   -4.473062188035652e-02   +3.284045206467707e-01];
L1_L3_iAMPA_netcon = [-1.000000000000000e+00   +3.323452492455063e-01   +3.451349299218770e-02   +3.758795923305764e-03   +8.953426342991053e-02   +5.607596331774758e-01   +2.752041329500277e-01   +3.373231406499093e-01   -9.736875458808177e-01; -1.936152286482461e-01   -3.951265733752850e-01   +7.251276119237204e-01   +6.853177804490578e-01   +2.651111005477964e-01   +2.150131102679314e-01   +8.811331494412269e-01   -6.273334797597092e-01   -1.304830550733037e-01; +5.748433833567500e-01   -4.101254660792066e-01   -7.335819324893640e-01   +3.288818116544837e-01   +5.561058061044839e-01   +1.007786995258935e-01   +1.572902425309670e-01   -2.127700281858454e-01   +5.699633419411289e-03; -7.372746478674038e-01   -1.382126476520789e-02   -8.547813879872022e-02   +8.486879640484196e-01   +7.206583533416344e-01   +9.548327318044311e-01   -8.770670099410618e-01   -7.707100210145502e-01   +4.248981535124344e-01; -9.208233756271192e-01   +3.151435131508859e-01   +8.356692525693814e-02   +5.385464747568782e-01   +9.840140863270490e-02   +1.139663861784159e-01   +5.712727114403324e-01   -4.798650424361126e-02   -4.395512568457234e-01; +8.212091331657811e-01   +1.308577246689584e-01   +8.092717809627030e-01   -9.951877421043104e-01   +7.158572671613582e-01   -6.987391723136644e-01   -4.414395705398556e-01   +4.445393524883790e-01   +1.176910829026008e-01];
L3_L1_iGABA_netcon = [-1.235950407063286e-02   +3.678289287690023e-01   -4.998927981746639e-01   +6.731054088936884e-01   +8.076135861286063e-01   +5.809580657351952e-01; -9.384170728439899e-02   +3.149451434443848e-03   +1.260462807550067e-02   +8.483336381760171e-01   -3.075970043227242e-01   +4.331356298228783e-01; -9.563679806496020e-01   -2.984687217952988e-01   +8.309987536684228e-01   -5.589358346753941e-01   -6.939511280273682e-01   +4.291099738383821e-01; +4.687925212566657e-01   +6.867795241418462e-01   +6.832228880946782e-01   -6.271327269568431e-01   -2.090915955982472e-01   -1.692199812669358e-01; -4.558947811180047e-01   -7.429539795340563e-01   -8.796419051279972e-01   -2.993698404010346e-02   -2.092117039780003e-02   +5.598057530867697e-02; -2.217395799925888e-01   -3.870429237593552e-01   +2.023135486100737e-01   -2.858076215594049e-01   -2.151625934132114e-01   -3.250584086307583e-03; +5.811976837229194e-01   -4.007434819871762e-01   -8.370967593533875e-01   -6.036969622817446e-01   -1.083612126518279e-02   +8.585274969890194e-01; +6.690033992508148e-01   -3.175091339440665e-01   -1.895343509546841e-01   +1.705690497586718e-01   +4.870246556291892e-01   -1.018890528402584e-01; +3.806186724476412e-01   +3.045725839395143e-01   -1.812307865285480e-01   -4.787758865425997e-01   +1.000000000000000e+00   +6.709924050087326e-01];
L5_Input1_iAMPA_netcon = [-1.666728598793867e-01   -2.245647304639042e-02   -1.000000000000000e+00   -9.372005200766627e-01   +9.741957250199192e-01   +5.572535170806182e-01];
L6_Input2_iAMPA_netcon = [+5.107275071028629e-01   -6.583852641815665e-01   +5.070480103797288e-01   +1.000000000000000e+00   +8.839652937120935e-01   +5.077205076378101e-02];
L5_L6_iAMPA_netcon = [-7.349657726424513e-02   -3.743086047025259e-01   -7.432703668921775e-01   -2.350844540972461e-01   +7.433274773954440e-01   +3.949961497862740e-01; -4.515933865819222e-01   +1.876767711968819e-01   +7.445966734093602e-01   +7.680675587158065e-01   +1.000000000000000e+00   +6.314195166800995e-01; -5.713773450251227e-01   -8.827443102743880e-01   +7.950983324022390e-01   +4.849073944230457e-01   +6.167011959907950e-01   +9.090499716731341e-01; -3.156075174953000e-01   +6.486425464178858e-01   +5.462834681927043e-01   -1.423560295747980e-01   -4.751676823930033e-02   +2.192766868233529e-01; +3.454811111982429e-01   +8.824635353090150e-01   +3.928159598361692e-02   -4.685401286050460e-01   +6.774800641340569e-01   -4.960582866885155e-01; -3.984648663557898e-01   +6.226428323184205e-01   +3.959678858739529e-01   +2.282329633350185e-01   -2.040904998822198e-01   +7.007174709523968e-01];
L4_L5_iGABA_netcon = [-1.787640801102799e-01   +3.174916074645031e-01   +6.418156062009862e-01   +4.483243782923454e-02   -6.668292307396678e-01   +2.797623189005807e-01   -6.375908045126105e-01   +1.393460497448959e-01   +2.625285924150249e-01   -3.768238706187385e-01   -5.386177320835397e-01   +6.233211624191818e-01; -4.366453758059991e-02   -9.139016871495523e-01   +6.096380254359748e-01   -1.688952129596616e-01   -6.696549967843459e-01   -2.970685192503724e-01   -4.689837655707250e-01   +4.477694991571997e-01   -5.741349541276132e-01   +9.676648302064089e-01   -5.080386534757847e-01   +3.257920878992361e-01; +4.448991331790058e-01   +9.666480464967805e-01   +2.488799013306926e-01   +3.847401062915742e-01   -8.963874803774357e-01   +4.528558929265403e-01   -5.905316518374785e-01   +6.485334889740916e-01   +9.597333540982681e-01   -1.040313981001214e-01   +1.406556225795964e-01   +8.625319436895207e-01; -1.630032560589093e-01   +5.256816517484399e-01   -3.659222111141237e-01   -4.713263034755608e-01   -1.620489450598281e-01   -3.049918114416947e-01   +7.800639734835393e-01   +4.204706101193673e-01   +5.380839109912348e-01   +5.596366921803169e-01   +7.750775428969823e-01   -7.976215209158709e-01; +1.731919924161149e-01   +6.504770247567981e-01   -2.713353608012011e-01   +1.137129156547745e-01   -4.032006202761865e-01   +4.268226426410206e-01   -1.000000000000000e+00   -6.787941828218124e-01   -4.396479215722499e-01   -3.517357153422092e-01   -6.151017629809258e-01   +1.840281301694201e-02; -9.573669194584519e-01   -4.410905766104267e-01   +8.777075587383477e-01   -5.290447881779193e-01   -9.639949351025653e-01   +5.246181715574958e-01   +4.265217160826792e-01   -2.398065464602606e-01   +6.569589840574566e-01   -8.248269244328389e-01   -3.608640298127563e-01   +4.864288899547403e-03];
L6_L4_iAMPA_netcon = [+6.142158518187038e-01   -3.827130865576416e-01   -1.202724894801269e-01   -7.142308538000199e-01   +1.047806640295116e-01   +7.998661031511815e-01; -5.861526009161488e-01   +2.616036918206204e-01   +4.116123796239813e-01   +6.326295825251511e-01   -4.424545509165782e-01   +8.093652135781857e-01; +3.895566132745865e-01   -5.300724287086138e-01   -9.704817553679497e-01   -6.543142656894588e-01   +8.550103075347522e-01   +6.305233466643696e-01; +6.107303388060396e-01   -5.955703847118219e-01   -4.597957271114855e-01   +5.259330192402255e-01   +8.667328545279710e-01   -3.883218443585398e-01; +7.340549416967826e-03   -4.108940260028799e-01   +5.056646811786838e-01   +6.655542091748021e-01   -5.034858198746308e-01   -7.149386713954657e-01; -4.764869414296133e-01   -3.233212693329644e-01   -2.369522112197580e-01   -4.363729148092506e-01   -1.052815990477257e-01   +8.077586535826734e-01; -7.369235703581288e-02   +7.688421537353686e-01   -1.023906790578330e-01   -7.126408528485394e-01   +8.729109229555710e-01   -6.619957096492695e-01; +7.486738223301160e-01   +5.318254685912553e-01   -1.000000000000000e+00   -7.118927266091946e-01   -7.484116628498132e-01   -6.127771551933484e-01; +4.676435347820297e-02   -1.237414136099935e-01   +6.493953539308428e-01   -4.908586783827241e-01   -1.892483815876158e-01   -4.765885038323334e-01; +4.241072785902317e-01   -7.453540473600290e-01   +5.310829588853561e-01   -7.817139689519151e-01   -4.405029610475160e-01   +4.451815704737354e-01; -6.867633436404095e-01   +6.449597225462966e-01   -1.178030706930941e-01   -6.065166741492476e-01   +2.433842791560704e-02   -9.456386320161030e-01; +4.023571766572798e-01   +6.322741471966381e-01   +3.791900517358132e-01   +5.741927224069370e-01   -7.418639173414253e-01   +4.819165126758701e-01];
L5_L4_iAMPA_netcon = [+3.497616367431875e-01   +5.589024597465392e-01   +3.736093509632674e-02   +1.000000000000000e+00   +8.610047326806971e-01   +4.948111807801332e-01; +6.408322213352263e-01   -5.465883033306311e-01   -5.789090744260604e-01   -5.231084274118912e-01   -1.112185468332820e-01   -7.534553017454283e-01; +4.575457197294939e-02   +7.324065252705825e-01   -7.097548475052204e-01   -3.902128491585621e-01   -1.599020564127604e-01   +8.108189834843612e-01; +6.834622812732852e-01   -5.812881354561611e-01   -2.060923285897993e-01   +8.536758061177662e-01   -3.758091903547522e-01   +4.671695726852824e-01; -4.026603923489395e-01   +4.740529336838486e-01   -2.915011840823967e-01   -5.315384494416494e-01   -8.183082650309383e-02   -6.484442554251838e-01; -7.201517535943981e-01   +5.927760332012509e-01   -7.368100865369750e-01   +1.357340391228624e-01   -3.657749944255952e-01   -6.190048927611977e-01; -6.161754719476729e-01   -1.128504000541092e-01   -6.837113887875340e-02   +4.106714363044554e-01   +2.024849427691034e-01   -3.401976360269307e-01; +7.362736803202340e-01   +8.704148613209547e-01   -4.744692796410920e-01   -2.984195855073108e-01   +7.824599302388049e-01   -7.169681130765209e-01; -5.212028717503003e-01   -3.242564318282396e-01   -7.340695681560040e-01   +6.432482437262166e-01   -7.883367288339527e-01   +5.046119620365976e-01; -3.337252662168268e-01   -3.211152299176226e-03   -1.485786549820801e-01   +2.273482868101699e-01   -8.919414106376507e-03   -4.492023819787791e-01; +4.077187571850800e-01   +8.165472158083589e-02   -9.146278262647527e-01   +6.142485278163352e-01   -2.617268399749830e-01   -4.534319062359920e-01; +2.350351124504747e-01   -8.363764220963916e-01   -9.063777857816860e-01   -6.651785059253875e-01   +1.288778614315726e-01   -3.497516319990333e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
