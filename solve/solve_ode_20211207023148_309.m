function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+8.926551228757854e-03   +6.325467005672469e-02   -2.640867753182342e-03   +9.399002584576251e-02   +1.313848899620591e-02   +7.271139251696671e-02   +1.019701932786734e-01   +5.935485071924614e-02   +6.010310020198362e-02; +2.724886892777250e-02   +3.498209214911375e-02   +1.022360183550657e-02   +7.170737844601591e-02   +1.342613287765123e-01   +4.322044171995965e-02   +7.643526684597207e-02   -3.708274811182503e-03   +4.002811190866470e-02; +4.133493728997936e-02   +8.252141257300168e-02   +5.885814764560331e-02   +4.150413483023511e-02   -1.842396597958034e-02   +5.664334206710973e-03   +1.461208594981303e-01   +7.107072133208371e-02   +6.365019081281226e-02; +9.683177719868992e-02   -8.389045826272243e-03   +7.188072695103649e-02   +1.242533400516079e-02   +4.222481329479200e-02   +5.575910937609305e-02   +2.964086208945903e-02   +7.555123005074166e-02   +6.668877291410977e-02; +3.721571085584707e-02   +8.760610025865222e-03   +9.976514762101212e-02   +8.037915339327555e-02   +1.033231316707404e-01   +1.052708733888357e-01   +5.309100131157978e-02   +3.557433941307992e-02   +5.832837069786977e-02; +6.602476901761337e-02   +2.416927380951026e-02   +7.709826199671979e-02   +1.234073908304252e-01   +6.473227418758629e-02   -7.081982527959713e-03   +1.147041957160210e-01   +3.499342739391350e-03   +6.108290700258651e-02; -2.222091773134955e-02   +3.519227817161858e-03   +7.794059214625541e-02   +7.710656353727348e-02   +1.041473432980300e-02   +3.655892383142997e-02   -5.952295129450155e-03   +7.877680318814459e-02   +6.503324194043798e-02; +6.477451117766923e-02   +4.095855745886876e-02   +1.456403311630044e-02   +3.870966263164417e-02   +5.209354378595041e-02   +1.202954170044070e-02   +7.121568255365734e-02   +2.155969658404195e-03   +1.115093254861254e-02; +5.035689819829187e-02   +5.933871729991032e-02   -1.029601021799225e-02   +4.791919220092257e-02   +8.483492379045037e-03   +1.175211129328713e-01   +6.010571864869021e-02   +2.136599629084059e-02   +2.750530719141268e-03];
L1_L2_iAMPA_netcon = [+7.873215888378177e-02   +7.757845692155305e-02   +7.878431754433898e-02   -3.291988396703148e-02   +9.747640349551474e-02   -9.005958134890803e-03   +8.944953171109039e-02   +5.227526668055864e-02   +9.656109875814373e-02; +5.169012364381481e-02   +2.168812638532383e-02   +8.072688473357262e-02   +2.483870904465190e-02   -8.304617256303846e-03   +5.143965207792455e-02   +9.030901406548424e-02   +9.654420782302342e-02   +5.639641693698978e-02; -1.104629277854628e-02   +4.025581290249752e-02   +8.285247360972012e-02   +5.794819558334417e-02   -3.658186264419298e-03   +4.946356370930992e-02   +7.099272469814263e-02   +9.084491223639073e-02   -5.210919562747579e-03; +4.179397618298137e-03   +9.008272803796795e-02   +5.574805992702071e-02   +8.331930820622653e-02   +4.047051673134937e-02   +5.050465186124287e-02   -2.646048430488538e-03   -2.630957821065468e-02   +7.913378178764248e-02; -2.080988235760498e-02   +1.292889115057147e-01   +1.315058721855278e-02   -9.195367067159083e-03   +2.575750922313211e-02   +5.930262305842966e-02   +3.746876596084264e-02   +6.453923119392202e-02   +7.737392302789010e-02; +7.171345678816890e-02   +1.962249456008047e-02   +8.218778120895950e-02   +4.611479771672740e-02   +8.274793945932381e-02   +2.311605063836864e-02   +8.083443656836574e-02   +1.110347439988308e-01   +4.177866256731667e-02; +1.072036199876975e-01   +1.104112505197866e-01   -6.181468619228957e-03   +6.523693695349350e-02   -1.397559159678222e-03   +7.731619539299205e-02   +3.820622753189658e-02   +9.983448235100052e-02   +2.541477064803028e-02; +4.935056389330365e-02   +4.437272124428320e-02   -2.358851948720301e-02   -2.078781987933242e-03   +6.884383075063526e-02   +3.943905129026503e-02   +7.724136057743961e-02   +7.930192166919096e-02   +1.198354895769270e-01; +1.253621357665286e-01   +7.146747956571488e-02   +2.450982769251919e-02   +3.761506837321672e-02   +6.415836008315708e-02   +1.473954655184295e-01   -1.712464002003037e-02   +1.507916701383698e-01   +1.647110774300047e-02];
L2_L5_iAMPA_netcon = [+1.207211551514570e-01   +4.143683015945578e-02   -5.174066864708627e-03   +1.174509252434094e-01   +1.184658763808304e-01   +9.318632891892865e-02   +9.745768522486982e-02   +1.195417073457374e-01   +1.155450076956827e-02; +5.978095504167172e-02   +1.373135651241567e-01   +4.290895189105159e-02   +1.038420475292474e-01   +1.748156286359838e-02   +4.355861091752257e-03   +1.582905572992953e-02   +1.202230532224552e-02   +9.587397648539228e-02; +7.590743595746044e-02   +6.430370725268600e-02   +8.818646069469504e-03   +3.989377660350340e-03   +4.925661549622712e-02   +1.234195275930304e-01   +8.243701442728278e-02   +8.258866442543313e-02   +6.805510164415056e-02; +3.607248183314024e-02   +6.884391298156493e-02   +4.303037427057188e-02   +1.018562286326700e-01   +4.730596639767172e-02   +8.961689993778016e-02   +5.040538166347379e-02   +1.158837020771491e-01   +6.244024017664249e-02; +3.321582377615517e-02   +1.024837973925617e-02   +1.822622787859209e-02   +5.187695681089761e-02   +1.050816569494215e-01   -4.101964744104542e-03   +3.621526170222484e-02   +4.061446498329449e-03   +1.040788678667197e-02; +8.481528291368987e-02   +1.105096973048627e-02   +1.864925305216109e-02   +1.003324013588931e-01   +2.819328329481525e-02   +2.048988404260519e-02   +3.715631962179219e-02   +7.682245704822063e-02   +1.237212118564698e-01];
L5_L2_iGABA_netcon = [+6.539397686711289e-03   +2.161883356866657e-02   +5.953326364067396e-02   +7.089682359710801e-03   +3.728288966776618e-02   +1.384964137737831e-01; +1.127114442067308e-01   -5.814220799263249e-04   +6.769726734883721e-02   +5.069661253665744e-02   +5.422826388090344e-02   +8.717342909960914e-02; +1.443034080852277e-01   +1.151471982896741e-01   +7.918451296355669e-02   +3.814844543856126e-02   +2.018033890451307e-02   +5.821383048058915e-02; +8.343607636750457e-03   +2.921406632753539e-02   +4.920283746006685e-02   -1.112399508982791e-02   +7.824332724256620e-02   +2.308895105817396e-02; +6.030661253728024e-02   +6.880906850627458e-02   +7.776043038415442e-02   +7.523193990918020e-02   +1.679154263302128e-02   +5.739001264645098e-02; +3.879014606871126e-02   +5.217629196963529e-02   +3.093800179708824e-02   +9.291197385706279e-02   +5.697078824081094e-02   +2.683136446929483e-02; +1.359419829133373e-02   +1.536803209656957e-02   +1.043016921554714e-01   -1.144414157708229e-02   +1.009616853253288e-01   +5.461882962788773e-02; +8.983430091762722e-02   +1.440356754422443e-02   +4.233809756125823e-02   +1.016753887506367e-01   +6.470981351540489e-02   -2.438693621617951e-02; +4.211992905856098e-02   +5.789777709470890e-02   -4.450594382094209e-02   +6.498222009341736e-02   -5.267237361735889e-04   +7.048002377297832e-02];
L3_L2_iAMPA_netcon = [-3.377300836883764e-02   +2.039250910218493e-02   +4.311034301439844e-02   +3.715392681645061e-03   +1.277413822809682e-01   +8.558445937546856e-02; +4.712612171178450e-02   -5.662657226040578e-03   +5.770261878597768e-02   +1.391865776788859e-01   +5.514849256085209e-02   +3.596603679300307e-02; +6.084052267402186e-02   +4.538523917475226e-02   +3.788713854920462e-02   +8.005531876464321e-04   +3.026160812377766e-02   +4.372074281296751e-02; +3.653975418604793e-02   +4.752503803393190e-02   -5.000149879471351e-04   +5.641727868180529e-02   +4.358808217017400e-02   +1.140271132721317e-01; +3.852328402351154e-02   +1.644659714748112e-02   -9.870821353538922e-03   +1.338394597742117e-01   +1.314547838294860e-01   +9.545421251298132e-02; +9.250150720263511e-02   +1.910307794934992e-02   +2.611283468410108e-02   -7.939726614332938e-03   +5.546710665660117e-02   +7.366649409285933e-02; +5.598279972797928e-02   +8.910975361018558e-02   +5.691561964712150e-03   +1.493815666271485e-02   +2.326403225593933e-02   +2.730824808714256e-02; +3.414841160996276e-02   +8.301798579893670e-02   +6.492779575833803e-02   +5.393137814086534e-02   +5.838108547057615e-02   +2.404272825858514e-02; +2.344668426503158e-02   +5.448109267518061e-03   +4.383105707623133e-02   -3.508324844547803e-02   +7.695058953025170e-02   +7.159884688512723e-02];
L2_L3_iGABA_netcon = [+8.073977170866112e-02   -2.246491962306373e-02   +8.110868997056311e-02   +6.356084717081077e-02   +8.091305261055043e-02   +4.298377462305202e-02   +7.578835497959012e-02   +1.040416777177156e-01   +1.020228542351633e-01; -2.652857467026492e-02   +1.134825254867663e-01   +9.738254740974867e-02   +9.097591301368357e-02   +7.928603487459492e-02   +5.222819187881046e-02   +2.753656543189374e-02   +7.568046450135295e-02   +6.228388838772324e-02; +2.013226809298979e-02   +9.275789641552487e-02   +5.624304267002184e-02   +5.546184987289541e-02   +1.008224136023428e-02   +6.915791326368594e-02   +9.361680831446829e-02   +3.382195932367281e-02   +3.824348627331600e-02; +1.631642227109455e-03   +8.575872345043201e-02   +5.240018422535311e-02   +6.415469066443504e-02   +8.683432435736148e-02   +8.149153385658378e-02   +3.525547874399420e-02   +3.466432801245273e-02   -2.487734762171225e-02; +4.327200811227743e-02   +3.911695430286161e-02   +5.274379056584533e-02   +6.396975514996006e-02   +1.929403298111231e-02   +5.422683645036171e-02   +2.770408199607576e-02   +3.897637023935798e-02   -8.164488971728140e-03; +2.051539778993477e-02   +1.064464086480274e-01   +1.126727636693107e-01   +6.575720677829287e-02   +7.155734367873630e-02   +3.921119670852731e-02   +5.720960135070752e-02   +8.083022148164343e-02   +1.025996061256516e-01];
L1_L4_iGABA_netcon = [+1.491785596933129e-02   +3.218407838056620e-03   +3.300288012814127e-02   +5.116108745450582e-02   +9.957771987311087e-02   +4.405668028114296e-02   +8.200193826955367e-02   +1.667147256513611e-02   -1.184396736914636e-02; +2.460780212084306e-02   +1.126870269284382e-01   +1.230441126552908e-01   +6.106199148067636e-02   +5.027750186405059e-02   +9.075066916131226e-02   +1.091239439216294e-01   +6.348101001712579e-02   +5.271432043984096e-02; +6.992859248533609e-02   +4.463303963064805e-02   +8.837750349543623e-02   +7.871274244725368e-02   +9.475440887147925e-02   +1.454522462409147e-02   +2.450059497909794e-02   -2.913064528581258e-02   +7.209863737869049e-02; +2.487482359539969e-02   +3.936823578208856e-02   +1.071474090614772e-01   +9.200247499052367e-03   -4.026467352633416e-02   +5.366970086444539e-03   +8.344431287958422e-02   +5.308150647735914e-02   +9.382208332415347e-02; +3.345345279863606e-02   +1.118413100234695e-01   +4.174610162648910e-02   +8.298871344191974e-02   +8.602343441936840e-02   +8.946459393191750e-02   +1.562159214759700e-02   +7.029168515397366e-02   +3.559994215263836e-02; +3.732056627591909e-02   +7.352372008109212e-02   +3.484815892202303e-02   +7.529049568028101e-02   +2.721420591849514e-02   +7.826440708169949e-02   +7.398471564483790e-02   +6.224471820964096e-02   -3.341403754818718e-02; +3.257470994363544e-02   +6.869057694649304e-02   +5.019522404708142e-02   +7.534874247523331e-02   +1.449662008508829e-01   +4.363926746551342e-02   +5.291775159996722e-02   -5.957397206620322e-03   +1.798918041002041e-02; +5.485768128387002e-02   +1.645818927055955e-02   +8.552368702225764e-02   +5.034311615228642e-02   +7.566533679135581e-02   +3.129355367957263e-02   +5.313471606193106e-02   +5.497003367152606e-02   +9.416795558283134e-02; +5.720168073583871e-02   +4.465763722866036e-02   -1.064816086714255e-02   -1.761173233721271e-02   +8.434124014621971e-02   +7.551096977129680e-02   +4.221184730063592e-02   +5.686966432978589e-02   -6.505114695827135e-03; +1.250748684980054e-02   +1.128334878683943e-01   +6.665021888347904e-02   -1.788512912479242e-02   +3.263767592746083e-02   +3.252015862534065e-02   -1.334512801998893e-02   +9.660838532212325e-02   +9.785465626798123e-02; +1.230975163258595e-01   +4.870043843394917e-02   +3.227909525624840e-02   +8.310995273138172e-02   +4.202759229462490e-02   +8.777971330552697e-02   +4.563558973181674e-02   +4.948111891010086e-02   +1.174792660267491e-01; +7.552917345519033e-02   +2.168373809087604e-02   -2.078334918388790e-02   +9.592425886479351e-02   +4.480349800763667e-02   +7.173784316316753e-02   +6.228784894559076e-02   +5.832100889856174e-02   +9.392171864059441e-02];
L4_L1_iGABA_netcon = [+5.033650587012012e-02   +6.608831931710128e-02   +7.634637253854891e-02   +3.033918514417511e-02   -1.146980744639357e-02   +8.185990801125100e-02   +4.626760655064260e-02   -2.667542018481713e-03   +7.171626699762312e-02   +8.428554861418993e-04   +3.560116103070518e-02   +2.575785480950364e-02; +2.204343716346276e-02   +8.888362304643998e-04   +9.148364268015964e-02   +5.362318845119753e-02   +3.899336169852669e-02   +6.542954414623402e-02   +1.504009519256156e-01   +2.035036290317182e-02   +1.441884405737687e-01   +2.545215055000886e-02   -1.665640723841082e-02   +4.967010909396628e-02; +3.970649953341300e-02   +5.981314229877646e-02   +6.516136823658164e-02   +3.581663379676021e-02   +6.076395968005067e-02   +6.019677209546448e-02   +1.529464972401735e-02   +7.913613361823518e-02   +9.571205235268331e-02   +2.572841473811186e-02   +5.636177178791004e-02   +5.109424154624421e-02; +8.950563966391131e-02   +4.044328941996858e-02   +6.015881049373006e-02   +6.730277048111635e-02   +3.797584262905255e-02   +7.449146410994420e-02   -2.337605508377837e-02   +6.749028921601805e-02   +3.690694969555208e-02   +1.114241911272608e-01   +3.628524576266079e-02   +1.116321332204414e-01; +9.158504797780445e-02   +1.544900771634987e-01   +6.190161166489117e-02   +4.275894225807302e-02   +8.629773307115925e-02   +2.180321418285634e-02   +1.319682833519697e-02   +3.841812219679282e-02   +2.701311983709666e-02   +1.308834817670560e-01   +8.705914168175792e-02   +6.368402230886684e-02; +4.389549987895668e-02   +2.934700178779977e-02   +5.624103308085950e-02   +1.088032828189158e-01   -4.064415827124721e-02   +5.742104584725045e-02   +8.210342540460128e-02   +1.263162337185030e-01   +9.447701472684780e-04   -9.833437647051531e-03   +2.424377815609544e-02   +1.914114460412980e-02; +4.376726014139076e-02   -6.311300263787763e-02   +5.903689244844041e-02   +3.193556347655499e-02   -2.028133855467463e-02   +4.727277850708372e-02   +4.791141552909607e-03   +9.226409185223362e-02   +3.772123784592415e-02   -1.246856145050296e-02   +2.182273852378264e-02   +1.071148313390531e-01; +1.327822157877613e-01   +4.490247611122161e-02   -2.299312309008972e-02   -4.926869468375172e-03   +1.061585727972762e-01   +2.140728564997030e-02   +1.007142261999897e-01   +5.672266640780538e-02   +9.520776777036793e-02   +1.134125323088601e-01   +9.148472830169051e-02   +4.021137508556795e-02; +9.264362466659964e-02   +5.624684571205534e-02   +8.090862063133139e-02   +5.607345466550274e-02   +1.510582648667175e-02   +4.598981255957586e-02   +5.785445402087015e-02   +1.562644436095790e-01   +9.937667064453110e-02   +4.463040065727884e-02   -1.173903590423795e-02   +2.149448719868447e-02];
L1_L3_iAMPA_netcon = [+3.479801641329701e-02   +8.251619377304729e-02   +5.822537204588139e-02   +9.688671209031141e-02   +4.647714363218606e-02   +7.326948630085163e-02   +4.583608155000962e-02   +7.563477404756692e-02   +1.931012521057346e-02; +1.750439601354499e-02   +7.114242576101892e-02   +4.555561466501125e-02   -1.493795642488274e-02   +4.072283418861947e-03   +2.210028339971577e-02   +1.493010863654976e-01   +2.653019715008703e-02   +1.081683973734934e-01; +8.095613980685681e-02   +5.726499703039961e-02   +6.248723850923639e-02   +1.261435270175375e-01   +4.536803016008362e-02   +9.445679483842138e-02   +6.768164732003197e-02   +1.392199876270680e-01   +6.150090933853483e-02; +1.125032078346921e-01   +2.356270104694987e-02   -5.289510334680232e-06   +5.519394938267178e-03   +9.386224742756448e-02   +6.380420365572208e-02   +1.972861773520853e-02   +9.559066676556775e-02   +1.681000115654166e-02; +1.363312778220120e-02   +5.116647256757354e-02   +3.941583883899279e-02   +5.897244867013612e-02   -1.779024811222052e-02   +9.346180353000733e-02   +7.289371808946721e-02   +2.252013996654020e-02   +5.268865155529309e-02; +9.603248713795406e-03   +9.377152659337054e-02   +6.625904860570432e-02   +1.015789132999450e-02   +1.327504163310018e-02   +5.999058454738233e-02   +7.478868650150113e-02   +4.503975504327826e-02   +3.627871697552917e-03];
L3_L1_iGABA_netcon = [+1.090220906151737e-01   +8.963446744620267e-02   +5.247787182069494e-02   -5.585311771931262e-03   +1.362995211812935e-03   +9.056255782243375e-02; +4.921556023290761e-02   +4.960994101517401e-02   -1.218458929974097e-03   +2.207850314129271e-02   -1.558011834213887e-02   +4.004915562786476e-02; +7.941210466931099e-02   +2.894608277631480e-02   +6.892993919879063e-02   +3.951537675790367e-02   +1.028075229173311e-01   +8.077514444337572e-02; -2.145998136231603e-02   +8.261705012370779e-02   +7.609584682424216e-02   +7.301510077359014e-02   +1.370124936898371e-01   +1.040066309171397e-01; +4.528212892127154e-02   +3.913798974967043e-02   +1.026058766341197e-01   +6.281726135946276e-02   +5.551511907915549e-02   +5.781453884258307e-02; +1.206355757941452e-01   +5.859393957968256e-02   +4.939402269597078e-02   +9.314833900943875e-02   +1.229791744740965e-01   +8.710308013005316e-02; +2.201168850828341e-02   -4.276120217939673e-03   +1.051512663501673e-01   +3.325209474343756e-02   +4.532130777684820e-02   +5.020799984962637e-03; +4.066452275420548e-02   +5.864328158299201e-02   +9.463903082224059e-02   +4.691123573439427e-02   +2.194236707249210e-02   +2.711052920068290e-02; +4.594639196927552e-02   +1.175376757281184e-01   +8.300469293469757e-02   +7.174600214927970e-02   +4.095103236036352e-02   +1.041170016009806e-01];
L5_Input1_iAMPA_netcon = [+1.059311423017424e-02   +8.748310995709968e-02   +5.842219202126820e-02   +4.935064342742896e-02   -3.800820354611337e-02   +1.005861197864663e-01];
L6_Input2_iAMPA_netcon = [+7.264356268826583e-02   +7.394786350169598e-02   -6.863572915368537e-03   +5.069348252983633e-02   +5.673155987212392e-02   +1.127196759785241e-02];
L5_L6_iAMPA_netcon = [-3.860600766401386e-02   +9.671039465121926e-02   +1.086924246730442e-02   +1.546651706199035e-01   +1.866529738903702e-02   +2.936732543840913e-02; -4.259237940366808e-03   -2.224996255890341e-03   +8.070016664470406e-02   +1.116341182704750e-01   +1.121497138755859e-01   +7.637944260632393e-02; +9.492545448359549e-02   +1.022488772417201e-01   +7.400721344210734e-02   +2.354906946227057e-02   -2.061433373718217e-02   +8.403658645406940e-02; +7.089009418578078e-02   +1.203132328368779e-01   +8.813933161480601e-02   +1.096448984955906e-02   +4.658895111023846e-02   +9.834312908888028e-02; +2.731878030765326e-02   +1.165594150954387e-01   +1.094223924565631e-01   +4.225102489422627e-03   +4.924431061423356e-02   +6.299560948438372e-02; +9.077615761986944e-02   -3.450528246382197e-02   +1.568359652074271e-01   +1.807947132071730e-02   +1.016831456201270e-01   +9.235155406589705e-03];
L4_L5_iAMPA_netcon = [+2.054694175182235e-03   +6.038410455328233e-02   +1.111057574018489e-01   +5.064176012453489e-02   +4.130470238105893e-02   +3.846732216671121e-04   +1.390077735389714e-01   +4.566883192963133e-02   +6.085187808250804e-02   +9.206528796464161e-02   +1.069915577007961e-01   +3.735179327865993e-02; +3.843078817580592e-02   +1.208236910027740e-01   +3.873158247796025e-02   +8.302893139959761e-02   +2.037266552960235e-02   +6.717707126928546e-02   +1.342775206298851e-01   -1.866788255658409e-02   +7.618844203395785e-03   +1.609098644202172e-02   +8.983098687944908e-02   +8.946398432161347e-02; +5.373173680586679e-02   +6.535954806612659e-02   +1.196419708251836e-02   +4.553847093579924e-02   -3.433811171298389e-02   +1.278262961806156e-01   +1.322402594190993e-02   +3.762833931515261e-02   +8.041295588734197e-02   +7.195223597788959e-02   +8.676969051184542e-02   +4.228677592428107e-02; +1.571577651980104e-02   +6.515955965403823e-02   +3.243137990285019e-02   +1.971230391991375e-02   +5.116463575023336e-03   +7.870596126137815e-02   +2.434740763517507e-02   +3.105306526812976e-02   +8.619103529404960e-02   -6.258506369162250e-03   +1.242475745050053e-01   +2.708283240201705e-02; -2.805514062770541e-02   +8.904833205739002e-02   +6.395188522487492e-02   +5.457671316387805e-02   +6.249295061610365e-02   +7.773184898724604e-02   +1.015253289544098e-01   +1.462804748345944e-01   +5.197278000343972e-02   +1.512220341715005e-02   +7.257348259945805e-02   +8.081284873892035e-02; +8.719659400906803e-02   +7.590536908134614e-02   +5.732558567129335e-02   +9.177837137189934e-02   +6.242868754650651e-02   +1.340605414999291e-01   +3.374814886239302e-03   +2.693770269130968e-02   +4.339829150376887e-02   +1.210854681049808e-01   +8.386351340532096e-02   +1.277719177439113e-01];
L6_L4_iAMPA_netcon = [+7.009262088977920e-02   +8.495184944836265e-02   +6.145199863403610e-02   +2.967713666346250e-02   +6.143319586200815e-02   +7.499450480628871e-02; -7.993342635485151e-03   +5.275581482867962e-02   -9.795304348511400e-03   +4.633554849661639e-04   +5.394947941107255e-02   +5.370188271598345e-02; -5.809351093820447e-03   +1.186906370753377e-02   -4.540218744350062e-02   +2.854721299005249e-02   +1.175759599729584e-01   -1.343526081140472e-03; +1.156034615803694e-01   +8.849560742406751e-02   +4.028721110307130e-02   +5.160514927785571e-02   +1.045803114690170e-01   +2.504960176965434e-02; +1.672723336914443e-01   -1.567057406306219e-02   +3.243920507272433e-02   +2.620242887625075e-02   +7.336979953585013e-02   +8.870819201010269e-02; +1.019580747947825e-01   +9.509874695050370e-02   +5.673780732524829e-02   +6.863607656012588e-02   +2.285682265482413e-02   +1.130620245504828e-01; +4.387168288574129e-02   +8.109279274323045e-02   +8.317830081879746e-03   +5.557043876831393e-02   +1.064192430692442e-01   +5.539374372739494e-03; +1.356467598960027e-02   +1.126857532421912e-01   +1.080055488660588e-01   -1.280143301409316e-02   +1.882616252917764e-02   +1.187879080345473e-01; +1.203790160558726e-02   +2.475450762738422e-02   +8.970661319488392e-02   +3.494551483048218e-02   +1.728971790915105e-02   +3.016282239039392e-02; +4.208782711370263e-02   +5.436858297289899e-02   +1.000207080326110e-01   +6.832219914219827e-02   +1.385037113778644e-01   +5.961751793415147e-02; +9.292743554447336e-02   -5.012329624355759e-03   +1.154197837393013e-01   +4.476035184419008e-02   +4.675641326363561e-02   +3.646374458638902e-02; +5.790592012280438e-02   +6.510988875578462e-02   +3.298195294143824e-02   +1.392125652394088e-02   +6.301674216144140e-02   +6.453663081137373e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
