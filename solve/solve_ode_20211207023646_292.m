function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.278498886033562e-03   +2.383853604270706e-02   -8.130555320963873e-03   +4.172161366380620e-02   +2.125448876766774e-03   +1.015757744659613e-02   +4.336493583256260e-02   +2.949389046316690e-03   +3.521927698722504e-02; -4.086391309237243e-02   -6.552441024245875e-03   -3.951173999151483e-02   +2.556168594266318e-03   +6.464335774045562e-03   +4.900697810469314e-02   -2.010412475341326e-02   -1.096085928191347e-02   +2.255719914990056e-02; -5.284420507414693e-03   -1.192980614337653e-03   -5.639173232614453e-03   -2.870616432997018e-02   -3.969657048441450e-02   +3.802897674196980e-02   +4.213966060643293e-02   -2.331835245618707e-02   +2.854528236249987e-02; +1.893839015792026e-02   -1.663744825023660e-02   +1.873102299269655e-02   +3.820872632104731e-02   +5.147164926206859e-03   +4.191279836707068e-02   +2.767022205470416e-02   +3.991981230875030e-02   +1.900789096333716e-03; -4.360664733851131e-03   -2.532047935897139e-02   +6.113743233817184e-02   -6.961747168758799e-03   +3.205111715191854e-02   -2.232125507228121e-02   +4.817934363502030e-02   +1.407745800246675e-02   -9.396479004327198e-04; -1.295311704229272e-02   +4.081816097594981e-02   +2.055115170811225e-02   +6.410576134513532e-02   +3.630803309282256e-02   +2.667734823899662e-04   +4.594585689218141e-02   -3.099110594039777e-02   -9.668235773296063e-03; -3.765989702138452e-02   +8.934327289795648e-03   +4.360961903827054e-02   +2.340289576896005e-02   -1.917024510676726e-02   +3.092902262080465e-03   -8.206836126907650e-03   +1.868588762551995e-02   +2.839655319100532e-02; +6.501493734217131e-02   -2.363188949600287e-02   -4.633101727746763e-02   +4.927011360795482e-02   +1.097205473494201e-02   +1.162845152843967e-02   +4.165263250213242e-02   -9.753899375013215e-03   -3.618477311175506e-02; +3.996947784423124e-02   +3.042724268709152e-02   +1.651528488126359e-02   +3.357385464249676e-02   +2.514987035646300e-02   +5.142065729847441e-02   -1.533865316781459e-02   -1.115427182503253e-02   +1.293973530384863e-02];
L1_L2_iAMPA_netcon = [-1.239174361474528e-02   -2.263126252601694e-05   +2.320516095545890e-02   -3.571921037659373e-02   +1.689236474116759e-02   -2.730896466902273e-02   +1.529512385631916e-02   +3.056873876535896e-02   -8.903184604291035e-03; +5.367239792421165e-02   +4.747954134827327e-02   +4.464082135259460e-02   +1.620033122040234e-02   +8.355029180544619e-03   +5.659726283790386e-03   +4.160038107952713e-02   -1.173792758247107e-02   -1.546725542133945e-02; +4.856692311205385e-03   +2.923365970196009e-02   +5.137619821341158e-02   -7.731260718133648e-03   -1.047817656775811e-02   +3.262172282746054e-02   +6.282663213171787e-03   +5.539447054546655e-02   +2.537101260211347e-02; -1.075930880833444e-02   -2.388714609321520e-03   +3.721782903193319e-02   +2.446591751749214e-02   -1.528372638514534e-02   +2.081932857072884e-02   +5.950789513877029e-03   -3.025764180276896e-02   +5.356918872217152e-02; +2.474065643159196e-02   +6.852873199585396e-02   -3.458959346291815e-02   +3.323417348464408e-02   -1.213621604373267e-02   +3.731048177457557e-02   -1.742362506638752e-02   +4.896577746722669e-02   +6.812255024944643e-03; +2.252092174261305e-02   +4.012391502112083e-02   +7.399701024808723e-03   -1.907963612112147e-02   +3.457486797789224e-02   +5.981100193005025e-03   +1.215745756142408e-02   +6.777507756203598e-03   +2.563392102601597e-02; +3.595927326903066e-02   +8.875040208250654e-03   +1.095645814977481e-02   +2.795092278066159e-02   -1.316840165574194e-02   -1.640377028579717e-03   +3.295553710474915e-02   +5.433200796601030e-02   +1.238035002078425e-02; +1.535524741586318e-02   +4.604188703446684e-02   +2.548665495467019e-02   -9.889138848655415e-03   +6.903097323172989e-03   -4.699937228882872e-03   +4.184230160454758e-03   +1.260471766035318e-03   +5.127364758318557e-02; +4.382714284930089e-02   +2.988306373218614e-02   -3.864238616722216e-02   -5.378450472004657e-03   -2.416273538790120e-02   +2.600734313303833e-02   +1.696601295534146e-02   +8.379660769407431e-03   +1.406070695847032e-02];
L2_L5_iAMPA_netcon = [+7.510044429560749e-03   -1.003760292773260e-02   +3.996762718584014e-02   +7.290566485472882e-02   +9.480295746090418e-03   -3.646848143332871e-03   +3.309539824734792e-02   +6.818062927992055e-02   -1.427825063325026e-03; -3.334262115708822e-03   +6.035653866139321e-02   -5.083301159494168e-03   +6.031232092801447e-02   -1.886739738168735e-02   +3.140697315757585e-03   +1.112757484512588e-02   +1.935771595654528e-02   +6.026961406061906e-02; -1.603685069924083e-02   +6.875614563833388e-03   +1.939135846941012e-02   +1.100644376553079e-02   +2.651899486065190e-02   +6.199819850928676e-02   +7.138780408263202e-03   +4.643663114640990e-02   +3.523089526541950e-02; -2.768623519314415e-02   +4.480513920133650e-02   +4.302111896381341e-02   +5.752699550575507e-02   +2.564987662293110e-02   +6.449777918657934e-02   +1.359511708572940e-02   +2.562404857729418e-02   +5.626884223029584e-02; -1.267866971627323e-02   +2.953040244989825e-02   -1.411501528335815e-03   -2.691303877650946e-02   +2.621298589363603e-02   +1.416583821625674e-02   -1.133435525894787e-02   +2.662185926327239e-02   +1.794999428364723e-02; +1.220000053125461e-02   -3.545659868679680e-03   +2.191141487763106e-02   +1.329128291594108e-02   +6.561472614451285e-03   -3.224969876074441e-02   -2.885149528655415e-03   +3.841828755909064e-02   +2.439397769704933e-02];
L5_L2_iGABA_netcon = [+1.995653840317649e-02   +2.364335380218162e-03   +2.457572040615350e-03   -9.966245860250534e-03   -1.232099492722316e-02   +5.340130844991969e-02; +2.695331355126151e-02   +1.968192472256975e-02   +2.718447157297241e-02   +8.287881228521149e-03   +4.778057564896150e-02   -1.126369701333108e-03; +4.873121753855322e-02   +3.150695366407615e-02   +4.576381738938422e-02   -2.685586098733063e-02   -1.050732424579027e-02   +3.917144238191937e-02; +4.189213652892981e-02   +7.067811369933433e-04   +1.805773993763473e-02   -3.563975936419906e-02   -1.026490401170633e-02   -1.294200119039827e-02; -2.420702110431852e-02   +5.395180156934217e-02   +3.589287287849550e-02   -1.870325153169213e-02   -4.661085360048280e-02   +9.357045650567542e-03; -1.502098948528167e-02   +2.240691232578597e-02   +7.985917428874284e-03   +4.454324321937023e-02   +3.346234740914228e-02   +4.051898484554602e-02; -3.405217403262601e-02   -1.802890913328253e-02   -3.920673989107479e-03   -2.964102353171593e-02   -1.986577710295413e-03   +3.523312138209395e-02; +7.125174714083275e-02   +2.708129945752632e-02   +1.185723427046220e-02   +3.617150243685090e-02   +4.388788311103760e-03   +1.142819341212835e-02; +5.275726125282115e-03   +3.397987325577330e-02   -4.084865153363668e-02   +3.825816647383389e-04   -3.009341493700738e-02   +3.872498128205366e-02];
L3_L2_iAMPA_netcon = [+1.080966067670374e-02   -2.914445817734409e-02   -1.065955849481964e-02   -4.320642714108010e-02   +4.129136656905040e-02   +4.911808829544624e-03; +2.813379083562209e-02   -1.943516880568334e-02   +2.255992539047145e-02   +4.653642836130584e-02   +4.056812827524147e-03   -2.846404635143688e-03; +1.490375470459417e-02   +5.008910088366972e-02   +4.445735981460551e-02   +7.519177369779553e-03   +8.054517290802735e-03   -1.804391328061856e-02; -1.587264738028000e-02   -1.957475447179197e-02   +1.504968751825815e-02   -6.980357971841863e-04   +3.912209182341392e-02   +3.866231297495867e-02; -5.523115332264974e-02   -2.175047292879115e-02   +3.286662428654122e-02   +2.522770468327826e-02   +4.446347428032515e-02   +8.943427268638712e-03; +6.222459777457360e-02   +2.035626244151616e-03   -2.315972296045405e-02   -1.027156608905400e-04   +4.471953496562178e-02   +6.644662596100116e-03; +3.133289863243074e-02   +1.056912046358984e-02   -8.587284945355812e-03   +3.818422071843967e-02   -3.579069165005409e-02   +1.530656438179414e-03; -2.399474597802316e-02   -6.396127057250595e-03   -5.238927191590801e-03   +1.110450059048053e-02   +3.118144102938453e-02   -8.796212046348879e-03; +3.797919615384130e-02   +2.586206366782681e-02   +3.816823486264233e-02   +2.938213506493784e-02   +4.536125145765337e-02   +1.699760886383839e-02];
L2_L3_iGABA_netcon = [-1.795603025980015e-02   +1.703983628263779e-02   +3.521802092634371e-02   +3.522849623228682e-02   -6.163987414497467e-03   +1.742382509439529e-02   +9.340563496918544e-04   +6.880048690548878e-02   +5.522860507556819e-02; +3.164931399665095e-02   +5.466381985699671e-02   +6.185188137302207e-02   -4.729737778375352e-03   +5.999849441636405e-02   +6.866251275693442e-03   -2.356520175076014e-02   +3.389203246004799e-02   +6.334390347014172e-02; +1.944345784948796e-02   +1.700054242623763e-02   -2.523545671132901e-02   -1.082965033683424e-02   +5.398406054787888e-02   +4.529568746813230e-02   -2.730709540062059e-04   +9.316129003595583e-03   -4.527934984307824e-03; -4.952986771616486e-03   -1.772832929010254e-02   +3.183542029752979e-02   -2.454914944885386e-02   +7.056608600633864e-03   -1.816033906372493e-03   -3.910542515828875e-03   -4.974095641575121e-03   +3.715832279104457e-05; -1.193037554923867e-02   +2.885593480275503e-02   -2.105039106551410e-02   -8.569631481600967e-03   +3.088828784883924e-02   +4.068957382620360e-02   -4.958770848778328e-03   +6.233426771597606e-02   -2.532000870847767e-02; -4.372290019948435e-02   +2.223296497605004e-02   +7.485157002018175e-02   +5.308333321398517e-02   +3.830633686854420e-02   +3.522227846917155e-02   -9.683806666828609e-03   +5.650861980675378e-02   +6.674168530366212e-02];
L1_L4_iGABA_netcon = [+3.298055632424707e-02   +1.141633016167375e-02   -2.177484673109122e-02   +4.938882407151610e-03   +3.209524372852879e-02   +1.910170992073056e-02   +5.612970684607686e-02   +2.615498746107170e-05   -1.683090856852554e-02; +2.508437913221336e-02   +5.425336436331947e-02   +7.591958610180748e-02   +4.322783795543737e-02   +3.150458953020804e-02   +5.904322093681545e-02   +7.717191899041981e-02   +2.141673734889259e-02   +5.494449060967552e-02; -1.239356698329317e-02   +1.719865088664711e-02   -4.405086603029719e-03   +6.953474281121223e-03   +1.781392166091401e-02   -2.371599103709619e-02   +3.153520330064126e-02   +1.636121407587509e-02   +3.021684594682689e-02; -2.400585678677481e-02   +1.180470605946897e-02   -5.820956438405071e-03   +7.330986177730748e-04   +2.556247412814659e-02   +2.704055251843338e-03   -2.651946896936326e-03   -4.138018103350925e-03   +5.883315503972734e-02; +2.349530534997765e-02   +6.933225287199175e-02   -3.118481799509900e-03   +3.210905360331345e-02   +6.867686416454409e-02   -5.265937431996430e-03   -4.415873243117845e-02   -1.431888335786152e-02   +6.347909770699871e-04; +2.291956012149056e-02   +5.139783403129943e-03   +2.390839861121195e-02   +3.363179907113212e-02   +2.282799629030146e-02   +2.181018897287076e-02   +4.817065282785145e-02   +2.472960181579078e-03   -2.492937929932190e-02; -7.981145950515110e-03   +5.861023872754572e-02   -1.790615320581493e-02   -1.235772410051048e-03   +3.128925742069952e-02   -1.971753253279727e-03   +2.271607061825329e-02   -2.651489892569471e-02   +6.497632021335565e-03; +2.982067547414742e-02   +8.364415532385067e-03   +3.292428602382631e-02   +3.526685118010055e-03   -1.690303260133551e-02   +3.883168854871448e-02   +5.736329511522987e-02   +7.412485482027298e-02   +2.694651597258217e-02; +2.470125821586040e-02   -6.207819089772741e-03   +2.570884044003567e-02   -1.597635652434197e-02   +2.215795632021206e-02   +2.764165835936981e-02   -3.383799563657527e-02   +3.727294462794123e-02   +8.474599111365153e-04; +2.383352616076951e-02   +2.088117751576826e-02   +9.195664707524732e-03   -3.309482105876223e-03   -7.921530033652965e-03   +4.487885464113692e-02   +6.852922863499586e-03   +6.027381499422141e-02   +2.058086330148804e-02; +3.325623538906793e-02   +2.888251256439535e-02   +1.621165272809753e-02   +3.037463420705969e-02   -2.194302140034377e-02   +4.443943623388276e-02   +3.826485766856286e-02   +4.495299337944191e-02   -1.396088675704509e-02; -1.727678872643984e-02   +9.129311514445170e-03   -1.470823261032954e-02   +4.736504411713179e-02   +1.319819527122605e-02   +5.164466635125130e-02   +4.488958164525034e-02   -1.726958675130912e-02   +3.491261362601982e-02];
L4_L1_iGABA_netcon = [+3.969466703428071e-02   -2.664549143050898e-02   +3.765229163717297e-02   -2.803960391631629e-02   +3.082839799562898e-02   +7.371625004257479e-02   +3.478093724350877e-02   +3.421951388397998e-02   +2.441763909058071e-02   +2.657773571012876e-02   -1.359465214177550e-02   +3.056299040661612e-02; +9.681973947555447e-04   +2.439787608988574e-02   +6.513341755018942e-02   +1.424050506283617e-02   -4.800303889184728e-03   +9.546854937318321e-03   +3.739104910824718e-02   +1.083550357950857e-02   +6.223752760388924e-02   +2.708122867945574e-02   -1.056477317391609e-02   +2.491698047472052e-02; +3.706337325651122e-03   -1.271899233848569e-02   +5.579297066507947e-02   -3.712837898707115e-02   +4.640988221940817e-02   +3.124240122213506e-02   +2.936757059182470e-03   +1.104714722290562e-02   -4.486637260631490e-05   +3.876576287507105e-02   +1.651280720902949e-02   +2.899565582886969e-02; +2.249545486304356e-02   +2.424763294581889e-02   +4.307500769580791e-03   +1.360995320060459e-02   -1.651439830651351e-02   +2.250256019797052e-02   -1.552810407981202e-02   -5.446030796719854e-04   -1.414843525946937e-02   +3.045789446405855e-02   +4.874707185858281e-02   +3.387602450964772e-02; -1.144689122376515e-02   +2.166660347997877e-02   -1.014364031211974e-02   -6.408300213703848e-04   +2.996707549364489e-03   -4.795553866954953e-03   -2.008826906834163e-02   +3.866790995991227e-02   +2.176017095056859e-02   +2.272714034339506e-02   +2.381929788001415e-02   +1.505726125566741e-02; +4.278644733717216e-02   -1.737980042180674e-02   +9.155397193740101e-03   +1.061140385580583e-02   -1.009802365096599e-02   -7.739163261114429e-04   -2.000714316754636e-02   +6.381363039520306e-02   +3.080539061936655e-02   -4.069420426869670e-02   -1.552542794323857e-02   -6.267090320786602e-03; -1.443304245624800e-02   -3.024740885658322e-02   +4.620274263728014e-02   +4.695301291914971e-02   +2.581480701603771e-02   +4.206786068007685e-02   +4.648805545799729e-02   +7.408281090960079e-03   +3.429468756925544e-02   -6.144023314401623e-03   -1.033338961663155e-03   +4.599271939725658e-02; +2.890455800821000e-03   -3.034909296608222e-02   +2.789997350676600e-02   -1.813537731377530e-03   +3.110860625212164e-03   +1.033396526058263e-02   +5.663938525573342e-03   +1.806567051779797e-02   +1.433760607444838e-02   +6.880322561847001e-03   +3.877737096985318e-02   +3.935039645982946e-03; +3.429178515048088e-02   +1.434955696562265e-02   -2.200080409655152e-02   +1.114095268334012e-03   +1.925617702211644e-03   +1.448892238097074e-02   +3.116811380180062e-02   +8.815352110882760e-03   -3.865966080461081e-03   +2.839985503020329e-02   -3.294728918979129e-02   +1.804954744326504e-02];
L1_L3_iAMPA_netcon = [+1.990082104206937e-02   +4.229764658056101e-02   +1.118573600211527e-03   +1.855741518669164e-02   +3.126637062477900e-02   +2.634050371721603e-02   +2.924430178247290e-02   +3.809008248131916e-02   -3.856877859667404e-02; -2.933018253761216e-02   +5.583084993269361e-03   -2.183086523387210e-02   +1.955729451235561e-02   +3.573087014689397e-02   +3.869808602062436e-02   +7.947846191815365e-02   -7.402443740324706e-03   +3.306673755821215e-02; +1.972222553607743e-02   -2.409018327622439e-03   +1.011275315673327e-03   +4.537666371101895e-02   +1.661343537876186e-02   +4.902360275457914e-02   -6.325349209872592e-03   +1.654699335739498e-02   -1.586435637733620e-02; +3.157416998690818e-02   -3.033651422401722e-03   -3.069071741716119e-02   +2.256926469954152e-02   -1.559330527242734e-02   +1.821910912278674e-02   +7.276372092801690e-03   +1.665585388005106e-02   +4.827646632781876e-02; +1.641048253829045e-02   +1.238061098906630e-02   +3.488602782405988e-02   +2.068887113877173e-02   -2.240607654152944e-02   +5.523174131499038e-02   -2.800390296479671e-02   +3.044278896825062e-02   +1.591371709276104e-02; -9.511859252846588e-03   +1.306294380538351e-02   +1.415457383006813e-02   -2.482144668714199e-02   +2.722786944651660e-02   -1.019301771600369e-03   +3.622402199917565e-02   +1.887578005500596e-02   +4.577327056234448e-03];
L3_L1_iGABA_netcon = [+5.150195657042093e-02   +3.887033677969730e-02   +1.647991102686612e-02   -1.273744284244728e-02   +6.344683059118787e-03   -9.559597538227951e-03; +6.405390475811680e-03   -4.600509485451175e-04   +1.036710729786671e-02   +2.000711473063579e-02   +1.816695489428227e-02   -1.509923934704012e-02; +1.453646057819647e-02   +3.652390994727265e-02   +5.467454898177715e-02   +1.432387323323995e-03   +6.064226020845144e-03   +1.223178501483473e-02; +3.543453303258685e-02   +1.098413907501039e-02   -1.871245183710381e-02   -1.665196706815080e-02   +1.587418187451283e-02   +4.624827064181115e-02; +3.198518929767601e-02   +1.353912025659183e-02   +1.915531639748038e-02   -1.384596401703149e-02   +3.361765630259719e-02   +2.423396758351280e-02; +3.884330058807139e-02   +8.199085945645617e-03   -1.467288690518893e-03   +2.980471632602120e-02   +2.013907191716909e-02   +4.262132925973394e-02; -2.559406845849466e-02   +3.224126135097830e-02   -5.470649761649300e-03   +1.848711656358182e-02   +3.037054383295226e-02   -1.734017198039624e-02; +1.341823508832039e-02   +6.819454929231621e-03   +6.126876544112644e-02   -3.336400086717402e-02   +2.141938700595615e-02   -1.707936022970611e-03; +1.969244925524922e-02   -8.702302914845538e-03   +1.695556610010050e-02   +3.506386111355032e-02   -7.106165872308718e-03   +2.572092838813042e-02];
L5_Input1_iAMPA_netcon = [-4.020657065930830e-02   -1.255178633183185e-02   -5.041058201072986e-03   +5.524169065357422e-02   +2.162485468891162e-02   +3.244576989671928e-03];
L6_Input2_iAMPA_netcon = [+2.051149183638101e-02   +2.405529434010917e-02   -2.034221289668544e-03   -3.463888288363791e-02   +4.520027866691283e-02   +2.446786589420482e-02];
L5_L6_iAMPA_netcon = [+1.139305708545527e-02   +3.127018571566813e-02   -1.632405705905076e-02   +3.452094498873629e-02   +1.080676042950538e-02   -1.793009941281617e-02; -2.214517997919511e-02   -1.273967397526912e-02   +4.139253330408885e-02   +7.770009572447327e-03   +1.639545462979036e-04   +4.779295175049963e-02; +1.376081899263418e-02   +2.390808288567048e-02   -8.347296225943806e-03   -1.192675652282671e-02   +2.775802075060834e-02   +1.597283526843574e-02; +2.867408764370552e-02   +3.901640636792009e-02   +3.219916568736417e-02   -1.230462022422178e-02   -1.370377631183635e-02   +3.687168199461938e-02; +2.502445277368538e-02   +5.565625107108253e-02   +4.847496639054242e-02   +2.750846100248170e-02   +3.625397011077416e-02   +1.017066392594319e-02; +6.573950785069333e-03   -1.285287901332459e-02   +3.604269135676181e-02   +1.911285326036103e-02   -5.090515479350827e-05   +2.918973656789138e-02];
L4_L5_iAMPA_netcon = [+4.320194798858592e-03   +2.267361280092341e-03   +3.382213128340413e-02   +2.797965683152001e-02   +2.160721593983135e-02   -1.955259412946793e-02   +2.426667603674943e-02   +2.276976838170361e-02   +5.098778600654080e-02   +1.111134976723950e-02   +7.480899819203270e-03   +5.054692806265405e-02; +2.043210991804491e-02   +3.227077764077398e-02   -1.647224671911805e-02   +6.065330963213959e-02   +1.649849226123897e-02   +2.374769105530564e-02   +6.558889214852354e-02   -1.410151434193935e-02   -2.435824111435822e-02   -1.486081957452660e-02   -1.612319169479857e-02   +2.805966613004275e-02; +2.445346899676641e-02   +4.558052041221632e-02   +5.813577696799317e-02   +2.657403077966249e-02   +2.119392822634448e-02   +2.638065626794743e-03   +4.016511104745253e-02   -8.997639741645629e-03   +1.053435791110040e-02   +3.627733715441502e-02   +6.552212752588359e-02   +2.672265544221134e-02; -1.913095189511490e-02   -4.313197753264246e-03   +2.773477976967056e-02   -3.059560363404323e-02   -2.782129564481639e-03   -1.153316369804085e-02   -1.701178063121166e-03   +3.238030244327538e-02   +3.596485526081684e-02   -2.526189114085021e-04   +7.668070885428765e-02   +2.942309575885014e-02; -1.064240240267627e-02   +2.589605551656296e-02   +2.447119052655121e-03   +2.779222975277819e-02   +2.328473605711994e-02   +2.538584350597452e-02   +1.422331051061079e-02   +5.835402694764108e-02   +5.239838826088859e-02   -1.867611575318717e-02   +3.163657010146596e-03   +1.335946824079814e-02; +4.337800169143442e-02   -1.404075818511353e-02   -2.650791215131956e-03   +3.610371983370490e-02   -1.187374832580947e-02   +5.567762582509495e-02   +2.368323464007054e-02   +2.190482327043458e-02   +1.706310462536477e-02   +8.684550313464595e-02   +8.193668186228374e-03   +1.957402218117200e-02];
L6_L4_iAMPA_netcon = [+3.947849389941730e-02   +8.960099486209006e-03   +2.860563804256573e-03   -1.966917691453586e-02   -4.275337372198224e-02   -3.318088547847747e-03; +2.925266557561954e-02   -5.435094095921425e-04   +4.763520075447402e-03   -3.976775722924311e-02   +2.738570355508072e-02   +6.876340264168649e-03; -5.754636004518303e-03   +3.614756702135426e-03   -2.913063327028855e-02   +4.456355956586481e-03   +6.176737706882386e-02   +1.105448661779647e-02; +2.560718832644057e-02   +3.254315778567494e-02   +2.235691518438654e-02   +1.698546445718089e-02   +2.920767395185038e-02   +3.939034646457222e-04; +2.008921155288608e-02   -2.150996463012361e-02   -9.279496061127532e-03   +2.896242747068579e-02   +2.392768175730127e-02   +2.723038518128016e-02; +5.320208673099090e-03   +4.098020121218909e-02   +3.134137835020728e-03   +4.087915983416336e-02   +3.601266031517170e-02   -2.337640817135552e-03; -2.288400484835511e-02   +5.542198050516301e-02   +2.494992607470921e-02   +1.583977573637964e-02   +2.009667473947842e-03   -1.495576216780854e-02; +1.972924068027779e-03   +8.269405726854862e-03   +3.552374377691349e-02   +4.210287436599549e-02   +1.856955506438148e-02   +4.570848709084849e-02; +7.921457814840514e-03   +4.225104127282129e-02   -7.868934854605651e-03   -1.610902678839558e-02   +1.938787532618232e-02   +1.837763688784810e-02; -1.378537134175408e-02   -2.295870061495463e-02   +1.639990897344318e-03   +2.936438556819025e-02   +4.861430630664822e-02   -5.079410426174259e-03; +4.863508789133981e-02   -4.351887178544921e-02   +4.669216356875328e-02   +8.975519849851241e-03   +1.203646241637492e-02   +1.667797221710864e-02; +3.898581158102922e-02   +8.627955670919406e-03   -7.156863107358989e-03   +2.789103236915648e-02   -1.449204306761379e-02   +9.002407093964170e-03];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
