function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.915399501002127e-03   +1.972152520640101e-01   +6.328386517127301e-03   -1.595044259854294e-03   +3.324213065310700e-01   -5.284510423104337e-03   +7.109007860149263e-02   -2.298643455630775e-01   -1.668425895276487e-01; +4.420900425579169e-02   -4.870770683351346e-02   -1.167056462111321e-01   +8.082459958313280e-02   +1.246017984677119e-01   +2.577112959555421e-01   +9.967437732263540e-02   +1.524004654097570e-01   +1.325934359448080e-01; +7.662890757265337e-02   -4.784817211066666e-02   +2.240653145720811e-01   +1.007193177824319e-02   +5.194662796863952e-02   -1.548245984879414e-01   +7.488079378016586e-02   -1.483311415427081e-02   -1.425492684690906e-02; +1.480841070210603e-01   -5.909738525631331e-02   +1.140787168521938e-01   -1.209878328090280e-01   -4.886890800519891e-03   -2.618495048923345e-02   -6.070401525142750e-02   +1.090920827309392e-01   -3.133599320292565e-02; -7.314923993195616e-02   +7.905878342862054e-02   +1.139466319416517e-01   -9.423197774782642e-03   +5.056570109620480e-02   -6.815522944589228e-02   -1.961918269244994e-02   +1.818447297877602e-01   +5.346016238184825e-02; +1.365734200157874e-01   -1.182755500687258e-01   +2.082276956304588e-01   +8.181662304672377e-02   -8.458146393425028e-02   +7.340443804644795e-02   +6.869429286927468e-03   +1.120958287802003e-01   +1.462847028156810e-01; +2.231814088804981e-01   +1.502904856633002e-01   +4.268923009182852e-02   +2.228677991692999e-01   +2.476238157206164e-02   +1.146361095056921e-01   -4.317504773158311e-02   +2.914301550499462e-01   +3.389475327513713e-02; +2.539171107289007e-01   +1.592107468875300e-01   +6.987805317157683e-02   +9.976744599340395e-02   -1.301740402846588e-01   +1.677772262462664e-01   +2.591212874409585e-03   +1.423720970884466e-01   -1.899649928352141e-02; +3.546811964785278e-01   -2.744486207764279e-03   +9.153530771131740e-02   -1.184259163180887e-01   +5.612893809565410e-02   +8.622387247314782e-02   +1.683354112478247e-01   -8.855318033792887e-02   +7.474564375035600e-02];
L1_L2_iAMPA_netcon = [+2.953406172262635e-01   +1.979816482366910e-01   +2.561989515837595e-01   +2.392361975406017e-02   +2.079541708837741e-01   +1.284502936203051e-01   +9.746922079425824e-02   +1.053330843538763e-02   -4.295357701778443e-02; -2.772257498996800e-02   -5.255357304588829e-03   -1.915610322823309e-02   +1.296701790170015e-02   +1.336846340691403e-01   -3.740480916694346e-02   +1.746251696687082e-02   +2.370969150001387e-01   -3.499646750855527e-02; -2.837701320611692e-02   +2.250419737305574e-02   +2.639909194537970e-01   -1.059495940356365e-01   +2.786855401317843e-01   -1.441060009816014e-02   +1.715313522138583e-01   +4.895868016575471e-02   -1.049990973051493e-01; +1.710070260880882e-01   +2.377224434956777e-01   -7.631656660506528e-02   +1.773171013767670e-01   +1.470290122761506e-01   +7.577182972742194e-03   -2.569321201681448e-01   -5.499623590532729e-02   -1.127015321145718e-01; +4.760768111418674e-02   -9.546529125665598e-02   +1.118678183407801e-01   +3.854175779448761e-02   +1.020597445999369e-01   +2.133874788299670e-01   +2.540883176249080e-01   +6.385797338668646e-03   +2.894914948048248e-01; +2.110770921141046e-01   -1.325181853288463e-01   +1.960401768544227e-01   +2.603774751670511e-01   +5.972875684822356e-02   -9.162751878118901e-02   +1.456670459181088e-01   +1.761804291956127e-01   +1.743800935617553e-01; +1.636992894741051e-01   +8.617622865991835e-02   +2.720422306764911e-01   -1.278163416572291e-01   +6.549552974447836e-02   +1.769239789538402e-01   -7.699332671960596e-02   +2.450388643338729e-02   +8.903119620656638e-02; +1.161807882092619e-01   +1.033517437065330e-01   +8.244041428105045e-03   +1.812688237480576e-01   +1.470746031600236e-01   +1.355728413905051e-01   +1.181110177023260e-01   +1.694911092161217e-01   -1.018638587919556e-01; -5.999814300685288e-03   +1.654008042020577e-01   +9.011701937722999e-02   +3.559522574207036e-02   +2.283467894100338e-01   +3.632860128366074e-02   +1.522900426255419e-01   +2.157975358715836e-01   +1.752759806613045e-01];
L2_L5_iAMPA_netcon = [-4.125662311033092e-02   +4.572407412973765e-02   -5.552802118734670e-03   -5.203464385486146e-03   +1.311143928943547e-02   +8.111458587792900e-02   +3.849209316629365e-02   -1.316534125894945e-01   -5.507671266113677e-02; +1.704444023968054e-01   +6.300971078727216e-02   +2.813850848847431e-01   -8.917377710808119e-02   +1.073976346249464e-01   +1.757824765309608e-01   +1.647913829589170e-01   -3.951794617978235e-02   +9.932220206139412e-02; +1.368638336406096e-02   +1.560871758808033e-01   +3.354752950055274e-02   +1.904665885185881e-01   +2.545855762165495e-01   -1.563884508801141e-02   +3.478947287612475e-02   +1.002298180724725e-01   +3.955661747545496e-02; +6.824807498027947e-02   +2.884089625046968e-01   +3.647081323482507e-02   +1.144016662507103e-01   -3.020706925674085e-02   +1.522698838437352e-01   -5.785985942922435e-03   +1.081661689237347e-01   -9.464068106253463e-03; +5.367061082647866e-02   -6.783164012197010e-02   +2.376639234656813e-01   +7.446655496605645e-02   +1.646023066178544e-01   +1.237826199155429e-01   +1.968043009938447e-01   -4.879204167870103e-02   +1.204246931685599e-01; +1.249566524947334e-01   -1.638647607521709e-01   -1.310733921714428e-01   -8.140728452134861e-03   -3.364009257637729e-02   +9.831615966628787e-02   -4.483294756541867e-02   -1.009696552600714e-02   +1.887980731120607e-01];
L5_L2_iGABA_netcon = [-5.024941416681972e-02   -1.045947795406654e-02   +2.545970845360135e-01   +9.119789379068072e-02   +2.383881862369391e-01   +1.921502646417420e-01; +5.169326778683087e-02   +2.739874968390069e-01   +2.064744760313239e-01   +3.961682320883438e-02   +1.418546923424139e-01   +1.891119195612147e-01; +1.017477212424776e-01   +2.080943109137855e-01   +3.510325442607682e-01   +1.226260194512208e-01   -5.546458797872771e-02   +3.394258467413182e-02; +2.102930119572222e-01   -2.095378291614451e-01   -7.792673146612755e-02   -7.653340583091944e-02   +4.533034880693496e-02   -2.740907537169095e-03; +1.266095437953433e-01   +1.788016585140194e-01   +2.768227616157368e-01   +4.459115861774073e-02   -6.845883304850695e-02   +2.029459099927731e-01; -1.788376257697224e-01   +1.633862861813714e-01   -3.303106492949504e-02   +2.230076733072960e-01   +8.672697706619598e-02   -2.663366559851243e-02; -1.283052422539395e-01   -8.296143678163109e-02   -2.217818818231652e-03   +1.325640688098576e-01   +1.081627240072837e-01   +1.338988747743812e-01; +7.354566168138922e-02   +5.226681299885360e-02   +3.177628710495143e-01   +1.743116654316280e-02   -6.803001521826779e-02   +3.175732236637876e-01; +1.705523398635978e-01   +1.663573899762791e-01   +7.407972655991953e-02   +3.779432806392154e-03   +1.179276845084345e-01   -1.886470476993433e-02];
L3_L2_iAMPA_netcon = [+3.534497666859933e-02   -6.333670555817800e-02   +1.736600069714204e-01   -2.600181539858484e-02   +1.511558430394294e-01   +1.863837962037720e-01; +8.072020769740980e-02   +1.019669470246330e-01   +7.120172959114787e-02   +1.247751095647355e-01   +1.237705658457529e-02   -2.213627998092893e-02; +3.364449189152931e-02   +2.881475874088303e-02   +5.076133804555294e-02   +1.672146693093762e-01   +3.799088515248664e-02   +1.070160545782658e-01; +9.749544642463560e-03   -1.958435286194944e-01   +3.804425709491496e-02   +1.176654714228621e-01   +5.015299645531084e-02   +1.115985987933604e-01; +2.497404443381564e-01   +4.671941745619362e-02   +1.453161553896106e-01   +1.079760001965726e-01   +1.067465239576561e-01   +2.647477570302227e-01; +1.711687867659752e-01   -2.644601946786065e-02   +8.574890144841969e-02   +2.354900834613522e-01   -5.620408198659794e-03   +2.868417596396513e-02; +2.251084560239153e-01   +1.800610802388366e-02   -3.449320581528288e-02   +1.539192260020318e-01   -7.494932144250419e-02   +1.086479750392533e-01; +8.841692378452987e-02   +1.794613786743790e-01   +1.934361906350426e-01   +9.911068912890100e-02   -1.650819840146117e-01   -2.206244117663936e-02; +2.501864755965095e-01   +6.981876220446934e-02   -1.554145805687191e-01   +1.083587674632855e-01   +3.385989758159043e-01   +9.385957472246095e-02];
L2_L3_iGABA_netcon = [-2.874358969001790e-01   +1.886933531417589e-01   +8.034336318923177e-02   -4.440901766747022e-02   +7.216166562685099e-02   +1.762423090107188e-01   +8.042090421059439e-02   +7.593928538077280e-02   +9.890244331824945e-02; +2.633183052815706e-01   -3.523262864926894e-02   +4.530938247174683e-02   -8.666042022317506e-02   -2.513435267095995e-02   +3.122738893133868e-01   -5.545892968211755e-02   -5.307242884611572e-02   -1.194683282300356e-01; +4.368054759801356e-02   +1.933309096026001e-01   +1.616972017918178e-01   +1.097803297827816e-01   +1.770027292925393e-01   +1.501462522703286e-01   +2.071560019597047e-01   +1.270294336429210e-02   +1.749247910760175e-01; -1.377211298293819e-02   +4.356528016085923e-02   -2.102218242474128e-02   +1.622928379902680e-01   +1.276005436704095e-01   -2.459107339539972e-02   +2.339964722883486e-01   +2.200794719466909e-01   +3.926780353562591e-02; +1.756272797823696e-01   -8.725039545243775e-02   -1.330294354384039e-02   +2.549356073588938e-01   +7.947499893095381e-02   +8.257853964917257e-02   +1.833171816877893e-01   -2.085474618718056e-02   +1.839407833777710e-01; +1.281752386177354e-01   -1.029789514143363e-01   +1.147736986591374e-02   +1.183434788362220e-01   +1.950334223256658e-01   +2.652010737403238e-01   -2.745232163665893e-02   +7.536183038439401e-02   -9.759490323515355e-02];
L1_L4_iGABA_netcon = [+2.037727536049650e-01   +1.114977111670426e-01   +1.075704207582553e-01   +1.842437890979684e-02   +1.183291732166489e-01   +2.622618682891177e-01   -2.149800159058339e-02   +6.519338499435319e-02   -1.336053593986432e-01; +8.352455452435745e-02   +6.119882295307139e-02   +1.279807533386952e-01   +1.497085719513244e-01   +1.125747924886421e-01   -2.397479862247536e-02   +5.614763156110939e-02   -2.500771187077450e-02   +1.115491141183615e-01; +1.603336859315028e-01   +1.399754237768477e-01   +1.405802714801099e-01   -7.531013736321069e-03   +2.391575414123649e-01   -9.336936925011911e-03   -6.705400900797806e-02   -1.451245217360445e-01   +1.158852001844326e-01; -7.156670307109524e-02   -9.960257814968485e-02   +9.733515473228543e-02   +7.230347824241029e-02   +8.620088332055617e-03   +2.485840607113960e-01   +1.085711373689353e-01   +1.327018282435670e-01   +1.874644476211755e-01; -1.144028613416513e-01   +2.138003262022762e-01   -4.441373492823865e-02   -2.289231631723676e-01   +1.241807791058875e-01   +1.030390836155711e-01   -5.548175579421485e-02   +2.130156645415455e-01   +5.501600005400413e-02; +1.835757341115709e-02   +7.425980172749777e-02   +9.286631226912238e-02   +1.498666074922631e-01   +1.139076256154642e-01   +1.211199828450284e-01   +1.338240327097957e-01   +6.477244436763184e-02   +7.808315186513726e-02; +1.824812598614730e-01   +1.574236567845393e-01   +6.391015471232758e-02   +1.755501687256223e-01   +1.635473634027492e-01   +1.200834109031479e-01   +2.817482879077445e-01   +2.225174832943679e-01   +4.285382976062800e-02; +1.024652844819796e-01   +2.535191797442427e-01   +1.061142407764622e-03   -1.042879049982114e-01   -1.590876543633464e-01   +6.559095293077812e-02   +8.172350327885061e-02   +1.557309595277348e-01   +2.773051380236891e-01; +5.715377339039054e-03   -9.739056916525823e-03   +7.392749483089793e-02   -9.818880026652273e-02   +1.114107247020434e-01   -1.173337725842964e-02   +1.085462814395429e-01   +2.881450211804010e-01   -1.400317623147732e-01; +3.004890170578042e-01   +6.345919739430174e-03   -1.171272552264287e-02   +1.653975429850692e-02   +1.038773168654287e-01   +1.687810312427467e-01   +1.233930350626169e-01   +2.092516967304649e-02   +2.766437576407687e-01; +1.027776410234097e-01   +1.899009151423301e-02   +1.402737470217495e-01   +1.379407330861934e-01   +2.440567346319163e-02   +9.971813615473363e-03   -7.212485101316989e-03   +1.633951759794819e-01   -6.219950116858802e-03; +2.819012400456899e-01   -3.985212236542325e-02   +5.767847030947439e-03   +1.725324555757378e-01   +1.538372453905225e-01   +5.020933479575952e-02   +1.316627776844198e-01   +1.903805977576981e-01   +2.527640302468545e-01];
L4_L1_iGABA_netcon = [+1.877554040307467e-02   -4.665046547110413e-02   -9.005696107698456e-02   -3.529140366978935e-02   +8.599701065143420e-02   +1.048836431831524e-01   +2.035437122399722e-01   -9.401932516964670e-02   +1.435676984350336e-01   +1.576271526080456e-01   +1.628103801047555e-01   +2.006082044648702e-01; +1.221040119431379e-01   +5.269234200918357e-02   +1.664708451917789e-02   +1.394027522831326e-01   -1.053561248547956e-01   +1.592200314251579e-02   +2.190412405279600e-01   -2.883066217105763e-02   -5.094595832434191e-02   +9.392835002857447e-02   +7.138192107374997e-02   +1.769655183665189e-01; +8.866367674898426e-02   +6.850926712234749e-02   +2.328213225823387e-02   +9.073302640871103e-02   +1.462179984822727e-01   +1.547604964770782e-01   +1.127604594110899e-02   +2.043119886498678e-01   +1.850304779302119e-01   -2.139300423487242e-02   -5.040095577964376e-02   +2.140045423363415e-01; -9.162874373235297e-02   +8.065873798483260e-02   +2.151310786789253e-01   +1.433465990000015e-01   +2.208150749539025e-01   -5.641813078492970e-03   +1.581589917534779e-01   +1.270767973395205e-01   +8.665618851673348e-02   +2.103603946616949e-01   +2.085879435381991e-01   +1.048630476056616e-01; +2.546436026173979e-01   +1.865997567376368e-01   +9.446569414208378e-02   -2.439004479381779e-02   +1.559362619631604e-01   +1.470683189653623e-01   -2.054792117125064e-01   +1.007336011203298e-01   -1.414826995499263e-01   +1.655469575448538e-01   +4.724715742139626e-02   +1.448354398300219e-01; +1.696664633498375e-01   -4.831724164594018e-02   -9.447337392385044e-02   +1.149583298834839e-01   -7.203597760738367e-02   +2.108061618103664e-01   -6.733940958968548e-02   +1.745475011306024e-01   +7.290834562099852e-02   +1.364042282907706e-01   +4.250659697979886e-03   -1.076989334555866e-01; +2.042261389514028e-02   -2.840576641112921e-02   +2.102176055451610e-01   +2.357425843611081e-01   -1.915856089722724e-02   +1.173333977856170e-01   +1.259454715217399e-02   -1.281487852644599e-01   -6.066208926648825e-02   +1.945612513384976e-01   +1.093322721558827e-02   +2.092048280922215e-03; +2.384942887180614e-01   -1.567453095391602e-02   +2.297008501031072e-01   +5.777841176581352e-02   -8.008603051748024e-02   +1.819954860294145e-01   +2.371922487393127e-01   +2.672357904959076e-01   +1.451838504033399e-01   +8.762920714103030e-02   +5.770325699306586e-02   +1.102536466066260e-02; +1.943819830438532e-01   +1.263833678656647e-01   +2.686213720532710e-01   +7.079743698623199e-02   +2.168870937633040e-01   -4.236327090774776e-02   +5.366313276583976e-03   +1.036935716437271e-01   +2.555799901975593e-01   -1.409890562083055e-01   +6.003299544894342e-03   +1.193262290883829e-01];
L1_L3_iAMPA_netcon = [+9.661782269762245e-02   +2.143261027774972e-01   +2.119500430024377e-01   +1.913302723609375e-01   -7.114127625185855e-02   +1.324938404893740e-01   +2.654337630783398e-01   +1.065524533424761e-01   +1.379590658776114e-01; +3.970541903727572e-01   +2.296351845066402e-01   +1.046190383909989e-01   +2.758099476332561e-01   -2.169598027882538e-03   -3.006824955017657e-02   +2.533812782079189e-01   +9.425379005707923e-02   +2.659299113041267e-01; +1.332818802502844e-01   +5.990295877902780e-02   +1.457233044441112e-01   +1.874486662843427e-02   +1.335287703193274e-01   +3.315449882015833e-03   +1.514742607229329e-01   +1.168746522421782e-01   +1.655825569055297e-01; +2.378676795772924e-01   -2.143276702716791e-01   -4.670629349906585e-04   -3.713968096703087e-02   -1.768157180796626e-02   +9.554204208239286e-02   +8.085557605185777e-04   +1.717193278733514e-01   +2.302524851891324e-01; +2.639978254857189e-02   +1.123775985995691e-01   -2.921046800384196e-02   -1.452536043993794e-01   -1.548094961470627e-01   +7.232274638631958e-02   -5.076220615229408e-02   +1.016951927094056e-01   +1.105505787944882e-02; +1.417123577287484e-01   +2.276895487637523e-01   +5.103345017968028e-02   -6.636957189652978e-03   -1.120033595525177e-02   +4.660475132272804e-02   -2.292124697887857e-02   -1.906267557824129e-02   +2.855381605623236e-01];
L3_L1_iGABA_netcon = [+1.038432441748788e-01   +4.280721723579990e-02   +2.023557793256133e-01   -3.518714280360446e-02   +1.518546918997051e-01   -9.723407326766692e-02; +1.993469826899681e-01   +1.470399966018570e-01   +1.171034643722802e-01   +2.589788809203739e-01   +2.854106453493460e-03   -3.891886061304663e-03; +1.649361862046099e-01   +8.230889518837570e-02   -9.056950713956452e-02   +1.051732053725139e-02   +1.580191707428117e-01   +6.152279888322095e-02; +1.685901679791630e-01   -1.175541579836884e-01   +7.151755770185679e-02   +4.025040641616645e-02   +2.185426478870895e-01   +1.949322102573526e-01; +1.534866530839697e-01   +6.937610177126179e-03   +1.407119436760611e-01   +1.156468503629808e-01   +8.628611157939479e-02   +1.003215901041287e-01; -1.328593988713777e-01   +8.682856590810914e-02   +5.530649573790131e-03   -6.311443619779367e-02   +4.820526669712542e-02   +2.581654746110950e-01; +2.765162737646505e-02   +1.615630597770234e-02   +1.673625974503441e-01   +2.878817449643130e-02   +1.352394009727182e-01   +2.092777487827693e-01; +7.259908402620617e-02   +1.522540747800266e-01   +9.063865903904060e-02   +1.354127237927349e-01   +7.761474142656760e-02   +1.912558216434274e-01; +7.543990973200940e-02   -4.429835442187272e-02   +4.389376638557188e-02   -2.449728652864388e-02   +1.270581986513907e-01   -1.603238421984433e-01];
L5_Input1_iAMPA_netcon = [-6.165766281552301e-02   -9.024562824952842e-02   -9.844842396144947e-02   -1.127015370001611e-01   +3.936291537074302e-02   +8.864008741333045e-02];
L6_Input2_iAMPA_netcon = [-8.762823842241223e-02   +1.048723327405774e-01   +3.004876014996443e-02   -2.114986042336878e-03   +1.792560841345892e-01   -7.246016163687308e-02];
L5_L6_iAMPA_netcon = [+1.494929883035840e-01   +9.025269613820572e-02   +2.241839053499790e-02   +1.192860167927602e-01   +1.741439655268888e-01   +3.776360918477709e-02; +1.544424040861101e-01   +2.182139379644150e-01   -1.033981302514115e-01   -1.028491348238060e-01   +1.684121507968631e-01   +7.085338450836570e-02; +5.689208898158883e-02   +1.288973826973289e-01   -1.911167165471551e-01   +2.889444666096447e-01   +1.855490431782809e-01   +1.307718150910994e-01; +6.394988169980115e-02   +3.068215205879569e-01   +1.127095247457935e-01   +3.480653937473113e-01   +2.010356351668310e-04   +9.982208266428032e-02; +1.733603796632378e-01   -1.043114788879258e-03   +1.089182850833758e-01   +4.217737500115698e-02   -1.004633605381013e-02   +1.469275079481661e-01; +1.111870490307504e-01   -1.254280436573404e-01   -4.455873457422197e-02   +8.370510183551567e-02   +1.100788324156716e-01   -3.740334710377357e-02];
L4_L5_iAMPA_netcon = [+1.513903138041181e-01   +4.176052174794786e-02   +2.530638164220753e-01   +2.125378085026975e-01   +1.008598466460840e-02   +3.773657114430291e-03   +1.909469423144808e-01   +2.441509916587569e-01   +1.257783476368228e-02   -3.200076590544251e-02   -6.034937706121919e-02   +4.684014200853618e-02; +2.617470663719149e-01   +1.303454485413482e-01   +9.266008152702464e-02   +1.204200526751289e-01   +2.152932960641712e-01   +7.028531253136938e-02   +1.217240629107131e-01   +1.591900850018995e-01   +4.657955206436114e-02   +1.602932347740872e-01   +7.792206427497878e-02   +2.876962168835508e-01; +9.950655051969240e-02   -1.079158987617298e-01   +7.873682024297454e-02   +9.722655304081852e-02   -1.036553309293473e-01   +1.161041548159263e-01   +5.841955166750434e-02   -4.667808399329238e-02   +4.947801426477731e-02   +3.073103991931182e-02   +1.453259172591641e-01   +1.331292931572265e-01; +4.246014273618606e-02   -1.470650068760173e-01   +1.729723599938957e-01   -8.230723306164128e-03   +8.169729101337439e-02   +1.000043408039244e-01   +2.214237780487127e-03   +1.737977884012331e-01   -3.244959101033994e-02   +2.894707435107800e-02   -5.843521934346367e-02   +3.401501199212771e-02; -2.487727196969846e-02   +2.392006966675136e-01   +2.631121781854820e-01   -1.704851279098527e-01   +2.160225522140741e-01   +2.220408837195345e-01   +8.071077096190685e-02   +1.459703035862007e-01   -5.726986596793510e-03   +1.651746391697821e-01   -1.703640683962806e-01   +3.188183822315834e-01; -1.907583878378420e-01   +9.002013026762778e-02   +1.571195091671808e-02   -4.810204300052608e-02   -5.239499565433062e-02   +2.135780819434629e-01   +1.175769759196614e-02   +9.534550395826369e-02   -2.492207889060834e-02   +1.369825088237716e-01   +1.749508906920585e-01   -3.262581587267879e-02];
L6_L4_iAMPA_netcon = [+5.899271826392043e-02   +1.257245331781198e-01   -2.269472135387504e-01   +2.647945868663215e-01   +1.857641034750189e-01   -1.534352798182875e-02; +6.009697495400763e-02   -1.333624507639984e-01   +1.092102953987650e-01   +7.856433222133721e-02   +4.916230384122878e-02   +1.795515394992716e-01; +9.033940097398535e-02   +2.953040341540529e-03   +1.727677492962794e-01   +1.167873414735903e-01   +1.053812267040262e-01   +1.893975849263691e-01; +1.472215034578777e-01   +1.695562745075135e-01   +3.467017292721267e-01   +2.334217128290588e-01   +1.463027676863144e-01   +2.848013929375994e-01; +7.495364198953824e-02   +6.866716602897889e-02   +1.078531925955855e-01   -6.525946631868193e-02   +6.923089059102530e-02   -4.234335840282849e-02; +4.833717661029767e-03   +1.082678310812370e-01   +2.627646405302586e-01   +2.115818992447364e-01   +2.283676367039291e-01   +1.379803031582905e-01; -3.108214579214486e-02   +2.017349412272191e-01   +4.916082568844187e-02   +1.687617622570130e-01   +9.860535912987833e-02   +1.045239424586746e-01; +4.507250163487525e-02   +8.990892819948473e-02   -9.254141196442640e-02   -6.655503666701199e-02   +8.564697796658066e-02   +6.365608961806342e-02; +1.430655870179412e-01   -8.632528672826276e-02   +1.147295422749017e-01   -6.792010998441053e-03   -4.639991603415747e-03   +4.800748830990798e-03; +7.305743495458865e-03   +2.573657591286210e-01   +2.636913415354501e-01   +4.348682417391825e-01   +2.858355437106980e-01   -4.964922764661690e-02; +2.362504885432734e-01   +1.995511131480258e-02   +2.046247365370454e-01   -3.458879074862758e-04   -5.231417701803164e-02   +2.370180586285512e-01; +2.346866916644972e-01   +9.530885225425843e-02   -2.114158361434704e-02   +1.035537614182703e-01   +1.292823149650162e-01   +1.147692472208694e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
