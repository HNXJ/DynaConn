function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.288163099122932e-01   +1.630809435607232e-01   +3.002849544166763e-01   +2.553738485008210e-01   +6.377255161194867e-01   +7.204211196834787e-02   +3.282646386690368e-01   -1.745948655978124e-01   +5.335373679672244e-01; +2.653386912088668e-01   +8.427194997896169e-01   +4.603272909863890e-01   +5.172942023618298e-01   +4.847368744098769e-02   +5.488100847635076e-01   +5.964717878262457e-01   +3.026183780066991e-01   +3.439584408304054e-01; +2.829269944551495e-01   -6.852107680633521e-02   +4.719526985731153e-01   +9.560115868534609e-01   -2.084509332437842e-02   -1.463671107308622e-01   +4.369793292674832e-01   +4.995343734925051e-01   +2.228664000689393e-01; +1.548656830861608e-01   +5.759632921571887e-01   +6.854153642517995e-01   +5.086501729349343e-01   +7.518612883109359e-01   +5.328313996926476e-01   +5.298440426262867e-01   +1.187010502160645e-01   +5.667165440912156e-01; +1.889277093012180e-01   +4.346111435168601e-01   +6.646967753754195e-01   +3.245931879215391e-01   -1.228870666421960e-02   +7.016457959970591e-01   +4.986311535589817e-01   +4.850373652217578e-01   +7.482799775216312e-02; +6.592420792575755e-01   +5.091599307287354e-01   +1.278506292202261e-01   +6.426332475107930e-01   -2.340618794721021e-01   +5.508191485078480e-01   +8.038477642422732e-01   +5.981432295541463e-01   +4.113040417361883e-01; +1.000000000000000e+00   +7.060911386576352e-01   +5.556316275593910e-02   +2.282338580835938e-01   +1.808417290827252e-01   +6.280160119205366e-01   +3.114754688959658e-01   +3.037475113841321e-01   +3.935005467391068e-01; -5.421535430269656e-02   +5.642059304878806e-01   +6.430751736240543e-01   +5.060894802871123e-01   +8.486284533283405e-01   -2.887394038472865e-01   +1.365464605783822e-01   +3.377081389417360e-01   +4.780962014281504e-01; -4.134507047290709e-02   +1.217763230351529e-01   +2.303337633770051e-01   +3.239234336888974e-01   +7.437678695946048e-02   +2.363989588649067e-01   +9.498130283706672e-01   -1.776131543759003e-01   +6.866279382825643e-01];
L1_L2_iAMPA_netcon = [+1.283646342210714e-01   -1.783035886600418e-01   -1.185839034083107e-01   +6.761646877888736e-01   +1.362534526366060e-01   -1.057336524316191e-01   +8.632352654380160e-01   -1.023503959570605e-01   +5.326382108933511e-01; +4.496242759547808e-01   +5.644507540129268e-01   +3.308700521366870e-01   +2.266114596237998e-01   +6.940761752920120e-01   +4.777779379925735e-01   +1.846385650060627e-01   +9.459938495861158e-01   -6.643472970331588e-02; +4.985629892338284e-01   -2.232751565753762e-01   +3.004522482195373e-01   +7.538106937570325e-01   +2.706145946688303e-01   +4.750443900331602e-01   -1.402432278073568e-01   +1.950758442327306e-01   +5.864133992010478e-01; +5.471552421034481e-01   +3.736745544020840e-01   +7.727393595113502e-01   +8.763180176323625e-01   +2.264671580706500e-01   +6.372631802083842e-02   +4.794784686634346e-01   +1.965887668160716e-01   -1.249515569745999e-01; +1.608539054797549e-01   +7.759091643131555e-01   +5.636003112351423e-02   +3.825613041236950e-01   +3.251249161274145e-01   +6.778773821732862e-01   -1.238211208725284e-02   -1.985378868779776e-01   +1.279804697913974e-02; +5.047669725158538e-01   +7.847718748861223e-01   +3.121898376233631e-01   +5.513558910271839e-01   +5.350044866026621e-02   +4.788490354648181e-01   +8.982613765225987e-01   +7.202456220505244e-01   -4.447554653169139e-02; +1.365520496622943e-01   +3.651000903256523e-01   +3.404369566073338e-02   +3.793317680129320e-01   +4.499043132092284e-01   +5.442120346187092e-01   +4.628226214146460e-01   +8.211493134328118e-01   +3.214131531139605e-02; +3.009691354586513e-01   +1.173009750019075e-01   +3.040665775064118e-01   +4.413002286331563e-01   +4.847337638091481e-02   +5.037119358166051e-01   +4.329115083225737e-01   +5.748856614229029e-01   +7.133999231559301e-02; +7.391656489938434e-01   +1.703862646583993e-01   +3.983878256781879e-02   +9.203350746117429e-01   -1.072696906612567e-01   -8.801674061539275e-02   +5.795218452707017e-01   +2.551148891079087e-01   +9.699564552318907e-01];
L2_L5_iAMPA_netcon = [+3.842969914150390e-01   +7.138573013462841e-03   +2.834182276609382e-01   -8.037992888216372e-02   +9.212687853206697e-01   +2.249393003772518e-02   +3.161259137574359e-01   +4.794155841548133e-01   -1.033198925626161e-02; -1.155253897996511e-02   +7.632713577520130e-01   +8.407873276702492e-01   +8.387029925436733e-01   -1.676297914443194e-01   +2.753403384455892e-01   +1.449211144337534e-01   +6.231139041884447e-01   +7.079278770808014e-01; +3.310520436551790e-01   +2.550168452949880e-01   +7.520989741450544e-01   +4.149318722911296e-01   +9.547776145761516e-01   -2.588646884284547e-01   +6.379129858522844e-01   +2.434146484661484e-01   +4.934583888335277e-01; +6.045232022956950e-01   +8.343725980948227e-01   +6.635119785253132e-01   -1.233271381557253e-01   +5.296629494766505e-01   +6.695731800425131e-01   +1.904738119282413e-01   +4.236470166205371e-01   +4.503704057926943e-01; +7.301846533469373e-01   +7.569724821170211e-01   +7.363033615822434e-01   +7.726003168422896e-01   +4.751242144429250e-01   +1.637923965698676e-01   +8.782451743383141e-01   -2.231304493123857e-01   +8.959745665224614e-01; +1.000000000000000e+00   +4.679201169547696e-01   +3.920701725931701e-01   -8.987219110511060e-02   +2.333599239001577e-01   +4.608509900027739e-01   +9.154993714689156e-01   +3.880727829354469e-01   +8.782880936173052e-01];
L5_L2_iGABA_netcon = [+4.034774283398749e-01   +7.510453240630920e-01   +4.623445014815846e-01   +9.287291512068573e-01   -6.303479880239028e-02   +6.695375793076126e-02; +6.114053770150155e-01   -2.566870479824054e-01   -1.347256674878730e-01   +5.163008806461858e-01   +4.754031837321878e-01   -1.883361110852075e-01; +1.483609069732649e-02   +3.552897644688383e-01   +9.029861444264818e-01   +6.687127134185288e-01   +6.435895463379354e-01   +6.938869699547193e-01; +5.116820557539115e-01   +6.157443308029020e-02   +5.144661803979945e-01   +6.694620755788243e-01   -9.256906390242355e-02   +3.744721650168545e-01; +9.919491187719415e-02   -1.991099126459419e-01   +1.550501979195576e-01   +3.100687492231190e-01   +1.000000000000000e+00   +4.978257686931229e-01; +5.231360342904179e-01   +3.765949344916014e-01   +7.487055950938850e-01   +4.595741475243031e-01   -2.020394984167425e-01   +4.290467399909697e-01; +8.083487899399253e-03   +4.014920860641959e-02   +2.688609845562737e-01   +8.136815930531998e-01   +2.664790079267860e-01   +1.175410751489454e-01; -2.142470955810654e-01   +4.259718833270126e-01   +8.132399515299567e-01   +5.365924874585613e-01   +3.361986865495954e-01   +8.809312765396003e-01; +8.820273044358954e-01   -2.646926165855712e-03   +3.651569606671454e-01   -2.265416841142054e-02   +3.180703698431411e-01   +6.163458434952336e-04];
L3_L2_iAMPA_netcon = [+8.299824666178833e-01   +1.921851504659533e-01   +5.535383175009356e-01   +5.395414815088333e-01   +2.441961794882320e-01   +4.694928154089828e-01; +4.957515655470762e-01   +7.835757632217680e-01   +4.732229520309502e-01   +1.727102495260402e-01   +7.887828498226976e-01   +9.733548445988791e-01; +6.208021828804131e-01   +1.325832151887703e-01   +5.976137780441438e-01   -1.674505401699609e-01   +2.602422070354039e-01   +2.587207861708652e-01; +9.379690636321233e-01   +4.972167701630953e-01   +2.155772502044831e-01   +2.055001947430568e-01   +6.261946078281679e-01   +2.677424000933663e-01; +3.685742145141887e-01   +3.608483530488107e-01   +3.939087105786649e-01   +4.162759339960921e-01   +4.864679681190509e-02   +6.001802553711697e-01; +3.818743940075870e-01   +6.717481111734143e-01   +4.236468902824181e-01   +5.381173074621696e-01   +7.452064621172485e-01   +1.456455020839455e-01; +1.254073086663595e-01   -2.633543850720826e-02   +4.612585067375731e-01   +3.342576232331554e-01   +6.341118097064947e-01   +2.346982586267456e-01; +3.678627533090445e-02   +6.829002111508272e-01   +1.713912835322305e-01   +4.672470106050367e-01   +8.729058864412852e-01   +2.024362754978595e-01; +1.007395511325888e-01   -9.070472191887990e-02   -8.567100681490197e-02   +9.365932038843932e-01   +9.089563608514624e-01   -1.500984578734407e-01];
L2_L3_iGABA_netcon = [+3.337353015645282e-01   +5.946731982016986e-01   +5.763336653252823e-01   +2.995536272922570e-01   +1.000000000000000e+00   +1.194242360235301e-01   +6.116710945114471e-01   +9.519347300321243e-01   +3.663908449971066e-01; +4.414627846241799e-01   -3.440358652204735e-02   +4.909278489429117e-01   +5.531045366152990e-02   +2.856839928337754e-01   +2.464144730193701e-01   +5.571325537593598e-01   +4.042219310688736e-01   +1.716726632865961e-01; +2.264510944505016e-01   +6.821689175007266e-01   +7.995732902568058e-01   +4.361053376906813e-01   -9.181207720039257e-02   +5.078198610591406e-01   +2.361758885545967e-01   +1.157638990551109e-01   +8.926395528236826e-01; +4.520825776829950e-01   +4.693713399128814e-01   +6.023031865000679e-01   +2.329353668613356e-01   +1.291549055519435e-01   -2.138240838478925e-01   +1.352945824108681e-01   +7.039101981311697e-01   +5.522793741018527e-02; +4.534347902359472e-01   +8.528403704754841e-01   +5.834327941547376e-01   +7.924178106269905e-01   +4.925710493991003e-01   +5.843218388794149e-01   +3.873185142552307e-01   +1.720615280672487e-01   +2.885210075176046e-01; +6.491918491542115e-01   +6.102123672930211e-01   -3.711407799080610e-02   +1.616053634305566e-01   +3.396558405629019e-01   +5.105644911471695e-01   +6.375389690570591e-01   +3.806034061463101e-01   +3.365695503783927e-01];
L1_L4_iGABA_netcon = [+4.288503100389688e-01   -5.535786473088664e-02   +5.232583661633929e-01   +6.489294077658750e-01   +1.387103597706462e-01   +7.780204482413092e-01   +5.263924742978425e-01   +7.243466298665160e-01   +2.662460110783930e-01; +1.043016283907071e-01   +3.704490427967707e-01   +6.076182622414857e-01   -2.231904056425010e-01   +4.169720569431726e-01   +2.783021956367817e-01   +4.778003836113794e-01   +5.768820893391754e-01   +1.046255893824665e-01; +5.045769301014486e-01   +6.337360706582753e-01   -6.463734140661008e-02   +7.140672161290768e-01   +1.824258667859893e-01   -2.282403300132878e-02   +7.263502667681518e-01   +7.561422542815481e-01   +4.289487139752023e-01; +3.961556216534836e-01   +5.628623972241438e-01   +1.508383101846348e-01   +4.684261042879181e-01   +2.647203273892056e-01   +3.834153716129352e-01   +8.409558124380511e-01   +4.886935784616869e-01   +4.275102266608395e-01; +5.895607121978854e-01   +2.960464144562219e-01   +5.906964404735845e-01   +2.481561673474844e-01   -4.143339633908615e-02   +1.809313674310898e-01   +2.442460290935014e-01   +7.006975004971250e-01   -3.009045847614603e-03; +7.226973711890295e-01   -1.555827754777854e-01   +7.838980825487932e-02   -1.870887687128894e-02   +2.435965422006709e-01   +9.025348685022059e-01   +2.783831430300034e-01   +8.361673871312707e-01   +7.493581332242563e-01; +4.904393163159467e-01   +8.528740162500352e-01   +2.265213513403176e-01   +6.925566711067620e-01   +5.681073636165279e-01   -6.537237611497479e-02   -5.717935037814786e-02   +4.567998958701813e-01   +4.026095403663250e-01; +4.936282347233744e-01   +2.663680633268661e-01   +5.960167221829756e-01   +5.722218802214332e-01   +3.362951248378054e-01   +6.138810033409585e-01   +4.014474183625064e-01   +5.866555883571917e-01   +4.546365350836030e-01; +5.714383615645706e-01   +3.700071942816602e-01   +7.113020393260103e-01   +5.507682446734540e-01   +3.869572548415582e-01   +7.727728953891180e-01   -1.238706197401568e-01   +6.645069640824786e-01   +4.230143629875220e-01; +7.318899757393096e-01   +5.403966575148035e-01   +4.111764829526205e-01   +3.312398359117024e-01   +4.780684941870716e-01   +5.041137038580830e-01   +2.516325163440283e-01   +5.091920184641752e-01   +2.055736302559552e-01; -1.247701533474995e-01   -2.704585500187813e-02   +3.691542990632434e-01   +2.270467737016712e-01   +5.228729612883164e-01   +4.424398083481083e-01   +1.739996150723552e-01   -7.486597870374073e-02   +1.000000000000000e+00; +5.987069223430938e-01   +1.911445028272240e-01   +4.936922569574292e-01   +6.756828817352237e-01   +7.794425324672695e-01   +3.075045065097803e-01   +7.567783516483513e-01   -1.086015615567583e-03   +7.626034551742496e-02];
L4_L1_iAMPA_netcon = [+4.085382921392400e-01   +1.488281406882393e-01   +5.824597702506078e-02   +3.747221336888913e-01   -8.172610909808506e-02   +1.562616337846004e-01   +8.274836701193918e-01   +5.180092092746474e-01   +3.792309028721360e-01   +8.436326716780808e-01   +4.112094775583974e-01   +1.337174382212680e-01; +3.979301749346194e-01   +1.330165049541773e-01   +3.522887917535212e-01   +3.622836956666072e-01   +8.827998775259752e-01   +6.347364147930726e-01   +2.996234005539596e-01   +8.705315780122640e-02   +5.901475935861085e-02   +1.000000000000000e+00   -3.571923367090550e-02   +6.484033919106418e-02; +3.372394831192325e-01   +5.177847753173200e-01   +7.188291124867208e-01   -1.113343212120821e-01   +4.224359669019397e-01   +4.943825531144411e-01   +9.407069505858083e-01   +2.782213718563666e-01   +1.700822509225522e-01   +3.254920554530507e-01   +6.107835854340188e-01   +5.753705458474938e-01; +8.322108087454667e-01   +9.422493841128209e-01   +2.340752675038668e-01   +7.133224993863208e-01   +4.260147909669053e-01   +4.535336613315069e-01   +5.137933662627526e-01   +5.176538876811348e-01   +5.991222513534653e-01   +2.288013360476185e-01   +1.141738042632972e-01   +6.348443441475616e-01; +4.097330271547928e-01   -2.100067926529790e-01   +9.318454749804776e-02   +4.522727816542978e-02   -1.114090606660556e-03   +7.091580075778715e-01   +3.179307447358991e-01   +3.210686843657478e-01   +5.261522955399084e-01   +5.544484945768038e-02   +1.299183919921896e-01   +5.824454735366664e-01; +3.434781459031501e-01   +5.079650996060937e-01   +8.665370190527903e-02   +2.058205373028651e-01   +7.078281751765330e-01   +1.130783658538419e-01   -1.074396043388666e-01   +7.934561214058838e-01   +9.682985356182616e-01   +7.426125714488826e-01   +7.069861888998832e-01   +9.438699990467506e-01; +3.291915169165535e-01   +5.836028932633865e-01   +7.238035411265125e-01   +2.246320026833146e-01   +1.283788250437571e-01   +4.655144727334424e-01   -1.800301774859005e-01   +2.289924345086567e-01   +6.835930558766603e-01   +3.502689153680137e-01   +2.015345979073651e-01   +4.854413647855551e-01; +6.176633002596507e-01   +3.888213390114980e-01   +9.217625553243636e-02   +1.116964219910949e-01   -8.857006741611967e-02   +2.688774850358533e-01   +8.296919996545161e-01   +1.586429448610064e-02   -6.988860857893818e-03   -1.682033592650179e-02   +2.818158368191883e-01   +6.882702866027289e-01; +4.372427912269911e-01   +1.563196096620936e-03   +7.201159616753166e-01   +8.812665544104265e-02   +4.663035253800033e-02   +4.796874399001522e-01   +1.772580618080813e-01   +3.509672487165904e-01   +6.792365565478234e-01   +9.844265429218479e-02   +6.070726724612604e-01   +1.824024742632658e-01];
L1_L3_iAMPA_netcon = [+3.153334735277082e-01   +2.626189750424806e-01   +6.230073823230173e-01   +5.414811150615180e-01   +9.477835915018273e-02   +1.801486173654854e-01   +7.799777774631980e-02   +5.771708898923888e-01   +3.874232204351722e-01; +2.998931352604643e-01   +2.729574296599400e-01   +6.464213451309047e-01   +4.938049459426902e-01   +1.286530621838980e-01   +3.056900910403145e-01   +2.179908574261983e-01   +3.584981378662957e-01   +8.365709232571763e-01; +5.412593642946446e-01   +3.252463113773761e-01   +4.530900202544162e-01   -1.283046689919448e-01   +5.210025099459678e-01   +2.169095662011681e-01   +7.019797056754095e-01   +2.848209687656211e-01   +4.478079067771185e-01; +3.548754254894360e-01   +3.058048648245457e-01   +3.401581756972186e-01   +6.420600900780807e-01   -7.039300551938912e-02   +3.621018612781942e-01   +2.765038216694954e-01   +4.495815591603992e-01   +3.734540390722631e-01; +8.310579500850943e-01   +2.118862241218344e-02   +5.156118023210920e-02   +5.295576080624464e-01   +6.207114742598123e-01   +6.432397600577003e-01   +2.155973565106300e-01   +3.702528722595895e-01   +7.360939728902445e-01; +1.021522091770138e-02   +4.276329190832404e-01   +8.181126412158319e-01   +2.116570333687482e-01   +9.146312699069800e-02   +4.324008165342176e-01   +6.777582112311766e-01   +1.352241264685884e-01   +6.779779265770212e-01];
L3_L1_iGABA_netcon = [+5.151621832215618e-01   +4.934816433502077e-01   +1.000000000000000e+00   +6.437497328630396e-01   +3.767202889061411e-01   +7.336653589219378e-01; +1.555481101379529e-01   +4.704800187701142e-01   -2.466184905508570e-03   +1.477657800425652e-01   +2.424247931897710e-02   +2.936741770679057e-02; -8.000980622632364e-02   +8.100032300051587e-01   +4.771641413522199e-01   +7.600163932045769e-01   +1.748583482018986e-01   +6.254786990595396e-01; +5.924993603665745e-01   +5.542027518584434e-01   +3.782465505579324e-01   -2.313899782569135e-01   +2.972855385307764e-01   +4.232932893639350e-01; +4.307443487442457e-01   +3.398764912482452e-01   +3.874862846218604e-01   +5.178034325478539e-01   +3.205928517646348e-01   +5.345132939056390e-01; +6.489068970052667e-01   +5.046815796810272e-01   -7.692874015900217e-02   +6.794906220695960e-01   +2.155490806151603e-01   +3.253087727092568e-01; +3.746805442417566e-01   +1.418722045177287e-01   -1.011234097598164e-01   +5.423952527016425e-01   +4.651148547222371e-01   -1.991657300420920e-01; +6.682991505099846e-01   +6.973854177041635e-01   +6.911838015639463e-01   +6.617404347439169e-01   +5.265132631915979e-01   -4.196837355943368e-02; +1.151902052321514e-01   +7.058506537676831e-02   +1.955859009529142e-01   +6.343461051131586e-01   -9.912519152525208e-02   +3.025801276233771e-02];
L5_Input1_iAMPA_netcon = [+9.071746520526303e-01   +8.188569096998544e-02   +1.093008605267224e-01   +6.505457973834402e-01   +5.537634725579167e-01   +1.064855953786679e-01];
L6_Input2_iAMPA_netcon = [+4.714628618493417e-01   +1.358386875078696e-01   +3.263327507064666e-01   +5.132743749349650e-01   +4.580144259576129e-01   +6.031607275912172e-01];
L5_L6_iAMPA_netcon = [+4.400419394030568e-01   +1.723069549616701e-01   +3.455166061463893e-02   +3.593148096637682e-01   +3.656522097777021e-01   +4.815657099384926e-01; +4.486080025782063e-02   +4.494305534070936e-01   +8.643524730156573e-01   +7.588436936623733e-01   +7.188984015327484e-01   +2.781271691435331e-01; +5.527265234855208e-02   +8.237012866274790e-02   +7.444547621665524e-01   +6.715594451474112e-01   +4.477623301603316e-01   +1.369478562163300e-01; +1.899824716336490e-01   +4.051850251613321e-01   +6.951886595502582e-01   +1.086269741565123e-01   +1.900655981817044e-01   -4.422886141908189e-02; +3.611386986240664e-01   +1.113792697555053e-01   +5.249975685541146e-01   +4.672907253613829e-01   +6.197334225875604e-01   +5.405164746981271e-01; +4.853842050452656e-01   +2.590301450472950e-01   -2.245116460591667e-02   +4.882028777408373e-01   -1.676485010218885e-01   +8.537064083605667e-01];
L4_L5_iGABA_netcon = [+2.186433670946188e-01   +3.828593808922467e-01   +6.325233125425218e-01   +2.169586456121789e-01   +9.704262218504259e-02   -3.666366079147747e-02   +1.763854081559356e-01   +9.013362260049523e-01   +1.206702893683299e-02   +5.799446319084168e-01   +5.493121771708946e-01   +4.462948286315678e-01; +6.829396150981837e-01   +7.128164203404986e-01   +6.457048930368371e-01   +1.083784873184716e-01   +9.495053338489278e-01   +9.307540615557173e-01   +2.220659667198108e-01   +7.151129626126395e-01   +6.365456528777133e-01   +2.335356645603657e-01   +8.132557765429465e-01   +3.903856700258527e-01; +3.335116219571292e-01   +1.000000000000000e+00   +3.854003606234348e-01   +5.798983023923120e-01   +9.912134180325605e-02   +4.171194077971589e-01   +8.218700117422059e-01   +1.718181513373887e-02   +2.014139626635065e-02   +2.860367503291126e-01   +1.517964013660870e-01   +3.296239682902645e-01; +2.495480732586155e-01   +3.200512848996805e-01   +3.331191623112568e-01   +7.597793173809466e-01   -1.913289076402866e-01   +9.147422905852024e-01   +1.671724693188804e-02   +4.922711734858486e-01   +1.734452617954714e-01   +8.164542418809267e-02   +1.255824441795807e-01   +6.043936466072385e-01; +2.774421427880044e-01   +1.224662219317363e-01   +6.090003874652963e-01   +2.708577666895329e-01   +7.603574508130825e-01   +2.465193413156415e-01   +5.100292517799290e-01   +5.105002329490236e-01   +9.319353342805177e-02   +6.478652457116784e-01   +4.403054578579011e-01   +7.439160695526771e-01; +6.373552730760516e-01   +5.060963357727027e-01   +4.411852403691898e-01   +4.260037420042683e-01   +1.589203075633586e-01   +5.855753174957175e-01   -5.556580376219734e-02   +4.229643157812344e-01   +4.254086672997131e-01   +3.115333947333045e-01   +2.314819267207068e-01   +5.635433376067748e-01];
L6_L4_iAMPA_netcon = [+4.964554342152026e-01   +3.388713386961694e-01   +5.213180801960320e-01   +6.561062663262855e-01   +5.095867630429187e-01   +1.800453673133092e-01; +4.118562871800919e-01   +2.380802695129217e-01   +4.923424774796669e-01   +1.439762143005053e-01   +2.222605685959414e-01   +2.232243973747409e-01; -2.185467171164307e-02   -9.635235716202561e-02   +4.511138727872788e-01   +8.595748382638922e-01   +4.367971002411264e-01   +5.901017468693883e-01; +3.644772345493285e-01   +3.779230900231027e-01   +6.535267524606208e-01   +6.037855592085493e-01   +4.837769840650676e-01   +6.570820686870886e-01; +1.275825351131527e-01   +2.874663495839257e-01   +4.652465664099168e-01   +5.794096512833394e-01   +6.638630780259311e-01   +1.444119888213568e-01; +5.512284304496029e-01   +5.982570604604518e-01   +3.387186584907138e-01   +4.784265699678407e-01   +3.442973339390910e-01   +7.487758976639616e-01; +1.351899677533324e-01   +5.007498056668780e-01   +5.487131498179978e-02   +3.929641946110267e-01   +2.903699736479517e-01   +4.144011933082510e-01; +6.442458946445305e-01   +5.195824016960280e-01   +7.547180798364556e-01   +5.708539567390499e-01   +1.061839292243669e-02   +2.074166348896599e-01; +4.552324973198424e-01   +3.622074957525242e-01   +4.133267533458748e-01   +6.005913306484321e-01   +9.250342533755109e-01   +1.508430422054518e-01; +2.804827921443847e-01   +4.645711105088293e-01   +5.668142519212209e-01   +4.392728813792784e-01   +7.401252511300415e-01   +6.809920354219803e-01; -3.211781346561915e-03   +1.075135833430829e-01   +3.028853176500944e-01   +5.836696375143547e-01   +4.415029203904328e-01   +3.528253510738427e-01; +2.395358998531604e-01   +2.240787836640167e-01   +3.917773256055982e-01   +2.191143389135177e-01   -4.298249408967014e-02   +3.280789661458611e-01];
L5_L4_iAMPA_netcon = [+2.795630692515600e-01   +4.760373858942083e-01   +1.496088393910420e-01   +6.374816712039585e-01   +4.414907052358761e-01   +1.431060006761361e-01; +3.912745646813630e-01   +3.067982087107382e-01   -1.418419609612453e-02   +1.729508399811972e-01   -6.646774148941942e-02   +7.812974684598565e-01; +4.522302730285119e-01   +5.583226380096289e-01   -1.145536530079908e-02   +5.627517173968877e-01   -4.158055197568383e-02   +6.418058634919133e-02; +7.708256959642426e-01   +4.305639125156669e-01   +5.926708892449836e-01   +6.751134323397093e-01   +3.210046556710107e-01   +9.409722073865026e-02; +5.917592697879192e-01   +1.065554043781214e-02   +3.875956741062517e-01   +3.739712055949973e-01   +1.939544755880565e-01   +3.750187076782180e-03; +5.576270559964795e-01   +3.263522641816800e-01   +3.875593512160627e-01   +9.295844488008219e-01   +4.917348425593913e-01   +1.980123662094364e-01; +8.072395641026864e-01   +6.239351438410240e-01   +9.251745890593348e-01   +4.240177532311737e-01   +6.442666365452629e-01   +2.135917769131733e-01; +3.577302792604279e-01   +9.464798325684788e-01   +5.857814920797444e-01   +7.924551959333426e-02   +3.105165940183388e-01   +7.378603197969762e-01; +2.032746367764420e-01   +6.734943838782972e-02   +2.923081305293990e-01   +3.326150423549242e-01   -3.097727624969089e-01   +2.144569515462226e-01; +2.641528225328476e-01   -6.732730475393134e-03   +1.751934087229514e-01   +2.948242274161243e-01   +1.943885616730641e-01   +3.636795327356266e-01; +3.120196358619659e-01   +2.244415609466812e-01   +4.769367264909526e-01   -5.902097802907721e-02   +3.591581261169714e-01   +7.092516288372590e-01; +9.911937591232056e-01   +2.462536593290625e-01   +6.352743375449318e-01   +6.946212357639431e-02   +5.171833450971616e-01   +3.512722187680712e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
