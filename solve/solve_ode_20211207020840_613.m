function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.681008762773618e-01   -4.764762419513381e-01   +2.466344014969681e-01   -8.046533350518638e-01   +1.596422745971128e-01   +2.327928906963635e-01   -7.126530472129384e-01   +4.667039094148192e-01   +8.376923018085458e-01; +7.027118643768204e-01   -6.378901656935119e-01   -2.913815323865607e-01   +1.935182472663223e-01   -7.586154967703661e-01   -6.579177419521897e-01   +1.676346985506988e-01   +6.615808130265791e-01   -8.454426288217630e-01; +6.176380508520941e-01   +8.536166487084774e-01   +6.569940809971799e-01   -1.150304183693517e-01   -9.187639427542035e-01   +4.880764287673967e-01   -9.850710312996203e-02   -8.031331137031710e-01   +1.000000000000000e+00; -6.982481296308976e-01   +2.984937937315405e-01   +7.467140914356273e-01   +8.142479924583765e-01   +1.184502771995923e-01   -9.336067316045878e-01   +7.287314186805799e-01   -7.223222808053867e-01   +1.236944914301595e-01; +3.623526155564238e-01   +2.800955208097453e-01   -7.737590980476640e-01   -7.909621094876882e-01   +4.258873904468813e-01   +2.396371650837782e-01   +5.108260970439700e-02   -5.247751344080592e-01   +6.545592030477244e-01; -3.946374670884649e-01   +8.161482147898655e-01   -2.909362604477459e-02   -4.077411484793073e-01   -8.379105472300711e-01   -9.630407146425096e-01   -3.723109622803024e-02   +7.270179893553576e-01   -5.569957182376860e-01; -3.821251287230016e-01   +7.474540497715911e-01   +4.543136387973810e-01   -5.267903715590545e-01   +5.488948950849504e-01   +4.797484468482754e-01   -4.553132579928285e-01   -9.343767805823170e-01   -5.578867224066281e-03; -2.157846273579995e-01   +5.324214050952948e-02   -7.440269457383820e-01   +7.152585508615897e-01   -7.317930233751767e-01   +9.904141596678716e-01   -8.419568896929976e-01   +6.240566585583186e-01   +6.354113202698514e-01; -4.317912948983808e-01   -7.106802765350351e-01   -2.586386130211347e-01   +9.462785762228965e-01   -3.163244344046316e-01   -5.506344109271494e-01   +7.946019373604153e-01   -8.335738796068514e-01   -2.715180462128130e-01];
L1_L2_iAMPA_netcon = [-9.931854799819253e-01   -5.387286044616773e-01   +1.408359269335407e-01   -9.309562339456147e-01   -2.195229943533692e-01   +4.517343532230320e-01   +5.254315935065067e-01   -6.349234566164372e-01   +3.254434037300849e-01; -5.156727774406461e-01   +2.593358594158268e-01   +4.385045784402495e-01   +6.494616683446848e-01   -1.632098314371806e-03   +4.422663060828952e-01   -2.848617344021276e-01   +1.054078663154157e-02   -3.553733927877340e-01; -7.563761176972149e-01   +8.274362635088577e-01   -8.044147859589295e-01   +1.000000000000000e+00   +3.571463532869718e-01   -3.708659739479560e-01   -3.171758623718205e-01   +8.524008444215724e-01   -3.218927525906911e-01; +4.515678809716805e-01   +8.381241586250775e-01   +2.104680553816044e-01   +9.911241988343193e-01   +3.786954186459840e-02   -9.724955928551220e-01   +4.033918625357715e-01   -9.496949044325498e-01   -8.937749206969632e-01; -9.038861875277170e-01   +5.391623016157712e-01   +3.341678943046474e-01   +7.869433661707291e-01   +4.455189874601035e-01   -6.143161186918761e-01   -4.458382370355919e-01   +5.059139651562271e-01   -6.373785179540005e-01; -3.703722576940261e-03   -3.943352556670870e-01   -7.919526453371163e-01   -3.542521777178698e-01   +7.578449903318671e-01   +8.677321637810802e-01   -9.488154891123063e-01   +6.378768479051210e-01   +8.507545879689254e-01; -9.790272189330386e-01   +6.800650824815795e-01   -4.380717783175718e-01   -2.801698582146494e-01   -2.512193993992049e-01   +1.739192736875173e-01   -2.410932438143975e-01   +3.025677478865373e-01   -4.241956540813182e-01; +7.528718928892955e-01   +6.557718600745043e-01   -8.614924373740118e-02   +9.083757759361056e-01   +5.510805244371567e-01   -9.293628496559473e-01   +4.602071836668591e-01   +7.219158244724857e-01   +5.642242412311547e-02; -4.498830581104408e-01   -1.677289504770849e-01   +1.083775232642282e-02   -2.246665535542334e-01   +4.977897777295426e-01   +1.384403186488791e-02   +8.610977857557185e-02   -3.234647461563330e-01   +7.652944467938084e-01];
L2_L5_iAMPA_netcon = [-8.676954849464730e-01   -7.209060694379776e-01   -7.192036555349310e-02   -1.337883517985723e-01   +8.132787696746341e-02   +7.071640807692545e-01   -1.808013017703103e-01   +5.783137486539816e-01   +6.801504903764207e-01; -9.026977596647152e-01   +3.211460176953937e-01   -3.955181639386476e-01   -9.049186004025939e-01   -8.193697578734130e-02   +9.549400598781800e-01   +5.902538685711645e-01   -1.437524990584019e-01   +8.622802636056136e-02; +4.631383574704762e-01   -5.780967988772769e-01   -7.575467225469873e-01   +2.455251964069612e-01   -2.887196859871701e-01   -5.312113000884382e-01   -8.687105909801324e-01   +8.912119473152736e-01   -5.929791647313769e-01; +8.218237086857370e-01   +9.280946220853952e-01   -2.206952325105724e-01   +1.511807567158930e-01   +1.000000000000000e+00   +6.896313325735036e-01   +4.922774456476759e-01   -9.703453356407171e-02   -4.992520163928779e-01; -3.357347901128722e-01   -2.614920762812410e-01   +7.975380597627423e-01   -8.971727132758343e-01   -1.538501652107935e-01   +1.410327369860350e-02   +1.683744856140589e-01   +5.620391288665725e-01   -2.202383128042284e-01; -9.266098023700349e-01   +5.933962747247501e-01   +5.970946459071144e-01   +9.665070954756082e-01   -9.576307890197796e-01   -1.924379930010640e-01   -5.845436182494910e-01   -9.525785097653469e-02   -2.728922918719635e-01];
L5_L2_iGABA_netcon = [-2.720569240289150e-01   -2.088358505054512e-01   +1.000000000000000e+00   -2.052830091282964e-02   +4.551414606650211e-01   -3.676993677654614e-01; -7.995087223941064e-01   -3.991814673302455e-01   +6.960476135721448e-01   +9.793087907728961e-01   +4.520880784236070e-01   -9.914816513731102e-01; -2.236370916668803e-01   +9.562193121229680e-02   -9.636016500180564e-01   -4.237156582429118e-02   +9.375129289049016e-01   -2.563385384993467e-01; -2.816904657902967e-01   +1.132871418228909e-01   -7.462991836472297e-01   -5.509141807571826e-01   -5.134776284362057e-02   -4.891192047259018e-01; -2.456136496186013e-01   +7.723083006661180e-01   -1.716892283470433e-01   -9.681487193014202e-02   -9.446437698446567e-01   +7.236155860203911e-01; +2.939341846441651e-01   +2.002975184500325e-02   -4.635430016955495e-01   -3.858056343219320e-01   -2.086900539472375e-01   -6.936292041403853e-01; -1.953360435962390e-01   +9.675670675400239e-01   +3.139226347735247e-01   -4.737572091807520e-01   +2.814212440490240e-01   -5.167073123206338e-01; +4.683065975544128e-02   +5.978787552590759e-01   -6.073182788895372e-01   +7.588579419860189e-01   +2.938233181749291e-01   +7.549296006653219e-01; -8.674766696397517e-01   +5.544122637719735e-01   -4.518751454103712e-01   +8.427678308136927e-01   -2.250447682545249e-01   -7.599054914662928e-01];
L3_L2_iAMPA_netcon = [+4.556726807835723e-01   -9.495576420078804e-01   -4.124401924845565e-01   -8.769231073348374e-01   -7.700725582963358e-01   -3.810590730931048e-01; -6.472147949056619e-01   -9.403265408414825e-02   +3.444209162927205e-01   +6.433442956888741e-01   -4.328909933432496e-01   -6.470099314350437e-03; -2.419387060049722e-01   +3.276749422960302e-01   -3.722597571980188e-01   +6.295781998806494e-01   -9.751673866158322e-01   -3.428641534012120e-01; +9.307726313311606e-01   +3.882335155476250e-02   +4.888243836927544e-01   +7.369789572974111e-01   -9.101727356531090e-01   +3.591097967117738e-01; +7.934277958715356e-01   +7.380635689821236e-01   +7.809444420266154e-01   -4.921120718466563e-01   -6.808176212585434e-01   +4.243941529041621e-01; -9.428210615482212e-01   +6.850850664730322e-02   +6.550991490655238e-02   +9.894633873231177e-01   +6.892562537356034e-01   +6.747614928938570e-01; +4.412298020030330e-01   -4.460140366397356e-01   +4.516355861480149e-02   +3.984435629222649e-01   -5.581904754053766e-01   +1.426516972951312e-01; -1.000000000000000e+00   -3.361392296094340e-01   -2.425092117061267e-02   +2.626517779342966e-01   +2.324278569210595e-02   +5.793450086994462e-01; +9.809902896934622e-01   +9.910592634121479e-01   +2.441245352243834e-01   -8.101100542574573e-01   -1.495631720373288e-01   +1.606255437905258e-01];
L2_L3_iGABA_netcon = [-8.575948980163995e-01   -9.444536809523696e-02   -9.352249238541782e-01   -3.194275728352678e-01   -7.196948692842527e-01   -7.158607174245112e-01   +2.060139677679307e-01   -5.491676654441388e-02   -8.189504577452986e-01; -9.817876671997586e-01   +5.978284631022328e-03   -7.071880545418626e-01   -5.803291789481206e-01   -8.943564952884655e-01   +8.818340497314429e-01   +8.753684978253761e-01   -2.750411099202989e-02   -3.945110735822440e-01; -1.054375673725742e-01   +1.068272140902950e-02   +4.386251213746521e-01   +7.319993253567507e-01   +1.953214012813217e-01   -5.065767104193458e-01   +9.809998797327840e-01   +2.482472292944146e-01   -4.870060154223175e-01; -5.684954186236518e-01   +7.282122172092307e-01   +3.497693796509022e-01   -7.865429699786484e-01   -7.882713416750767e-01   -4.966306046075833e-01   -8.013227222435824e-01   +1.947966724895729e-01   +6.550804005258329e-01; +7.815782441552870e-01   +9.574764765991992e-01   +8.156965292187454e-01   +2.838213439810597e-01   +5.582201717522025e-01   -9.789060746844094e-01   -7.449772154176010e-01   +5.772385756428771e-01   +9.510770049772747e-01; +7.799663178208308e-01   -1.000000000000000e+00   -3.148473373306269e-01   +1.336834033514008e-01   -1.347931526497548e-01   -8.468084963567549e-01   +9.921820705184905e-01   -5.683616391742800e-01   -5.236980548434251e-01];
L1_L4_iGABA_netcon = [-5.672404015942393e-01   -5.786072918520463e-01   -1.852689417547423e-01   -5.339709543743330e-01   +1.469297483403930e-01   +3.110534629227418e-01   -9.960826748257975e-01   -1.549877276870132e-01   -5.326997800192257e-01; -2.695219776884720e-01   +4.096116027753063e-01   +4.030164645691471e-01   -9.300166846017249e-01   -2.586066401876169e-01   +4.080342285452853e-01   -6.387597872919193e-01   -8.147409120937629e-01   -8.910884374304133e-01; -9.197916809529914e-01   +5.045398856593084e-01   -1.057788563372659e-01   +9.883001495391586e-01   -4.845204446592530e-02   -2.380687845392682e-02   +9.983536415633462e-02   -4.491855421062714e-01   -1.422951862650495e-02; -1.000000000000000e+00   +1.424942298137672e-01   +1.449860334913968e-01   +3.320505271234857e-01   +5.104020555669790e-01   +8.862499965587551e-01   -7.606979283026869e-01   +3.359925271271961e-01   -4.575038610545281e-01; -2.659549976907063e-01   +3.203208586271333e-01   +8.494437856653704e-01   +9.458037455222668e-01   -2.207978759626679e-01   -9.578416489181177e-02   +7.728625088654215e-01   -6.636832006549341e-01   -8.907784709643868e-01; -2.012102212598474e-02   -3.449409283467066e-01   -6.061581239188656e-01   +2.451417973904062e-01   -8.031781272663712e-01   -5.403629118530829e-02   +8.576171503757969e-01   -4.406400512476284e-02   +4.200484991397220e-01; +8.307624008187378e-01   -8.890711388075859e-01   +2.434173325059185e-01   +1.510983756875386e-01   -8.697205257406460e-01   +2.120889668004345e-01   -6.254602204546458e-02   +8.755895384964764e-01   -3.867196396913377e-01; +8.162301981496813e-02   +7.042167611153312e-01   +6.530393994116040e-02   +2.281774662758096e-01   +8.105215657209728e-01   -9.940315635138557e-01   +8.534375248570816e-01   +9.851038217382058e-01   +4.916456057266770e-01; -7.137371118500891e-01   -3.753418612701714e-01   -7.273521039119487e-01   -5.023943840302612e-01   +8.490212950197566e-01   +5.543104873047748e-01   -3.452087356768201e-01   +6.721835740564430e-01   -9.213170191233623e-01; -3.853188145172508e-01   -9.665917405419657e-03   +9.202177031605139e-01   +8.858938554503371e-02   -7.208228530211356e-01   +3.821005406938071e-01   +8.881975957716206e-01   -9.035473019165216e-01   +5.953459855414502e-01; -1.372145678276632e-01   +5.071813873741707e-01   +5.296447199475592e-01   -7.263988099619280e-01   +1.276080524655396e-01   +2.883525536539633e-01   -9.228230790423753e-01   +6.017351644846781e-01   +9.881767833175765e-01; -9.778892625262242e-01   -9.317843968071124e-01   +4.280535781721944e-01   -1.361728621958602e-01   -7.349805074334895e-01   +3.624850769159047e-01   +7.001960000147104e-01   +8.967236372233575e-01   +6.832284317987554e-01];
L4_L1_iGABA_netcon = [+7.460313899479715e-03   +4.780963741729540e-01   +5.309946940267521e-01   +2.152470804007433e-01   +9.552945499879615e-01   +4.705199207099358e-01   -8.627124296778709e-01   +2.212734791155589e-01   -6.744715127319870e-01   -8.742110163162258e-01   +2.015227919675173e-02   +3.535433823028517e-01; +8.002094335713203e-01   +7.751230432884975e-01   +6.093284519950852e-01   +3.878690764690284e-01   +8.133572622481396e-01   -6.507889635742622e-01   -1.000000000000000e+00   +1.192899898847815e-01   +5.851686374255022e-01   -4.082686179334780e-01   +3.269382690940185e-02   -4.446271309309611e-01; -5.586649226841550e-01   +7.737206836281121e-01   -6.547099647280281e-01   +5.145587513684103e-01   +1.113980422768456e-01   -6.193127122553817e-02   -3.027613695190641e-01   +5.816460086951913e-01   -1.574340437253595e-01   +1.886665156025762e-01   +2.662669911854778e-01   +9.043221664211112e-01; -6.869264507750638e-01   +6.411313034818749e-01   +2.637095157092629e-01   +3.581228868888637e-01   -1.432211318733895e-01   +3.000093788482429e-01   -3.098444515823460e-01   -3.135584278513182e-01   +5.174575470974655e-01   -3.801402011333692e-01   +6.779997389628374e-01   -3.239272612803909e-01; +5.179888596508667e-01   -5.152957077993917e-01   -4.995393612619298e-01   -8.046149557613063e-01   +8.723151748982499e-02   +2.499625003724131e-01   -9.863089208383407e-01   -4.596604376788181e-01   -5.542528440665510e-01   +9.695923680043153e-01   -2.387774840036701e-01   +1.823753974800461e-01; -6.266940125089711e-01   +9.687394627884895e-01   +4.830629755237022e-01   -3.263321438486982e-01   +1.095902129022775e-01   +7.892774306829061e-01   +3.258453246855345e-01   -7.837696482989250e-01   +7.652112448497658e-01   -9.668446135621550e-01   +3.047401544575301e-01   -5.002220785435730e-01; -2.602562032083707e-01   +2.634206607006281e-01   +3.718865097918927e-01   -2.193052042114747e-01   -1.150406175642015e-02   -4.570472365555900e-01   -3.913379000451376e-01   +3.328959171236580e-01   -6.063217951124020e-01   +7.868500031008124e-02   -4.398781652766219e-01   +9.571985911106519e-01; +4.944834023101318e-01   -4.923953544905572e-01   +7.042410652499161e-02   +6.948769335287649e-01   +4.820031951669053e-01   -1.947498161186911e-01   +2.082878005036424e-01   +5.131033325684153e-01   -5.089243652035000e-01   +7.725728732494233e-01   -3.043518266337917e-01   +9.672431561978391e-01; -9.951263408494668e-01   -9.209757359825420e-02   +4.422679900752740e-02   +7.822370166386950e-01   -9.355169253717450e-01   -9.883656578117279e-01   -4.293193055680790e-01   +3.532128507348911e-01   -5.633806349215048e-02   +9.095933405571563e-01   +3.339392313813246e-01   -6.086784973382672e-02];
L1_L3_iAMPA_netcon = [+4.849117922978154e-01   -5.155296002134843e-01   +8.837123319975421e-01   -9.054929336279322e-01   -6.831284769894675e-01   +2.841815402540216e-01   -3.635876944686716e-01   +6.784591623951266e-01   +5.401203208018212e-01; -1.502814694073748e-01   +8.298324263293835e-01   -1.199919371037261e-01   -4.309698961493031e-01   +2.785665325968253e-01   +5.227701428302044e-01   -7.251624417992045e-01   +7.261133743772997e-01   -4.608353560390515e-01; +4.593042386647185e-01   -6.371041836537407e-02   +6.925411445467470e-01   -1.635373826863590e-01   +8.374008212417001e-01   -2.894170937021592e-03   +1.000000000000000e+00   +4.576179920733315e-01   -6.290424134609037e-01; -6.129516555149787e-01   -1.691920100949372e-01   +6.030130647939060e-01   -6.697669169650499e-01   -2.085928967184308e-01   -2.605746949007912e-01   +5.881846362801472e-01   -3.485726262888684e-01   -6.296502603579794e-01; +2.852398785714388e-01   -6.487160883685391e-01   -2.259400612008344e-01   -3.011928575678374e-01   -8.224185385098368e-01   -8.690196378493703e-01   +8.459569217962543e-01   -3.258196727991490e-01   +9.564163500119810e-01; -7.940815613403017e-01   +1.595452765459660e-01   -6.617838764138324e-01   -8.394274395544400e-01   +9.425184061419176e-01   +2.804246152298097e-01   +1.626556005887315e-01   +9.560841567025710e-01   -6.038132785831585e-01];
L3_L1_iGABA_netcon = [-4.339952229841413e-02   -9.346926768165901e-01   +1.467947429863065e-01   +9.624297550856341e-01   +3.456204773535351e-01   -6.655092567752737e-01; +5.196125688763972e-01   +3.005084480617642e-01   -6.539077860263626e-01   -3.287314030979519e-01   +8.817313221402716e-01   -2.832223112731396e-02; -1.169466423428488e-01   +6.695478218576408e-01   +3.790366548942219e-01   +2.609180354116235e-01   +1.000000000000000e+00   -4.805381632346089e-01; -4.984986766249050e-01   +9.225039703599623e-02   +7.418419499449644e-01   -6.409833466213709e-01   -9.619355288124450e-01   +5.904084057313062e-01; -2.796794369352334e-01   +1.752671570469222e-01   -5.814746119542734e-01   -7.267686257363001e-01   +8.864895780434888e-01   +3.105993167682803e-01; +6.951729716812863e-01   -8.388783481262926e-01   +8.805401433325275e-01   +4.250962507275237e-02   -2.590130894791451e-01   -9.575482930852929e-01; +4.062214845170350e-01   +9.824110670401958e-01   +4.645297689567457e-01   -1.244114095650685e-01   -8.999418779379830e-01   +1.013559096920636e-01; +1.203622556663807e-01   -3.537516902098184e-01   +6.700984065719966e-01   +5.476292972239386e-01   +7.130578990155690e-01   +4.485731307406383e-01; -5.366296638209812e-01   -6.970207405805355e-01   +4.104654131335337e-01   -7.809656229103048e-01   -2.657299572012491e-01   +6.305605892904862e-01];
L5_Input1_iAMPA_netcon = [+2.707738826125849e-01   -9.013896064143636e-01   +1.458677192997773e-01   -4.392835505603776e-01   -1.466558829191386e-01   +1.000000000000000e+00];
L6_Input2_iAMPA_netcon = [+1.518216535492356e-01   -5.044958053860036e-01   +7.155013972370711e-01   +7.135300358711684e-03   -1.000000000000000e+00   -7.371343981700332e-01];
L5_L6_iAMPA_netcon = [-4.164548741746018e-01   -8.449523110479540e-01   +4.087016673111123e-01   +8.741567271990718e-01   -3.992245278569555e-01   -5.601600715590551e-01; +9.369727333310769e-01   +5.994141673649562e-01   +4.047838134327769e-01   +9.557855757610813e-01   +4.194611114969989e-01   +5.596551895728659e-01; +7.357146495217102e-01   +6.928195983711676e-01   +1.000000000000000e+00   +7.732758144510036e-01   -4.169811198187954e-01   +7.206571390695098e-01; +9.722842491251722e-01   -4.097012830034340e-02   +1.057407167327475e-01   +1.935635369541042e-01   +5.160101421196256e-01   -2.276061225662011e-01; +4.080775565920923e-01   -8.888522287701187e-01   +3.833465751630863e-01   +7.947292129706072e-01   -4.246011615941337e-01   +7.446197383854500e-01; +9.985625349556915e-01   -6.295361083068423e-01   -9.212431802284898e-01   -6.861588485087247e-01   +6.849892258683307e-01   +7.125223856419766e-01];
L4_L5_iAMPA_netcon = [-9.336053402389466e-01   -8.861796307423375e-01   +8.022352223992547e-01   +3.649410320679575e-01   +5.975456373784477e-01   +7.511585504849771e-01   -2.263366248144687e-01   +9.787981506903621e-01   +5.969026363637366e-01   -8.896016088337766e-01   +7.782688511363878e-02   +4.925756571230969e-01; +6.462946050501891e-01   +9.952528636340195e-01   -9.212552759919188e-01   +2.833072198579778e-01   -4.907031384246421e-01   -2.013394212745045e-01   +9.049626253366677e-01   -2.060271384113588e-01   +9.087639535263590e-01   +9.373162711068114e-01   +7.618121745093764e-02   +8.458973093292832e-01; +6.072650745035167e-01   -5.251759173989820e-01   +6.356951031862876e-01   +6.157116468800886e-01   -2.903426440162964e-01   -1.677859803341624e-01   +5.796103078416985e-01   -3.533184345875150e-02   +5.803082527642598e-01   +8.184396761915517e-01   -6.321364413800361e-01   +9.113722157826263e-01; -5.536338374656623e-01   -8.967847927892544e-01   +8.112712251384302e-01   -7.131728380260153e-01   -2.615776315278199e-01   +7.826033598557456e-01   -1.482419712973211e-01   +9.353900923053022e-01   -4.693002456502466e-01   -5.891412485655916e-01   +4.541707935047715e-01   -4.970042916173522e-01; -9.203084625163516e-01   +2.415262727422578e-01   +1.774031345397229e-01   +1.155616047724579e-01   +8.971663289321176e-01   +2.521038243384648e-01   -6.691026308028190e-01   -5.487181662893220e-01   +9.540811425624727e-01   -2.430225560463521e-01   +2.615948328718557e-01   +7.690524814449652e-01; -7.596291463345549e-01   -5.588000484673106e-01   -6.663310295306773e-03   +5.665294181051237e-01   +5.760385183445462e-01   +4.632866349705487e-01   -5.731521705193173e-01   -3.359810389880912e-01   +1.000000000000000e+00   -6.398881233798450e-01   -5.923585471004020e-01   -9.225008795706530e-03];
L6_L4_iAMPA_netcon = [-8.453652123879318e-01   +4.350509143681204e-01   +2.960043207247614e-01   -1.326042729648299e-01   -1.013810576221505e-01   -9.945384253594636e-01; +1.487147059033313e-01   +9.742645162342005e-02   +5.627201826523260e-01   -4.597943949613876e-01   -4.550011610764940e-01   -3.060171963997529e-01; -1.686612329183819e-01   -4.175173951879836e-01   +9.906342625432600e-01   +5.686068696722676e-01   +9.244215288633137e-01   +8.822384505820707e-01; +8.253779519286659e-01   +5.241594686302246e-01   +6.697485276856043e-01   -2.335070794197262e-01   +6.291023365658754e-02   +6.711099981745087e-01; +6.339988885221517e-01   +8.370381764417199e-01   -8.462056363633668e-01   +8.394323042659894e-01   +9.453278817484738e-01   -1.516674951108177e-01; +7.686877805230503e-01   -4.570353946096323e-01   +4.499422268008087e-01   -5.971212289935116e-01   -8.146808455084069e-01   +1.252428360322231e-01; +4.336001708487924e-01   +1.366740154814987e-01   +1.188815007158838e-02   +1.309374567674705e-01   -9.371104668224893e-01   -4.422251142355100e-01; +1.127172930129633e-01   +6.788301001913316e-01   -1.254439867172245e-01   +1.266852413627064e-01   +2.590864779312822e-02   -2.795927723352286e-02; +4.484997083444053e-01   +7.721993039114764e-01   -7.603288554082461e-01   +7.722115947201426e-01   +4.267591307014126e-01   +1.445265928831733e-01; +2.301367485547198e-01   -6.200633620848155e-02   +1.000000000000000e+00   +7.753386672525724e-02   +9.814522699228135e-01   +9.972841999077932e-01; +7.495237191442046e-01   -9.540682721421344e-01   -3.822170940283367e-02   -6.454961148761696e-01   -4.574141813690668e-01   +9.059648696794005e-01; +5.301588116549040e-01   +3.615452880283422e-01   +2.239613883824612e-01   +5.688997318866067e-02   -8.724936227317336e-01   -6.107554032118457e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
