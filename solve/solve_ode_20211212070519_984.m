function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.630346703074550e-01   -7.422471249039829e-03   -3.021475263410339e-02   +8.751475045887042e-02   -3.124159627447183e-02   -8.248253218679481e-02   +5.306669653454379e-02   -4.892603353871409e-02   +9.578942949303032e-02; +4.206770039592253e-02   +1.586356426749901e-01   -3.850426442123603e-02   -6.692478753084875e-02   -9.344409947153287e-02   -2.890846537268269e-02   +8.279854824231885e-02   +3.803852942459618e-02   +1.996378456897205e-02; -8.291910305464791e-02   +3.388965172285787e-02   -9.680954437700251e-02   +4.254079798377076e-02   -1.228593132607562e-01   -4.932851038665410e-02   +1.278211896990568e-01   +2.871785653847587e-02   +7.677057171473290e-03; -1.003634529792685e-01   +3.407712232957844e-02   +5.194542076820050e-03   +1.474387761938480e-01   -1.738684515490860e-01   +8.663368761140569e-02   +7.461248955140932e-03   +5.761776214941380e-04   +1.464147364356465e-01; -8.381485508617807e-02   +6.249712597608914e-02   +7.490668239691244e-02   -7.824767347480070e-02   +1.298452150379952e-01   +1.079391339888135e-01   +1.591533471679936e-01   -5.922016941354785e-02   -4.922490335023581e-02; -1.112278619440276e-02   +1.487461104400033e-01   -1.690821779711625e-01   +1.584798029569686e-01   +6.731288377742223e-02   -2.172467213288165e-02   +6.184958108315508e-02   -4.084665972111676e-03   +9.472310679721099e-02; +1.940464056286784e-02   +7.726536250006535e-02   +5.255100287418629e-03   +7.482996233327117e-03   -8.982876147202754e-02   +1.265675360738322e-01   +3.885476635536139e-02   -1.628266107444096e-01   -2.984290664326662e-03; -1.230001851372617e-01   -4.238635022290506e-02   +5.906100574798563e-02   +6.941974912643822e-03   -1.273869707425550e-01   -3.355570453409377e-02   +3.175434783173255e-02   -6.379993947157772e-02   +2.008883330707620e-01; -4.581260990197240e-02   -7.910310263197934e-02   -7.247409469472936e-02   -1.119082238382327e-01   -8.218493491315124e-02   -3.607135170801005e-02   -5.720376727352714e-03   +1.175677241914535e-01   +5.733192442336925e-02];
L1_L2_iAMPA_netcon = [-3.326839597197166e-02   +4.947583088646430e-02   +1.153775878486944e-01   +1.138961340687640e-01   +1.227777636249918e-01   -3.123072780216882e-02   +8.557780751124967e-03   +8.287524690037185e-02   +3.987524288577390e-02; +1.066416139742115e-01   +4.867409095905843e-02   +1.626048564322876e-02   +6.625394933192569e-02   -4.528093219116476e-03   -8.448212610443584e-02   -1.816796362032213e-01   -5.936927550195588e-02   +4.207044867167024e-02; +8.020500795651543e-02   +2.572921026304963e-02   -6.879066480011849e-02   +6.781118842299871e-02   -4.006616922954739e-02   +1.033149053054940e-01   -2.072007817265867e-02   -4.247560053331041e-02   +7.478505174432284e-02; -1.297798970102134e-01   -1.089212461564210e-01   -4.698403695284020e-02   +6.546366540221213e-03   +5.295911016293371e-02   -4.675803321613595e-02   +7.810706482398334e-03   -1.311055868583694e-01   -3.835049814767568e-03; -4.693617495656349e-02   -1.118999412616319e-01   -1.025050401664050e-01   +1.488412223023519e-01   -6.394182352480852e-02   +5.977453164707973e-02   +1.308574704672265e-02   +4.648024291513651e-02   -1.654316894776335e-02; +3.205126237186270e-02   +1.372061532662230e-01   -1.053684661688120e-01   +5.376708704567284e-02   -9.208640489123099e-02   -1.063480928497992e-01   -1.510826015400879e-02   -7.160494351548027e-02   +1.354749424191549e-01; +1.765974416572677e-02   +2.700844598177120e-02   -1.812622765231152e-01   +4.947523524841742e-02   +1.182392203399033e-01   -1.035168762155805e-01   -7.161419856254765e-02   +1.269742256841588e-01   -1.813997178247441e-02; +7.835824803888192e-02   +2.931522744374634e-03   +4.647481864940668e-02   +6.501603359115749e-03   +6.616651931164461e-02   +8.765637712566900e-02   +1.642448490379314e-02   +6.760368798683308e-02   -3.752532629876664e-02; -4.113082878543395e-03   -5.891750062874362e-02   -9.526130711070127e-02   -1.146162976677209e-01   -7.997637966034619e-02   -5.232511568460765e-02   -7.405669683385525e-02   -4.907277109948112e-02   -7.462635699924491e-02];
L2_L5_iAMPA_netcon = [+6.250750140929437e-02   -1.190652669004610e-01   +5.129476851064848e-03   -7.062768586719700e-02   -1.072331788669775e-01   -7.923277599846180e-02   -5.508093579464605e-02   -2.148036262941581e-02   -3.901978803608593e-02; +4.272533738359673e-02   +1.450199724336819e-01   -2.813781847157319e-02   -1.375290999800789e-01   +1.568467137999266e-01   -3.406844837358684e-02   -1.353301880221283e-01   +7.933786437267717e-02   -7.624150623150944e-02; +1.014190024165781e-01   +1.488098689137562e-01   -2.569315154675919e-02   +8.081708360107472e-04   -6.457493628425812e-02   -3.198852784866324e-02   -8.786365861320319e-02   -3.052620153658943e-02   -5.391103926617868e-02; +2.809291276123690e-02   +4.134718235667320e-02   +6.739676481598310e-02   -9.003778495248785e-02   -5.568868770043089e-02   -5.724403632365133e-02   -1.320249727059485e-01   -9.265039373638546e-02   +1.285017931548408e-01; +5.085649064686040e-02   -3.815415158889926e-02   -1.573008165453101e-01   +7.936243970045480e-02   +1.230949417325021e-01   -8.572673574035759e-02   +1.120734197979350e-01   -8.856073225865464e-02   -7.206656144913750e-03; -1.433567654428999e-01   +1.405263162008262e-01   -2.987675258030414e-02   -1.391356638330414e-01   -1.273439556394381e-02   -1.462361225211416e-02   +8.714169957072040e-03   -3.452519450753452e-02   +1.164088778306677e-01];
L5_L2_iGABA_netcon = [+8.127809565979927e-02   +7.659590662086717e-03   +3.875011792828487e-02   -4.353957825011689e-02   +9.569955232662065e-02   +3.427560208306413e-02; +1.857912800509639e-02   -1.213006073110296e-01   -3.404328911656210e-02   +1.173168623865231e-02   +6.542100633821260e-02   -1.088863511159010e-02; +5.588604408976736e-02   +2.846187361490756e-02   +1.454148274853656e-02   +1.554088308971524e-01   -1.420704542536163e-01   -5.529282535156671e-02; +6.676511217573879e-02   -9.714013932397327e-02   +4.417104737337505e-02   +1.222037813966038e-01   +3.526473253779771e-02   -5.104991999992874e-02; -4.853924400687752e-03   -4.183648127647607e-02   +3.399288876580440e-02   +3.922258731078827e-02   -1.164970420409048e-02   +2.654725703726169e-03; -8.004007724563678e-02   +1.480234907925194e-01   -3.982519637835920e-03   -6.083162271264612e-02   -7.505713468160830e-02   -1.326535260105836e-01; -8.609553546353456e-02   -3.264385699841651e-02   -6.994267330507333e-03   +1.114731162047471e-01   +2.908446853907398e-03   +1.071941783425492e-01; +1.640602884389221e-01   -1.575956665031149e-01   -7.019635672172939e-02   +1.483702245674204e-01   +2.130794952057104e-02   -5.295557203961410e-02; -4.983441254988868e-04   -2.634101794469938e-02   +1.009339161815281e-01   +4.939336686737222e-02   +3.601914354270386e-02   -3.861999733204036e-02];
L3_L2_iAMPA_netcon = [-8.192781902143974e-02   +8.176574031009931e-02   +1.598265582000177e-01   -1.430735730076245e-01   -8.471765709405478e-02   +2.251579773659337e-02; +7.332417926304702e-02   +8.219931328945981e-04   +1.105621404189748e-02   -6.125163731782906e-02   +8.744442788533553e-03   +1.754212593876824e-01; +1.048827137909036e-01   +3.388416797913093e-02   -3.081885447666308e-02   -5.889982635716502e-02   +1.674155023098352e-01   -3.044644904801859e-02; +4.105016940288526e-02   +4.576465378978722e-02   -1.088369427226695e-01   -5.803546724556922e-02   +2.705530246248007e-03   -1.451818240915006e-02; -7.075241327748370e-02   -1.105437001389686e-01   +8.434905613351923e-02   +6.802611786797211e-03   -1.318448217416399e-01   +1.348512611793790e-01; -2.863718118251916e-02   -1.524886658812566e-02   -5.787492831551649e-02   -1.752512598447456e-01   +5.911079169876730e-02   +3.585596145481659e-02; -1.597392607912007e-01   +3.509737805436449e-02   +7.979438902270944e-02   +7.978273731026629e-02   +1.259037666290186e-01   -1.136046793652354e-01; +2.107680215171211e-02   +1.087025311615382e-01   -1.193612564574494e-01   -1.265876276877367e-01   +9.959500614644501e-02   -5.273623924550675e-02; -6.607517573616088e-02   +1.245729983853763e-01   -7.699445607901062e-03   +2.184662831569624e-02   -3.649788184486552e-02   +6.533178667187522e-02];
L2_L3_iGABA_netcon = [-6.399047716598366e-02   +2.336537516653688e-02   +1.268157455406772e-01   +7.462609265362664e-02   +8.767671811032145e-02   +1.868193551345778e-01   -1.340262360256233e-02   -5.695437193131729e-02   -1.047029186657215e-02; -1.085411361282438e-01   -1.378025024741172e-02   -2.967706151669351e-02   +6.962507286499707e-02   +4.944078240422779e-02   -2.968902946208126e-02   +5.078143915189359e-03   -3.624624973576770e-03   +9.228087325297633e-02; +8.539911797593004e-02   +6.640242176182195e-04   +2.074818526640392e-02   +4.760514761346932e-02   -3.968799671298398e-02   +2.002567315798284e-01   -4.676943902367572e-02   +8.525060746374100e-02   -1.074595984504128e-01; +1.274726227611341e-01   +4.056659456176506e-02   +1.065650689827383e-02   +4.674675456192531e-03   +3.284770832928822e-02   +1.357234466465865e-01   +1.097083877485850e-01   +4.183356426065286e-02   -1.167073530996109e-01; -4.472802447909136e-02   +6.752621076732238e-02   -4.131201899588584e-02   -8.334730453929856e-02   +1.134141329687575e-02   +5.872804885107804e-03   -5.568998458492101e-02   +3.060833087260509e-02   -6.177336551914916e-02; +1.241812033438549e-02   -2.924342462710562e-02   +3.952303125831824e-02   -1.277349887171346e-01   +8.037463168791247e-02   +7.806085498624281e-02   -5.466082586316683e-03   +8.148668330136287e-02   -6.102674930413125e-02];
L1_L4_iGABA_netcon = [-3.858181974375992e-02   -1.005707838334151e-01   +5.178498345280774e-02   +1.214774477824779e-02   +1.484279225394611e-01   -8.920844147135534e-02   -3.442311172687609e-02   -8.892011723943997e-02   -2.574857210570764e-02; +5.183515715800588e-02   +8.996122877673132e-02   -5.566536298189793e-03   -1.160429099336339e-01   -3.827912746297470e-02   +8.563129900905231e-02   +3.212621748647013e-02   -5.061779623893958e-02   +4.377577458795993e-02; -5.023880851441295e-02   -1.151122239314098e-01   +1.688279513070361e-03   +1.049063960098617e-01   -4.347959111163739e-02   -5.343157429330846e-02   +1.767924011889583e-02   +1.190771546780223e-01   -1.764442073438735e-01; -1.277354057970288e-02   -4.681710471421326e-02   -5.480440331475656e-03   +5.739251796367063e-02   -4.411136367565914e-02   -1.357508992933925e-02   -5.944346698069314e-02   +2.927516869547413e-02   +1.307727537114576e-01; -1.000577576082404e-01   -9.086298493600686e-02   -3.040374538012907e-02   +2.171688430686949e-02   -4.565594520811068e-02   -3.578360683521103e-02   -2.302279735264096e-02   +1.054286095286912e-01   -3.110067935274475e-03; -6.258319203893589e-02   +3.236445447477346e-02   +7.862241734645167e-02   -1.232950184144618e-01   +2.004157183383406e-03   -8.003694793432677e-02   -1.375256241130327e-01   +1.321220749610969e-01   -9.698877375705128e-02; +3.877173646530816e-03   +3.724962898931801e-02   -7.175865140751302e-02   -2.939511460937072e-02   +5.527672592954202e-02   +8.523454235523041e-02   -1.532334071702782e-01   +1.730622144545440e-01   +5.054024824196161e-02; +2.902563383084497e-02   +2.898000355126777e-02   +8.680996359526180e-02   +3.526469741964863e-02   -3.136321145631066e-02   +1.077038167757436e-02   +3.335795849981531e-02   -4.603572592808188e-02   +1.372637177819217e-01; -2.189672686268600e-02   -1.153661150575282e-01   -3.815816373653191e-03   -8.132150959217985e-02   +5.055786532815743e-02   +7.602295888888587e-02   -5.729309686950082e-02   -1.626773018177272e-01   +1.269556711827200e-01; -6.023113575465310e-02   +3.544246765377314e-02   +2.039147343773525e-02   +9.804137862572866e-02   -2.249879243117842e-02   +2.485645876644993e-02   -1.200409898187541e-01   +8.343186238486473e-02   +3.191517961884955e-03; +6.601900139564454e-02   +6.264081828995755e-03   +8.418924364896276e-02   +3.784255810769455e-02   -7.405422340554665e-02   +3.941657110821480e-02   -6.888534691485075e-02   +1.121299156444192e-01   +9.562757909926542e-02; -3.557446924164845e-02   -2.166755101893207e-02   +3.945107160741770e-02   -3.307790528340051e-02   +3.153898029484391e-02   +1.451088576613818e-01   +1.336350887996113e-01   -1.579174374687428e-01   -8.879124844614876e-02];
L4_L1_iAMPA_netcon = [-1.191304843045733e-01   +5.553797093907866e-02   -1.082426767114612e-01   -1.686476477351227e-02   -1.933959746343109e-02   +1.303653058944229e-01   -4.650904945845213e-02   -4.278834877707394e-02   +1.315108563711005e-01   -1.523279057888064e-01   -1.280172187013514e-01   -5.422554622329562e-02; -2.977635960251310e-02   -4.407377803676632e-02   -9.545905917751960e-02   +5.787662138620905e-02   -4.051995884543574e-02   +3.437076903702017e-02   -1.786187931791323e-02   +3.506479580480873e-02   +1.466853023481456e-01   +1.513374512724469e-01   -2.751237994239854e-02   +6.425090037926063e-04; -1.179592609119638e-01   -3.104101549286261e-02   +1.430704482008255e-01   +7.675995085164970e-02   +9.021418160516141e-02   +3.705951315054759e-02   +1.090392895288578e-01   +2.980611034721603e-02   +7.239050315214029e-03   +8.027660724524500e-02   +1.825021468268059e-03   -5.652446289155971e-02; -1.432789777722251e-01   +1.924538498279487e-02   -1.710415049280798e-01   -1.275123080418324e-01   -6.461668359878808e-02   +4.857555174278031e-03   +4.914182399395908e-02   -1.086382446613303e-02   +5.387690349660411e-02   +1.445107114153663e-02   -7.648370922986028e-04   -7.291020106758887e-02; -1.293463384683215e-02   +1.252050619518644e-01   -9.785790056201285e-02   +4.673310324323064e-02   +2.790177378390175e-02   +7.525285237881020e-02   +1.633145902002984e-02   +8.199966571142592e-02   +1.384738865782562e-01   -6.562454418050029e-02   +5.687451976639031e-02   +3.055063841040596e-02; +6.182198981186942e-02   -5.349745924563359e-02   -7.469055484923999e-02   +6.951526971932659e-02   +3.396120504597072e-02   +2.566001577839657e-02   +1.466658083092517e-01   -1.390501620592862e-02   +1.054741180535756e-01   -3.458329040999344e-02   +4.795133963208946e-02   +7.266014597800763e-02; +8.722957306430856e-03   -6.436978186580375e-02   -2.425268771883705e-02   -1.429389019235458e-01   +8.072772418578676e-03   -4.434281938323575e-02   -1.661022543983138e-02   +1.186987353630415e-01   -1.029650202707815e-01   -8.817269189550225e-02   -2.929723910140883e-02   -1.401402531214103e-01; -2.395664430756227e-02   +5.407677256831854e-02   -1.310911429615404e-01   -1.174426696452087e-01   -1.923672999676615e-02   +1.238760894282122e-01   -1.388595424533401e-01   -1.662914529654649e-02   -2.144271113390442e-01   +2.914627227693764e-02   +1.205709738973123e-01   -9.819439863894253e-02; +4.037408786379149e-02   -6.051083644737980e-02   -1.855781372170448e-01   +1.321775717764503e-01   +4.463835716273195e-02   +9.716190299807687e-03   +8.129954908784603e-02   -3.612249927850383e-02   -2.665870026260081e-02   -1.420830764540263e-01   +2.606812112294508e-02   -7.524464184442198e-02];
L1_L3_iAMPA_netcon = [-8.371279261331914e-02   +3.081176648231448e-02   -1.329999148468240e-01   +1.382488940078035e-02   -1.000968758662148e-01   +6.464300825900859e-02   +1.821903821516088e-02   -4.251645535134342e-02   -3.389194390063467e-02; -1.262693205377954e-01   +1.032302010131034e-01   +1.065305768465229e-01   -1.815964990850021e-02   -2.034607488090214e-02   -7.417712801700953e-02   -1.011970091022940e-01   +4.974182472183211e-02   +6.245290378831433e-02; +1.114388843752462e-01   -4.028301497062624e-02   +3.561824606246367e-02   -7.097818680830284e-02   -1.303589148448779e-01   +1.250228276848515e-01   +2.863461323463568e-02   +1.106468086466320e-01   -4.602000123992270e-02; -8.667541146983078e-02   +1.264771761946966e-01   +9.264104546883567e-02   -8.061588098282169e-02   +1.681995220514442e-02   -9.923648312425065e-02   +1.176340939258067e-01   +7.938772158352644e-03   -7.492390625657931e-02; -6.595077794490915e-02   -5.363203178022905e-02   +6.587290534906008e-02   -1.026683554044011e-02   +4.662919658522600e-02   -9.139304461890242e-02   -1.118005906622804e-01   -8.322673409751206e-02   +1.215466589652704e-02; -1.053694163065334e-02   -8.137419443427174e-02   -3.656011070439050e-02   -1.253676159075820e-01   +1.230854801034978e-01   +1.575355979732749e-02   -1.848971503675960e-03   +1.794616641217604e-01   +1.184163851621181e-01];
L3_L1_iGABA_netcon = [-7.659784816899655e-02   +6.257598423261553e-02   -9.131130336487396e-03   -4.082244308131925e-02   +1.617913706635445e-02   +7.991168043808602e-02; -7.456837878087695e-02   -3.428057587643790e-02   +7.305932863123252e-02   +2.256094960391675e-02   -2.129371144579482e-03   +3.863896961309563e-02; +6.949154592660035e-02   +1.071965497985159e-01   +8.500843102368393e-03   +7.864308534365537e-02   -5.542858914442794e-02   -1.190949497215213e-02; +6.454833454723369e-02   +1.149563029326386e-01   +3.335790313704365e-02   -7.080936227413828e-02   +1.080806383995681e-01   +6.243619085896857e-02; +1.518336826958051e-01   -7.996537893537041e-02   +2.562399165270127e-03   +4.064316910719565e-02   -9.369421488999694e-03   +7.528944463347323e-02; -3.538167693362714e-02   -7.828400801729885e-02   -1.140701290927545e-01   +6.974918091315667e-02   -1.528914100208388e-01   +1.233969159257618e-01; -1.475558708352622e-02   -1.477459336800647e-02   -4.657145137627266e-02   +1.229872612176430e-01   +3.933688983857075e-02   +1.013768432479464e-01; +1.560873191306711e-03   +1.346852414062047e-01   +1.471523446354067e-01   +4.809816500251497e-02   +3.405557981152104e-03   +1.490293062928230e-01; -1.321111324194831e-02   +5.283737455880930e-02   +6.461135403432086e-02   -8.042258763883445e-02   +4.263285528081207e-02   +1.361147639543553e-02];
L5_Input1_iAMPA_netcon = [-1.247492977518525e-01   +8.801803251271140e-02   -6.849667166397060e-02   +2.284761847141557e-02   -1.486738206860773e-01   -1.572538534677727e-01];
L6_Input2_iAMPA_netcon = [-1.049326528988294e-01   +4.815432781471620e-02   -3.505288996899784e-02   -5.439735127617452e-03   +5.861348839828501e-02   -1.104091362698573e-01];
L5_L6_iAMPA_netcon = [-5.558509237011774e-02   +9.327811224613537e-02   +1.254364257936570e-01   -3.454282610489119e-02   +1.080915300518750e-01   -5.713073796394827e-02; -1.441123415878010e-01   +6.076080781893885e-02   -3.713366843947082e-02   +8.622915237265930e-02   -4.513410245260261e-02   +1.089757704637709e-02; -1.007656946849956e-01   +7.367764365700696e-03   +2.843676232223571e-02   +1.033211797989637e-01   -6.303528691406032e-02   -1.260862015647075e-01; +1.335780002695713e-01   -3.820574983034739e-02   -3.472117788063566e-02   +8.205056218670997e-02   +9.623903540783342e-02   -8.911640273344342e-03; +4.005759715668704e-02   +7.253467862114107e-02   +7.018478689584629e-02   +6.395549702459132e-02   -4.664230888864901e-02   -2.985465371656839e-02; +6.362165134231185e-02   +1.001651517433242e-01   -8.232550551542064e-02   +1.186049997654066e-01   -3.323783250334809e-02   +4.279040876919753e-02];
L4_L5_iGABA_netcon = [+1.055912323357112e-01   -2.803364889696349e-02   +5.496101903803622e-03   +6.266493525229770e-02   -3.098849422034587e-02   +2.305094641275512e-02   +6.824276380780754e-02   +8.571682298622640e-02   -1.382320186972267e-01   +4.215073377013324e-02   +1.326717506927475e-02   -8.527863464762888e-03; -9.165299083174615e-03   -6.407579542139225e-02   +1.077157497096760e-01   -5.521563996404001e-02   +5.196639981766690e-02   -2.290742476534057e-02   -8.334731520629454e-02   -1.199820866745505e-01   +6.213806524095652e-02   -7.885610583123130e-02   +1.708988477756852e-02   +2.439893894189904e-02; -9.973666221602992e-02   +9.353976075378621e-02   -7.105929270280741e-02   +1.232783210239499e-01   +1.612458986887758e-01   +1.592422654911163e-01   -1.000785617346904e-01   -1.120000964408952e-01   -5.063874208011199e-02   -4.544317152829006e-04   -2.246712269467379e-02   +5.636962789413191e-02; +5.786369525957311e-02   -1.220721671622806e-01   +7.265141479144245e-02   +9.344768473436359e-02   -9.453231737064148e-02   +2.000217013105968e-01   +6.676616632598358e-02   -8.456092931193562e-02   +1.099855372370360e-01   +6.199775098472038e-02   -8.905700919997712e-02   +3.287547208139076e-02; -9.435360532816121e-03   +1.052321218790543e-01   -3.844335098769763e-03   -1.735856185952001e-01   +4.457203140092345e-02   -2.756517831384820e-02   -1.297470363617935e-01   -1.525548783392851e-02   -4.715497061328749e-02   -9.592527939215152e-02   -6.078000101872406e-02   +1.074399902549406e-01; +3.470978765530509e-02   -2.134765075236635e-02   -2.083806449243998e-02   -1.273502803753139e-01   -1.866792990130112e-01   -1.332032145946369e-02   -4.596005348806314e-02   -8.131420604691589e-02   -6.310530728387159e-02   -5.313916446099586e-02   +5.157256298858615e-02   -1.305028322610450e-01];
L6_L4_iAMPA_netcon = [+8.526017653827977e-02   -8.565351144015486e-03   -4.108920897901792e-02   +4.765368366310407e-02   -1.137039293360843e-02   +1.663600459169470e-01; +2.268259871232352e-02   -7.174689791919091e-03   +3.063896143548646e-02   +5.351953601897290e-02   -1.155599562999862e-01   +1.050348594156208e-01; +1.882001896732932e-01   +1.337416969466577e-01   -5.835317404244483e-02   +4.069129604685366e-02   -4.215147886337037e-03   -1.388748620899702e-01; -1.545387216756038e-01   +1.353090301816637e-01   +1.004208014664790e-01   +3.787776419979042e-02   -4.609764331349468e-02   -6.040763239804810e-02; +7.476887111643241e-02   -3.062271922727869e-02   -9.486387974083527e-02   -1.884098920725420e-02   +4.109888011395921e-02   -1.314334382353506e-01; +8.472248177100530e-02   -1.191097004390141e-01   +6.160386946171596e-02   +1.014373128911308e-01   +8.427064344963084e-02   -7.755254122987336e-03; +2.268638018083055e-02   +2.566246449168431e-02   -2.166318167725237e-02   -1.005286016147707e-01   +4.737188588135210e-02   +2.043622942161863e-02; +4.591809449541941e-02   -4.676890080511335e-02   +1.738158617577170e-02   +6.644173179212387e-02   +4.245301047930906e-02   +2.462810862513205e-02; -8.756985745378038e-02   +1.080186219918753e-01   -4.155045792242890e-02   -2.254865117781522e-02   -1.652740468934464e-02   -5.992100506285992e-02; -1.821167090430221e-03   +6.722458344233009e-02   +5.868930378863321e-02   +8.894635074418902e-02   +9.973375032287257e-02   -5.752032577793691e-02; -5.838743184102273e-02   -5.777864574770245e-02   +7.587970810425290e-02   +5.788588247048452e-02   +1.101160257905107e-01   +4.109852251527255e-02; -1.054814244561070e-01   -8.866127840661682e-02   +8.693547770217337e-02   +3.831409195702926e-02   -7.184663258884275e-02   -9.153247101506759e-03];
L5_L4_iAMPA_netcon = [-2.815761361029289e-02   -7.050053836291355e-02   +9.039574985332432e-03   +1.572411819683310e-02   +4.618703103157010e-02   +5.824742760393573e-02; -2.927852637714817e-02   +2.295165708432265e-03   -3.949855422417244e-02   -5.234894832893987e-02   -1.786127598624709e-02   -3.534821321014069e-02; -1.778831600426515e-02   -5.977564602720222e-02   +9.323252670525566e-02   -2.099397992511517e-02   +3.538796196879156e-02   +3.986822067985973e-02; -3.617181405225431e-02   +8.389987377822240e-02   +1.446885927005010e-02   +7.164881460462008e-02   -2.066416409248635e-02   +2.284734344388141e-02; -1.596964438827223e-01   +2.613970524985188e-02   +4.229137310522241e-02   -6.731443568113466e-04   +1.048285838061702e-01   -5.745166127115704e-02; -8.059686588938128e-02   -9.139986110181936e-02   +9.861342095913510e-02   +8.093217151408957e-02   +8.388887234894007e-02   -4.107778582720906e-02; -1.321606503587484e-02   +1.351452825281318e-02   -8.847829730767770e-02   +5.459370117884118e-02   +8.558575616980049e-02   -1.186145622523360e-01; +1.671830342386774e-03   -3.941639987973532e-02   +1.187252379517875e-01   +4.694972836463567e-02   +9.512386504844615e-04   -6.098196955334111e-02; +3.257113397682155e-02   +8.113607785334262e-02   +1.946933351545287e-03   +9.152709299632463e-03   -1.152567936118705e-01   -8.969484270360829e-02; +3.628011671738322e-02   +5.406752911538625e-02   -6.068079494153088e-02   -7.260790614401913e-02   -5.708252234997484e-02   -8.635916606953641e-03; +4.542097296773974e-02   +2.738631836171266e-02   +8.345398093914021e-03   +5.657991835870294e-02   -1.011655900631092e-01   -6.263865813663033e-02; +1.678655394692810e-02   -7.834413915934450e-02   +1.557385141349216e-04   -2.159670035265224e-02   +4.008839893068508e-02   +1.132902982805861e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
