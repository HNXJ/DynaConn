function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.741392910124878e-01   +1.275134761819409e-01   +1.577552620846312e-01   -6.017185461212093e-03   +2.459249344314040e-01   -3.670041579419391e-01   +4.892166847438049e-01   +1.135940747809132e-01   -1.427071096005328e-01; -4.269439602771552e-01   +1.100447206358218e-01   -1.357416966804239e-01   +1.390594268798410e-01   -1.032416957836695e-01   +2.517315937389700e-01   +3.194626509792345e-01   +7.299807792016288e-01   -4.826190858010496e-01; +5.234458755774570e-01   +8.716372769902463e-01   +4.288669612470739e-01   +5.642783302897661e-02   +8.449869431160477e-02   +2.929798138171493e-01   +1.918479698917129e-01   -5.798115637496708e-01   -2.382274621747926e-01; -7.248580517849008e-02   +9.416572752659763e-02   +6.979587802579171e-02   +1.181034906433956e-01   -1.737904220674821e-01   +1.333679226443528e-01   +3.835383563851009e-01   +4.211443189682258e-01   -2.504708664166876e-01; -3.007725488732782e-01   +3.902479635795764e-01   +5.942164584596974e-01   +9.807984860705286e-02   +3.263921171964237e-01   +2.276211833566471e-01   -1.638816648210999e-01   +7.626558633265479e-03   +5.004353509419297e-01; +4.187086494579976e-01   +5.612477537843194e-02   -2.476793385455104e-02   +2.531336654549022e-01   -1.016128130569890e-02   +1.336510594754052e-01   -3.019893720238570e-02   +3.922215709596203e-01   +7.337352546913949e-01; +3.056353260384125e-01   -2.207363195740281e-03   -2.635059401225152e-01   +2.011331599542412e-01   +4.116774570723735e-01   +3.591322398915063e-01   -2.975187198774217e-01   -1.394587547388395e-02   +2.341771406745119e-01; -2.216608433111498e-01   +1.000000000000000e+00   +7.433163536137308e-02   -1.471680731865720e-01   +9.139545680095676e-02   -5.629960567785629e-01   +3.866351809217102e-01   -3.283699238920198e-02   -3.518419484691209e-02; -8.722705422843626e-04   +7.267480725404072e-01   +3.789187219820866e-01   -3.638973367659625e-01   +4.705691938701205e-01   -2.642749684386053e-01   -2.302135472436936e-01   +4.673563675482208e-01   -2.500911746715536e-01];
L1_L2_iAMPA_netcon = [+7.134884453696464e-01   -2.740900375150141e-01   +5.399729977020769e-01   +2.725920309639393e-01   +2.918437537798277e-01   -4.083583732139315e-01   -2.081736626732414e-01   -2.386020046157991e-01   +1.000000000000000e+00; +4.072851291817452e-01   +1.116445371157356e-01   +2.073536054556726e-01   +7.360706004621060e-01   +1.976981519910776e-02   +2.525807643830562e-01   +9.983765167043342e-01   +3.507045412874401e-01   -3.819690320349869e-01; +3.373154091879389e-02   -3.118164303263352e-01   +2.071140588549814e-01   -2.797000146703168e-01   -3.095674439256115e-03   +4.890227829076920e-01   +4.207963066590083e-01   +5.501040963701961e-01   +6.745786098403171e-01; +1.054410963972965e-02   +4.798923965035212e-01   -9.514451333083083e-02   +1.159105861797978e-01   +8.610473530740681e-02   +5.367133231881234e-01   +6.343984691045503e-01   +2.852968026894451e-01   -4.989032907552595e-02; +4.016665685893200e-01   +9.742403011624428e-01   -3.640965983418092e-01   +5.426278022120807e-03   +3.873043347420268e-01   +5.802978895083986e-01   +5.273665522462572e-02   +4.450458064331211e-02   +3.868153437411151e-01; -1.620738378841427e-01   +1.109996543034571e-01   -2.614848399182533e-01   +7.866234377315301e-01   +2.839604032371929e-01   +4.035468306904488e-02   +3.452560561753176e-01   -4.861898284522820e-01   +5.584723893283144e-01; +2.833765757907180e-01   +6.646864665701298e-01   +4.880211341964349e-02   +6.587003648126494e-02   -1.072129534539601e-01   +8.685522736151023e-03   +3.058051550321816e-01   +3.426799610067852e-01   -1.092343350308055e-01; +4.429087704934579e-01   +4.829063251322492e-01   -2.468096873669294e-01   +3.780926756473413e-01   +4.819883106965863e-01   +1.518617880845215e-01   +6.889879566535393e-01   +7.016869400183810e-03   +2.466932712152972e-01; +8.722596276372611e-02   -2.092689813764872e-01   +1.892924687290064e-01   +3.425450796380338e-01   +5.855937091830355e-02   +6.051342472712686e-02   +7.467792323766210e-01   +6.514549299420060e-01   +1.139670209836075e-01];
L2_L5_iAMPA_netcon = [+7.112710785245437e-01   +3.016456721194508e-01   +4.601205877674768e-01   +1.179239476914004e-01   +8.608069958156686e-01   +2.808318275265508e-01   -2.474680385492751e-01   -6.769572875170745e-01   +4.417830286657218e-01; +8.335405044585753e-02   +6.709065483629080e-03   +3.364282460682071e-01   +2.722213827885408e-01   -4.962552132035150e-02   +3.487725157554684e-01   -8.303299648535331e-02   +6.335464573638084e-01   +2.827320688103717e-01; +3.374214566787346e-01   -8.426123203486575e-02   +6.597926509473004e-01   +4.159330709864214e-01   +4.199088018724951e-01   +3.955769033302244e-01   +3.038930716219426e-01   +2.569567834479284e-01   +1.117263863861531e-03; -3.322963580848892e-01   -3.652440147538993e-01   +6.596977829068424e-01   -1.212795112291817e-01   +5.999902038828651e-01   +3.867304412103800e-02   +8.612195100340739e-03   +2.720511715903060e-01   -1.291906019419060e-01; -2.373224142423048e-01   -1.213770788286400e-01   -2.963895185511092e-01   +3.259902142830059e-01   -1.434345926823384e-01   +2.781531532839735e-01   +1.183767299268922e-01   +9.864265948392485e-01   +5.373474855555840e-01; +6.203467948789223e-01   +2.042022023332309e-01   +2.792764936047786e-01   +4.955367031252245e-01   +1.070329029261729e-01   +2.287499327617368e-01   +3.249678635609131e-01   +2.967412816763085e-01   +5.750711218563258e-01];
L5_L2_iGABA_netcon = [-2.852687186150000e-01   -1.299579053112364e-01   +5.313512982215154e-01   +2.862196732148221e-01   -2.484903314208137e-01   +7.653603901160695e-02; +1.258016985948618e-01   +2.885601572161291e-01   +4.556974577958338e-01   +5.673926845660261e-01   -1.883249525517015e-01   -2.310947692135321e-01; +6.920029849605400e-01   +2.432104211597014e-01   +5.955236065492093e-01   +9.966551813723068e-02   +2.648087807460872e-02   -2.679796210426085e-01; -2.118886682435981e-01   -3.537368814540903e-01   +6.361491623113381e-01   -6.729843742619279e-02   -7.897453317676184e-02   -2.381199085014805e-01; -1.374302461980222e-01   +5.302597559107136e-02   +1.964240123868798e-01   -1.526362423233737e-01   -6.031922487375956e-01   -6.117338388091156e-02; +5.241027910302287e-02   -9.735382607655807e-02   +8.587313434578390e-01   -2.417968390945346e-01   -5.910601519008135e-02   +8.328529151417749e-02; -4.672647363873289e-02   -3.511491800594143e-01   +2.790119562404864e-01   +4.904501902478638e-01   -3.641039701180400e-01   -4.770076805914461e-02; +4.725903886563326e-02   +5.928901587943263e-01   +4.407022142144663e-01   +3.673775210183001e-01   -4.930874721706245e-01   +3.814933044231523e-01; +6.492691630561300e-01   +2.291729029068270e-01   +4.339177126713238e-02   -4.181244269895396e-01   +8.747015491310477e-02   +3.822018645265403e-01];
L3_L2_iAMPA_netcon = [+8.883133002017417e-01   +6.495607814702630e-01   +1.808853129247444e-01   -2.186907964175800e-01   +5.419827135928108e-01   -1.271736549465465e-01; -5.612250861048119e-02   +4.481444241871173e-01   +4.768962875042266e-01   -8.679983706008149e-02   +5.084054109689395e-02   -1.803486402813268e-01; +2.724884040440812e-01   +4.136549187539996e-01   +2.826759634453105e-01   +7.465694771085403e-01   +1.277529354563797e-01   +3.637773091574734e-01; +1.519933417308040e-01   +2.634077343172309e-01   -2.268244867028100e-01   +1.033287571134074e-01   +5.721730201422388e-01   -2.089720109831238e-01; +4.067726963480243e-01   -2.769190179761713e-01   +3.412101791170844e-01   +2.777088292849515e-01   +1.096702831330950e-01   +2.282776011759436e-01; -3.304485093421913e-01   +6.698474079049449e-01   +4.821222554926845e-01   +1.196790363488579e-01   +5.990068025021231e-01   +1.806388362188993e-01; +2.567458238165243e-01   +2.398682013195069e-01   +2.365081696809026e-01   +2.280536737760228e-01   +1.954559824851643e-01   -2.685810949851378e-02; -5.016455602723044e-01   +1.679667720937568e-01   +2.510988853432067e-02   +2.628463936389333e-01   -2.485347543860806e-01   +8.967229228182852e-02; +6.728542726283806e-01   -2.585725989214432e-01   +4.785978621860985e-01   -1.243638956421748e-01   -3.029317572220085e-01   +6.759078408022748e-01];
L2_L3_iGABA_netcon = [+3.180815079871004e-01   -1.994311953701001e-01   -4.451405587277931e-01   -6.578293841512192e-02   +9.257702559669784e-02   +1.541435302372866e-01   +4.765934543597456e-01   +9.604348318923167e-02   -2.974803223506157e-01; -3.740793902841094e-01   +2.577721943459318e-01   +2.252806297845201e-01   +3.635899938671224e-01   +5.995280410744854e-01   -2.402901765343523e-01   +2.339825592053499e-01   -1.245493251078942e-01   +2.190123744020770e-01; -1.482831425778140e-01   +1.747266261644652e-01   -1.218403772772112e-01   +3.028591343419167e-01   -4.328901550208644e-01   +3.287072106843784e-01   -9.758921315666816e-02   +5.668509403324367e-01   +4.296878366226421e-01; -1.386284291131517e-01   +7.671194981514233e-01   +5.656386078047897e-01   +2.926109258693135e-01   +1.799474972049372e-01   -7.106573090759793e-02   +7.074989816905847e-01   +1.064962427116829e-01   +3.320066310037516e-01; -1.560971962682495e-02   +4.237546013184483e-01   +9.977215950900893e-02   -2.350295572890634e-01   +8.639129130828216e-02   -3.765845490308453e-01   +1.287398150444347e-02   -1.004265336400260e-01   +3.821041063037164e-01; +1.497416741688667e-01   -2.890784365739187e-01   +5.868787262082641e-01   +3.755005061623280e-01   -1.311214443130334e-01   +5.278968417354697e-01   +2.238414414678444e-01   +4.965245505890002e-01   +4.438439141451926e-01];
L1_L4_iGABA_netcon = [+2.943707474757109e-01   +8.199998789092582e-01   +6.443128001066178e-01   +4.863758270818156e-01   -1.063115595071107e-01   -2.028842241232936e-01   +3.433292812686706e-01   +7.302416293164503e-01   -5.103206536393215e-02; -2.698678057059103e-01   +5.810988072113619e-01   -6.396796972447663e-02   +2.476479751427545e-02   +2.788922554665679e-01   +3.189946865214788e-01   +2.286592423190716e-01   +1.829537437624915e-01   +1.573400688595274e-01; -3.265147958078257e-01   +9.476459330562678e-02   +3.781828258206070e-01   +3.565061920933027e-01   -2.519413803596245e-01   -4.675174204059899e-03   -7.529653234087302e-03   +5.331768800472838e-01   +2.047336659440628e-01; -5.373080992503523e-02   +1.287874719631588e-01   +5.125843161449966e-01   +9.333552757777545e-02   -1.706097367308987e-01   -6.382527758776032e-01   +2.941994491279108e-01   +1.000000000000000e+00   -3.796106463362437e-01; +3.825875926892947e-02   -7.298564537197302e-02   +4.834565536232794e-01   +8.183527711402343e-01   +6.221403203876967e-01   -8.706691875413151e-02   +4.025636630310396e-01   +5.170284228937801e-02   -2.613538633269544e-01; -1.360162807675186e-01   +2.724900130179638e-01   +1.593648109672103e-01   -1.661290244585922e-02   +1.456056860793891e-01   +4.055486938898342e-01   +2.887654393958873e-01   +1.905285763197017e-01   -5.490595181806462e-01; +3.184863416171573e-01   -6.554253944856624e-02   +1.088267134904024e-01   +6.362008673427094e-01   +2.816229659697208e-02   +4.773282164644923e-01   -4.073986588752986e-01   -1.157320612784896e-01   -1.340864060078150e-01; +4.577621351990898e-01   +4.714801618057357e-01   +2.953216392123397e-01   -3.436721110404897e-01   +3.197130922636481e-02   -1.336166310621490e-01   +1.541180030190657e-01   +8.934878174277701e-01   -2.012329712610988e-01; +1.384749821605069e-03   +2.435799127652610e-01   +9.374861362812907e-02   +5.676436235533743e-01   +2.498032962550776e-02   +6.252736906179388e-01   +2.084024599689787e-01   +5.909476170417388e-01   +3.239200933580794e-01; -1.922743766714713e-01   +1.908866386161168e-01   +8.748825463128799e-01   +6.906494537653751e-01   -6.146536720475112e-01   -3.067102460278480e-01   +2.565304657198316e-01   +6.086542012823428e-02   +3.899904947771657e-01; +8.004057513029184e-01   +7.426279977559523e-01   -7.019435077206787e-02   +6.306920184865695e-01   +1.700849327254015e-01   +5.135096242934295e-01   +2.305291971029242e-01   -8.009420475675062e-02   -2.938687522852220e-01; +5.483790679732241e-01   +8.796312267851026e-01   +1.870742049739718e-02   +1.407871339302038e-01   +3.801213088367368e-01   +4.154219109363853e-02   -2.274935519444803e-01   -2.638522932260692e-01   +4.803331196726781e-01];
L4_L1_iGABA_netcon = [-2.196576967826126e-01   +6.681772635227403e-01   -5.650359677168036e-02   +2.345693267961555e-01   -2.189426846379424e-01   -6.338211101691876e-01   +2.521501803331152e-01   -1.276773726918056e-01   +1.024788077054410e-01   +2.967320226011691e-03   +2.422798076582633e-01   +9.944856950385972e-02; +1.322985198304306e-01   -1.418201994942121e-01   -6.646187409098417e-01   +2.631402073771727e-01   +4.441678561183189e-01   +2.789094465859491e-01   +3.576673422685934e-01   +6.654087667436799e-01   +4.452291536364545e-01   -4.081356141095411e-01   +4.260571469856618e-01   +8.275151534718672e-03; -1.256730359995042e-01   +5.245286018127946e-01   +2.062629398096903e-01   -3.739011615324780e-02   -4.667980823410051e-03   +1.868401131906739e-01   +4.748334119016397e-01   +5.016214916872586e-01   -5.558938693222077e-01   -2.634143447328728e-01   +9.786332813127612e-01   +3.128155032148500e-01; +1.241653313796870e-01   +1.380005213516469e-01   -2.218264687774028e-01   +4.934958228505186e-01   +8.897502630961731e-01   +3.368364067727914e-01   +2.446254351572728e-01   +3.607724068480372e-01   +5.215824718127188e-02   -5.474975075610996e-02   +2.227802972975275e-01   +2.389380201506404e-01; +5.499519953964280e-01   +2.861535181893744e-01   -2.907243369034402e-01   +6.673758448824918e-01   -3.786126152744512e-03   -3.988929474998644e-01   +4.064975579972300e-01   -2.775254038356814e-01   +6.910278761039507e-01   -1.461487435377784e-02   +1.548837118436350e-01   +5.475286013661050e-01; +3.027764077857342e-02   +2.057824631404996e-01   +2.680060139162079e-01   -2.766701220702870e-01   +2.104594755052311e-01   +1.521173726504089e-01   +9.510490255826292e-01   +3.277673042788462e-03   -2.455541642858092e-01   -6.193466018910765e-02   +6.268240611124828e-01   +5.253142999057427e-01; +5.999086043010488e-01   -3.310853319085100e-01   +4.477124754504473e-01   +3.432851999105259e-01   +1.616914751220305e-01   -4.249805636403610e-01   +6.687758776897449e-01   +2.288598752502269e-01   -7.048850682327250e-02   -2.289633361089664e-01   +4.404947093272236e-01   -7.829675559808114e-01; +1.772548498658661e-01   +7.065289633675219e-03   +6.839410094362267e-01   -1.883334187488461e-01   +1.147932764369962e-01   -3.802227956028743e-01   -1.918764406629112e-01   +6.620991002990491e-01   -1.838192168177541e-01   -2.163746935694161e-01   -1.248802036553017e-01   +2.609168892461514e-01; -2.544308017569338e-01   +3.767922559266946e-01   -9.330544733033323e-02   -2.373012741095856e-01   +3.446891502629612e-01   +2.773495109076321e-02   +4.355597494294264e-02   +3.057599713970003e-01   -5.420040747709560e-01   -1.235787276137385e-01   +2.851677997611116e-02   +2.646818676290336e-01];
L1_L3_iAMPA_netcon = [+1.982541031470830e-02   -1.691113702870250e-01   +5.808393051487616e-01   -5.539474324367656e-01   +1.000000000000000e+00   +2.197631081094313e-01   -2.900897094063450e-01   -1.589040511797753e-01   -1.196258011023250e-01; -1.368151502927744e-01   +7.636755178312099e-01   -1.154913877291928e-01   +2.715057275944348e-01   +2.958575933990614e-01   +3.570271986591738e-02   +6.351047605118478e-01   -4.220742151077297e-02   +2.221644360997405e-01; +3.032330651459559e-01   +6.856689652390535e-02   -4.785297066779498e-01   +5.902626111092303e-01   +8.135524773193182e-01   +2.351958439914459e-01   +4.539534661482399e-01   -2.939252373376716e-01   +7.637964210090272e-01; +5.582737900346315e-01   -3.652753730298803e-01   +4.519992470283324e-01   +5.350461229336012e-01   -8.209455373027132e-02   +5.632874018349925e-01   +1.820606518666764e-01   -7.614356422340621e-02   +4.767453073024250e-02; +1.547420838271823e-02   -6.944519612601587e-02   +5.584877327997215e-01   +1.017960051078669e-01   +2.370251587793060e-01   +2.548580715635300e-01   +4.400234625738612e-01   +7.725259128849455e-01   -4.294135792708849e-01; +5.515151083992814e-01   +6.672648626766607e-01   +2.482964409219628e-01   -5.764282271960088e-02   -1.909510801330528e-01   +1.241001968392196e-01   +3.068512336208743e-02   +4.501477237942249e-01   +4.267533311801041e-01];
L3_L1_iGABA_netcon = [+5.211520440412684e-02   -7.864280034749427e-02   +2.082424259785745e-01   -2.113524005741899e-01   -4.934057697689831e-02   +8.335403663002376e-02; +2.303410024062005e-01   -2.949931754323478e-01   +1.651811933394409e-01   +4.117167031934834e-01   -1.877086082522025e-01   +2.865600954065842e-01; +1.486700450056404e-02   -2.232974276017086e-01   +3.086125773440681e-02   +3.821413057669841e-01   +3.010265677914433e-02   +1.174413091264345e-01; +2.475632619670123e-01   -4.874299197459250e-01   +7.873783766133390e-01   -1.614172261954069e-01   +5.878327513396245e-02   +7.008925449895020e-01; +4.401575347554810e-01   +1.485394979896669e-02   +6.009498075103408e-01   +4.235307418970775e-01   +1.557172053449618e-01   -5.432147889685892e-01; -2.739026730980767e-01   +8.842085394600318e-01   +3.095514027988118e-01   -2.554142845043514e-01   -1.045584178420728e-01   +1.931721106365371e-01; -1.238440211057153e-03   +1.103755963372696e-01   -3.055451859117762e-02   +4.777123358684101e-01   -1.236255076776817e-01   +4.749021911306222e-01; -8.693270472042684e-02   -2.030294583977069e-01   -2.296414503231497e-01   -3.971592393232764e-01   +1.218608919638125e-01   +3.658507386545560e-01; +2.436016508715031e-01   +1.000000000000000e+00   -1.273493911991990e-02   +5.064515776183138e-01   +4.767306369324334e-01   +6.015024860459077e-01];
L5_Input1_iAMPA_netcon = [+4.471226101903331e-02   +1.050769659453102e-01   +6.247816577261306e-02   +1.372639894453958e-01   -3.963282389251281e-01   +4.461264648465375e-01];
L6_Input2_iAMPA_netcon = [-4.189901293386488e-01   +5.000001687001007e-01   +4.844486374095749e-01   +5.951735463701648e-01   +5.501571995555138e-01   -6.537416555221702e-02];
L5_L6_iAMPA_netcon = [+9.458683269732190e-02   +1.714181209811842e-01   -9.777184923155402e-02   +1.524271516604606e-01   +2.387402197338725e-01   -2.025102230165993e-01; -1.945207159979709e-02   +5.683753333397896e-01   +3.327240517737707e-01   -2.181959816071338e-02   +5.408906275737233e-01   +5.562665714240459e-01; +3.883743118981209e-01   -3.570757595016597e-01   -3.223209965204993e-02   +1.475161756467281e-01   +2.899221826116233e-01   +7.841981473396799e-01; +5.419273900040932e-01   +6.336897805045271e-01   -8.183955344384200e-02   -6.521963864531595e-01   +3.868368492397363e-01   +1.642434970893776e-01; +1.040246930279315e-01   -2.764673219618063e-02   -1.973465610012157e-01   -2.665905683377507e-01   +3.548401936698836e-02   +7.318093379584754e-01; -9.991094173300832e-02   +6.396254159764462e-01   +4.009727707555329e-01   -9.232718507521220e-02   +2.551236859595315e-01   +4.720465936515111e-01];
L4_L5_iAMPA_netcon = [-6.911310847388125e-02   +2.313500377776264e-01   +5.215541892673143e-01   +7.047522892664518e-02   +7.023469485221986e-02   -2.854367358821733e-01   +7.028746341120402e-01   +7.208942252524417e-01   +3.578232412899757e-01   -8.982970398776322e-02   -3.772398366346445e-02   +2.280749099440484e-02; -1.064589808209858e-01   +5.705848469994003e-01   +2.915760026724493e-01   +3.968084534907879e-01   +1.286609247907231e-01   +1.409637006750638e-01   -2.196796145088614e-01   +1.930170591381625e-01   +6.480807409409595e-03   -2.584759091495016e-01   +8.743207841220868e-02   -5.753640924855239e-01; +2.007232977732388e-01   +4.466123960009585e-01   -5.099802592596961e-02   +2.123512320195270e-01   +7.350165079391358e-01   +8.732631170654389e-01   +4.143316959205022e-01   +2.458662112941769e-01   +7.484388295940682e-01   +2.773094789019475e-01   +5.368033581252313e-01   +8.214442725201967e-01; +7.777299037388650e-01   -2.289075757257550e-02   -3.831062739778365e-02   +1.932330614923648e-01   +2.738261225910257e-01   +2.655995181852276e-01   +2.482005326976170e-01   -3.394152070842926e-01   -5.469604903994938e-01   +1.211270137665450e-01   -2.922478785001637e-01   -1.379899418718959e-01; +5.092270575841268e-02   +2.829990048467166e-01   -4.452996562718622e-01   +6.161309475544261e-01   +3.662256427802347e-01   -1.601787779455518e-01   +6.143284106544034e-01   -4.939139215378457e-01   -7.099170044744682e-02   -4.784573322119531e-01   -3.007355413320527e-01   +1.096177761730383e-01; +2.766161496775457e-01   +1.772075418053382e-01   +6.647098794273650e-02   -2.293364720245878e-01   +8.423988182771287e-01   -1.090908153160586e-01   -4.449713571645126e-01   -3.619934675872574e-02   +6.135618144516599e-01   +2.026087256057267e-01   +2.655425542266091e-02   +6.480119946489100e-01];
L6_L4_iAMPA_netcon = [-6.201930244185996e-02   +3.112337190289877e-01   +4.258535098745949e-02   +8.280917009742923e-01   +3.288362471766670e-01   +3.996328773231100e-01; -4.770975412445300e-02   +6.221480107434010e-01   -4.410740518090102e-01   -2.623418874600932e-01   -9.238234331181400e-02   -4.024488454034918e-01; +1.603210596053541e-01   +3.711623298418570e-01   +1.741185595389114e-01   +2.798509024539711e-01   +4.160399529951532e-01   +5.861910840890213e-01; -2.371043672200441e-01   +2.744185730263269e-01   -1.707561680521316e-03   -6.339476531018184e-04   +2.469508212489727e-01   +2.213137970106445e-01; +1.230500185174432e-02   +1.818082171499170e-01   -2.166971229788070e-01   +1.751742455419544e-01   +1.023755266456310e-01   +6.058145209614416e-01; +2.250800907765368e-01   +3.903961913684755e-01   +4.089948936205033e-01   +7.891054808281333e-01   +6.142084699337160e-02   -2.156095045736401e-01; -4.526897495481091e-01   +2.487427484148887e-01   +5.839014819247315e-01   -6.347607867990060e-02   +8.096165387860907e-01   +1.783365081276054e-01; -2.853409756800067e-01   -2.592310660082475e-02   +4.588209653456650e-01   +3.286936805521132e-02   +5.274203836200952e-01   +3.556217463488248e-01; +6.649402611080818e-02   -3.668612238576313e-03   +3.975813260228426e-01   -2.088454245872621e-01   -9.483256435229481e-02   -6.428514922011556e-01; +5.116651200781419e-03   -3.526445334172938e-01   +5.123459458596961e-01   +5.049959287838297e-01   -2.740727699916168e-02   +2.377211188476636e-01; +1.830059273123656e-01   +1.814840057340325e-01   +2.822994669516578e-01   -5.672678541765427e-02   -8.419513122099391e-02   +3.220587412945496e-01; -4.749948699409779e-02   -1.205725673440663e-01   +2.327493519119934e-01   +2.148591155606360e-01   -2.972913364845453e-02   +3.262235669352755e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
