function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.964484967791919e-03   -7.750087789689525e-04   -1.376690211886913e-02   -1.921630431668034e-02   +1.341010993512027e-01   -2.478256046630466e-02   +1.245022118805509e-02   -2.832631888209091e-02   -5.078909232737885e-02; -3.407126098451647e-02   -1.566691945574702e-02   +7.897342293788339e-03   +5.412110333313485e-03   -2.565493737088683e-02   +5.533867878232251e-02   +4.565437048458646e-02   +6.457293958498318e-03   +7.085829889155018e-02; +3.878249065542237e-02   -6.668108221049990e-02   +1.276777501107170e-01   +4.673996817649701e-03   -2.529219524665683e-02   -8.233881496696564e-02   +4.474970764211396e-02   -2.323995311524606e-02   -3.265040440419074e-02; +7.544506853352323e-02   -2.320188087364021e-02   +9.572332702094577e-02   -6.896038904242294e-02   -8.970494011815157e-03   +1.204450314814655e-02   -4.491288847932761e-02   +5.901777049668898e-02   +4.719349431221530e-02; +1.178804365756205e-02   +4.909328909394789e-02   +5.821532297073522e-02   +1.502862394611648e-03   +4.980036932781617e-02   -5.552540165121989e-02   -1.678810880749079e-02   +4.259616422671969e-02   +2.066136502601056e-02; +5.572691436728790e-02   -6.766524735623096e-02   +3.457136775435327e-02   +1.045532137898891e-02   -3.785425614814125e-02   +4.123448479225936e-02   -2.395857433667797e-02   +2.596428594132683e-02   +5.350188628438453e-02; +9.759360737814092e-02   +1.987172429958065e-02   -1.868225468043011e-02   +1.365042099782737e-01   -3.695478173301237e-03   +4.003765487064039e-02   -2.560553884714900e-02   +7.725607762476790e-02   +7.704746100481608e-02; +1.089884227368808e-01   +5.148520131590278e-02   +1.636862418831658e-02   +3.167446935538591e-02   -9.627243750407111e-02   -4.284099719508612e-03   +2.823147219888733e-02   +3.134718562123287e-02   -3.817000470756345e-03; +8.285026113458094e-02   +5.001359144871800e-02   +6.649586896496097e-02   -1.487417159554625e-02   +6.823714402694071e-02   -8.712256751488047e-04   +9.218321282426706e-02   +2.079032015854720e-02   +1.504392843608583e-02];
L1_L2_iAMPA_netcon = [+9.976517852775432e-02   +5.535044431754486e-02   +1.102206268451097e-01   +5.604587749620988e-03   +4.112866002658003e-02   +5.250030286301213e-02   +1.135110504509801e-02   -2.704779829474500e-02   +7.623668279981104e-03; -7.268129458502962e-02   -7.537615126743774e-03   -2.306452364736957e-02   +5.943666829720740e-02   +8.342051271534175e-02   +1.291556235315568e-02   +1.687743951495099e-02   +5.923379976938763e-02   +3.305343162477342e-02; -3.960227350734975e-02   +5.317976871468977e-02   +1.391860299255329e-01   +1.816083723902292e-02   +1.150377741487313e-01   +5.995404033448011e-02   +9.761040007627314e-02   -3.419849539884770e-02   +2.103775694081323e-02; -1.226414222150391e-02   +1.128418468624088e-01   -1.344624986592285e-02   +1.782925673103013e-02   +1.962420364032405e-02   +4.560189599547020e-02   -8.829101609520423e-02   -6.109755603992882e-02   -9.438875621655353e-02; +3.617556863983167e-02   -4.598612586202858e-02   +7.963669176846454e-02   +1.209254213342711e-02   +1.067358416488734e-01   +1.083435587865313e-01   +1.179010016553855e-01   +5.330334033061138e-02   +1.620246516795699e-01; +3.301664891141296e-02   +1.668922515785316e-02   +7.517613852969005e-02   +5.677951433527149e-02   -5.837221462355390e-03   -3.453529662026125e-02   +6.164515444285310e-02   +1.074976827339886e-01   +8.263791408269289e-02; +4.919332936543457e-02   -3.478277778064413e-02   +7.572774723432872e-02   +2.176373113921491e-02   +8.644086006376528e-02   +2.380378503845803e-02   -4.890576893646287e-02   +1.328231197155597e-03   +1.578346025725654e-02; +7.304822034552938e-02   +7.463367170300945e-03   +2.657849032257921e-02   +3.465021337328419e-02   +5.590372463111252e-02   -3.792727283387611e-02   +6.094858514867781e-02   +7.719468311492089e-02   -3.460075409416932e-02; +1.219648659958310e-02   +7.077238569102730e-02   -2.082566421901279e-02   +1.856899781297446e-03   +8.493372131206102e-02   -4.606420239230270e-02   +9.450826033929538e-02   +8.410900931869306e-02   +5.779453552651566e-02];
L2_L5_iAMPA_netcon = [-2.158673224053260e-02   +6.322180365714518e-03   +1.488522989898708e-02   -5.380435324723666e-02   -6.083861033286007e-02   +3.497746325942139e-02   -4.496304076258052e-02   -4.568738214680187e-02   +3.986661320592329e-02; +4.195467278435326e-02   +5.599022568564849e-02   +4.993852742684676e-02   -4.219170686463843e-02   +4.047134605569326e-03   +1.294287065966023e-02   +6.959788148587791e-02   +1.100154912636715e-02   +3.235521707426695e-02; +4.214120180428473e-02   +4.833929025236308e-02   +2.057700661571368e-02   +3.698683581260148e-02   +9.337616599044692e-02   +1.955449069787658e-02   +2.871513242981850e-02   +5.719447720437036e-02   -6.924777192217586e-04; +2.044321253404575e-02   +1.162733888089262e-01   -2.072796841002990e-02   +5.724126160980526e-02   -5.173226310086924e-02   +8.651880770668698e-02   +4.593922755473737e-02   -1.743004040792535e-02   +2.817217231884312e-02; +2.128566157866634e-02   +2.057113272281537e-03   +4.052518786715362e-02   +2.666713542652747e-02   +6.572352912898295e-02   +2.991432280343064e-02   +1.125539131081926e-01   +1.540476992857093e-02   +3.192068449091497e-02; +6.343733559875339e-02   -5.165097938647020e-02   -8.498432829210922e-03   +2.843518870762242e-02   +4.797771406971681e-02   +3.973437439934491e-02   +2.654668270347205e-03   +2.302332286113556e-02   +1.754446175625082e-02];
L5_L2_iGABA_netcon = [-1.463142852652170e-02   +2.259242508309715e-02   +1.132297519749656e-01   -2.625926220972014e-02   +1.583237386777019e-01   +4.536048724449504e-02; +7.663651419832848e-02   +9.715873937414693e-02   +2.738031045394017e-02   +2.372602642437788e-02   +2.312946041072298e-02   +8.255865864684407e-02; +7.547533810745606e-02   +1.187328539621292e-01   +1.468065525351991e-01   +7.442025140622138e-02   -4.013814766455855e-02   +6.905375558843484e-02; +5.812388302678292e-02   -9.519097507662258e-02   -7.519021769722534e-02   +8.719208128219337e-03   -2.717243985395153e-02   -4.488548883601183e-02; +3.998518980412208e-02   +5.662666857825180e-02   +1.152247769106769e-01   +1.925779121189953e-02   -4.401543677061327e-02   +6.103432015416874e-02; -8.823606048658955e-02   +2.647488541290744e-02   -2.166901336527740e-02   +8.203842910143429e-02   +7.926401658410187e-04   +2.794374490461538e-02; -1.453708004101032e-02   -8.749984957226459e-02   +6.506683900300368e-02   +6.882986424695622e-02   +6.980961548761516e-02   +4.643127343843537e-02; +3.716169777052063e-03   +9.989127194078962e-03   +1.329548340242504e-01   -2.528548164034971e-02   -4.496117267440519e-03   +9.897862744764320e-02; +5.786309382843297e-02   +5.247043873764724e-02   -1.729085070128022e-02   +5.010347741866099e-02   +1.334135685756311e-02   -7.071658035774945e-03];
L3_L2_iAMPA_netcon = [+1.861947935648953e-02   -9.789182963889749e-02   +4.747760796778715e-02   -3.659072828487406e-02   +2.528483038632861e-02   +7.592213689049711e-02; +1.968535594595440e-02   +2.956816817107980e-02   +2.881165418633725e-02   +3.158013604977217e-02   -8.315558730401358e-03   +7.950658021910174e-03; +1.313375525687631e-03   -1.363491811240066e-02   +3.249799625061799e-02   +1.043182968632055e-01   -4.814172148494077e-02   +9.919549677659040e-03; -2.114664941487136e-02   -1.046904152394011e-01   +1.140966700678685e-02   +6.089505032615216e-02   +2.538698387639201e-03   +5.015715050781362e-02; +7.305411280850820e-02   -1.681376576602245e-02   +5.293330438933740e-02   +2.568350499573385e-02   +2.111243520393577e-02   +4.991181137195719e-02; +7.577899519001575e-02   +5.204393050782326e-02   +5.425205216801726e-02   +4.464117497632418e-02   +1.944046140124708e-02   -6.178497813638292e-02; +1.063553543961863e-01   +1.754273549774133e-02   -5.854550716968422e-02   +5.332057118588309e-02   -3.708883471082264e-02   +4.284677311955961e-02; +9.919546823089740e-03   +3.230044685082337e-02   +3.217716543493321e-02   +2.807025396423853e-02   -1.831793223466071e-02   +4.435158620802565e-03; +8.288574000590501e-02   +3.925616348462097e-02   -5.493676830790420e-02   +1.472589067072069e-02   +1.169048032977814e-01   +1.221813856519954e-02];
L2_L3_iGABA_netcon = [-1.591180532558441e-01   +4.596100627424961e-02   +1.884272101121826e-02   -2.551099109537886e-02   +1.952700502193546e-02   +2.422558024060048e-02   +1.598094864817265e-02   +5.950761179936746e-02   -1.392026663732765e-02; +2.258614886759685e-02   -1.751416040118747e-02   -2.131614792628844e-02   -4.903504841946241e-02   -2.297588814041830e-03   +1.285862553550358e-01   +1.169981337473997e-02   -5.704058200392617e-04   -3.358113871985194e-02; -3.203168626967971e-02   +4.848656966556096e-02   +2.862485625959922e-02   +1.312006669938621e-02   +5.169381190001577e-02   +3.366101294169962e-02   +7.066155479748532e-02   -1.788611832106165e-02   +4.309973128180042e-02; +2.881325021861059e-03   -5.650355237284545e-03   +7.407533958734907e-03   +8.816695807765336e-02   +8.602018752170663e-02   +9.133415870812105e-03   +5.438822358313451e-02   +4.409670031837267e-02   +2.336758738399881e-02; +5.859865464925173e-02   -7.950917809401971e-02   +6.661250894800590e-02   +1.066267255225363e-01   +4.922318034027574e-03   +2.869394435559672e-02   +1.197376041787479e-01   -7.776345586070459e-02   +6.413816600367739e-02; +4.624531614048408e-02   -3.234466160691173e-02   +4.248065454705324e-03   -1.165001523503196e-02   +2.363709893443462e-02   +7.317749428738214e-02   +1.268065628542988e-02   +3.434209424574160e-02   -4.464700294653598e-02];
L1_L4_iGABA_netcon = [+7.768737844315324e-02   +1.578136605013400e-02   +7.976876774569651e-03   +5.183552447921701e-03   +2.945740008542074e-02   +9.844728991102758e-02   -7.865333074895112e-02   +8.045962501856960e-02   -8.584657505762480e-02; -1.669799493862550e-02   +4.571120290308321e-02   +2.698714020626645e-02   +4.702625856066987e-02   +5.120319649476990e-02   -5.811226192325456e-02   +2.078044778793995e-02   -4.878992815611745e-02   +7.913957589135401e-02; +3.288776547130159e-02   +6.802854535917455e-02   +1.276051039886779e-01   -5.707976183108804e-02   +6.269929453940204e-02   +4.530351977408229e-04   -3.053111042556192e-02   -7.444446714092434e-02   +1.084764463377105e-02; -2.526194393211225e-02   -5.457769138263399e-02   +2.840324989954604e-02   +4.027305703524757e-02   +6.571462164869360e-02   +1.071000290584053e-01   -4.384850442346854e-03   +2.124583491377505e-02   +5.338365113981723e-02; -6.763133171754381e-02   +9.247950384243700e-02   -7.414644046756022e-02   -9.684052514927655e-02   +8.263168607338056e-02   +2.789447656952970e-03   +4.701861873081754e-02   +8.818081766242902e-02   +1.391669666820232e-02; -2.130275158352845e-02   +1.344087057391544e-03   +1.053031821766238e-01   +7.876308069918489e-02   +6.757146574126617e-02   +5.392463768151536e-02   -3.141413070843223e-02   +3.462877118647081e-02   +9.997860100960099e-03; +6.023569105080693e-02   +6.997835028783993e-02   +6.068252609549002e-02   +3.832637347921117e-02   +5.429585132405711e-02   +7.062940610322202e-02   +1.148036623579067e-01   +8.037990893474285e-02   +4.528445789893445e-03; +8.234038904506051e-02   +1.060164293356911e-01   +5.001808780981434e-02   +2.324486183939075e-02   -3.850388934773967e-02   +1.763227504770708e-02   +2.293144283412950e-03   +4.843388802143862e-02   +8.066694051828849e-02; -2.429360929867836e-02   +2.749701538161549e-02   +3.401357081238916e-02   -4.728196723552732e-02   +3.437562560060824e-02   +2.536837252156959e-02   +4.669230805352856e-02   +3.130763657014329e-02   -5.205733106120627e-02; +1.741863793179220e-01   +2.334436803711175e-02   +1.718722538041288e-02   -2.068458622480695e-02   +1.562971699171075e-02   +2.367024581756470e-02   +1.219048563639889e-01   +2.332549612940404e-02   +2.295167043636719e-02; +1.098412534044944e-01   +3.349903800542207e-02   +3.401872799442163e-02   +9.116968898107142e-02   +5.401368105347050e-02   +5.960406059646517e-03   +1.500353624928618e-03   +8.590515362360128e-03   -1.260840420624497e-02; +8.467777374096828e-02   +9.447587235648369e-03   -3.677083222322287e-02   +5.473479517064778e-02   +2.109530933690332e-02   -3.184850718391830e-02   +6.429232566651030e-02   +6.442594586779612e-02   +3.758665632303517e-02];
L4_L1_iGABA_netcon = [+3.154081708150448e-02   -4.434836409331390e-02   -4.207906668172780e-03   +5.607165070457814e-03   +4.663423344484711e-02   +7.037436579071179e-03   +4.442523907272764e-03   -1.082151411365063e-01   +5.618722294830934e-02   +3.587193250346296e-02   +2.918237868113172e-02   +3.388569600931299e-02; +8.543142551246342e-02   +4.046621443100775e-03   -3.026667684731937e-02   +3.723587114039282e-03   -5.658261840364251e-02   +6.887639106300153e-02   +6.398247333088897e-02   +4.406023066671413e-03   -1.154222466566490e-02   +9.267327792889257e-02   +5.221796116847267e-03   +2.577802590216796e-02; +1.468016771661569e-02   +7.955587295475086e-02   +1.749157387302746e-02   -7.368908547017366e-03   +1.853227428163348e-02   +5.359896853993879e-02   +6.871591846067085e-02   +7.242344008765557e-02   +7.556811378123916e-02   -7.740709789442770e-03   -5.744082966726705e-02   +1.368223129935911e-01; -2.644023756016205e-02   +5.140706485733696e-02   +4.019051646639170e-02   -8.853941912900530e-03   +8.961075315939301e-02   +3.914455678885787e-02   +3.693702198207328e-02   +4.917562421919797e-02   +6.430804057940094e-02   +9.430653644002425e-02   +1.123552718765740e-01   +4.400228683481121e-02; +7.524079812188547e-02   +8.604810196403230e-02   +2.976227243009345e-02   -3.956269593261654e-02   +2.609769926473949e-02   +7.414393915305836e-02   -9.849243577642625e-02   +7.814623035134866e-02   -3.891648235028430e-02   +7.626735319328981e-02   +5.670111384234430e-02   +4.521934595376634e-02; +5.300158070969044e-02   -3.438095555729049e-03   -3.634508470852262e-02   +6.254663332488569e-02   -2.851247774431813e-02   +3.235500011934930e-02   -4.190798435034076e-02   +1.953289380964464e-02   +2.068323745416451e-02   +1.168598391046570e-01   +2.494573110063789e-02   -1.029251667333512e-02; -4.475396902401919e-02   -4.746264386215945e-02   +3.907052859274154e-02   +9.597870881300698e-02   +1.021518026958197e-02   +8.317390772061903e-02   +3.589770192868767e-02   -8.343307292003488e-02   -4.758325560868886e-02   +9.320325109273117e-02   +1.460863741314795e-02   +7.048115017378903e-03; +3.512009205605043e-02   -2.391086510401434e-02   +1.008062518607193e-01   +1.933453584313401e-02   +1.014173363128011e-02   -3.055863583555668e-03   +6.875979196006785e-02   +6.339061252117695e-02   +5.170753785413449e-02   +3.420078906061540e-02   -2.595511244067342e-02   -3.552232093490218e-02; +1.091463368071237e-01   -6.132212225775854e-05   +7.947638769601835e-02   +1.284603132672196e-02   +1.255690342519196e-01   -5.744850924963019e-02   -1.396002919290289e-02   +4.777523956111396e-02   +1.554249480128604e-01   -3.410009654293575e-02   +4.294340836426089e-03   +5.933452407752358e-02];
L1_L3_iAMPA_netcon = [+8.776508940973633e-02   +1.118262804773297e-01   +3.800319126232199e-02   +4.630829957011937e-02   -9.975213583835425e-03   +7.832148222907026e-02   +1.337491248661097e-01   +1.502053506521284e-02   +3.236930927497877e-02; +1.871566963897381e-01   +6.214072961952195e-02   +3.135985815267397e-02   +9.959267536208269e-02   +1.209222746760278e-02   +1.521646344029727e-02   +1.217622673650648e-01   +7.014875809495655e-02   +7.244110573115550e-02; -1.084828947210987e-02   +6.108639609741860e-02   +1.151218024121490e-01   -3.303912755347860e-02   -3.539347865666398e-03   +1.403834411409857e-02   -2.783240565917658e-02   +1.636867551907875e-02   +1.368975328417073e-02; +8.231697713311042e-02   -6.721652048661281e-02   +2.696066835627429e-02   -9.234196870870365e-02   -7.896248925043621e-03   +1.985469533984176e-03   -3.333626887909861e-03   +1.115293275052685e-01   +1.918900331386179e-02; +1.589884764881367e-02   +2.800554575775980e-02   +6.198803607304076e-03   -1.347235160349093e-01   -1.640510190529315e-02   -1.584127190757859e-02   +1.487873545074049e-02   +3.632169705904634e-02   +5.793909630573593e-02; +5.113139863226848e-02   +1.303971121533889e-01   -4.035604607712301e-02   -2.300003948361970e-02   +2.670053703061101e-03   +5.565975588658271e-02   +5.426934083137105e-02   +1.312797666604344e-02   +4.860146622953893e-02];
L3_L1_iGABA_netcon = [+6.262961359444843e-03   -1.979433390211681e-02   -2.609500340502931e-02   +3.702721971436178e-02   +4.231777156665352e-02   -4.208253441353642e-02; +5.655617079888333e-02   +7.831835009184009e-02   +1.933950297023455e-02   +1.155846690078320e-01   +2.810621847952793e-02   -6.569647194188878e-03; +1.962595585467485e-02   +2.177212413086548e-02   +4.381815700503477e-02   +2.073964667887549e-02   +7.404134459461365e-02   +4.884645636186667e-02; +9.754563182435642e-02   -9.903567190221660e-02   -6.874939699010346e-03   +8.152342415302691e-02   +5.167378498617949e-02   -2.677567344842613e-02; +9.363546472053567e-02   -1.561931974486482e-02   +4.421178183912576e-02   +1.897621465329752e-03   +6.622600395042054e-02   -2.444511748115764e-03; -6.832775283655490e-02   +2.013147621523758e-02   +8.168764533275572e-04   -4.571660184125463e-02   +6.113084939240027e-03   +1.033252671251716e-01; -5.530765699047430e-02   -5.222375911618694e-02   +3.890491299647812e-02   +3.793831570505966e-02   +1.843544828667607e-02   +3.485011962866100e-02; +8.024293889458603e-02   +4.351371558345089e-02   +1.645950182906831e-02   +2.463362983108274e-03   +2.453329822162759e-02   +1.206175722783986e-01; +3.771749059533741e-02   -2.026546897931890e-02   +1.076568923301323e-02   -4.827437566869840e-03   +2.156994467278193e-02   -4.956080631438571e-02];
L5_Input1_iAMPA_netcon = [-1.965892923943592e-06   -4.641723574154958e-02   +9.141565287183561e-03   -5.239437832487770e-02   +2.586787782434984e-02   -5.028926595777359e-03];
L6_Input2_iAMPA_netcon = [+4.535680658153293e-03   -3.795664644699047e-02   +7.334589254692392e-02   +5.994966588936766e-02   +3.558163518948902e-02   -6.044921741294322e-02];
L5_L6_iAMPA_netcon = [+3.018263377397479e-02   +3.308407616731365e-02   +9.881554341132359e-03   +4.712089486236564e-02   +7.852748023950064e-03   +7.729996518979380e-02; +6.213162623402334e-02   +1.064310912132540e-01   -5.647919971281704e-02   -8.113599843041179e-02   +1.827769544858611e-02   +3.310312995474754e-03; +4.825951253727902e-03   +5.082396000153457e-03   -8.284527653922853e-02   +5.600884030056561e-02   +2.514904390828653e-02   +7.203542706861907e-02; +6.328762264024383e-02   +8.582996633357759e-02   +8.260744155930851e-02   +1.778372352686941e-01   -5.175828742258722e-02   -2.096692810479836e-02; +8.136064439992931e-02   -3.616370804819781e-02   +9.709214967684736e-02   -6.633226387887357e-03   -3.647706083216860e-02   +9.686010391327805e-03; -5.050099972272638e-02   -8.056396650810738e-02   -3.389219600743378e-02   +3.194605873457223e-02   +3.114491152174466e-02   -4.899763890193701e-02];
L4_L5_iAMPA_netcon = [+2.889750579432671e-02   +5.441168508734201e-02   +5.669271444835021e-02   +8.467485034430086e-02   +9.791543904319966e-03   +2.235543697510253e-02   +5.462807383139519e-02   +8.395107024961065e-02   -4.566584245185486e-02   -3.760331340040801e-02   -1.278543808451824e-02   -4.433301131236641e-03; +8.152379088175643e-02   +4.019235996852694e-02   +2.821707604711743e-02   +9.465529012152518e-02   +6.361045227602626e-02   +3.602682421308958e-02   +3.088959942040678e-02   +9.038615494706566e-02   -2.714995444266614e-02   +4.226664970799203e-02   +4.781434279131033e-02   +9.445356858595258e-02; +3.170652458098014e-02   +7.869929820846402e-03   -3.947652405815467e-02   +3.196771107300987e-02   -4.443909513954364e-02   +6.352873689320378e-02   +1.328000588315629e-02   +1.012554306389659e-02   +2.248053388625181e-02   +1.370223103190679e-02   +6.954227564385557e-02   +7.619405564749993e-02; +2.010067751108291e-02   -3.536419837868784e-02   +1.035086327903011e-01   -1.175906244563465e-02   +7.903674895189641e-02   +5.422010756463641e-03   +4.605932726620495e-02   +8.363000803395924e-02   +1.927752929967860e-02   +4.996056613428013e-02   -1.236925276303995e-02   +4.003827851586186e-02; +1.820051905725256e-02   +1.232173718401018e-01   +1.208118998882423e-01   -5.534445723586086e-02   +9.998656098675614e-02   +1.004602709197691e-01   -2.169031510430426e-02   +2.256507991601230e-02   -4.123937101016500e-02   +8.255668615668811e-02   -6.583215969940623e-02   +1.381369352842313e-01; -9.539364949454547e-02   +2.806512150484242e-02   -4.660138595259285e-02   +1.952155234510344e-02   +3.762649935510516e-02   +1.020848880030013e-01   -1.948610425569145e-02   +1.379944411073482e-02   -6.030629239294456e-02   +9.460266611216770e-03   +1.228648178294957e-01   -4.552416450243580e-03];
L6_L4_iAMPA_netcon = [+3.097272222473106e-02   +2.057670325916509e-02   -1.027192383921908e-01   +8.506941997691905e-02   +1.422704188468813e-01   -6.462682814908438e-02; +5.514597059480132e-02   -3.668685241214621e-02   +1.990780295448177e-02   +7.349553155700178e-03   +4.432131758796561e-02   -1.381116032900083e-02; +5.316420314031494e-02   +3.175000416257277e-02   +1.023717209500044e-02   +5.090297020714964e-02   +6.197350940407558e-02   +8.632570802608459e-02; +3.608070353587232e-02   +6.241043578395367e-02   +9.944646824652642e-02   +1.016088654495051e-01   +7.025890752192568e-02   +9.567702036692151e-02; +1.457663805567230e-02   +1.229140697800947e-02   +4.825063187720075e-02   -3.649766411874273e-02   +8.231918061597149e-03   -4.103161886741611e-02; -3.972002888063570e-02   +2.325156926955063e-03   +1.666350951340200e-01   +1.048221886034176e-01   +6.202947841051552e-02   +3.488366582978802e-02; -1.510828436692872e-02   +2.976863851722396e-02   +2.915463866113432e-02   +1.128109913942633e-01   +4.457567608045358e-02   +2.827436334730203e-02; -4.080026577037230e-02   +8.001685911276646e-02   -6.880854217067095e-02   +3.575244044478285e-02   +8.732148628752558e-02   -4.646680696740352e-02; +4.643246674273446e-03   -2.148314056026467e-02   +4.541078786301581e-02   +1.471864714804142e-02   -6.466266460429723e-02   -4.584974486635187e-02; +3.915850852520295e-02   +7.191908084464491e-02   +9.565475800430377e-02   +1.689342829661315e-01   +9.976042326007110e-02   +1.382375045982230e-02; +1.253764425816035e-01   +7.025514804299113e-02   +4.139343830142764e-02   -2.763000042817230e-03   -1.553433054374181e-02   +4.377196710871699e-02; +8.246593928506402e-02   +7.887973642717890e-02   +1.649897868238211e-02   -3.128146747299648e-03   +2.106779328366285e-02   +4.524327829822847e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
