function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.930149189695150e-01   -3.014377429498258e-02   +4.167190450711074e-01   +2.683269025778793e-02   +4.042640281362845e-01   +4.575436535810938e-01   +1.647350980110872e-01   +5.712841305699973e-01   +4.343325015541943e-01; +2.401581622512706e-01   -5.641929641101762e-02   -1.844781965592222e-01   +1.791849850234074e-01   -2.340994342023908e-01   -2.371403179249480e-02   +1.250866940137635e-01   +1.265439579754381e-01   -1.709276113980387e-01; +1.469192898110335e-01   +4.375164746414793e-02   -1.351977315903970e-01   -1.202316182861032e-01   +3.270478528826385e-01   -5.471433556937620e-02   +4.782031040881450e-01   +7.223448807947400e-01   -4.360225500791146e-01; +8.198523320909612e-03   -1.395954738289182e-01   +2.143028138624029e-01   +4.768012688093063e-01   +1.637007833613555e-01   +3.422004898109433e-01   +2.821849875378569e-01   +4.163462217173760e-01   +5.486334387907950e-01; -3.005125257986492e-01   +3.044700068903182e-01   -2.340207818001369e-02   +3.268484344312715e-02   -1.415345955773666e-01   +1.552153393774980e-01   +1.130431885160477e-01   +4.465417467725252e-01   -1.427497698879782e-02; -7.216523952242798e-02   +2.828589233594945e-01   +7.809304541285980e-01   +6.355107425774493e-01   +4.552626669083363e-01   +5.003474588337326e-01   +1.701149545256286e-01   +1.765260280664863e-01   +1.204267727116948e-01; -1.384993419461614e-01   +3.140764476439462e-01   +8.857061139823357e-03   +9.358186669612913e-01   +4.066604134409292e-01   -4.941058482945607e-01   +3.289289750851325e-01   +2.473510301465629e-01   +5.043736942737173e-01; +3.420204347605797e-01   -2.637327347809693e-01   +3.704318954367107e-01   +5.179191888050975e-01   -2.694764146954494e-02   +4.506135872676908e-01   +4.147316301496362e-01   -1.781156281664682e-01   -4.204387103595179e-01; +1.000000000000000e+00   -1.640594944653536e-01   +3.364470679341962e-01   +3.903305959188814e-01   +4.530444452238275e-01   -4.940979833314115e-02   +7.202645150548859e-01   -2.982131365418181e-01   +2.726095130749198e-01];
L1_L2_iAMPA_netcon = [+5.643172549220541e-01   +1.870570973207054e-01   -5.604935648492384e-01   +5.908192683422726e-01   +3.572459847183219e-01   +4.691900622203029e-01   +2.135222754206011e-01   +2.864798325440976e-01   +1.957799191806540e-01; -1.115541603406917e-01   -8.273511143986750e-02   +3.153997387174934e-01   +1.893959655267320e-01   +6.955462818219799e-02   +6.561831465684205e-01   +2.195765051186762e-01   +9.322994669249932e-02   -9.425678609805760e-02; +1.744586844965835e-01   +6.093000428955415e-01   -9.538981376893130e-04   +3.251717412818175e-01   -1.179842883647520e-01   +2.483384379852966e-01   -5.525866641936691e-02   -2.730327703225289e-01   -3.336734413000489e-01; +2.589918546277248e-02   +5.866619440411125e-01   -1.191188044666769e-01   -9.155352831496290e-02   +5.883697685970336e-01   +4.916274882687975e-01   +3.101830724046390e-01   +4.964751876996804e-01   +7.228569644798025e-01; +2.380424000891092e-01   -9.412875040964076e-02   -2.217430345138019e-01   +1.180935700524874e-01   -3.871246471056419e-01   +3.816402388191031e-02   +1.108283852327765e-01   +5.225476221892689e-01   +1.261032013741912e-01; +2.054026414615382e-01   +7.713578138127406e-01   +4.424718075445963e-01   +3.079134973562156e-01   +4.904896551163996e-01   +2.804288067237974e-01   -2.650140603804539e-01   +3.488795933296153e-01   -3.532359363159202e-01; +2.617148875784314e-01   +1.731980650751169e-01   +1.801209650253702e-01   +1.219078338013435e-03   +1.090307732155062e-02   -4.256144249310096e-01   +2.890552279785106e-01   +1.250044322982312e-01   +4.469517583176442e-01; +8.226731117277728e-01   +5.007768536387727e-01   +3.442242629275616e-01   +6.332569454426232e-01   +3.364858462747636e-01   -3.748458151882910e-01   -6.261990112593342e-01   +4.349098640333834e-01   +6.061376408676039e-01; -1.794509325996925e-01   +4.071176341717646e-01   +1.751701533239427e-01   +2.230094529736780e-01   +3.229671970065565e-01   -4.319963321468501e-01   +1.306564887402786e-01   +2.167505653352922e-02   +5.703188803397006e-01];
L2_L5_iAMPA_netcon = [-4.677585592371428e-01   -8.997008206170112e-02   +5.608079357292324e-01   +4.389965955177917e-01   +7.372914467454775e-02   +6.299848797539611e-01   +7.001883139108837e-01   +3.497167262586094e-01   +3.098420263423632e-01; +1.609714782293578e-02   +6.711794132037350e-01   +2.900974800000684e-01   +1.094302657674371e-01   -8.395713807090283e-03   -5.086946800651867e-02   +1.654393803058116e-01   +3.920667175086012e-01   +3.136026014616180e-01; +2.430064207021198e-01   +2.702616448890815e-01   +3.117687049089599e-02   +6.102921095506710e-01   -3.054435524451548e-01   +2.949745101695192e-01   +3.440190319355523e-01   +3.970125618045179e-01   +5.080639405276345e-01; +5.860316064440313e-01   +4.279038779818853e-01   +2.667936984536904e-01   +1.517619375753913e-01   -4.264466175422160e-01   +3.503730698165161e-01   +8.057360557893944e-01   +6.899197704186433e-01   +3.435611068687033e-01; +2.231057729869771e-01   +4.217720450304807e-01   +8.517947130137735e-01   +1.618609936433517e-01   +1.607525022311064e-01   +2.776945899786951e-01   +7.248229523399659e-01   -3.172515658118581e-01   +2.436334479589457e-01; -2.312670405378367e-01   +5.270911460528214e-01   +5.188356136751212e-01   +3.391674082819189e-01   -2.122124629994035e-01   +4.065288702721338e-01   +2.962773751937926e-01   -1.952597949374482e-01   -1.446032570345185e-01];
L5_L2_iGABA_netcon = [+7.903655185730035e-02   +1.881981691404494e-01   -1.272411503501225e-01   +2.416905342636248e-01   +2.040514239622536e-01   +1.065708952615394e-01; +1.000000000000000e+00   -4.954171571334404e-02   -3.024079500810785e-01   +3.124944002519857e-01   +5.715148535841339e-01   +5.113790854974741e-01; +3.000442315886828e-01   +4.135248318224703e-02   +1.593537204217198e-01   +2.587233190280934e-01   +2.273251996987375e-01   -2.197132948463217e-01; -5.340499431745096e-01   +7.269189305196555e-01   -4.088456522325445e-01   -2.431133672455409e-02   +4.107388273480249e-01   +1.337763186121753e-02; +4.823676206071958e-01   +3.298059080696402e-01   +2.446659197954908e-01   +9.521716974580124e-02   +5.333928304027337e-01   +3.397323992835059e-02; -1.742167876309741e-01   -3.607961586504177e-01   +6.632627090101562e-01   +3.694494234789721e-01   -7.161080562085759e-02   +3.072377399060993e-01; +8.664189866134953e-01   -2.903255301030136e-02   +3.841720575760595e-01   +4.037849210238209e-01   +3.330392285121747e-01   +4.000045607889155e-01; +5.010794677462418e-01   +3.947092996873698e-01   +3.256809511002660e-01   +8.019325689510349e-01   -2.338061936977893e-01   +2.375380685510442e-01; +3.113440215973497e-01   +4.702824099011585e-01   +4.845762023054798e-01   -1.329880227360392e-01   -2.936851584052660e-01   +2.300683992611332e-01];
L3_L2_iAMPA_netcon = [-7.558057826311809e-02   +3.882321826969618e-02   -5.244792740253944e-02   +4.664071001434986e-02   +5.355808427948660e-01   +4.661526871185818e-02; +4.199397300870334e-01   +3.447568709928262e-01   +1.335151103866796e-01   +2.075705617990335e-01   +1.057498330815863e-01   -6.033674107312761e-03; +1.322584654694023e-01   +1.551746644447408e-02   -3.750221005565650e-01   +1.583081795068146e-01   +8.299477892999903e-02   +2.716273604181867e-01; +5.341500421712495e-01   -9.961166798018559e-02   -3.257207280230494e-01   +5.389343213269542e-02   +1.000000000000000e+00   -7.897009510680451e-03; +5.200797633172451e-02   +5.010010626409641e-01   -1.776962119817124e-01   +3.885553009105678e-01   +3.165069892386303e-01   +8.037336051971010e-01; +4.382009724878470e-01   +1.602939917091181e-01   +6.535905033328773e-01   +2.002369180974454e-01   +3.812174243107020e-01   -3.987163797857979e-01; +8.215875549863588e-01   +5.664003512296913e-02   +5.619091573153644e-01   +7.279484093025499e-01   +2.974050251994360e-01   +5.958768758154864e-02; +2.055660399494446e-01   +4.144685391989732e-02   +3.070011115485772e-01   +4.007578468910398e-01   +2.037517083667088e-01   +3.973731780499755e-01; +6.798080620586139e-01   +3.497203428413184e-01   -4.231099441690051e-02   -9.847239382175708e-02   +2.984603703772607e-01   -8.331308820595557e-02];
L2_L3_iGABA_netcon = [+6.264116137846059e-01   -2.451938506291964e-01   +7.496903801643354e-02   +5.645636603367084e-01   +8.444576733642565e-01   +4.341078453417813e-02   +3.860539387126477e-01   -1.308671823073511e-01   +4.847671081379233e-01; -3.710632845645273e-01   +6.868648897030507e-01   +1.793105360613971e-01   +2.271416903993208e-01   +8.692962545340928e-01   +1.470252591540430e-01   +6.579364526011213e-01   +9.643318204279618e-01   +6.206507723136188e-01; +7.223744084819969e-02   +1.747156632920398e-01   +3.264602655532504e-01   -7.122392197391497e-03   +4.593601256025622e-01   +2.014167394089348e-01   -1.477010742186667e-01   +6.052500450143362e-01   +7.901098919812672e-01; +3.743960638922662e-01   +3.843083233465894e-01   +1.223855837265677e-01   -1.608732872232781e-01   +1.059067545215327e-01   -4.125081332954736e-01   +2.766908385394771e-01   -2.084552280398571e-01   +4.399493474991185e-01; +3.822732734949817e-01   +6.835989178705649e-01   +4.700929714687082e-01   -1.607319555924910e-01   -1.393972408631740e-03   -3.043144383012567e-01   +2.942196403436716e-01   +3.860975876081523e-01   +2.825554691908476e-01; +7.524947180266667e-01   +3.817174503525226e-01   +2.378175438424494e-01   +9.343187926910467e-01   +7.793399812448580e-01   +3.501345828298020e-01   -1.662148086336204e-01   +2.678840591698177e-01   +2.100093944135822e-02];
L1_L4_iGABA_netcon = [+9.101232175019611e-02   +9.227287209214780e-01   +2.649947491094868e-01   -8.429967014139382e-02   +1.078514851757442e-01   +4.176166777757899e-01   +9.544875413643809e-01   +1.411208317653999e-01   +7.948108478378101e-01; +1.251004488058090e-01   +8.500741938691163e-02   +2.349221187804846e-01   +5.250187900497879e-01   -6.865260491176864e-02   +5.689867393757242e-01   +5.748906217864235e-02   +3.998658332756392e-01   +4.501079051742902e-02; +1.008118978440847e-01   +1.999219669560404e-01   +2.293375580980191e-01   +1.775694093307231e-01   +6.423004217860552e-01   +9.220281743443481e-01   +2.627235169724365e-01   +2.575722755836648e-01   +2.390598987926129e-01; -1.429474704403351e-02   +3.839169225249935e-01   -2.524859218958695e-01   -2.671866619190835e-02   +2.737523779136549e-02   +3.157311365602746e-01   +2.302384578566179e-01   +5.051453018673048e-01   +9.879989327439266e-02; -3.907543474855963e-04   -1.746283932043610e-01   +4.579485714462058e-01   +4.783837757074521e-01   +1.011680529038265e-01   -2.518656507551634e-01   +4.430512936469920e-01   +1.392175657212757e-01   -1.962823694893551e-01; +1.533701730831649e-01   +1.543596588314170e-01   -1.808473987915530e-01   +2.362362716312722e-01   +2.755413392722372e-01   -3.845881070874785e-01   -7.472629359177084e-02   +5.244086720075603e-01   +8.835992797062154e-01; +1.101545638258830e-01   +1.000000000000000e+00   -4.491678969627970e-01   +8.011730281015116e-01   +5.154793555085913e-01   +2.047510945289669e-01   +8.904147283868918e-02   +5.497036714375572e-01   +3.643653084306986e-01; -8.319720493875081e-02   +6.633504582892614e-01   -1.636758360137467e-01   +5.540716916368177e-01   +6.031189023520270e-02   +5.572404994889713e-01   +3.571866108458021e-01   +1.455457652020763e-01   +1.836208806481973e-01; +1.119078645606283e-01   +2.339750268626461e-01   -2.602901701997219e-01   -8.323568394603070e-02   -9.738216567188096e-02   +1.768836578108576e-01   +1.774446578748990e-01   +2.670583793075673e-01   -1.325728625091915e-01; -8.240776356153055e-02   +5.426538712584875e-01   +3.345531192755672e-01   -4.526170653492271e-01   +3.150952269412662e-01   +2.149914244871944e-01   +9.604743340167052e-02   +3.404784268310573e-01   +4.802007891016987e-01; +2.203336675190626e-01   +1.552192024781976e-01   +5.221060726099584e-01   +1.675574489193466e-01   -3.277825473211658e-02   +2.112551649813808e-01   -9.694878012583912e-02   -1.400816050447656e-01   +4.578851532129373e-01; +2.374087638325320e-01   -2.144513171096458e-01   -9.586460853877165e-03   +2.905041867453118e-01   +4.296844534302531e-01   -1.147880641591155e-01   +7.477141344912378e-01   +3.871623735530553e-01   +1.539830630039243e-01];
L4_L1_iAMPA_netcon = [+7.473319939839468e-02   -1.655231546059842e-01   +2.868510269430448e-01   +4.219112845404819e-01   +4.997287378900629e-01   +7.904262537332684e-01   +2.745375586635226e-01   +6.988625465622013e-01   +1.790148468655967e-01   +4.147347011235425e-02   +1.196894168850985e-01   +2.154970810851391e-01; +2.552532973978608e-01   -5.187935025456361e-01   +4.431046386405713e-01   -1.891686682989607e-02   +2.551945086006315e-01   -3.843747984723719e-02   +5.377688905641671e-01   -1.581725166786252e-01   +2.850014723256399e-01   +2.733954799062693e-01   +5.932963047604622e-01   +3.607129359613134e-01; -1.556167741392697e-01   -1.105435576394250e-01   +2.722193502675614e-01   +6.617840588755302e-01   -2.032242050194467e-02   -3.670133314631104e-01   -2.052182919504220e-01   +1.890069172587834e-01   +5.631071531922943e-01   +1.280635249187966e-01   -6.043130719411068e-01   +5.470873618467668e-01; -4.662539421169962e-02   +2.152008180193293e-01   +1.108214123031310e-02   +6.558309153833267e-01   -2.602947385673608e-01   +6.328384498946555e-01   +3.892171004492404e-01   +9.381221741542725e-02   +4.172137273936106e-01   +6.355702025179646e-03   +5.501354239083674e-01   +2.550498813847534e-01; -2.849787232296828e-01   +6.345375844805082e-01   +5.890095364632909e-01   +5.663701552769306e-01   +6.564596492044963e-02   +1.000000000000000e+00   -3.420513763378932e-01   +6.370401990307757e-01   +1.568421292939658e-01   +1.751317525484240e-01   +1.933317398510180e-01   +7.442827534268387e-01; +3.877814935354746e-01   +2.566126444486724e-01   +1.204321537911727e-01   -1.811412478022597e-02   +1.804560641967259e-01   +6.555740279323184e-01   +2.416653667226087e-01   +1.043662273856345e-01   -1.905011957019053e-01   +2.353740962957787e-01   +5.675371135245740e-01   +2.467351514148055e-01; -2.602126963317068e-01   -9.366763165409674e-02   -2.250338187602930e-02   +5.650884766434427e-02   -5.952739336946793e-02   +2.071637662833076e-01   +3.026268807944906e-01   +5.072623054118152e-01   -5.528809860732414e-01   +7.288523885124677e-02   +8.967033749555869e-01   +9.496742856476418e-01; +3.902433340270373e-01   +2.863923357476124e-01   +7.359824725839322e-02   -1.889310158953542e-01   +4.010648357696346e-01   +4.357282421806637e-01   -2.876993271146332e-01   +9.537946768082435e-02   +1.888170398440256e-01   +3.321611774914245e-01   +2.063827055478166e-01   -2.673910314959545e-01; +3.924728590164809e-01   -9.539902679240961e-02   +1.555421261012089e-02   +8.168911077982435e-01   +1.920098735069036e-01   +3.977357355691656e-01   +2.571704579600392e-01   +5.314769641656865e-01   -2.705721656183777e-01   +1.881168987276332e-01   -5.160018532765947e-02   +2.884710518093299e-01];
L1_L3_iAMPA_netcon = [+2.827628534058408e-01   +7.008039227222854e-01   +3.132134485373577e-01   -1.471260222689591e-03   +4.412709721677317e-01   +3.802132213847121e-01   +1.706959979863084e-01   +7.264056909171095e-01   -1.090478455783749e-01; +2.914035120439710e-01   +7.496888389793993e-02   +5.607933537151173e-01   -3.422054858942564e-02   +1.983066434191025e-01   -2.353804587629802e-01   +3.373534596588971e-01   +6.383103344094296e-01   +2.439710256739987e-01; -1.288458134967396e-01   +1.278507240860996e-01   +1.292030834565064e-01   +3.865038332670844e-01   +4.617405149456014e-01   -2.345140273657218e-01   +1.170494935225051e-01   +3.214091240424011e-01   +4.908929757389598e-01; +8.590465520738422e-02   +8.393839986465515e-02   +1.256035921189732e-01   +5.390226037198339e-01   +4.483727655158580e-01   -2.298715959604107e-01   -4.600199626197551e-02   +8.839774072382316e-02   +2.843887806641859e-02; +4.380772915409286e-01   +8.555333338551070e-01   +1.609747669825879e-01   +5.052477614277651e-01   -3.300469537855650e-01   -2.065493898675539e-01   +2.758643357090053e-01   +4.267472541389273e-01   -3.895752746576150e-02; +8.221507993128396e-01   +2.753040014261640e-01   +2.111362906274771e-01   -2.855995317750940e-01   +9.066875534409924e-01   +4.040670777608280e-01   +4.364537227149173e-01   +8.047711678893489e-01   +1.058460019410055e-01];
L3_L1_iGABA_netcon = [+1.099988448526673e-01   -3.963143533845719e-02   -8.829112692553602e-02   +2.766105019235207e-01   +1.279138702283665e-01   -3.992910836862542e-01; -1.863371727996392e-02   +1.807845714514588e-01   +7.546371399000307e-02   -5.150261566446636e-01   +1.605512913461348e-01   +8.027049569648673e-01; +3.551428619996450e-01   +3.141085101451526e-01   +4.120307071642299e-01   -6.376195329057448e-01   +1.473861086408355e-01   +9.059712680762728e-02; +1.339215368283537e-02   +3.853097300550138e-01   -5.302514754963400e-01   -2.513718724498265e-01   +2.616456215545337e-01   +5.198501605673643e-01; +5.464463291890193e-01   +2.946158365386984e-01   +4.425429304922441e-01   -2.440709565690244e-01   -2.482390735176344e-01   +1.000000000000000e+00; +1.280047753971841e-01   +8.332305377392420e-02   -1.768189503027600e-01   -2.142058668112841e-02   +9.352545321587973e-02   +2.319833775586297e-01; -2.129973097190973e-01   -4.701385058255896e-01   +5.466260386075814e-02   -2.117659725021698e-04   +2.349434111983544e-01   -4.643249993064012e-01; -1.547453590725481e-01   +1.763345595449485e-01   +6.270852721778355e-01   +1.723266799134105e-01   -7.427466965629652e-02   -3.577457607061697e-02; -1.724905016412417e-02   +2.642751732055522e-01   -1.119253883388819e-01   +5.024865608731136e-01   -3.105057462308317e-02   -3.176161121960067e-01];
L5_Input1_iAMPA_netcon = [-4.426749939371080e-02   +1.619826675800119e-01   -6.141458220456836e-02   +3.543094331649040e-01   +1.999203804201993e-01   -1.003246592396330e-01];
L6_Input2_iAMPA_netcon = [+4.081645823830610e-01   +4.963532728658339e-01   -1.692378018202634e-01   +2.235548660405279e-01   +4.233266438818934e-01   +1.574231808295266e-01];
L5_L6_iAMPA_netcon = [+2.654133617317115e-01   +4.334809356114949e-01   +6.244109202690220e-01   -3.447890051181574e-02   -1.180572596826190e-03   -7.302172559991993e-05; +5.311382728338553e-01   +4.394454646416759e-01   +8.088610170048420e-01   +3.000499089430334e-01   +4.608289718672008e-01   -2.945600432213223e-01; +3.563403112958086e-01   +3.143833433294264e-01   +5.988194362763327e-01   +2.955096294790368e-01   +7.269291511474157e-01   -1.796498537204612e-01; +1.653950130428331e-01   +3.480769577098384e-01   +6.219936352049946e-01   -9.044336662631525e-02   -3.147949278547209e-01   +4.442868557006887e-01; +3.643640418457834e-01   +1.891146408000301e-01   +5.319998561138550e-02   +6.856522840374512e-01   -2.145376094397948e-01   +2.271311081564905e-01; +1.435730288143607e-01   +2.044394085936790e-01   +3.088940179574604e-01   -1.354399966666014e-01   +3.309659867362792e-01   +6.308889322737025e-01];
L4_L5_iGABA_netcon = [+1.909324051427654e-01   +2.243120267170221e-01   +5.085176622547298e-01   -8.282211533795045e-02   -2.554611335136004e-01   +4.311422039703837e-01   +5.691743467196947e-02   +7.884084012154049e-01   +3.329194829761298e-01   +1.338556773958263e-01   +3.418984022440633e-01   -3.952455344803699e-01; +3.481759836576627e-01   +5.871207399144318e-01   +8.405209858040572e-01   -1.014485063727691e-01   +3.453342604126327e-01   +2.548404160439396e-01   +3.900962023517778e-01   -6.909629464673826e-02   +1.678247943769403e-01   +4.784973370336378e-02   +9.921766283151334e-01   +1.153650637110346e-01; +3.955966750927224e-01   +3.862634377707901e-01   +2.202616069903517e-01   -3.518427493328316e-02   -2.128645647478686e-01   +3.796471738395550e-01   +1.602743270905218e-02   +5.186581804593079e-01   +3.869771461985024e-01   +1.762475574053997e-01   +4.184523045380280e-01   +5.218622480804267e-01; +4.664041725139647e-01   -1.089744531558939e-01   +3.635568352600058e-01   +4.273097045549767e-01   +8.815965571708489e-01   +2.490432429197619e-01   +3.699589569806226e-01   +3.949784214374931e-01   +1.148826549792167e-01   +7.880646066300062e-01   +5.761645760299311e-01   +3.026777945014785e-01; +1.191077637763167e-01   -7.948467141573867e-02   +8.198874865525735e-02   +5.511235187974599e-02   +8.054531559282848e-01   +2.136422665421540e-01   +1.578226089809464e-01   +7.154684964072830e-01   +5.931037464131655e-01   +3.214488842200633e-01   -6.614992799913283e-02   -1.545062897603636e-01; +5.787202349524013e-01   +6.482534701305515e-01   +2.789635138302858e-02   -4.721046752713896e-01   +4.042894966283146e-01   +3.773453081806053e-01   +2.942034812393696e-02   +9.256505217218993e-01   +3.817776224011096e-02   -7.523241768727507e-02   +3.279884488753819e-01   +1.388032716556001e-01];
L6_L4_iAMPA_netcon = [-2.302783740162406e-01   -4.081573914261574e-01   +4.547052120645396e-02   -1.178112587535045e-01   +3.955833346237427e-01   -3.392400593843204e-01; +2.678414696112201e-02   +1.254644240709300e-01   -6.555962365833889e-02   -8.973003784608896e-02   -1.005334047759442e-02   +2.196506023768131e-01; +3.998959131374197e-01   +5.711706788731491e-01   -5.014861661194202e-01   -2.690125274834306e-01   -2.499621231334427e-01   +5.775680872520463e-01; +1.287592126247857e-01   +5.720582104177552e-04   +4.713520864314156e-01   -1.732046573507201e-02   -2.208233468818908e-01   +6.327910113329450e-01; +5.391885638056202e-01   +5.833374346957356e-01   +4.834837012080380e-01   +5.118532499138496e-01   -1.612784006799678e-01   +8.111149855111797e-02; -4.750265790701493e-01   -9.386278256701561e-02   +4.114286588540924e-01   -1.025802765685675e-01   +1.761505058668397e-01   +1.259001005777323e-01; +3.572839720600739e-01   +1.222518696796947e-01   +4.736174440890481e-02   -5.467752868804051e-02   -3.136726294609335e-01   +6.014459913359675e-01; +2.494131358952755e-01   +5.224454796447926e-01   +2.817364787808131e-01   +6.362762526367404e-01   +7.048084248862978e-02   -4.253009758276866e-02; +4.350366585218996e-01   -2.650914000653565e-01   +6.048082115275888e-01   +4.907992671177096e-01   -5.816484472181406e-02   +2.806383712363281e-01; +5.031864805480881e-01   +1.676242412740365e-01   -1.472647359719775e-01   +1.141646774880313e-01   +5.121123022360670e-01   +2.208607535907968e-01; +7.391383039603042e-01   +2.622113762282832e-01   +6.192691615329521e-01   +2.401720494839934e-01   +5.829800828552208e-01   +1.000000000000000e+00; +3.683459437981380e-01   +1.018748235398178e-01   +4.439944313236860e-01   -9.495655354881828e-02   +2.725764733837390e-01   +2.719968881400954e-01];
L5_L4_iAMPA_netcon = [+2.110941549150360e-01   +1.208531068998618e-01   -1.574213177305338e-01   +1.634971054509810e-01   +3.279356985373920e-01   -2.104302619493934e-01; +3.091181891761473e-01   -1.324162816185932e-01   +1.251071103309876e-01   +1.903500077861647e-01   +3.090537414047010e-01   +8.401367805306741e-01; +1.256546728083863e-02   +5.914853505147505e-01   -7.637868436050302e-02   +5.862812438422615e-01   -5.078629602322992e-01   +4.372194645694913e-01; +1.115217312641037e-01   +2.340233545372589e-01   -2.815148136142442e-01   +2.719551467342150e-01   +4.049973043449581e-01   +6.223388235591966e-01; +5.401069313898975e-02   +4.873666861436351e-01   +4.369367563221425e-01   +2.237873329531695e-01   -3.320552285432379e-01   -3.055631973388393e-02; +6.922319292433565e-01   +2.120310841892863e-01   +8.036514868243301e-01   -1.018557143258374e-01   +1.906315263318743e-02   +4.860764871150328e-02; +1.590346195202101e-01   +5.457510425522084e-01   +2.530186640240969e-01   +6.337517434630767e-02   -5.588357979554371e-01   -4.696345450106899e-01; +1.866966069370538e-01   +7.690334987733474e-01   +5.575750921523283e-01   +4.288699350093019e-01   +4.503004411641463e-01   +5.035204895954473e-01; +4.155388566265241e-01   +7.046828586842576e-01   +4.046817035503800e-02   -9.524184624893212e-02   +3.107857643240150e-01   -2.253013268392636e-01; +7.692724998428383e-01   +1.172156806322993e-01   -8.091004073565958e-02   -1.352012821302063e-01   -9.819966205157907e-02   -2.504300664184330e-01; +5.704926088308246e-01   -1.301817075914014e-01   +2.106848944527591e-01   +6.118348728354733e-01   -6.851050277967863e-02   +1.555774261304785e-01; +6.892920278300569e-01   +4.461990370995502e-01   +9.745927481365943e-02   +6.035329043179561e-01   -5.520668687495571e-01   +3.829582704395224e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
