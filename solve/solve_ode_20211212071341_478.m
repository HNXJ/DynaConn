function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.164224428233828e-01   -5.413725045089733e-02   -1.066949152967412e-01   +9.710485738362841e-02   +2.081169277501390e-02   -5.966718406040465e-02   +1.738977162467252e-02   -8.796288339838831e-02   +4.834547008465476e-02; +3.816127739673015e-02   +1.316948828897753e-01   -1.523887775998949e-02   +7.522481992045364e-02   +4.595391308505926e-02   -3.521978004687534e-02   +1.971949371548645e-01   +2.452251150401644e-02   +6.555489302236735e-02; +8.998619976148631e-02   -1.059678162848142e-01   -8.098136114581353e-02   +1.146418779488853e-02   -1.378793619617897e-01   -7.230747232657618e-03   -4.966825446641866e-02   -6.835780463382531e-02   +5.272151965143609e-02; -4.774332386585541e-02   -4.441595720617808e-02   +1.310948436068397e-01   -3.923062054269057e-02   -1.118948764813244e-01   +6.557790561478967e-02   +3.381293856985283e-02   -1.706215097116082e-02   +1.801259925785349e-01; -1.322296944054388e-01   +5.235890745231585e-02   -3.961337771085101e-02   -9.769869631734988e-02   -2.219156114279294e-03   -2.119282455173560e-02   +9.096170357929462e-02   +6.842089636899887e-02   -6.162057127820988e-03; +1.237944451289423e-01   -2.607595071300211e-02   -1.686507480407314e-02   -1.021150205392706e-01   +1.862584173523493e-02   +3.998844461444306e-02   +7.847359160788683e-02   -3.940926595702468e-02   -2.700278573683406e-02; -3.359063907679919e-02   +1.416638044263291e-01   +2.724133249342903e-02   +6.511115353909924e-02   +5.665422098200657e-02   +4.266542975436315e-02   +2.750222342596607e-03   -1.046086655021385e-01   +2.930556069458748e-02; -4.678886557120152e-02   -1.803654762087682e-02   -1.431536720060755e-01   +5.167976539328087e-03   -2.076500430573883e-01   +3.260813684381883e-02   -1.064678496471361e-01   -5.441087635317393e-02   +1.342315408087796e-01; +4.336417241546511e-03   -7.618264096226993e-02   -1.001890506762984e-03   -1.783680046466606e-01   -6.489751377004281e-02   -5.736743545000629e-02   +5.054850516877128e-02   +1.819327501609834e-02   +4.571158175771234e-02];
L1_L2_iAMPA_netcon = [+3.200776355374269e-03   -1.220524525971199e-01   -3.713396969434361e-02   -1.287134707758263e-01   +6.497603189058868e-02   -1.872958254814641e-01   +5.729601076215367e-02   -1.807878948693135e-02   -7.025504965007731e-02; -5.543790586019087e-04   +5.898659641336321e-03   -6.798285743294327e-02   +7.746420068375809e-02   -1.512928426356595e-02   +1.291101910213313e-01   +8.129089726023810e-03   -1.867843734773274e-01   +7.394003862101568e-02; +9.904578932785095e-02   -1.343659458872421e-02   +5.513546769152811e-02   -6.841185137721911e-02   -1.582622092959011e-02   +7.303208401552883e-02   +1.587979111320127e-01   +6.968584523802585e-02   -4.524093964893961e-02; -5.638879076797276e-02   -1.405186124359802e-01   -1.175706904574939e-01   -6.958968346503147e-02   +1.332443670418769e-01   -8.143848409394827e-02   +9.330928629896144e-02   +8.910696363126769e-02   +2.150600487439457e-02; -4.992691135077156e-02   -1.180515276562023e-01   -7.223702025046005e-02   -3.255449808475396e-02   -8.496961252592786e-02   -1.547499833234966e-02   +4.462680029627020e-03   +8.448714394192289e-02   -3.237472323054282e-02; +1.693146509432791e-01   -6.902542550155132e-02   -4.019108364068493e-02   +1.675104543452113e-01   +9.252254130329821e-03   +6.344766634315993e-02   +3.743809518766061e-02   -9.262980371540395e-02   +1.038148827018644e-01; -4.723020759656804e-03   -7.083285207770364e-02   -1.254609373238019e-01   +6.964992688681590e-02   +1.868014755374716e-01   -1.576108429946601e-01   -2.563161954883240e-02   +3.924040196509997e-02   +1.574011557409793e-01; -3.177831910569431e-02   -8.635842351815969e-02   +4.828796981595165e-02   -3.109300525994730e-02   +1.329214780767568e-01   +5.688773283951874e-02   +6.031719572860148e-02   +4.030575745589351e-02   -4.993778477101854e-03; -1.766983022373482e-02   +2.220331023960809e-02   -9.764004166824269e-02   -7.798410873095672e-02   +5.312373785345048e-02   +4.288346308821588e-02   +6.902832880210530e-02   +7.986165529513947e-02   -1.443767863076869e-01];
L2_L5_iAMPA_netcon = [+5.077062594740744e-02   -1.040118957214012e-01   +3.458469147612948e-03   -1.384003581464513e-01   +3.362883586825220e-02   -1.022770822329021e-01   +9.283750157996488e-02   -1.372336596247804e-01   -5.333726304393548e-02; +9.113921866934124e-02   +9.955730456263338e-02   +2.968570759730679e-02   -4.855879329207045e-02   +2.778841814981085e-02   -3.300436660405381e-02   -1.052315540481312e-01   +1.176539109179740e-01   -3.101941943943262e-02; +1.955585333830283e-02   +4.468321266461907e-02   -1.521132078674633e-01   +1.064463573623430e-01   -6.174970874982118e-02   -9.287086924705243e-03   -7.693408563301665e-02   -3.640136261635973e-02   +3.651366355392125e-02; +7.478302108313423e-02   -5.691719795064392e-03   -4.268153387742582e-02   -1.075935984244876e-01   +5.130190734767913e-02   +1.030490548687999e-01   -7.198838865404587e-03   +6.910660062448583e-02   +5.242050128688661e-02; +1.533406765465830e-01   +2.210652564949563e-02   -2.968287072190105e-02   -9.307879133989258e-02   +1.115142160567942e-01   +1.954553958328120e-02   -8.329765661607982e-02   -7.332502024520700e-02   +8.982640185138441e-03; -1.011371830427531e-01   -1.461022726210145e-01   -6.849787759054483e-02   -1.416398609308420e-01   -3.393852115241368e-02   +1.528883605772312e-02   -4.899827800763810e-02   -4.127576609535176e-02   +5.354383118754465e-03];
L5_L2_iGABA_netcon = [-6.357582101988314e-03   -1.070259637017928e-01   -3.048831470199127e-02   -3.833734122264229e-02   -6.910718564414596e-02   -1.093828230749663e-01; +1.295733276426488e-01   -1.224731372638600e-01   -1.787669212922232e-01   -6.816878814764796e-02   -8.655038893788353e-03   -2.310958977952630e-02; -7.091916163699083e-02   +3.205170161681482e-02   +7.232589343750588e-03   +1.830103477837197e-02   +5.558058352917356e-02   -4.175725439329660e-02; +3.984083005071466e-02   -4.188513619590525e-02   +4.900538506801257e-02   -4.257693205446789e-02   +1.011420359262432e-01   +1.330169230224628e-02; +7.610869627730935e-02   -5.600514283617215e-02   -4.646374034215067e-03   -2.176705954532977e-02   -1.313461714044912e-01   -9.433024637017794e-03; -1.048755926730529e-01   +1.270060305269852e-01   +1.259851752173400e-01   +8.153967212521104e-02   -6.981663028297184e-02   -7.105163212893131e-02; +1.185530473606648e-01   -4.896396057375516e-02   -1.499433081610013e-01   -3.219972922803292e-02   -7.565300114535439e-02   +5.099873664004127e-02; -9.812131673642647e-03   -1.131747044389470e-01   -8.368786742168367e-02   +1.230240023360007e-01   +1.569906614281898e-02   -8.296927361315123e-02; +4.278211683036308e-02   -1.010367790847966e-01   +1.216761420867635e-01   +1.304028776547348e-01   -4.586214188908057e-02   -5.431664992946339e-03];
L3_L2_iAMPA_netcon = [-5.266336201213052e-02   -1.093281328197894e-01   -8.392462195396404e-03   -3.011706420039262e-02   -1.312507049033896e-01   +6.484950281274704e-02; -5.298062935859713e-02   +1.474302403524098e-01   -1.829109956028266e-01   +6.042188128607219e-02   +1.549171646116261e-01   +1.537486891561500e-01; +1.111153551834630e-01   -2.478163961243585e-02   +1.818537852888224e-01   -1.336952083573477e-01   +6.171977025466976e-02   -8.937856360941467e-02; -3.381718312589924e-02   +4.249255023701810e-02   -1.054754967458686e-01   +7.596967579790531e-03   +1.981028423393371e-02   -3.376061795464860e-03; -1.373445052102109e-02   +5.678214787537703e-02   +6.712720006694112e-02   -2.978034753973725e-02   -1.234780153120927e-01   +1.413552559411172e-01; -1.589428551825653e-01   -1.814868492670023e-01   -6.154608088877804e-02   +9.737095686576193e-03   -1.657944719179021e-01   +1.061525339967865e-01; -5.187178178274988e-02   +6.897056762511608e-02   +9.671549963847134e-02   +7.547598743360567e-03   +6.519847899304893e-02   -1.094924438591046e-01; +5.002490049957072e-02   +3.913178485166312e-02   -8.325744504605861e-02   -1.326788909093168e-01   -1.421151033783649e-01   +1.914132613069523e-02; -1.701719066313782e-02   +1.085650592114467e-01   +9.003787527382159e-02   +7.750197076900342e-02   -1.268567551792978e-01   +1.190045533307987e-01];
L2_L3_iGABA_netcon = [-1.438267070149523e-01   -6.834548473039392e-03   -3.132336026487242e-02   +1.593758402858678e-01   -1.311374119998464e-01   +5.868213447205537e-03   +1.738777439589921e-01   +3.000570562366043e-02   -5.856754677281209e-03; -4.424514442429546e-02   -1.483167710830531e-01   +1.321105525173929e-02   +8.365560901488786e-02   +3.477807588191571e-02   -1.047720844976914e-01   -6.772767697777650e-02   -9.096051659763346e-02   +5.442365489772914e-03; +4.079523359834681e-02   -4.387374780277015e-03   -1.191299243674315e-01   -1.329859877661826e-01   +4.250827501013688e-02   +5.590895932998205e-02   +5.442299116748871e-02   +9.777823787577456e-03   -6.976089079895131e-02; +1.011051317940091e-01   -7.210501664346954e-02   +7.761435116097289e-03   +8.392866012920427e-02   -7.234852121372498e-02   +7.374204128979021e-02   +1.058338529459273e-01   -3.841225845341786e-02   +1.174237258401356e-01; +1.359402128550746e-01   +6.809133022001444e-03   -8.814923203831106e-02   -4.269944237597281e-02   -1.443803051463266e-01   +6.484921302281533e-03   +6.025000370171452e-02   +3.094476351025501e-02   +5.695505102048911e-02; +7.371359234140749e-02   +1.107764352379536e-01   +9.318963489619043e-02   +4.627857963241098e-02   -1.508558464448423e-01   -5.369054114910465e-02   -8.697827985002772e-02   +1.142439545146423e-01   -6.393234239924972e-02];
L1_L4_iGABA_netcon = [+5.983078322007417e-04   -8.941596752512004e-03   +1.049208354642688e-01   +7.845690216589057e-02   +1.631503227632259e-02   -1.706722732258565e-01   -3.508792187645073e-02   +5.600573600479734e-02   -4.209770124109451e-02; +1.279573431947561e-01   +2.418766179658509e-02   -2.364895092808938e-02   -5.194395172996231e-02   -1.338098659648450e-01   -4.260995030036440e-02   +1.933779141905789e-02   -4.808181883766714e-02   +1.501709033820070e-02; -8.607775020066226e-02   -6.824013428227609e-02   +2.500589611850854e-02   +3.525327147923196e-02   -1.347489757030571e-01   -1.352212556771833e-01   +8.944366054715321e-02   +1.830045932511634e-02   -1.037998877540447e-01; +2.319338664502968e-02   -1.269129567870688e-02   +1.699458098925756e-01   -4.353603105634825e-02   +5.625209471930027e-02   -1.089347223557739e-02   +1.139884910599267e-01   +1.162497368196575e-01   +1.366454032043021e-01; -2.951380810172529e-02   -1.586313299086171e-01   -8.317528805330071e-02   +8.236520446156378e-02   -1.388295168723468e-01   -6.463973653943650e-02   -1.894154727940137e-01   -1.193642110791014e-01   +1.349669437773377e-02; +9.271599816981521e-02   +1.537970650977931e-01   +1.148323331712922e-03   +8.829839575801232e-02   -4.065867326333351e-02   +8.822269310631739e-02   -1.168897788269023e-01   -8.022574949487699e-02   -7.737188924983668e-02; -1.364084665357162e-02   +1.799185861353961e-01   -1.327377524882821e-01   -1.575842180412815e-01   +5.058833334665247e-02   +4.932319960529280e-02   +1.114722207130140e-01   -8.811711185050757e-02   +1.720927400792180e-01; +6.781875421518067e-02   +1.701795304243956e-01   -3.485943084658027e-02   +6.213493224171204e-02   -1.052579957292355e-02   +1.516108027916210e-01   +7.966494139959912e-02   +6.748616283886016e-03   +4.906187831840617e-02; +7.753682736621173e-02   -1.673213248286496e-01   -4.746893031741607e-02   -8.178400091169033e-02   -7.213792526467311e-02   +3.323277577676251e-02   -1.061647318180347e-01   -1.492191543777599e-01   +1.194679699063202e-01; -1.210711711402003e-03   +5.260611538727136e-02   -9.159723106050394e-02   +1.199506346770334e-02   +1.348126940866183e-01   -1.424071626403453e-01   +1.859943266832679e-02   +7.064638676768224e-02   +2.358631693077090e-02; -7.046344300465027e-02   -4.684754019905780e-02   +7.989209016978671e-02   -9.691536656627807e-02   -4.885618116742835e-02   +3.315491923706645e-02   -1.768581661750091e-01   +1.411401076381706e-02   +1.547991594258448e-01; -7.616380604849660e-02   +1.104246113704644e-01   +1.534595833686807e-01   -4.161682943851053e-02   +4.158715021501828e-02   +2.047384030099327e-01   +1.246544899511409e-01   -1.335545375104221e-01   -1.029530266829306e-01];
L4_L1_iAMPA_netcon = [-1.197978003879215e-01   +1.801558902936818e-01   -1.010727939694356e-02   -1.223733888155042e-02   +1.831049111253945e-02   +9.559387995592988e-02   +1.219992615703626e-01   -1.299883764625668e-01   +4.226474969387661e-02   +8.047664158152709e-02   +5.341118352461739e-02   +4.952661587067792e-02; +8.332897911940623e-02   +3.495061705445729e-02   -9.525838402788050e-02   +6.120094330985391e-02   +1.267621606988919e-01   +2.317433249224028e-02   -5.703374943847292e-02   +4.921670517101401e-02   +2.960267800113229e-02   +8.772617330947591e-02   -2.988088048977278e-02   -1.629713123523127e-01; -3.048645040175416e-02   +7.413468624672424e-03   -1.330346216234129e-01   +5.502535620890554e-02   +1.050478410668875e-02   +1.220670170175574e-01   -5.937125737949261e-02   -2.275191322632894e-02   +6.744579627606617e-02   +7.428548200333079e-02   +9.515038701449782e-02   -2.233382669835939e-02; -4.382604520844607e-02   -6.932868277399890e-04   -7.676900013461913e-02   +3.772005503705664e-02   +9.097902769791444e-02   +6.375129010533019e-02   +1.114587702404623e-01   +1.591498148373690e-01   +8.831861300269417e-02   -1.804815224890385e-01   -9.997157290818304e-02   +8.970474057930242e-02; +1.075328737719005e-01   -5.357488736654100e-02   -5.124761826737886e-02   -5.418160107819153e-02   -8.018655494243526e-02   -1.466991229944386e-02   +4.472475018000880e-02   +2.099027601399934e-01   +6.161588280105718e-02   -1.032177358000970e-01   -3.396352479550113e-03   +4.303308074951676e-02; +1.482162973857661e-01   +2.847461855702412e-02   -1.568190838867967e-01   +2.790990620267238e-02   -6.470535324625268e-02   +4.341383048081039e-02   +1.742854166035706e-01   +8.837036731068566e-02   +1.388884598940548e-01   -4.763171216115251e-02   +2.351091335096047e-02   +1.158621564309296e-03; -1.562012536121363e-01   -1.669390188510703e-02   -1.926848680582516e-02   -3.666206528819820e-02   -5.502524581695838e-02   -1.327754903823098e-01   +1.070954023414762e-01   -1.473620347160823e-02   +3.319667881334486e-03   -8.579375426454408e-02   +3.113516255921800e-02   +9.613327445468314e-02; -1.521178106357848e-01   +1.191295218117326e-01   +6.456950259651545e-02   +5.860613134794548e-02   -5.533843284956781e-02   +2.669291221834759e-02   +1.181500820496609e-02   -4.514847604410455e-04   -1.891965601009568e-01   -5.532362743057311e-02   -4.369808128213742e-02   +3.385045322061234e-02; -1.066834674762885e-01   -8.346699289988840e-02   -1.847764247360688e-01   -6.165195798184830e-02   -2.828569763699863e-02   +1.496836577181813e-01   -7.232914116892236e-02   +4.445107361170213e-02   +1.537064654106521e-01   -1.895126119280565e-01   -5.890072683078119e-02   -6.942582476871206e-02];
L1_L3_iAMPA_netcon = [-1.214851308966618e-01   -1.148673762057908e-01   -2.778677054439883e-02   -1.739037078159714e-01   -5.071874660720762e-02   +4.305041955754303e-02   +6.455955762734593e-02   +8.584825347063496e-02   +1.260975611826610e-01; +5.910010553730504e-02   +7.962376595143357e-02   +1.988757044720148e-01   -9.852898635310439e-02   -1.258751988545818e-01   +1.470704158092142e-02   +4.606214107329074e-02   -5.806683427761145e-02   +2.346722275374651e-02; -4.095137344582227e-02   -3.275207468243152e-02   -1.008311329625144e-01   -7.283149204909152e-03   -6.172727056743198e-02   +3.507830869390544e-02   +7.896189224643030e-02   +1.064068892720942e-01   -1.227941285948121e-01; -1.597836399085095e-02   +1.366094797039114e-01   +1.472835748264726e-01   -1.242823018690486e-01   -4.932454916682678e-02   +5.702330105200298e-02   -1.020247391464157e-01   -2.226798850305087e-02   +6.489391124200797e-02; -1.922541929484264e-02   -2.130869199405878e-03   +2.005831945771483e-02   -1.110348441110982e-01   +5.407162499608319e-02   -1.029052145410389e-01   +3.169929325296952e-03   +6.039545743725376e-02   +2.640461728328585e-02; +1.400903915650915e-01   -9.627377237364947e-03   -8.758298225891559e-02   -4.191134029199808e-03   +2.122298719602954e-02   +6.733004187046289e-02   -9.435035599165057e-03   -5.921938997968938e-02   +1.311990151138137e-01];
L3_L1_iGABA_netcon = [+2.986295597571390e-02   -8.071660843613407e-02   -7.372840774205661e-02   -1.510170458928780e-01   -1.528056433586120e-01   +1.451085473353682e-01; -1.710828403120965e-03   -1.386084633220490e-01   +6.936437747625486e-03   -1.328461642301244e-01   -1.054111887923996e-01   +5.146833199629112e-02; +3.774279305792435e-02   +3.840809870829198e-02   +1.582602009763601e-01   +6.238062485190125e-02   +1.015923355479462e-01   -1.103123274934808e-01; +6.086120931621672e-02   +9.766495899246994e-02   +4.937005996147077e-02   +8.546011239640256e-03   -3.895820643235803e-02   -1.197865982303548e-01; -1.097701837604709e-01   -8.094561831360134e-04   -1.238201342559880e-01   +9.059676065134602e-02   -1.712677416873230e-03   +4.419283448398102e-02; -1.526397767452325e-01   -5.640752124500829e-02   -9.956293074881352e-02   -4.224512558420219e-02   -3.539072931213948e-02   +1.048040035386034e-01; +1.293335016834530e-01   +8.976780299886683e-02   -6.269842776740207e-02   -1.059783809611988e-01   +8.717635512627726e-02   -7.708784931889309e-02; +8.467279155885007e-02   -9.355964183527238e-02   -1.156117007389425e-01   -7.479545890243058e-02   -1.001979721159659e-02   +1.652110714676869e-01; -2.252105393887692e-02   +1.251148718788615e-01   +1.011487181786626e-01   -1.186540187989651e-01   -6.997189391762051e-02   +1.762873398571386e-02];
L5_Input1_iAMPA_netcon = [-4.883295671542524e-02   +1.184520497993695e-01   +4.300381027296292e-02   +9.368079502716853e-02   -1.517387233837635e-01   -4.803037543728961e-03];
L6_Input2_iAMPA_netcon = [+5.330254620608574e-03   -2.110436972270134e-02   -5.620159616800863e-02   -1.292838612164257e-01   +1.642478680861993e-01   -9.309025836961231e-02];
L5_L6_iAMPA_netcon = [-9.862862347402263e-02   +1.090260083433443e-01   +1.385435711476097e-01   -3.635114808527262e-02   -1.050534598732590e-01   -2.891710098151352e-02; +2.564747401498406e-02   +3.021964767520966e-02   +4.675236603644613e-02   -5.530895625292546e-02   +7.783990866372524e-02   -2.277458019778894e-02; -8.151368564059010e-02   +2.072335851750690e-02   +5.714117569828672e-03   -4.137808911511619e-02   -6.198762071850408e-02   -6.807302386356875e-02; +5.740276105748171e-02   -1.834659120183387e-02   -4.112862218237097e-02   +3.682163597058832e-02   +1.196107344285635e-01   -4.244229145978148e-02; +4.105969417654264e-02   -4.131351275024620e-04   +4.819149791480178e-03   -3.089656327523780e-02   -8.179121539442283e-02   +5.514061956903043e-02; -3.731976311712021e-03   -6.641418503686590e-02   -9.053912978162870e-02   +1.868677395805387e-01   -1.048632468381823e-01   +1.086115323281553e-02];
L4_L5_iGABA_netcon = [-2.437852095300611e-02   -4.230766201889580e-02   -5.421244961685785e-02   -1.026937966377720e-01   +4.790374859197673e-02   +3.323457383565133e-03   -1.758865910958426e-01   +4.175452385072845e-02   -7.799522412077682e-02   -1.387364841999018e-01   +1.059238476851465e-01   +4.904127901810319e-03; -3.777871180696633e-02   -9.390405169852847e-02   +6.311959584584759e-02   +2.265065525705225e-02   -5.138521677138571e-03   -1.058131011914579e-01   -3.693035113593756e-02   -1.457884195272728e-01   -4.768016447585035e-02   -1.523893886957026e-01   -1.384560703878228e-01   -3.677232856446234e-02; +1.211158541580552e-02   +5.575822154101420e-04   -3.018294920205898e-02   +1.282706652204973e-01   +2.946100482744863e-02   -5.388863263984103e-02   +6.306732637044075e-02   -1.049851664987097e-01   -8.325759684116762e-02   +4.180047623134221e-02   +6.633338848279477e-02   +1.636573386849771e-02; +7.863480585592290e-02   -2.072905140738759e-01   +9.460634430800205e-02   -1.172072032832997e-01   +5.463093513602568e-02   +1.889433915635187e-02   +8.743729030104554e-02   -1.146188696352256e-01   +2.204837741184196e-02   -7.597501225343035e-02   +8.465769818246151e-02   -2.681834119959875e-02; +7.713665231624600e-02   +8.907096755864065e-02   -2.704138680036757e-02   -2.430248320382005e-02   +5.998257083202462e-02   +1.258359390303257e-01   -2.219784487937312e-01   +7.303347077662642e-02   +1.186612111550676e-01   +2.724477262377828e-02   -4.223089716777503e-02   +1.809944703706902e-02; +1.259667079439884e-02   +4.387633967688834e-03   -2.641218021099631e-02   -1.078140099179599e-01   -4.215210598296468e-02   +4.893740893189507e-02   -9.995708951830620e-03   -3.248136421433448e-02   +1.138044126918541e-01   -6.141835058265686e-02   +1.332753564499329e-01   -5.247941903482444e-03];
L6_L4_iAMPA_netcon = [+1.081277080305158e-01   +4.463264766367271e-02   +2.791690838046061e-02   -1.540174276697030e-01   +1.545832872157563e-02   +3.431323348729636e-02; -1.087534011590025e-01   +7.246303643806105e-03   -1.266656445072800e-01   +7.034997495551019e-02   -1.419771702058817e-02   +1.391921920786406e-01; +3.254785573197438e-02   -2.017811444137228e-02   +2.983712877738065e-02   -3.355956564608270e-02   -6.639715321301248e-02   +7.219961177924951e-02; -1.035679509734425e-01   +6.028664976862175e-02   +1.195855253819552e-01   +3.807505895437581e-03   +2.496368489132928e-02   -3.366711834895304e-03; +1.191097877168701e-01   +4.048954148738153e-02   -1.237116531492662e-01   +1.112926073716039e-01   -2.994473884666762e-02   -2.111643768724516e-02; +1.822512601550285e-01   -1.023250598371252e-02   +2.871834991092179e-02   +2.286540135638145e-02   -8.523729202608601e-02   -1.085877488072680e-01; -8.623220011319051e-02   -1.349707937770943e-01   +5.418145134494030e-03   -1.075070530150659e-01   -9.102400414150671e-02   +5.537274388108410e-02; +1.851128837926089e-02   +1.003985320292340e-01   -1.614443455199474e-01   -1.597860230619305e-01   -3.708386466194966e-02   +6.759746877156404e-02; -2.005172110503534e-01   +1.761865576166254e-01   +9.986067718057147e-02   +1.313672103025418e-01   +5.723079192855994e-03   -1.459332034975767e-01; +1.600990879849691e-01   +1.392198375931523e-01   -7.445366980453119e-02   -1.209679062400876e-01   +8.782307143154473e-02   +1.453779258727116e-02; -1.651009453261945e-01   +1.185601608792099e-01   -2.137511542231217e-02   +1.169458071438663e-01   +1.528627011224164e-01   +1.569018211279586e-01; -1.195511608622249e-01   -7.710480500194403e-02   +9.545674670707929e-03   -3.772506209289050e-02   -4.261781060595266e-02   +1.273546971090798e-01];
L5_L4_iAMPA_netcon = [-9.935987339404845e-02   -6.414627116892903e-02   +8.569867827347480e-02   +1.141699823278783e-01   +1.243803010026560e-02   +9.462515484882879e-02; +1.497785816527571e-02   +1.201341647715491e-02   -2.297143444061368e-02   -1.617073952813002e-02   -5.204798776433034e-02   +8.546022740479123e-02; -9.222274030774910e-02   +4.757372022283155e-02   +8.593885130449772e-02   -1.465813904426232e-01   -3.472124769682062e-02   +1.215225172807579e-01; -1.748280793433533e-01   -7.202053165951368e-02   +1.276785469068761e-01   -8.099095598791428e-02   +3.508158510502002e-02   +7.473683892276668e-02; -1.215809666043570e-01   +2.599175750928836e-02   -5.888702332318077e-02   -5.875174892075598e-02   -7.465771878285318e-02   -1.778555118714462e-02; +1.504589852758344e-02   -2.466428117130694e-02   -3.644336810632415e-02   -1.481340337937292e-01   +9.275660841152174e-03   -6.109128935423591e-02; -4.267346836447327e-02   +2.807417481545740e-02   -5.908700299959359e-02   +5.326952881615916e-02   +7.274644543253561e-02   -7.378902356754999e-02; +1.542281244015249e-01   -4.880362309683179e-02   -1.064154432885000e-01   +4.364491000362582e-02   -4.548833155381311e-02   +8.882314931408067e-02; +2.887059839598173e-03   +1.089081844983359e-02   -1.289803602837201e-01   -5.671381982329525e-02   -1.167354337421634e-01   -1.928269426356943e-02; -4.999491199739863e-02   -1.020284501917430e-01   -1.887473532028661e-03   -1.024940731180607e-01   +1.444156714239635e-02   +2.710421434223897e-02; +4.767463003423700e-02   +4.529537662078646e-02   +1.604993648139232e-01   +7.790445745151268e-02   -1.025709428179470e-01   -5.220286606129006e-02; +7.813464293545386e-02   +1.024907780431894e-01   -1.064995457327772e-01   +4.669903391176101e-02   +3.566544412996962e-02   +6.388319023695263e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
