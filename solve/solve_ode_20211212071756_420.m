function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.615660892654266e-02   -6.656048857891902e-02   -2.481801572743388e-02   -3.018857022908384e-02   +8.520517747276282e-02   +1.966614611164720e-02   -7.978338134199894e-02   -4.619803397113294e-02   -6.491752289535072e-02; -6.331496006500103e-03   +1.550324455647766e-01   -4.578115068676109e-02   -4.662269076691386e-02   -4.970289925614899e-02   +8.834656172296619e-02   +3.232988089172886e-02   -4.175413031209822e-02   +1.184524908761480e-01; +2.458477834170404e-02   +5.306178085234971e-02   -2.141781008965485e-02   +4.952625027904101e-02   -1.317134015739501e-01   -3.886361661857778e-02   +4.315670823454939e-03   +9.212626250497742e-03   +6.423328276579070e-02; +4.488969018037871e-02   +5.343276692020115e-03   +2.566566466709113e-02   -8.080700260362456e-02   -8.683121360407439e-02   -1.384747834482951e-02   -6.080363628879410e-02   -4.892670213362846e-02   +5.069984533204740e-02; -2.246989075204716e-02   -5.925988526425717e-02   -2.438733831418091e-02   -2.252956898726121e-02   +6.172983996560904e-02   -9.471384157878956e-02   +1.687984397402250e-01   +1.040745345577505e-01   -1.108533750041949e-01; +1.584527818896904e-01   -6.330618269764116e-02   +8.606395877872879e-04   -6.762195628774233e-02   +1.433991584468573e-02   +6.337121408120046e-03   -2.277463706769236e-02   -8.952947089263133e-02   -1.061335480629523e-01; -6.282710342836353e-02   -2.605500775865324e-03   +4.236612547026385e-02   -4.657210646855212e-02   +1.371254377115266e-02   +2.263287582696816e-02   +7.707096679379309e-02   +2.166457670703482e-02   +3.612474201471827e-02; -7.442783956420593e-02   +1.215038390473985e-02   -9.068082962613172e-02   +5.099233662682820e-04   -1.621381654257260e-01   -1.024026747391974e-01   -5.283066725162712e-03   -1.087592174010264e-02   +9.135346543326885e-02; -1.211581754638227e-01   -1.088970668301750e-01   +7.382769247673823e-02   -2.605389892947683e-02   +4.329552374602544e-02   -1.204296373967836e-01   +8.832051430221202e-02   -5.711859743686126e-03   +7.225319908263411e-02];
L1_L2_iAMPA_netcon = [-5.556987187802147e-02   -1.054330762084302e-01   -2.308536419096210e-02   -1.295449203258706e-01   -3.980040556525124e-02   -6.873904867120967e-02   +6.162776819483002e-02   -6.911197956116677e-02   +3.005753497093324e-02; +7.180235586458689e-02   +1.152633620439332e-01   -9.633128049200013e-02   -4.829737362421471e-02   -5.185813045053047e-02   +1.094335367777309e-02   +5.402059359138187e-02   -1.816452388693258e-01   -5.427433376478479e-02; -5.340763467571175e-02   -4.226818944941045e-02   +6.100467487183969e-02   -5.038389744677347e-03   +2.812342133081317e-02   +1.157145203233730e-01   +1.087014895942329e-01   -5.789165798919906e-02   +5.249869856639598e-02; +1.164815209847463e-02   -1.638494977703543e-01   -1.492887616043443e-01   -8.832818210266945e-02   -3.325038332849187e-02   -4.550775478538958e-02   +1.345218026942492e-01   +1.618550543779800e-01   -6.734202787887006e-04; -6.705962688329882e-02   +3.414100960379865e-02   -9.227346898506231e-02   -1.117719698986877e-01   -1.212564947493240e-01   -6.634065726048211e-02   -6.067064791317058e-02   +2.416159051227392e-02   +2.561784396208907e-03; +1.716227578289447e-02   +3.399017810927928e-02   +1.013543380291133e-02   +3.539857002085500e-02   +9.263770765289696e-02   -1.796977313845056e-02   +1.102339832427991e-01   -1.135457390084008e-02   -7.978725860294297e-03; -5.291938134213289e-02   +4.283824324267941e-02   -1.385324789078080e-01   +6.637788065914439e-02   +2.082460319377155e-01   -3.160645749147978e-02   +3.391322824863542e-02   +6.110657144229460e-02   +1.677601748436147e-03; -3.235696436714108e-02   -1.039623120728657e-02   +4.376196898143633e-02   -9.886040421761545e-02   +1.540563276285078e-01   +5.690689393208784e-02   -4.730734315451939e-02   +1.168387349436688e-01   +7.361913102632209e-03; -5.381866876024693e-02   +9.017938390464678e-02   -1.612645977814748e-01   -8.481262986807150e-03   +4.730286654996234e-02   +3.485143578525910e-02   +1.656813044744277e-01   +2.193300134128332e-02   -2.330129009683760e-02];
L2_L5_iAMPA_netcon = [-1.483286162619699e-03   -1.269720031679543e-01   +8.707893900590463e-02   -4.554888035252948e-02   -3.992679275626557e-03   -1.117359629409850e-01   +1.696525515336053e-01   -1.221047544706540e-01   -3.154019330113864e-03; +1.469943308953388e-02   +5.030938467551486e-02   -3.071688014980866e-02   +1.615564256902261e-02   -2.076000150246438e-02   +8.036422780270915e-03   +3.386731167605744e-03   +6.231111985680315e-02   +7.329736548805784e-03; -8.736825341621934e-02   -2.947411011511104e-02   -1.094165773348219e-01   +7.553543529047707e-02   -1.009153561802298e-01   -1.415190279546953e-02   +3.828522875107572e-02   +1.214949805491033e-02   +5.836513137935727e-02; -3.952491437296273e-02   +9.378441962028243e-02   +4.455939386504716e-03   -1.235983810454025e-01   +1.114449775656583e-01   +1.399704799871263e-01   -7.243307629659954e-02   +5.473290888592566e-02   -8.620913896233436e-02; +1.003885893967368e-01   -8.467866416933803e-03   +5.956351510881748e-02   -4.565642159075153e-02   +6.099318269908378e-02   -3.304995304954378e-02   -9.508612950034073e-02   +6.952857679482834e-02   +5.478780405827330e-02; -1.021734163395349e-02   -3.829424303345399e-02   +3.508468750895494e-02   -1.261333910965647e-01   -1.754430655425019e-02   -7.372463718538315e-02   +3.401042399632995e-02   +1.296543385256634e-02   +3.921621573938858e-03];
L5_L2_iGABA_netcon = [+1.725653432959654e-02   -3.568589717687792e-02   -1.882978564696802e-02   +7.708978531258934e-02   -1.909658010758445e-02   -3.946350384437715e-02; -2.254698243410555e-02   -1.548030776174749e-01   -1.027613975497523e-01   -1.333441977758242e-01   +2.303626325034481e-02   +4.560694552873348e-02; -2.539783111496274e-02   -3.188030330382496e-02   +3.953089782939490e-02   -6.380121636808947e-02   -3.975135658387094e-02   -4.065032783776920e-02; +1.186296180913737e-01   -5.922517387905449e-02   -2.916532962164310e-02   -5.124802251595782e-02   +1.481809559429631e-03   -5.563541825722156e-03; -4.941333593359549e-02   +4.696536341246240e-02   +1.520694147719768e-02   +9.323567739165162e-02   -4.921208443111232e-02   +1.972719303278841e-02; -1.046081968044965e-01   +1.893825174223629e-03   +6.362694582010453e-02   +1.229548694863182e-01   -2.485533316369054e-02   -8.871965764398811e-02; +5.836415624489159e-02   -9.271968756618780e-04   -1.622038690745104e-01   -4.758412817519403e-02   +3.848892458218665e-02   +1.079050014948805e-01; -1.139220990166720e-01   -4.037364750008272e-02   -2.348008058202530e-02   +1.199323663476775e-02   +1.277489545273970e-01   -1.039140286134717e-01; -5.083209287714674e-02   -1.003507014031327e-01   +1.492748380525717e-01   +9.278127428914967e-02   -9.488476886011270e-02   -9.647797228867115e-02];
L3_L2_iAMPA_netcon = [-1.755905437945957e-02   -7.846186796027425e-02   -6.586809651903250e-02   +1.671429338802052e-02   -2.262305534235499e-02   +3.989571327142082e-02; -2.636826425255193e-02   +1.274034015895263e-01   -8.927646060112104e-03   +9.466758220704256e-02   +8.592021123951150e-03   +4.013089245360042e-02; +1.272301413566552e-01   +1.864223586884880e-02   +3.034966835780283e-02   -1.359109220815050e-01   -5.982440709527532e-02   +5.460941787567315e-02; -7.224897981244555e-02   -7.268349183081085e-02   -4.043297813339934e-02   +3.711016584591703e-02   +7.333917567678089e-02   +4.733321891961940e-02; +4.302123533528490e-02   -8.295602254261521e-02   +1.425834728527536e-01   -6.894332237938582e-02   -9.244458844869266e-02   +3.020216735653790e-02; -2.900816391359684e-02   -6.172085925578612e-02   +1.217225394918583e-02   +1.912798847971936e-02   -1.801443165052898e-02   +7.221541981608035e-02; -5.663302322435269e-02   +3.469806482461689e-02   +6.160031608629976e-02   +2.531163039458644e-03   +1.057612148163247e-01   -1.300266269110848e-01; +7.911017788991161e-02   -4.533766575812555e-02   -1.452374665979101e-01   +1.066799220483274e-02   -1.286074532821994e-01   -4.565895830638791e-03; +5.276367398434606e-02   +1.228236799614268e-01   +1.096588734930991e-01   -4.208381480197607e-02   +5.925405600183807e-03   +6.672980571088276e-03];
L2_L3_iGABA_netcon = [-6.046297917735140e-02   +5.898300235189385e-02   +9.564558844198066e-02   +6.283378471741728e-02   -3.459566174838673e-02   -5.416054880189200e-02   +1.730827489591765e-01   +5.335612246469247e-02   +6.620689759760530e-02; +5.839294952194719e-02   +1.069272971074127e-03   +5.129932371579192e-02   +1.460956223371613e-01   +2.524390153533985e-02   -6.247265754385748e-03   +4.273725017332186e-03   +6.278140688939129e-03   -3.170647659680424e-02; +1.503306429946391e-02   -4.333889457635422e-02   -1.272331130096100e-01   -2.307442656034576e-02   +5.106260026373929e-02   +6.001248762019387e-02   -4.089796892943121e-02   +7.760309549861250e-03   +4.575158464717016e-02; +3.783602396160971e-02   +7.795097765378816e-03   +9.172371610570841e-02   +7.848231570058382e-02   +2.848394643540570e-02   +1.076236952835926e-01   +1.177944296472301e-01   +5.579321830088184e-02   +1.638647151496375e-01; +6.469958749396340e-02   +9.807727756935652e-02   -5.737930239129864e-03   -2.858272300999602e-02   -1.064442112674988e-01   -2.764521826384710e-02   -7.820894449987176e-03   +9.906527089248260e-02   +1.051117790070799e-01; +9.022892909366267e-02   -6.566385079960503e-02   +1.097112879110784e-02   +2.764055920636142e-02   -1.414738011088872e-01   -1.149057991015077e-01   -1.080928746300556e-01   -2.264651662378337e-02   -1.392133868385820e-01];
L1_L4_iGABA_netcon = [-2.230827011907648e-02   -8.491298651139742e-02   +1.160204084811846e-01   +2.710262865756208e-02   -6.066660673890704e-02   +3.108315739039044e-02   -3.721628315772132e-02   +6.541645323478165e-02   -1.345925176034572e-01; +1.389577133850058e-01   -6.415820471941890e-03   -2.934255863089192e-02   -7.506922939029846e-02   -5.857528761313759e-02   +6.581005800561474e-02   +7.560209766221482e-02   +8.073853152087305e-04   +1.044321602244232e-01; -5.327405964281860e-02   +3.040599268446223e-03   +2.331322424215338e-02   -7.575152831381289e-02   -5.970510676715911e-02   -4.950722760621950e-02   +1.746506624072164e-01   +9.045326094153809e-02   +1.873858641809939e-02; -4.972625492115472e-02   +1.377054690046587e-02   +2.881877031777196e-03   +3.526668539229191e-02   +1.809926675529808e-02   -8.069087224225864e-02   +1.424130173857102e-01   +1.015314192527159e-01   +1.149643775313934e-01; -1.693291870224724e-02   -1.771997989229897e-01   -6.304504922621768e-02   -1.397981259734019e-02   -9.210708832702245e-02   +5.378299651392442e-02   -2.609339452985433e-02   -1.176563010420839e-01   -2.092913119566420e-02; +1.373680853119864e-01   +1.375998079277951e-01   -6.271410471396581e-03   +7.294274352829994e-02   +6.528339137498100e-02   +1.177418814352588e-01   -1.549345060891213e-01   -1.179963691272009e-02   -1.424591616685626e-02; +4.410152984953737e-02   -2.989238043214461e-02   -1.455251589731966e-01   +8.111463528877490e-05   -1.652035801635404e-02   +2.923397476914672e-02   +8.408994145227996e-03   -1.982565671875930e-02   +6.450589839136529e-02; +1.267609749270308e-02   +1.286029855465761e-01   -9.290281443874752e-03   -5.295785948067255e-02   -1.001014740823305e-01   +8.169546430977981e-02   +8.022526463229572e-02   +1.229949974676440e-02   -1.042528163370700e-02; +6.532859817733512e-02   -7.026369428222197e-02   +8.680631588054491e-02   +2.420103890254633e-02   +5.793130069853704e-02   +1.254502694930618e-01   -8.387996284684704e-02   -1.535892127349995e-01   +1.632570509878541e-01; +6.055593130424151e-02   -1.011076945513788e-02   +4.726286175392575e-02   +2.848057678775325e-02   -1.716694772737470e-02   -3.818864034404931e-02   +7.542109107686293e-02   -2.537610785942388e-02   -5.226689013402289e-02; +4.244160828781209e-02   -5.983436111947447e-02   +2.223364175438581e-02   +5.788596220182263e-02   -4.859076947814307e-02   +1.126997493882178e-01   -3.671824111352275e-02   +2.288550370085012e-02   +2.080008764288743e-02; +3.229931948012168e-02   -2.992964523508121e-02   +8.220079133109214e-02   -1.138262421005547e-01   -5.501907252515282e-02   +1.328977261535752e-01   -2.877366797704419e-02   -1.248779209393111e-01   -1.140670691153770e-01];
L4_L1_iAMPA_netcon = [+4.335328984447399e-02   +2.037596205618630e-02   -3.179026299832245e-02   +2.147413664786918e-02   +8.364987319261681e-02   -7.644165730147784e-02   +9.628311135537587e-02   -1.384733774000110e-01   -6.756938606135471e-02   +1.037140790073780e-01   +1.122804103206290e-01   -7.705188752684249e-02; +1.252489196880029e-01   +9.345680441101295e-02   -7.857850375721763e-02   -3.490684621988041e-02   +8.864430658009595e-02   -1.429073198542075e-02   -1.000820927958222e-01   -4.354439212469031e-02   -8.792495186396061e-03   +4.280151420813292e-02   -1.701757702335718e-02   -1.426893163206188e-01; -2.165492919542240e-02   -3.995883437171384e-02   -1.292810134227966e-01   +3.253898390741065e-02   -7.059181473692883e-02   +8.309187546638314e-02   -3.549956358519407e-03   -8.708829025974075e-03   +6.386824129562342e-02   +6.198253458593558e-02   +3.115113793189167e-02   -1.356684743255230e-01; -2.865753453124933e-02   -6.475206051603999e-02   -2.927819867551087e-02   -2.224191997490158e-02   +9.286316676365527e-03   +2.926639661349244e-02   +1.324370217070120e-01   +7.928999523713162e-02   -4.614165504900541e-02   -1.377462670612091e-01   -3.142400018810579e-02   +2.935369654161954e-02; +5.679661822351540e-03   -4.275329659625515e-02   +4.474092290022129e-02   -3.295841939720569e-02   -1.021397461411502e-01   -4.704090719985018e-02   +5.951041005258105e-02   +2.122565842191291e-02   +1.094524189777317e-01   -1.247891822371784e-01   +4.343540354549826e-02   +6.528904555915423e-02; +1.503291429692283e-01   -6.188644300166790e-02   -1.244779824319709e-01   +6.078766806192433e-02   -1.035131879458238e-01   -5.329045168934199e-03   +7.386354172012241e-02   -2.924072440273467e-02   +4.181289838286360e-02   -4.265065537399956e-02   +6.039219200740735e-03   -2.880831445343799e-02; +1.223087198061227e-02   +8.024951899979660e-02   +9.895067870738770e-02   +2.753244780587638e-02   +3.480211656886926e-02   -1.110167275466364e-01   +1.636323736717972e-01   -9.262908499693353e-03   +8.271110338075216e-02   -7.952488394073500e-03   -8.706242631165988e-02   +1.217457671531858e-02; -6.173560220106203e-03   +5.358546375886608e-02   +1.385613601263598e-01   +5.761391983223436e-02   -3.765282576982370e-03   +1.295736645130429e-01   +1.291750668951087e-02   +1.840752173000710e-02   -9.262130609846664e-02   -9.013093456009033e-02   -5.934150716921379e-02   -2.178616156799818e-03; -1.389986989457057e-01   +4.335351729065672e-02   +5.990995709790163e-04   -7.093296279852630e-02   +2.920124716057662e-02   +1.728438576863770e-01   +6.789148744596210e-02   +6.613341128756786e-02   -2.087728843488719e-02   -1.569778523521572e-01   -7.277979847681090e-02   +1.031069851188380e-02];
L1_L3_iAMPA_netcon = [-7.925270442019598e-02   +1.054872015479774e-03   +6.841431084580801e-02   -3.112095094115430e-02   -2.733039704253774e-02   -1.026313052548629e-02   +7.129323943597419e-03   -3.231384545240316e-02   +1.053657677815073e-01; +7.319520257495730e-02   +1.011721502903282e-01   +9.575989617977926e-02   +4.798162988882674e-02   -1.537210851849384e-01   -5.790071838988831e-02   -4.215102591614072e-02   -2.832129954452958e-02   +1.250492651347342e-01; -7.385726894890151e-03   -1.277839304108513e-02   -6.369614456776951e-02   -2.535514006173436e-02   -8.074749242590251e-02   +2.691529784785275e-02   +5.273268211330116e-02   -1.579975607765313e-02   -7.640253239022532e-02; -3.564523412869972e-02   +8.274383387688436e-02   +1.460394223277144e-01   -7.814233864021758e-02   -1.339854265038623e-02   -8.416585726146068e-02   -1.082212903445650e-01   -8.385731819085560e-02   +1.478595009796757e-01; +1.840498941876535e-02   -1.729923005450767e-02   +1.815958204434609e-03   +1.304656868052580e-02   -7.052745133708077e-03   -4.300188395870010e-02   -3.588590291298650e-02   +5.042774011325747e-02   -1.541339692313049e-02; +1.078333361823017e-02   -9.177892309896238e-02   -1.259915144183656e-01   +1.126155962481076e-01   +8.802678600617990e-02   +3.097320831498428e-02   -4.822380838534890e-02   -2.462027515502373e-02   +1.317358882483962e-01];
L3_L1_iGABA_netcon = [+4.913360435499341e-02   -1.466112428061079e-02   -3.403579854283367e-02   -1.202560956218164e-01   -1.445104032116045e-01   +7.079875255647880e-02; -9.134682199369579e-02   -6.915920383166935e-02   +9.520802636984976e-02   -5.412785733032322e-02   -2.876977153159907e-02   +5.004981490347521e-02; +9.902876552887509e-02   +8.343306307192086e-02   +4.359307119353169e-02   +4.012640598805744e-02   -9.845508130392769e-03   -1.582695770220250e-02; +1.207554916195968e-01   +1.081070908233489e-01   -2.866277840101743e-02   -4.177071435302894e-03   -1.021512489117535e-01   -6.018369225651320e-02; -2.510410933634983e-02   +5.066914124093304e-03   -1.459584101269820e-01   +1.205422655070395e-01   -8.439495433505452e-02   +3.022615067431471e-02; -6.090076899423126e-02   -1.377721653897684e-01   -4.796115984730700e-03   +8.802748781177167e-02   -6.326437510815693e-02   +1.396980897805645e-01; +1.305748403353595e-01   +9.338311805548252e-03   +4.309472066852687e-02   -7.567457001404003e-02   +1.563735579681373e-01   -1.043029426763679e-03; +1.066645963227715e-01   -1.378598276232081e-01   -4.494980957924690e-02   +5.662577480271531e-02   -7.337172617156930e-02   +1.622138584681830e-01; +2.705717920368748e-02   +1.729706859446036e-01   +9.651705301939231e-02   -2.213207560272471e-02   +3.955871508157878e-02   +7.615689638310397e-02];
L5_Input1_iAMPA_netcon = [-7.105451157458204e-02   +1.249841149799085e-01   +6.824186756381938e-02   +2.841639600398219e-02   -6.161535614295745e-02   +1.082582808348078e-01];
L6_Input2_iAMPA_netcon = [+2.630084358734283e-02   -1.578376498773726e-02   -7.526877491116757e-02   -2.053873385645732e-02   +1.198979964452121e-01   +1.540799519538934e-02];
L5_L6_iAMPA_netcon = [-7.304869919453562e-02   +1.018865030710261e-01   +1.693825965236870e-02   +1.451661158462318e-02   +1.173348002932603e-02   +9.560808382880231e-02; +7.581164863610951e-02   -5.480581486648339e-02   +3.702720665241579e-02   -4.795696175511306e-02   +9.083853661171157e-02   +2.795862674355815e-02; -6.297046798934194e-02   +1.056048230826854e-01   -9.957995928466945e-02   +4.914197838289395e-02   -1.290851078695536e-01   +1.556319192166210e-02; -6.856759740807895e-03   -9.835855050643320e-03   -5.518679593150941e-02   -7.303445759569878e-02   +1.469748372882195e-01   -2.123791106055354e-02; -8.028769648009693e-02   -9.897588110883708e-02   +1.048624697472995e-01   -1.069165173618784e-01   -9.846250138688666e-02   +7.528027130425718e-02; -5.522629979002733e-02   +1.811866688433558e-02   -1.787660007605002e-02   +5.265784426806670e-02   -1.174302423878072e-01   -7.437753553972773e-02];
L4_L5_iGABA_netcon = [+3.298906340519577e-02   -1.040728695085172e-01   -1.155211730774668e-01   +6.110723662277988e-02   +1.159896585329094e-01   -8.313981926895763e-03   -2.769793393179172e-02   +3.697078170177399e-03   -1.434519653564385e-01   -1.402210994549508e-02   -2.481551156684272e-02   -4.773320368788693e-04; -1.101250894072114e-01   -1.421919184175241e-01   +6.760373561639260e-02   -7.406600360935102e-02   -9.998716051838392e-03   -1.617538697692844e-01   -1.567061435690830e-02   -1.698526433678105e-01   -6.258390503765376e-02   +7.949301768583064e-03   -1.792069017899648e-02   -8.014362884464375e-02; +6.196237110053824e-02   +8.307161712967324e-03   +3.592838977888320e-02   +1.461399626797390e-01   +2.969101604977355e-02   -1.071385831452786e-01   +1.062909137542765e-02   +1.156214421356781e-02   -7.828565424076474e-02   +7.286707700553303e-02   +4.460938857119153e-02   -4.435160069840036e-02; +7.434835150740482e-02   -6.332022863612462e-02   +1.135226274583161e-01   +3.389602770389201e-02   +1.200710628864911e-01   -5.484653059680270e-02   -7.768079021101431e-03   -1.196937269559778e-01   -2.142496957452403e-02   -1.392408076892296e-01   +8.625187348667575e-02   +3.106118372807532e-02; +1.487867016492790e-01   +5.175501204572544e-02   -4.894670969405098e-03   +1.852196865624508e-02   +5.639956632471428e-02   +1.189981340131432e-01   -6.803671451293047e-02   -4.835633134748542e-02   -2.197856509056115e-02   +2.916517755261730e-02   +3.263262731325890e-02   -1.943543975431081e-02; -4.379799338092333e-02   -3.003788299145183e-02   +6.612103724457215e-02   -4.195995909597499e-02   -5.218375860184230e-03   +5.593942451752767e-02   +8.363487231008492e-02   -1.110185090839634e-01   +1.388191139255380e-01   +2.864052952829344e-02   +1.203110184262552e-01   +7.947512312811268e-02];
L6_L4_iAMPA_netcon = [+3.289766759865123e-02   +5.895998088890693e-02   +6.107703687880295e-02   -8.109914099512482e-02   -9.937143450895022e-02   -5.058049157175531e-02; -5.764549120458354e-02   +2.695974972111929e-02   +2.831100056157965e-02   +1.248719961502269e-01   +8.688052656554687e-03   +1.566340908620681e-01; +5.436769055802832e-02   -4.382234613538190e-02   -4.365174628401330e-02   -5.044374247461911e-03   +3.216638355335958e-02   +7.308295972692344e-02; +1.357088447533009e-02   +1.185070225376574e-01   -6.410622890105683e-02   +6.967289287501159e-02   -5.242193077131888e-02   +7.961539162082244e-02; +3.451464745868970e-03   -1.674387535433892e-02   -1.416523692650619e-01   +1.389760855656637e-01   +6.983278991108410e-02   +4.422293589111709e-02; +1.242736719111302e-01   -9.744820406249764e-02   -4.612849936969748e-02   +4.055985194537496e-02   -1.232288846983613e-01   -7.711137253789910e-02; -4.793032742954423e-02   +2.948792848109131e-02   +1.143951290022590e-02   -1.210966575993857e-01   -1.383915490437905e-01   +5.028959521761747e-02; +1.955746930735028e-02   +1.057860475959672e-01   -1.270808654557250e-01   +8.473750849300653e-03   +5.219190964977258e-02   +9.442764983514908e-02; -6.271527434128615e-02   +1.547889625222167e-01   +4.532173661964549e-02   +4.106037138739911e-02   -1.008833147845520e-01   -5.314212411037798e-02; +3.900020948541776e-03   +1.331049596727303e-01   -8.485173643879447e-02   -5.855824221020058e-02   +3.527243154731111e-02   +3.513282934220047e-02; -1.064209894143721e-01   +5.148118893226168e-02   +8.991186795425160e-02   +2.623578388012461e-02   +1.531196642914228e-01   +6.924918329039612e-02; -1.245789165061647e-01   +6.419649773020618e-02   -5.046847508667139e-02   +1.573022910782394e-02   +2.987269227019369e-02   +1.167258932749243e-01];
L5_L4_iAMPA_netcon = [-1.509663615551043e-01   +4.573029522860789e-02   +8.416523370619704e-02   +1.144972493298571e-01   +9.291484282903460e-02   +7.231288415551530e-03; +2.838285942020457e-02   -9.017675998022515e-02   +9.247536492215790e-02   -6.157567037931962e-02   -1.351634145858146e-03   +3.982929672744821e-02; -1.233712392080189e-01   -2.612796263675332e-03   -3.373566119385744e-02   -9.917904546064281e-02   +1.059786308503734e-02   +3.402504799825391e-02; -1.594306790096977e-01   +3.602292934632319e-02   +4.818666487170505e-02   -5.718921293475260e-02   -1.841842330195512e-02   +9.734662818586165e-02; -5.996467935962090e-02   +5.879314095363771e-03   -1.330208430631906e-01   -3.547844736032196e-02   -2.296465506432563e-02   +3.034791450532575e-02; -2.104088539631191e-02   -6.973067083850674e-02   +5.905943672479828e-02   -1.729553038068421e-01   -8.476234443612431e-02   -6.538693238519946e-02; -5.306252932580214e-03   -4.130426938593933e-02   +4.343535649510884e-02   +1.235187503169991e-01   +1.909493450694705e-03   +9.513326222465188e-03; +1.224801235324585e-01   -6.336765948383745e-02   -1.285457277805597e-01   +1.706396195567752e-03   -3.461471771240693e-02   +9.905637846744009e-02; +2.384546104203542e-02   -7.061173346376705e-02   -3.976180884695395e-02   -8.301376532069078e-02   -6.002835629295089e-02   +2.269681068631999e-02; -1.387931896417272e-01   -8.342161756065615e-02   -1.725561782285566e-02   -1.136919698706154e-02   +8.702960640057758e-02   +5.287086731828441e-02; -4.454072028192201e-02   +8.533671292165367e-02   -2.311228221843642e-02   +1.061986882403404e-01   +1.913014051659361e-02   +3.191851813536875e-02; +1.355065359297395e-01   +4.413399306351516e-02   -4.442855413475129e-02   +8.140260914035544e-02   +1.468094973207816e-01   +7.388076416026401e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
