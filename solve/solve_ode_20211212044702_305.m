function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+6.849206616272914e-02   +8.991896196086230e-03   -1.764454383779545e-01   -6.771663810033422e-02   +5.881899852445256e-02   +2.148586117061037e-01   -1.848347221648664e-01   +1.527866732861296e-01   -8.976523588423588e-02; +5.254735918534054e-01   +6.681526318823408e-02   -1.304340343785483e-01   +7.431707506813572e-02   +1.275597846153276e-01   -2.751185836667047e-02   +1.791276123929813e-02   -5.508596053706616e-02   -2.623228084968460e-01; +1.845426653391043e-01   +5.659880883108087e-02   -1.527200754461373e-01   +4.202439831877170e-03   -3.123728310830739e-01   -8.480021623870980e-03   +2.175546489151879e-01   -1.260909284695321e-01   +1.579463932901631e-01; +8.201549494361279e-02   -2.988649963367583e-01   -2.722152199321134e-01   +3.813496774535724e-02   -9.637013431832159e-02   -1.523436149823774e-01   +2.175215121290152e-01   -7.844887288733428e-02   -1.613345690743513e-01; -9.424708864960178e-02   +9.069477439463854e-02   -4.006424682472873e-02   -1.002366135256333e-01   -3.266643036974978e-01   -9.674716441055747e-03   +2.888885221520128e-01   +3.030377773570612e-01   -1.676150102949840e-02; -5.712243538450748e-03   -8.228941177329510e-02   -1.688813824915326e-02   +3.222898464739743e-02   -1.212593019208523e-01   -4.905809265651299e-02   -6.706395588328168e-02   +2.769298967760086e-02   +2.026541019321402e-01; +3.857108930439260e-01   +1.869651840015928e-01   +1.675412208344370e-01   +7.143712566071617e-02   +2.666340500014392e-02   +1.168304933819298e-01   -5.414815436758312e-01   +6.708782580372699e-02   -4.769131483060435e-02; +1.035831016675021e-01   -2.162497179019357e-01   +1.015856740712965e-01   -7.958047033298031e-02   +1.490337458450994e-01   -1.928169036912250e-01   -3.072601539894721e-02   +4.722811830403190e-02   -7.263196845539914e-02; +6.997418991624024e-02   -2.074033622198697e-01   -2.976119974378226e-02   -6.210216373186241e-02   -3.597508724935283e-01   +1.663120640945502e-01   +2.796037746006554e-01   -1.517617242843627e-01   -1.891876854017144e-01];
L1_L2_iAMPA_netcon = [-5.391425279733547e-01   +2.888469812735943e-01   -3.408166534856304e-01   +3.473487085145353e-01   -3.894817287292272e-01   -1.976644839123631e-01   -2.481125858893215e-02   +2.067366037381010e-01   -3.059422350477305e-01; -2.150750010454877e-01   +3.528800950988428e-02   +6.060973636601227e-02   +2.580733760400721e-01   -5.646313550309322e-02   +1.558446244225694e-01   +2.568988276501623e-02   -8.835595460029830e-02   +1.364615703026975e-01; -1.466037312243035e-02   -3.501121181605928e-01   +6.580519219992997e-02   +6.465408577801367e-02   -6.544606312470359e-02   +3.389287719059098e-01   +3.129597007691040e-01   -3.379997711282309e-01   -5.330698508550633e-02; -1.559340686643420e-01   +2.118133872070303e-01   +4.738492546646478e-02   +2.187869723168206e-01   +2.080134034783662e-02   +3.523306418823623e-02   -1.420048455680241e-01   +2.293726356964737e-01   -8.832712203559950e-02; -8.753239994440068e-02   -1.194363475825280e-02   -8.138547517970954e-02   -1.227241829537425e-01   +5.684182159249233e-02   -2.743797756263099e-01   -2.366842152053101e-01   +1.654549466174549e-01   +2.579155753651904e-01; +1.974952818008295e-01   -3.705452575728207e-01   -1.151484467928606e-01   -8.068197273399191e-02   -1.533791935684247e-01   +2.701265441769437e-01   -7.154926804947337e-03   +7.456659743435748e-02   +2.719677147632543e-02; +6.327030109153813e-02   +2.661522120425481e-01   -3.148696432784568e-01   -2.982889208450847e-02   +3.537981000079136e-02   -7.398453239102046e-02   +2.220646975061839e-01   +4.740783786263027e-02   +4.292976226087198e-01; -2.568608614411163e-01   -2.745795617808967e-02   +1.398498183096161e-03   -4.146808296058284e-01   +1.794095193295840e-01   +1.462224909266787e-01   -2.438377187495674e-01   +1.763470250138474e-01   -1.099599126623841e-01; +3.302375427743741e-01   -1.234570479348060e-01   -1.608800930197577e-01   +1.471811179126981e-01   -1.597176304217018e-01   +6.910462809484530e-02   +2.016900229319642e-01   +2.455592775465587e-01   -2.727774977380523e-01];
L2_L5_iAMPA_netcon = [-3.068790686524537e-02   -2.379257627749357e-01   +1.184484397401445e-02   +8.059605973013849e-02   +1.874151616752806e-01   -3.374893406619536e-01   -1.448189331456780e-01   -1.519848946874245e-01   +2.525507450553722e-01; -3.478991284949720e-01   -1.881812173066187e-01   +3.255622111107851e-01   +3.745808936189503e-01   +4.242894971482554e-02   -2.384774454468546e-01   -7.883193411066761e-02   +3.894090845241096e-01   +8.024423073698354e-02; +3.951000841285504e-01   +8.451333058882528e-02   +3.228963643634931e-01   +1.564313100429224e-01   -9.166188501160126e-02   -7.729257204805019e-02   -1.458802334773662e-01   +6.189799848613625e-02   +2.894001813419512e-01; -8.370330106704217e-02   +4.913507731602954e-02   -2.056569159388927e-02   +1.408694559159264e-01   +2.678049721175744e-01   -6.747649530664811e-02   +1.697233109462810e-02   -1.214281235135529e-01   +5.560237638389982e-02; -8.626101353037152e-02   +8.478663514918808e-02   -2.828477888521879e-01   -3.981990612431632e-02   +1.166045824647787e-01   +1.372634193144883e-01   +2.651539908110629e-01   +6.061880755300630e-02   -2.620745035304452e-02; -1.989278588179991e-01   -6.619224575191324e-02   -2.439423843485165e-02   +1.834976474294418e-01   +1.907547917356410e-01   +1.883571547199479e-01   -1.607796567754167e-01   -5.666036066154621e-02   +9.688818742444785e-02];
L5_L2_iGABA_netcon = [-1.072737827091789e-01   -1.403171423466238e-01   -3.293345984694183e-01   +6.745849117426597e-02   +5.431353365105186e-02   -7.512460050694617e-02; -1.366699456392582e-01   -4.302309531302154e-02   +4.832223112697146e-01   +8.319515113701520e-02   +1.859140489915576e-01   +6.051159625978478e-02; +1.171098167704690e-01   -3.003315160952447e-02   +1.553060513334747e-01   +1.334651242922821e-01   -2.029390569114977e-01   +1.172069667430825e-02; +2.812532120951846e-02   +1.213685387841677e-01   -2.935769067342037e-01   -2.538058091487201e-01   +3.255620075263793e-01   +1.389654837462944e-01; +1.644708932761474e-01   -1.765958496391291e-01   -2.823173394189019e-02   +1.908428235534960e-01   -1.289366300282792e-01   -4.959662601621177e-02; -8.465438532037176e-02   -1.734803137825468e-01   +6.303920371730758e-02   -1.447965741450473e-03   -2.837156355423817e-02   +5.317848090473227e-02; +1.313947867050863e-01   +1.459230277550882e-01   +1.446874672066293e-01   +8.515505887126729e-02   +1.548079044103400e-01   +4.152101856618885e-01; +7.521531806171304e-02   -1.753713307343972e-01   +1.619367913399012e-01   +1.270842371287094e-01   +1.075071511960583e-01   -5.782372395840309e-02; +2.599356951885105e-01   -1.274161885966178e-01   -2.977437054467336e-02   -1.392655037005001e-01   +1.387289841997709e-01   +2.796435784474767e-01];
L3_L2_iAMPA_netcon = [+1.422137977723962e-01   +2.050278857516430e-01   +1.256394927507588e-02   +2.327326883780830e-02   -3.555886798733392e-02   -8.178726693827051e-02; -1.908291788787265e-01   -7.216077001801084e-02   -2.773552868431621e-01   +6.167268212468587e-02   +2.688193396586941e-01   -1.407469463750560e-01; -8.478623096730771e-02   +2.561562730045012e-01   -1.966121930808823e-01   -2.402936304103649e-01   -9.202401434035370e-02   -2.132578647070328e-01; +3.050919919221836e-01   -2.774766104353301e-01   -1.137813000611127e-01   +2.936836129616383e-02   -9.223105687706069e-02   -1.410527417242784e-01; +2.278033854824115e-01   +8.229830882490630e-02   -2.843462635781234e-02   +7.363046871992707e-02   -1.475258765272999e-01   -1.561876919256650e-01; +2.460960791694081e-01   +3.803328983005883e-02   +8.143701758336040e-02   +3.039528499542108e-02   +1.016267158314968e-01   +7.918395456186823e-02; +1.385231554910402e-01   +8.207483444461190e-02   +2.043595401847069e-01   -9.749877909578737e-02   -3.832970500886357e-02   +4.465632861308777e-02; -1.066187785776676e-02   -4.399803646011571e-01   +3.842900997467879e-01   -3.102226225293454e-01   +1.567045692689820e-02   -7.748144572553599e-02; +1.571024840804422e-01   +8.696902861559731e-03   -3.660658282664675e-01   -2.182488250897005e-01   -3.334165179712454e-01   +1.036152445214035e-01];
L2_L3_iGABA_netcon = [+2.936667059644467e-01   +1.918839538041653e-01   +2.318256635789936e-02   -2.122906894533492e-01   -8.602317043759306e-02   -2.658059428303410e-02   +3.698839581940722e-03   -9.430784073949532e-02   -1.865512168946865e-01; -2.926745283899900e-01   +4.562759121602471e-02   -4.043148503878777e-02   +2.055413247204006e-01   +5.817859001024261e-02   -3.957069114942618e-02   -7.594663570328050e-02   -1.874017431107986e-01   +1.101547067931835e-01; +3.012490608998754e-01   +1.430926546065364e-01   +1.049994610810305e-01   +7.694838573779633e-02   +3.469765344089024e-01   -2.315685502116089e-01   +4.091175599865760e-02   -8.471490265144968e-02   -2.071610008472261e-01; -3.032587438311504e-02   -3.626219755468438e-02   -1.444846256496453e-01   -1.425737059235744e-01   -6.927161072487735e-02   +2.001439717299280e-03   -2.547098951808616e-02   +6.989341549730282e-02   +1.045061579145649e-01; -6.979974268402123e-02   -1.236615909596231e-01   +3.648091080121131e-01   +1.900469753467978e-01   -1.922855220686349e-01   -5.369308684692944e-02   +2.686120721324406e-01   +1.006027213252351e-01   -1.490406407757497e-01; -7.021263767888268e-02   +2.818135349548182e-01   +1.287983352526510e-01   -2.635741076893202e-01   -2.682092246571979e-01   -3.245326640109417e-01   -2.920149737911331e-01   -2.433254913834314e-02   -8.045044636885139e-02];
L1_L4_iGABA_netcon = [-3.467407997729739e-01   +2.944459347814177e-01   -3.843796652200039e-01   -1.161140097255501e-01   -3.442037368203002e-02   +3.520509275550942e-01   +1.391951702827739e-01   +2.972528596885319e-01   +1.410761556336965e-01; +1.102791464546462e-01   -7.623608159086494e-02   -3.204580742432235e-01   -3.441685718103957e-01   -1.900130427316675e-01   +1.798273097294252e-01   +4.903529673517553e-02   +2.591558948537122e-01   -2.333278222342450e-01; +2.438839546195031e-01   +2.412292491631792e-01   +7.085653986062961e-02   +3.123130882035370e-02   -3.317779362561955e-01   -5.874291309344928e-02   -1.924833468409698e-01   +1.931201302011009e-01   -1.645693676677785e-01; +1.249154669925933e-01   +1.861481985516114e-01   -5.462818258639544e-02   +1.629451734880352e-01   -3.538147615190265e-01   -2.480054874494841e-02   +1.829398592938304e-01   +6.801693853876190e-04   -2.180273552076544e-01; -1.584292704415590e-01   +1.480006676773017e-01   +5.992683454125521e-02   -4.016923466715636e-01   -2.662937631970430e-01   +1.129584868775328e-02   +1.999072246317048e-01   +2.782232962490434e-01   -1.986216021573334e-01; -1.930912241478144e-01   -1.059601907975971e-01   +1.851512411576931e-01   -4.300466911488999e-01   +3.078640196935002e-01   +4.008393316701703e-02   -2.498057973634058e-01   +2.040749287756992e-01   -1.467136540458526e-01; +4.247147795348812e-02   -1.333448292259531e-01   -2.044538798996051e-01   +1.996339284413987e-01   +3.121679305819346e-01   -5.037885750366995e-02   +3.105896592767478e-01   +6.227981651282313e-03   -2.053252875889436e-01; +1.810412020978179e-01   +2.754891403171212e-01   +4.626854775834668e-02   -1.132334892424897e-01   -8.969539749326390e-02   -2.997967344347700e-02   +1.360670930416546e-01   +8.709134857206541e-02   -1.146804315580083e-01; +4.712216027715045e-02   -1.145779549857055e-01   -1.194397954974104e-01   -1.511591806806259e-01   +1.022964590521341e-02   -9.941033200680549e-02   +2.460491681926303e-01   -2.139168836588355e-02   +7.228156134872002e-02; -1.117800974996225e-02   -2.469753917586514e-01   -2.089249996692695e-01   -1.015574523707522e-01   -1.864457441599135e-02   +2.917566551933155e-01   +2.236379664400961e-01   -2.283934129073172e-01   +1.569172072133659e-01; -6.749420395337251e-02   +2.740095957139494e-01   +3.639690790142954e-01   -4.379042514404329e-01   +1.227102408220437e-01   +2.454136583187529e-01   +5.113678495735987e-01   +1.364659558573622e-01   +2.120071758390107e-01; -1.909266808141052e-01   -2.674152165627082e-02   -5.902016861839142e-02   +1.024756583290319e-01   +3.817435396529777e-02   -1.357764240603471e-01   -3.370112378625292e-01   -2.381146803907820e-01   +1.493778943059122e-01];
L4_L1_iAMPA_netcon = [-1.481200203980062e-01   +1.005060153160735e-01   +1.497027345653404e-02   +3.331079779261681e-01   +7.164657034767090e-02   -8.239135273673621e-02   -2.160375860146928e-01   +6.360185181966413e-02   +2.873883418623676e-01   +8.074985896757235e-02   +6.424515375118303e-02   +8.538919781757445e-02; +3.687962885535952e-01   -3.136256340579232e-01   +1.520726660268670e-01   -1.530200693160007e-01   +2.191535045515691e-01   +4.122597848560926e-01   +1.025576116252945e-01   -2.577084544014516e-02   -2.630070281630641e-01   +1.466438643145714e-01   -1.086859018090216e-01   -2.911206476439133e-02; +9.083103628200878e-02   +9.232964636756113e-03   +7.015749104152436e-02   -1.826572858670953e-01   +1.103898314662696e-01   +1.529091046285619e-01   +9.323674985651939e-02   -2.755808085580342e-01   -1.743360330323867e-01   -2.586520215481522e-01   +2.601068061811037e-01   +9.090771036816131e-02; -4.773038267346180e-03   -9.293699489478871e-02   +4.023056731171413e-01   +4.042921191216973e-01   -2.792509557192505e-01   +1.709259929381873e-01   +9.559719180874653e-02   -6.919101687766874e-02   +8.399438979234086e-02   +1.501730417669546e-01   +1.036081818394413e-01   +9.917813294414643e-02; -1.904347205291687e-03   +6.954845758200046e-02   +1.378403732648403e-01   +2.032224317494102e-01   -2.442531962749042e-01   -1.666270600938390e-01   -1.873599575423336e-01   -4.387230826877833e-01   -1.618854058399736e-01   -2.506099503174154e-02   +1.123042499366595e-01   -1.653150717550732e-01; -2.647558871646072e-02   -1.117757839869279e-01   -5.074504843142961e-02   +2.131931085636363e-02   -4.803900546708733e-02   +2.493042360042958e-02   -1.881761130541459e-01   -3.687346594979081e-01   +2.230523153271393e-01   +1.583930999885178e-01   +1.441722946381352e-01   -7.705687392588159e-02; -4.905165232346355e-02   +1.791982814228830e-02   -1.017317782843287e-01   -5.583077853124834e-02   +1.330817369555891e-01   -9.061422153055620e-02   +9.009162997773176e-02   +2.177359616937088e-01   -1.679088891998488e-01   +5.540748302467523e-02   +1.609818250808818e-01   +9.490943951354035e-02; -1.812830282695845e-02   +2.719606918694170e-02   -2.925011285628832e-01   -1.604200267489250e-01   -8.095419264796443e-02   +2.047566981760678e-02   -9.548912509391760e-02   -1.038137736093209e-01   -1.286707283896700e-01   -3.019126689513691e-01   +1.272912942401160e-01   -5.404481230620239e-02; +1.306531917680688e-01   +1.250115905358268e-02   -4.893416479337142e-02   +2.426601890075420e-01   +1.567943369771522e-01   -9.193236391066076e-02   +5.380578399175158e-02   +1.103136850043919e-01   +4.616450857261059e-02   +8.193841839583550e-02   -2.109084617674601e-01   +3.146642269834806e-01];
L1_L3_iAMPA_netcon = [-4.943401559766164e-02   +3.368905277945101e-02   +3.868505966101832e-02   -1.757024195772884e-01   +9.963810304222359e-02   -4.097847911329833e-01   +5.932461523428037e-04   +9.172933714611220e-02   +3.995528559454331e-01; -3.321947062180947e-01   +2.466831707640910e-01   +3.996352666999192e-01   -6.953494554913872e-03   +1.003348408359588e-01   +5.601596808198286e-03   -1.939697572651764e-01   -1.670815976334049e-01   +1.000707237466607e-01; +5.969090689985854e-02   -1.607392541847249e-01   -3.691758618891873e-01   -1.529578822980803e-01   +1.546216548019010e-01   +3.755930048254894e-02   +4.868482600463074e-01   +1.856309417462285e-01   -2.692044565453333e-01; +2.978292218348570e-02   +2.198839488335109e-01   -5.154089736380528e-02   +2.575992240308326e-01   +1.130436172549922e-01   -1.245470524900424e-01   +1.330087344641336e-01   +1.218388674126098e-01   -8.909788621502777e-02; +2.732983443988869e-01   +1.553821486699341e-01   -4.185627588123606e-02   -3.588229071282805e-01   +1.893399285454503e-01   -6.204450818128368e-02   +4.025947945169107e-02   +2.018060291391043e-02   +2.957195241041475e-01; -2.317647657731089e-01   -3.830944882497713e-02   -2.489491529951499e-01   -1.533522173343627e-01   +1.983979854382557e-01   -9.681620418323719e-02   +3.241602076055083e-01   +2.003711718683819e-01   +3.718238018883724e-02];
L3_L1_iGABA_netcon = [-2.806025800070950e-01   -2.626347478350700e-01   -8.659956891382557e-02   -2.808909604963117e-02   -8.566257838004097e-02   +1.110680655359604e-01; +6.579049584477845e-02   -4.403266939579539e-01   -1.114038169264637e-01   +1.751063058504075e-01   -1.492355905973766e-01   -9.365876422505801e-02; -2.720450972899209e-01   +8.788460667346945e-02   -1.432829526989871e-01   -4.188907104607225e-01   +7.279557607311726e-02   +2.407988832004978e-01; +2.364947485728005e-01   -2.502160690285692e-01   -3.068375991798532e-01   -1.556875924427543e-01   +1.378156951393598e-01   -1.624941337643686e-02; +6.678687256107239e-02   +7.145066517292153e-02   +6.694737811552731e-02   +4.825088731270964e-02   +8.928417079994939e-02   -1.180122335578503e-01; +7.627984840692684e-02   -3.146466032719217e-01   -3.140660265753977e-02   +8.042529958363326e-02   +2.489825286621194e-01   -5.747408144072313e-02; -1.050536058889620e-03   +3.771901765817213e-01   +3.472189115615823e-02   -1.291438148447080e-01   -3.365803616659167e-02   -1.214341978372515e-01; +5.304290857271389e-02   +2.542497984487549e-02   -1.896960545824809e-02   -6.241768248086002e-02   +3.851263290779026e-01   +4.225445341767307e-02; -7.554223667971401e-02   +1.011959115146374e-02   +2.153363416598769e-01   -1.228850525770186e-01   -1.801436213829308e-01   +2.143409793502269e-01];
L5_Input1_iAMPA_netcon = [-2.861599200133910e-01   -2.467702939799575e-01   -3.131627022057372e-01   +3.866075170443843e-01   -9.514380143729564e-02   -2.465995686990756e-01];
L6_Input2_iAMPA_netcon = [+1.474609909583793e-02   +5.137921336508033e-02   -6.234942918721835e-02   -5.369760197696057e-02   +1.068271082009042e-01   +1.968854911309272e-01];
L5_L6_iAMPA_netcon = [-3.783241631025597e-02   +4.715423609888889e-02   -1.986723577062477e-01   +2.575118910704175e-01   -1.420986032701517e-01   -5.401792179397211e-01; +6.348703848762888e-02   +6.648700973393711e-02   +7.199523710935388e-02   +8.053931994806517e-02   +3.525491029714692e-02   -3.911252773543999e-02; -3.254652010557270e-01   +9.837055711346822e-02   +1.572578712188963e-01   +1.037901658092590e-01   -8.804112095310088e-02   -2.670726425576422e-02; +1.862901240439844e-01   -4.041302631189639e-03   -1.767880461656798e-01   -5.569290302703266e-01   -1.629336279520959e-01   +3.420453532473119e-02; +1.151588924312996e-03   +1.881651863465657e-01   +3.042297862921126e-01   +7.838276621842298e-03   -1.876636583701639e-01   +1.966377381476062e-01; -2.343046684295840e-01   +5.981978800715576e-03   +8.757587755042053e-02   -2.836772251476261e-01   +1.660751386125896e-01   +3.104298123588095e-02];
L4_L5_iGABA_netcon = [-7.065725100380324e-02   +4.231293413913103e-01   +3.799246714572667e-01   +3.152789388043282e-01   +4.226391482377796e-02   -7.529532142446749e-02   +2.764005931614111e-02   +1.194300675604431e-01   -1.201999897174700e-01   +4.051175649472318e-01   +1.166981702512541e-01   -3.999603204090963e-01; -2.124532414916684e-01   +6.062633917403872e-02   +3.748327613897507e-01   +2.022910336989509e-01   +4.330309109872903e-02   -1.478748474898184e-01   +2.465207807154058e-01   +2.454948168397465e-01   -4.228815697187013e-02   -2.234201203646193e-02   +2.923029352267568e-01   +6.022501724825655e-02; -3.330252340639429e-01   -2.845032262576758e-02   +1.466651656031405e-02   -2.563851405497791e-01   +4.910331184804535e-02   +5.153323347707713e-02   -2.289643971916460e-01   -1.822301948012277e-02   -3.647070260961842e-01   +2.979766494248868e-01   -1.774475641290763e-01   +2.256594287243507e-01; +2.739464909198145e-01   +1.761142893558759e-01   -2.931586119781018e-01   +5.160056666021013e-02   +2.459284744942179e-01   -1.754871374470920e-02   +2.049164033812365e-01   +2.494281527115274e-01   -6.604397762978398e-02   +1.065118535991861e-01   +2.324189259861267e-01   +2.543832044385258e-01; +2.679852795099492e-01   +1.650620084812905e-01   -1.575718991609188e-01   +6.097663604510841e-02   -1.290269463103559e-01   +2.718976617345728e-03   -9.264847121994019e-04   -1.350865040722382e-01   +1.384393112549635e-01   +3.984487079567035e-03   +2.334505571537281e-01   -1.608223949533170e-01; +2.110056952760275e-02   -9.052761078194768e-02   -1.968394807645217e-01   -7.104453456568970e-02   +1.533422462192103e-01   -5.752592416624867e-02   +5.435507355358584e-02   +2.368692531369507e-01   +1.252196682921154e-01   -4.318125219978777e-02   -7.391097239362578e-03   +2.161521994125053e-01];
L6_L4_iAMPA_netcon = [+6.495804268352620e-02   -4.417459755133136e-01   -2.241604034946257e-01   -1.758710338725840e-01   +5.525368167631304e-01   -1.141854409281020e-01; +5.983047231242711e-02   -3.298550502618326e-01   +3.891064090608258e-02   -1.460205915240074e-01   -1.611753410113737e-01   +1.660901266656827e-01; -1.066021781732171e-01   -3.872681565654227e-01   -5.355207992938538e-03   -9.386544071742735e-02   +8.090114901122873e-02   +1.532441863548443e-01; +1.467710239153523e-01   -3.343605764335378e-01   -2.252631972945554e-01   -2.021896533826354e-01   +3.282530667354697e-02   +2.703250165069304e-01; -1.555110609629752e-01   +2.018573710270717e-01   +1.408134489543889e-01   -1.717359826086631e-01   +6.689043830248237e-02   +9.695377177226305e-02; +1.365610640896344e-01   +1.114888137864767e-01   +2.541096068181531e-02   -1.071101908983493e-01   +2.159085688899010e-02   -3.090472596564974e-01; +9.549251849767319e-02   +2.433302928589605e-01   -2.910629289270238e-01   -6.146331490218088e-02   -2.417335225183777e-02   +2.986556675824491e-01; +1.760038140308139e-03   +4.994027505407361e-02   +4.639881204508688e-01   +1.609972524355737e-01   -1.600557125916456e-01   -1.621685139054905e-01; -4.540285608336247e-02   -1.749652808685757e-01   -1.671630161897471e-01   +7.850742531149389e-03   +2.788570154878924e-02   +8.181576420934189e-02; +3.949761001273928e-01   +4.914661330287605e-02   -8.059079449828514e-02   -3.977443039298849e-01   +5.081410313040615e-01   -1.373037175831767e-01; +1.174924931196313e-01   -9.309659110868479e-02   +2.021548575165188e-01   -4.593601063394182e-02   +2.874267175619446e-02   +6.853952862891469e-02; +1.615634726693523e-02   +7.575310846385996e-02   +1.776809162338766e-01   -5.790747152700237e-02   +5.438209001391064e-03   +1.474073352261489e-01];
L5_L4_iAMPA_netcon = [-3.302088536056210e-01   -3.772743496681618e-01   +1.424946669431836e-01   -1.012823801759287e-01   +1.156676933688347e-01   +2.338709547486101e-01; +2.495632556105341e-02   -2.715214917294512e-01   +2.769949961261592e-01   +3.148317505801782e-02   +2.632636258195659e-01   +9.206161635727676e-03; +2.067139178806574e-01   +3.506770862350603e-01   -1.144788625899086e-01   -1.182739835196213e-03   -4.592976658082855e-02   +3.452870319165922e-01; -2.929234832585782e-01   -1.969252614564682e-01   -1.467665185672465e-01   +9.862740196515320e-02   -1.937962707739778e-01   -1.176938720165683e-01; +1.316347559168571e-01   +4.588754707695639e-01   +1.143415304345018e-01   -1.308616416262764e-01   -2.199719158150122e-02   -2.873443412129537e-01; -1.478693727779223e-01   +3.140497250134971e-03   -1.038973019930592e-01   -1.694110876611059e-01   +2.173805634463310e-01   -8.478497288727366e-02; +4.788480226023939e-02   -1.457900762063658e-01   -1.743486104609468e-01   -2.200627449094335e-01   +2.348884202026835e-01   +1.540365982334224e-01; -4.719360866612200e-02   +2.843482254103710e-01   -1.571689063595982e-01   +8.549341299925861e-02   +4.131587778665870e-02   +2.488201820539720e-01; +1.037420878709404e-01   -7.854349223015406e-02   +9.546571259797282e-02   +3.170321394416603e-02   -1.261423348737474e-01   +1.077415606640697e-02; +3.512548708975009e-02   +2.346383366468713e-01   -2.084710378878542e-01   +9.416267344636042e-02   -2.612714362465560e-01   -2.227770476423984e-01; -4.759575117083448e-02   -1.228430352701161e-01   +3.870843803543046e-01   +2.202541991815912e-01   -5.907223189451246e-02   -1.670944955912577e-01; +1.261998238184383e-01   -3.395839657079933e-01   -1.413276726340466e-01   +5.714682566274422e-03   -7.032135840376048e-02   -3.428761383319327e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
