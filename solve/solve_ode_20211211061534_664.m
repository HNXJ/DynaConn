function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.371239078446895e-01   +4.400245191448404e-01   +7.469345727592483e-02   +4.717646627269075e-01   +3.503535320539623e-01   +1.115372407331976e-01   +2.231595525084585e-01   -1.647319698120086e-01   +4.568317295774350e-02; +7.535764481560495e-02   +3.385175546279739e-01   -2.219185576659834e-01   -1.999289931200439e-01   +2.437785079905136e-01   +3.867929187313196e-01   +8.348998688993994e-02   +5.619965178122406e-01   +5.340551714499442e-01; +9.420699436655033e-02   +2.762143238593331e-02   +3.092844660889173e-01   -5.344389473343591e-03   -1.099280141285125e-01   -5.095496405469513e-02   +3.034143956066321e-01   +2.144959618740812e-01   +4.247908604281997e-02; +3.513787914815967e-01   -2.059708078633095e-01   +5.405222807117082e-01   +9.295240429759044e-03   +2.239642825912135e-01   -2.330277592189532e-02   -1.126560928501226e-01   +5.037543631530880e-01   +1.517581964485194e-01; -5.082635779158409e-02   -1.024621922092677e-01   +2.913482433494467e-01   +3.232104044748528e-01   +4.220683731403952e-01   +8.293807728218910e-02   +1.072704990844449e-01   +4.498431342073262e-01   +1.592263428259532e-02; +3.141016636559028e-01   +8.646604813117575e-03   +6.289820860616090e-01   +1.038933173458597e-01   -1.687065445312887e-01   +2.118761802871243e-01   -5.258596599221552e-02   +1.180139642922626e-01   +1.555862790835028e-01; +5.076724053122362e-01   +8.759103794102917e-01   +1.711006194402895e-01   +5.615217251872493e-01   -6.095003173486140e-02   +1.806134095681139e-01   -1.371155669255169e-01   +3.595948389918880e-01   +3.420265872749528e-01; +5.583185637645263e-01   -2.530261215765903e-02   +6.191676171592757e-01   +4.103149023382403e-01   +3.318010346529239e-01   +2.567541025933550e-01   -2.292969753391111e-02   +2.649496040840339e-01   -5.328188228699083e-02; +6.411246476729028e-01   +4.912615268044682e-01   +4.609732011065700e-01   -2.100384610670904e-01   +1.636824570939164e-01   +2.631912224636198e-02   +3.430467862763477e-01   +2.542727409800193e-01   +3.304934336828091e-01];
L1_L2_iAMPA_netcon = [+4.062335102412371e-01   +5.020007624117820e-01   +5.087686198897423e-01   -1.848948673937864e-01   +5.809242989835535e-01   +3.792532815392260e-01   +3.089710929512337e-01   +3.854490875118079e-01   +1.088792966931861e-01; +2.232478645535310e-01   +1.450713061204073e-01   -4.092550231331149e-03   +3.493650956880993e-01   +4.723435541722333e-01   -3.644391604210395e-02   +7.125347429672016e-02   +4.210566820676384e-01   -2.599848438735090e-01; +1.790235784376051e-02   +3.626803397179774e-01   +1.141880023092485e-01   -1.558899309785639e-02   +2.737648981869745e-01   +1.546269620872215e-01   +4.058575176357635e-01   +2.292818327389419e-01   +1.175354796009490e-01; +7.988229891318221e-02   +6.467730214273576e-01   +8.929785862292158e-02   +4.707573986296748e-01   +5.024440998431166e-01   +1.984129239391506e-01   -2.456738954270695e-01   +1.960511215826968e-01   -5.655119685188606e-02; +2.570219942677965e-02   -3.080250270363022e-01   +1.790930413316191e-01   +4.840904692732558e-01   +5.429827052827604e-01   +3.134821184082017e-01   +6.507538614623148e-01   -4.938918571963601e-02   +7.125378883198755e-01; +5.840000107400123e-01   +2.723485008861811e-01   +1.516363772892572e-01   +6.922605915057659e-01   +4.355032537604248e-03   +2.591108021878757e-01   +1.847540360832397e-01   +3.374530203652132e-01   +4.128091382717386e-01; +3.668769766416722e-01   +1.977995076573057e-01   +6.248305489689642e-01   -1.446900284326180e-01   -3.973971508861882e-02   +5.760456590522314e-01   +2.616248168541895e-01   -1.523044091387532e-01   +7.004720853402904e-02; +5.067740101392717e-01   +1.314182834873953e-01   +2.084759034506350e-01   +2.239256689602823e-01   +1.060241894099199e-01   +2.588511387081386e-01   -1.953393536966732e-01   +7.947505362460048e-01   -1.449725401859378e-01; +7.113158347414736e-02   +1.984186353397900e-01   -1.453914408078458e-01   +4.751711453342489e-01   +7.303881980648517e-01   +1.017258361128075e-01   +5.985191439640491e-01   +3.681108995007189e-02   +4.511155273324852e-01];
L2_L5_iAMPA_netcon = [-3.103792276994621e-02   -1.299121242319326e-01   +2.213030114193104e-03   +1.771065407495718e-01   +1.401519650661403e-01   -1.155684799464970e-01   +2.697191949966447e-01   -1.912080652361002e-01   +1.510289132779125e-01; +5.222386863847399e-01   +3.205879943841480e-01   +6.782860965085543e-01   +9.360830680395893e-02   -4.759558103523597e-02   +5.386260778270174e-01   +3.543965647442804e-01   +2.225429564347486e-01   +6.437598903684973e-01; +3.649831380398371e-01   +2.263072195753063e-01   -2.164506101047928e-01   +1.392339685056559e-01   +6.174394459705470e-01   +2.173455298365927e-01   +1.782785972964147e-01   +2.149416915414442e-01   -5.468518866050186e-02; +3.218445919288682e-01   +4.118773407066365e-01   +2.061526740610209e-02   -7.335195391549712e-02   +8.398069993161672e-02   +1.224705211095874e-01   -2.280698045724897e-01   +2.852732493482575e-01   +2.449792113236392e-01; +3.559644311251081e-04   -1.672858528275246e-01   +3.786852589956247e-01   +2.525385728647375e-01   +3.624453372867938e-01   -7.798685755761425e-03   +2.282756110667626e-01   +3.285772881057172e-02   +1.516123554109593e-01; +1.652663801260978e-02   -1.537523568164155e-01   +1.342969037630992e-02   +1.444333576477866e-01   +7.920482046360733e-02   +9.145588623474624e-02   +3.717986813582311e-01   +1.013203054873432e-01   +3.594434591746956e-01];
L5_L2_iGABA_netcon = [+8.676298785910611e-02   +2.582913394474264e-01   +3.666029398791881e-01   +4.621759590237842e-01   +3.451729975185982e-01   +4.317203504519843e-01; -8.436066305038548e-02   +4.650127237198461e-01   +6.133090718827969e-01   +1.975765811789159e-01   +3.882948018803347e-01   +5.301578934899123e-02; +2.697262812656649e-01   +4.069218149767878e-01   +5.851966519018790e-01   +3.525054309818434e-01   -1.355104327643294e-01   +3.558168928018358e-01; +2.754395084588391e-01   -3.526945143825093e-01   +2.510031993667660e-01   -9.324773835378176e-02   +3.223054639853752e-01   -2.460839519463186e-01; +1.181758274523719e-01   +1.167264920312044e-01   +4.215439430663405e-01   +3.286845999179923e-01   +3.598745328805784e-01   +3.392978932440569e-01; -8.899970190172500e-02   +4.419326895101977e-01   -2.767551713380186e-01   +4.667599081795188e-01   +3.228125412327804e-01   -4.596569594556899e-03; +2.516411779319570e-02   +1.751227940822371e-01   +4.463323283706070e-01   +5.678407965361596e-01   +1.552484327478920e-01   +4.296822595467409e-01; +3.292462849501995e-01   +7.796976071539707e-02   +1.127789826841142e-01   -1.761912788077845e-01   -4.298732321672227e-02   +3.967219577655623e-01; +3.064577551806449e-01   +3.876241285709576e-01   +1.727216432716467e-01   +1.344937207422074e-02   +2.644591430391138e-01   +1.379246434150503e-01];
L3_L2_iAMPA_netcon = [+2.192115737634404e-01   +2.341992924442390e-02   +3.771092684917535e-01   -8.681692001543023e-02   +4.429764448389733e-01   +5.556535835470111e-01; +3.961960269307144e-01   +1.923778411617898e-01   +4.914623981953389e-01   +8.522404579414665e-02   +1.220913449918448e-02   +3.550162438625118e-01; +4.814706641993723e-02   +3.145077502624929e-01   -8.222140703667954e-02   +3.939124058742580e-01   +2.903818847769670e-01   +4.308832322351532e-01; +2.456889203127821e-01   -2.593486518892203e-01   +1.085011200439394e-01   +3.240059897050832e-01   +3.203210055530864e-01   +1.928058478767097e-01; +5.050081531215348e-01   +1.396416029697806e-01   +4.138688676309107e-02   +3.726487304748540e-01   +2.000785956255839e-01   +5.345729131423957e-01; +6.511536379794078e-01   -2.103802060310295e-01   -3.510826856945229e-02   +6.886173965581793e-01   +6.001305329654621e-02   +2.853477910639478e-01; +3.891320142113439e-01   +1.178675730543718e-01   +3.588120803034561e-02   +5.723665386175081e-01   -3.199217365718710e-03   +3.421559153485971e-01; -1.602726573808077e-02   +3.828216285361108e-01   +4.628863083087478e-01   +2.805317508542497e-01   +4.345157701161131e-03   +1.542839999250412e-01; +5.801841075544382e-01   +4.666399352339426e-01   -2.155180036789928e-01   +1.680593146939523e-01   +2.863628105283865e-01   +3.314164649851697e-01];
L2_L3_iGABA_netcon = [+3.538997673475652e-03   +2.958115778235281e-01   +4.799112682070764e-01   +2.775678320955090e-01   +4.258475146677934e-01   +4.527123705167051e-01   +4.633384402505605e-01   +1.263669028647484e-01   +1.407648871074471e-01; +1.804245465114265e-01   +2.014788004420798e-02   +5.116666746202428e-02   -1.345399119682655e-01   +3.272769571137631e-01   +4.951571552148547e-01   -4.499255967582816e-02   +2.000704417702751e-01   -2.832948702063850e-01; +3.887972674019633e-01   +1.610965494963448e-01   +4.976136879949237e-01   +3.258799415639657e-01   +4.829606947221968e-01   -6.161237460956143e-02   +1.255976439553554e-01   +2.063423920874573e-01   +2.108926452848450e-01; +3.099217972520101e-01   -5.637305130950940e-02   +3.063145373968821e-01   +5.965331252916637e-01   +2.803001485301451e-01   -9.410564673205118e-02   +5.098403278662796e-01   +2.940490820335551e-01   +2.108490046941082e-02; +1.538399380118446e-01   +4.356446763530392e-02   +2.555808734921467e-01   +7.490240306232432e-01   +3.461778934360500e-01   -4.452884236159498e-02   +3.179859373450961e-01   -1.042434124759486e-01   +5.708142199912346e-01; +1.174954460351692e-01   -1.050958096051100e-01   +3.754858461172185e-01   +6.173805366468885e-01   +5.280485222955039e-01   +4.832913926569364e-01   +1.812964745768144e-01   +2.056179728064402e-01   +7.911116173839601e-02];
L1_L4_iGABA_netcon = [+2.087903263388310e-01   +5.737788081120407e-01   -2.092295818945496e-01   +2.301973136335982e-01   +2.680604427057567e-01   +2.148358017749189e-01   -6.279116039399577e-02   +4.211717309177109e-01   +1.004456525069283e-01; -1.536418049317892e-01   +5.318896472677900e-01   +5.202666726030444e-01   +3.805623313307529e-01   +4.908801881991687e-01   -1.379089800849838e-01   +2.562794747039290e-01   -6.110376678310921e-02   +3.477182625858533e-01; +7.107730148709559e-01   +4.897381237204083e-01   +5.137755712470704e-01   +8.814826140122745e-03   +6.467659802658292e-01   +2.874906369275851e-02   +7.117307034966631e-02   +1.802578583353557e-01   +1.440426734766836e-01; -1.974105938994738e-02   +1.520181333898893e-01   +1.914726619161654e-01   +4.355134980217718e-01   +4.868294385757578e-01   +2.228100526448001e-01   +4.356374305213307e-01   +2.632269528993230e-01   +6.936917767667647e-01; +1.023249381531662e-01   +2.859631602790336e-01   +2.579882164559107e-02   -3.905616676720925e-01   +3.345193584468061e-01   +1.041811873503714e-01   +2.281272639050784e-01   +2.568646775298214e-01   +2.962932834084798e-01; +4.952081997875082e-01   +3.724649354194523e-02   +5.709100151652697e-01   +1.692594544028342e-01   +3.661130792342686e-01   +2.661641997184397e-01   +8.174392680974424e-02   +6.471532037425422e-02   +1.033190565001878e-01; +4.825548956584149e-01   +2.788906554995428e-01   +5.761894441100520e-01   +3.413831986929918e-01   +3.515426941825440e-01   +1.127854913780490e-01   +4.498468206261294e-01   +2.760133764353102e-01   +2.819833344467462e-01; +3.065450024928590e-01   +2.977660946350433e-01   -1.782573743760348e-01   +4.362256222556933e-02   -1.552491569700656e-01   +1.021450827894139e-01   +6.483814115274127e-01   +2.839207965682028e-01   +2.943103847153454e-01; +2.001096262961975e-01   -7.792932526730890e-02   -2.125607721254038e-02   +8.800355390794930e-02   +6.242229805744617e-01   +1.959849021906168e-01   +1.941837637734539e-01   +6.438623761254246e-01   -9.764458629477486e-02; +6.281114099983449e-01   +3.454751366182799e-01   +1.041931043825601e-01   +4.655983330566276e-01   +3.822243895693881e-01   +2.627291913580074e-01   +3.993433128313806e-01   +1.448989634672231e-01   +9.180060441680253e-01; +3.361756565008233e-01   +1.287011476021830e-01   +4.985205749866927e-01   +4.215107710910069e-01   -5.170497857185996e-02   -6.171334780128687e-02   +9.029174621258355e-02   +6.068015787813954e-01   +3.135002555246621e-01; +6.292487239622750e-01   +9.318339376252480e-02   +4.597092187070203e-01   +6.183154920787848e-01   +2.797011917401697e-01   +5.105611116778851e-01   +3.873044919811453e-01   +3.520562785226070e-01   +5.607215663580856e-01];
L4_L1_iGABA_netcon = [+2.271113617388004e-01   +2.171955521910329e-01   +4.502389410050744e-02   -2.256113814059163e-02   +5.020342735861882e-01   +8.182787770397988e-01   +2.511217940308157e-01   +2.725408301952504e-01   +6.264972173218497e-01   +4.923536123699522e-01   +3.065616137521066e-01   +4.789957471981978e-01; +1.814289375480441e-01   +4.472779979723652e-01   -1.421255517332660e-01   +4.475930676495025e-01   -2.966167893786623e-01   +1.930806811180326e-01   +4.465194730648901e-01   +7.822737005531277e-02   -8.333551329028180e-02   +2.492324634568459e-02   +2.907144006427084e-01   +3.025676141839534e-01; +4.796905943932017e-01   +2.570882060009044e-02   +2.574226632981490e-02   -1.441324958538011e-01   +3.207520916794141e-01   +4.914926175349245e-01   +4.842999626264313e-01   +1.618469669534659e-01   +1.816598819695344e-01   +1.198833757489994e-01   +4.143017999516702e-02   +5.467667011468070e-01; +2.815548487336365e-01   +1.488862948651645e-01   +4.680036522194427e-01   +1.315963944892538e-01   +6.315310287083337e-01   +2.222966892284688e-01   +2.677001462664412e-01   +2.363535285467492e-01   +2.025907411506855e-01   +5.204716821879432e-01   +4.068858121311497e-01   +1.264450312630505e-02; +7.281364161106367e-01   +4.357396615018325e-01   +4.512674218764567e-01   +1.907372450906077e-01   +4.562818609241055e-01   -2.060442238235950e-02   -5.743798518243784e-02   +1.220346286810447e-01   -1.487103571097723e-02   +8.096894782484307e-01   +1.639644019804447e-01   +4.248886664170228e-01; +5.329995759101992e-01   -4.229670119306597e-02   -3.257280056954440e-02   +4.721254884227789e-01   +8.033860284776481e-02   +4.697739361139219e-01   +2.313822138485312e-01   +2.938583503385104e-01   +4.284721061784543e-01   +1.517398937256485e-01   -3.391574787852453e-02   -1.689110656695555e-01; +4.155260269047134e-02   +1.670511160515648e-01   +4.006813314085371e-01   +2.281985414393653e-01   +4.235390724648391e-02   +4.635045413003707e-01   +5.654948810912053e-03   +3.213637507084429e-01   +2.338208124418600e-01   +4.630854013916944e-01   +2.418747241171217e-01   +4.619400369334001e-01; +2.436640926210131e-01   -8.918716317691894e-02   +6.891718158769917e-01   +3.202889727073247e-01   +3.252397407609721e-01   +3.093295786190135e-01   +3.873501101898056e-01   +7.762499757116544e-01   +1.329154374496908e-01   +1.112890081218468e-01   +1.946702434642936e-02   +2.399717283616649e-01; +8.316040782197016e-01   +3.569361476224082e-01   +5.463545968474428e-01   -1.039852058261513e-01   +7.795336750523909e-01   +1.116337838068012e-01   +1.150805910907493e-01   +2.297154134691923e-01   +4.293849321641135e-01   -2.929723365418219e-02   +2.301780164345484e-01   +2.071459520253949e-01];
L1_L3_iAMPA_netcon = [+1.385741263209067e-01   +1.353038626574670e-01   +3.735254124443318e-01   +4.405713115780167e-01   +9.879039619487648e-02   +3.824299500578033e-01   +5.248774448619353e-01   +1.785479226474035e-01   +4.257431458377615e-01; +5.416614905935462e-01   +6.024061969825342e-01   +4.538237362452609e-01   +7.332125633563225e-01   +2.298933138313926e-01   +1.475262188398495e-01   +2.159165144563975e-01   +2.827665267968384e-01   +6.032070655153595e-01; +5.959450665716202e-01   +3.932242183368763e-01   +2.706828464350368e-01   -4.370741760016046e-02   +3.491055380036384e-03   +1.057080924704766e-01   +4.645238508638502e-01   +6.327605481269268e-01   +4.306162875067471e-01; +3.883358140391650e-01   -1.876482527392805e-01   +4.611344884690909e-01   -1.234870556399235e-01   +2.378472450475876e-01   +5.278918437782110e-01   -1.755879565675872e-01   +3.155208133905200e-01   +4.469011239061897e-01; -5.089952087287963e-03   +4.791476872789270e-01   +1.344808504449830e-01   -1.652159303212963e-01   -1.720979732411147e-01   +1.937321051684096e-01   +3.767510499042152e-01   +1.105738061458876e-01   +3.170974298491870e-01; +2.357411965502173e-01   +3.791570473081236e-01   +1.567061895309327e-01   +5.372548587309133e-01   +6.720819313125238e-02   +9.475353816070091e-02   +9.910745963710657e-02   -2.776451195530490e-02   +3.950820222372582e-01];
L3_L1_iGABA_netcon = [+4.658617730729386e-01   +2.489567425201721e-01   +3.531555196338443e-02   +3.306762532616257e-02   +2.782939335809774e-01   +8.678779976946155e-02; +5.636946570837893e-01   +2.141337440023133e-01   +5.640081894434800e-01   +3.299522879542364e-01   -1.894888237942915e-01   +3.696047442802440e-01; +1.483959320303478e-01   +3.790001138987579e-01   +3.644229125327489e-02   +1.392437977555353e-01   +4.465501283665551e-01   +2.200382357353158e-01; +2.706784894568860e-01   +1.295996245133043e-01   +2.762265506244994e-01   +1.119883409858315e-01   +8.015217310174871e-01   +5.317284706867750e-01; -1.206569920474775e-01   -1.865099405078301e-01   +5.151534466782790e-01   +3.441634582280578e-01   +4.823659089508830e-01   +1.774506894871813e-01; +1.338415992447939e-01   +3.354684572673135e-01   -3.065578465025059e-03   +1.618221249727889e-01   +7.228916182903608e-02   +2.882406343655509e-01; +1.795258616554800e-01   +7.224951057561615e-03   +3.062580554183393e-01   +1.318820297659659e-01   +2.928050591536464e-01   +6.172685484497326e-01; +4.455177868915769e-02   +2.967085779366520e-01   +3.231180976194289e-01   +4.858976979985787e-01   -1.455190081319652e-01   +2.347886790300784e-01; +1.680745560856232e-01   +5.308593009700496e-02   +2.926314617579811e-02   +2.200448950348375e-01   +3.155245469064406e-01   -1.506074695547193e-01];
L5_Input1_iAMPA_netcon = [+3.261943466501332e-01   -8.516191771393664e-02   +1.146450512028208e-02   +8.210685790364350e-02   +3.028224107613752e-01   +9.594583888145039e-02];
L6_Input2_iAMPA_netcon = [+7.418094338818759e-02   -4.673038415057049e-02   +1.732901071843967e-02   +2.213471052953890e-01   +4.093388935556697e-01   +6.327038463684515e-02];
L5_L6_iAMPA_netcon = [+2.371764619075783e-01   +4.092199669747746e-01   +2.199708119551296e-01   +2.351585816114833e-01   +4.354778993557178e-01   +7.269304976086766e-01; +2.648965785168512e-01   +6.349798933930063e-01   +1.294369236522142e-01   -1.136750678171536e-01   +4.912443327861345e-01   +4.102201186651913e-01; +2.006645283454335e-01   +5.301222750596630e-01   -1.472086426607292e-01   +7.308562687320156e-01   +2.356392076906242e-01   +6.043335588782189e-01; +3.831710925287227e-01   +4.223280700926737e-01   +5.402392078691299e-01   +5.005550551287156e-01   +1.576649505248361e-01   +2.601584601119601e-01; +3.096084789316947e-01   +2.438408875540213e-01   +3.801228405623224e-01   +7.476410773502980e-02   -6.087803341424659e-02   +1.452525211422681e-01; +6.095676838281041e-01   -6.551134803696834e-02   +3.523400231433134e-01   +1.214384940537145e-01   +3.510472603138195e-01   +2.089869540294411e-01];
L4_L5_iAMPA_netcon = [+3.269464243481239e-01   +5.625335453463840e-01   +4.531771123740093e-01   +4.466834809340607e-01   +3.228503424816321e-01   +2.224091489804149e-01   +4.137950915106213e-01   +7.666000736843703e-01   +3.108404371880392e-01   +4.073318544141126e-01   -3.648466662399309e-01   +5.600774648545623e-01; +8.021994907421918e-01   +5.811448530007144e-01   +2.149649597234486e-01   +2.041902759945678e-01   +2.106647876135783e-01   +5.299522370182455e-01   +4.842609328358377e-01   +4.958265141104511e-01   +1.295853261426353e-01   +7.074709291231704e-01   +1.697668991592380e-01   +4.514179182372102e-02; +3.711116122015717e-01   -3.157586007421254e-01   +4.684600385270384e-01   +7.410992945951731e-01   +1.136931902191527e-02   +3.662031969770491e-01   -2.805836283559691e-01   +1.563819907529017e-01   +4.195447813912063e-01   +1.006278751213749e-01   +3.986458074534223e-01   +2.273280402730834e-01; +2.327443136330533e-01   -2.709576111756410e-01   +4.421708128255475e-01   -3.406228896027713e-02   +4.399664977754333e-01   +1.595762291942901e-01   +4.105980626260202e-01   +4.828850084441919e-01   +2.389829736079760e-01   +1.408002933756234e-01   +1.238466103574644e-01   +4.072751148394330e-01; +1.976241566685760e-01   +4.296445139984563e-01   +2.283596275003499e-01   -1.652802683865247e-01   +6.391867357376713e-01   +5.091481979291468e-01   +1.036555529124520e-01   +6.901508662928927e-01   +2.281447623556095e-01   +4.676316545751757e-01   +2.311856570875093e-01   +7.254961425770687e-01; -3.282328619507345e-01   +1.627089576181169e-01   +3.996919976021549e-01   +3.840267788804940e-01   +8.105006308470214e-02   +7.901018860714539e-01   -7.031970949380645e-02   +2.966660755545920e-01   +1.446095153225914e-01   +2.859046927228497e-01   +6.267312724593072e-01   -4.145492089190686e-02];
L6_L4_iAMPA_netcon = [+2.777676688301183e-01   +1.414957057034918e-01   -7.963127284233854e-02   +3.608012134550203e-01   +4.006697099315882e-01   +4.337853727746780e-01; +2.605776795229029e-01   -1.664465619732088e-01   -1.706841913315787e-01   +3.009756048647419e-01   +3.812718113175584e-01   +1.065458440589140e-01; +5.064587570350456e-01   +2.852676407955507e-01   +3.832910974337973e-01   -8.115067536638315e-02   +1.758377653181498e-01   +5.445270988743093e-01; +4.250083140477657e-01   +2.048753434745293e-01   +7.551137048683306e-01   +5.137368330669916e-01   +2.553807302325132e-01   +4.932835553510022e-01; +1.959396221009187e-01   +3.636295749190294e-02   +6.139975339027026e-01   +2.629166565269364e-01   +3.780372986760571e-01   +4.851603473535517e-02; +1.440333459229991e-01   +4.228272419586903e-01   +4.509843461337216e-01   +5.002559407817359e-01   +1.286480897504991e-01   +6.573643015924706e-01; +1.338999427619969e-01   +4.530116021332804e-01   +5.509312628946834e-01   +3.955311870094022e-01   +1.384601731957838e-02   +2.302356899090005e-01; +1.888924883634813e-02   +4.732153792590130e-01   +7.987955093735093e-02   -3.748353499501346e-02   +2.677288698186767e-02   -1.472143086542683e-01; +3.100411924115473e-01   -1.046578322826048e-01   +5.974407897539693e-01   +7.391822872715095e-02   +2.333680584061770e-01   +7.181162780092060e-02; +1.031675483631453e-01   +2.159152648535164e-01   +6.550771453661272e-01   +9.658099036915135e-01   +8.194150678679728e-01   +6.546985071997519e-02; +6.567897904238457e-01   +2.533151091069010e-01   +2.837671375356637e-01   -2.484379938336326e-01   +3.481953522877781e-01   +1.577420108514303e-01; +6.064681747749228e-01   +3.938331976992303e-01   +1.505945177344278e-01   +5.374611930053207e-01   +1.121699236823434e-01   +2.676049692850347e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
