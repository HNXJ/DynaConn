function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+9.082889534426244e-02   -1.609944712144747e-02   -4.587215121459864e-02   +4.909419472267994e-02   -4.947566243608190e-04   +7.854155641509934e-02   -9.548868777602398e-04   +1.846555267471596e-02   -6.742699369462399e-02; +7.965947412605152e-02   -1.160063849255593e-02   -2.276318909678956e-02   +7.375579164611878e-02   -3.534293924652994e-02   -8.426222757186992e-02   -4.712911181849063e-02   -3.225717187294334e-02   +2.039043464988380e-02; +2.197119823292576e-02   -2.688924366786492e-02   -2.902060853913673e-02   +3.093909233772004e-03   -4.478718213966527e-02   -1.042275269049155e-02   -2.390288790374327e-02   -3.859675252784780e-02   +7.467156820931822e-02; +2.960909295415988e-04   +1.411798713550204e-03   -3.222066404629327e-02   +2.199716085282176e-02   -5.549309277408886e-02   +2.497635768287458e-02   +2.545814978224205e-02   -1.031165449584426e-02   +2.573452474960210e-02; -1.570039834602972e-02   -2.671414445868225e-02   -5.711085745720876e-02   -7.836177077304760e-02   -4.964604477482479e-02   -1.902988648353455e-02   +2.791037932129792e-02   +3.614220113589416e-02   -6.604340082420064e-02; -1.240756018504968e-03   -4.540374787221850e-02   +5.953092772319059e-02   +3.974188921426085e-02   -2.411758395915825e-02   -7.883458653397570e-02   -5.979826976515104e-03   -1.640188625046449e-03   +6.697697723183812e-03; +6.912169084798273e-02   +1.093743396485316e-01   +2.627819563268277e-02   +3.247253482883029e-02   +4.211604000948414e-02   +8.147296418140250e-03   -1.799348155308817e-02   +3.567220814116111e-02   +1.303407521884515e-02; +2.893936979247290e-02   -1.071496048336836e-01   +4.218406170532484e-02   +9.515004187138275e-02   +3.638670722695021e-02   -7.545068664418129e-02   +4.906242655917901e-02   +2.579931572652550e-02   -1.123943782492090e-02; +2.395479352495973e-02   +4.253579073225000e-02   -8.083593392521678e-03   -1.545186332363474e-02   -4.081159785617761e-02   +8.827767430886366e-02   +3.672391479253296e-02   +5.490495891010430e-02   -7.539064622622592e-02];
L1_L2_iAMPA_netcon = [-2.382421975529905e-02   -3.824276164616132e-02   -4.688982204078557e-02   +5.631113348374093e-02   -4.391691712882396e-02   -3.846555179475444e-02   +3.171787920764147e-02   +4.273050365830509e-02   -1.912028218213890e-02; -2.298708945701563e-02   +7.775944712759743e-02   -3.651235744413158e-02   -2.744811299150999e-02   +3.296952410244665e-02   +1.014421789656975e-03   +3.977735011804066e-02   +3.533264468203522e-02   +3.018052697503483e-02; -6.454848925367099e-02   -8.343288724207201e-02   -5.240400476770369e-02   -8.135318083448084e-03   +2.900828190901950e-02   +6.906999600267129e-02   +1.174820763785395e-01   -8.948734185509147e-02   -4.226128282012631e-02; -8.315533823008284e-02   +4.134268149902738e-02   +9.913006074804735e-02   -3.861722763234200e-02   -7.412901616561508e-02   +2.386246920251062e-02   -1.183083953487010e-02   +5.063566067179504e-03   -6.278722598733237e-02; -3.841248570816188e-05   +2.650038104520831e-02   -4.250954691182739e-02   +3.034076290379614e-02   +1.544473514982665e-02   -2.727424951385106e-02   -2.416438372493154e-03   +1.404349348795886e-02   +7.856422686959008e-02; +4.355891988300321e-02   +1.513728248802729e-02   +8.086144350718661e-03   -3.746852123154472e-02   -4.857386615726302e-03   +3.264806209263114e-02   +2.282980698200017e-02   -7.517030749146107e-03   +4.080775423247247e-02; +6.553145615818819e-02   +8.431671462334503e-02   -8.824410890498977e-02   -1.413569875325124e-02   -4.930547799467062e-02   -5.511119483277933e-02   +2.019447527459393e-02   -1.232641480091864e-02   +3.818166488844106e-02; +1.123329846529490e-02   -3.266271819372232e-02   -3.016938950119724e-02   -9.014335496804349e-02   +5.840987202604526e-02   +1.691690464005622e-02   -5.155443603887507e-02   +5.695375901316840e-02   -6.039617402466276e-02; +3.048623882190516e-02   -5.482559790564719e-02   +1.869384068788710e-02   +5.019367431207985e-02   +2.137688227280368e-02   +1.465628328491039e-02   -5.470462859044067e-03   +2.849095074716748e-02   -1.586913092677787e-02];
L2_L5_iAMPA_netcon = [+1.829690698480381e-03   -8.739118397730053e-02   -2.992516304463121e-02   +3.755581438565941e-02   +2.240781022983484e-03   -5.526717183290204e-02   +4.567165437933314e-02   -3.209898172355178e-02   +5.156543613039259e-02; -3.277382269353046e-02   -6.857847103741985e-02   +9.217560993154891e-02   +1.844058272849449e-02   +2.433747192711631e-02   +3.483741196993018e-02   -3.347125202559938e-02   +1.097554507219209e-01   -6.403299874618134e-03; +1.345061291079144e-01   -6.767967331116273e-02   +4.054697040318356e-02   -2.788812797978766e-02   -1.828525442832525e-02   +1.654710288735515e-03   +2.553971932867494e-02   -5.967268737100362e-03   +6.401322315636382e-02; -3.529621065444888e-02   +5.551327625666395e-02   +3.447753024517966e-02   +9.108843864811650e-02   +4.686008379903719e-02   -3.412277378475790e-02   +2.431523519586706e-02   -4.494278964886668e-02   -5.674478236902435e-03; +2.663378532220196e-03   -7.589121998700196e-02   +7.019218810202990e-02   -1.145038754791560e-02   +6.548734634162230e-02   -9.409043091758055e-03   +3.949148221978918e-02   +3.868539758353595e-02   +5.215013280682269e-02; +2.132048806928700e-02   -2.132961338181738e-02   -4.131151067018132e-02   +5.349673531943619e-02   -6.739785040310068e-03   -1.045232257505115e-02   +1.079269448047258e-02   +3.714024770775935e-02   +6.881409222696988e-02];
L5_L2_iGABA_netcon = [-4.577018219035926e-02   -1.636659744694420e-02   -3.597185071422104e-02   -1.970748254491730e-02   -2.025909133363723e-02   +2.100842122520610e-02; +1.583133164380100e-02   +2.893118332600450e-02   +6.336726493138084e-02   +4.456023244541062e-02   +4.263550660173493e-02   -5.575052886055558e-02; +2.826308098450363e-02   -1.827799084721559e-02   +1.447052784880136e-02   +7.435381471145475e-02   -8.528297364920806e-03   -2.189375994982606e-02; -2.396458517215979e-03   +8.482044292991453e-02   -3.566729597774015e-02   -3.324262714507192e-02   +3.160189414881455e-02   +5.713392979306967e-02; +5.042893064536727e-02   -1.098769614914573e-01   -9.348295542257655e-03   +4.693313544297528e-02   -2.295317518691354e-02   -5.487989758514643e-02; -3.786949374522249e-02   -1.872560563622259e-02   +2.649463141930699e-02   +1.400115543299564e-03   -4.388470176000652e-02   +2.575286315819565e-02; +2.444827776998719e-02   +2.610060301488973e-02   +8.190308236013393e-03   -1.908429741695120e-02   -8.235083668339235e-03   +2.512479819693195e-02; +2.525062703201911e-02   -1.537373795403755e-02   +7.858176045432055e-02   +4.042481882941475e-02   +4.389277275608434e-02   +4.254236861423089e-02; +6.894988106464861e-03   -1.764879267724150e-02   -9.251496709298401e-03   -7.692502408251582e-03   -1.045122887022753e-02   +3.287321780956490e-02];
L3_L2_iAMPA_netcon = [+3.062195621902027e-02   +2.016576620556821e-02   +8.002982744699660e-02   +6.762558617488029e-02   -4.783085026729031e-02   -8.006816187102708e-02; +2.255569281822288e-02   +1.743784091003848e-02   -9.679596193813745e-03   +4.152140902814651e-02   +4.319657937151740e-02   -2.005576856932423e-03; -2.272220112459106e-02   +6.821866319441165e-02   -3.179922938318028e-02   -5.358645613888295e-02   +7.594112074857311e-03   -4.068271695254112e-02; -3.332207496496358e-02   +1.693331492833038e-02   +4.986505714627709e-02   +5.475130055938894e-02   -7.863772348251796e-02   -2.389532125417508e-02; +7.056941743616120e-02   +5.241386315353652e-02   -3.618389210648309e-02   +5.109993608812900e-02   +3.859705119688495e-02   -1.305068056406879e-02; +3.051062642543642e-02   +2.786687055385377e-02   +5.656232634482201e-02   +2.976112578490565e-02   +2.278278625659594e-02   -1.129595464777690e-02; -1.746632387054221e-02   +1.845482156106585e-03   -2.802496852412238e-02   -6.433882132419918e-03   +1.651771864320920e-02   +6.129622599515134e-02; -3.232303019232649e-03   -5.947263611406337e-02   -3.743531469198168e-02   -4.976900021638461e-02   -1.627899032524831e-02   -2.371996976144781e-02; -1.305663415691612e-03   -2.821307187522881e-02   -2.694582233395337e-02   -6.538803937106845e-02   -9.064124412884669e-02   +1.598228467356537e-02];
L2_L3_iGABA_netcon = [-1.437727167093256e-02   +8.612927785058844e-02   +1.923899124141892e-02   -1.433215241471384e-03   -1.131948530104128e-01   -3.242550719051821e-02   -2.433521233223278e-02   -1.386040568118835e-02   -5.789248670092451e-02; -2.291273271541582e-02   +2.101413270492199e-02   -5.263839325364833e-02   +4.003617079078130e-02   +2.901022407071262e-02   -6.343936738778940e-03   -9.885212237163864e-03   +3.344571687953608e-03   +4.454342193085404e-02; +3.626287246989753e-02   -8.927020776583788e-03   +2.317894209037032e-02   -4.531866992908447e-02   -1.959390631106236e-02   -7.251794090754057e-02   +7.408609578198774e-02   -5.543048840301570e-02   -5.111958126755682e-02; +7.240671646257171e-02   -2.427699673149867e-02   -4.519317417169321e-02   -7.219132695371890e-02   -2.840104205679037e-02   +4.800175686884476e-02   -5.848220058171692e-02   -2.514647920028568e-02   -2.089406796057700e-02; +1.531771350511014e-03   -4.680892452739124e-02   +1.472236006720103e-01   -3.037912145805972e-03   -4.956131052749106e-03   -3.860004025969188e-02   +1.323885970551495e-02   -3.304261199352187e-03   +1.190627460166037e-02; +4.948540547393272e-02   +1.204359803350520e-02   -2.214469431156114e-02   +4.070150772748070e-02   -3.606948569627400e-02   -4.481937455117511e-02   -1.164821910084322e-01   -1.378847711705590e-02   -6.143698671556039e-03];
L1_L4_iGABA_netcon = [-1.190805886443511e-01   +2.015991188634114e-02   -1.076387278626111e-02   -5.390817452081141e-02   +1.837878365196213e-02   -2.424231688970465e-02   +1.451098849353738e-02   +1.097594468561163e-02   -8.451650878824254e-04; -4.308620816349383e-03   +4.610501522474145e-02   -3.050023655576758e-02   -3.260443506028894e-02   -8.763188843827510e-02   +1.105470416757331e-02   +6.290435653307347e-02   +2.619623253614317e-02   +1.563191465614960e-02; +7.138332015768209e-02   +9.155146973362523e-02   +6.873128772759148e-02   -1.692139131076361e-02   -4.588159708543961e-02   -1.236324008356746e-03   -5.810932197083007e-02   +4.562837265363044e-03   -4.482294107632598e-02; -9.972873307446613e-03   +1.263135162040255e-02   +9.256048210934294e-04   +1.579683243746391e-02   -4.253383013991990e-02   +1.557178119011982e-02   +3.320799497048938e-03   -5.652992312078622e-02   -4.155574432511229e-03; -3.316676279593508e-02   +1.178281353596033e-02   +7.008670084580317e-03   -6.973890017932982e-02   +3.220925000210256e-02   -1.833132888370176e-02   -2.067996479343837e-02   +4.828593457896956e-02   -5.258508163015472e-02; -1.661398932639134e-02   +2.922837687366439e-03   +1.295165191042180e-02   -1.051484154765678e-02   +6.564839841386294e-02   +2.758477075833843e-02   -2.525138760373014e-02   +7.944406280463812e-02   -6.746187751816682e-02; +4.049551348703415e-03   +1.355958109057939e-02   -8.832317492379876e-03   +1.344935781062503e-02   +3.004846132653734e-02   -2.596882692481189e-03   +4.058499014410018e-02   +2.160641902302820e-02   -3.098398685394300e-03; +2.150745255605305e-02   +4.612674686733277e-02   -2.914678150597792e-02   +1.177538904815616e-02   -4.824885909307096e-02   -1.806169780453229e-02   -3.125421382426059e-02   +8.731267277354057e-02   -4.075841213117114e-02; +1.522175709246738e-03   +3.825309581835540e-02   -3.293227871043706e-02   -5.671834629536146e-02   -9.553489048566182e-03   -1.767891106520557e-03   -2.356715472084197e-02   +6.150243065987051e-03   +2.033367841788052e-02; -3.516341937100376e-03   -7.530524234435865e-02   -4.093500144614595e-02   -3.036736189972734e-02   -3.865660851555627e-02   +2.266358773597161e-02   +3.036599531157359e-02   -6.965116422090395e-02   +5.508914060766847e-02; -6.131609237137962e-03   +2.726908464901913e-02   +2.652046245551955e-03   -7.125007728150945e-02   -1.432359121857326e-02   +8.040417240752037e-02   +1.116787578570583e-01   +1.688353858538676e-02   +9.030550218811544e-02; -3.460142251353311e-02   +1.731256407459423e-02   -4.234556065443072e-03   +3.949127685788238e-03   +3.302305674723704e-02   +2.863059160849698e-02   -7.758379106096737e-02   -4.732992406011730e-02   +2.623850870123074e-02];
L4_L1_iAMPA_netcon = [+3.129709852792983e-03   -1.121601577207889e-02   +1.633060052276050e-03   +4.879902472396501e-02   -2.896429783346434e-02   -6.801437195588229e-02   -3.475657344687077e-02   +5.965510390544593e-02   +1.190735762693733e-01   -3.931704503032479e-02   +2.253553905032121e-02   +2.207389341227410e-02; +9.076083429400855e-02   -1.802699778916756e-02   +5.083948771025025e-02   +7.250799883853043e-02   +6.200702306258561e-02   +8.799689999641346e-02   +5.478908814749112e-02   -3.759184354127840e-02   -5.170044586816558e-02   +4.274983245889247e-02   -2.465663380477750e-02   -1.741992888890626e-02; +8.223533474367200e-03   +4.941636053308560e-03   +7.679682654583070e-02   -3.741973571970276e-03   +5.326830516382604e-02   +1.981086120284259e-02   -1.591734254244222e-03   -7.112471020445831e-02   -1.800914780433294e-02   +1.951487238756863e-02   +6.303934970842744e-02   -2.035420581474312e-02; -3.619438069099994e-02   -3.374867482041576e-02   +1.288161975355542e-01   +7.057889114646564e-02   -5.264673418691327e-02   +2.278592151959988e-02   -1.112049310336559e-03   -1.512643986537223e-02   +5.861546900856408e-03   +3.937902619723120e-03   +3.459626189648431e-02   -5.570231621856711e-02; +3.380488932902895e-02   -1.846131062589923e-02   -4.849565427242405e-02   +4.183271913537676e-03   -2.926449412325399e-02   -4.055561184063599e-02   -3.770718244728744e-02   -7.706930187506403e-02   +1.970115947083965e-02   -7.096810880031928e-03   -3.062183011027904e-02   -1.239310664880037e-02; -2.161644026128146e-02   -1.925029701189310e-02   +3.051418280355746e-03   +1.491215482820290e-02   +4.059192866572984e-02   -4.352453768562786e-02   -7.582720317441024e-03   +9.739862898444147e-03   +9.024111015844119e-02   +6.178857879853869e-02   +6.150794207017540e-02   -2.061602706620149e-03; -1.429955417354267e-02   -5.355976733554234e-02   +2.691236965844649e-02   -1.102566245781658e-01   +1.871549165680635e-02   +4.579642493676012e-02   +1.773083006379295e-02   +6.375640628992582e-02   -7.400649293811667e-02   +2.974260585225104e-03   +8.570929343153452e-02   -7.252556230348713e-03; +3.989288993990441e-02   +5.375726966148242e-03   -5.072877649535346e-02   +2.482442135460653e-02   -2.709676928667402e-02   +3.448725322394557e-02   -4.479383851744508e-03   +3.025857794402042e-02   +1.910241659541632e-02   -8.200217712825235e-02   -2.253578478663114e-02   -2.077987534696328e-02; +3.864617414106497e-02   -6.404129182588930e-02   -4.707851566527778e-02   +2.394232850968184e-02   +7.383602689191046e-02   +6.614897553671659e-04   -1.640440528602204e-02   -2.029402211656043e-02   +4.791016693484972e-02   -7.474128862667163e-03   -4.618839014674299e-02   -1.130921323135230e-02];
L1_L3_iAMPA_netcon = [+1.326360424312547e-02   +5.432734755143764e-02   -4.202992033163959e-03   +1.033154500772813e-02   -9.908894674050747e-03   -4.708071405376369e-02   +5.270818059786719e-02   +6.460652027252867e-02   +7.431953717753666e-02; -5.062056283560474e-02   -3.183546666260158e-02   +1.811594754977122e-02   +3.003979342319148e-02   -3.367701336995374e-02   +3.095158097119660e-02   -1.890643121456062e-02   -1.400127859997325e-02   +1.200886062899862e-02; +1.775707625383043e-02   +1.014102941142504e-02   -4.117284755959510e-02   -2.041940613180394e-02   +4.476945540166968e-02   -2.722674723925697e-02   +9.301866544379171e-02   -7.406449547599017e-04   -8.708509358173612e-03; +3.094794381713112e-02   -2.831239711769618e-02   -1.592720784824064e-02   +3.317445218999315e-02   +8.942129634067927e-02   +1.956958200471767e-02   -4.148279986988210e-02   +3.727020741473420e-02   +1.392927578151887e-02; +6.605501565708488e-02   +2.620806318886651e-02   +4.837852780969749e-03   -2.984657313801920e-02   +6.214600595355835e-03   -5.123176847020444e-02   +8.955561330747088e-03   +4.502205568837923e-02   -1.958279548228520e-02; -3.973207267487543e-02   +1.779646259437424e-02   -6.145023847792044e-02   -2.086867837197967e-02   +5.669036593738210e-02   -2.498194427712105e-02   -1.880700938665172e-02   +2.387003764129284e-02   +3.963768082038063e-02];
L3_L1_iGABA_netcon = [-5.602944139439671e-02   +8.903812185326390e-03   -1.947029775415990e-02   -7.221362925739214e-02   -3.854291956215619e-02   +8.794195658872311e-02; -3.268458444192603e-02   -1.007132030160890e-01   -4.035492673418567e-02   -2.791716906506758e-02   +1.722761003278381e-02   +1.332062229488852e-02; -3.239570833768828e-02   -2.911165308027690e-02   -5.658883027731511e-02   -4.394247775793805e-02   +5.876535993453777e-02   +6.197813955676292e-02; +7.846424527349906e-02   -4.953690953630206e-02   -1.074863199480509e-01   -2.961620717967629e-02   +3.201446870623396e-02   -1.195760732286432e-02; +1.861875956126539e-02   +4.151894133385618e-02   +2.978332862374897e-03   -3.165436955053215e-02   +6.966406623739062e-02   +3.431661697231286e-02; -3.929302966755516e-02   +2.156057608204780e-02   +1.482191606139619e-02   +8.262424261449916e-02   -1.698387746254269e-02   -9.133363509231468e-03; +2.485820830060890e-02   +1.399835623488930e-02   +9.133456184052969e-04   +2.404711222237224e-02   -2.807531390037908e-02   +3.059441281294429e-02; -2.332828115238842e-02   +7.408410395939372e-03   +4.754770471806054e-02   +1.100303207540908e-02   -7.305726357411571e-03   +7.233090390646546e-02; +2.040995105208471e-04   +2.841189699294386e-02   +7.335219800726953e-02   -3.239761040981144e-02   -5.254841015310818e-03   +1.052936802971676e-02];
L5_Input1_iAMPA_netcon = [-5.210671373702322e-02   +6.465700882100019e-02   -4.328029937889832e-02   -9.129467509503414e-04   -1.281301769509034e-02   -1.956256429293843e-02];
L6_Input2_iAMPA_netcon = [+2.350319146021448e-02   -2.063004700725359e-02   -2.444787722145840e-02   -2.487525335287514e-02   +5.944232126107422e-02   +7.459254224159606e-03];
L5_L6_iAMPA_netcon = [-2.543181940411005e-02   -5.743025487602869e-02   -5.468979229037028e-02   +5.885124909357499e-02   -1.412735931414657e-02   -1.665184623805332e-02; +4.670526482615966e-02   +9.223760207646703e-04   +1.034833236310540e-02   +5.032335490262232e-02   +6.980945287548684e-02   +6.802048408242920e-03; -6.542920138386817e-02   +8.856247452684833e-02   +3.509434036101376e-02   +2.033638232395836e-03   +1.491046763767581e-02   +4.345493272682718e-02; -6.486783228081284e-03   -3.775052161469651e-02   -3.765482093983373e-02   -9.588792099931238e-02   -6.086415487863875e-02   -4.818113149352488e-03; +7.736939688801679e-03   -4.301017678498341e-02   +1.148353637662374e-01   -3.184169414705109e-03   -3.545038890077582e-02   +1.337850718289042e-02; -7.601644467056773e-02   -1.252675777186046e-02   +3.869268183542472e-02   -8.022591598466799e-02   +2.413406733796099e-02   +6.849055764972500e-02];
L4_L5_iGABA_netcon = [-2.771394294929739e-02   +8.916875744904462e-02   +5.696181909280924e-02   +7.835578565823340e-02   -1.690402113539276e-02   -6.877297981060225e-02   -9.167845593721410e-03   +3.051224084849915e-02   -3.136983133970889e-02   +2.526440810254433e-03   -1.845324718519432e-03   -1.015618365121591e-01; -3.231036958147121e-02   -2.271611197660436e-03   +1.132187091336895e-01   +8.992709580231035e-03   -5.591190899326238e-03   -2.860699090682787e-03   +3.635292920244473e-02   -6.393683632715792e-02   -4.928008101615344e-02   -6.594156552927746e-02   -9.162279094840308e-03   -2.019051793428983e-03; -1.017039315488236e-02   -3.364215916132844e-02   -1.440450759619074e-03   -6.362208108313805e-02   -4.938733492075848e-02   -2.025424172153841e-02   +8.331641027767636e-04   -4.206404907604177e-02   -7.288783734738799e-02   -1.765147287281761e-02   -2.315262187074094e-03   +5.529471885461623e-02; +4.412260505640966e-02   -5.212645105683294e-03   -5.747197190351683e-02   -1.001066960395747e-02   +5.116760624740545e-02   -7.929832376425952e-02   +4.144866062705441e-02   +2.941843696448702e-02   -1.784999540827113e-02   +4.172943573133817e-02   +6.057598213173838e-02   +9.083036560044436e-02; +5.763766690359967e-02   +1.112630660829095e-01   +6.588396982914364e-03   -1.540348094746237e-02   +3.670359390643715e-03   -2.161062173763743e-02   -1.625708774939938e-02   -6.346995167068926e-02   +1.336904054120613e-02   -3.904164322368947e-02   +5.317342329928011e-02   -5.815403735882370e-02; -2.770717313248017e-02   -3.971894024006562e-02   -6.205334702327332e-03   +3.153500084820401e-02   +3.337155507467864e-02   +2.389268080200007e-02   -1.080795522027702e-02   +2.849289114737371e-02   +5.512284429219948e-02   -2.270885664112951e-02   +3.270544469914725e-03   -1.261035233251714e-03];
L6_L4_iAMPA_netcon = [-4.791853182702359e-02   -1.380471687405674e-01   -6.494176640482099e-02   -6.267147982459928e-02   +7.054321127864346e-02   -1.220502584741881e-02; -1.374790708712770e-02   -5.201419171765304e-02   +5.484796979306485e-03   +3.978801090475102e-02   -5.266026335389337e-02   -2.058426149918686e-02; -4.352158277789682e-02   -4.734020488790390e-02   -7.314079637236524e-03   -7.306665006454144e-03   +3.535675357878409e-02   +9.155907412624198e-02; -3.470879170990347e-02   -8.474787180930361e-02   +3.073773946317727e-03   -1.255647094178884e-02   +3.396821912539986e-02   +5.264115666733633e-02; -3.691650052843651e-02   +1.317165558449795e-02   +6.066199039362208e-03   +8.318394318538494e-03   +4.637670298550842e-02   +2.315753991210094e-02; +1.641128493025941e-02   +1.092541193615468e-02   +4.692680762918288e-02   +1.293749617239144e-02   +1.725714302119264e-02   -6.142495294982758e-02; +2.943942580960362e-02   -4.412954577344416e-02   +1.258035977226582e-03   -1.674925877702716e-02   -3.064596160260667e-02   +6.058019294430879e-02; +2.295273511385922e-02   +3.881845639170536e-03   +1.231762496978057e-01   +2.789627180044634e-02   -4.773876182847380e-02   -2.743015334624696e-02; -6.139380691773818e-03   -1.317232852977369e-01   +2.301032044899351e-02   -1.665110538754962e-02   +1.009573543399972e-02   -2.762175105321230e-03; -1.888771239517831e-02   +3.992685508123962e-02   -3.742962980950910e-02   -6.514146149543729e-02   +9.600557394277177e-02   -3.904062579360837e-03; -3.157994051877478e-02   -8.180844839363041e-02   -8.332211873452452e-03   -5.611789892435669e-02   +8.190898134570317e-03   -3.077143385083535e-02; +4.039472576601939e-03   -9.037219412057568e-03   +3.960401148170384e-02   +6.062377051312910e-03   +7.244158580080869e-02   -3.053215794432449e-02];
L5_L4_iAMPA_netcon = [-6.811758067112947e-02   -1.137868955061422e-01   +2.026736170260050e-02   -3.228311504643366e-02   +6.975280165664019e-02   -2.738315042627843e-03; -4.848497803141593e-03   -5.579367481333135e-02   +8.206861873629900e-02   -4.274159709739623e-02   +9.383115957795907e-02   +4.369492604207836e-03; +3.517157750174654e-02   +8.999727811966990e-02   -6.398892737277351e-02   -2.082765788662332e-02   -7.329465246214516e-02   +5.475857561006909e-02; -5.281959324685129e-02   -1.018313463479670e-02   -9.202007348100765e-03   +1.309890537783582e-02   -2.728001659185401e-02   +2.638382990392367e-03; -6.079037339474146e-02   +3.746786639102966e-02   -1.129493150226632e-02   -1.700772778596166e-02   -1.947922884403333e-03   -3.996604356215726e-02; -4.015849085513032e-02   +3.584676290138953e-02   -3.959169096116693e-02   +2.806159723176063e-02   +4.567408460790442e-02   -2.886612524499554e-02; -1.691488197589334e-02   -4.153144272623469e-02   -1.233319535583613e-02   -6.733485140085982e-02   -2.148882747846307e-02   -1.246705459096403e-02; -2.360779397921819e-02   +7.805953946970202e-02   -1.169879756069822e-02   +6.440309658926247e-02   -4.177071042559029e-02   +4.305817756398007e-02; -3.648048811425304e-02   +7.946467448368619e-02   -1.378375648139065e-02   +1.274526259216338e-02   -6.393277188055427e-02   -4.599357095526344e-02; +5.613100397759855e-02   -3.599938805506843e-02   -2.938960677602686e-02   +9.048250311308608e-03   -4.350519393641140e-02   +2.328401269545867e-02; -3.720371084626736e-03   -6.945984163211533e-02   -3.298444929883512e-02   +2.444022196241398e-03   -2.359271999572233e-02   -3.602105807585433e-02; -8.178775680066606e-04   +8.423091553477653e-03   -3.451474093246460e-02   +3.343369008447991e-02   -3.627536603145071e-03   +3.025026948374215e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
