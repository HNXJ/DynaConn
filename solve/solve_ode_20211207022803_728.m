function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.229436886720601e-02   +1.453761527110840e-01   -3.594737307099050e-02   +3.948678422410972e-01   +1.483879213347905e-01   +2.401179698944274e-01   +3.021447678071632e-01   +2.946544881625914e-01   +2.599502081886771e-01; +1.924530382279945e-01   +4.802211925387862e-02   +1.072708962520584e-01   +1.952957006151503e-02   +3.481874349031817e-01   +3.331002149780758e-01   +3.010731722139934e-01   +6.333499451938604e-02   +8.591774883669590e-02; +1.279017743668229e-01   +2.209601195792041e-01   +2.066488928377389e-01   +1.975699732845505e-01   -1.891631178046904e-02   -3.200541639611364e-02   +5.158111174578230e-01   +3.693603805367807e-01   +1.130047676867119e-01; +4.426490979832386e-01   -4.379604066842036e-02   +2.124055619348159e-01   -1.365854166492479e-03   +1.845478729319540e-01   +2.234487709602800e-01   +1.176759637389422e-01   +3.560604573657181e-01   +1.361001323900247e-01; +2.015663814230840e-01   +6.992129800484539e-02   +4.304813521376959e-01   +2.400591164302606e-01   +3.524903736200316e-01   +3.974067401777349e-01   +3.392212992502252e-01   +1.001469124875762e-01   +2.329093490447426e-01; +1.660919624835243e-01   +1.448954131782917e-01   +2.386476816857276e-01   +2.989463695400166e-01   +2.203959466863532e-01   +2.349031428855513e-02   +4.170598561557209e-01   +1.198392482869020e-01   +2.803457593864844e-01; +4.009555675737250e-02   +2.089597850367946e-01   +1.923454624407507e-01   +2.205635302727153e-01   +6.772850568614426e-02   +1.937701186506506e-01   +7.471200699959157e-02   +3.890218105995799e-01   +3.288950365633843e-01; +1.551774351240587e-01   +1.067788073997685e-01   +6.501009427633452e-02   +2.206741809949023e-01   +2.847410859332452e-01   +2.126508266621468e-01   +3.054742278265383e-01   +8.387376857928663e-02   +7.074097627726256e-02; +1.221008700631059e-01   +1.533369564198547e-01   -3.894292542530359e-02   +1.940849368913899e-01   +1.099490729672505e-01   +2.733949587659645e-01   +2.031552147425616e-01   +1.142409348768886e-01   +9.421190299425777e-02];
L1_L2_iAMPA_netcon = [+2.939318743742588e-01   +2.892740822442681e-01   +1.582255751453199e-01   +1.693820826781609e-02   +4.494917436536110e-01   +1.493654395756609e-01   +2.937953847698015e-01   +3.324313283503698e-01   +2.743156054623430e-01; +1.913667428387970e-01   +7.787931600741102e-02   +3.449423979329839e-01   +4.493179289396748e-02   +8.675180720442889e-02   +9.487477863453590e-02   +2.133340335563708e-01   +2.193988502938273e-01   +3.506939337303604e-01; -1.648149099409471e-02   +9.242489689930311e-02   +3.584270509847589e-01   +3.611531633855302e-01   +8.325520313910262e-02   +8.298636007845123e-02   +2.155577623065563e-01   +2.146816380590891e-01   +1.247339110430642e-01; +9.159766366723454e-02   +2.233660239574489e-01   +2.296719939524692e-01   +4.164773962398937e-01   +2.481177876551372e-01   +6.180746826670347e-02   +1.373639455788634e-01   -4.343536789256773e-02   +4.076335380269917e-01; +1.455965379660069e-01   +4.342165365584797e-01   +4.273612953498637e-02   -3.029393511872464e-02   +1.891250587185093e-01   +3.429880355276771e-01   +2.066336936119208e-01   +2.488108428158623e-01   +2.522977812430724e-01; +3.201307922808271e-01   +1.800822246809418e-01   +1.237753066730914e-01   +3.846328603964836e-02   +3.801128562518455e-01   +6.767666606175057e-02   +3.853289140839992e-01   +2.953172511524453e-01   +1.003884569121757e-01; +3.492545110954961e-01   +3.843153128937213e-01   -3.113986145566483e-02   +1.797356373167487e-01   +3.239146246723888e-02   +1.111614471184062e-01   +1.817468833824415e-01   +4.846940547244901e-01   +1.867047951045784e-01; +1.923869512211992e-01   +1.448839552910170e-01   +2.986477671622482e-02   +8.896242941349135e-02   +2.116446585511899e-01   +3.326309569479250e-01   +2.887499810151841e-01   +3.952956525782079e-01   +3.758772702452643e-01; +4.675283470653767e-01   +3.338630594356373e-01   +1.963167562872271e-01   +2.281167078584724e-01   +1.798843716202892e-01   +5.213210725637151e-01   +4.212779046625543e-02   +4.760183086077120e-01   -2.485722351543157e-02];
L2_L5_iAMPA_netcon = [+3.210771407404387e-01   +1.372019586486404e-01   -2.957138652313995e-02   +4.018902528609249e-01   +3.154518115500583e-01   +3.083936209276098e-01   +3.252201526061140e-01   +3.640804255107243e-01   +8.449345109504069e-02; +3.028493281336043e-01   +3.790558415803806e-01   +8.045713534181147e-02   +4.243954553472197e-01   +8.541765835308768e-02   +6.224348486986408e-02   +8.858218815065975e-02   +6.006446945626265e-02   +3.647723707342012e-01; +2.083026299353843e-01   +1.903021031358996e-01   +1.959404155534516e-02   +9.635387441615771e-02   +2.017828584162456e-01   +3.673801011906153e-01   +2.461046065253819e-01   +2.280269004547140e-01   +2.998485778721939e-01; +1.138364511856662e-01   +2.548617234016499e-01   +1.018987358950107e-01   +2.435624987628825e-01   +2.216197969376505e-01   +3.447883939136596e-01   +2.984166785245424e-01   +3.804651590801473e-01   +2.290343250064493e-01; +2.655784167563736e-01   +1.513126605225453e-01   +9.469633741918562e-02   +1.765034866580866e-01   +3.698604042653580e-01   +8.667191931624135e-02   +1.021569580790876e-01   +1.536644907600515e-01   +6.199818906686166e-02; +2.716100506363135e-01   +1.620326019475017e-01   +2.383754411896096e-02   +4.201448517421363e-01   +1.216784327964960e-01   -6.568851109585139e-02   +2.130718104107387e-01   +3.320688182797556e-01   +3.419083226639726e-01];
L5_L2_iGABA_netcon = [+9.504708758756651e-02   +8.695877374633018e-02   +2.549356198710686e-01   +1.275469616838266e-01   +1.813057050293739e-01   +4.516987509091177e-01; +4.191962997507130e-01   -1.165083731144168e-02   +3.641265642322860e-01   +4.066623332128813e-02   +3.448917237919237e-01   +4.206112406142942e-01; +4.356738431289732e-01   +3.091643871232452e-01   +1.420286121632610e-01   +1.041541578841146e-01   +1.946404074262857e-01   +1.456606222378485e-01; +1.730269362325498e-01   +2.085959973289640e-01   +2.220256691194484e-01   +8.245290027462969e-02   +3.651867931391805e-01   -9.209011616462058e-03; +2.134568078149369e-01   +3.142999431706393e-01   +3.854614916329082e-01   +2.372759713911907e-01   +4.495211788110846e-02   +2.059816888400534e-01; +4.699830180248286e-02   +2.786270950759195e-01   +8.202448803420059e-02   +2.866950868122156e-01   +2.472322798605579e-01   +1.994713008984757e-01; +1.077658925752603e-01   +2.143315047856726e-01   +4.083055682453491e-01   +2.521827148602688e-02   +3.283522132370938e-01   +2.286752584238845e-01; +3.674183920082899e-01   +1.397351939399303e-01   +5.655999074926739e-02   +4.106279075448326e-01   +8.933829885294410e-02   +1.833137181430388e-02; +1.374836798240223e-01   +1.494434316233542e-01   -4.804753064193006e-02   +3.350649488920899e-01   +1.206896505286115e-01   +2.786162956356029e-01];
L3_L2_iAMPA_netcon = [+3.157864914779615e-02   +1.924510775826338e-01   +2.570304068985886e-01   +1.003930844829731e-01   +4.147756744765529e-01   +2.641906085781224e-01; +1.168968737974435e-01   +1.627422251386777e-01   +2.689678504196492e-01   +3.868689018215583e-01   +1.853419985569193e-01   +1.478822702537794e-01; +1.984997917960557e-01   +1.269533622162128e-01   +1.913332725289860e-01   -6.241672879176013e-04   +1.125768068229770e-01   +1.800249214976901e-01; +2.784907662660240e-01   +1.548433150104322e-01   +6.924963617995775e-02   +2.528489952270240e-01   +1.466318696840926e-01   +3.244827997783311e-01; +7.176559894543519e-02   +8.238927679572438e-03   -1.184063302181253e-02   +3.390431579144121e-01   +3.676464752695141e-01   +4.106157558721823e-01; +3.786968195175853e-01   +1.023869228242489e-01   +1.620057033849246e-02   +1.388272670553853e-01   +2.418934311830725e-01   +2.319237700104061e-01; +1.636256341581086e-01   +3.986158852432737e-01   +1.137636516348438e-01   +4.584089598608487e-02   +1.735809035805177e-01   +9.254359939476221e-02; +1.311117082812901e-01   +3.333717654279074e-01   +3.851975097881866e-01   +1.849827391990796e-01   +2.964822586517145e-01   +2.392387687721913e-01; +1.101306571436625e-02   +1.466821872012990e-01   +1.861286027856537e-01   -1.180325977763490e-02   +2.093869238825453e-01   +3.710030100253001e-01];
L2_L3_iGABA_netcon = [+3.391673601161433e-01   +9.081090617970028e-02   +2.118468655828067e-01   +2.905397054837436e-01   +2.179248655521873e-01   +2.737518330864632e-01   +1.909349188467794e-01   +3.524571502193485e-01   +3.893078986335520e-01; +1.253705651839225e-01   +4.924476176892213e-01   +4.308419101397287e-01   +2.568987280619338e-01   +3.032905146167842e-01   +1.083232474151700e-01   +2.235536184954870e-01   +1.345344974360976e-01   +1.078123864375972e-01; +1.187744862392145e-01   +3.090008182478074e-01   +3.383381899996914e-01   +4.004015355575493e-01   +3.984190800696444e-02   +2.846469887693081e-01   +3.405641846570471e-01   +1.489923445026285e-01   +2.174917933350843e-01; +1.004028662135569e-01   +3.567303584830138e-01   +1.192923253976428e-01   +2.979501914748359e-01   +2.858186714969069e-01   +1.601177904316702e-01   +1.166920354667722e-01   +1.577469584732369e-01   -1.459601540692893e-04; +1.278563472450204e-01   +2.929299910281328e-01   +1.575708703727648e-01   +1.907170204638582e-01   -6.177624308647343e-02   +2.860336765952603e-01   +1.136926837069139e-01   +1.755256752383421e-01   +8.961466043223468e-02; +4.595385614770011e-02   +2.498881260912285e-01   +2.623940965826180e-01   +3.353137761142903e-01   +1.658988011897951e-01   +1.515481373752931e-01   +8.656718035084790e-02   +3.321001481277557e-01   +4.599962853461895e-01];
L1_L4_iGABA_netcon = [+7.319396360099512e-02   +4.360909884929690e-02   +9.317236527899785e-02   +1.130879218065619e-01   +2.870277183485780e-01   +7.849575951999407e-02   +3.205302503798083e-01   +1.247078131664167e-01   +7.866076686115615e-02; +7.483409342460827e-02   +3.817760572107135e-01   +2.980034027039037e-01   +2.712767499352859e-01   +2.106337959024564e-01   +2.229445133130218e-01   +3.516261482969860e-01   +2.022535398538724e-01   +1.261970279178761e-01; +3.512503477928233e-01   +1.744128007682448e-01   +3.074479587046371e-01   +1.177358279248413e-01   +3.554975072729915e-01   -2.149553331007220e-02   +1.260316177773683e-01   -5.457477413287688e-02   +3.135047051651835e-01; +5.058802212310227e-02   +2.409974385453454e-01   +4.051571088266477e-01   +5.762350404544761e-02   -2.547032107988588e-02   +4.489253766411899e-02   +2.404239905030972e-01   +1.530584352786697e-01   +3.485522340477529e-01; +1.183100734789905e-01   +3.911312729476061e-01   +2.847255165364306e-01   +3.214089650606261e-01   +2.985936034298232e-01   +3.755004853789801e-01   +1.357893117090821e-01   +3.072447187371452e-01   +1.021192536599306e-01; +2.012887276001257e-02   +3.585803238362124e-01   +2.211659568034762e-01   +3.156557539536682e-01   +8.966603703168566e-02   +3.123710136375540e-01   +2.377645038034048e-01   +1.708018784349792e-01   +1.228208045958995e-02; +2.158870696934668e-01   +2.129633306556392e-01   +2.976004286122815e-01   +4.174889175747666e-01   +3.778953760493351e-01   +2.391615609411266e-01   +1.181670803577778e-01   +3.004962333249065e-02   -2.558329469958795e-03; +3.326478996655354e-01   +1.815832550615441e-01   +2.443477852189082e-01   +2.906171365987334e-01   +3.175137161271185e-01   +1.714540754981734e-01   +2.336230495403752e-01   +3.061104293640347e-01   +4.607898470449230e-01; +2.883839181542802e-01   +6.786140907769822e-02   -1.030877244435029e-01   -5.083956994417706e-02   +3.019075151147259e-01   +2.680407237337616e-01   +2.064451152832607e-01   +7.894568136972843e-02   +1.453743862437648e-01; +8.387482394206422e-02   +4.190705142265362e-01   +2.639300702390342e-01   -1.483870513805397e-02   +2.052817780116926e-01   +8.519287540518920e-02   +1.095409961997423e-01   +2.623495580023814e-01   +3.702561437992922e-01; +2.859424865063371e-01   +2.492926330197452e-01   +1.689536795255233e-01   +2.900659119478083e-01   +1.693344965040028e-01   +3.208876337168821e-01   +1.781553091961139e-01   +1.624275906864341e-01   +4.493656284305370e-01; +3.531153436867194e-01   +2.860321992964667e-02   -6.174149001538262e-02   +3.892110341291529e-01   +1.974723691704658e-01   +1.976647332311837e-01   +2.067520426861702e-01   +1.037430594813195e-01   +2.587615821981235e-01];
L4_L1_iGABA_netcon = [+1.603357594128810e-01   +2.205166593765033e-01   +1.931787634215411e-01   +1.939164943198687e-01   -2.184578631696349e-02   +3.181174527492060e-01   +7.085390356039339e-02   +5.679471939166517e-02   +3.219421446831073e-01   +1.260946425066012e-01   +1.377356272457729e-01   +1.932129069042973e-01; -8.035850011938284e-02   +5.915745139905856e-02   +1.688762432467304e-01   +3.364473693711727e-01   +8.869553227785874e-02   +1.290919568424514e-01   +4.438621480098111e-01   +1.678811638777370e-01   +3.919372791418926e-01   +4.017961009969512e-02   +3.804389770707648e-02   -1.675694821700341e-02; +1.047747318356903e-01   +3.226290283974121e-01   +2.931657545671527e-01   +1.644010203611156e-01   +2.588953046231689e-01   +2.535482927462862e-01   +9.201855611290655e-02   +3.313465696494820e-01   +3.190016188109787e-01   +2.463555861685995e-01   +1.137097665140917e-01   +1.603915605146428e-01; +2.292192512056736e-01   -3.362801304348456e-02   +2.035048934197867e-01   +2.051872879444138e-01   +3.673266625377800e-02   +3.001287726348303e-01   +1.443690757012048e-02   +3.611177911756672e-01   +2.102938613287310e-01   +3.234221079278232e-01   +5.326106116926391e-02   +3.672356785538666e-01; +4.066455068867187e-01   +4.446228910503494e-01   +3.078642698425357e-01   +1.290514166271332e-01   +2.449984497219454e-01   +3.121277478788307e-01   +3.974407301203658e-02   +1.837944190531241e-01   +6.978876963307935e-02   +5.053796914109545e-01   +3.324816095163264e-01   +3.881348685771984e-01; +8.276677968045559e-02   +1.524582745639005e-01   +1.086525321998775e-01   +3.511692310739051e-01   -4.977182226514529e-02   +1.527522490119259e-01   +2.977405447365014e-01   +4.249498287002543e-01   +3.863038768206130e-02   +5.526672608445715e-02   +1.289816732501806e-01   +3.970794072132224e-02; +3.068085419835319e-01   +2.506082322127287e-02   +1.539049727891765e-01   +1.154983087055746e-01   -1.057876794761387e-02   +1.577014466847756e-01   +1.676458479184283e-01   +4.206586815099697e-01   +1.462127988108989e-01   +1.390396699204037e-02   +1.154923337512151e-01   +3.769726514959112e-01; +4.032531331610646e-01   +1.400942069043815e-01   +9.411615941648838e-02   +7.949984443431264e-02   +4.215255391686081e-01   +2.062103488929012e-01   +3.233908235659623e-01   +2.082445021896494e-01   +3.892592453931093e-01   +3.617130131026751e-01   +3.050151685535210e-01   +1.553110760372143e-01; +3.335464816993734e-01   +7.123248758129624e-02   +2.940429644385839e-01   +2.202213712747513e-01   +9.640787831631181e-02   +1.864502729163611e-01   +2.199039427951548e-01   +4.213530083924442e-01   +4.157347211635905e-01   +2.201385460976408e-01   +1.594976552657200e-01   +1.138577130943200e-01];
L1_L3_iAMPA_netcon = [+1.464661707801050e-01   +2.355494096240963e-01   +2.806774239583270e-01   +3.049930536611867e-01   +1.365120311331624e-01   +2.845738923202423e-01   +4.845763090804059e-02   +1.418837310170749e-01   +3.815331814632555e-02; +2.155242724931002e-01   +2.195313936300880e-01   +2.471211338710849e-01   -2.194340380769557e-02   +5.849765043873231e-02   +6.276475792440654e-02   +5.516130641622460e-01   +9.744392735637233e-02   +3.165621882671010e-01; +2.833100766412597e-01   +1.718276086487853e-01   +4.953819178424962e-02   +3.113885379546997e-01   +2.315447094508468e-01   +4.132818861829971e-01   +2.243638077192610e-01   +4.196009668460012e-01   +2.621500418813749e-01; +2.700807708217009e-01   +1.769088640025843e-01   +4.426171895119735e-02   -4.924428655701422e-02   +3.566264006507849e-01   +3.288294667541525e-01   +4.259678177299357e-02   +2.966169218006079e-01   +9.047391049693083e-02; -1.087639985826124e-02   +2.085320654105970e-01   +1.303176516021307e-01   +1.770755975444737e-01   +1.327610373285236e-02   +2.726470752641643e-01   +3.045013770166838e-01   +8.655815129165667e-02   +2.540138652493344e-01; +1.655218076171019e-01   +4.027116090345777e-01   +1.853695397415376e-01   +6.544122822625636e-02   +7.218495379842725e-03   +2.377381197547812e-01   +3.800531729582327e-01   +2.279933060540314e-01   +8.314533394254585e-02];
L3_L1_iGABA_netcon = [+3.838524192143870e-01   +3.829401299768748e-01   +3.291687288229905e-01   +1.462569330748969e-01   +8.621565894870466e-02   +2.403606109496629e-01; +2.956349932376479e-01   +8.951954198624941e-02   -3.785754904789525e-02   -2.020428406894176e-03   +4.670008209428392e-02   +1.876139089146857e-01; +3.301162052094624e-01   +9.580273935392483e-02   +2.805734468411122e-01   +1.605378902546993e-01   +3.625752107136694e-01   +3.509969160936019e-01; +4.550056264367833e-02   +2.969266358232969e-01   +2.480346547678813e-01   +2.066420227187619e-01   +4.032353648228657e-01   +2.156267266634049e-01; +2.739985141733500e-01   +7.487751997471595e-02   +2.042473070853609e-01   +2.872789727603564e-01   +9.220395820730387e-02   +1.198995489903910e-01; +2.740792085955721e-01   +1.962257644524329e-01   +1.905652737119799e-01   +4.053891954781153e-01   +4.211902059541654e-01   +3.350302344974407e-01; +5.787371523190089e-02   +3.449417078787567e-02   +3.382622521158423e-01   +1.774514726351283e-01   +2.529678380914706e-01   +2.482172812579651e-02; +1.794483488910878e-01   +1.882042040192000e-01   +3.525575929188197e-01   +1.839587693628145e-01   +1.541538897837108e-01   +3.800404183245372e-02; +2.458404539533529e-01   +4.183861555638586e-01   +4.308519297300812e-01   +2.019688629760479e-01   +1.250878602487467e-01   +3.046612101742423e-01];
L5_Input1_iAMPA_netcon = [-6.869949648780123e-02   +2.864928905333947e-01   -4.348219443111058e-02   +1.480675763605988e-01   -6.760314380736615e-02   +4.897573333249561e-01];
L6_Input2_iAMPA_netcon = [+3.472248616307677e-01   +2.613276417455029e-01   +9.139102252808444e-02   +2.249999139014269e-01   +2.125776391280341e-01   +6.466854657659774e-02];
L5_L6_iAMPA_netcon = [-5.699665739955637e-02   +2.173126558621145e-01   +1.178670997546483e-01   +3.875271437309956e-01   +6.385752811553393e-02   +5.914233130748869e-02; +6.840731988470652e-02   +1.550766300365211e-01   +4.309758867787953e-01   +2.852367158405477e-01   +4.398391849731179e-01   +4.097221007513398e-01; +3.819542788876791e-01   +1.811466995589400e-01   +3.224865943224136e-01   +1.545727898391313e-01   +3.365234805295182e-02   +3.086585369902337e-01; +1.865948434174073e-01   +3.475437301899129e-01   +2.891142929942884e-01   +1.673667844919111e-01   +2.339705923014822e-01   +3.170962758558742e-01; +2.029353961018284e-01   +3.709947648377544e-01   +4.605817141103614e-01   +1.226054125917268e-01   +2.061724060678414e-01   +1.641099749417785e-01; +4.426606303500643e-01   -1.105484278135311e-01   +4.106103329162976e-01   +1.637024925016733e-01   +3.388523640598719e-01   +1.885705465257888e-02];
L4_L5_iAMPA_netcon = [+8.724730489027155e-02   +3.406867580401114e-01   +4.013674494690780e-01   +2.870123750811515e-01   +1.577887659668697e-01   +2.064426734460023e-01   +3.296530782437130e-01   +5.596680915573242e-02   +1.848483984857119e-01   +1.973984918397120e-01   +3.331406718362614e-01   +1.794233355620194e-01; +1.232727521237851e-01   +3.001653901020818e-01   +1.245252274347449e-01   +2.599368981225857e-01   +1.277512089087962e-01   +3.911347873249095e-01   +5.002547428884259e-01   +4.796741698495455e-02   +3.793019460974081e-02   +1.020166109168874e-01   +2.946574261918872e-01   +1.652365636018839e-01; +9.303969724945702e-02   +2.541435677356704e-01   +4.764716174396345e-02   +2.003254136490242e-01   +3.181609343598815e-02   +3.145574264334378e-01   +4.661440056026701e-02   +1.562483354719190e-01   +3.332607038158126e-01   +2.156277649455831e-01   +2.707527552210203e-01   +9.636933754445048e-02; +4.228837046837979e-02   +2.605318140906583e-01   +1.575787597214728e-01   +1.648949682441162e-02   +3.772343742554086e-02   +4.325188786662580e-01   +1.312403021389693e-01   +2.019220928370309e-01   +1.885698235816634e-01   -5.723504698187166e-02   +3.605332955235366e-01   +1.258850651311174e-02; +8.237464706459903e-02   +3.204185106294340e-01   +1.144217194314815e-01   +2.147181812620867e-01   +2.812134568076083e-01   +2.139766551493706e-01   +3.609499443552454e-01   +4.010958567248974e-01   +2.527170113720664e-01   +7.723519786787900e-02   +3.872487960065280e-01   +3.555957225463324e-01; +1.887425603303279e-01   +2.410439969052710e-01   +3.002112822996081e-02   +3.035195126233061e-01   +3.149390536419675e-01   +4.419619150715991e-01   +2.481019971815240e-02   +1.957651513171806e-01   +1.507921959870713e-01   +3.342190793937164e-01   +2.319485362708055e-01   +3.617492936887122e-01];
L6_L4_iAMPA_netcon = [+2.065164158323024e-01   +2.130133338700114e-01   +2.046062163018027e-01   +8.436873120224142e-02   +1.594046550154068e-01   +2.326997148770390e-01; +4.371139589092951e-03   +1.146305119844101e-01   -4.325846268134476e-02   +4.020429725483551e-02   +1.339742801244321e-01   +2.746116389482370e-01; +1.229076919092942e-01   +1.701327977295840e-01   -9.314734237802721e-02   -8.639565756341767e-02   +3.282466130450426e-01   +5.500868434473413e-02; +3.472650202736412e-01   +2.879809097678008e-01   +1.853634650106681e-01   +5.833417895370704e-02   +3.842569808383415e-01   +1.677808400114081e-01; +5.074327874646708e-01   +3.511827198873910e-02   +1.801324117259273e-01   +1.387466556829204e-01   +2.262620294520050e-01   +4.445640039370815e-01; +3.869366829342015e-01   +3.594685588718196e-01   +2.737323798588496e-01   +2.527417558162324e-01   +1.463939768990773e-01   +3.076920289759824e-01; +3.009414002384638e-01   +4.009086206330425e-01   +1.290767698253574e-01   +3.983896031795193e-01   +4.135247161346083e-01   +5.846855622097889e-03; +3.877791463930247e-02   +3.800870320151404e-01   +2.889452402178532e-01   +3.238394155701613e-02   +9.125747124891982e-02   +3.988123975377746e-01; -3.964436997698537e-02   +9.312020829990884e-02   +2.730050137387706e-01   -6.438092630304247e-02   -8.956234975459020e-03   +9.600492402352220e-02; +1.037965741058657e-01   +2.844714658196555e-01   +2.935455104756310e-01   +1.273476334302625e-01   +4.323828054451732e-01   +3.319715373934291e-01; +2.752849850205852e-01   +1.147309761872758e-01   +3.951249625806075e-01   +1.329883753914819e-01   +1.807818052416701e-01   +2.553123388216686e-01; +2.956289758245640e-01   +2.816874035229195e-01   +3.028543412368143e-02   +8.360168658510907e-03   +2.438668735871055e-01   +3.824579458171758e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
