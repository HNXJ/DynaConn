function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.329670893918554e-01   +7.566258963062161e-02   +7.583379518140115e-02   +2.311745304298851e-01   +3.731339305935544e-02   -2.119454116546011e-01   +3.988015484213798e-01   -1.523093428352679e-01   -1.354390544847882e-01; -2.509486228355488e-01   +4.215621900416042e-01   -1.139910830601143e-02   +3.701843361045087e-01   +1.735108985923741e-01   +5.894767910098149e-01   +4.636363480058835e-01   +6.882704122414254e-01   -3.063172843596791e-01; +4.814290551457210e-01   +9.880000733285601e-01   +5.501967052335014e-01   +3.061213799116757e-01   +3.201557575667751e-01   +3.258134762756654e-01   +2.675065787368626e-01   -4.923248321551988e-01   -2.301843762461798e-02; +5.793919226328814e-02   -2.286821578708882e-01   -8.543280566712330e-03   +5.560476211766909e-01   -7.756705672682648e-02   +3.140215996862993e-01   +2.992245244128300e-01   +2.089393517719426e-01   +3.237416856347480e-02; -1.672909794286248e-02   +3.224461590670253e-01   +3.938047975211809e-01   +3.880690828590984e-01   +8.189394896142406e-02   +2.545655491721592e-01   -1.230158980075425e-01   +3.768936806734233e-01   +5.609544860827312e-01; +3.660192588092162e-01   +3.281742125784912e-01   +3.653638817635740e-02   +3.063267645745453e-01   +3.319749707851156e-01   -5.579838022936588e-02   +9.239118352974031e-02   +8.095539472883364e-01   +6.368187517781501e-01; +4.636279263183688e-01   +1.878650215728467e-01   +8.951706694181222e-02   +2.158312487466081e-01   +2.206697610485006e-01   +7.116904797176602e-01   -2.967875899881880e-02   +1.214964329533053e-01   +4.845294922244047e-01; -2.015832230517653e-01   +9.253642198735454e-01   +7.397364463168438e-02   +1.060797198350193e-01   +4.847179182252062e-01   -4.863780377421294e-01   +4.091256589132908e-01   +1.650887981767771e-01   +1.038659650228894e-01; -6.216183794187319e-02   +6.156813313260647e-01   +1.147669653759373e-01   -1.682212738578917e-01   +4.008489462099586e-01   -2.115216094077125e-01   -2.031842086296713e-01   +6.808171059303264e-01   +7.058503213559245e-02];
L1_L2_iAMPA_netcon = [+5.911720953676517e-01   -2.994306073645859e-01   +3.808800902655091e-01   +5.963095185286368e-01   -5.750017567577970e-02   -2.064293995484170e-01   -1.010286091323367e-01   -1.404813526611630e-01   +9.120369575167789e-01; +3.536188959563527e-01   -5.432909523295848e-02   +4.802274641135480e-01   +8.164260744176549e-01   +1.184932293975316e-01   +1.658408792165237e-01   +8.348456538645315e-01   +4.657077005432835e-01   -2.705766911908147e-02; +4.716465542763260e-01   -1.405778684396312e-01   +6.778166386324351e-01   -2.099299991255040e-01   -3.463836853586455e-02   +3.324690490124649e-01   +1.082445069946583e-01   +4.330694639045271e-01   +5.937677734790378e-01; -3.688509103831997e-01   +2.606811102596757e-01   +2.154810299086659e-01   +3.846967736484486e-01   -3.604144376793936e-02   +3.296231249672222e-01   +7.910128315850740e-01   +2.507892644546064e-01   +3.157190196790592e-01; +4.209049404473115e-01   +8.586179072408643e-01   -1.986579769267138e-01   +1.703489945117062e-01   +2.806715923591286e-01   +4.259800176438200e-01   +4.024366473153288e-01   +1.603827173768188e-01   +6.862786028676696e-01; -3.478224684404672e-01   +3.931012192030177e-01   -3.037716898491298e-01   +6.939259371415536e-01   +4.303746604309849e-01   +2.970888911976809e-01   +4.850812001777184e-01   -2.231010796979055e-01   +8.129623074482192e-01; +1.092134842646142e-02   +5.624028789037857e-01   -5.793584887695016e-02   -1.935683629891949e-01   +2.554672813806458e-01   +1.320997235371997e-01   +3.744572104534365e-01   +2.889545148757022e-01   -2.504048923954588e-01; +2.576779204160497e-01   +4.963888729829609e-01   -3.662519760791589e-01   +6.890438813658588e-01   +5.275536789164473e-01   +4.125804558086947e-01   +9.977277059722161e-01   -2.165443322071237e-02   +5.944557106454699e-01; -2.478776913567811e-01   -3.852255210729420e-01   +4.653059798710362e-01   +1.863551988114491e-01   +1.859938625117808e-01   +1.719245399235639e-01   +9.813586897698008e-01   +7.439057329155075e-01   +6.336405183149435e-02];
L2_L5_iAMPA_netcon = [+1.000000000000000e+00   +1.033289383978931e-01   +3.436699841439482e-01   +3.202564354529998e-01   +9.080214649567566e-01   +6.066111532702669e-01   -1.043365192589457e-01   -5.790715461340187e-01   +6.541017900897663e-01; +4.214085340113435e-01   -1.060357293958948e-02   +3.520244534060229e-01   +4.879855827538937e-01   +3.205659004495161e-02   +1.966082236903170e-01   +2.001644558192726e-01   +5.957096123638711e-01   +7.188805950362557e-01; +3.272558647831363e-02   -2.459175210832783e-01   +5.710116546545808e-01   +7.721063724493257e-01   +1.343489866543603e-01   +7.001588056583760e-01   +5.091697014102472e-01   -1.103261081238477e-01   +6.413316302794686e-02; +2.739136818412865e-02   -7.815642121580310e-02   +6.362107696381699e-01   +2.837993829602173e-01   +6.432701776549312e-01   +4.288751036814665e-01   -1.118612657229962e-01   -9.741043650143053e-02   +1.676183559378914e-01; -3.342240079651809e-02   -4.181393081524112e-01   -1.800173085669113e-01   +3.835443827027634e-01   -1.650181341489929e-03   -3.339247129755890e-02   +1.837554240267501e-01   +8.909110173152101e-01   +8.847385916923008e-01; +8.595358055919166e-01   +2.838106960456485e-01   +3.609950592000062e-01   +2.945997382136832e-01   +4.678883925726071e-01   +2.797722956747942e-01   +3.121113617883142e-01   +3.099249446639308e-02   +4.685463028515898e-01];
L5_L2_iGABA_netcon = [-6.769038536155320e-02   -2.894807456824742e-01   +7.656747784058603e-01   -8.930969836529921e-02   +9.224091386197981e-02   +2.010453598921327e-01; -2.272652490624303e-01   +4.304273964381132e-01   +7.358404984348373e-01   +9.961232745002200e-01   +2.190912868162104e-01   +1.560012814483006e-01; +6.522879977802264e-01   +4.179672958437262e-01   +4.463047920413106e-01   +1.563977658767557e-01   -1.909489779230562e-01   -1.128980975326350e-01; -7.324303584975468e-02   +1.188099688120572e-02   +3.722770466597558e-01   +3.359102060632208e-01   +2.454401124231305e-01   -3.002770927433703e-01; +1.582599634473577e-01   +4.270127844785072e-01   -8.054086241626290e-02   +1.477342007837242e-01   -3.087057541252415e-01   +1.883105347462699e-01; +5.118809397860717e-01   -3.977164635686287e-02   +7.244362694185528e-01   -1.173785009145278e-02   +3.128526026403396e-01   +3.406689399377358e-01; +3.639291362464560e-01   -2.923763701109103e-01   +1.992578225030125e-01   +6.512331216725136e-01   -6.439336553241390e-01   +1.930209981020140e-01; +3.319819534124442e-01   +4.144357416913202e-01   +7.569998204052497e-01   +1.748713061642272e-01   -2.906509461894763e-01   +1.041823192485040e-01; +8.494538647579847e-01   +6.674053100375393e-02   +1.240042221180471e-02   -4.970540136319326e-01   +4.591134590179659e-02   +2.083817652422800e-01];
L3_L2_iAMPA_netcon = [+7.761591283186320e-01   +3.560227975585947e-01   -8.765234737920131e-02   +4.098587322765933e-02   +3.105819131245891e-01   +2.239937081835254e-01; +5.950136640564108e-02   +7.312190054026089e-01   +5.503927898480214e-01   +7.285973533633518e-02   -3.402941926034658e-01   -1.515042433578016e-01; -5.863731584567433e-03   +7.625569345287209e-02   +3.535659782941840e-01   +8.088900941473744e-01   +2.420416216656419e-01   +4.469774353795301e-01; -2.573769873270007e-01   +3.223440511119534e-01   -4.913325150241268e-01   +2.393951069526928e-01   +5.805475230629756e-01   +1.571175109513227e-01; +6.661262478771387e-01   +2.522902933312723e-02   +6.325656611640629e-02   +3.395877764838739e-01   +3.763005885959553e-01   +2.796761009881242e-01; -2.886057631208354e-01   +5.245236345115272e-01   +2.110033178787873e-01   +2.736045986661303e-01   +5.502176332441950e-01   +5.292919946509481e-02; +4.199026359766896e-01   +3.974414369798938e-01   +4.016490799348653e-01   +1.088476765381945e-01   +1.321342193557357e-01   -1.523690632726997e-01; -2.318781072767863e-01   +3.671991773168820e-01   +3.891403212926567e-01   -4.679551663502801e-02   -2.959771696020528e-01   +3.421749485225009e-01; +6.276757736493644e-01   +6.566723941561761e-02   +7.218084120332782e-01   -1.278986198762816e-01   -7.806530777885018e-02   +7.185721369491892e-01];
L2_L3_iGABA_netcon = [+7.655550081737945e-01   +2.032827750635673e-01   -1.855228474865647e-01   +1.682696889919288e-01   +4.915018726933171e-01   +2.770707376074444e-01   +5.141024249059851e-01   -2.261552436545782e-01   -2.396747174723606e-01; -4.680988120257971e-02   +1.183787042211585e-01   +3.165070355363956e-01   +5.178628093110464e-01   +3.868294382890189e-01   -1.055607551769285e-01   +5.435537227517463e-02   +6.512436723931707e-02   +2.281648298228215e-01; +2.222599489087884e-01   +5.228826178314133e-01   +1.730698722818436e-02   +5.783812192767730e-02   -1.835151212718035e-01   +2.745962425276728e-01   +2.470082810590365e-01   +3.543809927998017e-01   +3.828349242300980e-01; +1.964198480969709e-01   +1.000000000000000e+00   +4.576297245603980e-01   +2.588000587633714e-01   -1.741156672991185e-01   +1.779338470880561e-01   +6.401197576507645e-01   +1.414976852817432e-01   +7.016825493197440e-02; +2.738834388967100e-01   +6.390805102278674e-01   +2.123514427133025e-01   -1.282532342728579e-01   +4.023175276296748e-01   -1.113666018086720e-01   +4.457364855466404e-01   +2.240580309270198e-01   +4.266457206754793e-01; +4.426944062961503e-01   -8.502395073064768e-02   +6.361115251480267e-01   +5.763215710023143e-02   -1.958291496387649e-01   +2.162248427077971e-01   -3.493737866040876e-02   +4.477812048626162e-01   +4.252549026613598e-01];
L1_L4_iGABA_netcon = [+4.659555727743285e-01   +9.345490812621040e-01   +5.763386725551098e-01   +4.362984979427763e-01   -1.452901034067724e-01   +1.058859282287726e-01   +9.952226329295064e-02   +8.362645530014531e-01   +1.545572739978772e-01; +5.503863960126563e-02   +6.758122721483184e-01   +7.182169685803225e-02   +1.463772922298106e-01   +2.865705519817242e-01   +3.036702663675099e-01   +3.923635768444673e-01   +1.854356215294868e-01   -1.190632285405797e-03; +2.732236273168866e-02   -2.807116747698563e-01   +3.288447371004350e-01   +4.804816090620573e-01   -4.177837332574045e-01   +2.283606923258254e-01   -3.453896670564693e-02   +2.809387589010337e-01   +5.354333129046807e-01; +2.659997665003326e-01   +1.021774073822936e-01   +2.796126643958878e-01   +4.579456863777512e-01   +2.335682515986945e-01   -4.028628347760330e-01   +5.518122612589593e-01   +9.826155987203976e-01   -2.055514114578061e-01; +3.743423887938665e-01   -1.670263877991439e-01   +7.338632666907188e-01   +8.904829507802288e-01   +6.658508624670710e-01   +9.306088099764176e-02   +1.668049622337953e-01   +1.786172975503865e-01   -1.802179953486582e-01; +2.652719328956235e-01   +6.552599756958451e-02   +5.228028552456772e-01   -9.918074473768089e-02   +1.308798362370057e-01   +1.122489716919098e-01   +1.827945295332987e-01   +4.454619577114049e-01   -4.211296861128947e-01; +7.137000596131576e-01   +3.007184071804720e-01   +5.310207306999992e-01   +6.710435361514719e-01   +4.996068287153310e-02   +5.759373120446326e-01   -5.471276482067502e-01   +6.262755039468790e-02   +2.074663508308916e-01; +1.436182536463588e-01   +2.159173997283191e-01   +5.162608974799886e-02   -1.167941578106644e-01   -4.033572422619804e-02   +3.369206423671601e-02   +4.295255007235188e-01   +7.957460041014021e-01   -5.743419032783986e-01; +2.219082214398768e-01   +3.022895961583187e-01   +1.148069266489487e-01   +4.720919599572849e-01   +1.495475214688718e-01   +7.029635938045953e-01   +3.812484781068960e-01   +4.969026439401764e-01   +3.603728295900275e-01; +4.272045577552687e-02   +6.460092840675472e-01   +9.454445022585469e-01   +4.755791365103921e-01   -5.222588194966510e-01   -3.972089044870943e-02   +8.393414914091436e-02   +1.464595998080792e-01   +2.528851016556659e-01; +7.234011547010777e-01   +6.466190992861014e-01   +7.520415190695595e-02   +3.852341141463781e-01   +4.867885299329133e-01   +3.546580194300956e-01   +3.520310119492135e-01   +3.074189202627885e-01   -1.347835761300463e-01; +5.490930938992140e-01   +1.000000000000000e+00   -3.867863775147845e-01   -1.506185810742334e-01   +4.361209263247444e-01   +1.974875858189206e-01   -2.184519784955547e-01   +1.304286991743444e-03   +2.797554036007425e-01];
L4_L1_iGABA_netcon = [-3.672408404803243e-01   +8.102137709582751e-01   -5.748697342173301e-03   +2.504707400139825e-01   -2.082318937211585e-02   -3.708840231101745e-01   +7.031473897580581e-01   -5.412534740669483e-02   +6.651827156205301e-02   -1.048794288798878e-01   +1.673260253492208e-01   +5.429216936460628e-01; +4.460385338913390e-01   +1.541155168474967e-02   -4.831971078400931e-01   +3.942215940589007e-01   +4.910113739552455e-01   +6.678828193654887e-02   +6.093050123878786e-01   +6.191096494808570e-01   +2.946122030899131e-01   -5.660703234099315e-01   +5.547267701469119e-01   +1.197096831297182e-02; +1.904166325261494e-01   +4.766561138546205e-01   -1.616839976575786e-01   +3.900646039507119e-02   +3.124660838384981e-01   +4.506958177974549e-01   +6.069365146332742e-01   +4.771674201056675e-01   -2.739260610395590e-01   +4.621662048963718e-02   +1.000000000000000e+00   +5.408785224762545e-01; +2.576156094507797e-01   -8.450354192125768e-02   +7.332264459662159e-02   +5.226693147906996e-01   +7.651259266849189e-01   +3.984398633861291e-01   +4.740463304802631e-01   +4.388555179846494e-01   -3.710742884858871e-01   +7.375270252340171e-02   +2.723207803045707e-01   -7.114729050659553e-02; +3.203239801585537e-01   +1.496323173537551e-01   -1.239852405996325e-01   +4.844171900441839e-01   -1.835384367557308e-01   -1.732704232928315e-01   +7.637298522729715e-01   +1.881775333578605e-02   +6.626284916963932e-01   +8.247070171150679e-02   -2.474419168001818e-02   +9.591275632417968e-01; +4.952877122026113e-01   +2.959416443181520e-01   -1.044831089696543e-01   +9.793078168324186e-03   +1.713286758395859e-01   +3.370640890506522e-02   +7.809416681953859e-01   +1.256727324468874e-01   -3.010569804267666e-01   +1.788644673849702e-01   +5.819436038151656e-01   +4.959338391604162e-01; +7.381686045839573e-01   +4.424288053706090e-02   +2.579048014356825e-01   +5.343048190432387e-01   +4.205815126149168e-01   -1.725573934716891e-01   +5.021811568793829e-01   +6.508150089179845e-01   +6.958879946891991e-02   +9.298778153556649e-02   +3.404037656756910e-01   -5.299656886948105e-01; +2.505389504775387e-01   -5.997525610133139e-02   +5.197675825054789e-01   -1.438404450413452e-01   -2.248637934514418e-01   -1.334858772305333e-01   +5.570217465903084e-02   +4.041052397979663e-01   +1.709126832639388e-01   -3.020619850591814e-01   +1.490428434057668e-01   +2.121076243989087e-01; +5.083830434089598e-02   +1.223293423428851e-01   +6.629748181701930e-02   +1.127756263229127e-01   +6.618087634520842e-01   +3.390928167515906e-01   +2.926524751037484e-01   +4.503090202542750e-01   -2.915189819546758e-01   -2.490711470642034e-01   +1.143294978593060e-01   +1.686856770789501e-02];
L1_L3_iAMPA_netcon = [-1.959843645250130e-01   +3.457393526929398e-02   +5.260238105854144e-01   -5.073534496160449e-01   +9.683016888157276e-01   -6.892634813386780e-02   -3.833073379396960e-01   +1.022573338130593e-01   +9.730056315757669e-03; +2.519355430048396e-01   +7.567455649855210e-01   +1.542570263655191e-01   +1.201317249236211e-01   +6.068955660182616e-01   +1.960713424716474e-01   +4.624250870003935e-01   +3.919026116717608e-01   +1.777937972089496e-01; +6.288597281983400e-01   -1.018461728354705e-01   -3.179616005545671e-01   +6.350086186621468e-01   +7.952780685432459e-01   +6.808248092639478e-01   +4.199858878649277e-01   +2.035518514843136e-02   +7.057900588543549e-01; +5.648860453420651e-01   -5.349711387031058e-02   +2.021615071364291e-01   +4.106748677158495e-01   +3.133163199530745e-02   +6.353054195062039e-01   +3.769575112968951e-01   +2.845277732488070e-01   +5.117852929697210e-01; +3.102233216615956e-01   -4.816142028601431e-02   +7.607187498070682e-01   +1.685139645172312e-01   +1.123125536312606e-02   +2.676015136469146e-01   +9.769149676852559e-01   +7.815164088135284e-01   -3.483776053667008e-01; +5.579726457402339e-01   +5.176793739934962e-01   +4.761869253023624e-01   +1.449654104697563e-02   -2.450582470743426e-01   +5.036707362808338e-01   +4.481262239871280e-01   +1.000000000000000e+00   +4.605117614779878e-01];
L3_L1_iGABA_netcon = [-3.344096643210593e-01   +2.117344690721318e-01   -5.334996076605103e-02   -2.385057080801471e-01   +2.641500426171939e-01   +3.365478429522637e-01; -7.231669723836415e-02   -4.154601973111207e-01   +6.514453026040169e-01   +1.340332646439225e-01   -1.019421278493353e-01   +5.119722853968640e-01; +3.890271600649599e-01   +1.931236175168815e-02   +3.801049985973418e-01   +3.423942111150677e-01   +2.340777742039073e-01   -1.984659086727453e-01; +3.637808495622823e-01   -2.462364079762065e-01   +7.217832941403166e-01   +2.252086435390763e-01   +1.331822978791353e-02   +6.050223199289666e-01; +5.020788226837958e-01   +4.569753004100192e-01   +5.057728185995661e-01   +3.251897909441553e-01   +1.329242804450839e-01   -4.190122885192327e-01; +6.419838736496747e-02   +8.629237897812931e-01   -2.410567186109136e-02   -3.588568765888598e-01   -2.975859610153298e-01   +5.624033756797900e-01; +1.757462395460356e-01   +3.019922809808255e-01   +1.844377422227536e-01   +4.730820332699963e-01   +2.869664300799112e-01   +8.816419942520944e-01; -1.551387509378022e-01   -1.298022808122472e-01   -1.150303912717302e-01   -2.837984914361669e-01   +4.960443484863329e-01   +2.556796380651348e-01; +5.959356889183153e-01   +8.825153232979436e-01   +2.487783887246673e-01   +3.420166548535279e-01   +5.962550305180629e-01   +7.219614381358228e-01];
L5_Input1_iAMPA_netcon = [-3.335090189229962e-01   +2.613609610792484e-01   +4.583907618300696e-01   +4.321446118696695e-02   -8.397028438330284e-02   +4.431732145619633e-01];
L6_Input2_iAMPA_netcon = [-2.306287402489284e-01   +4.021339844403322e-01   +6.078049470021222e-01   +6.667676578797067e-01   +7.871449385715432e-01   +6.569505654439209e-02];
L5_L6_iAMPA_netcon = [-8.688655220280811e-02   -1.518145212782052e-02   +1.883740607306105e-01   +2.466995699510747e-01   +1.375635991609394e-01   +1.861517458759055e-01; -2.708236613359404e-01   +6.782722702413726e-01   +6.022232111280174e-01   -1.988812280328915e-01   +5.437691380048573e-01   +3.084280761999032e-01; +4.238627188765937e-01   -3.356585535847221e-01   -4.066792030288129e-01   +5.201099704904273e-01   +3.857688528690491e-01   +5.721863728005440e-01; +5.993139025180265e-01   +8.438733088724906e-01   +2.901450677521432e-01   -4.751676056994786e-01   +2.949175593798530e-01   +3.470074747639110e-02; -2.065854461997529e-03   -1.495186544981718e-01   +6.151531928412612e-03   -3.596116705455166e-02   +3.053414904825795e-01   +5.339256320907197e-01; +3.107797060524538e-01   +5.002694846953992e-01   +2.672645242737992e-01   +1.947087515744570e-01   +6.078991986933127e-01   +6.057434245180469e-01];
L4_L5_iAMPA_netcon = [+1.178898461451077e-01   +5.552342884988767e-01   +3.351645139820460e-01   +3.620996761693926e-01   +3.457959556248197e-02   -2.701740248909498e-02   +5.014223544254298e-01   +4.677487596654439e-01   +5.059487098156283e-01   +1.646989444917245e-01   +1.322371569231019e-01   +1.790073687742103e-01; -1.345838862397140e-01   +9.173275484049468e-01   +5.423355830472592e-01   +3.532456493590913e-01   +1.740701437963333e-01   +8.276156668932844e-02   +3.922497243849438e-02   +1.012178696094214e-01   +2.770317121967982e-01   +1.288803627440568e-01   +3.702651881717566e-01   -3.125098113513430e-01; +2.086863877732362e-01   +1.465351222153207e-01   -2.898834003573311e-01   +4.029385363745700e-01   +4.775936528771905e-01   +6.601843983806736e-01   +2.165601717731457e-01   +7.020304472337863e-02   +5.742975022366823e-01   +7.963789154594005e-01   +4.767888704736749e-01   +7.410329457106021e-01; +6.107267337408875e-01   +2.453529660857098e-01   -2.616019901274313e-01   +2.790148170430172e-01   +6.215625166727968e-01   +3.823990526738246e-01   +2.064650150361551e-01   -1.796898670472123e-01   -3.119859107357876e-01   +2.014827418166112e-01   +4.259312235472869e-02   +4.392041414852989e-02; -3.522805127216857e-01   +1.484935283075493e-01   -3.586525130300136e-01   +4.751231108254806e-01   +2.420730456547457e-01   +1.675228348551302e-01   +3.288650860313165e-01   -4.222444009548390e-01   +2.850604239362208e-01   -2.774354668341323e-01   -2.326427855138453e-02   -6.620556172518666e-02; +2.175881914344028e-01   +5.153534248808269e-01   +3.457909707485299e-02   -1.166944354572218e-01   +6.233725464887925e-01   +1.113020240970259e-01   -3.154183952252544e-01   -3.568776559391980e-01   +5.569190509270467e-01   +3.760370770513283e-01   -2.019841998567519e-01   +6.758544981843250e-01];
L6_L4_iAMPA_netcon = [+3.024368490359957e-01   +3.147934080864248e-01   +2.261373536350431e-02   +5.788129602931013e-01   +7.081203007580867e-01   +2.662116621968743e-01; -3.680634641385945e-01   +6.138668202568569e-01   -1.562965483674364e-01   -4.331834183205849e-01   +3.113623561907791e-01   -2.521254980189536e-01; -7.394451420935935e-02   +6.671874734705582e-01   -2.389789554561056e-01   +3.393929118913538e-01   +5.719781678572917e-01   +2.925777091126482e-01; -1.354653775692561e-01   +3.970340040084597e-02   -9.670726352863340e-02   +2.170417041335059e-01   +3.114353881535145e-01   -4.664414277489731e-02; +3.311912325090522e-01   -1.845640948594269e-01   +5.699389391190832e-02   +2.458879305157375e-01   +4.772771829242179e-01   +6.322973065254061e-01; +1.399563113405874e-01   +7.254619531642809e-02   +8.699296428044445e-01   +7.497043239879566e-01   -2.965716471326943e-03   -5.966754754109602e-02; -1.339765328676183e-01   +7.351773458468944e-01   +6.194173862612609e-01   +2.995568582220927e-01   +6.569851060833354e-01   +4.034939743854396e-01; -4.204872981368556e-02   -2.865838563402149e-01   +1.555745131586559e-01   +1.207734284227252e-01   +5.535846268572666e-01   -4.149647200397982e-03; -3.131718716413854e-01   +9.222591283560758e-02   +9.673029547798491e-02   -1.672273586670557e-01   -4.207806684588736e-01   -4.245045799380441e-01; +4.086258672361761e-01   -4.172529966865484e-01   +6.101129668783056e-01   +2.135112061757673e-01   +2.324315707633083e-01   +5.441540205575361e-01; +4.855555432250854e-01   +9.276139157215108e-02   +5.997167988898142e-01   +3.989922608757776e-02   -1.177759692911741e-01   +3.015157360433351e-01; +3.336386635005903e-02   +2.837417145982939e-01   +6.931540849313511e-01   +4.417268649260672e-01   +4.126132767788286e-01   +1.074633664424696e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
