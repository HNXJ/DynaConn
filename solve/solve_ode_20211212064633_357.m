function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.799538352127131e-02   +2.208581805124472e-01   -3.465820969849769e-02   -4.549749192816023e-01   +9.252198216246083e-02   -2.099844363944971e-02   +2.101726670574244e-01   -1.477863054467585e-01   +6.468828791650350e-02; +8.349750833970102e-02   +1.565000334440830e-01   +2.508613347300171e-01   -4.936176509430197e-02   +3.393103560285661e-01   +2.275009113760191e-01   +6.337792779555332e-03   -5.339588638655769e-02   -4.874400755951760e-01; -3.744549479977488e-01   +2.493593164583771e-01   +2.490341193168494e-01   +4.396055302108667e-02   +1.574738932903592e-02   -4.600838225661298e-02   +3.664626562230938e-01   -1.956865819845855e-01   +2.691918013093920e-01; -6.150369733684452e-02   +1.292296257955769e-01   +3.674019294763881e-01   +4.822589075431763e-01   +2.977348421361248e-01   +2.353126282579049e-01   +3.834100282301067e-02   -2.744634706044159e-01   +5.549981750475189e-01; +1.348165553870920e-03   +2.924858809713203e-01   +5.910856317015053e-01   -4.098857132484804e-02   +5.553613864315030e-02   -5.165375180821413e-03   +6.309678357555850e-01   +1.526972287376654e-01   -2.320525364224924e-01; +1.703613868653542e-01   +4.670443942630633e-02   +2.842404021030780e-01   +4.725812883457475e-02   -5.258486140914540e-01   -4.545365964277121e-02   +2.170001606474274e-01   +4.377631831168322e-01   +5.753090872938270e-01; +2.581961704546397e-01   +1.637173798757127e-01   -2.102334320986086e-01   +6.660870051952394e-01   +2.038744648160352e-01   +1.837477203245174e-01   +4.970090683849107e-01   +1.741641873718676e-02   -1.154395830600887e-01; -4.807547545585378e-01   +1.526984595262630e-01   +1.448089915698286e-01   +2.514003118787491e-02   +3.401081023728429e-01   -2.402999884070079e-01   -2.106825240893243e-01   -7.184346283480439e-02   +3.102711682386396e-01; -3.432087815727028e-03   -4.914685877466374e-02   +1.246371293739299e-01   +1.387230046104032e-01   +3.455547111364828e-01   +7.892206240242775e-02   +2.226419665720200e-01   +1.462080512784890e-01   +5.534543482045401e-01];
L1_L2_iAMPA_netcon = [-4.824510673404732e-02   -2.276034942043910e-01   -2.166735171068005e-01   +9.027408743047494e-02   +4.248928678947521e-01   -2.944613386029042e-01   +1.621057459438393e-01   +5.953757921979548e-02   +2.736600169545610e-01; -4.249327658413612e-03   +2.234373701049408e-01   +2.275316900802617e-02   +1.345769904143119e-01   -1.776585470119432e-01   -3.066981916966909e-01   -8.852949940201998e-02   -8.540507439889565e-03   -2.501702158493156e-01; +1.692950816859579e-01   -4.508157487187113e-01   -2.578376599516359e-01   +1.171895847157563e-01   +2.464974956618882e-01   +3.385581206813519e-01   -3.790344000405673e-01   -1.280423989966664e-02   +3.894161781162538e-01; +4.225147351847625e-02   +1.481004561400444e-02   +2.304147540559499e-03   +1.443979463412524e-01   -6.326487141374008e-02   +9.269403352980039e-02   -2.517058091446021e-01   +1.874867009049164e-01   +5.082680115093472e-02; +1.861029764716654e-01   -2.280365290816424e-01   -3.473099064109073e-01   +3.372327967289231e-01   +2.844474129154028e-01   +3.281752708474812e-01   -1.563345049449376e-01   +7.006835178629209e-02   +2.574621327014928e-01; +6.512320805714732e-02   -3.947083618209481e-02   +7.965852244499999e-02   +1.951498793769156e-02   -1.877235554606595e-02   -1.016352389210154e-02   +3.031479915443892e-01   +1.792566275714096e-01   +1.460572662719221e-01; -2.066213189338756e-01   +2.104393534183827e-01   -5.187927601161013e-02   +1.715183137753901e-01   +1.386175075041730e-01   -1.237129239312140e-02   +2.775946636515835e-01   +2.671010785182802e-01   -1.524251155140846e-01; -4.292676593508942e-03   +2.105017796289708e-01   +1.336486241325077e-01   -1.702342549740773e-01   +2.098756962016087e-01   +4.084060047035732e-01   +2.568721219712588e-01   +2.643838982686858e-01   +1.420696294635761e-02; +4.376833419240843e-01   +3.764847594437184e-01   +2.171089022047748e-02   -1.821694127261957e-01   -4.636337896728650e-02   +2.679816003171469e-01   +3.257148039743266e-01   +1.696175446949086e-01   +4.131380278893161e-01];
L2_L5_iAMPA_netcon = [+4.417067307133192e-01   -2.604982252020945e-01   -1.739318598573230e-01   +1.576928067004431e-01   +8.384665998493021e-02   -3.727026727289076e-02   +4.268092074819338e-01   +7.123181178001906e-02   +1.415881868827896e-02; +3.740356985120748e-01   +2.187556478430340e-01   +1.077713536992626e-01   +4.034469884271507e-01   +1.123272152996393e-01   +2.672907756279657e-01   -2.552391112646234e-03   +1.060371836947630e-01   +3.977796453460938e-01; +5.571204945186831e-01   +1.730249093435703e-01   +3.068341533589172e-01   -3.323559984013115e-01   +7.477504468147216e-01   +1.299978078603336e-01   -1.206355267733624e-01   -2.491323123995887e-01   -1.340710364459456e-01; +1.549081458463025e-01   +5.275073095830359e-01   +5.618553350803601e-01   -4.777886614796414e-02   +3.330071398543479e-01   +4.265962927611747e-02   -3.865067062139053e-01   -7.390073632473462e-02   +2.534274998960245e-01; +3.256151036527710e-01   +4.130961518750692e-01   +3.491907454704694e-01   +4.574862530961021e-02   -6.765767413292328e-02   +2.157334495097435e-01   +1.384863650073891e-01   +4.087345653076514e-02   +5.170779178668771e-01; -2.613266466588396e-02   -1.438443387090794e-01   +7.243162815566339e-01   +2.227390886510942e-01   +3.039275613206252e-01   +1.577443670001038e-01   +8.757426032849347e-01   +1.486072799319909e-01   +4.067892137292342e-02];
L5_L2_iGABA_netcon = [-1.206224308849956e-01   +1.958375112117247e-01   +3.677133556229003e-01   +6.044520737589558e-02   -2.921096825021094e-01   +5.233469323509907e-01; +3.534642062209323e-01   -2.095078579214762e-01   +1.222731855151974e-01   +9.721356581761782e-02   +6.600176879724096e-02   -2.005367904272215e-01; -5.511438500986161e-02   -2.573753965361001e-01   +5.522862324445131e-01   +2.012397556020637e-01   +1.582511112587787e-01   +2.894811617833294e-01; -1.038312002953338e-01   -1.028619517121415e-01   +5.050418513028876e-02   +5.032855063151015e-01   -1.646628146849658e-01   +6.406108725553891e-02; +2.762013898792687e-03   +2.214836037010616e-01   +2.631754660378362e-01   +3.664442603031499e-01   +4.747058893373381e-02   +1.409276597685076e-02; +4.285010000566312e-01   +1.483671749554944e-01   +1.142235169530137e-01   +5.383406541277707e-01   +2.788190671724081e-01   +2.402426186480672e-01; -4.268528970463541e-01   -7.234634583093680e-02   +1.821304876510407e-01   +2.940223875267455e-01   -2.415423901235421e-02   -3.394288505948596e-01; +1.310537164979990e-02   +1.651941803980337e-01   +5.451166510069348e-01   +2.351887880159019e-01   +1.186414704764389e-01   +5.969734006122021e-01; +2.780776940289229e-01   -7.283371132060196e-02   +5.833992292506917e-01   -2.899153190131802e-01   +2.259498914461061e-01   -2.821207930553138e-01];
L3_L2_iAMPA_netcon = [+4.728301277053818e-01   +2.356973402565520e-01   +3.635520079335552e-01   +5.989590934834765e-02   -8.754367021189013e-02   -8.889989626126660e-02; +8.748337251067717e-03   +6.071526188561278e-01   +2.721341696242853e-01   +2.263189227835219e-02   +1.253288220052169e-01   +4.679852915365939e-01; +3.370937944725969e-01   +1.408361259281508e-01   -4.359966925438894e-01   +4.944675683136769e-01   +2.135397010686501e-01   +2.224204228109053e-01; +2.791897915839489e-02   +2.263493364105183e-01   -1.080766760622680e-01   +1.571626570523957e-01   -1.119517088218459e-01   +1.448971583111364e-01; -2.775984753522531e-01   -1.364986231332438e-03   +4.251272002095738e-01   +3.247493051171706e-01   -3.571290731510348e-01   +1.273177600342479e-01; +1.035368309491101e-01   +1.984468395602727e-01   -3.359120045986261e-02   +2.451770636568769e-01   +3.538457154892801e-01   +3.313878890934915e-01; +9.702589285102996e-02   -1.974701649971591e-01   +3.140823904529075e-01   -1.982499181561090e-01   +3.533487446447722e-01   -2.469406420173963e-01; -2.671294717174601e-01   +2.883975219582016e-01   -2.446036358350537e-01   -9.678509432584328e-02   +3.568865181243558e-01   -1.434688733787474e-01; -3.222834166545567e-02   +2.942375529473548e-01   -4.395578561742514e-02   +1.164549067117270e-01   +2.398841720835738e-01   -3.045216507647018e-01];
L2_L3_iGABA_netcon = [+1.939604932064004e-01   -6.426616041671754e-02   +5.615276385468314e-01   +5.917026584194299e-02   -1.966593960716799e-01   +1.126331622292254e-01   +3.954408316847851e-01   +1.907084489758228e-01   -1.522054394990540e-01; +1.181119374948624e-01   +7.857107186676471e-02   +1.765751122159034e-01   -7.330645510883568e-02   +2.749585296996399e-01   +1.928436828563471e-01   +3.048635890878402e-01   +3.020570283806349e-01   -2.955256240163699e-01; +2.612722520269411e-01   +8.773518227276304e-02   -2.075716346151750e-01   +4.803121929726493e-01   -5.124100085882313e-01   +3.914797496478060e-01   -1.451660888393133e-01   -1.520324036382485e-02   +3.038803726496565e-01; +5.771545728457788e-01   +3.003400401892197e-01   -3.353179979880353e-01   +2.668424693049478e-01   +1.002261068066664e-01   +2.434474235576193e-01   +9.146924707505563e-02   +3.314323417705515e-01   +6.827554883920565e-02; +1.035487104568498e-01   +1.124364902777279e-01   -1.248902598504426e-02   -1.509912391102843e-01   -1.059069739684179e-01   -1.470220300559272e-02   -2.739092390044330e-01   -3.684076353268245e-01   -2.984878701756962e-01; +8.234284872921672e-02   +3.125554712199226e-01   +7.902721850653095e-02   -7.966282888441244e-02   -1.303713712353490e-01   -3.205942149291101e-02   +3.774436178802431e-01   +4.164481334403242e-01   +4.958611278898678e-01];
L1_L4_iGABA_netcon = [+4.399513769844803e-01   -2.631999518647040e-01   -1.971911178868236e-01   +4.962046955825471e-01   -2.584996425497836e-01   -4.796198111739385e-02   +2.987850204131049e-01   +3.103862545996557e-01   -2.627685570848346e-01; +1.249831353128011e-01   +7.093698736707596e-02   +4.117790431042879e-01   -2.671262816058608e-01   +1.340187418999693e-01   +4.296379041942844e-01   +2.013442846029016e-01   +2.007732975339808e-01   -2.841903912270661e-01; -2.403127832253977e-01   +2.855998847854430e-01   -5.075594240682315e-01   -3.058128159579951e-01   +3.662956169464386e-01   -1.065697685421140e-01   +3.022332967490217e-01   -3.505367146732426e-02   +1.115898020359980e-01; +4.819180573416268e-02   +1.513268348477834e-01   -6.550657119904897e-02   +2.896205595614834e-01   +2.543300277453913e-01   -1.085164265793756e-01   +5.410996170359407e-02   -1.418495454120629e-01   +2.030611594731395e-01; +4.644812298097313e-02   +7.701715949609847e-02   +3.783093094748554e-01   -1.926628592292736e-01   -1.959318660447308e-01   -1.595678909746502e-01   +3.410085764977734e-01   +1.607528272394836e-01   -8.908048900854545e-02; +3.550903577550495e-01   +5.567986071428087e-02   +8.495685409300116e-02   +8.962761863637418e-02   -9.701462721257899e-02   +3.298840624499741e-01   -1.764660790611855e-01   +4.201867177417145e-01   +2.090480769195803e-01; -1.535023395195404e-01   -2.042430792016293e-02   -3.291317527992285e-01   +2.645701287850235e-01   +2.088718829673767e-01   -8.744809106459205e-02   +3.660990697906313e-01   +3.962047562143191e-01   +3.442694245459059e-01; -1.911560783980348e-02   -2.163863756327774e-01   +1.912596482203473e-01   +4.928861225552688e-01   +3.465659161652119e-01   +3.191747214698318e-01   +2.101301874045516e-02   +2.107427891296531e-01   +2.020647454055690e-01; -3.520532212704280e-01   +2.102027765454770e-01   +2.928846889984966e-01   +1.521836123274985e-01   +4.824632227238401e-02   +1.643862537765671e-01   +2.303209065518443e-01   +3.464724236102435e-01   +2.060652396450836e-01; +1.956022448368462e-01   +5.207348915368735e-01   -1.018618155400079e-01   -2.015370228162298e-02   +2.638830097936065e-01   -1.815678469809584e-02   -4.308126689068796e-02   +7.946440509657685e-02   +9.503067763328243e-02; -1.155808698217060e-01   +2.026457365410416e-01   -6.846234868982676e-02   -7.336584784815250e-02   +1.705989008795881e-01   -2.440121359682586e-02   -2.833387742566507e-01   +3.533562890744925e-01   +3.379031277771947e-01; +4.155567827641523e-01   -1.597851927533613e-01   +9.968604159592273e-02   +2.076489127241141e-01   +2.965814779795294e-01   -6.867648373618726e-02   +1.870812968696087e-01   +5.286393904942364e-02   +1.809996038413781e-01];
L4_L1_iAMPA_netcon = [+2.743125249195731e-01   +3.968057971975162e-01   +2.182541704670695e-01   -1.814420082361994e-02   +1.700869795463284e-01   +2.669274243574029e-01   +4.571842655903958e-01   +8.139327665072413e-02   +2.184025960545299e-01   +1.611616447461819e-01   -3.375625936415514e-01   -2.610072772610439e-02; -2.123932431537937e-01   +3.713207919664370e-02   -6.766828792708761e-02   +2.221043564212873e-01   +6.720349764829388e-01   +3.749594515029562e-01   -3.028934384280257e-01   -1.080776997488062e-01   +2.351603425474676e-01   +5.029454426777202e-01   -1.635955483872406e-01   -1.168588213629513e-01; -2.147579618742012e-01   +3.155222324138995e-01   +4.577332958476390e-01   -1.444307885473217e-01   +1.013780956190092e-01   +1.152280690747046e-01   +3.045595060901563e-01   -2.473778577369969e-01   +8.653730212257191e-02   +3.999831900993015e-01   +2.903673595564629e-01   +6.595215985381405e-01; +2.461124050779462e-01   +2.986331436070087e-01   +3.430084289633993e-01   +3.240658700148792e-01   +9.847344981060376e-02   -4.378258037282207e-02   -2.522282861402259e-01   +7.763412869596606e-01   +3.074460195706364e-01   -2.916130204123095e-01   -1.175621348659019e-02   +7.179955927335485e-02; +4.240761160407158e-01   -6.918888405034514e-02   -3.775362686108844e-01   -6.030572826463553e-02   +4.178711603166477e-01   +1.692198372505227e-01   +3.908407893240655e-01   +4.206235188295302e-01   +1.369929391294229e-01   -2.389825258225336e-02   -6.302413535080045e-02   -3.795748296143481e-02; +2.281044189357443e-01   -3.485200275813667e-02   -1.326017836722739e-01   -4.610035278814831e-03   +2.242494682149587e-01   -8.513047902167431e-02   -1.344170410034179e-01   -2.658935634622069e-01   +3.072743875774850e-01   +5.811804119879002e-01   +1.192040147909904e-01   +7.241637791882469e-02; -9.655866608888017e-02   +1.172601193530199e-01   +5.184023949955039e-01   +2.810146891419683e-01   -2.184684017855153e-02   +1.084760655243285e-01   +1.121551279674413e-01   +4.209163344067433e-02   +2.483438058723981e-01   +3.936228758435766e-01   +1.519622521275039e-01   -2.059974036313301e-01; +4.209316749092096e-01   -1.644180906500795e-01   -3.065256230473996e-01   -2.140687231589794e-01   -2.550513371352707e-01   +1.477833564198863e-01   +1.750538362207172e-01   -2.356510374252141e-01   -5.065360302506042e-02   -1.443956926606841e-01   +3.771349707805373e-01   +2.548246777839202e-01; -1.198937619754722e-01   -2.162545813799152e-01   +1.661144961608505e-01   +2.254671119356668e-01   -1.311593048032050e-02   -2.022486568967659e-02   +3.418764531694162e-01   +1.468527259339616e-01   -2.149421656201420e-01   +2.580734278608610e-01   +3.689609870235349e-01   +2.617908505778786e-02];
L1_L3_iAMPA_netcon = [+4.651084920993049e-02   -1.004644820532936e-01   +2.192906910795255e-01   -8.928710293477059e-02   +1.798964997534048e-01   -3.588729654162209e-03   -3.961853102595443e-01   +2.611606007189317e-01   +6.885271966306519e-02; +4.427125909272455e-01   -6.312521755705569e-03   +2.358053837104451e-01   -4.371368596548231e-02   +7.123600585861178e-02   -1.576126080999093e-02   -2.656094566455477e-03   -3.390594280202291e-01   +1.091985130922163e-01; +4.482915270495778e-01   +2.981994463802476e-01   -1.535326568797385e-01   -2.089168164826769e-01   +6.167829104763846e-02   +2.692387781357010e-01   +4.092785573948448e-01   +6.003949255812792e-02   +5.201609022365858e-02; +2.708238916623974e-01   +1.556509933074283e-01   +1.273644125426753e-01   -1.458841644585354e-02   +1.231661451509158e-01   +3.682796527408913e-01   +2.180405600596590e-01   -1.229242612385709e-02   +3.095598606840605e-01; -1.351488998689587e-03   +3.505271163876102e-01   -1.178729452812888e-01   +2.913279513665997e-01   +1.222312508509528e-01   +1.435705385386979e-01   -3.014946678653485e-01   -1.246614798195875e-01   +4.083286588063587e-01; -1.998583650971144e-01   -6.192702075437265e-03   +4.085601863536337e-01   +3.614722035607912e-01   +2.107775353818023e-01   +2.425938820439328e-01   +5.574415730311144e-01   +3.115545281345519e-01   +2.823231899878889e-01];
L3_L1_iGABA_netcon = [+1.380909436233972e-01   +4.595666877101140e-01   +3.094456079909953e-01   +3.699937786228140e-01   +3.221990131765835e-02   +3.749453413736463e-01; -3.466522695821933e-02   +1.190399091529090e-02   +3.807014963000730e-01   +3.045771683625644e-01   -4.323710766937462e-02   -3.345680162681884e-01; +3.697110339565254e-01   +1.798308027834363e-01   -1.831114704174285e-01   +4.726900659237084e-01   -4.918573740153596e-02   +2.824895225150612e-01; -6.354699774418368e-02   +1.512710048788457e-01   -2.610556854520438e-01   -1.218121668246863e-01   -1.105704963656007e-01   -2.651780565233121e-02; +1.016111625749244e-01   -5.503210559567812e-02   -1.972317698165759e-01   +1.290719218796690e-01   -6.573220904656257e-03   +5.787137478333800e-01; +8.106303373656755e-02   +7.141126735423861e-02   +1.417234040457107e-01   -1.676278143440472e-01   -2.041380932809736e-01   +7.908856275184400e-02; +1.235528816116530e-01   +8.253525896618496e-03   -1.135729190011294e-01   +2.919053637283705e-01   +2.986029013187254e-01   -2.412816823605289e-01; +9.640570319359035e-02   +3.295333629271480e-01   +6.309587630770912e-01   +1.318927418628387e-01   -1.981639640147984e-02   +1.060177508829930e-01; -2.125693698940254e-02   -2.595996741498032e-01   +3.317804084393350e-01   +3.851254519215447e-02   -1.592677140449070e-02   +2.381726331966618e-01];
L5_Input1_iAMPA_netcon = [+2.968965992065828e-01   -2.570773945812556e-01   +2.036816475540259e-01   -2.054010394910822e-01   -8.637694373479812e-02   +2.088799822265869e-02];
L6_Input2_iAMPA_netcon = [+1.473971737257708e-01   +1.173493164112993e-01   +1.625633332529212e-01   +8.424703954287308e-03   +9.768532776940007e-02   +3.183679438044800e-01];
L5_L6_iAMPA_netcon = [+2.950209004948251e-01   +4.781219241445060e-02   +1.375354564761080e-01   +3.608156352897211e-02   +9.356434979045271e-02   +2.337274929691049e-01; -6.118282992336674e-03   +3.131877496004754e-01   +4.455878433945561e-01   +5.623873035700244e-01   +3.500891367721334e-01   +2.250573458767838e-01; +3.972543187448051e-02   +1.196831562141122e-01   -5.051816247522267e-02   +4.382091347295179e-01   +4.664964813641193e-01   -3.860766411068575e-02; +1.686028364267987e-01   -2.351795315145671e-02   -7.137178459715862e-02   +1.219449598132169e-01   +4.906652569152695e-02   -2.286520124511436e-01; +2.424326474725101e-01   -4.306061863628671e-02   +4.962376549644903e-01   -2.175502487639554e-01   -2.406760534676239e-01   +3.301061403365560e-01; +1.613938117809722e-01   -5.310620178410685e-02   +5.881291677161420e-02   +6.044634023993171e-01   -1.349770060598628e-01   +3.343734036004805e-01];
L4_L5_iGABA_netcon = [+3.409187774079971e-01   -4.101341803157395e-02   +2.378454229886326e-01   -9.815498786985119e-02   +2.365552455118467e-01   -2.705571571476484e-01   -3.238294203202455e-02   +4.775327496140626e-01   +5.107553974657340e-02   +2.051964619668523e-01   +3.674440704990020e-01   +1.456681803499151e-01; +1.630153916586801e-01   +3.432411033588456e-01   +2.830480317115843e-01   +2.133975518668633e-01   +9.581394270365529e-02   +4.757341882755565e-01   -4.186807291603495e-01   +4.728824001189137e-02   +3.757935122692139e-01   -2.489248174282352e-01   -1.580588703475067e-01   -3.453952642648097e-01; +1.471238859026586e-01   +3.331303744448166e-01   -2.408402720479495e-02   -3.222879569831912e-02   +1.129687948299637e-01   +1.777151983240889e-01   +3.096224007493935e-01   +2.536994024535172e-01   -1.955709909530273e-01   -2.086527515834518e-01   -2.107059688035418e-01   +2.823087763176163e-03; +3.454011092410457e-01   -1.758804564938122e-01   +3.338039567086552e-01   +1.682181344425018e-01   +2.386179166182125e-01   +9.386429701129788e-01   -2.506848331452888e-01   +1.354321904194565e-01   +3.387209584403982e-01   -2.956045037746222e-02   -2.200902933969257e-02   +2.428353013909565e-01; +2.061562578795020e-02   +1.666927893912870e-01   -2.477995135944661e-01   -1.583158607259841e-01   +2.237602896932371e-01   +1.963652289207821e-01   +5.261439581607735e-02   -7.333407591007211e-02   -5.810377374873407e-02   +5.851460995063071e-01   +3.569536582086832e-01   +1.449155225183136e-01; -4.215865370953376e-01   +4.856370976342548e-01   +1.598746986872845e-01   +2.511393911667741e-02   -3.171490156220504e-01   -4.364068840907946e-03   +6.181152147053078e-02   +1.276591351540014e-01   +2.073701259959221e-01   -2.690754675602073e-02   +3.205960195800312e-01   +1.276330842480564e-01];
L6_L4_iAMPA_netcon = [+3.407982820124718e-01   +4.566123201937384e-01   -2.132098160016380e-01   -3.064300922003214e-01   -1.610813714341614e-01   -3.332331899021930e-01; -8.998261938493259e-02   +1.964244028338336e-02   +2.797959377626453e-01   +5.824421020020983e-01   -6.276787426775429e-02   -9.402627374177937e-02; +3.158200668120668e-01   -9.423596471352395e-02   +5.360458359927922e-02   +1.464398548003418e-01   +4.539524965090506e-02   -6.111767817769768e-02; -9.874511362282409e-02   -1.781947111039668e-01   +3.322120312459434e-01   +2.810226938283292e-01   -3.613482660865255e-01   +1.400692152807463e-01; -3.737422613637658e-01   +2.360784325055631e-01   -3.072112345585319e-01   +5.982811733192667e-01   +3.542009204716248e-01   +9.528419108221026e-02; -1.716078067200859e-01   -1.754658172817790e-01   -9.084494615749264e-02   +5.265639609307528e-02   -1.468900838152791e-01   +6.049133823578259e-02; -3.866130830617574e-01   -3.513252791192892e-01   -1.565374469554336e-02   -2.742871253617680e-01   +4.571701756903083e-01   -1.887274824709770e-02; +5.030796796751837e-01   +2.304588598941269e-01   +7.137499386950630e-03   +1.940647777298223e-01   -1.416288924867685e-01   +2.230710422899500e-02; -1.223519843333439e-03   +1.737335792886928e-01   +2.002733878332454e-02   +3.315427494950329e-01   +2.911437710555638e-01   -1.189039934354562e-01; +3.066209697091978e-01   +2.660424322177294e-01   -2.526612141032850e-01   +1.872054084446849e-01   +3.881922295560272e-01   -3.330052246268693e-01; -3.082633850032182e-01   +2.579076281870044e-02   +3.953460238616658e-01   +6.797057123858138e-03   +2.948942709396626e-01   +3.448558565175116e-01; -1.275595343080955e-01   +2.778576964148232e-02   +3.267528371943867e-01   -2.140725534146157e-01   +2.887811493207452e-01   -3.631959352856673e-02];
L5_L4_iAMPA_netcon = [+4.167566600864797e-02   -3.032129778413060e-01   +1.636421293208556e-01   +1.133020085294996e-01   -3.001119459759499e-02   -4.445256969577892e-02; -9.666538687103265e-03   +1.017588971197533e-01   -1.407190507025842e-01   +2.832093694327785e-01   +1.643106724525468e-01   +2.803837616323008e-01; +5.320335805003620e-02   +2.045099237526401e-01   -9.814203323821033e-02   +2.654621056775383e-01   +2.147420863435641e-02   -2.657986755624335e-01; +4.459451140233738e-01   -1.864880533541382e-01   -2.080113043700508e-02   +5.767387387958538e-02   -1.844929493056054e-01   -4.278712706196908e-02; -2.970254886448861e-01   -1.970837436129186e-01   +3.407768643823118e-01   +1.410334161914366e-01   +2.104180103091892e-01   +1.004214413718464e-01; -1.018217088740206e-01   +7.022508707764955e-02   +1.469703190449999e-01   +2.169545582701689e-01   +3.291199043572607e-02   +1.570740866958025e-01; +1.411328243400650e-03   +8.691917587903700e-02   -7.298208186886507e-04   +2.491841579945889e-01   +3.370887842970887e-01   -2.544247232402452e-01; -4.136683693151800e-03   -8.817252019699143e-03   +2.283185131146716e-01   -3.629851791960381e-01   -2.192915326110914e-01   +1.278898103611472e-01; -1.613012434383260e-01   -4.010852037285728e-01   +5.465330547956754e-03   +4.541487708063031e-02   -2.178923274410816e-01   -4.283469970974221e-01; -1.135289764089637e-01   -2.778695066352923e-01   +3.357578932414456e-02   +2.367504683141033e-01   +1.451567100375515e-01   +2.165164603300407e-02; -1.964357605567527e-01   +6.410037442920138e-01   +1.889587022643396e-01   +3.373246566905821e-01   -1.965339149236882e-01   +2.275368466249509e-01; +2.400408666098914e-01   +2.704734912155837e-01   +6.388076438716873e-01   +1.315698971311517e-01   +1.577703969258819e-01   +1.207665153451945e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
