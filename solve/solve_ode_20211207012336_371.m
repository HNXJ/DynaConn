function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.962233593574771e-01   -3.480335748798875e-01   -5.522646974892292e-01   -4.593794643558634e-01   -4.099024022170913e-01   -3.722272230276540e-01   -6.046875348496339e-01   -6.533034321024488e-01   -6.313140744216071e-01; -5.647813994794008e-01   -4.919814330340741e-01   -6.316306879719201e-01   -5.591651300854206e-01   -6.056995592164651e-01   -6.058715970491944e-01   -6.966212842033606e-01   -5.999805914659693e-01   -5.094954854069784e-01; -5.667591625520237e-01   -2.614192790532071e-01   -4.886458701666641e-01   -5.631041978263267e-01   -5.605738783538947e-01   -5.500257086145449e-01   -7.056598006970356e-01   -5.410868265776939e-01   -5.634635966500141e-01; -5.469501775149438e-01   -4.464268927109726e-01   -5.442804167927960e-01   -5.796390741556912e-01   -2.760157222927447e-01   -3.889521086861520e-01   -5.309641382372460e-01   -2.466976699006894e-01   -4.092588931068026e-01; -5.883319595696543e-01   -4.660726020472342e-01   -1.980406638151302e-01   -5.244971783031049e-01   -4.431971003677699e-01   -4.582948825514398e-01   -4.412664620172341e-01   -6.977754672072006e-01   -4.534227140498662e-01; -4.686578693026626e-01   -4.180152168980563e-01   -4.257168505020679e-01   -5.585047132486467e-01   -4.366753702876470e-01   -5.788332229027582e-01   -6.293163789208349e-01   -6.942558673388828e-01   -4.489862602029334e-01; -5.731619905254453e-01   -6.147928350701819e-01   -6.307181551595118e-01   -6.089681316970873e-01   -7.541267279500985e-01   -5.537017887890550e-01   -5.974116050744117e-01   -7.548016779673430e-01   -7.438342714699651e-01; -5.352037382568723e-01   -5.173496109996025e-01   -6.478366262850221e-01   -3.636640764939652e-01   -3.654035266187525e-01   -3.556970425920832e-01   -5.849764996182510e-01   -7.728981802909238e-01   -6.675500823017650e-01; -5.953994186756993e-01   -4.269123098072604e-01   -6.610169911771578e-01   -3.665675515560339e-01   -4.939365182563664e-01   -3.468598342458719e-01   -5.130595115690507e-01   -4.843156565192005e-01   -3.871715257276068e-01];
L1_L2_iAMPA_netcon = [-4.467703280208307e-01   -5.019418178423569e-01   -5.336451196170575e-01   -6.164722294502509e-01   -7.334239971640080e-01   -4.224324901439093e-01   -3.406844414412435e-01   -6.348004507514442e-01   -3.824938516958422e-01; -5.128654014336804e-01   -5.427832037690040e-01   -4.884942588259116e-01   -5.550735236212269e-01   -6.496122825385339e-01   -5.936907536424277e-01   -5.582909311191111e-01   -6.554121344397640e-01   -4.208139361569895e-01; -5.801332174701490e-01   -3.619943281994480e-01   -7.517865879060662e-01   -6.028676921498228e-01   -2.567614506565008e-01   -6.451366867621350e-01   -4.425457175083279e-01   -5.191338483379128e-01   -5.931510384942675e-01; -3.534427450388608e-01   -4.771069468015342e-01   -7.000975232078245e-01   -6.321642202493565e-01   -5.446045655656804e-01   -6.867673820835821e-01   -5.904583821725453e-01   -5.081785977219834e-01   -5.429924451089323e-01; -6.637226868070153e-01   -5.051740520490834e-01   -3.256483059761229e-01   -4.784321478740806e-01   -5.247825966954542e-01   -6.030051703487114e-01   -3.552154292612392e-01   -5.690224879094152e-01   -5.126373933472951e-01; -8.158839634165373e-01   -5.403553564887004e-01   -6.141120679322851e-01   -2.097367389706986e-01   -6.618056453560031e-01   -5.891340854451241e-01   -4.866663230981871e-01   -2.691036172312054e-01   -5.220398209216802e-01; -6.194299299747412e-01   -4.100631253076105e-01   -4.904327212084261e-01   -5.772584271031654e-01   -4.960031502265990e-01   -7.422660373508333e-01   -5.936859650081812e-01   -5.557078707999911e-01   -4.644039990739718e-01; -1.746774025807690e-01   -5.019769652042930e-01   -5.248274071440655e-01   -4.362205576517117e-01   -2.980537072947782e-01   -5.463002889939366e-01   -4.309392245331820e-01   -4.062516724743230e-01   -5.918465893667203e-01; -7.196629138334479e-01   -5.244244987416220e-01   -4.955156064060287e-01   -5.796105297930739e-01   -2.014898371946530e-01   -7.519925307535520e-01   -3.980150081478578e-01   -7.165482210279565e-01   -4.097459108373447e-01];
L2_L5_iAMPA_netcon = [-5.265035079316680e-01   -3.015682346171196e-01   -7.820314794808438e-01   -5.248916017374660e-01   -5.517008038688458e-01   -4.969996555157035e-01   -6.221484682129150e-01   -3.291028250019234e-01   -5.448871716391820e-01; -4.727309174061192e-01   -4.917873480588598e-01   -6.482527291131979e-01   -4.118027744719573e-01   -5.371442675157587e-01   -7.742246333176122e-01   -3.531741898428007e-01   -5.738620564608727e-01   -5.521364178934628e-01; -3.559600934859091e-01   -3.490563796464675e-01   -5.773874460471203e-01   -2.630843457817146e-01   -4.114302531094036e-01   -2.345380554625840e-01   -4.199379745305470e-01   -5.406079594419958e-01   -4.676456490992009e-01; -6.563865960685258e-01   -3.164655510291736e-01   -2.954110544228952e-01   -4.516169590598491e-01   -7.732971581520699e-01   -4.217987922242062e-01   -5.248569794890625e-01   -6.558883467150138e-01   -5.994597858336842e-01; -5.259816708167857e-01   -5.678726344190985e-01   -5.816125989894572e-01   -4.874311435232211e-01   -5.993844815202034e-01   -7.030249369803833e-01   -7.005239041374323e-01   -4.701949662543777e-01   -3.417519980410627e-01; -4.485364164392575e-01   -5.998716300527862e-01   -5.820901126772536e-01   -3.722286009278784e-01   -4.500861326693543e-01   -6.681652722076978e-01   -6.246561446783701e-01   -5.297897960988629e-01   -3.836078451439964e-01];
L5_L2_iGABA_netcon = [-6.496496202031994e-01   -5.687221650098598e-01   -7.449716782766491e-01   -4.399550003999413e-01   -6.030141772228111e-01   -5.396365684100661e-01; -4.948678994823993e-01   -4.009929637696302e-01   -5.982510311781851e-01   -6.739363641263215e-01   -5.237351562838666e-01   -6.213020591819148e-01; -5.264286267725287e-01   -4.657345421019483e-01   -6.435205615637400e-01   -5.210326969939988e-01   -7.321028062381026e-01   -5.632988805003422e-01; -3.006670282730725e-01   -5.762750298613635e-01   -3.555070112794997e-01   -4.433445378173826e-01   -4.571582509336599e-01   -4.629573115969613e-01; -5.753661110453655e-01   -4.856367119243908e-01   -5.279018252160060e-01   -5.532264218682115e-01   -5.935711217126733e-01   -2.665642749502759e-01; -4.123151888821640e-01   -3.346607135629112e-01   -3.087018340822402e-01   -4.729754690173218e-01   -5.872761019676627e-01   -6.096736169394519e-01; -4.770361639134389e-01   -5.373311799196336e-01   -6.765731017343015e-01   -4.119693519012038e-01   -2.232361802801524e-01   -4.143269734862115e-01; -5.777735978375598e-01   -3.103001657373152e-01   -4.685706919568207e-01   -5.979395226784603e-01   -4.718508019339121e-01   -3.793058932411781e-01; -4.028859231052953e-01   -5.688265581488283e-01   -6.452499659449316e-01   -3.997770358513985e-01   -2.890618422057761e-01   -6.010909371526120e-01];
L3_L2_iAMPA_netcon = [-5.489512351862309e-01   -5.414894172001335e-01   -3.688912790764352e-01   -5.706816183040978e-01   -4.918831318044391e-01   -3.391072601834195e-01; -3.386048815962395e-01   -5.715237777077329e-01   -5.797676018160984e-01   -5.753477159225352e-01   -4.502757638253193e-01   -5.666771165110293e-01; -6.822021343062989e-01   -6.390097619299514e-01   -5.538339476957426e-01   -7.410782570150386e-01   -4.913381064015519e-01   -5.480746622413366e-01; -5.784724092866936e-01   -5.468613364722614e-01   -6.790623057319517e-01   -5.450528757728175e-01   -4.973611668224173e-01   -3.686976849199830e-01; -6.553147130933615e-01   -5.918371056376561e-01   -4.222337263940545e-01   -4.339713346008954e-01   -4.814452034251758e-01   -5.232984627769658e-01; -6.511816525247723e-01   -4.813930312452601e-01   -4.476470881669055e-01   -5.502202620245561e-01   -5.286477160600238e-01   -6.662795982999484e-01; -6.804932302693683e-01   -4.402123679645878e-01   -6.296636559181742e-01   -4.659163600376324e-01   -4.646834362659936e-01   -4.178986368775927e-01; -4.685097027801992e-01   -4.932784026947435e-01   -6.080708436331486e-01   -5.025698038460099e-01   -6.463376672878870e-01   -3.260897140174066e-01; -7.678690910089975e-01   -5.428304132134525e-01   -4.612437945055715e-01   -4.263871030436238e-01   -3.882054670807170e-01   -5.029843720512021e-01];
L2_L3_iAMPA_netcon = [-4.076225641658067e-01   -5.472784392856327e-01   -6.791353450435850e-01   -6.097401563785489e-01   -6.133323123163954e-01   -6.214314802452303e-01   -5.450930865632025e-01   -4.044702650939278e-01   -4.365433750492420e-01; -5.692339231147060e-01   -4.607415600924220e-01   -3.592992030767164e-01   -4.796933668959850e-01   -4.257319264461839e-01   -4.911363693053448e-01   -4.910881182279291e-01   -5.491656211823525e-01   -4.240189707359379e-01; -4.355540468232560e-01   -6.486030720507376e-01   -6.219466895192599e-01   -4.630018198733725e-01   -5.385659635196725e-01   -6.597836486041572e-01   -4.911295577209774e-01   -5.692845538085067e-01   -6.375265110507836e-01; -5.651233050948420e-01   -6.500217402415303e-01   -5.580877635315126e-01   -2.991286697471192e-01   -3.620737606737868e-01   -4.300079236954459e-01   -6.730902334387070e-01   -2.956118485885516e-01   -3.598637068314305e-01; -5.784787553782664e-01   -7.050638787621264e-01   -5.087127237031127e-01   -4.265875128278964e-01   -7.027919494404988e-01   -6.219776515327538e-01   -5.030449398738187e-01   -3.401577736299895e-01   -5.955956924025714e-01; -1.972373379567742e-01   -2.550384041897628e-01   -3.588912166152736e-01   -5.114718552742241e-01   -3.354584493048359e-01   -5.838653683529825e-01   -7.101413572627076e-01   -4.832989431233208e-01   -5.678861529793053e-01];
L1_L4_iGABA_netcon = [-5.951108458343642e-01   -5.224712005595090e-01   -7.429911533953446e-01   -6.174984393963983e-01   -5.912447917403251e-01   -4.165436375576408e-01   -4.687987303673626e-01   -5.132693692881470e-01   -3.384515742951255e-01; -4.008561008486670e-01   -4.878259801161758e-01   -4.937440484094093e-01   -5.134041626556691e-01   -5.643965780296715e-01   -6.504874406381291e-01   -5.202369069125560e-01   -6.942518834345269e-01   -7.575435259506876e-01; -6.811723371318604e-01   -6.145682920553861e-01   -4.428682006905800e-01   -5.979687067609281e-01   -4.199192669779033e-01   -4.893668967806546e-01   -7.311650930994622e-01   -4.633225995838752e-01   -3.617837171041258e-01; -4.310327289067366e-01   -6.435817281014421e-01   -6.092347594406116e-01   -4.658977346967484e-01   -7.010784236301570e-01   -2.796306932249905e-01   -5.309461506638248e-01   -5.842095322503768e-01   -3.111979571655004e-01; -4.787500792016306e-01   -5.665100532500942e-01   -5.950445332782122e-01   -4.451256013142315e-01   -4.416856769291850e-01   -6.925640721220523e-01   -6.051464476816699e-01   -6.258811613543858e-01   -6.124774773392521e-01; -4.142552458607211e-01   -5.435710855901627e-01   -6.648626340477025e-01   -5.102091291535235e-01   -4.436328295758788e-01   -3.731339575668010e-01   -5.112461269731641e-01   -4.927003417428434e-01   -4.522485485135138e-01; -5.746852948570740e-01   -6.859187077832728e-01   -5.067437450604930e-01   -4.469524541862179e-01   -4.452710748046320e-01   -6.883366834676772e-01   -2.363251040549933e-01   -7.258048941104015e-01   -4.883339779345476e-01; -7.859806770970039e-01   -5.404205691315573e-01   -3.912308824653157e-01   -5.289159708454391e-01   -4.754394735576514e-01   -4.028656231319699e-01   -5.564915247311718e-01   -6.506869895519460e-01   -5.901541951322984e-01; -5.701996437976860e-01   -5.679674636659939e-01   -3.245129181393588e-01   -3.342759387307340e-01   -4.405725389032623e-01   -4.031902415930693e-01   -6.858332316963671e-01   -4.839503932067451e-01   -5.165121484218729e-01; -6.351282126277280e-01   -3.056212803052571e-01   -5.543807916123669e-01   -6.909429038814454e-01   -5.790565628345363e-01   -5.321327126428712e-01   -4.127375638677705e-01   -4.629997563894015e-01   -2.636500764568271e-01; -4.509828301779277e-01   -4.031672019560225e-01   -3.211774661592507e-01   -4.309195993090756e-01   -6.068779409336105e-01   -4.979447050644746e-01   -5.651703975980541e-01   -6.675704932453922e-01   -5.248335407940775e-01; -7.857003977247855e-01   -5.249496614664051e-01   -5.370666146094620e-01   -6.701127289352464e-01   -6.358470908148043e-01   -4.926920368319304e-01   -5.359864334506602e-01   -6.781629694334879e-01   -5.200287731094856e-01];
L4_L1_iGABA_netcon = [-5.274596608011656e-01   -3.187972955865414e-01   -7.016650535841694e-01   -4.772763326240545e-01   -5.487333206326004e-01   -6.344887747619355e-01   -6.315721825437545e-01   -6.652266617267814e-01   -3.440714981139540e-01   -5.067020713714885e-01   -6.849739544940213e-01   -6.044329852283320e-01; -2.489683743505830e-01   -6.302775362584196e-01   -4.429300486508572e-01   -5.322516741174905e-01   -5.964594637253000e-01   -7.050683574205275e-01   -6.435923819616463e-01   -7.126540878265126e-01   -3.548357843631442e-01   -3.827494042105933e-01   -4.881130445798371e-01   -5.100727750123316e-01; -4.468557062037808e-01   -5.444806857273674e-01   -7.443730384951588e-01   -4.305680566015995e-01   -5.283923935149329e-01   -5.797580716686058e-01   -5.119895866204572e-01   -3.421680216192309e-01   -5.424249111608064e-01   -4.999575392754467e-01   -5.976400808828979e-01   -5.876585292432526e-01; -6.404003469729644e-01   -6.696051311331881e-01   -5.532677478202654e-01   -4.557278074749151e-01   -6.882586793303341e-01   -5.680689232534072e-01   -4.241390159177422e-01   -5.699641999079417e-01   -4.492859377173737e-01   -4.994154556586868e-01   -2.654689899562501e-01   -4.375760045257776e-01; -6.921486488921840e-01   -6.487290268974638e-01   -4.795843106555155e-01   -4.895305045095032e-01   -5.473555149537646e-01   -7.025302645429443e-01   -3.176337644414903e-01   -5.575170021473048e-01   -4.677161840347743e-01   -5.573918537329094e-01   -4.912596098913239e-01   -5.455790140354769e-01; -6.435096690441431e-01   -3.860716243329143e-01   -4.011779001463096e-01   -4.730291926845776e-01   -6.126744168845524e-01   -4.439287988713854e-01   -6.015785272216428e-01   -5.027929127932470e-01   -5.250618343994039e-01   -4.481569260848132e-01   -4.265949306254209e-01   -6.932648689237123e-01; -5.280957498404480e-01   -6.605841073467231e-01   -6.172708755954892e-01   -3.984409444409522e-01   -5.267342163840069e-01   -6.580626076810897e-01   -5.014212661759492e-01   -7.265781222688523e-01   -3.922503069107417e-01   -4.039176920332885e-01   -6.420006905951653e-01   -6.504176089624080e-01; -5.422323250851320e-01   -5.152493039412531e-01   -4.317125650516650e-01   -4.274230310804686e-01   -6.867236903549285e-01   -6.256896855235629e-01   -4.034444829192890e-01   -4.828216569667552e-01   -3.984387841117960e-01   -6.682917060070634e-01   -5.442772540408255e-01   -3.928207205821662e-01; -7.895992428873465e-01   -5.537045763894215e-01   -5.058167472876447e-01   -5.911606409403869e-01   -6.331109778636618e-01   -4.230148387091744e-01   -3.894318311779546e-01   -4.704175554657490e-01   -4.601899254069556e-01   -6.039114323361011e-01   -3.527300545113842e-01   -6.350263644315775e-01];
L1_L3_iAMPA_netcon = [-6.248402072808454e-01   -5.331191615945569e-01   -4.390755154318429e-01   -7.249965274419820e-01   -6.719379605225515e-01   -4.871876860554706e-01   -3.555072519534254e-01   -4.834862932148945e-01   -4.309378919178957e-01; -6.736553748442241e-01   -4.331794079748639e-01   -6.600381422728920e-01   -4.788208047150105e-01   -5.129394189040630e-01   -6.658138437134373e-01   -3.074177131612405e-01   -6.853549324200291e-01   -4.159170631782109e-01; -4.840089083307428e-01   -4.700747620631440e-01   -6.533065055160785e-01   -3.729921780492159e-01   -3.365216081166406e-01   -6.579867135815186e-01   -3.703489300828365e-01   -7.656227349140146e-01   -7.701769807927328e-01; -4.054338425046922e-01   -5.322067710220908e-01   -6.055236001968798e-01   -6.128668752612654e-01   -3.240831369619277e-01   -4.022346434828729e-01   -5.236254647820261e-01   -6.801987855575854e-01   -4.298410136818216e-01; -5.172035916386182e-01   -6.852032314388427e-01   -5.710875333413057e-01   -5.068136102218239e-01   -5.455441064372778e-01   -2.922457340520271e-01   -5.167028886091836e-01   -3.270588064184554e-01   -6.031309344511401e-01; -4.629691383979410e-01   -5.277555341824054e-01   -6.104450908940777e-01   -6.592777283314841e-01   -6.331991643015744e-01   -5.078003066005476e-01   -4.649642847798704e-01   -2.910907622710087e-01   -5.780028157836901e-01];
L3_L1_iGABA_netcon = [-7.188037914586634e-01   -4.549893175462423e-01   -4.608872009233884e-01   -5.960549247910546e-01   -3.441337105830827e-01   -7.789077627404616e-01; -5.953911350522260e-01   -6.006610019895013e-01   -4.096536061582686e-01   -4.201590359153315e-01   -5.286096247993189e-01   -6.540638734009768e-01; -5.036155519654053e-01   -5.975609803037460e-01   -3.393650714899892e-01   -3.947039164598215e-01   -3.854128802187409e-01   -6.356440062257261e-01; -3.649858485290873e-01   -4.272037946183441e-01   -5.045176135973113e-01   -6.394704574517263e-01   -5.081378375983349e-01   -7.637636177565816e-01; -5.010966693666814e-01   -6.072117851982615e-01   -7.738211895798031e-01   -5.630033283858058e-01   -4.380205371259591e-01   -3.611750227316238e-01; -3.655602385388315e-01   -4.449581113757878e-01   -5.881049801707007e-01   -3.686060348310944e-01   -3.054359891661863e-01   -5.287546945137820e-01; -5.170523966230769e-01   -5.095564658943255e-01   -4.084048225892291e-01   -5.825661534198094e-01   -2.833490776079665e-01   -2.520853052900623e-01; -3.171489224151159e-01   -5.742567314665395e-01   -5.186722796908145e-01   -6.118662522662616e-01   -6.484962192946023e-01   -4.623174072123089e-01; -6.939532250251698e-01   -5.088957046116603e-01   -6.403910556309620e-01   -3.824337262642110e-01   -6.845841661851384e-01   -4.463891649748924e-01];
L5_Input1_iAMPA_netcon = [-5.561401511583404e-01   -5.944141917323441e-01   -4.247825293444084e-01   -4.017327693002994e-01   -6.623785521488178e-01   -8.108005214244622e-01];
L6_Input2_iAMPA_netcon = [-5.493819870435790e-01   -5.806142479936446e-01   -5.727297602620577e-01];
L5_L6_iAMPA_netcon = [-6.219446732886673e-01   -6.810453143516726e-01   -3.859326676070236e-01   -5.876913382328842e-01   -5.536780040469909e-01   -4.746625454316354e-01; -5.124327814644634e-01   -4.596983703509407e-01   -5.226908727869701e-01   -6.160526794549840e-01   -5.689431392601060e-01   -4.842305513945204e-01; -7.554140632526222e-01   -4.099218689081231e-01   -4.224284998704462e-01   -4.699830676137284e-01   -5.030873926275142e-01   -4.666823446562566e-01];
L4_L5_iAMPA_netcon = [-3.735567056386341e-01   -3.793761652493237e-01   -4.532489301872674e-01   -4.847987285945380e-01   -5.431033595958845e-01   -5.383265485535162e-01   -4.174571559384193e-01   -3.160656259460809e-01   -5.947226787351415e-01   -4.678765655187361e-01   -6.303085408220358e-01   -4.328117224371537e-01; -4.100755539706337e-01   -4.591142710581096e-01   -4.746175450546946e-01   -3.123575959598585e-01   -5.884796015985834e-01   -5.186522515287936e-01   -5.857192605732018e-01   -3.632741277973724e-01   -3.411113906686364e-01   -3.514335053516316e-01   -6.900689583038100e-01   -6.214866535740308e-01; -4.029080844979409e-01   -6.351460600551182e-01   -4.619741395769291e-01   -4.431337638672787e-01   -6.015926325960245e-01   -5.161067136315737e-01   -5.320693345503842e-01   -4.825206329797921e-01   -5.222289840877751e-01   -6.054200027854251e-01   -5.440130122745163e-01   -4.075112605822465e-01; -2.496567208809436e-01   -6.051232869218245e-01   -4.575737958916494e-01   -3.631063420064274e-01   -7.303901144244564e-01   -4.919257295043816e-01   -3.747783296968360e-01   -5.811708201490308e-01   -6.091592634189524e-01   -5.477464650556477e-01   -7.047820877722675e-01   -6.486266175847388e-01; -3.521219971153636e-01   -2.430018242360618e-01   -7.148576419589231e-01   -4.651551892393095e-01   -3.149312431447729e-01   -3.829708406090199e-01   -5.476482033637107e-01   -6.212339552684522e-01   -6.171421562020593e-01   -6.830680317295409e-01   -5.692522027427415e-01   -2.330372153135370e-01; -6.586815868866270e-01   -5.339558114379138e-01   -6.098563587794492e-01   -6.238162307336218e-01   -6.235813505218302e-01   -6.454280250632460e-01   -5.059583605600722e-01   -5.382144417847380e-01   -3.920833719674961e-01   -7.935664501559796e-01   -4.897721803361745e-01   -6.777075570678465e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
