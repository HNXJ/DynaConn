function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.722623965958236e-02   -2.088275758866719e-01   -2.584960920749965e-01   -4.747005223443022e-01   -3.451662165095480e-01   -1.823944469996438e-01   -7.706762920959327e-01   -4.707520139037288e-01   -6.316497747921895e-01; -3.687202670466093e-01   -4.805991764127083e-01   -4.557451442669639e-01   -5.224068881442074e-01   -3.128248536880695e-01   -2.423585129045641e-01   -5.326280313796116e-01   -6.291771088342786e-01   -2.509380701721551e-01; -4.842114591679406e-01   -2.084057208802625e-01   -5.262788856100136e-01   -8.540338751593787e-01   -5.057936688602092e-01   -2.457482385886826e-01   -5.473634827757922e-01   -4.046125555247904e-01   -7.110887251061374e-01; -3.931144837762522e-01   -1.680283180676376e-01   -3.888576265467193e-01   -3.560784850671056e-01   -1.544575373225310e-01   -2.359222610504948e-01   -5.995211111731896e-01   -1.101491336658144e-01   -4.483618625611621e-01; -6.388436190513034e-01   -3.258254114115672e-01   -6.501382252447505e-02   -1.515279566618105e-01   -2.584743721272050e-01   -5.154541264869803e-01   -3.988365724289178e-01   -6.752352596213227e-01   -5.293130562754044e-01; -2.952042771818636e-01   -1.460752402194277e-01   -2.731898415878945e-01   -6.081015503533462e-01   -2.425935664879183e-01   -3.669660546606540e-01   -6.095243535330463e-01   -5.612646233961459e-01   -1.947717128788606e-01; -3.793596010522975e-01   -3.089281239970957e-01   -3.758792552032396e-01   -5.977930486015086e-01   -8.707529811895658e-01   -6.972114315620394e-01   -4.061018333077491e-01   -5.772483748629429e-01   -5.227296759860952e-01; -4.832086895062453e-01   -6.978859547610383e-01   -7.671231774763951e-01   -3.687464177569072e-01   -3.405888078033323e-01   +3.429965339898380e-02   -4.990428148679546e-01   -7.779922209447245e-01   -4.747642308669342e-01; -7.027020754431194e-01   -2.314643899465698e-01   -2.419130717986414e-01   -3.545763182320953e-01   -4.937981600636956e-01   +8.145448560440534e-03   -2.283514450850707e-01   -5.371925242527286e-01   -5.378163582576179e-01];
L1_L2_iAMPA_netcon = [-2.837561147441632e-01   -5.344582525293422e-01   -5.266329310043695e-01   -4.868013941388145e-01   -5.779220667370417e-01   -4.352454109593362e-01   -3.317121068695570e-01   -5.460864946580799e-01   -1.960498641567280e-01; -2.721142524073923e-01   -4.655382525060948e-01   -3.251461593559030e-01   -3.997726243403354e-01   -2.297714099552454e-01   -5.487992676189514e-01   -2.323761778297333e-01   -4.980557070162480e-01   -4.067147320469974e-02; -5.017373230352254e-01   -1.497842222518325e-01   -4.454547349937322e-01   -3.034329634760856e-01   -8.722452986635063e-02   -7.286156767120029e-01   -5.787571608417413e-01   -3.318529372365089e-01   -4.988125837615741e-01; -3.160090919695283e-01   -4.039345099369513e-01   -7.498575429450228e-01   -3.671041864297993e-01   -2.029980280198807e-01   -5.082517568150331e-01   -5.647956198012830e-01   -6.191022877692582e-01   -5.832075348828232e-01; -6.484470229029460e-01   -3.655964376959474e-01   -3.903964215378870e-01   -3.671779686708167e-01   -4.531184693255347e-01   -4.447167533022218e-01   -3.473387281830621e-01   -4.533703523701528e-01   -4.335049583742600e-01; -8.443090170041166e-01   -4.818676280972948e-01   -7.320711200806080e-01   +1.734550081653850e-01   -4.837434316487058e-01   -7.335219484202903e-01   -3.087530149594309e-01   -2.543341226742356e-01   -4.941128805360424e-01; -5.176158290298757e-01   -2.844667233298851e-01   -5.564482041160509e-02   -1.766258538036889e-01   -2.677850765540486e-01   -5.440596684833154e-01   -4.367335420134015e-01   -3.953610164225835e-01   -3.408595073467240e-01; -8.301596471046685e-02   -3.042156097688021e-01   -3.864061127587561e-01   -2.975010337125980e-01   -1.208808058006031e-01   -2.930302501920579e-01   -8.960514047033560e-02   +8.762491260336409e-02   -4.193956693929627e-01; -8.359908432719511e-01   -5.945757825951674e-01   -5.671577179660546e-01   -5.015115063181528e-01   -1.700862057911048e-03   -7.621094258751777e-01   -1.267689424844136e-01   -5.786897776955098e-01   -2.297708323474967e-01];
L2_L5_iAMPA_netcon = [-3.775311859821568e-01   -2.620957055917404e-01   -5.733482549211263e-01   -2.375872895902928e-01   -3.368358059811067e-01   -3.969530452778534e-01   -6.233355212739016e-01   -2.092931144687457e-01   -6.115318284811034e-01; -2.122136252294400e-01   -4.762938511889294e-01   -6.099872879265947e-01   -1.724515727288577e-01   -6.965475856961927e-01   -9.244061106800225e-01   -4.899792570307566e-01   -1.761531311717965e-01   -5.457789329957492e-01; -4.831065717417252e-01   -2.313197318064545e-01   -4.952799669765899e-01   -1.541935502287212e-01   -2.381475921886678e-01   +5.230981734081935e-02   -3.495862943993632e-01   -6.638687653820878e-01   -2.938738109850056e-01; -2.855302510489933e-01   -7.700857314913225e-02   -7.583462725542132e-02   -1.960495972857488e-01   -5.857693324435442e-01   -1.530071880970608e-01   -4.536521899472316e-01   -4.534709528057464e-01   -4.168566233200650e-01; -5.889835062818457e-01   -6.741558633525532e-01   -6.958989859674131e-01   -5.142692739522574e-01   -5.882598269748889e-01   -7.521173932804103e-01   -5.153439669073879e-01   -5.145244265452037e-01   -3.985086387672379e-01; -5.413522249280683e-01   -4.526577318382787e-01   -4.988350759723538e-01   -2.266845354217794e-01   -3.614336748981140e-01   -2.441692768554518e-01   -5.345018194189242e-01   -4.892590573208312e-01   -5.787519118177849e-02];
L5_L2_iGABA_netcon = [-3.882580076122824e-01   -4.373995738869442e-01   -8.074796262626310e-01   -4.364775510237222e-01   -5.033483546308973e-01   -4.475639873453388e-01; -4.654759689207112e-01   -3.326979935200243e-01   -6.069935436950823e-01   -5.868004464937155e-01   -5.174892143796836e-01   -4.066522030284146e-01; -4.508336944214558e-01   -2.310407405143116e-01   -5.705434933058614e-01   -4.003594938121831e-01   -8.004018659209806e-01   -3.741550820403733e-01; -1.727142687646281e-01   -4.555047413874791e-01   -1.117533765559160e-01   -3.606035243993447e-01   -1.179218726071502e-01   -2.594834760058274e-01; -4.479950683970519e-01   -3.795091020162327e-01   -2.376297732296262e-01   -2.673870996679645e-01   -6.707939292046106e-01   -2.364467811356046e-01; -2.406878600623120e-01   -2.772426694502573e-01   -2.176900991812885e-01   -5.151669411426633e-01   -3.360353093005780e-01   -6.805520132535355e-01; -3.138340106402732e-01   -4.238958063825527e-01   -5.002108569253779e-01   -1.696607843556863e-01   -1.841677672140695e-01   -9.043248382281438e-02; -5.955284934282367e-01   -2.327338287173891e-01   -9.261153636702732e-02   -3.943779152647061e-01   -2.733481913858800e-01   -4.082156652199896e-01; -4.785589737772098e-01   -7.720759579295053e-01   -6.403031703336002e-01   -1.424688413776494e-01   -3.133723870619889e-01   -3.527318532387976e-01];
L3_L2_iAMPA_netcon = [-4.227956195124797e-01   -6.049142547103374e-01   -1.902704165053167e-01   -8.746699657490151e-01   -4.249825843409209e-01   -2.083950175440258e-02; -3.070104112810372e-01   -6.921526225531605e-01   -4.696464010784355e-01   -4.375430592747114e-01   -5.551457859384130e-01   -3.346647174214806e-01; -5.435210885612671e-01   -4.952180315385057e-01   -3.180219200754112e-01   -6.906051749043364e-01   -4.641658333544265e-01   -5.197103921630037e-01; -4.080598449297722e-01   -5.601812425896168e-01   -5.702196210079752e-01   -3.738023892116802e-01   -1.593143137101378e-01   -4.393094328103708e-01; -4.224538450972163e-01   -4.627731339999901e-01   -4.526768447057098e-01   -4.460510097599453e-01   -2.090872402850657e-01   -3.819312175264989e-01; -6.983662493641610e-01   -1.938696489305949e-01   -4.299763031394406e-01   -2.502691002849357e-01   -4.853716396634732e-01   -3.951783370481483e-01; -4.462207139467305e-01   -2.718436294887392e-01   -7.814238167996622e-01   -2.578690184980360e-01   -5.181535217124349e-01   -6.042950264767678e-01; -3.510529981954355e-01   -5.594424699820337e-01   -4.595826594726108e-01   -3.411383969252518e-01   -3.245953226086010e-01   -2.423363755972269e-01; -7.223456875988922e-01   -3.885524312870107e-01   -5.810576069013227e-01   -1.158148978677450e-01   -4.531505775469099e-01   -6.077177290378376e-01];
L2_L3_iAMPA_netcon = [-4.579290256322831e-01   -3.213813436479742e-01   -4.478187590038180e-01   -4.589768716221057e-01   -5.815154897374002e-01   -6.853182336543553e-01   -4.374668636134289e-01   +1.279340343366513e-01   -2.287576547254816e-01; -6.992751682806270e-02   -6.350752000189167e-01   -3.890167641637165e-01   -4.388977901599151e-01   -2.955115814015315e-01   -5.215287604563397e-01   -3.584024533665157e-01   -3.613147233165095e-01   -5.478085911750133e-01; -6.011256795870455e-02   -5.487416816152942e-01   -5.088256496285376e-01   -3.349728695227557e-01   -4.424882905366656e-01   -6.611349848497313e-01   -3.345559478022599e-01   -2.861033881144198e-01   -4.666890602333861e-01; -2.074962955952956e-01   -5.918897538695509e-01   -4.618346308008973e-01   -4.351074127395096e-01   -3.280673316118793e-01   -4.247306147920875e-01   -6.423512344070598e-01   +3.274656793496782e-02   +6.575505598169115e-02; -3.042113340413991e-01   -6.327188996546396e-01   -5.073707013806185e-01   -2.259592090634754e-01   -4.204280980584918e-01   -3.287319098944608e-01   -3.741022126824330e-01   -3.376335892323830e-01   -6.310490675349086e-01; -1.669219336320887e-01   -1.596888621832151e-01   -1.419776208328439e-01   -4.666566202389472e-01   -3.023845267712327e-01   -5.771391926387780e-01   -8.577474950022590e-01   -2.067904549684014e-01   -6.322259973830657e-01];
L1_L4_iGABA_netcon = [-7.909556269029456e-01   -1.534023702218170e-01   -5.488476925491252e-01   -4.532329269087562e-01   -3.068133447978695e-01   -4.221473116218576e-01   -4.928675526508001e-01   -4.833487853070880e-01   -2.305579563216881e-01; -3.774205072725384e-02   -5.565667195052701e-01   -4.114527212825404e-01   -3.720509848826922e-01   -3.282063727467561e-01   -5.430110519141018e-01   -2.319696699070848e-01   -6.108676549816899e-01   -6.471484541541146e-01; -4.385934076720166e-01   -4.990205042159909e-01   -3.542147238839003e-01   -5.985993022681513e-01   -5.460107155975875e-01   -2.627613124245835e-01   -6.052862702239586e-01   -2.751384318620246e-01   -3.972488470078424e-01; -2.957208945376603e-01   -6.695507177374510e-01   -2.769108962371021e-01   -4.145911785491943e-01   -7.608400771126845e-01   -1.195464040726056e-01   -4.074296550718132e-01   -4.711047217661148e-01   -1.773025081614617e-01; -3.709358863478186e-01   -4.417987396060110e-01   -5.412617715217085e-01   -5.283875268457620e-01   -2.322404820544054e-01   -6.403680874907179e-01   -5.292913964450510e-01   -4.189913237451672e-01   -7.349787819187744e-01; -5.340213838920940e-01   -6.423809553190318e-01   -4.515962493100936e-01   -4.127881035340600e-01   -3.731665390736038e-01   -4.261114935712911e-01   -3.245308676977090e-01   -2.267968905007974e-01   -1.604842063748241e-01; -4.508804498928769e-01   -3.246008839973670e-01   -4.170604411751551e-01   -2.364982286206672e-01   -1.513437962928802e-01   -4.945015996087629e-01   -1.792879265901452e-01   -5.669576125375897e-01   -4.242573180504597e-01; -7.816922032418503e-01   -4.222292717905655e-01   -1.464214061831693e-01   -5.029986896132053e-01   -2.341729967236491e-01   -3.789897066044938e-01   -2.616038890936632e-01   -6.527787471235158e-01   -5.384380829945538e-01; -6.507339924299294e-01   -5.635026099113005e-01   -2.253870960205305e-01   -3.123197089893144e-01   -2.951157083370953e-01   -2.826353044657436e-01   -5.654298909107577e-01   -3.009808221362330e-01   -1.963696631034740e-01; -6.349655932442498e-01   -2.553032557714507e-01   -4.825418944208583e-01   -5.247689714602157e-01   -5.232552303623730e-01   -7.443536085542319e-01   -5.325790012463519e-01   -3.712552135921136e-01   +4.247235940608726e-02; -3.849878952015111e-01   -1.535109894925321e-01   -2.623326278258776e-01   -3.428190742651817e-01   -6.441755105248390e-01   -6.501654131555988e-01   -1.825880934095366e-01   -4.132799117725832e-01   -5.585271911834016e-01; -6.456913914927263e-01   -4.824701638784596e-01   -2.974478299801621e-01   -6.061649802217347e-01   -2.286314409732613e-01   -2.183070229709549e-02   -3.834171157913494e-01   -5.948241591490178e-01   -3.203610051247844e-01];
L4_L1_iGABA_netcon = [-1.155036795264825e-01   -4.505769121017407e-01   -6.590858456967160e-01   -4.899079228430474e-01   -3.129819710908726e-01   -7.199542242508251e-01   -6.197801069470766e-01   -3.841019638329151e-01   -2.299393066100050e-01   -1.773490403282900e-01   -5.028391835643303e-01   -3.116733319753259e-01; -2.358837653644628e-01   -6.668985062410544e-01   -1.169958608355157e-01   -2.300168220670186e-01   -6.612884411901818e-01   -3.372966996089015e-01   -5.457001409886439e-01   -7.673188560592628e-01   -3.100326323256028e-02   -3.385744087111517e-01   -4.622110835480755e-01   -4.926455939154419e-01; -4.044879141232450e-01   -7.668873187649877e-01   -4.874962207712868e-01   -3.133466082395140e-01   -5.475094863487500e-01   -5.632963770400676e-01   -4.853436898695515e-01   -4.234979854655654e-01   -3.617559589419485e-01   -3.547921115524532e-01   -6.052386348965832e-01   -4.271864827569926e-01; -6.102733476998669e-01   -6.976897515803848e-01   -1.955010777782496e-01   -2.463827256921312e-01   -4.746047664980987e-01   -5.085696443282773e-01   -3.227289613263367e-01   -4.377717560551049e-01   -3.459553967495133e-01   -4.178474173934237e-01   -3.437794946139278e-02   -4.853355058149709e-01; -7.069305596421470e-01   -4.320776483179988e-01   -2.498113477915094e-01   -3.572740048194920e-01   -4.246940273065941e-01   -3.847920332498413e-01   -2.116849007544903e-01   -4.597497435822059e-01   -5.372039315761222e-01   -2.978047489287813e-01   -1.099745241471541e-01   -4.714092581796498e-01; -4.676286147632359e-01   -9.161497512328125e-02   -5.490487781170070e-01   -3.904273032664569e-01   -5.153021884754261e-01   -1.341311920476313e-01   -4.569848584487157e-01   -2.637717175087415e-01   -6.473098871204714e-01   -3.754583030907761e-01   -4.538450977478121e-01   -8.624431601026786e-01; -3.737165556602420e-01   -6.075534346567784e-01   -3.911240609703399e-01   -2.537048096345083e-01   -3.991921578661547e-01   -4.890493795276697e-01   -7.237957595283794e-01   -6.460021680466411e-01   -1.689965157232228e-01   -3.004326467179983e-01   -3.186571661668206e-01   -5.473961402980191e-01; -5.656843145017354e-01   -3.121861877601146e-01   -5.089601330436972e-01   -2.212108383427380e-01   -6.117609525041705e-01   -7.157344421889202e-01   -2.583311283478102e-01   -3.780221121769089e-01   -3.189595742850926e-01   -4.096684229482181e-01   -6.964107246261714e-01   -2.673777042581916e-01; -7.370134624145155e-01   -3.819898056995711e-01   -3.288820916669695e-01   -8.047147804592817e-01   -4.753452154272447e-01   -2.823541048942355e-01   -5.259275443258595e-01   -4.965809571014618e-01   -3.204645207279112e-01   -3.908652555060129e-01   -4.248857297176348e-01   -3.233087764270069e-01];
L1_L3_iAMPA_netcon = [-3.554423550579392e-01   -3.225468894156888e-01   -4.762317055639785e-01   -6.555832027931683e-01   -8.042340064343294e-01   -4.921810483031943e-01   -2.597852263620087e-01   -5.004662088312070e-01   -2.446064882162227e-01; -6.094300648500667e-01   -7.463207886714164e-02   -1.429492325907827e-01   -2.089696649743110e-01   -5.524986936812289e-01   -3.938992541476686e-01   -2.695743053031701e-01   -7.304810517083031e-01   -5.556823716727131e-01; -3.903967855756529e-01   -2.387561365341828e-01   -5.602942486486008e-01   -2.212444588770775e-01   -3.679360050673361e-01   -7.514949618227728e-01   +1.522157581987094e-03   -7.830096464414399e-01   -5.437153354235101e-01; -2.056833006501527e-01   -3.771315117669598e-01   -3.236064629235346e-01   -4.883057676440078e-01   -3.751420462963994e-01   -1.531572159346250e-01   -3.608518038733022e-01   -6.318078332847349e-01   -3.487252989111437e-01; -5.439621631429996e-01   -5.032652173646427e-01   -3.769580924768740e-01   -4.749927042275208e-01   -5.158561154807029e-01   -1.565425373110960e-01   -5.744658722793257e-01   -1.291683108374870e-01   -5.886430979544923e-01; -6.252004371045471e-01   -3.814529291411485e-01   -4.852060210607921e-01   -5.065668078411283e-01   -4.737176873184576e-01   -1.710231706264386e-01   -5.459715654575399e-01   -3.936062912804065e-02   -5.470788321259472e-01];
L3_L1_iGABA_netcon = [-5.132243934712625e-01   -4.998117258356138e-01   -4.184244914872715e-01   -7.595619622603872e-01   -1.744879635281894e-01   -8.015167765583425e-01; -4.351634813715362e-01   -1.450277171770382e-01   -3.558906916104254e-01   -5.753750155629239e-01   -5.371973982522675e-01   -8.686674088851112e-01; -2.046910871199673e-01   -5.037513789660576e-01   -1.558497195215839e-01   -2.429261502499762e-01   -3.830195966686153e-01   -3.890942334606514e-01; -5.139788580818923e-01   -2.958883806404710e-01   -6.902749472847924e-01   -6.460865654565801e-01   -2.021013412113905e-01   -5.843695431074380e-01; -6.003251404016975e-01   -5.851670946570917e-01   -8.835802217148947e-01   -2.150256447352560e-01   -3.091989981017330e-01   -3.379733750984124e-01; -2.855712866043840e-01   -6.271191859781722e-01   -3.752034832120947e-01   -1.945554525923748e-02   -2.985265394566939e-01   -1.483573764025138e-01; -2.949101235363082e-01   -2.841088107016907e-01   -3.777527553598298e-01   -4.758225593662783e-01   -1.870773622180039e-01   -2.402717086568073e-01; -2.271208198865383e-01   -5.969242789400221e-01   -6.417368829307928e-01   -3.262392846677063e-01   -6.492849529378167e-01   -4.626970290591332e-01; -5.461882680573752e-01   -6.344650678707124e-01   -6.280863022842308e-01   -1.078511450579291e-01   -7.294020568665422e-01   -5.169851513667773e-01];
L5_Input1_iAMPA_netcon = [-3.961352629143921e-01   -3.166216599455198e-01   -4.912260158306450e-01   -3.148635502802565e-01   -5.035663596664134e-01   -7.404982829222438e-01];
L6_Input2_iAMPA_netcon = [-7.599410068752642e-01   -6.310004769910007e-01   -3.967753261397319e-01];
L5_L6_iAMPA_netcon = [-3.994717943611197e-01   -5.643350688432908e-01   -2.764440172775801e-01   -4.213065082961985e-01   -7.772993251241693e-01   -2.204066400189422e-01; -4.724319320582915e-01   -3.787674372614247e-01   -4.299277231123776e-01   -5.931683184562172e-01   -5.520403256621621e-01   -3.437069030919304e-01; -7.223890530501493e-01   -2.457926547046366e-01   -8.021637152043357e-02   -1.546280197960777e-01   -4.284792602933233e-01   -2.708470236798384e-01];
L4_L5_iAMPA_netcon = [-5.234781315678303e-01   -3.775201394267238e-01   -6.117800095930961e-01   -5.223922081195351e-01   -4.710767428783306e-01   -6.358651776186817e-01   -1.994646812662926e-01   -3.597895338306248e-01   -7.463837544498394e-01   -2.296618439148004e-01   -6.857966075714097e-01   -5.867509816781532e-01; -2.785515093879821e-01   -1.406663247755276e-01   -2.626983986239272e-01   -3.382869161826028e-01   -4.538548110944171e-01   -6.242874819206151e-01   -4.044026874151681e-01   -6.210398767110561e-02   -3.648291776508466e-01   -2.894835616841820e-01   -7.644250526531156e-01   -5.488190042755927e-01; -2.696102013121486e-01   -4.568879215670577e-01   -2.079895005682402e-01   -2.975998953842809e-01   -3.030451009901707e-01   -3.329265917262870e-01   -3.211104531366041e-01   -1.152774064427159e-01   -4.461531883824268e-01   -5.120643027169312e-01   -4.547402721990048e-01   -2.802412311487502e-01; -9.891094927855734e-02   -3.405807973613886e-01   -4.037511907258093e-01   -1.406005105308352e-01   -5.730758619712935e-01   -4.356686319631988e-01   -3.902517333568851e-01   -2.811049491152195e-01   -5.129629014327380e-01   -2.951521957168665e-01   -8.869686795047442e-01   -4.627388793882943e-01; -3.506853772389649e-01   -1.873542907452417e-01   -5.165989306979762e-01   -4.143249822458230e-01   -3.882709425419255e-01   -1.449690480578003e-01   -3.259083632802533e-01   -5.090977466104224e-01   -5.129602868532019e-01   -4.935349507885379e-01   -1.439736477706071e-01   +8.539126264282271e-04; -7.114040628944505e-01   -5.308825201614253e-01   -5.236632847655907e-01   -3.769797208177175e-01   -6.746976503622079e-01   -6.245633986067162e-01   -1.143114717977455e-01   -2.384591886609493e-01   -2.284793351650922e-01   -7.396461369591002e-01   -6.684610878032836e-01   -5.905369504048745e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
