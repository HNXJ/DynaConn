function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.693660572281974e-01   +3.351682004954218e-01   +2.538992449582521e-01   +3.019274603434633e-01   +7.223454284181898e-01   -5.340795525462208e-03   -2.770543898192872e-02   +1.553791630691258e-01   +4.491358193901095e-01; +4.518683355011301e-01   +5.356925658369047e-01   +7.489413501417511e-01   +5.088218230613519e-01   +3.637504536752213e-01   +1.861686701004468e-01   +6.326132680276927e-01   +8.173863101179130e-01   +4.623168760507605e-01; +2.145124508055392e-01   +8.057995547158614e-01   +3.673862299979109e-01   -6.298274258533430e-02   +3.963658639169026e-01   +4.929279586338027e-01   +8.743310919575439e-01   +1.562144672371521e-01   -3.411051692020638e-02; -6.599864402198553e-02   -1.803542766619953e-01   +5.624591947558305e-01   +1.202890605022944e-01   +3.111070808843767e-01   +2.469139665648008e-01   +6.663852850073991e-01   +5.455787192786161e-01   +1.433619268570033e-01; +5.030234544194416e-01   +9.373427094175966e-01   +7.864392836271958e-02   +1.518994396634005e-01   +3.804783094326274e-01   +2.128127751586535e-01   -1.197377957610783e-01   +3.973740680015880e-01   +3.510972891603266e-01; +4.338739126107657e-01   -1.690876397798134e-01   +5.589008912495291e-01   +4.643488501745325e-01   +5.518092745665761e-01   -1.165322801253224e-01   +5.466970317004567e-01   +3.260663760857877e-01   +7.072157088331809e-01; +4.437582439578369e-01   +6.226922591349103e-01   +7.242687779768660e-01   +4.078648128070622e-01   +4.282395967385444e-01   +3.637135103200936e-01   -2.354716968896458e-01   +9.711001664391984e-01   +8.413584363338708e-01; -5.408091301495385e-02   +1.000000000000000e+00   +2.276401542425846e-01   +1.718854357311246e-01   +1.378607551283564e-01   -2.304509506099967e-01   +4.707259898307495e-01   -2.649392395741051e-01   +3.514740173453593e-01; +6.092717246069852e-01   +3.111547886976809e-01   +9.018464536944792e-01   -1.406900731407471e-01   +4.376097138639774e-01   +5.744914846765053e-01   +2.988506735865720e-01   +6.375383340460881e-01   +2.469403131137649e-01];
L1_L2_iAMPA_netcon = [+7.922139758635566e-01   +1.471161298394058e-01   +2.484135252079537e-01   +9.168540058734823e-01   -2.420316445577619e-01   +2.842032037629284e-01   +5.892169903895593e-01   +5.067277694087404e-01   +7.104890931712786e-01; +2.739990491975329e-01   +2.144589095392589e-01   -1.471365966413980e-02   +1.000000000000000e+00   +4.663927807390186e-02   -8.328003104786011e-02   +7.668699790696657e-01   +8.396691427296608e-01   +2.874362467301134e-01; +2.030295401265612e-01   +1.997685947508700e-02   +2.028457970808862e-01   +6.051922539943896e-01   +3.469713427336507e-01   +2.445597516643985e-01   +5.933107570652009e-01   +7.187294651191252e-01   +2.138571525754146e-01; +3.677446382693238e-01   +3.611131701714766e-01   +4.832963057866539e-01   +3.444391228445260e-01   +3.374939919387523e-01   +8.356492733432387e-02   +4.673184931073964e-01   +2.351308244058333e-01   +6.822060609105645e-01; +7.341927050990309e-02   +5.965527414143885e-01   +2.426180699319849e-01   -1.443843827822956e-01   +5.875385401323115e-01   +2.738461886303098e-02   +3.670461824927535e-01   +4.132472414312339e-01   +6.373051693886923e-01; +2.786492893928612e-01   +5.089465013920544e-01   +4.471429419273661e-04   +6.627822113669124e-01   +2.846606874991927e-01   +5.305335366930042e-01   +7.889753526854367e-01   +5.149427231989163e-01   +4.752784403044504e-01; +2.140369898787649e-01   +3.162773525891827e-01   -2.962249717004918e-02   +1.621111722874539e-01   +4.224949536855004e-01   +9.722246794625600e-01   +8.327554253491455e-01   +2.937209059419785e-01   -8.729278366436448e-02; +3.352087282093146e-01   +4.609440495194375e-01   +1.249391071360800e-01   +1.604971688497196e-01   +4.470310820414794e-01   +8.764454506680479e-01   +7.096934196050576e-01   +4.705090126843469e-01   +2.813128488177215e-01; -1.517298917552523e-01   +1.454134729710274e-01   +3.345291526150332e-01   +2.231508141639898e-01   +1.870657408404354e-02   +1.049753157946306e-01   +9.033778698437117e-01   +5.845675076980205e-01   +2.729234990881571e-01];
L2_L5_iAMPA_netcon = [+9.547868329629536e-01   +1.339099395843607e-02   +2.043929844623825e-01   +1.972727862022730e-01   +4.886823389058108e-01   +2.397451019335811e-01   +3.869685220687047e-01   -2.539002903937846e-01   +4.521396772233683e-01; +1.000000000000000e+00   +2.789706295015644e-01   +8.592561022297243e-01   +2.273944643357883e-01   +5.778201917035494e-01   +1.952929500855708e-01   +3.159999568962477e-01   +8.515800415602789e-02   +4.289341812910900e-01; +4.758304805930768e-01   +1.941308626563202e-01   +6.076140704323904e-01   +6.230965156189079e-01   +5.566787104650519e-01   +2.485530752977905e-01   +8.020797647490674e-01   -8.186992812764914e-02   +3.053816725074033e-01; +4.301320945530213e-01   +4.772364370909490e-01   +2.014443449223285e-01   +6.621494620325293e-01   +4.547620463608207e-01   +6.571038037884286e-01   +2.927521792787118e-01   +1.646496704990690e-01   +1.222940241480583e-01; +2.835276988140663e-01   +2.213830398782662e-01   +6.436738731240571e-01   +2.816755066019610e-01   +3.017097435640961e-01   -1.044170514721414e-01   +5.211118510796336e-01   +4.927188200417030e-01   +5.964727249839605e-01; +5.844101274625612e-01   +3.912072715393520e-01   +4.215015933448715e-01   +8.092967111602238e-01   +4.060270309079586e-01   +1.359665185923172e-01   +7.466213058117315e-01   +3.740414386530619e-01   +6.359199505065618e-01];
L5_L2_iGABA_netcon = [+2.449039258968081e-01   +2.152627508621912e-01   +1.000000000000000e+00   +3.350576840117386e-01   +1.877832585068290e-01   +5.803786923637335e-01; +3.090979375580535e-01   +4.515735826491600e-01   +1.686717909063593e-01   +6.075981183199691e-01   +9.225872064178816e-01   +4.441278786650296e-01; +8.494712486344839e-01   +6.139354500466024e-01   +6.144866057783029e-01   +2.165784692589378e-01   +4.572914056828238e-01   +1.172378360064612e-01; +2.252548004340885e-01   +3.036851008736904e-01   +7.556702934371873e-01   +4.122580308972536e-01   +2.827761031372961e-01   +5.422679490929941e-01; +6.345140669296326e-02   -3.169980834664377e-02   -1.697628480691295e-01   +4.524766125028336e-01   +1.982549010736159e-01   +2.991059545920361e-01; +4.638550373682500e-01   +4.441796965544353e-01   +3.700609371015811e-01   +1.328820807649618e-01   +7.738737121598274e-02   +7.369389067025149e-01; +6.847482762794455e-01   -1.903606256770871e-02   +7.001041975478063e-01   +6.128864300401838e-01   -1.616376022426696e-01   +7.503230429807050e-01; +8.836204315189092e-01   +3.752049505381912e-01   +4.380579185985375e-01   +6.369033375762337e-01   -1.333248065472439e-01   +7.290096587198092e-01; +8.964655297923318e-01   +5.896018997102438e-01   -1.325786215537949e-01   -9.132662099277850e-03   +4.617929376226639e-01   +5.183787409093933e-01];
L3_L2_iAMPA_netcon = [+5.546241973810673e-01   +7.478629183104241e-01   +2.621288053970007e-01   +1.619344671887023e-01   +3.707091499790345e-01   +8.005267095910418e-02; +1.369973465714490e-01   +3.741958425800846e-01   +1.140761768689938e-01   +4.860559370405983e-01   +2.126472385486796e-01   +2.758548758005036e-01; +2.133873184479427e-01   +2.336205621624509e-01   +9.413994535444691e-01   +5.093799876486144e-01   +2.405564832784917e-01   +1.000000000000000e+00; +2.575420632349692e-01   +6.579864165623475e-01   -1.724046374872537e-01   +7.748345799267345e-01   +8.356854515771380e-01   -2.109795333575036e-02; +4.873800834659476e-01   +4.811082418253126e-01   +4.515463630686856e-01   -1.678098278954114e-01   +8.012918148272331e-02   +6.077090659654715e-01; +3.621617403573174e-01   +5.743638652287405e-01   +7.389681065839333e-01   +6.919931193619813e-01   +4.848149639244621e-01   +5.282820433590538e-01; +5.315591762313627e-01   +5.943969842345651e-01   +2.222592215635532e-01   +2.958464843088813e-01   +1.191027361164233e-01   -1.242894470234298e-01; -5.705052889566120e-02   +6.072332708201071e-01   +5.701536710924268e-01   +1.047952659565740e-01   +4.454803639448315e-01   +5.245159660214019e-01; +5.100778761008268e-01   +3.580243762460053e-02   +7.403832709382855e-01   +1.510229025427726e-01   +4.701948454629156e-01   +8.669059318569908e-01];
L2_L3_iGABA_netcon = [+5.154716363592194e-01   +1.821296247500399e-01   +9.513726141475315e-02   +6.611530609964789e-01   +2.001905328203746e-01   +4.660232171449312e-01   +1.553743633563537e-01   +2.410871699087729e-01   +4.123946932842268e-01; +6.322063360913326e-01   +3.125176751688570e-01   +4.425971962881186e-01   +3.178206778107969e-01   +1.678274107961606e-01   +3.938658512771673e-01   +2.181450271259020e-01   +9.195169871980036e-01   +2.317364460057341e-01; -1.256926675150330e-02   +4.705017603670072e-01   +4.910139081178849e-02   +4.549433575108930e-01   +1.018679957538656e-01   +2.963498857470601e-01   -2.955232578672778e-03   +6.233627612881654e-03   +1.217848369660262e-01; +7.859657599828039e-01   +9.413154206293284e-01   +2.153698128809529e-01   +3.030646514598171e-01   +4.498541898064802e-01   +1.805250419428716e-01   +9.093674020125132e-01   -2.863020124422051e-01   +3.398019817632710e-01; +3.342382932833202e-01   +5.557172405294215e-01   +5.271275387807947e-01   -7.749636469740973e-02   +5.345997863802335e-01   +3.539857866016952e-01   +3.492672024844926e-01   +2.274961417786360e-01   +9.895330986061112e-01; +1.201876543499020e-01   +3.133467076182256e-01   +7.318755763548171e-01   +4.715945471588749e-01   +1.069228964425522e-01   +3.973415390675177e-01   +3.964384029937920e-01   +2.680292372225427e-01   +2.146548560395330e-01];
L1_L4_iGABA_netcon = [+1.807051080890504e-01   +5.970775493845830e-01   +6.611716332379094e-01   +2.228849788648360e-02   +9.966843285451926e-02   +3.506788667896855e-01   +3.233547394757118e-01   +2.474831957424012e-01   -2.000609775678525e-01; +3.119261737811984e-01   +5.025349605568419e-01   +3.782277796488765e-01   +7.291859835638902e-01   +9.032131881128383e-02   +3.671319729858219e-01   +6.359176999012319e-01   +2.633217438520291e-01   -5.615280995979965e-03; -1.606202091251809e-01   -1.585950927516816e-01   +3.989863597238390e-01   +5.205524721811768e-01   +1.932949759798794e-01   +3.706343291842577e-01   +6.849117818107280e-01   +3.873754311688682e-01   +3.955175281909827e-01; +5.180159701534084e-01   +4.236615836532888e-01   +6.505551831179347e-01   +5.485872752776629e-01   +5.772083070960082e-01   -1.645433749005486e-01   +7.677779165973913e-01   +9.351484692927664e-01   +2.281637765694315e-01; +8.230754952713644e-01   +6.623040801760956e-02   +6.321964768112617e-01   +3.600242291283934e-01   +4.142911353160236e-01   +6.617058300380573e-01   +5.881619190525074e-01   +6.240641534472524e-01   +5.299037087841025e-01; +9.330322232560176e-01   -6.010185497558851e-02   +7.297353685713887e-01   -8.405873054082016e-02   +6.648331608391729e-02   +5.708833000939713e-01   +2.075259461548286e-01   +2.318122098964159e-01   +4.477601380145086e-02; +9.815006162167771e-01   +4.361938436760365e-01   +8.193050813207745e-01   +9.065738602583217e-01   +3.992891734170562e-01   +6.517370324529458e-01   +6.290527937301812e-02   -1.817868657571909e-01   +4.373058079990910e-01; +1.777415562764581e-01   +3.587750061348567e-01   +2.827855020991477e-03   +3.748647419177496e-01   +4.153557031462268e-01   +1.193294564225060e-01   +2.879281767813897e-01   +4.957040882293676e-01   -1.260742789810229e-01; +6.638844032258979e-01   +5.422686190215986e-01   -9.683144937232741e-02   +8.054004502559635e-01   +7.885423872783854e-01   +8.068804898356025e-01   +4.805165091450697e-01   +7.052933586252347e-01   +6.832235222914889e-01; +1.898200242867475e-01   +8.080363425827634e-01   +8.259530108056635e-01   +6.118069569778727e-01   -2.283394137438804e-01   +5.649471191485284e-02   +1.233579269598068e-01   +5.533185318409901e-01   +1.083801829200332e-02; +8.578981720110964e-01   +4.300903512874147e-01   +4.972379734947371e-01   +9.078626000729687e-02   +6.807605494985172e-01   +6.406018277215099e-01   +6.997058850247979e-01   +1.111964858656669e-01   +4.412590468789820e-01; +7.691628632652900e-01   +7.900541633020639e-01   +1.288245009051680e-01   -1.345260107050985e-01   +7.657342883855567e-01   +9.123610493617816e-01   +1.817562516963742e-02   +4.300593820924281e-02   +4.674225361954171e-01];
L4_L1_iGABA_netcon = [+5.742238728847933e-04   +5.564779619610694e-01   +2.864246156558318e-01   +1.716122647304065e-01   +3.385771929402629e-01   -8.738673141637485e-02   +1.371340425889845e-01   +1.465558342847710e-01   +4.279179180447463e-01   +3.323059651546281e-01   -2.377885250247845e-02   +8.159228007536002e-01; +4.534815002358791e-01   +3.591057992975515e-01   +3.637295654639550e-02   +5.252302752754886e-01   +4.174174995820372e-01   +6.706574676573847e-01   +5.469782853660214e-01   +4.136790990587403e-01   +4.756068107898287e-02   -6.704105167581206e-02   +6.677884405281000e-01   +2.191808065952262e-01; +2.519602393925084e-01   +3.198566694623471e-01   +4.385992899098981e-01   -6.287124238157744e-02   +4.961273340622889e-01   +6.494320135999551e-01   +5.440145356427288e-01   +7.940337909242747e-01   +2.590815356187586e-01   +5.543686561495325e-01   +6.848227254174176e-01   +4.132543306733207e-01; +7.672942146093548e-01   +2.665450248039132e-01   +7.224568308799537e-01   +7.165717624151380e-01   +4.956362896486943e-01   +6.475823532905095e-01   +7.763694033272066e-01   +2.176204641292188e-01   +3.274244955997744e-01   +3.448297852205038e-01   +8.386511908447931e-01   +5.387130504863313e-02; +3.165669048394656e-01   +1.669022682460085e-01   +1.941573232204330e-01   +4.701257418954347e-01   +2.842446621038951e-01   +2.859830939099168e-01   +1.000000000000000e+00   +4.217246186330209e-01   +5.942139455736591e-01   +3.507033212787195e-01   +1.681478602063589e-01   +6.972721592640730e-01; +7.484546955578424e-01   +1.974452600051840e-01   +5.111795004479303e-01   +3.483197645229657e-01   +9.636725993391586e-01   -3.174555385183957e-02   +8.608140333802042e-01   +2.134787546414942e-01   +1.127119103252126e-01   +2.543080565467147e-01   +7.953255673512599e-01   +3.511179955987918e-01; +6.216669392294590e-01   +6.687644501505637e-01   +3.452756792980158e-01   +4.988797915479145e-01   +6.192115636735767e-01   +3.955021608066718e-01   +7.825538014394602e-01   +6.580988365142960e-01   -3.323731437459265e-02   +8.332603404682803e-01   +4.507571262822024e-01   -2.948323404881253e-02; +2.617918117832650e-01   +5.478863489532642e-01   +4.071580343467395e-01   +1.251220372568372e-01   +3.197481513693843e-01   +3.919062332588755e-01   +2.945146329237249e-01   -2.618263882140675e-01   +3.728054522084137e-01   +2.417761988145470e-01   +4.908930664096330e-01   +3.441837707939998e-01; +3.667904468004592e-01   +3.047988279687261e-01   +8.337757749409070e-01   +9.364233394712164e-01   +8.114831422362636e-01   +6.195638269454823e-01   +7.049867934426849e-01   +6.577312652876375e-01   +9.678762651007651e-02   +5.185787462070126e-02   +5.341162686291459e-01   -1.493433712209570e-01];
L1_L3_iAMPA_netcon = [+1.538047032685829e-01   +2.113313002685390e-01   +3.439749295584669e-01   -1.511587180966056e-03   +7.946391469112860e-01   +4.374758372927515e-01   -3.185751555363892e-01   +3.321914323070090e-01   +1.589703624255780e-01; +5.457754580266949e-01   +7.171960358574461e-01   +9.367069852242031e-01   +4.852775612082508e-01   +7.794301365451571e-01   +4.952961112333031e-02   +9.903589273277390e-01   +6.705247354532301e-01   +4.116462607357220e-01; +8.119339659127617e-01   +3.376001109588608e-01   +3.466120447450889e-01   +6.045121351075184e-01   +6.041391279875644e-01   +5.461376587142532e-01   +2.720565493793055e-01   -1.718130783078881e-01   +2.964789668759482e-01; +2.230090445664552e-01   -9.225921978101150e-02   +2.798511100989579e-01   +8.892414919923963e-01   +1.426657715211261e-01   +7.427136417539340e-01   +6.113857611804236e-01   +7.217318462377902e-01   +6.204503937866002e-01; +1.363396482166364e-01   +3.176151400350494e-01   +3.369090946320691e-01   +4.232857769219446e-01   +6.691614179119494e-01   +3.743896736615308e-01   +7.604324874854771e-01   +3.851936945412405e-01   +3.343112839488910e-01; +9.885878011021870e-02   +4.226601942527426e-01   +3.741472974578565e-01   +4.625624324622493e-01   +9.831165843679499e-02   +3.072679458829962e-01   +2.280369647485652e-01   +7.634337990053235e-01   +8.816620234640831e-01];
L3_L1_iGABA_netcon = [+1.973395458219839e-01   +6.536374690393377e-01   -1.086598228303487e-01   +1.233078267880532e-01   +1.510073237741309e-01   -1.825794702353447e-01; +1.535841342048123e-01   +2.902869423393516e-01   +4.151739992425283e-01   +1.583188360294846e-01   +8.034235145602984e-01   +7.995619743156586e-01; +1.299601875577956e-01   +1.606966047123129e-02   +2.676836737863475e-02   +6.380542981916250e-01   +1.352300025388509e-02   +6.801476243200141e-01; +1.060970325332576e-01   -1.939617524237806e-01   +3.197500530214194e-01   +3.709959267318747e-01   +8.240481261818672e-01   +6.831597813609176e-01; +8.012038181719816e-01   +7.418725828229378e-01   +2.714382832529166e-01   +6.131643939942597e-01   +2.995247995063163e-01   -5.009249671646733e-02; +2.898147088107836e-02   +7.082501405028997e-01   +4.927862483750260e-01   +1.524039752683050e-01   -1.743818607434457e-01   -2.318686202825465e-02; +4.445300989434494e-01   +5.645187872721288e-01   +5.304337899919985e-01   +1.000072088643041e-01   +5.025819288571070e-01   +6.860284784587762e-01; +5.100829159118300e-01   +5.562676786180912e-01   +6.495361399164468e-01   +5.599073055873728e-01   +7.374678851779370e-01   +7.850051460123195e-01; +5.228237061774884e-01   +8.036169161293842e-01   +1.601161536772520e-01   +4.176888758616470e-01   +3.818354914661914e-01   +7.186208438422873e-01];
L5_Input1_iAMPA_netcon = [+4.567018204447325e-01   +5.821711232509733e-02   +8.564082343658558e-01   +2.138090571104797e-01   +4.681990710446184e-01   +4.490633526796416e-01];
L6_Input2_iAMPA_netcon = [+6.130694459548449e-01   +3.427221355176085e-01   +9.118100759504012e-01   +1.939123828388362e-01   +7.939376789433821e-01   +6.121346456645022e-01];
L5_L6_iAMPA_netcon = [+3.752588806124761e-01   +5.610118417774741e-01   +2.076852848880026e-01   +3.529379832438327e-01   +4.775534495673529e-01   +9.234405320195659e-02; +3.823134860356173e-01   +4.595448901918303e-01   +8.507542028412498e-01   +3.241785991845105e-01   +3.289475187977637e-01   +1.753155703670187e-01; +6.588563106811114e-01   +1.848224921125534e-01   +2.598272029572366e-01   +9.804150621754443e-02   +5.311234907808545e-01   +2.393580874788161e-01; +2.730494982804266e-01   +5.571503531615152e-01   +5.004830548319210e-01   -1.356376384268225e-01   +2.905963873298792e-01   +3.197643699167175e-01; +3.119322268237318e-01   -5.385100712802861e-02   +1.569183448165395e-01   +1.219939300395242e-01   +5.343987895230626e-01   +8.511339768100115e-02; +8.119440467739680e-01   +2.472806747728428e-01   +8.483696043681578e-01   +3.757046849764872e-01   +6.376850508374308e-01   +5.795082401282476e-01];
L4_L5_iAMPA_netcon = [+6.302881871943712e-01   +5.358602013018490e-01   +3.443125755897452e-01   +7.404600155445465e-01   +2.775071452617222e-01   +4.487971920011297e-01   +4.389914693560424e-01   +9.128493631419388e-01   +4.321357657480041e-01   +7.782979356798082e-02   +4.373143880804183e-01   +1.778006895492197e-02; -2.207696471369873e-02   +5.950125130587658e-01   +7.113356669134929e-01   +8.239508565588523e-01   +5.503786598026493e-01   +3.108641797017900e-01   +3.573527319670449e-01   +3.369132499576926e-01   +6.118738336492283e-01   +6.810197924138315e-01   +8.363276718482483e-01   +1.821808031472391e-01; +7.289752215000338e-01   -8.973416831623239e-02   +6.019647989611115e-01   +6.333257428287854e-02   +3.450585286548716e-01   +8.971577340113502e-01   +3.371950169368890e-02   +7.920466000133062e-01   +7.100725737828951e-01   +8.734728119044428e-01   +5.711339013972482e-01   +8.712613649903159e-01; +1.000000000000000e+00   +4.936776568512231e-01   -2.389919845612610e-01   +7.643565683073034e-01   +5.792443065022976e-01   +2.606882159446055e-01   +7.547030911144527e-02   +3.123076901084526e-01   -7.153985157755843e-02   +3.333671169222649e-01   +3.376983136579904e-01   +4.350507676678125e-01; -2.352338079221861e-02   +3.915969615371995e-01   -1.412020745801566e-01   +4.002391588282057e-01   +2.956291190772781e-01   +2.409145010283597e-01   +3.627634262614908e-01   +2.162882273367600e-01   +1.849990146622959e-01   -1.546346737128394e-01   +5.602243727885048e-01   +2.995845559049216e-01; +7.662852316195211e-01   +2.190974356484515e-01   +2.330437386735668e-01   +3.392034710090101e-02   +4.988360809551863e-01   +1.754432478226369e-01   -8.332626601711343e-02   +2.994743522132821e-01   +5.617459835257180e-01   +3.493143052188648e-01   -4.801667861450892e-02   +7.381829587534501e-01];
L6_L4_iAMPA_netcon = [+6.212602178387625e-01   +6.082788195746215e-01   +3.637132029513420e-01   +2.827036135594994e-01   +7.098338338941985e-01   +4.164981318391793e-01; -1.677158489495772e-01   +6.774045647240516e-02   +7.864793756223035e-01   +2.072623013225844e-01   +4.146289003943979e-01   +4.792406950432460e-04; +3.644565626191563e-01   +9.149718542693275e-01   +3.229712940511179e-01   +4.995372826892996e-01   +3.875753100676244e-01   +8.213647856271780e-01; +4.812915928139587e-01   +2.890222428049960e-01   -2.393809348732442e-01   -1.940599687704480e-01   -1.936158957393345e-01   +4.270046713541994e-01; +7.645690761724671e-01   +2.544308836090043e-01   +6.462983587262804e-01   +3.088095865085467e-01   +8.802884376873307e-01   +9.297769890383883e-02; -2.013559200289929e-01   +9.087297191425526e-01   +8.209735590277538e-01   +7.311359125440171e-01   +5.032950661171951e-01   +4.016626147308684e-01; -2.568991773285654e-01   +3.966120105706375e-01   +6.570861039995476e-01   +2.802469003867318e-02   +3.023096957521227e-02   +7.062523034683348e-01; +5.850979484900501e-02   +3.289930283526298e-01   +2.850185183498580e-01   +8.314775393860155e-01   +6.113916409647695e-01   +4.840886654813673e-02; +2.899479029701321e-01   +1.298909703415983e-01   +3.589341395094883e-01   -1.133158912268640e-01   -2.434160340794301e-02   -4.416222818791442e-02; +6.763198522573176e-01   -6.288076234730819e-02   +2.591538489645442e-01   +3.846719696986017e-01   +5.367184327343215e-01   +7.590209602086694e-01; +1.000000000000000e+00   +5.303432418843779e-01   +4.635738410359748e-01   +2.406667204128712e-01   -2.645382950605364e-03   +1.783599995625770e-01; +2.878475609859303e-01   +3.335708493611459e-01   +9.743836920645986e-01   +5.661388064280495e-01   +3.524120805350051e-01   -2.273875280026126e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
