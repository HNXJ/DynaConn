function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+9.817753014568904e-01   -7.307414957596396e-01   -5.234864705347237e-01   +2.090522679458595e-01   -9.739752521848378e-01   +5.225924858435367e-01   -3.831883789754582e-01   +2.957445327107555e-01   -8.687664968039608e-01; +7.063422881446858e-01   +1.145859913109453e-01   -5.338922718068024e-01   -4.889759858195737e-01   -2.967345278421472e-02   -9.137436503672448e-01   +3.564123880478127e-01   -4.700228786017579e-01   -8.982131376336350e-01; +8.736002646625516e-01   -2.718415065401241e-01   +1.283489828540718e-02   +1.991013836071606e-01   -2.188557197127831e-01   +9.001050811464154e-01   -8.668944446849818e-02   +6.660865409215850e-01   -2.464145656866595e-01; -3.229216915092056e-01   -1.422548061406479e-02   +6.985131501267446e-01   -1.338654399414911e-01   -8.327701664220855e-02   +7.539444099851882e-01   +6.762226481585987e-01   -9.444182478838347e-01   +9.160178659179252e-02; -8.168011376663841e-01   -1.035790214031517e-03   +6.433559305751617e-01   -4.869592974360700e-01   -7.683977311068355e-01   -3.563622164136844e-01   -5.510821210451681e-01   +6.831534177015618e-01   +4.763988689724067e-01; +9.143254386593412e-01   +3.168529863852158e-01   -1.902057156061739e-01   -3.653159437928240e-01   +9.765915643167535e-01   -1.000000000000000e+00   -4.844945489425226e-01   +6.587239620361568e-01   -2.817468535861455e-01; -5.119704715235407e-01   -8.384050793745196e-01   +5.682999838285239e-01   -7.968102004219721e-01   -3.842878108877013e-01   +6.149852958422675e-01   +6.508780974705245e-01   +3.043990715244675e-01   +9.297432531019326e-01; +2.101775417400867e-01   -4.009497850136263e-01   +1.424239614984449e-01   +4.086854920810045e-01   -3.084884256400723e-01   +4.267395506307747e-01   +2.001386218686589e-01   +8.802173935429326e-02   -5.825838419341737e-02; -6.846208070949693e-01   -9.310190141421839e-01   +5.468482000306514e-01   +6.301952069065238e-01   +2.885376214319755e-01   +9.643413606623821e-01   +3.280306024517535e-01   -2.960425558692991e-01   -1.450856966614407e-01];
L1_L2_iAMPA_netcon = [-7.537004765251256e-01   +3.843175216091049e-01   +9.679448157003387e-01   +2.600209756913783e-01   +2.513424270413401e-01   -4.601536348319404e-02   -7.023367040366266e-01   +4.077901342776191e-01   +7.863812392482273e-01; +7.930695190387913e-01   -2.157041689984170e-01   -2.756988763791156e-01   +2.558155660648499e-01   -8.895508933259947e-01   +5.572042117405933e-01   +4.400513591427282e-01   +6.322961174455409e-01   -3.643171842577078e-02; -8.631941845174929e-01   -8.866212371717257e-01   -1.493920666979705e-01   -2.864474738349060e-01   +9.190351378505968e-01   +1.929191779784335e-01   +7.532619706662081e-01   +6.358060298466119e-01   +8.037370955626457e-01; +6.706808919886953e-01   +9.544478653166281e-01   -8.741495104106233e-01   -9.208642834772180e-01   -6.078068823908990e-01   +1.492370602585815e-01   -8.062862374601983e-01   +1.000000000000000e+00   -2.201810244580592e-01; +8.002438933311339e-02   +8.492474239651777e-01   +5.581369928227958e-01   +1.422936119584761e-01   +9.840254707809729e-01   -4.844995503667502e-01   +1.674770302366942e-01   +8.195118199100346e-01   -5.759881054188838e-01; -1.195030897838506e-01   +2.985358767617830e-01   -6.735303959761340e-01   +6.626198764874388e-01   -7.035528726229091e-02   -4.664252724227353e-01   +5.598062924815682e-02   -6.298372136994296e-01   -6.929471735156273e-01; +6.321926863500921e-01   -3.996840684629626e-01   -2.546293276198914e-01   +2.572434746774848e-01   -4.706414383559864e-01   +8.750436920307452e-01   -5.079971379785549e-01   +6.538373560546131e-01   -7.699490353515559e-01; -6.077571488091269e-01   -8.172069442227571e-01   +2.320806560170973e-01   +6.608648568407764e-01   +7.743610228262267e-01   -6.670639400480377e-01   +6.299409183647967e-01   +8.779613813130681e-01   -6.706378692661054e-01; +2.047697723051195e-01   -6.479446813698039e-01   +5.944513405198776e-01   +9.436207193594253e-01   +7.330387089614908e-02   -9.312063729862157e-01   +8.904949623190732e-01   +8.214833646337167e-01   +5.913365584027332e-01];
L2_L5_iAMPA_netcon = [+8.545031658912936e-01   -9.287467390148160e-01   +4.042577528597467e-01   -1.090815846204395e-01   -3.155439616717388e-02   +7.595769699937626e-01   -7.836708785043593e-01   +4.455756227851954e-01   +4.746468772415451e-01; -2.196929772988769e-02   +2.894864638058198e-01   -9.715199843835446e-01   -2.668028610983577e-01   -4.996724157849181e-01   -2.998793436836968e-01   +8.911631489025035e-01   +2.960531350709376e-01   -7.023630652426592e-01; +8.366443700560920e-01   +6.296376616362820e-01   -3.848310777754947e-01   +3.555429975826253e-01   +9.519997957310191e-01   +7.100981965212630e-01   +8.609859447042854e-01   +6.581308200812217e-01   -9.454182421286118e-01; -9.677406750295314e-01   +3.023781445163724e-02   -4.555889837998566e-01   -7.115200494658915e-01   -2.494489279957220e-01   -7.623463268064853e-01   +8.421530798880109e-01   -4.245822445258944e-01   -7.867535209029161e-01; -9.356778560237989e-01   +3.999325656620000e-01   +3.408249636717963e-01   +9.445624441716973e-01   +9.487430331597149e-02   -3.251550531415350e-01   -4.371192525553749e-01   +3.325727040856647e-01   +8.553547375841417e-01; +7.532082507119466e-01   -7.289203447717998e-01   +3.363829235106107e-01   +9.505444110921160e-01   +1.000000000000000e+00   -4.619036178562276e-02   -1.871880166228174e-01   +3.040400307775838e-01   -3.027555710279120e-01];
L5_L2_iGABA_netcon = [-3.137305293709922e-01   -2.093492140580481e-01   -2.080557585240253e-01   +1.018066903700541e-01   +5.261514526102312e-01   +6.547247837491289e-01; -7.828810701401923e-01   -6.183246817493949e-01   +5.426033318018707e-01   -3.196457649540346e-01   +3.862690096437761e-01   -7.389535276705396e-01; -8.093724761211161e-01   +7.993158920130070e-01   +1.206161569792323e-01   +3.968525147837269e-01   -2.834423895753285e-01   +3.639735370899903e-01; +7.646171232467833e-01   +5.520704442212586e-01   -3.428134911144642e-01   +8.087878375686666e-01   -4.831327911639240e-01   +5.959165206607051e-01; -6.616132684126820e-01   +5.470722132066885e-01   -3.720215002338140e-01   -6.697099657607635e-01   -7.949450720413553e-01   +2.333009852209944e-01; +5.661876913086964e-01   -2.918931907910966e-01   -3.440694325139835e-01   +7.540726562736398e-01   -4.997868847495885e-02   -2.370464679180722e-01; -4.782699756653255e-01   -1.000000000000000e+00   -4.574877515832315e-01   +4.195524789179250e-01   +5.593138351077777e-01   +4.098862724745854e-01; +5.626473565325201e-01   -9.573804547100613e-01   -7.128076322844280e-01   +7.630580316037415e-01   -3.886922631977773e-01   -6.566532490462785e-01; +2.711219401053191e-01   -4.067121052279388e-01   -7.106963014986802e-01   -7.500802950105991e-01   +7.492327207353796e-01   +8.119842596317272e-01];
L3_L2_iAMPA_netcon = [-9.686409103327167e-01   -3.186691728572850e-01   -7.645783566203586e-01   -1.000000000000000e+00   +6.035363027213821e-02   +6.520589400246939e-01; -3.375634042275921e-01   +7.814250384666829e-01   +4.250452992521500e-01   +2.947194955937632e-01   +2.670604857777856e-01   +6.268247945499412e-01; -3.727423986072306e-01   +7.495642073456538e-01   +5.578552757825661e-01   -8.707034187743734e-01   +9.432975707663280e-01   +9.325969271078377e-01; -4.123627539487519e-01   +9.964532993155493e-01   +5.267865622301668e-01   +3.344015744278325e-01   -2.040634295863206e-02   +5.052177983915053e-01; +2.761393851462302e-01   -9.964050554764700e-01   +4.357905792151091e-01   +7.345609698895800e-03   +7.399830914348963e-01   -4.717691497698373e-01; -7.478795463212602e-01   -3.393953886891361e-01   -3.256891478332309e-01   +1.584267738958906e-01   +3.479740069726840e-01   -5.927414366096834e-01; -9.043258715322638e-01   +8.748349989914191e-01   +6.574239687631387e-01   -6.377269956667189e-01   -2.215368295995124e-01   -4.094140344486479e-01; +7.646821652377274e-01   -2.095935790190187e-01   +8.911486928559539e-01   -5.296588113453801e-01   -8.909672408533580e-01   -1.688977417299288e-01; -3.289454828032731e-02   +6.944420482361000e-01   +6.309141532682209e-01   -3.068560642832676e-01   +8.720855763145422e-01   -8.590154890113829e-01];
L2_L3_iGABA_netcon = [-9.088633766908053e-01   -8.394072404375140e-01   -9.225149292673146e-01   -4.021329793989125e-03   +6.167781902467872e-01   -9.728688265981302e-01   -8.245994796150603e-01   -8.351528516717217e-01   +4.133295468914269e-02; -5.237860188927048e-01   +1.623750298810047e-01   +9.784965984515624e-01   -7.395476321282373e-01   -8.971809899942194e-02   +4.949859201652924e-01   +7.632778730492438e-01   +5.313288801818563e-01   +5.649129246741383e-01; -5.972669483603572e-01   -3.224083060836848e-01   -6.491142975860289e-01   +9.318120313818041e-01   -2.435723713124816e-01   +5.545039023619907e-01   -1.210612904483541e-01   -3.348962242674707e-01   -8.446552266526146e-01; -7.341850322405531e-01   -2.384760414949240e-01   +7.691166110048050e-01   -7.614111925257352e-01   -2.095808699471702e-01   -1.186497136239619e-01   -1.265518463487834e-01   -9.719327892207564e-01   -2.014687683846011e-01; +5.020874345306660e-01   +5.113747033203833e-01   -2.738155116228473e-01   +1.295721841298368e-01   -1.934089826903104e-01   +7.284181460877186e-01   -3.853664805415287e-02   +6.884277901131327e-01   +2.075282947818595e-01; -4.079947944240086e-01   -8.156912059031796e-01   -3.495709554446542e-01   -8.885759732445400e-01   +5.236875229323924e-02   -7.394695123954621e-01   +1.000000000000000e+00   +1.685494343335593e-01   +9.859171685802356e-01];
L1_L4_iGABA_netcon = [-6.044950988607306e-01   +9.309773453717106e-01   -5.104421502120297e-01   +7.057044777548157e-01   -3.514254841872952e-01   -9.504884529741223e-01   +5.693718816493577e-01   -6.333164098788907e-01   -6.491999199662979e-01; -3.508279454329096e-01   -7.706074436395240e-01   +3.242889254703239e-01   +6.456996034678198e-01   +9.606844438796993e-01   +7.461571026635263e-01   -5.474514973326745e-01   -1.571850881536453e-01   -9.117897922203779e-01; +3.004211347583471e-01   +5.602062297190394e-01   -4.632697281049852e-01   +7.947419148014669e-01   +2.081398671418008e-01   -1.000000000000000e+00   +6.609645512820365e-01   +4.432809529590217e-01   +5.417289039301683e-01; -6.095775446271396e-01   -7.694315714266836e-01   +3.593331100868425e-01   +2.762003269831974e-01   -3.796929568832546e-01   +1.165345842928679e-02   +5.505161107234280e-01   +1.128434776158938e-02   -8.273017239331814e-01; -1.697157646745793e-01   -6.493763183637127e-01   -3.119173313764849e-02   +5.387278805653583e-01   +3.550276942751550e-03   +6.003140560115204e-01   -6.183455856925438e-01   -2.068335853261977e-01   -1.390241623445957e-02; +6.067105088990851e-02   -4.002682058342527e-01   +6.538254593970017e-01   -6.280507306455678e-01   +1.791932933851315e-01   +5.831338520080698e-01   -7.825926545245070e-01   -3.499061206035606e-01   +1.009854316174638e-01; -2.508030499578484e-01   -2.466353537495565e-01   +1.706855155544814e-01   +8.579330255487128e-01   +4.390777541303800e-01   +3.507385230544030e-01   +2.114305071643889e-01   -3.799959292049000e-01   -8.728487480126940e-01; -8.090717636859612e-01   -8.087239349961685e-01   -4.982983834698596e-01   -9.109051840073726e-01   +4.355552818247928e-02   -2.075934894999923e-01   -2.132683262251699e-01   -2.553299255253256e-01   -2.790734772934402e-01; -1.581653691725947e-01   -7.264051344330349e-02   -1.343498670623205e-02   -9.546676756232596e-01   +3.589367027112192e-01   +1.043444986560477e-01   +6.158228746324957e-01   -4.514646058151118e-01   +9.511956245517137e-01; -8.158178210055667e-01   -7.364945965846239e-01   -2.005018104342679e-01   +8.686762769808173e-01   -3.963892985638265e-01   -5.147771264038312e-01   +9.121482441667379e-01   -4.086100020468506e-01   +6.664890871134291e-01; -6.458057613199962e-01   +5.654548366930912e-02   -8.399774108335308e-01   -8.567030101484666e-01   +3.863009463673951e-02   -9.934953522258985e-01   -5.651885113398646e-01   +9.788598457269895e-01   +1.040691802256345e-01; -5.476401615742990e-03   +2.879464135387422e-01   +8.013511278282492e-01   +9.611513265470915e-01   +9.852068772829187e-01   +3.122941529518061e-01   +9.356096229215048e-01   +7.967379509154993e-01   +1.940201504072983e-01];
L4_L1_iGABA_netcon = [-8.628991695272625e-01   -1.452655430282566e-01   -1.701559727666306e-02   +4.016363357897141e-01   +2.046471378343589e-02   +2.055129734179980e-01   -8.647069103896600e-02   -1.219882893005554e-01   -1.998756607833991e-01   +7.991755967278388e-01   -4.086937189078506e-01   -6.508223086631129e-01; +2.259949051375560e-01   +9.616092645072432e-01   -4.439193910648773e-01   +7.816883080868321e-02   -7.187840543229521e-01   -5.259684420003828e-01   -5.004375807277555e-01   +8.111142431231078e-01   -9.926630372759058e-01   +6.427392534446150e-01   +6.764791884918949e-01   -6.555415741945134e-01; +2.982203044447951e-01   +1.389628024211161e-01   +6.855248282822185e-01   -6.903894317559096e-01   +7.956380236297437e-01   -5.270149812661032e-01   -9.115921822859840e-01   +2.550416193407208e-01   -6.630855796411996e-01   +5.907999728485936e-02   +9.787077075522814e-01   -4.191795343707937e-01; +7.723000256648460e-01   -4.286840380227828e-01   -6.663804272151768e-01   +1.431816917497487e-01   +5.809045040093116e-01   -7.217704801476389e-01   +4.845674094541022e-01   -2.740517172461731e-01   -9.956758846593867e-01   +9.967148200377596e-01   +9.891551176414451e-01   -3.701678517421039e-01; +9.986411337417574e-01   -6.603649806608172e-01   +4.919666988910218e-01   +3.049411145412845e-02   -8.294664792999344e-01   +3.152667902556825e-01   -4.070689268205951e-01   -4.689214514435747e-01   -9.397331673904175e-01   +9.955530841215539e-02   -4.463912322966169e-01   +6.540211324970472e-01; -9.225861978881215e-01   -4.275895881869460e-01   +1.358532477039653e-01   -7.325805389904918e-01   -2.814427004617222e-01   -5.355213782226730e-01   +7.230203058005100e-01   -3.134502827309996e-01   -8.101095182595416e-01   +5.612841637844765e-01   -1.725145385082595e-01   +4.479732053367207e-01; -5.477492574752330e-01   -5.023384145922758e-01   -6.136369027933356e-01   -3.135597621763164e-01   -6.222833304555233e-01   -5.361483268693359e-01   +1.000000000000000e+00   -5.802640854335925e-01   -4.188705907353709e-01   -2.143645808445066e-02   -8.929821224046196e-01   -2.819598057471976e-02; -6.469330613989546e-01   +4.735121614844374e-01   +5.919670824630783e-01   -3.354194053937032e-01   -9.348762966932935e-01   -6.792529323992177e-01   -4.024744256339866e-01   +9.246900650270691e-01   -3.475373708620081e-01   -6.484998307764698e-01   +8.932802215571761e-02   +7.490699846046507e-01; +4.702810978053676e-01   -8.107055941836431e-01   -2.033441528207995e-01   +4.699536337554051e-01   +5.269986849229440e-01   -6.288868732489582e-01   +2.872613650617659e-01   +9.546825791713431e-03   +6.020884586024807e-01   +2.285082645689459e-01   -1.349736135627390e-01   +2.441764685203761e-01];
L1_L3_iAMPA_netcon = [-8.079840838711046e-03   +6.944001100325664e-01   -9.304177692805751e-01   -3.970538507035654e-01   +1.226691364850249e-01   -2.442891484427224e-01   +9.329371152000171e-01   -5.064701378069815e-01   -2.047880428375899e-01; +8.629143690763813e-01   +7.254027378987629e-01   +7.041820696775434e-01   -3.928467791040847e-01   -2.724300660672587e-01   +9.414717057850670e-01   +1.366647204396985e-01   +7.576670572382841e-01   -6.439523151016545e-01; +3.808152050115381e-01   +9.206047406970563e-01   -1.949719095539332e-01   -1.424729145233034e-01   -5.901672986384318e-01   -2.351751244411187e-01   +7.010208930219249e-01   +4.315773744864035e-01   +9.636562725060259e-01; +7.735233369865497e-01   -3.711087886958239e-01   -8.393747535528883e-01   +4.724308964989822e-01   -8.006356469267759e-01   -5.254759674316676e-01   +8.188891384232211e-01   +8.004891098552507e-01   +2.683076771362484e-01; -4.027029374259976e-01   +4.464889485394804e-01   -4.979406080497001e-02   +2.113427394831508e-01   +7.781618183923042e-01   -5.687731596206601e-01   +6.914271206626977e-01   -5.195722265733786e-01   -2.570904547478725e-01; -4.529653648462583e-01   +1.079329069874409e-01   +1.000000000000000e+00   +4.631034441258983e-01   -6.270786092479083e-02   -3.292083306019553e-01   +3.371282353128415e-01   -5.076146203634090e-01   -6.183978802750207e-01];
L3_L1_iGABA_netcon = [-1.339281983491317e-01   -7.084470339159110e-02   +5.694018779392666e-01   +6.898470910021494e-01   -1.781402244821748e-01   +9.527118892311852e-01; +5.817044980866641e-01   +8.224668271448983e-01   -2.541484179865329e-01   -1.790420662082697e-01   -5.316057510191318e-01   +6.126519582781267e-01; -6.553638905506654e-01   +7.335203032593469e-01   +9.507448935409990e-01   -1.000000000000000e+00   -7.681685315596484e-01   -8.575908866324728e-01; +9.556390814298875e-01   +9.366833443740705e-02   +4.558941102970724e-01   +6.080300006858759e-01   -1.458003371284094e-01   +4.900642382742355e-01; -3.900323511245748e-01   +7.372752738900722e-02   +7.093424260598999e-01   -9.601965936401460e-01   +4.068271046655592e-01   +8.055501577330743e-01; +3.939388546158987e-01   -6.098913973737448e-01   +4.527625935220345e-01   -6.490591656717664e-01   +1.052971572293854e-01   +1.173155436713991e-01; -9.207768345905364e-01   -3.946017456987252e-01   +4.259015409568697e-01   +3.146990547895774e-01   -7.715238289590377e-01   -8.810927773686134e-01; -7.299447363541561e-01   +6.665225217140086e-01   +9.906295802341180e-01   -7.459974783364487e-01   +8.442410747562764e-01   +8.369319210513469e-01; -2.517316136098310e-01   +1.601305975758816e-01   +7.125759859638736e-01   +4.378804258865049e-01   -7.398303167918884e-01   +7.176269835351359e-01];
L5_Input1_iAMPA_netcon = [-6.225975837659955e-01   -1.000000000000000e+00   -2.929204912190718e-01   +1.075122438598583e-01   -9.369955442332355e-01   +9.067340803722009e-01];
L6_Input2_iAMPA_netcon = [+3.852083266779535e-01   +8.891171146611705e-01   -2.338622034123300e-01   +7.850206834610810e-01   +2.605282180860261e-01   +1.000000000000000e+00];
L5_L6_iAMPA_netcon = [-4.621901700594549e-01   -6.189936228331168e-01   -7.343028334498951e-01   -6.072990475262522e-01   +2.128498245376828e-01   -6.843264141247943e-01; +2.913326117806939e-01   +8.389388048223516e-01   +7.917656242742389e-01   -9.640079309303997e-01   +2.652323260269274e-01   +9.469330060140193e-01; -3.669678853094471e-01   -4.224733609586949e-01   +5.001203385216914e-01   +3.085347972290632e-01   +7.462295096933885e-02   -5.652876700781332e-01; -5.342967710114535e-01   +9.337961472257070e-01   -1.496377533249180e-01   -6.956331765639278e-01   -3.132628632091764e-01   +6.643260281253746e-01; +9.893069453508120e-01   -9.584651927422017e-01   +3.077240334799579e-01   +5.249873282048196e-01   -6.067453655306410e-01   -3.970812329030896e-02; +1.889081399938933e-01   -1.000000000000000e+00   -9.157504800448520e-01   +5.481465148778522e-01   +5.911203996357841e-01   +9.605281479539006e-02];
L4_L5_iAMPA_netcon = [+4.860493948848832e-01   +5.025467134140085e-02   +4.330388860805855e-01   -1.188854248540059e-01   -9.165209751720672e-01   -2.898891398612830e-01   -3.654213023422628e-01   -1.912889845795275e-01   -7.401825134158260e-01   -1.985265828837554e-01   +7.824482988968213e-01   +1.711633420679128e-01; +3.213780586557232e-01   +3.452973729393000e-01   +5.946677327892411e-01   -8.546565109430323e-01   +5.123074476911587e-01   -3.776527202324138e-01   +5.607217269856965e-03   -1.144155117039816e-01   +3.516631043484549e-01   +1.552677258026672e-01   +3.046911832153694e-02   -2.622497298417896e-01; -7.002148532641533e-01   +7.141408745651494e-01   +6.514582298138845e-01   -6.963388983614794e-01   +1.066031142640555e-01   -7.318132490081759e-01   +1.364602174306065e-02   +9.592388576071914e-01   +5.330264042489277e-01   +1.000000000000000e+00   -4.902624026383112e-01   +6.432344298389723e-01; -6.299935588095357e-01   -4.734088482450443e-01   +4.872621588888504e-01   +6.183226515863458e-01   +8.096037161634390e-01   +1.782985866332214e-01   +8.418477634205540e-01   +9.430159403536721e-01   +6.510186542960127e-01   -1.141417540740134e-01   +1.287234479038877e-01   -7.075556533598761e-02; -1.323578166453487e-01   +8.968384767699117e-01   +9.435137079087502e-01   -3.577990908769074e-01   +1.589545561489744e-01   -1.194462671085890e-01   +8.677421213940770e-01   +6.298897261831590e-01   -3.679446917876087e-01   +4.302590677042648e-01   -7.476908868962594e-02   +6.402982761831857e-01; -6.093225536618359e-01   +6.143574324673259e-01   -5.466770805652494e-01   +3.974647205663305e-01   +4.616102579287080e-01   +5.869659188973687e-01   +1.110652831912736e-01   -8.605379979490297e-01   +9.904005572454144e-02   -3.600221510390559e-01   -8.683779672187825e-01   -6.449250735690398e-01];
L6_L4_iAMPA_netcon = [+6.493621177372042e-01   -5.955034310888458e-01   -2.572044543912401e-01   -3.754189581512774e-01   +5.964922025080941e-01   -8.902790596734356e-01; +4.301372594685036e-01   +7.970827184963006e-02   +4.428766007300472e-02   +9.178442910137292e-01   -9.859108254471231e-01   -7.933563504557835e-01; +7.515433162554427e-02   +9.986655080729177e-02   -1.225055922554702e-01   -7.361996087392449e-01   -8.397348631851768e-01   +1.000000000000000e+00; +2.193632611962077e-01   -4.273425672526917e-01   +4.714724816346276e-01   +1.243560841955294e-01   -5.440446657419640e-01   +2.854896496252396e-01; +6.978209463215458e-01   -4.852243598431590e-01   -2.287509140333382e-01   -4.133495605650458e-01   -5.205642718149525e-01   +2.701612422755690e-01; +4.669788349930170e-01   +3.706725376486301e-01   +1.141552101285015e-01   +2.600846927757832e-01   -9.076203173784692e-01   -6.693455886613664e-01; +1.763836432153815e-01   +9.885233773175439e-01   -3.272482615999638e-01   +3.672873392903604e-01   +7.481866556052745e-01   -2.013997993580870e-01; +8.588786670460746e-01   +1.101211970943855e-01   +1.516675144080497e-01   -3.997215783047874e-01   +1.021706429500464e-01   -7.097360397270266e-01; +6.640588947125391e-01   -8.862388349338781e-01   +7.238454331848198e-01   -3.563763282004276e-01   +4.609748149844677e-01   -6.773863366068297e-01; +6.049975588298049e-01   -1.462735393582549e-01   +8.563051302685417e-01   +1.349498309480793e-01   +9.787634690766776e-01   +9.033817064432358e-01; -3.157804756175253e-01   -3.910066573668700e-01   +1.792676957430863e-02   -2.072943511281398e-01   -4.062127497527406e-01   +6.638361629035558e-01; +3.185568197484479e-02   -1.655544543260817e-01   +4.892419113065247e-01   -6.368246493559394e-01   +9.997453085159568e-01   +1.388854036775800e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
