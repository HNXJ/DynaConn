function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.188797025955446e-01   +3.160440620775994e-03   +1.045983515050682e-01   -8.251247575185996e-02   +2.472931526556694e-02   -1.153781346142392e-01   +1.873218602724736e-01   -1.021893359899625e-01   -6.422148669936807e-02; +1.268536315400204e-01   +8.973214294807286e-02   +3.836889712600564e-02   -9.238758570019778e-02   +1.544250658261060e-01   -7.465512487554017e-02   +1.255573779755281e-02   +9.677403782529911e-02   -6.961686381544466e-02; -7.178146195100908e-02   +1.967633903364921e-01   -1.005780054425978e-01   +1.599278864656167e-01   -1.201484740023624e-02   -1.968841343820736e-02   +2.275063950624363e-01   -1.509578904780561e-02   +2.482571344097403e-01; -8.675050830070133e-02   +7.432838286311082e-02   +1.136711960491165e-01   +1.183528274470746e-01   +1.353891325260458e-01   +8.627608800056538e-02   +3.339913869536486e-02   -1.129444985006461e-01   +3.838402039994568e-03; +1.456356532425679e-01   +1.621314930736197e-02   +1.935793626727729e-01   +3.037727595586715e-02   -1.200377636724842e-02   +3.049176042439319e-02   +3.049746526196984e-01   +1.347999197217799e-02   -8.724831946978828e-02; +1.080012560644049e-01   -2.699543445580001e-02   -1.093417017289814e-02   -2.934589303672930e-02   -1.757636867085535e-01   -9.537759238000147e-02   +3.808912302430979e-02   -2.751025135469150e-02   +2.711072787445233e-02; +1.158521306346695e-01   +2.211840724988375e-01   +1.224012608025638e-01   +2.319853879896792e-01   +5.486315811515469e-02   -2.968894380172047e-02   +6.290947553556192e-02   -1.879356040647069e-01   +3.948811309066640e-02; -9.697176457589854e-02   +2.730780902510211e-02   +1.405653115742683e-01   -3.913206402250584e-02   +2.910705155833403e-02   -9.517280901924517e-02   +3.390755243545873e-02   +1.145292435998301e-01   +9.747024785317414e-02; -2.258542833241153e-02   -1.717033453086453e-01   -2.921231740322188e-02   +5.062522894232185e-02   +5.183335304838615e-02   -7.747048616664368e-02   +1.249377298411289e-01   -5.245021098339020e-04   +1.977262162004967e-01];
L1_L2_iAMPA_netcon = [-1.142666157935719e-01   -2.034194029121325e-01   -5.382063154319485e-03   +6.526967323313035e-02   +4.147701164672951e-02   -2.725580414514883e-01   -1.014515450313431e-01   +2.270963611334012e-03   +1.409898559191191e-01; -6.968088970448894e-02   +5.505372700002245e-02   -1.948630992780044e-02   +2.177679936035713e-02   +2.691011351757063e-02   -1.827391205741815e-01   -1.078497210329536e-01   -7.626291325576617e-02   -8.921081222689452e-02; -1.033597760463951e-01   -2.012865220712505e-01   +1.430090973054680e-02   -5.814414975822418e-02   +1.095925298422917e-01   +1.129339084474220e-01   -2.479219273825664e-01   +2.843189697442584e-02   +5.999242708254642e-02; -1.384891059384620e-02   -6.268933057335863e-02   +4.600153442017099e-02   +1.554789515607892e-01   -1.069238871637347e-01   -1.201175052242140e-01   -1.613629865245555e-01   +1.165957778587843e-01   -1.266920943886783e-01; +1.061394949075049e-01   -1.020698580003131e-01   -2.575662115667562e-04   +1.783630706619818e-01   -5.595683858116260e-02   +2.969592074536903e-03   +2.749744855461456e-02   -5.783673875998664e-02   -2.168018792078524e-02; +2.244311933639811e-01   +6.503193614375610e-02   -1.055250106208598e-01   +6.230003439831964e-03   -4.646462173087008e-02   -2.681300480395458e-02   +5.213764133418439e-02   +1.264418322943806e-01   +1.173734164573713e-01; +2.800631741567675e-02   +6.264217682920992e-02   +7.581513523289507e-03   -2.052274174267953e-02   -3.048353698374361e-02   -3.895663242558758e-02   -9.847747236121596e-02   +9.251412532035713e-02   +1.582926682317529e-03; +7.871767327605776e-02   +2.042693767347343e-01   +1.301311199262035e-01   +6.703663379676600e-02   +2.512154827983082e-01   -1.107421260940292e-02   +1.449875999610525e-01   +1.087066769392734e-01   +2.031311674262434e-02; +2.019567504906697e-01   +1.213082430709202e-01   -8.211834690234870e-03   -2.125234037988059e-01   -1.188906045388327e-01   -1.025387226399279e-01   +1.283377577197202e-01   +1.754404848622183e-01   +1.464880621204253e-01];
L2_L5_iAMPA_netcon = [+1.260186289760706e-01   -2.022437716307946e-01   -1.067467518355252e-01   +1.572719237640294e-01   +1.111429963504834e-02   -6.336905538346438e-02   +1.000849555808085e-01   +1.657395616433084e-02   -1.659119579231414e-01; +1.319002345209593e-01   -3.777904256886854e-02   -2.228072894231100e-01   -3.433833491206706e-02   -3.832446685044207e-02   +7.855536128706911e-02   -4.383689134935174e-02   +1.142243085323454e-01   -4.150335489697878e-02; +2.493477879861196e-01   +9.204219864157201e-02   +1.717760292501811e-01   +5.240998401814109e-02   +8.194297955710364e-02   +1.202902742371201e-01   -3.741824996782318e-02   -9.940775031305783e-02   -1.311733911420209e-01; +8.486649199018134e-02   +1.739538792839508e-01   +3.271586516213649e-01   +2.809365342986891e-02   +2.498551066532675e-01   +4.558871295977095e-02   -2.016067040565634e-01   -1.296588600270544e-01   +8.516027755180361e-02; +1.409976886470846e-01   +1.576803454413496e-01   -1.460960678087664e-01   -8.108746590943322e-02   +1.118322360135018e-01   +2.110431174443270e-01   +2.101755731539091e-01   +1.434208439009520e-02   +1.373129969768990e-01; -3.791360655913227e-02   -1.366868991907334e-03   +1.757537722447473e-01   +5.808908049811252e-02   -2.795722656381892e-02   +3.790717621370204e-03   +3.522411551323644e-01   +4.078539795006340e-02   +5.067585929497834e-03];
L5_L2_iGABA_netcon = [-3.907011619377520e-02   +6.996678723307849e-02   +1.387426377001433e-01   +1.527798886789978e-02   -1.583880329223031e-02   +2.640365112616609e-01; +1.656866682524784e-01   -1.271295631127632e-01   +1.232808702659701e-01   +1.857052904508689e-01   +1.366908626514661e-01   -1.012384834911973e-01; -5.752727420957233e-02   -8.838105727170927e-02   +1.647771042968514e-01   +1.255391310698695e-01   -3.354790137887945e-02   +2.402375002184558e-02; -1.071074096645195e-01   +6.410643909448960e-02   +3.621012631148603e-02   +2.651047320615668e-01   -1.308608888741198e-01   +1.022324738591901e-01; -4.593354013374937e-02   -7.758516427734158e-02   +7.543747743734693e-02   +1.975424108747659e-02   -1.117675936575955e-01   +1.133296729457210e-01; +1.865936156165366e-01   +7.155773206465071e-02   -3.432477453202049e-02   +2.914139686218336e-01   +6.115846339068143e-03   -4.480959417159152e-02; -1.913637444792922e-01   +9.714710601655231e-02   +7.169804651562735e-02   +1.512089170545243e-01   +8.319343675244197e-03   +3.310081319738922e-02; +6.050923391211500e-02   -8.197296514433045e-02   +2.032861765897861e-01   +2.239270031273405e-01   +1.653083906553898e-01   +3.773987443906603e-02; +2.271932448248869e-01   -1.981555923780610e-01   +2.678944029589378e-02   +2.047414202597568e-03   +1.589483287385980e-01   +1.385521409055800e-01];
L3_L2_iAMPA_netcon = [+2.008098478691082e-01   +1.079020718143397e-01   +1.462725636283799e-01   -3.960311166873499e-02   +2.094971972794180e-04   +1.248112161447257e-02; +6.749497891106881e-02   +1.989722773809510e-01   -3.621445491280044e-02   +6.314742123202235e-02   -4.493324838035058e-02   +2.606586006128118e-01; +7.140138938623825e-02   +6.153080082529420e-02   -2.313843010409551e-03   +6.252866145677079e-02   +1.855992002504202e-01   -3.612738262249274e-02; -3.876465114721973e-02   +1.449270926161944e-01   -1.038732133596037e-02   +2.820213406041569e-02   -1.442786746492947e-02   +7.480668518891373e-02; -2.401410270553576e-01   +6.731981966766565e-02   +4.006052820911195e-02   +1.390854396036908e-01   -1.579426462979386e-01   +4.288603265121470e-02; +2.605285272700955e-02   +1.881671360399731e-01   -1.154417168163876e-01   -6.761116864127302e-02   +1.132679393058846e-01   +9.796334176444933e-02; +4.129911199694807e-02   +4.203562213150144e-03   +1.125552322396900e-01   -9.591123937023288e-02   +1.383546613463447e-01   -1.276708304870658e-01; +1.516807072368383e-01   +2.339579264255018e-01   -2.445150762816705e-01   +1.089166446229633e-01   +2.256635492540961e-01   +1.211623887815495e-02; -1.070547379341271e-02   +1.017839050878198e-01   -4.658969122537658e-02   +1.340797133328689e-01   -9.090024035456146e-02   +7.014791818100147e-02];
L2_L3_iGABA_netcon = [+2.633983932821902e-02   -1.453789950050528e-03   +1.709625295749906e-01   +4.817991337651820e-02   -1.449245880280443e-02   +1.205581251611264e-01   +1.172521902263790e-01   +3.371200916265404e-02   -1.257465499116969e-01; -4.649970430016204e-02   -1.869243827135758e-01   +6.472936516811233e-02   -1.249192620805911e-01   -1.929762693468132e-02   +3.252228525368107e-02   -8.792065322889842e-04   +8.096764970284973e-02   +1.688422453082400e-03; +2.390011392683579e-02   -5.062508029613802e-02   +5.643055938408362e-02   +1.741526748655577e-01   -1.903915050525142e-01   +2.107454494188443e-01   -2.067249330931801e-01   +1.765668336356027e-01   -3.936932219957797e-02; +2.624888186990514e-01   +5.816887449508108e-02   -1.422507534142053e-01   -4.222175214348514e-02   +5.515677316585551e-02   -2.581956460079837e-02   +1.418287234128125e-01   +1.689639419245720e-01   +1.313618482884508e-02; -9.726223948793933e-02   -6.378184540267270e-02   -1.487885356669356e-01   -1.758812359077623e-01   +1.493151361204904e-02   -8.021901030216169e-02   -4.460312320722763e-02   +5.198863040546758e-02   -1.947554632568282e-01; +1.066544206555527e-01   +8.409710235577489e-04   -1.055635641891816e-01   -1.027000975500415e-01   -6.532106913878932e-02   +1.615380962058286e-01   +1.820330630631723e-01   +3.168343425344531e-01   +1.408571053797086e-01];
L1_L4_iGABA_netcon = [+6.320122346381625e-02   -1.974480062629436e-01   +5.280588140316962e-02   +1.897051005845177e-01   +4.171624677928362e-02   -1.391633714462480e-01   +1.286846208347232e-01   -8.620591047351500e-02   -1.801139825786497e-01; -7.021268798652655e-02   +6.777966573569948e-02   -3.177404262844583e-02   +8.640041184402157e-02   +7.922408945073615e-02   +2.173636554056403e-01   +6.083952402199212e-02   -3.388847373397276e-02   -1.893477016851071e-01; -1.866160308027630e-02   +1.868923763252998e-01   -1.614331093730101e-01   -1.196564846682080e-01   +4.799299428163066e-02   -1.609695597269057e-02   +1.855097284807381e-02   +3.462443129844900e-02   -1.269327412711703e-01; -6.991577676246238e-03   +5.813353130429066e-02   -1.504758357303129e-01   +5.880379887412453e-02   -5.406755849857479e-03   -7.249384217165482e-02   -1.027638811543223e-01   +9.568671963612954e-03   +9.863246994881611e-02; +4.146192644607771e-02   +4.169281097647461e-02   -3.591953439560333e-02   -1.519952711826278e-01   -4.412287646571672e-02   -1.241141088632315e-01   +1.178985709311980e-01   +7.457729070484032e-02   +3.631264314617524e-02; +6.897826585249670e-02   +1.811151180357137e-01   +8.437830964355461e-02   -2.925381249085111e-02   +1.087308009886978e-01   +4.005892885872503e-02   -1.301795634201234e-01   +1.019858825574171e-01   +1.914790650270715e-02; -4.126487304756474e-02   -2.215794643772926e-02   -6.085953645503890e-02   +1.879154832765989e-01   +2.723519793456889e-02   +7.861764728990822e-02   +6.775300009214158e-02   +3.593585910267795e-02   +5.279627581635925e-02; -2.791281810033797e-03   -1.268128996226258e-01   +8.269636901914246e-02   +1.153984955344772e-01   +4.816705495689261e-02   +1.239948173386950e-01   -4.941422594586261e-02   +2.287333351047471e-02   +1.515188241149432e-01; -1.869511742621719e-01   -1.356983306974616e-02   +4.501687348600389e-03   -9.860877146521706e-02   -1.403295593237445e-01   +1.206465188377431e-01   +5.616960853273652e-02   -9.447667108266417e-02   +1.297285989072176e-01; -1.476274750192811e-01   +2.393686474576583e-01   +1.002642455076458e-01   +1.306100911810342e-01   +1.991961528134883e-02   +7.340399484447914e-02   -6.527394127774692e-02   -1.228098565341922e-03   +7.786166528761506e-03; -9.198350098889035e-02   +8.250064114537214e-05   +5.684298882759544e-02   +1.574173579217961e-01   -3.567010682092077e-02   -9.068058539823393e-02   -2.091548258408063e-01   +5.773978244533405e-02   +1.359341639323689e-01; +1.890338298605959e-01   -1.412229422251361e-01   +1.258575794689881e-03   +8.413325841175380e-02   +1.013762949216409e-01   -6.326717588518756e-02   +3.075003597418597e-02   +2.157769573308918e-03   -4.776416916869133e-02];
L4_L1_iAMPA_netcon = [+8.083016885830402e-02   +1.544714516730406e-01   +3.556227181129987e-02   +5.168688170679666e-02   +9.039572091904843e-02   -4.689264768359079e-02   +9.847195039942269e-02   +6.178163618980605e-02   +1.666506945774608e-01   +5.454242480198702e-02   -2.193948786500885e-01   +2.657096591541935e-02; +3.650192105786144e-03   +3.322493468707715e-02   -2.037530861524804e-01   +6.526077850371045e-02   +2.585640750635732e-01   +3.221649804888408e-02   -1.684711079388804e-01   -4.538504481975643e-02   -1.262087446150738e-01   +2.134998923033544e-01   +7.200263087371303e-03   -4.428785768187342e-02; -1.617232533188149e-01   +4.041301393724130e-02   +1.857331286881259e-02   -1.708161764520119e-01   +1.926749874192714e-02   +8.503146475693645e-02   +2.132983178526544e-01   -1.872522811278615e-03   +2.938871829549861e-02   +1.059039523446997e-01   -1.208867748110506e-01   +1.072011198363284e-01; +2.625326028959179e-02   +6.296080044958872e-02   +5.837834966197725e-02   -1.514837711999815e-02   +7.737425899292243e-02   -1.838779317057609e-01   -9.751585848924786e-02   +2.019748410977487e-01   +4.723415978929274e-02   -9.090456136232627e-02   +8.831975891828645e-02   +1.039136705669461e-01; +1.469863572976929e-01   +6.285279776190061e-02   -7.516092942018614e-02   +4.948866665720579e-02   +2.065391901222344e-01   +1.248068859995317e-01   +1.917907984649423e-02   +2.695033274419861e-02   +9.257151574363517e-02   -6.496709170088910e-02   +8.679558431319724e-02   -8.840701610523688e-02; -7.171253803865772e-02   +5.443894449957913e-02   +1.057319356154905e-01   -8.117542807539474e-02   +9.895733111937167e-02   -1.091436489189657e-01   +2.692046779358968e-02   -6.669666508874179e-02   +8.268528504601036e-02   +1.216639544295555e-01   +2.428321836072968e-02   +3.553116792027730e-02; -1.281692500915766e-01   +3.683029262820910e-02   +1.778430423779356e-01   +5.569691880676383e-02   -4.017122199426508e-03   +7.084634172490853e-02   +1.578045985301302e-01   +9.044423247538312e-03   +1.746172175372790e-01   +1.215821634658786e-01   -9.310605597428973e-02   -3.606084320526507e-02; +5.025756640621110e-02   +6.572237026587384e-02   -1.824231427696725e-01   -8.702175717811771e-02   -2.921991332220341e-02   -2.879891635860651e-02   +8.042514432625314e-02   +9.039690529093440e-02   -1.550396773752040e-01   +1.520997537369143e-01   +1.511867245966556e-01   -6.173126581232415e-02; +1.186965330188051e-01   -3.320284806781425e-02   -2.809395462133250e-02   +1.612152268248598e-01   -7.823051785066835e-03   -1.199387680626525e-01   +1.373256580936014e-01   +9.648354130577869e-02   -1.533445569445581e-01   +7.182188027698155e-04   +3.195926890184086e-01   -7.040649998097552e-02];
L1_L3_iAMPA_netcon = [+1.223725633293745e-01   -4.294216611781262e-02   +3.363105036573263e-02   -2.611666559316243e-02   -4.082635832817103e-02   -1.468181256843532e-02   -8.021668489555600e-02   +5.890689822238619e-02   -1.839092446426036e-02; -1.176049826609479e-02   +5.529592357222921e-02   -1.592799698340014e-02   +1.345259034068751e-02   -1.638305356364028e-01   -1.233202664957435e-01   +4.232098432011577e-02   +1.138655314275851e-02   -2.622236086081044e-02; +1.472428405505635e-01   +1.347928484640305e-01   +2.822001208316581e-02   -1.129336356135127e-01   +5.616966941700685e-02   +6.473093455773958e-02   +8.446892916329601e-02   +1.163674377343707e-01   +1.615998219424521e-01; +9.115894258958117e-02   +8.760099453023518e-02   -5.119107306858994e-02   -4.177355293000092e-03   -7.801043152133265e-02   +2.857621483202340e-02   -1.019611175668274e-01   +1.118931085260505e-01   +1.171663128834931e-01; -3.945593246291156e-02   +2.319584205701886e-01   -6.624611088276428e-02   +9.064097842512056e-02   -8.108293042558264e-02   +1.340123184604765e-01   -1.002876605127736e-01   -1.595429793903285e-01   +7.979708862229877e-02; +1.414185446650141e-01   +7.002186802865359e-02   +1.463551564495642e-01   +1.424136317100743e-01   +2.960356160009496e-03   +6.753645472408011e-02   +2.566202794146074e-01   +1.102579082740831e-01   +1.074403190259098e-01];
L3_L1_iGABA_netcon = [-7.965660906966937e-02   +1.005344650834516e-01   +9.454779298097987e-02   +8.911295950813758e-02   -6.739607201002437e-03   +1.913610703974004e-01; +9.071491861633560e-02   +7.460432512020224e-02   +5.384724786655011e-02   +1.479974328118862e-01   +2.111495120023302e-04   -9.332863693365728e-02; +1.627382506645298e-01   +5.677072454669667e-02   -4.448883824760590e-02   +2.721029157034547e-01   -4.001828363652260e-02   -5.122757853678555e-02; -1.877793603502029e-03   +7.304387152357592e-02   -1.170487927905228e-01   -3.255735688805902e-02   +4.048161047828908e-02   -1.412334569989630e-03; +2.492950834277607e-01   +5.504052171966275e-02   -1.510355180463800e-02   +7.265718915613609e-02   -1.422497629201613e-01   +1.186820122446395e-01; +3.469298324331740e-02   +1.140790286413828e-01   +6.077613615045854e-02   -9.174640781149883e-02   -1.758455607117398e-01   +1.287451011589939e-01; +4.169155166025146e-02   +1.107569234791435e-01   +3.183045429375761e-02   +4.008595775144645e-02   +1.578797266049277e-01   -2.020217429439323e-01; +7.460363705968839e-02   +1.419505368907580e-01   +2.582611610886389e-01   -7.902339216711574e-02   -6.791036685080226e-02   +5.285247475814636e-02; -9.576539541056944e-02   -1.210172645318660e-01   +8.949608108123132e-02   -1.605549366756900e-01   -1.207116968736002e-02   +2.491165391732547e-02];
L5_Input1_iAMPA_netcon = [+6.057845087428302e-02   -1.629067545737909e-01   +1.823800136814724e-02   -2.607753380121994e-03   -1.336579790311484e-01   -3.437236565655576e-02];
L6_Input2_iAMPA_netcon = [+2.344452995799260e-02   -5.666534834627081e-02   +8.423168855329274e-04   +9.172396853244766e-02   +9.208784401174196e-02   +1.026343596778102e-01];
L5_L6_iAMPA_netcon = [+5.635951986626236e-02   +6.327834498624213e-02   +2.066943022799316e-01   -2.589643009205901e-02   +1.568732419035055e-01   +3.404420447295875e-02; +8.199674381992322e-02   +1.418886976397366e-01   +2.170926371313920e-01   +7.073672416794081e-02   +4.227900883770610e-02   +2.197996265260451e-02; +4.256692357655462e-02   -1.302705172034600e-03   -4.879424590832369e-02   -9.798327324512832e-02   +1.228533912880623e-01   +1.013354649050825e-04; +9.434343814373107e-02   +1.866156973676582e-02   -5.468947881600028e-02   -1.641385317846565e-01   +6.514414963577861e-02   +1.269235570979979e-03; +2.134407732025733e-01   -2.266667566037384e-02   -6.498410041459178e-02   -1.447938292084690e-01   +2.079912976922334e-02   -1.384671753859644e-02; +6.021347995910693e-02   +1.806047384504345e-02   +1.750408723272407e-02   +2.567099031067271e-01   -1.724973260786880e-01   +2.225635043659466e-01];
L4_L5_iGABA_netcon = [+2.060168843874251e-01   -6.468487565300667e-02   +9.614250679036535e-02   -6.682842233687061e-03   +3.994886887609683e-04   -8.653258872935218e-02   -7.095866152198266e-02   +2.224984965735854e-01   +1.568142199388110e-01   -3.617682558788450e-03   +7.381077131738651e-03   -7.187668581585474e-02; -2.028299558540242e-02   -1.578259692840175e-01   +2.394253166381892e-01   +1.461516987953283e-01   +1.431790128598548e-01   +7.711492861853367e-03   -6.504118311048041e-02   -1.699476985084555e-01   +2.698160865570476e-01   -1.175412528765814e-01   -1.169844027207347e-01   -3.007925795362876e-02; +3.224787566707699e-02   -4.217316383843391e-02   -1.263080863707913e-01   +1.261865888421681e-01   +1.514288560526221e-01   +1.047312799216127e-01   +1.698755674062477e-01   +2.846726777330552e-02   -1.711387201836125e-01   -1.025356231286149e-01   -6.665122187706274e-02   +2.112531370482684e-02; +2.430310857400376e-01   +4.266083733258710e-02   +2.494356557361536e-01   +2.769446678523183e-01   -7.401036589922444e-03   +8.752855951501032e-02   -6.783084256820687e-02   +5.802995272699159e-02   +1.192663545988073e-01   -8.057855415908580e-02   +2.729992848603622e-02   +1.217291289697792e-01; -5.476919048489218e-02   +8.456733426042196e-02   -1.577736287669588e-01   -2.959392598667246e-02   +9.857220899380383e-02   -6.193876407724045e-02   -3.804898269379037e-02   +3.534871846374195e-02   -3.802271974735036e-02   +1.064807637029484e-01   +6.627636588823066e-03   +1.019981327197888e-01; -5.025723549294081e-02   +1.687618326319059e-01   +1.770902639722820e-01   -5.767898108640901e-02   -1.405054356506825e-01   -1.838679899457650e-02   -1.525419946911819e-01   +8.746141312819634e-03   -1.776411566281219e-02   +2.078089328278650e-02   +1.149814555801135e-01   +6.598259140575850e-02];
L6_L4_iAMPA_netcon = [+2.364272336062802e-01   +1.890356488164827e-01   -2.527401125949985e-02   -2.107610894180555e-01   -7.951592971085855e-02   +3.737469313748516e-02; -7.992633256203849e-02   -8.582000075574671e-03   +1.100066361295020e-01   +3.413283466230775e-01   -8.458770621929082e-02   -3.843492909250417e-03; +9.039958730085196e-02   +2.137016656544170e-02   +8.399377649397875e-02   +1.687006030899879e-01   -5.507905999991058e-02   -8.889139903449275e-02; +6.467969514567093e-02   +3.675002832355821e-02   +1.662825299081976e-01   +1.413162952746579e-01   -7.335883700187876e-02   -1.556084091307207e-01; -5.070590611536352e-02   +9.570612413302751e-02   -7.721871208498737e-03   +6.550711910093578e-02   +2.027750283043304e-01   -1.188325834759625e-01; -7.233090793192447e-03   -1.587187322917563e-01   -1.108987496192761e-01   -1.742674160689711e-01   +3.790457132016413e-02   +3.419138549335810e-02; -4.665792792249684e-03   -1.356702035478339e-01   -1.015776366557545e-01   -1.860497374617244e-01   +1.785997218506319e-01   +9.149884986706543e-02; +7.946350341583025e-02   +1.120680833132690e-01   +1.250112256271534e-01   +1.044646581144789e-01   -5.431060737205769e-02   -6.939104411858940e-02; +7.030616514923783e-02   +1.338106071187402e-02   +8.870095135607468e-02   +1.060436945368848e-01   +1.253277763156063e-01   -7.373814231044475e-02; +2.638753101097822e-02   -8.019473679021442e-02   -1.599969660272835e-01   -5.836218770881488e-03   +3.288430110010737e-02   +4.398815538363060e-02; -1.281130598713228e-01   +8.803933722263981e-03   +1.547958501291057e-01   -3.970886949178278e-02   +2.515146690140226e-01   +2.958674277110663e-01; +1.958698778525302e-01   +7.013273284416539e-02   +1.412245458381145e-03   -1.026249654946948e-01   +1.214333840290409e-01   -3.074605880928172e-02];
L5_L4_iAMPA_netcon = [-2.176942881976957e-02   -1.522088531585371e-01   +1.949757092160665e-02   -4.019789326370078e-02   -1.908105784131629e-01   -2.248510142888429e-02; -2.103058975533951e-01   +6.909839691386477e-03   +8.551648411108322e-02   -1.203182787370546e-01   -1.391258561470016e-01   +5.867859511824960e-02; +9.397239083233792e-02   +8.377780294199949e-02   +1.091424620346435e-01   +1.560551576431725e-02   -5.222035069109538e-02   -1.064209290913901e-01; +5.790285831986891e-02   -5.278022856445999e-02   -1.565270204178074e-02   -1.100460417505229e-02   -8.486297510049641e-02   +1.488663862554986e-01; -8.493307906327086e-02   +2.237128046920172e-02   +1.093912025926583e-01   -9.593395477272473e-02   +7.717909129257360e-02   +1.008272031759443e-01; -1.353984161101420e-01   +1.602038732184828e-01   +1.151990295722226e-01   +1.236486956464284e-01   +6.866014891676282e-02   +5.016850479772602e-02; -5.569733997812211e-02   +1.980312409503154e-01   -7.836527372031443e-03   +3.371040951898481e-02   +6.405332442687381e-02   -2.015272508985567e-01; -6.779797433637547e-04   -2.936165454643039e-02   +2.227483663101036e-01   -6.352853456756091e-02   -3.271419752986308e-02   -1.147451186417306e-02; +1.118021535376551e-02   +5.331136272701923e-02   -1.542120157051695e-02   +3.636867544081138e-02   +6.233160373779541e-02   -1.532503048053710e-02; -1.813621331931661e-01   +2.466553771747606e-02   +5.681765237384904e-02   +5.717953650778487e-02   -1.474929578213675e-01   +1.654094441179133e-01; +2.316257837782887e-02   +3.572526941633331e-02   +1.345014870966514e-01   +1.767281936132196e-02   -3.337285427510154e-02   +1.875222427641073e-01; +2.907904521809939e-01   +1.131637394895743e-01   +2.595950196042627e-01   +6.150741157999149e-02   +1.250415439548980e-01   +2.541392759642222e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
