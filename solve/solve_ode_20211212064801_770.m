function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.825908192356038e-03   +1.261318803135816e-01   +1.036683322792934e-01   -4.039942688125551e-01   +1.122344172550943e-01   -1.305352540225118e-01   +3.551153369153957e-01   -1.720018041039696e-01   -5.229561300597541e-03; +1.938317234300413e-02   +3.218779219037372e-01   +3.322281546541141e-01   +1.731944826011947e-01   +3.361711773558508e-01   -1.643578915456009e-02   +2.764004402804517e-02   +6.749439611902963e-02   -1.607373298165044e-01; -4.569257592977357e-01   +3.618376681379532e-01   -4.756455071591725e-05   +2.387619369580435e-01   +6.211331993474112e-02   +1.113009604877488e-02   +4.101160878103513e-01   -5.716052533817624e-02   +3.706981381848062e-01; -1.371298688049720e-01   +2.036313740664672e-01   +1.962553520972615e-01   +2.824508969583242e-01   +4.243985444673770e-01   +1.659241619634334e-01   +2.515636865696668e-01   -2.927933161649066e-01   +5.949299284430332e-01; +1.430195830807437e-01   +1.621854854464452e-02   +3.853004718142136e-01   +2.886253414228317e-03   -6.156868215253993e-02   -2.328905254272315e-01   +5.860275245518486e-01   +6.329587232457817e-02   -4.005739492700734e-01; +2.478067878725664e-01   +6.183140278630103e-02   +1.871482323694623e-01   -1.033543171857475e-01   -5.950625174719385e-01   +1.796701184112856e-01   +3.011631971743175e-01   +1.756174219446773e-01   +3.720806351077979e-01; +3.089299109020199e-02   +3.470619778135551e-01   -1.501541784576944e-01   +7.206297789416980e-01   -8.271709306466951e-03   +8.069357969656833e-02   +1.907646566435251e-01   -1.266317950824999e-01   -2.005856871113060e-01; -5.032455447539588e-01   +2.395231118008730e-01   +2.494831412072220e-01   -4.579200032488555e-02   +1.432682454740425e-01   -2.608478383997244e-01   +5.579452555230938e-02   -2.536316570577190e-01   +3.791255500319262e-01; +1.436381501817425e-01   -3.746701067494160e-02   -7.368489506455650e-02   +2.176390911806924e-01   +2.282782349130483e-01   -1.609354073710533e-01   +2.606962074289553e-01   -7.738268751606264e-02   +5.703244398943015e-01];
L1_L2_iAMPA_netcon = [-5.513717883807510e-02   -1.154259989325028e-01   -2.654250355309629e-02   +1.938838196476037e-01   +2.114425168364626e-01   -4.391749053680308e-01   +1.042424582240308e-01   +2.054694525038405e-01   +3.390771839172905e-01; +1.021085081327261e-01   +2.250210136499577e-01   +2.384111302797306e-01   +2.171365877203727e-01   -1.400501034073653e-02   -3.737126471345931e-01   +5.635101648581775e-03   -3.524387774395406e-02   -1.769159684330946e-01; +1.108519270462074e-01   -4.983654102372248e-01   -1.816981153958065e-01   -1.201844106416129e-01   +2.880098345384024e-01   +2.987716367653193e-01   -4.256575641897267e-01   -5.305988184585327e-02   +1.803586327480474e-01; -1.628546174549155e-02   +1.166258358589808e-01   +9.320677131244837e-02   +2.352661831553800e-01   -2.535761353906396e-01   +9.053068067815620e-02   -1.873270243288693e-01   +2.234721613554454e-01   +4.500387608957777e-02; +7.537054221078904e-02   -3.493374322929593e-01   -2.115156625202568e-01   +3.260365072229029e-01   -3.227305687831472e-03   +2.008364442814607e-01   -8.862728011297746e-02   -4.902743236293932e-02   +3.374656083759514e-02; +2.766956119546786e-01   -2.285462313189010e-01   +6.320272241039189e-02   +5.610504242406801e-02   -6.217913225959274e-03   +5.474210495675644e-02   +1.281679885777718e-01   +3.537254207250508e-01   +2.989831185324373e-01; -6.624407156158803e-02   +1.459748601585614e-01   -4.841346208818707e-02   -3.645274726692121e-02   -9.768638484410790e-02   +3.792870188796241e-03   +5.052251321251860e-02   -9.054524124225832e-03   -8.400767545376937e-02; +1.898697929990073e-01   +2.150271966094624e-01   +3.029311847205418e-01   -1.426523939418014e-01   +3.983197605124150e-01   +4.402929617421893e-01   +3.378112586421681e-01   +1.471277328108482e-01   +2.411747250583309e-01; +4.020795131102903e-01   +4.502401891785927e-01   +1.658758971011025e-01   -2.441231017270531e-01   +9.463805030814357e-02   +2.103659141325966e-01   +2.819977526757563e-01   +2.606609082151764e-01   +2.413077679467431e-01];
L2_L5_iAMPA_netcon = [+1.323187531561027e-01   -3.793153945112610e-01   -2.385439689956501e-01   +2.845280523239943e-01   +1.287139608490050e-02   -5.461768372969310e-02   +3.558071417092942e-01   +2.315966306378654e-01   -1.351258332625873e-01; +1.219195182613125e-01   +1.627340829207269e-02   -4.612115060154469e-02   +3.548054033429374e-01   +1.595839975392881e-01   +2.990407903626997e-01   -7.835058361747495e-03   -1.230497581154846e-02   +3.493806256632059e-01; +5.801007875870513e-01   +7.795492827441047e-02   +2.471157275145452e-01   -2.889669309249320e-01   +7.094282060558988e-01   +1.327767647022946e-01   +6.613527961602139e-02   -4.458745609512277e-02   -3.097647556062092e-01; +1.272500303093517e-01   +4.512071710350793e-01   +5.246475374827053e-01   -5.807420690419553e-02   +3.591631118353704e-01   +2.087016347895338e-02   -5.112658585761003e-01   -1.740179895799702e-01   +3.045882002509167e-01; +3.440255854037200e-01   +1.213574304428965e-01   +1.564383640322644e-01   -1.297161252763854e-01   +5.160628403532578e-02   +3.936942166610096e-01   +3.047483399464924e-01   +4.004078257617515e-02   +5.135017654577482e-01; +7.949520078302373e-03   +4.977662309438548e-02   +8.054297471090247e-01   +2.669879788744867e-01   +2.742196257987260e-01   +2.381622396389136e-01   +5.829239662028377e-01   -8.560893867516399e-02   +3.726096887008921e-02];
L5_L2_iGABA_netcon = [-1.041886645900755e-01   +5.385712913786292e-02   +3.679122807367154e-01   +1.924826395120997e-01   -1.794954466066113e-01   +6.001544313445567e-01; +3.489544493317668e-01   -3.872651036006012e-01   +2.455998908629960e-01   +1.151181820678953e-01   +2.186137706347767e-01   -2.531872375649756e-01; -4.512578979177685e-02   -2.583703872605930e-01   +3.063875466224711e-01   +2.684874239665297e-01   +1.684885788333557e-01   +3.829807554960070e-01; -3.126228226570905e-01   +2.480675651084487e-02   +1.941272112479203e-02   +6.281647365850670e-01   -2.143775081237553e-01   +1.938814493477826e-01; -2.045746496146399e-01   +1.688926965183018e-01   +2.635600028931219e-01   +1.713366784790639e-01   -7.947681575855364e-02   +1.893828857145426e-01; +2.890366130915567e-01   +8.704556753938095e-02   -9.102208831795279e-02   +5.533423396138426e-01   +3.564788166745774e-01   +7.011529913249778e-02; -5.338834521535508e-01   +1.377438028657942e-01   -5.817282333289742e-02   +6.674399147559168e-02   -1.535653582967766e-01   -3.238417111567197e-01; -2.060144719727258e-02   +3.571550260065297e-01   +4.741992405134532e-01   +2.127023287604910e-01   +1.765969586911200e-01   +6.814636537082791e-01; +4.451290484662359e-01   -1.619931004889809e-01   +2.472833754823690e-01   -3.218982971029923e-01   +2.160546415041190e-01   -6.948836253996749e-02];
L3_L2_iAMPA_netcon = [+4.747275983918086e-01   +7.654641939223722e-02   +4.163461510933462e-01   -8.979773208065374e-03   +2.178956104693537e-02   -8.822665059708107e-02; +2.097696843718369e-01   +7.125551241276394e-01   +2.896930968726016e-01   +1.834996872505314e-02   +2.270603303788684e-01   +4.537982921289749e-01; +4.877563961686098e-01   +2.004858178024833e-01   -2.747903842628758e-01   +4.417054102516302e-01   +3.809736992506551e-01   +5.976471056602461e-02; -1.109287327308115e-01   +4.007672687990112e-01   -9.112305304242904e-02   +2.628658832029552e-01   -5.759889462535972e-02   +1.005529386284358e-01; -2.701713388192236e-01   +1.921574354051031e-01   +4.852940534582662e-01   +2.309182916786854e-01   -5.043584396543894e-01   +1.227025629708895e-01; +1.871299726303624e-01   +3.272431203783795e-01   -1.794313651556193e-01   +3.350414401067476e-01   +3.279151857746634e-01   +3.048278935293615e-01; +2.172892579943280e-01   -2.899559791927996e-01   +1.781845078965801e-01   -3.371342117085507e-01   +2.088305128601585e-01   -1.728796572711073e-01; -2.504082357470053e-02   +2.607770719097519e-01   -3.856438499359104e-01   +1.666879091804492e-02   +4.211125610225931e-01   -1.522848509270633e-01; -2.291442949952400e-01   +3.434469140607227e-01   -1.423918743101089e-01   +2.936055523294151e-01   +1.054997990333950e-01   -2.497883801080894e-01];
L2_L3_iGABA_netcon = [-2.877281479566962e-02   +6.596420313020199e-03   +3.456323357633797e-01   -7.669663752801439e-02   -1.753631503350577e-01   -3.027953240816353e-03   +5.118137687465580e-01   +2.873016586006443e-01   -4.150254860315622e-02; -1.095857979538135e-01   -1.412009948056245e-01   +3.129276822745218e-01   -7.819785797892481e-02   +3.843409547865327e-01   +1.990916121355978e-01   +1.440361889262923e-01   +2.283480136097955e-01   -3.786188497062745e-01; +4.730160785251417e-02   -3.516722370482633e-02   +5.733557117735738e-02   +6.102308367913655e-01   -4.631533965947474e-01   +4.003756106675263e-01   -2.867022174792686e-01   +2.018826209584006e-01   +1.751594759761278e-01; +5.629642629888690e-01   +3.216243045562707e-01   -3.745005725875585e-01   +2.332203311312951e-01   +2.999007757453862e-01   +3.122791424595739e-01   +2.273256136054818e-01   +3.600912447393741e-01   +1.493657624972553e-01; -8.097360102838806e-02   -1.255449684057598e-01   -1.494736652190522e-01   -1.254367651079092e-01   -4.185692299390024e-02   -1.579175394405148e-01   -2.566012651509605e-01   -1.233053678713599e-01   -2.294939067215881e-01; +2.147536979095239e-01   +4.564554316889823e-01   +9.821331321586584e-02   -1.208822288411463e-01   -2.194006740146244e-01   +7.603499957273838e-02   +4.073611186746660e-01   +5.379549932023668e-01   +5.306036385475494e-01];
L1_L4_iGABA_netcon = [+5.310466426250005e-01   -4.173060550937088e-01   -8.296488945669198e-02   +3.472878808002043e-01   -2.284913710807742e-01   +9.553398942486933e-03   +3.925092763002851e-01   +1.045800590209384e-01   -3.813913714023633e-01; +2.181262162381892e-02   +2.114678370663611e-01   +3.648814745060225e-01   -7.509443129997612e-02   +2.766004218834659e-01   +3.722493632570393e-01   +3.754752552926309e-01   +1.212654246970741e-01   -1.792111140330510e-01; -2.105072504825072e-01   +4.085619626119629e-01   -5.527066130578454e-01   -2.749153567268730e-01   +1.363364595260292e-01   +5.207224808488400e-02   +1.004639441169848e-01   -2.234530784987769e-01   -4.495643688052657e-02; -3.723527108995948e-02   +1.397580687060692e-01   -2.003736226771864e-01   +2.242925361711126e-02   +1.099183235110956e-01   +4.779724975055114e-02   -1.491820517706867e-01   -8.046644210468089e-02   +2.364866536869675e-02; -1.808522673566817e-01   +1.250498004090653e-01   +8.287600129852010e-02   -1.318935745984228e-01   -1.773066156509945e-01   -1.635703005581531e-01   +5.127783488394003e-02   +1.686285712666612e-01   +9.981172454631823e-02; +1.656386484289752e-01   +1.084798817090530e-01   -1.058334211637787e-01   +1.018223739987352e-01   +1.607463808662701e-02   +4.901564531103367e-01   -1.268900486980711e-01   +4.310199721465247e-01   +3.379206115229713e-02; +7.919163122017375e-03   +1.282008584119663e-01   -2.501108374157501e-01   +2.510830564073105e-01   +3.066376217415171e-01   +1.034249006284684e-01   +1.192726796867693e-01   +3.173712408275788e-01   +1.042598455470576e-01; +6.531799114012304e-02   -2.248823753166722e-01   +2.654212865657129e-01   +1.909564509189348e-01   +2.704591903754165e-01   +3.295792974106405e-01   +1.416894007586664e-01   +5.984693992950622e-02   +2.502013259705231e-01; -2.793764506640876e-01   +1.595094763362812e-01   +1.307423971898965e-01   -6.854508894032446e-02   -1.278118406324714e-01   +2.134334192879869e-01   +8.898503926803025e-02   +1.533823711288950e-01   +1.320309625310072e-01; -7.243825591622552e-02   +6.330107428661543e-01   +1.168566841047466e-01   +4.826640109765157e-02   +3.254062237331963e-01   +1.647080626881622e-01   -1.675802131649790e-02   +5.977218238066098e-02   -3.245021629249055e-02; -2.296507771679374e-02   +1.250002357839178e-01   +2.554372808397338e-02   -2.753195272163430e-02   +1.372812274100924e-02   -1.792218375022285e-01   -3.971066870904867e-01   +8.633291881487470e-02   +2.969548293617982e-01; +3.084479200306804e-01   -1.084785018056171e-01   +2.392337572998506e-01   +1.594540939997336e-01   +2.176842050809228e-01   -6.049782745448692e-02   +2.412633780644300e-01   -1.657729993206950e-01   +2.434783473408670e-01];
L4_L1_iAMPA_netcon = [+3.878715759788848e-01   +2.502755368924043e-01   +1.355509956834673e-01   -7.465928217934213e-02   +2.585173905816916e-01   +1.741793582163954e-01   +3.497502600220372e-01   +2.187653757275712e-01   +2.965713959822538e-02   +2.083991892431608e-01   -5.002742216529774e-01   +7.366406052505674e-02; -1.147071392054755e-01   +7.078525595229612e-02   -2.510999373648307e-01   +1.573929557510718e-01   +6.956290626425882e-01   +1.276619030744224e-01   -2.451122881596011e-01   -3.126652396400786e-01   +2.835396708081422e-02   +4.655195394691353e-01   -5.837112584125147e-02   -2.492947158938283e-01; -3.664374833810150e-01   +6.637093079289974e-02   +4.719933095453352e-01   -6.878734088193922e-03   -8.617425024744750e-02   +2.224871904681934e-01   +3.320611843571548e-01   -8.671173409609818e-02   +4.307400631093328e-02   +4.428606474629181e-01   +9.985576281270586e-03   +4.656371882049410e-01; +2.131952860217125e-01   +7.048164416592276e-02   +4.506981566777692e-01   +3.872763547232621e-01   +2.519974985262035e-01   +6.354849339730281e-03   -2.213117819002519e-02   +3.956771674020167e-01   +3.958310966866048e-01   -1.346152729386817e-01   +2.051200769499775e-01   +4.259264760660875e-02; +4.590239251004786e-01   -1.003663114185474e-01   -1.942367411981888e-01   +1.295986063150594e-01   +5.237896255256642e-01   +7.092592717906232e-02   +8.194734236723300e-02   +1.281318750714995e-01   +1.764684268752505e-01   -1.942886475210255e-01   -3.113019599440119e-02   -1.759353729806697e-01; +1.862814678091562e-01   +9.911578404476531e-02   +1.945664520193047e-02   -5.463762182656926e-02   +7.757581600645762e-02   -1.810110474697001e-01   +1.198287821300826e-01   -3.390539647450295e-01   +1.023044371183299e-01   +6.465070438543562e-01   +1.796783255421637e-02   -1.252848994341288e-01; -1.590361035051034e-01   +8.301191638638154e-02   +3.475961087281546e-01   +8.601797360285157e-02   +4.110829161815223e-02   +3.876663120681326e-02   +1.703072338259752e-01   -4.543911698676376e-02   +2.946011927448733e-01   +3.661744739482354e-01   -9.736449445515981e-02   -3.280339839547255e-01; +3.032922271494192e-01   +6.602374261159652e-02   -2.446424526096108e-01   -3.687524549713252e-01   -1.827830239844082e-01   +1.767875167845663e-02   +2.495405670654597e-01   -1.789626006795536e-01   -1.744638045352086e-01   -2.750879474186799e-03   +3.899039885139001e-01   +1.145991623302014e-01; -2.818583015132757e-02   -2.473850105319323e-01   +2.877289859428923e-01   +2.062239337193246e-01   +9.799576412633642e-03   -2.032663325148938e-01   +4.290989929759736e-01   +5.994977957562041e-02   -2.329537078983789e-01   +3.405419631536860e-01   +4.296768523906050e-01   -4.124229572037227e-02];
L1_L3_iAMPA_netcon = [+4.068051487637546e-02   -6.161871571484778e-02   +5.506234384386499e-02   +9.762760407492659e-02   +2.496265746760066e-01   -1.007850222467384e-01   -4.774025723734909e-01   +2.069411509342231e-01   +5.059592312413404e-02; +4.473673648590572e-01   +2.010452296840235e-01   +1.599589414700700e-01   +1.028283294973939e-01   -1.474381712846092e-01   -2.260134267996875e-01   +1.068071102351601e-01   -5.590124605548369e-02   +2.514858474837017e-01; +2.161527090005668e-01   +3.994240017100072e-01   -2.473202932586985e-02   -1.826201757010815e-01   -2.518686099153167e-02   +2.766295362150644e-01   +3.835501580928553e-01   +1.076535706448875e-01   +2.582714534039876e-01; +6.065579835605936e-02   -3.797328914787863e-02   +1.254317068383472e-02   -1.926958174602633e-01   +4.203350795689664e-02   +4.245434482624938e-01   -1.633786805324361e-02   +1.661240334026391e-01   +3.729650353662204e-01; +1.790002698538137e-01   +1.352081153041121e-01   -2.597624316417582e-01   +1.133845060395847e-01   +1.108893398710555e-01   +4.951129007114626e-02   -3.714961856789898e-01   -1.564876897799597e-01   +1.866166973838189e-01; -6.558763321126919e-02   +9.440957626751287e-02   +5.001697460731517e-01   +1.320097705421112e-01   +3.396840051080137e-01   +2.534198038689611e-01   +3.452124728249678e-01   +4.330073750919508e-01   +1.321058467265965e-01];
L3_L1_iGABA_netcon = [+2.097452874367032e-01   +1.899388152868229e-01   +3.177200926826446e-02   +1.784591260564379e-01   -1.872028335853610e-01   +1.639978671056096e-01; -1.054515277648564e-01   +1.594342355296963e-01   +2.886832685415535e-01   +4.244997178271818e-01   -2.093683638107233e-01   -3.245435234937385e-01; +4.846094844952561e-01   +2.048668881580860e-01   -2.423810469378444e-01   +4.291952014307922e-01   -2.532312015255060e-01   +1.978208437930186e-01; -4.070816738651505e-02   +1.154117045577481e-01   -3.026963937018373e-01   +6.151150533099578e-02   -6.387560324148994e-02   +1.290777331513060e-01; +2.361319631675759e-01   -1.213466291258850e-01   -3.867514439961079e-01   +2.297543143580891e-01   -1.480875949108619e-01   +5.504907842038468e-01; +4.629896551280610e-02   +1.939237345651640e-01   +1.877766502014775e-01   -1.807690352782741e-01   -2.669633775724993e-01   +1.333211365137813e-01; +1.124415961346342e-01   -1.996756070818866e-02   -5.325360717445967e-02   +7.663435984683387e-03   +3.332165279915284e-01   -3.987294314003373e-01; +1.338704291379632e-01   +3.423131805306576e-01   +5.304412316202542e-01   +1.162261505115375e-01   +9.004026143325281e-02   +8.672334656518380e-02; +1.765468779576616e-01   -5.938495790296744e-02   +3.570627854003186e-01   -1.484921644392992e-01   -7.229171233129592e-02   +2.156947937132112e-02];
L5_Input1_iAMPA_netcon = [+3.252761364094631e-02   +4.821332081544172e-03   +3.243608009678403e-01   -1.725159175289476e-01   -1.081173765575539e-01   -1.616607145093253e-01];
L6_Input2_iAMPA_netcon = [-5.818862175384029e-02   -6.356911577503313e-02   -5.974980779330158e-02   +9.843366463792122e-02   +2.429470454451337e-01   +5.036571307001958e-02];
L5_L6_iAMPA_netcon = [+3.580830282938622e-01   +2.558549675669741e-01   +3.115672105870804e-01   -1.483258347262214e-01   +1.880110086583834e-01   -3.849344725920772e-03; -1.679531628075858e-02   +3.951684987530802e-01   +2.780308502995661e-01   +4.615942210888537e-01   +1.013187988441081e-01   +2.261914189566296e-01; +1.495879711817165e-01   -1.864305753868464e-02   -9.106809407148340e-02   +1.341773765379531e-01   +3.161894114878478e-01   +3.584324365351597e-02; +2.331159204455520e-01   +1.564244754241233e-02   +5.008929866045515e-02   -1.889775273697702e-02   -1.171242814105045e-01   -1.585671724284610e-01; +2.549859256163736e-01   -1.951243041191537e-01   +2.849221343245197e-01   -2.420350482532666e-01   -2.484587135266264e-02   +7.572982734832451e-02; +3.014217881471437e-03   -1.495235454513089e-01   +1.572633467152047e-01   +5.387198689012307e-01   -2.950566585120521e-01   +3.028264993114282e-01];
L4_L5_iGABA_netcon = [+9.478420346649336e-02   -2.328678643836132e-01   +2.133208480979542e-01   +1.292494643516236e-01   +3.360580828887922e-01   -3.979191272886592e-02   -8.993506710775684e-02   +5.249286117311107e-01   +1.346556713002292e-01   +1.238772146510083e-01   +1.552155989340945e-01   -8.381991184375456e-02; +1.266225050759827e-01   +7.043297727384981e-02   +3.893686138061483e-01   +3.369120117517289e-01   +2.413769695025343e-01   +6.044112051061749e-01   -2.775045357849986e-01   -7.819578469454697e-02   +4.000518687604775e-01   -1.829020320104022e-01   -3.497443911267349e-01   -2.149398115112799e-01; +2.239096571412242e-01   +1.523424094771670e-01   -3.917802077139459e-02   +1.780775072510149e-01   +2.564097680093794e-01   +3.214521973589289e-02   +2.165097175104939e-01   +3.233380800423384e-01   -1.957307822221738e-01   -2.165250967396149e-01   -2.802672641035659e-01   +6.446766244707935e-02; +3.760980002616831e-01   +5.724487084344945e-02   +4.489868136597930e-01   +3.544270453965944e-01   -3.716703257301696e-02   +7.566980790005721e-01   -3.811200652524693e-02   +2.886380057547379e-02   +1.497104345218404e-01   -9.489583657992612e-02   +1.206135940300234e-01   +2.142993564670954e-01; -9.806100550654637e-02   +1.428007917664347e-01   -1.481600984311214e-01   -1.246714497740587e-01   +7.201619516866752e-02   -5.947032411549957e-02   -1.383665622566680e-01   +3.853809191925756e-02   -2.247632513679426e-01   +2.506924598334327e-01   +3.027745633486824e-01   +2.975926131446607e-01; -1.925380693280971e-01   +5.206957797894434e-01   +1.064711567858287e-01   +7.272922347244359e-02   -3.300424783597008e-01   +1.635866045980801e-01   -1.036882853462036e-01   +3.437278926620574e-03   +1.270013494403405e-01   +1.059837194054162e-01   +2.045519935707600e-01   -4.869583721907597e-02];
L6_L4_iAMPA_netcon = [+3.575698564628136e-01   +3.668090815860924e-01   -1.536376182885331e-01   -3.338547571434807e-01   -1.077892956842303e-01   -5.233674636947563e-02; -2.361232824226271e-01   -1.273397819350522e-01   +2.418157949703045e-01   +6.653944648659567e-01   -9.079891552358342e-02   +4.594797233382641e-02; +2.051851010698636e-01   -5.258955230913688e-02   +2.790868973289243e-02   +3.030373289736292e-01   +2.641517578511914e-02   -1.524397383268198e-01; +7.882356256057092e-02   -4.502098831603074e-03   +4.158196650653755e-01   +3.511855716578551e-01   -2.363439891538461e-01   -7.559265165108403e-02; -1.583235946919138e-01   +4.007627768229818e-01   -3.885698982684068e-01   +3.102828410904946e-01   +4.749471904970924e-01   -5.635811686804629e-02; +6.300756478113359e-02   -1.639858771129639e-01   -2.094248470720841e-01   -8.711497530242004e-02   -1.545353472655815e-01   -3.671572694947697e-02; -2.846966685099234e-01   -1.215418295429582e-01   +8.301111210293390e-02   -4.130306331712399e-01   +5.681701040675734e-01   +1.647215600480769e-02; +3.990983826097130e-01   +2.361143953927317e-01   +2.221801388551360e-01   +1.154901958399742e-01   -4.020090626057414e-02   -1.501961843834815e-01; -1.507688194974251e-01   +1.623592723632540e-01   +2.184899129626665e-01   +2.551552254023661e-01   +4.520671058902828e-01   -2.993295264689302e-02; +1.564520158922091e-01   +2.092092683610770e-01   -3.381522682782081e-01   +1.411082431448770e-01   +1.978732913128017e-01   -2.794496985096615e-01; -2.975629657379436e-01   -3.296585698074291e-02   +1.241540197438147e-01   +1.488664027072245e-01   +4.470175712911886e-01   +3.736113650884190e-01; +6.847686714611424e-02   -7.730614266114097e-02   +2.304513846525993e-01   -1.657646407561492e-01   +4.482954702710764e-01   -3.247694421941325e-02];
L5_L4_iAMPA_netcon = [+8.814560823641228e-02   -3.155878934089232e-01   +1.293702898477625e-01   -8.810918388338913e-02   -1.925663386324301e-01   -2.628520381755837e-01; -2.129739664135616e-01   +1.809345082359046e-01   +5.870043501206920e-02   +7.504396089071400e-02   -3.315295553378494e-02   +1.226129681178418e-01; +4.744579396755956e-02   +1.023828995649432e-01   -1.827839292977720e-01   +1.534656389972113e-01   -4.133593784816900e-02   -3.926732493443308e-01; +3.997378091818888e-01   -1.940049434508987e-01   +5.545813161008477e-02   +1.347309570463217e-01   +8.203248499264215e-02   +8.133948812448666e-02; -3.354267992608102e-01   +3.654917470847277e-02   +4.215593217884005e-01   +1.996449301162834e-01   +3.653961770013421e-01   -6.597178571959872e-02; -2.725501119905225e-01   +6.591133770731292e-02   +1.905807823359263e-01   -4.484280593539103e-02   +1.100236359668358e-01   -6.558599844634982e-02; -9.876952736419035e-02   +1.773315160809308e-01   +4.264252324509330e-03   +7.173978764303296e-02   +1.003034951488559e-01   -1.316805697602386e-01; -1.709021562356050e-01   -1.369909435690802e-01   +3.814674954852649e-01   -1.988643081370540e-01   -1.851851460737771e-01   +1.519885515267809e-01; -5.600514900034684e-02   -1.629751783686916e-01   -1.030801739873087e-01   +1.068566498629252e-01   -1.471086380233931e-01   -2.824130344875200e-01; -2.975053783554229e-01   -5.644119872634856e-03   +1.438541302445289e-01   +1.996931201848768e-01   -8.191606141109704e-02   +2.133899269321921e-01; -5.736655611101822e-02   +3.624448225585303e-01   +2.236074741681796e-01   +4.708108052732047e-01   -2.307857048543291e-01   +2.769118385360078e-01; +4.219285896851530e-01   +1.856533962103981e-01   +6.369579186742698e-01   +7.526172204530246e-02   +1.393222341459242e-01   -3.679743408734301e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
