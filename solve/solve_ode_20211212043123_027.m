function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.197325842064134e-02   +3.692693137104791e-02   +2.184922081058485e-01   -2.321793674555446e-01   -3.588587926669087e-01   +2.171107803368612e-01   -2.421053229913019e-01   +5.429774861085641e-01   +2.562183534748558e-02; +3.151073989128569e-01   +3.056410462551851e-02   -2.928402863100177e-01   -2.397248350157207e-01   +2.560434517669310e-01   -5.692754604430510e-01   -6.534000089350393e-02   -4.197618234279186e-01   +1.242167217057970e-01; -2.425580655766983e-01   +1.545743537767090e-01   -3.447493812099559e-01   -6.684513559284840e-01   +5.978521936973155e-01   +4.428856852408151e-01   +2.867960473408990e-01   +6.352484988849280e-01   -2.331538435574447e-01; -6.703798047329472e-01   -2.874799018641807e-01   -2.874278366730430e-01   -8.259009388543946e-02   -7.562393292268599e-04   -1.480300988943616e-01   -1.926051532273757e-01   +3.369875993833217e-01   +4.023491657235410e-01; -1.954060794900077e-01   +2.575460788758142e-01   -1.237267822933179e-01   -4.360583010090378e-02   -2.128163411884385e-01   +4.315581375601416e-01   -5.154965063670906e-02   +6.106287366584158e-01   +8.158200368263016e-01; -1.535875605034475e-01   -2.181364990193539e-01   +3.820182455469607e-01   +3.899945134188243e-01   -4.649923221412627e-01   -4.386696531211711e-01   +1.867111765259671e-01   +4.769553816237217e-01   +2.437523988773438e-02; +3.343160099116615e-01   -4.842568372623501e-02   +5.858531187949533e-01   +6.525028008997693e-01   +4.528542275860354e-01   -2.351851686965675e-01   -6.802261636141194e-01   +5.417757768516944e-01   -3.319495811811838e-02; -7.244155961647012e-01   -4.638147145385464e-01   +2.521551740644976e-01   +5.716140810785788e-01   +2.618097139290171e-02   +1.395884008072283e-01   +1.344036812795865e-02   -1.230930886005504e-01   +3.731693967987615e-02; +8.910073929512544e-02   -6.699780073564943e-01   -8.469418901616214e-02   +4.244971328489797e-02   +6.249319243533699e-01   -1.977052950986649e-01   +3.211091552999375e-01   -2.562526685321386e-01   +1.870740070195618e-01];
L1_L2_iAMPA_netcon = [+2.972013187691007e-02   -1.897907204885036e-01   -4.768088754504788e-01   +4.310815389735167e-01   +1.861006660411872e-01   +1.228440008177083e-01   -2.684284987289548e-01   -1.747059945660546e-02   -2.390860357069018e-02; -2.998046690643908e-01   +2.464803817936886e-01   +2.170196750326963e-01   +6.251859866685359e-01   +1.938870919968615e-02   -4.405276961455389e-03   +4.485460091202911e-01   +4.994356916204364e-01   -5.036372216610441e-02; +4.817531431632062e-02   +3.612164783166696e-01   -2.631162844810844e-01   +1.465866017214607e-01   -2.262196373468591e-01   -1.509662006815658e-01   +3.139576467235580e-01   -3.151867395304128e-01   +1.332953155770562e-01; +1.790663447979578e-01   +9.573344142720314e-02   -4.382340814451473e-01   +6.043249661555339e-01   +1.439015617382136e-01   +2.509851795748397e-01   -2.943231206126025e-01   +3.634760380183077e-01   +3.847938289224757e-01; +5.037917180362490e-01   -4.855725783899454e-01   +4.054408446288493e-02   -1.071362300061517e-02   -5.637893076870287e-01   -3.696605184066424e-01   -1.019947040596378e-01   -2.370454816704230e-02   -3.910615884714765e-01; +2.565906377538386e-02   -1.298731105130430e-01   +4.922653717935001e-01   +3.628688894259171e-01   +2.659605866942893e-01   +5.101272044336762e-02   -2.013043898919776e-01   +1.758187878749088e-01   -4.641443805633933e-02; +1.793013848820331e-01   +6.086472990172050e-01   -3.580951052325452e-01   +2.741226277036117e-01   +1.863347683913007e-01   +7.929479370722464e-02   +3.680275732668415e-02   +4.223768694329382e-01   +1.858098179462289e-01; +1.337809524669432e-01   +5.488716204461757e-01   -1.876965389710188e-01   +6.220935978392921e-02   -2.581709905088103e-01   -5.329326844306710e-02   -3.501860547110332e-01   +1.842791945474558e-01   -6.359276131685406e-03; -3.569425669774233e-01   +2.904616285867891e-01   +2.640042157333602e-01   +4.090549225164823e-01   -5.291819248574943e-02   -1.000000000000000e+00   -1.352658667430724e-01   +3.287500040582729e-01   +2.744237627211999e-01];
L2_L5_iAMPA_netcon = [-4.842029055482955e-01   +4.782267650721770e-01   +2.674205455627557e-01   -2.196104230198653e-01   -1.872806162544159e-01   +4.633806231350784e-01   -2.118099010736300e-01   -2.980254786950242e-01   +3.103997711762936e-01; -5.514680787931594e-01   -3.811107568891925e-02   +1.353008909930575e-02   +1.152175906072325e-02   -6.346982700289397e-02   +4.696193046439891e-01   +5.316516621868853e-01   +7.667030302132325e-01   +1.127670059326437e-01; +3.502965577429661e-02   +2.390105693701618e-02   -1.046857282484870e-01   +1.609779484962917e-01   -8.327502950791636e-01   +4.235627667642262e-01   +2.215727756850922e-01   -2.894791003175951e-01   +2.462558566292105e-01; +1.860621559311983e-01   +2.212147289229411e-01   -1.761758901838705e-01   +1.197633166964738e-01   -9.265672502731044e-02   +3.193111825002254e-01   +2.744052876263899e-01   +5.252637943763891e-01   -8.350916116636656e-02; +3.633365197624858e-01   +7.483614795713661e-01   +3.505887526886636e-01   -1.914787067035886e-01   -5.993423872267375e-02   +3.007680957927741e-01   +1.856731622520692e-01   -6.455969074706955e-01   -4.198500812206701e-01; +2.473262525137420e-01   +9.945927355458410e-02   +2.006699662710443e-01   +4.691241771370373e-01   -1.575620175367520e-01   -1.922906940517589e-01   +2.721388433342159e-01   -5.270578629513183e-01   -2.754430631820166e-01];
L5_L2_iGABA_netcon = [+1.357908105141330e-01   +1.902965383515025e-01   -1.566849060816663e-01   +8.706833677529657e-02   +3.514479550068328e-02   -2.526718316653405e-01; +8.679718307272578e-02   +2.039637050305010e-01   -9.441109575991363e-02   +2.820124347483790e-01   +4.269602605898671e-01   +3.798877040341914e-01; +3.368308112795089e-01   +7.958223732099676e-02   +2.398382954732303e-01   -5.541300316773389e-01   +4.204526735437479e-01   -2.188692760134130e-01; -4.106754968051979e-01   +3.456762975298655e-01   -4.311533033627902e-01   -5.170672994707953e-02   +5.667986569589215e-02   -4.064677926638959e-01; +2.342229620317965e-01   -1.000818297114875e-02   -5.620817984807351e-01   +2.092838667928503e-01   -4.078050106845938e-01   +1.565184259861469e-01; -3.818101434086842e-01   -6.085545149439893e-01   +1.191412017118572e-02   +2.194509332913463e-01   +1.563876509738271e-01   -2.112358173850979e-01; +2.855406679497988e-01   -9.447825598740921e-02   -3.084555393294508e-01   +7.252120298005363e-01   -2.526141759157637e-01   +5.809938212595698e-01; +5.225125543297772e-01   -2.596792904610074e-01   -6.439525443267580e-02   +2.139412576009520e-01   -2.985396220869205e-01   -1.539040997696258e-01; +3.341677858230584e-01   -3.085949958083670e-02   -5.908738952843667e-01   -4.922619877591518e-01   +1.212181329701630e-01   -7.919317507226367e-02];
L3_L2_iAMPA_netcon = [+3.866807724626147e-01   +1.216651523486273e-01   +2.713509970776846e-01   +2.583304274977657e-02   +7.287130538569270e-02   -5.271140049522876e-01; -1.078861337353657e-02   +1.476801495734946e-01   -3.439979323578685e-01   -7.967878400108281e-01   -1.423668090565345e-01   +1.153415182006462e-01; +1.596782827702957e-01   -4.804164933230874e-01   +4.121405526794266e-01   -3.521781547459379e-01   +5.273786414815126e-02   -1.384172014839675e-01; +5.916649248369541e-01   -2.078509102894920e-01   +5.612392912347314e-02   +1.867651457391124e-01   +2.296113638462684e-01   +3.610533587877574e-02; +1.225317340307905e-01   +5.923955695956986e-01   -1.803130424844719e-01   +2.962201643845438e-01   +3.867450400665935e-01   -1.893837638790671e-01; +2.416598695093874e-01   +4.188845547303474e-01   +4.769866056214697e-01   +4.211002169632613e-01   -1.737320729090961e-01   -7.192962501382151e-01; +6.135326075977220e-01   +2.651678093421154e-01   +3.744583065554593e-01   -3.797360260454635e-01   -5.172266048197148e-01   +4.004815685454233e-01; -4.057468956986375e-01   +2.290757218411532e-02   +5.916238702377062e-01   +2.849266889723722e-01   +4.664854859560533e-01   +2.047932206452183e-01; +4.776573437695249e-01   +1.328567284117517e-01   -3.427639115447746e-01   +2.347204491289738e-01   +2.516274632989862e-01   -1.550103690137304e-01];
L2_L3_iGABA_netcon = [+6.020429656639634e-01   +8.201964696680494e-02   +5.088252593202913e-01   +4.951936955833830e-01   +4.696211347808629e-02   -1.615707662263087e-01   +1.643761966925300e-01   -7.584674141359589e-01   +2.499043338098340e-01; +1.765969962423282e-01   +7.298928374674171e-01   +1.636806364463422e-01   -3.376382888681199e-01   +3.040276217406857e-01   +1.144208429608071e-01   +4.051261642332480e-01   +3.078386775900199e-02   +1.799096735726652e-01; -6.511301232563868e-02   +1.426730954527999e-02   +2.616001685446385e-01   -4.479551938807580e-02   +1.931690875683313e-01   +3.090515163568724e-02   -4.125229449752000e-01   +6.020399848454900e-01   +5.924068988422468e-01; +2.902925671948535e-01   +9.840544844942029e-02   +1.128092433393071e-02   +5.266856109090670e-02   -1.892406535530353e-01   +1.283590264672759e-01   -1.715350043919743e-01   +2.181362887970596e-01   +1.650282941763035e-01; +5.488253096963662e-01   -1.768100192390867e-01   +2.463564579086054e-01   +5.699764131381961e-01   -2.379703604647462e-01   -9.224719042147292e-03   -3.231563084167277e-01   +1.973081720899995e-01   -8.409392859976392e-02; +2.715465645414132e-01   -2.594631994162175e-01   +6.492057408276949e-01   +5.546180312938938e-02   -9.595507484035613e-02   -2.201212644928206e-01   +1.265573457894019e-01   -3.623439798210719e-01   -3.482234026468580e-01];
L1_L4_iGABA_netcon = [-7.580673129046807e-01   -4.261169333309019e-01   -4.087440052247178e-01   +2.462721208034052e-02   +3.834551129635607e-01   +7.436255843246523e-01   +5.976758798705522e-01   -1.894437309608245e-01   -2.782421965453402e-01; -3.895039821999188e-02   -8.220365738258728e-02   -2.140612945485188e-01   +9.815836037793951e-02   -6.580674809720104e-01   -1.819823591027345e-01   +2.629077656164115e-01   -1.340515902010423e-01   -2.480731849915001e-02; +3.764729574033756e-01   -1.324514128680809e-01   +4.090414642872745e-01   -9.972883711150440e-02   +3.816834556679373e-01   -4.717223458306445e-01   -2.629407477264200e-01   +5.406082579813374e-01   +3.497810787439461e-01; +3.985887421538851e-01   +1.829504405966546e-01   -3.897449980396969e-01   +4.310213910480609e-02   -1.535475526459750e-01   +6.269725798353547e-01   -1.353694871535191e-02   -2.570266378857577e-02   +3.367177930125959e-02; -3.236320539865066e-01   +7.223283464471347e-03   +6.684722365307043e-01   -2.212570462589269e-01   +2.901174894093211e-01   -2.325244670538282e-01   -1.154470850320267e-01   +9.770322336605741e-03   -6.766343796670662e-01; +1.022675863013065e-01   +3.585992686422516e-01   -9.024921645312486e-02   +1.299197107739724e-01   +4.024423563816108e-01   -3.266972858272585e-01   -3.124906331703203e-01   +1.550708392587562e-01   +5.252492022537215e-01; -1.220235764265072e-01   +2.494997541135411e-01   -1.161548437176803e-01   -3.118254969815891e-01   +5.020126901031475e-01   -2.670181002383251e-01   +2.987821033734494e-01   -6.118976922199912e-03   +1.460142928296424e-01; -1.664624466375658e-01   +4.378599790123856e-01   +5.097938718456037e-01   +3.540778581283998e-01   +1.777790310429214e-01   +6.159236071699759e-01   +2.712107694657229e-01   +2.276822656203180e-01   -2.904771962344149e-01; -8.206713734774312e-02   +1.378141506598235e-03   +1.305373732385546e-01   +6.077917757656621e-01   +1.068062215793548e-01   +1.380576353421746e-01   -2.037471248876415e-01   +2.752013536170795e-01   +4.093619463403896e-01; -4.471588230835454e-01   -1.647229426789060e-01   +1.226501611381553e-01   -6.536425764559298e-01   +2.513363041555726e-01   +1.508650223267931e-01   +5.827212246457030e-01   -3.671007880843576e-01   +3.358316292305771e-01; +3.832041082972879e-01   -5.575670219553299e-01   +4.130593458340240e-01   -2.037411634639469e-01   -7.409630014000168e-02   -5.845242220622132e-03   -1.450985163158583e-01   -4.732707225013114e-02   +1.052755071979221e-01; -1.489561786380491e-01   +1.515186393141875e-01   -9.915115062160502e-02   -2.769079911650429e-02   +2.450120218155498e-01   -1.179558116088532e-01   +3.663610615931502e-01   -7.598410494366845e-02   +1.894970987238960e-01];
L4_L1_iAMPA_netcon = [+3.235370189536418e-01   +2.091676147439717e-02   +2.130638130741694e-01   +2.369211091731626e-01   +6.585831284159842e-01   +5.021433535049222e-01   +1.602515174721115e-01   -2.108877453532457e-01   +3.003184512293841e-02   -3.625239053421128e-02   -1.341714281026548e-01   -4.375788922464356e-01; +9.120072094278647e-02   -5.094275896312641e-01   +7.849307838317093e-02   +2.385348967302303e-01   +1.880354433174395e-01   +1.972385839068325e-02   +4.231538715675158e-01   -5.011137435045965e-01   +6.309747268010593e-02   -5.770103494374141e-02   +9.794123602922264e-02   +1.419674435310432e-01; -1.410166040439747e-01   +2.313216948860942e-01   -1.000222279996567e-01   +5.716166215536078e-02   -3.876107199406451e-01   +8.340144682500664e-02   -8.187229977474000e-02   +2.444090436264369e-01   +2.970773080857987e-01   -5.897916711894610e-02   -3.573272462847523e-01   -2.606838563195398e-01; +6.074641374381187e-01   +3.389164775111140e-01   -1.858012894175322e-01   +9.108939046140867e-01   -2.411268008245727e-01   -7.091156115018771e-02   +1.623195097150743e-02   +6.186730061973387e-01   -4.856159581563008e-01   -5.149501385094697e-01   +2.311629761168227e-01   -7.042423346898843e-01; -3.681784687176956e-01   +4.222392526215608e-01   -1.050851225922216e-01   +4.178006355934873e-01   -3.666587601923739e-01   +1.943363273240613e-01   -1.707956526065229e-01   -4.068431945382749e-01   +7.434344767151935e-03   +5.455475461347004e-01   -1.691604574074114e-02   -4.049844415338412e-02; +1.057911644477125e-01   +1.951983561865528e-01   -1.512272767397061e-01   +4.593690012424752e-01   +3.109463032566869e-01   -1.442019292556635e-01   -1.283939490390347e-01   -2.527753946640057e-01   -1.530604246610638e-01   -1.008563224284614e-01   +3.422006924989694e-01   -5.475495704847888e-01; -5.289489248430040e-02   +4.159828650327688e-01   +1.463048625805482e-01   +1.264789836028872e-01   +5.148749521171953e-01   +4.365231618446471e-01   +4.200893492933526e-01   +9.346430101429879e-01   -8.023226636586334e-01   +5.879637188287518e-03   +4.915724693726190e-01   +1.246366011729857e-01; +8.178094663685137e-02   -1.408901297143601e-01   -5.055258898753759e-02   -1.823075821733809e-01   -2.643240625235417e-01   -2.997118107184087e-01   -1.433407817645386e-01   +1.499051795761357e-01   +1.356705360192585e-01   +1.303445216350928e-01   -5.522768534254151e-01   -4.924390073631562e-01; +1.948358005386948e-01   -4.168723768425402e-01   -2.156410694283672e-01   +2.409253042757827e-01   +2.956780533955726e-01   -4.315633558235359e-01   +2.684999739941042e-01   +4.020227527486299e-01   -5.386555600015943e-02   -4.484137916105205e-01   -5.615979438014279e-02   +1.571541469392372e-01];
L1_L3_iAMPA_netcon = [+1.176130955568043e-01   +1.509041932891232e-01   -1.824147680204212e-01   +2.857618873309724e-01   +1.115796524639035e-01   +1.616660011098738e-01   +6.967999002614786e-02   +6.191629876102677e-01   -8.177320541806166e-02; +1.579653790744152e-01   +5.921447491411358e-02   +3.800590872073292e-01   -5.206546223502777e-01   -5.490668863830778e-01   -1.075245085222600e-01   +1.296193761596900e-01   -3.726432898689840e-01   -3.629152932805039e-01; +1.245373364713567e-02   +5.549579588172332e-02   -1.154697606430849e-01   -5.974362956673854e-02   +4.729157123693855e-01   -7.105422741567833e-01   -8.220257741128893e-02   +1.326126873670699e-01   +1.388817517488211e-02; -1.512445586373836e-01   +5.562092137503407e-02   +2.517635298695631e-01   +3.008891905194804e-01   +2.227172139146313e-01   -2.361142276402067e-02   +2.729305143169818e-01   +4.517232185934381e-01   +2.868264798240554e-02; +8.260608873467427e-01   +4.525362974386882e-01   -2.259216957265516e-01   +3.473251684805715e-01   -3.934796597617248e-01   -1.676475574761392e-01   +7.456320003339525e-02   -2.172947718584113e-01   +2.111520997477275e-01; +7.989886147153213e-01   -6.177611935742391e-01   -6.951348439478966e-02   -3.695328422020866e-01   +3.286033922408879e-01   +3.538494421495706e-01   +5.988174021327772e-01   +4.586364121510221e-01   -6.614079176302372e-02];
L3_L1_iGABA_netcon = [-2.938483375183351e-01   -8.531050700593829e-02   -3.593992929816383e-01   -2.720250135301768e-01   -2.844070776954942e-01   -2.252168788408064e-01; -4.823365969198835e-01   +1.299448976167692e-01   -4.204982750320860e-01   -5.594821724801466e-01   -4.276508103082968e-01   +2.592138938679073e-01; -2.380068489584565e-01   +3.635259564449830e-01   +6.735522284845383e-02   -9.811623220969982e-02   +1.685014693064479e-01   +4.780189266832597e-01; -3.930898958968654e-02   +4.287279197512107e-01   -2.859284330085140e-01   -1.355298243157916e-01   +2.949466621582045e-01   +4.265727951040691e-01; +1.322548481885260e-01   -2.662897938382724e-02   +2.356081493831466e-01   -1.246134431138791e-01   -2.804140021523573e-01   +6.174895808910259e-01; +1.730681074625038e-01   +4.361078155113127e-02   +4.132121106403683e-01   +2.077847582614361e-01   -1.985319985172128e-01   +2.160756906986818e-01; -2.872351459899932e-01   -2.598186076071426e-02   +3.880633617327454e-01   +5.649205361905072e-01   -1.770780453927807e-01   -3.024571046301361e-01; +1.403655832110217e-01   -2.884320877076136e-01   +6.616767503138504e-01   -1.755005611797634e-01   -4.434724373758194e-01   +5.499573801171953e-02; +6.583954076813714e-01   -3.576761176359557e-01   +4.054087043000379e-01   -3.363326780046251e-01   -4.985293335478426e-01   -1.793443733545268e-02];
L5_Input1_iAMPA_netcon = [-4.438932385748301e-03   -2.174533531776296e-03   +2.176912285035656e-01   +3.242340838069464e-01   +2.522657066045665e-01   -1.690568586184836e-01];
L6_Input2_iAMPA_netcon = [+2.562399575654167e-01   +1.057881326214246e-01   -4.165039361750039e-01   +5.956107840649395e-01   -5.696354507260962e-01   +3.540516462506332e-01];
L5_L6_iAMPA_netcon = [+1.237549962598546e-01   +2.640868260188722e-02   +9.716427218128021e-02   +1.539325701226610e-01   -4.791624102379372e-01   +7.380605666559784e-02; +5.337141852185434e-02   -2.765223408691378e-01   +5.119765813789919e-01   +7.017108324408837e-02   +3.149292029604947e-01   -6.848206357570590e-01; -5.350478189791320e-02   -3.919175376879366e-02   +3.846941324688191e-01   +7.306040848880986e-01   +3.340314922529227e-01   +2.425318024797768e-02; +9.106314976822821e-02   +4.649867795028449e-01   -5.414919143320769e-02   -2.569580994863060e-01   -1.428344100289983e-01   +3.154888512103666e-01; +1.934599077472238e-01   -4.324754069259060e-01   +1.416795874740362e-01   +4.185916641240240e-01   -5.002641683302552e-01   +4.176286671940628e-01; +8.262312858075711e-02   +7.137926998933092e-01   -1.540768632599729e-01   +4.323338293714993e-02   +4.257977588102759e-01   -3.925015481543551e-01];
L4_L5_iGABA_netcon = [-7.017940879173844e-01   +2.607191391866727e-01   +1.373476684747523e-01   +4.026540416515896e-01   -2.468423366989911e-01   +2.744574138065748e-01   -2.919973820697334e-01   -3.695976369552857e-01   +4.572358810747819e-01   +5.498021484693171e-01   +2.578810558188999e-01   +1.908970740313683e-01; +4.534953606058635e-01   +6.440622879880572e-01   +6.076948420008486e-01   -3.032162905357196e-01   +3.701974439619213e-01   +1.779706296905783e-01   +3.845519522274777e-01   +7.028221135118846e-02   -2.648668788647801e-02   -1.529483766278267e-01   +1.970059178916655e-01   -2.542982302976281e-01; -4.370256687644042e-03   -4.361037275456181e-01   +2.107079266541197e-01   -1.874508636284439e-01   -3.173020123765133e-01   -1.685059501387687e-01   +4.183819907069611e-01   +2.241880713802713e-01   +1.857103283928556e-01   +3.060840240510459e-01   -2.658875278126499e-01   +2.315555068897396e-02; -5.098258269815510e-01   +1.150305657166128e-01   -1.648082393356243e-01   -2.787781899320916e-01   +4.413655853150096e-01   +6.277820752534891e-01   +5.578613565348431e-02   -1.066241454121969e-01   -1.776799241604319e-01   +7.087904805579681e-02   +7.494926611921182e-01   +1.505184327738139e-01; +2.428704719607074e-01   -3.321445003093775e-01   +3.130772414719640e-02   +3.016401419867947e-01   +1.627615760483160e-01   +1.862495342497270e-01   +1.082045802275513e-01   -9.384548348333388e-02   -9.736652254276366e-02   +1.577996901110998e-01   +4.260049140475106e-01   +1.627127033715593e-01; +4.204343073723094e-01   +9.970893873935964e-02   -6.931298665057790e-01   -8.137986894307774e-01   -1.122636037762931e-01   +4.246676734839387e-01   -5.213539805962841e-03   +4.765466719640225e-01   +3.631315287951739e-01   -3.725104093878497e-01   +3.709304724494532e-01   +1.949552072919678e-01];
L6_L4_iAMPA_netcon = [+1.482294298838309e-01   -4.028800102038755e-02   -2.765539496985552e-02   +1.051163967761570e-01   -3.635418356589793e-02   +2.394059998370335e-01; -1.713226940607369e-01   -1.010264077703269e-01   -9.301802315244855e-02   +3.494442498188048e-01   +2.502914207789814e-01   +5.071869084935937e-01; -2.805576862082945e-02   -6.311458937726157e-01   -5.277643206883872e-01   -4.991767923478381e-01   +2.074557254070183e-01   +1.344331134490915e-01; +5.757301215432195e-01   +2.326758868729936e-02   -2.088150385851668e-01   -4.449561977787028e-01   +8.083971464064697e-02   +1.000000000000000e+00; -4.816299639466510e-02   +5.997002824627988e-01   +1.365948553615208e-01   +4.999578146307355e-01   -1.623095821187047e-01   +2.542514999480040e-02; -2.376557995113653e-01   +6.536226670468946e-01   -2.999919911618400e-01   +5.253170242624840e-02   +1.204246275789896e-02   -1.440627037959293e-01; +2.417098323181625e-01   -2.466249538259433e-01   -3.626047326912681e-01   +1.735687859996091e-01   -4.162919412908895e-01   -6.406702043211379e-02; +3.471318242321739e-01   +1.377172851814052e-01   +3.904702918524300e-01   -1.379224679781796e-01   +1.568614358384530e-01   -3.938330783132812e-01; +1.022209171001674e-02   +3.228907467151317e-01   +1.428042397615984e-01   +6.846368215832666e-01   +1.911607653709273e-02   -2.554431058425224e-01; -4.944601202822658e-01   -1.415790179525820e-01   -1.280120091858133e-01   +8.658496308234218e-02   +3.469750215936775e-01   -3.068040173082929e-01; +3.466701080486900e-01   -2.188951511113025e-01   -1.638061925364594e-02   -3.657279821769007e-02   +3.740084542963120e-01   -1.755145127769162e-01; +8.679564692992857e-01   +3.104380386557398e-01   +2.557375141920358e-01   +6.932654773494829e-02   -2.298602097708412e-01   -2.068170894134284e-02];
L5_L4_iAMPA_netcon = [-3.567490149409786e-01   -2.842140012911224e-01   -2.505655121851922e-01   -2.112335415270210e-01   +1.854268869573066e-01   +6.133931772179357e-03; +6.187573929891104e-01   -5.388632125608911e-01   -1.295605808112247e-01   -2.980572216229084e-01   +1.349925676786791e-01   +3.298964634060797e-01; +2.168647293533533e-01   -7.038212490045706e-02   +3.236350128220996e-01   -7.118378379350700e-02   -1.206845534159975e-01   -3.371400276368350e-02; -9.138399649520870e-02   +4.691104198534624e-02   +1.328001619250234e-01   +5.456293879121624e-01   +2.883916447586211e-01   -1.655159355896350e-01; +9.286860901189559e-02   +7.978122593975654e-01   +4.677829869158618e-01   +2.586615547219425e-01   +4.810094510033069e-03   -2.679563235720976e-01; +2.864538096449376e-01   -2.135677977462775e-01   +2.925308750900723e-01   -2.204759612578884e-01   -3.262541705733237e-01   -1.217428308133817e-01; +1.584860166278959e-01   +6.271172395552002e-02   +3.461539728212603e-01   -2.910994836776659e-01   +5.636182283493912e-02   +2.847571915288537e-01; +3.645690270515286e-01   +1.720683208982565e-01   +4.083965788355937e-01   +1.693604422027249e-01   -4.319434085768858e-01   +2.477767476187178e-01; +9.718926334619982e-02   +4.967590471327470e-01   -2.216850128874902e-01   -6.154268349055589e-02   -3.484429180840030e-01   -3.831680750168071e-03; +3.079495353520282e-01   +3.058464623480318e-01   -4.418774507379994e-01   -9.651223112086260e-02   -7.829313091495524e-02   -4.817293829445763e-01; -3.383374132930781e-01   -7.480980215106168e-01   +1.194071009209514e-01   +8.427305681871999e-03   -4.474989661420486e-01   -1.642492824193935e-01; +2.815725267695930e-01   -2.940697156572069e-01   +2.753178926192741e-01   -1.245712439756362e-01   -1.210895347085629e-01   +4.179001109915790e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
