function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+9.065470393084509e-01   +7.980291806444162e-02   +5.493406054333250e-01   +1.235658286340317e-01   -4.851395711298400e-01   +6.850989494187083e-01   -7.363397709436563e-01   -3.819304817872051e-01   -4.330321869548767e-01; -2.060493194187373e-01   -3.631244619757473e-01   -8.220761117890725e-01   -7.337764801644523e-01   -8.689661688594111e-01   +4.910904917327753e-02   -9.230163950097963e-01   -3.010916703023089e-01   -1.221960463592313e-01; +1.446086306241653e-01   +1.307792754054395e-01   -4.088172700168937e-01   +7.949026495993949e-02   -7.619935744386630e-01   -2.042031413856192e-01   +1.007038026685940e-01   +7.451898373945730e-02   -4.391446753956451e-01; +2.783731482308593e-01   -3.420470312024793e-01   -9.096559144236193e-01   +2.582116874988423e-01   -6.860181312271275e-01   -6.488479148771816e-01   -6.133411929661176e-01   +5.605092094246935e-01   -3.485346742023849e-01; -1.212740955864770e-01   +8.597232513638887e-01   +5.048034850997514e-01   +3.503378170957348e-01   -4.195456946956523e-01   -7.574103089149899e-01   -4.022746161829691e-01   +6.664630664737936e-02   -9.038899474529094e-01; -6.612745479103972e-01   +4.467475218184751e-01   +5.552816610365132e-01   -2.733925934531548e-02   -4.052085948735260e-02   +1.518762623377849e-01   +1.155322939591526e-01   +3.980246886682994e-01   -8.344985964006940e-02; -5.543245612935573e-01   -6.594467679713817e-01   +1.149156650867635e-01   -4.836260535843510e-01   +8.839460168224965e-02   +2.927612033537224e-02   -4.734534769717599e-01   -7.118577059286261e-01   -8.487744095113631e-02; +4.168043815867697e-01   -4.764876323369359e-02   -7.089840989908432e-01   +4.484857690602335e-01   +4.210576608072701e-01   -3.709983426786775e-01   -6.223335253724637e-01   -4.121171277038420e-01   -4.254599447066870e-02; +7.443807538099776e-01   -6.730338126410463e-01   +8.907442660955538e-01   +6.101193182870495e-01   -3.804870722217115e-01   -1.000000000000000e+00   -8.015285981466741e-02   +1.816217726481709e-01   -4.312433549371616e-01];
L1_L2_iAMPA_netcon = [+5.835490180442369e-01   -5.429853348512061e-01   +8.339770712682090e-01   -7.296175250959182e-02   +8.129438453697512e-01   +5.861039893945740e-01   +3.381182696126941e-01   -5.137704336119726e-01   -8.050103388139056e-01; -2.875826289525578e-01   +1.000000000000000e+00   +3.899327377240293e-01   -3.203433473725535e-01   +5.667166184619379e-01   +8.393114673719181e-01   -3.327473255521258e-01   +8.657458121963226e-01   -2.930237163978426e-01; +5.387640155456276e-01   -2.206686029058617e-01   +3.776888929186736e-01   +5.521617303144482e-01   -7.492604344545353e-01   -1.181567000802326e-01   +1.946563241264497e-01   -7.820241519280982e-01   +5.444203513151206e-01; +4.033867881394877e-01   -1.687551255891908e-01   -4.765883331868103e-01   +2.602615138599813e-01   -5.738033195779729e-01   -8.914227187805511e-01   -6.540740507089959e-02   -5.526606218466137e-01   -3.190509907150728e-02; +5.871184573187376e-01   -1.528532368313306e-01   -9.885211011290458e-02   +1.216374683087425e-02   +3.724255845294479e-01   -4.234211743359623e-01   +4.370636646845324e-01   -5.611268714900355e-03   +7.359719676078842e-02; -7.850837520596321e-01   -6.068008040823888e-01   +7.915601146064387e-01   -7.601153102316441e-01   +2.012793490019053e-01   -5.302683932441675e-01   -5.992779446776118e-01   -3.456765716701929e-01   -6.976908967024559e-01; +2.723100917557776e-01   +3.171314527526750e-01   +2.841455478321709e-01   +4.009851390414217e-01   +6.876649424991107e-01   +6.757727892947126e-01   -5.120204609655303e-01   -5.496913194224871e-01   +7.680640784236938e-01; -5.372115485962577e-01   -4.525974485425740e-01   -3.194031034059452e-02   -3.386487659513477e-01   -1.263858940342128e-01   -5.566130311755985e-03   -5.239085861041710e-01   -3.814311515121642e-02   +3.603133284393310e-02; +3.544281657651921e-01   +2.263254496149337e-01   +5.207053819577239e-01   +2.755648590775768e-01   +5.402461934941287e-01   -3.532692665418904e-01   +5.881612509535336e-01   -7.255263261374093e-01   +1.282454369206312e-01];
L2_L5_iAMPA_netcon = [+6.828690156570415e-02   -7.266559490430625e-01   -3.913762618967567e-01   -9.037231980617005e-01   -1.262780206094917e-01   -1.145539898440136e-01   +1.150936680307556e-01   -4.003785538847409e-01   -7.347013459479991e-01; +5.983512251953914e-01   -9.491599747475624e-01   +7.374828180796299e-01   +3.996787055181747e-01   +7.324254125976406e-01   -4.605889183117132e-01   -4.221455352495619e-01   +4.245741398935814e-01   +6.910172298647937e-02; +9.752115830483478e-01   -4.221357120503280e-01   -6.840450118296539e-02   +9.561469681568855e-01   -1.000000000000000e+00   +1.767553055676673e-01   -5.695372694801220e-01   -7.522439553372495e-02   +7.389928118713400e-01; -1.787345701270001e-01   +2.435853011996891e-01   -6.287210649948823e-01   +4.985564310051992e-01   -1.838588838893148e-01   -5.743487992140668e-01   +9.713215830490632e-01   +8.492758662983550e-02   +9.286320153584326e-02; +3.607125088194745e-01   -1.817585732809614e-01   +8.844363824504193e-01   +3.715988492729863e-01   +5.340076109226536e-02   +4.783745852833962e-01   -8.223411054080514e-01   +6.138393063666722e-01   +8.418902155892030e-01; -6.355542084032034e-01   +4.929731232197085e-01   -8.082119472615472e-01   -6.729295839745234e-01   +5.155421654625943e-01   -5.305179429448325e-01   +3.842058342105507e-01   -3.770121659819801e-01   -9.524669491679130e-02];
L5_L2_iGABA_netcon = [+7.634282976543234e-01   -2.807937193064367e-01   -6.536321343699456e-01   -8.933678761310429e-02   +6.196726595409126e-01   +3.139155083356073e-01; -8.903581470467881e-01   +8.248694793865230e-01   -6.940449060879778e-01   -2.914455242050856e-01   +7.588878101426223e-01   +9.116579936956003e-01; -4.969810845171470e-01   +3.830812706714662e-01   +1.176170435912964e-01   -3.063566443701272e-01   +5.009321690975006e-02   -1.896914583017049e-01; -8.005875352025954e-01   -3.996578761379246e-01   +1.617284293086974e-01   -5.182414825328181e-01   -4.608790853306201e-01   +7.793160713071257e-01; +8.533080413478261e-01   -9.650859881579206e-02   -3.002071011548323e-01   +5.055920181878860e-01   -3.711909224484664e-01   -6.381467657027415e-01; -1.553678075356852e-01   -7.479948940728768e-01   +8.490667992093619e-03   -9.510914997893638e-01   -2.860540420241549e-01   -7.260532047096009e-01; -6.424621497199883e-01   -2.093212524741846e-01   +8.988932877572269e-01   -6.799013298258522e-01   -8.076851742263318e-01   -4.575179646066157e-01; -7.083094325460801e-02   -7.646423093594139e-01   +2.803936216041369e-01   -8.292244128395756e-01   +2.447487300010912e-01   -7.340243299847785e-01; +8.325630566738836e-01   -4.497497697424437e-01   -3.237198263438382e-01   +6.569926395693794e-01   +2.183952205104686e-01   -1.000000000000000e+00];
L3_L2_iAMPA_netcon = [-1.864491689896750e-01   -7.579870997211753e-01   -6.446964294287209e-01   +9.498343818429452e-01   +1.248198799226277e-01   -1.635569754734181e-01; +7.481029639765497e-01   -3.275333797021160e-01   +5.760399762054009e-01   -6.909927786849459e-01   +8.570025997927049e-01   -9.872704999306808e-01; +2.388058588562924e-02   +2.867870892922408e-01   +4.328993991327332e-01   +3.225484391659648e-01   -7.436026271597980e-01   +1.702337041271628e-01; -2.855021467504838e-01   +5.463540714490270e-01   +5.374472225314525e-01   -5.901445334570943e-02   +7.917446144423952e-01   +4.328681254626632e-01; +6.394300916054000e-01   +5.381809471528821e-01   +6.459874550668684e-01   -9.288116311977100e-01   +2.469348804616041e-01   -7.320512389562035e-01; -7.994763326430505e-01   -5.289000139223577e-01   +4.083784383168291e-01   +1.610314594872435e-01   -7.100727243526627e-01   +5.418231950056717e-01; +7.222188977286153e-01   -1.989277416781816e-01   +5.193599462809665e-01   -2.845882385677145e-01   +4.782528288941120e-01   -7.755152017104348e-01; +8.338261646741205e-01   +1.000000000000000e+00   +7.937443812096489e-01   +4.967212821835326e-01   -7.318661803388385e-01   +8.132465964471175e-01; +3.565215961130025e-01   -9.979080114241254e-01   +2.921177278795058e-01   +5.776647824208760e-03   -6.563063579584179e-01   -1.860330881243466e-02];
L2_L3_iGABA_netcon = [+1.622808281156390e-01   +5.421455883430045e-01   +9.842089909643227e-01   -3.773805215196147e-01   +1.665449401946593e-01   +9.168408931243485e-01   -8.917978310104246e-01   +9.254046960810629e-03   +3.856540482865753e-01; -1.148610701181589e-01   +6.688100623313074e-01   +5.809114608982129e-01   +2.673475968861543e-01   +8.315657469563124e-01   -5.976407568826678e-01   +7.474302859375384e-01   +6.974502088410509e-01   +6.156955796141338e-01; -6.873353831896771e-01   -1.878341767066790e-01   +8.132603491107532e-01   -5.112044166379917e-01   +5.877655389254153e-01   -5.339318557450734e-01   -6.809671713492736e-01   +5.431039025510669e-01   -6.976534344084726e-01; -3.790113227972992e-01   -3.522751296440551e-01   -5.557430029485375e-02   +7.819599703493080e-01   -7.668872898024880e-01   +1.683958062925071e-01   -7.160575427638948e-01   +1.000000000000000e+00   -9.778944874205701e-01; -2.986490731460961e-01   -8.223935401412772e-01   +1.734048932724858e-01   +5.508042101717983e-01   -3.877775688280826e-01   -3.857620624296272e-01   +7.027284245404073e-01   +1.899471711061015e-01   +8.284405380480527e-01; +9.148771785350214e-01   -2.687376461333020e-01   -7.198716958828257e-01   -1.120222510111810e-01   +6.574340414709353e-01   +1.332184511481919e-01   +3.732629256717795e-01   +1.601152933124584e-01   -4.436775760048906e-01];
L1_L4_iGABA_netcon = [-5.780271087827211e-01   +7.545238054592532e-01   -7.804405200791766e-01   +3.145029516097709e-01   +1.342537254321221e-01   +9.475669941204566e-01   -4.657322662427310e-01   -6.957877111938523e-01   -6.745954783209624e-01; +5.255141732341140e-01   +4.538604851049386e-01   -6.159279809448927e-01   -7.255628310517712e-01   +4.170870577836941e-01   -1.739494186463937e-01   -3.780222183585866e-01   -2.095102073787174e-01   +1.696254588638031e-01; +7.151168873670350e-01   -3.653253108727104e-01   -5.257766285585279e-01   -8.853495943161851e-01   +8.937952245317647e-01   +2.585438341959819e-01   -1.481426187552708e-01   -5.483471046001429e-01   +5.699857932811645e-01; +7.017363146761005e-02   -5.313794214898011e-01   +8.006030846545189e-01   +4.472056225795821e-01   +8.412936610470864e-01   -9.876687486243005e-01   +7.410008744820727e-01   -4.621625079801400e-01   -5.014421869489581e-01; +4.265786131240584e-01   -4.368682137881804e-01   +5.394340337818145e-01   +6.615019757404865e-01   -8.607933117990821e-01   -5.038762094156245e-01   +9.547783960320245e-01   +6.671709275269441e-02   -2.076586450378298e-01; +8.293982056625373e-01   -1.911424619477051e-01   -7.908340636217105e-01   -6.837191085785045e-01   +7.335872323618196e-02   +9.541973612732317e-01   +2.309381226891916e-01   -6.686154946913612e-01   -3.184546701484129e-01; -5.600023476515567e-01   +1.000000000000000e+00   -2.191408217992966e-01   -5.411687679814849e-02   +1.223004417746243e-01   +8.248861666728997e-01   -1.608238220358127e-02   +1.940946213239529e-01   +3.033281135919778e-01; -8.268657897686690e-01   +1.383677622805783e-02   -2.188986094446013e-01   +4.559520442289426e-01   -4.164921476365868e-01   +1.257990313401636e-01   -3.951018508255341e-01   +3.013453038034103e-01   -2.623271188459648e-01; +4.287554282836736e-01   +2.608951688954307e-01   -3.832498774542294e-01   +1.541734925479322e-01   +9.635765700940224e-01   -7.660672156653326e-01   -2.173225592062160e-01   +2.190269570345719e-01   -9.491978192926772e-01; +9.147449755615529e-01   -3.675400980013425e-01   -1.235982287438065e-01   -9.076194356552211e-01   -9.152056245013167e-01   +1.976334247694635e-01   -8.398109175328496e-01   -1.364360025420231e-01   +1.182498880045637e-02; -7.912664391460638e-01   +6.262846653506648e-01   -2.949612844176505e-01   -6.866118819816549e-01   +9.965303402625650e-01   +3.493618897606754e-01   -9.025071871596359e-02   +2.764505725050439e-01   -5.828291463090919e-01; -3.771159455341763e-01   -6.828626921438626e-01   -1.476580726300810e-01   -2.588163897518083e-01   +2.894483960330096e-01   -3.426625758742254e-01   +3.837719022650552e-01   +4.630289663249471e-01   -7.197991169930190e-02];
L4_L1_iAMPA_netcon = [-4.498254926974348e-01   +7.279352167061663e-02   +2.223107087828629e-02   -7.915660761130314e-01   +4.692080851296557e-01   -4.448901665612792e-01   -7.770858983871448e-01   -6.737866142994366e-01   -4.671881082758905e-01   -4.390043221510976e-01   +5.375064657519878e-01   -8.722760065937000e-01; -7.944883427133453e-01   -3.784116165608394e-01   -2.804570545678982e-01   +6.772156903375420e-01   +9.149636579352060e-01   -5.508553920028082e-02   +8.143856387720526e-02   +2.523653380468152e-01   +5.706121918778172e-01   +3.147245100166715e-01   +7.372834380996099e-01   +8.044726281372070e-01; -5.266083187489561e-01   +7.408423979773573e-02   +6.061910459777839e-01   +6.106708383071058e-01   -6.190035085305692e-01   -9.597365121143682e-03   -4.738096358973148e-01   +5.873028315018556e-01   +6.226831117971040e-02   +9.005338379384419e-01   -6.394739182011846e-01   +3.405597015770797e-03; -1.346510369862978e-01   +4.186720528737896e-01   -3.715831797441506e-01   +1.735213722832150e-01   -4.838561124991568e-01   +1.127376061734175e-02   -3.362157735714240e-01   -8.316972990725481e-01   +5.338710786488481e-01   +3.069264302481055e-01   -5.101715467478655e-01   +5.486571614035873e-01; -7.330833413242785e-01   -1.000000000000000e+00   +4.287171917652029e-01   -5.675697959944774e-01   +3.695384325210080e-01   +2.026089572101145e-01   +3.126344375705029e-01   +1.950418576433932e-01   -6.807865707680328e-01   +1.257173018855079e-01   -6.803757041871387e-01   -1.190882984815574e-01; -2.427795404328938e-01   -2.872804109165562e-01   +7.933971101785088e-01   -2.299742850463246e-02   +8.023598761100638e-01   +2.344188186387707e-01   -3.696892296941625e-01   +1.805840697032139e-01   -6.922266249270762e-01   +2.892035807411511e-02   +4.210585830058729e-01   +1.147343007071185e-01; +1.915103769366475e-01   -2.144209431033657e-01   -9.104794130186917e-01   -5.667341703390480e-01   +6.123480151549916e-02   +9.556779632195015e-01   -5.832129204338717e-01   +1.493738350845430e-02   -7.900359972818665e-03   +7.968020630821254e-01   -8.276873624603028e-01   +4.220926846758921e-01; -6.007570009482908e-01   -4.309844038208189e-01   +3.567827880626647e-01   -5.844202308965606e-01   +3.931485976740537e-01   -9.939313105851695e-02   +3.231917593174032e-01   +8.269748850008640e-01   -4.945328195187301e-01   +5.519741078624744e-01   +8.373649025465312e-01   -1.338069110802410e-01; -5.922378213426915e-01   +9.607914702387594e-01   -2.674535586837234e-01   +7.103332506173026e-01   +3.476549398592267e-01   -5.763862815828720e-02   -2.866784024993061e-01   +1.278066175026340e-01   +3.517741059731720e-02   +5.344802059769826e-01   +5.232067868637376e-01   -4.766168221665002e-01];
L1_L3_iAMPA_netcon = [-6.552589271258287e-01   -3.207900818370165e-01   -8.000820534537409e-01   +1.875145663443164e-01   -1.488303466665311e-02   -4.040604326507172e-01   -9.857964218867674e-01   +4.924315597612873e-01   -8.738757520675653e-01; +5.415576812889392e-01   +6.771969182080229e-01   -7.043310370343820e-01   -6.390331626375848e-01   -8.791444101513705e-01   +7.827604044604608e-01   +6.792397361756044e-01   +3.995344140831563e-01   +2.312744124103155e-01; +1.880877638779511e-01   +4.561913623867051e-01   +2.469802129189552e-02   -2.085710238155641e-01   -1.649673956671871e-01   +1.000000000000000e+00   +4.920807427730005e-01   -6.476236224294890e-01   +7.918638207278640e-01; +7.088643385337331e-01   +6.246059557374339e-01   +2.101132263103598e-01   +8.888169924213660e-01   -7.123671119288078e-01   +1.391730922199836e-01   -1.922001583387044e-01   -4.791541564069354e-01   +2.656141463162864e-01; +3.014287519400451e-01   +1.524775107232371e-01   -3.657689782222328e-01   -1.096498957313496e-01   -1.238634131513099e-01   -4.643717449851725e-02   +7.155237231107620e-01   -8.279802738637922e-01   -8.671718216158957e-01; +7.412313678675079e-01   +4.762736084051003e-01   -9.793243179793254e-02   -3.603163195149541e-03   +7.563832987978495e-01   -6.595554183227029e-01   +1.276991106140495e-01   -7.699467260908952e-01   -7.697688337599661e-01];
L3_L1_iGABA_netcon = [-1.258775245689641e-01   +1.536903254616774e-01   +4.118332339102736e-01   +5.355813453843611e-01   -1.863806702524762e-01   +1.035813797630834e-01; +4.539769258779190e-01   -1.718016342389860e-01   +4.548794494311619e-02   +2.690615803983776e-01   -7.017033324241412e-01   -1.858419522553865e-01; +7.540062675007668e-01   -8.269674122378634e-01   -1.909970195924929e-01   +1.592682831361008e-02   +7.031473132359120e-01   -2.355715688169261e-01; +5.245997766148117e-01   -6.917051239703805e-01   +5.115850186088808e-01   -5.917996964680852e-01   +9.592113913247534e-01   -8.490398358688080e-01; +6.288307004116690e-01   +4.344283391831559e-01   -6.048794701787760e-01   +5.003197462123502e-01   +8.310760721008870e-01   +4.098822160054051e-01; -8.845325374505604e-01   -8.040778428575356e-01   -3.540282051887917e-01   -3.242417966497874e-02   +4.741081281768579e-01   -4.221574302757265e-01; -8.911678295995521e-01   -7.513746844419539e-02   +1.304949804041954e-01   +1.000000000000000e+00   +5.046916124093245e-01   -1.608332379166411e-02; -8.971650167052544e-01   -2.283018156662557e-01   -6.475247463869637e-03   +8.968013755624710e-01   +2.944109025185883e-01   +8.075237915515716e-01; +5.612031488912130e-01   +2.596507039139977e-01   -1.148893898531791e-01   +2.238939036208448e-01   -6.453256227170602e-01   +1.354143599185193e-01];
L5_Input1_iAMPA_netcon = [+7.334391938577526e-01   -1.000000000000000e+00   +6.361843328734823e-02   -6.569157278943677e-02   -8.364725630733297e-01   -7.306931187128883e-01];
L6_Input2_iAMPA_netcon = [+3.715115190558737e-01   -1.000000000000000e+00   -2.285493868971667e-01   -3.105707207462587e-01   +4.122135504818331e-01   -1.022623448122111e-01];
L5_L6_iAMPA_netcon = [-3.713887637490597e-01   +7.639286148928365e-01   +3.869367625212061e-01   +6.916378089204543e-01   -6.179989242499596e-01   -1.430224385266293e-01; +6.194791179962685e-01   +2.659400431627285e-01   +7.082063368472197e-01   +4.610138703340599e-01   -2.240510832838048e-01   -9.253855948856586e-02; -7.314676662659378e-02   -1.488341354305208e-01   +6.607619578480229e-01   -6.417050699409228e-01   -4.992873263837674e-01   +2.980326366610012e-02; +8.230029195091677e-01   -6.563580312719459e-01   -5.224639981625091e-01   -1.082411229374025e-01   -7.304577992941523e-02   -4.616244658333735e-01; -7.956175843825085e-01   +2.426930314618825e-01   -5.357981122600464e-01   +9.379622439395092e-02   +8.621636978350986e-01   +1.000000000000000e+00; -1.319638565684429e-01   -6.746582854347388e-01   +9.046882365694107e-01   -3.028235980143128e-01   +5.857858608227855e-01   +5.585915801438627e-01];
L4_L5_iGABA_netcon = [+2.789467986714230e-01   +6.055205987353119e-01   -4.789523428652377e-01   -5.335752531252898e-01   -4.156684446229929e-01   +8.127926504073053e-01   -7.104776559590507e-01   +2.169214482878466e-01   +1.965568697893370e-01   -4.335987838252396e-01   +4.908958218600400e-01   +5.382288067176354e-01; -1.964305735450948e-02   +1.840502371830586e-01   +4.949896144438472e-02   +4.878784380072405e-01   +7.441860596981096e-01   +5.244491539235037e-01   +3.535846957808422e-01   -1.795878994884838e-01   -2.557465807129728e-02   +7.648704507557699e-01   -3.804073611649066e-01   -4.526537385776664e-01; -7.902869975433752e-01   -8.665542961055791e-01   +5.032485139388244e-02   -3.244438720815748e-01   -6.825149939042879e-02   -2.347890420138712e-01   +3.081228118377665e-01   +2.283863826013542e-01   -8.229036904056590e-01   +5.025889383140923e-01   -2.363603987742423e-01   -1.000000000000000e+00; +7.592555568837023e-01   +5.424658472707518e-01   +8.293319164855817e-01   -8.596328323525668e-01   -8.079942858846543e-01   -9.078229349530494e-01   -4.790679397625170e-01   +6.597833067155919e-01   +7.261942013888997e-01   -8.533478829554046e-01   -1.685800320992379e-01   +2.971626860443486e-01; -7.645466841404122e-01   -6.736177470859571e-01   -8.731327672748920e-01   +9.863542619846766e-01   +1.783765709050807e-01   -8.004616979573529e-01   -4.049260450041197e-01   +3.984700288709452e-01   +7.576670187761627e-01   +4.067099466002618e-01   -9.438811408905530e-01   +3.370143705005794e-01; -7.361092567591667e-03   -4.503486221575014e-01   -4.716747717650506e-01   +8.881902847603925e-01   -8.107840059788124e-01   +2.903580060139647e-01   -3.342764243786265e-01   -5.255272889899981e-01   +7.053909343675359e-02   +1.930692128744810e-01   +5.792076386637224e-01   -4.762144766072580e-01];
L6_L4_iAMPA_netcon = [+4.232720329519566e-01   +1.668448869669111e-01   -2.827410280734886e-01   +6.637134609156847e-01   -4.465015885213657e-01   +3.447092415067989e-01; +3.232721721955487e-01   +7.068101113962313e-01   -1.136022942160374e-02   -8.832012927847247e-01   -3.432438809456391e-01   -2.017541026798955e-01; -1.815174972931233e-01   +5.074562450193096e-01   -1.553226536557538e-01   -2.776104993769374e-01   -7.149323423559701e-01   -1.905704580270632e-01; +3.902874514699584e-01   +3.142567763331179e-01   -7.383508693991806e-01   +6.292618552271855e-01   +5.361267600488710e-02   +5.104402549402851e-01; +8.720145873758974e-01   +4.302181204911192e-01   -8.207650574274074e-01   +5.424676375345399e-01   -4.051004132352329e-01   -4.573352953489884e-01; +2.529517810597371e-01   -7.296985786492441e-01   -9.918753133001178e-01   +5.042829032729389e-01   +5.112356539494590e-01   +4.677530616687610e-01; +1.974055526749969e-01   +5.705946957004721e-01   -2.401201608284385e-01   -5.482046725491696e-01   +2.952375152604890e-01   -2.021936037914237e-01; +7.016559946477979e-02   +1.716817224543938e-01   +3.750370039771442e-01   +1.000000000000000e+00   -2.967576861362821e-01   -6.647331295435984e-01; -5.569438866287253e-01   -7.898905202308515e-01   +1.257236900254040e-01   -1.055999474435288e-01   -3.977655417268431e-01   +3.701599121544419e-01; +7.009280760821603e-02   +2.806419539755952e-01   +4.311851697007912e-01   +3.574402897803073e-01   +6.458046485595671e-01   +8.290482066771214e-01; -1.743889037448317e-01   -7.045873117715091e-01   +6.980059130337988e-01   +3.596523271259345e-01   +1.413770082899614e-01   +2.923547032420836e-01; +4.549080359443786e-01   +8.076976113394543e-01   -5.225329064895019e-02   +6.824982083741903e-01   -2.510903416277154e-01   +2.317941668586810e-01];
L5_L4_iAMPA_netcon = [-2.114688995682124e-01   +4.162858143389653e-01   -5.016018256568423e-01   -4.145403949346654e-01   +9.446892796819459e-01   +8.295600658383395e-01; +4.599968507142569e-02   +7.679701485071816e-01   +4.901019478758967e-01   +2.263322975578434e-01   +8.578761714939354e-01   +4.996465655193879e-01; -8.437785880544293e-01   +5.074355397892413e-02   +2.387064377277687e-01   -4.244725513987758e-01   -3.490359433401806e-01   +3.031143101283296e-01; -3.753232621836389e-01   +6.597668642572976e-01   +9.160964874603080e-01   +4.331571636581316e-01   +1.000000000000000e+00   +3.657779320818248e-01; +1.662722639692647e-01   +4.034192387062510e-01   +3.137495297044999e-01   +2.879177849885979e-02   -7.434253913906032e-01   +9.540028321845524e-01; -7.168155079456188e-01   +2.665599606329619e-01   +6.280154035936961e-01   -2.916356275254875e-01   +4.870057242553631e-01   +2.225206418422455e-01; +5.004011631917711e-01   -4.204804843988325e-01   -4.245768758443319e-01   +5.315400975673684e-01   -3.098824135573695e-01   -1.278631652899594e-01; +3.866512464296524e-01   +1.495269776187355e-01   -1.290947475008260e-01   -3.995303071366978e-01   -8.820508860795883e-01   -4.512037082053603e-01; -3.681726560216948e-02   +6.136919291934220e-02   -7.625868134907223e-01   +4.078013949827480e-01   -4.932297392294026e-01   +8.801920720059220e-01; +6.057590196214596e-01   +3.353994832117816e-01   +8.064522292664489e-01   -4.378100438425451e-01   +7.048510207329163e-01   +8.201466471002108e-01; +1.368006312170052e-02   -5.458676025080307e-01   +6.441973673127128e-01   -1.547184717004101e-01   +6.516923773251022e-01   +4.513515503914391e-02; -8.067010447691486e-01   +1.826732295733049e-02   +7.693503755739676e-01   +1.244144743795756e-01   -6.066333951334919e-01   -8.988068784061600e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
