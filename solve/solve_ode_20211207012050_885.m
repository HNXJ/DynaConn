function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.396912928528071e-02   -2.985503230148324e-02   -5.920340448052819e-02   -4.102136104217666e-01   -1.906807455397218e-01   -1.001092644529752e-01   -7.635400101813149e-01   -4.601967706220663e-01   -6.077150294085317e-01; -2.166044576758405e-01   -4.885277355746396e-01   -4.495121406436378e-01   -5.023756673219434e-01   -3.269781852553248e-01   -1.836874734483750e-01   -4.445008835809645e-01   -4.505773920639863e-01   -2.671391518549063e-01; -3.228707611988689e-01   -2.135421092595229e-01   -3.658223702821338e-01   -8.233169366428374e-01   -4.609909939386335e-01   -6.791935436581691e-02   -4.410763144608505e-01   -1.798835254623136e-01   -6.135917545136915e-01; -1.882743840830808e-01   -1.201767372023485e-01   -2.514580381099960e-01   -2.964209661125351e-01   -1.090084712380379e-01   -1.112579842651380e-01   -5.769895639555120e-01   -1.175796729762973e-01   -2.464262258695815e-01; -4.237437071093720e-01   -3.531456433494407e-01   -3.783079505632337e-02   +1.066647543218330e-01   -8.911202276146943e-02   -5.376390802227926e-01   -1.558233979764648e-01   -5.843362983708356e-01   -4.380156597515558e-01; -2.674090325298866e-01   -1.180021764078650e-01   -1.293636860755909e-01   -4.746902801051339e-01   -9.905085117718029e-02   -2.564009379165701e-01   -6.069010388246786e-01   -3.347498586554314e-01   -6.414418363027918e-03; -1.519433928118208e-01   -3.230554200269916e-01   -4.071535091790255e-01   -5.286715044146246e-01   -7.257627891740427e-01   -4.915150732140411e-01   -1.785106641017425e-01   -3.753214759721912e-01   -4.645073252299718e-01; -4.704259867943597e-01   -5.368225008354380e-01   -6.695968577716331e-01   -3.465296148075542e-01   -3.693635703790635e-01   +1.660883301997333e-01   -4.043916023813198e-01   -6.979375763926621e-01   -4.131059557955042e-01; -7.101284823064223e-01   -1.638512314035149e-01   -8.856714211018430e-03   -3.625950765217951e-01   -5.394540244294566e-01   +5.939073375646306e-02   -1.291906144073571e-01   -4.805579747545007e-01   -5.375381648185542e-01];
L1_L2_iAMPA_netcon = [-9.961760827701283e-02   -3.374217087129510e-01   -4.882363971442637e-01   -2.766236358498046e-01   -5.398863543201254e-01   -2.178942274106679e-01   -2.355974931793630e-01   -3.877601174003807e-01   -1.689470731021180e-01; -1.017242472097102e-01   -4.320244640901367e-01   -1.252162927050789e-01   -2.710875734983926e-01   -2.469774380483468e-01   -5.675965641771517e-01   -1.279446152119298e-01   -3.427226553347165e-01   +2.253516307935537e-01; -3.185193499310751e-01   +3.575921085499076e-03   -3.000173779324834e-01   -1.740356894755696e-01   -4.891566269871911e-02   -6.206028259918397e-01   -4.645127614837521e-01   -3.313044513935157e-01   -2.938971194056301e-01; -1.892457859159146e-01   -3.557927175560262e-01   -5.835186358320430e-01   -3.589729492573454e-01   -1.783920784027584e-01   -3.532238873757826e-01   -4.816032254382807e-01   -4.418977744771830e-01   -5.418076428022351e-01; -4.665505139689295e-01   -3.542238028045757e-01   -2.870043372514102e-01   -2.806883657881619e-01   -3.245375224094991e-01   -3.073019477670374e-01   -1.999797616741972e-01   -2.683873563676206e-01   -4.173520133777967e-01; -6.776093741168359e-01   -2.866662207089805e-01   -6.218268974651149e-01   +2.081944161798656e-01   -3.042205337461572e-01   -6.501967753485615e-01   -1.435212318516725e-01   -2.550967683279744e-01   -3.061335664722234e-01; -4.177207278634786e-01   -2.919655355360282e-01   -4.581767713231831e-02   +1.599333346474358e-03   -2.316465541056031e-01   -4.718935273333084e-01   -3.624724253229342e-01   -2.692857153231788e-01   -2.004306393567252e-01; -6.283121873507806e-02   -2.271433131678416e-01   -3.622704062143671e-01   -2.064362604924711e-01   -9.777964071648122e-02   -1.554060059214095e-01   -5.551001152358468e-02   +1.120274362674516e-01   -2.842559743155700e-01; -7.061514395568538e-01   -4.881022811353590e-01   -3.848997199687105e-01   -5.405669952375913e-01   +7.563327254779599e-02   -5.706058316148119e-01   -6.318140048835631e-02   -4.182310940127341e-01   -2.360591262352444e-01];
L2_L5_iAMPA_netcon = [-2.473734992141102e-01   -8.583799591808068e-02   -4.243046200120386e-01   -1.794829180705534e-01   -2.311747972448898e-01   -3.131990089433373e-01   -5.422271738721032e-01   -2.030390169022405e-01   -4.239272082216440e-01; -5.862994929016267e-02   -4.621503284889044e-01   -5.572163183648539e-01   +1.708563272661853e-02   -6.065846379110426e-01   -7.385930976299103e-01   -3.398174605714610e-01   -1.060830692200620e-01   -3.232949060447362e-01; -3.466524688738348e-01   -2.569887889866306e-01   -4.868708623430981e-01   -1.182021010693320e-01   -2.300518113837692e-01   +1.695765016261697e-01   -2.160766988795240e-01   -6.288455163035686e-01   -2.898550241339609e-01; -8.635721659719779e-02   -4.898688940832262e-02   +3.313498747781547e-02   -6.538951007690606e-02   -5.103186008063686e-01   -1.493319036817172e-01   -4.430344032737276e-01   -2.370152068826874e-01   -3.924443986638074e-01; -5.110392781049774e-01   -5.009690663398378e-01   -6.208251123115744e-01   -5.689119089395978e-01   -5.030526912412291e-01   -6.130513896308862e-01   -4.854594674176511e-01   -3.801576066276841e-01   -3.649859323340547e-01; -3.942540677927773e-01   -4.274677217862849e-01   -2.806863524168411e-01   -8.866087438861552e-02   -3.042781568238723e-01   -4.834641776752942e-02   -4.539656843954914e-01   -3.799778287918285e-01   +4.204592856361256e-02];
L5_L2_iGABA_netcon = [-3.272557500431901e-01   -2.658192710829101e-01   -6.791958875409828e-01   -2.390984732476456e-01   -4.233834624739309e-01   -3.308446630361177e-01; -2.297536421653925e-01   -1.715260981937290e-01   -4.801745673784669e-01   -5.325249304990556e-01   -3.815494366833038e-01   -2.645974666120841e-01; -3.436132081191101e-01   -9.583570724047791e-02   -5.910270302172975e-01   -2.663928938214831e-01   -6.486809351088479e-01   -2.543272362999488e-01; -1.039874270345917e-01   -3.104590973019586e-01   +4.526558554973679e-02   -3.083129589026103e-01   -1.267300537641816e-01   -1.625559038086001e-01; -4.143957058033974e-01   -3.643472980122177e-01   -4.946081906511382e-02   -1.562037329147654e-01   -4.754969220792061e-01   -9.152265770000687e-02; -2.570360113247842e-01   -2.951885593281703e-01   -1.279822485268019e-01   -4.262489585646720e-01   -1.761186111097566e-01   -5.281562279749221e-01; -3.040073447675206e-01   -3.185497716901172e-01   -5.083769949693526e-01   -3.098468831664047e-02   -3.568638078023902e-02   +1.533118483204435e-03; -5.642253267155691e-01   -1.713342645638045e-01   +1.469838308643673e-02   -3.420571324522261e-01   -2.787520526645840e-01   -3.129340545227767e-01; -2.521977607421224e-01   -7.345253039407955e-01   -6.639431216091460e-01   +4.332714164740817e-02   -2.777259515238088e-01   -2.123013513715699e-01];
L3_L2_iAMPA_netcon = [-3.350299146209669e-01   -4.939519662894473e-01   +6.220684060414895e-02   -7.485029764617290e-01   -2.618997578905605e-01   +1.773125601019857e-02; -2.538624891496636e-01   -5.568874639065776e-01   -2.653599348041510e-01   -3.100818956462396e-01   -3.616468975710354e-01   -3.287517671087230e-01; -3.794405021562198e-01   -4.692289491929064e-01   -3.411219616458954e-01   -5.892758373682878e-01   -2.754848231813369e-01   -2.913079038104089e-01; -3.368575126270708e-01   -4.379912585106008e-01   -4.415971711010653e-01   -3.764950353508933e-01   -1.242012630081841e-01   -3.826073706123748e-01; -2.390678283418794e-01   -3.987726912402191e-01   -3.942045282750542e-01   -2.830820125904056e-01   -2.276323503890066e-01   -4.015451132972425e-01; -6.889955577743956e-01   -1.276961676904050e-01   -2.425860812343630e-01   -2.608251561325204e-01   -4.518154117702849e-01   -3.346800288475489e-01; -3.171686658196633e-01   -6.836296130143850e-02   -6.628575722231599e-01   -1.985881822314015e-01   -3.561611927628583e-01   -4.838481723807394e-01; -1.588446965049163e-01   -3.385783932972507e-01   -3.380449520882690e-01   -1.026917238051928e-01   -2.448637763106088e-01   -5.182474965706083e-02; -6.326600957768672e-01   -2.735803839176383e-01   -4.457608907069785e-01   +7.861788860788933e-02   -3.314487178431604e-01   -4.237450481295236e-01];
L2_L3_iAMPA_netcon = [-2.387874468985023e-01   -2.638084524991028e-01   -3.284455733940082e-01   -2.685960584160666e-01   -4.838733590790524e-01   -6.570389276937243e-01   -4.762816849132345e-01   +1.788406304863793e-01   -2.210688418708135e-01; +3.724513265658447e-02   -6.264440986313221e-01   -4.245378235997312e-01   -4.149314754763991e-01   -2.512588876140170e-01   -3.580742501628913e-01   -2.057236649249443e-01   -3.633585705805459e-01   -4.359351585227833e-01; -5.442196199775313e-02   -4.358750445521763e-01   -3.921413599737490e-01   -2.891287312895205e-01   -4.335487610836244e-01   -4.497858167326035e-01   -2.685022458611042e-01   -2.100334625586312e-01   -2.360341920408260e-01; -9.387142040449448e-02   -4.755969937550193e-01   -2.588077660239069e-01   -3.080308406868848e-01   -2.991835437829555e-01   -1.958013530430704e-01   -4.859408985124800e-01   +5.443744875036758e-02   +7.977904078703615e-02; -2.363826582228342e-01   -6.022077800681191e-01   -5.433619836967550e-01   +1.604732393176701e-02   -4.226746472147428e-01   -1.671764714710542e-01   -2.565750387864440e-01   -3.072372673762656e-01   -6.518104474379349e-01; -1.684171018814076e-01   -7.787276093780357e-02   -5.924840441239981e-02   -4.638334497277938e-01   -1.916318289534198e-01   -4.553041062188192e-01   -6.695339170123336e-01   -1.080230351733589e-01   -4.523865634990870e-01];
L1_L4_iGABA_netcon = [-8.052961188904003e-01   -4.311367708548677e-02   -5.640300941789352e-01   -4.458826487379571e-01   -1.414956677865609e-01   -4.503362563458749e-01   -5.385316784430301e-01   -3.396281086399816e-01   -4.815166754515102e-02; +8.754181589878091e-02   -4.489541607095397e-01   -1.845662451808817e-01   -2.147007783825430e-01   -1.370136415689238e-01   -3.430318755009768e-01   -1.317315386658798e-01   -3.971584612250988e-01   -5.537382864884712e-01; -3.226106052300833e-01   -3.139028930620312e-01   -2.613154540538958e-01   -5.355299013695063e-01   -5.651296508657987e-01   -3.382737098314214e-02   -5.870830758197413e-01   -1.409853732442144e-01   -1.588618278265117e-01; -1.866757298960812e-01   -5.556179085240003e-01   -1.775553139390133e-01   -4.096486926581101e-01   -5.889675387918116e-01   -7.685437720247054e-02   -3.679551500515980e-01   -3.122516277477456e-01   +4.853731754446464e-03; -2.922015740639051e-01   -3.497865977651347e-01   -4.313739751180518e-01   -4.143638213942815e-01   -1.713530206325405e-01   -4.422818260513890e-01   -4.059355217890123e-01   -4.562621025482456e-01   -6.811067377433000e-01; -4.461849968751762e-01   -5.466514664284137e-01   -2.872815616027743e-01   -2.318279540022509e-01   -3.165709095431526e-01   -2.169117564491775e-01   -2.363220852335565e-01   -2.433910797797975e-01   -1.740075810821503e-01; -3.555022521977360e-01   -2.261627400911407e-01   -3.573880915408000e-01   -4.216264953538796e-02   -6.541352803590528e-03   -3.157244047848545e-01   -8.695323634205826e-02   -3.694369927740777e-01   -2.030578483286125e-01; -6.909644288674803e-01   -1.820135274334023e-01   +1.084869842355329e-01   -3.581056062225779e-01   -1.910629763614854e-01   -2.843697506706200e-01   -2.897113902652865e-01   -4.381325038217090e-01   -5.906066643161851e-01; -5.176370124068104e-01   -4.336136663409509e-01   +1.504561709432806e-02   -1.347333830047672e-01   -9.501883878861955e-02   -1.700424792117054e-01   -3.806514909102712e-01   -2.949845169560022e-01   -2.022611359263750e-01; -4.809644763403665e-01   -2.163894932452850e-01   -3.504148448939770e-01   -3.164724230752429e-01   -4.001082212945642e-01   -5.989983448294258e-01   -5.509517782069373e-01   -3.105763988824496e-01   +1.486384488471493e-01; -3.970771972864358e-01   +5.806345561640044e-02   -5.195285300671191e-02   -2.439277600504142e-01   -4.306937217353322e-01   -4.806586918881254e-01   -5.640399407207232e-02   -3.426703785825971e-01   -5.490599919220217e-01; -4.710992762241287e-01   -2.599102757388914e-01   -2.427061434703925e-01   -5.501247366665365e-01   -2.432869405912065e-01   +8.583262899910125e-02   -4.110000362259250e-01   -5.332276352579017e-01   -2.759219131909090e-01];
L4_L1_iGABA_netcon = [-1.077675818420296e-02   -2.612496264963394e-01   -5.288241328532995e-01   -4.157121173489927e-01   -1.817663075113070e-01   -6.558960916912802e-01   -5.053972603167696e-01   -4.122677509343495e-01   -1.889821100628237e-01   -2.215564541912251e-02   -3.406327164240744e-01   -1.368539393646726e-01; -1.812643150733652e-01   -5.776660899430419e-01   -1.134103529376325e-01   -1.952170657534282e-01   -6.054448167391875e-01   -1.835078418178458e-01   -3.794184921728551e-01   -6.462633846247307e-01   -1.889710360747448e-02   -3.760866123476058e-01   -4.045310908995772e-01   -3.572293719533689e-01; -2.414645236830313e-01   -6.409891438203882e-01   -3.055532181571737e-01   -9.637053043511160e-02   -3.541230285451046e-01   -3.551014284229939e-01   -4.493142688825710e-01   -4.603620305819688e-01   -1.848818238807768e-01   -1.700228140152029e-01   -5.342825498213820e-01   -2.387829422878345e-01; -5.115582741075403e-01   -5.640394509561450e-01   -1.438762261463714e-01   -1.185546045336473e-02   -2.592255189874157e-01   -4.169683023558865e-01   -3.307197756111316e-01   -3.140273613207174e-01   -2.799431248322957e-01   -2.597009357313321e-01   -3.077789848193867e-02   -4.432207908670458e-01; -5.704394947086040e-01   -2.893478124306569e-01   -2.380913538449998e-02   -3.120637495423943e-01   -4.464158773921699e-01   -3.785949698588125e-01   -1.335758129452795e-01   -2.823257731518553e-01   -4.682708202248575e-01   -3.140812391142359e-01   +6.029356182292529e-02   -4.278668251947865e-01; -4.981069870680624e-01   +7.842722549588683e-03   -4.141789755399692e-01   -2.709518941776177e-01   -3.417799629247555e-01   -1.322879833836725e-01   -2.318687679311401e-01   -1.531770185715944e-01   -4.720394922911377e-01   -3.213925576675891e-01   -4.614244981876723e-01   -8.222988444237791e-01; -1.673198535748052e-01   -4.993613980717460e-01   -2.128461739118066e-01   -1.578971759229064e-01   -4.143320316153102e-01   -3.051508195350626e-01   -5.397575630705902e-01   -7.162069541555464e-01   -8.231462417683308e-02   -3.051172380582826e-01   -3.459769151317544e-01   -3.973353956668519e-01; -4.629915069078506e-01   -8.113079401794349e-02   -2.806300851746657e-01   -1.434499425648050e-01   -4.187648741806185e-01   -6.433799285411903e-01   -2.299590400685302e-01   -1.440132555008656e-01   -2.623028852322330e-01   -1.735886732439354e-01   -6.311986465016817e-01   -2.766471082678963e-01; -5.440334046470146e-01   -4.148684266405944e-01   -3.280524016046173e-01   -6.484579071679065e-01   -3.707671940367225e-01   -8.839363246492651e-02   -4.024364034995185e-01   -5.249876148463717e-01   -2.891012052716471e-01   -2.877140677878040e-01   -2.567665762719397e-01   -2.497187038992964e-01];
L1_L3_iAMPA_netcon = [-2.948683198663394e-01   -2.790385673499109e-01   -4.938377609819036e-01   -6.116346015364644e-01   -7.019691036185366e-01   -4.583668031120821e-01   -1.023987505793631e-01   -5.461223877249242e-01   -1.918455434779626e-02; -4.043289958077167e-01   +8.563501867576599e-02   -8.883561890592136e-02   -5.875109493041456e-02   -3.542362215591887e-01   -2.546223667300075e-01   -7.777305026167591e-02   -5.686792911512615e-01   -3.599204994811875e-01; -2.195266935428525e-01   -1.582549868436390e-01   -3.431184363535696e-01   -8.672511637667654e-02   -2.939118276018156e-01   -5.932111876064056e-01   +2.992006915004343e-02   -6.674806351029432e-01   -3.333949446595755e-01; -1.819335871335671e-01   -3.238914558311987e-01   -2.584267711689159e-01   -4.398805468507379e-01   -3.157161341342516e-01   -9.586186976933227e-02   -3.859749016689067e-01   -6.003259193660322e-01   -3.600181773283107e-01; -4.089368770942031e-01   -3.093577954481069e-01   -1.920341104671589e-01   -2.725643423265703e-01   -4.069994738318390e-01   -5.308010970182964e-02   -5.408017591421318e-01   -1.293681105529293e-01   -4.720003899800382e-01; -4.366061353470795e-01   -3.395610286983385e-01   -2.586174726113949e-01   -3.622136269205232e-01   -4.688088320910528e-01   -1.230024331514338e-01   -3.249185900711836e-01   -2.781993288113484e-02   -5.843357527577323e-01];
L3_L1_iGABA_netcon = [-2.963255158188802e-01   -3.543742169681699e-01   -2.248158485891569e-01   -7.887755671039354e-01   -6.199795820705568e-02   -6.656572223434140e-01; -3.021696912549128e-01   -1.557603842779030e-01   -2.732751732317907e-01   -4.924871309495451e-01   -5.493812724305539e-01   -7.016575965043499e-01; -1.941698530548277e-01   -5.040145748103965e-01   -1.434998943970096e-01   -1.293095746042888e-01   -3.353998236860189e-01   -2.317994931577138e-01; -3.345765657430817e-01   -6.813197299879270e-02   -4.845947488893529e-01   -5.154662458898996e-01   -1.721126030675917e-01   -3.705577122488893e-01; -4.101761724837651e-01   -4.177627635545303e-01   -6.941703203714472e-01   -5.664184257968537e-02   -2.742180272937874e-01   -2.823348731430884e-01; -2.192770038077537e-01   -4.389502700252227e-01   -2.354363849289922e-01   +9.337072592654196e-02   -1.243338320002071e-01   -6.017762416640934e-02; -2.642812037141605e-01   -1.444434865693922e-01   -3.025742596688187e-01   -4.847304089075555e-01   -1.629131791003103e-01   -2.000147587291360e-01; -1.730253780155886e-01   -4.698480804235608e-01   -5.262564749670602e-01   -3.430429099755814e-01   -4.673293634930086e-01   -2.521500647571574e-01; -3.775338548680306e-01   -4.558398419123706e-01   -4.516618295795434e-01   +2.679129404739825e-02   -7.141870932888708e-01   -3.733478944902764e-01];
L5_Input1_iAMPA_netcon = [-2.119213958065332e-01   -2.729562873963892e-01   -2.906387990706982e-01   -1.781183228319324e-01   -5.136224601997519e-01   -7.078366347364451e-01];
L6_Input2_iAMPA_netcon = [-5.822812961386707e-01   -5.160631150214895e-01   -2.903642903480732e-01];
L5_L6_iAMPA_netcon = [-3.289100608890817e-01   -5.452678340261392e-01   -1.608766110438678e-01   -2.537773368468820e-01   -5.953334402986364e-01   -2.254811122434940e-01; -3.866942919904617e-01   -2.123482951103630e-01   -2.882336976884803e-01   -4.326242350790130e-01   -4.628730643076767e-01   -1.614755540312632e-01; -6.233929421005038e-01   -2.107694202359237e-01   -4.335330825253308e-02   -1.050153089683115e-01   -2.996157106253454e-01   -1.589230710146161e-01];
L4_L5_iAMPA_netcon = [-4.745740686942191e-01   -4.121151963072284e-01   -4.546335246751556e-01   -4.103769592927133e-01   -3.722829962785801e-01   -4.671594999894165e-01   -2.421104655560467e-02   -2.666594536767142e-01   -5.994583013521660e-01   -2.184759440466447e-01   -6.276849564818197e-01   -5.517876242947636e-01; -2.303179066634415e-01   -5.042210145513427e-02   -1.427296969446963e-01   -2.190494729574622e-01   -2.558131858317778e-01   -5.442176980573331e-01   -1.907083785356242e-01   -5.460787323797156e-02   -3.544999254696322e-01   -3.178489806573853e-01   -7.189836180157754e-01   -3.629826657130857e-01; -2.814047952111477e-02   -4.468043373870711e-01   -9.099967424538433e-02   -9.588568590415286e-02   -1.664459422593955e-01   -3.395839471434075e-01   -3.319600285214814e-01   -1.254929350214115e-01   -4.174650000664418e-01   -3.160464942808673e-01   -2.351312231289382e-01   -4.161156924418687e-02; -4.598870809178743e-03   -2.910877622135424e-01   -3.453589630543171e-01   -1.033395993005365e-01   -3.920228813343332e-01   -4.272165756195934e-01   -2.428891696408958e-01   -2.048158250186229e-01   -4.266033057214843e-01   -2.168000385740601e-01   -7.032872362531142e-01   -3.824960095451733e-01; -2.010850551586360e-01   -9.253146194524406e-02   -3.794186899052417e-01   -3.458475658174390e-01   -1.616680345755463e-01   -1.288512051173530e-01   -2.839813814904430e-01   -4.819881443394366e-01   -4.562035413557595e-01   -4.770212594203720e-01   +1.475894990724702e-03   +2.516720290975824e-01; -5.350684192140703e-01   -5.084615452411906e-01   -3.533410583740449e-01   -3.053325925070853e-01   -4.741250427624071e-01   -6.052701141625892e-01   -8.974559837264387e-02   -7.698116285136355e-02   -3.054536828070550e-02   -7.217597568619163e-01   -5.000236057835237e-01   -4.889531256897469e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
