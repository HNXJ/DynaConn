function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.441606158130290e-01   -1.646037548941967e-02   -5.126115303353934e-02   -4.067447347673420e-02   +4.327480719031070e-01   -4.262228162044647e-01   +3.605684523933019e-01   +7.038509554422012e-02   +5.594804308252737e-01; -2.558657986048707e-03   +5.136262773335000e-01   +3.195818435613005e-01   +3.144640205835119e-01   +1.270719345638396e-01   +1.770582916028819e-01   +4.402839933047041e-01   -7.758517906017587e-02   +1.422449101956305e-01; -4.647111081364372e-02   +1.761503674854412e-01   +2.831077122478136e-01   +3.857410007709719e-01   +3.479239213226183e-01   -4.898009101936264e-01   +2.163106992275403e-01   -7.441387896247575e-02   +6.061764773969591e-01; -1.075654344645502e-01   +2.126439427815917e-01   +4.396484999181147e-01   +7.235925288672895e-01   +4.755646367978962e-01   +5.888991851325416e-01   +1.749306718426925e-01   +2.905757183826838e-01   +3.148643096936818e-01; +3.267782695685115e-01   +6.332484507096978e-01   +1.064899003394432e-01   +1.490857062035768e-01   -1.498348719266987e-01   +6.274550566757507e-01   +4.917316573382819e-01   +4.955153652878265e-01   +1.314449643055256e-01; +5.348118900545306e-01   +2.322477587845724e-01   +1.039973911492423e-01   +3.577808281143247e-01   -3.886134473220612e-01   +4.352729456085858e-01   +6.724220065476063e-01   +3.869723780023759e-01   +2.972081967069896e-01; +9.704842156568483e-01   +1.672406583259926e-01   +1.254555898861935e-01   +5.600840603343550e-01   +2.499444552314182e-01   +6.505075250346393e-01   +4.412507535453771e-01   +5.724122995513613e-01   -9.995681123949718e-03; -4.522922766781796e-01   +7.053768613855447e-01   +7.420265708578407e-01   +5.018694247923212e-01   +7.711374658733539e-01   -5.751173171896702e-01   +1.094384458779226e-01   +3.471623310798033e-01   +5.675918384413030e-01; +2.404461827004522e-01   +1.046676675546723e-01   +3.756043693450092e-01   +2.203370087162502e-01   -1.142934179349442e-02   +4.216904397609427e-01   +5.348830687747037e-01   +1.982771277426200e-01   +5.164226517907308e-01];
L1_L2_iAMPA_netcon = [+5.685408034263401e-03   -3.686153770691312e-01   -5.262694024716438e-02   +6.002562445115227e-01   +3.391987252552410e-01   -3.309745102395780e-01   +2.759053112020615e-01   -2.904097551892448e-02   +7.917470273584615e-01; +3.354400106321226e-01   +3.858430621098806e-01   +4.171169394944503e-01   +2.280091113298121e-01   +3.930783978734122e-01   +1.268989730537647e-01   +3.010221292767515e-01   +2.214452939342633e-01   +2.434366746048217e-01; +4.294197007829073e-01   -1.748752600501632e-01   +3.401713402452249e-01   +3.675100102976059e-01   +2.220930835028288e-01   +5.167466206053765e-01   -2.951504020717227e-01   -1.742616882826250e-01   +5.037909957182146e-01; +4.908826816437282e-01   +1.244078914715471e-01   +4.836014055909192e-01   +4.839370927171318e-01   +1.662289420073892e-01   +2.407771890339905e-01   +3.110609016901738e-01   +2.157029992935676e-01   -9.440545181313266e-02; +1.179533392517950e-01   +5.264320182890549e-01   -1.298352895222522e-01   +3.339409506724654e-01   +3.829521094740439e-01   +4.047256442374900e-01   -5.586304571628560e-02   -3.538864802689272e-01   +4.220766104418369e-01; +1.029270432645235e-02   +2.673822602692040e-01   -6.277076956954120e-03   +1.856872309835928e-01   +4.546423790028509e-01   +2.648544767962405e-01   +6.694389998130624e-01   +3.932992134973355e-01   -1.843382023266973e-01; +1.338100866818362e-01   +4.684903258855672e-01   +1.454608880028099e-01   -1.308937678288785e-01   +1.668433130501246e-02   +1.655478997811039e-01   +3.237839270222576e-01   +5.469988778301230e-01   -2.814391358017516e-01; +4.071803861973090e-01   -1.048091767733859e-01   +5.266790662831404e-01   +7.515459785860057e-02   +3.690889342486571e-01   +2.655256455889761e-01   +1.103260258326048e-01   +5.602403834322932e-01   -2.725487951594113e-01; +6.166070155576872e-01   +9.373704506816166e-02   -1.442125624576907e-01   +3.249755380635782e-01   +1.844830338465135e-01   -6.894888888702910e-02   +1.848352440952925e-01   -1.373757138796153e-01   +3.859346285500790e-01];
L2_L5_iAMPA_netcon = [+6.073035707234107e-01   -3.459243421991001e-01   -3.127303667471994e-01   +3.762481653006861e-01   +5.176592040258529e-01   +6.556089505198362e-02   +3.961125619981944e-01   +2.859240412980902e-01   +5.232851651110226e-02; +3.821874353786066e-02   +5.141051266596373e-01   +3.278885863387538e-01   +6.780393632128453e-01   -7.317565174517385e-02   +1.644366667144164e-01   +9.414653722877121e-02   +1.467508703544140e-01   +5.762668052906770e-01; +3.936972048716946e-01   +4.105823128310900e-01   +1.550040600610856e-01   +3.824880269413968e-01   +9.084967227591134e-01   +2.860446168794996e-02   +5.640867982342989e-01   +1.175693131630634e-01   +9.796820614622687e-02; +8.591020353647472e-02   +7.809539969013939e-01   +4.231187330683856e-01   -2.166428810039988e-01   -1.682002649221181e-02   +6.600751716669322e-01   -1.567996311687193e-01   +5.046071170430794e-03   +2.441180310705347e-01; +3.036890865215784e-01   +4.693348217062066e-01   +7.094255477684126e-01   +7.049402228151043e-01   +4.356094073666181e-01   +1.998519591826837e-01   +7.815263759459991e-01   -3.393792619288063e-01   +8.689683547333124e-01; +6.562393105491617e-01   +6.251783092802115e-01   +7.518347022111433e-01   -3.781375446713191e-01   +4.301456925002677e-01   +3.675524527426531e-01   +9.337836831223812e-01   +6.820417116277316e-02   +5.622880383099182e-01];
L5_L2_iGABA_netcon = [+4.402132796215364e-01   +4.698710508589073e-01   +5.305909759305817e-01   +6.618455568861703e-01   -1.555612087348408e-01   +9.550179847751952e-02; +6.903535223243766e-01   -3.104871353761739e-01   +1.842385842947111e-02   +4.297087373810565e-01   +4.911859492002193e-01   -4.165024081239362e-01; +4.445534002150080e-01   +1.373050012340488e-01   +5.859202239478850e-01   +4.871337735275871e-01   +4.358857227706463e-01   +4.908222422051052e-01; +2.805645781562803e-01   -1.908205375970385e-01   +1.520369909130711e-01   +9.223884232214119e-01   -1.380210959015986e-01   +2.687608510837197e-01; +1.847895164172735e-02   +2.559213753710696e-03   -4.928859916469824e-02   +4.147262975349931e-01   +4.262401892463262e-01   -2.471952670764804e-03; +2.237019280268319e-01   +1.313474343676597e-01   +6.518730206468926e-01   +4.507107080121036e-01   -1.321491289517995e-02   +2.287533116848299e-01; -3.003849571391564e-01   -1.819130707583156e-01   +3.642668984047317e-01   +7.357588603776519e-01   +2.901753552080671e-01   +1.354867432297355e-01; +1.383802889738737e-01   -1.670026542654047e-01   +5.572485097120741e-01   +6.104961206654678e-01   +5.870955322604118e-01   +7.363042243223420e-01; +5.656222768332589e-01   +3.931321547224138e-02   +4.637479366649548e-01   -9.186063840337007e-02   +1.745577935422656e-01   +3.238607740937716e-02];
L3_L2_iAMPA_netcon = [+4.170087041278492e-01   -1.515599922715469e-02   +1.987981701860782e-01   +4.987346391934775e-01   +1.198903164632399e-01   +9.060769075437364e-02; +9.269775635391192e-03   +8.646734571612487e-01   +2.870448791855365e-01   +2.730081586844607e-01   +6.756445452126912e-01   +8.935171723915556e-01; +4.466497712543196e-01   +1.126886421872292e-01   +1.946780662659293e-01   +1.344288586158183e-01   -1.677432410671667e-02   +4.232147867417480e-02; +5.124696533972830e-01   +2.824578766027794e-02   -1.318267815481590e-01   +1.349306470281582e-01   +4.241608140743372e-01   +4.343551779228217e-01; -5.715323420986407e-04   +2.086290834056807e-01   -6.385372983665316e-03   +6.913857122069970e-01   -8.442540591631145e-03   +2.337842996211535e-01; -9.062748030335460e-02   +6.531520442987285e-01   +3.588478613553474e-01   +6.615713785667104e-01   +4.802165051213704e-01   -1.684594035748291e-01; +3.487136571607887e-01   -1.307086899621497e-01   +4.347828824249740e-01   -8.203480223509418e-03   +5.022812208028684e-01   -1.445730756264528e-02; -1.343758945636966e-01   +1.080467692459812e-01   -2.330768227138398e-01   +3.816772818757651e-01   +6.373544995806028e-01   -2.632919519451803e-01; -2.690900433804249e-01   +2.703035297533865e-01   -4.363791937990651e-02   +1.503261132666495e-01   +3.487396736059700e-01   -2.319661110629785e-01];
L2_L3_iGABA_netcon = [+4.730657652473562e-01   -5.300547349210288e-02   +5.868067636516903e-01   +4.738981168008793e-01   +4.065646754702412e-01   +3.177168247062866e-01   +4.800356684797626e-01   +5.699354468563267e-01   +9.037683910245703e-02; +6.191402579242267e-02   +8.543961806595612e-03   +5.401546735793215e-01   +4.137644356589204e-02   +2.621754023512509e-01   +6.032699722482542e-01   +7.426436763056262e-01   +5.300903190203730e-01   +1.674303727494562e-01; +6.734590175964317e-02   +2.646867972179904e-01   +5.265149289082808e-01   +2.178729734784023e-01   -3.708549351634616e-01   +1.266201573051158e-01   -1.255496717000311e-01   +7.584676016049172e-02   +5.011138030491663e-01; +3.801980238188843e-01   +3.466742664510077e-01   +1.302835068673139e-01   +2.532442276412304e-01   -1.305154387863283e-01   -7.481914214392676e-03   +2.447873891349132e-01   +6.368918162940445e-01   +3.199782698006005e-01; +4.587717276578109e-01   +5.015345871411920e-01   +2.139919393022819e-01   +3.814387735582535e-01   -1.891599423346628e-01   +3.627898894747713e-01   +4.108691171970923e-01   -1.665560034180512e-01   +2.802628716015637e-01; +4.514563771566787e-01   +5.979558679683517e-01   +2.164144332753543e-01   -7.347456868653363e-02   +1.256351091559940e-02   -1.746686295911498e-02   +5.620805829570170e-01   +8.981646043219081e-02   +5.635884161553230e-01];
L1_L4_iGABA_netcon = [+9.438832990587012e-02   -9.924095721346596e-02   +1.800154478813564e-01   +5.293273320871266e-01   +4.737176411630690e-01   +7.101134477388498e-01   +3.049648616441351e-01   +7.004064871712573e-01   -8.832467768906245e-02; +1.193404538208017e-01   +2.359665647491423e-01   +3.670825407186615e-01   -3.058149897712399e-01   +5.718885418041899e-01   +3.615319146202183e-01   +2.460047934970328e-01   +4.850210964746884e-01   -1.255817319424750e-01; +2.761656445503685e-01   +8.027687154969441e-01   -4.891658569631077e-01   +1.126194363750738e-01   +1.752169178073069e-02   +1.618515076047444e-01   +5.096313652110021e-01   +7.513659890431723e-01   +1.906849784140080e-01; +5.118028168338394e-01   +2.535941332912425e-01   +1.586005591589504e-01   +2.182411281459841e-01   -8.178075788117092e-03   +2.162652338216716e-01   +3.065091198752890e-01   +3.919025730203048e-01   +2.034837315825391e-02; +4.233990838221579e-01   -2.218533439269039e-01   +5.141974607160389e-01   +4.347786917464158e-02   -2.302094399296297e-01   +2.142786165491214e-01   +1.394276871187310e-01   +2.450631021780056e-01   +2.322021987288632e-01; +3.111853122333881e-01   -3.071133425325475e-01   +3.286909472719755e-01   +2.107806645303567e-02   -1.866284261185939e-01   +4.090883036579305e-01   -1.991078162058519e-01   +7.043157857189392e-01   +6.376108661742621e-01; -7.926645423897205e-02   +4.613621615246441e-01   -1.208406167316841e-01   +6.249143977004541e-01   +6.582671508223119e-01   -9.546048352178201e-02   +1.021092238274093e-01   +3.603339930859230e-01   +3.061577368392728e-01; +6.019625764688007e-01   +4.735896466501452e-03   +7.824361276013407e-01   +4.210758630131798e-01   +3.345869264263557e-01   +5.844990528868221e-01   +2.452874376750306e-01   +2.091870217226121e-01   +4.271881291689396e-01; +2.134210195028204e-01   +1.853109120430774e-01   +2.279069648414705e-01   +1.204575303935807e-01   -1.792798395331621e-01   +3.147991723555079e-01   +2.820437254668280e-01   +3.933798092557448e-01   +3.737075310997077e-01; +6.375460983460517e-01   +3.906942312702739e-01   +2.751360381455756e-01   -1.744113373195414e-01   +2.772506446482829e-01   +3.169999336370075e-01   +2.164127372269262e-01   +2.655712614651085e-01   +5.007028792010894e-01; -2.232631163832121e-01   -1.516502529293953e-01   -3.714008153092657e-02   -1.854150454721320e-02   +4.711750174947542e-01   +5.709507393689108e-01   -4.326221184312085e-03   +2.022460746496564e-01   +6.436244520385763e-01; +4.316792480917469e-01   +8.394725377800626e-02   +1.409506784351852e-01   +7.791843355406083e-01   +6.564758947427919e-01   -3.788649391499077e-02   +6.791476171312896e-01   -1.074592294318504e-01   +2.657447330396909e-01];
L4_L1_iAMPA_netcon = [+4.691538444341681e-01   +3.275496286843925e-01   -2.424058760440392e-01   +4.486218748671599e-01   +3.118123628629468e-01   +1.990345211899928e-01   +8.104280766296306e-01   +7.026695441646695e-01   +6.681228124682774e-01   +6.699008719173997e-01   -1.403567494727565e-01   +3.713384678052212e-02; -2.782363715473277e-02   -1.564525242043218e-01   +2.781357782644083e-01   +4.507593215405310e-01   +8.946982041313499e-01   +7.084923608250142e-01   +1.935772665189445e-02   +3.774542953817023e-02   +1.719053981151287e-01   +7.186904607921745e-01   -1.464105157947843e-01   +1.559140083136189e-01; +1.316555414763428e-01   +2.425565072606408e-01   +8.381075645794565e-01   +4.007259034868482e-02   +4.037835580847201e-01   +3.018415002896426e-01   +7.675168492763464e-01   +8.220760589304460e-02   -6.888862886350330e-02   +5.241971554016551e-01   +5.613769620012174e-01   +7.644308817779997e-01; +8.357316009152128e-01   +8.371535459557196e-01   +3.484009592581960e-01   +4.787783027435243e-01   +9.460428113332299e-02   +1.927445572144695e-01   +3.134390738014645e-01   +5.557638647785301e-01   +5.095320288898623e-01   -1.878133017551903e-01   +1.418628722900513e-01   +6.362318282561072e-01; +6.390897542385872e-01   +1.065089584222815e-01   -2.838092003159517e-01   +9.128803889159554e-02   -1.748336942878303e-01   +5.243846617017603e-01   +5.391626672487345e-01   +4.089748998296808e-01   +2.863723935748161e-01   +4.539767797181203e-01   +2.799497870526046e-01   +6.188953868122918e-01; +3.699867847497416e-01   +6.726826273072320e-02   -1.785758451942607e-01   +1.269181601060906e-01   +4.972725422502772e-01   +1.351908030969871e-01   +4.342803035899057e-02   +1.887514926377462e-01   +6.057477177533424e-01   +7.979641035678937e-01   +5.929756633300781e-01   +4.327871946563392e-01; -1.026799033680843e-02   +2.422554504291140e-01   +6.079522011676419e-01   +9.088506793489289e-02   -3.550522087249424e-01   -1.056086122059357e-01   +1.948329286452681e-01   +1.512109156835778e-01   +4.698575638403601e-01   +3.659394838121525e-01   +5.048788270554205e-01   -5.422060941947637e-03; +3.560361289473979e-01   +1.560011653413026e-01   -4.542001605112039e-02   +1.533516391643103e-01   -1.264507344615625e-01   -4.440258360825343e-02   +7.406433615034164e-01   +1.440245255690628e-01   -1.957661494272606e-01   +1.681484910148074e-01   +6.817597944819095e-02   +2.001726532081848e-01; +1.898044644385538e-02   -1.141684287878188e-01   +2.783174772592883e-01   +1.426257127370066e-02   +7.293926901276383e-02   +4.719873645909148e-01   +2.109247145241549e-01   -4.483740107073514e-02   +1.569257865125562e-01   +1.683141918398558e-01   +6.315535765748777e-01   +1.124220092298121e-01];
L1_L3_iAMPA_netcon = [+1.184682383449529e-01   -1.362372914237809e-01   +7.767586519240098e-01   +2.453043238070435e-01   +1.357121649870806e-01   -2.605552513693128e-01   -1.478750084712470e-01   +1.852927098053000e-01   +5.457863339494745e-01; +6.139645746858865e-01   +1.348215361078647e-01   +3.492493779176363e-01   +1.266335047842729e-02   +4.253208800025172e-01   +2.717486738858162e-02   -8.382179370735077e-02   -4.043677889256594e-02   +7.231070988287648e-01; +1.616218926299987e-01   +4.142169595380760e-01   +4.736906291175869e-01   +2.289451102992401e-01   +4.632287580253411e-01   +3.790046930324156e-01   +3.350445655318632e-01   -1.065821677674513e-01   +6.295254569652392e-01; +3.302418486704721e-01   -9.314738255723279e-02   +1.676869739016200e-01   +3.627678768266835e-01   -3.663117595372024e-01   +1.789871627231669e-01   +1.487697639655036e-02   -1.545537576088774e-03   +4.311511353312292e-01; +4.789463071940112e-01   +8.056923629450297e-02   -1.427235406072436e-01   +3.545225554257223e-01   +5.587177243436059e-01   +6.580188294078647e-01   -7.475208484267157e-02   -1.833757918469146e-01   +6.375978225368139e-01; -1.651765479416291e-01   +1.354439912383851e-01   +4.949359056123768e-01   +4.540728816597849e-01   +7.251172515152417e-02   +3.690763740093771e-01   +8.246013299341691e-01   +1.230922360130271e-01   +1.016253073764899e-01];
L3_L1_iGABA_netcon = [+6.142127155041993e-02   +5.205108427209307e-01   +1.833228749911043e-01   +7.829047063797541e-01   +1.112169583503052e-01   +3.782656374168940e-01; -1.509548293784028e-01   +2.526503840789497e-01   +2.435249196272752e-01   +4.566422475809601e-01   +2.009025289225153e-01   +1.912420931990783e-01; +4.053857439712839e-01   +8.595116990179513e-01   +1.234458597127563e-03   +5.516288203665090e-01   +4.249984799460914e-01   +3.129498961457874e-01; +3.808626955902474e-01   +1.479721875381092e-01   +1.078244000531939e-01   -2.407593746395346e-01   -2.930646163952699e-02   +6.364770042834790e-01; +6.195475831719053e-01   +8.648953585384606e-02   +2.068421051748736e-01   +1.941669984101173e-01   +1.115537895023461e-01   +5.189532560425102e-01; +5.954180478539239e-03   +7.920024856760715e-01   -1.532018885512971e-01   +3.704043247613562e-01   +4.560262206755835e-01   +5.397517467044581e-01; +2.260746566695304e-02   -1.605783664763700e-01   +1.431055339959074e-02   +3.691171826681783e-01   +2.072902925998114e-01   -3.269322207080240e-01; +4.003827318610016e-01   +5.422895891602114e-01   +4.257307372732802e-01   +6.538465758050438e-01   +1.895500088026819e-01   -7.923690404761846e-03; -1.317074855438014e-01   -3.212730064719512e-02   -1.401776357113635e-01   +3.185078326547290e-01   +1.176981748847872e-01   +7.287388953338769e-02];
L5_Input1_iAMPA_netcon = [+3.518691215494705e-01   -4.079694600402180e-02   -1.053469822996242e-01   +1.397796342122085e-01   +4.639775877622031e-01   +4.170826150694057e-02];
L6_Input2_iAMPA_netcon = [+2.005140947957635e-01   -3.839086865944974e-03   +4.014377723569368e-01   +2.189281921343385e-01   +6.747345472504134e-01   +1.792046802456312e-01];
L5_L6_iAMPA_netcon = [+6.451860951023849e-02   +2.171687818967646e-01   +2.171164797289545e-01   +5.812183886434676e-02   +3.486186234714615e-01   +5.236965594884346e-01; +3.142274779233527e-01   +5.465322347972799e-01   +6.147893653280194e-01   +8.127533616906824e-01   +6.781196414558217e-01   +5.915662318869725e-01; -2.220324080129747e-01   -1.319726546427946e-01   +1.190014006185140e-01   +3.987427917632160e-01   +3.488992930814849e-01   +2.646145307127108e-01; +9.105070471352619e-02   +1.041327521973420e-01   +7.193942774977459e-01   -2.736310560504949e-01   +9.347740367599541e-02   -1.909262471498399e-01; +2.231782562970991e-02   +1.434135823506318e-01   +8.008030087791262e-01   +1.060451799527223e-01   -1.407799076712735e-02   +2.363751011965284e-01; +4.146243686245301e-01   +2.041681049373722e-01   +8.122365367700407e-02   +5.968535202714207e-01   -7.071715237015773e-02   +3.784820603279310e-01];
L4_L5_iGABA_netcon = [+4.578909689137348e-01   +2.364044993648223e-02   +7.438400105473630e-01   +6.186056066435928e-02   +1.734026949986875e-01   -1.767235193095037e-01   -6.931889237049563e-02   +7.509898949990981e-01   -1.577449966281050e-01   +3.715611977401463e-01   +4.582136461799117e-01   +7.273057573900256e-02; +2.431395359864324e-01   +7.316864033228062e-01   +1.765021886350149e-01   +3.001211669825721e-02   +5.901247659647880e-01   +9.915926039201235e-01   +3.428882818249165e-01   +5.791489385830547e-01   +4.650072121248557e-01   -1.723096638712455e-01   +7.902236241255040e-01   +1.788092373447234e-01; +1.274106696856960e-02   +1.000000000000000e+00   +1.057076456852844e-01   +4.973361965787221e-02   -1.772673400780423e-01   +6.004848610903848e-01   +3.625500102950474e-01   +6.129458635274320e-02   -3.887077887248621e-01   -6.964297041415858e-02   -1.601089714095834e-01   -1.267730596751098e-01; +3.366570137291363e-01   +1.318187661716289e-01   +4.344241264169478e-01   +2.019403198140780e-01   +1.038797151038081e-01   +8.842526934026411e-01   +1.313710206926463e-01   +9.416099463113890e-02   +4.889888029006151e-01   +6.035862806005218e-02   +4.871697588600541e-01   +3.424056065249588e-01; +1.226784480388885e-01   +3.470432996046263e-01   -5.843464570411045e-02   +1.442806981561451e-01   +3.706492081478276e-01   +5.010298588409274e-01   +4.841995679808416e-01   +4.674989458382223e-01   +1.649758333123877e-01   +5.650650119032790e-01   +1.343214706045744e-01   +3.707896731122025e-01; +3.543093616449155e-01   +5.413071278380134e-01   +5.989488177902879e-01   +4.015514639190128e-01   -2.484547477199112e-01   +3.532955759372808e-01   -2.948956009214760e-01   +6.338420915690912e-02   +4.096032970325160e-01   +3.595623383136225e-01   +6.284541056831083e-01   +1.661233450044034e-01];
L6_L4_iAMPA_netcon = [+4.904549484190185e-01   +4.787102540459562e-01   +1.582477104070389e-01   +5.616529413823296e-02   +3.911513262939525e-01   -1.648962682204972e-01; +4.349804632259871e-01   +5.247788277483871e-01   +2.792876545399129e-01   +2.713287273892626e-01   +2.610043399119570e-01   +2.808177496461481e-01; +2.701084451221010e-01   -1.299837969935452e-01   +4.261945859619969e-01   +7.939256305041401e-01   +4.565531144172570e-01   +5.840227335711803e-01; +6.962405206435844e-01   +5.419076838907200e-02   +4.466321293285836e-01   +4.866280280240725e-01   +3.262189633727959e-01   +2.884512966230622e-01; -9.227935860918084e-02   +9.971083552805129e-02   -6.182985924765197e-02   +7.140405415258640e-01   +6.690504845642178e-01   +3.104147210905912e-01; +2.148514647805578e-01   +2.348964043242366e-01   +5.815975072201585e-02   -7.121059631996712e-02   -1.429866065195728e-02   +3.093885843377657e-01; +5.610762138464917e-02   +2.890587832911398e-01   +1.589357598128764e-01   +3.592128188980037e-01   +1.882086376902524e-01   -3.918323715402872e-02; +6.013640218927054e-01   +7.112523197051601e-02   +1.390853575126950e-01   +1.867595432525869e-01   -2.712040560308213e-01   -6.709816154607567e-02; +2.271558382844895e-01   -3.061623563803614e-03   -1.077786949436116e-02   +4.655196064546747e-01   +4.103975435090242e-01   -7.672744001988757e-02; +2.174181879772100e-01   +3.355539324185056e-01   -1.156017832204072e-01   -3.785647165876610e-02   +8.512936133236491e-01   +6.004383608742848e-01; -2.142732466402864e-01   +2.091205670589228e-01   +6.254096448336592e-01   -1.151505270736763e-03   +5.405080729325131e-01   +4.651955789471476e-01; +1.124700038315877e-01   -2.685146562998715e-01   +3.568434535290500e-01   +3.291118904334259e-01   +9.058453764055356e-02   +6.036082114969936e-01];
L5_L4_iAMPA_netcon = [-1.338642108993245e-01   +3.310808759432368e-01   +8.147658084736385e-02   +1.821246917092932e-01   +1.966292143411907e-01   +2.553991979013704e-01; +1.028859141962317e-01   +4.277123639384258e-01   -2.401887343542352e-01   +3.639137675948537e-01   +9.707679143974718e-02   +5.183442160069269e-01; +2.180080150242711e-01   +2.165828952496383e-01   -3.306692029145526e-01   +4.660503122471237e-01   +1.707669173375223e-01   -1.288423308299162e-01; +6.786488862350581e-01   +1.199857503351801e-01   +3.212283728454318e-01   +2.559924069395700e-01   -6.224810684864529e-02   -1.701876332043393e-01; +3.296092221646206e-01   -2.126350751626566e-01   +4.510492399169257e-01   -1.022750039257763e-02   -1.195322415404391e-01   +2.648514866922001e-01; +4.622730017116776e-01   -1.712754434516765e-01   +5.758772655999447e-01   +7.142281431710678e-01   +1.285676503651604e-01   +3.222885280842918e-01; +8.328920337362983e-01   +5.568087324777266e-01   +3.933092006470182e-01   +4.363294592247353e-01   +7.116442800248651e-01   -8.794773279942729e-02; +6.205814756291836e-01   +7.205907799716091e-01   +4.920573926207292e-01   +9.211800370733073e-02   +3.735185329127841e-01   +3.116521437022455e-01; +1.352639927733990e-01   -2.554908757773597e-01   +4.139923537473069e-01   -4.148636689879328e-02   -2.436380559206404e-02   -1.936686588690159e-01; -6.716500888393941e-02   -6.129770843608939e-02   -5.094537388300141e-02   +3.346453154602890e-01   +2.621917498916031e-01   +6.100748638590694e-04; +1.435730530572367e-01   +5.021104785279114e-01   +3.314802687799666e-01   +3.779277404236591e-01   -1.189156343504685e-01   +2.462648708931946e-01; +1.000000000000000e+00   +4.130172887339046e-01   +5.996442804112563e-01   -6.366215069469804e-02   +5.756546612877266e-01   +3.951412709811822e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
