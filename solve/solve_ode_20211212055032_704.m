function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+7.836510900886633e-01   +4.306457916276131e-01   +7.511011193502179e-01   +6.612127750180899e-01   -1.922676159305305e-01   -8.472254109276731e-01   -3.302238499870297e-01   -1.939013926790566e-02   -6.281593043148969e-01; +3.503237193004952e-01   +1.918813741437064e-02   +7.277032922941007e-01   -4.380054682127384e-02   +1.458593840009749e-01   -7.082775244173320e-01   -5.383214259278706e-01   -7.679549987085822e-01   -1.605511693868550e-01; -7.547720654566726e-01   +4.190942254640961e-01   -3.942722546371386e-01   -4.345402127745697e-01   +5.459307907120968e-01   +7.697852648873869e-01   +4.949783726364226e-01   +8.285366214057707e-02   +5.348414689839921e-01; +4.862015823726994e-01   -2.689354516919228e-01   +2.980025199147665e-01   -6.770781302985257e-02   -5.608072015042581e-01   -5.465686609127614e-01   +6.453338280689416e-01   +3.023155760497324e-01   +8.316504422822341e-01; -9.521589966031132e-01   -1.051793552442495e-01   -1.484254501639130e-01   -3.213748597264363e-01   +7.956234444144507e-01   -3.151686398385270e-01   +1.140418198421674e-01   -2.388313731016934e-01   -6.963113890040140e-01; +7.213915105895886e-01   +8.305788543144339e-01   -8.358398218234303e-01   +6.050738924868824e-01   +2.864980367873241e-01   +3.547141756295905e-01   -2.710743401127320e-01   +2.011435415539561e-01   +1.335154880815775e-01; -3.395181232587499e-01   -4.167683789914363e-01   -2.372315866779089e-01   +6.905598687324681e-01   -4.955683743718680e-01   +9.421969896181071e-01   +4.414275468258413e-01   -1.205863130582190e-03   -1.949026985830021e-01; -2.542135838693391e-01   +1.000000000000000e+00   -7.137869855816499e-01   +5.707268241311597e-01   -7.922162758934103e-01   +7.024853727804100e-01   -2.341729223052882e-01   -8.199083100356851e-01   -9.502613632903171e-01; -1.862190245689021e-01   -9.764865841502290e-01   +4.368723760834642e-01   -7.844232617722392e-01   -1.303058223948122e-01   +1.510311343328675e-01   -6.487884917726855e-01   +8.125455493238666e-01   -2.398203908547906e-01];
L1_L2_iAMPA_netcon = [-4.453942548870489e-01   +8.240123096623695e-01   +7.965385334525091e-01   +6.420792223368013e-01   -7.484707749529632e-01   -4.610995334355690e-02   +8.785361023676536e-01   +3.007901224950291e-01   +3.935596423224250e-01; -2.834262055447977e-01   +2.192860264079193e-01   +4.699158820710873e-01   -1.191523582573546e-02   -1.060945266805379e-01   -3.806794868115491e-01   -6.026933911821084e-02   -1.000000000000000e+00   +2.917752355335040e-01; +4.241207901760583e-01   +2.389599872856309e-01   +8.423071587231179e-01   -6.772427009483125e-01   +1.462952039318485e-01   +2.510422577674819e-01   -2.962154571161685e-01   -8.343428944017810e-01   -7.342936912620711e-01; -8.842780033296026e-02   -6.783873277041618e-01   +1.401658667919484e-01   -2.824077197409278e-01   -4.808060773758518e-01   +3.363213066453449e-01   -3.369280185191598e-01   -4.606851725768276e-02   +5.356143653830967e-01; +4.865034589367492e-01   +2.158597318434369e-02   +8.457095922488358e-01   +2.019332811460554e-01   +2.538763431815751e-01   -4.483727514645283e-01   -8.077287931861258e-01   +1.586727287861881e-01   -7.245126796355388e-01; -4.901027621825366e-01   -5.527346065954843e-01   -3.656922295986658e-01   +1.742590218352112e-01   -6.757757827597481e-01   -6.376229461841276e-01   +3.599776256103111e-02   +3.600368200635596e-01   -2.939140080736618e-01; +4.499435479496897e-03   +6.679620629807944e-01   -3.397034274531124e-01   -1.090443369993030e-01   +6.019188796243830e-01   -8.533152089388737e-02   -4.862007406437280e-01   +2.427144036815923e-01   -3.593417850781145e-01; +4.615359726938662e-02   +6.383112239163249e-01   -7.159103484133509e-01   +6.558351247074843e-01   -6.010439807412262e-02   +2.780109378694665e-01   -7.656665120096365e-01   +2.811995177151793e-01   +2.830381211936062e-01; +6.160650755182615e-01   -8.901235094982933e-01   +4.895356912554248e-01   +1.160189961869105e-01   -1.911724604661449e-01   -7.019640992251801e-01   -5.490716852393793e-01   -4.797777874162878e-01   -9.126767893470474e-02];
L2_L5_iAMPA_netcon = [+4.759246522420618e-01   -7.754770334579979e-01   -9.974809736456884e-01   +7.595501230644580e-01   +7.325491061274155e-01   +2.492372534151724e-01   -7.696956693738394e-01   -8.927932591617554e-01   -6.001377482020601e-01; +3.229648155113841e-01   -3.186758302541987e-01   +6.519251562251995e-01   -7.095180463549494e-01   -5.859029404127274e-01   +7.265503721517550e-01   -6.762354219958300e-01   -6.531551097007220e-01   -5.853950494371783e-01; -6.385832863003668e-01   +1.070500315399614e-01   +7.858004606313101e-01   +7.530661096739948e-01   +1.248290732473807e-01   -7.330063598360423e-03   -8.910994316315473e-01   +4.298277146201646e-01   -7.028691143549709e-01; -9.691509403403978e-01   +9.554174221637683e-01   -2.843680609542102e-01   +1.000000000000000e+00   +8.421784040669231e-01   +5.544361218922829e-01   -2.210447208726244e-01   +2.038601342709619e-01   -7.817954806221535e-01; +5.322317719910599e-01   -7.603316206180120e-01   -8.175273601873880e-01   -2.070624521851301e-01   +5.347648893256944e-01   -7.851363705803610e-01   -4.628285664672512e-01   -1.258399736561692e-03   +5.017662585143611e-01; +3.997630049907775e-02   -3.146145488307818e-01   -8.945957522236727e-01   +2.209207224938820e-01   +3.562646023077631e-01   +5.197556528183837e-01   -8.991048442330203e-01   +1.234939637977181e-01   -3.384324273680021e-01];
L5_L2_iGABA_netcon = [-3.701639412902705e-01   +6.469360330304590e-01   +3.895172566902427e-01   -3.021470751332900e-01   -9.541285040094692e-01   -6.140130657172641e-01; -6.668458533958960e-01   -6.920795842432564e-02   -8.840437454123347e-01   -4.129832477496620e-01   +3.473121258474841e-01   +2.544161031495431e-01; -4.843985719679259e-02   +1.780150903300871e-01   -7.038768492621903e-01   -4.847785167345436e-01   +2.811703210815212e-01   +2.322161603082793e-01; -2.701522083168699e-01   +5.110014013832976e-01   +6.070242272076068e-01   +4.521394912531922e-01   -8.473566651822316e-01   +2.722936527241306e-01; +9.780932208430214e-01   -1.090309124319906e-01   +5.161392077840689e-01   +4.824292370872149e-01   +7.968485671768448e-01   +8.147978660817133e-01; -1.740184546819865e-01   -3.487753320185575e-01   -1.207378688488534e-01   -1.000000000000000e+00   -1.544364523746739e-01   +8.096250539941234e-02; +1.685571251623646e-01   +3.618101338831552e-01   -7.347106438048963e-03   -6.518833682110355e-01   +5.261506575861031e-01   -5.136188845789442e-01; +2.085947418454754e-01   +1.387633903286924e-01   +8.191322976736243e-01   +5.478767082366178e-01   +7.136002429303004e-01   +5.046532515620548e-01; +8.094863990341126e-01   -3.746678436865836e-01   +5.060797384727334e-01   +3.036496324510490e-01   +2.564712887782998e-01   +6.354017786941143e-01];
L3_L2_iAMPA_netcon = [+7.604514978872827e-01   -8.509370354741425e-01   -2.700343434006758e-01   +7.606981359440761e-01   +2.977641207199519e-01   -4.625770396310513e-01; -5.055262593462836e-01   +1.224204865200378e-02   +2.298980988674147e-01   -5.791812565310662e-01   -9.686901240126511e-01   +2.461371165513763e-01; +7.230006683028943e-01   +2.744525942366133e-01   -2.641100945192647e-01   -3.799701801083464e-01   -3.467595447515529e-01   +7.117100937909687e-01; -3.996175007399010e-01   +4.625929077488715e-01   -3.814017944606115e-01   +9.179297369934081e-01   +8.193143019856134e-01   -5.085380324806168e-01; -3.094074456316238e-01   -7.243458563768691e-03   +2.187696283317259e-01   -7.804981588803038e-01   -7.258479315796108e-01   -6.027588958790766e-01; -9.025490515941049e-01   +7.795826936903901e-01   +3.913193321578262e-01   +1.000000000000000e+00   +4.347703425676763e-01   +3.460606756886586e-01; -5.977079281539563e-01   +5.619955940496476e-01   +8.134809886737547e-01   +1.084528073633377e-01   -3.896111389032824e-01   +8.800680115202056e-01; -7.277080017813915e-01   +4.127753935168784e-01   -3.541295323833704e-02   -5.649834779705495e-01   +8.278400962884931e-01   -7.921535840536731e-01; +7.534866444285638e-01   +7.217493128990854e-01   -1.918343647514447e-01   -4.056196775705398e-01   +4.864790809385422e-01   +4.615963764059711e-01];
L2_L3_iGABA_netcon = [+4.623878135873143e-01   +5.187765905095161e-01   +7.440116613875978e-01   -7.256877533158673e-01   +5.861287046044820e-01   -3.032786828329515e-01   +3.354683479702157e-02   -7.066259952509747e-01   +1.017872804969174e-02; -2.663456537436260e-01   -6.155035252695639e-01   +4.787230426808938e-01   -8.509398030674159e-01   +1.064380538747181e-01   -5.344733239247211e-01   +3.612704644446294e-01   -7.147137050832317e-01   -7.005733191089311e-01; -7.529144208294610e-01   -8.707568884543307e-01   -6.812361387348700e-02   -3.362202593803591e-01   +5.260793414655850e-02   +8.845134185611676e-02   -5.844211497252415e-01   -5.714884470257905e-01   +7.271324600738283e-01; +1.880211627044829e-01   +4.574709038709333e-01   -6.429205752270782e-01   +4.397642106337111e-01   +1.785151866789022e-02   -1.000000000000000e+00   +2.157182708022063e-01   +1.481727201435663e-01   +2.652213985428401e-01; -8.030256189938810e-01   +3.309343462058318e-01   -6.723565531788953e-02   +7.300213467248743e-01   +5.236384584350076e-01   -3.977128195789325e-01   -2.390534084959125e-01   -1.236425579265256e-01   -8.926222333087261e-01; +8.469618944707125e-01   -8.436545960880518e-01   +6.672494887332736e-01   -4.737750821348820e-01   -4.879864817653879e-01   +4.538156128807780e-01   -1.151315956176591e-01   -3.121911128263257e-01   +4.086719628441177e-01];
L1_L4_iGABA_netcon = [+1.861921368344639e-01   +4.103003689840088e-01   -7.167159396633899e-01   -4.250178116623051e-01   -2.350014420535976e-01   +1.409792562931688e-01   -4.635240002574732e-02   +2.005219917991821e-01   -8.026337934863963e-01; -5.746960128796155e-01   +6.895458993317143e-01   -8.522145382170635e-01   +4.236519259344828e-02   -1.000000000000000e+00   +3.091110359597607e-01   +1.665826265915351e-01   -4.248122656970206e-01   +7.517767333322918e-01; +9.143218671571297e-01   +3.823578238395305e-01   -3.795795786478868e-01   +9.775960830650018e-01   -3.633441347520474e-01   +6.533911861697664e-01   -2.101031416269569e-01   +6.407010139516608e-01   -5.848237676721153e-01; +5.216115911521921e-01   -5.782757868510826e-01   +8.352873803045890e-01   -6.833901805034599e-01   +9.671690800452631e-01   +4.536300820990375e-01   +9.023431616030142e-01   +6.846043930840205e-02   +7.808122109286340e-01; -4.142020726781859e-01   -6.890709650251261e-01   -6.318133268118133e-01   -8.239948931416693e-01   +2.218010538969794e-01   +4.220927410314484e-01   +8.543320930496041e-01   -6.231766133265145e-02   -4.573284239224136e-01; +2.559936937682969e-01   +8.205904914704721e-01   -6.405540014903720e-01   +7.690018545308510e-01   +7.358445285654278e-01   +3.605969032873226e-01   +8.105594711772655e-02   -5.698030330566910e-01   +5.117601437912530e-01; +8.762842181681753e-01   -4.570567554475192e-01   -4.902911739096524e-01   +1.562897307470853e-01   +2.849596840810548e-01   +6.383722648967601e-01   -1.176284853091102e-02   -7.060574200733594e-01   +2.402482203242718e-01; -2.142815787692736e-01   +4.190399994724303e-02   +5.421171402810818e-01   +6.909341519861418e-01   +6.519705253080749e-01   -3.112977162401336e-01   -3.147071273930093e-01   -4.797922116982949e-01   +1.447235897072278e-01; +6.696243100932583e-01   +6.852521827193370e-01   -6.423502253902033e-01   +6.752999723685126e-01   -9.879111027247308e-01   +5.383277118837477e-01   +3.115652198905307e-01   -6.092670359435927e-01   +5.490781215298669e-01; +6.554376123202197e-01   -8.110074476664957e-01   +3.895382941788844e-01   +4.306789758011207e-01   +3.274204537198949e-01   -7.127306734186963e-01   -3.511775724140083e-01   +7.952954340176144e-01   +2.056177940361661e-01; -5.403185930509347e-01   -8.051947945403364e-01   +7.046411435624983e-01   +7.655857876380356e-01   -8.183127281415878e-01   -6.578912232979773e-01   +2.043430943145195e-02   +9.863897972690516e-01   +2.013697802845929e-01; +3.200820085509138e-01   -3.474794783163266e-01   +3.113146135308800e-01   +3.325557698984714e-01   -9.548222672648720e-01   -3.054504414090844e-01   +3.808229216150236e-01   -8.169950267544055e-01   +9.384837940250200e-01];
L4_L1_iAMPA_netcon = [+2.098066887732234e-01   -2.525102010832859e-01   -7.503635064502535e-01   -5.416875127044314e-01   -3.093022403252653e-01   -3.651568834180223e-01   -1.988916532902216e-01   -7.836705415411555e-01   -6.091067962437584e-01   +2.760094263478196e-02   +5.398262783525279e-01   +3.584797851257239e-01; +3.961185961855839e-01   -4.333335695960315e-01   +2.004724215705172e-01   +7.471180402416508e-01   -5.643882632770375e-01   +4.251537218594088e-01   -5.382743395401683e-01   +5.941310039788539e-01   -1.425334785048680e-01   -3.719205813918905e-01   -4.627712633176876e-01   -6.173996276213206e-01; -8.575376502184431e-01   -8.905086303035306e-01   +8.102651651611822e-01   -4.049850354378172e-01   -4.154336604835529e-01   +7.714434686565987e-01   +6.524169824342997e-01   -8.854469373794807e-02   -4.668227950101343e-01   +2.854697039081425e-01   -7.037890735161562e-01   -1.494959276206839e-01; -2.153545578654586e-01   -5.277167798463970e-01   +8.897910123695683e-01   +2.774847955839826e-01   +4.126805527220592e-01   +3.070232763913975e-01   -2.695061652694399e-01   -4.421981747269497e-01   -3.920846117874070e-02   -3.087108070326490e-01   +6.682071161539083e-01   +3.859610268500996e-01; -1.452159305927598e-01   -7.019739471785352e-01   -6.715441671482825e-01   -4.391350621435100e-02   +8.279370879988693e-01   +7.784829326557757e-01   +4.107317357773805e-01   +6.756128522814581e-01   -6.594392870221336e-01   -7.174676711448884e-01   -1.880945857818343e-01   -4.663036388358335e-01; +3.647157133658525e-01   +2.180354324024336e-01   +9.824995405605124e-01   +9.801163889869244e-01   +7.309271463091223e-01   -2.556523515712907e-01   +5.368256087658709e-01   -5.704961138041594e-01   -9.925976634520979e-01   -8.509638851260916e-01   +6.834391298757385e-01   +9.315107428655094e-02; +3.673362860570793e-01   +2.744791167236849e-01   +4.087060863468489e-01   +3.829532684229895e-01   +8.830955199295146e-01   -7.797346532939825e-01   -7.334259195379874e-01   -1.727849332288690e-01   +7.756103619264338e-01   +4.937249851702327e-02   +7.907273430479200e-01   +3.758424296604581e-01; +6.116729463198841e-01   -5.355722310230317e-02   +3.724598487746696e-01   -8.718134877505225e-01   +7.067571100054396e-01   +3.900132627835965e-01   +6.558654228582772e-01   +4.104220205560151e-01   -5.889644868115887e-01   +5.178258892687281e-01   +9.312704603570261e-01   +3.475297727119928e-01; -2.159165848766249e-01   -6.863332176678898e-01   -8.046487217142737e-01   +4.520460018206223e-01   +7.289668078418401e-01   +1.320203122603395e-01   +4.353680260553988e-01   -3.003460313380444e-01   +4.690337500137256e-01   -1.000000000000000e+00   +2.949509293337527e-01   +6.663439165115778e-01];
L1_L3_iAMPA_netcon = [+5.809196436054606e-01   -4.502555776574573e-01   +6.557781767089109e-01   -4.073705910201624e-01   +4.675797339819938e-01   +7.317984139189869e-01   -7.493235075107577e-01   +2.516043520186438e-01   +1.419377863056182e-01; -5.575234619918518e-01   +5.975287667639201e-01   +1.859113622335836e-01   +5.991223748015523e-01   +2.629637430076195e-01   +3.010571895201957e-01   +9.606204466128666e-01   -9.244291227820612e-01   +4.603686808207596e-01; +6.178556547580498e-01   -4.691983833456656e-01   +7.959703096815368e-01   -2.024933417761988e-01   -3.345007307609286e-01   +4.139290695539216e-01   -4.959420323089157e-01   -7.062505720440277e-01   -3.797421520848537e-01; +1.000000000000000e+00   +4.545729437954016e-01   -2.051240300705242e-02   +8.826177305388547e-01   +7.284235821169521e-01   -7.942319524082132e-01   -8.218598954074084e-01   +2.323460983393872e-01   +9.273331345222814e-01; +4.342751032284249e-01   +7.798019539604211e-01   -1.540657095694672e-01   -7.862414244933509e-01   -4.674371148207476e-01   -1.071565172114292e-01   -8.525953344974926e-01   -7.821387876000832e-01   -5.707013612115864e-01; -1.663580070394163e-01   +5.744128682766940e-01   +4.497049923849226e-01   -5.336887547711116e-01   -4.596807637033601e-01   -8.205134176387477e-01   -7.263705449250770e-01   +1.118897507254831e-01   +4.991293653574145e-01];
L3_L1_iGABA_netcon = [+4.798722187775482e-01   -2.155883083614149e-02   -5.187548390300175e-01   -7.398064155386552e-01   -8.020978473963084e-01   -1.019509095852921e-01; -2.318996527485817e-03   +8.814768504840563e-01   +5.352967011227791e-01   -7.815986727147414e-01   +8.861878907234215e-01   +6.701757749051982e-01; +7.638491053587839e-01   -4.899263371505123e-01   -2.461033466571764e-01   +4.451620385495776e-01   -6.564755732132751e-01   -3.764931193591101e-02; -2.185346150115189e-01   -3.501333473235264e-01   -7.320074551359407e-01   +5.370113845736041e-01   -4.768363481931923e-01   -5.911142280955058e-01; +4.358883107480107e-02   +4.153249456886637e-01   -3.438227689218525e-01   +6.845831608254154e-01   +1.679547663533775e-01   -8.749100284603697e-01; +1.000000000000000e+00   -7.218275577338264e-02   -6.098257258842148e-01   -2.811526357147887e-01   -5.994276287572655e-01   +8.242514299093077e-01; -1.270047657937674e-01   -7.590675988627839e-01   -6.171549992589354e-01   +2.917489917281736e-01   -2.963003370222125e-01   +3.983976647431661e-01; -4.556969725116664e-01   -3.138512447576760e-01   -8.137221285707857e-01   -4.170712921568762e-01   +3.629256378726571e-01   -5.018058958553829e-01; -8.470495455249059e-01   +6.849242466519473e-01   +6.397789450667500e-02   -3.883095031980849e-01   +3.435518519639350e-03   -7.172093305922279e-01];
L5_Input1_iAMPA_netcon = [+3.098487218585098e-01   +8.280378881655755e-02   +4.916925422223289e-01   +1.000000000000000e+00   +2.506689042071837e-01   -5.873891244414651e-01];
L6_Input2_iAMPA_netcon = [-7.951041653346389e-01   -3.400373612834156e-01   +2.895164910673814e-01   -5.662788852724551e-01   -1.000000000000000e+00   +6.901068412809682e-01];
L5_L6_iAMPA_netcon = [-2.239976916133902e-01   +7.113540513549323e-01   +1.240949326141263e-01   +1.000000000000000e+00   +7.334917540747129e-01   +3.804126783996379e-02; -3.954195744396362e-01   -7.723701109078057e-01   +8.419714757523650e-01   +5.978054296953218e-01   +4.301326003158414e-02   +4.712209744059490e-01; -6.561469014990357e-01   +3.293443957337294e-01   -3.848150086816305e-01   -8.634113175027424e-01   +1.080639885775594e-01   -1.256937442705965e-01; -3.871299433231120e-01   +2.914255612417465e-01   +2.607603138873168e-01   +8.908664093502900e-01   -1.683694753119870e-01   -4.613911802410479e-01; +8.200832172745118e-01   +8.818874518100984e-01   +9.007863141043371e-01   -7.366116351760106e-01   +3.465459018724845e-01   +4.872845012304551e-01; -7.170497008234151e-01   +2.133520619438856e-01   -5.276501752310818e-01   +1.055476922354632e-01   +3.576050486925834e-02   +2.397322360830066e-01];
L4_L5_iGABA_netcon = [-7.889725960354099e-01   -2.574105956973787e-01   +3.310107594920527e-01   +8.326734592317842e-01   +9.266500611497553e-01   -5.309839531098399e-01   -6.767207359787947e-01   +7.509491704234522e-01   +1.031671954447467e-01   -8.072286868438825e-01   +1.544022920324992e-01   +5.787529551279804e-01; +4.524101770543624e-01   +1.139478281269239e-01   +1.963931161607436e-02   +5.320283245770447e-01   +7.382509516123258e-01   +8.064554084666836e-01   -4.395745413003557e-01   -2.296356165612440e-01   +1.594929443673973e-01   +3.955323539566823e-01   +7.030833168152041e-01   -9.183035236782214e-01; +7.260838868754308e-01   +7.129594743751760e-01   -6.555418340928345e-01   +7.537006205669837e-01   +5.177938573873019e-01   -2.895109029564714e-01   +7.957690227980468e-01   +7.153067296734273e-01   -5.823371651581813e-01   -5.074502104788496e-01   -5.111327411409845e-01   -6.781261590919218e-03; +3.612546545949022e-01   -3.001038363562147e-01   -2.038528615867513e-01   +9.438491525549930e-01   -4.821381175789320e-01   -5.687571950930974e-01   +9.861403077800518e-02   +5.538635056437875e-01   -5.112108849977484e-01   +4.330636892169865e-02   +7.104416071395606e-01   -6.361715832952350e-01; -1.579611013652478e-01   -2.430629524318512e-01   +7.410197842722231e-01   -3.169368808516584e-01   +5.747256606432851e-01   -8.061483047802290e-01   -4.423273534755295e-01   -5.318245569968483e-01   -6.849611166283637e-01   +9.534721233493274e-01   +1.323315574090098e-01   -1.961881514164796e-01; -9.248518859468975e-02   -1.836681289985939e-01   -2.020564322988492e-01   +6.892579543238769e-01   +1.196498361788365e-01   +2.690141874135211e-02   +1.000000000000000e+00   -5.856357934756684e-01   -9.395038756866625e-02   -4.331002311446704e-01   -4.996974842277376e-01   -7.143649826322218e-01];
L6_L4_iAMPA_netcon = [+3.774580137044441e-01   -4.967447439936091e-01   -3.074070065552232e-01   +7.737836641444400e-01   +2.312083098474798e-01   +6.889163428474548e-02; +9.213354694370844e-01   +2.721031089475854e-01   -2.937285192270115e-01   +5.518727133532814e-01   +8.912266506469272e-01   -1.834885818551019e-01; +6.831594442170694e-01   -1.355183180866215e-01   +6.748051905245809e-01   -3.616770434223365e-01   +6.819058877576822e-01   -2.780222882153837e-01; -7.374241042479724e-01   +2.490920495034243e-01   -9.225643297997511e-01   -5.115561957145884e-01   +4.332110015632201e-01   -6.724867510131964e-02; -6.778917703098745e-01   +2.724051237158751e-01   +1.079341172655408e-01   -3.043565843239174e-03   -9.728202457060844e-01   -3.476502489171769e-01; +6.872595745539477e-02   -2.153177954151505e-01   -5.446556479132240e-01   +8.173343202484087e-01   -6.884371809671274e-01   -3.790022606185187e-02; -2.436264101072410e-01   -4.896146198854204e-01   +6.084935301281170e-01   +9.336063631744871e-01   +6.477285998450145e-01   +7.774647734242692e-01; -8.872911775403792e-01   +2.167724834442995e-01   -6.432550907813139e-01   -2.357117134162058e-01   -5.150304472892751e-01   -9.931045876954599e-03; -8.304819799620518e-01   -1.106511298536720e-01   +3.843725263926089e-01   +5.440677974215065e-01   -2.666606620944916e-01   -5.849198102650104e-01; -7.269260996429092e-01   +3.286826376403498e-01   -6.584369098013400e-02   +8.527634933827881e-01   +5.944433884771583e-01   -7.528356003883163e-01; -7.688814343891888e-01   +4.643748406521200e-01   +1.000000000000000e+00   +5.847120350705384e-01   -5.203960089310018e-01   -1.237743239934304e-01; +2.588526890919724e-02   -8.440156229317904e-02   -1.077460159998343e-01   +6.726610715764867e-01   -8.629666123666625e-01   +2.374134584118208e-01];
L5_L4_iAMPA_netcon = [+7.459185252946794e-01   -5.955289211854846e-01   -8.812613722401252e-01   -3.226792040215511e-01   -5.587506897636987e-01   -7.747505088854280e-01; -7.370496241007684e-01   -7.838604845750619e-01   +3.278023745280773e-01   -2.846472739624622e-03   +2.953227076892926e-01   -2.268116754974924e-01; -6.829944065374861e-01   +7.774921513541294e-01   +1.000000000000000e+00   -1.620886565751364e-01   -4.553061057898132e-01   -5.457551990442444e-01; -4.874674753652500e-01   +4.200625913101166e-01   -9.427616901114059e-01   -4.699485610860708e-01   -6.667551564828523e-01   +4.260220248475722e-01; +4.000755355987327e-01   +5.353596153404633e-01   +2.352180416725334e-01   -2.122653766493181e-01   -4.933472927022812e-01   +5.729967339231481e-02; -1.436239621396752e-01   -7.747695882760791e-02   -3.763277471395579e-01   +5.826969269144222e-01   +1.350791099809282e-01   -5.030757454230321e-01; -1.160563465160934e-01   -3.880488653697011e-01   -3.033810912162074e-01   -3.153483004857462e-01   -4.655956805467820e-01   -1.424609381344532e-01; +8.110339815345368e-01   +7.961697033081729e-01   +1.078458182847315e-02   +2.646832551968447e-01   -8.023083313653687e-01   -1.896197339695007e-01; +1.822089826828786e-01   +5.538434957939001e-01   +8.647630830565638e-01   -8.965646304643979e-02   +2.124425544834960e-01   -7.665138079524147e-01; -6.854815853986992e-01   +7.679090823509818e-01   +5.149484822937592e-02   -6.837800906406438e-01   -2.953756999557416e-01   -9.017494004575359e-01; -6.719562704369166e-01   +5.958197929534215e-01   +1.682840387777824e-01   +1.961612391580491e-01   -2.989526434224770e-01   +7.097611854746841e-01; -6.740001556768023e-01   +4.874551136458559e-01   -7.625781859064486e-02   -3.880736707203510e-02   +4.424713696622879e-01   -5.159098787190517e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
