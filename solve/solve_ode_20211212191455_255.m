function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.245800879286180e-02   -9.192492169610145e-02   -1.180627447892786e-01   +2.693404533085201e-02   +1.155103038229231e-01   +4.073721368358404e-02   -1.322236427838921e-01   -1.078597180014389e-01   -7.958972625739166e-02; +4.493338044187163e-02   -1.701115885903798e-03   +1.134962531122250e-02   -1.514729849695118e-01   -6.776842045890647e-03   -2.456734788003170e-02   -2.300885425442870e-02   +2.247400467872088e-02   -1.148569165490811e-02; +1.025590230310329e-01   -1.097889689836479e-01   -1.139245785180650e-01   -3.696982064057231e-02   -1.160345588185848e-01   +4.070266960612526e-02   +1.068886203406889e-01   -5.134006702055778e-02   -8.167980214086798e-02; -2.910786388729440e-02   +8.593524240153605e-02   +6.034164866710812e-02   -9.767268204259535e-04   +8.360680174520323e-02   +8.972379886625080e-02   -5.940495424528226e-02   +2.567127941453472e-02   -9.677528055364473e-02; -7.816866135017976e-02   -9.758863950217457e-02   +8.131690764963156e-02   -9.096699319175834e-02   -1.049930957386036e-01   -1.300745024191255e-01   +2.181906497136954e-01   -1.150009084885370e-02   +6.767489802232224e-02; +5.887754649984075e-03   -1.034166563083612e-01   -1.386742211080993e-01   -1.413428884795427e-01   +6.141705825241713e-02   -9.696832554694966e-02   +9.288609403342563e-02   -4.376947720305217e-02   +2.991570912664049e-02; +4.233139087813673e-02   -3.709114365305299e-02   -1.096824218577707e-01   +1.129288881519802e-01   -1.024742885818062e-01   +9.438275189405718e-02   +7.603731470085145e-02   +8.088973662619521e-02   +1.562591745239894e-01; -4.467149294698824e-03   +2.396940146364101e-02   -2.066456634442243e-01   +1.041037964167410e-02   +4.871291105441947e-03   -1.331989355772132e-01   +4.036600088832352e-03   +1.065162531161851e-01   +5.922308813848816e-03; +1.546991108532406e-02   -1.769299680008514e-01   +1.145070934675533e-01   -1.812636542047029e-02   +7.542297271617752e-02   -9.810341730383269e-02   +6.281223262054203e-02   -9.038244077980073e-02   +1.071099498320775e-02];
L1_L2_iAMPA_netcon = [+3.652521807255726e-02   -1.052200856701756e-02   -2.660432336205057e-02   -1.262420304065223e-01   -1.396882726312190e-01   -9.017015571030175e-02   +4.971172033434742e-02   -3.462368655294995e-02   +5.262038425175004e-02; +1.177183814981251e-01   -4.608858364695725e-02   -7.061471241266737e-02   -5.925164695480909e-03   -1.222127616230316e-01   -4.737360472771010e-02   -9.470181895174795e-02   -1.227812486118397e-01   +8.308624360015665e-02; -3.909873439245578e-02   +8.386275176657544e-02   +1.071304547776511e-02   -1.474861018362606e-01   +9.158220301224917e-02   +1.220626084947507e-01   +1.253789272494551e-01   +9.002856996650888e-02   -9.596840765352777e-02; -7.894631698791982e-02   -1.946075547063482e-01   -8.411056952444011e-02   +6.342833231532680e-02   -1.253644504328782e-01   +4.847589310155169e-02   +1.880463909348172e-02   +6.696729627809542e-02   -4.724511442152334e-02; +6.660494574708414e-02   -8.482987907180986e-02   +5.582198000025915e-02   -4.916961144112954e-02   +4.509094881848258e-02   -6.721318566727214e-02   -1.339740534571792e-01   +1.530248841532782e-01   +6.927291546705677e-02; -3.334889610609300e-02   +4.462295597190512e-02   +1.475816113526366e-01   +7.369354847245593e-02   +1.381091622160214e-01   +4.077504996946318e-02   -2.713480782502542e-02   -1.263611131225906e-01   +2.050632156452951e-02; -2.828022511961418e-02   -1.111017446680305e-01   +1.266878656545699e-02   +3.401764518695909e-02   -7.698057627458843e-03   -1.162153011167786e-01   -8.662929768725056e-02   +7.191708947637443e-02   +2.419103418596003e-03; +1.203374980462065e-01   -7.813920503863039e-02   +1.602758788810457e-01   -3.132171522221133e-02   +1.964951640054672e-01   +1.179909317351188e-02   +8.508963285169671e-02   +1.967835215834534e-01   -1.039782294254888e-01; -1.390076245130279e-01   -7.390040871335013e-02   -1.358311152077597e-01   -8.851227460085202e-02   +9.249644710109924e-02   +4.755481639843567e-02   +7.154314219879382e-02   -7.411554971411811e-02   -1.414742297733534e-01];
L2_L5_iAMPA_netcon = [+1.380159882703467e-01   -9.307833631464490e-02   -7.307345049564298e-02   +5.553648233672445e-02   +1.461666936611092e-01   -1.443522249093427e-01   +6.776518642066635e-02   -5.971282667310131e-02   +5.605542343009121e-02; +4.466265229702921e-02   +7.214557023950484e-02   +9.821756818924000e-02   +1.369791336825490e-01   -9.568519324167223e-02   -3.392865160271230e-02   -2.078536468557633e-02   -8.302420584932346e-02   +1.344962013132449e-01; +4.638232007756350e-02   -5.058934334773139e-02   +3.001630221784971e-03   +1.866225112722039e-01   -9.452665339026103e-02   +6.231713599967403e-02   +5.761769534123144e-02   +1.928251601620056e-02   -1.009294041164912e-01; -1.447166882306889e-01   +1.146861062148429e-01   +2.557794938849126e-02   -2.080927073772622e-01   +2.017400632390352e-01   +1.913161315193068e-01   -8.002919891812282e-02   +1.324237171910584e-01   +5.524254899855555e-02; +2.016067818533848e-01   -6.079563427015266e-02   -4.768022177191344e-02   -7.159249280641752e-02   +1.218708479982944e-01   +4.417645799280615e-02   -5.989989244949620e-02   +9.499982211338059e-02   -1.283548116934034e-02; +1.390856679360035e-02   -1.604641766150343e-01   +1.075077269232465e-01   -1.807869091818809e-01   +2.809584462192505e-03   -1.309917035311105e-01   -7.388161752443730e-02   +3.072948168989277e-02   +1.473865746778453e-01];
L5_L2_iGABA_netcon = [+7.424886936190332e-02   +6.181153125578975e-02   +1.967744045140473e-02   +5.200136046909670e-02   +9.223624331623169e-02   -2.714487117514483e-02; -8.358730179944690e-02   -2.166243106975309e-01   -1.670310242247512e-01   -1.217125337293386e-01   -1.589867243384687e-02   -2.856626679480096e-02; -1.501500567775151e-01   +2.731126836567402e-02   +1.292910099979513e-02   -2.664434019445643e-02   +8.606302288869805e-02   +8.425757168700398e-02; +1.931841199076872e-01   -1.322293687159204e-01   +5.050409149836906e-02   -6.899234488091326e-02   +9.683276897040207e-03   +3.074004321520644e-02; -1.110098968034941e-02   -8.277535762265167e-02   +4.414755148738674e-02   -6.760514993806541e-02   -1.201812079033958e-01   +4.880735265961095e-02; -1.525829952236882e-01   +1.375698261515992e-01   +5.066273444205280e-02   +1.271827921755659e-01   +1.159038485569754e-01   +2.328866144041822e-02; -6.480856593208627e-02   -1.189625098848815e-01   -1.078611368756066e-01   +5.979330406191330e-02   +1.918991910739972e-02   +1.809709699199723e-01; -1.020036808710152e-01   -1.552729573461574e-01   -1.138706587504716e-01   -9.292085079326226e-02   +1.723956048874296e-02   -5.615973271439037e-02; -1.290677322430159e-01   -9.954802003846508e-02   +2.314002776792020e-01   +3.890743650423269e-02   -1.779788106295646e-01   -4.644499909032089e-03];
L3_L2_iAMPA_netcon = [-3.971350504738583e-02   -1.640952760684868e-01   -7.753868952679363e-03   -1.055864447659155e-01   +7.914576581303068e-02   -1.099077297849994e-01; -1.361889287867853e-01   -6.409909952362608e-02   -8.055736563852522e-02   +2.787064175832946e-02   +2.408883435617949e-02   -1.135004334871467e-01; +2.092843632504811e-01   -7.477415162288781e-02   -5.992830662784793e-02   -1.821033142751013e-02   -3.403007452848898e-02   +5.586014335821971e-02; -2.664697958391749e-02   +9.981369909207070e-02   +4.987844301959300e-02   +1.332138018797450e-01   -3.677737197751758e-02   +1.299346388806785e-01; -9.282995804006924e-02   -1.973655379657030e-01   +2.328774945841620e-01   -1.681936791810765e-01   -1.248898682381724e-01   -3.186388459688434e-02; -9.032532513511699e-02   -1.547760292917173e-01   -1.144595402531144e-01   +1.120747774531985e-01   +1.361218367031424e-01   +6.588507713480590e-02; +6.089638615821743e-02   -1.011711592697175e-01   +9.813671136273350e-02   +6.661034287717306e-02   +1.592080561586218e-01   -2.054813459275788e-01; +1.058841046728993e-01   +1.014729204782723e-01   +1.649538587839479e-02   +1.242599407224317e-02   -2.176581571408353e-01   -1.385693782271784e-01; -8.194662744197484e-02   +1.514960481075430e-01   +1.737285862816426e-01   +1.154885054649933e-01   +5.275930456293167e-02   -7.968993220108872e-02];
L2_L3_iGABA_netcon = [-1.660446987168723e-01   -6.437224643809673e-02   +7.897064571619014e-02   -2.330036141025710e-02   -8.905854869090533e-02   -3.481109562194998e-02   +5.983913324478239e-02   +8.734563699924316e-02   -5.024779626989632e-02; +1.341411107356216e-01   +1.004836863235126e-01   +1.768204138948022e-01   +2.160022844596369e-01   -1.276149284507356e-01   -2.760965976861034e-02   +1.386876733517309e-01   +5.528433782478841e-02   -1.652526377132930e-02; -1.208990798315939e-01   -1.189531246582916e-01   -5.407043769742513e-02   +1.239112578066286e-01   +9.503781635348590e-02   -2.678166260540910e-02   -3.677991926543840e-02   -2.354001063458809e-02   +1.240699360249667e-01; -1.331912819572409e-02   +1.428669015164293e-01   -2.785707789737421e-02   +1.341100897712318e-01   +1.298938920425081e-01   +1.018289732746084e-01   +4.369013902921750e-02   +1.772915802644859e-01   +2.284162713726523e-01; -4.675893420075507e-02   +7.726972215250204e-02   +8.063537506550511e-02   -1.202707768746900e-01   -8.584101411218453e-02   -1.463168116453845e-02   -1.335986845717926e-01   -7.805505149629328e-02   +1.960468571405124e-01; +1.284228665176254e-01   +6.648811744424749e-02   -2.643055438230565e-02   -1.528682068116130e-02   -2.010604060194539e-01   +4.105975244754312e-02   -2.607248629571173e-02   -9.798408523287122e-03   -5.850409646428136e-02];
L1_L4_iGABA_netcon = [-2.950662039576405e-02   -1.888907852288319e-01   +1.440662721845714e-01   -3.894829144491314e-02   -1.752850083551651e-01   -5.906162340066087e-02   +1.059749697110488e-01   +6.129263912229357e-02   -1.934246661158439e-01; +2.353135897886126e-01   +8.030560010925904e-02   -1.456928583040669e-01   -1.364991001043155e-01   -1.173322535724028e-01   -1.269198639076330e-02   +1.317965496753267e-01   -1.057791745763012e-01   -3.591357110172483e-02; -4.460449446217306e-02   -1.041767066645351e-01   +8.459031123928411e-02   +5.737542205747134e-02   +9.836709949303947e-02   +5.279311716775300e-02   +2.506644213455874e-01   -7.949480589682961e-02   -1.313672946213285e-01; -7.437627666136189e-02   -3.511398438934880e-02   -8.459573108281319e-04   -3.664780008794216e-02   +2.709680105379993e-02   -4.937465291206924e-02   +1.447022476086496e-01   -5.688934143721164e-02   +1.846146860697613e-01; +1.031296788077497e-01   -1.271929406284850e-01   +4.321069561078487e-02   -1.351673835055046e-01   -4.082326007575249e-02   +8.264592417888797e-02   +8.264168819879420e-03   -2.133804431606440e-01   -4.407067882778645e-02; +1.873460769099913e-01   +7.569407245546195e-02   +1.389880638250763e-01   -2.260482551280281e-02   +6.109592832662217e-02   +1.668992755485034e-01   -9.021614600004232e-02   -6.046033648695143e-02   +1.287575969744214e-01; +2.105522003113591e-02   -5.625899368858813e-02   -2.377908192671598e-01   -1.453620500871337e-01   +5.034869114372816e-03   +1.254747924109573e-01   -1.263531878410806e-01   -5.905082358569107e-02   +1.387536093283949e-01; +1.400734440639772e-01   +1.716656986090327e-01   -1.034377458698913e-01   -1.542671953629652e-02   -1.350900328442462e-01   +1.567413829233971e-01   +8.952905829689078e-02   +1.481312997605057e-01   -1.201403326249085e-01; -9.355827897287736e-02   -9.806070708095377e-02   +4.869319620233868e-02   +1.481052124794300e-01   -9.228989811254461e-02   +4.695060854585274e-02   -9.177430367903082e-02   -4.119311361892315e-02   +1.362411303792770e-01; -7.365480317641643e-02   -6.128759612111765e-02   +1.372024947501240e-01   -7.895464457173901e-03   -1.369159724528758e-01   -3.267854159767744e-02   +1.245825051547254e-01   +1.248320134825872e-01   -3.955682342870777e-02; +1.244418399129525e-01   -7.814310536861355e-02   +1.316229306570849e-01   +1.798562498527372e-01   +9.425029432302109e-02   +1.258540190482214e-01   -6.808283690556230e-02   +1.487592791277291e-01   -9.194810344717415e-02; +1.303905751422485e-01   -1.053029262643145e-01   -6.795412203791865e-02   -3.259592659232580e-02   -1.661916977065173e-01   +2.135859940603278e-01   +1.901432313241415e-02   +3.769073672750314e-02   -1.569039171062133e-01];
L4_L1_iAMPA_netcon = [+1.446738763372531e-01   +4.460801001866096e-02   +3.518239463887394e-02   -7.548604483444445e-02   +1.646820565607850e-01   -5.299732555409061e-02   +1.646986992027057e-01   -2.561462700967915e-02   -4.003016986798072e-03   -1.553642618867469e-02   +1.202924406235415e-01   +2.630598299279849e-03; +1.979857218197024e-01   +1.992367899744039e-01   -1.410927518668059e-02   +1.846591355228568e-02   +8.428611685402095e-02   +4.496783592342900e-02   -1.616888374029201e-01   +7.914967378433110e-02   -1.248408417491009e-01   +8.866451172916257e-02   +1.284619525714055e-02   -6.300974477118751e-02; +2.428565949570518e-02   +1.616176115322753e-02   -4.146895993404429e-02   -1.967120290808474e-02   -7.960903528584584e-02   +1.394262188513354e-01   -4.754840810901022e-02   -1.239280140061301e-01   +1.230448333020597e-01   +8.016230992665099e-02   +1.335153745351329e-02   -1.327077558193817e-01; -8.529690439979840e-02   -1.483310718744306e-01   -5.126102380885374e-02   +4.959176916298115e-02   -1.389700590914625e-01   -1.033478678547087e-01   -4.601750535064997e-02   -5.826056133209240e-02   +1.171942140960021e-01   -2.230775389264185e-01   -1.031709187377083e-01   -5.946085572557498e-02; +8.521886380825111e-02   +1.159574003382710e-01   +1.071916537195480e-01   -3.904983010939414e-02   +2.791790919306428e-02   -3.519285528133005e-02   +4.514586850311240e-02   -1.275716691167202e-01   +4.838182259953315e-02   -5.022928624579649e-02   +6.243311152987842e-02   +1.520347546361631e-01; +6.291681561889925e-02   -8.048866522165188e-02   -2.723647254891215e-03   +1.362047402987665e-01   -8.966991934018843e-02   +1.061554066297219e-01   -3.015668233091687e-02   +8.459783659042902e-02   +5.126822300230799e-02   +7.877835188720290e-02   +1.167196539770255e-01   +8.839445732867394e-02; -7.756617148894822e-02   -7.569623882290788e-02   +5.280916815961333e-02   -8.845092442542370e-02   +7.645743477577571e-03   -1.254810993786640e-01   +2.053735241131649e-01   -1.487183908995221e-01   -1.110591943420121e-03   +1.232337810505639e-01   -1.568341302609473e-01   +7.174475923036243e-02; -1.283144714786314e-01   +1.579016425338692e-01   +3.763079685591697e-04   -9.651537857163947e-02   +1.980867022433676e-02   +2.172184488709375e-01   +2.725698161679025e-02   -4.019405003465230e-02   -2.035998689358944e-01   -1.840092537741147e-01   +3.826991837793596e-02   +1.123575974649331e-01; -1.241254260343054e-01   +3.013540962999064e-02   -7.390648474622200e-02   -7.907566023718432e-02   -1.106868679319040e-01   +1.578471711626503e-01   -7.486477495214514e-02   -7.160864175786946e-02   -2.022628293201518e-02   -2.520194455230615e-02   +7.787086775250163e-02   +3.105078189533622e-02];
L1_L3_iAMPA_netcon = [-1.197492145699344e-01   -5.850120267231618e-02   -4.788110082060520e-02   +1.009603976545780e-01   -1.317287588271382e-01   -1.318030296345958e-01   -6.484165421571894e-02   +6.954554629217426e-03   -6.893818247517298e-02; +1.137421561683237e-01   -4.495384481969424e-02   +1.505496145778734e-01   +1.714403266751336e-01   -2.389058110150916e-01   -6.911948415082329e-02   +1.114599063362028e-01   -4.171345365579818e-02   +2.057065253956979e-01; -7.475248147098482e-02   +1.015490223467871e-01   -8.534909880459562e-02   -8.966704352515971e-02   +6.631271051428603e-02   +1.259975561259966e-01   -6.498344714281726e-02   +5.317423410620293e-02   -1.747218715394355e-01; -1.119476796991793e-01   -6.534994775100958e-02   +1.120940276975987e-02   -8.120754312121180e-02   -8.746245982148276e-02   -1.693727035688136e-01   -5.758088413416532e-02   -3.684403130048206e-02   -3.774715767610408e-02; -5.929459410812722e-02   -7.963931573985972e-02   +9.271654204121936e-02   +5.071948416713050e-02   +5.091786889749700e-02   +4.176489915492956e-02   -1.077719460040807e-01   +5.064959525362608e-02   +1.708672454724684e-02; +6.643673789994806e-02   -2.027034876353559e-01   -2.663873576288080e-02   -3.658175608065811e-02   +1.193779321637199e-01   +1.390543240681835e-01   -7.761259289151934e-02   +4.449310755089247e-02   +6.143407832948743e-02];
L3_L1_iGABA_netcon = [-9.864713905724717e-02   +6.298137244799734e-03   -3.872135005472925e-02   -2.142243277525824e-01   -1.585465646079511e-01   +5.422176377993862e-02; +7.588292160912523e-02   -4.000286401579367e-02   -8.440430500925773e-02   +2.218713215148676e-02   -5.059224372573456e-02   +7.614601328178890e-02; -7.467097672405609e-02   -3.966304719327619e-02   +9.123572147079594e-02   +9.350441124647677e-02   -8.511218238393431e-02   +3.981583250127545e-02; +6.215760115842502e-02   -3.920227347929647e-02   -1.964911483223634e-02   +5.924840983123827e-03   +2.876855463597340e-02   -1.020691587249880e-01; +2.019730684992775e-02   -1.074667060235992e-01   -2.089973189102031e-01   -2.601942738314587e-02   -9.720933949954876e-02   -1.819091922284604e-02; -1.778727022956613e-01   -1.711706052511676e-01   -2.712366438209276e-02   -3.165927855546022e-03   -1.554188988722062e-01   +6.744631032644804e-02; +1.447881290777861e-01   -9.520302586126152e-02   +3.715491526811934e-02   -9.649042078654912e-04   +1.843986109139918e-01   +4.161938220838837e-02; -4.129127300235765e-02   +3.917296552569197e-02   +5.083915714098217e-02   +3.034428119502962e-03   -6.223477707663592e-03   +9.829906502623313e-02; +1.030583233100255e-02   -1.377395905870141e-02   +1.808413747779693e-01   +1.269466930745623e-02   +2.667077418940339e-02   +1.467490485643860e-02];
L5_Input1_iAMPA_netcon = [+9.203868364270711e-02   +9.569430714447962e-02   +1.524498845893614e-01   +7.125242061333374e-02   +3.259585602096157e-02   -6.588368593425528e-03];
L6_Input2_iAMPA_netcon = [-8.612333384095758e-02   -4.871968916131075e-02   -6.624536925799525e-02   +1.507347465428900e-02   +1.461240086599562e-01   +9.716369163428029e-02];
L5_L6_iAMPA_netcon = [-2.368235535854138e-02   +4.184784762183113e-02   +2.498127518983950e-02   -7.140465184367492e-02   +1.879619507714686e-02   -1.769858489723072e-02; -8.829246617862055e-02   -1.423382986020428e-01   +5.026679382211508e-03   -1.052864911591786e-01   +2.056355141318769e-01   +8.815864717401004e-02; -1.265262226605273e-01   +5.071387718241616e-02   -3.226059642998745e-02   -1.802845342475401e-02   -1.406395815556361e-01   +1.283924554537690e-01; +6.714660077995982e-02   -2.382824780126055e-02   +2.166091620360363e-02   +3.985007938254898e-02   +1.915881897893954e-01   +9.886448229903519e-02; +2.281394946336537e-02   -1.310463388179337e-02   -6.162389101021198e-02   -4.290839012969915e-02   -3.691025938719093e-02   +8.534814718792604e-02; -1.020566539879225e-01   +1.194837631696274e-02   +1.292285910962391e-02   -5.428012069981697e-02   -1.969685532206150e-01   -8.215209919077859e-02];
L4_L5_iGABA_netcon = [-5.027563466710025e-02   +4.095110628556720e-02   -2.130711292947467e-01   +1.593146063469397e-01   +1.760034915472162e-02   -1.486944780644492e-01   -1.153929720653080e-01   +1.126419648274783e-01   +3.883076373290840e-02   -1.217978171498071e-01   -7.868878277083073e-02   -2.257351724548338e-02; -1.528288294400656e-01   +3.869979379032773e-02   -6.815766319180458e-02   -1.340322392247227e-01   -1.174039588458009e-01   +1.177877633662243e-02   -1.308094513786277e-01   -3.097613727953555e-02   -1.683428652016271e-01   -9.738809726387689e-02   +8.021983183316961e-02   +3.142564961987753e-02; +1.505341751906669e-02   -1.379005819278363e-01   -3.802990663928017e-02   +4.663226104819390e-02   +1.486104842617405e-02   -1.698314574257962e-01   -8.774829941917588e-02   +4.836314321799707e-02   +5.308376293253286e-03   +1.208156283534603e-01   +1.485312530736709e-02   -2.445188133805118e-02; +1.323300384057737e-01   -5.575176675244997e-02   +1.795077857299800e-01   +1.420583811373749e-01   +1.159554588579139e-01   +1.462186390641553e-02   -6.878229954233583e-02   -1.486200979123923e-01   +8.329126321249523e-02   -1.853633366189985e-01   -2.180507575108898e-02   -1.284927609316208e-01; +2.379667597902364e-01   +2.130551880956381e-02   -1.382400229635528e-01   +1.028563713388521e-01   +1.079975837444655e-01   +1.721046974606508e-01   +4.445307303956370e-03   +1.702981186459993e-02   +5.113000101685899e-02   -1.007435024418661e-01   +1.115502891723208e-01   -1.153342614676102e-02; +1.040055175342648e-01   +9.923552805997000e-04   -9.629312289633429e-02   +1.941234518519474e-03   -1.132603620443401e-01   +7.381629923831291e-02   +1.180695710544728e-01   -1.869387917774462e-01   +8.825603826453329e-02   +6.708183637624796e-02   +2.200387041321963e-01   -3.206763282221251e-02];
L6_L4_iAMPA_netcon = [-7.923852519642668e-02   +3.566554391170625e-02   -4.671392470570274e-02   -1.808209385833440e-01   +6.995683827020246e-03   +8.943633102791773e-02; -2.390674186496998e-02   +2.399448164903382e-02   +1.333480368866588e-01   +4.974584810918346e-02   -6.764742517734779e-02   +1.509180892640281e-01; +1.770275897238498e-01   -4.308939804212709e-02   -1.271362178443981e-01   +8.721015608647409e-03   +1.296004148645034e-01   +1.830708561563879e-01; -9.442892852826516e-02   -4.032068023176309e-02   -1.196810165033213e-01   +1.050198209442981e-01   -1.253789483819048e-01   +1.695632684604401e-01; +9.078460138920771e-02   +1.287350367211761e-01   +1.002069570127209e-02   +9.131887714243841e-02   +4.508940964969094e-02   +9.412085534540315e-02; -4.097663629761229e-02   -8.890484872776436e-02   -3.835200525224281e-03   +1.502408976620915e-01   -1.861179260319045e-01   +2.024235968408385e-02; +9.859595466853513e-04   -6.335772945486884e-02   +1.071341829643659e-01   +5.689565874056057e-02   -1.013949547785143e-01   +1.177684506081927e-01; -8.776054485395482e-02   +1.908694378917579e-01   -7.928295903611167e-02   -1.190762266158436e-01   +1.545033337673107e-01   +1.928554026775636e-01; -6.737761702927675e-02   +6.141039902422815e-02   +1.333842621264845e-02   +1.021830595813577e-01   +5.087372510013669e-02   -8.156414561771266e-02; +1.444396120764158e-02   -3.579503607155902e-02   +4.436853446105275e-02   +8.517996587856799e-02   +1.584119785946892e-01   +5.268531806229508e-02; -1.278244337015426e-01   +1.558591905239235e-01   -1.704383896897920e-02   -9.075245155217733e-02   +2.075738980796247e-01   -6.964412417523816e-02; -3.445684001481684e-02   -7.955202172008352e-02   -1.185911036591795e-01   -5.938879783780376e-02   +1.365135850034066e-01   +5.959335415489542e-02];
L5_L4_iAMPA_netcon = [-3.050445449673041e-02   +1.168192002544335e-02   +5.279020062422829e-02   -3.283987458633279e-02   -4.938654452105423e-02   +2.623823650820278e-02; -1.717871412462247e-02   +1.462568189656281e-02   -3.331744796948425e-02   -2.551141792948083e-02   +3.213751889424352e-02   -1.850670517345886e-02; -6.066892695154161e-02   -2.389719246185025e-02   +1.657589941509870e-02   +8.124067072907509e-02   +6.191721347758729e-02   +1.351332690843097e-01; -1.217870931277954e-01   +1.389438853705690e-01   +1.389790573208144e-01   -5.697486206419532e-02   +1.053561506602273e-01   +1.493970893529160e-01; +7.000814781891423e-02   +1.373062736417741e-01   -8.898233186930299e-02   -3.043311867764678e-02   +6.222978203664071e-02   -2.672242820147566e-03; -7.179973242285466e-02   -1.442263193453543e-01   -1.130479651772389e-02   -9.304320591435947e-02   -1.746880913891632e-01   -7.899208751897989e-02; +5.835749816786592e-02   +1.092990498940339e-01   +1.002350279444936e-01   +2.022649641657088e-01   -8.856009435208775e-03   -1.195328740399391e-01; +1.527903433605071e-02   -1.598904268843550e-01   -2.250867234785477e-01   -7.091829986983743e-02   +1.097844990335578e-02   +2.861126096490539e-02; -1.089617721615047e-01   -1.667793081786677e-01   +2.124508369858967e-04   +3.782165851425036e-02   +1.035889755458042e-01   +1.096277280087657e-02; -3.411724424374044e-02   +9.394285096981519e-02   +6.040055960207337e-02   -3.766758581378546e-02   -7.194185765627273e-02   +1.607049795863825e-01; -2.410665434310987e-02   +6.618117891060586e-02   +1.187434996223996e-01   -1.509560443933883e-02   -4.635060476574019e-02   +1.877225833409835e-02; +1.122567505624398e-01   +6.825881142033768e-02   -4.220628670696333e-02   -8.344940464142975e-02   +2.380034412159474e-01   +1.168984811999554e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
