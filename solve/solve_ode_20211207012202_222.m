function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.220554490360071e-01   -3.589907010637615e-01   -4.311022944604567e-01   -5.085115874482475e-01   -4.786745065187060e-01   -3.311495973364711e-01   -7.688403282296035e-01   -5.921990744061478e-01   -6.242374160226124e-01; -4.350303026095821e-01   -4.688620147864519e-01   -5.347545193531509e-01   -5.175171726248760e-01   -5.000112156716814e-01   -3.099726566289839e-01   -6.791242041008536e-01   -6.475085397075473e-01   -3.839093872989169e-01; -4.136306054050299e-01   -3.695781486291183e-01   -5.884094735593213e-01   -8.748194478288159e-01   -6.196056028500837e-01   -4.312899875500316e-01   -6.245532560388497e-01   -3.869680161446358e-01   -5.806264142328444e-01; -4.460887328248940e-01   -3.313865429691943e-01   -5.216766009928488e-01   -4.235757944091413e-01   -2.485366855142505e-01   -4.551740219772981e-01   -6.263642614414222e-01   -1.864577895183810e-01   -5.119490142051667e-01; -5.697836265943962e-01   -3.573552886351247e-01   -2.680383856904314e-01   -2.481546827427620e-01   -3.615047502820508e-01   -5.158091677343993e-01   -5.812581841211549e-01   -6.593307575962704e-01   -5.317348753080456e-01; -3.512782558398865e-01   -2.099054366519538e-01   -3.342524261925479e-01   -6.712847124071227e-01   -3.376074543384103e-01   -4.965559657043892e-01   -6.560130821450288e-01   -6.332698725573840e-01   -3.021629170427635e-01; -4.981286262484647e-01   -5.420141807816019e-01   -5.322876142003712e-01   -5.423273137033741e-01   -8.233596039602900e-01   -6.667838591551009e-01   -4.371502321157271e-01   -5.445818360727644e-01   -6.705672188381957e-01; -4.193483347677718e-01   -8.135656369322738e-01   -6.813653831830719e-01   -3.622674751008100e-01   -4.435529602887945e-01   -2.024949191102922e-01   -5.290495181956019e-01   -7.467625105327372e-01   -5.001184235362740e-01; -6.838960624764060e-01   -4.420790214107366e-01   -3.689571022495892e-01   -3.893895591827489e-01   -4.600898811814813e-01   -1.796843722670299e-01   -2.964631782140906e-01   -5.003695478827084e-01   -5.177915982549812e-01];
L1_L2_iAMPA_netcon = [-4.877956630055250e-01   -5.385525601964075e-01   -4.711005418813213e-01   -6.864999363734215e-01   -6.494431359457842e-01   -5.784163170302654e-01   -3.470800605233180e-01   -5.745690298832160e-01   -3.831874026744111e-01; -3.223855541607045e-01   -4.636539929478571e-01   -2.837241831698819e-01   -4.280804382212506e-01   -3.860949241558929e-01   -5.612906828855500e-01   -3.098431049382510e-01   -5.369745124833869e-01   -1.717456329778240e-01; -4.008867827250046e-01   -2.496222109012394e-01   -5.200427849513216e-01   -4.098897949033053e-01   -1.661739336238107e-01   -6.135468941275816e-01   -6.162892265865657e-01   -4.515424551651150e-01   -6.029142198023549e-01; -4.050951615502075e-01   -4.838592400479211e-01   -7.345806853979102e-01   -5.222033198930053e-01   -2.997900682681002e-01   -5.938140530846745e-01   -7.370213930409925e-01   -6.355417123893263e-01   -4.841801154545101e-01; -6.439888453322045e-01   -3.677461683550478e-01   -3.679762014661516e-01   -4.013984101126751e-01   -4.936761343710633e-01   -6.480504951430754e-01   -3.359816479691554e-01   -4.652344327149154e-01   -5.115487877200656e-01; -8.620003379658759e-01   -5.291147914044848e-01   -7.570618183226585e-01   +2.694898185811726e-02   -4.841882958987126e-01   -5.827277154999190e-01   -3.382844331953337e-01   -2.949448469670128e-01   -6.428250667273963e-01; -4.914158557487466e-01   -4.609034422469891e-01   -1.418979245931220e-01   -4.584688284586877e-01   -3.277084600048444e-01   -6.414126911830744e-01   -4.152189648696976e-01   -5.568888282041236e-01   -3.813679130394209e-01; -2.142057075892996e-01   -3.599227693510028e-01   -5.316989484820879e-01   -5.214398880808448e-01   -2.595168654523345e-01   -3.626636988448814e-01   -2.151304523820916e-01   -1.705410554826159e-01   -5.028087278632647e-01; -8.054778026969941e-01   -6.111728641513910e-01   -4.764806816274981e-01   -5.856929220726205e-01   -1.359392492095809e-01   -7.675619724117924e-01   -3.602299258754659e-01   -6.518210774810287e-01   -3.516737043110842e-01];
L2_L5_iAMPA_netcon = [-5.090913214990174e-01   -2.380586978906111e-01   -6.996196166804209e-01   -4.344026034355031e-01   -5.094558892136398e-01   -5.411918185743712e-01   -6.464259186012277e-01   -3.241270680993624e-01   -5.527575560370472e-01; -3.832367194122541e-01   -5.244622486046940e-01   -5.704705721932322e-01   -3.843774681326823e-01   -6.918689418104846e-01   -7.459296850533857e-01   -5.155694424888587e-01   -3.845531981857728e-01   -4.981681726869979e-01; -5.242312906557364e-01   -4.131188281299085e-01   -4.797802634530982e-01   -2.812222271756317e-01   -4.184488869996741e-01   -2.848986683258059e-02   -4.769678181799162e-01   -6.144902768595796e-01   -2.928437735185379e-01; -4.097269268893393e-01   -1.986636319617986e-01   -2.454640063805290e-01   -3.930606356488093e-01   -7.198559602489419e-01   -1.961550469268501e-01   -5.105866622219938e-01   -6.012616415182768e-01   -4.488100146297174e-01; -6.396858310237615e-01   -6.739654334139886e-01   -6.489390130713366e-01   -5.012601488347915e-01   -5.932099248802717e-01   -6.943356474766145e-01   -6.028103083234273e-01   -5.316437436523616e-01   -5.098598620983630e-01; -4.442341270251449e-01   -5.633266634358884e-01   -6.389131208368239e-01   -3.460710941142777e-01   -4.933001992991474e-01   -4.675007292373047e-01   -4.536409226134603e-01   -5.323177434687600e-01   -2.727357393589120e-01];
L5_L2_iGABA_netcon = [-5.395242252848453e-01   -4.658164271863026e-01   -7.700482526780742e-01   -5.691769461894046e-01   -5.148364168469652e-01   -5.090210226584454e-01; -5.642612996604243e-01   -4.000758332019614e-01   -5.546452481526656e-01   -6.858137323579647e-01   -4.893273922349985e-01   -5.069996109440316e-01; -4.030990621336408e-01   -2.112892933956672e-01   -4.730867053907085e-01   -4.408840747546129e-01   -7.521533862335403e-01   -4.168792176696235e-01; -2.206824414188998e-01   -3.362717913501882e-01   -1.940524168518657e-01   -3.355525263665675e-01   -2.812365071501188e-01   -4.405187102854327e-01; -5.415341286731001e-01   -3.890067713871048e-01   -3.936349052385831e-01   -4.678192210492674e-01   -6.995038439710408e-01   -2.971151329045762e-01; -3.866428177555940e-01   -3.648420169460113e-01   -2.561718913032866e-01   -6.026053965358069e-01   -4.437057881604262e-01   -7.908192324383352e-01; -3.361714619481413e-01   -5.122236655472183e-01   -5.670145702865879e-01   -3.586327760963926e-01   -2.543087954236730e-01   -1.595608390497608e-01; -6.084154219939821e-01   -3.033546713841331e-01   -2.066237711705473e-01   -5.359651544036658e-01   -4.227435442285109e-01   -4.911263772702079e-01; -5.137221381263044e-01   -7.486066940255860e-01   -6.164047319057911e-01   -2.899784049094798e-01   -3.389214394571867e-01   -4.609230753490645e-01];
L3_L2_iAMPA_netcon = [-6.083251559107468e-01   -6.314063981307989e-01   -3.726332873123559e-01   -7.164956143090502e-01   -4.400895487312909e-01   -1.900088182847654e-01; -3.906622435677195e-01   -6.853802893008712e-01   -5.440185714810054e-01   -4.453321415618658e-01   -4.641449591554717e-01   -4.813842963006425e-01; -5.729106417346082e-01   -5.437207206940400e-01   -3.889290617784570e-01   -7.181079720317810e-01   -5.180887394953111e-01   -4.555646504447693e-01; -4.534468422359589e-01   -5.312145246019122e-01   -5.834890934732120e-01   -4.125753671409672e-01   -4.209610100321584e-01   -5.077561877501304e-01; -4.662351853356627e-01   -5.604612377320536e-01   -4.068272206361436e-01   -4.517396682324559e-01   -3.150195448534331e-01   -4.494987859212125e-01; -6.057482438760349e-01   -4.164986016889723e-01   -5.340254268263835e-01   -3.745006752513750e-01   -5.049966842498966e-01   -5.426215913412535e-01; -5.576780441403191e-01   -3.657652054580027e-01   -7.916510886629087e-01   -3.841710527377942e-01   -5.103467183766213e-01   -6.310295886284979e-01; -4.490724104606698e-01   -4.862043828407250e-01   -5.686478641560192e-01   -4.933424670755950e-01   -4.690249391923752e-01   -2.803878091120429e-01; -8.062222294398111e-01   -5.448729500530466e-01   -5.527402718510299e-01   -3.238860733581032e-01   -4.438430712716802e-01   -5.064206110479598e-01];
L2_L3_iAMPA_netcon = [-4.275295793450097e-01   -3.958224278670259e-01   -4.526824835674496e-01   -4.016490435781335e-01   -5.457253813722515e-01   -6.659282361954236e-01   -4.509244626397817e-01   -1.895584676515885e-01   -3.134636014561150e-01; -3.191420823668483e-01   -5.935349670009991e-01   -4.111924247840316e-01   -4.634356705744762e-01   -4.593791046853997e-01   -5.443277309199682e-01   -4.699658132164042e-01   -5.192608612839910e-01   -5.938206322301678e-01; -2.784686139527246e-01   -5.329202021314347e-01   -5.057693258270910e-01   -4.650776739423081e-01   -3.593129669737012e-01   -6.701296143113196e-01   -4.364681264188598e-01   -4.831424033356407e-01   -6.029277173270130e-01; -3.218209049429702e-01   -5.110570668017480e-01   -5.981931724692936e-01   -3.841705635221244e-01   -3.708009084521011e-01   -4.926733712213167e-01   -6.878471297232607e-01   -1.842147811246579e-01   -7.216911754509471e-02; -3.981947655462819e-01   -7.690039724285533e-01   -6.019559745243093e-01   -3.654593760703975e-01   -5.109939100325084e-01   -3.637053964707130e-01   -5.824272253055736e-01   -3.424208235673937e-01   -5.873151740581580e-01; -1.713516434173280e-01   -2.170995375232565e-01   -2.565876801366423e-01   -5.197221285700125e-01   -3.060657425696407e-01   -5.380029368334487e-01   -7.627689429787521e-01   -4.126193231482246e-01   -7.263783426511141e-01];
L1_L4_iGABA_netcon = [-6.895811480302100e-01   -2.249916067390299e-01   -5.530576995727753e-01   -4.463338245452021e-01   -3.145917093842868e-01   -5.188422839605231e-01   -4.988704855096979e-01   -5.101607602341020e-01   -2.135160519818058e-01; -1.450811605280222e-01   -4.626556381781628e-01   -4.446266223596929e-01   -4.322747355934404e-01   -4.478925694570498e-01   -6.066690137133622e-01   -4.302449154556117e-01   -7.142189436666189e-01   -7.049942887524115e-01; -4.973249446993199e-01   -5.331504049294286e-01   -4.376428821267329e-01   -5.798751257550364e-01   -4.758409524555146e-01   -3.060279305269823e-01   -6.626318806147797e-01   -4.661629129943865e-01   -4.055345712027015e-01; -4.409278786599997e-01   -5.679014850123053e-01   -3.241086570660405e-01   -4.951075526725630e-01   -7.303718785320903e-01   -3.589594793596383e-01   -4.569858912052729e-01   -5.840724297807361e-01   -3.107813967807180e-01; -4.100138685773997e-01   -5.142744303895666e-01   -6.320304506328320e-01   -4.974248874393701e-01   -4.613670715812432e-01   -5.902208616463649e-01   -5.830233659893651e-01   -5.572964300977929e-01   -6.363034306270898e-01; -5.297405454736632e-01   -5.294047913857185e-01   -5.859206543087636e-01   -4.217955510556664e-01   -4.608735698195064e-01   -4.905744419475310e-01   -4.380081691357942e-01   -4.465522517218417e-01   -2.318153221635368e-01; -4.568499229031305e-01   -5.293639970986168e-01   -5.184948714392323e-01   -2.998733934260791e-01   -3.709472654578028e-01   -6.114463374255255e-01   -3.116925823927152e-01   -6.318087727895318e-01   -4.325160712689449e-01; -7.133158879083307e-01   -4.742944622262752e-01   -2.918784036525054e-01   -5.482692550431985e-01   -4.471191686818200e-01   -4.642586543056781e-01   -4.348674706947885e-01   -6.696851583864299e-01   -6.397904381472030e-01; -7.303244742847764e-01   -6.008624628249609e-01   -3.876310750157010e-01   -3.839036529255932e-01   -3.048318748886931e-01   -2.695405178265694e-01   -7.168458464025775e-01   -4.347693081405299e-01   -2.806743546396226e-01; -6.562682148728999e-01   -3.156706717353842e-01   -4.988812143973236e-01   -5.235467927666282e-01   -6.217572699418611e-01   -6.322018496289059e-01   -4.386777951901377e-01   -4.424717840352914e-01   -1.111062870496961e-01; -4.282561225195748e-01   -1.934738394419561e-01   -2.893328165258334e-01   -3.887119247943888e-01   -5.809422969372530e-01   -6.175654567952761e-01   -3.369218863660227e-01   -4.513234859139857e-01   -4.914543246362580e-01; -6.503696546831722e-01   -4.099578272157904e-01   -3.956917679866045e-01   -5.714779585988833e-01   -4.035817520369567e-01   -2.070218261674621e-01   -4.275131564540997e-01   -6.112108438586247e-01   -3.530815077828242e-01];
L4_L1_iGABA_netcon = [-2.722724536550759e-01   -3.796737008168229e-01   -7.341479493150140e-01   -5.714117796213769e-01   -4.069077962623711e-01   -6.919182121167378e-01   -5.995129241133738e-01   -5.872428746563809e-01   -3.469327429237721e-01   -2.618716684976549e-01   -4.468578645239396e-01   -5.294227229813087e-01; -2.598503167997279e-01   -5.604569465106481e-01   -2.835439428673321e-01   -4.805943285970816e-01   -7.299504412779591e-01   -5.061870753777149e-01   -4.607813584747872e-01   -6.986001907393390e-01   -1.109368401205390e-01   -4.308856267911344e-01   -5.312853198260539e-01   -4.430881609402138e-01; -3.978749526048335e-01   -7.157922447713159e-01   -5.711950784845304e-01   -4.028999224094417e-01   -6.276253707242817e-01   -5.655283163803484e-01   -5.345709321482026e-01   -5.625419337740244e-01   -4.606507867522321e-01   -4.089590724355585e-01   -6.656929223018770e-01   -4.272160016434929e-01; -6.016987987627133e-01   -7.144582990382885e-01   -3.669340467699507e-01   -4.483981519836059e-01   -5.416446157570597e-01   -5.983226228867934e-01   -4.200357030644979e-01   -4.135937605514235e-01   -4.186750093717878e-01   -5.203446929095122e-01   -1.525815329752960e-01   -5.791385153986154e-01; -5.557333968769995e-01   -5.035120380045898e-01   -4.469082006688989e-01   -4.869195377737660e-01   -5.064712138871177e-01   -5.560236715063265e-01   -3.134310471928430e-01   -5.020485388348060e-01   -4.944017677128119e-01   -3.529610667970924e-01   -1.663195936170947e-01   -4.854618318973373e-01; -4.936463604955313e-01   -2.815993287943394e-01   -4.534861346875607e-01   -4.782822554422387e-01   -5.415139562497692e-01   -3.747686052155346e-01   -4.908778877988202e-01   -3.391605750019676e-01   -7.491659034152849e-01   -4.553500196213530e-01   -4.562660852876762e-01   -8.498352459696539e-01; -4.402249976292576e-01   -7.188996708074594e-01   -4.286692891649130e-01   -3.951470700732042e-01   -5.269283736433014e-01   -5.026112449277592e-01   -7.288411185363163e-01   -5.732123394900563e-01   -3.214803476931750e-01   -3.807423981899842e-01   -4.678692462051516e-01   -6.300348376851378e-01; -6.441457455160136e-01   -4.258379624751553e-01   -4.924441215517795e-01   -2.489905899222272e-01   -5.910970555578889e-01   -7.329285842328798e-01   -2.991115280365650e-01   -3.927240507698671e-01   -3.414050619615372e-01   -5.768662245868943e-01   -6.594189495362281e-01   -4.036048274032499e-01; -7.660235619063147e-01   -5.307418495587100e-01   -3.897253312353934e-01   -6.862028915790909e-01   -5.459329678075711e-01   -2.639640714267578e-01   -5.750387963770726e-01   -4.361293081295112e-01   -4.321119497995207e-01   -6.184025843797446e-01   -4.732234362869309e-01   -4.236309609940336e-01];
L1_L3_iAMPA_netcon = [-5.148957328023787e-01   -3.367295899844194e-01   -6.213554045206346e-01   -5.990671213844824e-01   -8.209047160194669e-01   -5.289265637621724e-01   -4.943874511104664e-01   -6.030851180691175e-01   -4.277874941303763e-01; -5.606217296396179e-01   -2.151490142458697e-01   -4.012670450765912e-01   -3.598513927215736e-01   -5.152523428445648e-01   -5.046394971238054e-01   -3.261413062867593e-01   -6.921965346362768e-01   -5.129873836316122e-01; -5.090338822043891e-01   -4.116528269739420e-01   -4.662455460115162e-01   -2.644207535534192e-01   -4.111311501631607e-01   -7.145920434015571e-01   -2.907910744608192e-01   -7.210269922068477e-01   -6.288456500312849e-01; -3.080670549252964e-01   -3.813753854517665e-01   -5.304851500915501e-01   -5.831878426537319e-01   -3.601922939610522e-01   -1.552981959879103e-01   -4.862535965884702e-01   -7.536439812901009e-01   -3.529377586472449e-01; -4.507507662480765e-01   -5.856901551126185e-01   -4.989399823923130e-01   -5.968247693088355e-01   -6.905198996662070e-01   -2.235055765094109e-01   -5.416520646763655e-01   -2.169196558316494e-01   -6.043928264842501e-01; -5.876102697185530e-01   -4.232143254212073e-01   -6.013313558713711e-01   -6.221909615069364e-01   -6.156286220360342e-01   -3.128340983534034e-01   -5.047334324268598e-01   -5.185164318754945e-02   -5.976822243948064e-01];
L3_L1_iGABA_netcon = [-6.075123377340323e-01   -4.808542405374688e-01   -3.637125443674845e-01   -6.143391227964506e-01   -2.565013638010661e-01   -8.658716576630351e-01; -5.733750436535643e-01   -3.157880441165014e-01   -3.960142495014883e-01   -4.747549435130830e-01   -5.991231739132757e-01   -7.416524110834913e-01; -2.721340885539848e-01   -6.305474814005939e-01   -2.955079870481174e-01   -3.085044321707302e-01   -4.730448390334591e-01   -4.436353930440194e-01; -4.402016032754558e-01   -3.205180884324479e-01   -6.746731164264245e-01   -6.670816341565593e-01   -3.045666450864707e-01   -6.789918494524770e-01; -6.730777459398605e-01   -6.151200455159425e-01   -8.150673203536957e-01   -3.572138691531535e-01   -3.387695680308503e-01   -3.637478942501851e-01; -3.803244187801366e-01   -5.508035032390490e-01   -5.528957019149345e-01   -1.394956190547069e-01   -4.214652289128389e-01   -1.989574724144049e-01; -3.782775256605337e-01   -3.352804230774232e-01   -3.782936194612976e-01   -6.308314081048378e-01   -2.576071462558577e-01   -2.088842913916641e-01; -2.498719308882179e-01   -5.380735120220725e-01   -7.061731233417226e-01   -4.353251943948386e-01   -6.005903523580072e-01   -4.399147287067315e-01; -6.877344574091384e-01   -6.154739456488137e-01   -6.277383902745015e-01   -3.510790194390038e-01   -6.318531482541718e-01   -4.822547099267043e-01];
L5_Input1_iAMPA_netcon = [-4.292303250155047e-01   -4.962550454359784e-01   -6.155421913314986e-01   -4.274471500824563e-01   -6.313817425501373e-01   -7.941547764329806e-01];
L6_Input2_iAMPA_netcon = [-6.682641256681684e-01   -7.134297103134979e-01   -4.883886070159828e-01];
L5_L6_iAMPA_netcon = [-5.725177666978858e-01   -5.831225427621419e-01   -2.446925995333949e-01   -4.500326971118581e-01   -6.690888438614843e-01   -3.158470601080142e-01; -5.952384393493453e-01   -4.483418699323249e-01   -4.988971227228742e-01   -6.089213883204547e-01   -5.500046132174056e-01   -4.548074629872045e-01; -6.983208162815659e-01   -4.556525664282471e-01   -1.908252768145396e-01   -2.782882016876052e-01   -4.910627901779561e-01   -4.145997646383169e-01];
L4_L5_iAMPA_netcon = [-4.290843853034604e-01   -4.887127926792020e-01   -6.092222362729274e-01   -4.498185137178207e-01   -5.934157350502561e-01   -5.583514921811427e-01   -3.257302316129116e-01   -3.282334627749823e-01   -7.175955942876546e-01   -2.938520804708342e-01   -7.281124095975630e-01   -6.355947759038032e-01; -4.060405086383471e-01   -2.331265304446969e-01   -2.358798719500496e-01   -3.645748514141735e-01   -4.500850497785557e-01   -5.460523262297499e-01   -6.030858363703491e-01   -1.627184525775092e-01   -4.087575133613653e-01   -4.394138663145345e-01   -8.243798696115378e-01   -5.965212135231214e-01; -4.131851982629412e-01   -4.731301464131475e-01   -2.409402896798004e-01   -3.942017865196754e-01   -3.704978443388670e-01   -3.945300612483095e-01   -3.491325436364838e-01   -2.971745399031193e-01   -5.541705664212413e-01   -5.385784508877647e-01   -5.504784982014147e-01   -4.929547143201799e-01; -1.824398409784084e-01   -3.673198507793613e-01   -4.678616792901216e-01   -3.915965554375712e-01   -6.963946934942540e-01   -6.029760818851539e-01   -3.906136258148086e-01   -4.634001640370664e-01   -5.753180854682586e-01   -5.286378729965981e-01   -7.553106034840946e-01   -5.627091054812057e-01; -3.505972865092766e-01   -1.745270652102618e-01   -6.802022522733639e-01   -3.704021808552856e-01   -4.359930035986543e-01   -2.784466309973201e-01   -5.194507816568491e-01   -5.206672269582016e-01   -5.745487543567566e-01   -5.917787192180894e-01   -3.741364992798918e-01   -1.529426791633668e-01; -7.786664044893006e-01   -6.394455349786333e-01   -5.855704226801439e-01   -5.113374791045457e-01   -7.569109877944138e-01   -5.551936683288182e-01   -2.268217342189346e-01   -2.744042377359160e-01   -3.338512418505889e-01   -7.878793832404820e-01   -6.328843555521494e-01   -6.644815999419926e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
