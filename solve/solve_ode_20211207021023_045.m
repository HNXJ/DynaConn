function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-6.219783385301152e-01   -5.653235714087753e-01   +8.471845133055631e-01   -9.810284201197783e-01   +4.495430675172098e-01   +2.406569709899243e-01   +6.189993477637029e-01   +7.020369898725499e-01   -7.743273712897225e-01; +4.336658222113712e-01   +6.312352008447463e-01   -6.510993639753491e-01   -4.964393865050527e-01   +6.913099812866315e-01   +6.672827373823340e-01   +6.320786805432751e-01   -7.883386393450295e-01   +7.598094010447173e-02; -4.889308307407614e-01   -6.576435575379627e-01   -1.486918222128255e-01   +9.844110403918547e-01   -1.040681972201288e-01   +8.762906103886901e-02   +7.248921671629821e-01   +9.615831086689619e-01   +1.000000000000000e+00; +6.073880691150887e-01   +4.147558519124571e-01   +6.442737378556928e-01   +4.234107131419135e-01   -4.223790251158908e-01   -2.490385461335168e-01   +8.625293783248943e-02   +3.889252370706275e-01   +3.365257649366271e-01; +3.633141495019256e-01   +9.297488302703886e-01   +9.705857328074884e-01   +6.062220523391429e-03   +7.667908623742016e-01   +9.111959678965514e-01   +1.271620947865708e-01   +1.120003091693328e-01   +3.386193287631147e-01; +8.175219063171779e-01   +6.544247879100211e-01   +2.537532551151387e-01   +4.099120155810641e-01   +6.625409342185817e-01   +6.202501924963438e-01   -6.828913766850193e-01   -3.022508669059158e-01   +7.655976845518141e-01; -9.759574790134231e-01   +2.442033041128743e-01   -9.354782733164420e-01   +6.444141604394161e-01   +9.783584848837593e-01   +9.623831628755205e-01   -7.811111838701074e-01   -4.019818356569106e-01   +1.111623835435079e-01; +4.805844939124515e-01   +1.604459713343472e-02   -8.740774872507898e-02   +6.371405028071575e-01   -4.777042943698432e-02   +2.940657343289800e-01   -3.946450664680983e-01   +7.006668902354823e-01   +4.190154394538912e-01; +4.647368589912872e-02   +7.003123711857292e-01   -6.276073078656015e-01   +5.778134812176176e-01   +8.839577167754491e-02   +2.810603225344127e-01   +6.300013530049974e-01   +4.887718012632544e-01   -8.431228869634160e-01];
L1_L2_iAMPA_netcon = [-6.920014075456280e-01   +8.672862987007073e-01   +8.064925670793703e-02   -4.046403777685333e-01   -8.720796360102883e-01   +6.542327923245407e-01   -3.077427279908974e-01   +2.002131843504318e-01   +3.546452669908708e-01; +4.528392527759599e-02   -2.947073882999823e-01   -4.932452418365795e-01   +5.994315199075068e-01   +9.159384625256904e-01   -8.275388359132412e-01   +4.347962196224049e-01   +7.576332343217125e-01   -9.998597447119230e-01; -4.349119986398969e-01   +8.453803443381196e-01   +9.757486134889974e-01   -7.871467759076776e-01   -3.049825795846679e-02   +6.528328545927585e-01   -6.751075101161814e-02   +1.689796866588315e-01   +8.600127832499127e-01; +4.370690968611228e-01   -2.628318655963114e-01   +3.264578398594117e-01   -1.884822728823393e-01   +1.508353711937503e-01   -5.245116634739511e-01   -5.707153085508154e-01   +1.762177987229845e-01   -3.077578218015639e-01; -2.370044656226242e-01   -4.432466810713880e-02   +8.699745316222123e-01   -7.929101585837466e-01   -3.719552298931830e-01   +7.966388991796541e-01   -8.173850131455528e-01   -1.753004216548732e-01   +8.320020424733255e-01; -2.130445343675376e-01   -7.894844181810462e-01   -3.245365198437002e-01   +2.154235585675104e-01   +5.414772317982198e-01   +9.486630248850110e-01   -9.366863105867802e-02   +9.904197803227022e-01   -7.824441816359056e-01; +3.344101518987362e-02   -3.096168062616514e-01   +5.433507678598350e-01   +1.000000000000000e+00   +2.092563729864318e-01   -6.727184093711965e-01   -4.742818838950052e-01   +6.479373335535858e-01   -6.264906974450213e-01; +6.157002027466628e-01   -3.889383038926004e-01   +4.412111968443735e-01   -4.521865595809696e-01   +7.082796433188924e-01   -1.992728725964180e-01   -4.864172869036235e-01   +7.853690105390374e-01   -5.266687894579078e-01; -6.526542850804874e-01   +1.383950708121504e-03   -9.333166712747938e-02   +8.775213943751901e-01   -3.042420642241623e-01   -6.423913830214376e-02   +9.365109415996360e-01   +4.271327836389240e-01   +2.553178134226923e-01];
L2_L5_iAMPA_netcon = [-7.806402137773826e-01   -1.631353682707489e-01   -8.492080808692982e-02   +1.897849367926260e-01   -1.357285487534874e-01   -3.084628255921836e-01   -2.015242118194356e-01   +1.866355560114739e-01   -6.055691611352710e-01; +8.521022854506396e-01   +2.679052737438391e-01   -3.985574937101168e-02   -2.791886535482310e-01   -2.284794687741398e-01   -8.545483332619889e-01   +5.979971928022672e-01   +7.165519824360360e-01   +7.826060058476212e-01; +9.892292367294728e-01   -4.001849744342174e-01   -8.417515211891152e-01   -9.566733019241763e-01   -5.206334594665137e-01   -3.087262478122789e-01   +8.385453108203362e-01   -6.755024426516578e-03   +1.000000000000000e+00; -8.984847278030059e-01   -8.330389502714181e-01   -6.647586184898822e-01   -8.587194952404044e-01   -1.874497658378165e-01   +9.959883806735485e-02   -8.201888539984802e-01   +5.391715341163000e-01   -7.456114973544039e-01; +4.035219619832969e-01   -6.752263567346080e-01   +8.834855958879425e-01   +8.571005493007203e-01   -5.422816807107519e-01   +1.779852433994420e-01   -2.104225788387594e-01   +5.823375362647618e-02   -8.009121623267511e-01; -1.539820609310696e-02   -4.351515883607951e-01   +6.502004905991050e-01   -3.359300184622718e-02   +7.680904804260610e-01   +7.255283190003260e-01   +6.049489195905350e-01   +1.507373231086113e-01   +8.917197231608044e-01];
L5_L2_iGABA_netcon = [-3.098076035855512e-01   +4.524433376688680e-01   +7.231198929617826e-01   +5.017097985801834e-01   -5.048605087278025e-01   +4.435315594974201e-01; +6.143134925078118e-02   +7.366179726976139e-01   +9.872463555439124e-01   -5.487227316040472e-01   +4.548955903417187e-02   -3.389183115375597e-01; -7.344168883819363e-01   -8.323841795480962e-01   +5.663889273951490e-01   -6.505663592417845e-01   -1.502785045550153e-01   -5.519565543167269e-01; +5.117399025174107e-01   -4.305930036433845e-01   -8.169305593651217e-03   +8.114388768966415e-01   +6.754646799595027e-01   +5.633114794295158e-02; -1.334287182293327e-01   -5.625414918641917e-01   -3.735089624701619e-01   -9.850785658700814e-01   +1.000000000000000e+00   -9.046484135155329e-01; -1.892725213082742e-01   -3.713661856769356e-02   +3.078029253836984e-01   +8.885591689558174e-01   +1.607531065227733e-01   -5.606028806400074e-01; -7.656029644549075e-01   +2.192376613241746e-01   +2.502508204076551e-01   -7.868477147057625e-01   -9.208819421136724e-01   +3.704136285995642e-01; -6.727804350326865e-01   +5.386718587488295e-01   -1.274830160987541e-01   +3.560055831666168e-01   +2.474763757290302e-01   +7.603931025270052e-01; +3.786005405357131e-01   -2.610623405828345e-01   -5.753388856303082e-01   -4.691926092081582e-01   -5.206812246402127e-01   +8.748212299234505e-01];
L3_L2_iAMPA_netcon = [+9.733740835334486e-01   +5.849550984332327e-01   -9.415735261454303e-01   +6.503878052976774e-01   +6.562560032398486e-02   -1.400981463583691e-01; -3.920444422379137e-01   +8.935082078476246e-01   -2.987437875994651e-01   -8.946236555827605e-01   +7.757165201226129e-01   -8.971087192291241e-01; +9.178716249505237e-01   -1.691495741566773e-01   -1.120887359126137e-02   +4.664338440071173e-01   -2.603826151908526e-01   -5.414900751792929e-01; +8.429344221418827e-01   +4.250979273073954e-03   -3.729304331664922e-01   +2.463407830179227e-02   +6.339200433779200e-01   +7.183478356688613e-01; -1.847433660013757e-01   -7.870573424597473e-01   -7.230199085222232e-02   +1.412072524663690e-02   +3.328013704106146e-01   -4.264358737013075e-01; +6.475722136301741e-01   +4.003302471521384e-01   -7.752767920468985e-01   -3.823628053250366e-01   +6.641228661619530e-01   -3.022057787562719e-01; +4.664059946987598e-01   +5.591766723306261e-01   +5.175382930153734e-01   -5.576090743642790e-01   +1.000000000000000e+00   -4.475536547966831e-01; +4.744327369951092e-01   +1.954153071588557e-01   +8.028293853387078e-01   +8.626575489455703e-01   +6.682198485913388e-01   +7.267025602593044e-01; -1.014173653278161e-01   -1.953091006481377e-01   +1.015819289284640e-02   -7.926835291577373e-01   +7.091169920710816e-02   +8.634332761590143e-01];
L2_L3_iGABA_netcon = [+4.472332838891876e-01   +9.516239338060309e-01   -8.711264885476997e-01   +2.354417080569440e-01   +4.527717234571767e-01   -6.482857323223297e-01   -2.039781704600431e-01   +2.705037313126417e-01   +5.977461668412154e-01; -5.990545537150035e-01   -9.680057806279798e-01   +3.715947822505762e-02   -8.939190788347161e-02   -1.000000000000000e+00   +8.976207603148334e-01   -2.733958040852679e-01   +7.633604822198210e-02   +6.538716218938967e-01; +6.958349968962457e-01   +1.804882866895698e-01   +3.954542449787133e-01   +1.383252923207257e-01   +4.663561173986297e-01   -5.606891569394759e-01   -7.704473494656131e-01   +2.139362645085176e-01   +7.130298402040288e-01; +3.453898715162008e-01   +9.474239076995676e-01   +4.385531480276778e-01   +7.037333919920008e-01   -7.281012770591995e-01   -7.485892827285949e-01   +1.875124309169209e-01   +5.218435559048338e-01   -5.189923286457874e-01; -2.420484142190122e-01   -1.967293839761837e-01   -8.620071347872068e-01   +9.968444512370029e-01   +1.870392603229434e-01   +5.039268668685698e-01   +7.376809207194550e-01   +3.889105833392112e-01   +7.416475762613691e-01; +1.621626237779584e-01   -7.549516442851714e-01   -7.610655839072363e-01   -8.845438887128374e-01   +8.742747863381187e-01   +6.543462865076746e-02   -6.292899262362314e-02   +3.721114443791382e-01   -6.227409791243725e-01];
L1_L4_iGABA_netcon = [-5.869510736375337e-01   -5.611397148042149e-01   +5.850547210160291e-01   +8.699582421009978e-02   -5.594610066557659e-01   -2.252472214708842e-01   -1.193032589105555e-01   -3.206668630539244e-01   +5.181984087992272e-01; -2.208344976891106e-01   -8.858927320720952e-01   +6.068434886634847e-01   -9.914541779609224e-01   +2.594123823543186e-02   -3.271215235162789e-02   -4.475706763461202e-01   +6.759042153205860e-01   -7.519829641425404e-01; -6.234085257919752e-03   -9.696420284959595e-01   -7.633037830302001e-01   +5.560622767981694e-01   +6.725350034533600e-01   +9.331638685092755e-01   +8.158739891786021e-01   -1.741329040845515e-01   -8.379751733435185e-02; +8.101304248882553e-02   +6.761475888341126e-01   +2.637342057656034e-01   -6.324906738506630e-02   -3.167684482650642e-01   +9.889987085809794e-01   +2.793306594885521e-02   -5.003460425662060e-01   -7.484636894033454e-02; +3.200159991975621e-02   -4.560865991519056e-01   -3.378794514295240e-01   +1.958992174644194e-01   +8.497043294882710e-01   -4.613985074001019e-01   +1.050455184072097e-01   +8.130117258564052e-01   -8.418311306366243e-01; -9.912632854327997e-01   -7.415428559797136e-01   -6.798083599683807e-01   -2.168909202892361e-01   -6.590255632715242e-02   +2.653023904015869e-01   -7.397008984779177e-02   -6.392965995212218e-01   +8.811309388688986e-01; +9.259692571605164e-01   +1.843859895287983e-01   +2.713208600178862e-01   -5.842718902474467e-01   +9.955386708546944e-01   +1.936121212492417e-02   +4.782572551012962e-01   +1.485264327083648e-01   +8.478169051384167e-01; +7.155540913139519e-01   -3.908868476041995e-02   +8.864996214945017e-01   +9.118625882969618e-01   -7.739436292940177e-01   -8.995885150497500e-01   +6.006306494725873e-01   +7.767672540667023e-02   -7.462922678657484e-01; -7.271564739303055e-01   +9.691848616095430e-02   +7.646546025244031e-01   +8.083104746497635e-01   +3.571508652243749e-01   +4.238155656172570e-01   +1.000000000000000e+00   -5.639430382889085e-02   -8.200240998507524e-02; -2.703423882532712e-01   +6.764346878606424e-02   +5.489432205201401e-01   -3.943731728895007e-01   +6.815390440820489e-01   +3.564660714626374e-01   +7.430762015744452e-01   -9.463981875528972e-01   +4.325320566801122e-01; -6.103564224141197e-02   -6.866696646419219e-01   +1.691639294674240e-01   -4.843912192743308e-01   +5.239188964175933e-01   -1.797859438308105e-01   -8.559399110152334e-01   +3.497259726000320e-01   +5.231876416068502e-01; -4.081880075158764e-01   -4.221183415285167e-01   +4.127379815726311e-01   +7.699457943446936e-01   +7.824085164463451e-01   -3.363946954662533e-02   +2.563098126700463e-01   +9.056931430322411e-01   -6.895447953651856e-02];
L4_L1_iGABA_netcon = [-9.853541544601880e-01   +3.740363114333395e-01   -7.575151371545450e-01   -6.285365987678093e-01   -3.199073632957482e-02   +8.147072338146568e-01   -7.542856037277080e-01   +3.619851751272271e-02   -2.389096012385168e-01   -1.051550367316207e-01   -3.030564506938925e-01   +1.349138460873984e-01; -6.963952383688933e-01   -7.848050989051770e-01   +9.561078640491931e-01   +1.581317044156806e-01   +1.047557424721615e-01   +6.353400276948286e-01   +2.638574324758061e-01   -5.984660110371645e-01   +5.132810165158401e-02   -2.052886512924339e-01   +2.777480903464982e-01   +6.807127916071408e-01; +8.364650808432486e-01   +1.350697826578024e-01   -3.341984170813224e-01   -1.819985157980040e-01   -1.742538023703678e-01   +1.558443913086613e-01   -9.327698782569855e-01   +4.509469870223718e-01   -5.998770198825303e-01   -4.371034927216443e-01   +3.633927493314709e-02   +4.891781044813745e-01; +8.869846106390927e-01   -4.351240414214856e-03   +3.039048384522721e-01   +4.735972177428733e-01   -6.878133035996508e-01   +7.753469899089869e-01   +2.774894466063988e-01   -7.667333590748087e-01   +2.709994786783016e-01   +2.016635222590616e-01   +6.036019365007059e-02   -9.068345627079870e-01; -5.168328519188251e-01   +5.561509567219937e-04   -6.911232649205237e-01   +6.373693273247528e-01   +5.528182156108840e-01   -5.818859667727762e-01   +6.192748854077132e-01   -9.929634011639742e-01   -4.564312890409953e-01   +3.887623392821061e-01   +9.253929371179972e-01   -9.844939720185178e-01; -3.809306359071669e-01   -1.994063268762531e-01   -8.336141042905619e-01   -7.339919570988551e-01   -5.369147579645461e-01   -7.123828244796591e-01   +4.097224724795026e-01   +2.997144462028560e-01   -2.326801137779832e-01   +6.675735478957734e-01   -7.169012223734008e-01   -2.753875334774676e-01; -7.641414827853119e-01   +4.207699708306617e-01   +2.068704482335287e-01   -6.697297477805773e-01   -4.310159161515849e-01   -7.064782068010875e-01   +1.291058854796121e-01   -7.213189915369155e-01   +1.000000000000000e+00   +6.799129684787135e-01   +8.966186994628513e-01   -1.318007626515945e-01; +8.154571767392705e-01   +3.161346991119661e-01   -6.521322918060899e-01   -4.234403958599429e-01   +5.248804534819678e-01   -6.744980933942897e-01   +1.891081554743659e-02   +4.257341464058278e-01   -3.285431442379222e-01   +6.334726568888918e-02   +8.791522423447869e-02   -6.084797312716692e-01; -3.804741742291914e-01   +4.413527374875340e-01   +1.201215367663331e-01   -1.706974539286751e-01   -3.967334490687254e-01   -2.734048257737134e-02   -6.898128271124082e-01   -4.488951463908123e-01   +5.441178604330197e-02   +1.384969628709214e-01   -8.185533809269577e-02   +9.592642879758807e-01];
L1_L3_iAMPA_netcon = [+8.090684371603761e-01   +1.000000000000000e+00   -4.827862646126624e-01   -8.778803220685633e-01   +4.970925440159095e-01   +2.657004547008472e-02   -3.914464184801655e-01   -2.347718807095995e-01   +5.399129762789259e-01; +9.150668400176185e-01   +2.191087832430763e-01   +9.994607111552463e-01   +7.457543691374907e-01   +4.241958768363255e-01   -5.335594203093117e-01   -8.344042442244711e-01   +4.410848748534165e-01   +2.524719649237593e-01; -5.510128929419514e-01   +6.384759405171433e-01   -2.459319927330603e-01   +7.681071204536067e-01   +3.087802617355974e-01   -9.535559775635182e-01   -2.176641801645681e-01   -6.786954516986562e-02   +9.353680737898524e-01; +1.530012824235250e-01   -9.993475676287240e-01   -5.142383422754385e-01   -1.933350771840230e-01   -1.545047103935060e-01   +6.810839554148933e-01   +1.595736048625313e-01   -7.064066342362961e-01   +8.767562477689393e-01; -7.008909203906661e-01   +3.430546008967794e-01   +7.405711187800532e-01   +7.318631238334843e-01   +8.864871377161228e-01   +2.174541769120534e-01   -7.059916052025911e-01   +4.866987877383749e-01   -8.008496149699642e-01; -2.869601842732911e-02   +2.778225974553120e-01   +7.079392594703727e-01   -1.957349238927771e-01   +6.472541737975388e-01   -2.376172823522799e-01   +4.049851741330269e-01   -9.676853313645583e-01   -9.666034956454728e-01];
L3_L1_iGABA_netcon = [+9.751583395784218e-01   -9.862423993040651e-01   -3.855905180605086e-01   -2.152058388768009e-02   -3.650382788960226e-01   -7.516002204874778e-01; -9.975081744334185e-01   +8.555442591892186e-01   -7.872029392408944e-02   -7.996963290757425e-01   +9.361346657678642e-02   -3.087815515380485e-01; +4.989708666457391e-01   -6.994399770202321e-01   -3.724550493906441e-01   -6.346829472873878e-01   -3.873623815693846e-01   +3.476093783319041e-02; +9.395354993809797e-02   +1.161227360167202e-01   -7.740764827578330e-01   -3.035240212520351e-01   +7.665824420029412e-01   +8.015152452767179e-01; +8.261382525808320e-01   -3.237828808998036e-01   -3.271659215459461e-01   +5.435687694349843e-01   +5.285636580048849e-01   -2.213313489180205e-01; +7.821643766305321e-01   +7.501700121345934e-01   -8.541137824415141e-01   -2.656612878698970e-01   -3.925847921995053e-01   -4.944094792240121e-01; +2.576936451037367e-01   -9.767434400279376e-01   +9.788874177532881e-01   -1.118024683884669e-01   -3.371178705461492e-01   +4.685625558139436e-01; -8.493165452271789e-01   -5.593665690434831e-01   -6.794054577832502e-01   -1.000000000000000e+00   +3.828640634623454e-01   -2.540320904585290e-01; +5.408573202067171e-01   -4.434049881980515e-01   +8.802859467542755e-02   -9.806698609138127e-01   +1.931717311398506e-01   -1.147927252034440e-01];
L5_Input1_iAMPA_netcon = [+2.804026141307025e-01   +7.318637420976151e-01   +8.588018478902245e-01   +8.543699648255005e-01   +6.841237131728980e-01   +1.000000000000000e+00];
L6_Input2_iAMPA_netcon = [-7.512010729591836e-02   -8.790587255358355e-01   -7.795385477917007e-01   -8.230704016730474e-02   +3.603132442877848e-01   -1.000000000000000e+00];
L5_L6_iAMPA_netcon = [+8.874576637818874e-01   +9.923484189323735e-01   +2.571861214966209e-01   -3.540641182786601e-01   -5.722198794111338e-02   +1.000000000000000e+00; +6.893215850511312e-01   -7.497048804915960e-01   +4.184087034739269e-01   +2.250782506720917e-02   -6.832291860479927e-01   -2.140516888823384e-01; -8.463183270605533e-01   +7.187100015927915e-01   +2.834553341321789e-01   +5.264499397893702e-01   -6.177154765197473e-01   +4.961386687056194e-01; -3.490591921703359e-01   +3.824712025600586e-01   +4.671901537489644e-03   +2.698337186259053e-01   +4.732724592134768e-01   -8.851341672805942e-01; +3.909878579945463e-01   -8.191092913304212e-01   -4.027947290140410e-01   +2.830203438280876e-01   -5.910195177016402e-01   -9.275713003124376e-01; -5.246537782859333e-01   +8.581448748135673e-01   +9.135653051762287e-01   -2.087204852773528e-01   +9.445364183348893e-01   -4.656184478619392e-01];
L4_L5_iAMPA_netcon = [-1.000000000000000e+00   +7.847717517473974e-01   -1.123656303952099e-01   +2.491392524528968e-01   -2.506351319267760e-01   -9.208970359364695e-01   +5.975893871154120e-02   +1.658668623780350e-01   -2.599775364514190e-01   +2.832236075787722e-01   +4.577411961382953e-01   +5.374944930870631e-02; -5.522338103517158e-01   -6.739024206258131e-01   +5.042774724123970e-01   -6.594889338361258e-03   +2.278831600550794e-01   -4.695307939219912e-01   -1.928235650836632e-01   -1.402443664224852e-01   +3.794397813490141e-01   -8.986479887205048e-01   -9.105041437300163e-01   +8.484041096192155e-01; +4.318071618425773e-01   -1.921123641815136e-01   -7.828880765308396e-01   -4.829347394073311e-01   -8.878653069626209e-01   +1.445506139431122e-01   -8.609831762802268e-01   -8.131361458578449e-01   -7.723760012575767e-01   -9.242438387875861e-01   -9.902208160719700e-02   -9.045714193572029e-01; -8.845734961888939e-03   -1.799476827835736e-01   +3.938377181428112e-01   +3.438052814305282e-01   +1.178597766853085e-01   +9.347004210846611e-01   -5.944329615057914e-01   +2.795161547713077e-01   +1.100461986296639e-02   -1.282741112454647e-01   +2.787790403255330e-01   -5.427534439321535e-01; +4.051235643473378e-01   +8.474451413451471e-01   +6.012707699928374e-01   +8.807847468921518e-01   +4.018808912305620e-01   +8.303922642005541e-01   +3.762253665096761e-01   -2.709388077313964e-01   +4.681644573082558e-02   -4.476333695895023e-01   +8.189688860837593e-01   -7.052898191963127e-01; -7.336428311870801e-01   +8.294148707221947e-01   +1.593196178276965e-01   +8.814752118571618e-01   +6.195217293076105e-01   +3.260094231215830e-02   +2.188153832692595e-01   -4.306223191030468e-01   +3.594179520525445e-01   +2.212589251842815e-01   +4.495439086934230e-01   -9.739915587056429e-01];
L6_L4_iAMPA_netcon = [+9.782211838963901e-01   -3.001019931530104e-01   +3.497216389591774e-01   -9.423148939852101e-01   +3.926001458840093e-02   -1.000000000000000e+00; +3.199532934469901e-01   -7.180688870137525e-01   -7.008669895399726e-01   -1.799932946846165e-01   +4.493358153538379e-01   +9.604658899381556e-01; -5.530534176953329e-01   +8.023922247883917e-01   +4.287254535407850e-01   -2.638382663415050e-01   -1.215182689895687e-01   +5.249884843684303e-02; +7.133214046908317e-01   +6.296522556191529e-01   +5.027741324948960e-01   +8.500058822144207e-01   -1.581975517689672e-01   -6.899688859617381e-02; +5.427400612047065e-01   +1.084103715812147e-01   +6.393368573978000e-01   +8.652852972649538e-01   +8.705712986231200e-01   -1.523245183848076e-02; +7.689799170845478e-01   -3.499716624870057e-01   -8.083269705334289e-01   -4.615249429540005e-02   -7.866771868701733e-01   +9.928524953732891e-01; -1.069253230961365e-01   +6.512719645515605e-02   +3.250526171469436e-01   -6.283929229732700e-01   +8.189488916658325e-01   +1.021399840445036e-01; -3.679190027756303e-01   +5.154589658989035e-01   +4.153729631652368e-01   +3.287581317287054e-01   +7.607082053470502e-01   +2.294431032657502e-01; +4.119508039714159e-01   -2.725032223693562e-01   -1.160565105353863e-01   +4.353254757333074e-01   +8.811869614819695e-01   +4.997201472218669e-02; -3.404058941165405e-01   -3.166301306097447e-02   -2.968115054551121e-01   -9.501838210613284e-01   -6.783989350260028e-01   -7.834391753482909e-01; +7.785398702534944e-02   +6.485757163633382e-01   -9.582174105603589e-01   +5.194301587612532e-01   +7.185342018824320e-02   -1.524755110731413e-01; +2.659634234609138e-03   -5.443201804548137e-01   -6.419229203556152e-01   +1.439631010652863e-01   -1.485602021280929e-01   +1.244426126231972e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
