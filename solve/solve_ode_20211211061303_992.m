function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.360517094277941e-01   +6.105237216678367e-01   +3.150593654287835e-01   +5.713890013193732e-01   +3.453054650341291e-01   +2.644115280281488e-01   +5.016468767005455e-01   +6.428996845773118e-02   -1.869416670533253e-03; +3.033502916443073e-01   +5.274492001092006e-01   -2.195067016768708e-02   +5.665876160352676e-02   +3.664078863130308e-01   +3.519079692578311e-01   +2.750159930345266e-01   +5.304346355967786e-01   +8.174341505041818e-01; +3.701203274735708e-01   +2.971590135367546e-01   +4.774051639154959e-01   +1.808559564254053e-01   +9.195740738712745e-02   +5.501895901996075e-02   +1.399543698688087e-01   +7.275244687634794e-02   +2.286950416803734e-01; +1.508534219901187e-01   +1.477012658903258e-02   +5.042521738362323e-01   +1.845818347882940e-01   +2.069021654914950e-01   +1.552629111895348e-01   -1.421361362732411e-01   +8.593853755940974e-01   +1.712593417218247e-01; +2.384795282377374e-01   -5.671926472522119e-02   +5.091255019311126e-01   +2.623658981974101e-01   +4.631145733983964e-01   +4.024005340063389e-01   +1.684392596036824e-01   +4.382513161356912e-01   +5.640575592678404e-02; +5.744441342117211e-01   -5.076797794937563e-02   +4.954868257680703e-01   +3.953264732625252e-01   -1.043023840299052e-01   +1.210526647277210e-01   +2.317392826225752e-01   +3.789370371264493e-01   +2.791218120784293e-01; +4.332663861070712e-01   +8.303674561077310e-01   +1.509748423576003e-01   +3.974867631725024e-01   +1.075712965507203e-01   +2.392196653729557e-01   -8.673058973184118e-02   +1.634815652513647e-01   +3.347254478814906e-01; +5.600208029684473e-01   +1.860943639350112e-01   +7.914684602628784e-01   +2.585169579881096e-01   +1.916057374850397e-01   +2.652041274768078e-01   +2.567563596982891e-01   +4.234826461666955e-01   +4.759790653184198e-02; +6.236333767464810e-01   +6.745829116411707e-01   +3.109556843056110e-01   +1.505168335304877e-02   +5.089416784516020e-02   +1.087359639083411e-01   +1.511882558661315e-01   +6.108078330322719e-01   +2.338572866237737e-01];
L1_L2_iAMPA_netcon = [+6.856559522838230e-01   +5.028297330231227e-01   +7.030958836066473e-01   -2.010032267603838e-01   +6.685406622724841e-01   +4.731440954360334e-01   +3.920519009333924e-01   +4.056227369883663e-01   +1.640109130605746e-01; +1.178722415578121e-01   +2.056120781565635e-01   -2.232553346096939e-01   +4.318684559322928e-01   +2.983627850128843e-01   +1.110603276953767e-01   +1.386939073797793e-01   +7.304971270710854e-01   -2.264814307864640e-02; +1.520331686311896e-01   +2.536384614371284e-01   +3.338820312253518e-01   +3.193910362710711e-02   +4.588078068798601e-01   +1.269253396976853e-01   +5.600282357276318e-01   +5.823127882279500e-02   +1.293452280958986e-01; +7.482901820626411e-02   +5.901530534635767e-01   +3.859654760978865e-01   +3.717662015519332e-01   +6.159134076192860e-01   +4.548053118834062e-01   -1.258290721205199e-01   +2.503935168557108e-01   -5.898748910342329e-02; +1.932655274692144e-01   -1.646143346691060e-01   +2.854238096781313e-01   +3.298814498740930e-01   +4.182905056611163e-01   +4.781531555488414e-01   +6.073896216420688e-01   -9.411261204892052e-03   +5.892710879145500e-01; +5.724782787398844e-01   +4.430225901778349e-01   -1.549222304433352e-02   +8.267050442538313e-01   +2.778632322296413e-01   +9.584204227334533e-02   +1.830747189242626e-01   +4.108091000630567e-01   +5.271316753797729e-01; +2.270502163599548e-01   +3.500694119007425e-01   +5.008840087083359e-01   +9.667921613131099e-02   +2.338760189365046e-01   +5.763237314867269e-01   +4.953496498726291e-02   +1.095199294279124e-01   +2.624111182339670e-01; +3.950728704643471e-01   +1.897710538314415e-01   +2.506679796544673e-01   +1.066896386359963e-01   +1.254400585082547e-01   +4.952048412579074e-01   -1.507454559456569e-01   +7.092871007330158e-01   -3.802256775148732e-02; +7.070236597539317e-02   +1.049630862937898e-01   -2.755778312781623e-01   +5.765315605606263e-01   +6.325080402738741e-01   +2.607817144673184e-01   +5.222304515320113e-01   -2.960234774901821e-02   +6.989628130821020e-01];
L2_L5_iAMPA_netcon = [+1.396578181337292e-01   +1.042532479679128e-01   +2.551315687808567e-01   +1.350574247633768e-01   +5.532567923983798e-04   +1.496998551990352e-01   +5.468989044069655e-01   +5.440467336511169e-02   +3.162854296327008e-01; +6.142986588736137e-01   +1.307597757727609e-01   +6.266427698368329e-01   +1.698999001844857e-01   -1.319265848609799e-01   +7.194975053107511e-01   +3.805692707945444e-01   +1.923559080667603e-01   +5.851709206659361e-01; +4.140449246329239e-01   +3.590168807909462e-01   -1.472995243686104e-01   +4.024595145844482e-01   +5.717945559426654e-01   +1.923989310853668e-01   +2.820315847994261e-01   +4.875425489218907e-01   +2.794251571717246e-02; +2.778369195610659e-01   +2.778210694594171e-01   +2.410172960724083e-01   -3.529189230063616e-02   +3.638028706286888e-01   +4.024960755506928e-01   -2.868015745349377e-02   +1.798647185357383e-01   +3.495405152122746e-01; +4.854312252003284e-02   +5.336671285746380e-02   +6.478632233172311e-01   +2.839668178946125e-02   +2.933198022574185e-01   +2.228832560017882e-01   +4.226972368996031e-01   +1.274890199477180e-01   +5.131212029664647e-02; +8.458449170246196e-02   -7.260668632887340e-02   +2.019547193149235e-01   -2.809138374641520e-02   -3.137740376527365e-03   +1.537024763681058e-01   +3.725045108445322e-01   +6.682353145878944e-02   +1.775706183607599e-01];
L5_L2_iGABA_netcon = [+3.534798670067417e-01   +1.204013531770501e-01   +3.814068867848385e-01   +6.221359422314510e-01   +1.563996228522433e-01   +3.164564908127315e-01; +1.121544091648138e-01   +5.174338485184344e-01   +6.255511736530230e-01   +2.147679293221708e-01   +6.262454887220366e-01   +3.558372996268044e-01; +5.339832387889770e-01   +3.854674069958214e-01   +5.356106705041364e-01   +3.627042594805743e-01   +3.580381672867292e-02   +5.475988968776317e-01; +1.229339826610948e-01   -1.499449883697510e-01   +2.052595578517026e-01   -1.167312835031171e-01   +5.825090509087492e-01   -1.384919338530492e-01; +1.600137259071446e-01   +1.854195916603004e-01   +3.691987821713117e-01   +1.714999287032466e-01   +2.058650738194070e-01   +1.331249617983911e-01; +1.389584605839418e-01   +5.322902008359784e-01   -2.152847940350797e-01   +3.177117401483237e-01   +3.061255388465100e-01   +1.914378259705346e-01; +9.454225887728165e-02   +3.682802684947314e-01   +3.726268684994946e-01   +5.271721548222411e-01   +2.817010654439550e-01   +2.312494553683058e-01; +3.007385581147958e-01   +2.737531563154570e-01   +4.106973409526438e-01   +1.049284288609617e-02   +1.708633347497709e-01   +4.895440016945858e-01; +2.655741243978624e-01   +4.217206195252965e-01   +9.119948544308623e-02   -3.177784522846464e-03   +3.426518434809881e-01   +4.184447064492601e-01];
L3_L2_iAMPA_netcon = [+4.238832697516162e-01   +2.158500052004999e-01   +4.417327182692969e-01   +7.444307900041305e-02   +2.793536987960800e-01   +4.004102671001494e-01; +5.029681555010033e-01   +6.009853289906922e-02   +7.081398736625815e-01   +1.941467678666275e-01   +2.844971753607901e-01   +2.045748843227612e-01; +1.207888754274976e-01   +2.256928964069344e-01   +1.145545654235993e-01   +5.302478556876660e-01   +3.741268604014502e-01   +4.910671520460737e-01; +3.658780126662219e-01   -3.838105511197373e-02   +8.141085964642314e-02   +5.937120472481021e-01   +4.920755102402029e-01   +1.207792881193728e-01; +8.176188777785686e-01   +2.060504951439860e-01   -5.600522256218940e-02   +6.369881204093347e-01   +3.205110336242677e-01   +5.366867237178754e-01; +6.783767564647284e-01   -1.631997286738426e-02   +2.407532901825097e-01   +7.290659657051031e-01   +3.578187371450043e-01   +2.734304524242707e-01; +5.687635454224549e-01   +2.564434587750496e-01   +2.044017506887449e-01   +4.811214579676596e-01   +1.952711340212222e-01   +3.456819945078652e-01; +6.226993320957086e-02   +5.394079878767472e-01   +4.439070597646247e-01   +3.289718519305301e-01   +1.280432377288308e-01   +4.469819652021845e-01; +8.495935433562549e-01   +6.369396444874119e-01   -2.418751981143789e-01   +1.590964835103948e-01   +5.253682730682159e-01   +4.694724018661862e-01];
L2_L3_iGABA_netcon = [+1.964487479770564e-01   +2.473147024535657e-01   +4.279819181155317e-01   +5.523567867031945e-01   +3.238558701293575e-01   +4.997016119818127e-01   +5.308828101905039e-01   +3.800730529221777e-01   +2.374962296052965e-01; +3.915540429208583e-01   +2.393426564914373e-01   +2.861528184582152e-01   +9.704957136023901e-03   +5.974185586831775e-01   +3.605346537280462e-01   +1.541410373241492e-01   -1.449390874618578e-02   -5.996548303333540e-02; +3.912765285334106e-01   +3.319632332005162e-03   +6.321713303061240e-01   +1.967468994749384e-01   +6.529609991117675e-01   +2.517174489434507e-02   +1.500227117458235e-01   +4.194507626934243e-01   +3.777411143387478e-01; +3.024005346783537e-01   +2.150375003179965e-01   +5.477376050115692e-01   +9.085996103995905e-01   +4.553139073781561e-01   -2.521648868968689e-02   +4.636582431963212e-01   +3.606380423953177e-01   -6.956629713103846e-03; +2.200105302775590e-01   -1.561381836425362e-01   +5.963025142361582e-01   +6.602955222584157e-01   +5.232770119720915e-01   -6.612779442125179e-03   +3.470003653231937e-01   +4.951288555256090e-02   +5.373045155260293e-01; +2.011310081723904e-01   +7.774099181829369e-02   +2.419493497205999e-01   +5.365701219086052e-01   +5.203926401668890e-01   +6.682484260321209e-01   +3.544441527412402e-01   +1.628304407267592e-01   +1.997107837858546e-01];
L1_L4_iGABA_netcon = [+4.323207496736222e-01   +7.909416711964876e-01   -9.947737333646778e-02   +1.616635492625573e-01   +5.669759109561912e-01   +2.172345735963043e-01   -3.078980382521210e-02   +2.668987899310377e-01   -2.156824220658468e-02; +4.848990841615158e-02   +5.933663137033715e-01   +4.262102399771983e-01   +7.155490929559913e-01   +4.414834778705607e-01   +4.040619183473175e-02   +4.141578625661593e-02   +1.521769976258688e-01   +3.353825103976897e-01; +6.916894356325455e-01   +7.745284745777475e-01   +4.822980016957147e-01   +1.038216652471230e-01   +7.590425733352599e-01   +2.519619697422300e-01   +2.019345321280875e-01   +3.935767511470931e-02   +5.203110144258316e-02; -2.443703784235273e-02   +4.443983494064188e-01   +5.284735586679856e-02   +5.085284593541122e-01   +4.484583568852714e-01   +2.117985679296575e-01   +4.109879110309837e-01   +1.265481611082420e-01   +7.923492785734894e-01; +2.534748040929663e-01   +2.938533254022033e-01   -1.094904089719775e-01   -2.076564440567112e-01   +4.268165328644945e-01   +1.328488491923278e-01   +3.973950775148362e-01   +4.620007730783375e-01   +3.597533376791696e-01; +7.205094448269170e-01   +1.506649409236887e-01   +5.058941727687961e-01   +3.308625873874250e-01   +4.836965146913784e-01   +4.331724952780723e-01   +4.019105708159012e-01   -1.020402027868975e-01   +3.794389276995282e-01; +4.147353857833914e-01   +6.398622714787177e-01   +5.864965532416258e-01   +6.709256170589080e-01   +2.712692865198080e-01   +1.927866835673912e-01   +5.067050043026180e-01   +1.428803481478193e-01   +1.569004033727507e-01; +2.371517975870922e-01   +2.609915300603690e-01   +2.609605350748026e-02   +1.049103056015854e-01   -2.479748367664280e-01   +3.901262746621874e-01   +6.726230541375592e-01   +1.862173388723634e-01   +4.566122709995519e-01; +1.669539112073927e-01   -7.571601899251493e-02   +6.812716676201867e-02   +2.174934734214454e-01   +4.817388140508243e-01   -3.779458827426552e-02   +7.001639357039638e-02   +6.300987231724816e-01   -1.047484968033580e-01; +6.398064513288854e-01   +5.763215029000608e-01   -7.121163198597280e-02   +7.576666197436311e-01   +3.935379126747927e-01   +3.869933494760738e-01   +2.281893378735409e-01   +2.516489978352340e-01   +8.446608946736799e-01; +2.078443840108862e-01   +1.948396107323705e-01   +4.552960352929549e-01   +3.894667454995061e-01   +2.352681772177195e-01   +1.145839149844490e-01   +2.215026816134043e-01   +6.312841694552946e-01   +3.826027384773892e-01; +6.055823540613451e-01   +3.624781553540328e-01   +4.765323402811084e-01   +5.253509478550152e-01   +5.258514403981878e-01   +6.720211458830498e-01   +7.258695981222669e-01   +5.956229925773153e-01   +5.743890984149369e-01];
L4_L1_iGABA_netcon = [-2.691289236544088e-03   +8.936963199470493e-02   -1.594849314040612e-01   +2.743598925693824e-01   +3.467422270298455e-01   +8.525029056610384e-01   +2.437737757317419e-01   +4.928245723090687e-01   +7.943495662273563e-01   +4.228160537222544e-01   +6.208512953028192e-01   +6.150802173644202e-01; +4.539151533865466e-01   +4.122406188837473e-01   +6.886688850213157e-02   +6.512822083428241e-01   -2.393384474888697e-01   +1.191748915696950e-01   +3.841093104339172e-01   +2.834151166735188e-01   +1.708436091167458e-01   +1.425891449613472e-01   +5.033969648338545e-01   +2.687116137665567e-01; +4.647181591727966e-01   +2.184171287489045e-02   -6.138446130833836e-02   +1.162100437486677e-01   +3.088443466900685e-01   +5.381264173365562e-01   +3.010098447453909e-01   +3.895233198915301e-01   +4.295324022196335e-01   +2.848511244189372e-01   +2.834852952748733e-01   +4.554358019513221e-01; +2.229191441435426e-01   +2.682967324499131e-01   +7.271332821087644e-01   +1.166328542321157e-02   +8.050981031305318e-01   +2.112948933236279e-01   +3.917135568569482e-01   +4.242023717942856e-01   +1.973922683070498e-01   +5.521571315464664e-01   +2.319546664370649e-01   +1.419677821807173e-01; +6.658879715596531e-01   +5.590016241835747e-01   +5.213064946389426e-01   +4.908230718930695e-02   +4.931375782366564e-01   +6.156706468117501e-03   +1.847897664673849e-01   +2.887801458190290e-01   +9.829833029035935e-02   +7.182751719988619e-01   +1.275077444072887e-01   +4.163416523395316e-01; +4.507313186521348e-01   +1.978245361016821e-01   +1.649966711350075e-01   +6.264218108025765e-01   -6.258875721652635e-02   +3.477039556543786e-01   +1.498183817017879e-01   +6.065824372609872e-01   +8.091793819837388e-01   +2.220114500101303e-01   +2.187161675718101e-01   +2.990653723780506e-02; +3.197057393522617e-01   +2.411156971894302e-01   +3.653649506702387e-01   +4.375574428663465e-01   +2.074747679462223e-01   +3.476321709447096e-01   +2.463185245865584e-01   +2.615080819983582e-01   +5.654447344318643e-01   +4.620545283843204e-01   +4.544153724796530e-01   +6.591906253610280e-01; +1.141579840302797e-01   +9.050841629809056e-02   +5.922334900727417e-01   +4.586789659062845e-01   +4.019271156859441e-01   +3.402624444095546e-01   +4.273268216051228e-01   +6.715320949249296e-01   +2.773043143830884e-01   -6.914412562266901e-02   +2.843682776661329e-01   +6.178814792946576e-02; +7.486449660981054e-01   +3.321463924759014e-01   +5.208395793541394e-01   +6.473168852170912e-02   +7.500587236998641e-01   +1.671881685674209e-02   +4.294424302564372e-01   +1.434741277700182e-01   +2.459853284288258e-01   -1.582767175811138e-01   +4.939526696086686e-01   +3.896330356099034e-01];
L1_L3_iAMPA_netcon = [+9.017036237924156e-02   +3.081796928910470e-01   +4.058698966996790e-01   +6.634063751678265e-01   +3.896757713983302e-01   +5.580366040904762e-01   +7.088314107892058e-01   +5.870751504223154e-02   +4.144084562528156e-01; +7.955098541443840e-01   +4.563284630795669e-01   +3.214189941332024e-01   +6.219761801836358e-01   +5.243532860604982e-01   +3.217414608890243e-01   +1.763017366782237e-01   +5.192113652427617e-01   +5.426202044387365e-01; +6.031391356568843e-01   +3.800965000155255e-01   +5.407066025679190e-01   +1.185494936574299e-01   -2.374004349519485e-01   +2.821925367997291e-01   +6.362685078166216e-01   +6.846062594708749e-01   +6.083681180835727e-01; +6.129678604074840e-01   +4.999757887717593e-02   +4.333384338973625e-01   +1.017886861712467e-01   +1.965426382900544e-01   +4.345840188262101e-01   -1.097792263137804e-01   +1.891957910217802e-01   +7.672758019110344e-01; +9.439719526499601e-02   +4.694451333428530e-01   +2.149635515509709e-02   +2.810295574227898e-02   -6.561909312407144e-02   +3.126863179012550e-01   +2.168831947127278e-01   +3.820093489774413e-01   +6.738081130794938e-01; +1.927755507413391e-02   +3.086766328212492e-01   +4.014524388060049e-01   +5.636870096674033e-01   +1.933133315634220e-01   +2.487202534260897e-01   +3.200487737118417e-01   +2.842825153005216e-02   +3.109716880158683e-01];
L3_L1_iGABA_netcon = [+5.099991598507153e-01   +1.762783578896796e-01   +2.133924646621298e-01   -8.240857058221981e-02   +2.307988294028344e-01   -1.053814172649219e-01; +5.578994748878138e-01   +5.459783728028300e-03   +5.460695092907097e-01   +4.082633745949596e-01   -6.270292348189853e-02   +1.629686502791017e-01; +1.562377105674545e-01   +7.347770581515888e-01   +1.444547852020826e-01   +9.493607749530569e-02   +5.976900834033760e-01   +3.349705778594859e-01; +4.421257413180344e-01   +1.314521095697683e-01   +4.662539677627748e-01   +1.801095790082729e-01   +8.288284735580269e-01   +5.599430007120414e-01; +7.252955221645210e-02   -9.020481807829980e-03   +7.385613201608309e-01   +6.274345937149803e-01   +3.020382225398678e-01   +1.530089021996061e-01; +9.742064369493084e-02   +3.463561224135180e-01   +2.061619127080888e-01   +2.268471115708766e-01   +2.676477929041660e-01   +4.275481689152559e-01; +9.718170894896794e-04   +1.442968142144569e-01   +4.678970331550977e-01   +4.413427085696241e-01   +4.337549290844265e-01   +6.351551756667200e-01; -1.704409386062804e-01   +4.897184439234713e-01   +1.745223681649424e-01   +6.925277721369617e-01   -1.941892873511754e-01   +5.033913581254032e-03; +1.423526003252270e-01   +3.686677071130603e-01   -1.710890223220463e-03   +4.897179188307154e-01   +2.292809516271439e-01   +9.321350419016403e-02];
L5_Input1_iAMPA_netcon = [+5.136402528520490e-01   +1.408898773555292e-01   -2.902681147715586e-01   +2.613678032862389e-01   +2.078208361469625e-01   +3.256243904996814e-01];
L6_Input2_iAMPA_netcon = [+3.118873410707814e-01   +1.612086801385683e-01   +2.084349683913043e-01   +3.313974696934963e-01   +8.001995648783842e-01   +2.833410529623430e-01];
L5_L6_iAMPA_netcon = [+4.195604320176973e-01   +3.995068350994911e-01   +3.477837659847887e-01   +1.830947013604098e-01   +2.510460554452582e-01   +7.002029013960743e-01; +6.822207014817216e-02   +6.445506615518924e-01   +3.780059556079178e-01   +2.788187729141796e-02   +3.748602382843482e-01   +4.593567413546606e-01; +3.798529798005359e-01   +5.931672204566781e-01   +7.937508294539217e-02   +7.284843540813860e-01   +4.700103052374067e-01   +5.158529261492237e-01; +3.883768779396979e-01   +6.476425809479436e-01   +3.736338149876386e-01   +7.940418990401038e-01   +4.855856784431380e-02   +6.258650344281333e-01; +1.972988395608753e-01   +4.348897770652729e-01   +6.157556575968992e-01   +6.500329887427302e-02   +7.358183087975023e-02   +3.324564029367195e-01; +6.200461847090669e-01   +1.176410185911791e-01   +2.303012712395301e-01   +4.871162942134602e-02   +6.594386017686032e-01   +6.129299410472211e-02];
L4_L5_iAMPA_netcon = [+5.119187122454886e-01   +4.425538603310194e-01   +4.100250106767034e-01   +2.936456941556840e-01   +2.156847359807977e-01   +2.889536626883843e-01   +3.653460641246975e-01   +6.924875373809538e-01   +4.236887112976744e-01   +2.500924489609456e-01   -2.219323623294108e-01   +5.308099282968894e-01; +7.914657243045323e-01   +6.963199905776537e-01   +4.906082578432921e-01   +2.977670342538871e-01   +3.405646037972229e-01   +6.174098213673659e-01   +7.126221966712583e-01   +4.117402761760443e-01   +3.704606825482728e-01   +6.652188976747120e-01   +5.347953559616203e-03   +3.177961239362476e-01; +3.754868465348085e-01   -1.224885910745770e-01   +5.991660645098827e-01   +7.247398498247180e-01   +6.044342434658646e-02   +4.682355193591626e-01   -1.483856676811681e-01   -1.103864458244633e-01   +7.111205349664403e-01   +1.984927424085366e-01   +3.006155571697952e-01   +2.999889511030135e-01; +4.515974896742744e-02   -5.080329715253572e-02   +2.742835679537259e-01   +2.152745641651302e-01   +5.113163789811624e-01   +1.079579920636162e-01   +4.250368311227234e-01   +3.204686012148383e-01   +4.573796907694852e-01   +1.526042310517411e-01   +4.123760544342973e-01   +4.181544506779077e-01; +4.816984936310980e-01   +2.406160188132181e-01   +2.142441916432596e-01   -1.772390306837440e-02   +5.628392469193314e-01   +7.096014132568255e-01   +3.765351693699911e-01   +6.306360595110404e-01   +1.949165784775344e-01   +3.766481651307660e-01   +3.842631651263836e-01   +6.818054953942173e-01; -2.386310237814112e-01   +4.962467736863458e-01   +3.917898477803736e-01   +3.420190608179585e-01   +2.029721996939301e-01   +7.345676443925733e-01   +1.641485777803169e-01   +1.346936081705398e-01   +1.505483796218948e-01   +2.861975698370766e-01   +6.113211731238003e-01   +1.883903072761389e-01];
L6_L4_iAMPA_netcon = [+3.929106233749443e-01   -5.588692513840848e-02   +1.099101809958098e-01   +2.371714330599776e-01   +7.341639046400166e-01   +4.325858891409473e-01; +7.561934255749544e-02   +8.318368216531122e-02   +5.695407972344001e-02   +2.511901593846296e-01   +3.415874094947819e-01   +4.188286918885692e-01; +3.765089251114923e-01   +3.644742915012905e-01   +4.882727870077291e-01   -2.288336051994987e-01   +3.326320867482022e-01   +6.002061241572383e-01; +2.450553161824436e-01   +4.793142540895033e-01   +6.390801406828653e-01   +3.604324560018589e-01   +4.779127860033064e-01   +3.276225450571177e-01; +1.688748828060668e-01   +3.338161208353297e-01   +5.042256840105979e-01   +1.797264380299653e-01   +6.193240887485775e-01   +1.206057317495025e-01; +8.760579162016519e-02   +5.735433536235527e-01   +5.792198251495386e-01   +4.807825533477578e-01   +2.828971152490018e-01   +6.030185882712965e-01; +3.023436726807628e-01   +2.629217470655977e-01   +5.888380683732769e-01   +2.823931286684283e-01   +1.872339649698262e-02   +2.248911392672178e-01; +2.383698431473060e-01   +8.056880330664756e-01   +1.915946708721970e-01   -4.058162672990341e-02   -4.158955849168003e-02   +9.784766570939210e-02; +3.279744801664001e-01   +1.176806289170676e-01   +4.739953344301442e-01   +3.705744200621649e-01   +2.591064666530475e-01   +3.474756435917256e-01; +3.249787354710444e-01   +1.000840742013370e-01   +6.233429283956170e-01   +9.567041893370595e-01   +8.176915154872838e-01   +3.385207923051101e-02; +6.245262914539784e-01   +7.586771158086347e-02   +4.466670752187404e-01   -4.308236589032398e-02   +2.019085559970462e-01   -9.104185206511650e-02; +4.619801074101307e-01   +6.229469959138623e-01   +3.205455814834235e-01   +7.523529139311897e-01   -1.144521738497698e-01   +1.299693591342307e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
