function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.460213274633867e-02   +9.863854478084759e-02   -2.456452492430109e-02   +1.382998697302585e-01   +2.802725670346397e-02   +9.699262076002323e-02   +1.470369336583638e-01   +1.102916546983702e-01   +8.493080274470192e-02; +4.818565063970364e-02   +4.538625479657424e-02   +2.148972178555358e-02   +7.923368594155655e-02   +2.155553255662174e-01   +7.809410057900230e-02   +1.013300564750926e-01   +6.295657471617580e-03   +6.168600333511713e-02; +4.741373654086409e-02   +1.270273157909404e-01   +1.150863629707042e-01   +6.933594699403668e-02   -1.846258229568395e-02   +2.164417514285225e-02   +2.500918668673949e-01   +1.019390447305244e-01   +9.007553698362111e-02; +1.528551569119731e-01   -1.366233104923054e-02   +1.134915148925519e-01   +1.740337289116087e-02   +4.474887854747889e-02   +8.871565391371145e-02   +3.826953256883546e-02   +1.221381526347512e-01   +1.128612945179955e-01; +7.684383802413511e-02   +5.818411477984857e-03   +1.448110203707679e-01   +1.083362228323658e-01   +1.677669033595475e-01   +1.711672535256634e-01   +1.000333338724864e-01   +4.800640290847687e-02   +9.441547624952343e-02; +1.045267163351675e-01   +3.702992451764722e-02   +1.239672098492524e-01   +1.683208605813518e-01   +1.084799510579946e-01   -2.138751310615943e-02   +1.822193979184581e-01   +1.098273254610260e-03   +7.275170094238648e-02; -3.545229849590542e-02   +2.039412886903605e-02   +1.171710475458339e-01   +1.323206931945005e-01   +1.277803809532649e-02   +6.851797753553586e-02   +3.815205985399753e-03   +1.117588512562165e-01   +1.017917494198146e-01; +8.260470592686202e-02   +6.960236743687728e-02   +1.979999660759997e-02   +5.961604956183784e-02   +8.934213350070692e-02   +3.081601622180381e-02   +1.121510921925259e-01   +2.018049726758165e-03   +3.257141375849135e-02; +5.361260560575691e-02   +9.623255884295803e-02   -1.629930177590944e-02   +1.018003669270403e-01   +2.208157286131683e-02   +1.725023746705089e-01   +9.314732262159889e-02   +4.453910005336678e-02   -8.234420993188083e-03];
L1_L2_iAMPA_netcon = [+1.036465398835557e-01   +1.124038575307011e-01   +1.161295662793238e-01   -4.054560812909508e-02   +1.734856892819304e-01   +5.722875800105540e-03   +1.469307426258271e-01   +6.680918314989230e-02   +1.480010644272794e-01; +7.592704419734615e-02   +3.603534718971570e-02   +1.599022979809921e-01   +4.232074226560357e-02   -9.667300819396979e-03   +6.523037817148807e-02   +1.168710898298617e-01   +1.208287018019174e-01   +1.062688818082911e-01; +8.194932377578585e-03   +5.858136934899676e-02   +1.374898205341887e-01   +8.902004490787159e-02   +1.486356653170802e-02   +7.576000987146694e-02   +1.140308239230884e-01   +1.623541309320352e-01   +2.033211265476846e-02; +1.784078826213161e-02   +1.368097359730433e-01   +9.295078376504431e-02   +1.604489478917712e-01   +6.194306262165768e-02   +6.739168605130577e-02   -5.384201086132294e-03   -3.173249510583259e-02   +1.204394986578684e-01; -2.234876846469623e-02   +2.110192519408336e-01   +5.532557761525052e-03   -2.689486478986206e-02   +3.165328023619108e-02   +1.160470385452967e-01   +4.957242250346486e-02   +9.857997464834121e-02   +1.116206673741421e-01; +1.049968342323739e-01   +4.690675798396861e-02   +1.169847420338898e-01   +5.126840108066573e-02   +1.398963876383104e-01   +4.508092459838624e-02   +1.575233180223458e-01   +1.631385899918030e-01   +6.980656028383053e-02; +1.442983712588595e-01   +2.037966169178582e-01   -3.199301501668188e-02   +1.001033110996255e-01   +9.767300598404964e-03   +1.212051148899503e-01   +6.348876615140452e-02   +1.682650231267624e-01   +1.769910632443095e-02; +9.471914765238652e-02   +7.162571780241905e-02   -3.624301094976193e-02   -1.051920634443712e-03   +1.005335027964503e-01   +5.429496484918691e-02   +1.033165337193879e-01   +1.421686978490447e-01   +1.733656917854070e-01; +1.874934405759950e-01   +1.196719599682039e-01   +5.739732266365805e-02   +5.535651874149632e-02   +8.249646444673575e-02   +2.389502711266950e-01   -2.390546089404350e-02   +2.331246193601240e-01   +2.352774775165309e-02];
L2_L5_iAMPA_netcon = [+1.765050522499230e-01   +4.867231434348190e-02   -1.704535116375354e-02   +1.789723604477736e-01   +1.605702546527270e-01   +1.398283023694891e-01   +1.734962430003292e-01   +1.651934344056669e-01   +1.194113339062129e-02; +1.194355852443652e-01   +1.900958801082565e-01   +4.493047137120059e-02   +1.780617917741313e-01   +1.746609530993538e-02   +6.309106317924754e-03   +1.490894242098603e-02   +8.500479550361461e-04   +1.647186169322795e-01; +1.455172944980097e-01   +1.114417493877753e-01   +3.072773689383902e-03   -5.523061928308886e-03   +9.224285317288858e-02   +1.968414789177621e-01   +1.257770258767717e-01   +1.140146908045506e-01   +8.861563077390985e-02; +5.282332502441573e-02   +8.369957825341871e-02   +7.211078767433741e-02   +1.670249098465485e-01   +8.958812667436530e-02   +1.449223338466258e-01   +1.046153364726605e-01   +1.885299049517069e-01   +8.104861361876370e-02; +6.268635562943572e-02   +2.518115243234332e-02   +2.297786883426287e-02   +7.398233054520344e-02   +1.472502823989738e-01   +2.269793019654125e-02   +4.140879480410451e-02   +1.111377772981157e-02   +2.308627075204391e-02; +1.333616417248854e-01   +1.734580128172336e-02   +3.892499434291195e-02   +1.677860934112798e-01   +6.918962848788596e-02   +1.561473169207722e-02   +2.885102558209413e-02   +1.376154864550520e-01   +1.811254535696213e-01];
L5_L2_iGABA_netcon = [+1.775837559154430e-02   +1.931379072543188e-02   +1.192885229336576e-01   +2.573090972348292e-02   +7.634641865035012e-02   +1.970475525795895e-01; +1.734372254688262e-01   +5.449343258326607e-04   +1.222848015615634e-01   +6.287246363693773e-02   +1.140521604889749e-01   +1.469451638559051e-01; +2.305736609942829e-01   +1.647641171099626e-01   +1.106270968335462e-01   +6.018903866493790e-02   +2.178102533315925e-02   +8.277914544336051e-02; +3.469717837482129e-02   +2.854873520823890e-02   +9.361331920750009e-02   -7.545458506695302e-03   +1.261870336004229e-01   +2.502819357061118e-02; +9.939020447239778e-02   +1.246291453819529e-01   +1.146616080023286e-01   +1.068150284874316e-01   +3.809166968407688e-02   +1.070866842760712e-01; +3.725598704888641e-02   +6.242428053016088e-02   +5.519399834493996e-02   +1.332599886871918e-01   +8.947406416929292e-02   +4.277912346163894e-02; +3.228951206153833e-02   +3.835777484175927e-02   +1.696957511773669e-01   -3.219024090041709e-02   +1.621040097627127e-01   +6.828599425600808e-02; +1.333191174552305e-01   +2.552117856415743e-02   +5.467236174361510e-02   +1.767969427260613e-01   +9.950529579443623e-02   -2.886077057247648e-02; +5.918565163445118e-02   +1.044646133757968e-01   -6.733830187237229e-02   +1.290587136419904e-01   +2.139610101412570e-02   +1.101461520471653e-01];
L3_L2_iAMPA_netcon = [-2.753947779636172e-02   +4.877488171734502e-02   +9.679601965264627e-02   +1.377093808269960e-02   +1.945512536273239e-01   +1.562076154408623e-01; +5.013798578935620e-02   +1.498173552450747e-02   +6.950667383371310e-02   +2.094740232866713e-01   +8.284763900002422e-02   +7.449940161745620e-02; +9.604518256677046e-02   +8.669545371059928e-02   +5.843942214699600e-02   +1.017358553834874e-02   +4.930584051397577e-02   +7.733233022160449e-02; +6.567353789255305e-02   +9.508830584542613e-02   +9.216582513791070e-03   +8.536709158362336e-02   +5.591135163186137e-02   +1.704789464857425e-01; +4.197232915063731e-02   +1.453894512489746e-02   -7.434207230511290e-03   +1.786358468820321e-01   +1.857246586547417e-01   +1.636687977306116e-01; +1.369055525815065e-01   +3.401067074488449e-02   +1.990604308546298e-02   -7.735731641565911e-03   +6.332126041066671e-02   +1.047483896702149e-01; +6.722012457639781e-02   +1.319356102596103e-01   +7.150342062358454e-03   +3.050684517210865e-02   +3.056251562846114e-02   +3.291323262825852e-02; +3.541661659004461e-02   +1.395815712617158e-01   +1.332417641555181e-01   +7.119319486095574e-02   +1.086998248699802e-01   +3.004897691171271e-02; +1.886812436159424e-02   +1.518489786340861e-02   +8.754978595147489e-02   -4.507660773774995e-02   +1.217343118047094e-01   +1.062179779002731e-01];
L2_L3_iGABA_netcon = [+1.442089235623619e-01   -1.692873242117762e-02   +9.937357017245142e-02   +7.587622635354661e-02   +1.134721344246866e-01   +9.013304250386213e-02   +8.991703022289914e-02   +1.584885505916664e-01   +1.844048630729125e-01; -1.694596753346927e-02   +1.819238758293321e-01   +1.632099625659525e-01   +1.325536698117720e-01   +1.383902989836289e-01   +5.615711354857864e-02   +6.629629351019155e-02   +1.174749187768749e-01   +1.075910491914859e-01; +5.247764443798874e-02   +1.686719456289976e-01   +9.455539800614692e-02   +9.603208127573576e-02   +1.477322410305453e-02   +1.141505858570407e-01   +1.640545527775214e-01   +3.644529149621224e-02   +7.865448519042012e-02; +2.489716594810924e-02   +1.260402473218108e-01   +6.041752905889837e-02   +1.153855493965871e-01   +1.381612888200818e-01   +1.116664918355428e-01   +4.906771896684182e-02   +6.949917940534737e-02   -1.558537850962265e-02; +6.917640090874617e-02   +8.793811969523295e-02   +5.233907166030299e-02   +9.634539527314852e-02   +8.222919540061126e-03   +8.252166500815665e-02   +3.425957085290772e-02   +5.555981028526401e-02   -3.066385989858486e-02; +1.006382012136971e-02   +1.367931045482287e-01   +1.969697945333353e-01   +9.142365784468692e-02   +9.637221141175586e-02   +6.243607891868100e-02   +8.543994403753154e-02   +1.294747951269158e-01   +1.622397194398271e-01];
L1_L4_iGABA_netcon = [+7.211504909546885e-03   +2.541832333945383e-02   +5.079641890932637e-02   +8.255017686336490e-02   +1.479025682755124e-01   +7.118773305571971e-02   +1.417825074103174e-01   +4.077391175994357e-02   -8.762348585998489e-03; +1.786487505321702e-02   +1.654301087669886e-01   +1.851529102706742e-01   +9.545268784640229e-02   +7.778214676881244e-02   +1.575342069528975e-01   +1.865791730220592e-01   +1.272690253552766e-01   +6.047027088493055e-02; +1.065350016027374e-01   +8.736520792074981e-02   +1.100760378256938e-01   +1.167944467441951e-01   +1.664124000738360e-01   +4.399185629435903e-03   +3.334948514514311e-02   -2.540613141178157e-02   +9.512887111246722e-02; +3.402747736288941e-02   +7.995613909535790e-02   +1.774799252782687e-01   +1.711205005729318e-02   -5.776248368969715e-02   -1.923591630117426e-03   +1.229542101729764e-01   +9.019919307476766e-02   +1.446212579158702e-01; +5.537687866412105e-02   +1.597866946304252e-01   +8.896998486459548e-02   +1.293037817767298e-01   +1.428593359020627e-01   +1.088803073384226e-01   +2.556301225524273e-02   +1.246313651560192e-01   +6.230713463360309e-02; +2.984312898620865e-02   +1.083772379752169e-01   +7.566630742515171e-02   +1.032389306884862e-01   +3.798202803979667e-02   +1.211343956151496e-01   +1.162750742211396e-01   +1.186404871789043e-01   -2.293581191360460e-02; +7.212357996898401e-02   +9.542279566677686e-02   +7.872913887628577e-02   +1.415549796357020e-01   +2.145876943720687e-01   +8.138396618311523e-02   +7.416664754859970e-02   -1.636953781405141e-02   +3.436118459960201e-02; +9.210064622609396e-02   +3.249302187617401e-02   +1.520612818973425e-01   +7.159512246905872e-02   +1.064624361428212e-01   +5.483546598428677e-02   +9.255280209410638e-02   +9.182772598483023e-02   +1.518939737580580e-01; +7.019698793945457e-02   +5.012550239053111e-02   -3.083999185912346e-02   -3.055176510589535e-02   +1.223644141924885e-01   +1.106513534108528e-01   +9.288933254060604e-02   +1.087156513412213e-01   +1.200062072676688e-02; +2.826633516451938e-02   +1.578866581049298e-01   +1.028001004925527e-01   -3.961844366675202e-02   +7.287989280873781e-02   +4.187526454904986e-02   -3.092063742884674e-02   +1.463428507910560e-01   +1.656716237586904e-01; +1.742466432164599e-01   +9.135761232829616e-02   +5.277718053780189e-02   +1.551460415263980e-01   +5.323418236403803e-02   +1.480663002828141e-01   +4.185962255545643e-02   +7.280522669871176e-02   +1.759939441907019e-01; +1.179867889634608e-01   +1.911638540788516e-02   -2.232581449840314e-02   +1.449254446153282e-01   +7.648750099665741e-02   +1.091627833240308e-01   +1.134218546215754e-01   +6.680981815721757e-02   +1.217995182234795e-01];
L4_L1_iGABA_netcon = [+9.187952100501542e-02   +9.069580151593323e-02   +1.090047162514844e-01   +5.583154136752466e-02   -1.369763116850322e-02   +1.078834226781804e-01   +7.125891545589354e-02   +1.895390691476626e-02   +1.289582122029431e-01   +1.356564372125661e-04   +6.974949369961574e-02   +6.084355061827361e-02; +1.186658188610395e-02   +5.281922728842514e-03   +1.253672233628478e-01   +8.941442407623290e-02   +5.442737732916680e-02   +1.071673741533245e-01   +2.453641504100404e-01   +3.646703452353767e-02   +2.214634307011117e-01   +2.835072547371199e-02   -2.944359936158148e-02   +6.059589531575979e-02; +6.635357577811034e-02   +8.298908397604682e-02   +1.074570678899113e-01   +5.050357896577762e-02   +1.014743106028274e-01   +8.120278950191212e-02   +1.803173794616777e-02   +1.020039976094611e-01   +1.430476654777109e-01   +4.653120659093149e-02   +7.282109352461426e-02   +9.321176680630958e-02; +1.120414846807968e-01   +4.245889566897747e-02   +1.065006727220355e-01   +8.699232225900619e-02   +3.895971188679248e-02   +1.430593197749873e-01   -2.565580607906801e-02   +1.028689100871464e-01   +4.736406853175080e-02   +1.808703223942442e-01   +4.592157733421292e-02   +1.936850751156121e-01; +1.469275120684019e-01   +2.502820562131041e-01   +9.356215440839363e-02   +5.489020195320403e-02   +1.163075344781263e-01   +5.437775221080911e-02   +9.880363641880290e-03   +5.911538484553630e-02   +2.878744486949421e-02   +2.112423440143303e-01   +1.420448177378015e-01   +1.058807297560109e-01; +8.348593276189435e-02   +6.297800615100266e-02   +7.512984690525426e-02   +1.700533160680064e-01   -5.327644645580806e-02   +6.275442224572038e-02   +1.324869287761103e-01   +2.034619099834586e-01   +2.051489166226795e-03   -3.904263472679290e-02   +2.715175419259228e-02   +1.847246871629086e-02; +8.640465330591950e-02   -8.703404213489505e-02   +8.323308053442524e-02   +3.410363691491859e-02   -2.933775401164265e-02   +5.730345439891986e-02   +1.723128752916642e-02   +1.475092351976089e-01   +5.602068891130493e-02   -3.413178158853810e-03   +4.643367082261608e-02   +1.572118698330798e-01; +2.077247044996630e-01   +7.109194958971798e-02   -1.461982712478079e-02   -6.072488311399780e-03   +1.860659944582258e-01   +2.400288221542965e-02   +1.538868023553063e-01   +7.724062702458706e-02   +1.310441173366615e-01   +2.058855632827290e-01   +1.501966555341627e-01   +6.561662087793257e-02; +1.380264022190374e-01   +5.838345676551610e-02   +1.172011981168562e-01   +9.120759946502796e-02   +7.155246505868041e-03   +6.985077094374642e-02   +9.855699384154866e-02   +2.432737617614106e-01   +1.824467569142381e-01   +5.524536526671944e-02   +8.314667741543616e-04   +4.193955852127325e-02];
L1_L3_iAMPA_netcon = [+7.189242381415478e-02   +1.315359474135950e-01   +7.341786468214366e-02   +1.539617138790423e-01   +5.552442009918722e-02   +1.123920562331603e-01   +4.843430238297525e-02   +9.920344179316740e-02   +4.040761666264001e-02; +3.628013787090462e-02   +1.232103237421733e-01   +7.860632290863297e-02   -7.268681820544342e-03   +1.916411293535093e-02   +3.974801768409043e-02   +2.393423433083218e-01   +6.035257504318681e-02   +1.664512764766060e-01; +1.166394321791941e-01   +1.021880168384738e-01   +7.691466254892079e-02   +2.102372488981378e-01   +7.559450088306133e-02   +1.331600504844160e-01   +9.957896037993316e-02   +1.951591618853339e-01   +8.869769662455641e-02; +1.815827378949937e-01   +3.907643859003429e-02   +8.079813673176513e-03   +3.724552493485051e-02   +1.251591193350315e-01   +1.093286639669541e-01   +1.930833238443278e-02   +1.365671456473067e-01   +2.496522584112333e-02; +1.889159360772840e-02   +8.253350806472402e-02   +5.951248283759980e-02   +8.720440647906960e-02   -2.943370411309248e-02   +1.360961271224249e-01   +9.895509364322204e-02   +3.698593227735182e-02   +1.017810915514799e-01; +2.620754377233960e-02   +1.442317449984358e-01   +8.894320674549971e-02   -5.808697753779889e-03   +1.765372077708884e-02   +1.111477528754254e-01   +1.002389314090301e-01   +7.968769611996436e-02   +9.499231814663412e-04];
L3_L1_iGABA_netcon = [+1.580439513616343e-01   +1.525661177147275e-01   +1.050534041281478e-01   -1.373175028721440e-02   +6.801080572954153e-03   +1.209149468330511e-01; +7.582001618022219e-02   +6.631064751116070e-02   -8.971770590855232e-03   +5.011599037805248e-02   -1.914065702093084e-02   +5.332574865787428e-02; +1.482519961606205e-01   +2.992195382717026e-02   +1.158044898771173e-01   +5.950070560185733e-02   +1.419102611384681e-01   +1.366472194528162e-01; -2.802071131506829e-02   +1.146150777361182e-01   +1.032690223980784e-01   +1.024737437072258e-01   +2.104719031440914e-01   +1.342988250119417e-01; +1.033494364016069e-01   +4.792788541622574e-02   +1.529198630119342e-01   +1.003131212608391e-01   +7.284226927452703e-02   +8.590646019323789e-02; +1.708884157491291e-01   +1.053315159602812e-01   +6.197908250337546e-02   +1.506099094276672e-01   +2.106817216549517e-01   +1.259735209057582e-01; +3.980124634729583e-02   +2.320886430531593e-03   +1.771779747203560e-01   +5.124280841556365e-02   +7.715546266033656e-02   +2.891761242209944e-02; +6.089693186075226e-02   +1.027607334021107e-01   +1.643427385816745e-01   +8.413711742263880e-02   +2.468977147324852e-02   +6.454341307852310e-02; +7.921273157714111e-02   +1.969917031313818e-01   +1.504180103862235e-01   +1.098717331440274e-01   +5.767217398401649e-02   +1.669261803322887e-01];
L5_Input1_iAMPA_netcon = [+2.443267479567067e-02   +1.454259140859927e-01   +7.939520768282393e-02   +8.282549398932723e-02   -3.434636156336258e-02   +1.720956745896880e-01];
L6_Input2_iAMPA_netcon = [+1.278768613766553e-01   +1.179382653606710e-01   +4.439923441341739e-03   +8.305553345452384e-02   +9.862283117108747e-02   +2.700982267016889e-03];
L5_L6_iAMPA_netcon = [-5.571998102257146e-02   +1.331893435052395e-01   +2.428302631087384e-02   +2.188712058172947e-01   +3.308290661126081e-02   +2.842393165785330e-02; -3.600807387414966e-03   +1.014153118729435e-03   +1.442258863059472e-01   +1.611875268384560e-01   +1.778053610487581e-01   +1.081542287785895e-01; +1.577796402524875e-01   +1.479900058548068e-01   +1.137088538354178e-01   +3.707371004167787e-02   -1.833781475415484e-02   +1.426071317119866e-01; +1.065777898318677e-01   +1.794686829647283e-01   +1.301706334331316e-01   +3.417460076892634e-02   +4.560897036668846e-02   +1.362490440007707e-01; +2.846855797325564e-02   +1.733573344750443e-01   +1.677824281144433e-01   -3.196774407757046e-03   +6.604086350852707e-02   +8.278354644511199e-02; +1.488319558680170e-01   -6.763519792876052e-02   +2.265308562471462e-01   +3.001981838049658e-02   +1.520121086565094e-01   -3.578291475493153e-03];
L4_L5_iAMPA_netcon = [+4.920241044446736e-03   +1.200287300562818e-01   +1.765400215363459e-01   +8.903146282298528e-02   +5.402754978859127e-02   +1.786193326381986e-02   +1.894645658722967e-01   +5.007294970292616e-02   +7.233651647380678e-02   +1.322837431473656e-01   +1.628438859923816e-01   +6.872107761139126e-02; +4.062557527307700e-02   +2.000295007298165e-01   +3.868432273827090e-02   +1.203690514412633e-01   +3.281780230419783e-02   +1.038240516712532e-01   +2.093140149020292e-01   -2.091867106527304e-02   +8.825064521868146e-03   +2.906252303755013e-02   +1.306076006650289e-01   +1.283513006231994e-01; +5.682927950955632e-02   +1.314789347167374e-01   +3.321425158475796e-02   +6.128618194331367e-02   -5.056214733671944e-02   +1.838988281561157e-01   +2.584798136561804e-02   +7.031101773612138e-02   +1.510383237269763e-01   +1.096840614166478e-01   +1.360934935474778e-01   +5.782969841463846e-02; +1.398104218692170e-02   +1.004132634862188e-01   +5.797910033734351e-02   +1.640111240585427e-02   -1.974679223836345e-02   +1.173955018513400e-01   +5.118862730176718e-02   +4.634639429089490e-02   +1.423707009994156e-01   -1.384383447556447e-02   +1.752178996095113e-01   +5.280346188050116e-02; -3.765250803157236e-02   +1.194584470582792e-01   +8.988619471258308e-02   +9.701234033383579e-02   +9.124338710709036e-02   +9.350787588574855e-02   +1.628369543080646e-01   +2.160561805194417e-01   +6.558170672527082e-02   +1.907252053353059e-02   +1.339245983562934e-01   +1.349480983739390e-01; +1.522862390922764e-01   +1.037485364115936e-01   +6.342204797005738e-02   +1.281229140913950e-01   +9.852375214452291e-02   +2.100462912606841e-01   -8.872462109254317e-03   +5.878806376296011e-02   +6.892359247997398e-02   +2.034447158151092e-01   +1.591999230222885e-01   +1.903486275629110e-01];
L6_L4_iAMPA_netcon = [+1.153570724159576e-01   +1.094153452165924e-01   +1.176137547944690e-01   +5.093988975514128e-02   +9.222810037081972e-02   +1.084975264843840e-01; -8.677674782026223e-03   +6.913708882196498e-02   +1.834443455771979e-03   +1.028235685713092e-02   +8.420667864867082e-02   +8.689184446940720e-02; -2.409337144454274e-03   +3.253794263428949e-02   -5.178047128805112e-02   +2.331327203789103e-02   +1.869629071848856e-01   +9.170471303748075e-03; +1.786027722632828e-01   +1.506279127825949e-01   +6.952475568576552e-02   +5.238382397585709e-02   +1.684464519926808e-01   +3.292289644822298e-02; +2.413398465820842e-01   +7.404002324167928e-04   +6.873176637791814e-02   +6.262151389756174e-02   +1.255544935953284e-01   +1.482555744545196e-01; +1.341203750692404e-01   +1.634373535217367e-01   +1.026109949715322e-01   +1.049987646639667e-01   +6.084178224857045e-02   +1.738595996392947e-01; +7.462557924525469e-02   +1.313264502371529e-01   +2.095363816539179e-02   +9.549328874518605e-02   +1.781148007456605e-01   -1.249798392645152e-02; +3.706433358104279e-02   +1.711884089080511e-01   +1.568557834112655e-01   -2.261969115036354e-03   +2.072939993988762e-02   +1.628503589518192e-01; +3.850890424921094e-02   +4.989163003463756e-02   +1.321533013391855e-01   +3.797424508655819e-02   +3.421873193361677e-02   +3.922039423867735e-02; +7.773117588961911e-02   +9.486416668481300e-02   +1.433315442119252e-01   +9.450948428302412e-02   +2.051657932160648e-01   +7.812645769975102e-02; +1.406907134113121e-01   +4.571487672500315e-03   +1.780376060304770e-01   +5.643683237026997e-02   +7.366772275028854e-02   +7.011936841442035e-02; +1.007465646739972e-01   +1.070643068953543e-01   +5.893069032332012e-02   +4.025858778869928e-02   +1.035055787665968e-01   +1.068057414992300e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
