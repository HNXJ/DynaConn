function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.525667503583078e-03   +4.146842862523735e-02   +6.173075181292800e-03   +4.959567281099364e-02   +1.408413956107146e-03   +3.545495813915062e-02   +5.577067126270863e-02   +5.149948082062690e-02   +2.821942482713228e-02; +6.215720815030559e-03   +2.157759138196852e-02   -1.268702168250339e-02   +3.400172494207317e-02   +6.828990352995123e-02   +2.310632376228066e-02   +2.161537046448749e-02   -9.474955956722571e-03   +9.699951605094912e-03; +1.842953830601949e-02   +3.082481325657226e-02   +1.701632383275598e-02   +6.518417395602566e-03   -2.439595827677966e-02   +1.552252419535754e-02   +6.495701653620747e-02   +4.958653972716659e-02   +3.713616512318875e-02; +4.476893866243886e-02   +3.000635396067526e-03   +4.608327133646840e-02   -5.455705528496929e-03   +7.539194868980748e-03   +2.566484447722722e-02   +9.526621681329173e-03   +4.187438731680194e-02   +2.053726031577656e-02; +2.659962530768845e-02   +7.764388745537304e-03   +5.241901205240140e-02   +3.693128243717037e-02   +6.144570372941064e-02   +4.051093089227391e-02   +3.330707184184528e-02   +5.844722609876776e-03   +2.703720125057135e-02; +2.647618991219929e-02   +1.519896221959780e-02   +2.039120348421730e-02   +7.142711652614608e-02   +4.345138364544879e-02   -9.861009983370377e-03   +6.236253473756802e-02   +5.139226421107064e-03   +4.126989862260080e-02; -1.738997419478920e-02   +1.892034095545775e-02   +4.472057683785468e-02   +3.788125524879988e-02   +1.117451406061426e-02   +3.068774035504561e-02   +1.729803364036209e-02   +4.191637553469524e-02   +3.451662437517850e-02; +3.728136566647520e-02   +2.215373636836280e-02   -3.943706669843029e-03   +1.722737233811278e-02   +1.567597397540635e-02   +1.038823465717386e-02   +1.902040702061716e-02   +3.183034580649139e-03   +1.114218018620363e-03; +2.925252768932619e-02   +4.361759690062948e-02   -1.264015713816263e-02   +3.744889956660338e-02   -8.595301983310428e-03   +5.106198161655676e-02   +2.882584394865552e-02   -2.606119484186032e-04   -1.233593614647715e-02];
L1_L2_iAMPA_netcon = [+4.121741374369947e-02   +5.222570491946581e-02   +2.073643032696981e-02   -2.796199631266568e-02   +5.998243938093615e-02   -7.863740590018577e-03   +4.217637760843689e-02   +3.616535307143022e-02   +3.140383313410553e-02; +2.725042538287731e-02   +2.463752383239825e-02   +4.434665051917363e-02   +1.162604711110525e-02   -4.672159671325176e-03   +3.930907844035663e-02   +3.780373708840030e-02   +6.311212166513105e-02   +2.421508191766480e-02; +1.451151166385800e-02   +3.104321219120947e-02   +5.706490182920488e-02   +3.646376787362698e-02   -5.627055768344363e-04   +1.127892044960334e-02   +5.122245541845408e-02   +5.753164833423523e-02   -4.959413809117447e-03; +1.725859776012756e-03   +4.141812260639867e-02   +3.157892040129761e-02   +4.316346179296068e-02   +2.800470529762576e-02   +2.145374314004776e-02   -1.360856902736626e-03   -1.180057091860143e-02   +4.615654460411535e-02; +4.207938480952487e-04   +7.866563979822615e-02   -2.401621051878930e-03   -3.515223372913826e-03   -3.960903294064565e-03   +4.379224146400490e-02   +2.408874847348037e-02   +3.350372662951223e-02   +3.454281417889261e-02; +2.423384851572998e-02   +1.428870775310118e-02   +2.847822744948824e-02   +2.600850776298125e-02   +4.190097634739451e-02   -3.942692793875851e-03   +2.875763892175053e-02   +4.787611197940406e-02   +7.916661609246069e-04; +5.778976935873247e-02   +5.024592900087020e-02   -1.500521786443327e-02   +3.121019024663733e-02   -8.810613104212472e-03   +4.669682698847171e-02   +1.399302268651376e-02   +4.300075404575129e-02   +1.255121400622056e-02; +2.302856529884876e-02   +1.847519107087124e-02   -6.494612365037383e-03   -1.035799294721219e-02   +2.023497078438628e-02   +1.771328226402114e-02   +5.495211926086811e-02   +3.778096571275833e-02   +4.961146610823751e-02; +7.251055081657887e-02   +4.105006259347437e-02   +8.324262064987742e-03   +4.022392925371601e-02   +2.378287086711077e-02   +6.033015583360640e-02   -2.345221569335421e-02   +7.367184165658025e-02   +1.315380524521290e-03];
L2_L5_iAMPA_netcon = [+5.931820338278983e-02   +3.233944746139659e-02   +2.589637867616039e-03   +7.095154632193383e-02   +4.242264506185075e-02   +6.307034114003758e-02   +5.607480549118121e-02   +6.426146059492628e-02   -1.210808387992467e-02; +1.631003754168433e-02   +5.064280901100116e-02   +1.821061581065784e-02   +6.022041439056267e-02   -5.984129557163064e-04   -2.085389741397554e-03   -4.043506226078110e-03   +1.992856253107130e-02   +4.558282329104649e-02; +5.324896381386963e-02   +4.473456255611006e-02   +2.556276818624865e-03   +2.423992288269753e-03   +3.104169386255903e-02   +4.777694077336706e-02   +6.525207166617801e-02   +3.423829184229867e-02   +3.054183744627785e-02; +1.835268386307957e-02   +3.341865299234126e-02   +2.477237139213570e-02   +5.543144618868213e-02   +3.094667940538125e-02   +5.282343824216963e-02   +7.366711434960906e-03   +6.215918285003980e-02   +2.763237863874769e-02; +1.129738859020651e-02   +1.636965705623234e-02   +1.953936753743207e-02   +2.672161778554982e-02   +3.925768808969946e-02   -1.514920698880818e-02   +9.035501757770542e-03   -8.633009905705320e-03   +1.117908163936530e-02; +4.171277700469619e-02   +2.279233677193829e-03   +2.092376765879535e-02   +6.020367697947464e-02   +2.084606110380598e-02   +8.556938859421628e-03   +1.249010318709533e-02   +2.486295012087063e-02   +6.600658697540625e-02];
L5_L2_iGABA_netcon = [+2.407810433044309e-03   +7.615789931592697e-03   +3.053514530514060e-02   +9.465102984343637e-03   +2.465368839426450e-02   +6.945780973273397e-02; +7.422295843606863e-02   +1.036426265649666e-02   +4.298320661122853e-02   +2.613419443492709e-02   +4.039611869970126e-02   +3.096521345458303e-02; +7.836013194062494e-02   +7.991138593402509e-02   +2.546626898945726e-02   +1.301604114669961e-02   +1.447316363824394e-02   +1.336712228306311e-02; +1.035301774522369e-02   -1.275121056336197e-04   +2.015805304384716e-02   -4.131298445634613e-03   +3.478899645033153e-02   +9.651714167856021e-03; +1.420755541520067e-02   +4.701525509818787e-02   +2.903784568680661e-02   +2.619254867088764e-02   +5.444518941059225e-03   +2.723925056054384e-02; +1.615336306563313e-02   +1.777321863545810e-02   +3.004011899226708e-02   +5.094297178912920e-02   +1.736519204365077e-02   +1.630407410937073e-02; +1.734747178727652e-02   +2.231512448585935e-02   +4.395343874387266e-02   -3.084242417477017e-02   +3.656676226496196e-02   +1.678608528310668e-02; +4.926970138039071e-02   +1.311701622966403e-02   +3.960804701180658e-02   +5.642154084949230e-02   +3.078609337227941e-02   +1.362622852823552e-03; +3.255823882909380e-02   +2.111591572805635e-02   -2.662138654336315e-02   +3.480045127479511e-02   -1.544636654898167e-02   +2.288488627521983e-02];
L3_L2_iAMPA_netcon = [-1.678922332212667e-02   +2.693107852478888e-02   +4.117565674233273e-02   -1.060492866248060e-02   +6.611723766148896e-02   +2.998172095929183e-02; +3.001252135992427e-03   -7.660944085170634e-03   +4.585723530693900e-02   +7.608272576919839e-02   +3.022874974000439e-02   +2.699324039565635e-02; +4.241070600973537e-02   +3.199385493603556e-02   +2.879206074765467e-02   -2.050461993734021e-02   +1.110097302773263e-02   +1.596647644383396e-02; +1.306036839388671e-02   +1.895104204238954e-02   -2.061199260719385e-03   +2.230764588812793e-02   +9.101048656098256e-03   +6.789022186927145e-02; -7.785735423550902e-03   +3.337728449436084e-03   +5.052471985024256e-03   +5.503146461745559e-02   +6.280493640342785e-02   +3.374578992663362e-02; +6.202191144026586e-02   +1.912512520425048e-02   +3.590635402448300e-03   +1.366560447551393e-02   +2.977867329320177e-02   +3.166296282749578e-02; +2.056915992412220e-02   +2.974411855607966e-02   +6.725672300995057e-03   -7.135145283954673e-03   +2.633484508929938e-02   +1.360928422620131e-02; +6.563210772897605e-03   +4.581059631564718e-02   +3.289134362877590e-02   +3.420594881936884e-02   +2.581713520632448e-02   +1.611059911238782e-02; +1.214746601292641e-02   +4.386529731928344e-03   +1.225187355286933e-02   -1.679239638940715e-02   +3.767761655244641e-02   +4.285279463354756e-02];
L2_L3_iGABA_netcon = [+4.217333904622159e-02   -1.642872894395382e-02   +2.970060414674604e-02   +1.750344904922399e-02   +5.024602357715155e-02   +2.315027459574451e-02   +4.727593036218618e-02   +6.349996354315864e-02   +5.946260559666960e-02; -1.003058278489953e-02   +8.013280296817611e-02   +3.919091501292802e-02   +3.582556242281825e-02   +4.593876548945105e-02   +3.293612551594523e-02   +3.150579845234463e-02   +3.171752852203783e-02   +3.795807826394017e-02; +8.956304270106831e-03   +4.958375604218372e-02   +2.747165387699959e-02   +2.037765298350237e-02   +2.458828431795189e-02   +4.516157567616537e-02   +2.455771764944000e-02   +2.086584911288962e-02   +2.453362229077134e-02; -7.024633969116642e-03   +4.437357211355775e-02   +1.396362499364681e-02   +4.004824240446154e-02   +3.665099422034486e-02   +5.086985034700076e-02   +1.577398163031112e-02   +2.002264717831240e-02   -2.240540564631939e-02; +2.799938358418480e-02   +1.778704929882425e-02   +3.452787422525423e-02   +1.751159457389873e-02   +1.944823724990950e-02   +4.020762701088707e-02   -2.944338750082732e-03   +3.009811328824664e-02   -1.640485129772593e-03; +5.223829788117088e-04   +6.475126940858364e-02   +6.633484705228937e-02   +5.318588604745115e-02   +2.650524058833089e-02   +2.327921383570150e-02   +4.430325385992134e-02   +4.043988423440388e-02   +6.647813517406581e-02];
L1_L4_iGABA_netcon = [-4.796934230799853e-03   +1.811316694451125e-02   +2.459846899461541e-02   +2.793133099406633e-02   +4.461891654101807e-02   +3.656674926783607e-02   +4.547675874880265e-02   -1.903663046863982e-02   -1.646021149663352e-02; +2.720601753790727e-02   +5.691838689730742e-02   +7.527743848088413e-02   +3.647188515025300e-02   +3.392735706708960e-02   +4.949183079620001e-02   +5.837278617317125e-02   +3.340006854279279e-02   +2.820357859393496e-02; +2.289266684217487e-02   +1.303469736533655e-02   +4.650601219195510e-02   +3.462082958826050e-02   +4.869214894304640e-02   +4.871861924289885e-03   +9.675200549555053e-03   -2.607239307485814e-02   +4.268551326570335e-02; -1.044023917686228e-02   +2.702356472117202e-02   +6.190221755130041e-02   +5.292190032819053e-03   -2.410081252376423e-02   +1.952095162492683e-02   +3.619546670947472e-02   +3.856536428866763e-02   +5.818117527606852e-02; +2.203068569677704e-02   +7.575298775222376e-02   +1.776181408985237e-02   +6.126084221377386e-02   +4.831499889571927e-02   +3.524214058743623e-02   +4.761900710226134e-03   +4.572488923080882e-02   +5.165174963859464e-03; +1.603490550513604e-02   +3.501928723734953e-02   +2.148349950547473e-02   +4.886155900121293e-02   +2.106565896430913e-02   +6.318001861358165e-02   +1.545894744734297e-02   +3.300565742440507e-02   -1.925281406380553e-02; +2.191685562834574e-02   +4.968288329329653e-02   +1.795040599575981e-02   +3.853498437672954e-02   +7.955856210132142e-02   +1.451327089331382e-02   +5.056704861374879e-02   -6.695607518400125e-03   -4.155497922778530e-04; +1.780315839418536e-02   +1.598475238405079e-02   +3.972221433614166e-02   +2.727574249887295e-02   +4.272682181612600e-02   +2.006239194877094e-02   +3.531647934546633e-02   +4.921765072571176e-02   +5.180041420859543e-02; +3.357929308913723e-02   +2.915601421095738e-02   -1.445510421535373e-02   -1.111788972420962e-02   +3.291824145790959e-02   +5.704213632506474e-02   +1.780339734408323e-02   +2.880180368383127e-02   -1.005860471275320e-02; +9.577583456075822e-03   +5.268584727709361e-02   +3.428381422502558e-02   -2.699147070626725e-02   +8.769916697369956e-03   +1.577170986425800e-02   +1.742657326684884e-03   +4.467921582999848e-02   +5.162456918234481e-02; +7.166063218992334e-02   +4.067393806768442e-02   +2.679620024307554e-03   +3.290740513218039e-02   +1.843183753225392e-02   +4.314498863496367e-02   +2.592958599444148e-02   +3.563456234719681e-02   +6.112816987150126e-02; +2.979528575285702e-02   +3.141449745068753e-03   -2.787372730604038e-02   +6.760727571069834e-02   +3.716265681388034e-02   +3.102428466347196e-02   +3.706796289438061e-02   +3.219905982636317e-02   +4.990068297558943e-02];
L4_L1_iGABA_netcon = [+4.147568174204817e-02   +2.728039821351022e-02   +3.985420358948735e-02   -2.093078960608399e-03   +6.293679008968129e-03   +5.753862749267200e-02   +1.991797016517453e-02   +3.919979710818377e-03   +3.002504876145635e-02   -9.831687052701236e-03   +1.123560527799006e-02   +2.172443410223101e-02; +3.592061933944442e-02   +1.002581932712048e-02   +6.413500552688553e-02   +4.713948423746516e-02   +2.988602753128050e-02   +1.908786960565265e-02   +5.284516870735764e-02   +2.009063649638624e-02   +8.384995674002044e-02   +2.147703948923244e-02   -2.577316839079057e-02   +3.013390090572841e-02; +2.994864364630739e-02   +3.479381644634226e-02   +3.210401293473453e-02   +3.936853812644502e-03   +3.504589846850660e-02   +2.743169933173439e-02   +1.462247126082921e-02   +4.243804397949257e-02   +5.306933992879745e-02   +1.646068414460613e-02   +2.355147556908151e-02   +2.050598917566735e-02; +4.671746219974245e-02   +2.637170072599406e-02   +1.945655869371143e-02   +3.538897577932298e-02   +1.519623647661845e-02   +2.359909891792256e-02   -2.431453797414377e-02   +2.322489392077139e-02   +1.564496337406499e-02   +5.981358904802230e-02   +2.270197254697159e-02   +6.177373613940428e-02; +4.267304420624370e-02   +7.521803266503219e-02   +2.905079936819024e-02   +2.006720627931926e-02   +3.712040379403739e-02   +1.684899793448187e-02   +7.871188228885809e-03   +2.068620080344409e-02   +2.299807014877477e-02   +5.559835542449865e-02   +4.676403932251978e-02   +3.696922556738685e-02; +1.346961911669484e-02   +1.302837811699655e-02   +2.614655798035490e-02   +5.649739395582245e-02   -2.939326459691748e-02   +2.839848634944242e-02   +2.760655129440593e-02   +8.267915000342234e-02   +1.558504746851811e-02   -8.523457446761161e-03   +9.831951031603961e-03   +2.411656644451796e-02; +2.322739383573205e-02   -3.539408971373794e-02   +1.871515601072300e-02   +3.235842145970086e-02   -1.810460909750785e-02   +3.692072845914061e-02   +7.580538942154345e-03   +4.140739463882017e-02   +3.397114456076535e-03   +7.954437251437248e-03   +7.418465634468753e-03   +5.494413250801987e-02; +8.138049594794822e-02   +1.790272736737560e-02   -1.202256922626430e-02   -4.517116487204390e-04   +3.192201270912232e-02   +1.622672302768480e-02   +3.472090190551359e-02   +1.586940743464697e-02   +5.106015681622217e-02   +5.868672761421175e-02   +5.428921085480434e-02   +2.429245689294956e-02; +3.085313143499658e-02   +2.796893732632619e-02   +3.851096947066959e-02   +2.229770839625537e-02   +1.695951124419504e-02   +2.554019108718634e-02   +2.040749061651766e-02   +8.380359644077780e-02   +5.125617820049785e-02   +1.342013922446939e-02   -9.840488866996259e-03   +2.006855443459817e-02];
L1_L3_iAMPA_netcon = [+4.175632365981433e-02   +5.297633053839079e-02   +3.485674569342445e-02   +5.091854961684992e-02   +1.542581216951575e-02   +3.340546709113785e-02   +2.603664149721607e-02   +5.790008512323234e-02   -4.039456773351378e-04; +2.143824586550655e-02   +5.379969130240775e-02   +4.252603218083292e-02   -1.416792516560466e-02   -1.123147463136350e-02   +1.638260347200024e-02   +7.698687335592340e-02   +1.377427090765873e-02   +7.147111949002520e-02; +3.117752584437683e-02   +1.635454956307324e-02   +4.154423469559355e-02   +6.783791097870678e-02   +3.182483589333457e-02   +3.916195419000373e-02   +3.848107235151539e-02   +8.218603387910868e-02   +3.355568488775561e-02; +5.816713445300147e-02   +1.928486515802567e-02   +9.403907064694338e-03   +3.303605421965568e-03   +5.319631455067288e-02   +3.183568885510808e-02   +1.365996275906396e-03   +3.289688797930362e-02   +2.050125798255217e-02; +7.847565077518399e-04   +2.629839827869719e-02   +1.774657236229823e-02   +4.739864342980382e-02   -3.010127995675635e-02   +4.054499573245630e-02   +2.070412949641918e-02   +2.938998192675886e-03   +3.236858008877713e-02; +1.413374006905080e-02   +4.058494992092071e-02   +2.230074988988975e-02   -1.978921433255500e-02   +1.898392683120551e-02   +4.214162880273768e-02   +2.884752422167380e-02   +2.259021973617982e-02   -8.928539476652062e-04];
L3_L1_iGABA_netcon = [+5.774458359436649e-02   +5.304258665502074e-02   +2.365673639826397e-02   -7.895297979974415e-03   +1.276259758506433e-02   +4.069709056920356e-02; +1.087623284982452e-02   +3.811392915584717e-02   +1.107225403663037e-03   -5.920089647015042e-04   -1.294690171231989e-02   +1.227379575200223e-02; +3.880275764976061e-02   +1.938298651740462e-02   +4.191553868867319e-02   +2.420024348240877e-02   +6.278037649755527e-02   +5.004084166406840e-02; -9.677412030604841e-03   +5.607475251197243e-02   +3.261739447014746e-02   +3.801045632344036e-02   +8.446678339358651e-02   +4.918059390068374e-02; +3.044146247464720e-02   +2.477582520070764e-02   +6.135998329298217e-02   +8.382729051707673e-03   +2.902618982850348e-02   +3.149370458696431e-02; +7.132027965791031e-02   +2.581800743726837e-02   +9.595035220609276e-03   +6.760094131873570e-02   +5.638321298882016e-02   +2.818407735185854e-02; +4.483533384122018e-03   -1.981777798018917e-03   +3.721691935833529e-02   +2.886396352255101e-02   +3.835661167313267e-02   -6.236969764764194e-03; +2.985035027638788e-02   +2.440206695432494e-02   +6.502573237707064e-02   +1.331289476525754e-02   +2.570348723483376e-02   +1.041037912099480e-02; +5.527192482629348e-03   +8.223091533256190e-02   +5.030703849330549e-02   +5.251938180068090e-02   +3.093492325973446e-02   +6.229980581712436e-02];
L5_Input1_iAMPA_netcon = [+6.877892800493481e-03   +3.246166684769605e-02   +3.274854849022047e-02   +4.062645735979016e-02   +4.241353090899125e-04   +5.864821456903311e-02];
L6_Input2_iAMPA_netcon = [+1.463848273964433e-02   +3.383164699351561e-02   -1.158745283626679e-02   +1.349668607970830e-02   +3.289261317301254e-02   -1.439520875021296e-03];
L5_L6_iAMPA_netcon = [-1.602394543797148e-02   +4.174887946297881e-02   +5.729199572344957e-03   +5.835022196980330e-02   +2.248167153081042e-02   +1.388488120017108e-02; -2.692548787301549e-02   +1.980730320311650e-02   +3.003977549757930e-02   +3.611952752055873e-02   +3.818970175295187e-02   +4.142698758883379e-02; +5.202332298142226e-02   +5.037630674469442e-02   +4.309665125945417e-02   +2.565285548601884e-02   +6.105540182567233e-03   +3.623435549585401e-02; +2.975157647947098e-02   +6.260476124742921e-02   +4.532048798642135e-02   +1.168227645676213e-02   +4.416387522858395e-02   +4.322388118238489e-02; +2.267328930979666e-02   +4.872422657873497e-02   +6.595022263125890e-02   +1.299153522697285e-02   +3.588712357429432e-02   +3.550831604143311e-02; +3.742109758883282e-02   -6.660721232268749e-03   +8.136053006482243e-02   -6.582636179560562e-04   +5.738618441439204e-02   +9.284454874254573e-03];
L4_L5_iAMPA_netcon = [+1.575228837850673e-03   +2.193364426073335e-02   +6.075504080761475e-02   +3.256464818040090e-02   +1.571641224188760e-02   -2.222728890292856e-02   +7.178995652929582e-02   +2.514829331447119e-02   +3.803242105724632e-02   +3.620490922389530e-02   +7.265338003083878e-02   +1.615171210935172e-02; +1.110425696222225e-02   +5.119182919795089e-02   +1.424572615518448e-02   +3.555807327860834e-02   +3.508173568863425e-03   +1.654148724497052e-02   +5.682769565006827e-02   -1.421424281877285e-02   +1.898841979869650e-02   +1.652445791434738e-02   +5.656628298802892e-02   +3.903006282811252e-02; +3.067986395975955e-02   +3.116512383698239e-02   +1.985550483649166e-02   +1.006626737635864e-02   -1.815501054098221e-02   +6.848472732742210e-02   +6.260999836561386e-03   +3.019301929488553e-02   +3.915286758494708e-02   +4.085644989847281e-02   +3.802816172855420e-02   +5.187590776343464e-03; +1.045262154727009e-02   +2.363118115907066e-02   +2.156106253127830e-02   +3.621853666356714e-03   +1.493441270983470e-02   +4.458738275642764e-02   +3.044194933853303e-02   +9.967997003589890e-03   +5.068636324645652e-02   -1.480334688246441e-03   +8.014811615836835e-02   +2.697076851955335e-02; -1.914896523493656e-02   +5.478688800203620e-02   +4.346795683104625e-02   +7.735846167073481e-03   +3.589979011089155e-02   +4.677607930574135e-02   +4.827547758115282e-02   +6.994736235426423e-02   +2.905690749765277e-02   -1.285417787181029e-02   +2.779736255657228e-02   +2.123994040428925e-02; +4.203886296608969e-02   +4.254602356078560e-02   +3.528612208061970e-02   +4.736856822325648e-02   +4.136259186679750e-02   +5.850899027984255e-02   +5.229708062022003e-03   +1.839716582040534e-02   +1.693652465547712e-02   +7.194737489963555e-02   +1.926558086263122e-02   +6.017162793112722e-02];
L6_L4_iAMPA_netcon = [+5.785918081449748e-02   +3.835982936852279e-02   +2.929404680951394e-02   +3.518835971279251e-03   +2.180492728926633e-02   +2.954876301781952e-02; -4.568848652730034e-03   +3.458019843030938e-02   -1.249930883804231e-02   +6.975966234352520e-03   +2.145184649741402e-02   +2.441973352516673e-02; -5.751608757276707e-03   +1.495708398128007e-02   -1.387734894507034e-03   +2.475884314838986e-02   +6.541206507612625e-02   +3.724224645135285e-03; +5.443458552145126e-02   +4.484203374006063e-02   +4.075638859355030e-02   +2.885189096711088e-02   +6.694207060266098e-02   +8.213480299383163e-03; +1.050962640629333e-01   +1.218937004870753e-02   +2.029978246604498e-02   +1.572831633226937e-02   +3.922252007697892e-02   +6.542378235075245e-02; +5.016235858182798e-02   +4.988059813034789e-02   +4.535344971749520e-02   +2.977199696935001e-02   +6.038738214141558e-03   +7.662170908401097e-02; +2.783544202062741e-02   +5.100281177443654e-02   +9.659783768879540e-03   +5.051393467112449e-03   +6.280564609999879e-02   -1.095609951811348e-03; +1.745386462237525e-02   +6.326542348389290e-02   +5.961166838749343e-02   -1.454623620819518e-03   -9.847681714219955e-03   +7.648470796045469e-02; +9.086937523755684e-03   +1.404689284714189e-02   +5.088000937187769e-02   +1.473571292698932e-02   +2.068894774363061e-02   +1.112643801221936e-02; +1.132709457987930e-02   +9.489156174624166e-03   +6.626033087301850e-02   +4.273868955620153e-02   +5.800275321637977e-02   +3.076683137359786e-02; +5.617223188960339e-02   +1.630449072434276e-03   +5.424150979033663e-02   +1.203580863285654e-02   +2.441867705813267e-02   +9.168641351925076e-03; +4.303952769693834e-02   +4.350930844084098e-02   +1.422615283164944e-02   +7.473270913398927e-03   +3.556023208970045e-02   +3.297813271469750e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
