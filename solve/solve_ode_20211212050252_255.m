function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.443630449640849e-02   -3.405713651951819e-02   -4.433433072308771e-03   +3.356277717478676e-02   -1.644593522631134e-02   +3.488103541060841e-02   -5.654792433867233e-02   +4.655222583918428e-02   +6.791316001473913e-04; +2.087400536133460e-02   -3.676293491594430e-02   -3.023009659973199e-02   -2.084504656528836e-02   -1.160518334343677e-02   -7.107106160970525e-02   -5.499070810542574e-02   +1.671345595995714e-02   +3.406567792325089e-02; +3.533583851646311e-02   -3.505552009287274e-04   +3.645637696550823e-02   +1.014748703810338e-02   -8.199959349155801e-03   -3.280413905825152e-02   -1.866095506290825e-02   -1.342431260879403e-03   +3.972977295740879e-02; -3.225313585850242e-02   +7.947912744325948e-03   -6.549029615418969e-02   -2.667133275458396e-02   -3.954703533941963e-02   +7.061252111468156e-03   +1.658350372287535e-02   +1.198461800193792e-02   +2.881165636294710e-02; -7.500963890602619e-02   -5.716439860721713e-02   +5.872549682740223e-04   -2.946534841325619e-02   -7.951920102212182e-02   +2.048961997924753e-02   +2.568095283933033e-02   -3.676693909223473e-02   -8.958933657612878e-02; -6.011987651504172e-02   -1.872580364016317e-02   +1.086904811233624e-02   +3.758961613059120e-02   -2.499159458953554e-02   -2.945058949789580e-02   +2.159129614744292e-02   +6.500767714326780e-04   -1.745450248044499e-02; -2.734668288380004e-02   +1.942312607737056e-02   +2.699363300942077e-02   +1.399750468305892e-02   +2.126718227738648e-02   -7.692063178733963e-02   -1.296453102703383e-04   +3.894815016429737e-02   +5.472733992090244e-02; -3.940991286118139e-02   -3.201182041526740e-02   +2.530208181201102e-02   +6.691561846629546e-02   +1.725724496459325e-02   -5.871513034031417e-02   +1.597396764462979e-02   +2.656074363355052e-02   +1.552112085360594e-02; +6.835336305759816e-03   -8.752235553102145e-03   -8.841857147129123e-03   -2.613634044604434e-02   +6.213277877498199e-04   +6.942404175345920e-02   +4.278695685949221e-02   +5.552696403369460e-02   -2.572082535706144e-02];
L1_L2_iAMPA_netcon = [-2.076692653715378e-02   +1.516022881928099e-02   -4.587897488155655e-03   +3.506934719221770e-02   +3.743236642766209e-03   -1.691594900050478e-02   -5.625723146924061e-03   +1.392055557888646e-02   -2.173548597035858e-02; +1.212070275352788e-03   +1.781347114488219e-02   +9.451256639414112e-04   +7.812249319991948e-03   +4.075466925580996e-02   -2.825082284073135e-02   +3.442856097547131e-03   +1.069908187624430e-02   +3.131016958088699e-02; -3.156294108567546e-02   -4.979730733905084e-02   -6.518402784474626e-02   +6.659672213097947e-03   -5.175957291737560e-02   +6.100659298092320e-03   +2.930974077354273e-02   -5.681788021619478e-02   -3.567206659470432e-02; -1.036298193953222e-01   +2.080754353167366e-02   +2.933759731790962e-02   -3.053122748103446e-02   -5.330433598213654e-02   +7.933172321613563e-02   +9.914786554404427e-03   +5.599146237133970e-03   -1.120218882276436e-02; -5.616668061512977e-03   +3.045938906398798e-02   -6.442227411733750e-02   +4.346997640869034e-02   +3.375475456734078e-02   -2.561310852718173e-02   +1.395457391611239e-02   +3.122794797480710e-02   -4.402367869741797e-03; +2.764002754803960e-02   +1.702423088897409e-02   +5.833888014314408e-03   -2.375059903694286e-02   +4.970733054516364e-02   +2.826971373770168e-03   +2.756953401583122e-02   +1.277235393478894e-02   +2.134394552193614e-02; +1.525397160378173e-02   +3.890427546319074e-02   -1.262456795138849e-02   -6.312086717215725e-03   -5.658739879644910e-03   -7.525228668418468e-02   -1.475872595954150e-02   +4.802044001329497e-03   +1.929084662327172e-02; -7.272033140686685e-03   -1.258563688678962e-02   +6.920445226086688e-03   -2.777665144413898e-02   +4.720776383060304e-02   +2.153238280979473e-02   -6.260990728040572e-02   +2.304259666247679e-02   -3.730792476808222e-02; +1.274223745688405e-02   -4.086840219199472e-02   +2.434417459793046e-02   +5.671198185898392e-02   -2.477555839402396e-02   -1.674493710732167e-02   -3.986204373532938e-02   +2.837272202671973e-02   +2.717668702736130e-02];
L2_L5_iAMPA_netcon = [+2.339606416612428e-02   -1.538385904462642e-02   -2.281171093358150e-02   +3.233067946081022e-02   -1.733290929552437e-02   +1.366258966638199e-02   +2.795685193032757e-02   -2.120718648881790e-02   +1.458657634920736e-03; -1.839969329942389e-02   -6.433816557071990e-02   +7.852816252459882e-02   -9.074887615370272e-03   +3.902204167753522e-02   +2.082388323803626e-02   +8.864587777896286e-03   +5.182548747431698e-02   +3.470537114802634e-02; +1.165557663605441e-01   -4.184829395414052e-02   +5.801004293167870e-03   +1.053150068129642e-02   -3.349629987546417e-02   -2.886138060455351e-02   +8.788059928834491e-03   +4.384191032663527e-02   +5.146409615086156e-02; +3.000315743762359e-02   +4.809441901429292e-02   -1.474551516374207e-02   +5.919481106361354e-03   +3.863917052856377e-03   -4.366347635895240e-02   -2.684132239063689e-02   +2.262319226676086e-03   -1.973938950371541e-02; -7.388023562535737e-03   -1.461520563201222e-02   +1.867757008846217e-02   +2.820107207891850e-02   +9.582039055956734e-02   -6.989581220312165e-03   -1.814843688590416e-02   +4.433352554559629e-02   +1.668805184299072e-02; -2.349387047827706e-02   +2.313164602877005e-02   -5.788111095514572e-02   +2.287200519530880e-03   +4.587368423510196e-02   +1.637414212345025e-02   +4.402238041265421e-03   +1.664529961808469e-02   +1.477622779673675e-02];
L5_L2_iGABA_netcon = [-1.515677967813927e-02   +3.119625627107218e-02   +3.924961777710394e-02   +3.682898707244905e-02   -5.730606169961380e-02   -4.458765499349605e-02; -2.389710506300162e-02   -2.816529900174539e-02   +4.353152534748467e-02   -4.010550875673702e-03   -3.548059233470328e-02   -4.440686770754484e-02; +4.957467541593625e-02   -6.799768565343484e-02   -1.823961382753592e-02   +3.113371074721404e-02   -1.255899943544523e-02   -3.032972086893647e-02; -3.037986671634913e-02   +3.971316523539744e-02   -2.180094784782054e-02   -3.881114150312917e-02   -1.328278288022618e-02   +7.758553636408837e-03; +1.725746906202990e-02   -9.672879484676504e-02   -2.043733212666739e-02   +2.875613336505869e-02   +3.945486009464656e-03   -8.112711957523465e-02; -1.519331367681913e-02   +5.112756296899484e-03   +1.556574696382882e-02   +4.739785861491895e-03   -4.208989111473643e-02   +2.491810736169236e-02; +2.129471566202427e-02   +2.272812722068076e-02   +2.191801688960365e-02   -2.887087879842848e-02   -4.064086400252711e-03   +1.292709624415713e-02; -1.910501076533795e-03   +2.501135108603801e-02   +1.650825316304973e-02   +2.711378788466192e-02   +4.890830166381900e-02   -1.069388791363348e-02; +3.486353773033430e-02   -7.551195430234802e-03   +1.765389593071151e-02   +3.396246319992732e-03   -9.054275318946467e-05   -6.472324718194679e-03];
L3_L2_iAMPA_netcon = [+4.156471383747820e-03   -2.250725780379743e-02   +4.251253590365341e-02   +7.340437536353690e-02   -4.546609589229478e-03   -6.153898946242609e-02; +2.395097029430115e-02   -3.278997222222902e-04   +5.356257514260133e-02   -8.163451555696786e-03   +5.342359526664282e-02   +1.061896581382195e-02; -4.081152092722733e-03   +2.594253398979396e-02   +2.274210154495458e-02   -4.322875084797935e-02   +3.432261351626372e-02   -3.995955422568259e-02; +2.609048604619186e-02   -1.390265533141269e-02   +6.504533457926186e-02   +1.689395243038169e-03   -1.065788131132992e-01   -7.271246925457606e-02; +6.464185508092352e-02   +4.269089919499528e-02   -4.865893946503373e-02   -1.263349409661280e-02   -2.643027966875856e-02   -7.370414828267894e-03; -2.251461420738407e-02   +2.148130307121503e-02   +1.253787649974909e-02   +4.346785862409507e-02   +6.465479620055625e-03   +5.196956692819604e-03; -1.140947995980210e-02   -2.747455379992290e-02   -1.774202672722567e-02   +3.161113237720681e-02   +4.255057198107458e-02   +4.259592288545504e-02; -2.511188146502068e-02   -3.819255310949000e-03   -4.548218625582359e-02   -9.006643334025918e-02   -3.262650063897890e-02   -9.272565792439423e-04; +2.335413612129821e-02   +5.034557291344719e-03   -3.212310554083198e-02   -2.006033095706874e-02   -1.807696786707804e-02   +4.920008241866038e-02];
L2_L3_iGABA_netcon = [-1.934311826028556e-02   +5.499397037704024e-02   -3.424885045165853e-02   +1.360435334359185e-02   -5.072477874600380e-02   -5.836514272900094e-02   -2.463762655153395e-02   +2.285067329331727e-02   -7.395179301746402e-02; +3.228580736023715e-02   +1.582110052236949e-02   +2.281037769374580e-02   +2.903926337808552e-02   -2.363853977297867e-02   +6.524123563382300e-02   -1.503463659114409e-03   +3.692746289854937e-02   +1.016961317014870e-02; -1.186282809808379e-03   -9.853161736577701e-03   +1.450887193355151e-02   -4.077364504558256e-02   +1.039850969294097e-02   -5.923881713335589e-02   +1.371152464204951e-02   -6.856019870651880e-02   -7.119771684292696e-03; +3.371692831425065e-02   -5.972698749336230e-04   -3.554680506041736e-02   -8.374923154450337e-03   +3.410837962882947e-04   -2.161283287042316e-02   -3.347516806319245e-02   +3.123103176305623e-02   -1.883889610893425e-02; +2.375543210834519e-02   -2.683634423970869e-02   +3.577773170729343e-02   +5.571470541675083e-02   +1.502544733206711e-02   -4.121436627264299e-02   -3.276079431379624e-03   -3.642791439841017e-02   +6.391121850674149e-03; +7.526603079856801e-02   +2.499706443895428e-02   +5.018415169224745e-03   +3.685085546125384e-02   +2.332519733253211e-02   -4.004422476096318e-02   -9.250082552073147e-02   -5.375937762977806e-02   -3.640378961093083e-02];
L1_L4_iGABA_netcon = [-7.377230208914265e-02   +1.303466837183222e-03   +9.245888134652052e-03   -2.756941187800730e-02   +6.899486638241675e-03   +5.145892001246355e-02   -2.688321133419873e-02   +3.308246708614174e-02   +2.375683975416806e-03; -2.265196412787327e-02   -5.137740650375737e-02   -4.491564054348326e-02   -6.415033687939932e-02   -1.681898508898471e-02   -4.114977308328156e-02   +2.248944653074375e-03   -2.504877674738498e-02   +8.387240120951010e-03; +3.379189173089675e-02   +9.187545417065020e-02   +3.864281896067642e-02   -5.668474332660997e-02   -4.697766283908360e-02   +5.948360893568615e-03   -6.287795274129709e-02   +3.573981151022704e-02   -2.090161621655172e-02; -2.110390849569481e-02   +3.893519970148151e-02   +3.252904262958445e-02   -4.252392765310752e-02   -8.001608129081923e-03   +2.994283164450418e-02   -1.303692979897122e-02   -2.791414958561617e-02   +1.795588307634111e-02; +3.915727254804598e-02   -1.169701965010734e-03   +4.720802541047925e-05   -5.389176802685189e-02   +4.839033687242458e-02   +1.104002229967003e-02   -9.080163409777976e-03   -1.914566472192820e-02   -8.480041042582538e-02; -1.254976580507418e-03   +7.103561338371924e-03   +7.388595033942068e-03   +8.031397215291572e-04   +1.891760383403613e-02   +7.633606420957142e-03   -5.796707453123488e-02   +4.509484667789537e-02   -4.472467622145988e-02; +2.234076350237525e-02   +1.344752622325633e-02   +2.488374808890136e-02   -5.011497338613655e-02   +7.464958758301646e-02   +9.902953834242195e-03   +2.768962201740188e-02   +1.681077830245459e-02   -5.809881315293197e-04; -1.002630173308187e-02   -2.979218951529679e-02   -4.603395496568131e-02   +3.464521916132948e-02   -4.083073172873901e-02   -4.441038576722765e-02   -1.673088777861959e-02   +4.546211443914239e-02   -1.776501364747684e-02; +1.649646009993376e-02   +7.117356126076840e-02   +3.055802098813832e-03   -7.337068989293542e-03   -1.732942695889926e-02   +3.950160835870581e-03   -4.753422305423879e-02   -3.813070221551079e-02   +4.575372620083043e-02; +4.427661965248479e-02   -1.106368125610609e-03   +1.864740245807565e-02   -1.439962171679146e-02   -2.193780345654599e-02   +3.456101586496107e-02   +3.264668480917288e-02   -2.974834432557809e-02   +4.222344808565286e-02; +2.822055696774066e-03   +2.290664032418731e-02   +3.355185416156336e-02   -2.759709180189222e-02   +3.509087284619929e-02   +7.618373873988954e-02   +4.998967786546973e-02   -1.098709556369088e-02   +7.444813585230720e-02; -6.365986880925356e-02   -5.357258306621519e-02   -3.671594430788214e-02   -2.571345668927134e-02   -5.057477837572216e-03   -3.210236178806000e-02   -7.334039400090825e-02   -4.792446469087761e-02   +7.529800418876309e-02];
L4_L1_iAMPA_netcon = [+6.358220238802920e-02   -2.410136374276880e-02   +7.854214485135311e-02   +1.397389248844089e-02   +2.665412309377580e-02   -5.142680190182906e-02   -3.361771302913445e-02   +3.718181632843430e-02   +2.152766002512436e-02   +1.462757061040013e-02   -3.298497363397247e-03   +5.677615805048118e-02; +3.406522906670081e-04   +1.000831343009592e-02   +2.312700649215554e-02   +3.944199890102023e-02   +9.237443889443413e-03   +9.764144746925804e-02   +7.892980747240422e-02   -8.547363973907429e-02   -5.334960150046365e-02   -3.776014156953653e-04   -3.289484842260167e-02   -1.727502305145991e-03; -1.212470702355320e-02   -5.027781522420743e-02   +3.866196477191854e-02   +5.763263126370811e-02   +3.513217706698625e-02   +2.671625384653064e-02   +1.169479164860054e-02   -6.931516854003780e-02   -2.119001421980561e-02   -9.631569529448360e-03   +5.007722857869754e-02   -1.202525322887542e-02; -1.177588761312113e-02   +7.896941154845122e-03   +6.578404760222265e-02   +3.449601994033014e-02   +5.422946781205992e-04   -2.234993208844788e-02   +5.414008985498855e-02   -4.710683538458946e-02   -3.520871355509193e-02   +4.050555149804689e-02   +7.463215580815677e-02   -2.226257725518160e-02; +1.698122167902109e-02   +1.863953950374780e-02   -9.495410260614161e-02   -1.365814185591691e-02   +7.434928861646877e-03   -8.626143429341759e-02   -2.214428751043002e-02   -3.232342609672786e-02   +4.094879980353930e-02   +4.897094139423862e-03   -4.854087029796652e-02   -4.384386170404926e-02; -1.303219032262033e-02   -6.816381975318950e-03   -5.064146568298314e-02   +2.071939789439402e-02   +7.349202236926981e-02   -6.424174332179865e-02   +1.936639960363608e-02   +2.794681233092996e-02   +2.092166365597036e-02   +2.248132385800191e-02   +3.583427695894068e-02   -1.432502908363910e-02; -6.986562345024480e-02   -2.464004989183678e-02   -4.550655899922760e-03   -1.754975999261356e-02   +1.422247129882053e-02   +6.188320367783450e-03   -1.886504875383549e-02   +3.123540923936824e-02   -8.988499460246450e-02   -3.307188529171841e-03   +7.972137936450321e-02   +3.101673122049765e-03; +3.291659059254201e-02   +5.028063404927624e-02   -4.428770519636287e-02   +6.549990554477367e-02   -1.835398550068233e-02   +4.301899769630925e-02   +3.719445794796929e-02   +1.992920349525993e-02   -3.468895590063358e-02   -5.667696815212646e-02   -1.065927975885252e-02   -2.851978840116033e-02; +1.504159662793010e-02   -3.992372927467214e-02   -4.831003396093760e-02   +1.789798200982842e-02   +3.811365393600145e-02   +2.951357595101523e-02   +2.698938437746183e-02   -7.365545472262988e-02   -2.685199353340989e-02   +4.307659825324772e-02   -5.282627640977276e-02   -1.992610167650805e-02];
L1_L3_iAMPA_netcon = [+1.809416428831799e-02   +1.575396130077146e-02   -3.937122780437753e-02   -1.614484201652128e-02   +5.455458225967304e-02   -5.699753505361013e-02   +3.608173206180471e-02   +2.168337031574208e-02   +2.430548653926837e-02; -4.781371968776930e-02   +3.182209506557093e-03   -1.771703625892716e-02   +4.791819745557515e-02   +1.289227325265606e-02   +6.777373451003941e-03   +1.431649183850106e-02   -4.241707727461690e-02   +7.068401021548973e-03; +4.735843456580598e-02   +6.411254741088319e-02   +1.606532480624627e-02   +4.119764906980020e-02   +5.970910743061768e-02   +2.025639725754496e-02   +3.683087369628221e-02   -7.112869955293666e-02   -1.472903207800380e-03; -1.497197678340981e-02   -3.054690590002705e-03   -1.793713265939012e-02   -1.325589556525217e-03   -2.282270754170836e-02   -1.037050271441817e-02   +1.509105768564187e-03   +2.856175960739445e-02   -5.832216514751496e-02; +4.946524214752806e-02   -5.429931959810608e-03   +8.324384191103717e-03   +4.128365748506770e-02   -9.419495024946628e-03   -4.640701694572907e-04   +2.424889114411580e-02   -2.859196747554597e-02   -2.744224904869321e-02; -6.010381233659829e-02   -4.580519998695810e-02   -1.319959472991299e-02   -7.794333876352181e-03   +4.895133455114277e-02   -2.653537013633203e-02   -1.726670386864882e-02   -1.075577382307714e-03   +2.183881472383085e-02];
L3_L1_iGABA_netcon = [-2.393133504586935e-02   -2.318566958820160e-02   +5.406714354910455e-03   -8.650742690934561e-02   -2.641249464048263e-02   -5.279609661367410e-03; -1.620195121412836e-02   -6.677705301588689e-02   -1.290236989900543e-02   +1.963794104211082e-03   -3.164030995965846e-03   +5.423084003345301e-02; -1.330839788235479e-02   -1.472892784169628e-02   -2.679276900252579e-02   -4.820410095663074e-03   -9.595465775714497e-03   +6.532962674723297e-02; +4.325415279029224e-03   -6.189124182270739e-02   -2.584393584127751e-02   -4.788437441203496e-03   -2.820501381937496e-02   +3.430558505330520e-02; -2.524870643456689e-02   +6.816933530641002e-02   +4.791886073360299e-02   -9.922486772535324e-02   +3.297447489110884e-02   -3.085680868788666e-03; -5.589068220231466e-02   -1.609583048556652e-02   -3.979303549416977e-02   +7.701981310884892e-02   +1.769985547915540e-02   -4.411650564411995e-02; -5.732553765095275e-02   -9.013672033106736e-03   -2.353985737700929e-02   +7.252694655208165e-02   +2.260906179060075e-02   -2.598476408819591e-02; -5.191624902349187e-02   +1.721372644262779e-02   +3.162852632952302e-02   -4.547969057741628e-03   -2.893698904304489e-02   +2.901132024866439e-02; -4.405496676814534e-02   +4.326304129045112e-02   +4.513876357624333e-03   -3.251754924409421e-02   -3.963466178459884e-02   +8.005330122956324e-04];
L5_Input1_iAMPA_netcon = [-1.625016943268156e-02   +7.297347553885250e-02   -2.885680686778808e-02   +2.486896993519890e-02   -3.485440607986141e-02   -7.057929090150242e-03];
L6_Input2_iAMPA_netcon = [-4.383586036010255e-02   +4.384666397412285e-02   +4.350988497902122e-04   -5.150402739772533e-02   +1.389783321110035e-02   +5.563374602009945e-02];
L5_L6_iAMPA_netcon = [+1.113332787621112e-02   -8.347461500644152e-02   -1.710214190418877e-02   +5.295428032539629e-02   -1.653730688593969e-02   +1.944192015978818e-02; -2.981769740909447e-03   +8.643297470640431e-03   -1.313145590426543e-02   +5.698725747374560e-02   +1.998416494355118e-02   +3.045601213507493e-02; -2.603180236652381e-02   +2.987870448018666e-02   -1.982169948244103e-02   +1.511667650864259e-02   -2.080135460540448e-02   +6.383953674515910e-02; +4.418753662053152e-02   -3.005008375909199e-02   -8.723742139169390e-02   -6.119387906741321e-02   -6.524048634433749e-02   +8.609899120171433e-03; -4.388270850775099e-02   +1.980598705534072e-02   +5.526615026473548e-02   -1.305117415400717e-02   -1.232993646365942e-02   +1.317134698519164e-05; -4.523201212481238e-02   -4.318243631463399e-02   +3.720224040351006e-02   -3.829474823902674e-02   +2.829596750606694e-02   +4.425208433715361e-02];
L4_L5_iGABA_netcon = [+1.069864415809788e-02   +8.695154836439159e-02   +1.043840682982750e-02   +5.474634364824637e-03   -1.377691601583871e-02   -7.226963097177538e-02   -1.547869557050829e-02   +1.213022672723489e-02   +3.140563214270162e-02   +5.938029230967846e-02   +8.569182707255214e-03   -9.590504681723794e-02; -1.719858217680288e-02   -6.474148896668000e-02   +7.869091163842470e-02   +4.769527505162936e-02   -3.366243725654753e-02   -1.364108040887071e-02   +4.970323291785253e-03   -1.811497792264715e-02   -4.407933172839992e-02   -6.777392052202663e-02   +2.158762457508779e-03   +4.847305376101251e-03; -4.813109439213596e-02   -2.222235781999293e-02   -8.119105223239441e-03   -4.069499203255596e-02   -7.264325288097814e-02   +5.699755528938533e-03   +1.522132838824834e-02   +3.534098258653185e-03   -3.375315128964166e-02   +3.400019171368602e-03   +1.774206572684634e-02   +6.774028278995139e-02; +2.236736041077765e-02   -4.153711519513313e-02   -6.152821583424092e-02   -1.349496706147458e-02   +4.674959434557749e-02   -5.261136124479148e-02   +5.671087127153231e-02   -3.401212405459708e-02   +4.116578963666596e-02   +7.361609989629619e-02   -7.335064437397738e-03   +7.550230566952368e-02; +1.005886817175864e-01   +5.846388869163255e-02   +5.158867699112566e-02   -1.935223120366819e-02   +1.059808522475986e-02   -3.655133008056690e-03   -3.396232748499586e-02   -1.841906373695921e-02   -5.477629834798887e-03   -2.517266278891531e-02   +1.436056877759908e-02   -7.203950443149068e-02; -2.840920639131369e-02   -4.522229268371614e-02   -1.629505641378905e-02   -3.191750975787752e-02   +3.907159054806687e-02   +2.605450150638967e-02   +4.547650895854244e-02   +1.670208128714844e-02   +3.780756346247954e-02   +8.514931539405374e-03   -2.094021188081512e-02   -2.541464805964068e-02];
L6_L4_iAMPA_netcon = [-9.261029516543695e-02   -2.644610428123108e-02   -2.225763512326541e-02   -4.485247900946560e-02   +5.055467907453786e-02   -2.239758389067334e-02; -2.255735693290353e-02   -3.199166101633233e-02   +4.016522648915977e-02   -2.203817762723715e-02   -6.523463217313946e-02   -2.052443904295297e-02; -6.263484905267767e-03   -6.204872131556891e-02   +3.313935652234092e-02   -2.961815825519348e-02   -1.773250815686959e-02   +3.980323420635121e-02; +1.011124094206292e-02   -9.251972728902796e-02   -2.287718644760979e-02   -5.918978983064302e-02   +2.360270307830302e-02   +5.559255662408191e-02; +3.543106134715603e-02   +2.542922092972789e-02   +2.007403349568108e-03   +2.005938017273594e-02   -4.284166385646569e-04   +4.965030301197517e-03; +3.683476704226034e-02   +1.760681599303385e-02   -2.156666173058631e-03   +4.912058558945567e-02   +5.178565365091251e-02   -2.045056860159736e-02; +3.248812437146028e-02   -8.514402802072368e-02   +2.738715786027738e-02   +2.990257853379610e-02   -7.145335245672424e-02   +5.351476862911227e-02; -8.837796954548709e-03   +2.859624052789408e-02   +8.061531451975484e-02   +9.880369925280750e-03   -5.801379510516302e-02   -2.327870636144196e-02; +7.889579526172190e-03   -1.375083579153885e-03   +3.452621682372610e-02   +2.995171405695965e-02   +3.525202854699094e-02   +6.233702931128077e-02; +3.548540744682198e-02   -1.882164779761462e-02   +3.103920559232710e-02   -3.447743471488367e-02   +1.861862412047574e-02   +4.211586858228393e-02; -6.573254146925464e-02   -1.860010401695049e-02   +5.170291029039827e-02   -4.895242568807412e-02   +5.234741497843396e-02   +1.273102244991707e-02; -3.807041651108688e-02   -3.409204003459831e-02   +3.438353841602561e-02   +6.466508827033845e-03   +9.886038909301864e-02   -1.967633202799509e-02];
L5_L4_iAMPA_netcon = [+3.063182707099215e-02   -9.923887102273321e-04   +1.162283431743307e-02   +1.475425322198104e-02   +4.829293210514827e-02   -4.096894676130943e-02; +1.715831416083394e-02   -8.358625305879472e-02   +5.617443601061221e-02   -7.190990321913497e-03   +8.372636595329719e-02   -3.409475295732447e-02; +8.211710034529099e-03   +9.576928544589500e-02   -5.497756042752547e-02   +4.000170531040526e-02   -1.453469961379077e-02   +1.533885698626121e-02; -1.313873226914116e-02   -1.540364280482710e-02   -4.398093005873904e-02   -3.671694908706134e-03   -4.537583303949237e-02   -2.008089576562543e-02; -3.536806137359656e-02   -2.845955745524545e-02   -4.089423126727179e-03   -2.126091011699529e-02   +4.451299506956437e-03   -2.008907990242917e-02; -3.583192880492926e-02   +4.310939408748560e-02   -4.764246505034055e-02   +1.006638273458875e-02   +3.910017422752582e-02   -2.555698186498315e-02; -3.323453366748924e-02   -8.023670330057890e-02   -2.554502014803146e-02   -2.983467366947181e-02   -1.025617211792407e-02   -4.809022018837938e-02; -3.582350178653476e-02   +3.889964702033006e-02   +1.728245814902879e-02   +3.768745055611340e-02   -1.727541558694193e-02   +4.952684215303740e-02; -2.581422647751032e-02   +2.410421372386847e-02   -2.618054089840416e-02   -3.129046095483070e-02   -6.405066123571890e-02   -4.175387992470967e-02; +4.622003643746808e-02   -2.031999600488625e-02   +2.485082624500715e-02   -1.135893567168131e-02   -6.519919266385299e-02   -1.108976913246521e-02; +2.417505938380479e-02   -7.855313689203830e-03   -4.537374701290345e-02   -1.804787757615584e-02   +1.898665115618522e-02   -1.327939415889820e-03; -2.292372826139268e-02   +5.890403613200468e-03   -2.256031601780224e-02   +1.354403619505500e-02   +3.072983597690740e-02   +1.297233286551504e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
