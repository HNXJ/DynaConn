function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.153293274956772e-01   +9.628343339033606e-02   +1.539542067564620e-01   -3.620841094743995e-01   -4.409518052350370e-02   -1.978318211307953e-01   +3.576110811097469e-01   -8.086967466132702e-02   -1.414005689431929e-02; +1.646922041940993e-01   +1.832304562535383e-01   +3.626351559510099e-01   +6.987314615048423e-04   +3.343260805903384e-01   -6.355328605500643e-02   +1.582777785999419e-01   +1.827363700286975e-01   -1.927073278578370e-01; -3.249469253203909e-01   +3.293470427938049e-01   -1.544765994811214e-01   +3.196283394865934e-01   -3.736280606234176e-02   -6.397760512072427e-03   +3.182882329701625e-01   -1.794555101613343e-02   +4.078420814977541e-01; -2.411346831195339e-01   +1.174527502334756e-01   +1.019564563667635e-01   +3.018979973647754e-01   +5.024117858268957e-01   +1.908178858101504e-01   +1.431085810427948e-01   -3.009838255253960e-01   +3.172271106638220e-01; +2.370178114240625e-01   -6.908590780545530e-03   +3.504463269466232e-01   +9.739076843988220e-02   +4.049817341363660e-02   -7.923544852537392e-02   +3.910134011780942e-01   -9.615958707196923e-02   -4.675836136849549e-01; +2.297402120324805e-01   +1.116880252555671e-03   -1.749882882495954e-02   +5.935225157676718e-02   -5.686172965969158e-01   +6.233387995155734e-02   +3.828705412925275e-01   +1.670059253601786e-02   +1.614974056526205e-01; +1.296791377435599e-01   +3.126748876711191e-01   +3.232712047063664e-02   +4.752002468415758e-01   -1.186656068318585e-01   +9.330401996230843e-03   +1.692459782814627e-01   -2.599343211317586e-01   -2.093220591044825e-02; -3.511202428682318e-01   +1.488935689202828e-01   +2.891763048951814e-01   +9.038704175323270e-02   +1.284334200900357e-02   -5.105790168542948e-02   +1.345545518509325e-01   -4.061152820338534e-02   +2.859516386207444e-01; +1.266078236137486e-01   -1.018303449223593e-01   -8.109007554978261e-02   +9.112825632534693e-02   +1.331424941588527e-01   +3.093254972851606e-02   +3.366552890844146e-01   -1.513477215625992e-01   +5.579753563658814e-01];
L1_L2_iAMPA_netcon = [-8.223966216240072e-02   -2.253121956324122e-01   +8.283661193314719e-02   +4.785457108138721e-02   +6.825944954456611e-02   -4.754966700769928e-01   +8.138718980698781e-02   +1.324987967940366e-01   +3.719247646433010e-01; +5.494455708553996e-02   +3.464366230387961e-01   +2.164092025079933e-01   +1.869791847233243e-01   +1.373991206612678e-01   -2.867250085371660e-01   -1.302731308713843e-01   -1.050894144749502e-01   -2.201621880297095e-01; -1.425624168785666e-02   -4.823213115328415e-01   -7.838991408179381e-02   -2.252527870740001e-01   +1.002775007757720e-01   +1.983784583031284e-01   -4.177901653433458e-01   -1.458823281192015e-01   +2.411191043388665e-02; +6.312581372579129e-02   -4.320944805827187e-02   -6.867248193583969e-02   +9.187633612859088e-02   -5.441173996525819e-02   -2.758802098145353e-02   -1.959147529162787e-01   +2.743115942407199e-01   -4.565550896666151e-02; +5.710215707961085e-02   -2.905493528827306e-01   -5.569607522462550e-03   +2.821118759313131e-01   +7.873413274595223e-02   +2.049306652715674e-02   -1.712258276923133e-01   +3.025879283021907e-02   +1.458657753525056e-01; +2.345583948197660e-01   -4.307766643217645e-02   -1.294282291491047e-02   -3.708344627200504e-02   -1.859167408763297e-02   +3.685156805563783e-02   +6.845397513159254e-02   +3.448549660093023e-01   +1.528799933279014e-01; -2.410810463333321e-02   -2.768655685314790e-02   -2.237706328757122e-02   -2.357361566223007e-02   -5.778433605097663e-02   +6.601955842889343e-02   -7.914306803919802e-02   +9.862330637437704e-02   +1.428018502113106e-02; +2.731381598069695e-01   +2.310177869748850e-01   +1.697522710494783e-01   +2.330795995597972e-02   +4.595042194757871e-01   +2.543135827534914e-01   +2.088625674314613e-01   +9.121487235982148e-02   +2.062520773644848e-01; +1.863472719759771e-01   +3.195145640884357e-01   +2.788800774832594e-01   -2.711549094216989e-01   -5.526431722344491e-02   +7.969948462724745e-02   +2.045925964122187e-01   +2.989237928927262e-01   +1.055096902594169e-01];
L2_L5_iAMPA_netcon = [+2.289321072683193e-02   -4.056675468505918e-01   -3.497689941721712e-01   +2.100493922799176e-01   +1.446923741366971e-01   +8.727626999254251e-02   +2.409932283106533e-01   +1.404926306482731e-01   -7.195401922727206e-02; +1.797020084290334e-01   -3.931446577195366e-02   -1.980926893333941e-01   +1.956192858546833e-01   +7.989844265072231e-02   +1.414446918296061e-01   +1.091570448670175e-01   +9.698802177000038e-02   +1.780065161656866e-01; +6.099400470350906e-01   +1.152691734381410e-01   +1.843411213583735e-01   -2.035584647781980e-01   +4.597315495361884e-01   +2.026874768984877e-02   +1.739815338323400e-02   +5.387449413034428e-02   -4.020126038963496e-01; +2.521475414676907e-01   +4.113866184322738e-01   +5.674585996224970e-01   -1.973658767162789e-01   +3.347765834716508e-01   -8.772542482078022e-02   -5.472762700536855e-01   -1.646867190248931e-01   +3.052259243386668e-01; +2.417795749464872e-01   +2.475531438420336e-01   -3.086512170044797e-02   -6.923033007787141e-03   +1.004227494113002e-01   +3.268316989876401e-01   +4.030173794474781e-01   -9.230165902156032e-02   +4.003255258802107e-01; -1.473579560960426e-01   +1.557870730378222e-01   +5.689836374171088e-01   +2.649480668975199e-01   +1.867871009422585e-01   +1.866484457737362e-01   +5.908336760413115e-01   +1.900302659517968e-02   -7.376117233296306e-02];
L5_L2_iGABA_netcon = [-3.605569511638337e-02   +2.273243912094886e-02   +1.868724333785706e-01   +3.422674364508754e-02   -1.891796104077324e-01   +6.442032253211440e-01; +3.162096209398811e-01   -2.927107513598494e-01   +2.967194956254813e-01   +2.056590132488587e-01   +3.192316528680931e-01   -8.319705739523996e-02; +4.511097093061767e-02   -2.378062259497992e-01   +1.993807425192209e-01   +3.701317406718091e-01   +2.740106511636389e-01   +2.165162876712787e-01; -2.801204060117211e-01   -2.821792583936996e-03   -1.462465377232482e-01   +3.674358117888684e-01   -2.225122038533092e-02   +1.640263821014823e-01; -2.264855085805050e-01   +8.891962111947482e-02   +1.872140228427961e-01   +8.745625974293486e-03   -9.732740595236544e-02   +2.397434313552962e-01; +2.569316533331398e-01   +1.827386679419409e-01   +2.226797765989630e-02   +5.132714743328142e-01   +2.242643381669667e-01   +4.390310827892051e-02; -3.039644591432382e-01   -4.163703441114219e-03   -8.106729450939351e-02   +1.787062051665092e-01   -8.443838456350077e-02   -2.004882119371548e-01; -5.322220782849815e-02   +1.339951367270617e-01   +3.461723055188183e-01   +3.182140392984039e-01   +2.940246340151909e-01   +4.589958964585873e-01; +3.237225333135944e-01   -2.290053379495811e-01   +3.183424402482697e-01   -1.538888317031006e-01   +2.157199574162461e-01   +5.882921717529178e-02];
L3_L2_iAMPA_netcon = [+4.735478906505633e-01   +2.055103847606435e-01   +2.163427149976452e-01   -1.027830491218108e-01   +1.158612230135612e-01   +8.640499757616926e-02; +3.018853053099234e-01   +5.615334608053595e-01   +1.847328511462021e-01   -1.506223366235298e-01   +1.203534908631504e-01   +3.649211172606317e-01; +3.739796662868260e-01   +2.781646439371369e-02   -8.178069845579933e-02   +2.886810674487609e-01   +3.381716841624269e-01   -1.190023629881326e-03; -5.107505232018805e-02   +4.243561988985407e-01   +3.047604409870605e-02   +1.359707381313792e-01   -2.047051740856037e-01   +1.834899613958262e-01; -3.047172745243439e-01   +1.458599407100135e-01   +2.923804870005151e-01   +1.464460831312527e-01   -3.315684735296376e-01   +1.528216815161983e-01; +2.781201642643467e-02   +1.962423412932018e-01   -9.888952792971611e-02   +1.277611818307785e-01   +3.522957870318010e-01   +2.956234453915014e-01; +1.724235180273089e-01   -3.479130006036646e-01   +1.142737541165834e-01   -2.973693513078157e-01   +2.394907753656281e-01   -2.196907907005398e-01; +4.366384078526486e-02   +3.339197282448568e-01   -4.150841476503289e-01   +1.664685241872912e-01   +1.806226262152074e-01   -1.897432169156250e-01; -5.170088987131594e-02   +2.353076911840002e-01   -2.116348037916184e-01   +1.780211955208595e-01   -2.031533087167237e-02   -7.301288299875172e-02];
L2_L3_iGABA_netcon = [+1.212256979689312e-01   +3.239449932171969e-02   +3.935600658267498e-01   -1.487446285634010e-01   -7.433736700737935e-02   +1.065317886137324e-01   +4.700938425101592e-01   +1.646477923020415e-01   +2.600867442659589e-03; -1.338353066035719e-01   -2.529809533329803e-01   +2.458452378544635e-01   -1.544313382931191e-01   +1.459097600003962e-01   +1.804961436062772e-01   +1.193534079679635e-01   +2.727071874490550e-02   -2.398022783023509e-01; -1.015092450796631e-01   -1.289830676867114e-01   +4.022603442540217e-02   +4.399432094367577e-01   -5.177758305618725e-01   +4.313292952033865e-01   -3.444006791797412e-01   +2.989096902151755e-01   +1.462321120916781e-01; +3.841247853876588e-01   +1.138103158132525e-01   -4.338757749234899e-01   +2.052760972808523e-02   +2.327590768220624e-01   +1.891563177759099e-01   +1.632274135118616e-01   +4.029775763359456e-01   +1.546529954784810e-01; -5.374292235053896e-02   +1.306284328396880e-02   -8.761261638183937e-02   -2.141472896121489e-01   -6.869519003305638e-02   -2.768271643091984e-01   -9.458836017812097e-02   -1.108758270621073e-01   -3.044957368223677e-01; +2.006769730069481e-01   +2.011718507082049e-01   +6.636015850517626e-02   -1.048219344730424e-01   -1.691319487951687e-01   +1.227386221996515e-01   +4.579481739857939e-01   +5.333773285426835e-01   +5.738685753955723e-01];
L1_L4_iGABA_netcon = [+3.569716640883128e-01   -4.604918277315935e-01   +7.789809931630642e-03   +3.492690829217911e-01   -2.762825166078003e-02   -7.797795561383331e-02   +1.769184993115316e-01   -5.001468731182722e-02   -4.025743050825565e-01; -5.644815098564192e-02   +7.237728220764186e-02   +3.418928618478727e-01   +3.507015623313477e-02   +1.196984186803111e-01   +2.997520761236573e-01   +3.376340339676752e-01   -4.735639113642416e-02   -2.720991308848981e-01; -1.935139505516223e-01   +4.800836962182894e-01   -3.053528069680250e-01   -1.324633211291609e-01   +2.234153193100232e-01   +1.016239476480641e-02   +4.768206751695384e-03   -1.348754921101719e-01   -1.128123131104937e-01; +9.753570002369819e-02   +4.355113304152011e-02   -2.851038376286441e-01   +1.545232641832223e-01   +5.042912309599111e-02   -2.476001225600111e-02   -2.334097316033753e-01   -2.266139885297010e-01   +2.114411064391471e-03; -2.521618237925329e-01   +5.199019201102782e-02   +1.111263551528018e-02   -4.246697308488789e-02   -4.383112003423036e-02   -1.469020199480360e-01   +1.465481514570277e-01   +1.199662213178886e-01   +1.673347016958061e-01; +2.991623756931866e-01   +1.435864663013213e-01   +5.712991394780380e-02   -3.018128856844184e-02   +1.787883560247162e-01   +2.967070263997656e-01   -5.063748056872006e-02   +2.987737689655976e-01   +1.576492612533779e-01; -1.548405046354315e-01   -3.038449694654295e-02   -2.548533259287840e-01   +3.157725400880005e-01   +8.936159437670252e-02   -5.855321549649531e-02   +2.272458363532447e-01   +2.445665401546791e-01   -4.042811170554717e-02; +2.176354188216677e-01   -2.644069748543791e-01   +2.000209774759125e-01   +1.920769686243339e-01   +3.210071579158146e-01   +2.056661659649338e-01   +1.717052354665378e-01   +1.676333784089973e-01   +3.091537642810914e-01; -1.338168810148583e-01   +1.600022877664246e-01   +1.023213122865685e-01   -1.252364814216126e-01   -1.471871318388837e-01   +1.271570126910862e-01   +1.879598849716466e-01   +4.904603354261175e-02   +2.299127325383144e-01; -5.758230256482016e-02   +3.716006046446869e-01   +2.605439884611103e-01   +1.649562404132576e-01   +1.589055312329831e-01   +2.599605588003804e-01   +1.266736283123112e-01   -1.005190695607403e-01   -6.820973363370288e-02; -8.639378837525785e-02   +1.808167072162560e-01   -6.118664198157071e-02   +9.809428133030074e-02   -2.184886174486288e-02   -1.495462847314918e-02   -3.598813151646830e-01   -4.769147131606971e-02   +3.530922481634916e-01; +2.548017077451113e-01   -2.352280346632196e-01   +3.000014581039164e-01   -2.599534940499165e-03   +2.224967288995988e-01   -1.736935813875405e-01   +1.977917617515827e-01   -1.463776957762004e-01   +5.460597026139333e-02];
L4_L1_iAMPA_netcon = [+3.142170103527921e-01   +3.025308496821755e-01   +4.983667236350994e-02   -5.473872399501058e-02   +1.632001915385411e-01   +4.207126962840636e-02   +1.514607895876878e-01   +1.250827052081537e-01   +9.001068939299536e-02   +2.055611799166941e-01   -5.658159730304357e-01   -5.339470390938011e-02; -1.322476755882798e-01   +1.976987699463494e-02   -2.829973131506195e-01   +1.974068259051448e-01   +6.511798473900411e-01   +2.280312888143693e-02   -2.247990834770532e-01   -3.438088117179938e-01   +1.582987427288422e-02   +4.066804515776308e-01   -7.488186808493777e-02   -6.183179259048249e-02; -2.963627220346539e-01   +2.868739015653745e-02   +2.412375541163778e-01   -9.300070820219634e-02   +3.022489155579662e-02   +3.448547848384037e-01   +3.056224072883904e-01   -3.524592153213471e-02   +1.249088237796298e-01   +5.090602650472558e-01   -1.233541725735671e-02   +3.965684914464439e-01; +6.845360123896567e-02   +1.144740782362181e-01   +3.591685241441752e-01   +1.752379346903203e-01   +1.192801822150592e-01   -1.477624043633246e-01   -7.989147091529097e-02   +1.739526255162466e-01   +2.121310345355618e-01   -2.281100432839832e-01   +3.051399496188014e-01   +7.105545084627313e-02; +2.711712277754679e-01   +4.310878820054853e-02   -2.897957457144421e-01   +2.675680039528694e-01   +4.467634379108684e-01   +9.218989806296853e-02   -8.257983522704467e-02   +7.021618929591464e-02   +1.877953653058260e-01   -2.853325289915249e-01   -2.638086921561586e-02   -2.038593178916722e-01; -5.242427196090360e-03   +1.718389192568448e-01   -4.694494377836366e-02   -1.154636601335894e-01   +2.975634067926208e-02   -4.120546721497105e-02   +1.528812257657839e-01   -3.537431036024259e-01   +3.184832342200598e-02   +5.193512936764316e-01   -1.261524925303820e-01   -2.318494730731034e-01; -7.448125421786726e-02   +2.166753578622311e-01   +2.784807171595486e-01   +1.014694582700372e-01   +2.705002775990892e-02   +6.765417566014317e-02   +2.013452453777647e-01   +1.169771283649116e-01   +2.405835616221321e-01   +3.472071747370028e-01   -1.875728340451460e-01   -2.793349240740892e-01; +2.269074293344289e-01   +5.582387027733171e-02   -2.832585668998536e-01   -2.124122709533977e-01   -1.236401521551837e-01   -4.143387925563107e-03   +3.431988269851356e-01   -1.083866937100914e-02   -2.289318715225489e-01   +1.609276269374183e-01   +4.503668258802589e-01   +7.580459307882798e-02; +1.015727384788509e-01   -3.570510565233043e-01   +1.658068827007293e-01   +1.638611388232748e-01   +6.867011188100217e-02   -1.004310321437313e-01   +4.748780889343239e-01   +1.139813265757984e-01   -3.288158865213000e-01   +1.463969811802515e-01   +4.550515408267900e-01   -2.080038864290218e-02];
L1_L3_iAMPA_netcon = [-3.733202581021063e-02   -9.742427457229200e-02   +5.124746884177171e-02   -2.066034865103721e-02   +8.323354353792804e-02   -2.246782394091519e-01   -2.631290918914694e-01   +3.110277409824481e-01   -9.980673552208950e-02; +3.436174048945022e-01   +2.890514896896305e-01   +7.068171021864769e-02   +1.652849546549445e-01   -2.657084023440930e-01   -2.689487526581490e-01   +2.500106855343816e-01   +1.004821869548349e-01   +7.354208346789343e-02; +1.917205751512552e-01   +2.539812626521541e-01   -2.723430084718477e-02   -1.767279057167087e-01   +4.533734422522723e-03   +3.694329434939084e-01   +2.459883450387414e-01   +5.977350396988738e-02   +3.275158810978673e-01; +7.080730990219387e-02   -2.465763828828939e-03   -7.635533855688402e-02   -7.558472403676440e-02   +6.872907463500275e-02   +2.570484466541696e-01   -9.390151993089924e-02   -7.874270781105003e-03   +3.688616112854495e-01; +3.409326163199139e-03   +2.346992030055071e-01   -1.625369627015527e-01   +1.357195305503332e-01   +3.042965638479449e-02   +2.036469059288157e-01   -2.610353949020573e-01   -2.519782960818039e-01   +1.797663212985913e-01; +6.482252891685593e-02   +1.187332341074925e-01   +3.643530354699614e-01   +1.618283062104022e-01   +2.361281626636933e-01   +3.063410437348357e-01   +3.671276761167668e-01   +4.309362086109486e-01   +2.169469925357522e-01];
L3_L1_iGABA_netcon = [+1.376069672781130e-02   +1.064786869211054e-01   +1.752255325319949e-01   +3.097565202166601e-01   -1.503857868739828e-01   +1.921084245271149e-01; -2.485675524862534e-02   +2.792320240978874e-01   +3.776483662531621e-01   +3.588467994602857e-01   -3.594462906578588e-02   -1.167896777928547e-01; +5.135216546073068e-01   +7.524101947817384e-02   -2.939523882356155e-01   +5.015815602065724e-01   -3.603910780201721e-01   +6.362204809521599e-04; +1.346005601630732e-01   +7.246407822602144e-02   -3.424742130672379e-01   -4.363292575918176e-02   -1.879774645140243e-01   +6.129084401364004e-02; +3.494889755754422e-01   -1.073596627557689e-01   -1.778515986319496e-01   +1.823474840920898e-01   -1.415646574060649e-01   +3.489464562925370e-01; +6.847404461691929e-02   +1.581255781921684e-01   +2.534143690463296e-01   +2.079055460732690e-02   -2.393044509680420e-01   +1.626055804338160e-01; +2.218929375261292e-01   +1.371980634396724e-01   -6.063498749145362e-02   -4.752384190248254e-02   +3.320806199939560e-01   -3.989583524256420e-01; +1.445510878890725e-01   +2.784226869157965e-01   +5.796035738576411e-01   +6.257736631800263e-02   +1.623916934539611e-02   +1.710121784187429e-01; +9.792259672769060e-03   -7.130222994135473e-02   +2.543428055182536e-01   -1.811032868618089e-01   -1.042048033098329e-01   +1.246485968547818e-01];
L5_Input1_iAMPA_netcon = [-6.243737481811902e-02   -8.457351221050621e-02   +2.316215574875539e-01   -4.425654528304040e-02   -1.167375449039957e-01   +1.480213979764541e-02];
L6_Input2_iAMPA_netcon = [-1.643075848537592e-01   -2.155159294359532e-01   +6.995761212335541e-02   +8.460822287521434e-02   +2.900730552826850e-01   +1.782885005296140e-01];
L5_L6_iAMPA_netcon = [+3.579895965980920e-01   +3.014535301112924e-01   +2.349999897437324e-01   -8.311031674389445e-02   +1.819402999213008e-01   +1.224385928020472e-01; +8.272506458624679e-02   +3.409882422956615e-01   +2.753628649879887e-01   +3.956081164291054e-01   +1.243412347405398e-01   +1.224479964814293e-01; +1.292780168557693e-01   +4.574013425482165e-02   -1.943513248778934e-01   -3.502738386482915e-02   +1.397688148713789e-01   +1.156293560668661e-01; +1.348151810890723e-01   +2.424525293859936e-02   +1.110933849068726e-02   -1.459278564864270e-01   -3.817363428932984e-02   -1.755041439108784e-01; +1.885112211024449e-01   -2.193849271709687e-01   +1.242579884632362e-01   -2.321512139242126e-01   -9.167830439617219e-02   +9.555090981505805e-02; -4.544436052087957e-02   -1.875631607514113e-01   +1.581832706869773e-01   +5.077003841993569e-01   -3.867586155585173e-01   +3.477027426386294e-01];
L4_L5_iGABA_netcon = [+1.988007004063466e-01   -9.487221962579558e-02   +1.725191181712635e-01   +1.442513256759303e-01   +3.736979593005149e-01   -8.344260251009965e-02   +4.774339584216361e-02   +3.683237772942028e-01   +1.024299993604149e-01   +1.186652024135124e-01   -2.120620048591815e-04   -1.160224347328371e-01; -8.198460606142668e-03   -1.105593434993187e-01   +4.044264478249681e-01   +4.356705271465717e-01   +2.175381784820241e-01   +3.695081587043275e-01   -2.674821760528063e-01   -2.018519388335702e-01   +4.031743047678364e-01   -2.973262087920073e-01   -3.862893464691025e-01   -2.608357756049021e-01; +2.279762877246844e-02   -3.772267229319097e-02   -8.101003351260119e-02   +1.422530437084929e-01   +2.628244789486804e-01   +1.647985345859458e-01   +3.214937993387228e-01   +3.257376028163931e-01   -2.977902611199296e-01   -1.964842131262642e-01   -1.317072005578553e-01   -8.217333788554655e-02; +3.869449067263385e-01   +2.141127897314521e-03   +4.729049417452750e-01   +3.086792796466307e-01   -1.682349537115632e-01   +5.125762099830874e-01   -1.397138304802964e-01   +1.879133801823260e-01   +1.520944688699412e-01   -1.510018411615020e-01   +8.933059161997615e-02   +1.061657266885532e-01; -5.740384624258974e-02   +2.507376653597633e-01   -2.702356955190087e-01   -5.253777085603527e-02   +1.987963638174869e-01   -1.584204294215934e-01   -1.368443850105203e-01   +2.954673607720535e-02   -2.019449206360559e-01   +2.794145440174372e-01   +3.646070953749271e-01   +2.518303735180820e-01; -9.445517474353310e-02   +5.041942161025018e-01   +1.734303233368589e-01   +6.838020660604668e-04   -1.424594961355490e-01   +3.314198511950099e-02   -2.187656359632503e-01   +1.578638502771852e-01   -3.936962251897860e-02   -7.704681351240873e-02   +1.333799422401434e-01   +9.843982640389598e-02];
L6_L4_iAMPA_netcon = [+4.058135067826101e-01   +2.895924621930870e-01   -6.903847774992657e-02   -3.579048225411435e-01   -1.432435893327855e-01   -1.304728370685388e-02; -2.612897850596149e-01   -1.644241865848464e-01   +3.238822803074423e-01   +6.297669465807717e-01   +2.991533742575239e-02   -1.167919941924498e-01; +1.854501075580853e-01   -3.335924631268875e-02   +1.004303530551495e-01   +3.120049216916772e-01   +1.290153474939179e-01   -2.517631921499739e-01; +1.788526693922185e-01   -1.638675916082322e-02   +2.600944821114263e-01   +2.348349389937709e-01   -3.437966912002949e-01   -1.431583144550061e-01; +4.576514493167316e-03   +3.387170907683934e-01   -2.186826904086501e-01   +3.452380386618686e-01   +5.343506849389652e-01   +5.499389353499502e-02; -7.821489463387524e-02   -2.682369980259097e-01   -6.182592157087449e-02   -1.076150712396160e-01   -5.924237984764762e-02   -1.597651100787496e-01; -2.440105172100866e-01   -1.068196060690364e-01   +6.023231269553803e-02   -4.565223992828183e-01   +5.617089265123558e-01   +1.471784380835049e-01; +1.877661749041886e-01   +2.656185950538022e-01   +8.702908549536632e-02   +5.963420527554649e-02   -3.640594796058767e-02   -2.958045405055272e-02; -1.567953187622669e-01   +2.628308631535708e-03   +1.676454973406004e-01   +1.777224534133190e-01   +5.136720914090939e-01   -1.855552776873656e-01; +1.161016010784004e-02   +1.529619434400060e-01   -4.024402286520312e-01   +1.494385734513677e-01   +1.263464625074870e-01   -2.377115512610392e-01; -2.573407802939534e-01   -2.621012049765194e-02   +3.841754846092715e-02   +6.210872280251883e-02   +3.763008174026111e-01   +4.474610633068244e-01; +2.083086867390119e-01   -1.346670571680100e-01   +9.729289706613567e-02   -2.185556871847530e-01   +2.260721747259085e-01   -1.803157214597145e-01];
L5_L4_iAMPA_netcon = [+6.519247446226950e-03   -2.003195480080283e-01   -2.068378766592509e-02   -7.594107584601045e-02   -2.305069506358707e-01   -1.291043332268597e-01; -2.372971986002361e-01   +1.052584022616493e-01   +1.480081580097472e-01   +2.665940779444837e-02   -1.633050624819622e-01   +8.832319507433839e-02; -1.298149227562205e-02   +9.234360694024964e-02   -2.499632877262883e-02   +1.364229719982622e-02   +7.400461871059041e-03   -2.301361446540818e-01; +2.591387234179654e-01   -2.733851381614380e-01   -8.372252794841770e-02   +2.607500972714051e-02   -2.408128653945847e-02   +3.985085237421825e-02; -2.764892372236090e-01   -5.466729218422127e-02   +4.129082719332626e-01   +1.160395052117045e-01   +2.830268747264917e-01   -1.796160192487849e-02; -3.513341176288260e-01   +3.366524407507383e-02   +2.624746786920328e-01   +3.273740991152452e-02   +1.909486369343251e-01   -1.959657841647398e-01; -6.826463381983000e-02   +2.261574619358246e-01   -9.599707213612695e-02   -1.090898986378481e-01   +1.182636828369447e-01   -1.515247093936163e-01; -1.463653117926431e-01   -1.196311443835498e-01   +3.443250599432167e-01   +3.183235613738039e-03   -1.314694470706053e-01   +9.600172119085079e-02; -6.178548717595576e-02   -1.126653818406993e-01   +6.399194865535046e-02   +5.767405071376922e-02   +3.607055891526328e-02   -2.871897093375524e-01; -2.718633549762832e-01   -1.344870225843136e-02   +4.729105401672899e-02   +4.130964376290720e-02   -2.293692498119980e-01   +3.367957470112487e-01; -1.077789201259343e-01   +3.375347557618203e-01   +2.028215788858642e-01   +3.561329426492261e-01   -2.031759094477114e-01   +3.697898045894313e-01; +4.805520925961468e-01   +2.624784292659225e-01   +4.807189391713024e-01   -4.301380162505232e-02   +1.451155345258540e-01   +1.629030719852593e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
