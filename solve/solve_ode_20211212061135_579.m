function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.974082314622833e-01   -9.771148578606224e-01   -8.811206465582080e-01   +7.959313999598774e-01   +8.199631207871024e-01   -7.544597233421118e-01   -1.950112073037983e-01   -9.527716227721971e-01   +2.134825044715550e-02; +6.386546886633765e-03   +5.874540892743654e-01   +2.054912782256030e-01   +3.114294823529743e-01   -8.828681673517219e-01   +3.863209307913549e-01   -3.876595775715236e-01   +7.619138810088749e-02   +4.758620392159053e-01; -5.640000697975022e-01   +5.893294924237779e-01   -3.121401441033599e-01   -5.097488470034668e-01   -9.756048533742927e-02   +9.931843907993031e-01   -7.093931073069927e-01   +7.191465506571798e-01   +7.725196372590284e-02; -8.503007593891730e-02   +6.099977951613423e-01   -9.361864486012870e-01   +8.486795531614967e-01   +1.284866967084048e-01   -3.793241044835756e-01   +1.660771697974753e-01   -5.198465216193147e-02   +8.003285539623312e-01; +3.278874104192101e-01   +6.967559078661539e-01   +5.355647857678460e-02   +5.141985459548811e-01   -2.343211988183912e-02   +5.198953788237488e-01   +6.338898071563590e-01   -7.346467654047953e-01   -7.104885378667957e-01; +4.788550644936065e-01   -1.925174836507109e-01   +7.516031770597993e-01   +4.044358318497511e-01   -4.348099994950613e-01   +3.571369186685801e-01   +2.496028762765390e-01   -4.303405110035061e-01   +3.747333883810013e-01; -1.984092580632672e-01   +1.000000000000000e+00   +4.509197266779086e-01   -9.374189365628702e-01   -2.161757905285895e-01   +4.308708595408751e-01   +6.705804377321918e-02   -6.047136744179329e-01   +8.864527338255361e-01; -1.815925778302246e-01   -4.847036422969517e-01   -3.398507960329281e-01   -2.245959506532811e-01   -7.947290260737344e-01   -5.473109735353714e-01   +4.463355842294429e-01   -4.229943508544856e-01   +4.295547839706972e-01; +5.792025645082545e-01   +8.383204882643224e-01   +9.633547807652852e-01   +9.922073294211130e-01   -1.397702688994047e-01   -8.805593354067678e-01   +6.973722081080728e-01   +6.659154926748727e-01   -7.285475309798344e-01];
L1_L2_iAMPA_netcon = [-6.814250413333495e-01   -4.618773194211662e-01   +4.774610249751809e-01   -1.696289169985757e-01   -4.716532705253981e-01   +5.331227125508923e-01   +2.143036183008362e-01   -8.039067165350862e-01   -5.296173392980402e-01; +5.532316797761724e-01   +6.370776342542396e-01   +4.849135998780852e-01   +2.874454071589421e-01   +1.310802810909035e-01   +2.936775688743788e-01   -9.639112553869594e-01   +1.666181852468006e-01   +6.555021173522309e-01; +2.756939341075877e-01   +6.773813732625354e-01   +4.165393407499168e-01   +2.208355719034756e-01   -9.461997763306598e-01   -1.654884213498411e-01   +8.833604650207854e-01   +1.134963337243309e-01   -1.000000000000000e+00; +9.262662483676344e-01   -8.413927629146327e-01   -1.417463099454691e-01   -4.829541745404541e-01   +9.088832800265418e-01   -6.008249179614034e-01   -3.415463329678017e-01   +4.341992608648291e-01   +3.362530108382743e-01; -9.244109064104562e-01   -4.661822236390797e-01   +2.809056228504974e-01   +6.857920955347957e-02   +6.457850627236015e-01   -7.978190548042952e-01   +6.151846290640801e-01   -5.889282204241801e-02   -7.530147820523965e-03; -4.975320301124900e-01   +2.343205695282948e-01   +6.527509435126576e-01   +3.756706477333724e-01   -1.975794002259123e-01   -1.579077768774069e-01   -7.659602701081890e-01   -4.122959005030692e-01   +5.875434774713213e-01; +8.853810593166359e-01   -4.573497359382431e-01   +6.661350053216960e-01   -7.805498191084221e-01   +2.122130604097969e-01   -1.297415319655325e-01   +6.575768732009222e-01   +9.945678858769712e-01   +3.254131592510648e-01; -9.128009758499247e-01   -3.801776667269310e-02   -4.729505114456818e-01   -5.768951622473585e-01   +8.004221304739724e-01   +3.825553840084029e-02   -6.351072637240796e-01   -7.390979860206039e-01   -6.579648667965360e-01; +8.648755352027896e-01   +3.854170845429376e-01   -8.520074644306046e-01   +1.406176657905584e-02   -2.244874302132954e-01   -5.655910550487636e-02   +2.449250920700328e-01   +7.067779187973287e-01   +2.032901276369250e-01];
L2_L5_iAMPA_netcon = [-7.455860529168606e-01   +6.946506601382340e-01   +6.858148344008062e-01   -7.340218902967944e-01   -5.695398777007221e-01   +5.399175538021694e-01   +6.064144362554006e-01   +3.834630024806053e-01   -4.271705627633881e-02; -8.810179550727218e-01   -5.056793969920140e-01   +8.251169509155972e-01   +5.823167661070318e-01   -3.251723254512322e-03   +1.080961901175458e-01   -6.363240318905654e-02   -6.982683926173177e-01   +2.200294555167323e-01; +1.000000000000000e+00   +2.257627091334989e-01   -4.279319835588733e-01   +5.902700420135168e-01   -9.741743936007726e-01   +5.713241191239289e-01   -7.590965077218059e-01   -3.637023645844285e-02   +3.856074026995491e-01; +9.303224728770736e-01   -1.811196609356265e-01   +8.319768703174039e-01   -3.913813616888203e-01   +5.321981002602447e-01   +7.102587740833196e-01   +5.658965727651309e-01   +9.383480859877649e-01   +4.712852463976137e-01; +2.019172008211440e-01   +8.429518212345247e-01   +9.528438194049308e-01   +5.636473394883623e-01   +7.056147831845404e-01   -8.899012036360058e-01   -2.326652605583440e-01   +7.750858338076856e-01   +3.692419890674912e-01; +2.459425363790760e-01   +3.323366624698600e-01   -2.287146092298364e-01   -6.134058173797096e-01   +4.612927840179450e-01   -7.356510899694275e-01   -5.649157357398373e-01   -1.287621078081990e-01   +6.515695311569053e-01];
L5_L2_iGABA_netcon = [+6.109295201634447e-01   +8.522119998597000e-01   -3.666200806077169e-01   -6.327935318998811e-01   -4.220843862145415e-01   -6.416577619376301e-01; -2.774334711702434e-01   -3.826923299244183e-01   -2.783732164816833e-01   +7.126011716037116e-01   +6.772582134109379e-01   +2.421681708940847e-01; +8.618367922953138e-01   -4.340376336456070e-01   -1.642624774505283e-01   +7.466684330431732e-01   -4.715527962680364e-01   +1.354379296828541e-01; +1.600306264049972e-01   -1.695194187914899e-01   -7.383327031806873e-01   +7.027367647438691e-01   +4.792497389384707e-01   -5.286062514594646e-01; -5.206617349993461e-01   -3.635127482389748e-01   -6.211340040580920e-01   +8.786183315630716e-01   +5.161489597019883e-02   -7.864190369863596e-01; +7.640252705874194e-01   +6.965213565427347e-02   -1.005513670439823e-01   -8.815987976794786e-01   +5.572529379748734e-01   -3.309202617843026e-01; -4.293330265369977e-01   -1.528237297318333e-01   +8.376775446140532e-01   +5.582557786147460e-01   -8.861253716236713e-01   +6.014939838853022e-01; +2.226187152080934e-01   +4.355179809292090e-01   -7.278968684595049e-01   -4.084989931609029e-01   +1.000000000000000e+00   +8.513624363214652e-01; +5.218240712392137e-01   -2.107657603931609e-01   +6.176531787991543e-01   -5.278572143179398e-02   +1.783055517849983e-01   -8.252563390556940e-01];
L3_L2_iAMPA_netcon = [-5.530397690639461e-01   +1.896972009809763e-02   -2.091047062660511e-01   +2.454605698125834e-01   +8.589759028056952e-01   +6.306737774463239e-01; +4.893759006783873e-01   +4.759320841372850e-01   +6.853186930851788e-01   -8.503578968673442e-01   +8.270284032154603e-01   -6.671788282831683e-01; -1.000000000000000e+00   +3.491166635770797e-01   +6.678570259202760e-02   +7.405639856942833e-01   -3.229238510420218e-01   +5.026113834503896e-01; +2.855817153602364e-01   +5.678102935076003e-01   -6.083049565302996e-02   +2.988240740911502e-02   +3.732667224013734e-01   +6.758234276946208e-01; -6.733576287705959e-01   -1.871220229806068e-01   +1.663112498870971e-01   -1.404292098649300e-01   -2.301525164895426e-01   -4.535833107342841e-01; -6.439116283935098e-01   -2.414084460422235e-01   +6.637129005235680e-01   +5.281765875052286e-01   +4.970760573634189e-01   -7.101482631230234e-01; +2.505392159598664e-01   +7.118778496344595e-02   -5.795747592691091e-01   +2.065953554024025e-01   -2.318405933578553e-03   -3.288375773988469e-01; +1.323100629685391e-01   +5.634659834954751e-01   +3.304343114393657e-01   +6.774336427389757e-01   -4.473320535143777e-01   -2.913505466800174e-01; -2.980282112441248e-01   -6.960516922434176e-01   -1.145225501396079e-02   +7.519193859228073e-01   +4.371147630233076e-02   -3.603984999688076e-01];
L2_L3_iGABA_netcon = [-7.667982897939609e-01   -3.456798162587286e-01   +8.487401735783833e-01   -2.267517952187511e-01   +9.587655375022118e-01   +8.551114161606974e-01   +3.239231731831013e-01   -2.047882184938115e-01   -4.311327019420598e-01; -5.892646703041955e-01   -3.915582949930781e-01   -7.177116952168124e-01   -2.214435964005050e-02   +2.304099971720215e-01   +9.153999773723788e-01   -6.669047668578946e-01   +6.272704985695109e-02   +8.995582340752643e-01; +5.990618667414882e-01   +1.000000000000000e+00   +1.258818590574798e-01   +9.923451936316887e-01   +6.144088441191298e-01   -3.694208236479561e-01   -3.681119368059395e-01   +6.926109611288379e-01   -7.101572053806084e-02; -8.459128566569023e-02   -6.273320815684976e-01   -3.244693106783801e-01   -3.143311112855652e-01   -6.134100547012711e-01   +4.132072904203113e-01   +9.665834920047902e-01   +3.215111356175474e-01   -4.291958956517214e-01; +3.523306092540583e-01   +5.814077305415879e-01   +2.636943740461563e-01   +3.810561225581216e-01   +3.920068745908333e-01   +4.462179540895710e-01   -6.427836360887288e-01   -6.610030458699924e-01   +6.003898009956372e-01; +7.453418098509225e-01   -7.164027906944634e-01   +6.928601960551461e-02   +5.317596330136406e-01   -9.298103295460460e-01   -4.955584073232345e-01   -7.620240181998764e-01   +9.367136784975666e-01   +1.879578750490611e-01];
L1_L4_iGABA_netcon = [-1.941810307220094e-01   +7.382886222684663e-01   +2.985513511451222e-01   +4.102457385611418e-01   -3.561865192035336e-01   +7.420688363885245e-01   +8.771195615841342e-01   -3.856781406274535e-01   -5.460117108349044e-01; -5.157247606023443e-01   -4.998251896897015e-01   -1.851812777612381e-01   +4.632125414574848e-01   -2.639768043422600e-01   -1.545544014919285e-01   -5.296826449401865e-01   +9.781309949913146e-02   +1.232426385976238e-01; -3.871910644867004e-01   +6.241859806574196e-01   +6.498923732647590e-01   -3.389748736942877e-01   -4.165930505846015e-02   +4.562505971210286e-01   -1.176779613109769e-01   +4.702773387217900e-01   -1.152392741680678e-01; +6.347958589015344e-02   +1.968242222588051e-01   -5.286586137782320e-01   +5.663103722139383e-01   +1.080479702882682e-01   -6.446210002887119e-01   -8.620569240405958e-01   +7.625539321082005e-01   +5.054673525466907e-01; -5.307294488602378e-01   -6.380554529355504e-01   -8.809935075463321e-01   -5.760015162360691e-01   +3.497787890271297e-01   +7.324533515130578e-01   +3.590282935108662e-01   -6.797164662150665e-01   +6.957252805774157e-01; -1.477735350202510e-01   +8.297636978940789e-01   +6.534109651278613e-01   +2.050777753217172e-01   +5.828127808906860e-01   +3.046880171205575e-01   -1.071772062681475e-03   -8.406848381088450e-01   -7.159026615969543e-01; +7.625606838566240e-01   +5.749720600739388e-01   +3.672722605814008e-01   -2.750518774041808e-01   +2.845975522428654e-01   -4.842853416405302e-01   +4.522443614823994e-01   -6.652150697616184e-01   -7.836605467554568e-01; +1.368604154241481e-01   -5.137780682352744e-01   -1.079229603376428e-01   +6.450575734639675e-01   +6.482534784044267e-01   +2.158040879104730e-01   -5.739612878227910e-01   +6.592495308069825e-01   +6.073325183976599e-01; +1.891969420605581e-01   -4.596962729347740e-01   -2.938021806987698e-01   -6.516598224147019e-01   +7.709724809425568e-01   +3.504235678860680e-01   +2.337515980993533e-01   -8.355552733862485e-01   -4.446652845941834e-01; +1.000000000000000e+00   +4.404587015061133e-01   -4.831297277008207e-01   -7.401739505749162e-01   -5.605510906359445e-01   +7.651766616245325e-01   +4.536341364530022e-01   -3.764847769612789e-01   -2.537605611637686e-02; -7.796623578266068e-01   +4.124948783073283e-01   -2.758109414575628e-01   -1.758331860880503e-01   +7.884025914811444e-01   -2.035398337176866e-01   +1.741875131568206e-01   -7.914853962642919e-01   +8.537275319239528e-01; +1.717734075841246e-01   -8.189327020621675e-01   -2.979688563550134e-01   +8.447767277264628e-05   -5.903863366401224e-01   +2.035332308273110e-01   +7.545376526869875e-01   +2.111237004937319e-01   -4.527315057014620e-01];
L4_L1_iAMPA_netcon = [-1.585656470409949e-01   +3.431097663314436e-01   +1.600751577925852e-01   -8.902631077416594e-01   -8.216232252090208e-01   -3.474436063713956e-01   -7.157845153058201e-01   +9.146173605762933e-01   +5.726958590600618e-01   +7.660645297909570e-01   +1.188329772055773e-01   -4.767662669045546e-02; -4.136244499822441e-01   -5.563503278231919e-01   -8.952930544515841e-01   +3.128012917723493e-01   +7.678129813452235e-01   -7.137428888776466e-01   +4.665894291769351e-01   +7.621039060033596e-01   +2.377368066941704e-01   +1.034342575381090e-01   +7.628302722218437e-01   +6.687279130286554e-01; -7.407392293716378e-02   +1.665671706567364e-01   -3.102471097156561e-01   +7.499200474918882e-01   +2.643581840031264e-01   +5.005252846434622e-01   +5.726583084474430e-01   +5.950474156842533e-01   +8.777972284826185e-01   +2.533466897148083e-01   +7.325023990928770e-01   -3.743361854024896e-01; +1.724636046491312e-01   -6.388530398713722e-01   +7.446886394258165e-02   -1.477184268900308e-01   -8.067841959635633e-01   +3.432850749947721e-01   +3.131283318390780e-01   -4.605480020891830e-01   +6.967974104541824e-02   -2.579110286998390e-01   -3.259435949904816e-01   -6.233125952173858e-01; -3.186111654936512e-01   -7.626454872894807e-01   +6.966809375832087e-01   -4.405242621636927e-01   +8.191775150701541e-01   -2.777214824813571e-01   +3.784406307152833e-01   -7.053963659795451e-01   +4.953864234139329e-01   -1.985336511907705e-01   +7.670029972361910e-01   -7.851102746599687e-01; +2.438120028895248e-01   -3.225436969630815e-01   -1.808116829822006e-01   -6.121229937374671e-01   -4.180510825975557e-01   +2.071313506845434e-01   +9.707608417147381e-01   -6.456052101163440e-01   +4.240512267191786e-01   +4.550410907148955e-01   -3.292323476710727e-01   +5.680892566795170e-01; +2.368418323579037e-01   -1.617020101868355e-01   -3.647263045730684e-01   +4.509942767498398e-01   -6.456228444496791e-01   +1.000000000000000e+00   -7.146582973200281e-01   +2.617841655533750e-01   +3.717973132379976e-01   +2.119477377468260e-02   -9.579255445479969e-02   -2.566298669107137e-01; -5.582337491252815e-02   -3.457835979229549e-01   +2.345768325422486e-01   -2.158417719224852e-01   -5.255883002559502e-01   +6.383604757467665e-01   +8.348903260412111e-02   -3.621781866364566e-01   +8.803763541647027e-01   -5.461900324123096e-01   +3.580890098582928e-01   -3.417415181991397e-01; -4.491025366626948e-02   +6.653039644767416e-01   -3.184395894355649e-01   -5.239659006544473e-01   +3.257046777383534e-01   +6.985585327718015e-01   -8.573452111103511e-01   -6.737801159500136e-01   +3.314867107197257e-02   +8.278401004828269e-01   -8.288753368052181e-01   +3.958377205009070e-01];
L1_L3_iAMPA_netcon = [+5.406024673273585e-01   +5.245954785784556e-01   -5.384856400379132e-01   -1.000000000000000e+00   +1.747214598632529e-01   +1.346206653695849e-02   -9.022431183869256e-01   -5.673201777878713e-02   -6.703408751470227e-01; +5.709208337775884e-01   +5.475311033515174e-01   -3.345939832082966e-01   -7.709009547493689e-02   -4.673581695427437e-01   -2.877038925767189e-01   +6.792635994943864e-01   +3.137721779817059e-01   -1.664865599472785e-01; +7.488053387005178e-01   -5.708082894263206e-01   +6.412153811398630e-01   -3.863319328516638e-01   -6.477069494485861e-01   +6.692693905277489e-01   +6.491163686185970e-01   +8.813674819702099e-01   +3.216068475393085e-01; +6.864022484196561e-01   +3.766367835947870e-01   +7.183467219055389e-01   +1.891057311670307e-01   -4.602037138594948e-01   +8.027461323080500e-01   +9.469311500680121e-01   -7.763539911918490e-01   +4.094481178918123e-01; -6.371438389873207e-01   +6.010873650992029e-02   +5.108145403418854e-01   -4.296818491946203e-01   -3.565964587918343e-01   -8.750072161984793e-01   +3.005959302512398e-01   -8.128695020384423e-01   -7.542027849309879e-01; -6.959444009273575e-01   +9.528149566181013e-03   +9.905381232809213e-01   +4.678039924043235e-01   -7.775116171442993e-01   +3.487249553948207e-01   +4.271723084312216e-01   -6.499979943870707e-01   -8.928937656593835e-01];
L3_L1_iGABA_netcon = [+2.265541449960413e-01   -8.543998568503542e-01   +6.561071653887242e-02   +9.125666315367278e-01   -6.043406460382154e-01   +9.014703279661728e-01; -1.907700763698525e-01   +1.470643155976047e-01   -4.996720085980528e-01   +9.927847926355640e-01   -8.830036531457498e-01   -9.185611448617536e-01; -5.356554801686463e-01   -6.317984481597488e-01   +1.257373662757229e-01   +4.025203523732090e-01   +3.395665216402663e-01   +5.564749683246073e-01; +5.559425316288383e-01   +7.893642902024711e-01   +7.958017752085011e-01   +2.293856511191053e-01   +1.000000000000000e+00   -7.465795191526942e-01; -4.363012565218768e-01   -5.894915103814544e-01   +5.192663100880657e-01   +6.678016890389782e-01   -3.311722230515225e-02   +1.845173170155944e-01; -4.435217368406919e-01   +5.974922145945236e-01   -4.579087912711469e-02   +8.072630776526389e-01   +3.268389321076516e-01   +4.259826878634072e-01; -2.717168239618262e-01   -8.397351944439054e-01   +2.110716455780607e-01   +7.059625830615355e-01   -3.617308262424382e-01   +8.655193021799424e-01; -9.611225834696848e-01   +2.651684548339629e-01   +4.218614015963052e-01   +4.275626192349615e-02   -2.236673927186245e-01   +8.170370065713214e-01; +3.765450645340399e-01   +3.644814778042658e-01   +6.423609210156704e-01   -7.430140588256617e-01   -7.361658800310251e-02   +3.962143587089276e-01];
L5_Input1_iAMPA_netcon = [+6.311359765210720e-01   -1.000000000000000e+00   -6.276704302423020e-01   -4.702076704902990e-01   +3.004630814328907e-01   -2.642736318464866e-02];
L6_Input2_iAMPA_netcon = [+3.504461359390567e-01   -9.389140039520316e-01   -6.997534948699820e-01   -6.155096892015312e-02   -1.000000000000000e+00   +9.773855531211727e-01];
L5_L6_iAMPA_netcon = [-6.381229269227963e-01   -9.501176496298397e-01   +1.000000000000000e+00   -4.698292364683176e-01   +3.720514875071067e-01   -6.459793301918373e-01; -6.044694963630048e-01   +4.649370243292797e-01   +4.254438089290150e-01   -8.398925977612181e-01   -6.382111175338833e-01   -4.219187422799305e-02; -6.865097862557494e-01   -5.623828157517503e-01   -9.889650633254242e-01   +5.793105143770169e-01   +2.201984663065861e-01   -6.534351088474831e-01; -5.208339089124935e-01   +2.359462510869308e-01   +7.520274910308060e-01   -2.151980246241265e-01   +7.576041037125186e-01   -2.117602562209416e-01; +5.764593667166947e-01   +7.624038909932321e-01   -5.796286693530347e-01   -5.748345593511724e-01   +7.106329842497547e-01   +9.732181558636992e-01; +9.635225929991580e-02   +2.552496733081156e-01   +7.336142610142071e-01   +3.373078439701157e-01   -9.288917736963013e-01   -1.325637327353141e-01];
L4_L5_iGABA_netcon = [-9.113402825197230e-01   -7.476258483256955e-01   -4.906990403817503e-01   +2.203654095767316e-02   -5.799839263602770e-01   -4.151280333435484e-02   -8.290303697140311e-02   +7.349728456701494e-01   -6.633575624486386e-01   -2.543148715678104e-01   -4.554276389148015e-02   -7.707521153742038e-01; +5.691777825064610e-01   -4.606224046430266e-01   +5.616212433807113e-01   +5.931351186138063e-01   +2.628417585885379e-01   +1.000000000000000e+00   +4.488945990214512e-02   -8.264026199135973e-01   +7.186048075581758e-01   +3.378127025031494e-01   +8.977825855069902e-01   -8.638581288469158e-01; +2.125824797237532e-01   -5.394836735137488e-01   -7.175366744968811e-01   +5.894416363808419e-01   -3.079215279094882e-01   +5.594459230547335e-01   -4.825883053815082e-01   -7.224033687520536e-01   -2.346376588535614e-01   +1.285919407022903e-01   -2.604930938875634e-01   -6.916304190546236e-01; +8.032189614101966e-01   -9.030825263692144e-01   -1.095391476354766e-01   -4.674678342583952e-01   +8.266173614400052e-02   -8.801674520843388e-01   -1.957333503459458e-01   -5.834432079657548e-01   -2.724892562325197e-02   -6.917950392654956e-01   -4.821853720075849e-02   -7.172573695626476e-01; +5.480154093208478e-01   -6.002926271668869e-01   -1.399700136248961e-02   +7.123556216375835e-01   -5.785535378611029e-01   -8.470279037104337e-01   -3.097648674815250e-01   -7.057168300784300e-01   +4.123028435791387e-01   -5.488863712097134e-01   -5.458558754610834e-01   -4.246165966891636e-01; +3.659068228826630e-01   +1.690463710238850e-01   -1.031372677445895e-01   +2.345603733490947e-01   -8.518721485171042e-01   -7.348504452515142e-01   -4.607064372659859e-01   -1.374843500161982e-01   +2.752171672297650e-01   -2.410004104339346e-01   -2.740971870906079e-01   +6.428478798543192e-01];
L6_L4_iAMPA_netcon = [-6.436292082422278e-01   -3.012952655678983e-01   +8.062917876964089e-01   -4.789392148253850e-01   -4.018611897809181e-01   +3.098988604841605e-02; -5.180791766672062e-01   -3.346621272928321e-01   +1.907851922303718e-01   -5.884060227141322e-02   +2.462801404500987e-01   +4.303945907866880e-01; -9.688196108649406e-01   +1.921382516450713e-01   +1.475979526931305e-01   +6.899182209468637e-01   -1.026430535983420e-01   -8.600741109608910e-01; +7.425796537222709e-01   +2.983706747830460e-01   +5.926461133302724e-01   -4.300702165582085e-01   +1.000000000000000e+00   -4.158518875395510e-01; -1.702761883112964e-01   -3.123849871880585e-01   +3.490901225801799e-02   +6.502477729873654e-01   +4.986009109564455e-01   +3.935462852456892e-01; -5.436599196710502e-02   -4.065498212837281e-01   -5.234654484941994e-01   +7.159747484506601e-01   +5.216336741573199e-01   -1.105865944357933e-01; +8.424834247497386e-01   -7.200234420342878e-01   -5.985927560247618e-01   +5.805781758188021e-01   -2.817389089094097e-01   +6.772520158996151e-01; +2.616448890382716e-01   -3.348398587816220e-01   -5.868392220195914e-01   +5.277285069171440e-01   -8.095348226042515e-01   -3.066987510224125e-01; -2.617296710998147e-01   -2.764365597100875e-01   +2.626194504733698e-02   +2.366648507951816e-01   -8.092577839534921e-01   +9.148236200072686e-01; +9.024349634963555e-01   +7.281737146584871e-01   +5.046152713473308e-01   -7.685846219151836e-01   +3.359905789647407e-01   +2.090746551815389e-01; +7.869784147091482e-01   -4.793358436877059e-01   -3.717631784836440e-01   +2.803349276043568e-01   -5.188262526341874e-01   -9.318617508464369e-01; -9.484339340698721e-02   +2.899761531585811e-01   -1.982105092987473e-01   +7.668288551801991e-01   -1.450829416455953e-01   -5.516102009748263e-01];
L5_L4_iAMPA_netcon = [-6.053753882086644e-01   +7.495892892363785e-01   +7.016153489748448e-01   -9.212674985201534e-01   +4.318494873575112e-01   -2.797448583052787e-01; +1.129574525290847e-01   +4.728288585434626e-01   -1.382111593460391e-01   -2.887173234561870e-02   +3.047813265901033e-01   +4.145550043477834e-01; -4.388531088228175e-01   -5.198569733035079e-01   +7.742893479653654e-01   -5.742000763344719e-01   +1.000000000000000e+00   +6.399490859910857e-01; +6.572967476272156e-01   +3.085028669226343e-01   +1.879564353070343e-01   +9.947116642855881e-01   +5.828191363499216e-01   -4.766340910002634e-01; +1.409301407212074e-01   -3.271954801313616e-01   -4.161604673824379e-01   -2.633041268918669e-01   +2.445596644329224e-01   +8.541551618471048e-01; -7.095033555565309e-01   -2.946203359104393e-01   +3.914811808271849e-01   +6.598680762911653e-01   -4.335130067771364e-01   +4.642980721851093e-02; -4.397787352996741e-02   -5.096397848920877e-01   -4.963679461887603e-01   +1.271215483425741e-01   +2.161104072013450e-01   +7.691886585131466e-01; -2.425111381100358e-02   -2.661415716631044e-01   +7.712213554319786e-01   +5.072310780900532e-01   -2.366508732268641e-01   -5.690079681215102e-01; +7.849899488866763e-01   +2.262763672792987e-01   -7.952946574788878e-01   -6.505582844496656e-01   +8.805918961839109e-01   -1.406309253216517e-01; -5.787198529288483e-01   +3.288605055392044e-01   -3.719339417279465e-01   -8.396462797021446e-01   +2.344789497705321e-01   -3.668033375210772e-01; +1.926915876240305e-01   +4.748943644179155e-01   -8.147233735067991e-01   +6.220727112189421e-01   +6.892141468053005e-01   -6.919493195400558e-02; -1.330215370574281e-01   +7.322582675217191e-01   +6.476484504278095e-01   +7.597465486356434e-01   +7.027115468514060e-01   +9.590398654385439e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
