function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.808748197329524e-01   +2.569420481836591e-01   -6.943795716477089e-02   -3.278105814909297e-01   -3.604040038583106e-01   -3.729061521408797e-01   -9.726953342611214e-02   +5.622851805259105e-01   -3.096676843307404e-01; +5.664279876330935e-01   +2.416828430147125e-01   -7.126734042645291e-01   -1.447205315802174e-01   +9.231069630214758e-02   -5.079144710546735e-01   -2.153417133216640e-02   -2.729168359820314e-01   -3.164255454528909e-01; +5.641136262889643e-01   +2.079907374330947e-01   +7.986827034437621e-02   -8.289288542361266e-01   +3.613797039208206e-01   +5.826082229689008e-01   -1.373577446722601e-01   +5.660897745087734e-01   +3.817864315797529e-01; -5.735046615700239e-01   -1.790094552755235e-01   +3.982350222012115e-01   +1.513475380174710e-01   +1.580302482887461e-01   -2.239713442970256e-01   -3.614575589698019e-01   -1.334462723194387e-01   -3.137997021201344e-01; -7.016405938452452e-01   +1.861326910226807e-01   -1.988735545823254e-01   -1.493901801493994e-01   -2.024105727788139e-01   +5.399786632476260e-01   +1.472628917645060e-01   -1.060407303483540e-02   +6.797287409229184e-01; +5.971811534269820e-02   -4.826770650996433e-01   +2.253991147795691e-01   +2.560352977776063e-01   +3.495781740529383e-01   -6.412415934661211e-01   -3.351733160815987e-01   +2.605183618718465e-01   +3.413212613588438e-01; +5.752378469342118e-01   +2.914062471389465e-01   +2.284883895541792e-01   +5.385206983318186e-02   -2.010055208549179e-01   +8.056781958061364e-02   -7.184089451623503e-01   +8.573457174064475e-02   -5.929935973760760e-01; -4.731607595386915e-01   -9.257463365191540e-02   +2.586484113583296e-01   +7.052332545246578e-02   +9.742455038198707e-02   +1.998674290118557e-01   +1.020329175640249e-01   +2.159188739119510e-01   +1.572968540694218e-01; -1.233914451895192e-01   -5.672861414454435e-01   +1.244196777728680e-01   -2.809710460813447e-01   -9.050216818134693e-02   -5.293380927480222e-02   +7.028076835629734e-01   -5.578460838190300e-01   +3.563703799611111e-01];
L1_L2_iAMPA_netcon = [-3.277251767478271e-01   +3.009040067452267e-01   -2.789957464764824e-01   +3.171246261108454e-01   -3.686846279790260e-01   +4.074008807546917e-02   -3.004089266776575e-01   +1.545332266155923e-01   +4.828418927520983e-01; -3.302288817264057e-01   +2.602963913891140e-01   +2.662714910241499e-01   +2.882253405826565e-01   +4.380518156292256e-01   -1.106567427864714e-01   +6.488473614420296e-01   -1.806308110619448e-01   -3.277662862111372e-01; +1.942804920173615e-01   +2.574385075243618e-01   +1.587963868902849e-01   +1.477639502487503e-02   -4.228540951966320e-01   -1.655483215693052e-01   +6.146241083556503e-01   -2.249464895235553e-01   +4.934811242797530e-01; +9.017686865776781e-03   +1.762327605694976e-01   -1.871114181947059e-01   +3.049271983490205e-01   -4.080807859125463e-02   -7.164599364526753e-02   -5.218490849513413e-02   +4.798781176624485e-01   +1.655246563746193e-02; -4.120722426500530e-01   -3.515555206379473e-01   +3.441441716925514e-01   +2.997100446690870e-01   -1.991012482712730e-01   -8.361546933457877e-01   -1.290761973049471e-01   -2.356463082519799e-01   -3.885755284789663e-02; +2.233077660417381e-01   -1.722230160345888e-01   +1.281655036241171e-01   +3.817498036922402e-01   -2.706058053911430e-01   -3.177440480759373e-01   -1.317004297185069e-01   +8.447429274434773e-02   +2.960139128058243e-01; +2.411372740887411e-01   -1.895127678975151e-01   -4.751310224807611e-01   +1.453637814916193e-01   +1.523591493772349e-01   -1.362339746545378e-01   +2.188687987319139e-01   +4.850423392828673e-02   +5.995797263417709e-01; -3.601255485942614e-01   +1.658869997376567e-01   +3.543762356558444e-02   -2.605472450608629e-01   +2.035590281730521e-01   +3.589855219406921e-02   -3.602529123165551e-01   +1.421821830313232e-01   +4.340412351234941e-01; +2.565079702375611e-01   +8.434419580098912e-03   -2.968915829523611e-01   -1.103474953759294e-01   +2.705226121869785e-01   -4.102963037147969e-01   +2.344745681617776e-01   +1.981852851264077e-01   +1.715651987621620e-01];
L2_L5_iAMPA_netcon = [-2.176012877606637e-01   +2.405320780563165e-01   +3.704831638588164e-03   -4.400666226058406e-01   +2.118741667657076e-03   -1.969885525032876e-01   -6.412872828778524e-01   -4.946059978870012e-01   +4.090104565931619e-01; -9.924091820055483e-01   +1.802935513882439e-01   +1.698537089629959e-01   +1.738152919772143e-01   +9.365853493152249e-02   +5.162089957789437e-02   +1.990692491360520e-01   +1.929929020562537e-01   +9.754299773607333e-02; -2.499445294995523e-02   +1.884285887516579e-01   -1.996825279365254e-02   -5.597768725524545e-01   -3.011212326211349e-01   +2.551903457435890e-01   -3.334844342891438e-01   -1.231502846359165e-01   +4.879525614657462e-01; -4.643136436762008e-03   +3.523784307834882e-01   -5.207834950348178e-01   +4.065797647421709e-02   -7.080299176713173e-02   -1.199815675018700e-01   -2.208405848061750e-01   +6.178970220314961e-01   +3.607020101824429e-01; +6.432557844034181e-02   +4.908544738250872e-01   -1.647837737131109e-01   -2.440652116197848e-01   -1.511891241238570e-01   +5.020446787656305e-01   -8.272986023254997e-02   -5.604264418696361e-01   -3.701692457495717e-01; +2.335514731437837e-01   -1.738661280830341e-01   +1.876284755533250e-01   +1.688136980930910e-01   -2.538665748024722e-01   +1.684243781951186e-01   -2.685234138246815e-01   -1.045820003080303e-01   -5.542884125820431e-01];
L5_L2_iGABA_netcon = [-2.714835991612458e-01   +2.491996883599992e-01   -5.086102128203707e-01   -3.055578706964244e-01   -1.409324186864793e-01   -3.905536390932046e-01; +3.797206591382660e-01   +1.432173162557459e-01   -4.790568079380580e-01   +3.710435435674761e-01   -3.401850194495577e-01   -1.266964439658239e-01; -3.023443731801957e-01   -5.121880115606205e-02   +7.992152787542027e-02   -4.950294259718770e-01   +2.041018540473099e-01   -3.103795069869008e-01; -1.599778639400346e-01   +5.118792265342760e-01   -1.021495915267738e-01   +1.974276369959695e-01   -9.427487317982042e-02   -5.862470558268928e-01; +5.451656588307727e-02   +3.369316532271247e-01   -2.876054204413296e-01   -3.231134173508743e-02   -3.329814917287414e-01   +3.837102226683187e-02; -4.114062230264239e-01   -6.921396351823429e-01   -1.636267510138577e-01   +2.336710558627936e-02   -6.553067693978004e-02   +6.019335563497735e-02; -9.941656821032024e-02   +2.520664005782998e-01   -3.382393819081348e-01   +2.153920876022384e-01   -4.378190260795058e-01   +2.750283134631522e-01; +3.110599768865541e-01   -4.315947581309050e-01   +1.646092409310925e-01   -3.038583455969081e-01   -3.740119372401962e-01   -3.214612540521095e-02; +7.663430494362669e-02   +2.621589172658875e-01   -4.951376243720351e-01   -9.049812218017295e-02   -1.806476357956020e-01   +1.012935487008937e-01];
L3_L2_iAMPA_netcon = [+5.402921685506880e-01   +3.041264190789800e-01   +8.061523139309068e-01   +8.507572626439078e-02   +1.939605966682902e-01   +1.178954739757644e-01; +5.587953382527921e-02   +4.918406554212303e-01   +5.985349954233513e-03   -4.213539837453921e-01   +1.036327661578967e-01   +6.461289979110482e-02; +6.924682445958401e-02   -3.043417929318469e-01   +3.594219293567508e-02   -2.975614498183656e-01   +2.848054738342475e-01   -3.191510115601681e-01; -3.341230461544936e-02   +5.729199579973658e-02   -2.495743089176212e-01   +5.857442999533985e-01   +2.202507842698865e-01   +2.324957888421640e-01; -4.594799183925499e-02   +1.816408798558933e-01   -2.569887249793896e-01   -1.004619514405427e-01   -2.045501125688548e-01   -2.329240394027391e-01; -3.196635277845565e-01   +1.815906621201525e-01   +6.025745360878370e-01   +8.761783990362390e-02   -1.443340796551059e-01   -3.348155453783842e-01; +2.617187567080376e-01   +3.794509673225581e-01   +1.765720672852291e-01   -5.180024994257686e-01   -8.540571664618957e-02   -1.689582468993104e-01; -2.659856383265826e-01   -5.352150418873340e-01   +5.477099890006956e-01   +4.235693276101254e-02   +5.813421055567474e-01   -8.137505497131925e-02; +2.813082842159993e-01   -2.378056945606229e-01   -7.356947293395221e-01   +2.571407969412827e-01   +4.384569182889838e-01   +2.183523915199381e-01];
L2_L3_iGABA_netcon = [+3.443755423564212e-01   +2.178309365922657e-01   -2.630267919518842e-01   +4.394887345131701e-02   -5.767187028224627e-01   -2.038334564099443e-01   -1.404992886154487e-01   -3.978271265470832e-01   +2.235785248298363e-01; +9.288216145888044e-02   +4.230271339189918e-01   -3.550447642318616e-02   -4.579140186700985e-01   +4.717287775375490e-01   -1.270512671586165e-01   +5.268902121862920e-01   -4.062243545474046e-01   +4.588099480940678e-01; +3.062935926834751e-01   +5.682758532171004e-01   -3.275756427303712e-01   -1.447283075918021e-02   +1.250262977550548e-01   -3.329949324988563e-01   -4.658647657537428e-01   +1.453771057866740e-01   +2.657136886660552e-01; +4.826653282749686e-01   +4.012047746821344e-01   -5.397929622705372e-01   +2.529021107913958e-01   -2.815685411879822e-01   +2.385074889558995e-01   -3.728595472365809e-01   +5.162052794490742e-01   -2.807728615196657e-02; +1.065129861481150e-01   -2.090782087682816e-01   +3.746109385844059e-01   +1.913070732590987e-01   -4.708571027948333e-01   +8.553063508586572e-02   +2.169824478846444e-01   -7.084090581732001e-02   -1.339369872812464e-01; +5.228336242725568e-01   +2.886134826040297e-01   -6.218747835258459e-02   +1.707763343435734e-01   -3.934504789774417e-01   -2.279413384768237e-01   -2.082752616442994e-01   -3.039413441935384e-01   -2.603858924868074e-01];
L1_L4_iGABA_netcon = [-7.817146551227498e-01   +4.950261787356036e-01   -1.387650034752032e-01   +4.417421506387291e-03   +2.098649490168785e-01   +7.642921834128270e-01   -1.033544452116419e-01   +3.323887008947199e-01   +4.101195158237382e-02; -5.084958650446142e-01   -3.150651478262251e-01   -4.191113303151477e-01   -3.406437653521160e-01   -2.921725378995247e-01   +5.351057814859055e-02   +1.175207831516864e-01   +2.456050463336361e-01   +3.474699001448560e-01; -1.666313672443420e-02   +2.127848915628699e-01   +7.663153547086293e-01   +3.471399757831846e-01   +9.443676379920848e-02   -1.993944126532828e-01   -5.645900907222892e-01   +2.172019174718332e-01   +1.292417887277645e-01; -1.289408753854739e-01   +2.679078131539225e-01   +1.114382853133863e-01   -4.896089677364700e-01   -1.910365277311783e-01   +5.228233613164330e-01   +3.182833077394766e-01   -6.642415975350129e-02   -4.000255279614548e-02; -2.124957763959185e-01   -2.303435508476739e-01   +4.156907509438926e-01   -5.219505872388033e-01   -1.406285561736968e-01   +1.260560232622302e-01   +3.220181678238523e-01   +3.126589897123728e-01   -6.340198414101074e-01; -4.205919845297736e-02   +8.133078627186263e-02   -4.337338681706404e-02   +1.792796834400582e-01   +9.559898599590346e-01   -5.208905813355456e-01   -4.701973960039956e-01   +3.139284096463173e-02   -2.401382796141371e-02; -5.589387908619231e-01   -4.550285898208604e-01   -1.538685897801166e-01   -1.641330982244388e-01   -6.002429993867586e-02   -2.541068205511861e-01   +8.365302357418174e-01   +3.965841459505771e-01   -5.001067450030886e-01; -2.280460497641686e-01   +5.129265984574687e-01   +7.990747793612692e-01   +3.498673654595664e-01   +5.523121810103433e-02   +3.768264951964939e-02   +1.411738608246189e-01   +4.777074019561494e-01   +4.615302009865178e-01; -3.157829266870593e-01   +8.882299420060299e-02   +5.787037999375169e-01   -2.000163253862896e-01   +7.725013143315901e-02   -5.056262520720065e-01   -2.398224290877689e-01   +2.942956510956312e-01   +1.361375614967112e-01; -2.186292709574513e-01   -5.901324860605529e-01   +1.809499956947609e-01   +3.154062566797269e-01   +5.353930395491957e-01   +4.866541293936788e-02   +4.763991875675334e-01   -5.163000649361332e-01   +3.493577136107253e-01; -1.133664258353704e-01   -6.351446959035939e-02   +6.114409132149906e-01   -5.457898356977259e-02   -2.672959778637676e-01   -1.543797377505815e-02   +3.518999942547208e-01   +3.197408260135460e-01   +1.984887373508860e-01; +2.868429030003051e-01   -2.516163035895549e-01   -3.959144831497186e-01   +1.792585728486462e-01   -1.840360776413465e-01   -1.972912850448463e-01   +2.693906824282838e-01   +5.034831194949581e-01   -1.476965703946787e-02];
L4_L1_iAMPA_netcon = [+2.587895155092810e-01   +3.011001624167766e-01   +4.553067756894710e-01   +1.618066222272055e-01   +5.800252085003628e-01   +3.675547660665286e-01   +3.674748803457467e-02   +5.811563840486172e-01   -2.759071288670240e-01   -6.886987051584463e-01   +1.269553259592933e-01   -6.823487814075911e-01; +1.686223622525181e-01   -2.987116364871582e-01   +4.303540775473032e-01   -2.859523168481635e-01   +6.964811517507813e-02   +6.995112841587536e-01   -9.096770435434978e-02   -4.174656803353978e-01   -3.193861773596203e-01   +1.343412459615828e-01   +4.367252132096579e-03   +1.553828783833080e-01; -1.534178453065730e-02   -1.975443728133320e-01   -6.679909071347939e-02   +5.164993315883226e-01   -2.532850569367304e-01   +1.473425252198649e-01   -1.695095823772413e-01   +1.947792350035416e-01   -2.017076891833780e-01   -8.258625226002783e-02   +1.626351931634555e-01   -1.399499234296635e-01; +4.093407593570457e-02   -2.401517687406135e-01   +1.657288970536691e-01   +8.064149080453012e-01   +2.604916623364736e-02   +3.055216866031422e-01   +1.612610124199436e-01   +2.205407785756444e-01   -6.191303282710894e-01   +3.924314122683222e-01   +4.582644538697962e-01   -3.347657842435151e-02; +1.248983445822880e-01   -1.035975091877894e-01   +3.530485607264610e-01   +2.595733200975476e-01   +6.211841037491175e-02   +7.893281885460346e-03   +2.031765346940439e-01   -1.520274995380426e-01   -5.361744050593655e-01   +4.779699931424631e-01   -4.570952628303270e-01   -4.398058695659073e-01; -1.281336434003476e-01   -3.592489448108269e-02   -2.122254363595469e-01   -2.652975994201097e-01   +2.690700100509330e-02   -1.366424672239446e-01   -1.103225427224264e-01   -4.095687972463332e-01   +2.582145001381868e-01   +1.556005264698225e-01   +3.799200479318536e-01   -6.792494164164170e-01; +4.414383745046807e-01   +2.173201667973637e-01   +2.988031250293296e-01   -3.147613927243128e-01   -1.856371571146165e-02   +3.495371150599322e-01   +4.159474554748637e-01   +4.037348200211494e-01   -4.762102492112552e-02   +1.643743749090994e-01   +6.632066180641877e-02   +1.158087038123790e-01; +9.183186549540262e-02   -3.071323026365699e-02   -1.023463853987913e-01   -6.107904232440313e-01   +2.981127018585160e-01   -2.664446488300826e-02   -2.460249669963084e-01   +6.084343381366056e-01   -2.345920864036078e-01   -8.189578200584724e-02   -5.223290617270421e-02   -8.049196028224007e-01; +1.399168774463754e-01   -4.583916802547741e-01   -3.912155936321543e-01   +2.889408527503063e-01   -1.993339604133789e-01   -5.250477535122982e-01   +1.333904972311274e-01   +1.425542070082151e-01   -2.921665924153469e-02   +2.097209100413283e-01   -3.935930930053033e-01   +5.044357536236580e-01];
L1_L3_iAMPA_netcon = [+4.311422597699968e-01   -2.267567473148655e-01   -3.532656020311672e-01   +4.944513353134211e-01   -3.765532624601878e-01   +4.323734421869539e-02   -5.517380930946770e-02   +4.225253655379569e-01   +1.335015165012164e-01; -2.193835045651607e-01   +1.339481009553949e-01   +1.907897797682384e-02   -7.956272711950196e-02   -6.407119536833820e-01   -2.807090281393674e-01   -1.840242049783965e-03   -3.859655479998895e-01   +4.335413889020712e-01; +1.072894458130691e-03   +1.088799883946069e-02   +1.473316987551897e-01   +2.908945764492479e-02   +2.189623978354907e-01   -4.341524395498637e-01   -9.326922314842839e-02   -3.138926975590237e-02   -5.352332144415770e-02; -4.695702345456356e-01   +2.556285197625656e-01   +4.049190773233245e-01   +5.603686872770572e-01   +2.721544401955041e-01   +6.169739304967968e-02   +4.427933444204896e-01   +4.031936274372662e-01   -6.992628905850096e-02; +7.706072560396955e-01   -3.223215276256702e-02   -1.274965044651315e-01   +2.634154628566368e-01   -6.392146707487431e-01   -2.182005177339361e-01   +4.562061243591412e-02   -2.157283555851199e-01   +1.972132658093255e-01; +3.039022499589544e-02   -7.926333012388986e-01   -5.418374663233921e-02   +2.740152351829234e-01   -2.756283355153036e-02   +2.121193523352689e-01   +5.100065392894630e-01   +1.970254501001920e-01   -5.060629690874824e-01];
L3_L1_iGABA_netcon = [-4.784467961954639e-01   -5.479267383560399e-01   +1.294421027878130e-01   -2.562569651354975e-02   -1.010894384069938e-01   -3.877027893710974e-02; +5.804614606799600e-02   -4.654827119275141e-01   -2.134539810839608e-01   +1.616505598663652e-01   -4.063365269865633e-01   +2.648091468974332e-01; -2.427172355043544e-01   +7.448066474450233e-01   -2.261960429614817e-01   -5.488659130453366e-01   -1.405596539952393e-01   +4.722715319842219e-01; +3.020033487890049e-01   -9.614334469235077e-02   -2.780163702955940e-01   -2.634110686894176e-01   +1.622943704372564e-01   +1.554464767484729e-01; +2.193657878671496e-01   +2.104395854371156e-01   +3.411029491178824e-01   +1.929625276178046e-01   -4.309595434646740e-01   +6.895360833665148e-02; +8.431969450955668e-02   -1.547206948776215e-01   -3.477819732810461e-01   +6.741770029034055e-01   +3.853759421970535e-01   -4.904276894261134e-01; -3.667921176871111e-01   +3.110445237084166e-01   -7.284204190929452e-02   +1.585002990676121e-01   -5.402622678793159e-01   +3.894967619065507e-01; +2.824554280652396e-01   +1.275016723646261e-02   -2.494239259774581e-01   -3.339934506801452e-01   +3.087485345806276e-01   +1.356783552317310e-01; -5.446162536013940e-02   +3.326038723996744e-02   +1.655047256724924e-01   -3.654010352012352e-01   -4.825438603052327e-01   +4.059011407984145e-02];
L5_Input1_iAMPA_netcon = [-6.554935416061934e-02   -3.785013746025097e-01   +8.032069051105930e-01   +4.265928320780243e-02   +1.013844354403372e-01   -2.512465763300905e-01];
L6_Input2_iAMPA_netcon = [-6.157031529634349e-02   +3.947455379458557e-01   -6.936422667530520e-01   +3.314918630691104e-01   -2.727968549831504e-01   +1.253202464106954e-01];
L5_L6_iAMPA_netcon = [+4.915396470989777e-01   -1.484199222002987e-01   -5.680073758049053e-01   +5.460217864809833e-01   -7.268357016889391e-01   -6.579084848682598e-02; +1.962507906719108e-02   -1.112569739217007e-01   +5.054175709282615e-01   +1.450060786650803e-01   +4.092841097694955e-01   -4.204273277320712e-01; -1.133635686367430e-01   -1.426551835505742e-02   -1.961589096877954e-01   +2.037955273639617e-01   +1.087648912353240e-01   +2.883067879520966e-01; +1.523549890088486e-01   +2.296762424867920e-01   -2.114566932706888e-01   -5.666421252053908e-01   +3.862837832324054e-01   -2.829049551161073e-01; -3.574625112725387e-01   -2.635124254040635e-01   -2.932135816285333e-01   +4.624480174172952e-01   -3.695244337179492e-01   +5.318362552339306e-01; +2.156737690248933e-01   -2.309115334083909e-01   -4.142484324078771e-02   +1.684156108958942e-01   +1.210148784712894e-01   +2.130275899003276e-03];
L4_L5_iGABA_netcon = [-5.214817124068980e-01   +4.031003803691741e-01   +5.015713971166168e-01   +5.087674885614333e-01   -2.019791585077448e-01   +7.731435584287889e-01   -1.368530830478657e-01   -2.010513144484229e-01   +6.914113320018500e-02   +9.430719774917061e-02   +6.814391612598729e-01   +6.498235538732293e-01; +9.302985561469573e-02   +7.113361113184669e-03   +3.012259479808009e-01   -2.618080667141782e-01   -2.534646245101635e-01   -1.238822657431624e-01   +2.573654763535584e-01   +5.530668414995126e-01   -1.459673433455834e-01   -6.667914913092496e-01   +3.248855912673049e-01   +1.147761274689638e-01; -4.432561271823955e-01   -7.472750745791874e-01   +3.157728870096108e-01   -2.274195688124492e-01   -5.013051439059499e-01   -1.942988086944591e-01   -3.024944462700729e-02   -1.039465939391249e-01   -8.818818944903024e-02   +6.986248971909921e-01   -4.018424749563855e-01   -5.373276451870312e-02; -2.293535644190824e-01   +2.769080236301622e-01   -4.983977350338292e-01   -8.405030892132015e-02   +4.901839535800907e-01   +4.900634940023252e-01   +2.058643075669631e-01   -3.463637431768757e-01   +1.125559210331492e-01   -1.136557407295780e-02   +9.086278600635573e-01   +5.678220168210579e-01; +6.267221748273106e-01   +4.771414385741539e-01   +5.313062681185626e-02   +5.855597343058200e-02   +3.928519767007574e-01   -4.465456373115123e-02   +1.341856611373099e-01   -1.185508958250103e-02   +4.303262728688673e-01   +4.041103728414011e-01   -5.469086864786257e-02   +1.857141796943991e-01; -4.111101218985734e-01   +2.272933296010358e-01   -4.571112874568754e-01   -3.598090054745431e-01   -1.289558805929442e-01   -3.388445505512011e-01   +3.830186388012504e-01   +5.532690908967005e-01   +4.741526523485636e-01   +1.305917401567316e-01   +3.613611245058473e-01   +2.625207370951522e-01];
L6_L4_iAMPA_netcon = [+8.433321944084707e-02   -1.825132378364508e-01   +1.405065508599902e-02   -1.423918487751438e-01   +6.974616132735476e-01   +3.455092811576564e-01; -4.133351151124191e-01   -4.987190710149516e-01   +1.757201713376038e-01   -2.305240414809130e-01   +5.996145949760743e-01   -8.337171015160955e-02; -5.434662543906793e-01   -4.495776361785522e-01   +5.228472481053464e-02   +2.219801580038869e-01   +6.556315521840521e-01   +4.285178850466899e-01; +6.055778439773979e-01   -1.584174014941489e-01   -2.012708719876010e-01   -2.825448379912524e-01   +4.402510733593502e-02   +2.610853253926616e-01; -2.344593439803107e-01   +3.571265506899786e-01   -2.041435650062377e-01   +3.831413328787131e-01   -1.443353488912864e-01   -1.175328382990622e-01; -5.964253216735085e-01   +9.092503002474590e-01   +4.421627449401094e-01   +3.253326655793601e-01   +3.020731008657281e-01   +4.868174445138779e-01; +4.241084802868850e-01   +6.368085396483492e-02   -6.917782745415020e-01   +5.786696220515360e-01   -1.764294227296636e-01   -2.437197000112323e-01; +1.974380301306755e-01   -3.860925435674329e-01   +4.535059407371492e-01   +3.239013992215197e-01   +4.809019820731991e-02   -6.908379384778456e-01; -3.695772853514890e-01   +4.570360001160341e-01   -1.194905959839904e-01   -5.124689216963918e-02   +3.640367385427449e-01   +9.401769018496063e-02; -7.501767528271802e-01   +3.157690978724046e-01   +5.751729654544855e-01   -2.512994516687567e-01   +6.522721266653808e-01   -5.220010590669044e-01; -1.313400915640340e-01   +1.088735980227726e-01   +5.763516557573800e-02   -1.312816343856314e-01   +3.295787138400133e-01   -2.548713694598953e-02; +8.798856148987172e-01   +1.717947323304473e-01   -1.196367677390569e-01   +6.090988664012810e-01   -3.286300820931722e-01   +3.621871219516648e-02];
L5_L4_iAMPA_netcon = [-3.697626210718479e-01   +9.201715325414926e-02   -1.956208719310830e-01   -1.015635028721339e-01   +2.832493180808047e-01   +1.399598350999784e-01; +1.273514832392553e-01   +1.341058121095620e-01   -1.701750903158664e-01   -2.583530022084127e-01   +1.271771706869813e-01   -3.369721399181815e-02; -1.600001377295865e-01   +3.789052620927238e-01   +3.551679819330718e-01   +2.485055062174033e-01   +2.301316584631951e-01   +4.946314896028026e-01; -2.663278123229960e-01   -3.401948257145085e-01   -3.703545641147047e-01   +1.078575778988139e-02   +3.035414701217726e-02   +4.470760431688227e-01; +3.681324280794747e-01   +3.859007879740849e-01   +1.716489294200124e-01   +1.423502489373831e-01   -4.047112290637364e-01   -1.844934802838047e-01; +1.630070104410370e-01   -3.813943860942021e-02   +7.650226725834393e-01   -2.285515104273551e-01   -2.918062145927071e-02   +1.395482392443819e-01; +1.857572436616642e-01   +3.428476485607952e-01   -1.152104844252896e-01   -3.585392219986328e-04   +3.971356334888669e-02   +8.957854011875449e-02; -2.118322102263713e-01   +3.270138659322475e-01   +1.972296459252521e-02   -2.141823146421978e-01   -4.309382737210018e-01   +2.669960763827370e-01; +4.623402244036290e-02   -4.027205502419542e-01   -1.251359415659123e-01   -1.048055606337044e-01   +1.988486803555433e-01   +3.069866376677866e-01; -2.879694724912935e-02   +5.921983090183220e-01   -7.741216634758119e-01   -7.258132561042140e-02   -3.612863033432978e-01   -5.890410775488251e-02; +1.992007979662365e-01   -6.857221807473151e-01   +1.059003732016969e-01   +2.711891045891341e-01   -6.801317309654860e-01   -3.753683988809430e-01; +5.835685817484159e-01   -5.783739454687559e-01   +2.567958390016062e-02   -2.663728687477568e-01   -7.453382108340137e-01   +3.901318724903721e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
