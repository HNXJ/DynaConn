function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.192471554635467e-01   +8.111739239513910e-01   +8.062022409598808e-01   +4.918020459174080e-01   -2.603647049649076e-02   +8.640220691878544e-01   -1.146432344258957e-01   -2.350820062703704e-01   +6.643452941450960e-01; -6.765297421144115e-01   -1.598454252702378e-01   +6.606607010087775e-01   -5.212995032988571e-01   -4.481007491198854e-01   -1.711650959859383e-01   +8.101572568712959e-01   +7.362086768223215e-01   -2.275311199699304e-02; +8.843087948961570e-01   -8.818385525062622e-01   -7.951146291936744e-01   -2.381552100945784e-01   +2.858309884371301e-01   +2.606082808705153e-01   +5.183427833902775e-01   -5.100273140418720e-01   +4.506484029186009e-01; -4.460331076568405e-01   +8.687514200240757e-01   +3.339377936966979e-01   -9.120700531558843e-01   +7.725800800385645e-01   +1.130348195151724e-01   -3.786582929322260e-01   -4.725905962876378e-01   -6.458045894600802e-01; -8.503428641818143e-01   -6.992192589685852e-01   +6.021121420668226e-01   -6.184844313935587e-01   -4.007831411475415e-01   +3.105040640190336e-01   +3.563068456937586e-01   -4.971041611142589e-01   -9.913022214975125e-01; +3.380278374130745e-01   -3.868165734950072e-01   +4.617245881531444e-01   -1.140381369794339e-01   -5.301937643936244e-02   +8.983027924728046e-02   -1.733853546995598e-01   -8.329791885765534e-01   -5.132764071709242e-01; +7.340117445183324e-01   +7.388144394291264e-01   +9.574837355390980e-01   -6.176880854032376e-01   +5.825422440011497e-01   -8.924950022823243e-01   +4.895791250016935e-01   +5.567560200429632e-01   -7.801404940462403e-01; -7.063548608268325e-03   -8.870375209448338e-01   -8.722730088358439e-01   +7.919881062602829e-02   +3.354879413344197e-01   -1.000000000000000e+00   +6.191753893833540e-01   +2.310964001680346e-01   -5.565816411655938e-01; -7.485170626786805e-01   -4.025270958125752e-01   -5.809791644643197e-01   -4.304738721594071e-01   +4.093990450087845e-01   +4.785485681720791e-01   -2.172422272599024e-01   -8.095808879735575e-01   +5.265043881475843e-01];
L1_L2_iAMPA_netcon = [+1.041575191799909e-01   -5.221502451817405e-01   +9.533945675129676e-01   +2.021991379629512e-01   -7.611065764035616e-01   -2.317285253518054e-01   +2.430275940333542e-01   +5.756195694809187e-01   +2.444858622170570e-01; -2.937098513695061e-01   -4.857327985245197e-01   +7.224937709132045e-01   +3.240882986681083e-02   +6.821232214403664e-03   +2.033558127074626e-01   -8.181258910012350e-01   +8.277918875441932e-01   +1.000000000000000e+00; +7.628185622418164e-01   -2.555439742404600e-01   -3.045559006187400e-02   +5.343685872700827e-01   +3.789287131696040e-01   +5.617028121045704e-01   +1.813139044786970e-01   +7.892663076095066e-01   +9.287900960327646e-01; +9.664453670380302e-01   +6.895518371505089e-01   -8.286733292481578e-01   -3.235336069267336e-01   +4.219070769350176e-01   +5.238669593238280e-01   +6.598518405169117e-01   -5.965160619507104e-01   +4.563977814527411e-01; +5.370735969604015e-01   +5.450162108389579e-01   +1.980702738510494e-01   -4.859289338325225e-01   +5.679022473063129e-01   -2.070080856411513e-01   -5.606811234874253e-01   -5.102723890872061e-01   -1.905423011910671e-01; -2.200404530779821e-01   -1.684407577291978e-01   -7.507219395522177e-01   +3.991402076108359e-01   -7.224027529508140e-01   -1.753538045561447e-01   +3.547386965930810e-01   +2.112128196606843e-01   -2.270027157481762e-01; -5.860992171691203e-01   +4.724766687579874e-01   -9.750993331173419e-01   -3.479058902423356e-01   -4.973407936489613e-01   -3.416879202540325e-02   +6.445082444255550e-01   -5.129169859266108e-01   -7.001182469063019e-01; -3.061472213833292e-01   -1.384128240877627e-01   +7.109332977008828e-02   +4.067106039399480e-01   -5.428456277554481e-01   +3.389214606550329e-01   -5.450290862335070e-01   +7.438722895109379e-01   -4.198549849853112e-01; -1.816029898036966e-01   -8.676001800061235e-01   -8.709975818959232e-01   +5.254067571012982e-01   +8.149064515247633e-01   +6.662074413691093e-01   -7.149316328001326e-01   +9.580692749995159e-01   -5.277151615554734e-01];
L2_L5_iAMPA_netcon = [+5.534269972810560e-01   -5.798240676493192e-01   -6.925258092143184e-02   -6.852782367324078e-01   +7.374420475652075e-01   +4.546036734363109e-01   -2.204205510547141e-01   +7.671527747375298e-02   -1.877845270293021e-02; -5.819580328819116e-01   -6.179647530285142e-01   +2.704363125666041e-01   +6.372847284643595e-01   -1.412181536823424e-01   +1.000000000000000e+00   -2.652772283044682e-01   +3.755360871362162e-01   -6.391660971014611e-01; -1.037031150480696e-01   +4.029091770498041e-01   -3.365296589733894e-01   -5.477169746714424e-02   -2.974331562444731e-01   -3.998536927189337e-01   +2.035892460818858e-01   -7.183151650751334e-01   +7.433136617252483e-01; +9.378062217347143e-03   +9.746700521668571e-01   +2.738808411265765e-02   -1.801257007566805e-01   +7.578390369880849e-01   -7.613133042758683e-01   +2.713724828569967e-01   -2.333653442721640e-01   -1.004368076216812e-01; +3.500392178168896e-01   -8.613887182379689e-01   +3.518765524329848e-01   -7.104790688559653e-01   +9.209127887278178e-01   -7.890386041545477e-01   +1.467036480683486e-01   +2.638155747835389e-03   -4.482341416243990e-01; -5.402483787100966e-01   +6.005945433248033e-01   +8.886985921892913e-02   -4.975785712772117e-01   +1.621654301789248e-01   +1.152044366376095e-01   +2.815595776856910e-01   +6.803053950972962e-01   -7.528634522858345e-02];
L5_L2_iGABA_netcon = [-7.932745454258877e-01   -8.158793503464142e-01   +8.396067121990108e-01   +2.758147850557194e-01   -8.728926910447045e-02   +5.875482396482150e-01; +7.514957109456116e-01   +6.773362965320577e-01   -5.151667751273041e-01   +4.016449332801860e-01   +6.396674409466284e-01   +3.957228513658056e-01; -9.796620765741109e-01   -7.635457124678514e-01   -2.189956287995561e-01   -2.423834157855902e-01   +1.000000000000000e+00   -2.957813728282658e-01; -7.934400639668850e-02   +3.969856699384140e-01   +3.977585228721146e-02   +7.392899117529746e-01   +7.270586449774216e-02   +1.290062682736261e-01; +5.241223287559880e-01   +6.487340624819712e-01   +5.612799089789412e-01   -1.526426054097406e-01   +2.776092068623941e-01   +3.539773792167122e-01; +8.260614740057716e-01   -3.169484070313228e-03   -8.312606078703090e-01   +1.693238053732022e-01   -2.741849482804058e-01   +4.612998609516111e-01; +6.304253869521689e-01   -4.000732807388803e-03   -1.707549762983900e-01   +3.978389514152810e-01   +4.079491167952479e-01   -9.433864633409367e-02; +3.258391569996530e-01   +2.739580128512911e-01   -6.040898723062080e-02   -6.300541399579949e-01   +6.481011085372712e-01   +5.075320378225964e-01; +1.473906862591736e-01   +4.125152940696796e-01   +7.488876334742718e-01   +8.561148589185427e-01   +3.735753798489732e-01   +3.100041412820660e-01];
L3_L2_iAMPA_netcon = [+7.490223917886067e-01   -8.513827126788972e-01   -6.852043429176667e-01   +6.878046607954966e-01   +4.912330549160371e-01   +7.919933521369937e-02; -2.716706999360098e-01   +1.328423168542318e-01   -7.618880105032553e-01   -8.600948979033345e-01   -3.700850096327997e-02   +9.170366773694623e-01; +2.987773404358710e-01   +2.006435425989159e-01   +4.991363546639318e-01   -8.203933146790852e-01   -1.804813620048896e-01   -2.170630144804928e-01; +1.752842128441901e-01   -1.000000000000000e+00   +4.357408593062587e-01   -6.521469247095416e-01   +7.400423414332511e-01   -3.056958020698725e-01; -8.150350286837143e-03   -1.468956759591349e-01   -8.300474444622244e-01   -5.689395820427626e-01   +1.095887655354579e-01   -8.884093140726657e-01; +7.964738668710389e-02   +5.532070666072156e-01   -9.631806061358055e-01   +7.501595265518261e-02   +2.817481830899169e-01   +4.473593807282298e-01; -5.789656417359217e-01   -5.108699946273317e-01   +3.492430343912011e-01   +6.864609707633990e-01   +2.411151034891531e-02   +4.625284408857983e-01; +7.668274867936073e-01   -8.094266658410908e-01   +2.023183093854379e-01   -3.991636090398836e-01   +7.644576355483251e-01   +4.838912850223697e-02; -2.813505805404536e-01   +8.761828604393175e-02   -5.740107066528601e-01   -4.158602810894557e-01   +4.042891464544629e-01   -6.947799862843550e-01];
L2_L3_iGABA_netcon = [-9.040799487030132e-01   -7.811070575886241e-01   -4.637145707028280e-01   -1.703028385121479e-01   +9.064895787652204e-01   +1.045956660022860e-01   -1.075580162714025e-01   +2.334091088575589e-01   +1.819346408992270e-01; -9.471338471886704e-01   +1.590957676238218e-01   +2.286439276926471e-01   -1.620336136709236e-01   -9.401901371692056e-01   +1.276135013147117e-02   +3.289657885622244e-01   +2.426357958185027e-01   -7.299914448807923e-01; -3.607740909202758e-01   +5.907944760810070e-01   -7.511696081448692e-01   -2.435691753279741e-01   +3.708843815833673e-01   -9.384456511151752e-01   +1.000000000000000e+00   +8.290876521662067e-03   -5.609710542249321e-01; +7.695847873286449e-01   -2.153066800516764e-03   -6.336323189785834e-01   -4.775313092420480e-01   -1.244968387946129e-01   -4.864291672675288e-01   -7.117853602457171e-01   -6.967338667664405e-02   +9.081395734140966e-01; -1.802435778677066e-01   -1.157502366237087e-01   -3.015889325764299e-01   -2.903470926562963e-01   +2.321302448767540e-01   -3.829901456930945e-01   +5.540869936929019e-01   -7.725683220093894e-01   +1.919956961901531e-01; -5.160106455690450e-01   -1.254205897843823e-01   -5.190834024655178e-01   +9.313152564677476e-01   -7.931780309224966e-02   +5.894927111679658e-01   +5.259234271773845e-01   +7.949013467348292e-01   -9.965131465498285e-01];
L1_L4_iGABA_netcon = [+1.590838156546586e-01   +1.404492258447051e-01   +7.896123566376092e-01   +3.654206876362405e-01   -3.850924896567489e-01   -2.121911834574279e-01   +8.114348191282142e-01   -8.366133679743198e-01   +5.322973417337150e-01; +5.215682925718623e-01   -1.844687676414174e-01   -2.891953265213890e-01   +9.951993076746633e-02   +9.193163210856217e-01   +1.982021509349406e-01   +3.184056355914553e-01   +1.290499246741293e-01   -2.747272663750613e-01; +7.179588259697430e-01   -3.843796885619399e-01   -7.361025312414445e-01   -5.555519872513547e-02   +8.108566032602651e-01   +8.580430519111479e-01   +7.468991171294062e-01   -7.216233466635749e-01   -8.721403458328582e-01; -4.389150136920005e-01   -9.243044758154610e-01   +5.669076637280852e-01   -8.845165786913175e-01   +1.000000000000000e+00   -3.912231319068187e-02   -6.113148680219409e-01   -6.966026734751505e-01   -5.205805310718052e-01; +4.774958370243167e-01   +8.717591990080404e-01   +1.719509436338007e-01   -3.561291549051988e-01   +7.999465479445245e-02   +8.054330702716943e-01   -2.976894610034608e-01   +6.113378891503419e-01   -4.241341049613402e-01; -3.952578902866902e-01   +6.835286696723784e-01   -4.464369600523438e-01   +2.139321956028603e-01   -8.981373344891902e-01   -5.748609108379752e-01   +8.847662096032403e-01   +4.925773788765646e-01   -3.837165234146302e-01; -8.633455805661612e-02   +4.833391709527733e-01   -1.893144680216235e-01   +2.219726789851348e-02   -4.286332444114103e-02   -7.930772152347864e-01   +7.985650254686469e-01   +5.533890980687177e-01   -4.511417336054902e-01; -2.429310020034913e-01   +6.652771892762688e-01   +7.390404549036200e-01   -2.803732423422646e-01   +2.584990376383963e-01   +5.398422426420857e-01   +4.619776822680081e-01   -5.477508042279162e-01   +8.809896906161838e-01; +5.467403559495990e-01   -3.531645331956214e-01   -1.286222324365934e-01   -4.950908764481979e-01   +3.220697630903595e-01   +6.550039540750366e-02   +9.638094971480218e-02   +5.351012513336035e-01   +3.364941689785282e-01; -2.353693639135008e-01   +2.106672145647149e-02   -6.709299846433748e-01   -6.430954295361532e-01   -1.451806979462926e-01   +2.813047096292133e-01   -8.551747758380331e-01   +7.838448884054598e-01   -2.705298758741679e-01; -4.748137188238730e-02   -1.572770223152035e-01   +8.639133523813209e-01   +5.556445615941560e-01   +7.372265770753096e-01   +5.610586490025498e-01   +4.283478333449282e-01   +1.483391217106492e-01   -5.477043156082109e-01; -5.502637448806313e-01   +3.109051595653665e-01   +5.184192734669603e-01   -2.716436988668145e-01   +8.560187946858447e-01   -7.404415621216885e-01   -4.934063686951488e-01   +1.288624185584798e-01   -5.890962051473830e-01];
L4_L1_iAMPA_netcon = [+1.323907595562439e-01   +4.401794604277678e-01   +5.660424689469761e-01   -2.116267011548290e-01   -4.137125326001402e-01   +3.759953006555459e-01   -4.873671042408887e-01   -5.149414855224228e-01   -3.188585320252263e-01   +3.368681478501131e-01   +6.545052042582928e-01   -4.154005864322076e-01; +9.025691333784176e-01   +7.879667361977214e-01   -6.597679999811994e-01   +7.976213633026691e-01   -5.752124691247783e-01   -6.369658692711846e-01   -2.685696460648670e-01   -6.599679505041096e-01   -3.090775063278678e-01   +1.670834845666733e-01   -7.264212832963514e-01   -3.094799475324894e-01; -4.077652873654523e-01   -9.987837244304053e-02   -6.189120685648384e-01   -9.198082945093751e-01   +5.348696633162376e-01   +1.539315801481285e-02   +5.501446754834802e-01   +3.497540965354246e-01   -4.612058455551723e-01   +5.564446188816220e-01   -3.079113442159270e-01   -3.620023311682324e-01; +7.596167695927282e-01   +2.600590851722766e-02   -3.681276890655479e-01   +2.292268589946857e-01   -9.843380764499202e-01   +1.715393039481041e-01   -6.877484838996577e-01   -2.097284419701996e-01   +5.314749791674430e-01   -7.435961653448701e-01   +2.087541972546740e-01   +7.726366186482297e-01; +5.700340147308869e-01   +5.058230743750023e-01   -2.341307631291625e-01   +7.310725687545717e-02   +1.644432940154033e-01   -2.667609397822155e-01   +7.693705723982043e-01   +5.506831513687660e-01   -8.948685045025169e-02   -6.938767389612817e-01   +5.252693371920391e-01   -7.201108962377735e-01; +6.203884075458660e-01   +3.159500093200027e-01   -3.579757481115304e-02   -6.328058392529251e-01   -1.413386837375496e-01   -3.069481434242836e-01   +7.773013883456412e-01   +6.478522991276449e-01   -1.863262681466527e-01   +6.782477733997935e-01   +1.939420836512250e-03   +7.438526762033676e-01; +6.189654201122533e-01   +7.754131418848111e-01   +1.000000000000000e+00   +7.957265086390344e-02   -7.328603273142240e-01   -1.038747115097856e-01   -1.940614236227131e-01   -4.115396531072473e-01   +6.355514469295777e-01   -4.003735412045822e-01   -3.616505229041989e-01   -8.003933809849130e-01; +6.357075374943585e-01   -3.586214498665923e-01   -7.618172114962192e-02   -8.905152995599083e-01   -3.859591354438747e-01   +4.321688844351195e-01   +4.924300969435297e-02   +7.230233508302835e-01   +6.264122192292549e-01   -5.705973692923942e-01   +9.482902581272495e-01   +3.509923878625228e-01; -7.874884461853942e-01   -2.805694298014815e-01   +7.907869319983805e-03   +3.902142301895261e-01   -1.909901988172151e-01   +2.133159373098988e-01   -2.007766167861596e-01   +1.962486287714515e-01   -5.600797874988220e-01   +3.332664453753107e-01   -4.438704367173353e-01   -8.896394475829119e-01];
L1_L3_iAMPA_netcon = [-7.243059071392804e-01   -1.590280714330811e-01   -3.834576406461822e-01   -4.808587853044827e-01   +3.730656638098951e-01   +3.376429008484970e-01   -7.811290124230587e-01   +7.349098147197181e-01   -2.408248336115360e-01; -5.449705142376856e-01   -4.564953327103985e-01   -2.591499354937533e-01   +4.414751323407334e-01   +7.842311854869987e-01   +7.426709039165144e-02   +8.442051634333424e-01   -2.134223450321320e-01   +4.872043118438512e-01; +7.251651892977078e-01   -1.724230690648474e-01   -7.599284139384606e-01   +4.525189840808032e-01   -9.062980011515268e-01   -3.388621526879840e-01   -2.946489347190829e-01   -1.781151219837016e-01   +4.527882249608632e-01; -1.911397814321476e-01   +2.640510949613964e-01   +5.121198230471020e-01   -8.252443386169362e-01   -7.287893003014463e-01   -4.955108972792099e-01   -7.711307481862714e-01   +6.779297365274128e-01   +5.532285204118828e-01; +1.000000000000000e+00   -4.820898623796503e-02   +5.330499034473479e-02   +2.448672130656937e-01   +5.325888559402062e-01   +3.587173896000421e-01   -2.350428911957360e-01   +5.900785331321718e-01   +1.049951847118940e-01; -1.541210765843564e-01   -5.288547704668670e-01   +2.559493505206134e-01   +5.737515731939195e-02   +8.998991531891352e-02   +5.044354984165801e-02   +7.438694163762408e-01   -4.650073624053746e-01   -2.559071092682363e-01];
L3_L1_iGABA_netcon = [-3.548157846581224e-01   +7.119316682723843e-01   -3.395005778295506e-01   +6.598389135421571e-01   -3.469736495697597e-01   +6.162679681304835e-01; +4.534250170592191e-01   +5.029139462489801e-01   -6.006219273370031e-01   +3.910533994813762e-01   +4.735008988253502e-01   -4.509350305507953e-01; +5.384469868129426e-01   -5.125972006246053e-01   -2.689022196471474e-01   +5.700387467146588e-01   -7.275686131709580e-01   +4.187152391742336e-01; -6.589862557053491e-01   -3.743126132685839e-01   +4.112285456557735e-01   -5.489713632469423e-01   -2.920327387809968e-01   +4.443228322177567e-01; -7.753500998811099e-01   +3.862584750772708e-01   -5.726682710435618e-01   -2.114724332390693e-01   -1.000000000000000e+00   -7.353596873625625e-01; -7.880149870853544e-02   -1.489160615623983e-01   +5.378665035472744e-03   -4.324396476698301e-01   -4.676832197098459e-02   +1.348523834883420e-01; -1.236622228912143e-01   +4.326222291163870e-01   -2.240074533619526e-01   +7.398061412627169e-01   -6.793776466123794e-01   -7.007941670000557e-01; +3.394300636296799e-01   -7.029435680220935e-01   +1.999366973072611e-01   -7.181785981799506e-01   -1.110872695795601e-01   +6.452916095144431e-01; -3.058619279904637e-01   +1.936966599457875e-01   -7.651912221244606e-01   +7.422258326989276e-01   +6.957775168725785e-01   -7.537166692977879e-01];
L5_Input1_iAMPA_netcon = [+4.478295804516345e-01   -2.418916935999304e-01   +1.000000000000000e+00   +6.362049548192197e-01   +5.314642278475001e-01   -5.157509759373653e-01];
L6_Input2_iAMPA_netcon = [+5.786108451004783e-01   -7.050940277516530e-01   -7.720738463173750e-01   -1.000000000000000e+00   -4.207145677180207e-01   -8.789911874617752e-01];
L5_L6_iAMPA_netcon = [-1.000000000000000e+00   +7.880701320786537e-01   -9.769712300714825e-01   -8.900900757203097e-03   +1.558572362522269e-01   -2.820828597276887e-01; +8.851982474730320e-02   -4.853935950926502e-01   +7.380387016641268e-01   -8.718172910465978e-01   +3.222607149723970e-01   +6.412806974844968e-01; -7.292879799101420e-01   +7.487836470467509e-01   +6.336253639559024e-01   -3.647290822398714e-01   -4.356253806576008e-01   -5.586617960651483e-01; -1.864121931949365e-02   +5.653373262339408e-01   -8.603511524582610e-01   +6.050244442527434e-01   -7.685352318957949e-01   -5.248663136804109e-01; +2.423167783842261e-01   +1.489626181879015e-01   -7.670851425699305e-01   +5.333423301495090e-01   -4.116744418605721e-01   +5.659352954983404e-01; -1.234808586640046e-01   +5.912110023268694e-01   +5.372446412566237e-02   -8.020504132237614e-02   -4.523894984864417e-01   +7.475584409168032e-01];
L4_L5_iGABA_netcon = [+1.501573889425106e-01   +2.604471995694149e-01   -6.540791869089205e-01   +6.257438855402798e-01   -5.384991962282771e-01   -4.742400271588217e-01   +4.328707720139950e-01   +9.881312392881042e-01   -4.699402526555444e-01   -4.098280554139638e-01   -7.931322894743098e-01   -1.770922256585439e-01; +1.394067674962710e-01   +2.190133701545300e-01   -6.770839250991033e-01   +1.940246776338838e-01   +4.064030215210189e-01   +6.761504536523215e-02   -2.598757726701955e-01   +1.000000000000000e+00   -1.911186859659276e-01   -7.282989984474382e-01   -5.562369581912278e-01   +7.913552574203910e-01; +5.729577827058699e-02   +5.084472222788398e-01   -8.605705016020921e-01   -3.244699416983617e-01   +9.071886363902106e-01   +7.766817261162817e-01   +3.841540039381229e-01   +7.500775641273022e-01   +9.256636015377138e-01   +9.989775492067841e-01   +7.216309012186013e-01   -5.743254258616515e-01; -4.807235421418758e-01   +8.589598472514710e-01   +9.757344180963630e-01   -5.689594613861144e-01   +4.101095228119921e-01   -5.415842853650149e-01   +8.108428947749022e-01   +6.721993644512017e-01   -9.434539434369013e-03   -2.900890279195631e-01   +2.102447723519433e-01   +7.404820754003174e-01; -8.524197263030097e-01   +6.213521163530846e-01   -1.097426635800332e-01   +4.704081928293469e-01   -3.309548047756213e-01   -5.659850088211258e-01   -4.161498505913650e-01   -3.325806034933759e-01   -5.916106712442823e-01   -3.992095529887631e-01   -2.403760900679396e-01   +2.211375185118359e-01; +7.090060510614370e-01   +3.079933779464092e-01   -6.421132045343504e-01   -4.938219591976710e-01   +4.015439282458546e-02   -1.358855865550719e-01   +3.288162735750960e-01   -7.978189719006082e-01   +8.988734069415584e-03   +8.732297784987365e-01   +2.141158453918477e-01   -2.323074543309037e-01];
L6_L4_iAMPA_netcon = [+3.248022442901261e-01   -7.588352761154196e-01   +1.726497643244814e-01   -8.526577016504191e-01   +3.246751253642263e-01   -2.803831489220493e-01; +5.451255991608811e-01   +9.894431372691962e-01   +1.506163087533991e-01   -1.000000000000000e+00   -3.967683478494287e-01   -8.255007996756514e-01; +9.912220978160849e-01   -6.558915669716380e-01   +7.238682179203655e-01   +8.284061463755517e-01   -4.486077239054836e-01   +1.787593331392218e-02; +8.935233149690287e-02   +5.532144184719667e-01   +1.956757642518204e-01   +7.625231397432005e-01   +9.921930867705181e-01   +3.109606834877884e-02; -9.373092762558446e-01   -9.269235477405424e-01   -7.059300679621480e-01   -3.967942516444045e-01   -8.479843680417458e-02   +7.086426347277456e-01; +7.517319655799840e-01   +9.388603843350108e-01   +3.887556031114027e-01   +3.703365044805252e-01   +1.807839423509185e-01   +5.838159624192905e-01; -5.854589828483163e-01   -3.132253244665310e-01   -6.458044017928956e-01   +7.736723958711458e-01   -6.390118987872567e-01   +3.085761399015715e-01; -5.748285056004534e-01   -6.693313183724203e-01   -7.114593336134413e-01   -7.496800189332277e-01   +3.961990378710791e-01   +3.699455412939284e-02; +2.164399534874929e-01   -8.185890237597254e-01   +1.543003673240000e-01   -2.197102802517375e-01   -7.092496185878944e-01   +3.449059957824763e-01; +4.256926946605769e-01   -9.119689078490555e-02   -2.573985198914929e-01   -8.502991197614476e-01   -3.069701448342605e-01   -4.267435792506274e-01; -7.868641057912572e-01   +2.059506489838362e-01   -7.902613931620599e-01   +1.921398491730589e-01   -2.818024156965672e-01   +6.636379961138326e-02; +5.688435919144202e-01   +6.770446693256568e-01   -6.103009223990236e-01   +4.354884410160386e-01   +4.406176178346405e-01   -6.722634380256748e-01];
L5_L4_iAMPA_netcon = [+7.273602840705704e-01   +1.726616592448067e-01   -4.227231338495213e-01   -2.543979810432203e-01   -2.322955776468047e-01   -7.837052724837544e-01; +1.493486379314595e-01   -6.722154860555509e-01   +2.835015107225037e-01   +5.785981455672194e-01   +4.536245706751488e-01   -7.762873278321883e-01; -7.286087621182695e-01   +1.000000000000000e+00   -6.484426673242318e-01   -8.309474437011831e-01   +2.168035986812883e-01   +6.402412226804642e-01; +2.254236924212732e-01   -9.328657219061929e-01   -7.525990464519455e-01   -5.640001108902591e-01   +6.802395288854430e-01   -3.679824234155157e-01; -7.757880367071168e-01   -7.206891059916735e-01   -7.351710668976306e-01   +2.211385897417517e-01   -3.537875184172955e-01   -8.869309637324031e-01; -6.710064029116913e-01   +3.040017629529972e-02   +1.782919389521648e-01   -5.666287959841840e-01   +4.249381836799233e-01   -3.522327145301230e-01; -4.711788351930199e-01   -9.801750302160781e-01   -5.061620409072105e-02   -7.229700741962236e-01   +9.452575484867941e-01   -1.138693411873004e-01; -1.949317750470067e-01   -1.408735424177745e-01   +5.015409996675495e-01   +6.381832268464164e-01   +3.922645547226536e-01   -1.701024491106669e-01; +2.826961915275834e-01   +3.260854268357426e-01   -1.967988488374660e-01   -5.693865980019878e-01   +7.954034009172949e-01   +1.090686169242070e-01; +9.276430924167455e-01   +1.828309389778227e-01   -3.834003616857906e-01   +9.233534407529812e-01   +5.026150392546977e-01   +3.910883537666346e-01; +1.277091957653670e-01   -5.881914313543102e-01   +4.326947660995774e-01   +7.900461861062386e-01   +1.423173978828607e-01   +9.562642439730317e-01; -1.689278619557280e-01   +5.213781397697789e-01   +9.535517657470138e-02   +2.303167623415023e-01   +8.391544889915135e-01   +5.425206379438016e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
