function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-5.781502421696740e-01   +2.829315630963132e-01   -2.152955740573782e-01   -3.032410324053685e-01   -1.962767667475054e-02   +6.452432441991374e-02   +3.348036037752553e-01   -4.246190085519527e-01   -7.625019888079129e-02; -6.923508770007134e-01   +1.980515727422043e-01   -5.883332858231263e-02   +4.146443452671621e-01   -4.193445607843257e-01   +2.499811258530008e-01   -7.092561444214429e-02   -2.998750907970559e-01   +1.457015133292227e-01; +2.439044049693848e-01   +2.073345712499890e-02   +1.315617190859159e-02   +2.942388712934183e-01   -4.196989768655080e-01   -1.367654680229844e-01   +2.373030001471932e-01   -3.155230185929774e-01   +4.107905399710168e-01; +8.768995669501891e-01   -3.296006221344531e-01   +5.937989782120154e-01   -5.177619440798689e-01   -2.435868748535510e-01   -4.019908390552550e-01   +1.025939531125522e-02   -5.675912538235975e-02   -4.610734069509446e-01; +2.545889956924852e-01   -2.451069823291033e-01   +2.508848164653378e-01   +2.963687866695741e-02   -6.216200182081173e-01   +2.319450858459676e-01   -3.392346098362864e-03   -2.345585793370952e-01   +1.078175620243230e-01; +3.304110999345439e-01   +3.008617650837380e-01   +2.558583607797497e-01   +1.381693996566633e-01   +3.680688008050172e-01   +8.697791764842974e-02   +1.535799474355931e-01   +2.587248609363740e-03   +3.922328532245479e-01; +1.301645903909061e-01   -1.187628906376131e-01   -4.935751219522564e-01   +7.992770096337394e-02   -1.524442521474691e-01   -8.359052805828279e-02   +2.432255947644547e-01   +1.187940726545527e-01   -2.042177451191255e-01; -6.661130587271759e-01   +5.369955988091768e-01   -3.716834596553293e-01   -3.100145436278320e-01   -2.660586173613342e-01   -3.996941107951456e-01   -1.562558705109488e-01   -2.710333033445345e-01   -8.444684031126692e-03; -2.397781063730137e-01   +1.466342888611121e-01   -1.504069212468819e-01   +1.824122970152556e-01   +4.548109281802762e-02   +2.086599110587480e-01   +5.907636090432471e-01   -1.713193573832663e-01   -6.576074485859282e-02];
L1_L2_iAMPA_netcon = [-2.621248180350970e-01   +4.730149560622741e-01   +5.995815898331826e-02   +2.677307904665690e-01   +6.196575038545582e-01   +1.136028451799895e-01   -2.975109382844586e-01   +2.095803272118182e-01   +3.675132324503460e-01; -3.362739702842372e-01   +3.659780208810305e-03   -6.920314775553658e-02   +2.698296217808662e-01   -4.768828698382477e-01   -2.030578626233838e-02   +5.237477560618029e-01   +1.255726635505396e-01   -2.279035157983054e-01; +1.451334453009901e-02   -8.093041285690763e-01   +4.665870822149732e-01   -1.190902536722243e-01   -5.646590620699934e-01   -2.009270911955248e-01   +6.387424640893041e-01   +2.011717190997785e-01   +4.910018689314180e-01; +2.130245439876704e-01   +4.259372102108880e-01   +2.314138989261369e-01   -4.422379935969877e-01   +9.734525300941063e-02   +7.763321958999948e-02   +5.422210931006530e-01   +2.609351956527823e-01   +5.022803701155404e-01; +6.427234317853173e-01   +2.050934105012095e-01   +3.121387224852326e-01   +2.748628293292053e-01   +3.252948568317376e-01   +3.618715540476298e-01   -3.816025350320094e-02   -3.137936165668765e-01   -4.184636188462523e-01; -4.750840554987469e-01   -6.330550711290740e-02   +9.317954170670195e-02   -7.128876668214521e-03   +1.449915686135225e-01   -3.283575539025969e-01   +7.563718927728588e-01   -4.803583970204769e-01   +4.102836612921453e-01; +7.464845031980513e-01   -1.688012004591789e-01   +3.473811035308604e-01   +9.956237856379778e-02   +1.442091369026781e-01   -1.769477491189492e-02   -2.884110334226981e-01   +6.812559910674924e-02   +5.697417169489040e-01; +1.000000000000000e+00   -6.411699833057731e-02   -4.301152548480441e-01   +5.195590763995233e-01   +1.826110221224385e-01   +4.723379338225375e-01   +4.837851043080790e-02   +1.727332002561984e-01   -5.465202031022449e-02; -3.591749813461525e-02   +2.189512061164665e-01   +3.497904688900636e-03   +4.082699652364411e-01   +2.327553048078347e-01   +3.171273883930384e-01   +5.253039365639385e-01   -3.601755399351773e-01   -2.047153927685176e-01];
L2_L5_iAMPA_netcon = [+8.684782965530055e-01   +1.874401739176845e-01   -3.092002680846544e-01   +3.990997376490131e-01   -2.529621269102040e-01   -2.877901375848274e-01   -7.510864304788156e-02   -6.331456192898357e-01   +1.908656397579809e-01; -2.499894154027888e-01   -1.121939283122083e-01   -3.275264838986497e-01   +6.350984069634170e-01   +2.339651048835625e-01   -2.534697639705831e-01   -1.062291465746018e-01   -6.293014605096650e-02   +3.777305943681663e-01; +5.643773629259192e-01   -4.910879009316483e-01   -2.594392693383352e-02   +5.921717657341362e-01   +8.456873273720689e-02   +1.324404281661069e-01   +3.359292994910312e-01   -3.161072319668969e-01   +4.014521804610426e-01; +4.612952730515466e-02   +3.581759214088410e-01   +9.939852820760386e-02   -3.079849414164342e-01   +1.915920600554747e-01   +4.076824630664744e-01   -1.773697944200228e-01   +2.137629497025800e-01   +1.697710856495142e-01; -2.536608603729162e-01   +4.869611691573554e-01   -5.906033618216889e-01   -3.701555321665042e-01   -2.940060028034065e-01   -5.102246458085817e-01   +2.910317220812525e-01   +5.927490836940630e-01   +2.258299588197183e-01; +3.463571524377960e-01   +3.343939341044230e-01   -1.239936537167200e-01   +2.993645604259071e-01   +1.401859057329479e-01   +2.600362917500642e-01   +3.014051739848511e-02   -1.776551563438176e-01   +2.963769193671258e-01];
L5_L2_iGABA_netcon = [-1.389347891999505e-01   -3.064164301632416e-01   +4.678331305604588e-01   +5.010093007426811e-02   -1.802134118592394e-01   +4.147658089953724e-01; -5.613244446567240e-02   +2.073302509086251e-01   -1.828727184309570e-01   +2.225523090102134e-01   -4.436080749958121e-01   -4.204484948941019e-01; +2.039574570502443e-01   +2.585004014291943e-02   +4.055575670662384e-01   +3.174111671352386e-01   -1.135355231390977e-01   -4.436326021740415e-04; -1.916378578312440e-01   +1.727212184006568e-01   -5.374806583990316e-02   -4.073298767491484e-01   -1.973777720269080e-02   -3.634262190658558e-01; +2.939146253921162e-01   -5.346504263888301e-01   +3.928982584259486e-01   -6.685234192030349e-01   +2.088244374805316e-01   +5.655821375086266e-01; +4.462823093057008e-01   -8.321286561490025e-02   -3.899668611171771e-01   +2.093706861717675e-01   +3.831460477625457e-01   +2.873387433533266e-01; -2.705658481537800e-01   +3.999612904460669e-01   +6.147909739826221e-01   +1.000000000000000e+00   -6.220716837033655e-01   -1.772919257672683e-02; +3.723949622047332e-01   +2.854762669292820e-01   +1.410772070837336e-01   -4.400969288482209e-01   +4.779609324666599e-02   +8.486213512646495e-02; +1.399491295795295e-01   -4.667729974551258e-02   -5.624803615541804e-01   +1.465634657674292e-01   +4.896921511959323e-01   +2.153706912070373e-01];
L3_L2_iAMPA_netcon = [+2.336869047269738e-01   -4.608396874436148e-01   +1.414388339701935e-01   +4.911107709103786e-01   -4.185059704546308e-01   +4.314155473018344e-02; +5.619447441532882e-02   -3.371661889607808e-02   -8.188999032734529e-02   +4.821056859549910e-01   +2.991292018121313e-02   -2.951542738365259e-01; +4.615293706722813e-01   +6.659629103356141e-01   +2.669892812314043e-01   +5.449296982605302e-02   -3.504863875558612e-01   +2.625940343809592e-01; -7.917901009661260e-02   +1.090249959644859e-01   -4.880525962378884e-01   -1.755990057996955e-01   +8.621158546574876e-01   -1.177587100727369e-01; +1.713951039663240e-01   +2.118328784952877e-01   +7.808792967633410e-02   +1.570322061651628e-01   +1.221347395312294e-01   +1.260887976151908e-01; +5.876505450176415e-01   -3.050048771739942e-01   +7.335881570265952e-01   +2.956951943568281e-01   -2.030238690937520e-01   -9.101712377420319e-02; -3.594601632741304e-01   -4.534977685821704e-01   +3.948247907491065e-02   -1.816946040862971e-01   +2.450494177297319e-01   -2.689686944259003e-01; -1.964404423586981e-01   +7.471219410214570e-01   -1.543161178283800e-02   +9.768543670797114e-02   -1.201398681530123e-03   +3.459178632683000e-01; +8.746178921014156e-02   +3.357908450947514e-01   +4.558387047075750e-01   -3.660970046928251e-01   -1.967416293360164e-01   +2.974167646762980e-01];
L2_L3_iGABA_netcon = [-5.297067211103629e-02   +1.367774577630695e-01   -6.562343682665057e-02   -1.727657102776062e-01   +1.606182870235480e-01   +9.947900094232337e-02   +1.486087900692454e-01   -1.130119812508775e-01   -5.144764764746763e-01; -2.550405327931286e-01   +4.451964743752973e-01   +8.082230078753594e-02   +4.326939906618438e-01   -3.700744775521424e-01   +6.325112969911684e-02   +2.403229736595414e-01   -2.202058228067520e-01   +2.536331491432746e-01; -4.894859168150940e-01   -1.287845627340385e-01   -1.188360096217688e-01   +3.464517458301760e-01   -5.988234987356603e-01   +1.875241946546870e-01   +4.644910900691359e-01   +5.985703296225643e-01   +5.259874626994756e-02; -2.637131167666245e-01   +2.322766346728309e-01   -4.454783657768641e-01   -4.146628288832073e-02   +3.060663590062088e-01   +8.326954757411271e-01   -2.632923938435570e-01   -6.099191084693420e-02   +6.069566300974290e-01; +2.883035362814320e-01   +1.042290935926529e-01   +1.982284362163208e-01   -3.005088053201604e-01   +3.535298981537928e-01   +1.112493596248817e-01   -2.932982273839047e-02   -7.331539653292936e-02   +1.956190048581112e-01; +5.227144014435638e-01   -6.717849600962172e-01   +3.200163490186664e-01   +1.465772449110420e-02   -5.880133158181025e-01   -4.998850264058379e-01   +1.261716926152751e-01   -3.886890259522573e-01   -2.784521383387835e-01];
L1_L4_iGABA_netcon = [-3.820952778752045e-01   +2.129222992091394e-01   -5.435385378100019e-01   +1.479401377187020e-01   -3.632643646728114e-01   +2.460784028565455e-02   -1.615255493516585e-03   +2.533387376431751e-01   -3.836120522486128e-01; -1.854015257826460e-01   +7.223127398223672e-01   +1.248051477909030e-01   +5.255589322334999e-01   +1.653421060642761e-01   +5.480813392550481e-01   -1.584206144328540e-01   +4.341609058389562e-02   -5.459655324710222e-02; +1.993753439614926e-01   -2.403487749609383e-02   -2.166566156190572e-01   +1.484082248939188e-01   +2.952834810284225e-01   +7.054879144669185e-02   -5.388331426292025e-01   +5.945273359007772e-01   +6.299823934520236e-01; +3.542272008070080e-02   +1.677025026966436e-02   -2.008225783411268e-01   +5.178136692663067e-01   -1.462068698684940e-01   -1.185070141502120e-02   -5.220245850478765e-01   +2.892959450199272e-01   -2.658389489830553e-01; +2.636553858660389e-01   -1.798436013988348e-01   +3.673739820905982e-01   +4.521699031621570e-02   +5.489766960462388e-01   -4.212031606225854e-01   +5.681986266310787e-01   -1.061599777044273e-01   +1.708598267970557e-01; -4.893756776138194e-01   +3.151268463760891e-01   +2.569480785894175e-01   -2.705089447997295e-01   -5.474198565088599e-02   +2.489267982578626e-01   -2.027030274440764e-01   -3.978740608034072e-01   -2.488319201102708e-01; +2.652630815441334e-01   -4.708976271657412e-01   -6.659091221201005e-02   +2.263320356423101e-01   +1.441517604339878e-01   -3.838284802660409e-01   +3.707930728156655e-02   +3.550016980269802e-01   -3.996000637134478e-01; -5.079200913725741e-02   -2.813398713507688e-01   -8.098621862487274e-02   -6.439359549107332e-01   -3.339488432797675e-01   +8.967598047253067e-02   +4.015822390267964e-01   +3.976422935772959e-01   +5.536176249978028e-02; -6.007148497544390e-01   +1.626648740640219e-02   +4.622885674730989e-01   +5.083432186184059e-01   -2.817563929245952e-01   +5.025581854473259e-01   +3.440717862628702e-01   +5.964498774423135e-02   +3.803935911691649e-02; -2.603244510779145e-01   +2.181171013292168e-01   +4.520916135380243e-02   -6.597048969420474e-02   -8.522897693706117e-01   -5.350784688865980e-01   -1.216749931192223e-01   +9.161242806520392e-03   -1.324572712646623e-01; +7.755482658920337e-01   +2.480761731366094e-01   -1.915540742399935e-01   +9.141063656790660e-02   +2.062844523231404e-01   +9.558488034422215e-01   +6.986416635824718e-01   -7.020643769617837e-01   -4.558774516591430e-01; +1.049398703818050e-01   -9.006466952070796e-02   +2.454046554362974e-01   +1.788947558742800e-01   +6.794944816548995e-02   -2.920459656522982e-01   +2.946425082876388e-01   +4.570202824783977e-01   -5.440798820680769e-01];
L4_L1_iGABA_netcon = [+4.996500705066177e-01   +5.565348351250941e-01   +2.299583411538487e-01   +4.349830758487891e-01   -4.663436035723608e-01   -9.614929120424860e-01   -3.481893883505679e-01   -3.408338332067670e-01   -1.329184916582583e-01   -4.328818584713412e-02   -1.590642118205071e-02   +3.848347400098805e-01; -2.414705287690973e-01   -7.440354189255864e-02   -4.329566654191144e-01   +1.072895651307326e-01   +5.535331245981816e-01   +6.812265838551774e-01   +2.047210960118774e-01   -2.322905984573784e-02   -7.973042846836875e-01   -1.239219557680603e-01   +4.148008204919241e-01   +4.747045095372331e-02; +2.071125707266337e-01   -4.772605533690324e-01   +6.148146189953069e-02   -2.254873413232232e-01   +2.202886259047988e-01   -1.090987717693675e-01   -1.159487552444357e-01   -2.192704127362881e-01   -3.458944247324798e-01   -3.984996136157594e-01   +4.977292940236217e-01   -4.003456522788819e-01; +3.190767776694932e-01   +4.844475336924731e-02   +3.911885157359024e-01   +5.735901735741806e-01   +7.180302141201415e-01   -1.598943518352315e-01   +1.880902630791287e-01   +2.153803316264180e-01   +3.963869312595245e-01   -3.748266700557774e-01   +1.698616674497666e-01   -1.170412591505681e-01; +4.906297252375264e-01   +2.559275572436069e-01   -3.196174164241116e-01   +3.532891622530643e-01   -1.367900509970416e-01   -1.130695197131354e-01   +6.132112560011679e-02   +3.212799927695076e-03   +5.049709153837644e-01   -1.878973678045738e-01   +2.655956650574361e-01   -5.556024120047243e-03; -1.068839103472006e-01   +8.317016839905664e-01   +3.261956558993377e-01   -8.809690081014518e-02   +4.542980635263659e-01   +5.467803099305898e-02   -9.320617435718057e-02   -8.105783379374130e-01   +5.903776509435537e-01   +3.304574103073138e-03   +9.619367387178689e-02   +2.118564772380125e-01; +4.180961146739691e-01   -2.388404631366720e-03   -8.059938060289176e-02   -2.905278757650298e-01   -1.512115011928041e-01   +1.543268348479466e-01   +3.312080080183823e-01   +4.928804685372387e-01   +1.316027282972054e-01   +2.936977693113256e-01   +7.858715417225002e-01   -2.337607277671241e-01; -9.145920685462938e-02   -6.536760349505893e-02   +4.044982639774979e-01   -2.253814667663788e-01   +8.488865739038919e-01   -7.097159238938473e-01   -5.491646689218905e-01   +5.389229803345962e-01   +1.990706412232957e-01   -7.380857630531370e-01   -1.210092031050103e-01   -1.087562719553083e-02; -2.686792727778241e-01   -3.027054356147445e-01   -4.270257248872478e-01   +1.532175659499075e-01   +1.935418514599527e-01   -1.880998433486518e-02   +4.241275300650070e-01   +1.052017282158730e-01   -9.220438839737247e-02   +3.428192671586123e-01   +5.293136585846625e-02   +4.567317115297921e-01];
L1_L3_iAMPA_netcon = [-3.938358698932959e-01   -2.559246940702602e-01   -1.957407954726139e-01   -8.089937185468278e-02   +1.000000000000000e+00   +1.289579766130690e-01   +1.163129697940900e-01   -2.243983784884891e-01   -4.510304057199361e-01; +3.745074923650609e-01   +3.385046691776732e-01   +5.056116031876698e-01   -3.972591882800103e-01   -1.059833732830819e-01   +1.814851844869730e-01   +1.154784787979463e-02   -2.640647632050121e-02   -3.458481222316477e-01; -4.225084181671483e-01   +2.848746135807159e-01   -2.279072794755236e-02   +8.232938683729729e-02   +1.110587885971112e-01   +2.465250730984113e-01   -2.489340069086141e-01   -5.203346331296995e-01   -1.572348877253022e-01; +3.246312759666443e-01   +4.254142693338379e-01   -2.880684938980168e-01   +3.103496270775955e-02   -4.483509295341992e-01   +3.498538532790930e-01   -7.638539059623836e-02   -3.663184782669835e-01   +8.439764380082872e-02; -8.518164930933787e-02   -1.609006171768683e-01   +2.487622955303425e-01   +1.639135505353025e-01   +6.361111220944109e-02   -6.744966765700674e-01   -1.952827900026027e-01   +2.775035124091924e-01   +3.936451142027299e-01; +5.556285005326940e-01   -6.050352030946619e-02   -1.669729489066555e-02   +7.402931398541503e-02   +8.857692010399891e-02   -3.320384895058364e-01   -1.839674772024755e-01   +3.471081982541748e-01   +8.208487024268964e-02];
L3_L1_iGABA_netcon = [-1.490767178535343e-01   +2.642412883138411e-01   -5.602927046838173e-01   -9.293521577482033e-03   +7.733886632856091e-02   +4.132315722001213e-01; +9.709367837455557e-02   -4.523149811730573e-01   -6.460068707376831e-02   +2.738848796526522e-02   -3.930969864715156e-01   -1.108330356569228e-01; -6.444471972047218e-01   -8.095942586731984e-02   +2.090316916576529e-01   -3.116034655424199e-01   -5.033932372090999e-01   +2.222158294494284e-01; +1.033795367136525e-01   -4.435098434380127e-01   +3.991635456711327e-01   +2.789936364667785e-01   +2.777164396412699e-01   +3.293500674213287e-01; +7.657220905888594e-01   +1.492469968610829e-01   +1.753711357997899e-01   +4.614859056234731e-01   +4.830898484574661e-02   +3.320974472569670e-02; -1.579679574480080e-01   -7.890019966169587e-02   +1.885795402232653e-02   -1.000672233433697e-02   -6.316614971483178e-02   +2.086123797302685e-01; +5.677326152409925e-01   -3.148390650815809e-01   +5.528915746890328e-01   +2.440767618313955e-01   +2.125648721581391e-01   -1.021511466232994e-01; -5.183217244687943e-01   -4.667725569765999e-01   -1.043990348611537e-01   +1.819764034454187e-01   +2.275928961640288e-01   +4.402539209261447e-02; -2.323009003806479e-01   +5.481054987883609e-01   -3.814297580735251e-01   +3.530957586613853e-01   -1.499898481036542e-01   +3.347937320371768e-01];
L5_Input1_iAMPA_netcon = [-3.700129816672268e-01   -2.465671845681297e-01   -7.558472786909871e-03   +1.085043741040203e-01   +1.462362218478329e-01   +3.330713032519696e-02];
L6_Input2_iAMPA_netcon = [+4.396622109220868e-02   +4.654137095974195e-01   +5.084799819631482e-02   +6.319238154891931e-01   +1.196423402921991e-01   -1.731604303413572e-01];
L5_L6_iAMPA_netcon = [-1.159559358323135e-01   -1.330865110282963e-01   -2.180698663896028e-01   +6.653435945915899e-01   -3.355866344987408e-01   -2.014749089535336e-01; +7.867902004731353e-01   +6.723328721660067e-01   -4.262790704215170e-01   -4.999270965383677e-01   -1.683549800278276e-01   +4.002346606356358e-01; +7.191404207928815e-01   -2.655657925585245e-01   -2.064489331391423e-02   -4.924817538800960e-01   -2.291391526199308e-01   -2.838757432681065e-01; -1.520524462388084e-01   +1.626595655599771e-01   +4.014143008916615e-01   -1.446309382473772e-01   -3.187245455545590e-01   +5.878106514844412e-01; -2.128806453397880e-01   +4.846161134089965e-01   -2.915836853945892e-01   -3.118726521817050e-01   -1.901335873811327e-01   +8.795532428072296e-02; -3.719546113641768e-01   +2.823246374029453e-01   +7.747919378389857e-01   +3.422562211989593e-01   -5.236983689743491e-01   -7.840827312034553e-02];
L4_L5_iAMPA_netcon = [-5.408832762082956e-01   +1.907208886576338e-01   +5.200052042228137e-01   -3.959575882043633e-01   +1.221246719049277e-01   +2.400362825786255e-01   +7.289761938549291e-03   +9.477280359749141e-02   -2.338174802686252e-01   -3.466591968353424e-01   +4.589878635492980e-01   -3.090624300808701e-01; +2.197512934532447e-01   -3.196855635359347e-02   +5.728972095748421e-01   +5.916557797710313e-01   +5.507428670285391e-01   -2.118716335643102e-02   +1.158781050469485e-01   -1.799781701847567e-01   +1.903736789214761e-01   +5.460326744074319e-03   +2.928871274767973e-01   -2.179761360740001e-01; +1.000000000000000e+00   +1.652193366142955e-01   -1.686946829085501e-01   -4.640489375766026e-02   +5.736616025696358e-01   +4.259707058495394e-01   +5.471698932017033e-01   +8.662337562732671e-02   +8.334754557278154e-02   +4.612541748353598e-01   +4.851413772557263e-01   -2.824804572491637e-01; +8.631806664228639e-02   -2.569824799040853e-04   +2.002920811764497e-01   +6.889947103909348e-02   -1.948570973226288e-01   -5.616297729267414e-01   -1.123074242501269e-01   -2.242056510241619e-01   +3.535155138849233e-01   -5.953340461654814e-01   -7.949084251450675e-02   +2.799363149553716e-01; -2.327489987534286e-01   +6.695742710211006e-01   -5.262848482451945e-01   +8.184931514996229e-03   +2.068452932845536e-01   -8.365310525871453e-03   +4.903595427197378e-01   +9.305906790110091e-02   -1.165172985577493e-01   -2.514263602055457e-01   -1.761422376925087e-01   -1.191990470185544e-01; +3.289355980687326e-01   -6.874337182095422e-02   -2.854602718405755e-01   -1.962699883750560e-01   -1.115267421540487e-01   +1.151692051649708e-01   +2.065481330013553e-01   +1.835357909115500e-02   +4.710916538486954e-01   +6.080275929428612e-01   +1.966400670711030e-01   +3.535448503892005e-02];
L6_L4_iAMPA_netcon = [-4.909706281040189e-02   -2.097536390527501e-01   +3.957592415028884e-01   +5.359835139674081e-01   +2.312398520685343e-01   +1.232247385668400e-01; +3.578686178328460e-01   +5.946319747986850e-02   -3.019438099384202e-01   +1.856629676840355e-01   -5.815039727839626e-01   -3.165840570539786e-01; -8.244429174770429e-02   +2.242290779492445e-01   +4.852145481737656e-01   +5.825500044427590e-01   +1.690848367365805e-01   -2.220996471105946e-01; +6.133260294309731e-02   -2.127548633571757e-01   +1.623470500258563e-01   -4.141089581864871e-01   -7.232347385328836e-02   -3.499654810612735e-01; -1.136898331235763e-01   +6.163964672917654e-01   +3.682255403956528e-01   -2.103163182855854e-01   +2.937187912906441e-01   +1.523202589230588e-01; +7.702543802740700e-01   +1.741703510389020e-01   +9.091691416664448e-02   +4.451389170482734e-01   +2.577920759791494e-01   -7.218729804818746e-02; -1.765703337736341e-01   +1.883081509225898e-01   +1.315050057698456e-01   +1.312601177922807e-01   +4.570388877546520e-02   -2.933634175741123e-01; -4.383303212146920e-01   -6.847048489224576e-01   +3.351863470349107e-01   -2.050431578128863e-01   +9.001705820734537e-02   -3.507045536409868e-01; -1.623708750129680e-01   +4.954250457575849e-01   -1.097377810934774e-02   -6.636461005992699e-01   -4.838897987464972e-01   +1.779025982544342e-01; -6.486150055533801e-01   -3.781010983719049e-01   -1.439451775774306e-01   +3.135454749267844e-01   +4.747167326958999e-01   -2.865330422846097e-01; -5.044056459459582e-01   -1.252695128588766e-01   +6.478186459846594e-01   +3.147754603645668e-01   +5.385939726266715e-01   +1.102961764440287e-01; -4.787158282327355e-01   -5.822958202698167e-01   +1.624636067464241e-01   -1.658350664479864e-01   +1.363015137984957e-01   -7.465382851646816e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
