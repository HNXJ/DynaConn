function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.218778223597175e-01   +3.072445385421636e-01   -4.369471469772918e-02   +2.967474766900078e-01   -1.208998643133868e-02   -3.893580944087688e-02   -4.064485217837895e-01   +2.666634910128826e-01   +3.689633571314030e-02; +3.321157621075552e-01   +6.150151014789143e-02   -4.052476290264457e-01   +1.553501448622972e-01   -2.520201280377258e-01   -1.414260832252580e-01   +5.044919204242309e-01   -4.517264026364444e-01   +1.065241248593404e-01; -1.932394854388467e-01   -3.451439343054415e-01   -6.383932988829185e-01   -1.222704633692565e-01   +2.142677404219197e-01   +2.163703151425806e-01   +1.152767107197322e-01   +9.742307314910623e-01   -5.458325539464524e-01; -4.676373117513283e-02   -3.713784833946678e-01   -5.542465456088121e-02   +3.350898530342239e-01   +1.599837060390602e-01   -1.159835629523712e-01   +1.051694882675486e-01   +2.589775506552157e-01   +1.835214131337474e-01; -5.500758504142300e-01   +3.068105662772626e-01   -2.526950045164059e-01   -3.501794477327665e-01   +4.456883496471986e-01   -1.683937812328232e-01   -2.239369973812995e-01   +1.809071443291309e-01   +2.539033050362466e-01; +1.584578606239384e-02   -2.294930161160750e-01   +5.088436286382105e-01   +5.227031260973192e-01   -1.481434272990209e-01   +1.837839579385401e-01   -2.128379826592682e-01   -1.648687258092937e-02   +1.740101585942924e-02; -1.390291589445393e-01   +2.653841915794457e-01   +7.740789804199449e-02   +7.058639226410999e-01   +4.347143170614961e-01   -5.156677054147888e-01   -1.807409705641468e-01   +4.296963792381341e-01   +5.657009317432993e-02; -1.762641890209232e-02   +1.312479698505780e-02   +1.739809678414928e-01   +5.246045558138608e-01   +3.184900191583434e-01   +3.351185946413968e-01   +3.822461437360910e-01   +2.819987587777574e-01   -2.846925092723544e-01; +6.117231585212201e-01   -5.330746844644162e-01   +4.641345241480459e-02   +7.653404304152034e-01   +2.635820139589757e-01   -1.920447577765974e-01   +5.619614087483875e-01   +1.348883535555958e-01   +1.648312066424226e-01];
L1_L2_iAMPA_netcon = [+2.732312707898203e-01   -3.958495699008113e-01   -2.585932247118172e-01   +4.816949227375756e-01   +2.790344850931444e-01   +5.447505154456204e-01   +3.971446264990641e-02   -1.467917526452863e-01   +1.298905091161493e-01; -1.722484256838974e-01   -3.625904081166103e-01   +3.843557105856404e-02   +5.793525708388557e-01   -2.464611845472460e-01   +6.001338565380436e-01   +2.151720818559807e-01   +1.057437941607958e-01   -6.513280957164862e-02; +4.652556732016357e-01   +4.221444613535590e-01   +2.612942684633957e-01   +1.561097425234252e-01   -9.506692572032842e-02   +4.373139191933056e-01   -3.909502373889975e-02   -7.964538263176425e-02   -1.216862946890331e-01; +1.734173943776385e-01   +2.433904550317327e-01   -1.577880099769966e-01   +2.169589271207525e-02   +1.077692735448619e-01   -1.739102369416964e-01   +3.569432839552862e-01   +2.559341083131606e-02   +6.882848158063750e-01; +7.048259918356904e-01   -1.492070641574456e-01   -1.473401526955671e-01   -1.614490862773241e-01   -5.121819089633668e-01   -8.827837015165844e-02   +6.379863971138700e-02   -3.410651894406194e-01   +4.257857121376828e-01; +1.392928438190605e-01   +3.525886583769247e-01   +3.916998185755023e-01   +1.764952106500427e-01   +5.193118659211676e-01   -2.890921501126008e-01   -4.761872332376630e-01   +3.808165922838427e-02   -1.081533621240858e-01; -3.199053275864372e-01   +2.538058794993825e-01   +6.905528330877347e-02   +2.647217833494954e-02   -1.011871676608298e-01   +1.646655022250380e-01   -9.889990311840868e-02   +3.539961327704820e-01   +1.740511720475451e-01; +7.403274095130798e-01   +3.343836591643199e-01   +2.999581908230824e-01   +3.741683765657797e-01   +9.139792151183267e-02   -1.875921278117532e-01   -1.000000000000000e+00   +5.757990851400364e-01   +3.782727225753061e-01; -1.191496392895965e-01   +3.602394002792411e-01   +1.161302305046945e-01   +3.722449218307077e-01   +6.636997525552842e-02   -4.906385011271737e-01   -3.674231452016866e-04   -5.010871161688060e-02   -1.103152423419721e-01];
L2_L5_iAMPA_netcon = [-3.015548325151600e-01   +3.516261834641432e-01   +2.995087661032680e-01   +3.865511952793083e-01   -1.898386626511255e-01   +5.177866764366057e-01   +5.930436036578463e-01   +1.182884697123670e-01   +4.074214974727609e-01; +1.000185284135256e-01   +1.200904264663421e-01   -4.118613222989591e-01   -5.839073870454681e-03   +2.304195819009653e-01   -8.418961365500187e-02   +1.557623579454173e-01   +5.065154813362819e-01   +4.204642745637908e-02; +1.288742532916901e-01   +5.765801110400279e-01   +1.249881537779431e-02   +1.076906572941320e-01   -7.533451946398848e-01   +4.846456771413309e-01   +4.646181905413275e-01   +5.903829637304964e-02   +7.722319635530925e-01; +6.413505084464078e-01   +5.793986272071855e-01   +1.171906480582415e-01   +2.157163424667494e-01   -9.127887649278109e-02   -1.241291073863096e-02   +3.269599588917190e-01   +6.736435006387826e-01   +2.250766774920628e-02; +1.137550140049051e-01   +4.038528834098397e-01   +7.550719725658021e-01   +1.021819683425384e-01   -1.144578143976743e-02   +3.508393330590115e-02   +1.791079495204950e-01   -7.917722712383978e-01   -2.332711421917111e-01; +4.206937262730353e-01   +1.321844139066522e-02   +3.520386951398922e-01   -2.885527029792279e-04   -4.138935902017563e-01   +5.783090803621609e-01   +3.334073818986053e-01   -4.597420928269764e-02   -2.519228272068011e-01];
L5_L2_iGABA_netcon = [-1.375214377005940e-02   +2.815655560115740e-01   +4.098590510585515e-02   +2.135382790056066e-01   +1.866349494662665e-01   -2.021569822397873e-01; +4.876084763584592e-01   +6.157131566464984e-02   -2.722114392786194e-01   +3.924730088084786e-01   +4.918992439005557e-01   +6.916254123217590e-01; +6.391493377383892e-01   +5.551150049280552e-01   +6.901336914829330e-01   -2.909931847739664e-01   +7.055071352848230e-01   -3.514205132781907e-01; -7.868461844213661e-01   +1.321024917779808e-01   -5.010708746507028e-01   -3.698302237766495e-01   -1.396140592846030e-01   -5.124915134371655e-01; +3.067863319453409e-01   +4.092877566369463e-01   -1.620070653483255e-01   +5.150158760108121e-01   +8.045297848002531e-02   -1.382732455136191e-01; -4.304962369287757e-02   -1.906619012844931e-01   +2.231095091604690e-01   +3.930918993146569e-01   -6.093846792378788e-02   +2.838010480744335e-01; +7.730104190910027e-01   -3.126267712556751e-01   +4.693943927657328e-01   +4.446955531308288e-01   -2.163827762010818e-01   +1.727298432113166e-01; +9.189245268986257e-02   +1.532127067204085e-01   +4.168971657219444e-01   +4.341914536330592e-01   -4.348868534852073e-01   +5.789859208727672e-01; +4.118778320977282e-01   +2.570187183197039e-01   -3.641026558693025e-01   -4.180376913417435e-01   -3.058975910413847e-01   +5.680049282968122e-02];
L3_L2_iAMPA_netcon = [-2.186879570215894e-01   +2.938727636032312e-02   +4.127062107567763e-01   -2.333136943720473e-01   +2.311827315247555e-01   -3.339926930495726e-01; +3.385029653916545e-01   +6.399703169248602e-01   -2.011717392882680e-01   -2.261484925906015e-01   +9.445426063136789e-02   -1.541159376770623e-01; +6.109927802052426e-01   +3.131131983712723e-01   -1.885276110297149e-02   -1.181115937390245e-02   -2.659225897847128e-01   +7.544597094150562e-02; +4.564307878871378e-01   -4.062083241818707e-01   -2.557394219139650e-01   -4.373222173239655e-01   +8.679822459284035e-01   +2.611762027743000e-01; +2.914490072863307e-01   +2.403412671832703e-01   +2.622776684255074e-01   +4.483532299401225e-01   +6.787948316171868e-01   +2.960226162466920e-01; -2.296765534531238e-01   +2.046540843131896e-01   +8.885916345154506e-01   +1.354209019938193e-01   +1.481855473092714e-01   -7.340993294350183e-01; +9.404549832112927e-01   +1.326311234820365e-01   +1.448235030318740e-01   +4.721369457892631e-01   -4.115011622148457e-01   +4.445178517996452e-03; -4.392483101935972e-01   -1.736108368133485e-01   +3.850418123132033e-01   +6.975514229206943e-01   +1.215743582413379e-01   +1.268896282540098e-01; +7.241482912192613e-01   +1.350456898375795e-01   -4.607396728137791e-01   +3.839947299930427e-01   +2.550150534180659e-01   -4.006863744652119e-01];
L2_L3_iGABA_netcon = [+5.583686421459102e-01   +2.304782064279123e-01   +3.249196949449530e-01   +5.246685162717160e-02   +6.817122359110975e-01   -4.814752591882140e-01   +2.913604389443083e-01   -6.143799081853633e-01   +6.981676448758307e-01; -2.825184190127994e-01   +4.455457097967562e-01   +6.911127110087929e-02   +4.592378995756012e-01   +9.946963941336801e-01   +1.975645592523184e-01   +1.811468198408729e-01   +5.704495580626143e-01   -1.440631016389080e-01; +1.920791293036984e-01   -4.769641317634480e-01   +1.698760103210360e-01   -1.913627030461040e-02   +1.245227933869777e-01   -4.046734144299443e-01   +2.144386800471574e-01   +3.718724370110886e-01   +6.846996184857754e-01; +4.334389881288433e-01   -2.284165555389213e-01   +7.155958763993840e-01   -2.744576234459951e-02   +4.989732411020423e-01   -2.444161132415683e-01   -2.544554253123019e-01   +2.129488856035344e-01   +1.086331052955012e-01; +4.494692877379941e-01   +5.330168459554302e-01   +3.889410216739557e-01   -5.979291941569337e-02   +1.586168258879967e-01   -3.820532198093654e-01   +7.628010799315885e-02   +1.223810313549730e-01   -2.079257971732991e-01; +6.374849600374697e-01   -3.182252515687298e-01   +5.675366818109707e-01   +3.412991728685886e-01   +7.506782357106617e-01   +3.483413845613866e-01   -1.906858987236498e-01   +3.835135365096599e-01   +7.885513772621257e-02];
L1_L4_iGABA_netcon = [-2.504449724980219e-01   +4.036706530456036e-01   -1.553197424789018e-01   +3.619253831565277e-01   -8.974630049141573e-02   +4.455608801500490e-01   +7.651477904553949e-01   -3.986432022491485e-02   +7.486186211858918e-01; -3.833527839642459e-01   +4.127199242365675e-02   +2.175095803413063e-01   +3.140980646068891e-01   -5.001743189430565e-01   -6.227557698371249e-02   +1.643557948881521e-01   -5.252659954793733e-02   +3.573849671570800e-01; -4.132640783435720e-03   -4.408898695486837e-01   -1.751786316140667e-01   -2.153314838920003e-01   +2.584166715879159e-01   +1.202064687936152e-01   +4.466595222965388e-02   +4.316469591804273e-01   +2.641878043112695e-01; -3.542402725348024e-03   +1.873469218114426e-01   -5.714388552571774e-01   -1.179332236811632e-01   +5.977720771207949e-02   +2.999146817952290e-01   +2.807851028676938e-01   +1.906976287558571e-01   +1.089367168625075e-02; -1.846759128427519e-02   -4.822559958844572e-01   +1.178906371698902e-01   +6.352412432459480e-01   +9.787036066231257e-02   -2.649895263569065e-01   +5.143346123795265e-01   +7.612793305379019e-02   -2.131765083981841e-01; -2.034909529868695e-01   -4.633320006653761e-02   +1.007856508685541e-01   +6.666754322401885e-02   +3.532467718928959e-01   -2.115115816886665e-01   -1.180801341307389e-01   +3.954092144107944e-01   +9.027564086151808e-01; +2.511167269818052e-01   +1.000000000000000e+00   -4.151844272099675e-01   +3.899644930697567e-01   +1.460249246773428e-01   +1.657606682923917e-01   +1.895559772074948e-01   +9.571584967828706e-01   +1.424291444698560e-01; -3.238758923603011e-01   +2.121738497186387e-02   +1.937291707648800e-01   +1.460269586979407e-01   -4.355911227984579e-01   +7.112538283487402e-01   +7.144607540942383e-01   +3.998769245737855e-01   -3.222209844898153e-01; -8.474098112719573e-02   +4.806937792215278e-01   -5.183476415901810e-01   +3.105518244108197e-02   -7.098665121658000e-01   -9.596931139505906e-02   +2.330763329301800e-02   +3.910184710606917e-01   +3.180601519848812e-01; +7.747468171213749e-02   +5.303610555366676e-01   +2.660070336772673e-01   -7.288144303374686e-01   +5.316023717589842e-01   +5.157334840537855e-01   +4.871846054680457e-01   +1.486127887926034e-01   +3.896934893615130e-01; +6.434831394574119e-01   +4.465445237958056e-03   +5.477860036650202e-02   -8.898154709270208e-02   +3.339272245442415e-01   -1.840875906401888e-01   -3.392554432240316e-01   -3.417792003040170e-02   +2.741883743251884e-01; +1.354894447895835e-01   -2.052116189764099e-01   -2.472007372763892e-01   -1.645093495760817e-01   +1.320788397218659e-01   -4.555825945066820e-01   +2.867612519204660e-01   +4.032875399121478e-01   -1.752442625336222e-02];
L4_L1_iAMPA_netcon = [-1.822118571523873e-01   -5.678408189111641e-01   +1.401322889262296e-01   +4.150426554783265e-01   +5.604733009625642e-01   +4.160124072508126e-01   +4.444915730656201e-02   +1.504224256019222e-01   +2.623258555435271e-01   +3.784611112354451e-02   -2.001031799074500e-01   +2.049480354436287e-01; +1.706529521922381e-01   -4.093675092765053e-01   +2.820694607283242e-01   +2.391719332817653e-01   +2.216074811959780e-01   -7.206814424753580e-02   +4.805383311561487e-01   -8.383548600022739e-02   +7.456629527575118e-02   +4.704529553854048e-02   +4.004916207430175e-01   +1.695922325638144e-01; -6.625509614146313e-02   -4.240704669047117e-01   +5.629218032470590e-02   +7.755955106551857e-01   -1.454884845829058e-01   -3.526909231471388e-01   +3.182122063544626e-01   -1.924182622551757e-02   +2.079321447649333e-01   +6.463438977826519e-02   -3.815500843000446e-01   +2.701188690842575e-01; +3.192498047584424e-01   +7.704529553836501e-02   -2.461691121163254e-02   +6.415642638879456e-01   +1.758294517743474e-01   +8.318272622374533e-01   -2.305705454217939e-01   +1.846291004198268e-01   +3.375292352874869e-01   +1.787396335676406e-01   +2.858872084328108e-01   -2.627746252540403e-01; -1.731354646292638e-01   +3.605009655287887e-01   +3.155527863114059e-01   +6.188289107636067e-01   -4.394503472870843e-01   +5.043695043153448e-01   +8.391847886206241e-02   +3.902035408699508e-01   -4.166621634655649e-01   +6.601446863504339e-01   +3.906087268236215e-01   +6.744135663200357e-01; +1.982810264092968e-01   +3.838827823560708e-01   -3.081773165330667e-01   +1.128808206930438e-01   +1.361264109686609e-01   +2.792776905623998e-01   +4.826434790046947e-01   +6.445666386864637e-02   -4.310731477586474e-01   +1.120049652904507e-01   +5.380344307211480e-01   -2.076704871435260e-01; -5.885297766530342e-01   +3.505197523479789e-01   -2.610633102876757e-02   -1.467193037408575e-01   +3.945897120599443e-01   -2.508536994793521e-01   -2.583098092436953e-03   +5.979148645749846e-01   -4.999475647040185e-01   +7.534807081782524e-02   +7.363494534018127e-01   +7.696623936715893e-01; +3.217327336345599e-01   +1.060906554000235e-01   +5.240864662539717e-01   -2.222725589001473e-01   +3.522905854020064e-01   -3.691939073986442e-01   +6.592231463446208e-02   -1.531921615632095e-01   -5.498022697080718e-02   -8.163405893487058e-02   -2.809576910282242e-01   -2.507902610990109e-01; +4.047500174573184e-01   +1.026863545222193e-01   +2.233943270387389e-01   +6.326466496776805e-01   +7.131584526087781e-02   -1.697393638803419e-01   +3.005354433955565e-01   +1.810972899241221e-01   +2.082407619964039e-01   +2.055045986432106e-01   -3.870912183677687e-01   -3.054065378878915e-01];
L1_L3_iAMPA_netcon = [+3.835581505490531e-01   +5.302099810456080e-01   +3.498866136102474e-01   +2.500612934473887e-01   +5.388363948245383e-01   +5.286072933008578e-01   +4.313273323855453e-01   +2.453677160291856e-01   -5.330167123430629e-02; +7.728865160459284e-01   +6.392953885956135e-02   +9.113403634773043e-01   -3.565404749190965e-01   +4.360342056572981e-02   -3.674068655711404e-01   +5.476995715622706e-01   +1.429086081407843e-02   +2.201173099661050e-02; -2.892538937561130e-02   -6.570866871712833e-02   +2.928013241040081e-01   +2.011249540699324e-01   +1.815601719702150e-01   -2.657364067558742e-01   -8.701506466781303e-02   +4.047716349059565e-01   +3.070441701754136e-01; -2.180728053467774e-01   -3.260036767043073e-01   +1.251356540975269e-01   +5.372295612651665e-01   -6.518184292829787e-02   -6.624741083073291e-02   -7.013110933714298e-02   +3.312480407927711e-01   -1.512506943959018e-01; +7.537158338767238e-01   +5.774606520977983e-01   -4.124680743545744e-03   -1.096632422351363e-01   -5.062000180444051e-01   +2.808044940340315e-04   -2.196242236550927e-01   +2.494223552891680e-01   +2.706525216418085e-01; +9.751216371667553e-01   +3.797223495093681e-02   +4.484831326087801e-01   -1.114807055946986e-01   +7.343029445665845e-01   +1.296110750869517e-02   +9.325402620312740e-01   +8.455031727335146e-01   +4.243660859545498e-01];
L3_L1_iGABA_netcon = [+3.026768849177445e-01   -1.043427075031805e-01   +1.672411151061065e-02   +2.522483327650558e-01   +3.278718195566509e-02   -8.281442651128195e-01; -1.184866429337343e-01   +1.111202971563146e-01   -3.051882900012565e-01   -6.320546766584543e-01   -7.658027797162581e-02   +2.179043428855501e-01; +3.059344451323965e-01   +4.163087960471273e-01   -1.560030453692605e-02   -4.681652316942980e-01   +4.223659679066439e-01   +2.522395575266621e-01; +4.495210697207641e-02   +2.545884630308174e-01   -2.099222537645596e-01   -9.414029839772747e-02   +1.446642249984067e-01   +5.295464831690593e-01; +4.655158368819904e-01   -6.068638940611421e-02   +5.737440597943988e-01   -1.548838723965006e-01   +3.049005490520978e-01   +4.924616171698260e-01; +1.695956384958345e-01   -3.898076628082392e-03   -2.842219768845501e-01   +3.311685948975087e-01   -3.804970438690813e-01   +2.528926003899433e-01; -1.585950757153642e-01   -1.881506330593602e-01   +5.217668356434945e-01   +4.469440295674222e-01   -2.275065068338573e-01   -3.969821122285808e-01; -4.363213216672618e-02   -7.185402659065791e-02   +3.804636804150267e-01   -8.556853737436179e-02   -6.392073445983714e-01   +2.419439478571712e-02; +2.732891566802071e-01   -1.153030823359895e-01   +2.973610851213607e-01   +3.539469264339382e-01   -3.149183391766506e-01   -6.475076249577016e-02];
L5_Input1_iAMPA_netcon = [-2.362548908428698e-01   -2.011293579762261e-01   -2.492336093949931e-01   +2.289816904030593e-01   +2.005102791693060e-01   -4.878902553143855e-01];
L6_Input2_iAMPA_netcon = [+4.175055788346980e-01   +8.741669379141706e-02   -2.868359047356720e-01   +4.891870221599771e-01   -3.413270130681543e-01   +1.401314870792184e-01];
L5_L6_iAMPA_netcon = [+5.479772962504482e-01   +5.323996753728691e-01   +7.387563649641846e-02   -1.635448297939862e-01   -6.325353377303977e-02   +5.720270729085325e-01; -1.972599221688026e-01   +1.423468919475734e-01   +7.708044152073839e-01   +5.712324882610066e-01   +7.026233501517110e-01   -5.262145366566683e-01; +1.901212918921427e-01   +1.180825914295616e-01   +2.346971804250025e-01   +4.120180436861950e-01   +1.000000000000000e+00   +2.697452506735044e-03; +7.001585740862851e-02   +3.265074028415942e-01   +5.953015198763740e-01   -2.368650334921693e-01   -1.130925810661949e-01   +4.589683557253100e-01; +7.052564625658455e-01   -2.921283749743058e-01   -6.512520293707341e-02   +8.104122110947131e-01   -4.778557994558979e-01   +7.934361044564639e-02; +8.395107778407204e-02   +1.369602921339496e-01   +4.298241737164663e-02   +4.218108554765950e-01   -2.753427590162228e-01   +2.606334348009759e-02];
L4_L5_iGABA_netcon = [-3.483653437923996e-01   +5.479948984703753e-01   +3.374244145432743e-01   +1.023914101304405e-01   -4.107960204362793e-02   +8.078539334410946e-01   -4.603952380648052e-02   +1.810309898967815e-01   +4.312342055494649e-01   +5.560065938814650e-01   +8.037143509242781e-02   +1.372423926168789e-01; +6.467588617335668e-01   +6.556657526274572e-01   +6.569839700940870e-01   +3.103874747380754e-01   +3.245527003486223e-01   +2.675509650593254e-01   +2.467949825286967e-01   -4.060265308464075e-01   -3.842118174199884e-01   +7.148940798817255e-02   +9.273755876054441e-01   +9.555239939052587e-02; +1.389732789379348e-01   +3.485159940918728e-01   +4.337454659947729e-01   +5.952084761052939e-03   -3.408535345990071e-02   +5.990803458055209e-01   +2.335112480380777e-01   +9.002542704138519e-01   +5.336172550728802e-01   +5.474966668559768e-02   -2.744902658786921e-01   +1.969079153633807e-01; -1.604339522640106e-01   +3.163790990982544e-01   +4.285021393357580e-01   +6.842220551624850e-02   +2.814199860332545e-02   +1.629296782852193e-01   -1.412331280895865e-01   +4.126661051013322e-01   +7.138052389476104e-02   +6.549338031554472e-01   +5.916964198263762e-01   -2.069673981915781e-01; +9.073218462554791e-02   +1.029958596525191e-01   +2.468730959843018e-01   -1.769901762299678e-02   +9.008101605337671e-02   +4.286079917463881e-02   -2.283493851812912e-02   +5.278673938968768e-01   -3.260145399485820e-02   +1.069125202860292e-01   +2.694397798965230e-01   -9.612576903002948e-02; +4.044718005344130e-01   +3.469096315753922e-01   -1.341853621260062e-01   -8.527431317216303e-01   +3.553573609731177e-01   +1.776289191655000e-01   +7.534840669724427e-02   +7.123847878852431e-01   +1.632624717711287e-01   +2.527414262300737e-02   +7.255849317388390e-01   +1.491828849213462e-01];
L6_L4_iAMPA_netcon = [+4.874018918668066e-02   -5.466359865864860e-01   -3.192590770082034e-01   +3.339181655661051e-01   +3.435928239814484e-01   -2.777622861479820e-02; +6.604016177757618e-02   -1.679649070620750e-02   -2.723987386291569e-01   +2.587161717000024e-01   +5.012781331998567e-01   +6.099228619946805e-01; +1.987176046447732e-01   +6.855690082585963e-03   -1.338295040848586e-01   -1.299682432469683e-01   -3.959011901394676e-01   -2.245678845729793e-01; +1.132866562214308e-01   -4.128709430694517e-01   +1.344946545183734e-01   -1.655232719582706e-01   -4.621883957943965e-01   +8.100549343835538e-01; -1.572766069149034e-02   +1.553809165733217e-01   +5.219089076161559e-02   +3.711164909840975e-01   +5.531604800195805e-02   -7.662166042338089e-02; -4.118704642336833e-01   +3.784404218384538e-01   +5.165634662428906e-01   +1.491403426273495e-01   -4.508425896709342e-01   -4.791633242440038e-01; +2.352506816391541e-01   -2.354334109916726e-01   -3.065179085239693e-01   +2.839149498952003e-01   -4.509203469443895e-01   +5.231240889153580e-01; +3.145675847201318e-01   +2.220322415967093e-01   +2.977214872824524e-01   +4.828618940626779e-01   -5.871612565916465e-03   -1.287861587753920e-01; +2.830393636171111e-01   -1.335637916624691e-01   +4.289220719723793e-01   +4.998119686484139e-01   -2.108152682226117e-01   +3.294660131878367e-01; +9.366251402119491e-02   -3.317486996599179e-01   -4.242324744308124e-02   +6.252721685005168e-03   +1.670430281997363e-01   -2.323115603826655e-01; +7.104833762990638e-01   +1.364878636328303e-01   +2.135461004904138e-01   +2.276834205068052e-01   +4.912096622506938e-01   +3.289125285780999e-01; +6.344936747179389e-01   -3.883768788340352e-01   +5.078312510650984e-01   -2.643325562332259e-01   +2.391892697913022e-01   +2.700957467825960e-01];
L5_L4_iAMPA_netcon = [+2.104074911061309e-01   -2.285638298731684e-01   -3.527748450071106e-01   -1.922738793172636e-01   +5.281406054264556e-01   +8.163561447411127e-02; +1.893604748762130e-01   -3.794278580097807e-02   -1.435469221180011e-02   -4.166745430192664e-01   +4.252214748950138e-01   +2.129686419343927e-01; +1.658133204900080e-01   +1.791613771782262e-01   +2.723168488845434e-01   +2.999871260844458e-01   -5.727132847237859e-01   -2.126443639542486e-02; +1.806405165133262e-01   -1.087123597275684e-01   -3.141525615322421e-01   +2.811027858884595e-01   +1.844880805152181e-01   -9.234874456784811e-02; +2.823143369701562e-01   +4.167193729335624e-01   +5.454940150049611e-01   -4.292654748416992e-01   -5.933354680737953e-01   -5.276717130860553e-01; +2.264469854998795e-01   +1.726414217321882e-01   +6.673552960921453e-01   +6.422487277667760e-02   -4.993774570409424e-01   +5.808480874769351e-02; +1.092856592400206e-01   +6.522097458529188e-01   +3.136347027098555e-01   +1.135521878521976e-01   -1.650813672601391e-01   -5.505976411570714e-02; -4.291817014474943e-01   +5.667650637374495e-01   +1.119069602534796e-01   +3.547605415329939e-01   -3.483804156476957e-01   +7.198471357504423e-01; +5.179892823789560e-01   +9.843583841459299e-01   -6.421661525401263e-01   -1.166350281525156e-01   -2.516434981553879e-01   -1.516511195455100e-01; +4.651503784020825e-01   +1.321933741566937e-01   +7.624555062960725e-02   -5.340119638524656e-01   -6.719691813323225e-02   -3.464129675735381e-01; +8.983096062745005e-02   -2.072598761355820e-01   +1.558997395661754e-01   -3.016963780790471e-03   +1.166184410316104e-02   -3.176005005411817e-01; +1.278657151407392e-01   +1.042676478610135e-01   +2.519309608363938e-01   +2.561127401621327e-01   -2.650639866891426e-01   +7.386200606628019e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
