function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.525506173651410e-02   -1.215121958447081e-02   +1.677938633063941e-02   -1.708356609542815e-02   -3.010359629841612e-02   -6.566729905612546e-02   -2.137697242168630e-02   -1.468109227618961e-02   +2.932474206380364e-02; +2.138742521880357e-02   -1.924550155200901e-02   +1.793726056469568e-02   +8.269700672639585e-02   -4.018995804285982e-02   +4.475955422327468e-03   +3.390353120126704e-02   +2.457706470679279e-02   +5.010826310560770e-02; +4.859866842898479e-02   -1.433351539584936e-02   -3.781484257467603e-02   +1.117882194812809e-02   +1.018644451367676e-02   +4.877989351986540e-02   +2.744053651294370e-02   -6.179764082358105e-02   +6.843561563608902e-02; -8.374386871758122e-05   -3.644870746902677e-02   -6.797928612717117e-03   +6.480401259707244e-02   +3.875387331192374e-02   -3.340273274134295e-02   -1.214139198087581e-02   -1.944233137252432e-02   +5.270617092312295e-02; -2.524084794148653e-02   -2.389029726010141e-02   -2.732547681610239e-02   +5.319276517728191e-02   +2.043984831908643e-02   -8.752176189535700e-02   +1.642439273338007e-02   -2.869124644985347e-02   -3.640014704341955e-02; -4.558138546308448e-02   +1.050739232646334e-02   -4.966348767600639e-02   -3.502498587859931e-02   -1.076372273134722e-02   -4.991757145795719e-03   +7.096651347737298e-02   -5.578041003112978e-02   -8.481826083770162e-03; +1.504886782167294e-02   +5.666876955925600e-02   +5.210522239055955e-02   +4.917064422448545e-03   +3.447400904519610e-02   +2.954170648740440e-02   -4.100260293997664e-02   +1.727622068107238e-04   +6.510390902125214e-02; +2.017497477764910e-02   -5.175506710306275e-03   +1.898801574081392e-03   -1.726163170296108e-02   -3.284553111775786e-03   -2.344396588556917e-03   +3.817975838743383e-02   -2.747082579159951e-02   -1.579418443924412e-02; +3.173926739929418e-02   +7.062684478417067e-02   -4.857755933306598e-02   -3.142341485585007e-02   -2.958545547961866e-02   +2.911936351296338e-02   -2.278166173111098e-02   -2.926552821200668e-02   -5.924968411864769e-02];
L1_L2_iAMPA_netcon = [-7.632373007546271e-02   -3.049278527611498e-02   +4.465985154134115e-02   -6.389223480496659e-02   -9.223674030265845e-03   -6.344023311618296e-02   +4.367684515277248e-03   +2.872846434694528e-02   -2.406212612142792e-02; +1.555438722572506e-02   -1.406634810262401e-02   +1.965298515962479e-02   -1.444753043305605e-02   +3.079208576482093e-02   +9.569041955213662e-04   -2.541135284771643e-02   -2.982886216451291e-02   +3.342444255282050e-02; +4.153099085469274e-02   +4.356539822518149e-02   -3.518944506848066e-02   +3.708759494467317e-02   -5.734012261997084e-03   -1.077153116717196e-01   +2.381989014672391e-02   -1.962338515221667e-02   +1.393365172779254e-02; +3.915509543125150e-02   +3.075643120871143e-02   +1.298613736854094e-02   +4.990628395139565e-02   -6.383362402910506e-02   -1.948940038217372e-02   -4.855328390549372e-02   -4.889007036416535e-02   +2.163053198793578e-02; +8.094531624161616e-02   +1.148921548195356e-02   -6.624286885555497e-02   +4.222965279610875e-02   -3.107609602951134e-02   +5.813924769209564e-02   +1.153797955776808e-02   -5.465435778940301e-02   +3.695794499853924e-02; +1.878986203928986e-02   -3.115732279745334e-03   -7.839505239165930e-03   -3.036217522776158e-02   +6.683514898252615e-02   +3.795996250759583e-03   +3.076315579436443e-02   +1.081245220667458e-02   +2.136169152702148e-02; -2.567391225157461e-02   +7.782716433035084e-03   +2.969882845172430e-02   -3.081700484450511e-02   +2.010069473759641e-02   -2.347312303635431e-02   +7.049078953073634e-03   +4.132425834232042e-02   +1.353979516564456e-02; -5.530664800570172e-02   +4.271797944781365e-02   -2.613844174933506e-02   +5.284675538710733e-02   -2.000864716059866e-02   +1.862919906229712e-02   +1.444077497554518e-02   -3.049101332085203e-02   -4.106118761253157e-02; +3.740291472682163e-02   -1.128309410641938e-02   -7.360981192862687e-02   -1.868533898802827e-02   +4.592056081602795e-02   +7.091389264349755e-03   -2.549437284596746e-02   +4.316677055431165e-02   +5.270322182714726e-02];
L2_L5_iAMPA_netcon = [+4.009857957635410e-02   +1.461512617522125e-02   +7.969504095305431e-03   +3.861216710274343e-02   +6.957440353180139e-02   -1.166451663270966e-02   +3.601069793830358e-02   +2.830290249969511e-03   -9.491590701377473e-03; +2.547308878882118e-02   +3.616681451282416e-02   +4.626057805077113e-02   +7.749783530083243e-02   -4.241024932242018e-02   +2.993124193060855e-02   +3.393344893070891e-02   +3.576822991801303e-02   +7.128178685780980e-02; +1.053160555801030e-02   +7.271384543896129e-03   +7.440536652339078e-03   -9.972874415503043e-03   -3.912746204975771e-02   +6.594656868629462e-02   -2.635841148686859e-02   -1.103041367066996e-02   +1.645504095515801e-02; +3.051129985975426e-02   -1.241663866405552e-02   -2.827362020693964e-02   +9.801203741298480e-02   -1.498125533228111e-02   +3.675124956688764e-02   +3.906702001448473e-02   -2.377644829060848e-02   -3.944633658799751e-02; +6.930919573507818e-04   -1.061323981920871e-02   +5.865660315280394e-03   -1.808067931228816e-02   +6.979252621113792e-03   -1.279370050855286e-02   -1.711355755737490e-02   +1.997731610522243e-02   -4.910345384744774e-03; -3.864075203399907e-02   -2.477701216321231e-02   +6.867871782355102e-03   +2.642334622944963e-02   -6.017942111961039e-02   -3.851278354300199e-02   +4.114898227390161e-02   +3.106698151444554e-02   -4.440189490399633e-02];
L5_L2_iGABA_netcon = [+6.105706901892590e-03   +7.359528232108451e-03   -3.163873459131302e-03   -3.888749052100124e-02   -2.132283815293270e-02   -8.846959446110217e-02; +2.539078674340624e-02   -3.918956745424051e-02   -3.423910064125524e-02   +5.018003061785911e-02   +1.665153531067747e-02   -1.257445408260360e-02; +6.461926891859215e-02   -7.510925796831835e-04   +3.429889729942155e-02   +8.993558096015555e-03   +6.022619247690718e-02   -1.704240587267776e-02; +4.456172100274784e-02   +3.533359257745318e-03   -1.685893899748713e-02   +2.397426078876058e-02   +4.373043814715675e-02   +3.771512442350872e-02; -3.816267460941207e-03   +5.223008183332293e-02   +6.957970736937910e-02   -1.067364669710083e-02   +1.629723182832914e-02   +3.388699778592241e-02; +2.638832608081526e-02   +1.849955405191614e-03   +5.654114097996980e-02   -3.613332999090067e-02   +3.335916415630403e-02   -5.417827548113677e-02; -2.531264151240783e-02   +2.606026060833066e-02   -8.434839918995486e-02   +3.952161030200563e-02   +3.294695295905199e-03   +7.232416257018807e-03; +3.682674057150920e-02   +6.432097050969876e-02   +4.862633582018906e-02   -3.600958735471390e-03   -4.109291774150846e-02   -5.063890696609938e-02; +3.661139586877761e-02   +1.797842996162417e-02   +3.054249771233255e-02   -2.575407987657013e-02   -3.375564571976989e-03   +6.928616929220327e-02];
L3_L2_iAMPA_netcon = [+1.411143297970272e-02   -5.302771665563653e-02   +1.541242809409966e-02   -7.500420361191217e-03   +4.094931299488411e-02   -5.442060851638357e-02; -1.040973275114735e-02   +3.739728218282028e-02   -1.896276088826490e-02   +3.536309461729715e-03   +6.880266047845381e-03   +7.037748276927212e-02; -1.055902400205960e-02   -1.453277156798723e-02   -3.402512865384252e-02   +2.384210542379521e-02   +2.229791315529321e-02   +4.693487526856982e-02; +3.455028715733233e-02   -5.173476500634323e-03   -4.265235664187496e-02   +6.012224768154412e-02   -4.469580416426691e-02   +2.293495874961188e-02; -6.435667719516638e-02   -4.560437281995103e-02   +2.343865729813772e-02   -1.920743925458337e-02   -2.487328454357038e-02   -6.317425880485607e-02; +5.089080810911405e-02   +3.380048201040114e-02   -4.779337526163048e-02   +3.202663096476467e-02   +3.305502974728013e-02   -2.954286112530003e-02; -8.218411992600527e-02   -1.408844533210745e-02   +4.575689453537430e-02   -2.281360891392831e-02   +3.913594470298013e-02   +1.518251002442003e-02; +3.634416666477435e-02   +3.133028177757394e-02   -2.334067749373981e-02   +9.385882626925196e-03   +8.678674634184213e-03   +5.838682254895353e-02; +2.484960202818310e-03   -4.829798563064609e-03   -2.572348631013285e-02   +3.179829010462824e-02   -8.274335351660035e-02   +2.350577215816702e-02];
L2_L3_iGABA_netcon = [+1.220779190468257e-02   +2.599057304738903e-03   -1.899208793303587e-02   +1.821690916992837e-03   +3.923420124022807e-02   +2.456279377515104e-02   -3.348452231109730e-03   +1.288047021653422e-02   +1.671132963488970e-02; +1.243164875088513e-02   +7.670867699693679e-03   +4.832145919474595e-02   -3.859482430811069e-02   -7.847284856434458e-03   +5.739564515604147e-02   +1.976056131539732e-02   +4.320858673727412e-02   +1.385252894491202e-02; +5.442078641315656e-03   +3.832610085580108e-02   +2.323962629081400e-02   -2.415783212936439e-03   +6.181401836962916e-02   +2.559311777381226e-02   +8.459953990564994e-03   -1.746413558265551e-02   -3.070239569890973e-03; -6.587059999502164e-02   -8.461370229437848e-02   +4.709992173091448e-02   -8.113104822972506e-02   +1.357175936708705e-02   -8.326607299787493e-02   +4.684960387634672e-02   +4.648129332260106e-02   -4.472835135751469e-03; -1.982015999069622e-03   -4.845438868465651e-03   -7.893438786833559e-03   -2.643865339521674e-02   -2.038662905299637e-02   -4.021800827584667e-02   +2.765771023074293e-02   -1.054262469595948e-02   +9.331643207414192e-02; -3.279597383949912e-02   -1.251083848021307e-02   +6.020805027907628e-02   +3.280821216820368e-02   -5.070678415400168e-03   -3.170282547415153e-03   +2.600197426090541e-02   +2.308513356350855e-03   -3.318809184623402e-02];
L1_L4_iGABA_netcon = [+8.598300254144620e-02   -2.903454180862634e-02   +2.604703951555113e-02   -1.575813296437172e-02   +5.685978649088384e-02   -1.781854661526521e-02   -5.279171743430038e-02   -2.497453227439083e-02   -2.028510337789897e-02; +1.681876350187413e-02   +2.342184441394841e-02   +3.124669812372244e-02   -4.996635755682308e-02   +7.475186383577877e-02   -3.522618347037626e-03   +5.980706057006903e-02   +3.427259055216855e-02   +2.501902759772116e-02; -3.742398838805980e-02   +6.474108218137473e-03   +4.095362285173443e-03   +8.469554858208724e-03   -1.613547598192747e-02   -1.777963573950840e-02   +8.592595972540112e-02   -5.439988386252315e-03   -3.275781167254858e-02; +2.107636580407351e-02   +1.078989205781255e-02   -3.357410336432399e-02   -1.130457845469961e-02   +4.497745015736541e-02   +3.670654507292855e-02   -7.310863764254794e-02   +1.299690366797084e-02   -2.875294270698593e-02; -2.469010134185963e-02   -1.170962214865784e-02   -2.902091617229680e-02   +1.771121910857229e-02   +9.247713717812729e-03   -8.507926236987479e-03   +2.695903556531686e-02   +3.606982722578439e-02   +9.627006417013593e-03; +1.230896789401828e-02   +1.352126744016605e-02   -3.485664131047618e-02   +2.268306686786654e-02   -2.113638022355030e-02   -3.888997965628783e-03   -1.027703464978023e-03   +4.242117726448609e-02   +5.876601428612620e-02; -1.057182050784506e-02   -1.576111675608172e-02   -1.099307276813652e-02   -1.498145537888555e-02   +5.170030990682174e-03   +3.623162474010445e-02   +3.289312205707350e-02   -7.679961882516882e-03   -7.087292348366009e-02; -3.576169625872862e-02   +5.448804234879332e-02   +1.182023057066851e-01   +1.833081560973977e-02   +4.945437387896363e-03   +3.917520404277623e-03   -3.345359098874145e-02   -4.423832841394501e-02   +5.069390165298382e-02; -3.453717278141189e-03   +3.169605190845246e-02   +1.630055824974206e-02   -6.673032530093579e-03   -3.812122294051021e-02   +1.127787793573829e-02   +3.302772491715907e-02   -1.071784501696576e-02   +7.466157373614682e-03; -3.583153207667451e-02   -3.617438142846503e-03   +7.003981164351261e-02   -1.255009929949789e-02   -3.005424957931371e-02   -1.798831486147519e-02   +3.162165526043226e-02   +4.514392665744252e-02   -7.529714666911845e-03; -1.885020795866729e-02   -9.697500519224300e-03   +1.903252653227680e-02   +1.571560252032055e-02   -1.539125585842532e-02   +4.224343978261961e-02   +3.202349363785248e-02   -8.115467179088436e-03   +7.483183672256125e-02; +2.444127664911106e-02   -3.335980034098462e-04   +4.378547827789908e-02   -7.179421823997601e-03   +2.095271434364037e-02   +5.975417531240847e-02   +3.708799985651540e-02   -6.957441020250149e-02   +7.162141815962976e-02];
L4_L1_iGABA_netcon = [+5.908992117016343e-03   -3.109613780242201e-02   +3.871483659282813e-02   +4.087941024831895e-02   +9.779753046080988e-03   +1.316658888583012e-02   -1.904232872669243e-02   +1.151570226453292e-03   -6.573622149584264e-02   +3.064819398181259e-02   -1.676475234142219e-02   -2.575177773783514e-02; +2.675817296556331e-02   -3.563755761460394e-02   +6.954655226713345e-02   +3.409894167832817e-03   -3.306332980666727e-03   -5.327676437233581e-02   +6.916224640638043e-02   -6.888571782298913e-03   +3.547659369592854e-03   +2.730705280850782e-02   +7.355995193049224e-02   +1.517402845683493e-03; -1.379611835507098e-02   -1.723813157252933e-02   +4.064728670046438e-02   +7.399494014832537e-03   +3.711225557571478e-02   -7.832291227143708e-03   -2.951187424769567e-02   -5.559126987996184e-02   +1.140461189327287e-02   +2.770368280713347e-02   +7.256072557399539e-03   +1.089380646013558e-02; -3.903708793212166e-02   +5.875897755596077e-02   +1.687522670193339e-03   -2.620784955639609e-02   -2.409506539567606e-02   +1.975251987986502e-02   -5.504983614265285e-02   -2.435465589397809e-02   +2.875392060558959e-02   +5.623898857940299e-02   -2.972275189415431e-04   +4.806701187913585e-02; -2.263740755420349e-02   -2.447271640970309e-02   +8.556999896106570e-04   +6.432152993602182e-02   +1.527112063335170e-02   -3.154692007057891e-02   +3.308411653266820e-03   +2.529384634248063e-02   +1.436596765965846e-02   -3.713379491818798e-02   +3.791034032739408e-02   +3.599224106009227e-02; +5.227958095651374e-03   +9.028706037789798e-02   -1.240510493334872e-02   +4.145234670635404e-02   -1.221813886092686e-03   +4.401925907747892e-04   -2.272531394449314e-02   -8.565569783571233e-04   +4.761364237951315e-02   +5.580351682144923e-02   -7.171673374786491e-02   -8.866301933093707e-03; +8.102548248735439e-02   +5.640396029152055e-03   -5.267438879029739e-02   +1.185524346855284e-02   +1.055177773859602e-02   -2.525937178880641e-02   +5.741818778149417e-02   -3.258535109435663e-02   +7.747405778107638e-02   +3.293093934277412e-02   -1.893607347984050e-02   +3.936373613202242e-02; +1.969517455472859e-02   -2.275866942462891e-02   -3.738797178711555e-03   -5.562455118585573e-03   -1.078661019484146e-02   +4.181297016620298e-02   +1.761895777353867e-03   +2.622768717402843e-03   -3.877880510175570e-02   +3.523983667214313e-02   +3.164576562271342e-02   -6.380085936979127e-03; -2.242181036530666e-02   +6.359504017001744e-02   +1.024230169235381e-02   -6.445957333359821e-03   -7.243775478486997e-03   +1.305919441473202e-02   +4.221669059066796e-02   -1.133480317046482e-03   -1.366896157957562e-02   +6.870011188309989e-03   +2.965617714700816e-03   -1.004923174576101e-03];
L1_L3_iAMPA_netcon = [+5.413461950166013e-02   +3.751400975979396e-02   +4.799068540684895e-02   -9.069908012188951e-02   +1.525893591873019e-02   +5.280134930809968e-02   +5.291982483554022e-02   +3.224735317346153e-02   -4.460017379851557e-02; +9.669866283157788e-03   -7.504213335821198e-02   +2.826727150992067e-02   +4.255474351720941e-02   +5.096650555493732e-02   -4.854828023656384e-02   -3.157018230859215e-02   +1.553584333576626e-02   -3.363278084815033e-02; -4.243954684112174e-03   +2.845581511607154e-02   +6.387828471452828e-02   +2.743030248631191e-02   -2.691582808314790e-02   -8.218429300353887e-03   +1.740478956015352e-02   +5.465659805343916e-02   +5.097674784975529e-02; +1.507379041380527e-02   -7.632053757618781e-02   +8.277924752528251e-03   -6.296940359265216e-02   -3.318528655144459e-02   +1.389420267745959e-02   +1.872662021022267e-02   -4.070447965083893e-02   +9.096421739565650e-03; +2.482227434528168e-02   -2.928380087342444e-03   -2.999174509675986e-02   +6.656947824964099e-02   +8.830575822107063e-02   -2.815408365324752e-02   +4.288212181354627e-02   -8.226856233291292e-02   +4.080176884433807e-02; +9.011947174221584e-03   +7.118435740010651e-02   +5.014681594509478e-03   -2.672045228447703e-02   -1.392035102524430e-03   -1.322881913461277e-04   -4.797302966006453e-02   -1.174013754906435e-02   +4.271503946717389e-02];
L3_L1_iGABA_netcon = [+6.834273249247588e-02   +3.270948545380133e-02   +2.157384964199242e-02   +1.748131847449647e-02   -3.541117904196810e-02   -2.004562941220540e-02; -1.119131301895181e-02   +1.903782702516604e-02   -3.815777690272227e-02   +6.619713899145863e-02   +1.227410887314205e-01   +2.629179844495808e-02; +1.270500589613821e-02   -4.487595577227785e-02   +3.253734688388550e-02   +3.214045169262821e-02   +1.421627846638226e-02   +2.404628928276527e-02; +9.153174538362816e-03   -2.795518638761106e-02   -7.746070056977732e-02   +3.702562584452083e-02   +2.286488176495980e-02   +4.503716095102519e-04; -3.949478225768500e-03   -2.608383133258980e-02   +7.124441996515299e-02   +8.595513336319156e-03   -4.241885190875773e-02   -2.129782666964116e-02; +1.165323919561667e-02   -1.633466271979372e-02   +4.497636861913992e-02   -1.884758190656241e-02   +2.071761169272275e-02   +1.018597429200465e-01; +1.963804448455490e-02   +3.478706827986735e-02   +5.516486513727076e-02   +3.147117223609595e-02   -4.564949559054211e-02   -7.282071057003807e-02; +3.908066842867636e-02   -4.195383573472650e-02   -5.541610155947745e-02   -2.407039763432159e-02   +1.792241045601034e-02   -1.767648753019297e-02; +4.593702211118057e-02   +8.670657729645625e-03   -1.671953056488724e-03   -8.930365553215120e-03   +5.317145076168780e-02   -1.248499079355467e-02];
L5_Input1_iAMPA_netcon = [+1.978232695519567e-02   -1.363272160020398e-02   +2.437557103799112e-02   -4.903114298718533e-03   -2.932857603751783e-02   -2.263291372454685e-02];
L6_Input2_iAMPA_netcon = [-1.409420737148499e-02   +2.529586133078830e-04   -7.836544704751904e-02   -1.803566735501298e-02   +2.660180006238758e-02   -3.987397328744127e-02];
L5_L6_iAMPA_netcon = [+1.880492189938256e-02   -1.965569472803094e-03   +3.236725380377534e-02   +7.688701821724236e-03   -7.241299752485525e-05   -2.507243461459656e-02; -2.545034832504664e-02   -4.543366628779746e-02   -4.108495323902147e-02   +2.861410483110089e-02   -3.009634586087332e-02   +7.277078628637217e-03; +4.688380160138736e-02   +3.910972783352446e-02   -9.306032100140364e-03   -1.139865745790563e-03   +4.733876856772481e-02   +8.123700589824198e-02; +3.917618730938090e-02   +1.371230891138166e-02   +4.094252321724655e-02   -3.350208746102036e-02   -3.603359357364606e-02   -1.941746757392578e-02; +1.970812981448178e-02   -2.706706068540941e-02   +4.940311234493281e-02   +5.834793108105412e-02   +2.676778376148470e-02   -6.926024606833303e-02; +5.502175147062436e-02   +3.543381623165467e-02   +1.321481045122175e-02   -1.178568989006919e-03   -5.994539525658331e-02   +2.280087916749713e-02];
L4_L5_iAMPA_netcon = [-1.480536822291622e-02   -2.262948532365361e-02   -3.089116136379807e-02   -6.453033033393359e-03   +1.024244831635613e-02   -3.984074548021677e-02   -5.276736988435427e-03   -1.137361048267475e-02   +7.025797879080814e-02   +4.895266965324618e-02   +3.295374024269446e-02   -2.767634669159654e-02; +3.142352326124451e-02   -4.534918154284423e-02   -5.536082140362725e-02   -1.725534664708545e-02   +1.123079446417186e-02   -7.279036452920595e-02   +7.300891399075304e-02   -2.581539262618366e-02   +5.339841494898679e-04   -5.583846207234927e-03   -2.144581264457385e-02   +6.287866352039771e-02; -3.922323647703294e-02   +5.791658882119584e-04   +5.265266304732949e-02   +3.074672524861159e-04   +2.011116182123003e-02   +6.478244409193937e-02   -4.211166720337498e-02   -2.349250426132757e-02   +2.679940946001263e-02   +2.427682074455212e-02   -4.865834414751270e-02   +2.770680044400149e-02; -5.697690769455117e-02   -5.194167821405919e-02   +3.417142345736908e-02   -3.973520047158485e-03   +2.683019744656530e-02   +5.728740529578316e-02   +1.538454985954069e-02   -2.606101054178915e-03   +2.217849235386493e-02   +4.339660743652821e-02   -2.037674549469153e-03   -1.227294928054478e-02; -2.972337524382248e-02   +4.566089625441937e-02   +3.934955954728383e-02   +3.132320701798553e-03   +4.655795392849690e-02   -2.881176650673721e-02   -5.587508805981781e-02   +2.791938343508515e-02   -2.754875724628567e-02   +4.277803826423338e-02   +1.183070184241387e-02   +8.565641879386601e-03; -5.593403684363136e-02   +5.311865029980505e-02   -4.015017325961098e-02   -3.933570725415784e-03   -3.698667519904174e-02   +8.075728077028486e-02   +2.668476282953858e-02   -1.213694276269833e-02   -3.106598993722610e-03   -1.267994342990839e-03   -1.245172135143999e-02   -7.182693396381429e-02];
L6_L4_iAMPA_netcon = [+2.757427017692707e-02   -1.780901784566070e-02   +4.166453244948416e-02   +6.380683868210862e-03   -4.876574738062681e-02   +6.107188834851847e-02; +4.136696923224879e-02   -3.008011638185332e-02   -3.441372898541773e-02   -2.353276025363218e-02   -1.247468726972988e-02   +2.094102266154499e-02; -8.370927542171707e-03   +2.788039188986072e-02   -3.831852537240543e-02   -1.096450911275722e-02   +3.072228852099696e-02   -2.326514398006666e-02; -8.514958680715914e-02   -6.723099185876008e-02   +2.031733795991521e-02   +2.088537372098241e-02   +6.575742228677413e-02   -6.274099045538388e-02; +2.395585121059784e-02   +4.833394336848154e-02   +7.110465187584916e-03   -7.265367807888903e-02   +4.643571838804453e-02   +7.349880837222511e-02; +1.861921277090360e-02   +5.832208848980089e-02   -1.297384156256611e-02   -7.638585166104446e-04   -1.422457669778729e-02   -5.681514677324539e-03; +5.593982228838272e-02   +1.056069455076940e-02   +5.991752939610047e-02   -1.842586657379702e-02   +6.861731362876078e-02   +6.801440503288060e-02; +3.858453210090260e-02   +8.833855771047897e-03   +3.061077377340440e-02   +1.725832370432129e-02   +2.132497458844571e-04   +1.410927234277992e-04; -5.051087640810100e-03   -3.880389957426091e-03   -8.547035351669116e-02   -1.598382401942026e-02   +1.139452846273868e-02   -2.408978485492101e-03; +4.048341286615305e-02   +3.150616917263262e-02   -6.989805178922701e-02   -1.677933006444234e-02   +3.480456465553448e-02   -1.873059153181274e-02; +3.025529542427546e-02   +5.268259031039291e-02   +3.362099928341080e-02   +6.422837935906892e-02   -1.382139223044210e-03   +2.099361560918631e-02; -2.664740809594152e-02   +6.413081073423446e-02   -4.659418365109346e-03   +3.231521175297587e-02   -6.715963062652966e-02   -6.244990272261206e-03];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
