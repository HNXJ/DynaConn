function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.051202007829137e-01   +8.410552855500968e-02   -3.487952256763807e-03   +3.031594309521525e-02   -5.808589805731423e-02   -1.071072451892501e-01   +1.419396644931899e-01   -1.683543632377317e-01   -6.263786727489595e-02; -4.708033453627691e-03   +1.985443377639725e-01   -7.798221961770749e-02   -1.927689204746126e-01   -6.591930323864528e-03   -1.350698351882978e-01   -1.599048504368196e-02   -6.706674181508861e-02   +5.272163580503524e-03; +1.779605660421506e-02   +1.881718160155247e-01   -1.433075068140708e-01   +1.724640381181412e-02   -5.757467977888681e-02   +1.362557634069806e-01   +1.668280500464924e-01   +1.432023512587888e-01   +2.502047760726616e-01; -2.726039531516239e-02   -8.663323356205450e-02   +4.646614113666567e-02   +1.317768818812023e-01   -1.115899083724402e-01   +1.179277997921823e-01   +1.386680105188806e-01   +1.092885091979655e-01   +6.032990624447706e-02; +1.409902234345972e-02   -6.740941036337279e-02   -6.799002493503778e-03   -5.388512509495517e-02   +1.255785188574808e-02   -9.355945118097420e-03   +2.211491795818256e-01   -4.056636576024820e-02   +4.433324764363648e-02; +7.373695601711269e-02   +1.234633694631498e-01   -1.178294606138199e-01   +1.026877026973466e-01   -1.454811542262443e-01   +8.864259343736765e-02   +9.434594290721225e-02   +3.142539064552433e-02   +8.410040780845077e-02; +4.074141886571320e-02   +6.904798070122917e-02   +2.010730608141243e-01   +1.563332636624756e-01   -5.252672261488275e-02   +5.816730363451644e-02   -4.712535571289431e-02   -2.190455379946855e-01   +1.159848114416678e-01; -1.435211359488580e-01   +3.253052788417857e-02   +8.773695086193720e-02   -4.907592232272292e-02   +4.244068949949918e-03   +7.242712857603670e-02   +1.100969461512800e-01   -6.437891413538259e-02   +1.844677594439193e-01; -6.714072282731808e-02   -1.466193781847841e-03   -7.487186428878845e-02   -4.162760081731898e-02   -1.435334222891407e-02   -4.005304821230068e-02   +6.495448220372807e-02   +8.716079414069675e-02   -3.018720839538896e-02];
L1_L2_iAMPA_netcon = [-8.382576064734794e-02   -1.203911118161089e-01   +4.610373822119641e-03   -4.742864411002864e-02   +2.758575705978076e-02   -1.542043287828762e-01   -1.334181835010059e-02   -1.008924281409664e-02   +3.181100256652709e-02; +9.445522443571211e-02   -5.716250814177548e-02   +1.320337032298330e-02   -1.112829399999248e-01   -9.470488750111673e-03   -3.551294073868451e-02   -1.793950714736967e-01   -1.610295067160858e-01   -1.586072137013844e-01; -4.220827359954699e-02   -1.403235188940825e-01   -1.376129373892475e-01   +5.834666297850728e-02   +1.600231007511782e-01   +1.808382944062788e-01   -2.690528058260176e-02   +1.405132194027245e-01   +1.442365456909885e-01; -2.310996196569405e-02   -3.373925126068979e-02   +1.262694499807588e-01   +1.039237455667896e-01   -4.704954914318366e-02   -1.941783518917825e-01   -2.047579061603551e-01   -6.326585083358233e-02   +3.750653342022933e-02; +3.248100545420125e-02   -1.234250782531024e-01   +5.169722602675716e-03   +2.248102307556973e-01   +1.721000916220905e-02   +2.341656791747718e-02   +7.858719756621609e-02   -9.387970715665736e-02   -8.976815925386061e-02; +1.500132525862223e-01   +1.233342014947819e-01   -2.165324827247621e-01   +1.220384084479415e-02   +4.015845751886638e-02   -8.287619475497006e-02   +3.084672197550352e-02   +1.244018465444305e-01   +1.295297394023114e-01; +1.162169682494816e-01   +1.186624239029469e-01   -1.252618663826926e-01   -1.571720514584214e-01   +1.079886220575527e-01   -7.687541965905649e-02   -8.265441886968157e-02   +1.185530210816831e-01   +1.406230146518613e-02; +2.000128922798112e-01   +2.122244462354111e-01   +2.957862536084290e-02   +4.339000187295200e-02   +1.514451576310102e-02   +1.440700241926862e-01   +1.081943672847747e-01   -1.019042494731019e-02   -1.004521913369500e-01; +2.433907735565680e-01   +9.467029137505269e-02   +2.922905708824657e-02   -1.048509284012201e-01   +6.714054376126068e-02   -4.034502265131309e-02   +2.536276295663473e-02   +2.032374265427379e-02   -9.776599518642609e-02];
L2_L5_iAMPA_netcon = [+9.704913330432730e-02   -1.686618254614515e-01   -1.773536710280095e-01   -3.181394899887267e-02   -1.140977124912031e-01   +1.741600045201539e-02   +2.774243168112381e-03   +1.151374129007029e-01   -1.023264087325107e-01; +1.841648392254131e-01   +9.331929057389320e-02   -1.037347689043185e-01   -8.694381866140383e-02   +1.176363703703839e-01   -2.745530838431001e-02   -1.346628168861463e-01   +1.343375852896213e-01   -1.016463243303672e-01; +2.135587074053403e-01   +1.700325905707676e-01   +3.292013829983297e-02   +1.216413092800241e-01   +7.424250760967278e-02   -1.065515654376316e-01   -6.832381041492602e-02   -1.339867885711312e-01   +2.020102972523320e-02; -4.640762153975939e-02   -2.471126026325049e-02   +2.305186588482702e-01   -2.445753848353622e-02   +1.004315690589194e-01   +2.547871080830987e-02   -1.241088819652241e-01   -1.486451330589272e-01   +3.657301434769306e-02; +2.148573498525913e-01   +5.669115050516682e-02   -5.283595555498087e-02   -2.673852134448816e-02   +5.594165769645375e-02   +8.901057430015751e-02   +8.291439961519613e-02   -6.703717737418889e-02   +2.550587167711896e-02; -1.162050747610655e-01   +2.758570798126539e-02   +9.772658849282440e-02   -1.112915218862299e-01   -5.052850162890320e-02   -8.097087866325237e-02   +2.114403949434013e-01   +1.182200592548100e-01   +1.070851077981658e-01];
L5_L2_iGABA_netcon = [-5.224376774447347e-02   -4.862120626369815e-02   +2.783604997685520e-03   -1.392729141233103e-01   +1.583209603037208e-01   +4.321370850403095e-02; +2.115973101194941e-01   -1.852973169249946e-01   +8.527700351458990e-02   +1.136454450872468e-02   -7.751525980382815e-02   -1.750464616383426e-01; +1.937183654489361e-03   -1.322047600701985e-01   +5.762616054366564e-02   +1.632742800935303e-01   -1.525139336123993e-01   -5.158087700698861e-02; -1.155569552762575e-01   +1.039360791422787e-01   -6.084735092979585e-02   +2.595933148399470e-01   -8.211769090193022e-02   +3.196898192073766e-02; +6.397212425080097e-02   -1.388868345280911e-02   +1.464061145269442e-01   -1.114617997836366e-01   -1.632337407880994e-01   +8.836592338639970e-02; +5.231678116693297e-03   +1.262049182958500e-01   -9.187770545563422e-03   +2.438986129764170e-02   -1.550554591590311e-01   -5.943526313977636e-02; -1.619261809432242e-01   -1.009053992867953e-01   +1.628331670541229e-01   +6.910363253445062e-02   -1.049090372067115e-01   -4.184571767515410e-02; +1.831850386343103e-01   -1.579744074099512e-01   +7.793448821359192e-02   +1.037371752114075e-01   +1.205771086770302e-01   +1.053730737619077e-01; +2.339511600936726e-02   +1.956077078538176e-05   +1.055688714476836e-01   +1.215169933916170e-01   -5.617409618274632e-02   -3.539567952035569e-03];
L3_L2_iAMPA_netcon = [-2.451208095843775e-02   +5.347202358764169e-02   +1.606498285780305e-01   -7.574602870805870e-02   -1.010939902353943e-01   +4.903626358202652e-02; +4.988212726606379e-02   +1.806217018296049e-01   +3.828007993822878e-02   -2.304623203318066e-02   +1.093101605710775e-01   +2.148521237938642e-01; +3.142334382254627e-02   +1.692900986805225e-02   +6.576298937009135e-02   +9.565704989652452e-02   +1.633760855936096e-01   +7.895483327545032e-02; +3.000554073262513e-02   +2.111970703317012e-01   -1.632087359035084e-02   +5.790301577090956e-02   +1.659217151899908e-01   +1.652714373612348e-01; -2.149626173435418e-01   -1.336667081484773e-02   +1.281501702037964e-01   +1.163354933763222e-01   -1.855614224035416e-01   +1.108105470341138e-02; -2.604544572467956e-02   +5.930603175754427e-02   +4.789289681651723e-03   -2.131164163972118e-01   +1.066848907697096e-01   +5.215055423073315e-02; -3.328043197028993e-02   -1.084254666744402e-01   -9.089864974943303e-02   -6.893035962131344e-02   +1.800444168690477e-02   -1.415837395621618e-01; -7.434759264086832e-02   +3.225586214029864e-02   -2.138580266397029e-01   -4.797230381882069e-02   +1.730610903270909e-01   +2.220781342423449e-02; -4.329896005335978e-02   +8.244832258466522e-02   +7.561506629957107e-03   +1.087030126326608e-01   +6.863395066353994e-02   +4.187101830238040e-02];
L2_L3_iGABA_netcon = [+1.090997622856621e-01   -7.383705151040932e-03   +1.358187218784981e-01   -2.657762507051005e-02   +4.285333972590205e-02   +1.973319696374980e-01   -1.203891848892308e-01   -6.097925640620878e-02   +9.704618684789763e-02; -1.183510268394153e-01   +6.694326871810957e-03   -6.151030158750993e-02   +6.249147957480343e-02   -1.065451346210101e-01   +3.394859042215283e-02   -3.231394699273805e-02   +1.118006525673963e-02   -5.899850864957507e-03; +1.265957771137259e-01   -1.598295991825852e-01   -1.862985791537982e-02   -3.872316842832346e-02   -1.831855836625678e-01   +2.414225976715233e-01   -1.932006408175376e-01   -1.670756630092655e-02   -1.271570870980279e-01; +1.086111401118647e-01   +1.087822559509857e-01   -2.437115974284414e-01   +1.403351480338205e-02   +6.808465934070022e-02   +1.210942104103457e-01   +1.134959252160044e-02   +1.385348884219584e-01   -7.220040273577165e-02; -1.309783661878817e-01   +5.063136328579168e-02   -1.504819882697992e-01   -1.621016305195974e-01   +1.501597248268464e-02   +4.380980638735646e-02   +1.022636982216344e-01   -1.145553682049060e-01   -1.980579327598496e-01; +1.787945473399373e-01   +1.037412802205429e-01   -7.742005993615628e-02   +2.904155675609130e-02   +8.347964545715642e-02   +2.263441498574443e-01   +8.109955786244338e-02   +1.728837413433117e-01   -5.442182056000611e-03];
L1_L4_iGABA_netcon = [-1.074780722159808e-01   -8.758075873836753e-02   +1.262103971361175e-01   +1.850701597918047e-02   +1.421923658259445e-01   -1.722936008193512e-01   +3.816922864678750e-02   -2.347970577261617e-02   -8.883704262212422e-02; -5.905864480582783e-02   -5.791384534729578e-02   -5.749567938086679e-02   -4.313419420154788e-02   +8.183058091081191e-02   +1.165098233161347e-01   -7.331534904243490e-02   -8.036912376871366e-02   -6.210929824685770e-02; -6.434321188990862e-02   -6.584040253695037e-03   -1.724500036604356e-01   +4.161751909295662e-02   -2.218188459986964e-02   -2.812694260477904e-02   -9.504131142890079e-02   +4.076255084738420e-02   -1.992716922790855e-01; +1.025974818659224e-01   -1.086922578027374e-01   -1.280258897139342e-01   +1.470874028950657e-01   -6.154359011653657e-02   -9.749412290749465e-03   -5.897818416884593e-02   -6.058754645439331e-02   +1.445277450061096e-02; -1.153186194669758e-01   -1.502906879487834e-02   -9.700915692576008e-02   -5.493917469950245e-02   -9.376600563257070e-02   +4.711041131177246e-02   -1.047128594388472e-01   +7.510671587475218e-02   +1.080355121877704e-01; +1.592763768483622e-01   +6.820833455467547e-02   +1.043017381506308e-01   -8.305782959634456e-02   +1.222974786580903e-01   -3.764473513263233e-02   -1.174669179125228e-01   +1.929107452724536e-01   -2.538978524365593e-02; +5.145834016106150e-02   +1.509083667189653e-01   +1.529360899507604e-02   -1.444942391949294e-02   +1.963393513634047e-02   +1.512474185900002e-01   -1.125180196326378e-01   +1.217983350803099e-01   -4.138524132570754e-02; +1.446473625462886e-01   -2.057106046834239e-02   -2.352299146036711e-02   +7.944489295957069e-02   +6.855410426098718e-02   +5.125581265405150e-02   -2.065921335222606e-02   +2.988820183756199e-02   +1.385363348314410e-01; -2.093953631116092e-01   -8.457437936434696e-02   -4.391319510444856e-02   -5.804827419144171e-02   -5.649288098412933e-02   +1.983438365587544e-02   -9.342089975262553e-02   -1.971013025558410e-01   +1.173644181221606e-01; +7.651800191525301e-02   +1.246506873869362e-01   +1.074782745703623e-01   -4.823964139296681e-02   -2.451181143500555e-03   +1.377931609021590e-01   -1.977597239595778e-01   +1.272329915341548e-01   -1.186618050926728e-01; -3.586128898649776e-02   -4.634458106438365e-02   -8.493228077749468e-02   +1.015445669386144e-01   +1.207762914484914e-01   -1.293089002697860e-01   +2.300742262511921e-02   +7.264493495362252e-02   +1.692736659406134e-01; +1.338995466298533e-01   -1.518079730650039e-01   -4.560821188048580e-02   +2.970978378775904e-02   -4.966107159111188e-02   +1.419832178707405e-01   +1.176938118036649e-01   -1.103919224060839e-01   -7.144229740502028e-02];
L4_L1_iAMPA_netcon = [+4.575428427146591e-02   -5.379215373063029e-02   +3.489232044694753e-02   +8.076904663180648e-02   -6.897995150576255e-02   +3.889004647814746e-02   -7.651563978619148e-04   +1.402784106589374e-01   +2.035196329713343e-01   -1.175148607357263e-01   -1.504734338220085e-01   +3.084268816220755e-02; +6.572841325446607e-02   +1.117323244396960e-01   -5.447446412238917e-02   +6.880482297709273e-02   +3.367733296611462e-02   -7.643665721761168e-02   -1.147726173041309e-01   +1.259737156697918e-01   +8.408279328861806e-02   +2.361155538467685e-01   +1.344348525134045e-01   -1.834202422967749e-01; -1.382495642065147e-01   +1.567383435741749e-01   +8.740091426745580e-02   +1.678649412542418e-02   -3.601427458535837e-02   +1.214328654106798e-01   -2.402128337970877e-02   +7.365164236387781e-02   +1.371928478700685e-01   -4.259632602686880e-02   +6.276992651334966e-02   +1.263930637357262e-01; -5.992272458164431e-02   +1.584168003078509e-01   -7.843369014133689e-02   -2.366117823050785e-02   -6.661049896068366e-02   -8.997296253890692e-02   -1.908570610766092e-02   -1.649637514944562e-02   +3.104876239071722e-02   +7.009562455203200e-02   +1.130623782427473e-01   -7.968058448609955e-03; +1.705289850478054e-01   +1.240605077238076e-01   -1.100975760315025e-01   +1.549132619569352e-01   -1.455113515968000e-02   +1.353568066547869e-02   +4.554954955068483e-02   +1.163696508097931e-01   +1.094069194067104e-01   +9.868334185440897e-02   -3.146010003485724e-02   -6.001450434170627e-02; +4.918286581687091e-02   +2.521355997289330e-02   -5.175261646734299e-02   +6.313444681635476e-02   -4.913040146822747e-02   -8.452179000217902e-02   +1.131859102486540e-01   +1.135964217176510e-01   +4.616453241520667e-02   +6.920282145019173e-02   +6.204510855971644e-02   +1.821361723922544e-01; +7.386492072647745e-02   -9.978091513247328e-03   +2.553295367191788e-03   -6.905418101272096e-02   +1.316402056373417e-01   +1.354299643929223e-01   +1.055889616993299e-01   +6.197134040748248e-02   -5.400370769547558e-02   -8.013459059003805e-02   -1.427135099145936e-01   -5.806390446206114e-02; -6.151743290348378e-03   +1.665916928083170e-01   -1.359923418512329e-01   -1.358715025197861e-01   -8.191662365497072e-02   +6.398695002869779e-02   -1.919404505749293e-02   +1.064976054189207e-01   -2.634113883538192e-01   +1.521104834570416e-01   +2.302209322674649e-01   -1.662667308267389e-02; +1.556248539107399e-01   +1.618068909187952e-02   -1.780922839954523e-01   +1.965138389791818e-01   -3.593292147446826e-02   -1.519409170734080e-01   +1.145358496560869e-01   +9.942631999002072e-02   -1.790592021745974e-01   -1.319219069890885e-01   +1.593624095511111e-01   -4.867389110983041e-02];
L1_L3_iAMPA_netcon = [-7.313361995484284e-02   -1.014177491675999e-01   -9.038739864013187e-02   +1.003941308752214e-01   -9.813039567522627e-02   -5.912594694089535e-02   +4.055311750212688e-02   -1.237516336986259e-01   -8.222498520575308e-02; -3.180656323127301e-02   +7.197937225758623e-02   -2.629496917001899e-02   -7.226856770524473e-02   -9.505247753109435e-02   -2.301118511079306e-01   -1.245335640650749e-02   +4.678312496282098e-02   +9.149169781951241e-02; +2.771900857178462e-02   +2.748309408328517e-02   +1.139373883324616e-02   -3.107673849044081e-02   -9.402058489749358e-02   +1.877696953652962e-01   +1.113550191201106e-01   +1.059120715982505e-01   +1.626616637755389e-02; -7.143345069565077e-02   +1.266907541646293e-01   -1.408962965960412e-02   +1.746316381624410e-03   +9.457114371769892e-02   -9.609029677403984e-02   +1.791771865722670e-02   +5.841970558729333e-02   -2.838505867778075e-02; -1.163310515819635e-01   +1.551228552153325e-01   +2.997973847016009e-02   -4.545674681275599e-02   +8.582254614532209e-02   -4.900376416085171e-02   -7.859064903407424e-02   -1.889590244942321e-01   +1.740445464384736e-01; -2.911244394111429e-02   +5.893606769899690e-02   -3.363251882470746e-02   -6.312737730628085e-02   +7.925557701593794e-02   +7.078011761669385e-02   -7.360298320479006e-03   +1.034388656956396e-01   +4.304585137883375e-02];
L3_L1_iGABA_netcon = [-8.266387903915255e-02   +8.832856910642856e-02   +1.120151736751672e-01   -2.338244423956388e-02   -1.374056403631636e-01   +2.293680357707679e-02; +4.794345958665905e-02   +1.294291560972958e-01   +1.586233490389881e-01   +4.714662546376522e-03   +1.618968351193399e-01   -5.336289725513944e-02; +1.713843008873671e-01   +9.308256628670111e-02   -2.975818478682213e-02   +9.370588196838268e-02   +6.490817900839602e-02   -5.096703240817051e-02; +5.820348941710943e-02   +6.335677477402406e-02   -1.956727561945398e-01   -1.158638270572565e-01   +1.365330463528058e-01   -2.988992230106304e-02; +1.993723578783582e-01   -2.927290994833881e-03   -1.030111106591848e-01   +6.496986938785764e-03   -1.227458133636162e-01   -4.728652874953826e-02; -1.281040678633382e-02   -3.133803263520230e-02   -2.861526048657614e-02   -4.522924854710626e-04   -1.792405368342136e-01   +9.510697427588609e-02; -1.077949433409875e-01   +1.751958426952856e-01   +8.834049413625858e-02   +1.082071372922819e-01   -3.641193573656340e-02   -5.165257498107897e-02; -4.151665656509027e-03   +1.473426711559563e-01   +1.595762773567364e-01   -6.273666014564155e-02   +2.902089754160748e-02   +9.890335381992346e-02; -3.148150009163288e-02   -9.529501862109682e-02   +4.132856184834328e-02   +8.925572028805367e-03   +3.189443287867989e-02   +2.533455569343236e-04];
L5_Input1_iAMPA_netcon = [-4.460736356068666e-02   -6.733024147020299e-02   -1.064361788164368e-01   +1.206720934643704e-01   -4.090833537914593e-02   -9.592953209409352e-02];
L6_Input2_iAMPA_netcon = [-1.555600252996426e-01   -8.070273090990515e-02   -1.765535487343050e-02   +1.910355312448734e-01   +1.398056984369179e-01   -2.972915707021005e-02];
L5_L6_iAMPA_netcon = [-1.372117396370316e-01   +1.643459077102836e-01   +1.266968480802374e-01   -9.240252133443966e-02   +6.664103475863783e-02   +1.235134127887181e-01; -1.026758051706851e-01   +1.942040471764232e-01   +6.802107033842089e-02   +1.984367993799965e-01   +5.422473248221999e-02   +1.346990097111503e-01; -1.049119574076976e-01   +9.120015459643188e-02   -9.137476395766639e-02   +1.164353953730080e-01   -6.187563433197822e-02   -1.528107880138632e-01; +1.858663135391989e-01   -1.220179945375406e-01   -3.325391776218459e-02   -1.248083798092185e-01   -7.717011209968044e-02   -2.324381717258441e-02; +2.740365605622717e-01   -1.265203001691776e-01   +6.255465983829468e-02   -3.806127216290146e-02   +6.855222039157895e-02   -1.086090591382568e-02; +1.654574691947538e-02   -3.008340277500286e-02   +1.365466432728453e-01   +2.394285786934217e-01   +7.696382001906865e-04   +2.108355285922210e-01];
L4_L5_iGABA_netcon = [+8.757206383339516e-02   -5.524325527873795e-02   +1.152837088097023e-01   -1.385814381451517e-01   +1.284987135914220e-02   +5.994201549844455e-02   +1.954535998457494e-02   +1.456170673622060e-01   -2.713776393035923e-02   -9.418879135176855e-02   +7.887939609185418e-02   -1.149340445823366e-01; -3.827517614470115e-02   -9.466682352937045e-02   -1.392435571998915e-02   -8.116443293113346e-02   +1.013189293200038e-01   +1.196936771316279e-01   -1.298281063476014e-01   -1.901609335866429e-01   +1.917431875331699e-02   -1.770386841752237e-01   -2.104495161374909e-01   +1.128308937545834e-01; -1.178412388593406e-01   +1.352025796340964e-01   -1.885240185308314e-02   +9.852650759929125e-02   +1.641477715584884e-01   +1.014239192732312e-01   -4.145351050528119e-02   -1.108306226034265e-01   +1.473089354096664e-02   +2.161383765517051e-02   +1.304407942728802e-01   +9.983543990035551e-02; +1.717753177620784e-01   -4.643619949425535e-02   +2.402181651823232e-01   +2.244986876070367e-01   -6.450120601450507e-02   +1.654869103342081e-01   +1.117919237051450e-01   -1.195159239738776e-01   +3.998560249433571e-02   +3.447023354689809e-02   -1.240552389728204e-01   +6.540609883247614e-02; -9.279167848900026e-02   -1.989145311361706e-02   -5.260690756536446e-02   -1.191234898279023e-01   -8.715870530777409e-03   -4.482853245760220e-03   -1.628486635656277e-01   -4.372206331028002e-02   -1.699050766310076e-01   -9.002721947198825e-02   -1.731814639360979e-02   +9.314280508148934e-02; -4.104593188731250e-02   +4.954554777195551e-03   -4.020889826356402e-02   -5.577624960856389e-02   -1.282260092121235e-01   -3.958655859712631e-02   -4.062907916129850e-02   -9.933267696905404e-03   +1.364834720060558e-01   -9.901968035492681e-02   +4.749163504165006e-02   -3.093710064922829e-02];
L6_L4_iAMPA_netcon = [+1.666781863180811e-01   +5.161598720414273e-02   -1.874616249572434e-01   -1.453268496689876e-01   +9.153248482627160e-03   +8.745664375568725e-02; -6.357503985107914e-02   +9.229483862969552e-02   -2.260065748986723e-02   +9.034323272209516e-02   -1.371692751922955e-01   +2.092284945867884e-02; +1.688615608899250e-01   +6.003552100293750e-02   +1.129667953871359e-01   -2.774086560376295e-02   -1.298363588223203e-01   -1.014321270361256e-01; -4.937705706036832e-02   -1.642503671057694e-02   +2.120011755974569e-01   +1.554143554414524e-01   -3.519817644250099e-02   +2.139783267255166e-02; -1.428052712910058e-01   +1.091177745317485e-01   -4.664153293974733e-02   +6.500980031385786e-03   +2.195850928743059e-01   -1.652354871790888e-02; +9.830953621241208e-02   -9.334057453948531e-02   -1.053737843186124e-02   +7.780933884462674e-03   +1.047775219732792e-01   +2.268215770841360e-02; +4.454762698725123e-02   +1.845216055755929e-02   -1.363871890918010e-01   -1.536764143520525e-01   -2.555279657904977e-02   -2.126586797245519e-02; -1.751398235449855e-02   -3.602427341007012e-02   +1.229391501746516e-01   -2.752306343891585e-03   -3.125866977201831e-03   -3.558317534019808e-02; -1.098967582281400e-01   +4.856969382945547e-02   -1.024609740354840e-01   -4.559299497508126e-02   -2.901261867354719e-02   -1.155625510441563e-02; +1.154970500718930e-01   -1.448740637035636e-01   +6.632530564849594e-02   -9.240218068805400e-02   +1.251504929415869e-01   -9.197547002225197e-02; +6.980238150346403e-02   -1.240274079013942e-01   +7.259839624545020e-02   -1.523399224855544e-01   +2.052402097185894e-01   +3.165910678639128e-01; +1.657656250871509e-02   -2.037953009181818e-02   +5.621508359150416e-02   +4.722999170861961e-02   +3.585776426936996e-02   +6.663342943443759e-02];
L5_L4_iAMPA_netcon = [+1.089787282811720e-03   -6.682466335469610e-02   +8.287295327741444e-02   +5.737806068253536e-02   -8.013307582417629e-02   -1.099698488862812e-01; -1.571024027913713e-01   -9.051103000357170e-02   +1.002736217134760e-01   +1.967516467364075e-02   -1.879489405801780e-01   +6.135581352321293e-02; +2.006787363361700e-01   +3.424343212113434e-02   +1.677584199138245e-01   -1.428919292434434e-01   -1.027383490094725e-01   +5.190417862322752e-02; +3.373598547439538e-02   -1.082463251776814e-01   +9.477464405358668e-02   -1.441629106099492e-02   +2.895220070490072e-02   -2.435277681068471e-02; -7.222277404101132e-02   -2.605876858973159e-02   -3.146215098617526e-02   -1.789830042528454e-01   +1.245789829914090e-01   -1.181346775661931e-02; -7.443789927574984e-02   +1.613794059198986e-02   +2.152797896337425e-01   +4.582043946390777e-02   +2.139746945555549e-02   +1.000023011487526e-01; -1.196721346347524e-01   +2.282894021205591e-01   +3.374433320175906e-02   -1.606843727236238e-02   +9.965178350835063e-02   -9.707367214169625e-02; -6.134962431706410e-02   +1.050157898201467e-01   +1.258817273158755e-01   -1.085839699150443e-01   +8.583472784914879e-02   +2.484463061800128e-02; +1.405067403908426e-01   +1.218823607803601e-01   -6.307148558643337e-02   +9.027065091851737e-02   -8.431006764278998e-02   -3.982518232165048e-02; -3.262826898806089e-02   +6.309344733641829e-02   -4.072103970311206e-02   -4.475693965101502e-02   +3.238867133157106e-02   +7.588754080069995e-02; +5.101965561758716e-02   +8.750608303758679e-02   -6.392166009049173e-02   +3.516359510350761e-02   -1.176933583250468e-01   +1.399109658104363e-01; +2.276124783814488e-01   -9.171659379269306e-02   +3.828313493480955e-02   -3.663151276915869e-02   +1.266337012972726e-01   +5.682736721507632e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
