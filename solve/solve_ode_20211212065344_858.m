function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.012903158265572e-01   +7.599927257050977e-02   +1.106267162081032e-02   -2.301728718790398e-01   -9.879936941817609e-03   -3.830065609481558e-02   +2.047439157495524e-01   -8.159457781363660e-02   +4.556703970141195e-02; +1.304245588773773e-01   +5.573745072093438e-02   +1.638648035506357e-01   +7.328610453231521e-03   +1.791833081719882e-01   -3.392001177474404e-02   +9.211706625805036e-02   +8.549736587448581e-02   -1.173215780155695e-01; -1.674551436979275e-01   +1.624522976513833e-01   -1.198478134355239e-01   +2.123007366972841e-01   -8.216108354798536e-02   +5.196355179645007e-02   +2.053661251497985e-01   +2.220888601608819e-03   +2.026304489210171e-01; -9.304947996519493e-02   +1.180812176629157e-01   +2.373606818704376e-02   +1.275355739097987e-01   +2.462338261803701e-01   +9.488151360986474e-02   +9.765102047073887e-02   -1.052594251596214e-01   +1.240886597027357e-01; +1.268400570470020e-01   -2.957173919116430e-02   +1.278540729473452e-01   +3.089620329474775e-02   +1.006646177706138e-01   -7.800838986387663e-02   +2.690683444724026e-01   -6.965146222975120e-02   -2.373038986403263e-01; +1.121195537991435e-01   -2.569156516343703e-03   +4.754784322764508e-03   -2.103666580441197e-02   -3.055185436198013e-01   -1.852035160304440e-02   +1.375651922285933e-01   -8.922042652526815e-04   +1.566060728346555e-01; +1.165669716877890e-01   +1.752768711143896e-01   +4.422242568535050e-02   +2.508202496486585e-01   -4.174155177053782e-02   -8.061803348728734e-02   +3.912337975800617e-02   -1.280519790177407e-01   +5.073055480029284e-02; -2.162741251705026e-01   +5.061171649961920e-02   +1.468320512477146e-01   -1.870247693670984e-02   -3.627899812167106e-02   -2.717340131984177e-02   +5.738870576507923e-02   +4.214405282410016e-02   +8.740361758714092e-02; +5.227079678475406e-02   -1.155358551591105e-01   -3.624955860410208e-02   -3.125198691030305e-03   +5.156500793658678e-02   -2.277517947549236e-02   +2.325648845850464e-01   -1.146568753734959e-01   +2.855225347360469e-01];
L1_L2_iAMPA_netcon = [-2.098645285588293e-02   -1.993918478240127e-01   -8.578025290986668e-03   +1.036486446689785e-01   +8.866503718700153e-02   -2.720977690598670e-01   -3.041170986959215e-03   +1.199378211676287e-01   +1.479899018173438e-01; -3.417456764777808e-02   +1.862569232029380e-01   +6.756869967724159e-02   +4.412829099087504e-02   +2.072478721756553e-02   -1.823923120600203e-01   -4.464135301589914e-02   -3.766169673126837e-02   -7.417943150528947e-02; -1.496025446714871e-03   -2.399167734224055e-01   -5.180328052498663e-02   -1.174907212153904e-01   +9.849913876495001e-02   +1.732158064232191e-01   -2.202703828700568e-01   -3.808657995028864e-02   +4.184706866474035e-02; +1.711522638809197e-02   -5.050766599917168e-02   -2.076645576724347e-02   +7.580636876753448e-02   -2.238038927553888e-02   -3.191288202999475e-02   -8.022105829956053e-02   +1.262284335988458e-01   -4.851257540331975e-02; +2.872696062735860e-02   -2.151688415026319e-01   +1.595827030996931e-02   +1.581502100692352e-01   +4.279515397620769e-02   +1.772569964492375e-02   -3.784705025389541e-02   +2.565336982833501e-02   +3.315694397330116e-02; +1.843272428170518e-01   +3.740291400157194e-02   -4.708213617711890e-02   +3.958579917870161e-02   -1.581094679000666e-02   +6.299548464805017e-02   +1.799157244589571e-02   +1.656944038119071e-01   +9.594316146508471e-02; +1.925605397374231e-02   -3.872458821603875e-02   -4.153550329388781e-02   +3.042190076656904e-02   -2.351635060929818e-02   -3.857447051654899e-02   -5.819101707707418e-02   +1.162622260364904e-01   -5.789981475196604e-03; +1.721234587027363e-01   +1.373340421667254e-01   +5.810176754354505e-02   -4.463184509617514e-02   +2.379685945615654e-01   +6.590127926698852e-02   +5.335426412444563e-02   +7.503251385252549e-02   +7.698727694043557e-02; +1.504609613225582e-01   +1.196166339321651e-01   +1.163058402656100e-01   -1.420501055600117e-01   -1.768937340715346e-02   -6.436299975580359e-03   +8.643633812408470e-02   +1.629687289567803e-01   +7.286183836373801e-02];
L2_L5_iAMPA_netcon = [+3.035490995001040e-02   -2.127008755720219e-01   -1.726757169777357e-01   +1.354250816997303e-01   +8.886691111956854e-02   +3.213208425935130e-02   +1.188653637166098e-01   +6.401480351640243e-02   -9.281114122563851e-02; +5.810750182213819e-02   -9.599810995709682e-04   -1.474905980509947e-01   +5.688847286573680e-02   -3.115895016411960e-02   +9.297684662886040e-02   +7.370861525627422e-02   +5.466980285603372e-02   +4.876390840336458e-02; +3.383359480885730e-01   +2.546814106797879e-02   +1.446819730125782e-01   -4.644025090557795e-02   +1.904254833158703e-01   +2.764075934008114e-02   +3.376698863451317e-02   -1.017957880017323e-02   -1.319536724478204e-01; +7.963167187897130e-02   +2.470063422863598e-01   +3.301981550861043e-01   -8.720683028603035e-02   +2.165146448005189e-01   +2.567700329836775e-02   -2.223674674506502e-01   -1.096086386278339e-01   +1.683851569065108e-01; +1.001807832817855e-01   +8.632076530634759e-02   -7.520080414641436e-02   +2.716836836969350e-03   +3.951139564441414e-02   +1.437701431536705e-01   +1.964657839416679e-01   -9.715969244104075e-02   +2.076672167227435e-01; -7.172530879060772e-02   +7.778030769813445e-02   +2.647428982189775e-01   +1.812132931963775e-01   +9.221312528695005e-02   +9.507883143490335e-02   +3.185883312394828e-01   +2.402320745448682e-02   +3.515627635886210e-03];
L5_L2_iGABA_netcon = [-8.635860155209913e-03   -7.432764770036102e-03   +1.036750922241707e-01   -1.030497783176699e-02   -5.349330035339720e-02   +2.670844315748925e-01; +1.391260091244632e-01   -8.015509041311772e-02   +1.901913620146720e-01   +1.078938925183876e-01   +1.517276746226549e-01   -7.235827899443573e-02; -5.764568218321695e-03   -1.190648061411458e-01   +9.575369363747846e-02   +1.521648700646834e-01   +8.074075942264559e-02   +1.247356857858659e-01; -9.165682793136533e-02   +5.605586869024314e-02   -2.667582188047451e-02   +2.385635629831708e-01   -4.245463385609500e-02   +4.804707946370270e-02; -1.523044098011767e-01   +1.374093261164473e-02   +1.149267832599833e-01   -1.905160455510691e-02   -8.410973294069087e-02   +7.948367957209376e-02; +1.256983001347519e-01   +4.262502401124457e-02   -3.071352304889007e-02   +2.869666007407606e-01   +7.578587955251928e-02   -1.616085282133169e-02; -1.091432063592605e-01   -8.158185074286992e-03   -2.580937060910259e-02   +1.671069954936787e-01   -2.462740291949883e-02   -8.352289709403402e-02; +2.947902605665738e-02   +4.344217164938755e-03   +1.398289108983432e-01   +1.975508313885177e-01   +7.540091586619141e-02   +1.660937694859723e-01; +1.832522105219288e-01   -1.428998340452275e-01   +1.244364922294400e-01   -7.241019036386757e-02   +1.208886150248751e-01   +8.172094288139532e-02];
L3_L2_iAMPA_netcon = [+2.308813794977427e-01   +1.185926491007479e-01   +8.999696043742357e-02   -8.500525701991202e-02   +9.110041416833034e-02   +7.464323107437135e-02; +1.672040743554246e-01   +3.629513996055530e-01   +3.518730052164121e-02   -6.594192193857193e-04   +5.099325659473385e-02   +2.433837104918615e-01; +1.840538790623549e-01   -2.039448434354969e-02   +3.372233045339265e-02   +1.547829790812396e-01   +1.570672798276667e-01   -4.641619956869499e-02; +7.009042599516110e-05   +1.722360782680988e-01   +2.113003328704788e-02   +5.926593689844924e-02   -1.013615756769548e-01   +9.746868739190961e-02; -2.209207788882569e-01   +5.185025182060832e-02   +1.036389847464030e-01   +7.313190161245722e-02   -1.760563698607296e-01   +1.196284297901715e-01; +4.278104708287810e-02   +1.113655434834235e-01   -7.323463308490499e-02   +2.197917455533927e-02   +1.993613851371857e-01   +1.080089342905681e-01; +7.972626493679517e-02   -1.144692074018476e-01   +3.975197652866171e-02   -1.949833437745075e-01   +7.882096081131824e-02   -9.761820721769857e-02; +8.773815663625802e-02   +2.004497798001118e-01   -2.359759033557993e-01   +1.466590532642917e-01   +1.647122215089089e-01   -9.566276676125879e-02; -4.318531338966331e-03   +1.151278292450642e-01   -8.648799195740195e-02   +7.069096504166411e-02   -6.328281058857828e-02   +2.902499775444579e-02];
L2_L3_iGABA_netcon = [+1.055769590361523e-01   -1.153388365441973e-02   +1.395631053833989e-01   -2.920457262163710e-02   -3.986560153709835e-02   +9.257118682743710e-02   +2.714189640735265e-01   +8.867401831083366e-03   -7.562046992769653e-02; -4.893842299444602e-02   -1.388391319241439e-01   +1.564624982087515e-01   -9.475827953944624e-02   +8.279549515703784e-02   +1.006877312338720e-01   +7.049610181049294e-02   +3.300293497973106e-02   -5.882354341633783e-02; -4.935774418335481e-02   -1.085425705342124e-01   +4.467050400399152e-02   +2.179928447967144e-01   -3.095386712291349e-01   +1.983453721183354e-01   -2.496341503325398e-01   +1.409173894364416e-01   +4.456286667678749e-02; +2.097377881733941e-01   +2.182447882896631e-02   -1.999414872664572e-01   +6.708844423768179e-02   +1.168313006409453e-01   +7.870548655731258e-02   +1.265732485489831e-01   +2.561114547120115e-01   -8.765560779745649e-04; -4.658266540479641e-02   +1.302677927310989e-02   -1.389461342632466e-01   -1.188002643987686e-01   -8.868012308816940e-02   -1.064333432308757e-01   -6.653632588423659e-02   +1.480957924540756e-02   -1.985543050604634e-01; +1.130985696012520e-01   +6.185520687280819e-02   -1.972109389346224e-02   -1.302317163714858e-01   -1.098491729009096e-01   +1.148338601795018e-01   +2.971547793745930e-01   +2.842547240412761e-01   +2.674375452519095e-01];
L1_L4_iGABA_netcon = [+1.909887449050559e-01   -2.336738123128692e-01   +5.417949280712500e-03   +1.574228699056419e-01   -3.441481700299259e-02   -5.982837727177737e-02   +1.683783611151390e-01   -4.929401465166268e-02   -1.738904150535616e-01; -7.547914870808028e-02   +5.404375302279941e-02   +8.928142128649826e-02   +5.025879770683363e-02   +2.701274920416386e-03   +1.749895674007525e-01   +1.462344328467246e-01   -6.036212756805566e-02   -1.431038857635398e-01; -1.261122038571823e-01   +2.470068298530944e-01   -1.383643299634791e-01   -2.260390648858622e-02   +1.236853041368798e-01   +3.812879064290105e-02   +2.862728839213978e-03   -8.063641842748161e-02   -3.296471347712038e-02; +9.734131291819786e-02   +3.142164759512962e-03   -1.135109242550221e-01   +3.786937606339071e-02   +2.383679132143507e-02   -3.725572177254897e-02   -1.122337956910925e-01   -3.963811847553288e-02   +6.216061181226595e-02; -5.612199401284482e-02   -9.107472276611295e-03   +2.630472547559420e-02   -7.749781740614921e-02   -4.777125888897564e-02   -3.114612183740589e-02   +5.395589326709754e-02   +4.586862473169780e-02   +1.451783744456633e-01; +1.833511612438503e-01   +9.815605062999461e-02   +6.460683769412798e-02   +6.918352895170596e-02   +6.941315486864272e-02   +1.723619940386349e-01   -5.784125446482834e-02   +2.005186878147389e-01   +1.174324316633369e-01; -6.380377630260303e-02   +2.877201070721831e-02   -1.354891567313473e-01   +1.341748177960499e-01   +5.221173862239038e-02   -1.240336135319391e-02   +1.879412631938389e-01   +1.509505948039650e-01   +1.272414631193664e-02; +1.064933880268800e-01   -9.842905902859667e-02   +1.582540268138989e-01   +9.836154818371208e-02   +1.500888753948147e-01   +1.608757213574590e-01   +4.918582129349437e-02   +1.275996450724719e-01   +1.466530000371095e-01; -1.155603650940994e-01   +8.605735652370952e-02   +6.679602100617124e-02   -6.014805607737186e-02   -5.452252274231940e-02   +1.281980027169019e-01   +1.028959403721362e-01   -5.896573917172884e-02   +1.635779226414175e-01; -6.165819523549242e-02   +1.741282105502939e-01   +7.973951802606534e-02   +6.896940315256306e-02   +3.849436038190557e-02   +2.069704988911285e-01   +8.950333001316334e-03   +1.885879663332583e-03   +1.363450715955847e-02; -1.900929111835550e-02   +7.256380059651300e-02   -2.049503790455726e-03   +8.240492327084212e-02   +1.811127393331700e-03   -7.240703591149300e-02   -1.304194340335026e-01   -1.159288112914613e-02   +1.326956593632958e-01; +1.351040897756421e-01   -1.490773614932383e-01   +1.313204669143396e-01   +2.322158256330000e-02   +1.573260330585528e-01   -3.348601219056770e-02   +6.983490929120076e-02   -8.368719383037590e-02   +2.451122984851183e-02];
L4_L1_iAMPA_netcon = [+2.018866242283880e-01   +1.368252411872662e-01   +4.107588542511990e-02   +4.800389444061152e-02   +6.767494270238879e-02   +5.992476914699942e-02   +7.562815815582397e-02   +1.445354814029959e-01   +9.795847155416652e-02   +1.350572148626002e-01   -3.150515071099913e-01   +1.209802217391470e-02; -2.508195155676689e-02   -5.027876519464915e-02   -1.442179442031164e-01   +9.740809279486830e-02   +3.013923020942601e-01   +5.775239660546135e-02   -1.345354759541483e-01   -1.811644923431112e-01   -4.000070886300817e-02   +2.305203227716507e-01   -8.864227217204418e-02   -8.123441508072909e-03; -2.192790992698895e-01   +7.641787603149311e-02   +4.813958568496963e-02   -1.072072056439444e-01   -3.533299271177767e-02   +1.930154396802413e-01   +1.399348919054990e-01   -4.352091031991727e-02   +1.008734745544980e-01   +2.501477454882101e-01   -4.539360627170433e-02   +1.862799605385476e-01; -2.332446919147751e-02   +3.280580099161041e-02   +1.773028598580908e-01   +6.216149625534383e-02   +6.700175504295433e-02   -1.147712745147955e-01   -1.206474932676360e-01   +1.287314972627879e-01   +1.106656699349787e-01   -1.524674215895710e-01   +1.855367879076089e-01   +3.994101074173675e-02; +1.390109102095344e-01   +7.583625265103824e-03   -1.152251066321726e-01   +7.222986913025610e-02   +2.276707133347569e-01   +3.217585351150617e-02   -5.556790096142604e-02   -4.879252746133893e-02   +1.449377476772406e-01   -1.594818730670285e-01   -2.316432891831081e-03   -4.926654220315807e-02; +5.465897631099524e-03   +6.092585014844680e-02   +4.132826007336264e-02   -7.771397409195295e-03   +1.168027643865955e-02   -5.913553953593208e-02   +4.854741934358806e-02   -1.421573397165898e-01   +1.738923548359531e-02   +2.205573105541846e-01   -7.506348921752129e-02   -6.689056396185704e-02; -4.927932969454967e-02   +9.668505593550808e-02   +1.643235848052273e-01   +5.049506408645035e-02   +7.057685451505739e-02   +1.620396241491866e-02   +1.123879181142521e-01   +3.160629745825033e-02   +1.613802401775086e-01   +2.260784123354833e-01   -9.201479232876572e-02   -1.000797572296075e-01; +8.630570602244429e-02   +4.884982229704055e-02   -1.317977830367792e-01   -1.759611450471558e-01   +9.528159608513921e-03   -3.002259010797784e-02   +1.907646887054619e-01   -1.019644049658799e-02   -1.323408112086017e-01   +1.352269762677473e-01   +2.314312182551797e-01   +4.779886950513147e-02; +7.074341809957917e-02   -1.689434941807454e-01   +5.370504501585149e-02   +8.823676682286023e-02   +1.876389290230739e-03   -7.771693450592985e-02   +2.583361545483424e-01   +1.018709075844120e-01   -1.219747438881514e-01   +8.222158600038833e-02   +2.789681831968983e-01   -5.894657266386333e-02];
L1_L3_iAMPA_netcon = [+2.494033165400759e-02   -1.438808182279019e-02   +2.740341155509623e-02   -5.190542139912192e-02   +4.707267084026425e-02   -1.077322763627757e-01   -1.771777773495803e-01   +1.637055210758299e-01   -5.732116855301460e-02; +9.612724481376524e-02   +1.876099064185404e-01   +3.493582509551302e-02   +3.070891753665859e-02   -1.169982976806184e-01   -1.235169735797724e-01   +1.592857325895709e-01   +5.346439805892336e-02   +5.756637173077933e-02; +9.620836959948149e-02   +1.025402241066291e-01   +2.607998960450555e-02   -1.171550728711698e-01   -3.351174868038105e-02   +1.952873339363970e-01   +1.251465300343454e-01   +3.361463201771371e-02   +1.474674376157707e-01; +9.926574331861858e-04   -1.574224555107237e-02   +8.630209522104703e-03   -2.076100482187725e-03   +1.066646519648735e-02   +1.120426893364296e-01   -1.179233751321074e-01   +2.945387142901956e-02   +1.620632012531699e-01; -3.705737343453397e-02   +1.671252327704907e-01   -5.159399655678167e-02   +1.115960061050935e-01   -5.011187319381345e-03   +9.928708880786052e-02   -2.121998465985531e-01   -1.084628143324664e-01   +8.158940808059612e-02; +5.204355258301543e-02   -2.705563630383887e-02   +1.734501255111720e-01   +1.199133626967040e-01   +7.402371565002691e-02   +9.688878183673956e-02   +2.305586605899793e-01   +2.286235683747740e-01   +6.986972138108702e-02];
L3_L1_iGABA_netcon = [-1.192801604044150e-02   +8.327341896480739e-02   +6.946631827581991e-02   +8.147976163148538e-02   -2.543003278984965e-02   +1.693941323049084e-01; +3.182875326025265e-02   +1.364507888932586e-01   +1.716851440770260e-01   +1.939143015724334e-01   -7.140285614446566e-02   -4.805020488656762e-02; +2.902703218650505e-01   +3.813139601455096e-02   -1.363075519618468e-01   +2.594275975713650e-01   -1.773433681761364e-01   +6.719505350575788e-02; +9.074993452509042e-02   +7.235281812582631e-02   -1.174592874082484e-01   -7.251492869126913e-02   -2.979980524326679e-02   -7.638067509852835e-03; +1.826499129830188e-01   -4.134280330874542e-02   -1.097212808410643e-01   +1.104538711875365e-01   -8.169120837648108e-02   +2.006509033031023e-01; +3.769740262283570e-03   +1.158955658323993e-01   +8.321450474502805e-02   -2.609574601840253e-02   -1.111719739387254e-01   +1.478112927069726e-01; +6.171593655925373e-02   +9.321973365847963e-02   -4.837125036202445e-02   -3.923092281666115e-02   +1.212982816351692e-01   -1.989613414412318e-01; +1.580474802181428e-01   +7.896747841936719e-02   +3.248797244905368e-01   -3.862729382513522e-02   -1.055729614400299e-02   +6.000451157601183e-02; +1.594018661200916e-03   -1.086594831840231e-01   +8.128437880276769e-02   -9.170960861934035e-02   -7.781170515003567e-02   +7.511336424513634e-02];
L5_Input1_iAMPA_netcon = [+5.625013519000718e-02   -1.007545333844051e-01   +1.200256234924698e-01   -2.428069171714286e-02   -5.382347989011527e-02   -2.848231864095369e-02];
L6_Input2_iAMPA_netcon = [-5.489225718401603e-02   -9.330527437777700e-02   +5.752692576352665e-02   +8.053988575951378e-02   +1.570376514962041e-01   +7.590189983250556e-02];
L5_L6_iAMPA_netcon = [+1.658087155180097e-01   +1.439285718297230e-01   +1.394919914136575e-01   -1.289283135542082e-01   +1.358602366493529e-01   +3.895419230905559e-02; +9.300899479908420e-02   +1.684855354896560e-01   +2.105975208761126e-01   +1.856413952447864e-01   +9.447420566875264e-02   +5.118278575336665e-02; +1.404941068599622e-01   -3.166609565268307e-02   -7.530919607518000e-02   -5.658105076733966e-02   +4.432815675898082e-02   +1.298161470659558e-02; +6.660836671054138e-02   +5.926519622091560e-03   +6.418537328504170e-03   -9.619586298912189e-02   -3.684680687161254e-03   -7.693968549130600e-02; +1.509157833599503e-01   -5.739189447996763e-02   +3.438310791487792e-02   -1.286075956702279e-01   -5.103273360575070e-02   -2.632170883615526e-02; -5.215752088217367e-02   -8.364004907654669e-02   +6.334722428980999e-02   +2.361046592385823e-01   -2.545888841961989e-01   +1.816657260594764e-01];
L4_L5_iGABA_netcon = [+1.380522703666031e-01   -9.559895300688392e-02   +1.656126411339127e-01   +3.883153735071360e-02   +1.223109051039018e-01   -5.007792157658968e-02   -5.990780642368000e-03   +1.666440628511358e-01   +1.085677596709222e-01   +3.732449229811759e-02   +4.418938555670738e-02   -1.299635891971097e-01; -2.457964336610646e-02   -1.121050852996250e-01   +2.812103384153745e-01   +2.620557707108440e-01   +8.795288721716343e-02   +1.170737630848843e-01   -1.363727930214024e-01   -1.465987060228208e-01   +2.194435466887035e-01   -9.618423223476175e-02   -1.162450856214419e-01   -1.041353216870034e-01; +3.708642855648074e-03   +2.821842920211318e-02   -6.661659447066692e-02   +1.262909219987710e-01   +7.995552800581182e-02   +2.504010294876943e-02   +1.644088983442541e-01   +1.495332419033991e-01   -2.463707463856470e-01   -1.527921828086019e-01   -4.835812127891112e-02   -1.798096326635510e-02; +2.654517711600285e-01   -1.473960683113974e-02   +2.578638904088617e-01   +2.150120522105178e-01   -6.539578577115282e-02   +2.406829450758304e-01   -2.328086092606058e-02   +1.651632606989009e-01   +8.373061175072039e-02   -7.646048525506405e-03   -8.331443751233989e-03   +7.088762171133696e-02; +3.520321733108438e-02   +1.348491027374955e-01   -1.109088663640967e-01   -8.496443197450368e-02   +1.245581754360057e-01   -6.974819846936609e-02   -6.435869793580927e-03   +6.375551169865815e-02   -8.692591422523924e-02   +1.891513155491139e-01   +1.322397681246038e-01   +1.082840153973367e-01; -4.603464995188329e-03   +2.344283059883988e-01   +1.353473029033758e-01   -3.671937869217091e-03   -7.466023142515039e-02   +5.080806020228464e-02   -1.195188428207049e-01   +4.776225950549560e-02   -2.254599602453606e-02   -1.282539151489940e-02   +1.472258325269833e-01   -1.819209675914930e-02];
L6_L4_iAMPA_netcon = [+2.328669092013939e-01   +1.585125208196646e-01   -9.281702272970163e-03   -1.875322641768815e-01   -1.018546145928632e-01   +7.986027745652763e-02; -1.276999255327543e-01   -8.291124724594395e-02   +1.523326418339035e-01   +3.684982187919243e-01   -1.313332011971125e-02   -2.194920235564552e-02; +1.645621757883182e-01   +8.987574011839406e-03   +2.681168561174669e-02   +1.880926345611754e-01   +5.732269066171040e-02   -7.011515675108401e-02; +7.075660210802688e-02   -8.549541326020831e-03   +1.315761835673547e-01   +4.888731165382585e-02   -1.727730383439296e-01   -7.824614051446277e-02; -2.055127638122276e-02   +1.677989753812201e-01   -1.331657407443975e-01   +8.956134970706213e-02   +2.356876772420969e-01   -4.000045579951990e-02; -5.750806070869028e-02   -1.475736813206290e-01   -7.271766291985940e-02   -1.125260240440536e-01   -7.910526234018465e-02   -2.145644261953592e-02; -7.611092850268351e-02   -4.218732572845573e-02   -9.200699314804802e-03   -2.830258487555389e-01   +2.147073115416286e-01   +9.004646097844687e-02; +8.373840567782981e-02   +1.405927139368980e-01   +4.616607568346292e-02   +3.357053716744274e-02   +1.759662662164618e-02   -3.927044887010726e-02; -1.315942417051260e-02   -5.592501314988978e-05   +1.152108409249072e-01   +1.556611620715368e-01   +2.144646457895009e-01   -8.749005881756901e-02; -4.740994636070651e-02   +1.244584467695100e-02   -1.661420091090801e-01   +5.748286775098072e-02   +1.413645824796265e-01   -6.678179668532294e-02; -5.134229341300258e-02   +1.171357282367431e-02   +9.218110128573107e-02   +3.636072602415331e-02   +2.138075465165893e-01   +2.785826651639142e-01; +1.503964074513673e-01   +1.062867477406174e-02   +5.628245050415995e-02   -1.291589995927147e-01   +1.428992250751886e-01   -1.579905845429128e-01];
L5_L4_iAMPA_netcon = [-8.427582882441061e-03   -1.068510084350819e-01   -3.825204481792993e-03   -9.369038965616561e-02   -1.495451668155831e-01   -3.408604265170921e-02; -1.387583540361258e-01   +1.191918681632303e-01   +6.290717152816823e-03   -5.085022288607972e-02   -6.120508043040006e-02   +7.006770022138993e-02; +3.678515636708450e-02   -2.410652860857424e-02   +4.313196110117760e-02   +2.476112986503378e-03   +4.200529236283203e-04   -1.320349937971100e-01; +1.331255588244642e-01   -1.255791180042509e-01   -1.329759442278057e-02   +8.414756779833775e-02   +6.854427904550496e-03   +7.599200194855468e-02; -1.180177179007986e-01   +1.478209098250497e-02   +2.380109224972909e-01   -2.769690353341361e-03   +1.180700517608073e-01   +3.020981622596548e-02; -1.114775332054119e-01   +9.840738814629162e-02   +1.177143230332493e-01   +3.585141967165067e-02   +9.621015715782973e-02   -6.398844456069451e-02; +1.210030656518857e-02   +1.588593236532690e-01   -5.325755467055554e-02   -7.000109501461206e-02   +2.047123441177840e-02   -1.343205829815573e-01; -1.012888248329833e-01   -9.443734817212595e-03   +2.232791186227276e-01   -4.600451751430005e-02   -4.486648329246105e-02   +7.487852228873280e-02; -8.524884891146162e-02   +1.769512996152982e-02   +5.615844228870915e-02   +4.522705715926925e-02   -2.953474978046316e-02   -1.348740817736014e-01; -1.353781979812530e-01   +1.392140595634365e-02   +2.442733461925364e-02   +8.995537147727178e-02   -1.297570630433358e-01   +1.534715836073342e-01; -2.915764487532996e-02   +1.698788301115894e-01   +7.960235066453544e-02   +1.299370734316375e-01   -9.014052568312400e-02   +1.295296721810733e-01; +2.662228047296483e-01   +8.593224811228518e-02   +2.833751194657575e-01   +2.620116900720527e-02   +1.495519963355410e-01   -7.448470798264037e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
