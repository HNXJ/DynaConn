function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.000000000000000e+00   +1.399121117674631e-01   +7.963169671817554e-01   +6.785363963060872e-01   +4.711826996219909e-01   +8.731884292953286e-01   +4.745169783704976e-01   -2.187644223472207e-01   +2.799603684026642e-01; -3.704980119319323e-02   +4.328198389047549e-02   +4.181876831923054e-01   +7.950892805121653e-01   +9.226853696341993e-01   +4.924033996217799e-01   +9.148656195111204e-01   -2.077678026396549e-01   +5.646409592349263e-01; +3.735604424292865e-01   +5.478948411056320e-01   +4.871169930621939e-01   +4.115097239122840e-01   +1.848495662362855e-01   +3.997460362193270e-01   +3.812997526305941e-01   -4.789618436762669e-02   +2.651879900702440e-01; +4.617727607613150e-01   +4.520063160408634e-02   +7.242399898783297e-02   +2.223132012495504e-01   -1.625243755841438e-01   +1.337052546709848e-01   +4.073961252340481e-02   +1.981922739423742e-01   -8.782205402426410e-02; -2.623389076220521e-02   +4.083949558333701e-01   +4.471954511113406e-01   +3.904861876137640e-01   +4.891468720036873e-01   +7.549433983993927e-01   +6.997997227342859e-01   +5.932548985242323e-01   +3.190415741372381e-01; -1.397205865636071e-01   +3.949598308818112e-01   +5.893899152979876e-01   +3.166540645647073e-03   +2.138516712861186e-01   +3.191657038941755e-01   +8.478663374752005e-01   +3.978692441783149e-01   +4.203476106347876e-01; +9.551794776713669e-01   +7.323755456651486e-01   +3.371903214253326e-01   +6.231470233125609e-01   +1.850806102783558e-01   +2.235114945838688e-01   -1.039824507897092e-01   +9.885147659245609e-02   +2.459060354165623e-01; +9.905362184202147e-02   -3.293718334389962e-01   +8.489552252420213e-01   +6.184202596943805e-01   +1.610808945714792e-01   +6.767015103448526e-01   +2.342848586367310e-01   +7.070469570825024e-01   +9.580112363521771e-02; -1.707560371815925e-01   +4.752510184609538e-01   +4.716716411539649e-01   -1.407624447095862e-01   +8.809103896180258e-01   +4.698350041322988e-01   +6.642003595234844e-01   +3.034565389524288e-01   +8.027452229298881e-01];
L1_L2_iAMPA_netcon = [+6.981224514911423e-01   +5.158842222104595e-01   -4.556023068126944e-02   +1.681262025050326e-01   +5.065456336991814e-01   +5.359113704627132e-01   +6.753839091629555e-01   -1.794400571397584e-02   -1.075977018234269e-01; -9.274871250034341e-03   -1.393919661685587e-01   +8.484512932009773e-01   +6.736323478888053e-01   -1.819629422582343e-01   +5.626091715338691e-01   -1.045112022307263e-01   +2.942783969874435e-01   +5.976433184175407e-02; +1.625017629914503e-01   +4.474864537881659e-01   +1.806638218275070e-01   +4.686931771461166e-01   +1.289464123078308e-01   +7.926948642874707e-01   +4.903346464319361e-01   +3.082463573544207e-01   +2.704418574624461e-01; +5.893110942453585e-01   +8.604738054809594e-02   +1.492802645984429e-01   +4.084906484474840e-01   +2.487717846004932e-01   +7.676542033379689e-01   -1.226744105430070e-01   +6.302622779534105e-01   +1.582960612611010e-01; +6.509257400705778e-01   +7.373803806586690e-02   +4.207613599610188e-01   +1.597869804643192e-01   +8.152267000936501e-01   -2.452539524492152e-01   +4.135429242586612e-01   +5.480452595664438e-01   +1.000000000000000e+00; +2.408877250891228e-01   +4.829716854218896e-01   +6.525155058716949e-01   -2.064585606622595e-01   -5.688761137367706e-02   +2.962555115101436e-01   +7.370213605772007e-02   +3.247315837872669e-01   +1.015669849467323e-01; +6.708333431818840e-01   +8.129554326719233e-01   +7.813533311642703e-01   -1.461859595145547e-01   +1.746015611164405e-01   +7.585785292995834e-01   +4.086877116250644e-01   +9.396203801799988e-02   +4.674229078832438e-01; +5.884569948839322e-01   +4.638850402195317e-01   -1.810667637263647e-01   +3.145725597526543e-01   +3.463278850631207e-01   +3.584817747686798e-01   +1.405367245363845e-01   +2.030428296421382e-01   +3.396922256061404e-01; +6.231216031037438e-01   +4.731736712452971e-01   +7.513255108331066e-01   +2.245936062147953e-01   +1.131397756563699e-02   +4.805136334634526e-01   +1.944814001502131e-01   +3.226327091204313e-01   -2.565095072199462e-01];
L2_L5_iAMPA_netcon = [-6.021388328830998e-02   +4.130144279205171e-01   +4.483154755016763e-01   +8.600093332645038e-01   -2.095260580927412e-01   +9.666999922686916e-01   +7.601968844442104e-01   +4.735535286224398e-01   +1.516090068898609e-01; +8.213519001547312e-02   +3.766496019652147e-01   +2.155524894948776e-01   +1.783860592333429e-01   +5.865259359321386e-02   +6.040533216499178e-01   -1.073843884498560e-02   +7.029188666881339e-01   -3.168770509587868e-01; +3.927934875721037e-01   +6.887182530480587e-02   -4.838833902224660e-02   -3.469868540475315e-01   +5.732809615790416e-01   +2.062418737115844e-02   +2.230453402302119e-01   +3.504253622528909e-01   +1.000000000000000e+00; +4.331831574827509e-01   +1.601168116850272e-01   +1.975519685643934e-01   +3.060209551378476e-01   -4.190909089653250e-02   +4.361232676492117e-01   +5.082833375023704e-01   +6.099271917964160e-01   +8.195378325100302e-01; +6.715665446726831e-01   -2.300050165418567e-01   +4.413890530465201e-01   +4.687114672507331e-01   +1.042923448514276e-01   -6.701193861737699e-02   +2.328180028976274e-01   +4.929923138262459e-01   +5.864853506267257e-01; -1.430432770735426e-01   +2.522740471772570e-01   -8.295742654587408e-02   +1.147522560066854e-01   +4.408514957970360e-01   +7.688877892416038e-01   +3.962088416376354e-01   +5.837997452025696e-01   +6.068493961873987e-01];
L5_L2_iGABA_netcon = [-1.308007515080628e-01   +2.791180324063622e-01   +3.735091092004084e-01   +6.503393132444633e-01   +2.570004302773544e-01   +5.195212728762917e-01; +4.398957712812297e-01   -6.040509068438139e-02   +2.750447257086335e-01   +2.888398240968939e-01   +7.833847133992696e-01   +6.595082217632536e-02; +7.401630911613746e-01   +2.976534633606888e-01   +1.000000000000000e+00   +2.777880530798372e-01   +6.442680989960355e-01   +1.717509306379037e-01; +7.611407350611310e-02   +7.626869843213613e-01   +3.205579006418812e-01   +4.946954271360980e-01   +4.309024548545937e-02   +2.090166022555077e-01; -3.096709764844012e-01   +4.020285919272862e-01   +5.404983889941254e-01   -2.347861058100140e-01   +3.459183831341906e-02   +9.837755417687161e-02; +4.008259808980570e-01   +7.254013752415444e-01   +3.034284128716852e-01   +3.177735328710437e-01   +1.658397259942399e-01   +6.096381276189279e-01; +4.384343046119290e-01   -2.509079071324442e-02   +5.546491287590181e-02   +1.886671539060750e-02   +6.930275113958680e-01   +9.747363301455741e-01; +7.232506547976908e-01   +5.029593092388190e-01   +3.761209457442078e-01   +2.314578847428350e-01   +6.271370579613121e-01   -2.515460826419919e-01; +3.794095775989547e-01   +2.726353001403015e-01   +6.168590665768734e-01   +2.970110412508273e-01   +1.871964698161487e-01   +1.637961887377098e-01];
L3_L2_iAMPA_netcon = [+2.271030735907787e-01   -1.306663941672234e-01   -3.062677251628264e-01   +4.040732661427274e-01   +4.881437427416079e-01   +4.110231093847153e-01; +4.690542051658693e-01   +1.661854922725744e-01   -3.573399287492969e-02   +5.800506409467460e-01   +6.330198179653665e-01   -1.221837626509983e-01; -2.868673727282353e-02   +1.156899457142495e-01   -1.324176614905411e-01   +8.204219918322750e-01   +1.446494604799147e-01   +5.789266458148705e-01; +3.130859323812688e-01   +7.199600953559300e-01   +3.155938433335365e-01   +5.196314894045759e-01   +5.286029266192118e-01   +3.732269102376138e-01; +5.327159281727034e-01   +3.922182383567266e-01   +3.727199072335960e-01   +3.027899291998618e-01   +5.935796978437029e-01   +1.382596318894186e-02; +2.229952844601039e-01   +7.438627179803831e-01   +3.350089533379124e-01   +4.824434624270587e-01   +4.379420972943754e-01   +4.402833098907918e-01; +5.085149923127313e-01   -1.770973115174840e-01   +4.868618854760920e-01   +2.716060084727844e-01   +3.520213637063133e-02   -2.976862762419600e-01; +3.999351324137796e-01   +7.510835605728315e-01   -1.986668094157834e-02   +7.387562503004121e-01   +4.686877335843188e-01   +4.461606424923040e-01; +1.627860602878752e-01   -7.029248716230235e-02   +1.002988133390523e-01   +1.611185444792070e-02   +6.117869010297509e-01   -8.070537159798644e-02];
L2_L3_iGABA_netcon = [+3.477136424277297e-01   +4.004748093762356e-01   -5.950604614357868e-03   +4.560599781745132e-01   +2.369121215663575e-01   -2.069877960103565e-01   +5.306063756009851e-01   +1.553403813276302e-01   +4.062134706035208e-01; +1.902113629296627e-01   -3.209740450416093e-02   +6.769987760471985e-01   -3.212846831377529e-01   +1.622791346647800e-01   +6.336630590040784e-01   +4.380310408232028e-01   +6.647629124748360e-01   +6.370856047269164e-01; +6.696139069991378e-01   -2.776838380987625e-01   +5.327973311583301e-01   +3.486044431599126e-01   +2.289586457185880e-01   -1.663421458696548e-01   +7.153693355648192e-01   +3.097563868546198e-01   +5.707060195012876e-01; +7.263585633089988e-01   +4.360468405619609e-01   -2.302169965208676e-01   +3.804332936742501e-01   +3.421886105121968e-01   +6.579592574066075e-01   +5.079468155239146e-01   +2.801034077335812e-01   +9.708174203298663e-02; +1.909351786844902e-01   +3.572869762704689e-01   +8.167844816528704e-01   -2.378231738731168e-01   +3.747105021216248e-01   +9.351553181710985e-01   +5.631267319788390e-01   +4.713786253942082e-01   +8.404647320990564e-01; -7.498982964876508e-02   +9.617701893055228e-01   -2.527325471265524e-02   +8.254652083625367e-01   +6.297234421965587e-01   +5.628802366504329e-01   +4.035493017677558e-01   -1.719689011045794e-01   +7.150538662940100e-01];
L1_L4_iGABA_netcon = [+1.895719587273158e-01   +7.141804268281572e-01   +4.898248545503195e-01   +4.197398672419706e-01   +3.517999257209397e-01   +4.635562098968504e-01   +4.238331750251498e-01   +3.693260748262798e-02   +3.577419552874092e-01; +4.315804637108032e-01   +6.476053797402892e-01   +4.752863943458419e-01   +3.110303394336436e-01   +4.726984087073098e-01   +1.260966647406500e-01   +7.558219655509332e-01   +8.047583085497204e-01   +3.013607259304878e-01; +7.704722306781098e-01   +1.827709935777742e-01   +2.657211979402830e-01   +4.978431039596332e-01   -7.070465012485944e-02   +7.729009529244155e-01   +4.923408475295637e-02   +2.417696449935910e-03   -2.898163882370101e-01; +9.035628136690741e-01   +3.151962134757001e-01   +4.401008836983615e-01   +3.495988609003250e-01   +1.794881610584345e-01   +2.842868712170323e-01   +3.728601414234996e-01   +5.455558668328320e-01   +7.291381547398519e-01; +3.240297076612564e-01   +1.722684627284034e-01   +8.645745205471220e-01   +1.849654378361962e-01   -3.793948840025361e-02   +5.040990561300621e-01   +1.794824039214598e-01   +4.039705803386215e-01   +6.450935788999679e-01; +6.118514510444379e-01   -4.637930172893835e-02   +5.443280914017781e-02   -6.075531931522343e-02   +8.265987657215165e-01   +1.000000000000000e+00   +1.090628641368218e-01   +1.908413640237983e-01   +3.680677324863280e-01; +5.688171903853043e-01   -2.819346899336171e-01   +1.855810724884195e-01   +3.412445273520383e-01   +2.554783226637778e-01   +4.846120803003633e-01   +6.259286568066905e-01   +8.175779196844852e-01   +3.664261646852627e-01; +4.219812979411657e-01   +4.488162621082676e-01   +5.884239699351859e-01   +5.413695780174793e-01   -5.764152080119020e-02   +6.132339700194855e-01   +3.411826216982790e-01   +3.471417916331497e-01   -7.683871555489293e-02; +6.155262546990692e-01   +6.148121500572280e-01   +4.001852982310566e-01   +8.340528843768765e-01   +3.541389478389073e-01   +2.519099228687364e-01   +4.661127567787370e-02   +3.665082481986791e-02   +2.115347520131806e-01; +5.962488185045390e-01   -2.129919923211316e-01   -1.473040924955177e-01   -1.173592244821934e-01   +8.006484586869628e-01   +3.037602537559647e-01   -1.218474268727206e-01   +1.177432850704184e-01   -6.476336293299895e-02; +7.085864256494977e-01   +4.830197541351940e-02   -6.347264487108520e-02   +3.413296009694430e-01   +2.911723445686893e-01   +7.249789026341642e-03   -2.170468166535762e-01   +1.916448397643478e-01   +3.374499471862822e-01; +3.936247661608194e-01   +4.248466487513704e-03   +5.648194106256034e-01   +3.487415707708826e-01   +4.437678074582421e-01   -1.060563830789546e-01   +3.479977010183469e-01   -7.291311522450544e-02   +4.026381191549773e-01];
L4_L1_iAMPA_netcon = [+4.906969910894323e-01   +4.672422364075653e-01   +1.510941690622270e-01   +8.507751353846492e-01   +8.265355277768531e-02   +4.495038484371583e-01   +2.211885078677716e-01   -8.466928097279411e-02   +7.976805684262172e-01   -1.223282655357256e-01   -1.061350979857068e-01   +7.190845315695549e-01; +1.739784193395945e-01   +7.656952321589945e-01   -4.704265546140922e-02   +1.380871720155135e-01   -9.782452670489362e-02   +4.335931592678158e-01   +7.498734085861639e-01   +3.581825466359460e-01   +1.528435325580297e-01   -5.670749518779066e-02   +7.058354453854321e-01   +8.847892878118562e-01; +4.525585095792219e-01   +5.682674901882357e-03   +3.346123314522184e-01   +2.147375824514692e-01   +2.818777650531108e-01   +5.134672625354577e-01   -1.994067908219874e-01   +6.951863384673811e-02   -1.702018360484072e-01   +8.659701542344547e-02   +1.830648544927185e-01   +2.071243966633768e-01; +1.611836823985009e-01   +5.422180525432003e-01   +4.616750150056915e-01   +2.168034934031448e-01   +5.253272644573849e-01   +6.113337142365797e-01   +3.731929828988944e-01   -2.147873297826160e-01   +9.689540256081745e-01   +7.357283653538622e-02   +8.029362184290659e-01   +4.776131204720823e-01; +2.244875424734545e-01   +3.549839663193479e-01   +3.787511527654758e-01   +8.575057557400342e-01   +1.455827639719873e-01   +1.818249138587829e-01   +1.614464408755665e-01   +6.616501295414136e-01   +5.163674706809899e-01   +9.822631841166019e-02   +3.062734124144454e-01   +6.103424201452812e-01; +2.077956493918489e-01   +7.440413705658848e-01   +3.358626898173506e-01   +4.119606144489693e-01   -1.052196084922783e-01   +5.239145690513166e-01   +6.849650141064352e-01   +2.651268992001857e-01   +4.109404481211524e-01   +6.067941317133979e-01   +5.142166514247366e-01   +3.992018639984597e-01; +7.501085261267537e-01   +5.719943374990066e-02   +6.360310764961428e-01   +3.457660500918884e-01   +1.120463757690480e-01   +4.596215288273841e-01   +6.803690777901197e-01   +2.080145942080281e-01   +8.938667741852668e-01   +6.889435627570256e-01   +6.280932344474146e-01   +1.000000000000000e+00; +8.318603821674793e-01   +3.417622704026742e-01   +4.469655972093666e-01   +6.758679734947993e-01   +4.734721784488054e-01   +4.315224090707576e-01   +1.631267027104966e-01   -1.835049788093403e-01   -3.301276852649305e-01   +2.081315179418253e-01   +1.877648135942326e-01   +5.288037259460944e-01; +5.355060532657190e-01   +5.764388945597427e-01   +6.687111980383100e-01   +2.620923448053125e-01   +7.811072950392103e-02   +8.118639663780399e-01   -1.561837386252413e-01   +3.682240924969568e-02   +4.046261057960887e-02   +7.246894821422716e-01   +1.790609731989212e-01   +4.380044081026862e-01];
L1_L3_iAMPA_netcon = [+6.693959655031665e-01   -2.740354866263994e-01   +2.962776851746388e-01   +2.033243178366716e-01   +2.605317334701354e-02   +1.167893144458379e-01   -6.182935502447613e-02   -2.645367914130572e-02   +7.457083216390020e-01; -3.691988602885746e-02   +8.853135263622319e-01   +5.184092358665278e-01   +3.643989434686983e-01   -2.379438858444225e-02   +4.530209449276105e-01   +3.021994446389064e-01   +6.699995722832954e-01   +8.847683835416178e-01; +4.166177536606959e-01   +1.000000000000000e+00   -7.110382137971007e-02   +5.547427321026089e-02   +2.039531853126234e-01   +1.244941832307493e-01   -2.647868954975169e-01   +3.634817899497505e-01   +2.421718172466286e-01; +3.128498896609616e-01   +4.850188743272128e-02   +5.180486434990957e-01   +3.483167953990410e-01   +4.828104043314319e-01   +1.796222127018858e-01   +5.519707620187259e-02   -9.515366218690600e-02   +5.302589865036532e-01; +3.865122238616119e-01   +5.249076335174914e-01   +7.814442563349592e-01   +3.386587368691081e-01   +3.183860550987511e-01   -1.091996689183113e-02   +5.557400127699410e-01   +1.417326334610005e-01   +7.831256988292269e-01; +6.007259660350831e-01   +2.557556004710150e-01   +3.951839998868002e-01   +4.396165543682611e-01   +6.501086213348627e-01   +1.846414641836882e-01   +2.186303854007658e-01   +5.331037861692270e-01   +3.281712239284200e-01];
L3_L1_iGABA_netcon = [+3.575635150704033e-01   +5.086999733549666e-01   +8.232610379057993e-01   +2.881027966827283e-01   +4.118433007540597e-01   +6.708228415402990e-01; +1.603454640046378e-01   +2.984421227056672e-01   +3.124814283942795e-01   -2.437028388720956e-01   +1.694644744456444e-01   +3.133477151344209e-01; +4.683536993871761e-01   +7.872494193812100e-01   +3.077216081146092e-03   +4.873558771855988e-01   +5.581360456335535e-01   +5.747920311966209e-02; +6.308377156391731e-01   +7.608750706095174e-01   +9.687379555104072e-01   +2.886297178223056e-01   +8.900636673539660e-01   +2.667649052213212e-01; +6.677191182154063e-01   +6.492488813704564e-01   +8.218781092176241e-01   -7.081732286564398e-03   -2.476044894193662e-01   +3.668815859924178e-01; +2.110970568477797e-01   +9.213375746066219e-02   +6.182387424031620e-02   +3.678646963492753e-01   +2.407518385754499e-01   +1.602577080451070e-01; +4.375100164678073e-01   +2.659571533330518e-01   +3.177676114153057e-01   +4.418487586476637e-01   +1.492298092853925e-01   +5.084416557391539e-01; +8.088922141983116e-01   +5.410653288654273e-02   +5.124858879496075e-01   +1.000000000000000e+00   +1.092578561991029e-01   +5.484082130180320e-01; -2.775344478811095e-02   +2.887035792181076e-01   +2.294150069523031e-01   +4.226325004120761e-01   +1.386904809694901e-01   +3.328486685599442e-01];
L5_Input1_iAMPA_netcon = [+1.604786252253309e-01   +5.995476270317561e-01   +6.966157751892408e-01   +6.573189223158931e-01   +6.655264714673118e-01   +6.615016295676529e-01];
L6_Input2_iAMPA_netcon = [+2.647838091036105e-01   +3.132404153946503e-01   +5.218386380133626e-01   +7.232282325126168e-01   +8.648041657560490e-02   +4.063563172215265e-01];
L5_L6_iAMPA_netcon = [+3.709268787659697e-01   -2.276403579259765e-01   +6.768446752708478e-01   +7.084485682649142e-01   +3.856073923782899e-03   +1.046351886911567e-01; +1.012912712656021e-01   +2.263049452883358e-01   +6.635432161617394e-01   +3.560310626679667e-01   +2.234482546930152e-01   +1.626353764534873e-01; +2.437539365147347e-01   +8.951470712397092e-02   +2.510864268606037e-01   +2.968385405569995e-01   +5.966260554469985e-01   -2.303303912493462e-01; +5.260185175751231e-01   +3.935354587840927e-01   +3.672956462610120e-01   +1.347136176524071e-01   -5.502734312439070e-02   +3.269379867032923e-01; +3.457097378030624e-01   +3.354559135649605e-01   +2.316120204825279e-01   +7.820095720664397e-01   +4.034063447039354e-01   +3.958075052784910e-02; +3.489808928307630e-01   +1.317516088256221e-01   +5.980721378875524e-01   +4.038168236541371e-01   +9.256933247736236e-01   -1.579160501475396e-01];
L4_L5_iGABA_netcon = [+2.500060361842329e-01   +4.583452180371922e-01   +1.000000000000000e+00   +6.089126937859074e-01   +6.027189359396818e-01   +1.141594603027531e-01   +3.763649949162636e-01   +4.083645608460233e-01   +1.289172159667935e-01   +6.779548230943798e-01   +1.022366846660440e-01   +1.212829157763476e-01; +4.010029209653784e-01   +6.529463712426690e-01   +5.853229974677129e-01   +3.089813837493686e-01   +9.054090242057964e-01   +4.044772129744455e-01   +3.576289169804475e-01   +1.697796251303043e-01   +1.939005338337110e-01   +7.598232187739778e-01   +3.651653369661811e-02   +5.005350627125839e-01; +4.422785024563184e-01   +8.652232293731013e-01   +4.006425862163565e-01   +5.133247725017817e-01   +3.757374610670909e-01   +6.841704188808455e-01   +3.272347379373205e-01   -1.090841444782171e-02   +4.861616505018563e-01   +7.950712474156789e-01   +3.102128715587996e-01   -3.456475943182794e-02; -2.025174396130854e-01   +6.066440923575234e-01   +5.900549714457682e-01   +3.726295443207456e-01   +3.198327540471401e-01   +8.307756880918983e-01   +4.624999785758039e-01   +3.422049772442003e-01   +6.284795635983099e-01   +6.350011946136179e-01   +3.622175829588568e-01   +9.046063279284421e-01; +4.494382505027488e-01   +4.328414129008118e-01   +2.894156720224944e-01   +3.163523756677088e-01   +6.903690086040569e-01   +3.087360176184115e-01   +4.304150220476982e-01   +4.220771985093769e-01   +3.766015007028559e-01   +5.779238675874326e-01   +6.468150991092596e-01   -5.117388957768832e-02; +2.875546541174556e-01   +8.268872263798094e-02   +5.392997707359977e-01   +3.220251904135492e-01   +4.888908022300250e-01   -3.182621139416476e-01   +1.441120438843685e-01   +3.410892144529765e-01   +4.773353738918454e-01   -1.577988038680218e-02   +3.648834764128679e-01   +2.398663332651181e-01];
L6_L4_iAMPA_netcon = [-5.734871675734331e-02   +6.822594707825853e-01   +5.114914423520623e-01   +6.215162760710755e-01   +3.725138952152718e-01   +3.696294505642355e-01; +7.531915471882096e-01   +6.259371785186716e-01   +4.334046172198727e-01   +3.303747472515268e-01   +5.246258475578532e-01   +9.234998153424676e-01; +6.121720769673432e-01   +3.479209198639237e-02   +1.890184800028733e-02   +1.118650262882094e-01   +3.915359763260347e-02   +2.541906276904074e-01; +4.252664226888690e-01   +7.359876003889487e-01   +4.033390694157424e-01   +3.700483750511262e-01   +4.408281227800435e-01   +6.046751234701009e-01; -1.118560844461642e-01   +4.925757942950524e-01   +2.253502469546496e-01   +6.003645224589830e-01   +9.682436746410205e-01   +1.149617566314813e-01; +3.593059859241587e-01   +1.902096266685317e-01   +1.895125153771320e-01   -1.122427328780657e-01   +4.499362002103293e-01   +8.117886894481535e-01; +7.714304252554863e-01   +1.658855932473418e-01   +3.772297626442721e-01   +4.525754590895593e-01   -4.341791303363000e-02   +3.871714647411900e-01; +3.201948335747984e-01   +5.565593205454823e-02   +2.522683515344548e-01   +1.261627873410154e-01   +2.393515155510178e-01   +2.718020706389629e-01; +1.651345153533056e-01   +4.548482248949031e-01   +4.580248587803559e-01   +3.931510934383479e-01   +1.759241647814817e-01   +1.000000000000000e+00; +2.704642887667176e-01   +4.959374341471519e-01   -1.881062866382081e-01   +1.780484203002006e-02   +2.596346493615218e-01   +2.890904123338385e-01; +2.742638624480982e-01   +5.750111301580570e-01   -7.396426641636286e-02   +2.748396065130211e-01   +3.887580898019546e-01   +6.097624943402029e-01; +5.834383778460208e-01   +2.256780700371922e-01   -2.067185157422297e-01   +6.446790383801955e-01   +5.340821162239564e-01   +7.581593304532086e-01];
L5_L4_iAMPA_netcon = [-1.428573420594492e-01   +3.651164525566964e-01   +9.660674598447800e-01   +2.414692832864299e-01   +7.305786147993368e-01   +5.277233706494437e-01; +3.740638184415596e-01   +5.601866027806077e-01   +9.076588069822889e-03   +8.870527305851543e-02   +9.268125194685081e-02   +7.266333877173209e-01; +3.989932572753756e-02   +9.385938850430965e-01   +2.118848649535544e-01   +6.738641311780104e-01   +4.138834731759376e-01   +4.371173075546699e-01; +8.240223115148250e-02   -4.556060783243576e-02   +3.583986622343856e-01   +8.997045937131116e-02   +4.864892221681925e-01   +3.410109992619864e-01; -1.215657844929167e-02   +2.384149555554003e-01   +4.782596130443094e-01   +1.081994138147998e-01   -1.557670054122662e-01   +5.191508784267114e-01; +2.805682328255763e-01   +2.439225836740681e-01   +3.393449939015681e-01   -6.275743597379396e-02   +7.651498486853352e-02   -5.887877730136867e-02; +3.967392625742437e-01   +1.507020071555227e-01   +3.512153180354880e-01   +1.000000000000000e+00   +1.701520885441850e-01   +9.039002484178468e-01; -1.068617450714743e-01   +9.224948567146278e-02   +4.205048803144446e-01   +5.143733019254110e-01   +3.521867504612751e-01   +3.947211888270184e-01; +2.791399588498307e-01   +2.652352305270262e-01   +5.500021745154542e-01   +5.837486114149061e-01   +4.807780583506187e-01   +4.695224637360320e-01; +3.884410809842161e-01   -1.606541464532235e-01   -3.264322034659831e-02   +6.353575779445562e-01   +5.449952073671498e-01   +6.467873073770847e-02; +3.635793172098541e-01   -1.299097344390431e-01   +4.289320063548135e-01   -9.191805563636572e-02   +6.089334312179526e-01   +1.564284081670593e-01; -2.638987936433562e-01   +8.061347439492614e-01   +3.601772764363473e-01   -4.564012980577727e-02   +2.367951902135687e-01   +3.024950271721254e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
