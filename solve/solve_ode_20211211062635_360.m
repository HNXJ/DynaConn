function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.917126610580147e-02   +2.953231249211882e-01   +1.932048565565574e-02   +4.362175748161577e-03   +3.323658848568661e-01   +7.678322691254735e-03   +6.684632212097021e-02   -2.399284744013506e-01   -1.560345744614088e-01; +1.982371085156354e-03   +4.471401249133630e-03   -1.121160432963401e-01   +8.071443919288551e-02   +7.766143823722375e-02   +2.599655379469937e-01   +6.649199641939171e-02   +2.622113278049417e-01   +2.091254794141167e-01; +2.332019666735766e-02   -4.742069045368183e-03   +2.648510751882126e-01   +2.045362880119060e-02   +4.846695160083875e-02   -2.033530577700831e-01   +1.250868855356800e-02   -1.866931114865879e-02   +2.404156057396281e-02; +1.086875176263431e-01   -1.212322457114109e-01   +2.001342900072337e-01   -1.073654256595110e-01   +4.964343798795293e-02   -6.626892126563250e-02   -1.206479340370846e-01   +7.658319165241202e-02   -9.133706094424603e-02; -1.745931337262917e-02   +5.511746048885438e-02   +1.503459479028174e-01   -8.316424957766361e-02   +3.501337500388292e-02   -9.641050922709157e-02   -1.562596276932759e-02   +3.008107251214895e-01   +2.385958807487439e-02; +1.326729667701256e-01   -7.319762177968089e-02   +3.124802824034183e-01   +1.769965573207060e-01   -1.598039076092105e-01   +6.556338677153144e-02   -2.164406288361836e-02   +1.967645601435848e-01   +1.713438206705571e-01; +2.009133159937219e-01   +2.149851752783584e-01   -3.204689827174617e-03   +2.580792176975212e-01   -1.562202531401037e-02   +1.900915893496842e-01   +9.270134327492331e-03   +3.484837305457540e-01   +6.153878646223789e-02; +2.974968049111930e-01   +1.801206271590375e-01   +5.928170245319957e-02   +9.388811128156890e-02   -1.233334925388514e-01   +2.558630337094796e-01   +3.391692375735446e-02   +1.031333909702332e-01   -5.675553650669671e-02; +4.611880911701438e-01   +3.281167050437699e-02   +1.905611759291563e-01   -1.981043876827459e-01   +7.112151854114571e-02   +9.855477385281353e-02   +1.719415254300123e-01   -6.805596770555160e-02   +1.688055045810698e-01];
L1_L2_iAMPA_netcon = [+3.211034346785309e-01   +2.209799533669474e-01   +3.042802677116188e-01   -3.362637214906433e-02   +2.403077762214415e-01   +2.384079099400970e-01   +5.489122483610680e-02   +1.015374564654915e-02   +7.129177618246091e-03; +3.719293953205822e-02   -5.069664539960690e-02   -3.646632655595169e-02   +9.387890776698662e-02   +2.152632917753366e-01   -1.235048797231130e-01   +5.019715627449298e-02   +3.278051645645751e-01   -8.906747776264545e-02; +2.241130954187953e-02   -1.064787473385196e-02   +2.583656476413814e-01   -1.192089851178780e-01   +3.430117585786646e-01   -6.624999039095962e-03   +1.469383335542052e-01   +1.434623608977957e-01   -6.120792394563922e-02; +1.714425260715273e-01   +2.317303175633634e-01   -4.133598859712605e-02   +1.518190944657028e-01   +1.989044981070243e-01   -2.863335620873178e-02   -2.635831315897004e-01   -5.558832310417696e-02   -2.008437468521869e-01; -2.109065429953201e-02   -1.682471877847881e-01   +1.206987863433197e-01   +1.023063558499012e-01   +5.243538342661373e-02   +3.354209589111382e-01   +3.745459844345975e-01   +2.007055434315795e-02   +3.513654018959618e-01; +2.209294324049749e-01   -1.020884054399354e-01   +2.252775154306703e-01   +2.444557401714821e-01   +2.899320593119989e-02   -4.154696529340301e-02   +1.560132314502000e-01   +2.468793747714298e-01   +2.051002469049124e-01; +1.599009110307431e-01   +1.879549450235346e-01   +3.539937451153808e-01   -1.792404311495641e-01   +1.160524240762814e-01   +1.835034649303662e-01   -5.683333940667670e-02   -1.226208275603038e-02   +7.424362756132233e-02; +2.197658845129443e-01   +1.075140683464952e-01   -6.843932333039905e-02   +2.356751837387859e-01   +1.406566646575051e-01   +1.573796328895938e-01   +6.832834208172139e-02   +2.159602757991927e-01   -7.217693524561358e-02; -8.825295631559500e-02   +1.596935498554055e-01   +8.621164294063936e-02   +1.278945597272918e-01   +2.828142878738869e-01   +5.772008237415399e-02   +2.132311128735911e-01   +2.391961863418016e-01   +2.598330457228277e-01];
L2_L5_iAMPA_netcon = [-5.874985706647155e-02   -1.706220601151268e-02   +7.371428420555140e-02   -2.127243879807264e-02   +2.418193576371021e-02   +1.022362316985454e-01   +1.301059519797079e-01   -8.053834912900505e-02   -1.982787463231877e-02; +2.680144477562645e-01   +1.452412181658037e-01   +2.789251233465382e-01   -6.303669393912012e-02   +1.550216381136701e-01   +2.935063181862597e-01   +2.456056310586172e-01   -1.195262307938261e-03   +1.880159843053046e-01; +1.204599504121808e-02   +1.311787339289170e-01   +3.321372964240277e-02   +2.481297385955605e-01   +3.273256752245670e-01   +1.504134163952509e-03   +4.258865827492016e-02   +1.419117102480573e-01   +3.298195565434870e-02; +5.348718450303994e-02   +3.228485616801567e-01   +1.920423694243287e-02   +1.343925349602631e-01   -9.914292643763867e-02   +2.318754464488556e-01   -8.177726344682096e-02   +1.155386359956909e-01   +2.700826052047063e-02; +1.246028768094873e-01   -1.119066418565657e-01   +2.171654828323041e-01   +1.341722691023278e-01   +1.990979349673875e-01   +7.910928386338001e-02   +2.782167632034342e-01   -3.373137525628114e-02   +1.935736720032576e-01; +1.219428849965359e-01   -1.203926624362351e-01   -1.355147275550885e-01   -3.339842827924705e-02   -4.358044615415287e-02   +1.639189009694335e-01   +7.597896127118340e-03   +8.440158317190076e-03   +2.439906193255995e-01];
L5_L2_iGABA_netcon = [-1.359524423241035e-01   +3.338333090109603e-02   +2.649287241189362e-01   +1.166845865112811e-01   +2.363180088420020e-01   +1.600522937788031e-01; -9.964788256371232e-04   +2.782638078101414e-01   +2.242643277428578e-01   +6.963098687649653e-02   +9.766059842976652e-02   +1.821370367461390e-01; +1.834508878114489e-01   +3.165272317090394e-01   +4.023542408440283e-01   +8.285798740397746e-02   -8.885651548663881e-02   -1.985783426194547e-02; +2.567735854354852e-01   -3.085394302953676e-01   -6.290602034305752e-02   -6.430956452793375e-02   +1.274347045080547e-01   -7.582460017675519e-02; +7.517184709371588e-02   +1.477065634001077e-01   +3.650631016861207e-01   +1.039754147938141e-01   -7.026042036131164e-03   +2.553032764144329e-01; -1.935152509324234e-01   +1.727658728293719e-01   +3.576668243812015e-02   +2.508053114294615e-01   +1.571726847741173e-01   +1.483443057071300e-02; -1.100548032543839e-01   -8.483294015088488e-02   +5.829773788910243e-02   +9.822155069139175e-02   +2.172445933382196e-01   +1.206216234053935e-01; +1.748555424739211e-01   +1.220415178700220e-01   +3.406725172443260e-01   -5.928230370502635e-02   -1.553379068476438e-02   +3.195311359157795e-01; +1.919938562750531e-01   +2.149615243687713e-01   +1.309454658184158e-01   -3.958384958484280e-02   +1.348393481992325e-01   -4.245343101303943e-02];
L3_L2_iAMPA_netcon = [+1.158563511139081e-01   -8.992790064224226e-02   +2.418792584761757e-01   +3.828395716236877e-02   +2.045938705599464e-01   +2.808736921608838e-01; +8.364820659333137e-02   +1.376801217428025e-01   +2.805539252490796e-02   +1.257769813963930e-01   +9.162859759757910e-02   +4.490283242475230e-02; +8.942284719849999e-02   +7.411947456582506e-02   +5.140895264271270e-02   +2.599709458509890e-01   +1.141507440867254e-01   +1.776179340209045e-01; +8.009480011698072e-02   -1.833399664131956e-01   +1.124290880570365e-01   +1.328333125589224e-01   +1.016920160345560e-01   +5.653479104403207e-02; +2.692242633457716e-01   -5.859447171288959e-04   +1.532773585275663e-01   +2.151963881531699e-01   +1.287849461473235e-01   +3.075039577048467e-01; +2.550662841304950e-01   -9.025401562120353e-02   +1.104305899855859e-01   +2.211735817294512e-01   +3.114130156184164e-02   +6.927839446973880e-02; +3.186921058706971e-01   +4.432268776933372e-02   +2.654358711295782e-03   +1.383963720512347e-01   -1.142630031315181e-01   +1.889625791530838e-01; +1.093203437594888e-01   +1.787441417641099e-01   +1.652526099340592e-01   +1.912194404635287e-01   -1.552643894248334e-01   +3.964640219833636e-03; +3.624154877733114e-01   +1.551134837238653e-02   -1.308897704625747e-01   +5.460527438105359e-02   +4.233097843867565e-01   +1.376669751080112e-01];
L2_L3_iGABA_netcon = [-2.794564052585631e-01   +2.920866437019308e-01   +1.824299525063307e-01   -8.712394434090165e-02   +3.696988707733724e-02   +2.833152829783858e-01   +1.039863493045859e-01   +2.736558760318857e-02   +5.796247358519589e-02; +3.289176847585092e-01   +1.949014682537435e-02   +1.196004524882195e-01   -3.750612366313160e-02   -4.163157588260070e-02   +3.482302853574032e-01   -6.481974383952738e-02   -3.572883433291573e-02   -1.612644940261172e-01; +1.012085180349106e-01   +1.693196254083415e-01   +2.367768705596220e-01   +1.829214572399063e-01   +1.760499175968890e-01   +1.248418566825669e-01   +2.063555323538497e-01   +2.920343407653800e-02   +2.722503189806169e-01; +2.477548960133975e-02   +6.931366511241649e-03   +4.916357546375948e-02   +2.705661108238752e-01   +1.220550987171152e-01   -1.060487799230079e-01   +2.181892794350376e-01   +2.525861987424520e-01   +4.523590449648576e-05; +1.436217084501644e-01   -9.192593573598407e-02   +1.383092237075562e-02   +2.916357019900257e-01   +1.750748043344161e-01   +6.701974254858828e-02   +2.039953569716996e-01   +1.676851594788067e-02   +2.382219231170729e-01; +1.207801359448045e-01   -1.662807661573016e-01   +8.853158582173112e-02   +9.014300594974171e-02   +3.239009742784218e-01   +3.767238203454281e-01   +4.580504281629443e-02   +3.969426732636593e-02   -1.177609122339263e-01];
L1_L4_iGABA_netcon = [+2.028575292500012e-01   +1.209626760998540e-01   +1.393428725721521e-01   +1.018041218130587e-01   +1.431645753684467e-01   +2.738198702180503e-01   +4.663276504868373e-02   +8.548677629598918e-02   -1.141120980225899e-01; +2.521309956894630e-02   +1.437264666964944e-01   +2.414585434778125e-01   +2.552943147489617e-01   +2.156795367662429e-01   -6.479534076291961e-02   +6.141073805637851e-02   -1.355674787567802e-02   +6.471322518020292e-02; +1.931822304879268e-01   +1.570395176171857e-01   +1.602834556119994e-01   +1.300931652665364e-03   +2.416036435472018e-01   +1.357841993741483e-02   -3.661659765392158e-02   -1.047472144001877e-01   +2.257639734965768e-01; -6.632986016697635e-03   -4.487387129500026e-02   +4.575384511921158e-02   +1.106949971845477e-01   +9.133959200925856e-02   +2.344116102755883e-01   +2.129396298461206e-01   +1.705034532285521e-01   +1.881773113386665e-01; -9.922390703963306e-02   +2.433285409901780e-01   -7.203744505658805e-02   -2.378788846410436e-01   +1.374517560343066e-01   +6.130266311945185e-02   -1.664886612399017e-02   +2.246565165083668e-01   +5.953077933733529e-02; +3.506901648729036e-02   +1.001152814960864e-02   +1.477700679594985e-01   +1.474443754403528e-01   +1.091691158101412e-01   +1.065180379555482e-01   +1.923235253600300e-01   +1.671874116300240e-02   +5.776988794235891e-02; +2.177054940974834e-01   +1.256998830460269e-01   +1.348846890503045e-01   +2.651923304071080e-01   +2.295293769748421e-01   +7.867816118765211e-02   +2.970662906131437e-01   +2.230702436758996e-01   +1.358578954378200e-01; +7.648542426849803e-02   +2.509820094626346e-01   -5.954142754561381e-02   -1.328140797433821e-01   -1.505419445169182e-01   +1.088446906194061e-01   +1.138185315290143e-01   +1.838234055268006e-01   +2.912635435744366e-01; +5.630355374519466e-02   -8.399790078106795e-02   +9.006258721824083e-03   -1.228354261011415e-01   +2.052777073091527e-01   -1.702435128341370e-02   +1.485467894136971e-01   +3.256094416309745e-01   -2.072318885014478e-01; +3.697101014725546e-01   -1.189309526439099e-02   -8.176163392992522e-02   +4.241609246302405e-02   +1.721020816309731e-01   +1.289845489378245e-01   +1.281857920211388e-01   +3.367430559342108e-02   +2.886381521415446e-01; +7.344773509983411e-02   -2.138379112189304e-02   +2.477191092756846e-01   +2.486626280546972e-01   -5.341891678358694e-03   -6.566956637673534e-02   +1.452100486113050e-02   +1.615137759009125e-01   -7.913321268434124e-02; +3.558253980215480e-01   +4.898557395006792e-03   +5.864284035714695e-02   +2.349763429073576e-01   +1.476107176097963e-01   +6.947908694229170e-02   +1.213538076967802e-01   +2.267370940285715e-01   +2.970056104782315e-01];
L4_L1_iGABA_netcon = [+9.410194358185689e-02   -2.470511511733569e-02   -9.870252251117155e-02   -4.890846229614570e-02   +9.306339681716119e-02   +1.663645176289582e-01   +2.324497763681432e-01   -6.221208986264612e-02   +2.335952310645729e-01   +1.722935083273477e-01   +1.760020415284290e-01   +2.692312723175072e-01; +9.688791022032159e-02   +1.214419131902084e-01   +1.458342820510557e-03   +1.209434521711870e-01   -1.787004973816805e-01   -4.075612801802006e-02   +3.074733878760969e-01   +3.956045852049085e-02   -4.562672977726005e-02   +4.757712791287451e-02   +1.195046555806495e-01   +2.108032759242922e-01; +1.892261497457368e-01   +1.666118839746783e-02   +4.205377251038453e-02   +8.920694837807783e-02   +2.283728668993935e-01   +2.109465615929042e-01   +3.290721707312194e-02   +2.744501846800054e-01   +1.707992045549727e-01   +8.120200343303345e-03   -1.359918184109702e-01   +3.234208557440408e-01; -3.026104029699414e-02   +2.506674557668995e-02   +1.896576279891832e-01   +9.561594871566331e-02   +2.674753515910203e-01   -1.059816192788991e-02   +1.832355263185474e-01   +1.269187185634844e-01   +1.610344664834066e-01   +3.204038263399625e-01   +2.330342708034550e-01   +1.151778577202172e-01; +2.772103228152466e-01   +1.659844416166683e-01   +5.663056858992439e-02   -5.585071932516185e-02   +1.171820629998706e-01   +2.100323725601641e-01   -1.970840016823575e-01   +5.170239276648778e-02   -2.484055129443411e-01   +2.840027625907388e-01   +1.985980746863293e-02   +1.443123032463300e-01; +2.914131125321016e-01   -1.417688780770004e-03   -7.852250470966454e-02   +9.673902507312809e-02   -1.311656736847566e-01   +2.892550898648950e-01   -6.450197094037222e-02   +1.485934352803732e-01   +5.159740991320321e-02   +2.120815537039359e-01   +6.480341837931568e-02   -1.224604689064038e-01; -2.391568838897122e-02   +4.390163376765256e-02   +2.667306960500358e-01   +2.242137033918808e-01   -6.280836675509742e-02   +1.905743990233452e-01   -9.053267248109315e-04   -1.034997677282544e-01   -4.984801434437436e-02   +2.242972816272883e-01   -6.446954983674666e-02   +8.707151995739222e-02; +2.527800478353545e-01   -8.697883952673527e-02   +3.636399854777795e-01   +1.135776521545624e-01   -8.820297407872064e-02   +2.823860873762755e-01   +2.610824229155824e-01   +3.221375766646187e-01   +1.239350953420874e-01   +1.164066724591838e-01   +2.532858438446059e-02   +5.244761689289969e-02; +1.875713986411942e-01   +1.679702935556095e-01   +2.832966995817315e-01   +9.624413689586581e-02   +3.297344291608169e-01   -9.374612390749812e-03   +9.054840075619801e-02   +5.642437418440457e-02   +2.378116631456436e-01   -1.476297873426902e-01   +6.070329521293099e-02   +8.528647175770514e-02];
L1_L3_iAMPA_netcon = [+4.301996324906447e-02   +2.732725483600038e-01   +1.826520960080656e-01   +3.126904923293741e-01   -1.106287217681277e-02   +2.502657386673117e-01   +2.628923519869018e-01   +1.703683703045246e-01   +2.126437207170842e-01; +4.203249651881703e-01   +2.963751097228426e-01   +2.097610642314421e-01   +3.103756593215702e-01   -6.793214820231404e-02   +3.272610718314668e-02   +2.746029937761575e-01   +6.058435814401929e-02   +3.841200419551315e-01; +1.104894276805256e-01   +7.601274000243577e-02   +1.333109694785501e-01   +6.778501237835879e-02   +1.280069381178378e-01   +8.282813716525265e-02   +2.313184853132622e-01   +2.233844273804045e-01   +2.470133550823290e-01; +3.343409673913963e-01   -2.663019367060907e-01   +2.769014825035702e-02   -3.734012171757399e-02   +1.610820129820070e-03   +1.959307390061788e-01   -1.692129764908258e-02   +2.731890376227010e-01   +2.281715825249593e-01; +5.828984862808109e-02   +1.886970012421735e-01   +2.280251252116964e-02   -1.374134523693288e-01   -1.823125974991785e-01   +7.469399090776438e-02   -2.443030032734175e-03   +1.856433284434570e-01   +7.124640328687001e-02; +2.111694663224724e-01   +3.607561504161021e-01   +1.016278298686802e-01   +2.437745003224141e-03   -1.833284653544814e-02   +1.578182955109777e-02   +1.463007817745748e-03   -1.041742982064234e-01   +3.772378945806054e-01];
L3_L1_iGABA_netcon = [+1.271145137198342e-01   +1.993774626035094e-02   +1.689294660263445e-01   -4.587286870223077e-03   +2.208910952358612e-01   -8.830373549693001e-02; +3.083353916697156e-01   +1.723630080915433e-01   +1.291376265246977e-01   +2.842840425553103e-01   -2.641437023360632e-02   -3.043106814963823e-02; +2.660816720091735e-01   +1.387194838021076e-01   -4.825021516395738e-02   +4.175526912853096e-02   +2.753405497506488e-01   +8.264444798774037e-02; +1.731828822252230e-01   -6.882759870873978e-02   +4.726167566600686e-03   +1.102275023991916e-01   +1.965255638036582e-01   +1.972847114845362e-01; +1.197858227036592e-01   -5.604364213190677e-02   +2.332802777251765e-01   +2.156153881478517e-01   +9.149477099778222e-02   +9.108593197075431e-02; -9.452226401613265e-02   +1.799970280140469e-01   -7.213731890236150e-03   -1.255548800994058e-03   -1.798471064816597e-02   +3.355380069340431e-01; +6.057955595452440e-02   +9.111743520972234e-03   +2.197499314963705e-01   -2.103586444213158e-02   +1.209629579273130e-01   +3.169744715663792e-01; +8.296593561030410e-02   +1.877925876929918e-01   +1.240581662727658e-01   +1.964749203561379e-01   +7.954693330547280e-02   +1.905618642474406e-01; +1.669106269573144e-01   -2.002509904861375e-02   +3.739714811759978e-02   +3.929662264578299e-02   +7.882494933038539e-02   -2.314867064162416e-01];
L5_Input1_iAMPA_netcon = [-2.342505801803222e-02   -1.215287631632636e-01   -1.324250407230532e-01   -1.170216591198536e-01   +1.060777532883881e-01   +1.479521466962886e-01];
L6_Input2_iAMPA_netcon = [-5.681152195058236e-02   +6.571008932862499e-02   +3.527060773965230e-02   -1.862506461535431e-02   +2.316360157030791e-01   -7.180577419347986e-02];
L5_L6_iAMPA_netcon = [+1.321202227644809e-01   +1.653714549473536e-01   +9.078442706779798e-02   +6.819456568924628e-02   +1.357902124770906e-01   +1.316355035226696e-01; +1.396745031707986e-01   +2.925963642882949e-01   -8.142170627167057e-02   -1.020879722266598e-01   +1.720894600488261e-01   +1.030020980694539e-01; +9.122860128709255e-02   +1.356053447821575e-01   -2.485019179162173e-01   +2.993803831135925e-01   +2.081941223253541e-01   +1.095181765659116e-01; +1.351199430799361e-01   +3.827611299978106e-01   +1.771167002432889e-01   +3.910288601711119e-01   +4.792442379362394e-02   +6.578394506758962e-02; +1.849817446533130e-01   +4.489260152775636e-02   +1.410261327283893e-01   +1.966735132254357e-02   +3.239191868536063e-02   +2.340538663107815e-01; +1.690649086931517e-01   -1.651861655870936e-01   -5.184648732331601e-02   +9.707799479121240e-02   +1.589340770698599e-01   +1.565451682998289e-03];
L4_L5_iAMPA_netcon = [+1.725417631094086e-01   +8.252998084347943e-02   +2.971920048124118e-01   +2.485332860113372e-01   +6.423809296475838e-02   +4.397186140242410e-02   +1.571087484390784e-01   +3.346433578395535e-01   -4.004975866453941e-02   +3.336382410726351e-02   -1.146733471434270e-01   +1.309869885706670e-01; +3.552113311340457e-01   +2.070813448692721e-01   +1.547452096830688e-01   +7.546623452255219e-02   +1.982256533807707e-01   +1.210667260418179e-01   +2.281687239489312e-01   +2.759268481017312e-01   +3.218816431084306e-02   +2.793064385515034e-01   +1.158232934391082e-01   +3.223107928595486e-01; +1.505450292963399e-01   -1.770877829464457e-01   +1.736131635211325e-01   +1.488386040674335e-01   -5.879333723909232e-02   +1.657060699616805e-01   +9.297397728716406e-07   -9.880247877792331e-02   +5.476289051041056e-02   +4.117928462708356e-02   +1.704218762104563e-01   +1.394910277624964e-01; +8.610383531130533e-02   -1.287492146969400e-01   +1.655264826360413e-01   +2.567621410194727e-02   +1.510352547961407e-01   +1.426146046540994e-01   +5.115742029016007e-02   +2.376441962852845e-01   -5.725710812808159e-02   -6.793809931606436e-03   -3.116767769826832e-02   +8.615887974368933e-02; -2.949100067277271e-02   +3.621309707519149e-01   +2.593806326693485e-01   -2.027963227418129e-01   +2.151567670287766e-01   +2.577540395964130e-01   +4.496993137947675e-02   +2.391941096853435e-01   +1.989338518692683e-02   +2.336281113414768e-01   -1.377217358165284e-01   +4.172665446442138e-01; -1.722029183366875e-01   +5.929550980861529e-02   +5.268548110722131e-03   -4.813572464211650e-02   -4.116537238238040e-02   +2.005803308899493e-01   +7.936049183857224e-02   +9.457040555698977e-02   -7.009654944172650e-02   +1.902486170237449e-01   +2.483757068596227e-01   -4.847087550307996e-02];
L6_L4_iAMPA_netcon = [+4.882187259702311e-02   +8.174507185866781e-02   -2.727603236300082e-01   +2.690463101814822e-01   +3.105756428920303e-01   -4.397643593025101e-02; +4.681271199051586e-02   -1.018419740038031e-01   +6.026761983695358e-02   +1.035816118267109e-01   +5.242312432149936e-02   +2.803084306295432e-01; +9.067734691228960e-02   +6.026500819025339e-02   +2.591505025023740e-01   +9.814352885769101e-02   +6.520564310899216e-02   +2.991445781083870e-01; +1.882130335311520e-01   +2.466126267146586e-01   +3.885518835736410e-01   +2.680202521362923e-01   +1.622120089876763e-01   +2.740059047797415e-01; +7.844503405039792e-02   +1.161022181104259e-01   +2.062824126493490e-01   -5.749725307548290e-04   +1.249573837821771e-01   -3.569462708389722e-02; +6.586398846618857e-02   +6.301000948285422e-02   +2.485109456202989e-01   +2.610621962203908e-01   +2.067904053528623e-01   +2.167617889984451e-01; +1.183988993897839e-02   +1.919749022372007e-01   +1.129015629902630e-01   +1.699137387784256e-01   +4.661696964482157e-02   +4.973004740435899e-02; +1.302465816801285e-02   +1.579304636976338e-01   -4.201576063450900e-02   -6.613756478787733e-02   +2.687150344105432e-02   +6.821834610701670e-02; +2.508081070727010e-01   -1.554291526891160e-01   +1.675653898542690e-01   +6.990952872912747e-03   -1.830064948350812e-02   -3.734589922595413e-02; +4.727694525891268e-02   +2.467452794163360e-01   +2.919723001111625e-01   +5.246575753422617e-01   +3.854251761388759e-01   +4.422199820250265e-03; +3.346899209502740e-01   +9.689108449095855e-02   +1.907229882325738e-01   -8.474726877906335e-03   -9.309198848976397e-02   +2.590604006655792e-01; +2.596361915415188e-01   +1.392141145676420e-01   -6.910497872089913e-02   +2.093627708601694e-01   +1.808619379722349e-01   +1.099426050722159e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
