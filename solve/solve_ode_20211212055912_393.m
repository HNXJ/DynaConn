function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.344813751906187e-01   -7.849588508834128e-01   -8.287317317396179e-01   -2.833673895807212e-01   -3.935315887887412e-01   +2.690499561598761e-01   +3.994911362785076e-01   +1.169143879841025e-01   -6.262069109491847e-01; +3.091217488304870e-01   +3.451920894397859e-01   +3.900070893621242e-02   +7.599797675441162e-01   -7.512370452967901e-01   -4.917020630282844e-01   -6.343691444181327e-01   -4.500139333008739e-01   +2.112755566934959e-01; +5.804503627922629e-01   +9.160536103442721e-01   +9.493827447197154e-01   -2.617295475462227e-01   -1.413994164633347e-02   +5.580376507930047e-01   +4.962011441691532e-01   +3.674865805983971e-01   +5.835198051394977e-03; -6.431442030749338e-01   -2.321364054857013e-02   +6.365547389198549e-01   -6.704847593652214e-01   -1.646900749165758e-01   +2.486150289925954e-01   -9.574404700050955e-01   -2.792038225192242e-01   -1.240774178452140e-01; -4.533520845585967e-01   +5.911488212736619e-01   -4.833401603813622e-01   +8.666257698101436e-01   +9.199530153135954e-01   -4.792526046637922e-01   -1.917067043708379e-01   -1.871677435996782e-01   +9.675586102056982e-01; -2.083983381400581e-01   -2.322042734282231e-01   -3.667706658815215e-01   -5.629246885799648e-01   +7.245456970434859e-01   +3.493710319476531e-02   -5.896841444310962e-01   -6.595335938463035e-01   +8.462681849645659e-01; -5.691888750916440e-01   +2.563964832065214e-01   -5.863869986885607e-01   -6.470563212735130e-01   -7.671086163706117e-01   -2.454453808947124e-01   +7.146873246306173e-01   +5.131418792086326e-02   +7.352988811137289e-01; -7.919810858029087e-01   -6.355812197685500e-01   -7.711543375910677e-01   +5.806668871781341e-01   +8.140979920646608e-01   +6.792262172101147e-01   -1.000000000000000e+00   -6.797783056980434e-01   -3.587250278224288e-01; -1.678111126765268e-01   +8.247146515075952e-02   +3.268374599433270e-01   -1.076078338362010e-02   +2.991513470826050e-01   -6.227191265375585e-01   -1.630708644043526e-01   -5.153139318843754e-01   +3.204019682546398e-01];
L1_L2_iAMPA_netcon = [-5.436642343967460e-01   +2.231289506452411e-01   +4.925903178705787e-01   -5.586673477801492e-02   +8.385948061759002e-01   +9.513269570483603e-01   -7.042328532461676e-01   +6.419374331563991e-01   +9.811532111329672e-01; +4.190335465089426e-01   -1.665712087464644e-02   -1.449224816815907e-01   +5.248899657225460e-01   +4.091046904727964e-01   -8.778834555008054e-01   +4.240180841235734e-01   +3.336623852778857e-01   -1.663710791153378e-02; -7.214289993145894e-01   +2.390583647374235e-01   -4.579710242257471e-01   +5.282792972211449e-01   +3.690032793963955e-01   -8.480790061464067e-01   -7.504141374881699e-01   -1.530625924778730e-01   +5.630348504417483e-01; -2.685040211934572e-01   +3.581276359016813e-01   +6.806439548713128e-01   +9.382673794938363e-02   +1.000000000000000e+00   +8.186062909890306e-01   +9.610249297636656e-03   +5.948246228977487e-01   -7.072327726112052e-01; +2.073347250281937e-01   -7.823125606733752e-01   -5.536711070242644e-01   +1.879632107903627e-01   -8.149486369768378e-01   +5.615050542097022e-01   -4.141136818684068e-01   +3.323746675606680e-01   -7.016268554769493e-02; +6.248835566476517e-01   -6.598208506523369e-01   -6.112686516441389e-01   -5.083156340418553e-01   -9.171619405021655e-01   -4.751543964787922e-01   +4.298494941545391e-01   -3.811751215984477e-01   +4.221363591271678e-01; +4.407766709795231e-02   +6.962951497568513e-01   +5.335971308004732e-01   +3.230128681278547e-01   +4.468767724362409e-01   -1.140089744871055e-01   -4.424713143372991e-01   -7.503011754325812e-01   +9.260713529229180e-01; +9.249822011354214e-01   +6.568539373458298e-01   -3.312164301661412e-01   +1.462830294136252e-01   -2.868711969959363e-01   +4.398037591869836e-01   -5.967683867878749e-01   +8.386096343494821e-01   +4.581300839493243e-01; -7.111015393475630e-01   +1.609735170108929e-01   +6.570342211968606e-02   +8.645253382638027e-02   -1.605640403888349e-01   +1.002954379315596e-01   -2.501181926868349e-01   -4.679377449531741e-01   +4.486557676625593e-01];
L2_L5_iAMPA_netcon = [-1.000000000000000e+00   +6.443332968891060e-01   +9.526713986421894e-01   +2.217176676383287e-01   -3.083274197610607e-01   -1.426021868319280e-01   +5.324341878176572e-01   -6.778902837553533e-01   -1.496395604641731e-01; -6.180072808585846e-02   -6.993606964955469e-01   -6.856474193810240e-01   +2.898162201841660e-02   -6.117165300551639e-01   +5.107294253723683e-01   -1.682908544626603e-02   -2.753490018773996e-02   -2.996546122509845e-02; +1.754815005639226e-01   +4.696322855089179e-01   -7.608421853065159e-01   +3.100534475911247e-01   -2.890731697303141e-01   -4.559644767846793e-01   +5.295081378406578e-01   +7.029116837406522e-01   -6.174428262850678e-02; +5.899701759901710e-01   -5.512723027987586e-01   -4.579333778821982e-01   -1.905471682364500e-01   +3.480601245615441e-01   -2.714943271906798e-01   +2.329389939668518e-01   -3.321193382645515e-01   +5.933086788799546e-01; +5.509200602533130e-01   -6.308517186855239e-01   +9.752829356922508e-01   -7.779843494603245e-01   +8.036951232193956e-01   +3.609124165398115e-01   +8.943429112523086e-01   +3.029473227088857e-01   -9.087963741595989e-01; +5.238356108477937e-01   -6.937514379213916e-01   +7.861226078477381e-01   +4.556523292367810e-02   -5.967323216332032e-01   +8.068169452593011e-01   +3.148568290538394e-02   -3.852728008075333e-01   +9.242663349185766e-01];
L5_L2_iGABA_netcon = [-1.801383090161600e-01   +5.777092345416117e-01   +6.173443027885478e-01   -3.912461051747547e-01   -1.432140440062420e-01   +1.000000000000000e+00; -8.211801038966418e-01   -6.633549837141657e-01   -8.453922454233217e-01   -3.477621034993240e-01   +2.392247823410172e-01   -3.792994380053842e-01; +3.192312497268164e-01   -3.392584362084208e-01   +3.423443055394453e-01   -5.361482864670210e-01   +5.737587364792719e-01   -5.982834908509375e-01; -5.573721677248481e-01   +6.808591768851789e-01   -8.109109314895636e-02   -1.477983033320420e-01   -8.345840258868812e-03   +3.800613058355298e-02; +9.573751531220907e-02   -3.208800020068737e-01   +5.699345048645867e-01   +4.892272125674557e-01   +1.025253598446064e-01   +1.427366386918557e-01; -3.877848159061883e-01   +6.622823731263021e-01   +9.321205963764680e-01   +1.925570322894719e-01   -7.184759041785521e-01   +3.690036685381918e-01; +6.626980722750417e-01   +3.053980358061126e-01   -1.472157904012743e-01   +1.258760388364493e-01   -6.179888771165064e-01   -8.516768985167336e-01; -7.571449437764562e-01   +2.913700611024344e-01   +7.737097801883390e-01   +8.111776453820250e-01   -6.466568906585417e-01   +5.691257479806643e-02; +3.386030464404778e-01   -9.366657552446175e-01   +1.406409956068284e-01   +3.309906081993494e-01   -4.676345099586701e-01   +6.486602191488980e-01];
L3_L2_iAMPA_netcon = [+7.856861245885904e-02   -4.383552884039811e-01   -7.819734222162137e-01   -9.090619695364198e-01   +9.709035124250328e-01   +1.806690536278121e-01; +8.649224104121016e-02   -4.436966588762895e-01   -7.165764342554357e-01   -6.249532655622196e-01   +5.005165696508738e-01   -2.090786920122165e-01; +8.475374517703857e-02   -3.376027938240269e-03   -1.000000000000000e+00   -1.185540287376287e-01   +6.919655313536901e-01   -2.732066203626249e-01; -1.149302809942906e-01   -6.860256103638063e-01   +7.132066802656749e-01   +3.254004173594294e-01   -7.065683049256623e-02   -7.401540634729959e-01; +5.872827938355180e-01   -7.287980555987177e-01   +9.779237853739018e-01   +8.752370162289391e-01   -6.188807037340346e-01   +1.043334919397193e-01; -1.510551693010458e-01   -6.442321944529847e-01   +2.189407100430400e-01   -5.533624833438371e-01   +8.499187484720382e-01   -4.244144466808836e-01; +3.557329613118883e-01   +6.577729131109579e-01   +8.954278625102225e-01   -7.280422898534680e-01   -6.913234777282371e-01   -7.668436867570989e-01; +2.614100500169640e-01   -5.006766114017982e-01   +3.950368652061871e-01   -7.384398868455925e-01   +7.978357387382566e-01   +5.777430333928769e-01; -2.640375564495454e-01   -4.203673196842247e-01   -1.186397785054677e-01   +6.423667034727133e-01   -1.587480689369173e-01   -4.176094050003077e-02];
L2_L3_iGABA_netcon = [+9.520446573103215e-01   +3.128920318308411e-01   -8.423015033630017e-01   +5.040901091709755e-01   -7.163289801172253e-01   -3.154857048510539e-01   -3.403515517067840e-02   -7.691573801035697e-01   -2.874401814706507e-01; +1.120305006021124e-02   +5.057017364473128e-01   +1.813012680609283e-01   +2.055032946601458e-01   -2.208196839774804e-01   -1.490023273684753e-02   +1.544310836087436e-01   -2.277642361955188e-01   +3.072815413092055e-01; +7.716764190522036e-01   +1.000000000000000e+00   -1.216387573230329e-03   -5.286016153917142e-01   -4.949000595921314e-01   -9.799015835048708e-01   -6.685717987323148e-01   +5.083030921071167e-01   -7.109568455828139e-01; +4.402767802288695e-01   -2.259367575934361e-01   -2.743758883049573e-01   -3.903255118691809e-01   -7.261023724702959e-01   +7.088098049389572e-01   +6.409701913048631e-01   +2.989566333413037e-01   +2.325980739922919e-01; +8.708564203152449e-01   +5.662078244077937e-01   +7.829617980514573e-01   -5.255785278528713e-01   -1.790488267556894e-01   +5.291228747833119e-01   +3.372608712171134e-01   -5.770971674172916e-01   -3.175220965544456e-01; -2.904683400381263e-01   +4.475380877648910e-01   +3.664753844371241e-01   -3.419374887894022e-01   +4.841630529293250e-01   -1.362275892595965e-01   -2.847516342354940e-01   +1.121044012408270e-01   -1.971441080541619e-01];
L1_L4_iGABA_netcon = [+2.442706533200597e-01   +7.856018422357994e-01   +6.871854697843712e-01   -7.249051403408262e-01   +5.441569386290728e-01   -1.611219637767547e-01   +6.387641398648100e-01   -8.170298176721733e-01   -5.997577642346241e-01; +2.663031487651167e-01   -4.766514670100109e-01   +4.960264576659713e-01   -6.106301022292600e-01   +5.314732061679840e-01   -7.885343726572202e-01   -7.173061905104903e-01   +1.236541149300301e-01   +4.982100214353398e-01; +4.641975750798951e-02   -6.911851154549978e-01   -4.116992676621253e-01   -2.589284916403787e-01   +7.919880433641915e-01   -6.044611329587406e-01   -1.933805025974579e-01   -5.391563257093634e-01   +7.156952333992074e-01; -3.401192004971554e-01   +3.183422016318298e-01   -9.019550060969842e-01   -3.048694067928662e-01   +1.794844961349240e-01   -4.274868502632896e-01   -3.859797461843114e-02   +7.468867403321788e-01   -5.816671578849177e-01; -6.932426227196641e-01   +8.407553872389796e-01   -7.697089051239506e-02   +5.215490777613685e-01   -5.919254866413733e-01   -7.513327188281258e-01   +3.297425242506318e-01   +3.867793600748199e-01   +5.567697997112075e-01; -4.967320231582273e-01   -7.390104405008076e-01   +6.639245909014315e-01   -3.500692412401823e-01   -2.528539727688286e-02   +1.238197079761066e-01   +6.277208731178733e-01   +3.378978041153197e-01   +6.281113526606632e-01; -5.850499152525123e-02   -3.839961168707676e-02   +2.626151867479984e-01   -7.314254250760721e-01   +2.068435680879838e-01   -8.627600161945815e-01   -7.892483157521643e-01   +7.530111951485265e-01   -6.099962952012294e-01; -9.252942698420644e-02   -4.253691174932183e-01   +3.919492928149461e-01   -8.038838654195961e-02   +4.449102922140501e-01   +4.304864815845121e-01   -3.272896726094690e-01   -8.069262147219288e-01   -1.466292701666392e-01; +5.195304628038561e-01   +1.121346272831418e-02   -4.776197188359609e-01   +8.573637463688346e-01   -3.040253664095734e-01   +6.142106863605709e-02   +1.017949161375362e-01   +1.946093562401998e-01   +1.745043504674353e-01; -6.210534306895885e-01   -3.400608731977484e-01   +2.078329564049924e-01   -1.761573423806544e-01   +1.651490558663370e-01   +2.965388447775059e-01   -9.568596458763835e-03   +2.735516944640562e-01   -6.888242276071993e-01; -7.167200988263607e-01   -1.000000000000000e+00   +2.901066617711039e-01   +2.684540455732490e-01   -2.123765311680265e-01   -3.290828048913305e-01   -8.162124572745023e-01   -4.313107421582758e-01   -8.633116064491965e-01; +4.265027703360719e-01   -5.674170552831541e-01   -3.097024957015004e-01   +4.919405194956916e-01   +1.918257588957090e-01   +8.116995401593736e-01   -6.572582123719449e-01   -7.979083369018968e-01   -1.780662486577745e-01];
L4_L1_iAMPA_netcon = [+7.563248289086422e-01   +4.248957140751555e-02   -9.096178014605945e-01   +4.135373202100182e-01   +4.837629455652924e-02   -9.197853292857802e-01   +3.701905872198806e-01   +4.117309804794722e-01   -2.456723033368409e-01   -5.666792433334608e-01   +3.591533640637825e-01   -7.428392935858192e-01; -2.830207253805954e-01   -6.693645248729535e-01   +1.857281354735877e-01   -4.768806299545760e-01   +5.641576385996768e-01   +4.157190440105381e-01   +3.523215257126041e-01   -3.636915104200624e-02   -5.267467250626923e-01   +8.124053349153753e-01   -4.751882556263782e-01   -3.552706079614465e-01; -6.023713402271542e-01   +3.234086345168099e-01   +1.766491034228738e-01   -2.059901718652206e-01   -4.919263585640662e-01   -2.827264444578066e-01   +4.844202628806539e-01   +4.097006714872654e-01   -1.167627606158265e-01   -3.962177860381852e-01   -1.652692526582369e-01   -2.551338696192131e-01; +2.102973655107016e-01   -1.374626371009248e-01   +5.838213564469860e-01   -7.734670957242598e-01   -1.578266971072282e-02   -6.064320925724900e-01   -5.384379734253126e-01   +3.280796779036084e-01   -3.525338083429592e-01   -8.898926836373280e-01   -1.325152803833100e-01   -2.484216717160410e-01; -1.368698581807069e-01   +5.301778085248386e-01   +5.332355541723337e-01   +2.828821290638152e-01   +2.788027939534060e-01   -5.332888186036574e-01   +3.033352185394682e-01   +1.199800878047231e-01   -2.108596833581448e-01   -5.570023162832446e-01   -7.031277570781220e-01   +8.984683125415179e-01; +2.002847690048614e-01   +4.665843467017625e-01   -2.431502704691558e-01   +6.028128827887614e-01   +5.915829264779792e-01   +5.023394937098186e-02   +6.950964694145265e-01   +8.746250909637198e-01   -8.878993626433248e-01   -5.891455025790529e-02   -9.223159804153439e-01   -2.293515996902595e-01; +1.877393083936257e-01   -8.254301804334186e-03   -6.963156287648460e-01   +6.510929988056369e-01   +1.062290894105317e-01   -7.073993625416083e-01   -6.309652724425155e-01   +4.514043792270622e-01   +6.998290184267286e-01   -4.097835775616926e-01   -7.987003362884674e-01   +4.040685939687044e-01; +5.237378606575325e-01   -6.174899129936636e-01   +3.590997088760797e-01   -8.491878731865824e-01   -8.677095151565373e-01   +3.921595838544101e-02   +8.326043060954130e-01   +4.667537791614548e-01   -6.780875297687279e-01   +2.242762170311218e-01   -3.568688273791752e-01   -9.167264283954643e-01; +6.339057281317059e-01   +8.766281740965337e-01   -3.519871508759645e-01   +4.634696881915002e-01   +4.749601303455067e-01   +4.121863407308231e-01   +5.219509295876422e-02   +1.814064063907777e-01   -6.869441841859625e-01   +4.279716504440894e-01   -4.614425208774317e-01   -1.000000000000000e+00];
L1_L3_iAMPA_netcon = [+2.013403143056409e-01   +5.391269612572616e-01   +9.492976562869815e-01   -9.648416290711690e-01   -9.176352877507276e-01   +3.141569208314513e-01   +1.669585443408282e-01   +4.841368944934697e-01   -4.654414771758933e-01; +9.047317377692998e-01   -2.705738021733444e-01   -6.760031120798506e-01   -3.086481066784990e-01   -9.537789427252562e-02   +3.214401029419710e-01   +1.343837352252922e-01   +1.266272899657805e-01   -1.559172594221095e-02; +1.449252307738926e-02   +1.000000000000000e+00   -5.913938006363092e-01   -1.821798841796609e-01   -4.368708224015061e-02   -3.156480231260564e-01   +7.766871158503594e-01   +8.353083401545863e-01   +5.001693147463546e-01; -2.821824428874368e-01   +3.998837903426221e-01   +7.012022832633718e-01   -8.276755533205440e-01   -9.137223854748716e-02   -1.227846073446204e-01   +6.438189038888795e-01   +6.968556345185236e-01   +1.525836017471846e-01; -4.083581498697454e-02   -1.384376881943236e-01   -9.433781051882707e-01   -4.114833152546988e-01   -5.692496109114188e-01   +1.810330110681923e-01   +1.395133938405397e-01   -9.757067382716590e-01   -6.828842287140465e-01; +5.736321040503890e-01   +6.237988714211328e-01   -5.338499728791000e-01   +3.273046686912541e-01   -2.699152817995709e-01   +6.018246082902625e-01   -8.851852796023862e-03   -5.351688570617894e-01   +7.092849468554289e-01];
L3_L1_iGABA_netcon = [-7.808263699408469e-01   -6.094485063675568e-01   +1.000000000000000e+00   +8.565837554022603e-01   +3.414534023648791e-01   -4.369292750712239e-01; -4.791395723507121e-02   +5.121444933675602e-01   +2.245941631606363e-01   +3.555111535981019e-01   -1.695351185941544e-01   -6.553039121852799e-01; -9.980089221013190e-01   -6.909279673283016e-01   +9.177431723684778e-01   +7.248822807245355e-01   +2.705340487041392e-01   -3.590866170424256e-01; -2.261995629464756e-01   -4.300278663708316e-01   -3.026520607814699e-01   -5.319059753206249e-01   +6.219167199160794e-01   -4.063828680392301e-01; -4.726549521956206e-01   -3.131197102207685e-01   +1.490076037323960e-01   -6.290159906165269e-01   -4.141509477349680e-01   -2.636863536426168e-01; -4.532599108765346e-01   +3.531529431707900e-01   -2.463034253828994e-01   +9.102291635164012e-01   +7.425570547565833e-01   +7.119096752268732e-01; -1.085663953814999e-01   +8.297057175158913e-02   +3.384153204722065e-01   +1.364027944996922e-01   +9.307570440333570e-01   -4.604345177227873e-01; +1.921854423125019e-01   +8.761996050333639e-01   +6.665489683080108e-01   -5.067743900844205e-01   -4.631094225201766e-01   +8.305136403766245e-01; +5.800881432364593e-01   +4.302616615272385e-01   +6.278255097906421e-01   +9.906881685181785e-01   +2.334804668462215e-01   -3.853040212340303e-01];
L5_Input1_iAMPA_netcon = [+1.000000000000000e+00   +8.166916848735232e-01   -9.970162832539029e-01   -1.390612762095500e-02   +2.610684835483745e-01   -2.077350628577103e-01];
L6_Input2_iAMPA_netcon = [-2.811020629545251e-01   -1.921888080442904e-01   -3.103111138683953e-01   -6.318205715255317e-01   -9.525991164760953e-01   -1.000000000000000e+00];
L5_L6_iAMPA_netcon = [-1.336561942251044e-01   +6.385694559601436e-02   -4.882718693809127e-01   +1.717111005440349e-02   -5.382537801109584e-01   -3.287373642967114e-01; -6.847657214440701e-02   +7.217662108686249e-01   +1.000000000000000e+00   -5.676401000778696e-01   +9.709276276961835e-01   +3.055940213442438e-01; -5.866840042046712e-02   +3.177382375644619e-01   -2.875889061363733e-01   +2.543589005651525e-01   -4.620345301547569e-01   -3.516627464756450e-01; +8.408080222419192e-01   -5.536401327583407e-02   +8.216950336106306e-01   -2.497548814695342e-01   +4.861842913231659e-01   -7.572092826059684e-01; +3.945489155606665e-01   +4.735054538785058e-01   +6.324675081864322e-01   +6.208729850500257e-01   +4.356873015334474e-01   -9.610661600524213e-02; +4.310193759574271e-01   -2.202751728671627e-01   -1.325381888581315e-02   -2.885325284040110e-01   +3.020382586175267e-01   -3.050604954906110e-01];
L4_L5_iGABA_netcon = [+4.361155751058190e-01   -6.871803721250773e-01   +1.000000000000000e+00   +7.323789517019993e-01   -4.254878820797334e-01   -8.866007106720528e-02   +9.733477879447108e-01   -4.774819872212953e-02   +6.015708821905728e-01   -4.414210030598350e-01   +4.161750015529929e-01   +2.624993523243879e-01; +4.553261751746894e-01   -5.596430863706692e-01   +6.112938261605898e-01   +7.814039499354913e-01   -9.646455694340987e-01   +3.057212666304990e-01   -3.367652539362073e-01   -9.931280618102528e-01   -2.312603999866598e-01   +5.000852026157252e-01   +2.753988222391662e-01   -9.293387759858023e-01; +9.534297779321729e-01   -3.754913964986420e-01   +5.594372428381971e-02   -1.110006346665278e-01   +4.818776477637503e-01   +1.531189759233696e-01   -8.560046575820244e-01   -3.709872878160516e-02   +6.182261044598572e-01   -8.658696109077188e-02   +5.351284102178042e-02   +3.245891173875738e-01; -4.324866863545506e-01   +6.647582045377157e-01   +5.929130376830363e-01   +7.411826616553737e-01   -6.873991874558918e-01   -4.671235983744741e-01   +7.980158527724189e-01   +1.665370029116789e-01   +3.832530872330779e-01   +4.109915858492639e-01   +3.819995397816597e-01   +9.448677853427098e-01; -6.738376007922636e-01   -8.506457316320304e-01   +5.743498468446034e-01   +9.727954811832112e-02   -5.274920812304787e-01   +1.616601090823259e-01   +9.684160756976509e-01   -6.957808636335364e-01   -1.386140335833695e-01   +3.791515925557293e-01   -1.642842315111972e-02   -7.479427134319429e-01; +8.892275763982366e-01   -1.382598799816726e-01   -6.361963462414889e-01   +7.058141994714571e-01   -6.484611223860288e-01   -4.377563102258608e-01   +3.027150568904428e-01   -2.573243464959798e-01   -2.301824945249768e-01   -7.558092232934722e-01   -1.207271215079389e-02   -7.361431777243727e-02];
L6_L4_iAMPA_netcon = [+6.506076539891162e-01   -1.433641538679268e-01   -9.245125877595785e-01   +2.927616973960755e-02   -2.424772722963370e-01   -8.749992719128284e-01; +8.433711345134712e-01   +5.903009725909940e-01   +9.486279472626816e-01   -6.510503259553219e-01   -1.434684266546636e-01   +5.330749800457417e-01; +3.404883251616849e-01   -4.042327005150114e-01   -8.438334846697565e-01   +6.240918576418496e-01   +2.926175740594399e-01   +4.251752523495554e-01; +8.048567720858500e-01   -1.959150153815711e-01   +2.124823905260685e-03   -3.917099600614888e-01   +4.351781569249927e-01   -3.597896706525970e-01; +8.122275018058226e-01   +1.350587883460689e-01   +9.822519719858492e-01   -3.073992819733661e-01   +4.397215635788907e-01   -6.901917620399053e-01; -9.162184472370635e-01   +5.710374239180088e-01   +1.416015546541333e-01   +1.975482078408249e-01   -7.200272816764904e-01   +5.826717383608239e-01; +2.225511107262056e-01   -6.142837028380154e-01   +5.131588268191642e-01   -4.835299260303815e-01   -1.986478863720356e-01   +7.365104683381981e-01; -1.000000000000000e+00   -3.495394133654652e-01   +7.796475871513253e-01   -3.937633750789618e-01   +3.778243725819576e-01   -5.944481382693680e-01; +2.391459394842733e-01   +6.801651738737204e-02   -7.420169367676641e-01   -6.603579809957061e-01   -4.975389996436566e-01   -7.864224895052454e-01; -1.922137967034379e-01   -7.600106887529364e-01   -7.624181546261770e-01   -1.556715228451785e-01   +5.379231554676613e-01   +8.591862880327697e-02; +5.111440665209962e-01   -1.902344208291323e-01   +2.740888875715867e-01   +5.178103630346370e-01   -7.473082155681862e-02   -3.124383294125854e-01; -8.076035176063658e-01   +3.325777869678092e-01   -8.619141436295927e-01   -9.967541353663794e-01   +5.545783321475662e-01   +8.984906015980522e-02];
L5_L4_iAMPA_netcon = [+7.446874542930940e-02   +8.500207143340127e-01   -5.228867492891585e-01   +8.471393011728486e-01   +4.588888643220189e-01   -3.602045012128284e-01; +2.856993696514661e-01   -2.237490452585293e-01   -3.455955226253336e-02   +6.196466050249050e-01   -5.147693099230098e-01   -7.950674161078910e-01; -2.889701894377700e-02   +6.419699491414457e-01   +8.248758891154412e-01   -1.253060632171339e-02   +7.291357235785525e-01   +7.897475866393626e-01; -4.954111307646825e-02   -3.561208889885127e-01   +9.698833887768299e-02   -6.064660257978419e-01   -1.613663328904784e-01   +9.269083018636669e-01; -7.665061021411633e-01   +6.622669197828419e-02   -5.406239776842744e-01   -3.451127761786741e-01   +5.318562468642466e-01   -2.820784353811847e-01; +2.354890033365647e-01   +4.922647958647197e-01   +5.254170658721945e-01   -7.314761945254292e-01   -1.773711545359927e-01   -3.389164505345983e-01; +1.098999376153750e-01   -3.581466490418234e-01   +3.406472776210460e-01   +2.312965431421206e-01   -4.244275498687289e-01   -1.034512944839873e-01; -2.423980204962894e-01   +4.481073717631474e-01   +7.809517970641172e-01   -2.011534514216432e-01   +6.154511519559889e-01   +1.000000000000000e+00; -7.554004894174944e-01   -6.288480705303952e-01   +1.984884043879970e-01   -1.768360073001944e-01   +3.632335884833384e-01   +1.685151988759806e-01; -3.827922788392354e-01   +4.800074051588762e-01   -7.729352277061364e-01   -3.047129702575681e-02   -5.803817814333635e-01   +1.494897379449613e-01; -8.034102645541108e-01   +3.412876630733092e-01   +1.179150143961836e-01   +4.128036334771491e-02   -6.286402988176429e-01   +9.296276711351509e-02; -5.969146740630532e-02   -8.997635987363076e-01   -7.046497456626097e-01   -3.875411611117873e-01   -3.172836652630158e-01   +9.936926504028358e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
