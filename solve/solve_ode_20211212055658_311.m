function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-9.995653032306681e-01   +5.020033313741102e-01   -3.645166840880069e-01   -1.155013835683441e-01   +5.042635062304351e-01   -2.538775623616291e-01   +4.184420182863289e-01   -2.821912377482289e-01   +1.987997627711875e-01; +7.880124231476771e-01   -8.415390653146552e-01   -5.430736162540710e-01   +6.534909767578327e-01   -3.263791093365151e-01   -6.259712866002827e-01   -2.649276286199173e-01   +8.235475570175694e-01   +5.255085226663451e-01; +6.945219474785833e-01   -4.976163640312755e-01   -7.355134201709120e-01   -5.730152738416268e-01   -6.046810784009066e-01   +9.022679471929730e-01   +1.489715712413498e-01   -7.578944626604363e-01   -3.829331600521927e-03; -8.121077359625974e-01   +6.038829573198198e-01   -1.000000000000000e+00   +6.351082258622154e-01   -8.267912956884791e-01   -6.020301067598608e-01   -1.107645528112178e-01   -7.963688805588010e-02   -7.842272956717413e-01; -7.948377251072375e-01   -4.509691431347628e-01   -3.882002923250111e-01   +1.326316276619139e-01   +7.177955912905521e-01   -7.097993288649698e-01   -6.832505853270594e-01   +4.365185226297701e-01   +4.207700907573896e-01; +7.204150009233776e-02   -4.191494493662834e-01   -3.568018793246236e-01   -4.181225337162447e-01   -7.310380709687076e-03   +1.819966810923197e-01   -3.971054470569700e-01   -5.981995113127857e-01   -7.155365120001090e-01; -4.325046467617176e-01   -2.419917581269251e-01   -1.903808063062608e-01   -6.390625978308935e-02   -4.654585840611388e-01   +6.832589910625477e-01   -2.110424309962020e-01   -6.740731648420660e-01   +3.566265920486442e-01; +7.824623722478816e-01   +7.132899526430829e-02   -3.091628229502305e-01   -8.216129684974540e-01   +1.227870890072861e-01   -3.732802645413111e-01   -3.967238724026728e-01   -9.410978914946372e-01   +4.873538726961496e-01; +7.088241634661494e-01   +6.663426701629713e-01   +6.950064801755148e-01   -6.749826156830658e-01   -2.528307516812739e-01   -3.819990813821786e-01   +7.484394750765866e-01   -3.306465180332289e-01   -1.443568541684220e-01];
L1_L2_iAMPA_netcon = [+4.497120033705282e-01   -9.255953707875230e-01   -2.545567086309843e-01   -6.296250728045187e-01   +5.592782122262824e-01   -4.147813158250115e-01   +2.197979940692607e-01   +1.720242631679677e-01   +7.405687351593999e-01; +3.819494667938377e-01   -4.112421452564842e-01   -1.641823979754684e-01   +2.441170238904645e-01   +3.369061022301015e-01   -3.069959636813909e-01   +4.793598494469876e-01   -3.975747543915422e-01   +8.305665796596231e-01; -4.982129130487063e-01   -6.779557442027982e-01   -3.750277327589994e-01   +4.899128551396898e-01   -2.951211718342543e-01   -6.186369950358789e-01   -3.030056371737452e-01   +1.804427462177491e-01   +2.363633593270481e-01; +2.702667022762051e-01   +4.596941649095083e-01   -6.415303568324419e-01   +9.796421418281706e-02   -6.551972588060428e-01   -6.195125975120428e-01   +3.417425075905087e-01   -5.910461537313636e-01   +9.135034153914278e-01; -1.152384767542852e-01   -7.651971812951046e-01   +3.720372714878579e-01   -7.385757137910853e-01   -1.000000000000000e+00   -6.522340523193795e-01   -2.070737896161016e-01   -1.690517557444675e-01   -5.378679060923109e-01; +8.752993221764663e-01   -4.371042301632214e-01   +2.854224558765311e-01   -6.272728853126212e-01   +2.668734561731131e-03   +5.951517567526640e-01   +4.206154522476157e-01   +8.030685989404182e-01   +2.992638635955001e-01; -8.459469696598046e-01   -4.275667892554624e-01   -8.321922950763581e-01   +4.217512418015973e-01   -5.695542282692194e-01   -1.861403756592474e-02   -3.081135261471169e-01   +8.298973319704592e-01   -9.234205255168362e-02; +2.049754468496912e-01   +6.687311670067905e-02   -4.335683864475589e-01   +5.039911101980026e-01   -9.644636504892912e-01   +3.257005003731941e-01   +4.340427724182049e-01   -2.779353928933590e-01   -8.307241719542016e-01; +1.060697163301046e-01   -1.116599127455517e-03   -7.032923339470033e-01   +3.917716442044623e-01   -4.101134685280053e-02   +3.961617987856285e-01   -4.541803671464553e-01   -6.238122864287455e-02   +2.887700869924951e-01];
L2_L5_iAMPA_netcon = [+8.864895303892797e-01   -4.957330481373087e-01   +8.310458128885456e-01   +9.445067186297270e-01   -7.771154636522040e-02   +3.204280810723339e-01   +9.000636547731570e-01   -6.712354353559991e-01   -3.447627333925713e-01; +5.018890235083399e-01   -4.637071479090255e-01   -1.924869316416203e-01   +8.301794823727267e-02   +9.479293700595146e-02   -4.960421836384261e-01   -4.581204850230984e-01   -5.432104970488856e-01   +8.805666071521064e-01; -4.648871091982980e-01   -4.817912889291924e-01   +3.433041526138417e-01   +3.646703975870912e-01   +4.799087344770727e-01   +2.714299957644378e-01   +1.342242833525818e-01   -3.237396164463181e-01   +5.330131556108968e-01; +7.320480652407380e-01   +3.311582563306691e-01   -6.181583215759548e-01   +3.057428890531611e-01   -3.577498571965647e-01   -5.286411926244287e-01   -5.998129825362246e-01   +3.134550366797466e-01   -7.247906757434018e-01; +6.030198044651209e-01   +1.000000000000000e+00   +5.952754568399884e-01   -5.364699269717313e-01   -7.778564421804522e-01   -7.197559382497354e-02   -6.873264417530498e-01   +8.087432492838450e-01   -9.695665734016996e-01; +5.304160754647739e-01   +4.014079563756442e-01   -1.894921447403455e-01   -4.482884210014710e-01   -9.186958298203202e-01   -1.080373155655019e-01   -2.148810240748004e-01   -1.310396586028291e-01   -4.349777599544088e-01];
L5_L2_iGABA_netcon = [-2.836305724421525e-01   +2.169242352008070e-01   +5.425043422592516e-01   -6.888701958790804e-01   +2.689058394562822e-01   +9.334082653312098e-01; +7.758775515762719e-01   +3.316854710914933e-01   -8.053850328657095e-01   +5.906011291890352e-01   +7.830112863491788e-01   -7.502789043223798e-01; -1.957547149950002e-01   +1.420345767811724e-01   +7.880673164218788e-01   -9.714025031017748e-01   +5.180914534832728e-01   -5.599981060230518e-01; +1.883750146547088e-01   -8.565358066767353e-01   +5.686215649983040e-01   -9.719797698026503e-02   +4.016946961355353e-01   -9.476498523384316e-02; -3.596468561276094e-01   +4.243088608291348e-02   -2.221805592883529e-01   -8.136084829514788e-01   -1.629407726475741e-01   +3.372693710041473e-01; -8.078151288239928e-01   +5.055135793796004e-01   +1.110012032053377e-01   +1.791625969558266e-01   +9.114825937552450e-01   +5.284011647688955e-01; +5.018930423968672e-01   +5.405397200668896e-01   +3.637330320135593e-01   +4.861692900740169e-01   +3.436072517556078e-01   +1.509405615757174e-01; +1.325770738664782e-01   +1.903197984621206e-02   -6.165387113937557e-01   +6.931991399484150e-01   -9.105678126115371e-01   +3.201223055875060e-01; +4.694363998024636e-01   -3.165620157165026e-02   +5.848260556858295e-01   -5.940690548797430e-01   +6.354668735138456e-01   +1.000000000000000e+00];
L3_L2_iAMPA_netcon = [-3.424152331238305e-01   -5.137111134775646e-01   -8.325137427816552e-01   +8.351209481515789e-01   +1.865509040452133e-01   +1.689444975737695e-01; +6.725606263640176e-01   +8.362780807415955e-01   +4.561023248023790e-01   +1.591085828462017e-01   -3.659444987406795e-01   +2.725902479603594e-01; +6.181726224613586e-01   -5.693360012624457e-01   +5.411064244934556e-01   +7.284639283168455e-01   -3.311759254938064e-01   -5.881871242730583e-01; +7.816592615763255e-01   +3.119167079984903e-01   +4.765266241138770e-01   +7.291115534165999e-01   -2.335517086692231e-01   -9.288856734331581e-01; -7.987808077511831e-01   -6.590865021820448e-02   -8.215774357621223e-01   +9.837543199216605e-01   +5.480547299801294e-01   +1.737315960778417e-01; +3.160088735354546e-01   -9.771895387560712e-01   -3.435869117160470e-01   +4.123047925646120e-01   +9.325229892243730e-01   +4.563523662405673e-01; +8.606297019283707e-02   +4.393598683526402e-01   -5.145949781703422e-01   -1.000000000000000e+00   -7.661219669661705e-01   +3.230489069318826e-01; +2.832519715235155e-03   +2.171842442355351e-01   +1.015731303886383e-01   +5.398101825914592e-01   -2.604507262432456e-01   -1.060415666508458e-01; +7.212789264828011e-01   +7.358786904321684e-01   +3.741574450193146e-01   -8.717873189378008e-01   -8.751650879837868e-01   -2.460172809419299e-01];
L2_L3_iGABA_netcon = [+3.908980338770908e-01   +4.255408515563849e-02   -5.102172578461962e-01   +5.774598019379564e-01   +7.982861348813287e-01   -2.110061122731431e-01   -8.657404061261137e-01   +6.014284572404193e-01   +2.745294425298434e-01; +1.861287995313262e-01   -5.210355604537258e-01   +9.522727791647047e-01   -2.830428998307519e-01   +1.139095689551202e-02   +8.818100078811707e-01   -2.517257365621876e-01   -2.918070651241143e-01   +6.949336410963927e-01; +2.878006987951197e-01   +8.505443188155500e-01   -3.916686055750639e-02   +1.000000000000000e+00   -3.477105434531821e-01   +3.678966565863685e-01   -1.308246121437633e-01   -7.658195575747562e-02   +9.974802201417891e-02; -5.217243100425083e-01   +2.779894038991155e-01   -1.148999382131270e-01   +7.599714760105275e-01   -7.559457980361511e-01   +6.251027185639677e-02   +3.850748848373911e-01   +2.379051939297961e-01   +6.949508835911407e-01; +7.044268109455485e-01   -3.884200168807868e-01   +1.842463618830015e-01   +1.131465925941951e-01   +1.617350293267229e-02   +1.188880163997852e-01   -6.858103255215466e-02   +7.304372584956829e-01   +1.743399030790868e-01; +5.454373276072709e-01   -6.827082869463802e-01   -1.856358002382098e-01   -1.849708993141695e-01   -1.476149388567217e-01   +1.309037830939514e-01   +3.866391854488555e-01   -4.461214914667142e-01   -2.415737708882537e-01];
L1_L4_iGABA_netcon = [+9.438866789731944e-02   -8.618815299593469e-01   -3.536808146753547e-01   -4.476674028411203e-03   -8.144840729977543e-02   +1.568666039744690e-01   +2.656370847664966e-01   -9.564195263964935e-01   +6.983833733983672e-01; -7.601302300053076e-01   +1.301046777250237e-01   -8.334946579606451e-01   +5.815668941295130e-01   -4.646721398496518e-01   -3.870849211954284e-02   +4.301527893955281e-01   -6.459208877494277e-01   -3.176512648879530e-01; +5.083454849879693e-01   -4.886202651187090e-01   -1.420957299103357e-02   +1.245150352806668e-01   +8.627069198211036e-01   +2.766731497996727e-02   +5.740920815472712e-01   +4.038063427150902e-01   -5.182625612103041e-01; +4.149142416541033e-01   +2.879531947667490e-01   -9.306489504065019e-01   +4.559356821593241e-01   -2.130923396211391e-02   -5.207558923896032e-01   -8.454984393894118e-01   +1.865739931598777e-01   +4.115922657745313e-01; -8.005929418373431e-01   -5.548892668709924e-01   -8.636762735989416e-01   -6.279341771020247e-01   -6.947047779861985e-01   +6.861933603874488e-01   -6.550565434587823e-01   -2.375368277231061e-01   +2.650360421189866e-01; +1.583987130976477e-01   +1.236091240730861e-02   +1.663089039193001e-01   +3.552658299871995e-01   +8.506248743899602e-01   +8.073094955614901e-01   +1.261797540783605e-01   -3.978917816563493e-02   +3.367232376581573e-02; +2.616112759560308e-01   -2.768417894269835e-01   -5.591273373646857e-01   -3.150143698345498e-01   -5.350669738263633e-01   +3.845622802528046e-01   -3.639387884736487e-01   -3.445227767934524e-01   +9.250476223376093e-01; +7.672165083273681e-01   +1.418590359437226e-01   +5.692417567151355e-01   +4.309334558693438e-01   +2.920938779379851e-02   +7.442137894838728e-01   +2.410619944416942e-01   -6.597526706325921e-01   -4.035512642825627e-01; -3.548950022656092e-01   +1.000000000000000e+00   -1.599807183201455e-01   +9.514122363438808e-01   -6.955581719979845e-01   -2.590338248545785e-01   +1.483987777824071e-02   +1.506936377866581e-01   -5.776713291163283e-01; -2.594445382201219e-01   +4.852093045816390e-01   +3.503323833766895e-01   -5.109237501490942e-01   -5.655916474376054e-01   +6.053986595214663e-01   +7.070730214815707e-01   -9.604516224660105e-01   -5.460428507586372e-01; -7.914024330841856e-01   +1.610080772612163e-01   -4.338942427128490e-01   +5.975154962742560e-01   -8.286327492173273e-02   -3.259138648471506e-02   -7.837247159566153e-01   +3.565063314486973e-01   -6.512860115098019e-01; -6.245205828191287e-01   -7.681819042391264e-01   -5.125073640601169e-02   -2.633331875163875e-01   +7.787064645659244e-01   +8.785048823399252e-01   +4.036239563333595e-01   -3.439545659091694e-03   -2.661002720379164e-01];
L4_L1_iAMPA_netcon = [+3.176310352970094e-02   +1.688597383319179e-01   -1.809158350260282e-01   -9.480534148140930e-01   -6.065153541585012e-01   +4.402269485131977e-01   +2.926916469641873e-01   +6.378816426155246e-01   -7.845629737840155e-01   +5.523367838722262e-01   +9.885874296854497e-02   -3.746599550246840e-02; +7.861775295090621e-01   -1.000000000000000e+00   +4.580339494893899e-01   -7.277803547914801e-01   -5.215073291821958e-02   +6.900692539488363e-01   -2.209239873789424e-01   +5.216977927605744e-01   +3.826001194533692e-01   -1.958085766279651e-01   -4.035107385771814e-01   -4.734250849534866e-01; +6.453602839799875e-01   +5.403550452805610e-02   +1.075157985172403e-01   -3.947700056624759e-01   -8.493437439964358e-01   +6.007850369467467e-01   +4.668140338895089e-02   -8.219716263683972e-01   +4.881518326661907e-01   -8.806757223284458e-01   -2.560426427319308e-01   -9.512090246272288e-01; -4.164310229909723e-01   +1.690528763329025e-01   -1.865741980791513e-01   -5.655827437743211e-01   -2.579806420017821e-01   +5.238184491560842e-01   +5.564047130914040e-01   -7.378195050286692e-01   +4.037717883402621e-01   -1.713653244029540e-01   +8.996365978536635e-01   +1.850614876800869e-01; -6.140425119959484e-01   +7.813612692054309e-01   +2.278764178405177e-01   +6.527549558485595e-01   -1.217966439918981e-01   -8.576211702475825e-02   +9.025675967957791e-01   +9.601109495101368e-01   +6.714668910101985e-01   +1.875118340466441e-01   -2.435770515181831e-01   -5.537697325258256e-01; -1.188868463471453e-01   +8.797059223106262e-01   +8.670637184079152e-02   -3.185656688512080e-01   -1.473429969199456e-01   +6.892140896031587e-01   -1.522756567570472e-01   +5.528130151854114e-01   +6.630670883243825e-01   -5.274265113428799e-01   -7.940646192162347e-01   -5.833211857336225e-01; -1.773873787627112e-01   -2.292038456170318e-01   +1.019865749577503e-02   +7.140657128614809e-02   +7.073551464472549e-01   +5.180265572638924e-01   +4.440007209912360e-01   -8.058147723131684e-01   +8.632510851649686e-01   +4.730166738764606e-01   -8.395883313674165e-01   -1.153689694279746e-02; +2.417359214622537e-01   +8.011229073679172e-01   +5.219304262725709e-01   -7.053464055041083e-01   -7.101964533605628e-01   +1.719765228764486e-01   +7.478301245642961e-01   +4.104935068061646e-01   -3.310356663940267e-01   +1.860426913987798e-01   +2.943516896769588e-01   +4.813184675440311e-01; -6.656908388733924e-01   +8.278700152819728e-01   +6.105451614926733e-01   +1.303818773690385e-01   -4.136522268785950e-02   +5.135424286719528e-01   +3.958522839743989e-01   -7.971397720435847e-01   +9.520934716787735e-01   +4.418048596245282e-01   +2.728579211843457e-01   +7.802977607131217e-01];
L1_L3_iAMPA_netcon = [-6.963259694525255e-01   +1.645191408707362e-01   +1.189341440568373e-01   -1.000000000000000e+00   +6.119296859335344e-01   -4.596232717187998e-01   +8.601179286253915e-01   -2.374407515202331e-01   +7.634592934885229e-01; -3.970344417567096e-01   -3.618934005766705e-04   -7.059044830314621e-01   +4.026374091027409e-01   +1.959783601956268e-01   -5.323408872544638e-01   +4.296566003590400e-02   -9.177677274951007e-01   +1.489558392782250e-01; +6.336354089247272e-02   -4.334592587321506e-01   +1.122574024122254e-01   -8.508717891534127e-02   -6.389979467270828e-01   -2.432497570773011e-01   +5.634696518643755e-01   -2.164580609304525e-01   +9.209444480460124e-01; +2.561946416238383e-01   +5.677582041425812e-01   +3.162090190449994e-01   +3.099063594513051e-01   -9.628192123243691e-01   -7.771143276294856e-01   +7.610465683645398e-01   -8.792688796892478e-01   +5.162270396894238e-02; +1.220187306075188e-02   +4.867112542115649e-01   +4.545973136600573e-01   +3.528161129981258e-01   -6.594047149496692e-01   +1.061670357467383e-01   -7.652659660018141e-01   +1.408300805726391e-01   -7.426328431612390e-01; +3.997937674664588e-01   +9.514242522317373e-01   +3.193855582450995e-01   +7.232230617913936e-02   -4.232682600920116e-01   -4.367746446665965e-01   +4.599550639730474e-01   +1.021284837582994e-01   +8.379196442910488e-01];
L3_L1_iGABA_netcon = [-9.558474816071384e-01   +7.079817050674614e-01   +4.896637941240512e-01   -8.798936053092540e-01   -9.034466740011686e-01   +1.540860582751189e-01; +3.546870309234505e-01   +8.960907673336622e-02   -8.113820600352043e-01   -7.547698980673088e-02   +2.349079480889434e-01   -6.455036737186230e-01; -5.945201997388105e-01   -7.176121193311369e-01   -8.961223892597884e-01   -9.056381194622467e-01   -3.360689437279755e-01   -5.530048134225400e-01; +2.007331913515003e-01   -6.041762439309390e-01   -1.419394035845825e-01   +8.721430421523654e-01   -4.745481434651121e-01   +6.726381873887763e-01; -8.710743816186678e-01   -5.250268324378642e-01   -9.256450158459965e-01   +1.904537954858207e-01   -1.060745979401799e-01   -2.663559798810664e-01; +8.660460373806255e-01   +8.881128406769855e-01   -7.820909365323849e-01   +5.738915169157925e-01   -3.546034522604032e-01   -1.079946664460642e-01; -1.958675137829864e-01   -7.562780415405574e-01   -1.997533921662696e-01   -2.780520705667056e-01   -6.293514082184753e-01   -2.739247185782176e-01; -8.018250504934978e-01   -4.229246795445031e-01   +2.627812088476406e-01   +6.631583970141078e-01   -5.827902147121503e-01   +7.929046038812713e-02; +6.508377520762366e-01   +4.853677365161358e-01   +5.033213688071999e-01   +3.462383549338199e-01   -8.091840459604007e-01   +1.000000000000000e+00];
L5_Input1_iAMPA_netcon = [-7.250193031319693e-02   +3.581858619575843e-01   -3.110544110268491e-01   +1.000000000000000e+00   -4.075054523363482e-01   +1.380923194800886e-01];
L6_Input2_iAMPA_netcon = [+4.547038560771771e-01   -1.000000000000000e+00   +1.325805723925274e-01   -9.234631070476722e-01   -3.099938120136904e-01   -7.499104433470615e-01];
L5_L6_iAMPA_netcon = [+7.230709181661200e-01   -4.474342847051798e-01   -5.582032298563523e-02   -6.136174698070193e-01   -2.366997215502492e-01   -4.735790706207703e-01; -7.415778548333527e-01   +7.841159147269144e-01   -5.775041097533997e-01   +1.120643600106545e-01   -3.630713593470757e-01   -5.545026266374524e-01; -6.773554822352993e-01   -4.776878622270048e-01   -5.745183918260346e-01   -3.283914610660718e-01   +4.427786672277330e-01   -2.585886537027477e-01; -7.383846280284291e-02   +1.065534262394395e-01   -7.350585507202795e-01   -6.322210648772525e-01   -2.806339967450388e-01   +3.623705799091251e-01; +9.415877563417577e-01   -3.354495700537617e-01   -7.172118255963116e-01   -3.684984818818542e-01   -2.408071126457947e-01   +2.062973297243825e-01; -1.000000000000000e+00   +5.049999667875922e-01   +3.992828265648831e-01   +5.804391967536005e-01   +6.565819503484480e-01   -4.890530880322302e-02];
L4_L5_iGABA_netcon = [+2.215194161402452e-01   +1.435140334428299e-01   +4.506118314602011e-01   +2.202053756892204e-01   +4.227315750473390e-01   -3.512738436233154e-02   -9.002879262081007e-02   -4.256812103642614e-01   -3.181506639305765e-01   -6.360591465073688e-01   -4.105449469560180e-01   +4.825779830631718e-01; -2.408606289429776e-02   +8.148794578871564e-01   +1.000000000000000e+00   -1.202159980899433e-01   +7.115419173747366e-01   -7.208226759947799e-01   +2.467257558122114e-01   -9.027041022807565e-01   +5.841494462792777e-01   -2.773153032006866e-01   +6.833791830269015e-01   +6.536132227724513e-01; +3.247863836487028e-01   +2.827707499379277e-01   +2.294363471658134e-01   +1.318765324459943e-01   -7.427791100593319e-01   +3.551678932150085e-01   -3.670406877425992e-01   -4.728557592152193e-01   -3.711148319532189e-01   +8.085324955335215e-01   +7.456018932098163e-01   +7.858815995210615e-01; +2.461604459080835e-01   -8.609847823166995e-01   +8.649668889401790e-02   +1.932921242978478e-01   +9.587873608713401e-01   +8.789032700316819e-01   +7.495622452713054e-01   -1.679932987368790e-01   +9.101349794244724e-01   +4.132453942219230e-01   -4.698999985956693e-01   +5.484061770147880e-01; -7.129824238476543e-01   +5.591710184026992e-01   +1.748060856688968e-02   -1.415648635729005e-01   -6.186116369665925e-01   -3.249066964630026e-01   +5.270920455879020e-01   -5.352392831831513e-01   -5.406834217530132e-01   -7.862276079909056e-01   +4.765542024703684e-01   +3.611560495796905e-01; -4.234309132811800e-01   +3.420502096133244e-02   +4.479038207119184e-01   +4.327063326891857e-01   +2.600282892137488e-01   -2.747686379244442e-01   -1.385096557555858e-02   -6.130707903093511e-01   +7.475549137041611e-01   -8.956138043181003e-02   +1.154614083784266e-01   -9.270891673601034e-01];
L6_L4_iAMPA_netcon = [+4.005298996914546e-01   +4.064028891270509e-01   -7.599666889470049e-01   +2.782525557258982e-01   +1.060448150269961e-01   -2.884851588338182e-02; +7.769687847488398e-01   +3.513868669103420e-01   +4.503170660027409e-01   +7.928286072205224e-01   +1.000000000000000e+00   -6.729200892853106e-01; +4.841600772894550e-01   -1.666572741888963e-01   -6.500158926773404e-02   -7.539009212996338e-02   -1.413475649364076e-01   +7.905714309278143e-01; -1.234803450267118e-01   -1.363637158117535e-01   +3.642979653614463e-01   -2.315638941165826e-01   -7.589358373185633e-01   -6.083864722467670e-01; +9.071783049386574e-01   +3.883075483957992e-02   +1.294087053907435e-01   +6.465553636535405e-01   +7.279432627717657e-01   +2.314247720502211e-01; -7.358518350021567e-01   -2.247395599314725e-01   -8.762971859346561e-02   -7.835466305802646e-01   -3.805963960464767e-01   +8.319331874725583e-01; -7.099892915092398e-01   +5.649343497694851e-01   -2.437924725855861e-01   -6.142028691485950e-01   +7.042188984751266e-01   -1.055751181073521e-01; +2.512316332290310e-01   -8.242004917988541e-01   +2.127718398423629e-01   -4.046144947825508e-01   +4.920331406370054e-01   +7.503408445711346e-01; +1.974901153777123e-01   -4.505538634660102e-01   -3.730354462742794e-01   -5.100937667627649e-01   +2.417566916944350e-01   +4.785026965097596e-01; -6.783330013974110e-01   +1.908490687374490e-01   +1.016559669425215e-01   +2.533831017335869e-01   -7.612131286474416e-01   -5.117292607323740e-01; -4.342972486688717e-01   +7.355468634234086e-01   -5.996803484892186e-01   -6.795542458609111e-01   -5.696093284219517e-01   +8.687547029870012e-02; -6.774437716932349e-01   -8.089962426517384e-01   +9.086704893622410e-02   -7.409549837631068e-01   +9.941243060530400e-02   -3.623600988022652e-01];
L5_L4_iAMPA_netcon = [-2.805005012686395e-01   +4.822933746786914e-01   -5.233678545754149e-01   +2.946244087706715e-01   +1.314175419326500e-01   -6.244174130718561e-01; +3.116866156878104e-01   +9.384118131917457e-02   -4.235810338653620e-01   -1.434032511510304e-01   -7.259485756708682e-01   -9.400343442876434e-02; -8.344094488865103e-01   -2.760356393817712e-01   +7.173015867343684e-01   -4.484137747564620e-01   +1.000000000000000e+00   +5.992712933740697e-01; -2.984896753089544e-01   +6.193568444442447e-01   -5.423173743880624e-01   -5.384957726149326e-01   -3.067479308799024e-01   -2.361282469348756e-02; -9.054259786269256e-01   -6.528528546940311e-01   +7.218949021746157e-02   -9.119897686642469e-01   +5.266972220188439e-01   +3.534467140809546e-02; -2.099604805387277e-01   +6.851224423523411e-01   +6.498155562626721e-01   -1.103461236488307e-01   -7.908523658199139e-01   -4.565813697432443e-01; +4.670243641663077e-01   -4.527042402031433e-01   +7.542836170903683e-01   +1.177074998028478e-01   +5.018271282895723e-01   +3.267154564415565e-01; +3.000818011107381e-02   -7.465316085892403e-01   -3.299402152235125e-01   -6.255771010628759e-01   -6.166182620155957e-01   -6.875926677575742e-01; -2.383907159349984e-01   -4.907715309634582e-01   -7.800409407615803e-01   +3.154020918367799e-02   -4.306930079925211e-01   +2.677408596169593e-02; -6.015282029401053e-01   -2.182447259018081e-01   +4.841186177800351e-01   -3.380977455078263e-01   -8.532042628343536e-01   +6.662347015427769e-02; +9.375734552813370e-03   -6.284528496381436e-01   +7.286505519926341e-01   +6.639529495150538e-01   -3.606003359347096e-01   -3.997756846626543e-01; +4.333212457967904e-01   +4.804895884521087e-01   +3.447546728356488e-01   -5.922074659550144e-01   +2.855319845602888e-01   -2.453598408309877e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
