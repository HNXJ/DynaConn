function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.145396349895957e-02   +2.292515111476526e-02   -6.635288212613749e-02   +5.107967668434386e-03   +1.192052764487798e-02   +1.471937227055456e-01   -8.141756169208977e-02   -7.034592468729412e-03   -1.850154394748460e-02; +1.655676878431074e-01   +3.777570325565248e-02   -1.067418377095263e-01   +1.008417814260808e-01   -4.210325881998154e-02   -6.913057458895593e-02   -5.309752361666041e-02   +4.385219580567770e-03   -6.853072882625745e-02; +7.093762811250894e-02   +2.755219584292016e-02   -7.394284922130032e-02   +2.642181645675971e-02   -1.332193028838848e-01   +1.013713551081511e-03   -3.343641046168930e-02   -4.874216986402344e-02   +7.478008581167736e-02; +7.143712952703905e-03   -3.667080473795200e-02   -1.126123242283761e-01   +1.120465048607063e-02   -6.932686216439085e-02   -5.322798001051452e-02   +1.234792370675625e-02   -2.044207093029738e-03   -3.687411911914765e-02; -2.367391366770641e-02   -1.476388120069153e-02   -6.460894933132225e-02   -7.862896296065795e-02   -1.163361962349300e-01   -3.213603793015907e-02   +1.276190239094342e-01   +9.114953366289574e-02   -6.096708898867127e-02; -5.983785258375739e-03   -1.474598366007310e-02   +4.942288438298936e-02   -6.992271677772648e-03   -1.062332939910662e-01   -4.985328299814919e-02   -2.642508429073571e-02   -5.196104160735482e-02   +2.451353166720249e-02; +1.193772379394196e-01   +1.439417863864800e-01   +7.446111342277009e-02   +2.205054251761798e-02   +5.297845595361964e-02   +4.822867043493913e-02   -9.666317191651141e-02   +2.822544815469512e-02   -1.667300154805179e-02; +1.051369005011989e-01   -8.702033529103753e-02   +1.554677095607179e-02   +1.147814116897287e-01   +5.807876418377150e-02   -8.805376694977647e-02   -1.151209407495033e-02   +5.010584250166245e-02   -1.174858266266351e-03; -2.616684399446426e-02   -1.037966917991555e-02   +1.225278085169338e-02   -1.064000170597472e-02   -1.594330500676616e-01   +9.751826727708955e-02   +1.133964477764203e-01   +3.656939637593307e-02   -3.656021729784076e-02];
L1_L2_iAMPA_netcon = [-5.770278819901435e-02   +3.717433543707432e-02   -9.507975440798601e-02   +5.453780202096089e-02   -1.025745992212447e-01   -7.902976678818405e-02   -4.457907584857418e-02   +1.007673154864651e-01   -6.854254481112287e-02; -3.934280874284071e-02   +6.171685848476040e-02   -1.078087474828987e-03   -2.282982031235354e-02   -1.667846355782992e-02   +2.144627391925711e-02   +4.927975484325393e-03   +2.560591679351451e-02   +4.895782796383828e-02; +5.713826222001516e-03   -1.036409355826158e-01   +2.948607893566666e-02   +1.699511640162331e-02   -1.692174610579471e-02   +1.461165869744435e-01   +1.301164270939293e-01   -7.855632810189829e-02   -5.134436557586227e-02; -1.122957169774385e-01   +6.931156776509979e-02   +8.617973172399612e-02   +3.416080004644483e-02   -6.116810000848086e-02   +8.556737490878788e-02   -3.514866713717507e-02   +7.865861645386762e-02   -8.281904296855486e-02; +2.857911308507045e-03   +8.531038303667495e-03   -1.654188732992491e-02   +1.596933603199599e-02   +3.281534735227011e-02   -5.695095682193701e-02   -1.196345581215007e-01   -2.753140551974413e-02   +1.065975517387053e-01; +6.463132360529679e-02   -1.140035478434464e-01   +5.290784856719289e-02   -3.010511910041290e-02   -7.347962088359547e-02   +1.310786831528197e-01   +3.749759718562887e-02   -1.777758696712838e-02   +7.657428838950712e-03; +1.992037549874233e-02   +1.255995087742582e-01   -1.336491728321965e-01   -1.097178691553253e-03   -4.948318822471051e-02   +7.692712847241292e-03   -3.635696052065553e-02   +4.722656104999533e-02   +7.153873357874239e-02; -1.844615794411424e-02   -6.749646120647354e-02   -8.502104978182774e-02   -6.582343281389319e-02   +3.417320491566532e-02   +4.837905989950690e-02   -1.513357448141496e-01   +1.317621866847944e-01   -9.976940136780398e-02; +4.781871083806916e-02   -3.830518352096184e-02   +7.238709910813891e-03   +4.703472160530349e-02   -6.229682760289863e-02   +2.295859192068888e-02   +3.262773372891347e-02   +6.501860926486903e-02   +1.876895571477918e-02];
L2_L5_iAMPA_netcon = [-1.426819911669737e-02   -7.548872056494862e-02   +6.927676671175160e-03   +2.571015709311501e-02   +4.250716453781705e-02   -1.153487238055934e-01   -2.747467652376206e-02   -4.518061719400900e-02   +1.281295767766206e-01; -6.216775908189884e-02   -1.185678684043545e-01   +1.065848057077173e-01   +9.611057410050372e-02   -2.896935835911402e-02   -5.925928032114987e-02   -7.576593788271357e-02   +1.468500189729211e-01   -2.391048773998811e-02; +1.779210995521990e-01   -7.517228285895763e-02   +1.013838286986318e-01   +2.928089547745392e-02   +3.348810291124798e-02   +3.109798276933814e-02   +1.177727832409072e-02   +1.954852664606947e-02   +7.085125518580927e-02; -4.194930288851180e-02   +7.174191935451431e-02   -1.324527946113823e-03   +1.281338279506940e-01   +1.323962701771560e-01   -2.912265935851639e-02   +3.148459350516841e-02   -5.291442283888249e-02   +4.983448827025881e-02; +1.711963668123188e-02   -2.023401255421803e-02   -1.157911862444287e-02   -2.257266699000207e-02   +7.127416457030497e-02   +3.781705948513064e-02   +1.164086168760876e-01   +4.528194325666536e-02   +3.392890752303922e-02; -3.069884738592355e-02   +2.313933663122020e-03   +1.396552581319297e-03   +5.708140559836504e-02   -3.028554864811496e-03   +3.582680553160652e-02   +1.620878490069164e-02   -1.238325413111512e-02   +5.302824744892276e-02];
L5_L2_iGABA_netcon = [-4.085739487509007e-02   -3.061540778122954e-02   -7.770454250611379e-02   -9.980450811574702e-03   -5.744310691665684e-02   +6.395278340421823e-02; -3.005295896604826e-02   +1.751712465457024e-02   +9.700083948571081e-02   +5.359470309537250e-02   +9.959615953030297e-03   -4.774228302838236e-02; +5.504149137895148e-02   +4.088345132951043e-03   +8.986132857821767e-02   +1.259600644764291e-01   -2.840743862591946e-02   +1.955461566682301e-02; +1.730676520527414e-02   +1.091631580965645e-01   -2.766306432806469e-02   -5.309073233956916e-02   +2.568830202622373e-02   +1.111911471682778e-01; +6.033086918634853e-02   -9.109856324058151e-02   -4.100988912266891e-02   -1.661280548878258e-03   -8.779017512939430e-02   -6.120688336247015e-02; -8.042725041039758e-02   -4.106423927609011e-02   +9.752304556896275e-03   -3.681688365660180e-02   +1.029728071039689e-03   +3.064853007919622e-02; +4.751180443111169e-02   -7.258085567341077e-02   +1.843357721073348e-02   -1.111826403520902e-02   +9.696941787821244e-04   +8.368485346407326e-02; +1.057073570741562e-01   -6.566857480860952e-02   +3.254526686144446e-02   +4.071636449195572e-02   +7.570438750451247e-02   -2.144970226608724e-02; +7.227405955971770e-02   -6.869873936907611e-02   -1.392585233686086e-02   -3.284130451551716e-03   +4.775572022347117e-02   +7.617968176804973e-02];
L3_L2_iAMPA_netcon = [+8.395316820806145e-02   +1.417210733835644e-02   +5.931146169313885e-02   +9.369903004556761e-02   -2.688121878233185e-02   -5.552808397709782e-02; -2.881772077568991e-04   +8.922808431220623e-04   -1.106106763111384e-01   +2.653550332362923e-03   +1.252756220597816e-01   -5.779880074594717e-02; +5.243969762298469e-03   +1.522800418582474e-01   -1.062419299034187e-01   -2.250733827018621e-02   -1.472692251299066e-02   -1.559814336746517e-02; -3.402234109057406e-03   -4.051227296266467e-02   +6.141602087497278e-02   +5.947920465126783e-02   -9.826404366615031e-02   -5.158800144897175e-02; +8.795545746385390e-02   +2.400698260702710e-02   +8.129353512376687e-03   +2.308509211613835e-02   -3.895623485979283e-02   -1.204039172592181e-02; +8.017088305316014e-02   -3.579988227192448e-03   +4.131238681660088e-02   +1.159273057127195e-02   -2.017746706077945e-02   -3.530951818181251e-02; -4.818929440918841e-02   -6.064227860673604e-02   +2.079929171968179e-02   -2.095172286642776e-02   -2.110942346466804e-02   +6.383165158285145e-02; +1.066130775560895e-03   -1.180958624732115e-01   +8.823107263773783e-03   -1.040907264560935e-01   -5.482804810890144e-03   -6.100210343609022e-02; +5.409460477492457e-03   -4.092170911982841e-02   -5.658619606698176e-02   -8.137639944710706e-02   -1.202550699374646e-01   +6.553785787745636e-02];
L2_L3_iGABA_netcon = [+4.859882534974710e-04   +1.216566071973217e-01   +2.956333448682925e-02   -7.258217680218013e-02   -1.308951083895349e-01   +3.673249660239029e-02   -3.636188966109986e-04   -4.404016767313801e-02   -4.153046225107519e-02; -3.329554868535010e-02   +6.303339211811636e-02   -9.944481924786412e-02   +3.291751981921781e-02   +3.320813428453037e-02   -3.087942169487123e-02   -1.505332099849720e-02   +6.196242137606375e-03   +4.848429957391363e-02; +1.223175082293191e-01   +4.505574938583986e-02   +6.467986687677822e-02   -1.132900878735895e-02   +4.132967314137456e-02   -5.430659731524841e-02   +4.363992680308897e-02   -7.892707168666085e-02   -7.456666081579913e-02; +4.485351702082478e-02   -3.047474036363547e-02   -1.018525481987916e-01   -6.762315697899188e-02   -2.166043386899265e-02   +2.320177626184573e-02   -1.510967635538834e-02   -9.117672647098419e-03   +2.633878859306410e-02; -1.790572741874228e-02   -2.948242696741562e-02   +1.788191004911930e-01   +6.304949908386033e-02   +5.667668819514113e-03   -4.194572460819941e-02   +5.138267950548642e-02   +1.429086336200298e-02   -1.104214094939613e-02; +1.062632698900128e-02   +9.503190994770705e-02   +2.746905389979109e-02   -1.883061212647555e-02   -4.332772121017729e-02   -6.439142148750804e-02   -1.213178209264829e-01   -4.257852083882217e-02   -4.015422799744840e-02];
L1_L4_iGABA_netcon = [-1.928618358528871e-01   +6.857291483606980e-02   -6.971327524569297e-02   -4.685767413851272e-02   -2.433588807418345e-02   +4.538210390591215e-02   +4.840219347930898e-02   +5.699771560563446e-02   -2.805511981222713e-02; +7.430149157002139e-02   +4.292929990984063e-03   -5.005566287471955e-02   -1.137473226469650e-01   -9.431749067023065e-02   +2.637227838431779e-02   +2.452640652412774e-02   +2.583969573980295e-02   -4.124956399906257e-02; +6.168025363271872e-02   +1.199059134708954e-01   +2.369916693366333e-02   -5.211024903165717e-03   -7.912808811542744e-02   +3.212591900617719e-02   -5.729066907246785e-02   +7.370992125996594e-02   -8.467929143811422e-02; -2.614635813570068e-03   +9.717183718365221e-03   +3.577811954335179e-02   +2.668404056709241e-02   -9.399205216924382e-02   +2.009953843985866e-02   +1.364709486647136e-02   -2.208382456824920e-02   -3.026176779257960e-02; -4.002630323699558e-02   +8.651176891363985e-02   +5.803037904353268e-02   -1.493909490075916e-01   -2.910169180396388e-02   -3.701917610325908e-02   +1.097432746559766e-01   +8.869012088765874e-02   -1.066732767991333e-01; -2.786663849651076e-02   +2.971847577206370e-02   +4.823996816292861e-02   -4.027062312086628e-02   +1.382690515421733e-01   +1.464588114246457e-02   -8.390254400445459e-02   +1.120959230809317e-01   -1.154673158202768e-01; +1.849583553509714e-02   -6.339806316448630e-02   -8.863092008204533e-02   +7.745682557191461e-02   +3.380265091036579e-02   -3.486044186238518e-02   +1.039747056883411e-01   +3.928667636923448e-02   -6.946589844880639e-02; +6.924768583186475e-02   +7.982725426609351e-02   -4.051796623213454e-02   -2.347129534689354e-02   -3.630377379535064e-03   +2.827605579100229e-02   +3.472193591426924e-02   +4.432328049715351e-02   -1.054316377369728e-01; -2.333112787083028e-02   +2.223758414849007e-02   -4.377740916390380e-02   -6.297964258381002e-02   +3.324359114080542e-02   -8.334254301375407e-02   -2.208172388418403e-02   +2.767202351368775e-02   +2.496282630573635e-02; +2.776539949198515e-02   -1.409469014962129e-01   -5.682776479434850e-02   -8.638219686485643e-02   -3.512943648626602e-02   +1.279825397372878e-01   +6.452834476199518e-02   -1.488905466036431e-01   +2.913027158121035e-02; -8.957637893223730e-02   +1.118317426410328e-01   +3.743970077063850e-02   -3.969644934244604e-02   -5.232776632474938e-02   +1.239417587769833e-01   +1.034671432782087e-01   +1.104104799410664e-01   +5.980515919929069e-02; -3.005609957376451e-02   +2.045409346884012e-02   -2.028824834159777e-02   +4.857024489987263e-02   +5.690911756727474e-02   -3.737669961614613e-02   -9.568704193228543e-02   -4.680198828605609e-02   +8.178785177163093e-02];
L4_L1_iAMPA_netcon = [+3.418722040316118e-02   +2.745735721509608e-02   -1.564898906683707e-02   +9.338062273130650e-02   -4.486411778995542e-02   -3.429115551327029e-02   -2.103709321529323e-03   +1.306989841706161e-02   +1.028054228280585e-01   -3.912268952141112e-02   +4.903631495432039e-02   +3.141699393651894e-02; +1.233051926093560e-01   -2.042470727661463e-02   +4.395164192306482e-02   +5.636986489515222e-02   +6.335811711341865e-02   +1.406920262550141e-01   +7.830796919983146e-02   -3.430730631978375e-02   -1.133041884141002e-01   +2.048623441631275e-02   -4.507537909779799e-03   +1.854865448153909e-02; +1.951521937581940e-02   -3.670931692392861e-03   +9.919827270571316e-02   -2.965708842463151e-02   +2.937452550970009e-02   -2.367717285446878e-02   +1.009903473534078e-02   -7.289258310686568e-02   -7.864989386629843e-02   -6.959715214253241e-02   +1.337788542165688e-02   +2.242419316903976e-02; -1.436244123374977e-02   -8.391565144295531e-02   +1.690556445579744e-01   +1.052261266271665e-01   -7.878654665754271e-02   +6.799408403237153e-02   -1.003638071498615e-02   -9.958175557668116e-03   +3.820237914194000e-02   +3.831249158307322e-02   +4.062225841621848e-02   +1.862605098094433e-02; -3.579225128210097e-03   +5.927657458760160e-02   +2.651186586522805e-02   +3.398962462643177e-02   -5.786911548890104e-02   -6.541576156120220e-03   -1.170113213663101e-01   -6.703136856390679e-02   -3.787246910801134e-02   -4.335382237629980e-02   +9.148262297604987e-03   -1.671069486824445e-02; +3.008012747324381e-02   -4.945179578063769e-02   -1.762747407050030e-02   +5.558861889380670e-02   +4.395298812971733e-02   -2.294592859125975e-02   +1.208554479380924e-02   -5.195166288503720e-02   +1.343693946054917e-01   +4.391868442951740e-02   +1.241769963776510e-02   +1.757310569624023e-02; -9.262660267259894e-02   -3.441833527958731e-02   -3.350188547086505e-02   -7.997970274980201e-02   +1.153430476910562e-01   +1.015667059085603e-01   +4.369427089764635e-02   +3.199394249611722e-02   -1.435051487125709e-01   +3.672412989403820e-02   +1.018097270369517e-01   -2.366970306631793e-02; +3.912824510444180e-03   -3.859317707581703e-02   -1.387313424820713e-01   -4.255107620860681e-02   -1.259427855664979e-01   -2.027950637247281e-02   +3.665500945668541e-02   +1.340760947000953e-02   -5.762517952535351e-02   -7.895132220777226e-02   -5.580644217066946e-02   +2.043045130137773e-02; +9.607382256355852e-02   -2.140580059764863e-02   -9.893321524522754e-02   +8.197867764044658e-02   +6.727204408312971e-02   +1.861398874577088e-02   -1.055666548771236e-02   -1.227818504758185e-02   +3.072283655618846e-02   +8.581777922736576e-02   -8.992685053331995e-02   +5.138086319441938e-03];
L1_L3_iAMPA_netcon = [-4.890488534283723e-03   +4.456823239409459e-02   -1.762364488005559e-02   +6.268046441801605e-04   +1.485882439707735e-02   -9.530728740145950e-02   +7.358541832975815e-02   -1.810781087634516e-02   +7.496890998586576e-02; -8.629383180266023e-02   +1.001764388055430e-02   +7.268230663333969e-02   +4.931758579134230e-02   +4.555932352551086e-02   +5.809786875477600e-02   -1.743520793902945e-02   -7.222438900331030e-02   +4.144031857641409e-02; -8.085441966495816e-03   +3.453225527437070e-02   -4.868150360386259e-02   -7.180562805251320e-02   +2.489253699523446e-02   +2.711933465225985e-02   +7.996093246051610e-02   +4.279914161457656e-02   -5.826204676384349e-02; +1.841258277934493e-03   -2.632529410295661e-02   -1.080797946377766e-03   +3.717974454690930e-02   +2.744798876430939e-02   -2.333052586217831e-02   +2.292619080425913e-02   +3.630183455962802e-02   +6.977427134315757e-02; +6.699513368438559e-02   +4.783440065894459e-02   +2.273175347565078e-02   -1.320804262614621e-01   +1.114652419333481e-01   -9.021422299775204e-02   +2.932230567207920e-02   +6.407175002333071e-02   +7.229156984001469e-03; -7.009314135716166e-02   +1.140605078142181e-02   -5.123808788352973e-02   +9.966836159712156e-03   +7.811274313013541e-02   -7.809373493181522e-02   +4.260281625808455e-02   +3.864877719010578e-02   +3.272902015325719e-03];
L3_L1_iGABA_netcon = [-5.384951619856077e-02   -4.701793606568543e-02   -1.721495798590110e-02   -1.197255107424778e-01   -5.289627289545348e-02   +5.889990614936601e-02; -1.576834915248120e-02   -1.235563230876412e-01   -4.078037568292361e-02   -1.250828493413614e-02   +4.122800020864505e-02   +6.578941358885709e-02; -4.991714898006822e-02   +1.223485752200978e-02   +1.277597433896501e-02   -1.231976477206800e-01   +1.775237530708253e-02   +9.910067387271479e-02; +8.889530345961524e-02   -2.257072334406868e-02   -4.956165459496870e-02   +4.754092846896042e-03   +4.910738237051995e-02   -4.804329445293892e-03; +2.486623832254138e-02   +6.120971393834339e-02   +4.406142217974746e-02   -1.262679979414019e-02   +8.646523803088474e-02   +1.405134180010353e-03; -2.772820392871687e-03   -5.553123133481180e-02   +4.637559192372720e-02   +7.393274341864141e-02   +1.816032991617018e-02   -2.569348192601298e-02; +3.288174996619549e-02   +1.433778274796017e-01   +6.749694931368404e-02   -3.364629661897760e-02   -3.186557297809289e-02   +3.865149965234421e-02; -1.042911810028058e-02   +1.893542875357846e-02   +6.300756343155760e-02   -1.345052247233162e-02   +1.858206102023130e-02   +5.823043015058618e-02; +8.927267528751326e-02   +2.343386636998143e-02   +8.879976150917318e-02   -8.182818270025771e-02   -1.327513705228339e-01   +6.152900196863015e-02];
L5_Input1_iAMPA_netcon = [-1.017538950802837e-01   -1.019208385102988e-02   -1.418463491145315e-01   +4.750239847494290e-02   +1.963958700783143e-03   -5.196137459686852e-02];
L6_Input2_iAMPA_netcon = [-2.278043313492653e-02   +2.136827422154507e-02   -9.433376085244621e-03   -5.081125800409363e-02   +4.054315217797057e-02   -1.222056482864263e-03];
L5_L6_iAMPA_netcon = [+5.873943868090018e-02   -6.115288991123890e-02   -5.003991673309294e-02   +6.523308808249420e-02   -1.148807919693718e-01   -1.177427418925840e-01; +2.881610613041830e-02   +7.075917021599738e-02   +1.450745189360143e-02   +5.355030751016959e-02   +9.514180604053242e-03   -3.029260698657583e-02; -4.804147729624353e-02   +5.194894247596513e-02   +3.989337536543863e-02   +5.628891462233801e-02   +4.375367074990454e-03   -5.669099918325853e-02; -2.664103635171448e-02   -9.618719495219125e-02   -1.729323738283853e-02   -1.732109438167071e-01   -6.840483422913390e-02   +3.580985473297103e-03; -6.603401564084701e-04   -3.570796669783787e-02   +1.036431481033553e-01   +1.254742426384840e-03   -4.818574734481756e-02   +1.136573626899429e-01; -1.187135767274008e-02   -5.278102048022770e-02   -1.143068074980859e-02   -4.643787671994583e-02   +5.149773366016365e-02   +2.626188235491962e-02];
L4_L5_iGABA_netcon = [-1.041705276704812e-01   +1.830775566142814e-01   +7.144839229956373e-02   +1.617925412268653e-01   -2.481738740048099e-02   -7.726929080258335e-02   +3.150763356125674e-02   +6.953281967986794e-02   -5.720134796075430e-02   +5.377064717024962e-02   +2.035371577380111e-02   -9.184931494868953e-02; -8.980038415919772e-02   +1.550877792954923e-02   +1.852261090300394e-01   +7.802231243948526e-02   +6.226860272270642e-02   -4.289686068439941e-03   +9.979782870004064e-02   -2.827314759953238e-02   -8.630810995032157e-02   -3.660666809596405e-02   +8.259466356604665e-02   +9.389133766151950e-02; -3.754945724207211e-02   -2.024631245738690e-02   +6.289551790903854e-02   -1.141456713114152e-02   +2.083550891111028e-02   -6.194242651675926e-02   -6.230690005090928e-02   -2.738531186466546e-02   -7.179170805264602e-02   +7.316879624631520e-02   -7.217495509498578e-02   +4.329312658884600e-02; +1.017511925580840e-01   +3.315737937594603e-02   -9.651917017280079e-02   +4.242339973495163e-02   +5.158952073197016e-02   -2.419265417643563e-02   +1.297145702733995e-01   +7.353435329148091e-02   -1.118486858978537e-01   +2.241078814097898e-02   +8.203721918449974e-02   +1.805825330385678e-01; +4.886245448197717e-02   +1.175726658184829e-01   -4.864309498932820e-02   +4.346060747642443e-02   -3.057580419278516e-02   +9.378097273523971e-03   +2.884549922885956e-02   -8.669067362066976e-02   +1.681080342173716e-01   -1.078795802457914e-01   +1.709272307353331e-01   -7.678555986338492e-02; -1.080116727496055e-02   +1.604229896666597e-02   -1.107444599855118e-01   +1.539203167924997e-02   +4.909027960325642e-02   +3.457573642958912e-02   -1.817545487790482e-02   +5.091174169769389e-02   +6.965398602253704e-02   +1.185807328122721e-02   +1.907651894592215e-03   +3.678626936483759e-02];
L6_L4_iAMPA_netcon = [-5.390345700748650e-02   -1.684560039751618e-01   -6.189122359012857e-02   -1.159185864496691e-01   +1.830648265869859e-01   -2.469079420556288e-02; -2.146993909856297e-02   -1.210635990523125e-01   +4.804402209026316e-02   +7.726342947341529e-03   -4.703723984269034e-02   -1.190229897670959e-02; -1.405370317679025e-01   -9.067138389158563e-02   +3.360326243984607e-02   +2.142119182802463e-02   +4.505678172117293e-02   +9.570667010054636e-02; -4.488182658773970e-03   -1.338959338884222e-01   -5.416865076228750e-02   +1.734974873721515e-02   +9.734576273468784e-03   +8.396952561300144e-02; -4.477392323917400e-03   +3.888439366593031e-02   +1.154213948098516e-01   -5.139131103517843e-02   +1.034399328682536e-01   -4.967042655314469e-02; +1.049323997503839e-02   +8.781779379086625e-02   +5.055004038938176e-02   -9.462067000424353e-03   +5.519815438265854e-02   -5.980913051558969e-02; +2.941932981903843e-02   +3.236917960940629e-02   -1.197128020882490e-01   +2.566784463404426e-02   -8.471529910435636e-02   +9.407639068121754e-02; +2.648824464780385e-02   +3.974299025933832e-04   +1.877689645403605e-01   +6.052263565262456e-02   -5.870580329773346e-02   -5.132722953402589e-02; -1.032937328180011e-01   -1.340447340298599e-01   +3.790112328126351e-02   +2.102865254847932e-02   -2.195215600103752e-02   -2.305442808384187e-02; +6.487068823464739e-02   +2.343790504912308e-03   -2.864651021787845e-02   -7.584450459562524e-02   +1.691113942664395e-01   -3.221526529271196e-02; -2.509748601790359e-02   -5.446974798322243e-02   +8.387281624453688e-03   +2.441759123174207e-02   +4.094247105622742e-03   -4.830828637369509e-02; +1.885204977466246e-02   -1.166428732743520e-02   +8.833908071467149e-02   +7.468298932523123e-03   +1.207760070733727e-01   -8.255790242079135e-03];
L5_L4_iAMPA_netcon = [-9.415012819431288e-02   -1.953434119123080e-01   +8.898852096563406e-02   -2.049089411321966e-02   +7.027396667902933e-02   +2.838554614425073e-02; -5.639008200632015e-02   -2.819392711127710e-02   +6.473004758563264e-02   -1.715897772426225e-02   +5.408577723615411e-02   +3.091947413790291e-03; +3.783801918497880e-02   +1.340354363343740e-01   -2.442955450845417e-02   +8.638665651543607e-03   -2.987434027649382e-02   +7.311073556447757e-02; -1.807306671449813e-02   +2.956364378811898e-02   +1.054843772653917e-02   +8.564246941528478e-03   -9.136676316550138e-02   -3.604342305961051e-02; -2.543804005213669e-02   +1.065987321607759e-01   -7.521571378651070e-03   -5.817902493914656e-02   +1.605305580729290e-02   -8.788242065898680e-02; -3.764951407104042e-02   +7.166455543800354e-02   -4.907943676971016e-02   +1.571200614197411e-02   +6.888921546523290e-02   -3.565624081304958e-02; +1.162106655251421e-02   -1.158119871813346e-01   -5.859945156250811e-02   -8.357390450667285e-02   +6.061286135839221e-02   +5.391095965712291e-02; +1.364799908325404e-02   +1.159578234910921e-01   -1.349251433917649e-01   +7.003357801777645e-02   -2.810282121914947e-02   +1.488436301168216e-01; -2.634493922151182e-02   +1.884515049866860e-02   +4.390869493838934e-02   -8.846525829236054e-03   -1.355027774800288e-02   -2.471102029211034e-02; +7.591544272397568e-02   +2.292944972638873e-02   -5.263758023287226e-02   +3.014319761361797e-02   -8.627102869686687e-02   -5.237311296290784e-02; -7.371178744514013e-02   -7.865190484990697e-02   +5.762039647843011e-02   -9.655482428281143e-03   +3.464957960301240e-02   -5.057090916396915e-02; +4.580986124502484e-02   -1.082291916045201e-01   -1.391045081694535e-01   +8.266524579263212e-02   -5.424823385779672e-02   +5.264386008703058e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
