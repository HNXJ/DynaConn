function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.471770943442786e-01   +3.191784619551140e-01   -7.440150476625966e-02   +1.957649633249250e-01   +4.531713251076820e-01   +7.290510364021593e-02   +6.870731929087329e-02   -1.468658351262803e-01   -1.502450736645019e-01; +1.003620961475912e-01   +1.699171629562013e-01   -2.143313480465605e-01   +1.198291515726919e-01   +9.925386809049300e-02   +2.428342820655711e-01   +1.283493205732340e-01   +5.595494460706965e-01   +3.964257628795598e-01; -5.337999068980009e-02   +7.193939520484113e-02   +3.058731638908002e-01   +4.488803396181429e-02   +4.326195123184716e-02   -1.454576852825413e-01   +1.217394090358628e-01   +4.056008134541170e-02   +2.803562239439839e-03; +1.961203847736091e-01   -1.397025914556642e-01   +2.366210305848417e-01   -1.175972017060682e-01   +4.806181019694380e-02   -1.590349171933939e-01   -4.478881194775466e-02   +2.802722451171813e-01   -1.522239046974097e-01; -3.459568217505619e-02   -9.356879569655488e-02   +3.071834002127898e-01   +2.287831689831980e-02   +1.404579868108385e-01   -1.626598184190624e-01   +1.730855471481580e-01   +3.567145520245502e-01   +1.468372970955084e-02; +1.594301028465710e-01   -9.333394476942880e-02   +5.066515489590150e-01   +1.254129760604945e-01   -1.339356546766167e-01   +3.578009013673078e-02   +2.982277867838233e-02   +2.185389169907368e-01   +3.063954155416600e-01; +3.262197859953644e-01   +4.891513196158655e-01   +8.207643240625861e-02   +3.898740302860794e-01   -1.140306854067190e-01   +3.075657634935960e-01   +1.759729441009941e-02   +3.382963107010781e-01   +1.078212110994011e-01; +3.720939079338108e-01   +7.099014314269059e-02   +1.596282295987826e-01   +2.997479932624043e-01   +1.581859596075030e-02   +3.977119677326367e-01   +2.198740617816723e-01   +3.135238467374204e-02   -2.338688767036489e-01; +6.048870479840035e-01   +2.155781873418677e-01   +3.690787049011240e-01   -3.589043034276343e-01   -3.965074791196995e-02   +1.152947910947289e-01   +3.588639251218665e-01   +2.132514465053628e-02   +2.920217924643360e-01];
L1_L2_iAMPA_netcon = [+4.435239449824873e-01   +3.364062717424168e-01   +3.504289089955098e-01   +2.946068299433313e-02   +3.275627917974006e-01   +3.164146641395440e-01   +5.209216142791095e-02   +1.232807278791151e-01   -5.560593723178753e-02; -7.149392318839710e-02   -1.585280511499536e-01   -1.509082803934320e-01   +1.773346070245429e-01   +3.697672006513756e-01   -8.418278434064033e-02   +2.100681407380969e-03   +4.804675285106781e-01   -3.957335935460703e-02; -4.898185494754206e-02   +2.279673785717211e-02   +2.647163853578625e-01   -1.632318449124318e-01   +3.643212262858006e-01   -6.148557125054326e-02   +3.048351462775946e-01   +1.427481628598244e-01   -4.678742928514076e-02; +1.255658473678091e-01   +3.199064725575563e-01   -9.982634256274275e-02   +3.152602484115095e-01   +3.834090267259025e-01   -1.333139195022106e-02   -3.641583438852130e-01   +3.621594924100732e-02   -1.436126350637532e-01; -1.673986229621776e-01   -2.394112111995512e-01   +9.980636634105816e-02   +3.058229498826696e-01   +3.077925631305158e-01   +3.228661433330300e-01   +5.488807379410370e-01   +9.637539029489101e-02   +4.532313418160634e-01; +3.180985525015427e-01   -2.495521198157799e-02   +2.688489947615566e-01   +3.477137090084276e-01   +2.416350889248108e-02   +1.602180134018985e-02   +1.951691025180310e-01   +4.134308821742484e-01   +1.043110112492912e-01; +1.471284432051275e-01   +2.437232958485858e-01   +5.226737879510652e-01   -1.618394274319007e-01   +1.732771344447411e-01   +2.821492035237653e-01   +2.241544302017698e-02   +8.040006694385111e-03   +9.295866542126030e-02; +1.545521752259608e-01   +9.521318664206639e-02   +3.777985188667451e-02   +3.382745903142352e-01   +1.631884488523835e-01   +9.463213272366088e-02   +8.375509895936437e-02   +4.951440902131550e-01   -2.574614885891681e-01; +1.368592540010552e-03   +1.874502708945013e-01   -2.197490492188101e-02   +3.640001657195432e-01   +4.535657620226128e-01   +1.404958223021351e-01   +3.757074271805405e-01   +1.792653844153446e-01   +2.970615483246032e-01];
L2_L5_iAMPA_netcon = [-9.169235200601954e-02   -1.848821043356630e-02   +1.662983596918099e-01   +1.391292395176301e-02   +1.065889712473734e-01   +1.111087131719264e-01   +1.285621200154728e-01   -1.436145862770942e-02   +9.278051359356573e-02; +4.082418435594405e-01   +2.724065598105438e-01   +4.580052585233476e-01   -1.456640547742351e-01   +1.732081067360449e-01   +5.586206143347531e-01   +2.719850406465382e-01   +1.053305718095336e-01   +2.745714184234486e-01; +1.525062499801668e-01   +3.774916446008674e-01   -5.938443495613770e-02   +2.251194265297403e-01   +3.594507724209112e-01   +1.866447174781163e-01   +2.112567885668079e-01   +2.602658593701402e-01   -1.232929158520315e-01; -4.285577181160184e-02   +3.870791086919761e-01   -1.294606396462637e-01   +2.144947602070475e-01   -7.968567275630842e-02   +1.983765680549245e-01   -1.064496577841952e-01   +1.268405231469437e-01   +2.270229630999750e-01; +2.097792399994439e-01   -1.932201965166859e-01   +3.831541054098673e-01   +1.569380956060545e-01   +2.604836940060227e-01   +1.173533706978200e-01   +3.076500522712881e-01   -8.731229751332026e-02   +1.750174594875487e-01; +1.267199934969457e-01   -2.936374401664716e-01   -7.427006650454970e-02   -7.120937968737159e-04   +3.591044781242603e-02   +1.817489494249461e-01   +8.840277591949559e-02   +6.165278148135782e-02   +2.915016091513665e-01];
L5_L2_iGABA_netcon = [-5.291372704652633e-02   +2.848064323608384e-02   +2.677832418108205e-01   +2.816120671257748e-01   +3.709785522453152e-01   +3.773146787277946e-01; +8.164821568388669e-02   +4.611303748494978e-01   +1.620867465246680e-01   +2.806578643372445e-02   +3.344211464952589e-01   +1.862869649004635e-01; +3.243361907731697e-01   +3.573385205518507e-01   +6.374070704930070e-01   +1.290546537909640e-01   -5.471356528402864e-02   +7.062641400976966e-02; +1.848783360007941e-01   -2.768860779855233e-01   -2.240627048838986e-02   +4.859710620392616e-02   +1.716442321529831e-01   -3.001347475787289e-01; +1.834635288355143e-01   +5.340405106563137e-02   +3.566340787375957e-01   +1.920313866875326e-01   +3.716724813219410e-02   +3.239938229781034e-01; -2.006356543159994e-01   +3.545546443531900e-01   +4.689589179882447e-02   +1.940800036312850e-01   +2.678661299916247e-01   -4.738180705447075e-03; -1.315545623840594e-01   -8.643715835572241e-02   +2.864644902135150e-01   +1.801064892010886e-01   +2.252729683810722e-01   +2.150348369583686e-01; +2.787590967186310e-01   +1.137902751715022e-01   +3.130768790832706e-01   -1.197962760986904e-01   +5.811959081606335e-02   +4.734592841491206e-01; +3.494394238908740e-01   +2.022858773267995e-01   +1.856419816833952e-01   -6.717655743559275e-02   +2.299141954391344e-01   +2.015358740451506e-02];
L3_L2_iAMPA_netcon = [+1.032908659086210e-01   -1.287958398842171e-01   +3.774937980452656e-01   +4.747664241776027e-02   +2.780359428758057e-01   +4.263577600031936e-01; +1.219332368382607e-01   +2.230847924554056e-01   +1.784901597950859e-01   +7.034562013379320e-02   +1.495244359655341e-01   +2.212515184553049e-01; +7.846199947188984e-02   +6.202160289949257e-02   +2.044932164536844e-01   +2.369088817367339e-01   +1.593836188606018e-01   +2.949990227392559e-01; +1.839445339262178e-01   -1.796683711261396e-01   +2.043050084075494e-01   +1.524338578739018e-01   +2.635040625280085e-01   +7.647562792427232e-02; +4.694672736365931e-01   +3.644273658863936e-02   +2.486584836602875e-01   +3.260530984581066e-01   +2.953938242823680e-01   +3.430978411628282e-01; +4.054419887099008e-01   -1.944308800829322e-01   +1.034465098161280e-01   +3.251991081099168e-01   +1.499482970067942e-01   +4.945635688581348e-02; +4.300687349485512e-01   +1.246690995146942e-01   -1.007407921141718e-01   +3.020539139366006e-01   -2.280586247525850e-02   +3.694925415134283e-01; +1.058784594314419e-01   +3.774278752653077e-01   +1.735723672143714e-01   +3.576089661961711e-01   -2.130750185912584e-01   -3.607545728355335e-02; +6.057211707460284e-01   +2.712479507223202e-01   -1.539250319555799e-01   -4.528032228045394e-02   +4.321076735372919e-01   +2.547772250106592e-01];
L2_L3_iGABA_netcon = [-2.688473914265351e-01   +3.298695742145270e-01   +3.212501856932781e-01   -7.542303775539866e-02   +1.547095353790697e-01   +3.543928827405495e-01   +1.092791054695474e-01   +2.288738118234319e-02   +1.594135806735794e-01; +3.327454658027432e-01   -8.346311887426719e-02   +1.950536872954225e-01   -1.437750177587553e-01   +1.658681207973470e-01   +5.759137917887610e-01   +4.668888835902107e-02   +1.165511363452883e-01   -3.350646566432784e-01; +2.282939112922390e-01   +2.038589430731041e-01   +3.622649390226395e-01   +2.425545775001927e-01   +4.182174978586850e-01   +1.031974341914683e-01   +2.085618512972675e-01   -5.010509560975400e-02   +3.693820448899532e-01; +2.949977770548032e-01   -1.467025781160945e-01   -3.015905455144127e-02   +3.940860465721119e-01   +2.687202280577586e-01   -6.431969317500091e-03   +2.956423366583414e-01   +3.779241251956003e-01   +4.620368786006908e-02; +1.287345705294753e-01   -1.282296953420488e-02   -3.828375787002714e-02   +3.124850205089394e-01   +3.276383505251277e-01   -5.983137473424698e-02   +2.792271853151028e-01   -4.948858305079409e-02   +3.694332008809494e-01; +2.138191733699170e-01   -2.718478072705456e-01   +1.663662245134821e-01   +2.959308801556840e-01   +4.695497987800861e-01   +5.113577577110306e-01   +1.284419404091949e-01   -4.377453548113983e-02   -1.301165506531490e-01];
L1_L4_iGABA_netcon = [+1.941468496667635e-01   +2.652502898714862e-01   +2.149345701852184e-02   +2.006927659448363e-01   +1.517638438542858e-01   +2.392003581525577e-01   +5.337398061204743e-03   +1.522586100820214e-01   -1.379269582451252e-01; +4.001746766699038e-03   +3.332057192110802e-01   +2.778483377285886e-01   +2.043502169238136e-01   +4.359291859343182e-01   +1.061056955566581e-02   +1.573211388239726e-01   +5.558145914311484e-02   +2.455174393861717e-01; +3.518624170291129e-01   +4.009239781363719e-01   +1.777139868224679e-01   +3.040634134469906e-02   +2.981891763276043e-01   -1.951636056653619e-02   -1.590735663775496e-03   -2.453295340352599e-02   +2.803791465630650e-01; -7.197587341946324e-02   -4.962181565901526e-02   +1.936797358183048e-01   +1.184619536315934e-01   +2.017918844259577e-01   +3.159408641594817e-01   +1.679842894997254e-01   +1.636353008988723e-01   +2.863225506592310e-01; -2.896961332253423e-02   +2.814383479996634e-01   -2.777683419636665e-02   -3.080807061112913e-01   +3.123261333213300e-01   -1.258946446283115e-02   +6.280120195659415e-02   +3.294991424290579e-01   +2.260941194295967e-01; +6.295184079259103e-02   -1.392048111078453e-02   +2.746162839234951e-01   +2.027987794901754e-01   +2.528968820150489e-01   +1.606400557347888e-01   +1.293169933223554e-01   +4.491130699016218e-02   +2.448979809421005e-01; +3.328160304050473e-01   +2.177587971319897e-01   +3.705345961421535e-01   +1.772635222078043e-01   +2.546915509913588e-01   +3.838060056397273e-02   +4.282047774803999e-01   +2.780115650275009e-01   +1.624716790932766e-01; +3.364605552288188e-01   +3.266940615544951e-01   +3.782725580210333e-02   -1.586543011058398e-01   -6.878068601701877e-02   +1.974566053256468e-01   +1.874727117849231e-01   +2.973869033121525e-01   +2.889684790255437e-01; +1.845473510443542e-01   -8.128019913823663e-03   +8.978540081635519e-02   -6.249148538107196e-02   +3.965167771277494e-01   +1.853862035984324e-01   +2.744390246241402e-01   +5.270315579865505e-01   -3.015640273935929e-01; +6.757686581830153e-01   +2.193453445929702e-01   +3.977162226552977e-03   +1.250946791296193e-01   +3.477258696347901e-01   +1.724551122170825e-01   +2.872793908554938e-01   +8.051875368700734e-02   +6.282867172547922e-01; +7.593708453618286e-03   +7.754903527551094e-02   +4.217446357150500e-01   +2.407610195185041e-01   -1.130674789446247e-01   -6.517155111604896e-02   +9.961406396634759e-03   +3.866079035401063e-01   +1.098643925971229e-01; +5.415144893506861e-01   -1.847508186909526e-02   +1.301758315754866e-01   +5.150118420567517e-01   +1.946283700393531e-01   +1.215853975727964e-01   +2.648618532249677e-01   +3.413495797449565e-01   +3.872526743835895e-01];
L4_L1_iGABA_netcon = [+2.369559309438256e-01   -1.395476890835991e-01   -1.691536965646978e-01   -6.988538859389695e-02   +1.555028909470022e-01   +3.353968826751064e-01   +2.445424474809174e-01   +1.345739177463690e-02   +3.328849579529646e-01   +2.854304839332358e-01   +2.950945197160553e-01   +5.189830611236358e-01; +1.267687567470374e-01   +1.966075434795235e-01   -2.013664181779626e-02   +3.505608518725576e-01   -1.430368451384737e-01   +4.097336681542227e-02   +3.534997728644165e-01   +2.905513798092352e-02   +1.483936209577760e-02   -5.275755999079169e-02   +1.142171613789959e-01   +1.723618676964685e-01; +1.943364160545261e-01   +4.216421238420828e-02   +9.005443019351858e-02   +4.453568238968342e-02   +3.952406236050303e-01   +1.711596291305525e-01   +2.057304975083566e-01   +2.656722373427370e-01   +6.352890553622807e-02   +7.628658008057797e-02   -1.237004646777767e-01   +5.044516303291839e-01; -4.968528152873852e-02   +1.339551435146784e-01   +3.240688692771626e-01   +1.780180822887692e-01   +5.091308250277378e-01   +2.947422455805383e-02   +3.587099432537734e-01   +2.108238092608314e-01   +2.188938692179102e-01   +5.105280839657935e-01   +3.344700926083788e-01   +1.903327983490452e-01; +3.288138578098613e-01   +2.615625829458150e-01   +3.195784770664375e-01   +5.811354484970827e-02   +3.678820373765618e-01   +1.307173954516690e-01   -1.487711622383585e-01   +8.459804954252752e-02   -1.962186889665008e-01   +3.853042101558644e-01   +6.001010992959659e-02   +1.995926286779678e-01; +2.926851798294607e-01   +5.134313668106318e-02   -1.076818660220011e-01   +2.345335695564845e-01   -1.618206568273325e-01   +3.310981469747572e-01   +2.784059011275181e-02   +1.185093457055764e-01   +2.192138657943535e-01   +1.712801526365564e-01   +1.131666164038121e-01   -2.777178240305166e-01; -1.614874838684532e-02   +4.217460817595643e-02   +3.159608354557220e-01   +1.235302173988780e-01   -3.668139063623128e-02   +3.357359314020758e-01   -1.616658250464022e-02   +2.679413280384367e-02   -1.795983871769520e-02   +2.340211352901529e-01   -5.510913982045342e-02   +2.023825566164512e-01; +2.320366735043826e-01   -3.045083990284914e-02   +4.287291273988167e-01   +1.867779861802341e-01   -1.748690245747636e-02   +2.486070740490487e-01   +4.355094411014270e-01   +5.416222969660411e-01   +2.217324304261751e-01   +1.015260852109411e-01   +4.607965458394168e-02   +2.428579209019659e-02; +4.801852914099549e-01   +2.928888895506209e-01   +3.962974941586591e-01   +1.091425752575875e-01   +5.373158411121423e-01   -1.453924810161543e-01   +1.088620320150970e-01   +4.911210254007702e-02   +4.204268924513562e-01   -1.272781369637684e-01   +8.640862310370656e-02   +3.095591977021452e-03];
L1_L3_iAMPA_netcon = [-1.139964933713447e-03   +2.305756178144028e-01   +2.407400712494317e-01   +4.874594654998620e-01   +7.114507237015899e-02   +3.398659946771324e-01   +4.091409899345458e-01   +2.226562546991147e-01   +3.739735658080752e-01; +5.550006056095789e-01   +4.080782131551106e-01   +2.419883286905615e-01   +4.409258255597632e-01   +1.086130572622088e-01   +2.239453749586231e-01   +3.245090038737939e-01   +8.388104251567237e-02   +4.602786875307803e-01; +3.311936168576202e-01   +2.365682923983276e-01   +1.266486379628452e-01   +1.049050976248676e-01   +3.018326251179327e-02   +2.575553794574144e-01   +4.536916802105360e-01   +2.172773785766982e-01   +2.367390155923050e-01; +5.040059557422745e-01   -3.061534457977870e-01   +8.110051165320564e-02   -1.038272386215569e-01   -9.633612784843019e-02   +3.073503986767622e-01   -9.725186450498216e-02   +2.607837618805979e-01   +1.425620784290228e-01; +1.596622770852801e-01   +2.547984949767031e-01   +1.527574072077426e-01   -2.499085402155644e-01   -1.734382878223261e-01   +4.396443145232173e-03   +2.481574326017742e-01   +9.903327594228434e-02   +7.664488043366940e-02; +2.705040652474577e-01   +3.855846017105755e-01   +1.982734140806747e-01   +1.278979283555144e-01   +1.658340048228906e-02   +2.238725213765538e-02   +9.519805062994208e-03   -1.554785426593374e-01   +4.315349677850888e-01];
L3_L1_iGABA_netcon = [+3.015634738494083e-01   +3.584744936825385e-02   +1.197690102929573e-01   +6.620207052499033e-02   +1.827991018607808e-01   -1.564374280345298e-01; +2.886172243387343e-01   +3.505030344723870e-01   +2.796347447186006e-01   +4.068528892077931e-01   -8.680446301731462e-02   +1.236504776327915e-01; +3.645233779806076e-01   +2.614754537078323e-01   -1.471873053990720e-01   +1.827180177697627e-01   +2.290661980393895e-01   +6.752186085476891e-02; +1.207923713337432e-01   +4.509487425893724e-02   +2.742645410121514e-02   +2.524225887579900e-01   +2.780872925041622e-01   +3.262143037820899e-01; +8.104451217423714e-02   +4.416329548062231e-02   +4.171121849110132e-01   +2.681794385140830e-01   +1.980102558553226e-01   +1.633131766829551e-01; -2.940647421782476e-02   +3.427755024386245e-01   +6.257467318604716e-02   +6.516864495062501e-02   +1.634765195544682e-02   +3.528779325368014e-01; +4.967963529567228e-02   +9.419890292536827e-02   +1.667644835106402e-01   -3.198017164450909e-03   +1.766775763177565e-01   +2.747291678297750e-01; +1.010438241280774e-01   +3.510940778816805e-01   +2.007309986377144e-01   +2.974261406402846e-01   +1.244871187361105e-01   +1.918826253133658e-01; +1.332922933140810e-01   +1.134714237593249e-03   +6.406758172948390e-03   +8.732695119367875e-02   +1.247751019218081e-02   -1.613031513360346e-01];
L5_Input1_iAMPA_netcon = [+1.662646728425679e-01   -1.150590608383479e-01   -9.212419801175188e-02   -1.080440772288592e-01   +1.395334757898609e-01   +1.390914316949602e-01];
L6_Input2_iAMPA_netcon = [-2.241720913618564e-02   +1.370429469241407e-03   +1.136510560646222e-01   +9.856284817887848e-04   +1.917876235513823e-01   -1.516381923855167e-01];
L5_L6_iAMPA_netcon = [+1.621627036371663e-01   +1.983989687316370e-01   +1.014107128110534e-01   +1.377879460491480e-01   +2.299311319708474e-01   +2.644037570889691e-01; +3.145591197537451e-01   +3.879642836134454e-01   -1.059041499986425e-01   -3.146822397373052e-02   +2.759876373080870e-01   +1.503956581422409e-01; +5.686171001811023e-02   +1.054419968088300e-01   -1.758891958257500e-01   +5.899248858774964e-01   +2.833895530655141e-01   +4.037628303307693e-01; +2.796298840284572e-01   +4.183926632136191e-01   +3.106032623532758e-01   +4.682439484253412e-01   +1.328347857372210e-01   +7.711578118558292e-02; +8.544652069407616e-02   +3.014779017988847e-02   +2.304954640547912e-01   -2.215020728183395e-02   -1.988915637706374e-02   +2.574555203494893e-01; +4.091267423496523e-01   -6.319600940276621e-02   +1.289865483818631e-01   +1.431174374269219e-01   +2.446516543689857e-01   +1.373599423559039e-01];
L4_L5_iAMPA_netcon = [+2.971295765292481e-01   +2.013529684343710e-01   +3.214471063374092e-01   +4.110177493140011e-01   +3.272819736627816e-01   +5.063644050901644e-02   +3.666118334638221e-01   +5.365825348546032e-01   -5.689507029806876e-03   +2.875657852721832e-01   -1.839818511058403e-01   +1.379593644756039e-01; +4.406567869021133e-01   +4.199942835164904e-01   +2.482045533522284e-01   +1.113844363241456e-02   +4.090568797073257e-01   +2.252709054099898e-01   +3.814019987815359e-01   +2.887030444545948e-01   +2.037947090188319e-01   +3.914305055176964e-01   +3.985527859929412e-02   +2.584366154070411e-01; +2.201732977531281e-01   -2.522680581408873e-01   +3.241442390004544e-01   +3.432015148133502e-01   -1.009328878581538e-02   +2.300313515232662e-01   +2.035602856193802e-02   +8.354289793324013e-02   +1.218273796293283e-01   +2.431907494498331e-02   +3.392626618131682e-01   +2.771612636233028e-01; +1.267960123428967e-01   -1.962258380885818e-01   +2.886262356615720e-01   -5.386276988049778e-02   +1.715263535230412e-01   +1.195830310665983e-01   +1.870675426034807e-01   +3.825115695523832e-01   -6.674081849677341e-02   -5.016434601917125e-02   +1.489903545231250e-02   +2.132397467059201e-01; -3.921436697123139e-02   +4.447254982706798e-01   +2.722044335325959e-01   -2.681503571324141e-01   +3.645266455534630e-01   +3.401499583274519e-01   +1.793511660549742e-02   +1.973554171482637e-01   +8.351462548869544e-03   +3.787762999852241e-01   -8.294172968133176e-02   +6.401906233886909e-01; -1.070078765703587e-01   +6.788825373772162e-02   +1.347868404404996e-01   +1.200654836790480e-01   +1.251641141651307e-01   +3.058346470895306e-01   +7.639060632464573e-03   -2.042862169357590e-03   -5.535237473879081e-02   +3.277512161105988e-01   +3.723166383188490e-01   +7.741430558861347e-02];
L6_L4_iAMPA_netcon = [+1.679963900995418e-01   +1.121111234564387e-01   -1.991203545655988e-01   +3.668845978068443e-01   +3.828795803753461e-01   +1.073548355039335e-01; +1.204289354635858e-01   +5.225413107554994e-02   -1.125502189282326e-01   +2.762706173585193e-01   +2.590687796851840e-01   +2.754500031137266e-01; +1.532231371089171e-01   +4.564834540668974e-02   +2.849768158440726e-01   +1.815280261786699e-01   +1.693737841486584e-01   +4.061127754182151e-01; +1.509456005775677e-01   +2.062146791778877e-01   +4.065031025382453e-01   +5.008446355051478e-01   +2.195432387494649e-01   +4.796480763769013e-01; +5.789606973281405e-02   +1.118555129207849e-01   +4.610705551260986e-01   +4.749542164585366e-02   +2.447916171037187e-01   -3.347038768313611e-02; +2.161489793072133e-02   +1.514423939569625e-01   +3.828755903647086e-01   +3.160658059231966e-01   +2.051233866798104e-01   +2.942058733104164e-01; +2.981243257784816e-03   +2.527735893302435e-01   +3.517498561191570e-01   +3.178005839256536e-01   +1.387734011785285e-01   +5.946099937883487e-02; -1.577201789394687e-01   +3.783141364230557e-01   +1.022024060048717e-01   -1.395405556192080e-01   -3.337488291230119e-02   -1.358556618123566e-02; +2.920822742933428e-01   -1.630581658878709e-01   +2.077621448811568e-01   +6.753209955014433e-02   -2.813753531138356e-02   -7.385613971609949e-02; +1.893888535775124e-01   +2.593263916719358e-01   +5.895222179513079e-01   +7.117242338013894e-01   +6.119721489300750e-01   +5.703872281931420e-02; +3.792673804106261e-01   +1.200782328577956e-01   +3.047439688419565e-01   -3.857848854001309e-02   +6.651436737947616e-02   +2.369506587548910e-01; +3.301510491784412e-01   +3.135652731365325e-01   +5.108527546742125e-03   +5.588063124239216e-01   +1.997203950355325e-01   +2.312921828162982e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
