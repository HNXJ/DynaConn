function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.298540183034969e-02   +1.896903763780927e-01   +9.272690243401130e-01   +4.520671460997038e-01   -6.847152506663875e-01   -3.495674818978591e-01   +9.617910649105266e-03   +6.990295427670399e-01   +3.540460926755063e-01; +5.643377219083304e-01   +5.545513137789951e-01   +1.982167057926810e-01   +4.598161747057212e-01   -9.303779496759167e-02   +3.827938984123841e-01   -1.541617093518085e-01   -1.855399653890251e-01   +2.852323139284904e-01; +5.959041158409686e-01   -2.262577512375428e-01   +3.898116774105053e-01   -3.324182805973004e-01   -1.879594679579781e-01   +2.630040190917486e-01   -2.868064601836846e-01   +9.584573678180094e-02   -3.793311408283656e-01; -5.077430860484720e-01   +5.636343978601319e-01   +4.741795137573184e-01   +2.534095521140157e-01   +1.162591759918516e-02   +7.565000156123517e-01   +1.321761893922357e-01   -6.869218959707407e-01   -1.134675689312765e-01; -4.530032010810869e-01   -2.387443595033868e-01   -4.403206073748788e-01   -1.821377322237737e-01   +1.120738342869021e-01   -7.219103533088086e-02   -5.535255521433249e-01   +1.373394526312439e-01   -4.409244308477495e-01; +3.999413784658589e-01   -3.024113409422413e-01   -1.680625225538692e-01   +9.006606619897635e-01   -6.197947006346800e-03   +3.017100425728325e-01   -5.713860660745790e-01   +6.348654277416096e-01   +1.428849322075876e-01; +6.569228455391697e-01   +5.656763948800698e-01   -5.679683447203264e-01   +2.270800623413260e-02   -3.448254425337338e-01   +5.609567507766824e-01   -4.464641619794177e-01   +7.062552775503251e-01   +3.919162740693304e-01; -2.446153861781170e-02   +8.359318900934468e-01   -5.072796118541847e-01   +5.110402262496074e-01   +3.639284043444382e-01   +2.233785798994690e-01   -5.375229476286059e-02   +5.025383048637326e-01   +3.123308181409281e-01; +4.524072530884529e-01   +1.000000000000000e+00   +5.351674280217187e-01   -3.551553135775263e-01   +7.095181511391248e-01   +7.909605595791502e-01   -2.590683805010172e-01   -1.996112741311047e-01   +2.547721144157679e-01];
L1_L2_iAMPA_netcon = [+2.026198963293303e-01   +1.441030081664348e-01   +1.494860701987847e-01   +4.847904489599567e-02   -2.371211052281417e-01   +8.567138192338516e-01   +3.061259242597755e-01   -7.289782810238495e-02   +2.429318678462974e-01; +1.000000000000000e+00   -5.567569819443804e-01   -1.614109958600953e-01   +7.578549631874185e-01   -3.784808874255700e-01   +6.039895890662670e-01   +5.200562759471977e-01   +2.317054340183918e-01   -3.635665638051141e-01; -1.461264076961423e-01   -4.688154094687496e-01   +7.444249381947031e-01   -4.027868331146812e-01   -5.187616773175665e-01   +1.268240721493987e-01   -1.496074544943974e-01   +5.983139917903783e-01   +6.482838946863136e-01; +3.947984168623018e-01   +1.683952338091216e-01   +6.313630977998328e-01   +5.593249326118465e-01   -3.581137894249069e-01   +7.070401566625164e-01   +6.736056043275497e-02   +9.434897971084576e-01   -3.011851571540246e-01; -5.436314720120072e-01   +4.630032361645015e-01   -2.946048544004372e-01   +8.820498826610514e-02   -3.738092003532971e-01   +2.910149598754226e-01   +4.985088193921902e-01   -6.465336890959666e-01   +4.151984952537315e-01; -3.861200836715826e-01   +7.376602699475804e-01   +1.178692453126023e-01   +7.395414250658260e-02   -6.629622607307101e-01   +2.147656984628049e-01   +8.968827259521549e-01   -5.127319712995424e-02   +5.840248958233225e-01; +5.417123967271771e-01   +6.322531528254370e-01   -1.081368191819091e-01   +5.497091616600643e-01   +2.959155913696789e-01   +7.872052638180685e-01   -6.069006856120138e-02   +4.499170714488039e-01   +3.615661437217343e-01; -4.943894013993912e-01   -5.193137174256168e-02   +1.504104742380856e-01   +8.931064485240971e-02   +5.858494114400542e-01   -5.972060665041547e-02   -3.983021051510834e-01   +4.603072990339935e-01   +8.036990457907922e-01; +6.094014985291072e-02   +4.693816978425261e-02   -4.298315585409178e-01   +8.092388267452012e-01   +2.258463009754853e-01   +3.898450656676015e-01   -5.980185058380286e-02   +3.223582922960468e-01   -8.764171923021090e-02];
L2_L5_iAMPA_netcon = [+7.494961559728538e-01   +7.402563717882130e-01   -4.528548950167741e-01   +3.146152146775003e-01   +1.723523985824527e-01   -5.128283301523910e-01   +6.887759866418969e-01   +6.610379201836768e-01   +8.220979229681089e-01; -7.722515569441211e-02   -6.491396874730181e-01   -6.026905729113472e-02   +1.909892590519852e-01   +7.012701594133144e-01   -4.950893261156179e-01   +4.045530397783775e-01   +2.893987116351943e-01   +3.772763481957609e-01; +5.881369412889366e-01   -9.263509191400611e-02   +5.740656814820642e-01   +7.400733585082341e-01   -4.828080676201306e-01   -2.178635655359216e-01   +1.987629251782455e-01   +2.978379429236231e-01   -3.285019355929125e-01; +3.603506240520385e-01   +8.021736262768975e-01   +8.342738679351555e-01   +6.479189011670179e-01   +2.514786775754803e-01   -1.743784522661887e-01   +1.697658706217262e-01   +6.397445304155385e-01   +3.953816474857839e-02; +7.372493189207393e-01   -1.055730683448876e-01   +8.122102855647714e-01   +1.000000000000000e+00   +2.465402565728586e-01   +3.560083848495516e-02   -2.778922988848858e-01   +4.904800392576217e-01   +5.118354070761347e-01; -4.815851721687240e-01   -2.708826423380225e-01   +7.563208915346444e-01   +1.222036150942110e-01   +7.212448743722834e-01   +4.132126663214365e-01   -3.236521277501825e-01   +3.821947315618336e-01   +3.974047789859311e-01];
L5_L2_iGABA_netcon = [-3.884361289636902e-01   -6.790747595872015e-01   -2.717584688006373e-01   +8.009929413045686e-01   -4.886059412932750e-01   -3.365567668229014e-01; +2.118632601712364e-01   -4.805285027880498e-01   +8.078241787056630e-01   +8.530082642589446e-01   +5.188476500249757e-01   -3.898962025983034e-01; -4.929323626579676e-02   -4.929727344183309e-01   -2.860443467400067e-01   -1.924115664747397e-01   -3.372954217765298e-02   +2.748351080786706e-01; +4.860823363447742e-01   -1.822955376207593e-01   -5.764075651822025e-01   -3.928716155931173e-01   -3.582391375537388e-01   -5.470474711041321e-02; +4.939274373062378e-01   -4.537352786046695e-01   +1.816692377384030e-01   +1.559772270658082e-01   +8.339787371646472e-01   +9.334577461232966e-01; -3.224866712833892e-01   +5.883280939569393e-01   +9.086171190637875e-01   +4.008856257718813e-01   +5.038589346121487e-01   +7.967949695633808e-02; +9.112056870134591e-01   -8.117490695293799e-01   -2.014389088132945e-01   -3.752968557101073e-01   -1.326894531132355e-01   -9.960429793107993e-02; -5.513720025393091e-01   -5.240115638495562e-01   -1.343068354218548e-01   +6.296628753824023e-01   +1.000000000000000e+00   -3.374999370798794e-01; +6.736238395113690e-02   -4.487600656006554e-01   +2.626814416582459e-01   +7.784897223480035e-01   +4.718355160193306e-01   -7.246463379040150e-01];
L3_L2_iAMPA_netcon = [-2.443801665111000e-01   +6.813532178339541e-01   -4.719197897404588e-01   +9.283665993692236e-01   +5.610583336686294e-01   -4.052566921839518e-01; +1.371524677415818e-01   -3.592431729162379e-01   +8.360412974301097e-01   +9.587625932178679e-01   +9.142073404146581e-01   -2.279156900218533e-01; -5.232416767650550e-01   +3.619583067795550e-01   +7.063789716265864e-01   -2.335843812866231e-01   +4.427899979392224e-01   -2.135811787833022e-01; +8.218612900679532e-01   +9.836318094336705e-02   +2.519405123429776e-01   +4.020349005121994e-02   -5.297127352146020e-01   -5.028938542927827e-01; +2.604183078483226e-01   -3.634783704020792e-01   +5.874495895489974e-02   -7.320023962483425e-02   -4.957497082099255e-01   +4.314458501275283e-02; -1.083958452390048e-01   +7.238785519392791e-01   -2.114547165264239e-01   -5.666721547272507e-01   -1.747327100597077e-01   -7.341357575487951e-02; -1.099049907810103e-01   +1.000000000000000e+00   +6.300433550306809e-01   -6.918949102758015e-01   +5.126441355204698e-01   -2.978333212082514e-01; -1.694832318647725e-01   +3.794180183494795e-01   -5.070969653606248e-01   +2.621652717174118e-01   -1.762799973301212e-01   -1.500167680902768e-01; +3.762611117739951e-01   +8.353164443335523e-01   +7.567759150419808e-01   -2.220107509059391e-01   +9.282960340059350e-01   -2.477363617621848e-02];
L2_L3_iGABA_netcon = [-3.558226684265379e-01   +6.970824607182593e-01   +3.652011855311942e-01   +2.535508716807550e-01   +1.000000000000000e+00   -3.143541924799638e-02   +9.267821196806239e-01   -2.412897195654408e-01   +7.246331135520296e-01; -3.852692517454949e-01   -2.331508599639916e-01   -2.095318289530394e-01   +1.300852343679640e-01   +6.435642288479728e-01   -2.841086984385707e-01   -4.603446872990848e-02   +7.927481502760605e-01   +8.581021962070023e-01; +9.571190717994322e-01   -2.334351965187391e-01   +9.578365332936918e-02   +2.529613107208007e-01   +7.129544063725964e-01   +3.745446670449247e-01   -1.668780230216071e-01   +8.022845304250996e-02   +3.805251329110496e-01; +2.637400571733505e-01   -4.294825017100886e-01   +2.302164494948924e-01   +3.519307451597817e-01   +7.273128588736727e-01   +7.282653198272734e-01   +6.535302577507917e-01   +3.960696851299437e-01   +5.879181509642224e-01; +5.818380361589853e-01   +6.843352131089930e-03   +1.297770989756530e-01   +4.321910598470247e-01   +1.622085790619075e-02   -4.029181957553539e-01   +5.658660147519979e-01   -3.241218581802273e-01   -1.232758265320735e-01; -4.597226020301168e-01   +8.698071042600016e-01   +4.399462478697971e-01   +5.697714115896105e-02   +8.260023851548532e-01   +3.743493718292733e-01   -2.601738732274403e-01   +8.390272645417853e-01   -2.084142246617960e-02];
L1_L4_iGABA_netcon = [-3.712214831977905e-01   -5.929834986871835e-01   +1.908483074987664e-01   +7.863353220360924e-01   -3.400177125816655e-02   +6.379769332193903e-01   -4.887669316955387e-01   +1.860200573080090e-01   +2.478961623772428e-01; +3.506851410010715e-01   +1.241303319746302e-02   +1.626019234919857e-01   +7.660523551903343e-01   +9.402181333682993e-01   +6.282738954347555e-01   +1.957301963765822e-01   +6.781815476293737e-01   +1.503028442000919e-01; -3.241679413883742e-01   +1.913358497187947e-02   +1.000000000000000e+00   +5.377901394081636e-01   -9.921795524373941e-03   -4.475599991685466e-01   -1.877009887730916e-02   +7.395874217874612e-01   -1.707573147609048e-01; -1.663094168509372e-01   -3.100373090661535e-01   -1.248145878585455e-01   -5.304926313450289e-01   -2.326091559624594e-01   +5.724972170528583e-01   +3.409632991024394e-01   +8.100092161406688e-02   -3.470960068507913e-01; -4.325221175440049e-01   +7.854366873868364e-01   +2.404454578738243e-02   -1.397645116576761e-01   +2.767433066178665e-02   +2.010084007677790e-01   -2.270072857680129e-01   +2.255164164895381e-01   +9.883131655891886e-01; +1.582870519076371e-01   +1.222925275231369e-01   -2.976856565667401e-01   +7.548654080383300e-01   +4.915357696270235e-01   +3.352287308597433e-01   -2.760221706223764e-01   +6.709892816677457e-01   -8.658005041794132e-03; +2.784353512109977e-01   +2.619816260226334e-01   -4.538386421106170e-05   +7.291756297830227e-01   -2.505032493713944e-01   +7.261032541226936e-01   +4.239661370850462e-01   +6.826325664182715e-01   -3.743020148118540e-01; +6.577873113833425e-01   +7.968999887575140e-01   +2.599261762372629e-01   +6.093598869223001e-01   +6.564900135416446e-01   +8.106704151530744e-01   +6.692049794258945e-01   +5.871078077084217e-01   +4.372755619124372e-01; +3.516283332658681e-01   -3.263000009280383e-01   +4.628802622285693e-01   -3.896929090173265e-01   +2.048055710756256e-01   -4.401955620659707e-01   +7.728709305732221e-01   -7.035840025402625e-01   -1.022639592237923e-01; +5.291204122346828e-01   +7.224678263461417e-01   -1.868210414338561e-01   +6.714777164380308e-01   -6.317749275117036e-01   -5.367475647407327e-01   -2.893972784753754e-01   +6.131036045390763e-01   -1.233977631018974e-01; +7.471621996535242e-01   +2.086917507593747e-01   +5.305592936544464e-01   -3.699623266549369e-01   +8.804668560665262e-01   -3.790100667190820e-01   -4.246127356756632e-01   -3.458290636933515e-01   +4.540163338294847e-01; +1.192264923665157e-01   -8.444592826004094e-02   +6.184337513435149e-01   +2.253024456147333e-01   -6.395676956436902e-02   +2.596591684587400e-01   -5.672689934984083e-02   +4.295415111464942e-01   -3.321589235910364e-01];
L4_L1_iGABA_netcon = [+7.551141983500294e-01   -4.816871790411291e-01   -3.480976291295940e-01   +5.286196145351806e-01   -1.122448689052176e-01   -2.273346739364079e-01   -1.067277046005508e-01   +4.948689124757436e-01   +5.982516380760285e-01   +1.527432387514653e-01   -2.494325887778739e-01   +7.576931156769884e-01; +8.557566324716176e-02   +1.284029040497620e-01   -3.782849265585605e-01   +6.267060304643300e-01   -5.346409043451239e-01   +2.029586125471487e-02   -4.586097233302402e-01   +6.419714469320031e-01   +7.289762946792198e-02   -3.278319618921383e-01   +9.765356123467663e-01   +7.268242809811215e-01; +7.691390127494714e-01   +3.108089239175089e-01   +1.813135036395405e-01   -3.637190182233958e-02   +2.458404631454708e-01   -1.095680199940983e-01   +4.779528763997864e-01   -2.138927155740119e-01   +5.858421557984666e-02   +9.261233390424518e-02   +6.569250421856980e-01   -3.851967671672354e-01; +4.584047574542940e-01   +5.204503799987755e-01   +3.015945532869777e-01   -2.893805395485834e-01   +4.157052661900351e-01   +3.756511172686944e-01   +7.578315138327018e-01   +1.226590288995352e-01   +3.330910277796478e-01   +1.835973485139776e-01   -1.147459085239051e-01   +3.891088570093884e-02; +2.177197955304435e-01   -1.365968925580433e-01   +6.196755005456480e-01   +9.634341169393373e-01   -4.558788179283679e-01   -1.949154836593847e-01   +5.217932011398546e-01   +7.320764592354176e-01   +3.384070568747376e-01   +2.196049206681898e-01   -4.670326522517823e-01   +5.039649189342388e-01; +4.820851964277556e-01   +1.000000000000000e+00   +2.218608826398603e-01   +3.148163505139899e-01   +7.654049620944232e-01   +4.594486218530462e-01   +1.145121567278299e-02   +9.711322047396189e-01   +6.479061545943520e-01   +6.721229818211285e-01   +1.661964596201521e-01   +5.807360096097013e-01; +4.932927371662470e-02   +5.008119026972494e-02   +3.536532661420696e-01   -4.538484989660411e-01   +1.014135436461920e-01   +7.741477242001952e-01   +5.804076399124417e-01   +2.872640013747614e-01   +9.588045001735076e-01   -6.908417831142213e-02   +7.034840205032159e-03   +2.716517765605626e-01; +5.000890063196588e-01   -4.973195040001777e-01   -3.299429333676875e-01   +1.078168006419917e-02   -2.929909263866526e-01   -4.775437778152521e-01   +4.707768606520606e-01   +5.151118495483303e-01   -1.328400859832335e-01   +6.892660028352106e-01   +2.020534480251757e-01   -5.004146932144802e-01; +3.384321783590087e-01   +4.404585998015109e-01   +9.412686240616246e-01   -3.758654901432471e-01   +7.228333488853487e-01   +5.303277058152233e-01   +8.055600387040505e-01   +5.640774487470678e-01   +2.312310186022748e-01   -5.882070680169124e-01   -5.705620185102469e-01   -4.784651287661840e-01];
L1_L3_iAMPA_netcon = [+4.145519011531403e-02   +5.712466156057534e-01   +7.736290209844418e-01   +8.914513046117210e-01   -7.026104378030177e-01   +4.324617439467330e-01   +4.528697112398097e-01   +2.343604576274541e-01   -5.460386763128212e-01; +7.298840072769410e-01   +6.456973235746709e-01   -3.354819908645074e-01   +8.684854078579533e-01   +6.246534359596313e-01   +4.081315883501285e-01   +1.478798390286769e-01   +8.780417532100138e-01   +8.845696482719875e-03; +7.306339209109158e-01   -3.148260362076351e-01   -2.361387724228835e-02   +4.259778073271130e-01   +8.075134599690408e-01   -6.483766407068700e-01   +2.961806016528721e-01   +2.752264680154875e-01   -1.104953272666264e-01; -3.147584935050705e-01   -1.947259687723113e-01   +1.000000000000000e+00   -4.255355909853105e-01   +3.283734087567791e-01   +4.677996158058220e-02   +4.848283063109301e-01   +8.085812629658051e-01   -5.690882086718829e-01; -6.439362878166257e-01   +3.038270493311050e-01   +5.643406172851211e-01   +7.143756592197098e-01   -3.699175885677280e-01   +1.132756039871676e-01   +6.675625900926182e-01   +3.026634771014430e-01   +8.127404839736810e-01; +6.351623654356402e-01   -6.938326188922981e-01   +9.087790008538998e-01   +1.038049868602647e-03   +2.047208002429108e-02   +8.707951485248249e-01   -2.738712624236160e-01   +1.087351636681174e-01   +3.495309528187931e-01];
L3_L1_iGABA_netcon = [+1.000000000000000e+00   +7.058943483094303e-01   -1.702174681218383e-01   -5.297974245216096e-01   +3.662662488221348e-01   -2.024194769681423e-02; +4.025693334208567e-01   -5.920512325070709e-01   +2.176983915823444e-01   -4.348240428002556e-01   -5.703747318967917e-03   -5.710189899435320e-02; +4.562304905448569e-01   +3.878488706677718e-01   -3.539789062314419e-01   -1.260093848054496e-01   -5.327078437797557e-01   -1.171391917475776e-01; +5.775478079900291e-01   -1.957077610000231e-01   -1.672561878284527e-01   +3.306209589793541e-01   -6.323783979751537e-01   +7.751104242378865e-01; +5.706808038295604e-01   +1.342170227737648e-01   +8.679048735927516e-01   +5.287126996682329e-01   +7.854104350893665e-01   -2.527261258264510e-01; -7.015493530805415e-02   +3.059163479779416e-01   +7.416805362605132e-01   +7.107068291531884e-01   +6.065765084747308e-01   +8.956798801037085e-01; -3.214097489830114e-01   +2.324182941510277e-01   +8.664956571509761e-01   +4.045491843277408e-01   -3.911843512522142e-01   +4.635999598255631e-01; -1.906348200090185e-01   -3.298346113844014e-01   +2.969540027269590e-01   -6.574383463022387e-01   +2.100249343662196e-01   -1.726441518355907e-01; -6.083140394381444e-01   -1.698750016127734e-01   +2.140314363507344e-01   +5.468310926093907e-01   -2.668279128353480e-01   -2.084429171441284e-01];
L5_Input1_iAMPA_netcon = [-4.623850093823527e-01   +3.694827307679839e-01   +3.880954248499482e-01   -8.500744039113591e-01   +2.661034736181748e-01   +1.000000000000000e+00];
L6_Input2_iAMPA_netcon = [+1.000000000000000e+00   -8.948688299852233e-03   +7.327261623074828e-01   -3.256578163298193e-03   +3.899787777386678e-01   -6.149557541277727e-01];
L5_L6_iAMPA_netcon = [+3.679255187339130e-02   +4.216467970019398e-02   +1.000000000000000e+00   +5.628183808620274e-01   +4.338404341736910e-02   +8.360870517070323e-01; -1.258443201411433e-02   +3.613789724011759e-01   -3.035632214652875e-01   +2.762321221088600e-01   -3.188588206618943e-01   +4.453795945037087e-01; -5.200156072571921e-01   +1.396743227703934e-01   +2.606994619446005e-01   +2.328638751146175e-01   -2.397352478435421e-01   +6.840101772434736e-01; -4.141130646150223e-01   +4.564444150460920e-01   -1.472389652570495e-01   -3.306229728513554e-01   +1.001868429415113e-01   +5.340936806873969e-01; +4.798519666611681e-01   +6.738469585299804e-01   +4.430807898265402e-02   +5.007449413911096e-01   +8.907606379627603e-01   +3.213341629266395e-01; -6.907911766142562e-03   -3.319536170771248e-01   +6.503596383102479e-01   -3.047320531225805e-01   -4.025150784539736e-01   +7.299785106965796e-01];
L4_L5_iAMPA_netcon = [+4.236096633841246e-03   +7.694074224996571e-01   +3.088629511547273e-01   +8.046681469773479e-01   +1.574623137527373e-01   +5.299620637944664e-01   +4.550636547880496e-01   +6.809879508292436e-01   +4.107540076607229e-01   +2.349640494643359e-01   -4.537119837262272e-01   +8.475071246045560e-01; +2.007387092187065e-01   -1.916028388942471e-01   +8.713971932127356e-01   +6.008036970257253e-01   -3.366898331224680e-02   -7.088792533085083e-01   +1.053027507061671e-02   -3.738621305644164e-01   +4.127187257277126e-01   +3.833070875393478e-01   +6.171886175819278e-01   -6.195076618489621e-01; +4.900852337124446e-01   -1.893290237223089e-01   +3.295144258358411e-01   +3.981659977880077e-01   +3.914027719520758e-02   +7.356074310713021e-01   +4.191916961467925e-01   +4.599186410213721e-01   -2.063351116920942e-01   +6.569243585181936e-01   +3.578472291964983e-01   +5.281337904992508e-01; +1.195798125728602e-01   +1.953075753297629e-01   -3.478979816269938e-01   +9.099293984027031e-01   +6.055231846931971e-01   -5.046114684808135e-01   +6.905873282259768e-01   +1.680765100448492e-01   +1.275191901219440e-01   +2.864182508535128e-01   +1.315447223283590e-01   -5.975556726835151e-01; -2.510674674564943e-01   +2.615573227704840e-01   -6.208923019627222e-01   +5.363871767048578e-01   -1.904442415238874e-01   -5.146010537568749e-01   -1.016267848264372e-01   +4.462135278075149e-01   -3.571973653004800e-01   +2.542919140179609e-01   -8.178119371452483e-02   +5.866943551781427e-01; -4.715629079901027e-01   -3.822058406876192e-01   +3.281662309546471e-01   -2.128381044853010e-01   +9.787782636242018e-01   +3.203370100744868e-01   +7.251895560956262e-01   -3.673563071002221e-01   -3.057758614431021e-01   +3.315649221197204e-01   +1.000000000000000e+00   -1.233180043376678e-01];
L6_L4_iAMPA_netcon = [+2.587877160005198e-01   +7.549076372661995e-01   +4.967994098634268e-01   +6.262706140158866e-01   -4.315195243185949e-01   +1.615072195305914e-01; +5.798432016004050e-01   +4.730219274719243e-02   +7.543365035287197e-01   +4.074108979284656e-01   +6.022058477805020e-01   -3.497686341709538e-01; +1.975965904923087e-01   -3.593105659138429e-01   -3.142942724116574e-01   -5.868214435323005e-01   +5.678250562656172e-01   +3.622020038271532e-01; +2.335421270483198e-01   -2.234992313915539e-01   +5.502460982274580e-01   -9.099503032326416e-02   +5.584233818254950e-01   -2.542207494754234e-01; -4.910716484534599e-01   +6.182352700234460e-01   +1.376286909456366e-01   +6.202270798046632e-01   +9.217416294098774e-01   +2.492216808680714e-01; -4.965812057447393e-01   -4.444203899415367e-02   +3.034674153052769e-01   +6.537369754078380e-01   -4.070559293096321e-01   +6.606348411034751e-01; -1.266830639368854e-01   +7.812348270173352e-01   +5.979031421537769e-01   -3.573591941215375e-01   -4.896803331477556e-01   +4.825831634992694e-01; +6.254932658044136e-01   -4.729691084814580e-01   -3.033684840713846e-01   -5.167309926420426e-01   +3.152751216386129e-01   -3.178037292688367e-02; +5.565573084782924e-01   +7.617042439302154e-01   -4.947355945336854e-02   +8.297537001767232e-01   +8.299129680642515e-01   +6.038574486352764e-01; +1.895687297269751e-01   +1.897431080817827e-01   +1.000000000000000e+00   -1.336143954515826e-01   -2.005685205634448e-01   -1.507581234285763e-01; -9.474776057184470e-02   -4.769235356478022e-01   +8.089725041182043e-01   +7.974619382423130e-01   -2.776754671948858e-01   -2.633057376151886e-01; -1.055043011885523e-01   +7.113839534137961e-01   +7.843041559012740e-01   -1.256057480091207e-01   -4.186649039100741e-02   -1.086758666364614e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
