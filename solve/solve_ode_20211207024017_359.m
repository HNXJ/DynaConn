function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.626710461798174e-03   +5.384680415984444e-02   -1.334212175259437e-02   -2.652779584396288e-02   +1.827474254446522e-02   -8.676331098630874e-02   +2.223335385572203e-02   +4.511473655618253e-03   +5.448557775419444e-02; +2.353280382639284e-02   -5.334515224697664e-02   +1.802839494323173e-02   +3.991676608459256e-02   +8.011845937579996e-03   +1.179481930118490e-02   +2.599131771092361e-03   -2.698162135246868e-02   +2.976203795264447e-02; +2.978706123448401e-02   -4.041076837655547e-02   -2.624275586764431e-02   -1.169929464117373e-02   -4.880295869267823e-02   -1.398374252345666e-02   +3.610704095882147e-02   -3.616878002041811e-02   +2.257979925002363e-02; -2.943670001830039e-02   +2.060403822331786e-02   -1.238130140218268e-02   +6.669013436475704e-03   +4.320457701258419e-02   +1.837129870208735e-02   +3.041433551149386e-02   -1.312501591198845e-02   +4.710690138796454e-02; -5.222101737318127e-02   -6.722987766485795e-03   -2.958216426192401e-02   -9.572038741925947e-03   -7.693856424900815e-03   -3.547904409806162e-02   +1.040026338672288e-02   +7.437992412614839e-03   -5.645079468776026e-03; -3.095724224758880e-02   +1.209471109984885e-02   -3.092003326223455e-02   -3.342978426171173e-02   +1.595396069937012e-02   -1.126276442825166e-02   +5.310537589534556e-02   -6.211726167949047e-02   +3.055996102282086e-02; -1.078156490975851e-03   +6.226852089974187e-02   +7.152327260938840e-02   +4.629539319692410e-02   +1.385651855185028e-02   +6.450640831475115e-03   -2.230573395425520e-02   -4.774693349166518e-02   +4.480109852348708e-02; -1.720210356271645e-02   +1.537632581952239e-02   +3.362051471036496e-03   +4.350642856520759e-02   +3.182877225347598e-02   +3.721277460226418e-02   +3.054013333002420e-02   +8.200781728381436e-03   -1.187504940743334e-02; +3.086497573166871e-02   +3.856334387244595e-02   -8.542558738161671e-03   -1.483675275150454e-02   -2.334413513355508e-02   +4.421807814733036e-02   +5.627262263645988e-02   +9.251130177944057e-03   +1.160728000574146e-03];
L1_L2_iAMPA_netcon = [-5.026524080512655e-02   +2.677364759481828e-02   +4.107274578944824e-02   -2.759276378115063e-02   +2.016408558488429e-02   -7.028025039548262e-02   -1.084034304099682e-02   -6.880513528690037e-03   +9.174912916985949e-03; +7.523017474424931e-02   -1.084827536189136e-02   +4.388848377962751e-02   +2.506131861429573e-03   +5.627773037000060e-02   -4.373987576178438e-05   +1.585706176851503e-02   -1.942981606579284e-02   +3.587947716037081e-02; +1.578839466373116e-02   +6.729474061914691e-02   -2.250767034299189e-02   +1.785345081838876e-02   -3.696056301184884e-02   -7.538207536643622e-02   +1.726718288051247e-02   +3.564093556904546e-02   -1.252877744850257e-02; -6.807089934088987e-03   -2.007690547658317e-02   -2.759932859740007e-02   +9.145289046066627e-03   -2.175195968517810e-02   +1.952994808386884e-02   +6.212771288580642e-03   -7.812572531022889e-02   +3.792219280019019e-02; +6.908397547008502e-02   +1.694416509909962e-02   -4.845816106970672e-02   +2.608958815372731e-02   -1.066368347496379e-02   +5.980815825097675e-02   +8.872193706178297e-04   -2.639931375296267e-02   +4.536700811373570e-03; -3.093013611027649e-02   -4.944972640687105e-03   -2.368297027576429e-02   -4.303185653187190e-02   +3.555330546958527e-02   +2.023297904120918e-02   +6.625972106076961e-02   +7.698617377090275e-02   +3.223919965523553e-02; -1.327573757351564e-02   -1.577906926531067e-02   +6.868232803464577e-02   -4.040210625339924e-02   -8.732576412807969e-03   -6.333766600238262e-02   -3.558335139129175e-02   +1.037511304743610e-02   +8.851454289816280e-03; -3.558625466039525e-02   -3.645349864845805e-02   -3.922699293238440e-02   +3.174157711188964e-02   -1.139649511488400e-02   +2.982339660947653e-02   -1.936233977289392e-02   -3.735726008182060e-02   -5.280302192381273e-02; +1.553684549453444e-02   -1.490755113852879e-02   -5.423818972044872e-02   +8.166109213718492e-03   +1.931446698197245e-03   +6.441623623734444e-03   -5.852508373905729e-02   -1.850791390706606e-02   +4.389806446340982e-02];
L2_L5_iAMPA_netcon = [+1.441635424665508e-02   -9.523600596081906e-03   -4.708128742118706e-03   +3.724543593744509e-04   +3.339127084131870e-02   -6.220622672065263e-03   +7.323589702376548e-03   -1.156159549185979e-02   +2.501235355272428e-02; -8.225516227953696e-03   -1.501899195564583e-02   -1.251955745667266e-02   +9.870483856317611e-02   -4.816629408809060e-02   +4.673860096713132e-02   +2.620163758470598e-02   +2.867508585914448e-02   +3.761065925433395e-02; -3.375661603179576e-02   +3.229480511670252e-02   +5.868468032305117e-02   +1.404020676627105e-02   -4.919236665928736e-02   +7.382826560468990e-02   -1.019594495184839e-02   +4.498602480326040e-02   +6.708441433453649e-02; +2.576559950665383e-02   +1.105145242358116e-02   +5.227920780798249e-02   +1.041481739904872e-01   +2.733105236009103e-02   +5.626891669233265e-02   +2.206016785449570e-02   +3.647875476984851e-02   -3.877623032257378e-03; -1.933144452020188e-02   +5.578539697130357e-02   +4.522307824175625e-03   +1.686599874422198e-02   +2.462588682214375e-03   -9.256180036423940e-03   -2.019239657072718e-02   +1.258384260856812e-02   +2.207156082924653e-02; -4.149717015188888e-02   -8.694770727484220e-03   +9.437667442572743e-03   +2.447954079023824e-02   -1.372956160968079e-02   -1.341637793621112e-02   -2.061380705595486e-03   +2.308168328827127e-02   +1.343229707841376e-02];
L5_L2_iGABA_netcon = [+4.658502608021842e-02   +1.164012809226224e-02   -5.100605951892457e-03   -4.600069701634966e-02   -5.156920651395018e-02   -5.262164055461340e-02; +1.438728751472813e-02   -3.374818760844681e-02   -3.029072160478548e-02   -2.431605877936361e-03   +4.894406636030060e-02   -3.333034807266468e-02; +6.792289367355006e-03   +5.934017075744910e-03   +3.690054205673655e-02   -1.629599145060784e-02   +1.885190482374071e-02   +1.564105031885910e-02; -3.000041109602558e-02   -4.028793042468202e-03   +2.211418675904801e-02   -6.806050682150420e-03   +2.618158334371277e-02   -7.392293138523687e-05; +1.211146147427089e-02   +5.640933860779229e-02   +1.124411916247371e-02   +6.375298054267417e-02   +1.020440314660957e-02   +2.203533680369069e-02; -7.877339981308192e-03   +3.413675469453612e-02   +2.954813801020931e-02   -1.621080541054275e-02   +3.350755114516707e-02   -2.017541336272150e-02; -8.937684411391947e-02   -1.509002798229892e-02   -5.742669221908830e-02   -1.780840810795300e-02   -1.775990164803472e-02   +3.217226303140522e-02; +5.727661542827557e-02   +2.710983058045653e-02   +4.532891862923366e-02   -7.902986407785886e-03   -1.066669050367848e-02   -2.474613549165086e-02; +3.954691573274569e-02   +9.755607124541560e-02   +3.769180646480896e-02   -1.017965590270415e-02   -2.111879720043344e-02   +5.284732180380585e-02];
L3_L2_iAMPA_netcon = [+2.544064039311941e-02   -6.629883833319006e-02   -1.369703101359061e-02   -2.997095094100090e-02   +4.989869047495987e-02   -4.579461665487168e-02; +6.114077776996485e-02   +7.231917974394642e-02   -1.964720257769186e-02   -2.542478365385178e-02   -1.479519129167910e-02   +4.001726332818889e-02; -3.475718826896083e-02   -3.976898090016641e-02   -1.553106314579753e-03   +4.098381579431055e-02   +2.642821928901402e-02   +9.468544247147844e-03; +3.011852846937797e-02   -1.747179015707970e-02   +3.348410944123373e-03   +3.988578648450152e-02   -6.070877318997668e-02   +1.275198136989178e-03; -7.203729376909582e-02   +5.347958880365721e-03   +2.635105859309680e-02   +3.866307379457980e-03   +1.720264923715795e-02   -2.791333828199066e-02; +5.495744922618340e-02   +4.272953196624825e-02   -3.793126390617781e-02   -5.913081026294933e-03   +1.089393394866585e-02   -1.564042844523588e-02; -6.591922428489883e-02   +4.912458738170457e-02   +1.930151331154219e-02   +1.223348851237676e-02   +6.697018551197186e-02   -1.408299958859225e-02; +1.593527937964933e-02   -1.142961553303933e-02   +1.387588272269463e-02   +1.338002101856617e-02   +1.026119276624296e-02   +3.249659523297489e-02; +2.818092297969604e-02   -1.115845955808019e-02   -4.002661131026265e-02   +2.833147071883487e-02   -3.637661262815949e-02   +5.185744449062177e-02];
L2_L3_iGABA_netcon = [-3.402172284578779e-04   -2.561883588256477e-02   -1.478964025038478e-03   +2.104801148743021e-02   -5.384018432104988e-03   -1.501719258667368e-02   -2.061864686775967e-02   +1.193780867738518e-02   -1.592464122488021e-02; -2.198640069505586e-02   +1.112500280368031e-02   +5.492844205483723e-02   -2.724176396517610e-02   +3.852212869752736e-03   +1.647947109485416e-02   -1.648865508232264e-02   -1.377562186045025e-03   +3.011653665473429e-02; +2.237558524844804e-02   -4.064113085597663e-02   +2.289814118030325e-02   -5.032463646495990e-02   +6.948946392248541e-02   +7.772595469594655e-02   +1.333905317581822e-02   +1.744507555499627e-02   +6.514249549821570e-04; -2.790043478914717e-02   -6.250014890384840e-02   -1.199528569180168e-02   -3.105970185248965e-02   +4.467730005196009e-02   -7.812442465165957e-02   +3.252991399626732e-02   +3.253993101460295e-02   -2.288380177154306e-02; -2.243354783895269e-02   +1.982792748573695e-02   +1.215436681992648e-02   -2.093389769248890e-02   +6.068707740622471e-02   +2.240761749694409e-02   +3.994843408290843e-02   +2.022146069121314e-02   +6.185659058739169e-02; -2.700431786107230e-02   -1.146042401722699e-02   +5.713523523626034e-02   +5.017978789785552e-02   +1.504217378555391e-02   +5.334284904741945e-02   -7.973761119753802e-03   +4.953303069966955e-02   -4.457350765163009e-02];
L1_L4_iGABA_netcon = [+5.116520851745019e-02   +4.277293665118422e-02   +1.191817611728708e-02   -4.222466915400798e-03   +2.245411938264727e-02   -6.706287760517593e-02   -3.430855759519640e-02   -2.810817632388912e-02   -6.143720794101202e-03; +2.964413923097375e-02   +3.137247972851629e-02   +6.149914717911185e-02   -3.299613029251497e-02   +7.508264686115063e-02   +1.474359488058361e-02   +8.633377519715359e-02   +8.019783988587827e-03   -1.019328677159166e-02; -2.643233666825031e-02   -2.498495634347017e-03   +3.431309025767403e-02   -4.321476150512697e-02   +2.751228733791180e-02   -1.903080064244795e-03   +4.361889965245555e-02   +6.518189670173535e-03   -1.450396641507027e-02; +1.401762179321592e-02   +4.015468969674094e-02   +1.557307037935280e-02   +3.535524943974457e-02   +1.893633357311854e-02   -1.323812292874849e-02   -5.488527566916707e-02   +4.671150966880647e-02   -4.205074930317385e-02; +4.764604113281001e-03   +5.921971064489985e-02   +1.550134111232331e-02   -2.953112826727711e-02   +5.096686468901471e-02   -2.109050821484160e-03   +4.980031125603548e-02   -3.681520401618416e-03   +2.452785008337957e-02; +2.666710048658019e-02   +4.943284707385492e-02   +1.068695412580967e-02   +7.394939612952224e-02   -1.767436287198493e-03   -2.525789278468298e-02   -9.277274409321599e-02   -1.960382856360261e-03   +5.669891463326106e-02; -2.007880746408153e-02   +1.274026189622095e-02   -2.235103360940672e-02   +1.056815321154780e-02   -2.749358690278170e-02   +4.291521269487207e-02   +3.628577053955786e-02   +6.398408065262786e-03   -5.485659858130087e-02; -4.435474941394146e-02   +5.079178788581278e-02   +7.873921743705395e-02   -3.433067582335821e-02   +1.588998998234641e-02   +5.380107320863761e-02   +3.861113411201046e-02   -2.216755151804892e-02   -2.531287790324388e-03; +3.248773693352859e-02   -8.501265746970074e-03   +4.311339643883545e-02   +5.146572081067410e-02   -4.575035258677425e-02   +3.715971778883542e-02   +1.454674095318898e-02   -2.073960377869344e-02   +1.799728965949787e-02; -3.321842964833691e-02   +1.396685762624189e-02   +2.909078726421783e-02   +4.530335415682749e-03   -1.725621943787898e-02   +2.440423065120347e-02   -1.499730422240803e-03   +4.790922590790435e-02   +2.530722436077137e-02; -2.982884895433296e-02   +1.379881684993073e-02   -2.271936857282418e-02   -1.721525080687659e-02   -5.428915915152005e-02   +6.839295876985542e-02   +1.455756416153948e-02   +5.544916058830788e-02   +2.270954153763624e-02; -2.731483997393223e-02   -2.169299276910146e-02   +2.187679347544444e-02   +3.194076071871398e-02   +3.286073355801045e-02   +6.569227441372390e-02   +4.655870206336761e-02   -4.355469485669510e-02   +1.019655021870675e-01];
L4_L1_iGABA_netcon = [-1.832803329705607e-02   -2.123830950894165e-02   -2.755097055280291e-02   -2.384551956206166e-02   +1.977477068088612e-02   +2.885299597872305e-02   -1.718716938401272e-02   +9.422482729190679e-03   -8.239441232098575e-02   -1.577691989391046e-02   +5.117172444303814e-02   +2.291864072717611e-03; +6.622490959804289e-02   +3.556441931636627e-02   +3.663725759098348e-02   -6.675483636658933e-03   -6.227585937416720e-02   -6.373977972009537e-02   +3.384168275531025e-02   -2.915648949587836e-02   -1.319579926994992e-02   +2.787222133028862e-02   +1.177112229656465e-02   -1.553542671022309e-02; -1.423534833177539e-02   -4.713002875019533e-02   +4.686638307612286e-02   -7.239461005555281e-03   +3.571689274463273e-02   +9.001771195713468e-03   +6.868915542461697e-03   -3.756912577239280e-02   +8.078097682075824e-03   +3.081849518195046e-02   +3.311938668727875e-02   +1.047596793180725e-02; +1.469998073027234e-03   +2.638117914689831e-03   +3.226642623691572e-03   -4.366362368891355e-02   +3.240396714538096e-02   +8.915376012141318e-02   -5.648342798408507e-03   -4.411883921812593e-03   -7.584322559548454e-03   +3.916565966584256e-03   +3.168957796939883e-02   +4.337338128883562e-02; -6.168542921028988e-03   +2.180897413518727e-02   -3.548720632888205e-03   +6.170585532633963e-02   -2.337769337812719e-02   -1.552923902880510e-02   +2.008654523119632e-02   +9.687840104291384e-03   +5.079265026559365e-04   -6.138040096869535e-02   -9.594587736621116e-04   +6.579637511985384e-02; -1.214323193484015e-02   +8.085294635282173e-02   -7.995010179061596e-03   +3.540216873572763e-02   -8.577197813910897e-03   +6.348142244479740e-03   +3.215360358911427e-03   +2.381478128338510e-02   +7.117312390729928e-02   +1.457842244448427e-02   -2.729423432542483e-02   +1.518328852504868e-02; +2.966054773903931e-02   -6.346177245923812e-02   -1.725337576149531e-02   +2.362256953266487e-02   +1.571171011028281e-02   -1.504360044923576e-02   +7.316118518112136e-02   +2.999535079695735e-02   +6.029690501407774e-02   +1.170761047942592e-02   -1.790449287026463e-02   +3.324001922147785e-02; +7.529121859383725e-03   -8.430908618109897e-02   +4.453323508005771e-02   -6.219267200634239e-02   -5.591339348701739e-02   +4.125033609312576e-02   +4.523196389661218e-02   -4.544377008780844e-02   -3.935980995155042e-02   +3.635829148149330e-02   -8.586427767595037e-04   -1.686354308253579e-02; +7.642940853284839e-03   +5.886402528393278e-02   +1.404818690258730e-02   -3.416381608049328e-02   -2.331643888286278e-02   -2.650830024067113e-03   +8.395352520577180e-03   -4.103590158882006e-02   -2.113953321444577e-02   +1.651144076479281e-02   +5.883558461574677e-02   +1.926083511825085e-02];
L1_L3_iAMPA_netcon = [+6.322605272362566e-02   +1.441345046148773e-02   -1.585294168165358e-02   -7.729066393013109e-02   +4.403774779580479e-03   +8.032660341372555e-02   +7.835283390540047e-03   +4.512145854640916e-03   -3.331566181334063e-02; -2.144434285178886e-04   -1.177207615296763e-02   +2.082144103572609e-02   +6.962242619746714e-03   +5.614661653467880e-02   -3.009936301074716e-02   -3.709072347346110e-02   +3.009654071122080e-02   -1.675213678421452e-02; +2.270294213971197e-03   +3.016873216343494e-02   +2.891605018930212e-02   +4.130497851410034e-02   +7.274009220556405e-03   +1.807703015120215e-02   -5.329294399177079e-02   +2.749530501829460e-02   +7.493835641649432e-02; -1.544226563618478e-02   -4.519237184931108e-02   -1.133632905959849e-03   -2.198422414387595e-02   -6.269413770678540e-02   +5.908597679061413e-02   -3.797672180676973e-02   -3.114489418324112e-02   +6.723415683459431e-04; +4.689376257868638e-02   +2.625688794231062e-02   -7.306242910476218e-03   +6.952612730206333e-02   +3.127092934980557e-02   -2.246020656811815e-02   +1.878869153368670e-05   -5.669119673318129e-02   +1.322415032179999e-03; +6.550250637407717e-03   +5.160495434301521e-02   +1.685923549507614e-02   +7.429390071342003e-03   +4.116393895982785e-02   -5.591770503194930e-03   +9.562852957763462e-03   -3.770721138517256e-02   +4.705818753983776e-02];
L3_L1_iGABA_netcon = [+1.209024309296708e-02   +4.205031226330755e-02   +2.352546809055407e-02   +3.145063282033739e-02   -2.244370225429750e-02   -4.677266276418015e-03; +2.749784547047347e-02   +1.034833265918786e-03   -7.282210851463196e-03   +4.590670757455616e-02   +9.820502026159293e-02   -5.975809930611179e-03; -1.485405957309738e-02   -3.219964414070489e-02   +8.564101888182685e-04   -1.535656444157618e-02   -3.237917659005660e-02   +5.362072571115345e-02; +2.654236233625834e-02   +4.617994660398830e-02   -7.679592476638565e-02   +2.366760490060682e-03   +2.096069987736945e-02   +2.119129942142233e-02; -3.057669950266195e-02   +1.657914639785208e-03   +5.366128796845338e-02   -6.995471035544099e-02   -1.393316279107215e-02   -3.509854983328253e-02; +1.539497666923454e-02   -7.336812500054487e-03   +4.764251178342677e-02   -7.595326277537923e-03   +3.440319096229981e-02   +5.586284542369291e-02; +5.509105815673170e-02   +2.203306620721003e-02   +1.129353620838451e-02   +9.088413732154972e-04   -1.465098241715522e-02   -3.914423763449099e-02; -7.009430313870191e-03   +9.000351095125933e-03   -3.827570782574305e-02   +1.348348464408868e-02   +3.897894199958474e-02   -2.249603598959234e-02; -1.287909092665184e-02   -2.617324064877625e-02   -1.587186990576347e-02   +9.437065474630867e-03   +3.589479432206972e-02   +3.811724546634745e-02];
L5_Input1_iAMPA_netcon = [+1.085661610148496e-02   +2.108389120113324e-03   +2.262742322724467e-03   +6.231779462052137e-02   +2.052388550203728e-02   -1.485818314304480e-02];
L6_Input2_iAMPA_netcon = [-3.109305629540551e-02   -2.909886935373860e-02   -2.899281731658235e-02   -5.355119828199362e-02   -2.152768427412678e-02   +7.568184856190190e-03];
L5_L6_iAMPA_netcon = [+2.092574022091584e-02   -1.273872049929758e-02   +2.803735344448333e-02   +2.724886754990000e-02   -1.109099564383455e-02   -1.322349118845999e-02; -2.561497439370378e-02   -4.102873033933575e-02   -1.724905952171085e-02   +3.317832890219161e-02   -1.061446305606375e-02   +4.127806079137183e-02; +2.236862145813763e-02   +5.292076329543224e-02   +4.392142010204897e-02   -8.905631298030538e-03   +3.750393243668472e-02   +6.812764343358312e-02; +2.970373442186081e-03   +4.174751932016298e-02   +8.166676654534552e-02   -3.373906453044094e-02   -4.754247045347187e-02   +2.183261508863978e-02; +4.995596203799729e-02   +2.207805808250300e-02   +3.624917653861887e-02   +3.154534225986216e-02   -3.212971239305730e-03   -3.220404472324908e-03; +2.066265862273112e-02   +1.859817422911588e-02   +4.241286008803149e-02   +1.528409524202011e-02   -6.185148414529301e-02   +7.145925615574911e-02];
L4_L5_iAMPA_netcon = [-1.663280686483951e-02   -3.342699715570259e-02   -3.274797750682992e-02   +4.593203675272046e-02   -1.918365382233328e-02   -3.078882660568165e-02   -3.350276594509771e-03   -7.338859376774153e-03   +4.473721667883424e-02   +5.199615186446466e-02   +4.403045667568972e-02   -3.457266320774040e-02; +6.391138183849253e-03   -4.080358870537371e-02   +3.110498744281744e-03   -6.761058328319164e-03   +3.578806127553436e-02   -3.566318702580215e-02   +8.519176010569743e-03   -3.387471345720325e-02   -6.833881251412034e-03   +4.076983366918190e-02   +6.036462000225055e-03   +5.282988194461836e-02; -4.912796764974076e-03   +3.851390307411870e-04   +4.905005473035940e-02   +3.448187121864651e-02   +3.098759359350699e-02   +5.853550547749278e-02   -3.381258442593224e-02   +8.595786990484133e-03   -4.148116060381138e-02   +5.206546867818292e-02   +4.765865925802949e-03   +2.177874483629404e-02; -5.279476568850101e-02   -5.895220784845848e-02   -1.575401901496269e-02   +5.247751057359945e-05   +3.297962548419766e-03   -3.516618523706615e-04   +2.111916562776511e-02   -3.974759764335132e-02   +4.602897322582866e-02   +1.762644733681451e-02   -4.421993051150830e-03   +1.122140273444822e-02; -1.526014199286339e-02   +6.890664645712070e-02   -2.225356503918544e-02   +1.919312402894408e-03   +4.035905476863910e-02   -6.300719237740171e-03   -4.954820830515601e-02   -3.295993269765179e-02   +2.690872195297664e-02   -2.201726811010719e-02   +2.472936870442973e-03   +4.224186766722507e-02; -4.653297875810948e-02   +2.637596214463915e-02   -4.363864111215850e-02   -2.927543166216877e-02   -4.722320794026093e-02   +9.788885035932661e-02   -4.660033128012055e-02   +1.560040532314795e-03   -1.826894733958825e-02   +7.609843217276810e-02   +3.054827665293867e-02   -5.823213370153923e-02];
L6_L4_iAMPA_netcon = [+6.566209943717025e-03   -3.769297760793652e-02   +2.684437763132404e-02   +7.240692651611078e-03   -3.682295696147705e-02   +5.932047832877402e-02; -1.545664977149928e-02   +3.036393191399296e-02   -2.926649080278870e-03   -2.384603872829621e-02   +2.466141664585599e-02   +1.853335934458102e-02; -1.982978165338682e-02   +2.659268253388693e-02   -2.953877304898543e-02   -5.169837339099843e-03   +2.602320192332656e-02   +1.151408626026106e-02; -3.069152435262258e-02   -6.659611597982298e-02   +3.811096535080626e-02   +4.808553647860909e-02   +5.399547209446337e-02   -3.162834040038773e-02; -8.075819082032434e-03   +3.016493806779091e-02   -1.913687644265756e-02   -5.067198736078461e-02   -1.011976604096277e-02   +6.195675608930332e-02; +3.836196897022057e-02   +7.413422568263719e-02   -1.486299387071460e-02   -1.225570607829207e-02   +1.052134488918869e-02   -6.014797580188250e-02; +3.130156568073354e-02   +1.532410015095391e-02   +3.677306342363516e-02   +4.788359635932626e-02   +3.656075472949739e-02   +4.318756146708438e-02; +4.533834699221097e-02   +4.460385653456803e-02   +5.947054426418527e-02   +1.509406046123654e-02   +4.423697155373200e-02   +2.682951240012729e-02; -7.203578885834437e-03   -4.958676349276809e-03   -8.404313238318580e-02   -3.614874447090109e-02   -2.239677203472266e-02   +1.727865169807093e-02; -9.191681244779322e-04   -2.117258665553577e-02   -2.844757485375178e-02   -2.328521900965235e-02   +5.541703891456888e-02   -3.078896392935832e-02; +6.220010255174849e-02   -3.043344239177157e-03   +8.459312796546045e-02   +6.724614212883949e-02   -3.983577210433800e-02   -1.995925351145559e-02; +9.083249305243221e-03   +7.775048883052096e-02   +3.830626689968913e-03   +8.980750987427890e-03   -7.653313208704388e-02   +1.279137105715591e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
