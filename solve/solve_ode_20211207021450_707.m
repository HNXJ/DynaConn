function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.828632696652211e-01   +5.772394528331551e-01   -8.772523468830141e-01   +1.680673173206142e-01   +5.951898675527100e-03   -1.832042684609584e-01   +7.304618007386363e-01   -7.170506819696583e-01   +8.602733703524341e-01; +1.531292349175923e-02   +8.960721943233665e-01   +7.463294635095628e-01   -3.059005329200505e-01   +1.069893467712156e-01   -1.907374685808463e-01   -1.418658208679906e-01   +5.735012630016247e-01   -5.735639970103090e-01; -8.520496411385331e-02   -1.751221921943491e-01   -1.962672203548201e-01   -3.538432575558504e-01   -5.283150647158117e-01   +4.619143725319502e-01   +5.704470629446050e-01   -6.208694168019731e-01   +6.853700044372102e-01; +3.915177235021812e-02   -2.556266231839390e-01   +3.731291884507655e-01   +7.928653259556457e-01   +5.430397906656198e-01   -1.626003573998414e-01   +7.990386414774580e-01   -5.945613521178271e-02   -4.244847567300127e-02; +9.425199705959428e-01   +5.710808613549057e-01   -4.913753127263865e-02   +5.709631536034061e-01   +2.048537678998054e-01   -3.770994556833017e-01   -2.112275623276390e-01   +3.707366265422954e-01   -7.508765949049171e-01; -1.666395201325291e-01   +7.407963739045377e-01   -3.121008729974054e-01   -3.194425231755857e-02   +6.082679153859384e-01   +3.256747611222144e-01   -6.746670970993247e-01   -3.018389481911774e-01   +6.271806473009860e-01; +8.203361074135901e-01   +6.857015581162392e-01   +5.779517250591339e-01   -5.547337940684444e-01   +1.222398870339399e-01   +4.938134650469341e-01   -7.062536481161812e-01   +1.780079530622376e-01   -1.950575077693090e-01; +1.480721315586910e-01   -9.462539560251852e-01   -6.160178650580843e-01   +1.709489437349910e-01   +5.120962380238804e-01   +1.000000000000000e+00   +3.361829337352184e-01   +3.373810119152779e-01   -2.174811323446270e-01; +3.340933713059506e-01   -7.439172295891702e-01   +6.948312770372251e-01   -1.600792332039058e-01   +3.693514022166327e-01   +4.719340444653672e-01   +6.990494415694319e-01   +9.295053201304524e-01   -1.560737450017411e-01];
L1_L2_iAMPA_netcon = [-1.836955110797265e-01   +4.889070217059980e-01   +4.328894981858959e-01   +2.796128465392475e-01   -5.351622992584438e-01   +4.247670351169666e-01   -3.141153390630296e-02   -3.509519932641695e-01   -4.641471429770329e-01; +2.418284475220522e-01   +1.028318176048395e-01   +1.773740772259418e-01   +1.000000000000000e+00   +4.092297339949555e-01   +1.092541170393617e-02   +1.791755283318319e-01   +3.598095861181028e-01   -4.707099278118833e-01; +8.499120861367103e-02   -2.065631723830409e-01   -6.451006129430051e-01   +1.202466513257273e-01   +3.228134630962728e-01   +5.490773038493482e-01   -5.691261224908571e-02   -6.680251766254699e-01   -4.612820272193555e-01; -6.076673626164044e-01   -4.090658243185160e-01   +1.928295339077351e-01   +2.827654917691221e-01   +9.822960157237208e-01   -6.740771828935488e-01   +1.991378245418775e-01   -2.137452056728809e-01   -3.422413134047902e-01; -9.681148626136480e-01   -8.872841570714143e-01   +9.488422780687732e-02   +9.421359795711659e-02   -4.090653816032369e-01   -2.275961512374140e-01   -2.039845853344852e-01   -4.646012857158091e-01   +3.641658304952261e-01; +2.217173146920685e-01   +6.792607629850920e-01   -4.838145390587190e-02   -5.481324934459845e-01   -8.261349057287045e-01   +6.611318539566023e-01   -5.885786301865696e-01   +5.647659449570185e-01   -6.627602366365618e-01; -4.383845077517941e-01   -7.477352806602015e-01   +6.133600220613766e-01   +6.427266922483859e-01   -8.465825278646536e-01   -3.235978343639495e-01   -4.131038371449659e-03   -4.422614588860895e-01   -3.112021476936412e-01; +5.093855583619870e-01   -3.845211187425122e-01   -2.076399825802636e-01   -9.072721676344682e-01   +5.400586832157509e-01   +7.531933976966607e-01   +2.642973760448436e-01   -1.614362900251800e-01   +5.689747661750586e-01; +2.064946822195134e-01   +6.454592515057080e-01   +4.816855283216505e-01   +2.445221261604185e-02   +4.845285641819011e-01   -1.237984558546255e-01   +3.452943640537157e-01   -5.763557404993989e-01   -7.899625168378495e-01];
L2_L5_iAMPA_netcon = [-2.311580110964246e-01   +2.746406067425959e-01   -5.076736044073340e-01   -7.229635451674092e-01   -6.665836134969884e-01   -4.889574677772990e-01   -2.458599539935550e-01   -4.411980440999714e-01   -4.385856039619037e-01; +7.502836690226731e-01   +1.554548118329857e-01   +4.398877377925277e-01   -2.667206887718130e-01   -2.715606164173974e-01   +1.650608498970100e-01   -2.409818242485290e-02   -8.974937455851253e-01   +5.178966470664054e-01; -8.179596860776579e-01   +2.087341363435236e-01   +7.385156410255476e-01   +6.141730474891031e-01   +4.375898442327177e-01   -5.163897878705277e-01   +5.014105847250417e-01   +5.739541494624395e-01   +2.207523942816309e-01; +2.833776676050674e-01   +2.980893266405647e-01   -6.635474764359451e-01   -2.174713951212859e-01   -2.931248824772647e-01   +6.636666864280379e-01   +9.102472097183207e-01   -9.720679687470217e-02   +1.000000000000000e+00; +9.297446460844193e-01   -5.813864184832237e-01   +1.620827784821645e-02   -5.123081237103722e-01   -7.626690176238615e-01   -6.860193793867042e-01   +1.630447130106530e-01   -2.789997036393960e-01   -8.052538303432325e-01; -1.510963106804418e-01   -3.938007709396401e-01   +7.120071660332836e-01   -6.046676384154272e-02   +1.459140346394128e-01   -4.779957439326715e-01   -6.623135565894049e-01   +2.125793133361764e-01   +2.531279506212767e-01];
L5_L2_iGABA_netcon = [-3.869790907492117e-01   +2.502454831576700e-01   +6.062650093313962e-01   -8.229151501689203e-01   +5.791226566153604e-01   -2.831871950899407e-01; +7.183129298104668e-01   +5.996336652725169e-01   +6.281600591795369e-01   +2.718386323383152e-01   +2.556869021392768e-01   -2.845906359929653e-01; -5.977982368300666e-01   -1.171188862561735e-01   +4.632544033415951e-01   +1.778958772678887e-01   -2.246941694629522e-01   -4.608436359227062e-02; +8.686726793166363e-02   -5.179229647175865e-01   -3.840337819806862e-01   +8.753262152657618e-02   +1.559931454325089e-01   +1.837784370150167e-01; -5.225468528168026e-01   +2.701457715905314e-01   +7.691444239431289e-01   +4.870473961191262e-01   -5.423997575794754e-01   -6.848263977217152e-01; -5.030578694364551e-01   -6.903065430847782e-01   -4.486531899481992e-01   +8.632793559650113e-01   +5.999539460261171e-01   +3.418171156257365e-01; +3.646783445924919e-01   +9.089386370851441e-01   +4.838064416349961e-01   -7.373491294907241e-01   -2.812081258155451e-01   -1.000000000000000e+00; -7.033536065111066e-01   -5.898175361445663e-02   -1.364641012077860e-01   -7.801581705299135e-01   -5.595877955406127e-01   -8.590633057664653e-01; +2.349232433863712e-01   +3.947147647413894e-01   +2.777430394972296e-01   +1.958779458914218e-01   -1.678131874808424e-01   -8.522835636471961e-02];
L3_L2_iAMPA_netcon = [-8.183256821194791e-01   +7.143134647743542e-01   +7.887398110102155e-02   -3.718376595993342e-01   -7.190745509436894e-02   +5.021129284608979e-01; -2.525820251892348e-01   -4.019558020969387e-01   +5.920143951564030e-01   +1.132537709226065e-01   -1.804239360723203e-01   +7.914925260597148e-01; -3.495932573281941e-01   +3.137185047893703e-01   -4.670613319640430e-01   -3.343566358275871e-01   -7.239041131273899e-01   +4.168857937299728e-01; -6.457490839133712e-01   +3.252224243251191e-01   -2.109322840978742e-01   -7.747339809513473e-01   -7.497021666498921e-01   -4.013344788367912e-02; -9.582022133618027e-01   -2.083494820347305e-01   -6.035483907570256e-01   +2.714543646499633e-01   +9.173537945414448e-02   +2.818560609005917e-01; +5.499320388747602e-01   -3.318368485597897e-01   +3.204017272396862e-02   -5.128103815129471e-01   -3.906840243166037e-01   -7.037529952471316e-01; -1.000000000000000e+00   +2.989634091913005e-01   +1.482693549395474e-01   +5.588408145572047e-01   +5.228030562204915e-01   +1.563625979241342e-01; +6.086799703862664e-01   -6.759580442107643e-01   -2.098319994417083e-01   -5.541888751756929e-01   -7.731501771375245e-01   +4.305251726322290e-01; +3.981670429763201e-01   -1.101105056807713e-01   -1.664169610154009e-01   +1.701633108663669e-01   +3.775756054758099e-01   +9.398846168734402e-02];
L2_L3_iGABA_netcon = [+5.923791821214082e-01   +8.226231182982873e-01   +5.770200223209822e-01   +5.723243094352244e-02   +5.282340665012479e-01   -2.568732406275397e-01   +8.646391552220282e-01   -6.474052371121096e-01   -8.171279422693138e-01; +5.178199780681977e-01   +6.016253507248946e-01   +5.558445912132040e-01   +1.519545361662310e-01   -2.447500061592859e-01   -3.057881336473932e-01   +2.171266575243148e-02   -3.896587885340275e-01   +7.405719313776052e-01; -3.640838942310872e-02   -3.340088093032745e-01   -3.762389942341379e-02   +1.610114083893184e-01   +1.000000000000000e+00   -3.010870482478631e-01   -4.260356814584630e-01   +3.637516144839139e-01   +2.622359092667278e-01; -7.269620191020969e-01   +3.556265927399745e-02   -5.773219357316701e-01   +4.456418364253070e-01   -9.065049350385712e-01   -1.690291404005273e-02   -1.564350751168110e-01   +4.678349921299081e-01   +6.754415110886666e-01; -6.148461690312573e-01   +8.278346345830396e-01   +3.160938458720965e-01   -7.450981860011299e-01   -1.459386518244184e-01   -1.228460656944393e-01   -5.670121924287591e-01   +8.219534930724507e-03   +6.231579046467663e-01; +5.429005530884812e-01   -4.250712025412113e-01   +7.483545646756397e-01   -8.929429245529759e-01   +4.093622369491107e-01   -7.896820114779176e-01   -7.844769044196238e-01   +5.854481917333534e-01   +6.918096173560530e-01];
L1_L4_iGABA_netcon = [+6.282628298075233e-01   +2.779432712035675e-01   +3.288861255251144e-01   +6.871695740636647e-01   -4.050058881070278e-01   +6.878014091061670e-01   +4.745384407527573e-01   -5.849464310176037e-01   -5.074665833987588e-01; -8.540100764766737e-01   -8.636904483386332e-01   -3.288978643998721e-01   +6.324627771058143e-01   -5.716577427439496e-01   +9.830364331179416e-01   +1.474970882811454e-02   +4.416412212560457e-02   +2.777599610002799e-01; +5.366219878082359e-01   -6.979370692986884e-01   -4.907935092970167e-01   +7.031042418032606e-01   +3.951290560311475e-01   -9.539737304019924e-01   -8.863660682257141e-01   -4.016300886088888e-01   -8.613193814068683e-01; -4.691543903876778e-01   -1.260925928752875e-01   -1.347416477219942e-01   -1.236349017602725e-01   +1.708253067730507e-01   -7.746693020309048e-01   +1.700018199616459e-01   +6.467389248151739e-01   -9.389051076478283e-01; +5.658352990697292e-01   -4.164291692110600e-01   -2.406613082944662e-01   +7.253070299272110e-01   +8.265830905886276e-01   -8.868444445981680e-01   -1.000000000000000e+00   -9.195148774428755e-02   +5.051547126550198e-01; -3.136811801912700e-01   -7.495440657672868e-01   -4.787643611983579e-01   -6.792994522629516e-01   -6.204689744854657e-01   +3.767728633994222e-02   +7.718567585572038e-01   +3.525351224718683e-01   -2.350188397340787e-01; +2.339701083424229e-01   -4.562074668090240e-01   +9.792868140242651e-01   -1.030698472872631e-01   -4.246738248581343e-01   +7.768433491468211e-01   +2.744223040616984e-01   +4.002844026638744e-01   +5.004879894002270e-01; +2.604147429724413e-01   +3.459426625563343e-01   -6.203851153861061e-01   -2.146891033097238e-01   -2.186248791174606e-01   -4.946626083511542e-01   +3.393311303248439e-02   -1.849481635627388e-02   -3.259495255761784e-02; +3.771563033417265e-01   -8.769618756710228e-01   +6.048081419046396e-01   +7.069126978276885e-01   -5.865333950087301e-01   -3.324151272222058e-01   +6.114961442866738e-01   -3.383657149720021e-01   +7.931483897190161e-01; +4.665460192803866e-02   -6.775845474752701e-01   -2.068102392315992e-01   +5.097695756216274e-01   -5.101049383990409e-01   -8.692061373102626e-02   -3.267239967952305e-01   +8.504743301371729e-01   -8.946942343603511e-01; -7.552236461162751e-01   +1.101581214011441e-01   +6.896366130287451e-01   -6.913902141809642e-01   -6.242945169426924e-01   +3.392168797419496e-01   -5.627751494980057e-01   -4.271900919742816e-01   -4.562617878474973e-01; +2.995997337094776e-02   +3.972617753380922e-01   -8.440310571090530e-01   +1.319398274397670e-04   +7.831873139836688e-01   +3.252218218226883e-01   -5.645126222520985e-01   +3.861326235043712e-01   -7.772079220848722e-01];
L4_L1_iGABA_netcon = [+1.340434125792596e-01   +6.068749522702576e-01   +1.551938413976755e-01   -5.745356650250375e-01   +2.984692694118926e-02   -3.791896174167856e-01   -1.522330882098747e-01   +1.377805709102329e-01   +7.734677826066827e-01   -9.679525780369049e-01   +7.622863693923913e-02   -6.663868125962992e-01; +8.885125320721658e-02   +5.555514263616588e-02   -7.263917533002028e-01   +5.157945689126301e-01   +2.171753663852554e-01   -3.664323799791222e-01   -3.733596511994546e-01   -8.192929450225227e-02   +1.393885513928552e-01   +8.598159998435719e-01   -7.246331830377875e-01   +6.997376043226773e-01; +5.525115303421454e-01   +1.205017387121006e-01   -5.910309143382240e-01   -4.933015804010286e-01   -5.604022292877755e-01   +1.033604414998945e-01   +6.938763088627952e-01   +7.392878737712451e-01   -4.522784883045974e-01   -1.454994367098760e-01   -6.849217908505481e-01   +4.842639725291646e-01; +6.413781532512175e-01   -4.590772789523234e-01   +2.779427401325443e-01   -2.642065457530439e-01   -1.157215851725405e-02   +5.405652306966435e-01   +5.314068722361203e-02   -6.866165756783836e-01   -4.654475833025204e-01   -1.436341085157310e-02   +8.233238462293134e-01   -3.989171124530147e-01; +1.107451647695897e-02   +1.826953047429420e-01   -3.550622178943467e-02   +4.587158613940644e-01   -2.179228196972976e-01   -2.147704301697665e-01   -4.664964961440188e-01   +4.770311690446741e-01   -1.378742526776643e-01   -3.503004591340441e-02   -1.489003892349497e-01   -3.280948088608196e-01; -5.839935097437673e-01   +7.275113458786222e-01   +1.869781587412265e-01   +8.431892913641076e-01   +1.000000000000000e+00   -3.375788485031530e-01   -2.634443615571745e-01   -1.950443563315029e-01   -2.982583032801469e-01   +6.053969761248866e-01   -7.907555823736797e-01   +1.355800096155071e-01; -1.556049913659774e-01   +3.271195895548147e-01   -5.138890000787493e-01   -4.805358525839158e-01   +7.569101341542909e-01   -5.921822956905239e-01   +4.960278927640435e-02   -3.592324125564635e-01   +4.107359050380780e-03   -7.048269297641208e-01   +5.593022010025333e-02   -2.887939195932973e-01; +3.040897674809682e-01   +3.002565546528493e-01   +1.912479939017394e-02   -6.190568106864264e-01   +4.918133649607159e-01   -2.682255046208412e-01   +5.620822975240179e-01   -4.360615897975652e-01   +7.949207947564146e-01   -2.102180206686936e-01   +3.080097353299469e-01   -2.974338172162967e-01; -4.182580747840235e-01   -5.384206976696079e-02   +4.136878992618501e-01   -6.783534336447146e-01   +9.610636765038926e-01   -1.389904699464684e-01   +6.455388095591464e-01   -2.083066818503314e-01   +2.771599208620091e-01   -6.072103871884387e-01   +5.326558401629092e-01   +7.567392264152828e-01];
L1_L3_iAMPA_netcon = [+9.447522482381145e-02   +1.413389343541404e-01   -6.048700094456411e-01   +4.479901994149763e-01   -8.900630887575579e-01   +1.993032514000090e-01   +5.173047559994136e-01   -3.231413012857419e-01   +1.207965141143898e-01; +9.361598638448683e-02   +2.903899162548059e-01   -2.302975740101781e-01   -7.418111968186910e-01   +1.884442068941149e-01   -1.178329605134104e-01   -8.902335447930912e-02   +1.203378803556359e-01   -4.298768629738986e-01; -1.429744485919292e-01   +1.605404221512576e-01   -2.283055649472846e-01   -2.172208573976326e-01   -1.653262369869583e-02   -2.913988152193744e-01   -2.027508875135342e-01   +6.653933791050176e-01   -9.497466054626305e-01; -5.748166890758891e-01   -5.779131674087377e-01   -1.000000000000000e+00   +4.860323036320687e-02   +8.734873883348661e-01   +8.016508158890996e-01   +3.560791687790464e-01   +4.458287304614418e-02   +2.389736041579604e-01; +4.449100001713979e-01   +1.577224122414849e-01   -2.091989743259072e-01   +6.696834466982600e-01   -8.099633219142442e-01   -6.572299297395356e-02   +7.602070986439392e-01   +5.259597805328493e-01   -4.748856117338056e-01; +5.442001560267296e-01   -6.078976217913773e-01   -5.058273758781364e-01   -4.132959636709154e-01   +8.107214018613965e-01   -3.514596905215736e-01   +3.612738097227918e-01   -1.221679199735768e-01   -9.544749396351675e-01];
L3_L1_iGABA_netcon = [+7.216241921277367e-01   +3.208883649405480e-02   +8.202596107306352e-01   +3.398722504133984e-01   -1.829564210205640e-02   -8.127615224085163e-01; +6.176007764763342e-01   -8.609427786568156e-02   -1.582091400142033e-01   +5.730504683513483e-01   +6.105623588632653e-01   +7.843665953789565e-01; +8.209143551647216e-01   +8.307001786302880e-01   +4.881955130029281e-01   +6.795779793298792e-01   +8.198068442465052e-01   -8.105587434285786e-01; +6.387962119257653e-01   +5.431646117957617e-01   +7.705917912744932e-01   -6.049966424414220e-01   -6.921316717019530e-01   +4.462168428176660e-01; +4.677796855032056e-01   -1.082552010955628e-01   -2.813622600320078e-01   -7.539173693547799e-01   -8.966611814250063e-01   +2.598136136721447e-01; -6.992028424728881e-01   +7.976223011074515e-01   -3.475612597260007e-01   -2.388670119218513e-01   +8.337554385172610e-01   -4.574419699608773e-01; +6.083999217491406e-01   +5.616527861781098e-02   -5.531036177068938e-01   -1.969723658527849e-01   -6.825704604844247e-01   -1.000000000000000e+00; -7.033436393188419e-01   -1.235340939781279e-01   -3.148922818675722e-01   +6.154287141987914e-01   -3.393459856900371e-01   -6.486391627341455e-01; -3.852775685018496e-01   +4.645482838644431e-02   -5.706176858364124e-01   +6.873609042101357e-01   +8.081193683553664e-01   +1.932527413508217e-01];
L5_Input1_iAMPA_netcon = [+2.003874917551347e-01   -9.868443583851259e-01   -1.000000000000000e+00   -5.178610838045453e-01   +9.417658022356686e-02   -1.983631194020999e-01];
L6_Input2_iAMPA_netcon = [-1.000000000000000e+00   -3.003987609525484e-01   -4.361024266036040e-02   -4.824060738571003e-01   -4.293338660456197e-02   -5.696198760039004e-02];
L5_L6_iAMPA_netcon = [+4.695679702927564e-01   -5.997771866458422e-01   +5.478551433967291e-01   +5.965719494798151e-01   +3.232275041572158e-01   +2.348478521328348e-01; -8.260273925454283e-01   +3.990192305709211e-01   -9.412288841919036e-01   -7.027606008214147e-01   +6.077766923782166e-02   -7.652826360887636e-04; +7.914289574218739e-02   +5.484216819737051e-01   -4.132517016657974e-01   +1.953991958980172e-01   -1.000000000000000e+00   -5.640173872132118e-01; -6.221114050276348e-01   +7.798397330120466e-01   +6.577592328780821e-01   -6.081467165110449e-01   +1.795448111161040e-01   +6.536132421988092e-01; -4.645312709793859e-01   +8.496170045699811e-01   +9.734374971167080e-01   -5.868615827736393e-01   -2.641403240672701e-01   +1.799953746120267e-01; +8.118675321186410e-02   -4.635837466875226e-01   +5.443898179194938e-01   +5.921238055762786e-02   -3.479773249257742e-01   +7.590465229942001e-03];
L4_L5_iAMPA_netcon = [-3.100474438113265e-01   -4.246076838321227e-01   +3.207270300647000e-01   -9.430070866091883e-02   +9.539069172951532e-01   -6.286527804525349e-01   +8.874729800463717e-01   +8.175351083803957e-01   +3.121472419882713e-02   +3.757305710619060e-01   +1.815041879427326e-01   +7.938204609566812e-01; +7.314594721956200e-01   +7.260925987486898e-01   +6.719539928085241e-02   +8.224592556229938e-01   +6.338095014691194e-01   -4.498456280207804e-02   -2.681560176843867e-01   +3.168824652159885e-01   +7.434848197509195e-01   -3.740109013816750e-01   -2.670434847565964e-01   -6.931358595810669e-01; +9.630682838443008e-01   +9.451993917693170e-01   +6.214123032594029e-02   -2.593713500806722e-01   -3.571090641230018e-01   -6.917506422467340e-01   -8.645080307413995e-02   -4.999651420249199e-01   -6.074858303910834e-01   -5.563903159141197e-01   +3.069478915111139e-03   -2.735104721541789e-02; -7.285026948852236e-01   +1.739040519901516e-01   -4.610816329239122e-01   -1.000000000000000e+00   -9.602487012065029e-01   +2.636719409704058e-01   -1.892048484459281e-01   -3.303645399168813e-01   +7.454552516337053e-01   +2.071324461873666e-01   +4.940339450385942e-01   -7.318826627376211e-02; -3.354916802157103e-01   -3.199110704426696e-01   +2.952815293438667e-01   -3.757780084606513e-01   -3.067347489816388e-01   -7.696901408156989e-01   +7.563755819034824e-02   -3.072368580987205e-01   +7.654802591376224e-01   +2.115093216084621e-01   +5.272961218437396e-01   -5.656408526246480e-01; -6.539978648958032e-01   -4.708053084782428e-01   +2.768053619008020e-01   -5.912811658259228e-01   +6.403961275047928e-01   +4.319935302688028e-01   +6.250295086312236e-01   +4.686384681617621e-02   +4.339270212418952e-01   -6.324183194205792e-01   +3.516747587274257e-01   +3.382803369365842e-01];
L6_L4_iAMPA_netcon = [-1.998748515006817e-01   +4.073768907741798e-01   +7.295918777789842e-01   +1.829184811388289e-01   -4.535355164887007e-01   -6.039541231179741e-01; -2.322232230373688e-01   -9.266139805835246e-01   +3.443029865390086e-01   +4.184081141584569e-01   +2.036351597092062e-01   -4.060730592600426e-01; -7.662246872718946e-02   -5.001945131888352e-01   -6.561094469545695e-01   -3.793327131700277e-02   -2.656012489524789e-01   +5.508743322973709e-02; +4.631604793683995e-01   +7.562925607539683e-01   +2.520061979775722e-01   +2.104581035343872e-01   +7.541985853404147e-03   -7.741918759186962e-01; -7.018772872828777e-01   +2.088075602921736e-02   -5.514044686956928e-01   -2.147765975568210e-01   +7.572830553976636e-01   +2.993688565051913e-01; +1.789614873357041e-01   -5.506535555462462e-01   -7.484916241500625e-01   -4.688333792194989e-01   -8.224201387307138e-01   -1.609640808264277e-01; +5.804286774599116e-01   -3.923962164783008e-01   -4.353315450670178e-01   +6.666570885468949e-01   -7.646772457533735e-01   -4.242003039745540e-01; +7.856145910905071e-01   +8.368639328654541e-01   +1.293571194516361e-01   -5.410794835741080e-01   +3.271616626668303e-01   -1.000000000000000e+00; +4.020045715279551e-01   -8.586020637612339e-01   -6.385496998132490e-01   -4.673710667410413e-01   -2.189463973436909e-02   +3.792195251287024e-01; -6.466295612119896e-01   +5.509228305209517e-01   -4.955280721498649e-01   -8.193221686096220e-01   -8.696954409842269e-01   -4.756211392561257e-01; -2.574906305438091e-01   +5.994218125589207e-01   +1.461111105368904e-01   -1.447311295771807e-01   -8.673654824314480e-01   -6.893035383578193e-02; +7.957243032318911e-01   +7.764146831834254e-01   -2.795927278068595e-01   +4.923324394818669e-01   -3.946402737731002e-01   -1.685777689203403e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
