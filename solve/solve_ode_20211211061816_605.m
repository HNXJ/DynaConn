function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.473631027892627e-01   +4.607600014726058e-01   +8.351045359915725e-02   +3.675895533233299e-01   +3.944790528768263e-01   +1.115546599893881e-01   +2.010216420016631e-01   +7.394360800694999e-03   -9.129581640652766e-02; +8.431791119256547e-02   +2.915203796806163e-01   -1.684105678692203e-01   -1.407614989078626e-02   +2.971100041394145e-01   +2.711593907462628e-01   +1.494868751223923e-01   +5.450258549512148e-01   +3.265570383596539e-01; +2.537050906996322e-02   -3.568279131046179e-02   +2.620503180249039e-01   -1.221137197841239e-01   -8.068205883571929e-02   -8.309564630594603e-03   +3.331785089284987e-01   +5.708120814286038e-02   +1.637088878045528e-01; +4.181972400573434e-01   -2.631724670945609e-01   +2.910275715935791e-01   +2.134457327444677e-02   +2.167814719428297e-01   -1.532897830417917e-01   -1.385277974092705e-02   +3.614113053604729e-01   -2.466641546566480e-02; -1.731377634124094e-01   -2.224237687022922e-01   +2.360731381118718e-01   +1.286197747222955e-01   +2.462940147563811e-01   -6.228960482035627e-02   +8.855668092883685e-02   +3.015743601739002e-01   -1.367285024471499e-01; +3.523180721934557e-01   +5.740151580961800e-03   +5.998234303916340e-01   +5.593465217625467e-02   -2.306317197419960e-01   +2.425595524229380e-01   +7.081482984395673e-02   +7.323036990166401e-02   +2.442840417764916e-01; +5.047886414606187e-01   +6.701260281862963e-01   +4.978351098099847e-02   +5.335093361516113e-01   -1.937949151636743e-01   +2.121206167730501e-01   -1.585279961688654e-03   +2.616262657779405e-01   +2.573201741487606e-01; +4.644472659208692e-01   +1.279793765738985e-01   +3.662728870848904e-01   +3.049672506846208e-01   +2.115830457506914e-01   +3.498026159466922e-01   +1.041466769777658e-01   +1.127743861014351e-01   -1.229422127959544e-01; +5.927219034037399e-01   +2.896267426276635e-01   +4.083966167663594e-01   -2.913234339805437e-01   +8.338919687886803e-03   -5.220332967128941e-03   +3.931725464630526e-01   +1.517487411742877e-01   +3.973805595137953e-01];
L1_L2_iAMPA_netcon = [+3.645532187016779e-01   +4.610856696420850e-01   +3.193863591245036e-01   -8.059108452333134e-02   +3.987461295370155e-01   +3.026212227030859e-01   +2.036239379008082e-01   +2.574937254729518e-01   -3.937102133588613e-02; +8.078965440450597e-02   -5.855124259672329e-03   -1.563323956963800e-02   +1.794617551869621e-01   +3.169998760553803e-01   +4.054906562418591e-02   +1.321322139968210e-01   +4.736747252645318e-01   -1.450765736269697e-01; +1.410853838585150e-01   +1.606430902179598e-01   +2.192363506046434e-01   -1.147522667279772e-01   +2.964570182340543e-01   +1.335407242876259e-02   +4.667574399534242e-01   +2.481146705178350e-01   +9.535749852899941e-02; +4.408805540421400e-02   +5.837047116125427e-01   -1.822041959496409e-03   +4.487105150996093e-01   +5.401343337107649e-01   +5.822652173350593e-02   -3.384757681174753e-01   +1.098285165435720e-01   -4.576692359384536e-02; -5.239462122430841e-02   -2.234756969091554e-01   +6.066367413840387e-02   +3.136602743490646e-01   +3.202586272420109e-01   +2.309643899059627e-01   +6.232260344739813e-01   +6.559475847583482e-02   +6.306919974096992e-01; +4.125069730756523e-01   +1.205454147484511e-01   +2.372283339997502e-01   +5.829562263655313e-01   +6.837855622449261e-02   +2.004275690543832e-01   +2.066244347285758e-01   +3.352601486911242e-01   +3.076069957626785e-01; +3.239220092096433e-01   +3.046240177539058e-01   +6.393116854651466e-01   -2.588348338144864e-01   +9.170600224364767e-02   +5.018367082579450e-01   +1.966440233508112e-01   -2.408011731230758e-02   -5.525211298632035e-02; +3.231404556167432e-01   +2.478764923408255e-01   +2.089802346952516e-01   +2.704060173494484e-01   +1.260755568541473e-01   +2.446676384882779e-01   -9.187405196000711e-02   +7.288713647201908e-01   -1.465459753269914e-01; +1.267673709088107e-01   +1.883225916427783e-01   -9.513547191403092e-02   +5.018763577151217e-01   +6.393933459834976e-01   -2.668432192238054e-02   +4.207450173401063e-01   +6.567207704677566e-02   +2.374776187276367e-01];
L2_L5_iAMPA_netcon = [-3.441451810406236e-02   -1.863172019481514e-01   +6.361997127592844e-02   +1.217522409778680e-01   +8.958937595243133e-04   -3.324518274668290e-02   +2.365525208956651e-01   -2.893689902607831e-02   +1.378025971754508e-01; +3.210275855288401e-01   +2.135963417881392e-01   +5.566355915193347e-01   +2.307285349791063e-03   +5.396836345372295e-02   +5.631548313155289e-01   +3.028332368308646e-01   +1.119463931119829e-01   +4.460133707075433e-01; +2.127518187942664e-01   +3.315991348002856e-01   -1.886589455127770e-01   +2.480289994254872e-01   +4.182023946233378e-01   +2.808132085635798e-01   +1.052857689284449e-01   +2.985239349252267e-01   +2.880490880182120e-02; +1.450253027619083e-01   +3.361611868952911e-01   -4.078993232325025e-02   +7.040205435476948e-02   +5.146027588234442e-02   +1.417382076973204e-01   -1.401959654950280e-01   +1.075690422243573e-01   +2.715207904098835e-01; +6.324817050639388e-02   -2.136114414156774e-01   +4.359432757172667e-01   +2.378853550359209e-01   +2.121527251347946e-01   +7.186694591477047e-02   +2.719866879955942e-01   -1.768760856058856e-02   +1.544232462376733e-01; +5.733276929694787e-02   -2.127395933844154e-01   +4.780032523042032e-02   -5.045991440562447e-03   +7.182704181618056e-02   +2.495710998125147e-02   +1.754823453699113e-01   +6.124977104112472e-03   +2.529954305206932e-01];
L5_L2_iGABA_netcon = [+2.684882264421133e-02   +1.136556354127849e-01   +3.962339830609899e-01   +4.401244529005500e-01   +4.081914629329309e-01   +4.537726642052181e-01; +7.241323833097786e-02   +4.893515605915267e-01   +4.031526644773912e-01   +1.492767756971498e-01   +3.669410306699763e-01   +8.211091221266109e-02; +2.508943348896356e-01   +4.315325007654233e-01   +6.187994715440348e-01   +2.036547449123267e-01   -7.797349687573607e-02   +2.703154960445950e-01; +2.257728876360156e-01   -2.067040741522970e-01   +9.665210580854605e-02   -5.626754481594613e-02   +2.310790281594058e-01   -2.110619065395672e-01; +1.043466856613098e-01   +4.033381771227817e-02   +3.224647873592618e-01   +3.110497262009435e-01   +2.276120774307367e-01   +2.554927345009282e-01; -1.876118281841373e-01   +2.838129643101879e-01   -1.262349068798263e-01   +2.344231707317505e-01   +3.943627835932380e-01   -1.402147136807431e-02; -4.707137671178414e-02   +5.786168491869061e-02   +4.107296606346379e-01   +3.927621593752197e-01   +9.637861898453373e-02   +2.654463957652006e-01; +2.155156757751580e-01   -2.935301019862118e-02   +2.340189687757026e-01   -8.445816844248263e-02   -1.208677844804527e-01   +4.076131543584426e-01; +2.908519403266319e-01   +2.754575109211036e-01   +1.444246141713517e-01   -1.270409188623927e-01   +8.883819923299414e-02   -2.255060108229474e-02];
L3_L2_iAMPA_netcon = [+1.231038449175953e-01   -5.793743546927684e-03   +4.162275912669223e-01   -5.159298122713832e-02   +2.242756416503415e-01   +3.332579993523471e-01; +2.215694219727055e-01   +1.569671724532683e-01   +2.473527579995042e-01   +3.598348417562400e-02   -1.024953427961145e-02   +2.757175848245749e-01; -1.028135902296388e-01   +2.521364715115068e-01   +7.127908080777272e-02   +3.018697280558835e-01   +3.759743388222032e-01   +2.176328560034070e-01; +1.505589275313039e-01   -1.787530688160469e-01   +1.805312664429469e-01   +2.793896373501430e-01   +1.321593655525921e-01   +1.740364348396963e-01; +4.817652007999281e-01   +1.956853947292004e-01   +1.794173288806072e-01   +3.133421040008512e-01   +2.888253015886515e-01   +5.620400948464362e-01; +6.396745837956018e-01   -5.936328250915267e-02   +1.915220449669868e-02   +5.147325689762511e-01   +4.008254227689213e-02   +2.168587178234563e-01; +4.066383543965182e-01   +2.380255113682496e-02   +6.266860180852044e-02   +3.853315436522999e-01   +1.252766565625629e-01   +2.945720306075249e-01; +2.416475694634043e-02   +4.359728060080567e-01   +3.253000257208816e-01   +2.735349678576700e-01   -1.304502471489724e-01   +1.019749231218255e-01; +5.775653523759481e-01   +4.380221252270948e-01   -1.068853271321655e-01   +1.012412261783605e-02   +3.656064830969720e-01   +2.596895569734750e-01];
L2_L3_iGABA_netcon = [-1.423049458233680e-01   +2.801973133130385e-01   +5.027606904299861e-01   +8.886302612391109e-02   +2.796696865089698e-01   +5.006398237247802e-01   +2.673479251107481e-01   +1.118965019908526e-01   +1.431563573432326e-01; +2.345183257619757e-01   +2.204578883860013e-02   +1.910354669238376e-01   -9.876026808180349e-02   +2.719861803965106e-01   +5.186813878863907e-01   +1.129883688417656e-01   +1.078374410862391e-01   -2.502300279521682e-01; +2.404747838668539e-01   +2.379058557540581e-01   +2.780802238050796e-01   +2.852924188188690e-01   +4.845785250907502e-01   +2.105989547638555e-02   +2.387190420992791e-01   +3.114316869507078e-02   +3.139932784045175e-01; +1.844365470374231e-01   -8.178372610851052e-02   +9.552112134043927e-02   +3.662067285095571e-01   +1.476003556805369e-01   -1.883147417181880e-01   +2.948012540633487e-01   +3.024278626136042e-01   -5.744205003414049e-02; -2.133574342549031e-02   +7.432013265498585e-02   +1.022455780396729e-01   +5.574351360940580e-01   +3.957769351918637e-01   +1.045024429027678e-01   +3.682013638330969e-01   -1.884472172516327e-01   +3.272019579535619e-01; +8.119806217288382e-02   -1.739439023515718e-01   +1.884414652664880e-01   +4.275905171553385e-01   +4.001285273278219e-01   +4.866972008751301e-01   +8.741431310365608e-02   +1.211837794965773e-01   +3.398576616744865e-02];
L1_L4_iGABA_netcon = [+1.335440169739953e-01   +4.108017393721995e-01   -6.965904016753083e-02   +2.996776811896215e-01   +1.964282462466368e-01   +1.234741327695797e-01   -1.231329903629251e-01   +2.492440861543944e-01   -5.422606558795180e-02; -1.268184686325089e-01   +3.180955409388774e-01   +4.370519664217548e-01   +3.926847967442106e-01   +4.760386715495843e-01   -1.595573462470139e-01   +2.059309104424913e-01   -1.935078961386963e-03   +2.004734390290868e-01; +6.073404344645010e-01   +4.888565924156572e-01   +3.388257469011907e-01   +6.060555123851206e-02   +3.917680726163765e-01   +1.606839227047825e-01   +6.703838200656498e-02   -8.321381227838487e-04   +2.253438431143435e-01; -7.585517331523636e-02   +9.909202177798658e-02   +3.020590892093948e-01   +2.060322713822006e-01   +3.554417910375434e-01   +2.496259722458638e-01   +3.435801210015982e-01   +1.328617386688629e-01   +5.376288908863006e-01; -1.972516658680744e-02   +2.991840862202000e-01   -1.731579926885955e-02   -3.416519324730555e-01   +2.880007063860051e-01   -5.599576323139691e-03   +6.475935336605630e-02   +2.243645230027127e-01   +1.691969810331292e-01; +2.660750892296052e-01   +9.618849765375226e-02   +4.836624390545274e-01   +2.168531334523929e-01   +2.422009237371419e-01   +1.776306531942476e-01   +5.423194463110702e-02   -6.658355007358401e-02   +1.649859438075993e-01; +3.221496361042191e-01   +2.555704250791096e-01   +4.828672472283699e-01   +4.191877633882792e-01   +2.734567281562380e-01   +7.526225783261301e-03   +4.354533141297911e-01   +2.268809084774741e-01   +1.530104057748032e-01; +3.828153662305400e-01   +3.783415198896444e-01   -8.381549401375579e-02   -8.000691715662971e-03   -1.946681552620622e-03   +6.497606407059300e-02   +3.999088441181532e-01   +2.155033993006059e-01   +2.185202689303538e-01; +5.584445255468054e-02   -2.590860207835888e-03   -7.855644517108344e-04   +2.379469765770004e-02   +4.471755649553298e-01   +9.948568111118428e-02   +1.503988846046271e-01   +4.897870123822015e-01   -1.872031312887257e-01; +6.483727947230140e-01   +3.483952243851309e-01   +1.895061689106775e-01   +2.336802502376931e-01   +3.289150665235430e-01   +3.025832097101598e-01   +3.627521118438234e-01   +6.537986676698690e-02   +7.215848417738681e-01; +1.949978453655982e-01   +1.960223534028111e-01   +4.261501867412067e-01   +3.172788997042070e-01   +2.740047384129668e-03   -9.092328199408031e-02   +1.931384505424780e-01   +6.350661586148185e-01   +1.958231523161654e-01; +5.329243452015754e-01   +1.556298250797613e-01   +3.335953517303321e-01   +5.681423837014770e-01   +1.812470904770635e-01   +3.164108214775010e-01   +3.528326580901370e-01   +4.191381985749505e-01   +4.921135026699391e-01];
L4_L1_iGABA_netcon = [+2.625426067940708e-01   +2.604642213698097e-02   -5.311487385016543e-02   -4.844222387984333e-02   +2.608060437897883e-01   +6.223680438226232e-01   +2.743354739001274e-01   +7.929499493119135e-02   +3.986422440100692e-01   +4.706296886610899e-01   +3.785701098790374e-01   +5.163405236821494e-01; +1.931199639968398e-02   +2.319288584567505e-01   -3.681585759533819e-02   +2.710792874317452e-01   -3.133779071755868e-01   +2.299730550164462e-01   +4.084822198297807e-01   +5.124201537081521e-02   -4.936146411790175e-02   +1.319036095617100e-01   +1.877513929847574e-01   +2.427233392872725e-01; +3.164976245044159e-01   -1.134702798852092e-01   -5.432268819517637e-02   -3.030689079723854e-02   +3.539793918865380e-01   +3.261329692788753e-01   +3.172343653678265e-01   +1.577110127699741e-01   +1.668157824728347e-02   -3.067294318375183e-02   -9.819642000117391e-02   +4.479977436660042e-01; +1.128902052324887e-01   +6.335375808989702e-02   +4.012577931732223e-01   +1.693303174186475e-01   +6.074052553111451e-01   +4.613925105085070e-02   +2.659518427468710e-01   +1.286130803914002e-01   +2.727108500180134e-01   +5.436463581361415e-01   +2.167528156342274e-01   +1.535856671150503e-01; +4.749793972886359e-01   +4.114625310753053e-01   +3.881600298400417e-01   +2.764653995108169e-01   +4.112788658086861e-01   -1.055566446548068e-02   +1.552459763939952e-02   +1.539527492640181e-01   -1.392398312639871e-01   +6.439973058055073e-01   +1.171139671509097e-01   +2.622591277705664e-01; +5.675253021395593e-01   +9.313113818651725e-02   -2.248752553398877e-02   +3.666268232484720e-01   -5.878325728121327e-02   +2.984787191062384e-01   +8.475805735427988e-02   +1.619101399697181e-01   +2.622038574297819e-01   +2.455392085736367e-01   -2.992689226237693e-02   -1.454765180799120e-01; +6.549115911073371e-03   +1.654820755598488e-01   +4.418573433674610e-01   +1.905726843765629e-01   -8.584064161723451e-02   +3.808383216822079e-01   +8.816034301679893e-03   +1.401219038333462e-01   +1.392654933643204e-01   +4.745218555142637e-01   +6.015261343936631e-02   +2.284701328438723e-01; +2.702922533044442e-01   +4.771629885627765e-04   +4.087159681959217e-01   +3.495943702540038e-01   +1.780863662032354e-01   +1.905588529456670e-01   +3.839112249524463e-01   +7.328775631498329e-01   +1.871062642723439e-01   +1.060659601151085e-01   +3.599974118342045e-02   +7.577472156009764e-02; +6.746795936478518e-01   +4.202361365879775e-01   +5.084156514914592e-01   -5.166914473242129e-02   +5.905411858178942e-01   -5.767834573888636e-02   -4.498291343565275e-03   +5.898745620916196e-02   +4.798344587282521e-01   -1.167772165204643e-01   +1.289918049953686e-01   +6.712381431653963e-02];
L1_L3_iAMPA_netcon = [-3.541467055355554e-02   +1.765596622341890e-01   +2.308473380266286e-01   +4.497403012916832e-01   +3.954523572067690e-02   +3.264412777649363e-01   +5.425946478625956e-01   +1.042320858358372e-01   +3.320026761422462e-01; +5.086268952518046e-01   +4.965679331202577e-01   +2.467712635691305e-01   +6.252372568906477e-01   +2.390260453968162e-01   +2.314073936653599e-01   +2.832323884433704e-01   +2.051456979959166e-01   +4.424770685990063e-01; +5.295835528136837e-01   +1.691055778002232e-01   +2.316493973242728e-01   +1.010567431215464e-01   -2.470401043821305e-02   +1.285926966546816e-01   +4.937447549721516e-01   +4.408638071539804e-01   +2.090852824127883e-01; +4.556257764746984e-01   -2.042180833685195e-01   +2.209383334460535e-01   -9.480993271443530e-02   +6.118270811020157e-02   +3.525463998873386e-01   -1.447313521075085e-01   +2.922103309554095e-01   +3.272772755971488e-01; +8.560980489461405e-02   +4.616410016333132e-01   -3.258795876467643e-03   -2.207803736143426e-01   -2.608377493546145e-01   +8.697632450710591e-02   +4.455299123604682e-01   +3.440581583621288e-03   +2.308845793995729e-01; +2.590592273015478e-01   +3.468280809325894e-01   +2.248212915253041e-01   +3.471195016496259e-01   +1.865617433557905e-02   +1.895405182749319e-01   +1.562041763251902e-02   -5.996916258100780e-02   +3.565263134354287e-01];
L3_L1_iGABA_netcon = [+4.880863114175877e-01   +1.547007377246899e-01   +1.317649647666513e-01   -9.981650202420481e-03   +1.868287475852686e-01   -2.432495040271569e-02; +4.042913804322707e-01   +2.888269107187998e-01   +4.940327205195499e-01   +3.302830954475089e-01   -1.362916456768140e-01   +2.262257586484213e-01; +2.633727059962663e-01   +4.518084092609763e-01   -4.547703717535037e-02   +1.526977506185052e-01   +2.109787698893870e-01   +1.727493633560164e-01; +1.488654834657622e-01   +7.617127039455687e-02   +2.236549057309775e-01   +1.534302828372755e-01   +5.088256331732243e-01   +4.274400214250871e-01; -5.690031785023838e-02   -2.649766375983847e-02   +3.634028464966413e-01   +1.808853758545207e-01   +3.308769561027777e-01   +1.174624900725698e-01; +8.864875919101051e-02   +2.925575410080093e-01   +1.443368442819581e-01   +1.785096266478946e-01   +7.054016013097282e-02   +3.120467568293206e-01; +1.851532510369472e-02   +4.509994489549583e-02   +1.417174745015800e-01   -4.410442272385218e-02   +1.693365866096533e-01   +4.847853064141809e-01; +6.720683808447708e-02   +3.203417425762800e-01   +3.049972877231966e-01   +4.430677096093781e-01   +1.122297168793182e-02   +1.055321297775920e-01; +2.644608791133596e-01   +3.877774522696059e-02   +1.168791998570292e-01   +2.923181291643786e-01   +1.296073917251150e-01   -1.088903767821845e-01];
L5_Input1_iAMPA_netcon = [+3.925009765022075e-01   -2.359218118120713e-02   -1.032229655326857e-01   +3.772933352002311e-02   +3.464940699353747e-01   +7.847021940046188e-02];
L6_Input2_iAMPA_netcon = [+1.759335620011214e-01   +1.413035848773028e-02   +1.499168272021113e-01   +4.183221099957088e-02   +3.286878881489880e-01   -3.398918238956887e-02];
L5_L6_iAMPA_netcon = [+3.230478398999649e-01   +3.247653528405717e-01   +8.557322324503142e-02   +1.446682166521313e-01   +2.856564384623065e-01   +5.091339476005468e-01; +2.985172888610125e-01   +3.616675744910799e-01   +5.822238280940472e-02   -1.822804615824888e-01   +2.743927226756259e-01   +2.696311239375333e-01; +1.983513637114229e-01   +2.783539619139916e-01   -2.491338047612872e-01   +6.384553243035562e-01   +1.860497766693519e-01   +5.864148507257588e-01; +2.687903681948897e-01   +4.011431731595467e-01   +4.913834809301750e-01   +5.483137045677962e-01   +1.004850436081324e-02   +1.390010997273592e-01; +1.364072074541305e-01   +1.447423663833207e-01   +4.146994280463188e-01   -2.719542413793834e-02   +1.313365594823950e-02   +2.524221203405932e-01; +4.278501331349315e-01   +4.688843082625166e-02   +2.341861663158147e-01   +3.120170659231533e-02   +2.186152933764040e-01   +2.782498536409903e-01];
L4_L5_iAMPA_netcon = [+3.927986325683348e-01   +3.640112043528294e-01   +4.994423127995076e-01   +3.480361797950898e-01   +3.168030503375925e-01   +9.049375848981170e-02   +3.052294984498988e-01   +4.901525557719695e-01   +1.170102084530207e-01   +3.059674354031029e-01   -1.587222861222274e-01   +3.197582135723477e-01; +5.135663008068037e-01   +4.060081072199586e-01   +1.971135338138257e-01   +2.155703540135165e-01   +3.099719078115603e-01   +3.994202708366161e-01   +3.954081686152573e-01   +4.073354400388917e-01   +7.823208817661270e-02   +6.769022568658877e-01   +1.873115475126857e-01   +1.341737470871638e-01; +3.260317032793708e-01   -1.162773619745830e-01   +3.269239971366845e-01   +5.619592541988448e-01   +1.381636995073230e-01   +2.245654241191485e-01   -1.182821732170620e-01   +6.377436814804376e-02   +3.145826078501126e-01   +1.196057167528318e-01   +4.491201033949536e-01   +2.782550957010533e-01; +2.320503929759699e-01   -1.906840379811815e-01   +4.867221188129309e-01   +5.732605206067562e-02   +3.228906812952055e-01   +1.831905622509034e-01   +2.588180090336074e-01   +3.526022153480334e-01   +1.194301725746355e-01   +4.200330141722761e-03   -3.677624149814750e-02   +4.139294274639270e-01; +1.207434652317677e-01   +3.980083160013032e-01   +1.549940117045840e-01   -2.102655286388876e-01   +3.914613700970401e-01   +5.294103299578905e-01   +1.329762061173545e-01   +4.465175639329481e-01   +7.116469171172514e-02   +3.931842473126825e-01   +8.182864040162437e-02   +6.099842214475959e-01; -1.856595706219773e-01   +8.301968856634920e-02   +2.480583020773232e-01   +3.129790664467212e-01   +8.709061827663765e-02   +5.628464792966577e-01   +7.984028587594574e-03   +1.328497453925740e-01   -2.560390494346684e-03   +2.867297230640740e-01   +4.366335523756066e-01   +8.387884697210832e-02];
L6_L4_iAMPA_netcon = [+3.453902799047054e-01   +1.736063178263651e-01   -1.382670947523580e-01   +4.057556002815075e-01   +4.476944492290951e-01   +2.652615428259490e-01; +3.040600443528254e-01   -2.290144520630139e-02   -9.834768163271392e-02   +2.592115302679120e-01   +2.268938484591774e-01   +2.277935192049970e-01; +2.561312459163321e-01   +1.925842743368120e-01   +2.501231498506846e-01   +3.290506800244250e-02   +1.585282764576108e-01   +3.761108557898203e-01; +3.780391829773828e-01   +2.435688968070979e-01   +6.927493274969914e-01   +4.461337939417430e-01   +1.124571795744899e-01   +4.771637707162433e-01; +1.733126622580160e-01   -3.464349152398367e-02   +4.858211764659253e-01   +1.028309157685588e-01   +4.098561623911233e-01   +2.668696555103474e-02; +2.201708703479975e-01   +2.747224543130414e-01   +4.850881990854399e-01   +4.973836443847336e-01   +2.300458663264262e-01   +4.072800184446621e-01; +1.936067459350160e-01   +4.522754995881099e-01   +3.349152362006799e-01   +3.022674410924256e-01   +1.615518311498320e-01   +2.244174594174250e-01; -1.185843727028703e-01   +3.141401786770288e-01   -3.048036666841264e-02   -1.056303915068387e-01   +1.124700786831970e-01   -1.100262571880741e-01; +3.583719996722925e-01   -5.994371682241235e-02   +3.886288078853062e-01   +1.122096175761855e-01   +4.628023583168420e-02   +1.088429809461742e-01; +1.943722114824930e-01   +1.206368170019882e-01   +6.028323959353359e-01   +8.161696057209316e-01   +7.266606519523747e-01   +1.778660151668437e-01; +6.379058015952078e-01   +8.153367383022488e-02   +3.682462650011970e-01   -6.030084290653009e-02   +2.441592854555887e-01   +1.998424091964968e-01; +5.603694772073811e-01   +3.360475861249775e-01   +1.629281176370537e-01   +5.431169140524821e-01   +1.289500780676250e-01   +1.130940192306710e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
