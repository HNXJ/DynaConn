function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.736697515897704e-02   +1.044762298969970e-02   +2.103096056174853e-03   -2.275807085215863e-02   -3.504816484801365e-02   -9.165448442178328e-04   -1.490165596746621e-02   -6.020854924005465e-03   +1.978191413650254e-03; +3.201081143392466e-02   -4.782008889790546e-02   -4.540298052902410e-03   +4.234867079073167e-02   -4.709439082287868e-02   +1.443024553175643e-02   +1.922812674702141e-03   -1.851296245623054e-02   +3.171779287038140e-02; +6.011863312052857e-03   -7.243091344780059e-02   -3.188382305619002e-02   +3.553601489519495e-02   +2.882236691571426e-02   +1.389748730935859e-02   -4.202784447452296e-02   -2.591738280733473e-02   +2.728379381042254e-02; +2.335367903079231e-02   -4.875701720512529e-02   -2.688798527964313e-02   +8.339645988303848e-02   +2.318465713102347e-02   -4.303255053992747e-02   +2.484159262071316e-02   +2.175984904118812e-02   +1.928063037453581e-02; -5.881409410705223e-02   -1.449539460987935e-02   -5.479512706969216e-02   -1.176549953859195e-02   +3.023223581227557e-02   -6.204899245029111e-02   +3.681324528549581e-02   -4.877238861945265e-02   -5.890831882218601e-02; -6.095752125947676e-02   -1.699873000713223e-02   -5.129185251144629e-02   +1.662542490884941e-02   -2.253005614372875e-02   -4.484757887518187e-02   +5.873361962967240e-02   -5.378362023031787e-02   +1.103530490056305e-02; +3.698856218374877e-02   +9.119864371897238e-02   +1.076754595768373e-02   -4.732011915396917e-03   +5.406711335831216e-02   +1.371409756959034e-02   -6.762218359354613e-02   -4.116748952292911e-02   +3.939132999855714e-02; -1.999596945512246e-02   +4.125570953727303e-02   +1.938378989687957e-02   +7.817337777376851e-03   +9.687487194793457e-03   +4.788270710607433e-02   -1.882451493245223e-02   -6.246741856434484e-02   +4.175307856580549e-03; +2.653935556123465e-03   +3.124580663333121e-02   +8.781815614444525e-03   -5.070882939880338e-02   -4.485163868842796e-02   +9.395742457826012e-05   -1.310338561012243e-02   -8.064285043755752e-03   -7.404415105262599e-02];
L1_L2_iAMPA_netcon = [-5.789277594028122e-02   +1.771503739970406e-02   +2.915080346914901e-02   -6.998672422915436e-02   +1.357514307596759e-02   -8.066159967815834e-02   -2.508628864164191e-02   +3.465731329430633e-02   -8.095977115390273e-03; -1.383497111431396e-03   -4.972368823758556e-03   +3.347424980409873e-02   +9.602143102439618e-03   +6.220332340564684e-03   -4.999772271509619e-02   +4.150374717793969e-03   +3.010204051019323e-02   +6.834824491121870e-03; +2.271639576748405e-02   +5.373220810586282e-02   -1.904894017996829e-02   -5.362365666032696e-03   -2.983452847827744e-02   -8.695335864081666e-02   +2.504925834578672e-03   +1.845436069474530e-02   -4.104021133712810e-02; +2.839334085459025e-02   +6.520632024631125e-02   +8.843728801646432e-03   +4.194068552159902e-02   -2.457001478395185e-03   -1.964884928434253e-02   +2.782260250949801e-02   +1.333581878634138e-02   +8.033594317207451e-03; +5.595552344899316e-02   +1.304167325417030e-02   +3.391005468420964e-03   +2.243762306201350e-02   -1.838125198793876e-02   +4.497528755727997e-02   +5.964713615642449e-02   +4.217145844692549e-03   +2.403045079272612e-02; +1.709348398914376e-03   +3.644318967846786e-02   -1.217940948518870e-03   -1.729130824439583e-02   +2.080390099941167e-02   +2.923074345443861e-02   +1.753820795263869e-02   +1.569941137557461e-02   +1.745941641355423e-02; +1.972084318326463e-02   +3.341118643969440e-02   +5.557630550805862e-02   -7.395714767900138e-02   +5.134831156676935e-02   -9.492071113781453e-03   +6.215729161329370e-03   +3.602659172112110e-02   +3.930143233815402e-02; -2.920955267827395e-02   +9.350440905355074e-03   -5.208486692375631e-02   +6.729979098128061e-02   +1.057913544203728e-02   +6.381862779875078e-02   -2.432753661383480e-02   -4.955833379932679e-03   -3.261701121133823e-02; +7.515559814024131e-03   +4.913695600468400e-02   +4.746726367891353e-03   -2.614432231161859e-02   +2.925244174751607e-02   -3.120404713074783e-02   -1.544007454788870e-03   -2.018965831974481e-02   +5.639183803282467e-02];
L2_L5_iAMPA_netcon = [+5.847740493815835e-02   -1.812146260745965e-02   -1.743539453095151e-02   +6.080686077313264e-02   +1.421875902239006e-02   -1.717237802839926e-03   +2.172650467421549e-02   -5.718450731001780e-03   +1.153125136009587e-02; +5.065734513269044e-02   +3.592162582336990e-02   +5.978518668832672e-02   +8.488256416270473e-02   -2.985943927008938e-02   +4.524345168198496e-02   +6.386134108856739e-02   +6.195905708839693e-03   +3.631293368914802e-02; -3.720016354843495e-02   +3.906998614314065e-02   +5.431960134907281e-02   +4.079928999317371e-02   -3.539057055199583e-02   +4.593084713065667e-02   -2.692837514306830e-02   -1.434094145553518e-02   -4.013323234766943e-03; +2.459150343857388e-02   +2.837060801116004e-02   -7.620040547604058e-02   +8.162660782397649e-02   +1.397046312709682e-02   +1.251884273012584e-02   +5.836670830355457e-02   -6.952423272368880e-03   -2.553138899361119e-02; +2.171646676046944e-02   +5.799871307256253e-02   +3.844955609435180e-03   -6.266592726734763e-02   -3.759013536893108e-02   +7.729127941938125e-03   +8.735396604418376e-03   +4.024864508104833e-02   -2.402996181516156e-02; -4.323003089639473e-02   -6.433090443223116e-02   +4.377750456057321e-02   +5.476927218608388e-03   -4.905911347485917e-02   +3.588915450920921e-02   +1.119250941473491e-02   +3.389825066720595e-02   -2.150822110615923e-02];
L5_L2_iGABA_netcon = [+2.107471561317975e-02   -1.661618504198615e-02   -2.446765822124082e-02   -3.880623840282638e-02   +3.688382400903179e-02   -1.102028047379591e-01; +2.038826827211079e-02   -5.715746817648330e-02   -8.191022870070119e-02   +6.771249731324572e-02   -4.535715524384575e-03   -1.253097145844517e-02; +1.059618468975518e-02   +2.183629394065145e-03   +3.681695268054872e-02   -2.549103902367121e-02   +6.249367377694141e-02   -5.299045681942516e-02; -1.881645710567569e-02   -3.076403547677210e-02   +2.213649094059554e-02   +3.736749218871205e-02   -8.825163950092328e-03   -1.144512154657914e-02; -1.655886875939456e-02   +2.988804234253385e-02   +6.310402225475206e-02   +3.948697745454997e-02   +2.840932134709980e-03   +1.674915949981652e-02; +3.107878489736392e-03   +3.834293237999107e-02   +1.548090100781901e-02   -1.474924130042171e-02   +2.184765766216354e-02   -9.725967532384450e-02; -7.369265192278585e-02   +6.167164549520220e-02   -2.535402332184965e-02   +2.125074755438380e-02   -1.390159574142356e-02   +2.016431547939856e-02; -2.297257296657148e-02   -5.466118916599438e-03   +6.180201802483254e-02   -2.565007148214749e-02   -5.260847712294681e-02   -4.643066189409432e-02; +4.412614556599410e-02   +4.095370478850800e-02   +2.060304093412549e-02   -4.032571613326455e-02   -5.336877001239734e-03   +7.260544434085348e-02];
L3_L2_iAMPA_netcon = [-1.323978498268488e-02   -8.618101247544291e-02   +2.333372671033733e-02   -4.923151138949688e-02   -9.276322451287790e-03   -4.086856321935134e-02; -1.546546823192448e-02   +1.543441554166432e-02   -1.168754038095703e-02   +5.669937148047161e-02   -4.682586285977888e-02   +3.003885046635637e-02; -6.221817519360476e-04   -5.190744450034768e-02   -4.200297802199941e-02   -8.768832535452180e-03   -7.167812705743650e-03   +4.422833880183283e-02; +2.874665935671792e-02   +5.942782372437574e-03   -1.808322486624669e-02   -1.716772218286616e-03   -5.237298350050664e-02   -1.121295428387729e-02; -6.678855118132615e-02   -1.086539601520822e-02   +3.536600155619757e-02   +3.740133016902598e-02   -6.268097345306996e-02   -4.311308245137813e-02; +5.603798470293399e-02   +2.567359701347427e-02   -2.481005439269237e-02   -7.747173621286865e-03   -7.995215622286670e-03   -5.717044376828313e-02; -3.717521876138127e-02   -3.072154546949830e-02   +7.096703506833560e-02   -8.050728635781563e-03   -1.003939073774466e-02   +8.398157034245119e-03; -7.505206881614372e-03   +6.742891974556166e-02   -4.098873552469012e-02   +1.386746903904295e-02   +5.291016285972083e-03   +7.502696417429258e-02; -2.685917721258384e-02   -1.771370613442595e-02   -9.906643617938211e-03   +3.627806141399921e-02   -3.092839011586943e-02   -1.628431146764805e-02];
L2_L3_iGABA_netcon = [+4.619806230669408e-02   +8.163971715814138e-03   -1.472933008340842e-02   +4.125539420091243e-02   +6.891668831268280e-02   +1.803110458548483e-02   +1.844930543236394e-02   -1.980197537641408e-02   +8.068163698563755e-03; +9.954331553378382e-03   -1.671932855048200e-03   +3.644310376074872e-02   -1.922925361762371e-02   +8.552841610952107e-03   +1.289750631910466e-02   -4.238781794460370e-03   +6.456473449665705e-02   +2.642340986020666e-02; +3.401307695585232e-02   -2.422349186888322e-03   -1.628782982260650e-02   -3.254737123596530e-02   -1.884976901019548e-02   -4.776978678329252e-03   +2.006028085226553e-02   +9.686923695781204e-03   -3.744750166276144e-03; -7.276651610769752e-02   -1.020900212149286e-01   +1.861867844529719e-02   -2.815547147559205e-02   +2.486040717872485e-02   -7.966463251933595e-02   +2.190326717337951e-02   +4.975947687429352e-02   -1.289253830586215e-02; -2.507428335749739e-02   +4.164648351187690e-02   +6.588800742645701e-03   +1.383823195765845e-03   -3.330688921701550e-02   -3.650919394708626e-02   +7.714454465612343e-03   +3.144154961910912e-03   +9.823213735893539e-02; -5.343899301948919e-02   +2.087516157212865e-02   +5.939291467268112e-02   -2.599379767754483e-02   -1.490554123771468e-02   -2.868241022821661e-02   -1.481808276328384e-02   +3.701270225194048e-02   -4.428436069128084e-03];
L1_L4_iGABA_netcon = [+5.112449399220041e-02   -5.234603019033300e-02   -2.481687648302960e-02   +2.212311032664745e-02   -1.592162170239971e-02   +4.568856908434722e-03   +2.607243339785666e-02   -5.842635948108427e-02   +2.178230931549100e-02; +1.549303566123937e-02   -2.488276484875944e-02   +1.306112831306019e-02   -2.110955615110574e-02   +9.790172675676242e-02   +2.026563364902392e-03   +6.213194970913752e-02   +1.109297592438588e-02   +1.137089196657482e-02; -6.462776521704232e-03   +4.006814918085683e-02   +4.361245389229812e-02   -9.532283323980971e-03   +2.124938525682449e-03   -3.911105376877074e-02   +5.397476080582020e-02   +5.173604853686904e-03   -3.140142188261353e-03; +4.999855000671522e-02   +3.363807404474882e-02   -9.199030248954500e-04   +5.790560823817591e-02   +3.021363380831757e-02   -7.236242535276993e-03   -9.235397983192587e-03   +3.695114996777429e-02   +3.887992074816688e-02; -3.091071412934319e-02   +6.544581063379389e-03   -2.091712538962641e-02   -2.013108423066207e-02   +2.598705338704545e-02   +4.505101561607731e-02   +4.594567948403840e-02   +3.285195141143376e-02   +5.004883512669447e-03; -4.364583948518805e-03   +5.380522687319644e-04   -3.680074627891611e-02   +9.710173464697993e-03   -8.051563954387456e-03   -3.205264479919406e-02   -5.275423656394586e-02   +6.366656807183307e-02   +3.205982446617189e-02; -1.220512425226167e-02   -1.793334319322704e-02   -1.571511341808230e-02   +4.348905610241807e-02   +8.212348781427563e-03   -1.451616322023133e-02   -2.492290565172467e-03   -1.952566988609068e-02   -1.585972039605882e-02; +2.300914383898003e-02   +7.474961574506525e-02   +5.503648428131690e-02   -8.094962046984667e-03   +2.108946267451568e-02   -4.137778522490638e-02   -1.997498389131212e-03   -1.959576082223101e-02   -1.838296105228571e-02; -1.291956401589009e-02   -4.141188331850058e-03   +2.077583286595661e-02   -7.452886625514186e-03   -5.765173341871585e-02   -2.362367748350202e-02   +2.909222149088612e-02   +2.076046575374168e-02   -1.763357187601658e-02; -6.544309731527725e-02   +8.852174149144042e-03   +3.466805024782636e-02   +4.907153233795347e-02   +1.442829457161756e-02   -1.126352275401659e-02   +1.904190098347862e-02   +3.410864581325393e-02   -4.122108511977374e-02; -3.373239593153569e-02   +1.547350579693053e-02   +2.897792280941361e-02   +2.644223754965866e-02   -1.575490199891766e-02   +5.825268843263295e-02   +6.449247195453404e-02   +3.067478468198399e-02   +3.760319106242042e-02; +6.204866907793809e-02   -2.877305574970509e-02   -9.411507800638694e-03   -1.218936208391112e-02   +4.639006414443045e-02   +3.575208114692160e-02   +3.117913615509616e-02   -7.455902072715589e-02   +5.934893859663125e-02];
L4_L1_iGABA_netcon = [-2.574139620868929e-03   -7.781065319757521e-02   -8.648356404197741e-04   +4.304771840488378e-02   +5.562820832281068e-02   +4.784320117947265e-02   +3.870729427827313e-02   -6.525964099118393e-02   -1.653753144294363e-02   +8.589267705792568e-03   -4.219386187983225e-02   -4.900067621409925e-04; -2.882044090805983e-02   -7.348558350876389e-02   +6.151971908234254e-02   -2.108679075244741e-02   +7.163775533104462e-03   -4.997605849341306e-02   +7.104685120222359e-02   -7.759334219094693e-03   +3.882011176536254e-02   +3.306610846192359e-02   +2.534639373980913e-02   +3.331736493768898e-02; -7.741916425335105e-03   -3.183434875556293e-02   +2.855951286234548e-02   +4.051954041356568e-02   +3.750714417468734e-02   +3.530247569650569e-02   -1.094258947966914e-03   -3.212532076515714e-02   +3.532980525848683e-02   -7.129946352414335e-03   -4.200111347785828e-02   +2.964142334359987e-02; -3.782442550133058e-02   +9.111411512652193e-02   -3.413795802256151e-02   -3.320343434817851e-02   -3.269533288758493e-02   -3.587747758630708e-02   -7.475184934873390e-02   -2.156897598882120e-02   +3.321723105224675e-03   +3.551858151468241e-02   +1.687532172950196e-02   +7.074063005211362e-02; -3.476240712904802e-02   +3.738584783040479e-02   +8.732640089236972e-04   +3.754921005632395e-02   -4.244336498602892e-02   -3.235005959131266e-02   +3.774203599910516e-02   -3.489303127664406e-02   +5.200905462168349e-02   -3.788866457014867e-02   +1.299791563788220e-02   -7.136279184557226e-04; +2.312106232147079e-02   +4.511195940193880e-02   +1.825250785763620e-03   +5.141421823211950e-02   -6.267718563967564e-03   -3.495074724804818e-02   -5.373652639852571e-02   -1.976473891972311e-03   -3.108904639820112e-02   +7.013519723115916e-02   -3.938059484697021e-02   +4.140857878366183e-03; +3.561283151291110e-02   +6.802168671696626e-03   -3.540165904156814e-02   +1.144336929862470e-02   +3.516626347642990e-02   +2.368822465959110e-02   +5.897481381462902e-02   -2.477104874528779e-02   +4.886310699187645e-02   +5.713969669800213e-02   -2.350504580409014e-02   +6.961058387174715e-02; +4.851588363679368e-02   +2.314832384630174e-02   -3.475672635921353e-02   -2.582014214458413e-02   -1.468508503189556e-02   +4.686486184453745e-02   +2.233589879376077e-02   -1.870575907643031e-02   -5.724381983981790e-02   +2.216758424588253e-02   -2.510380227642677e-02   +2.554724852866696e-02; -3.164157038963069e-02   -1.282931971321684e-02   +7.161575220753914e-02   -4.730677186173569e-03   -1.254691198421764e-03   +1.111931164041305e-02   +6.581356391602246e-02   +1.059524129597057e-02   +1.703705239482864e-02   +3.901108995775259e-02   +2.052356385988163e-02   +8.880505804358918e-03];
L1_L3_iAMPA_netcon = [+2.544080789109954e-02   +3.539900230167568e-02   +3.800739288839276e-02   -6.299132498849838e-02   +8.565327160447700e-03   +1.308699401602906e-02   +9.136955880931139e-03   +2.977257446729359e-02   -1.652298810767554e-02; +6.416655534834347e-02   -9.664878088652434e-02   +3.863815566861801e-02   +2.649404034230635e-02   +3.537353076777086e-02   -2.057875037454640e-02   -1.844640362161136e-03   +2.894479367163792e-03   -2.640830265267810e-02; +1.083293225848493e-02   -1.352887406198870e-02   +5.516615679490524e-02   +1.889079692636079e-03   -4.535950718271834e-02   -5.866456253115451e-02   -6.183496218187121e-03   +7.246495859372316e-02   +4.128292357861395e-02; +4.000395898730867e-02   -1.109846230727254e-03   +9.408172180425599e-03   -7.537827453451366e-02   -5.745559015236949e-02   -4.639612212567652e-04   +6.074725986859299e-02   -1.479879120928316e-02   +6.195280644977305e-03; +9.313601199412276e-03   -1.888172398683717e-02   -7.019034468414162e-03   +1.933619862251703e-02   +7.013238958999679e-02   +5.704129363890802e-03   +6.105919770542781e-02   -6.321942125581247e-02   +3.028517709142560e-02; +2.746344038315632e-02   +2.908762031497001e-02   +4.853686449195393e-02   -2.852397248906123e-02   -1.991285403590447e-02   +1.033332359638511e-03   -4.878913957714154e-02   +4.212565376076382e-04   -9.747602405770779e-03];
L3_L1_iGABA_netcon = [+4.803020300207957e-02   +1.033409263058435e-02   +1.660177611526695e-02   +1.408639059769617e-02   -4.870697672430973e-02   +2.764330455620400e-02; +6.810561148746015e-03   +1.439284807221349e-02   -6.744361712318939e-02   +1.985517934697064e-02   +1.159282262488683e-01   -7.504381511963549e-04; +1.096485960226033e-02   +8.341539019756502e-03   +1.908716223710780e-02   +4.730245224414497e-02   -9.146106998878339e-03   +4.794435205275134e-02; -4.757797487243549e-03   -3.969487576791136e-02   -5.155359709549785e-03   +5.241642123170372e-02   +3.206760459085462e-02   +2.248212293891911e-02; +2.272556030320405e-02   +2.375379948447367e-02   +3.642309149242157e-02   +4.511385581566718e-02   -3.162336011762598e-02   -1.084133961632877e-02; +6.339858482160163e-03   -4.509473120981713e-02   +6.562033658371691e-02   +4.800574345213388e-02   -4.092096936933714e-02   +9.430785706136226e-02; -3.028099722384089e-02   +2.865413034895211e-02   +2.640276831348571e-02   +7.306772214483753e-03   -4.942893886765085e-03   -3.788735859392400e-02; +3.230282001920456e-02   -7.676669494481850e-02   -3.658444498695575e-02   -3.772994973946811e-02   +7.740437866913100e-03   -3.151066894824377e-02; -2.149388671291158e-02   +4.355715171772696e-02   -5.182367570028211e-02   -1.587976519357120e-02   +2.889724059338794e-02   +2.889281813782230e-03];
L5_Input1_iAMPA_netcon = [-4.725915407328956e-02   +3.910729636692537e-02   +5.024488061837488e-02   -1.970264107828842e-02   +1.966599287971799e-02   +3.110061516837292e-02];
L6_Input2_iAMPA_netcon = [-2.688717128310855e-03   +3.826912223853671e-02   -6.699358035021630e-02   +1.845222709606077e-03   +3.376819279992632e-02   -8.530933775217682e-02];
L5_L6_iAMPA_netcon = [+3.663595885932820e-02   +6.445050049571124e-03   +3.695810443419556e-02   +5.142364512148774e-02   -2.007185574460268e-02   +2.357452952707571e-02; -4.471370424477046e-02   +1.093821885867067e-02   +1.778509607514945e-02   +4.341589560466148e-02   -1.793997878816227e-02   +1.357696834750047e-02; +2.680562308381000e-02   +1.644825440500651e-02   -2.137616808916876e-02   +4.181821436960624e-02   +4.808840785355364e-02   +4.363141379794513e-02; -1.602020835813664e-02   +3.077947833947075e-02   +5.437136673571682e-02   -2.401331729956329e-02   -2.446315344704732e-02   +6.555801262840094e-03; +4.356022693658990e-02   +2.811167374223225e-02   +1.634793488315889e-02   +4.408761545022891e-02   +5.693462255666853e-02   -1.623467835659748e-02; +2.352470788490589e-02   +5.909166919022865e-02   +1.156882647356699e-02   +1.781747046953704e-02   -8.021103825572271e-02   +2.319884573497998e-02];
L4_L5_iAMPA_netcon = [+4.096371161578739e-02   +9.830319576345463e-03   -5.867460350232065e-02   -4.152846165081991e-02   -2.497494552529188e-03   -2.539255439079859e-02   +2.710033358449533e-02   +3.745091623108262e-02   +5.066120140571546e-02   +5.155625540277047e-02   +2.044725272484212e-02   -1.406460476052504e-02; +4.780304633859644e-03   -4.157775420943902e-02   -6.318548123608013e-02   -2.165639938054153e-03   +4.874249387075721e-02   -1.575895399599243e-02   +4.402600648189042e-02   +1.310767130310641e-02   +2.786870947988740e-02   -4.289016814275798e-03   +9.048304594158181e-03   -5.609405948694454e-03; -2.951154313716633e-02   -7.152584583266706e-03   +8.622552703156519e-02   +2.756655182976836e-02   -4.510315900365824e-03   +5.868188005934293e-02   -6.969787330331583e-03   +3.772687208873261e-02   +2.875888703721174e-02   +3.423912449140264e-02   -4.764671760609025e-03   -2.782102280845395e-02; -3.126743587060116e-02   -3.032401537551186e-03   +1.384086399127806e-02   -1.103838901488403e-02   -2.762355222912675e-02   +1.756211617449267e-02   +5.842977204131851e-03   -5.287542019056310e-02   -2.826455589240091e-02   +1.669998911392073e-02   -3.639852284596466e-02   -3.901554343872503e-02; -2.938686408802261e-02   +6.589516537075221e-02   +7.607303423281156e-02   +3.012051040006881e-02   +5.095801262272012e-02   -5.131009793071761e-02   -7.017358843234023e-02   -1.601950637625750e-02   -3.793954036909943e-02   +1.291751350790695e-02   +2.577174640289796e-02   +3.812394872557362e-02; -2.719781733720729e-02   -1.085355251180868e-02   -3.577164118204966e-02   -1.020732471267072e-02   -3.596310384159885e-02   +1.125624350157014e-01   -1.114276458536387e-04   -1.468575765559294e-02   -1.085288071278408e-02   +2.854055342084233e-02   +1.721286161643868e-02   -6.366673048558932e-02];
L6_L4_iAMPA_netcon = [-1.987970466347454e-03   -6.622687444096986e-02   -9.733748467204123e-03   +4.556022227465973e-03   -7.103349815125914e-02   +3.862913232771181e-02; -2.565813046901382e-03   -4.238513121326857e-02   -3.912429987212645e-02   -1.913846440064872e-02   -5.128725638865685e-02   -4.138196182867131e-02; +3.218283106950766e-02   +5.697238210278206e-02   -5.181167553448075e-02   -4.480323208944791e-02   +3.082726524570599e-02   -2.378348118844479e-02; -8.813472422184525e-02   -2.041380142638348e-02   -3.608700705112343e-02   +1.146992623392359e-02   +2.049270886006892e-02   -6.712870831128639e-02; -4.740606205730828e-03   +5.663940188762208e-02   +4.062269682893853e-02   -7.526991212447910e-02   +8.516569965944287e-02   +7.652439920023257e-02; -9.643613796025187e-03   +6.324735776210844e-02   -2.443698556584761e-02   +4.529060545758523e-02   +3.050018849930110e-02   +2.677245750419046e-02; +1.408269364792251e-02   +3.425975739748434e-03   +2.343364314091014e-02   -4.638157086022746e-02   +1.103476940673261e-01   +8.897113018889841e-02; -1.236003302350040e-02   -1.564062046110287e-02   -2.682093566786097e-02   +1.383306927711742e-02   +1.946417302006643e-04   -3.001126441579078e-02; -2.344393146609388e-02   +1.588913837545333e-03   -2.474218064396388e-02   -9.892465979855693e-03   +4.573214638331734e-02   +3.660611442631120e-03; +4.211203620029018e-03   +7.322661486154461e-02   +2.129591635029220e-02   -5.817045122387288e-03   -2.120087183572278e-02   -4.981128853735466e-02; +6.147813725838894e-03   +1.596544024644852e-02   +5.620750038398088e-02   +4.811041657992278e-02   -2.432571488703018e-02   +2.783797673470734e-02; +3.706006918663213e-03   -4.307342416796589e-03   -6.394508762696059e-02   +1.005079450254162e-02   -3.147200134143559e-02   -2.348462872510635e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
