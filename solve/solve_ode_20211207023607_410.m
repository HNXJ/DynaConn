function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.757035306925257e-03   +3.492276571024730e-02   +1.833534894875227e-02   +3.488650410254503e-02   -3.503729471527257e-03   +2.750747883645238e-02   +3.750159428489282e-02   +4.830519848929424e-02   +2.694329242121616e-02; -3.866901464056728e-03   +2.054543919328395e-02   -1.829269232345272e-02   +3.506495726720592e-02   +2.936680733685759e-02   +1.797923774258172e-02   +1.173791946112406e-02   +3.384829434358427e-03   +7.478919617578531e-03; +2.943653848611183e-03   +1.680836241168504e-02   +3.184316550429368e-02   +9.349636239111038e-04   -1.405349056606744e-02   +2.533695907849892e-02   +4.882231240800094e-02   +1.865508998973223e-02   +1.381755531524235e-02; +2.801948104614680e-02   -1.358133334986360e-03   +2.734336482292510e-02   -3.262500266853693e-04   -1.645378558220396e-02   +2.914943260391365e-02   -6.075259818107557e-03   +2.548744845385338e-02   +7.153361199231436e-03; +1.396770667471282e-02   +3.943537629901855e-03   +3.422885295066701e-02   +1.668360059683363e-02   +4.077375871803181e-02   +1.957150340594437e-02   +2.131057901874553e-02   -1.065883411817021e-02   +2.786192161404851e-02; +2.243883214947001e-02   +2.028117436210158e-02   +1.481465926555530e-02   +3.677087529726485e-02   +2.203221417025216e-02   -9.278027348419322e-03   +2.176985771279872e-02   +8.936644707529423e-03   +3.298765176785218e-02; -2.410547352630395e-02   +1.960238431216640e-02   +1.123193612229717e-02   +1.489879896147854e-02   -9.405791983425074e-03   +1.843067928573873e-02   +1.538661354516337e-02   +9.408575464453376e-03   +3.209830755237445e-02; +3.517829342233149e-02   +1.888981804926166e-03   -1.146925554739758e-02   +1.417910142771298e-02   +8.809102279766865e-03   +1.234988020101426e-02   +1.821536543288312e-02   -1.613668361033742e-02   -7.271953131122597e-03; +2.719963864063607e-02   +2.067622468458626e-02   -1.119390242127871e-03   +2.418317985515616e-02   -1.174622290350088e-02   +3.413120788858756e-02   +1.606571647782979e-02   -3.879909557509689e-03   +9.012005711318454e-04];
L1_L2_iAMPA_netcon = [+2.543754773583634e-02   +3.682264201131436e-02   +2.271943465292552e-02   -2.150415621625927e-02   +3.947208989073372e-02   +3.146184079303397e-03   +1.722563484045799e-02   +2.905508807434805e-02   +1.434549557405656e-02; +2.417651902840481e-02   +3.134569151401240e-02   +4.419902434701616e-02   +1.315301821561227e-02   +9.774730110260463e-03   +1.802099814385943e-02   +2.369575012314535e-02   +3.245045016782334e-02   +1.176247781184838e-02; +3.297604514295587e-03   +3.804409624648344e-03   +2.534125622755039e-02   +1.407673604197593e-02   -3.535532907327200e-03   +1.331746804448765e-02   +2.693487152143023e-02   +3.622090950608223e-02   -6.967088699946234e-03; -9.208295930636344e-04   +2.803463798955833e-02   +2.653119546013662e-02   +1.585064195291297e-02   +2.426304809871965e-02   +1.574374877841879e-02   -2.773417367659166e-03   -9.521543439309044e-03   +3.025081172673751e-02; +4.038364835792646e-03   +4.541708342760800e-02   -1.234424698066540e-02   -2.982693093347174e-03   -1.434084766842649e-03   +8.754345012385438e-03   +1.265575693845275e-02   +2.315704391555872e-02   +2.063405144541926e-02; +2.277398518589926e-02   +2.258148920438100e-02   +2.417596801339787e-02   +1.282886957071434e-02   +4.284326166069673e-02   -8.162821098552082e-03   +2.250536383899636e-02   +4.355933215132730e-02   -8.457812908376156e-04; +4.257833514979355e-02   +4.089224164609362e-02   -1.135842003178791e-02   +1.525274849505509e-02   +1.284193674373608e-02   +3.243096052872384e-02   -3.947416578432330e-03   +2.382233657321243e-02   +6.637297763483617e-03; +2.181257148269366e-02   +2.041155289831137e-02   +1.066599081352986e-02   -1.023933249407091e-02   +1.513000877414171e-02   -3.701570263951287e-03   +2.640771479545697e-02   +2.134701508522573e-02   +3.241835901707128e-02; +2.612795100684583e-02   +2.678591433192056e-02   -5.734508595213739e-03   +2.504439835374278e-02   +7.916026717310834e-03   +3.688375112139015e-02   -1.100800334920985e-02   +4.102131319327815e-02   -8.715190796421256e-03];
L2_L5_iAMPA_netcon = [+4.840731538641788e-02   +2.498352519103220e-02   +1.668646304066678e-02   +4.469334662592239e-02   +2.815543352948756e-02   +2.893260651831388e-02   +2.979424527050353e-02   +4.009320843221878e-02   -2.238769376508111e-02; -2.218477532053228e-03   +3.025542395467651e-02   -9.447496183154347e-03   +3.848789073481012e-02   +4.813041308118012e-04   -1.744866354821214e-03   -5.090018280167413e-03   +1.563379492796605e-02   +3.515227948108646e-02; +2.116949009003430e-02   +3.653853098656068e-02   +7.915359771851718e-03   -6.453001688465811e-03   +1.437759898410900e-03   +3.587967738412052e-02   +4.244368637889827e-02   +2.969010030429814e-02   +1.663169931967583e-02; -4.273349658684579e-03   +2.210062764353810e-02   +1.819570201903819e-02   +4.246672308947905e-02   +1.962019852839460e-02   +4.360756831616164e-02   +7.545165186598212e-03   +3.075309769833526e-02   +2.536765222430933e-02; +5.904759211151110e-03   +7.887021556912841e-04   +9.393552072209498e-03   +1.408053997744077e-02   +1.653606451750499e-02   -6.219884404652786e-03   +1.761522744314897e-02   +6.096787031032492e-04   -9.506932602465204e-03; +1.872163681043106e-02   +3.272401862260585e-03   +5.113663521446084e-03   +4.118244519607918e-02   +2.301612255018097e-02   +1.795137431003448e-03   +1.374154743420807e-02   +1.920592389416519e-02   +5.859834971783903e-02];
L5_L2_iGABA_netcon = [+7.213280441274466e-03   -1.220202564750491e-03   +9.588898321654339e-03   -3.236765855099619e-03   +1.470656777098804e-02   +5.449260551310364e-02; +4.429289049743364e-02   +1.683420083848738e-02   +2.250544077773044e-02   +1.380146464442575e-02   +2.081158570943583e-02   +2.714828518029192e-02; +4.806870098712277e-02   +3.463954504941295e-02   +2.181226442807412e-02   +1.105998116528755e-02   +1.468293610895215e-03   +1.698022356086384e-02; +1.823802751039040e-02   +8.838229329066385e-04   +2.256558062677466e-02   -1.601125829611681e-02   +1.560038531673786e-02   +2.080516646272876e-02; +8.128965360118551e-03   +3.163621822667879e-02   +6.179088381983637e-03   +2.368928999785133e-02   -1.568174478861939e-02   +3.612909062530029e-02; +2.031665271677721e-02   +1.818304371556688e-02   +1.202595381013483e-02   +2.852439003113628e-02   +1.553053424546862e-02   +2.499783622299464e-03; -2.226293538202288e-03   +3.157586366865313e-03   +2.825631832800840e-02   -1.871078121321938e-02   +2.325993432653197e-02   +7.424435702691880e-03; +4.599469211450812e-02   +7.767527031539882e-03   +2.549455344054290e-02   +5.222259772929463e-02   +1.945080853784088e-02   -1.666807160455397e-02; +1.339328134131168e-02   +2.868796688420831e-02   -2.376768968094592e-02   +8.099132753946081e-03   -1.501300989253018e-02   +2.326957057273710e-02];
L3_L2_iAMPA_netcon = [-1.910628665158999e-02   +7.994781726318265e-04   +5.736541192927314e-03   -1.372829660050420e-02   +4.163620190598275e-02   +2.908755562183855e-02; +9.301557612096230e-03   -1.219165790132482e-02   +2.583901407806910e-02   +5.042615335613186e-02   +1.184395426033108e-02   +2.518555949324023e-02; +3.008193613213102e-02   +2.836886631198727e-02   +8.857352794671891e-03   -2.085098679664946e-03   +2.207536978859842e-02   +9.292691948736352e-03; -8.010194097488326e-03   +1.499751516952008e-02   +6.812894230110308e-03   +1.664486879444953e-02   +1.386812333139854e-02   +3.891282078521812e-02; -2.189333575664888e-02   -9.818197673800808e-03   +1.348406142891911e-02   +1.760470887143779e-02   +5.099799162788343e-02   +2.514097568029536e-02; +4.062811931785568e-02   +6.446342671408876e-03   +9.343374902780192e-03   +1.499395301227472e-02   +1.250006150850444e-02   +1.151621849422859e-02; +1.479920223599267e-02   +2.375237694678971e-02   -1.692045530075764e-03   +5.255434817818891e-03   +1.784783567390905e-03   +2.179196717056039e-04; -5.250792102265790e-03   +3.768444064246139e-02   +9.689511171961577e-03   +2.482681816998977e-02   +1.680492961632091e-02   -7.870175376682569e-04; +2.476248789012374e-02   +1.841576486434532e-02   +8.264242888807062e-03   -7.565468979285938e-03   +1.695407619494626e-02   +1.480052785731902e-02];
L2_L3_iGABA_netcon = [+2.250621974434370e-02   -6.154878520806919e-03   +3.489125937878799e-02   +2.480752785750260e-02   +1.557059290709256e-02   +1.277497998115846e-03   +3.536156045095804e-02   +5.419461793189833e-02   +3.714335156301298e-02; -8.197631820690542e-03   +4.342347417039250e-02   +2.960486793542462e-02   +3.737589747123109e-02   +2.841126794365843e-02   +1.548847773058241e-02   +1.559541297884665e-02   +3.335154528348579e-02   +3.899509605854005e-02; -9.018962124868879e-03   +1.858035097211988e-02   +1.430739034499959e-02   +1.124479337644154e-02   +2.372945133096891e-02   +3.064148196981450e-02   +1.080130313306100e-02   +1.245639687505147e-02   +3.060726546386290e-02; -8.598197606903411e-03   +2.314468473719830e-02   +2.105532065128891e-02   +1.402283125762006e-02   +2.898575777098897e-02   +3.991338628675773e-02   -3.886859637917846e-03   +1.115889184777829e-03   -1.633881098291059e-02; +3.258775541001634e-02   -6.090001461593429e-03   +1.667068159641685e-02   +9.905761792602105e-03   +1.407392456973688e-02   +1.855532484172723e-02   -5.063094307998379e-03   +3.414019970728624e-02   -1.117522783623431e-02; -8.657206324260928e-03   +2.297374231424262e-02   +4.674315973856474e-02   +2.345652361192902e-02   +3.273245463342629e-03   +1.157570858401209e-03   +2.875528309334462e-02   +2.993018221168014e-02   +3.682191275191436e-02];
L1_L4_iGABA_netcon = [+5.420676171219057e-03   +1.232621331465645e-02   +1.071454232543324e-02   +3.059317777531474e-02   +2.582839953670904e-02   +2.537935483788699e-02   +2.797692803306155e-02   -2.581621259249435e-02   -9.112249211307917e-03; +1.462274219015072e-02   +3.563265979177123e-02   +5.013315764778156e-02   +2.035231436627937e-02   +2.387932056669606e-02   +2.987485044789652e-02   +5.243985453241498e-02   +2.063125786058597e-02   +2.657215094624325e-02; +1.278108523889209e-02   +2.369188578678037e-02   +2.553812410041710e-02   +2.207450683086703e-02   +3.167800410889239e-02   +4.193959555618184e-04   +5.534982371626464e-03   -2.458938464155998e-02   +3.226034193620819e-02; -2.401627257419205e-03   +2.817674357469776e-02   +3.527010406542713e-02   +2.597366924946198e-03   -6.873338962368696e-03   +2.733294321312802e-02   +3.229072790289239e-02   +2.543276476421113e-02   +2.706745887720834e-02; +4.011603130009606e-03   +4.526894054481365e-02   +1.059738696549642e-02   +3.723168610547047e-02   +3.865165248840865e-02   +2.640557932615651e-02   -1.382738616243641e-02   +1.647089657593164e-02   +2.224345974436314e-02; +2.173805007754498e-02   +2.493050255970017e-02   +3.439542309745280e-02   +3.284404124845819e-02   +9.978862572485921e-03   +4.377235749985515e-02   +2.158695993708428e-02   +1.459637120928766e-02   -7.335409444588639e-03; -4.934338522678263e-03   +2.769769350287200e-02   -5.274499997739926e-03   +1.985095264394682e-02   +6.014343717474516e-02   +1.569247065198364e-02   +4.644499021336965e-02   +5.902875875784491e-03   +3.808293026165911e-03; +6.099260091157899e-03   -3.426256005690704e-03   +1.851513263340763e-02   +1.440986431710061e-02   +2.374347959983411e-02   +7.152147776121626e-03   +3.481374173730160e-02   +5.180880885036325e-02   +2.903699936617123e-02; +1.631506374094903e-02   +2.109025649371948e-02   -1.519787012634272e-02   +5.489846180705438e-03   +2.725187926953412e-02   +4.259159429614022e-02   +5.300215853319320e-03   +4.275076219136556e-03   -2.700682455156007e-02; -2.529402822990908e-03   +3.214997789152273e-02   +2.682033792233419e-02   -1.522903567594193e-03   +2.595780896767976e-02   +1.146550441344992e-02   +6.677387996010600e-04   +4.677049879647124e-02   +2.789223318660699e-02; +4.510974372921482e-02   +2.258499474687134e-02   +7.746671354758975e-03   +1.369872883841470e-02   -8.619961257921669e-04   +3.733401058104022e-02   +1.179490197868805e-02   +2.946482745917332e-02   +2.678759526893704e-02; +1.017089188024923e-02   -3.785685150595531e-03   -1.996403233864417e-02   +5.053366211325882e-02   +2.700240316540096e-02   +3.812236956448360e-02   +3.621488394089810e-02   +2.414926023968297e-02   +3.651053914506322e-02];
L4_L1_iGABA_netcon = [+2.003888965160291e-02   +2.537752703559890e-03   +2.331025885861322e-02   +7.614698379250452e-03   +2.149388015683306e-02   +4.440583645794917e-02   -9.470114489288847e-05   -2.842694799268575e-03   +2.420892263676856e-02   +6.621032759634377e-04   -9.756360054593951e-03   +1.277787868795276e-02; +2.422666153693638e-02   +7.820745247057538e-03   +4.244933917915391e-02   +1.804598875495804e-02   +2.169466622444988e-02   +2.534524601734554e-03   +2.413152206484927e-02   +5.971560942992274e-03   +5.489013439713841e-02   +1.826354908605324e-02   -2.775726219109704e-02   +1.795195053737170e-02; +1.148871739032343e-02   +3.147376137272226e-02   +3.337897586903344e-02   -4.829008407994131e-03   +3.343677226658547e-02   +3.536465245691574e-02   +1.016999128490178e-03   +2.346580537319150e-02   +3.663306853795166e-02   +2.670976095095240e-02   +2.299714704533641e-02   +1.477604829956956e-02; +2.155224958525549e-02   +5.809670105390713e-04   +1.298562112293802e-02   +3.516038840563884e-02   +4.893940148254668e-03   +2.893916456836980e-02   -4.957094135922938e-03   +1.822733857374024e-02   +1.243565665916659e-02   +4.051608337278377e-02   +2.821517044572626e-02   +3.758652514328606e-02; +2.824495144273542e-02   +6.282797567477427e-02   +1.924257996693051e-02   +7.993797629540049e-03   +2.766559173158992e-02   +2.297538825916232e-02   -5.630257889294443e-03   +2.174406873237613e-02   +3.245929506589630e-02   +2.529254975374610e-02   +3.728680236552435e-02   +2.186633805072402e-02; +1.543793133099700e-02   +1.033098511948332e-02   +1.532223189939505e-02   +4.336075527427428e-02   -2.879742718019306e-02   +1.376293872383049e-02   +2.162399437095045e-02   +6.427117097741844e-02   +2.652756512047457e-02   -1.701331337753502e-02   -8.920842466914910e-04   +2.682206640888556e-02; +1.530501882427236e-02   -1.284096963672231e-02   +1.179630428800270e-02   +3.262506286147177e-02   -7.143819983202346e-03   +3.062440426510954e-02   +2.035277244000716e-02   +2.989150049873789e-02   +1.832572402348927e-03   -2.714197285347758e-03   -6.023472799722559e-04   +4.018014724287032e-02; +3.897506787155335e-02   -6.252393145373535e-03   -5.940068041057951e-03   +1.555379321948433e-02   +7.803723075233570e-03   +6.233020298522135e-03   +3.217850538021916e-02   +1.163843696461783e-02   +2.379906089571381e-02   +3.640466075992759e-02   +4.545409487245269e-02   +1.715255977588291e-02; +1.821949832477678e-02   +1.657921798377249e-02   +4.720401125987194e-03   +8.443685970321428e-03   +1.784731575829325e-02   +2.753073033131222e-02   +1.460697808259540e-02   +4.352496847259742e-02   +4.300649495808644e-02   +4.498620049858711e-03   -6.368750743149405e-03   -2.857868516760845e-03];
L1_L3_iAMPA_netcon = [+3.415493126223349e-02   +2.645110709438887e-02   +2.536688375362318e-02   +3.389026698847169e-02   +1.594590903186797e-02   +2.338671137316204e-02   +2.708380344549347e-02   +4.005414038022899e-02   -3.439723539409016e-03; -7.171581288822025e-04   +4.386316901495540e-02   +1.675756898061967e-02   +1.638585609967880e-03   +2.923488131934401e-03   +9.402522591420288e-03   +7.013998746867281e-02   +6.734944709296826e-04   +3.263496556276749e-02; +1.264316082305052e-02   -1.720789582382144e-03   +3.218282237641677e-02   +4.308267476203264e-02   +3.972138070711373e-02   +4.249905199026143e-02   +3.105856687785882e-02   +4.564576980152980e-02   +9.150328326768892e-03; +3.850775508507067e-02   +1.507131860306973e-03   +5.385214571320431e-03   -8.995030500417609e-04   +2.128062233142513e-02   +3.376987428957403e-02   -2.043268338864364e-02   +2.239289727629716e-02   +1.908142660470678e-02; +1.421257697630635e-02   +2.045700472132573e-02   +2.689377663924275e-02   +4.941480437838991e-02   -2.616098278902359e-02   +2.281086882847407e-02   +2.543569406020784e-03   +8.956132702557107e-03   +1.097170814064099e-02; -2.054653116898153e-03   +1.513928447683540e-02   +1.562864628661469e-02   -3.322632248644441e-03   +1.432413857850637e-02   +1.849779722536266e-02   +1.174444821812940e-02   +6.600179233431022e-03   -1.278706946479818e-02];
L3_L1_iGABA_netcon = [+3.974050785382179e-02   +2.305671880322005e-02   +2.807004996486490e-02   -1.745826040315204e-02   +2.106347833935980e-02   +2.258388333061165e-02; -4.847661286888257e-03   +8.669614194471386e-03   -1.372756964092470e-03   +9.245292873331701e-03   -1.017789952989100e-02   +5.005181906957276e-03; +2.157949224437233e-02   +1.335188958016172e-02   +3.149454616101617e-02   +1.999538422480106e-02   +5.005060030862372e-02   +5.044552591199162e-02; -2.691066154916564e-03   +2.762832944346919e-02   +1.839305316093930e-02   +1.296468696634333e-02   +3.586281579969693e-02   +3.425510941575926e-02; +1.314264866590889e-02   +1.199054033488545e-02   +5.164004402650522e-02   +3.995085445810481e-03   +2.761467409545461e-02   +1.972470164781690e-02; +4.581620793611688e-02   +6.296993326982476e-03   +2.355592507056913e-02   +3.489447886832357e-02   +4.448619934098846e-02   +1.939206785551047e-02; -5.744086915971897e-03   -9.940125514635214e-04   +2.277487047590935e-02   +2.646778022676269e-02   +1.086494732214193e-02   -1.086053309258342e-02; +2.396184927798438e-02   +2.203022393659677e-02   +2.860142851439238e-02   -2.684883339869361e-03   +2.932951809999606e-02   -6.850368828564983e-03; +1.215287620736486e-02   +3.452180728099787e-02   +2.836099121511508e-02   +2.879210479108858e-02   +1.840526184227588e-02   +5.473766846142131e-02];
L5_Input1_iAMPA_netcon = [-3.086477210072974e-03   +2.427338871416746e-02   +2.191703360617166e-03   +2.973784988831971e-02   -6.090119162489516e-03   +2.153274765235545e-02];
L6_Input2_iAMPA_netcon = [+2.308539295218020e-03   +3.771688992405342e-02   +7.838741135167953e-03   +2.222443372657293e-03   +1.510241785565974e-02   -1.058976286582067e-02];
L5_L6_iAMPA_netcon = [-1.896874708665367e-02   +4.036200023902133e-02   +8.128697802783739e-03   +4.761682001202269e-02   +2.079270680937964e-02   -3.109719972285216e-04; -2.135663626152458e-02   +1.515305714495708e-02   +1.532221738130017e-02   +2.379049158284655e-02   +3.007473363593132e-02   +3.523996919280902e-02; +4.671172696161605e-02   +2.412906937204883e-02   +2.829164500655984e-02   +2.529923885607622e-02   -3.317895961537390e-03   +2.556229503205185e-02; +4.456547899093020e-03   +5.016832891596979e-02   +3.102637399251094e-02   +1.309594130529803e-03   +2.206191765987758e-02   +3.080000144304392e-02; +1.393589832786146e-02   +2.870363396048382e-02   +4.331109542895928e-02   +1.351389946153347e-02   +1.859924840738581e-02   +3.087533812154555e-02; +2.449805378919369e-02   -1.552250126852076e-02   +5.799504083047816e-02   +1.720464503319922e-02   +4.407585066864061e-02   +7.475831739092781e-03];
L4_L5_iAMPA_netcon = [+9.729218620590663e-03   +1.467248229527970e-02   +5.048386054748761e-02   +2.409601652911484e-02   -7.343470757065283e-03   -7.561088518569720e-03   +4.650231312389287e-02   +2.215275651513885e-02   +2.011733855753697e-02   +4.297765835689300e-02   +4.775094919837711e-02   +3.089410676436966e-02; +3.038705068193133e-03   +1.548685824265070e-02   +1.029669711832871e-02   +4.368560566423908e-02   +8.493620402184470e-03   +1.653054588923701e-02   +5.759296750590175e-02   -3.728367238695161e-05   +1.685972983021879e-02   +1.404169873420647e-03   +2.822364333675398e-02   +1.916519380267260e-02; +1.657855949590875e-02   +1.703908178188620e-02   +2.744127363162245e-02   +5.306920865124156e-03   -1.255306107033223e-02   +4.325116946190654e-02   +1.937092332015484e-02   +2.913929338024139e-02   +2.695497021646563e-02   +2.739826945348092e-02   +4.270918150423141e-02   +1.706484867772189e-02; +1.248062034334411e-03   +1.339693940352385e-02   +5.491500316707908e-03   -4.341250248520167e-03   +5.441562647890015e-03   +2.303244621533620e-02   +3.012465886109482e-02   -1.796161083864468e-03   +3.353686452884492e-02   +2.963596673869879e-03   +6.939450761327133e-02   +1.360357273324606e-02; -2.148146468081296e-02   +1.696220890789656e-02   +2.663450795308688e-02   +6.200341737708179e-03   +3.434860074633373e-02   +3.171830374510282e-02   +3.757399354012720e-02   +2.586691640989123e-02   +2.095345050167325e-02   +5.950250322329710e-03   +3.393863372067977e-02   +1.788906293850465e-02; +3.470882464289487e-02   +1.034981473540040e-02   +2.502429000009848e-03   +2.514104074712178e-02   +1.985804174609851e-02   +3.907868552935966e-02   +6.975901161937810e-03   +3.123359256149904e-02   +5.029250681523478e-03   +6.429610804724557e-02   +2.109720515114077e-02   +4.094424516456676e-02];
L6_L4_iAMPA_netcon = [+4.646336189975003e-02   +4.256134855985097e-02   +1.568420744625170e-02   -8.287560757044028e-04   -6.127930656556260e-03   +2.599819488933931e-02; +8.443991145799462e-03   +2.127477793030073e-02   -1.583638181680884e-02   -5.111182838143706e-03   +1.568394507442828e-02   +1.293183544120457e-02; -4.190430780551403e-03   +1.367565203724139e-02   -4.935435417632765e-03   +2.241444340912527e-02   +3.275683688174688e-02   -5.175265194441510e-03; +4.180154003943768e-02   +4.119009350342081e-02   +1.116453902082896e-02   +3.586539042534663e-02   +3.207650434989454e-02   +1.450061598381911e-02; +6.473249793553683e-02   -2.219168657762668e-03   +1.299200903921330e-02   -9.011200907774110e-03   +2.316448423701182e-02   +4.088088131406266e-02; +3.539325870900664e-02   +3.540055467582511e-02   +3.716582326911473e-02   +2.134632084232746e-02   +1.817304292765921e-02   +3.604756933107528e-02; +7.173206498251018e-03   +4.277838215015286e-02   -1.390707331217281e-03   -7.350909256923118e-03   +3.806915537457639e-02   -1.249217648928740e-02; +2.115306856266679e-02   +4.333329897178075e-02   +3.366484911787219e-02   +1.530341856008810e-02   +1.040564953103159e-02   +4.581714419905850e-02; +2.361663967291201e-02   +5.061889463037201e-03   +3.183483320202223e-02   +1.163293361849902e-02   +1.022904326078389e-02   +8.597549808342205e-03; +2.110302034455010e-03   +1.582916616561102e-02   +4.096215288789655e-02   +4.277651569149129e-02   +4.308012530839524e-02   +2.029596743749815e-02; +3.279960594521074e-02   -1.792416262192646e-02   +3.453680181677372e-02   +4.473814478014823e-03   +1.292124670676252e-02   +2.436277445022401e-02; +2.981595509113003e-02   +2.401710813394910e-02   +2.581036370253407e-02   -5.584805550724905e-03   +4.205900832325065e-03   +3.144338280348227e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
