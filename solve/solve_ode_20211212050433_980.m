function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.925948216073983e-02   +1.565839772474025e-03   +2.088532172327654e-02   -9.170372345933972e-03   -3.703309457772426e-02   +3.509121898035835e-02   -5.793785427064688e-02   +6.492852980921358e-02   -1.706300436729820e-02; +6.047356533445463e-03   -1.208930071811519e-02   -3.914267898188845e-02   -3.305029078816096e-02   -3.909223926385211e-02   -2.973018029433589e-02   -7.558983790436163e-02   +2.477213113478609e-02   +5.169665115446449e-02; +3.309351668713680e-02   -1.932039501765180e-02   +1.435504408325342e-02   +1.447703804657284e-03   -1.361708993510578e-03   -5.503904126248547e-03   +3.057039026120978e-03   +3.851882135512975e-03   +3.077660575973191e-02; -5.469145938483361e-02   +3.784137634343584e-02   -7.214497559181553e-02   -2.891934471815713e-02   -3.691546368502906e-02   +3.038352747859868e-02   +1.524915564213325e-02   +2.460592895484716e-02   +3.256770262549302e-02; -3.578975052024579e-02   -3.689673003373888e-02   -3.462552790660794e-02   -4.311524664328402e-02   -4.580806296627628e-02   +3.193783200743027e-02   +4.180193490174246e-02   -5.068934435013200e-03   -4.304108029950222e-02; -4.057145214287167e-02   -1.456647113597258e-02   +2.730206314750037e-02   +3.324496192656127e-03   -1.683225372478711e-03   -4.680692457790882e-02   +7.830939447855068e-03   -4.675562913563399e-03   +1.871283542550902e-02; +1.316291488057130e-03   +1.601342697677928e-02   +3.214445768338837e-02   +6.672471876994922e-03   +1.448858080596772e-02   -2.898569803139444e-02   -2.510766508895126e-02   +3.411365548139987e-02   +2.565975062885830e-02; -5.628698655848927e-02   -5.080488766387534e-02   +7.301277509488911e-03   +7.184162670326795e-02   +3.624783089912002e-02   -2.127292646512796e-02   +3.445707064513022e-02   +5.152801131373812e-02   -1.500932940859152e-02; +2.835475568035700e-02   -3.467576843361740e-02   +1.077237488559567e-02   -1.434439531395104e-02   +7.493698775155370e-03   +6.807106076641650e-02   +2.526140790447641e-03   +6.196866156150344e-02   -5.384928451121001e-02];
L1_L2_iAMPA_netcon = [-4.437938943379159e-02   -1.857728614962144e-02   -3.018467236248164e-02   +9.197873570782500e-03   -2.907452784146091e-02   -4.008308740700244e-02   +3.757906008890518e-03   +4.748077967484378e-02   -3.280008068688300e-02; +3.438662650234429e-02   -6.908751014751857e-03   -1.071230359590673e-02   +2.666556739656839e-02   +2.337027130624492e-02   -5.645469951475465e-02   -2.282549557515618e-02   -1.411861142276946e-03   +5.302459432394508e-03; +3.410503475431221e-03   -4.563453602596382e-02   -6.296356199608266e-02   +6.891784074912744e-03   -5.552382712253887e-02   +2.210646059139910e-02   +2.854583856153436e-02   -5.911666703046883e-02   -1.982146410710412e-02; -4.871975192046639e-02   +1.512962086789137e-02   +5.661015599433577e-02   -2.143032169293366e-02   -1.471605528049081e-02   +6.833841655050686e-02   -1.584751160002074e-02   +2.057221988281499e-03   +6.720443557715516e-03; -1.025991033062686e-02   +3.259982248289314e-02   -4.527906966100192e-02   +5.770776945699649e-02   +2.957706656022783e-02   +1.733219931310627e-03   -1.872051331358646e-02   +5.470483679808485e-03   -2.921106728379901e-02; +4.296915005611950e-02   -1.019987171928363e-02   +2.126708524946576e-02   +7.150806354296182e-03   +1.643690881496512e-02   -3.129566867888491e-02   +1.527826312305063e-02   -2.322235941615788e-02   +1.378070724008905e-02; +3.800980394817152e-02   +4.581347635697119e-03   -1.334188939727327e-02   -6.673594073167924e-03   -1.486865491599149e-02   -2.984238376494848e-02   -2.326768029944658e-02   -2.490427236527589e-02   +3.570779870291412e-02; -1.561762199769941e-03   -1.328323832010627e-02   -2.964308683876670e-02   +3.701826543370253e-03   +3.492662327332646e-02   +3.396188342567295e-02   -5.457252816491178e-02   +2.520381286319309e-02   -2.030537073163396e-02; +2.969405767512192e-02   -5.016437812563626e-02   -4.699476514598424e-03   +5.372656847334150e-02   -2.572359369173931e-02   -9.728856876615684e-03   -3.244150313527529e-02   -1.066926728708034e-02   +5.151147079312392e-02];
L2_L5_iAMPA_netcon = [+3.270968340559079e-02   +2.084075253712963e-02   -3.542304167055930e-02   +1.154324651445227e-02   -2.066258070971539e-03   +3.865049459905298e-02   +7.544237913468600e-03   -4.894487458191379e-02   -1.147517962289896e-02; -3.883827644997333e-03   -7.292288217022118e-02   +6.860569683929502e-02   -2.349908981408902e-02   +6.354062975764288e-02   +2.824292118704442e-02   +3.647129021843380e-02   +3.358879143478140e-02   +6.161448496228029e-02; +9.387385174981339e-02   -4.748463940750142e-03   -6.625541486668036e-03   +5.116304485188784e-03   -2.458289898782170e-02   -5.202392011950014e-02   -1.634326077578395e-02   +2.226532360150820e-02   +7.124133955324535e-02; +4.081679467471316e-03   +4.719676391030653e-02   -2.738598837612621e-02   +2.552936422645372e-02   +3.724509230147907e-02   -2.404695977552476e-02   -5.640933189843117e-02   -1.221379383831337e-02   -5.054428800936683e-02; -2.945417998997710e-02   +1.262758543229208e-02   +3.070028300013006e-03   +2.472810670430159e-02   +7.614776903139785e-02   +1.252614667604947e-02   +2.478930529670395e-04   +5.564676225969230e-02   +1.381509027812550e-02; -2.805608695200751e-02   +5.880399706304183e-03   -2.200546998582827e-02   -1.593881622745191e-02   +5.840668385493741e-02   -1.462573070207826e-02   -2.589120880700081e-02   +1.110617601027444e-02   -1.170954107459968e-02];
L5_L2_iGABA_netcon = [-1.417050768805258e-02   +2.565858406750208e-02   +1.522472629301084e-02   +2.409972953796729e-02   -3.026010708258103e-02   -3.789131403931476e-02; -3.712761906795554e-02   +6.259206996818732e-03   +2.474901139627852e-02   +4.875112664635908e-03   -2.032719915882053e-02   -5.267131583586136e-02; +5.173775153033744e-03   -2.772933402836318e-02   -1.397581515708417e-02   +5.170323736040129e-02   -3.236823210056602e-02   +7.418610592269538e-03; -3.803933287405821e-02   +9.091330061078536e-03   -3.236533946419871e-02   -6.126279773627293e-02   -1.311861329450468e-02   +1.747052035808657e-02; +1.890721848419116e-02   -7.794082720583939e-02   +6.605676468684311e-03   +3.972385339250741e-02   +2.147391094245020e-03   -6.013485823004900e-02; +4.829503020005194e-03   +2.468383583719741e-02   -2.084417503224629e-02   -1.931592029891948e-02   -8.780696162542265e-03   +4.812935139240106e-02; +2.200343226477133e-02   -3.908667655771560e-03   +4.670887553066801e-02   -3.852844813781274e-02   -3.828747179266722e-03   +9.954439427957070e-03; +1.141066979156247e-02   +1.605500895850397e-02   -2.241575960194803e-02   +4.995548162348991e-02   +2.904795359857970e-02   -1.910209338773195e-02; +3.813859135022247e-02   +2.690878853884380e-02   -1.264675380378423e-02   -7.816324356627564e-03   +2.677155974956108e-02   -1.035769309909153e-02];
L3_L2_iAMPA_netcon = [+3.838406573742148e-02   -3.065344709340102e-02   +4.432416938980042e-02   +6.967759740239601e-02   -2.582332700485754e-02   -2.018091367648173e-02; -4.699670240092269e-05   -2.131305067499612e-02   +1.533985520560429e-02   -2.238375544474570e-02   +6.415194991859977e-02   -1.795000898801935e-03; -3.070268216602141e-02   -8.209636662561526e-03   +1.401304158340462e-02   -5.119610587460287e-02   +3.728332837249766e-02   -4.923961511062014e-02; -3.653768390679091e-03   +2.447347244872235e-02   +4.105895292242591e-02   +2.851970746589294e-02   -5.500613070700051e-02   -8.616943590303865e-02; +8.519192511879439e-02   +1.942889838956828e-02   -4.783194888914290e-02   -1.639812390693682e-02   -3.516965897586016e-02   -6.588780960295759e-03; -3.853963504287239e-02   +5.061273024537918e-03   +3.906730220186233e-02   +5.104238748783124e-02   -1.745736206809896e-02   +3.163083928260173e-02; -1.899839628001208e-02   -3.512669114564833e-02   -3.621310979464713e-02   +3.140325010411073e-02   +2.450581991364145e-02   +5.326376634428587e-02; -1.781588298352221e-02   +6.052440713516936e-03   -2.100531978994414e-02   -9.428959310450233e-02   +1.450815375865808e-03   +1.229932465520506e-02; +4.133874583309319e-02   -1.949425088664956e-02   -3.194578118016280e-02   -3.398064688252782e-02   -1.731880003322205e-02   +3.055466143310324e-02];
L2_L3_iGABA_netcon = [-2.787534559335226e-02   +4.226190752067714e-02   -5.630838703945831e-03   -1.834855835887353e-02   -6.586546386879262e-02   -3.193055369340445e-02   -3.204882443816211e-02   +3.929122252218639e-02   -8.594817996854040e-02; +3.982120641158745e-02   +4.069799491609211e-02   -6.768023931370944e-03   +2.954391504469427e-02   -2.104356380027465e-02   +2.155838142916542e-02   -3.402583069525111e-02   +6.437420601084796e-03   +4.241854846288615e-02; -1.456518644642758e-02   +1.728581417787987e-02   -1.540935828216827e-02   -5.042656802140760e-02   -2.560323800280196e-02   -5.489056163215626e-02   +1.313462384413686e-02   -2.920699890468715e-02   -9.892850995887614e-03; +5.408525574532178e-02   -1.651483829821963e-02   -1.412210048711864e-02   +6.190983860891080e-03   -2.413967239190544e-02   -2.946923911971456e-02   -2.873376051826093e-02   +5.457301452935619e-02   -6.265044111269328e-03; +4.545820918203848e-02   +8.189299674859544e-03   +1.959809549813257e-03   +1.088372740733253e-02   +1.013168439573983e-02   -5.713316518612081e-02   -3.659109027029260e-02   -3.687454037068633e-02   +2.635787931741657e-02; +6.630839057181823e-02   +4.551288910309582e-02   +2.176222081094521e-02   -5.287650568136720e-03   +9.092046152320673e-03   -3.451166358189459e-02   -7.150686944917270e-02   -4.636994346332348e-02   -1.555562575449892e-02];
L1_L4_iGABA_netcon = [-4.801955962046529e-02   -2.304574420428617e-02   +4.288268208886256e-02   -2.902029010931421e-02   +1.422559614597012e-02   +2.561442583357435e-02   -5.192755086163695e-02   +6.232692243933366e-02   +4.656079019428606e-03; -4.783865599173433e-02   -4.056331103971734e-02   -3.246419330994667e-02   -7.817925506178666e-02   -4.189736056717460e-02   -6.149206537325678e-03   -1.376149502362606e-02   +1.262117888560519e-02   +2.091767490636572e-02; +4.246881416293350e-02   +8.235352612914930e-02   +4.287639883998211e-02   -5.107600420371713e-02   -4.727109359567278e-02   +2.451293049725231e-02   -6.815883645636076e-02   +1.941261432860199e-03   +3.485630594610406e-03; +1.491777203942214e-02   +4.838780672716324e-02   -7.244449416638842e-03   -6.378319287664035e-03   +1.032202073216919e-02   -3.524027713362628e-03   +9.162984077080865e-03   -2.380572613117687e-02   +4.158120325000703e-02; +4.989157448070590e-02   -5.405076271443534e-03   -2.880363950590923e-02   -6.326136606240007e-02   +3.996124269103106e-02   +2.443367505524327e-02   -3.987369862118881e-03   -5.404227356466770e-03   -5.855438546429055e-02; +2.287896309858537e-02   -6.964509697504436e-03   -2.096023980626861e-02   +2.502213516959586e-02   +3.716941654094808e-02   +8.640228211650416e-03   -5.081017026944590e-02   +6.528603072191234e-02   -1.458538368786590e-02; -2.883270173801491e-03   +4.141695346060226e-02   +3.596464001993363e-02   -6.698988895286530e-02   +2.779138441452231e-02   -2.110258911217575e-02   -1.189865517267702e-02   -2.107808839999701e-02   +5.671081142020405e-03; -3.123260730513280e-02   -1.501799887389767e-02   -2.313033789454887e-02   +4.479922743738734e-02   -9.089582726833009e-04   -4.645517860615375e-02   -1.555328165168332e-04   +4.282473381391964e-02   -1.410238949585087e-03; +4.160821152193835e-02   +5.098132507690982e-02   +8.492186508830697e-03   +9.020923164243532e-03   -4.356171909277430e-02   +2.704265822358444e-02   -3.716287682580957e-02   -5.515151001705194e-02   +1.675858396430863e-03; +4.448291531244222e-03   +1.186820016539478e-02   -8.615002383604181e-03   +1.848426073020881e-02   -2.352514790886834e-02   +5.166611833328037e-02   +3.982208905322931e-02   +1.043841590857714e-03   +1.777192283652575e-02; -6.122296224385707e-03   +1.613297912361977e-02   +3.253240762775753e-02   -2.913400930067171e-02   +2.543065552108829e-02   +6.423836316675602e-02   +4.912617303974960e-02   +2.541981291150096e-02   +7.664465082729406e-02; -3.397943635106603e-02   -5.259652000879643e-02   -3.553487883612592e-02   -3.374829794785024e-02   -2.135077961194252e-02   -3.368256451129480e-02   -8.837336213474473e-02   -2.772314824202034e-02   +5.457008516378601e-02];
L4_L1_iAMPA_netcon = [+5.339065695519740e-02   -5.799535985390760e-03   +8.399384721683813e-02   -2.539340677021660e-02   -1.136640709116344e-02   -2.598481272993424e-02   -5.990050385121408e-02   +5.009231109819136e-02   -6.287367283839565e-03   -2.399504004722004e-03   +2.946033186447471e-02   +8.216827110245511e-02; +3.008769342144593e-02   +4.248954314082684e-02   -6.059359898526837e-03   +5.520021101211528e-02   +3.695696786881994e-02   +7.829965309041763e-02   +4.809806892894698e-02   -7.055161366017983e-02   -2.996113484326879e-02   -3.689801714681299e-02   -4.112573717070044e-02   +1.439047526078100e-02; -1.831078765835180e-03   -2.987295857130028e-02   +4.303454918248377e-02   +2.789616257545364e-02   +4.678743384502636e-02   +9.437797221634386e-03   -1.145011366342561e-02   -8.245287942061647e-02   -4.634466826163264e-02   -2.985939527705853e-02   +5.025580380666946e-02   -2.956006799125543e-02; +9.897816196438732e-03   +1.875936799927153e-02   +8.305945553278843e-02   +6.296814499170425e-03   -5.807716505234197e-03   -2.816605953139919e-02   +6.753592138080358e-02   -6.130963396905731e-02   -5.029721416119394e-02   +4.290252265868347e-02   +4.301256910114445e-02   -2.646182864024164e-02; +5.019800519815469e-02   -1.653295124509098e-02   -8.614055042199187e-02   -3.880381542256139e-02   -1.700747589366776e-02   -8.031643442660757e-02   +2.544366789952127e-03   -1.853277639172466e-02   +6.878577670969038e-02   +1.821394151730145e-02   -5.376265944437635e-02   -6.666770257607718e-02; -1.329269973850482e-02   -4.046621910363599e-02   -2.731699429044697e-02   +4.644288838532422e-02   +4.961177072024381e-02   -5.252878708640041e-02   -8.541787908245444e-03   -8.144905959349642e-03   -8.190015286045727e-03   +3.143147454789984e-03   +6.426972579248109e-02   -1.460299082065486e-02; -7.471958399720140e-02   -5.357258841958659e-02   -7.704702020021314e-03   -1.040950426001159e-02   +1.477494092144423e-02   +1.914029480573993e-02   -3.468901786687109e-02   +4.477220702902570e-02   -8.254043833470394e-02   +9.521370837325916e-04   +7.346966466304732e-02   -2.949886620578374e-02; +1.404077772786372e-02   +7.413950366099500e-02   -2.080586206018936e-02   +3.416999792365930e-02   -4.456796892900667e-02   +6.116647027883607e-02   +4.747676030881695e-02   +8.549667987416392e-03   +4.965031002144678e-03   -7.629918579281858e-02   -2.867474454840242e-02   -2.289453165867504e-02; -1.819983639783894e-02   -3.656432721458833e-02   -3.243400587700847e-02   +4.682106265522056e-02   +3.562494405104591e-02   +5.991084456350358e-02   -4.353350796180201e-03   -3.770084543743867e-02   -5.675552516753131e-02   +1.755746473946856e-02   -3.402860496235230e-02   +1.291793645672733e-02];
L1_L3_iAMPA_netcon = [-8.102085531127933e-03   -2.288212603977723e-02   -6.491252607992112e-02   +1.656560197100872e-02   +1.485034914933737e-02   -4.028295674551081e-02   +1.581985229271224e-02   -3.173872805501455e-03   +3.603254766950845e-02; -5.927115525589144e-02   -9.767570887772047e-04   -1.121450645757861e-02   +5.115715785032793e-02   +2.262333003311406e-02   +2.828453319818286e-03   +1.292566151735736e-02   -4.628422725983381e-03   +6.063117191612991e-04; +1.926126693572201e-02   +7.308844579654572e-02   +1.957400695929168e-02   +3.186113616002508e-02   +6.549074349009013e-02   +4.808343436269850e-03   +4.095184211824651e-02   -5.702842537455501e-02   -2.212201376337848e-02; +1.626666664656719e-02   +6.234019009284820e-04   -1.649065022365181e-02   -1.525321184904909e-02   +6.008595348356346e-03   -1.683955095529526e-03   +1.014923426275794e-02   +3.505620127126645e-02   -4.591019697924403e-02; +3.436907196721929e-02   +6.975393297141533e-03   -2.704526878252390e-02   +2.387534855479777e-02   -4.183995807025067e-02   +1.848077440018717e-03   +1.561590357633623e-02   -4.659007472395781e-02   -3.791242547953581e-02; -4.573964704622958e-02   -3.474022632951976e-02   +2.117383167613935e-02   -1.817047293670706e-04   +6.860676992666011e-02   -3.723095850733918e-02   -4.729620837736895e-02   -1.601788134486144e-02   +3.986308072928293e-02];
L3_L1_iGABA_netcon = [+7.656549537346159e-03   -1.596338520521904e-02   +2.503534217991200e-02   -4.313772610349577e-02   +1.451494380524814e-02   -1.261907916620047e-03; +2.300864894023973e-03   -4.773895846420394e-02   +2.314898245259199e-02   +1.796209031260435e-02   +3.525267061451366e-03   +6.553562396242335e-02; +2.122644892288989e-02   -1.516223355076622e-02   -4.798353226168181e-02   -2.835758008497356e-02   -8.645623554608026e-03   +5.949967771891935e-02; +1.540775216639681e-02   -5.614448056964359e-02   -7.069038709599086e-03   +2.461047096041854e-02   +1.208064560610990e-03   +3.629399074904391e-02; -5.435673855796786e-02   +7.833217366523294e-02   +2.294508929284794e-02   -7.750207771130423e-02   +2.137754621726167e-02   -3.658948260737789e-02; -5.775217311634046e-02   -7.842662783262533e-03   -5.469268226013056e-02   +8.693870554099176e-02   -8.701334769130164e-04   -4.285381814350740e-02; -2.600856931436513e-02   -7.798512029840836e-03   +1.072241022618104e-02   +6.750737703001221e-02   +3.983514200148469e-02   +7.027255047767293e-03; -5.524235869408117e-02   +2.870637629852331e-03   +2.321111666028212e-03   +6.352273562294083e-03   -1.899430352721915e-02   +4.709777962986592e-02; -4.334277959324911e-02   +5.081323133908796e-03   -3.088849289216297e-02   -8.665837014741662e-03   -3.991801400458908e-02   -3.133816156474541e-02];
L5_Input1_iAMPA_netcon = [+1.471332792453791e-02   +8.341541578935555e-02   -4.796686848971128e-02   +2.983186422722120e-03   -2.247239340107213e-02   -2.518481900430364e-02];
L6_Input2_iAMPA_netcon = [-1.383885271347425e-02   +4.396193162562707e-02   -6.188025034431962e-03   -4.083369664033100e-02   -2.054869720243303e-02   +7.832691991720914e-02];
L5_L6_iAMPA_netcon = [+2.674638956895792e-02   -5.611047755434331e-02   -3.818611123414248e-02   +1.739646037336760e-02   -1.739170690404885e-02   +3.801282906387686e-02; +2.043531518384420e-02   -1.268741960327382e-03   -3.955051440704341e-02   +7.693669173203688e-02   -1.433939176522049e-03   +5.643384182398384e-02; -2.137460423829123e-02   +3.455094260765233e-02   +1.231521455647785e-02   -2.427799249753976e-02   -3.537125178597323e-03   +6.261565680692088e-02; +5.435557149132729e-02   -4.290804254091803e-02   -7.429478925538470e-02   -4.473466061419542e-02   -5.716564722107668e-02   -1.039624621538836e-02; -5.680675763608842e-02   +1.564643496713966e-02   +1.940974907892261e-02   +7.993738382701805e-03   +2.276897666521272e-02   +1.115322019241353e-02; -4.725923258688765e-03   -4.496776341604058e-02   +4.764023330436164e-02   -3.929174561775363e-03   +7.385614153313210e-03   +3.772458262278586e-02];
L4_L5_iGABA_netcon = [+9.453080859208516e-03   +7.051139857148701e-02   +2.593669566135558e-02   +1.065064169072599e-02   +2.031707275879936e-02   -6.705988953298291e-02   -4.432356869385572e-02   -3.075029077517912e-03   +3.525119558208645e-02   +5.456200482771970e-02   +6.156375642109676e-03   -8.845108823400975e-02; -3.575674917869074e-02   -5.089378465871327e-02   +6.182083566490731e-02   +8.400560783713300e-03   -1.617212251428343e-02   -2.862219515817264e-02   -1.747117249238160e-02   -2.696695398971805e-02   -6.815951556478186e-02   -5.082672341245145e-02   -2.438281568870794e-02   +3.856527818089219e-02; -1.235324919560706e-02   -2.060681390231159e-02   +2.379935653203443e-02   -1.231326622166774e-02   -9.492305174083787e-02   -1.675566593603004e-02   +2.064082485354703e-03   -3.280094466239659e-02   -8.537640881262468e-03   -5.470334256286799e-03   -2.006578046607113e-02   +2.603322066727596e-02; +2.173389640862848e-02   -3.626841734319771e-02   -1.524903063231899e-02   -4.320893886695358e-02   +3.890671321008644e-02   -1.212596160844986e-02   +6.252016341198396e-02   -4.572993339260061e-02   +1.221519125259272e-03   +3.685575327526505e-02   -4.144344540778594e-03   +3.529595733272081e-02; +9.180205445673215e-02   +2.530726991406974e-02   +7.004208190182815e-02   -4.850578854081648e-02   -1.666169580284132e-04   +5.691575431125986e-03   -2.996582901708157e-03   +1.865838491405177e-02   -2.943435817652285e-02   -2.360359294237353e-02   -1.448207358943234e-02   -5.535117166605157e-02; -4.288978350541510e-02   -1.477852207014187e-02   +6.125354010477767e-03   -5.444527362554533e-04   +1.294288637865261e-02   +2.223404911825993e-02   +3.502640366522852e-02   -1.638425834407472e-02   -2.802756268497596e-04   -2.003269197036085e-02   -4.206151943677611e-02   -3.421443929624852e-02];
L6_L4_iAMPA_netcon = [-8.595268379933861e-02   +7.930351736687567e-03   -4.895459172182659e-02   -6.083940962197484e-02   +3.966419317755356e-02   -4.984764261043904e-02; -2.210578127787045e-02   -4.237934819361382e-02   +2.998584235599361e-02   -3.667354695039973e-03   -7.133843347102797e-02   -7.305230822296050e-03; -2.007859843794456e-02   -2.322293222785420e-02   +1.046794623333631e-03   -2.477216122053438e-03   +1.339233953824740e-02   +1.277478331749932e-03; +2.499464594841451e-02   -8.825502095428581e-02   +6.191177959740290e-03   -3.213692810830021e-02   -2.582621184451999e-03   +3.768688854366801e-02; +2.574065475856300e-02   -1.342541614043946e-02   -1.881218667610288e-02   +2.245166011439959e-02   -1.430078576534180e-02   -2.950862968790026e-02; -1.338180387066408e-03   +1.131214424245815e-02   +2.388812237681690e-02   +5.691951959885665e-03   +6.972896324334033e-02   +1.173212100121577e-02; +2.574307512980456e-02   -8.931341902206834e-02   +9.766020997459456e-03   +2.619999652492785e-02   -6.310272078573227e-02   +5.110845943658564e-02; -5.548324322095173e-03   +3.840165700949663e-02   +6.835980525985451e-02   +4.356179519838002e-02   -4.183003774109787e-02   -3.984068033187381e-02; -2.831241479079586e-02   -2.695262846425533e-02   +4.549977302967396e-02   -4.656182149382640e-03   +6.507270689754367e-04   +2.408939117440213e-02; +5.352500569592965e-02   -2.645550472813262e-02   +5.687838100201952e-02   -2.385978714485197e-03   +2.756418751808110e-02   +5.101044287136790e-02; -5.335493302395284e-02   -3.676907990749192e-02   +7.608163929434850e-02   -1.385697823466587e-02   +3.898922120241801e-02   +1.595428755653815e-02; -6.830611583721252e-03   -4.297284118389368e-02   +2.819236764851319e-02   -2.896554845317176e-02   +6.842941696422336e-02   -4.853385058449848e-02];
L5_L4_iAMPA_netcon = [+5.668683532520360e-02   -9.572559999935171e-03   -2.541308516490071e-02   -2.304228971367259e-02   +2.750241327380498e-02   -2.478692817077471e-02; +2.525770877597157e-02   -4.233733793117474e-02   +5.634920721285568e-02   -8.256104381455728e-03   +7.371596364158840e-02   +6.694493639725213e-04; -2.904313123976565e-02   +9.086045806302646e-02   -7.927858093511354e-02   +1.645079446621119e-02   -3.005122081175985e-02   +4.622521050888053e-02; -2.359121952817296e-03   -1.462587826289406e-02   -5.023963664390206e-02   +6.936383746453853e-03   -5.534452514977908e-02   -5.141589257490574e-02; -6.408256789083257e-02   +1.237173116990179e-02   +2.920808470860746e-02   -1.919075837777652e-02   -1.801214937508565e-02   -5.379851261257037e-03; -4.132952218351308e-02   +5.476717668303272e-02   -5.391478973379878e-02   +3.357708092084168e-02   +3.756246225695806e-02   -5.560770471367172e-02; -3.431585155645279e-02   -5.204826619737339e-02   -3.475648968030105e-02   -2.470859769298296e-02   +1.884692718544931e-02   -2.996051382654873e-03; -4.928100437909318e-03   +1.981697460570107e-02   -1.507860558561070e-02   +8.792740857881873e-03   +6.355049888781075e-03   +1.163754508665946e-02; -4.033102956132940e-02   -6.561927493745200e-03   -2.732922277068132e-02   -3.331490900767703e-02   -2.390359511811284e-02   -2.175479407370694e-02; +2.594247813555719e-02   -1.965097565381601e-02   -6.697563263776643e-03   -1.769397813495455e-02   -6.097566151822113e-02   -7.771931702118054e-05; -5.329617409229024e-03   -2.925904378964207e-02   -2.349689890093309e-02   +1.789589869315459e-02   +2.697255470270748e-02   +4.305520316271801e-03; +3.911766567854327e-03   +2.023428363033945e-02   -4.446095351732943e-02   +3.876131798625523e-02   +3.675727669487714e-02   +4.673755608257958e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
