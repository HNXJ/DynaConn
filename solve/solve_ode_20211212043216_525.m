function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.029699357498337e-02   -9.559789131874598e-02   +2.876759880623128e-01   -4.061045118335174e-01   -5.777734824370576e-01   +4.579517345417353e-02   -2.265413985159944e-01   +6.423060787232264e-01   -2.375057662216355e-01; +5.608034171048246e-01   +2.795708791664450e-01   -3.477069684809696e-01   +2.121149359865515e-05   +2.634128244445436e-02   -2.030075920666999e-01   +1.738381987762625e-01   -3.113784684548122e-01   -1.294772095874729e-01; -1.807293546654684e-02   +3.843591865091787e-01   -4.351734347909775e-01   -5.931976901080692e-01   +4.362236106942505e-01   +5.742979234542307e-01   -4.828514634650583e-02   +7.625665976767673e-01   +1.201809968208091e-01; -3.015010963240681e-01   -1.931739686736601e-01   -4.376849672547514e-02   -2.941251495137409e-01   -1.474321381727725e-01   -1.029493700678850e-01   +7.423220751882245e-02   +2.921873291299930e-01   +2.382060277284753e-02; -3.737037945403997e-01   +3.873204565417360e-01   -3.322805906603520e-01   -3.466773944655490e-01   -5.359177817280834e-02   +4.998933881796371e-01   -8.675589552529353e-02   +1.994526475226087e-01   +5.883091988879376e-01; -3.515468762449568e-01   -1.303272497390003e-01   +3.737588822045483e-01   +3.648906443356571e-01   -4.310446991985746e-01   -6.438453318438588e-01   +1.173758141201650e-01   +4.208126835168128e-01   -1.370171357989043e-01; +2.520445357783772e-01   -3.254288713313211e-01   +2.615483368310273e-01   +3.163811786270531e-01   +2.895433242959031e-01   -1.067743016850822e-02   -8.391204311248694e-01   +2.320418680631486e-01   -6.154690172789662e-02; -6.796763461064292e-01   -1.913237506799790e-01   +3.991997856284553e-01   +5.116509272211018e-01   -1.726679608757363e-01   -5.657867548834447e-02   -2.024950032781089e-01   -1.262348112687358e-01   +4.879070916101257e-03; +1.498817112229692e-02   -4.644406594805019e-01   +1.204083497945653e-01   -2.607131077200722e-01   +5.060104612656690e-01   -3.256188119987710e-01   +4.250846808006514e-01   -1.390239315934489e-01   +2.553571456142519e-01];
L1_L2_iAMPA_netcon = [-8.009715680395253e-02   -2.740624951949202e-01   -1.426602215453082e-01   +4.211596799218323e-01   -2.713864669976152e-02   +2.918329834666301e-01   -3.617822130676240e-01   +2.352749590375008e-01   -1.763929509389785e-01; -5.514939530714791e-01   +5.043467797494270e-01   +9.765689343512407e-02   +5.013764774617420e-01   +2.757262527816658e-01   -2.364373864959226e-01   +6.633230809748338e-01   +2.867208902353203e-01   +1.830412112145912e-01; +1.261004245249634e-01   +4.068892807025977e-01   -1.530449965654804e-02   +1.462305067691969e-01   -2.371602620529567e-01   -4.159178653080398e-01   +4.135739345974478e-01   -4.308697208458065e-01   +3.559013654305682e-01; +2.542599009322512e-01   +2.194263617750549e-01   -1.620686363397403e-01   +3.900328722439693e-01   +7.744215495077289e-02   +4.901996133462819e-01   -4.643100021838737e-01   +4.523464149008798e-01   +6.182323116657823e-02; +1.137574619493634e-01   -5.490313483921450e-01   -1.709200679798456e-01   -1.912018930227495e-01   -3.817316081731645e-01   -4.588483531956444e-01   -2.239426695225912e-01   -3.080429863355737e-03   -4.570139157214770e-01; -6.678241657753693e-02   -2.273021886827936e-01   +3.528041247142946e-01   +5.354486078319636e-01   +8.250890664859536e-02   -1.198819251251200e-01   +2.655747551812970e-03   +1.394078831185640e-01   +2.373276119472114e-01; +3.570018407458369e-01   +3.757972079933625e-01   -4.095889350276908e-01   +4.222251363616865e-01   -1.769018908822900e-02   -8.580275842151593e-02   +2.386317280608600e-01   +2.212903166335773e-01   +2.189080775175122e-01; +6.979126200370121e-02   +4.405395101789873e-01   +3.862056801319294e-02   +1.604176285789005e-01   -2.001191364694562e-01   -3.168069196579499e-01   -2.083980901181303e-01   -2.723118704006880e-02   +6.441718942933992e-02; -8.717939728406277e-02   +1.801775089294489e-01   -7.841908878761775e-02   +2.358421347737018e-01   -1.023794552805392e-01   -9.242697762729966e-01   +7.590089033807108e-02   +4.310452917868962e-01   +4.746219987163992e-01];
L2_L5_iAMPA_netcon = [-6.813416127756151e-01   +2.288064383330078e-01   +7.288485427253066e-02   -3.517543352406707e-01   -3.168218274656628e-01   +1.925693282444206e-01   -4.333112984592921e-01   -1.424032604515714e-01   +3.699957340997297e-01; -7.230026300890726e-01   -1.091760521388277e-01   +2.343216577234790e-01   +9.929813786479771e-02   -3.686178657183877e-01   +2.123530688423006e-01   +4.350979977560987e-01   +3.318709091980666e-01   +6.059705816649553e-02; +1.704395211905701e-02   +2.491252878645664e-01   -4.940888937597643e-04   -1.869457866697699e-01   -3.775196253921065e-01   +1.339307454679027e-01   +1.139729170613292e-01   -4.845129181145382e-01   +6.026358080388000e-02; -1.130320469986385e-01   +4.985593341265257e-02   +1.539647545086731e-01   +8.905135620846219e-02   +2.271130024675528e-01   -4.746842452127203e-02   +1.624794114869759e-01   +6.017146058392531e-01   +1.204731534920842e-01; +3.978463994391967e-01   +6.965412892924348e-01   +1.130848291686798e-01   -3.206758848567752e-01   +2.083350673152117e-01   +4.790180296682073e-01   +1.573653129906160e-01   -6.507242645779109e-01   -3.030861485084022e-01; -6.905810708623922e-03   -2.154618326217848e-01   +2.704614159330563e-01   +5.071430304505203e-01   -3.407834138721323e-01   -1.457407564688767e-01   +4.890083814391609e-01   -6.174389609699056e-01   -8.833695182275131e-02];
L5_L2_iGABA_netcon = [+5.580324358221843e-02   +2.078190851269526e-01   -1.759030104625022e-01   -1.901300228119170e-01   +1.143398596239856e-01   -3.017692163413832e-01; -2.158042089649319e-02   +1.017047973273877e-01   +6.209264940704474e-02   -4.929607663251287e-02   +2.675384085467347e-01   +2.236607551515297e-01; +2.306860661548576e-01   +1.924706804684064e-01   +3.890438033302842e-01   -2.459847820079451e-01   +3.688179332151109e-01   -2.732269265165530e-01; -2.855149859574993e-01   +2.849486422763878e-01   -1.169777127315340e-01   +1.570640571060766e-01   +2.620538200769886e-01   -5.278557144214689e-01; +6.602557010688653e-02   +2.950786401137673e-01   -2.936709504172052e-01   +4.612064808871907e-01   -5.719668183338875e-01   -1.927373479093181e-02; -2.064991356559693e-01   -7.518114498092444e-01   -3.662011989284074e-02   +3.627674482924748e-01   -3.756644983405666e-03   -4.506671034469582e-02; -1.443508060187237e-02   +1.136519799728685e-01   +5.561148153385864e-02   +8.716544515900135e-01   -2.475188899276493e-01   +5.712904777225671e-01; +3.457442619654745e-01   -3.652223157157478e-01   -1.626877031137512e-01   -1.417821985193617e-01   -4.397554415400111e-01   -4.192028725864266e-01; +1.073945924679706e-01   -2.473247359782577e-01   -5.116135358673846e-01   -2.602029020865469e-01   +2.647374462297387e-01   +5.399963262280121e-02];
L3_L2_iAMPA_netcon = [+5.067721032828952e-01   -9.697697924796804e-02   +4.771452338375134e-01   +1.816427484016853e-01   -1.828159255743494e-01   -2.536055864594290e-01; -2.159855072053522e-01   +3.887142101480305e-01   -3.071635840136948e-01   -5.823788845573711e-01   -3.001918726263782e-01   +7.634596690737000e-02; +7.828874235355214e-02   -3.518387663784371e-01   +5.011888747606120e-01   -5.552350677404798e-01   +3.731243666837426e-02   +1.371433777247213e-01; +1.975658131188188e-01   -2.128711835360259e-03   +1.563114700116774e-01   +4.133313892146959e-01   +4.784816463733939e-01   -2.871789347554223e-02; +1.583689681602770e-01   +2.477689981787895e-01   -2.748254277551170e-01   +6.312626297904961e-02   +3.323883187217517e-01   +1.190891431319765e-02; +9.313586237655680e-02   +2.361868565583822e-01   +1.523838054475703e-01   +6.077179863170101e-01   -1.347457802174928e-01   -6.969975484784211e-01; +5.643807462362511e-01   +4.636403822002992e-01   +3.732545909761065e-02   -2.003624775428707e-01   -1.859218361968513e-01   +6.719093149097605e-02; -1.770819735271971e-01   +1.071389245911008e-02   +7.666636995443084e-01   +4.318010589810662e-01   +2.664625735776497e-01   +2.495130569863868e-01; +3.186526075206036e-01   -1.585060567940880e-01   -4.394613803425333e-01   +6.133604383785055e-02   +3.204088059942229e-01   -3.179901165141839e-01];
L2_L3_iGABA_netcon = [+2.573533510853575e-01   +3.160900456907187e-01   +2.574243358961116e-01   +6.087683442437024e-01   -1.848131869332176e-01   -3.207939235812163e-01   +1.497874985872994e-01   -7.325274297904524e-01   +2.243387470617678e-01; +1.972104537365708e-01   +4.200085145668647e-01   -7.489045857649840e-02   -5.328943398716144e-01   +1.385961991916455e-01   +9.633922524335470e-02   +4.003625274932558e-01   -2.139415789125959e-01   +1.450219713605918e-01; +8.199548379452209e-02   +1.415987952588946e-01   +2.388171705017003e-02   +4.840099745147099e-02   +3.126801978040386e-01   +1.347964212927956e-01   -1.202492706672228e-01   +5.183294597941925e-01   +1.807031737826305e-01; +4.863430241387228e-01   +3.399451335232387e-01   -5.424081947736650e-02   -4.904865449971486e-02   -1.775369574641746e-01   -2.109787864343573e-01   +1.544956827342738e-01   +4.354920660391472e-01   -6.047627816429085e-02; +7.125727608967110e-01   -6.219016293824262e-02   +2.727699939200873e-01   +5.034007465926034e-01   -3.399391824702118e-01   +1.909835162441459e-01   -7.399750292320167e-02   -1.179340529391596e-01   +4.799643220550087e-02; +3.664988614678472e-01   -2.277679018340256e-01   +3.579401741052447e-01   +2.483517093334584e-01   -1.434374812704701e-01   -3.176817694005406e-01   -2.043985523369615e-01   -3.571196805611413e-01   -4.569699775690501e-01];
L1_L4_iGABA_netcon = [-7.798051297872890e-01   -1.749428856562926e-01   -1.441380033252730e-01   +2.758338451059619e-01   +1.886993427365425e-01   +8.088443076899928e-01   +3.136650135012501e-01   +5.053419474298670e-02   -1.350660042429774e-01; -1.430227200247332e-02   -1.349569286766713e-01   +3.940236155421498e-02   -8.417585343412816e-02   -7.882375143992009e-01   -7.917985337729862e-02   +4.938003815217629e-02   -1.848010420571096e-01   +1.992736808629973e-01; +1.913964621904482e-01   -1.563949898675721e-01   +5.957464039689704e-01   +1.112703012604063e-01   +1.922791960439253e-01   -6.096837247770404e-01   -2.434440607851573e-01   +3.376980277047782e-01   +4.989457602477160e-01; +3.635949163616779e-01   -6.875106185334795e-03   -5.885654565202350e-01   -2.456705721109221e-01   -3.909883816084656e-02   +1.973202350085422e-01   +1.365093392462488e-01   +3.379426985226060e-02   -1.678582432791891e-01; -3.951186550978733e-02   -4.916020565546687e-02   +7.497578723600214e-01   +5.930978001159742e-02   +2.750488746269039e-01   -1.990778981727611e-01   +2.084286578720764e-01   +2.861947349077107e-01   -7.754613981564061e-01; -1.826620115500449e-01   +3.899417324453214e-01   +1.943227046334643e-01   +2.985473661437835e-01   +5.759749346390626e-01   -5.021996231782213e-01   -5.633923282146387e-01   +2.276405406403977e-01   +1.061029871581379e-01; +8.156550815235217e-02   +1.549211930483157e-01   -1.247826593096635e-01   -4.970558987108626e-01   +5.580509794555952e-01   -4.660210082591631e-02   +5.510883785680745e-01   +1.814685220094394e-01   -1.551835425654395e-01; -3.911513275891208e-02   +5.558400970341970e-01   +7.004648708181108e-01   +4.220627008036600e-01   -1.762167330965952e-01   +7.249738049324164e-01   +7.794078242255684e-02   +1.366718235381746e-01   -3.126301338644305e-02; -1.133916707019118e-01   -4.922534898710292e-02   +2.505137031019127e-01   +4.710225736325340e-01   -2.052651568244365e-01   -1.456100064524742e-01   -4.030182324966356e-01   +2.402923925922167e-01   +1.482115293834727e-01; -3.503696804441228e-01   -3.547992899935413e-01   -4.539155125170402e-02   -2.247422498163313e-01   +1.090247485069486e-01   -1.444620548245012e-01   +7.657761195829682e-01   -6.017781942032488e-02   +3.258126031361716e-01; +5.050990135844483e-01   -2.003874825996389e-01   +3.958360629378000e-01   -6.207099511850472e-03   -1.130010186257548e-01   -4.662049758326112e-02   -5.866353190300971e-02   -2.802710519261874e-02   +3.781256134102151e-01; -8.630717625437176e-02   -2.977473298283659e-02   -3.337186817077085e-01   -1.645279411932508e-01   +5.330323277783158e-02   -4.125499928963913e-01   +3.285435235211969e-01   -4.432477904395662e-02   +6.549000162463958e-03];
L4_L1_iAMPA_netcon = [+4.062417006125596e-01   +2.217942268314541e-01   +4.644700963484637e-01   +2.550844576379586e-01   +7.317907009265642e-01   +4.493454786841193e-01   +1.486676287120834e-01   +1.080741062859215e-01   +3.259711290134213e-02   -1.091272149983719e-01   +1.183687954289392e-01   -5.291382682471504e-01; +3.059140334307361e-01   -9.372091319789244e-02   +3.452962625179306e-01   +2.916484714445752e-01   +1.291447950104721e-01   +3.041695470763202e-01   +3.070010062479844e-01   -4.794804734606374e-01   -7.038245173716187e-02   +2.514432886265558e-01   +9.004850306170369e-02   +2.768833262874239e-02; -1.071589883043709e-01   +2.131327257050809e-01   -3.606156675531551e-02   +1.664806120732821e-01   -1.697252918464940e-01   +2.961538259710276e-01   -2.571188788749186e-01   +4.220222525078486e-01   +1.719600364259179e-01   -3.349819736567596e-01   -2.472577186242426e-01   +6.478577609845618e-02; +2.197172182127391e-01   +2.794243641478611e-01   -3.532745471543925e-01   +8.858996265963217e-01   -3.545525111545437e-01   +1.163725483515866e-01   +3.311717076064170e-01   +2.238066407207597e-01   -6.405517601842048e-01   -1.181617475625935e-01   +8.350040507223988e-04   -4.699438472132700e-01; -2.551632519213148e-02   +2.655210524336050e-01   -3.353608276837652e-01   +4.796739161266471e-01   -1.259559434037839e-01   +1.680696644014414e-01   -3.087249929248086e-01   -2.247398904589309e-01   -2.267943280501850e-01   +2.211285416100476e-01   +3.141139462642777e-02   -2.133703407634850e-01; +3.853207753321819e-01   +3.122558728812700e-01   -4.022451402608876e-01   +2.086784623581961e-01   +5.073164884896308e-01   -3.830455036669546e-01   -3.414341991874099e-01   -2.242704964720031e-01   -2.340136453930546e-01   -2.988809175143824e-01   +5.207837082508532e-01   -5.738085476701409e-01; +2.166498379704820e-01   +5.361871004154910e-01   +2.764774397018133e-01   -1.707907796396247e-01   +5.205210544770309e-01   +1.085918191177876e-01   +4.402061102091340e-01   +4.715387014916989e-01   -5.450465776279853e-01   +1.654111304662626e-01   +4.081477425477485e-01   +3.780026355733178e-01; +1.801738538885336e-01   +1.152682636307437e-01   +2.064064479425573e-01   -2.244794775392402e-01   -5.296997493204564e-02   -2.794059104756563e-01   -5.460171618069527e-02   +8.782943474065676e-02   +3.117433193413224e-01   +2.886712135594397e-01   -3.260063704563340e-01   -6.192132777594493e-01; -5.340814796253793e-02   -6.372329314037946e-01   -3.601234941544768e-01   +2.009883769341522e-01   -1.522416821727876e-02   -1.441686525285918e-01   +2.472554002455340e-01   +2.892720193271497e-01   -1.859030315627964e-01   -6.556782106974313e-01   -2.433921479703642e-01   +5.723561024501007e-02];
L1_L3_iAMPA_netcon = [+3.176868791082111e-01   +1.082484156200688e-01   -1.133354089927706e-01   +3.157715621438405e-01   -5.858873893500305e-02   +1.761515126665021e-01   +1.341864945035957e-01   +1.814255487515917e-01   -6.154613908728138e-02; +1.116917340946007e-01   +1.153414613333771e-01   +2.397346531727355e-01   -5.209016032310416e-01   -5.204640798277261e-01   -1.008519439412406e-01   -5.689097715346718e-02   -4.752093154530422e-01   -3.960244973863064e-02; +4.084240346210898e-02   -1.823939244952434e-01   -3.179788767868030e-01   -1.637445117968133e-01   +3.320939002144142e-01   -5.738571255132274e-01   -1.531999013680615e-01   +3.764789976622057e-01   -1.122764749608856e-01; +4.863861858881072e-02   -8.777166372552124e-02   +4.321662370167634e-01   +4.354306536850022e-01   +2.043496237376034e-01   -2.307800930806767e-01   +3.540211697096134e-01   +6.035649742920196e-01   +3.348714015103177e-01; +8.108759188726495e-01   +6.804406740174729e-02   -4.479361646959635e-01   +1.121727130703574e-01   -6.201492050955617e-01   -4.631419604740858e-02   -1.366519956183035e-01   -3.002031457602744e-01   +7.575670091496342e-02; +5.335133810104186e-01   -7.553056816217478e-01   -7.257794061522355e-02   -1.630330740626067e-01   +5.406926583638092e-01   +1.965174816801247e-01   +5.458683767525041e-01   +4.800588621640536e-01   -2.510209531444907e-01];
L3_L1_iGABA_netcon = [-1.074566673250739e-01   -3.201545135853616e-01   -1.905028735348205e-01   -1.531942932831372e-01   -3.495149519942661e-01   -2.083458549066081e-03; -3.128829531214104e-01   +3.650097000857898e-02   -6.020128897109962e-01   -3.499931982387429e-01   -3.823567351033995e-01   +3.191063076830137e-01; -4.098045002059617e-01   +4.784072175346498e-01   +2.438576242734187e-02   -3.626099984418056e-01   +2.097358323356346e-01   +3.091053794756548e-01; +2.563404159485107e-01   +2.271579187519521e-01   -4.245500161618664e-01   -2.786677423056857e-01   +2.938997144446646e-01   +8.232462787505651e-02; +6.122542739804844e-02   -2.797409187919680e-01   +3.738220039743004e-01   -4.056630881424447e-01   -2.888771025671771e-01   +4.268644706333933e-01; -5.118686762748431e-02   +9.963118337039320e-02   +5.131839004917360e-02   +1.771671634051823e-01   -1.526772414727319e-01   -1.182835013721142e-02; -2.708271761996034e-01   -6.999343203959500e-02   +3.499775470994350e-01   +6.494867718314072e-01   -8.308672991048169e-02   -3.719593579350627e-02; -1.791064447879812e-01   +2.140218592466114e-02   +3.397994880973290e-01   -7.376565999040224e-02   -2.223166211187668e-01   -2.245318256910855e-01; +5.092708528996065e-01   -2.820046760978664e-01   +1.604911387843760e-01   -1.554177082991021e-01   -5.499485688887228e-01   +9.738259850769285e-02];
L5_Input1_iAMPA_netcon = [-1.469464152960061e-01   +1.092124578229134e-01   +4.907234448730992e-01   +1.570251059589886e-01   +1.654648017461638e-01   -9.701567981492940e-02];
L6_Input2_iAMPA_netcon = [+8.345605760669811e-03   +1.789648775766359e-01   -3.130969035097266e-01   +6.909908863377014e-01   -5.809527541935013e-01   +6.223355348012496e-02];
L5_L6_iAMPA_netcon = [+9.278388828991509e-02   -1.302817982775014e-01   -1.874527972391244e-01   +2.591230859778171e-01   -4.733473326389350e-01   +2.506034945663398e-01; -2.672182244042837e-03   -5.308305848056110e-01   +6.576412804571176e-01   +2.819321906705021e-01   +1.533449437943856e-01   -6.565161879748130e-01; -1.572726685049602e-01   +2.569403367672320e-01   +2.765591354125457e-01   +5.827623228459053e-01   +1.708627646772691e-01   +1.277034995412438e-01; +2.149163666257922e-01   +5.528728155278695e-02   -9.880420297032853e-02   -3.408397983159944e-01   -6.599529963395796e-02   +3.693308523729541e-02; -1.221778044146597e-01   -6.439648127802640e-01   +3.541244648638667e-01   +3.127958675533182e-01   -3.565159659047137e-01   +5.147891196000633e-01; +3.502647358518018e-01   +5.447896329769456e-01   +1.908305616015681e-01   +7.580519259380156e-02   +2.914278420997576e-01   -1.323423611847654e-01];
L4_L5_iGABA_netcon = [-5.403561257928572e-01   +5.141193615371558e-01   +3.449793523000766e-02   +2.896990812023981e-01   -3.254105222194430e-01   +4.492253264914872e-01   +5.730440431450468e-02   -1.696547805201215e-01   +2.719899557172710e-01   +2.384835738166844e-01   +2.307851888624023e-01   +3.820612359973754e-01; +3.398685780136537e-01   +2.724702525956652e-01   +5.811543206955566e-01   -3.640761534886355e-01   +1.335496208492081e-01   +3.055261517281880e-01   +2.832524594382427e-01   +3.637112759087428e-01   -1.431484492830473e-01   -1.806663743146820e-01   +1.627397565364614e-01   -4.508265042909663e-01; -2.367787820386511e-01   -3.665899420952520e-01   +3.949481332827987e-01   -8.410205198312509e-03   +5.354532158110575e-02   -2.725018896965274e-01   +1.758459138432285e-01   +1.052434727790269e-01   +3.097519135368087e-01   +5.251859953052809e-01   -2.877194966688257e-01   -1.428058304709643e-02; -4.996879865611117e-01   +4.012043665161950e-01   -1.197330688787496e-02   -3.728366389086887e-01   +6.100798154646958e-01   +2.236394642999541e-01   +1.523905747132615e-01   -2.559905806915937e-01   +1.262040947560682e-01   +3.570795289504596e-01   +6.953694452977033e-01   +4.316366471430982e-01; +2.076007194286804e-01   -5.818858785471120e-02   +1.822779273473532e-01   +1.292128998978778e-01   +2.485176767132734e-01   -8.713598153215540e-02   +3.233019316979562e-01   +1.596247919416845e-01   -6.958612608456442e-02   +2.444752368561731e-01   +2.185352347786287e-01   +3.228528203443413e-01; +2.697459612814732e-01   +3.584702127772162e-01   -6.790427382728902e-01   -6.550794540022140e-01   -3.683492204782286e-01   +1.421694656561977e-01   +8.735361888860173e-02   +6.735044333802136e-01   +2.407337996913527e-01   +1.655002383961957e-02   +6.116074810979490e-01   +1.932882606010840e-01];
L6_L4_iAMPA_netcon = [-1.214084464976375e-01   -1.355427984438161e-01   +1.131710379741190e-01   +3.991934421868434e-01   +1.435233708758493e-01   +2.434930438923001e-01; -2.933813832669057e-01   -2.320148712615737e-01   +1.640092287344007e-02   +9.287292985443293e-02   +5.070081970225002e-01   +5.690452908766249e-01; -2.692903900341564e-02   -5.903558390041637e-01   -4.599375527906024e-01   -9.890479685072806e-02   +4.121865584153631e-01   +3.849218741975224e-01; +6.775172559520055e-01   +9.727640731746748e-02   -1.987929094915369e-01   -1.038886144074413e-01   -1.120538609662155e-01   +7.475805068980856e-01; -3.434745439247899e-01   +2.921746604817488e-01   -4.538877512798717e-04   +6.248434386768899e-01   -3.206057380539812e-02   -7.047345484369051e-02; -3.748596337007337e-01   +6.195391501466048e-01   -1.270122319161024e-01   +7.202522565780510e-02   +1.662271783226510e-01   +1.401004360380465e-01; +1.738442419733045e-01   -4.687353464513230e-01   -5.406451204536882e-01   +3.806604340837855e-01   -1.656298316330734e-02   -1.769732007796503e-01; +4.458311966231705e-01   -1.371792836072909e-01   +4.486171463587875e-01   -3.335823076980310e-02   -1.572464671541279e-01   -3.169153432296370e-01; -2.937735865400503e-01   +4.282557466079235e-01   +1.114391503107650e-01   +6.482435371965972e-01   +6.473626714044642e-02   -3.353116431583145e-01; -5.621714398438428e-01   +2.565982035615733e-02   +2.164196464255794e-01   -6.960574097987565e-02   +5.172144872487163e-01   -2.921871968198573e-01; +1.835134210564561e-01   -2.726906494681317e-01   +7.101378170552754e-03   -1.114860591227869e-01   +4.746654685067646e-01   -2.259385281951912e-01; +8.183243239495372e-01   +1.234176783346394e-01   +1.044424682486722e-01   +1.450316175733548e-02   -4.653088522716117e-01   +9.181753037008802e-02];
L5_L4_iAMPA_netcon = [-3.639443088535838e-01   -1.118887859198886e-01   -4.604015450465826e-01   -3.874674439624349e-01   +1.789048075627857e-01   -4.448556707918865e-02; +4.594295451100546e-01   -3.243618388662044e-01   +1.159430761010980e-01   +4.294660483260959e-02   +1.055178602260000e-01   +5.955759071618263e-02; +4.419067329476922e-01   +6.318144064920239e-02   +4.283611355958845e-01   -2.389990361591784e-01   +1.569628521608822e-01   +2.755561360042700e-01; -3.092011951293369e-01   -2.778263413935803e-01   -3.588732887618559e-03   +6.336506672304367e-01   +2.354354024372229e-01   +1.810224708206805e-01; +3.508119359023154e-01   +6.904087477392667e-01   +3.278245661006760e-01   +5.105959651756362e-01   +3.718742428929630e-02   +9.888966786186093e-02; +4.351720269336676e-01   -2.962259193608640e-01   +4.878215094925678e-01   -6.286656551337835e-02   -1.806036231249076e-01   -8.723468730236408e-02; +2.869725684676160e-01   -2.320243382758140e-01   +5.647920425700583e-01   -2.013932584833770e-01   +2.352931129580698e-01   +1.679913454865730e-01; +2.405306415979779e-01   +8.590251239574684e-02   +6.721839067413138e-02   -1.544496279149545e-01   -3.648175461808308e-01   +2.585290443823181e-01; -2.465737370926938e-03   +8.610365132130099e-02   -4.892502712734232e-01   -4.119524889851511e-04   +2.966520876203238e-02   +2.302771598315377e-01; +3.931321909208414e-01   +4.379316570068235e-01   -5.938484876308612e-01   +1.954685614027330e-01   +5.075501230277554e-02   -6.126532139689284e-01; -1.110635949854561e-01   -5.652135486067641e-01   +1.050159753950765e-01   +3.432880535316681e-02   -3.065443353541709e-01   -4.003105096153889e-01; +2.020955537082395e-01   -3.906555317439412e-01   +3.045710186815304e-01   -3.357719376920850e-01   -2.946308672683764e-01   +5.785473006864580e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
