function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.324894308899787e-01   +1.242354722277358e-01   +2.553923581342287e-02   +2.355224405784289e-01   +3.300469386315880e-01   +3.609067364360674e-01   +1.331161933122135e-01   +2.306973473557139e-01   +6.742775996416685e-02; +8.592408216538439e-02   +1.364292704106129e-01   +3.214256852855461e-01   +1.687299986890780e-01   +3.634867942311624e-01   +4.292236661659826e-02   +4.827376784105417e-02   +9.130830192408869e-02   +1.502540321864222e-01; +6.607904137822437e-03   +2.350464140160448e-01   +1.838976592123609e-01   +3.307609740123563e-01   +5.515480722238428e-02   +2.302666949511187e-01   +2.467192140901140e-01   +3.227160545388935e-01   +7.420438802456297e-02; +1.410526479309028e-01   +5.060607126283753e-02   +3.608771458404224e-02   +3.347446436454389e-01   +1.297088841791413e-01   +2.268436098580241e-01   +9.905437541883264e-02   +1.975474560981198e-01   +2.681569975444292e-01; +2.143447472917906e-01   +3.752469422006129e-01   +1.732189434569065e-01   +2.372775948975341e-01   +2.952687313022621e-01   +2.136770801258114e-01   +9.074857192658206e-02   +4.204292758314782e-01   -1.942870631238828e-02; +2.672906897812483e-01   +3.491455207585573e-01   +2.927991710101870e-01   +9.570572327876310e-02   +3.172967322681053e-01   +1.041844500661518e-01   +3.656843978614995e-01   +3.238702642103131e-02   +3.009059178524426e-01; +3.347648645154358e-02   +3.470991155351474e-01   +3.866141749081798e-01   +3.542311637448743e-01   +4.091684619593485e-01   +8.601755550573958e-02   +3.105303427907354e-01   +1.607675022286963e-01   +1.344481969387094e-01; +1.087499998770304e-01   +3.154603507537515e-01   -2.348153835746771e-02   +8.299340658773344e-02   +3.252215980923310e-01   +3.513458122535480e-01   +2.901754085968808e-01   +3.955482418531030e-02   +2.752280368903325e-01; +2.311008798556031e-01   +1.495367483569813e-01   +2.671044568554006e-01   +3.639395291568923e-01   +2.799809892790002e-01   +3.647088218066477e-01   +2.378878470820376e-01   +7.738326000858975e-02   +3.394192516680776e-01];
L1_L2_iAMPA_netcon = [-1.227306783954919e-02   +1.963562346853571e-01   -3.711055010031263e-02   +2.385772048753898e-01   -2.770754969458267e-03   +3.356214813611301e-01   +6.586997463749183e-02   +1.269000311393552e-01   +4.228388943910230e-01; +2.509605648563742e-01   +3.916718954215732e-01   +3.161568237451864e-01   +1.889638438680152e-02   -1.437252355352555e-02   +1.900098136017908e-01   +3.123342340340334e-01   +6.329660670719281e-02   +2.623435241766063e-01; +4.569871271056325e-02   +1.076397742253494e-01   +9.009109721660248e-02   +9.720434753223614e-02   +6.793106401134796e-02   +1.557986859054652e-01   +1.075524431064041e-01   +1.724838779235001e-01   +1.982158667493767e-01; +3.493497393746134e-01   +3.315053467815389e-01   +3.753677597946874e-01   +3.795083758770812e-01   +1.909864734706205e-01   +2.159245423811296e-01   +3.077765743417873e-01   +2.302975016231434e-01   +3.010469897111733e-01; +2.855674971991974e-01   -2.219434496068117e-02   +8.441985892361990e-02   +2.057648659365303e-01   +6.259102966326362e-02   +2.779601484005820e-01   +3.229311667614996e-01   +4.591344263046149e-02   +1.356739716983937e-01; +2.620286488094072e-01   +2.207149491717248e-01   +3.839329752969969e-01   +3.947764916692116e-01   -9.824562155341006e-03   +1.654811251096985e-01   +7.436571948799385e-02   +2.255244125296439e-01   +1.413140338807903e-01; +3.350545185887047e-01   +9.511419644003503e-03   +2.719895039301868e-02   +2.621458241402980e-01   +2.311022656049514e-01   +3.739753692513014e-01   +7.845297421477095e-02   +2.200515732978815e-01   +5.443930816543865e-02; +1.942907044946163e-01   +2.961740416652693e-01   +1.188075520973113e-01   +3.262636638945893e-01   +1.552515104155635e-01   +3.057033997025627e-01   +3.281449851563709e-01   +8.688620645416677e-02   +2.779479588071510e-02; +3.954890566804210e-02   +1.091551733453915e-01   +2.426075034607023e-01   +3.511860515998928e-01   +3.680760182043036e-01   +8.873109813099109e-02   +4.047720714014197e-01   +3.589371844421164e-01   +2.182754965656797e-01];
L2_L5_iAMPA_netcon = [+2.750280668542489e-01   +2.012854405920885e-01   +1.718374633821735e-01   +3.770104883346223e-01   +3.753491102179234e-01   +3.230037792966365e-01   +3.626450854374646e-01   +3.598050327562378e-01   +1.987266402832722e-01; +1.703353162771556e-01   +1.921249378607170e-01   +3.610082800458601e-01   +2.461857856970890e-01   +1.826372508535461e-01   -3.522024724999920e-03   +1.027037074618943e-01   +1.768458023148199e-01   +3.024697650894838e-01; +9.449729221853284e-02   +3.091697347696327e-01   +1.554804047635635e-01   +9.097991251295147e-02   +3.837267196618921e-01   +5.170866483137656e-02   +1.549062720549661e-01   +2.656881819543060e-01   +2.097948082195092e-01; +1.545727249679420e-01   +2.415410830438682e-01   +1.520532754983862e-01   +4.053155364304414e-01   +2.492936841436939e-01   +3.517227062888125e-01   +3.932895098851394e-01   +4.076419945827761e-01   +3.467052773957748e-01; +3.312533559497992e-01   +2.889757944070392e-01   +1.664342099875928e-02   +3.219332305972031e-01   +2.959579731283186e-01   +2.844864201700554e-01   +4.915850382935497e-02   +1.389749813375333e-01   +3.171577185808638e-01; +4.176370199090546e-01   +2.365543921794615e-01   +3.250581163059952e-01   +1.357041071435593e-01   +1.481045202227107e-01   +3.123927918459800e-01   +2.851736613526508e-01   +1.347928953867179e-01   +4.024147677018180e-01];
L5_L2_iGABA_netcon = [+3.948053354450124e-02   +3.076699532392835e-01   +1.634255948665245e-01   +3.766479489917329e-01   +6.186362588039414e-02   +4.481602993568536e-02; +4.569483926493657e-01   -1.799757482190264e-02   +1.471308202240950e-01   +3.029766406909103e-02   +3.530898035708943e-01   +2.483973060745109e-01; +1.205458029065395e-01   +3.481868709569331e-01   +2.697518105292157e-01   +7.935598802804042e-02   +1.117194065048692e-01   +2.541602201615362e-01; +7.490660709196548e-02   +1.598984699334295e-01   +3.920162611925081e-02   +4.635004628002377e-02   +1.230996933684659e-01   +3.053954569084825e-01; +1.201288642365619e-01   +3.189413379438470e-02   +3.845381242946214e-01   +3.554436939629387e-01   +3.280621640382525e-01   +2.673786172401905e-01; +3.053658614229653e-01   +2.478073462465733e-01   +2.599696797125349e-01   +2.914846924176522e-01   +3.273577001064083e-03   +1.131965242807770e-01; +1.347848380110595e-01   +4.067937757132870e-01   +1.487274336717166e-01   +5.191834746769253e-02   +2.664587635695945e-01   +2.336471772131482e-01; +1.134178733711736e-01   +4.362331155275534e-01   +1.456609442463745e-01   +9.222497027521362e-02   +2.199277143469469e-01   +2.368870496313707e-01; +2.365829563186159e-01   +8.213969385921352e-02   +1.221076672491971e-01   +3.801693642070833e-01   +4.413761027505135e-01   +1.708110368392481e-01];
L3_L2_iAMPA_netcon = [+1.612728309946111e-01   +3.508316588332077e-01   +1.117891129249972e-01   +2.044086726925973e-01   +3.904170083699560e-01   +3.625512377704384e-01; +9.453707608653661e-02   +7.631115086312965e-02   +2.971156994640009e-01   +1.295049292255558e-01   +1.146083376669117e-02   +4.212883164034605e-02; +3.132377589356294e-01   +9.351025941209595e-02   +1.637769147676449e-01   +3.470316242515261e-01   +1.576460540845730e-01   -4.385542489932879e-02; +7.755539556153263e-02   +1.765824414979302e-01   -2.284473331443151e-02   +2.663769052416677e-01   +6.409148669352310e-02   +2.499258967244459e-01; +1.769557863091708e-01   +5.061499439402672e-02   +1.157469882728981e-03   +3.500955839590303e-01   +1.080044745910906e-01   +4.110229404135571e-01; +7.392797402288895e-02   +3.176179780287551e-01   +6.932485451634758e-02   +3.783618937284756e-01   +3.033016671324405e-01   +2.934154306237372e-01; +1.865399788041764e-01   +5.429495856735306e-02   +2.576708321242525e-01   +2.186160847995705e-01   +2.232286398242905e-01   +1.126648584275492e-01; +3.379283621473352e-02   +7.196251070444599e-02   +3.998294672334716e-01   +9.648320132703345e-02   +3.577888907505650e-01   +8.110135173438181e-02; +3.975337734191606e-01   +4.050497699591090e-01   +9.482179749655326e-02   -8.672680710913379e-03   +3.156286525051822e-01   +2.531679345991061e-01];
L2_L3_iGABA_netcon = [+2.259131493630697e-01   +5.536438874562615e-02   +2.297436300302730e-01   +2.947821360353565e-01   +3.398684286151452e-01   +2.077184643490737e-01   +3.651223948491371e-01   +6.253186207809881e-02   +9.390223983068334e-02; +3.340125413389669e-01   +4.155732366431681e-01   +2.055198325722384e-03   +5.708215515894692e-02   +2.765037985497054e-01   +3.309857383499527e-02   -5.142528379050641e-02   +2.026080696188142e-01   +1.559599323876798e-01; +1.005285727759856e-01   +2.337636022722393e-01   +2.634269877577008e-01   +3.513649343766367e-01   +3.274689381408615e-01   +1.543096011297576e-01   +9.952802798202876e-02   +1.718295193679814e-01   +3.628130808926804e-01; +7.572435964653945e-02   +5.538716235848261e-02   +1.160575372286408e-01   +1.320659195067721e-01   +3.413955092993760e-01   +3.377699556935237e-01   +5.423036983396424e-02   +1.890697482913518e-01   +3.767111316421428e-01; -5.695784159513123e-02   +3.046106700229377e-01   +3.790029962630064e-01   +1.540844638753156e-01   +1.775468103438045e-01   +3.884696889515944e-02   +3.672393571617800e-01   +3.181105797159179e-03   +1.242790208991726e-01; +2.355126777285469e-01   +3.556447379293935e-01   +1.187940855720699e-01   +2.844943055979148e-01   -3.323057851766192e-02   +2.037650396003745e-01   +7.043156587580783e-02   +2.800554955528045e-01   +1.993735822952608e-01];
L1_L4_iGABA_netcon = [+1.343079874813821e-01   +2.287443217925549e-01   +2.970973237399492e-01   +3.278635366589864e-01   +1.113159213512496e-01   +2.717730415009958e-01   +4.232919165765911e-03   +1.394897506200060e-01   +4.184536752346715e-01; +3.585452525210757e-01   +1.759676113247469e-01   +1.628156404007614e-02   +1.338928835747631e-01   +9.744359823355260e-02   +2.666521901152347e-01   +7.706188478915042e-02   +1.548502753098358e-01   +3.714215153197983e-01; +6.035808553657099e-03   +1.602267126311937e-01   +3.062296344987784e-01   +2.723989063013806e-01   +1.754240631908144e-01   +1.239404343648522e-01   +2.674586274576524e-01   +2.335850548921626e-01   +3.360487537323203e-01; +3.205123185289566e-01   +3.827208912035928e-01   +1.073660792901551e-01   +1.770136492919096e-01   +2.446665098133234e-01   +3.859425133026890e-01   +4.328336012076132e-01   +4.560968739996787e-02   +4.391220385388619e-02; +2.296723725657666e-01   +1.494959328708854e-02   +1.905525550054097e-02   +3.683375807057258e-02   +3.852101290165162e-01   +9.130923492418290e-02   +8.902342850935788e-02   +9.022298279374427e-02   +2.569468395370939e-01; +1.738395925219828e-01   +2.952695939459246e-01   +2.074553417022234e-01   +2.985183232570256e-02   +8.132924714022396e-02   +7.573443269915732e-02   +2.305849335291845e-01   +7.775307354253111e-02   +3.767333615118021e-02; +6.459940718904478e-02   +3.135135864820150e-01   +2.631212360184705e-01   +2.647881757373975e-01   +3.763464837848847e-02   +1.178940354391813e-01   +5.214280574240136e-02   +2.303550020961812e-02   +3.871232494491961e-01; +2.780974716978055e-01   +1.014150076359924e-02   +3.416699219242438e-01   +2.667212369747956e-01   +2.064300974225552e-01   +2.361350835090406e-01   +1.248730962285778e-01   +1.614496246038813e-01   +1.135437502103067e-01; +1.644054220917789e-01   +1.330982928905053e-01   +1.967467788067596e-01   +2.252279187738699e-01   +8.474285334848951e-02   +2.384617348412950e-01   +1.129491640151505e-01   +2.193184005765311e-01   +3.850738381596187e-01; +7.255742847842286e-02   +1.414296828551924e-01   +3.120500870709609e-01   +1.550040409417778e-01   +3.094448865397917e-01   +1.403601106486662e-01   +2.849669791364811e-01   +1.138757366924549e-01   +2.256212029544588e-01; +8.537810083706072e-02   +1.381560857483464e-01   +5.607363761190277e-02   +3.747003372696790e-01   +3.649615771245217e-01   +3.328455148348755e-01   +5.435874456332804e-02   +2.191916130031798e-01   +3.028937380774112e-01; +1.846334558163931e-01   +3.936161645893744e-01   +2.487061250380262e-01   +2.393275917655948e-01   +1.362085018011004e-01   +8.210079535205218e-02   +7.473279979450252e-02   +1.990390168399482e-02   +3.140092455998671e-01];
L4_L1_iGABA_netcon = [+2.664344099913263e-01   +1.648632379862851e-01   +4.263721086195875e-02   +2.011841119587963e-01   +1.377935028550982e-01   +4.859560494950022e-02   +2.074791374371196e-01   +2.378000932723029e-01   +1.275749115632214e-02   +7.394930327901000e-02   +2.317562248230906e-01   +3.480728328026952e-01; +6.514746795785420e-02   +1.604701093239915e-01   +3.669092413949338e-01   +4.234699578295415e-02   +3.215260525757413e-02   +3.394085397580563e-01   +4.546439100769434e-02   +3.703279672136316e-01   +3.602767197913269e-01   +3.433444315372158e-01   +4.305780384878470e-02   +3.836125978771680e-01; +9.870671193405192e-03   +1.412847600497244e-01   +1.299648232165215e-01   +3.358821660759428e-01   +1.479658019543048e-01   +1.045567289848143e-01   +2.780065398926732e-01   +4.332185787145641e-01   +3.120845289042267e-01   +3.113818367937223e-02   +2.451992355257603e-01   +8.814192925571168e-02; +1.135563035833115e-01   +1.761196672663112e-02   +3.800629656894957e-01   +3.679518838003764e-01   +1.360148208311164e-01   +3.152647676048384e-01   +2.621992034292999e-01   +4.143276618150496e-01   +3.499591825925046e-01   +1.337078696472006e-01   +3.977675716834941e-01   +2.249449211452497e-01; +2.059725039799432e-01   +8.592422260735166e-02   +7.645665692362641e-02   +3.547966241384087e-01   +8.698653761020256e-02   +1.587669391188913e-01   +2.145206096801115e-01   +1.718390214370056e-01   +3.182088438633459e-01   +2.206638705213508e-01   +1.772128864989768e-01   +6.263423065080884e-02; +6.634546284413649e-02   +4.191368190869846e-01   +2.923603689714241e-01   +4.033265064219891e-01   +1.518149073441632e-01   +1.149682944192063e-01   +3.013314950485092e-01   +3.966021118338489e-01   +1.129886300906124e-01   +2.168018485706295e-01   +3.162999142452404e-01   +1.821229464623208e-02; +1.628581341168032e-01   +7.548120133830725e-02   +3.361914434120509e-01   +3.092460437681848e-01   +3.910652526389766e-01   +3.069913501209921e-01   +1.118249183922617e-01   +2.203106843189620e-01   +2.072724100771690e-01   +3.572968797299100e-01   +1.175932283248046e-01   +2.889014036778896e-01; +1.147492754668851e-01   +1.702436004304228e-01   +1.396383289879247e-02   +1.738284143674224e-01   +4.730813646645454e-02   +1.143299929231639e-01   +1.340432523648676e-01   +3.419241435081236e-01   +2.267838763523969e-01   +8.255795872378063e-02   +3.972857338820131e-01   +3.115679749682413e-01; +1.704463949234643e-01   +2.445766335729682e-01   +4.413427700660439e-01   +3.616264498032852e-01   +2.731300245032933e-01   +1.875078211256753e-01   +1.734642572719118e-01   -6.006106174765144e-03   +2.740476993790980e-01   +2.650729006226201e-02   +1.170317476985570e-01   +1.336241592840111e-01];
L1_L3_iAMPA_netcon = [+1.989416388557735e-01   +3.106187238458007e-01   +2.988401899387806e-01   +4.357551487503113e-02   +3.405275892839421e-01   +3.434368889387756e-01   +7.184460428341574e-02   +2.099855969087854e-01   +3.574340107849332e-01; +1.691526185513660e-01   +3.476277167154880e-01   +2.956623279880072e-01   +3.650828770729732e-01   +4.667800171959169e-01   +3.259233581486248e-01   +3.811166688488875e-01   +5.718928007133363e-02   +2.601732449405441e-01; +3.828373195489212e-01   +3.195112064134372e-01   +1.275696298041009e-01   +2.727943235467907e-01   +3.003237422088457e-01   +2.249298226849674e-01   +1.749943170435212e-01   +3.902612207450962e-01   +2.121561096930717e-01; +5.906741982188126e-02   +3.273200927778318e-01   +1.942484788245316e-01   +2.349322812753899e-01   +2.711947451908386e-01   +1.977002447729295e-02   +1.149232713904523e-01   +2.643610678838402e-01   +3.405337364082439e-01; +2.604084738617365e-01   +4.048095283383711e-02   +3.049632209084720e-01   +2.686050846546532e-01   +3.788777112147710e-01   +3.899393499298088e-02   +1.806545856526779e-01   +3.542554512057883e-01   +2.797346359292730e-01; +1.170240675443806e-01   +8.584364843031832e-02   +7.157599188446614e-02   +3.392797980105972e-01   +4.580908965012295e-01   +2.274437679601579e-01   +3.054682634547774e-02   +1.952833913536667e-01   +2.656960270040567e-01];
L3_L1_iGABA_netcon = [+4.032232035491319e-02   +1.222748361272775e-01   +2.922327838573489e-01   +2.002155616343774e-01   +2.584481324217884e-01   +3.549576580612297e-01; +3.697110270211772e-01   +3.877261399061409e-01   +1.743926267070006e-01   +2.184554160623234e-01   +1.200538852577870e-01   +3.217731412510460e-01; +3.154626995949612e-01   +3.509038529149632e-01   +2.507857215726694e-01   +3.846468102713422e-01   +1.681269426770143e-01   +1.344004434755047e-01; +2.248892713286204e-01   +3.629828798049095e-01   +3.243827655585496e-01   +3.404443497489824e-01   +1.024533319541615e-01   +1.779261895749040e-01; +1.816778972267266e-01   +2.960356248923214e-01   +8.679516212402713e-02   +2.392557857668819e-01   +1.060423148511935e-02   +7.121550319304285e-02; +5.030501221891184e-02   +2.829082491156866e-01   +4.079610303073750e-01   +9.451112622156167e-02   +3.514718359800284e-02   +1.972808370426677e-01; +6.263327775740926e-02   +4.203827956042547e-01   +1.872262309436836e-01   +1.474840113408847e-01   +2.700847053896603e-01   +2.268708229205251e-01; -1.775161121557912e-02   +1.628879132150427e-01   +3.780806422852344e-01   +2.081542439095664e-01   +8.204869864061619e-02   +1.532922140806602e-01; +1.822489032650078e-02   +3.730092505889823e-01   +1.945458029466340e-01   +1.348712322377222e-01   +2.886690151618906e-01   +3.136043054098129e-01];
L5_Input1_iAMPA_netcon = [+1.446430250947238e-01   +1.381485597319374e-01   +2.948999843129537e-01   +1.628637097628108e-01   -1.497291114241369e-02   +2.306878626738515e-01];
L6_Input2_iAMPA_netcon = [+2.915536463320041e-02   +3.508999234219407e-01   +1.918403122147609e-01];
L5_L6_iAMPA_netcon = [+4.173087186307426e-01   +3.693608699271918e-02   +3.306929478831179e-01   +2.834588506732225e-01   +3.561738817896162e-01   +2.707476664526587e-01; +1.929335352610123e-01   +7.594763230287155e-02   +2.383743701669427e-01   +1.745819640129151e-01   +1.178194729753285e-01   +3.398859773831337e-01; +3.865161084207395e-01   +3.360783720096926e-02   +1.611707719633695e-01   +1.149902466868694e-01   +4.322277578036799e-02   +2.071711989314039e-01];
L4_L5_iAMPA_netcon = [+2.975421126891425e-01   +3.850013697044418e-01   +1.392881954557363e-01   +7.674834920667525e-02   +9.950692206275807e-02   +3.804175235376250e-02   +1.484344469370630e-01   +2.045405583346657e-01   +1.611992718056696e-01   +2.177463599981491e-01   +9.422962510811478e-02   +4.661507828538065e-02; +3.626157388694257e-01   +5.867898127269584e-02   +1.906128344944796e-01   +4.803311882642249e-03   +4.945624280189619e-02   +1.631196115140267e-01   +2.558272614332813e-01   +1.738715212414274e-01   +4.400908217795437e-02   +5.152168284635683e-02   +3.413697629581214e-02   +4.038444457789727e-01; +6.880398421556354e-02   +2.251678149009207e-01   +7.888146217315038e-02   +1.407708651890249e-01   +3.845472117933538e-01   -2.754618403913889e-02   +2.053754508191865e-01   +3.270796610309441e-01   +1.859139353353856e-01   +7.490973703835135e-02   +2.515361244748002e-01   +2.953170050063970e-01; +2.730473626713279e-01   +2.303528232294883e-01   +3.200586930248199e-01   +2.505499545838730e-01   +2.526733151786278e-01   +4.561894052557226e-02   +2.708280313722514e-02   +2.657686024758114e-01   +5.288709504747695e-02   +2.083258281399252e-01   +1.464902636541159e-01   +3.470059777928945e-01; +3.335305750349991e-01   +2.666036456429777e-01   +3.963139055033895e-01   +8.340269953096155e-02   +2.175487787803713e-01   +3.672063425255599e-01   +3.855527501925657e-01   +3.876530268650262e-01   +4.208630549709347e-01   +3.118153068996861e-02   +1.077163843359236e-01   +3.560172017091507e-01; +1.576463138481257e-01   +3.597879349380703e-01   +9.473562898323049e-02   +2.547225953523064e-01   +3.544755835126814e-01   +3.777859842727380e-01   +1.273872087545346e-01   +2.012383518255774e-01   +4.221665489738516e-01   +2.701788506300602e-01   +4.267603730211495e-01   +2.829930838210766e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
