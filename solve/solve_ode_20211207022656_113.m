function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.117590013835849e-01   +1.487153852529697e-01   +2.593056992233626e-02   +5.593457668941592e-01   +2.771470448125820e-01   +3.639642058949696e-01   +5.529861853871009e-01   +3.850150677907763e-01   +4.545165797404246e-01; +3.282240761901009e-01   +1.120964656222943e-01   +8.316767980693043e-02   -3.759376714531699e-02   +5.668642678116895e-01   +6.317793381008798e-01   +5.828401100918223e-01   +1.691050609246718e-01   +1.137364437920773e-01; +8.421899998512861e-02   +4.311030362860145e-01   +2.536012762838170e-01   +3.886730394956937e-01   -9.163260708422660e-03   +7.970967939828756e-02   +7.443947154112941e-01   +5.350266098991299e-01   +1.663461871564772e-01; +6.491787927252124e-01   +4.689675480548412e-02   +3.346263197375147e-01   -6.138200413655037e-02   +1.956584624064751e-01   +3.276126779181182e-01   +2.935573426065450e-01   +4.772114509448426e-01   +2.634655978593118e-01; +3.046741721037773e-01   +1.100900881082180e-01   +6.322738410627939e-01   +3.462710721272921e-01   +4.205940696715850e-01   +5.658799950400644e-01   +4.326531945596926e-01   +1.741620533983015e-01   +3.987416532518305e-01; +2.596964569845637e-01   +1.338364772429976e-01   +3.831701138755149e-01   +4.266617732276957e-01   +4.172092428994972e-01   +1.144677570152868e-01   +7.140001699602685e-01   +2.769074538589568e-01   +3.403171455593306e-01; -2.200656223257228e-02   +4.403247584760137e-01   +3.852969049826941e-01   +3.541502269714317e-01   +3.382379628131619e-02   +2.906146859044689e-01   +2.154927119950070e-01   +5.632583624413570e-01   +4.931891570888908e-01; +1.125178134830565e-01   +1.133173352303891e-01   +4.197794419504342e-02   +2.108270036457138e-01   +4.709577153178805e-01   +3.905409552985232e-01   +4.138229612290439e-01   +1.020209420319999e-01   +1.264424342221541e-01; +1.531030657123923e-01   +2.270193957292114e-01   +4.314503212378779e-02   +1.727163875454499e-01   +1.042735550112614e-01   +3.839840892165494e-01   +3.666689871749078e-01   +3.406890166582905e-01   +1.879790872493047e-01];
L1_L2_iAMPA_netcon = [+3.265298524016375e-01   +4.711733727714956e-01   +2.937108786807875e-01   +4.390587462670337e-02   +5.353353376057247e-01   +2.950505290597123e-01   +4.864218866324947e-01   +4.936075441126352e-01   +4.143814861463745e-01; +2.877367129619801e-01   -1.007100155923286e-02   +4.202493717389849e-01   +8.813887090569622e-02   +3.068507241820226e-01   +6.807520996962627e-02   +3.554246807514805e-01   +3.351942539530278e-01   +5.694467335042305e-01; +2.161207522817134e-02   +9.025393305861307e-02   +4.767333078911946e-01   +5.103032454141054e-01   +2.427967195401482e-01   +1.819642056597846e-01   +2.304424067972801e-01   +4.717635104399346e-01   +2.119918008826424e-01; +1.629186643375475e-01   +2.334041778404027e-01   +3.324798454305161e-01   +7.090318905474757e-01   +4.290941427790729e-01   +1.201797700890771e-02   +3.203633021948933e-01   -4.407992223761209e-02   +5.681515513106312e-01; +1.096652357300988e-01   +6.457873740267127e-01   +2.155111559703111e-02   -6.141384089640489e-02   +2.663457430074373e-01   +4.952127457341917e-01   +4.031690824872342e-01   +3.617088512257784e-01   +4.299795551451811e-01; +3.943821787897683e-01   +4.662842657485110e-01   +1.450302845086081e-01   +1.895687671855877e-01   +5.649390477354009e-01   +2.172047957903367e-01   +5.365940755245061e-01   +4.931151259682380e-01   +6.188887519284321e-02; +5.967047938751371e-01   +5.144765538258700e-01   +6.668924107309468e-02   +1.866903313819695e-01   +1.329158576167466e-01   +1.530803086286771e-01   +1.222913081657630e-01   +6.307288949376755e-01   +2.335437231146457e-01; +2.239277106910841e-01   +1.147713726423471e-01   +1.497860388568247e-01   +6.328157529375872e-02   +3.251659426244676e-01   +6.561082728157887e-01   +4.750259455840337e-01   +4.955853659410795e-01   +4.834690381398876e-01; +6.004830512124101e-01   +4.471150616891629e-01   +2.700626329262066e-01   +2.590869732779771e-01   +2.916309374714459e-01   +6.469050861819073e-01   +7.719808721128338e-02   +6.153098031453996e-01   +3.573179417978546e-02];
L2_L5_iAMPA_netcon = [+4.685903138850470e-01   +1.452417948760950e-01   +3.717896383679308e-02   +6.051802832743004e-01   +4.443817723421255e-01   +3.789650446514811e-01   +5.696749731794114e-01   +5.349380177854008e-01   +1.264459234177742e-01; +3.815172124349722e-01   +5.841161779128945e-01   +2.048111354683777e-01   +5.962577757651405e-01   +1.088868240168799e-01   +9.317440342852057e-02   +8.619804128960665e-02   +1.359495413171036e-01   +5.463728219762738e-01; +1.890602873524236e-01   +3.775574006243094e-01   +1.173397004410056e-01   +6.253314612553314e-02   +2.913612363488973e-01   +6.643331157244834e-01   +5.387720579983001e-01   +2.692115975703831e-01   +4.381037974703594e-01; +1.753675389122730e-01   +3.621057701276927e-01   +2.438748370082781e-01   +3.200958536363991e-01   +3.115359216770508e-01   +4.189077023140187e-01   +5.524291043260553e-01   +5.543455755692948e-01   +2.679142293973457e-01; +5.136646356547200e-01   +2.333055601897270e-01   +7.311822949839950e-02   +2.757055201212950e-01   +6.027813057908650e-01   +4.555307022356941e-02   +1.453550043194305e-01   +1.160023809316075e-01   +9.020187253518008e-02; +5.895584626111003e-01   +2.024135721748161e-01   +9.175620218638700e-02   +5.983565012074971e-01   +1.808713196250912e-01   +2.460469443962549e-02   +3.256114159290695e-01   +5.449969934915939e-01   +6.056602082305824e-01];
L5_L2_iGABA_netcon = [+1.104861973939119e-01   +1.288211163865663e-01   +5.451372660629896e-01   +2.707294593169810e-01   +1.734689006979688e-01   +6.921615602501716e-01; +5.320476164066390e-01   +8.248596790000381e-03   +5.133489265374924e-01   +5.516469197507207e-02   +5.555330368259173e-01   +6.759745705847791e-01; +6.841213369938459e-01   +4.904613687454054e-01   +2.865642285019371e-01   +1.598965902845780e-01   +2.277083534015522e-01   +2.588833058058585e-01; +2.398854934706462e-01   +3.532569852567526e-01   +5.185089123798905e-01   +1.242822938608493e-01   +6.659378990219647e-01   -2.882844403643711e-03; +4.313749288117841e-01   +4.266986348753267e-01   +5.410042171046423e-01   +3.463591489306932e-01   +1.934542938767572e-01   +3.253048888154446e-01; +5.934396860950522e-02   +5.313246295293398e-01   +6.150412740404980e-02   +3.529917774449004e-01   +2.676155352134613e-01   +3.824199926312322e-01; +4.402424096082659e-02   +4.131814596480569e-01   +5.738185129592370e-01   +4.868677681534349e-02   +4.466150689080169e-01   +2.313258489428716e-01; +5.687522933143839e-01   +1.718491572617181e-01   +8.949553553998692e-02   +5.654856549570642e-01   +1.594935842436715e-01   +5.954491902336821e-02; +2.621457298560382e-01   +1.777426707224729e-01   -7.706787039235055e-03   +4.615347475018469e-01   +1.505126489153275e-01   +4.058537121983322e-01];
L3_L2_iAMPA_netcon = [+1.298116695788932e-01   +2.954391428005752e-01   +4.091447677957575e-01   +1.819312543514795e-01   +6.847507770540633e-01   +4.889531097407162e-01; +2.803105152195747e-01   +1.912904969279168e-01   +4.463334302851232e-01   +4.613367970643468e-01   +3.521658368775135e-01   +2.092787152714932e-01; +2.558750788358721e-01   +1.368274388888192e-01   +1.767315952473079e-01   -2.018892229777110e-02   +2.148290596696140e-01   +3.187590240529866e-01; +4.676586994630019e-01   +1.489419009876758e-01   +2.252217440441468e-01   +3.871785439415300e-01   +1.474327976776568e-01   +5.390856078998109e-01; +1.483095012007888e-01   -1.696497113390825e-02   -1.997257424905551e-03   +5.578534904636838e-01   +5.142067139751797e-01   +6.076531792572546e-01; +5.544504608918401e-01   +5.843180910531745e-02   -2.542339248361435e-02   +2.281636494810003e-01   +2.618644080628413e-01   +4.454616820735814e-01; +2.889072966656717e-01   +5.076817869744781e-01   +3.068867127307001e-01   +9.651814184596264e-02   +2.852841806277835e-01   +2.269501005175982e-01; +2.381352385190472e-01   +5.663623584659850e-01   +4.936309356259164e-01   +2.387732806556759e-01   +4.555765418461012e-01   +1.885056762269718e-01; +7.657484231029980e-02   +3.682935849723461e-01   +2.835429365082878e-01   -1.193263649263929e-02   +3.941745140780641e-01   +5.302151769830917e-01];
L2_L3_iGABA_netcon = [+4.970894862280366e-01   +1.090661214204678e-01   +3.493956234080984e-01   +5.060128090186533e-01   +2.731472953271192e-01   +3.046520271783363e-01   +3.907622527573179e-01   +5.160046545401507e-01   +5.358137503438843e-01; +1.413984346241544e-01   +6.091845788920350e-01   +5.912576347263305e-01   +4.552146601795017e-01   +4.743457374309613e-01   +2.741629871249860e-01   +4.983753233828332e-01   +1.194583369995428e-01   +1.858887265591083e-01; +1.332387231507026e-02   +4.630552223121850e-01   +6.490321566908588e-01   +6.763371312999928e-01   +9.482304280242082e-02   +5.247221412344566e-01   +5.905040746481454e-01   +1.977270178105152e-01   +2.637418288582037e-01; +1.087572139468361e-01   +5.512433491025440e-01   +2.889440336099179e-01   +4.616569393262417e-01   +4.632783865771203e-01   +2.235687074964325e-01   +6.594727403878511e-02   +3.215830605039292e-01   +6.295478841084823e-02; +1.813514854118115e-01   +4.185431893619558e-01   +8.353648285854268e-02   +1.786946984034526e-01   -7.432410318186883e-02   +3.309212366503750e-01   +3.019390768392977e-02   +3.301830602347802e-01   +6.173975458739492e-02; +5.069932608220326e-02   +4.123947481503227e-01   +3.224547410128710e-01   +5.739208929351746e-01   +1.581868103869745e-01   +1.512548357447620e-01   +1.352199878026175e-01   +5.962658673154256e-01   +5.460774975542499e-01];
L1_L4_iGABA_netcon = [+2.116275471788198e-01   +7.194105469794553e-02   +2.135034383102822e-01   +2.130709925636411e-01   +3.141626812323712e-01   +9.545455104669005e-02   +5.219425309786254e-01   +1.744336035357504e-01   +8.438553699748060e-02; +8.438925094673384e-02   +4.852008770725831e-01   +5.536261719806996e-01   +3.315035381001713e-01   +3.496947200099376e-01   +3.676101542319696e-01   +6.098126468953838e-01   +2.732362321439976e-01   +2.120549696440093e-01; +5.375527862106045e-01   +2.908825950675155e-01   +4.048995694621714e-01   +1.816059431312055e-01   +4.450485351034698e-01   -9.692315127757616e-02   +2.908129905844703e-01   +2.943565930828974e-02   +4.757759201895417e-01; +2.012867216053619e-01   +4.637183922182965e-01   +4.817770043235192e-01   +2.150641563767889e-01   +2.375217710552685e-03   +4.031374883673633e-02   +3.044207746594099e-01   +1.204887018916104e-01   +5.500971794103401e-01; +2.143333118481681e-02   +5.556511241775918e-01   +4.168352617058627e-01   +5.204524734172540e-01   +4.348580761455421e-01   +6.501189919919889e-01   +1.518514977138080e-01   +3.680051927058935e-01   +2.010347901232018e-01; +1.628912825495261e-02   +5.154155502340820e-01   +2.548115999232832e-01   +4.962149700351607e-01   +1.685332350380767e-01   +5.549903189539008e-01   +3.660878561026978e-01   +3.123179055467030e-01   +5.762350423526788e-02; +3.585980742093246e-01   +3.809361741547756e-01   +4.433849196198316e-01   +6.079950062093121e-01   +5.247610396151475e-01   +4.186574873379852e-01   +1.146995102685405e-01   +1.750880867060170e-03   -3.096883756496727e-02; +5.247756344758305e-01   +2.910085916903058e-01   +4.852006611039962e-01   +5.541540370239532e-01   +5.343131054868999e-01   +2.764577021617816e-01   +5.266959379824986e-01   +5.510997705373909e-01   +7.329001270223707e-01; +4.071667764029742e-01   +1.301841992223542e-01   -2.226869058054191e-02   +4.434109231084256e-02   +5.051937836166540e-01   +4.337510109051214e-01   +4.322642023786852e-01   +2.087968303671655e-01   +1.437091192862553e-01; +1.550516864367985e-02   +5.430183328132649e-01   +4.097250459615042e-01   -8.235305547514477e-03   +3.602672255154173e-01   +1.293565099087169e-01   +3.499974182934301e-02   +4.992862563489563e-01   +6.577265044226976e-01; +3.554832461813374e-01   +2.953577110375585e-01   +1.660530624644596e-01   +3.796593632255383e-01   +2.507862278378853e-01   +3.768067642416091e-01   +4.302222086894642e-01   +4.041675492219501e-01   +5.916003042643343e-01; +5.517828199630508e-01   -5.681383894841277e-02   -4.414632014085638e-02   +4.264749031910403e-01   +4.134998094818045e-01   +3.164134510806593e-01   +3.194422971310682e-01   +1.705897011621696e-01   +5.317981789558045e-01];
L4_L1_iGABA_netcon = [+2.334870489419791e-01   +3.220340125644364e-01   +3.016245409826490e-01   +2.423150918212678e-01   +4.501197844613770e-02   +4.604545865380816e-01   +2.474614766457417e-01   +6.982776510201580e-02   +5.020997030448775e-01   +1.007353086354237e-01   +1.777822077202461e-01   +2.879837030984388e-01; -2.847610567748253e-02   +1.711407648275571e-01   +3.883125486896523e-01   +5.080138849499360e-01   +2.403558316709720e-01   +1.775879166905492e-01   +5.468780093891777e-01   +1.278070489775730e-01   +5.697672865893156e-01   +1.156543251309848e-01   +1.744672196961795e-01   +2.893197902877299e-02; +2.183272850321568e-01   +5.467846130105972e-01   +4.814375738994148e-01   +2.148405425171989e-01   +5.021151146107747e-01   +4.474039893136411e-01   +2.971540149279084e-01   +5.246746670708932e-01   +3.387605146422871e-01   +4.799304396498220e-01   +2.325036746177310e-01   +3.244196608357741e-01; +4.853315509754322e-01   -4.452790941300352e-02   +3.081828778606999e-01   +3.705835263045242e-01   -2.648950581220449e-02   +4.066152260746640e-01   +9.369670844365639e-02   +6.123468084238824e-01   +2.914626977979864e-01   +5.119252656116652e-01   +7.372928475641909e-02   +6.423070415238469e-01; +5.834308460334470e-01   +7.046048614496172e-01   +5.236903418595280e-01   +2.703957732179992e-01   +2.670583278812606e-01   +3.935044608873463e-01   -4.056843802133642e-02   +1.858884210386435e-01   +1.923822319584595e-01   +6.992375952891827e-01   +4.870955941048373e-01   +5.146178493348500e-01; +1.166698461061006e-01   +3.074172394745014e-01   +2.199100518921186e-01   +6.072623993515751e-01   +1.690705645486533e-02   +3.793959384511005e-01   +4.109827900914159e-01   +6.733940816287474e-01   +9.552529406371452e-02   +9.502643414313484e-02   +1.344817415551052e-01   +1.750303839116596e-01; +5.798749982778750e-01   -5.671436016400268e-02   +1.981822159263689e-01   +2.922890539866707e-01   +1.081588062916271e-01   +3.236559079322514e-01   +2.228266403786027e-01   +5.867785458238723e-01   +2.880867041676595e-01   +7.408667426536107e-02   +1.620047457211941e-01   +4.207778002152648e-01; +5.763826834969060e-01   +9.086139407220006e-02   +1.283009016904855e-01   +1.267232096965223e-01   +5.168799206061734e-01   +1.445326663692300e-01   +4.100106855917084e-01   +3.858441989018780e-01   +5.641852605756867e-01   +5.604329595273986e-01   +3.742671296060108e-01   +2.166655887866015e-01; +5.873957870620305e-01   +8.418506735147947e-02   +3.786356552389109e-01   +3.144737818967215e-01   +2.847108284350477e-01   +4.025891122653863e-01   +2.153452369122600e-01   +5.785507974315237e-01   +5.050217934467004e-01   +3.104472862873915e-01   +1.626207266883417e-01   +2.644649827979952e-01];
L1_L3_iAMPA_netcon = [+1.702051482396253e-01   +3.716061833207268e-01   +5.236452057808447e-01   +5.108759033060321e-01   +2.384838093280016e-01   +4.046901443946113e-01   +1.122961698552381e-01   +2.242710948208129e-01   +1.527717719326676e-01; +2.640892694651584e-01   +3.453426730535040e-01   +4.555152552874038e-01   -6.540660533802843e-02   +1.612018709417528e-01   +1.997329071322672e-01   +6.892174367767526e-01   -1.204655232481070e-02   +5.996900808198848e-01; +4.509672693139917e-01   +1.411253913787568e-01   +1.512614575167897e-01   +4.983282201933632e-01   +2.878613005394632e-01   +5.656967522881549e-01   +3.103103469523241e-01   +6.316315468258697e-01   +3.592165050908451e-01; +2.815547079939289e-01   +3.676661478774952e-01   +1.613886195071104e-01   -6.147890286730644e-02   +5.531011478699323e-01   +5.213069410395885e-01   +1.795896494373345e-02   +5.775447484657297e-01   +2.797234913103696e-01; +5.239229593583733e-02   +2.776353093963195e-01   +2.594078216493642e-01   +3.142692459555222e-01   -2.263873901764484e-02   +4.562141695797691e-01   +4.509238371180417e-01   +2.077405077210569e-01   +2.141050395658134e-01; +2.237406083775836e-01   +6.113861542971804e-01   +4.301532568908695e-01   +1.200313487253262e-01   +1.192685542345337e-01   +3.959777393077406e-01   +7.015776151364392e-01   +2.461146502874965e-01   +2.166400736181031e-02];
L3_L1_iGABA_netcon = [+6.496088120449895e-01   +5.223746355876350e-01   +5.614070330871208e-01   +1.545264500873262e-01   +2.251472950109672e-02   +2.736224969351900e-01; +3.474079925982694e-01   +1.478763343279278e-01   -3.753949098270846e-02   +6.469386118682005e-02   -8.950931445705090e-02   +1.659664089906180e-01; +5.715521806685532e-01   +8.885576041101464e-02   +4.056541195608563e-01   +2.290344642995547e-01   +4.468172373785209e-01   +5.045092314226886e-01; +3.218773139901119e-02   +3.698733046696182e-01   +4.246717886089406e-01   +2.779251547501824e-01   +5.718167681844586e-01   +2.326158080478549e-01; +3.385977678954809e-01   +1.397337300045556e-01   +2.222199422856347e-01   +5.888875837384896e-01   +2.153953262614162e-01   +1.369967382719740e-01; +3.639843541181030e-01   +2.755822820458855e-01   +2.325083029338664e-01   +5.845108946835860e-01   +5.094427472629399e-01   +5.668902643186230e-01; +3.619454315567214e-02   +9.225925198856035e-02   +5.562755034807511e-01   +2.778859962705817e-01   +4.249756242591946e-01   +3.068505892645997e-02; +3.545491530779113e-01   +2.484590904731611e-01   +5.678726196993136e-01   +1.901963782483711e-01   +1.747601069791997e-01   +1.918171536934770e-01; +3.683911423089600e-01   +6.761720467111073e-01   +6.323128218832988e-01   +2.230257109814745e-01   +3.183101918872626e-01   +5.438392263375096e-01];
L5_Input1_iAMPA_netcon = [-3.859029485919686e-02   +4.292241027843477e-01   -4.158040583060970e-02   +2.799507468647222e-01   -4.171103395956494e-02   +6.045625533467983e-01];
L6_Input2_iAMPA_netcon = [+4.595525481536347e-01   +3.600509600201094e-01   +1.636521189420238e-02   +4.760171989938701e-01   +2.522950375684972e-01   +1.278239732500820e-01];
L5_L6_iAMPA_netcon = [-6.306087930212588e-02   +2.966352895065916e-01   +2.216293780098083e-01   +5.794073209603732e-01   +5.125446729458769e-02   +1.960021960837433e-01; +2.179391628656402e-01   +3.237117723426552e-01   +5.891959745051246e-01   +5.566090369759589e-01   +6.008313818480125e-01   +6.436369123421041e-01; +5.458999853082158e-01   +4.146855471007988e-01   +4.808956119448762e-01   +2.633659664051813e-01   +8.270686396249159e-02   +4.349958437754251e-01; +4.506409810738363e-01   +5.821242218678766e-01   +4.579632595435219e-01   +3.117601801067045e-01   +3.080032801867216e-01   +5.721817976732998e-01; +2.058826069059045e-01   +6.716160624126596e-01   +5.808139945165831e-01   +1.640568312134707e-01   +3.560250106918966e-01   +4.197407008987032e-01; +7.241379640846020e-01   -5.343636593027959e-03   +5.353132725299721e-01   +1.698041560587188e-01   +4.473701162836360e-01   +1.116187588153680e-02];
L4_L5_iAMPA_netcon = [+2.976057324266719e-01   +5.313062333193000e-01   +5.381219428019727e-01   +3.920323425199139e-01   +2.532132978480692e-01   +2.939292801446624e-01   +5.183473285269153e-01   +2.178755448213673e-01   +3.415301183443054e-01   +1.847196283022270e-01   +5.274716032510979e-01   +2.409106111296223e-01; +1.664597527446606e-01   +6.039208435659102e-01   +1.207115423760451e-01   +3.725456090829193e-01   +2.224286952657200e-01   +4.948215828178016e-01   +6.897431908866946e-01   +1.459547399128973e-01   +1.253985827097219e-01   +1.642024800677448e-01   +3.431821718572616e-01   +3.187351590051782e-01; +5.633198572778577e-02   +4.840043173647732e-01   +7.963508769179556e-02   +3.866568922285268e-01   +5.961901254616930e-02   +4.832993551980648e-01   +6.051463237645934e-02   +2.331536874837217e-01   +4.796004113110805e-01   +4.096393479689399e-01   +4.267249800360107e-01   +5.507361408628135e-02; +7.870638303970960e-02   +3.392488814221276e-01   +3.974250699584061e-01   +1.094603113578488e-02   +8.285781322690397e-02   +6.024255275737058e-01   +1.131788737327569e-01   +1.819031359832715e-01   +2.523448024371527e-01   -2.053861653743775e-02   +4.516234490963120e-01   +5.956624546049437e-02; +2.460556950358040e-01   +4.801729824153925e-01   +3.159393237689602e-01   +4.378758492916617e-01   +3.936060973227813e-01   +4.439677820311756e-01   +4.962847711642526e-01   +5.529240210587648e-01   +3.398954666428124e-01   +1.653468047162903e-01   +4.690480405182688e-01   +4.889050368842159e-01; +3.683050751893674e-01   +5.159477267678424e-01   -3.458211741835065e-02   +4.066497598035049e-01   +5.211287854298279e-01   +7.152640380579343e-01   +3.394144405604300e-02   +2.544497033334043e-01   +1.709575797200168e-01   +4.031969259276227e-01   +3.080909767200037e-01   +6.016832616787945e-01];
L6_L4_iAMPA_netcon = [+2.332535482598304e-01   +4.061372752389697e-01   +3.078176124301852e-01   +6.332962810719829e-02   +1.301838015494760e-01   +4.143890573706630e-01; +9.134235394228001e-02   +2.219492099210920e-01   -3.258345558628533e-02   +3.656968160604049e-02   +1.845336769254838e-01   +4.319937134595927e-01; +2.162293544703787e-01   +3.637666762576407e-01   -5.426881497771793e-02   -2.161737868703496e-02   +4.015694484545367e-01   +1.952955042028051e-01; +4.912847911626799e-01   +5.680063410026764e-01   +3.662568837256652e-01   +1.869052531637006e-01   +5.708766795650739e-01   +3.231795625564029e-01; +6.543002684872053e-01   +9.856219834985640e-02   +2.693604319896862e-01   +1.756343141063698e-01   +3.436100515351668e-01   +7.023694091958022e-01; +6.196242034417999e-01   +5.856553883487617e-01   +4.204721677434148e-01   +3.894236336208637e-01   +2.879366033522924e-01   +3.692764764464288e-01; +5.087753862090605e-01   +5.544266013470400e-01   +3.341727283944139e-01   +6.341800337569303e-01   +4.907720823759304e-01   -5.156008172475897e-02; +3.717164879729981e-02   +4.984894896384391e-01   +4.094234153795105e-01   +9.761766264828403e-02   +1.149342183587295e-01   +6.181960232446146e-01; +1.940205942152532e-02   +1.039368719825742e-01   +4.360286609116323e-01   -8.323762103335031e-02   +9.559775600957017e-02   +7.925034125906939e-02; +1.658078384797386e-01   +4.617501994822559e-01   +3.465679396647949e-01   +2.474108007167583e-01   +5.145959441436700e-01   +4.627797180925651e-01; +4.006009337282825e-01   +2.552210324490011e-01   +5.788100105595058e-01   +1.509878784914644e-01   +2.301774406827884e-01   +5.536727751426100e-01; +4.118664492558082e-01   +4.186758085056815e-01   +7.113095282631150e-02   +1.060521290259102e-01   +5.238865305693966e-01   +5.226468697366805e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
