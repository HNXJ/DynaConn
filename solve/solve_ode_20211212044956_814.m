function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+7.013151022195101e-02   +5.544249481978587e-02   -8.891370586169471e-02   +1.702293934447326e-03   +7.596692979517519e-02   +1.549799166671960e-01   -1.407090318852059e-01   +1.654187728445137e-02   +1.753550908253425e-02; +3.257855533497682e-01   +1.663693577839465e-01   -1.200129817193850e-01   +2.666685694012929e-02   -1.917454484425599e-02   -7.946129799066751e-02   +1.329194505431338e-02   -1.393010234541622e-03   -1.349723119552879e-01; +7.317739697465997e-02   +2.772651743234916e-02   -6.460097489313363e-02   +3.853532139415729e-03   -2.579290441842825e-01   -4.345364762855127e-03   +4.454963089886467e-02   -1.010414519447778e-01   +1.905325906744889e-01; +3.119857132663501e-02   -9.145591358942845e-02   -1.981620824238276e-01   -7.364130646246012e-03   -1.406387916609375e-01   -2.647383953449985e-02   +3.482587884619076e-02   +2.626142141080631e-02   -1.657097024480383e-01; -6.451112062142368e-02   +5.364244004367411e-03   -6.375198938276485e-03   -1.049502716520709e-01   -1.944930878166246e-01   -5.097291070600765e-02   +1.748617329945972e-01   +1.498598484501547e-01   -7.141447790921389e-02; -2.703945428954388e-02   -2.379423197393558e-03   +5.816601311202790e-02   +7.961268560259141e-02   -1.660420437537332e-01   -1.182163852457550e-02   -9.957735925680737e-02   -6.204543597831815e-02   +1.334499174054342e-01; +2.087473424807183e-01   +1.789559639088262e-01   +6.018361133820178e-02   +9.058825729457290e-02   +7.306045282296819e-02   +8.643698842661861e-02   -2.516312034730163e-01   -3.845252897807182e-02   -1.137409608095332e-02; +1.442609876593863e-01   -2.093656406358505e-01   -5.127550071802858e-02   +7.052959999964835e-02   +1.542591916712753e-02   -9.579475740663736e-02   +3.215368884035372e-02   -6.037754135337439e-02   +1.906259815121345e-02; -3.954759721837165e-03   -8.651757579941427e-02   +3.072357319751463e-02   -6.406727908807439e-02   -2.102158866332425e-01   +9.404231025928395e-02   +2.499865131941169e-01   +3.776402706472433e-02   -1.782999411905480e-01];
L1_L2_iAMPA_netcon = [-1.877332510378309e-01   +9.080622240880000e-02   -1.861337135679524e-01   +1.261638042963614e-01   -2.582241379863471e-01   -9.153131252037662e-02   -7.176634028571391e-02   +1.548471101117412e-01   -1.860934561009285e-01; -4.665680288684360e-02   +6.867604907106928e-02   +1.177709012423721e-01   +9.263154082534711e-02   +3.118720004671963e-03   +5.484254079033326e-02   +1.022504644089661e-01   -8.135126141833419e-03   +5.588186431838539e-02; -4.567129513659381e-02   -2.022805219527892e-01   +7.202112807967108e-02   +1.377135510400116e-01   -7.062204163404157e-02   +2.493735391343371e-01   +2.041249847781495e-01   -1.449862361916011e-01   -1.144720084876471e-01; -1.425673236201547e-01   +1.074986122836410e-01   +7.885356841658771e-02   +1.226031444917510e-01   -5.739377110954186e-02   +1.229742883399134e-01   -9.925368815817628e-02   +1.819538977699293e-01   -4.893359413064090e-02; -8.660744611128049e-02   -7.670099525709753e-02   -2.365648103272429e-02   -3.846635715756214e-02   +2.216932776640410e-02   -1.077457304029608e-01   -1.714544975323687e-01   +7.946681748218573e-02   +1.754066171098635e-01; +1.177283866915356e-01   -1.238895928138677e-01   +2.163388933527073e-02   -1.141260825529638e-01   -7.760256344523984e-02   +1.199747369737659e-01   +5.512765503710974e-02   +6.035884717652905e-02   -4.720820569976748e-02; +3.073778656362595e-03   +2.252211766860354e-01   -2.435121443921377e-01   -2.208913788270766e-02   -4.939632923084258e-02   -2.528280389572838e-02   +6.623904892016533e-02   +1.225902575050783e-01   +1.604956446193154e-01; -1.179916268773026e-01   -7.847878204709927e-02   -1.183541525732592e-01   -1.060952029059231e-01   +1.379843013375580e-01   +1.452876752377925e-01   -1.325027963519752e-01   +1.881743034917380e-01   -1.650127314358634e-01; +2.095747507635038e-01   -1.261701787775579e-01   -5.202152193311323e-02   +1.054562857625051e-01   -4.070609826903852e-02   -1.868383878673163e-02   +4.663955571716638e-02   +1.021384598894965e-01   -4.928260797976013e-02];
L2_L5_iAMPA_netcon = [-2.765433475853522e-02   -1.953757303707644e-01   +9.259966693165442e-02   +1.238325390118730e-01   +1.471715560560976e-01   -1.607737075014013e-01   -1.880489116838036e-02   -1.118797619501112e-01   +1.558098339727875e-01; -1.817937450601075e-01   -1.640739287346224e-01   +1.956801645817663e-01   +2.070948066575992e-01   -7.412674637839550e-02   -1.146936074067796e-01   +5.130736416170015e-03   +3.081688225347387e-01   -1.566719801506807e-02; +2.384831798791411e-01   +4.268237900150032e-03   +2.515367507569789e-01   +8.959811035355950e-02   +9.369406647553812e-02   -2.148048133319529e-02   -3.036463561367561e-02   +2.997158321878034e-02   +1.645211710642078e-01; -9.378649901707836e-02   +6.794588095873663e-02   +1.430349807354701e-03   +1.427839727809911e-01   +2.294891285190822e-01   -3.200553980335863e-02   -2.306967181973976e-02   -3.620943940020527e-02   +1.043591929408640e-01; +2.715916134213338e-02   +7.855120369159934e-03   -1.850828415610137e-01   -5.188077226167230e-02   +1.235898835606292e-01   +5.279750575931294e-02   +1.955317202806806e-01   +8.804805669463804e-02   +1.489347723620084e-02; -5.093240898592581e-02   -6.036083793216173e-02   +3.618798027424035e-03   +8.364019561267433e-02   +8.375629512889528e-02   +9.605743268387607e-02   -8.920171459652299e-02   -7.570384947756598e-02   +5.773361983725178e-02];
L5_L2_iGABA_netcon = [+6.963964515191942e-03   -7.823894300541527e-02   -8.095742295541856e-02   +9.927110337254270e-02   -6.554266877713261e-02   +3.252792755505361e-02; -1.071479185025264e-01   +4.507332090051706e-02   +2.843325517548748e-01   +6.479141399450443e-02   +9.440092891659231e-02   +2.175432076445950e-02; +6.306977533741913e-02   +8.523223665008428e-02   +1.171688624184009e-01   +8.815326438731247e-02   -1.667476769236873e-01   -8.823741289714407e-03; -5.963229749462748e-03   +1.329501165951300e-01   -6.077478607477266e-02   -1.565440354989875e-01   +1.644225779442427e-01   +1.521224594871902e-01; +9.238717199290940e-02   -1.082108308811949e-01   -2.392089766178173e-02   +1.436822973850798e-02   -1.171375777269880e-01   -2.079192314071744e-02; -6.021380052499671e-02   -3.242613319175398e-02   +1.030713882071280e-01   -7.668531511010254e-02   +3.858988461017292e-02   -5.896396059593161e-03; +4.802626230083350e-02   -6.742170046899652e-02   +1.562897719790100e-01   +1.526494375792920e-02   -1.552922966590706e-02   +1.566524256053201e-01; +1.392727531004176e-01   -3.525112665353999e-02   +1.528234486655192e-01   -1.722661268938920e-02   +8.849324619328648e-02   -8.922157574899134e-02; +1.518293691862866e-01   -2.680475244368882e-02   +5.971189992451767e-02   +2.271057866278297e-02   +1.324924286039654e-01   +2.128045633109130e-01];
L3_L2_iAMPA_netcon = [+8.660142547448499e-02   +1.635373306511723e-01   +2.836627398366054e-02   +8.639892592481149e-02   -3.728830394919526e-02   -5.080285775710645e-02; -6.968084019310944e-02   -5.855151837789242e-02   -9.791081486279035e-02   -3.806574307752780e-02   +1.353400960835864e-01   -9.705581246950973e-02; -8.781968116794718e-02   +1.744966628536754e-01   -1.476296181230296e-01   -1.200703855895809e-01   -3.717046470873714e-02   -6.838507092191079e-02; +7.425593885540702e-02   -5.443652836051716e-02   +1.873533646697024e-02   +7.734005795689133e-02   -6.977474279235679e-02   -8.456476396754947e-02; +1.924935911158085e-01   +8.345679174886458e-02   +4.150419299093407e-02   -3.974794821689496e-03   -3.926455892668176e-02   -1.534535265920772e-01; +1.723084943555722e-01   +4.809699641700602e-02   +2.848885006640831e-02   -4.434796972173476e-02   +5.328677507414305e-02   +9.674319380145124e-03; +8.078899081117311e-03   -7.169078545660260e-02   +9.442855469964762e-02   +3.425417327098689e-02   -3.135623922465515e-02   +3.708519163508901e-02; -7.355314784296803e-03   -2.840200680744542e-01   +8.815343952604947e-02   -9.126871162613516e-02   -2.237181762925005e-02   -5.178549773586308e-02; +6.936771122829583e-02   -2.653615241907402e-02   -1.239744536111418e-01   -1.302846750743736e-01   -2.329952113681829e-01   +5.352623703448114e-02];
L2_L3_iGABA_netcon = [+1.051432874004442e-01   +1.570127744668391e-01   +3.370309271714341e-02   -1.986760294228387e-01   -1.597606081393005e-01   -4.740767931352313e-02   -9.153993737637861e-02   -1.196412660936758e-01   -7.883052881935611e-02; -9.978952206812171e-02   +1.704921574174346e-02   -6.494285134414714e-02   +9.114381958179316e-02   +3.861599302288892e-02   -7.188434649829981e-02   -5.627978617351653e-02   -1.648224894725621e-01   +1.154073280844101e-01; +2.068792720569258e-01   +7.552905590709096e-02   +7.900104283811468e-02   +7.440694661969585e-02   +1.356231624708589e-01   -6.959100567067830e-02   +6.598717153584158e-02   -7.344248790673005e-02   -1.507164569587955e-01; -1.496523889899130e-02   -1.003680361955235e-01   -1.014816119953621e-01   -7.706747249958719e-02   -6.263949598729063e-02   -3.803175837243914e-02   +1.339121028726734e-02   +5.589636982565455e-04   +1.162399120386974e-01; -4.319633722747518e-02   -8.003710578187209e-02   +2.365211840279576e-01   +1.330343734991069e-01   -9.519574448795466e-02   -1.494679532741691e-01   +7.337924311675624e-02   +7.751210472070577e-02   -1.981067969430119e-02; +1.198550117617665e-02   +1.566391960232504e-01   +5.617493809865476e-03   -1.258341642463870e-01   -1.047548678946878e-01   -1.559763224431642e-01   -1.590454099740838e-01   +5.071864690067516e-04   -6.569760488728070e-02];
L1_L4_iGABA_netcon = [-2.666942621989113e-01   +1.661396104067949e-01   -1.259639733530748e-01   -9.256190884638706e-02   -1.837546899510338e-02   +1.706343999416629e-01   +8.559302724710119e-02   +1.680864018729826e-01   -4.696042717273790e-02; +9.919308115466208e-02   -5.823211318722880e-02   -1.715167235185773e-01   -1.812814163251359e-01   -1.771900171296659e-01   +9.407356683694901e-02   -4.787260008856070e-03   +4.877508282022842e-02   -5.057064188312060e-02; +1.248479311255521e-01   +9.756879744760323e-02   -2.832457224112017e-02   +2.332789642391005e-02   -1.466354825528627e-01   +3.960449290444677e-02   -1.324508067245105e-01   +9.495832892346494e-02   -1.038720205227900e-01; +4.255383630224730e-02   -3.367437076343475e-02   +2.558839952178599e-02   +9.659201404027069e-02   -1.702910582400892e-01   +7.388571718446131e-02   +4.825532963257467e-02   -2.165574052989471e-02   +9.327923240157618e-03; -4.044017475947134e-02   +8.144467528483616e-02   +3.265785591700432e-02   -3.024660599069043e-01   -1.399220572812396e-01   -1.124831922016078e-02   +1.248567709126704e-01   +1.293848683946494e-01   -1.239657721337044e-01; -8.099229435219342e-02   -1.633252849570435e-03   +4.095121843273299e-02   -2.461791470246900e-01   +2.668617970481522e-01   +9.901764751121915e-03   -8.708364283142081e-02   +8.651772861677774e-02   -8.559014518325019e-02; +2.661413254758118e-02   -4.589870190082961e-02   -6.874332657715553e-02   +8.970803880062243e-02   +1.655704155745338e-01   +2.896441810796290e-02   +1.957234623951383e-01   +8.201047089478823e-02   -1.067278858227463e-01; +8.748684758479225e-02   +1.299292158976659e-01   +1.885835525295491e-02   -6.386159629541463e-02   +3.513463199935449e-02   -8.742364681276066e-04   +1.357251049724575e-01   +8.487536328248910e-02   -1.727907308999027e-01; +4.039824345869035e-02   +4.230789591908676e-02   -1.461439180230777e-01   -1.082885228615718e-01   +5.056914425833487e-02   -1.947450266404708e-01   +5.421137029734213e-02   +1.856114788610629e-02   +4.664094707096579e-02; +5.740399967232399e-03   -1.757367530459918e-01   -1.415600392659120e-01   -6.565285505677212e-02   -1.723765506015973e-02   +1.912985654490528e-01   +5.060671037469099e-02   -1.840300572873633e-01   +6.310459213203080e-02; -9.583409534883749e-02   +1.350508028114216e-01   +4.084758630908084e-02   -2.351154318949469e-01   -4.691774027462870e-02   +1.530765837888446e-01   +2.772585804216792e-01   +1.366604131423445e-01   +1.355367768602120e-01; -1.988351220194727e-01   -1.285306177618567e-02   -4.721756063396123e-02   +1.617878818614033e-01   +8.204192702469924e-02   -4.813765173899420e-02   -2.288217365366247e-01   -8.812088718971477e-02   +1.566197033597803e-01];
L4_L1_iAMPA_netcon = [-7.078623780592283e-02   +1.431159110430749e-02   +4.233926976645280e-02   +1.546562005388259e-01   -2.389188307703187e-02   -1.063734437780551e-01   -1.446012474946244e-01   +3.173993089408803e-02   +2.034010137513600e-01   +2.062423278427648e-02   +6.985407366819668e-02   +2.832346249088215e-02; +2.375143924847351e-01   -1.821809768724701e-01   +1.273553434419645e-01   +2.177906592850621e-02   +1.375353735513125e-01   +2.078227261086916e-01   +1.514758521524488e-01   -1.160872845534646e-01   -1.574487712467517e-01   +5.202348037010018e-02   -9.948788390977287e-02   +1.380136115183002e-01; +4.352891810363059e-02   -3.977871678637199e-02   +1.393449075112960e-01   -1.078190473629798e-01   +6.780646932342230e-02   +3.808179937924498e-02   -3.839427389665744e-02   -1.920662821085319e-01   -2.677877825213509e-02   -1.240944538731167e-01   +1.057881029236858e-01   +3.859129823585479e-02; -7.813109034430182e-02   -1.253961506112547e-01   +1.926685443511563e-01   +1.598005485686012e-01   -1.171821428391931e-01   +1.485645462535481e-01   -6.351319233584572e-02   -1.579860036248610e-02   -4.614910204805433e-03   +2.212122348412914e-02   +1.540366596758056e-02   +1.454462446295243e-02; -1.248353709206469e-01   +6.922904581800192e-02   -3.027738385904138e-02   -1.545471962409015e-02   -1.270479337089295e-01   -4.938738783356501e-02   -1.907747298201484e-01   -2.193319081456612e-01   -7.832765530790411e-02   -7.720391851913935e-02   +2.839972291679968e-03   -3.467344240221004e-02; +2.027408642058857e-02   -1.122206605299802e-01   -9.659542043257752e-02   +8.841893987412325e-02   +5.044213333704797e-02   -3.318904891088179e-02   -3.407031149421785e-02   -2.089831033537756e-01   +1.267453926929891e-01   +6.479168807166003e-02   +8.911154030868114e-02   -2.161035811207195e-02; -3.825544150941110e-02   -6.677314522980055e-02   -8.688136144619357e-04   -4.620225964535071e-02   +6.718850297357060e-02   +8.669391349716268e-02   +3.917192916150086e-03   +5.933850851732875e-02   -2.050954794748456e-01   +2.669340324675456e-03   +8.389301173108871e-02   +4.020009395159982e-02; -7.643233959805902e-02   -7.440072223772570e-02   -2.195273187783504e-01   -3.923167466472369e-02   -1.161812283060696e-01   -5.755487191775181e-02   -2.487308718416126e-03   -4.741116921553861e-02   -1.236834841451220e-01   -1.822387843458760e-01   +3.119140480735399e-02   -9.084853620388503e-03; +8.221264135862977e-02   -2.703734324456378e-03   -1.020231845550597e-01   +1.147025676997150e-01   +1.140492116196515e-01   +4.354602913638671e-02   -1.426733101234235e-02   +3.689998294617076e-02   +1.051539488123300e-02   +3.733433711303517e-02   -1.835655734997715e-01   +5.047036405982752e-02];
L1_L3_iAMPA_netcon = [-3.652423124275053e-02   +4.708343837714402e-03   +6.834449438159165e-02   -4.967173700139051e-02   +3.480191727978947e-02   -1.840861735308197e-01   +5.632023682664513e-02   +4.495160465495184e-02   +2.084261840968970e-01; -2.240503074568745e-01   +3.804776057094863e-02   +1.958146060310711e-01   +9.148383440034422e-02   +1.029769507294653e-01   +4.308364060845200e-02   -5.224980653150602e-02   -1.397044581623591e-01   -7.870032737915233e-03; -4.733515269409588e-02   -8.832044766793702e-03   -1.342288568002590e-01   -1.275638517138533e-01   +2.545928993396755e-02   +3.155508128376236e-02   +1.983097524372021e-01   +4.142419370234180e-02   -1.256420467716725e-01; -3.400041603235650e-02   +5.492876755294194e-02   +5.557777968492335e-02   +2.111027995205031e-01   -6.323135411268183e-03   -5.210150625457921e-02   +5.989159919222847e-02   +1.460925350957781e-01   +2.103531949647889e-02; +2.091965912755857e-01   +1.322641365332051e-01   -6.978723436961369e-02   -2.525479936248436e-01   +1.094819048124115e-01   -9.720243425963190e-02   +6.036127647780898e-02   +3.231721018377481e-02   +1.915260330899880e-02; -1.295330258212500e-01   -1.754500705199582e-03   -1.910994895034493e-01   -8.315152735016114e-02   +1.431700208161622e-01   -8.656289697327200e-02   +9.815643184719794e-02   +7.280678360877030e-02   +3.650916274248047e-02];
L3_L1_iGABA_netcon = [-7.764520798020963e-02   -1.738707995262733e-01   -1.738985937020030e-02   -1.076343587271059e-01   -1.045423284508440e-01   +1.194380967638694e-01; +8.125211741084118e-02   -2.537309585930760e-01   -5.701208517926334e-02   -6.030522549967905e-03   -4.839962741914611e-02   +3.235560582377578e-02; -1.516122117210299e-01   +7.332568597710397e-02   -4.489128166340553e-02   -2.241156018206679e-01   -4.272326967605215e-02   +1.114961749270374e-01; +1.258421687528083e-01   -1.314598282991815e-01   -6.468810843438286e-02   -2.814407048395234e-02   +1.437194725383003e-01   -5.621233541786368e-02; +1.558223021068699e-02   +2.905129494713999e-02   +1.409757113165737e-01   +8.667951350427500e-02   +8.317147800938655e-02   -1.987920449990541e-02; +2.632817138578968e-02   -1.997527753325803e-01   +6.754215437127946e-02   +2.733705909656858e-02   +8.561074975227127e-02   -9.511757491590865e-02; +2.982205664382672e-02   +2.535062101070437e-01   +8.009311548738089e-02   -1.993679206123058e-02   -4.647859584815067e-02   +1.387312406092353e-02; +1.999576146932430e-02   +2.715032228781374e-02   +5.593996851173175e-02   -5.203818656363769e-02   +1.510567911184660e-01   +6.139461757801373e-02; +4.822422403381289e-02   +8.701001730231414e-02   +8.361584112621578e-02   -1.285885305043001e-01   -1.557193195401025e-01   +6.255644146163249e-02];
L5_Input1_iAMPA_netcon = [-1.619084180514502e-01   -5.611151852141333e-02   -2.009175615425604e-01   +1.667968004267538e-01   +3.163743011041206e-02   -7.284006257283909e-02];
L6_Input2_iAMPA_netcon = [-7.503833232160220e-02   +7.166134700513785e-02   +2.793187770139096e-03   -4.731515866720958e-02   +1.252745649252069e-01   +1.396351625972728e-02];
L5_L6_iAMPA_netcon = [+6.417799236540336e-02   -3.822306956791828e-02   -1.073357338178704e-01   +2.277780660062666e-01   -1.469477492390766e-01   -2.317782567808045e-01; -3.275722328695406e-02   +9.801257018696018e-02   -1.082076264482292e-02   +5.304558252797882e-02   +7.181465170736308e-02   +3.125884394192034e-02; -1.199818499842580e-01   +6.124786671630439e-02   +6.169354580797375e-02   +6.555601668450292e-02   -4.361447434170343e-02   -6.685964958809615e-02; +8.066001263695545e-02   -1.410043130608094e-01   -2.124802999019967e-02   -3.296948571045184e-01   -6.069362879280297e-02   +7.047547017782908e-03; -3.172930921860453e-02   -1.829823559088507e-02   +1.109941875968501e-01   -4.499408720597892e-02   -5.107428634859029e-02   +1.101857390781763e-01; -1.537622521380350e-01   -2.266934953948633e-02   -2.536617538735511e-02   -9.376689224052716e-02   +8.909223644448352e-02   +4.194683134078953e-02];
L4_L5_iGABA_netcon = [-1.383687200007614e-01   +3.095770138394375e-01   +1.553414788442745e-01   +2.030851833526615e-01   -1.270085340166463e-02   -3.138232248059872e-02   -3.675297286367767e-02   +4.586041237676744e-02   -1.175968733404743e-02   +1.945607621384542e-01   +3.462659659994560e-02   -1.659510259963995e-01; -1.697179323423331e-01   +4.851153549077925e-02   +2.164820559386147e-01   +1.534171179943370e-01   +3.566029195796931e-02   -5.869484385110083e-02   +1.154475698582331e-01   +7.826611542418366e-02   -2.691672903898054e-02   -7.666807011326965e-02   +1.817691827156325e-01   +3.540967644618787e-02; -1.413671008524889e-01   -2.997274587681748e-02   +3.984441016767963e-02   -1.332713175011795e-01   -6.716472929302419e-02   -3.570006331270859e-02   -1.020692441405555e-01   -4.084717193226706e-02   -1.986765489717687e-01   +2.123436297095763e-01   -7.015240505307753e-02   +1.007584891087168e-01; +2.505318068998930e-01   +1.074875204530619e-01   -1.691617819297438e-01   +8.095609893817950e-02   +1.539882122721904e-01   +2.919452106994951e-02   +1.501825055689767e-01   +1.573017798278851e-01   -1.210064349854991e-01   +2.926453794616256e-02   +1.671975620496061e-01   +2.294504865380613e-01; +1.462156737899840e-01   +1.238675871447751e-01   -4.285827694794071e-02   +9.372064804023164e-02   -1.605915438439538e-02   -5.793850331478159e-02   +5.486399211806060e-02   -5.695755401572770e-02   +1.459272093000563e-01   -9.346516655169579e-02   +1.601815895637179e-01   -1.506848756862097e-01; -8.201254644725917e-03   +2.826239501224866e-02   -1.067036989756174e-01   -2.451823874369550e-02   +4.230214627980783e-02   +4.374441816867030e-02   -2.643351572821522e-02   +9.308898117721594e-02   +6.559623906173161e-02   +2.969441132564861e-02   -2.048424207380527e-02   +7.022707513433157e-02];
L6_L4_iAMPA_netcon = [-4.632386639801492e-02   -2.388386681898117e-01   -1.532803080324803e-01   -1.061173368581840e-01   +3.678486561070902e-01   -9.652814280357740e-02; -2.971694606917392e-02   -1.728215441508796e-01   +3.286456360707918e-02   -1.129702505510002e-01   -7.950022866636572e-02   +7.485088887771903e-02; -1.545168359736004e-01   -1.433386235843339e-01   +3.424320646440455e-02   +3.095917396413838e-02   +8.597909599897607e-02   +1.382529150230201e-01; +7.076491146137276e-02   -1.872920375017751e-01   -1.098024930950239e-01   -8.805955969425307e-02   -3.002123061179114e-02   +2.103069281836319e-01; -8.351654178252024e-03   +6.455654213263803e-02   +1.589690796900762e-01   -1.028883327695949e-01   +1.103612640079310e-01   -3.755359537280958e-02; +1.201757133859816e-01   +1.373606149508010e-01   +4.544407958974740e-02   +1.712676339906979e-02   -2.052721289028527e-02   -1.831561814674651e-01; +7.461991779258217e-02   +8.119668944767408e-02   -1.634126734071498e-01   -1.771568929200504e-03   -9.407802416281083e-02   +1.999171216335068e-01; +6.960030432717701e-02   +7.626236723732172e-02   +3.356047496924539e-01   +6.592280226121121e-02   -6.249766167664599e-02   -5.731370851119853e-02; -1.856316438554754e-01   -1.167714224219512e-01   -2.697746420891916e-02   -2.975484019381644e-02   -3.979986110730926e-02   +3.859241336932799e-02; +1.828093263229176e-01   +6.856168884294023e-02   -4.303909435836977e-02   -2.141771210605307e-01   +2.646113780615532e-01   -1.423553562819803e-01; +2.797183652876689e-02   -5.957050185946523e-02   +7.851533813786660e-02   +7.733050922626612e-04   +4.171821423318774e-02   -2.540139801958980e-03; +9.014819265903204e-02   -1.935435642168822e-02   +1.316313941226373e-01   -3.864460039999025e-02   +1.659806890221117e-01   +4.628903131597840e-02];
L5_L4_iAMPA_netcon = [-1.780367856082968e-01   -2.458670090451816e-01   +1.192425545954762e-01   -4.406848628924258e-02   +1.015640397259674e-01   +7.038015505850091e-02; -3.015998348092555e-02   -1.040781298758479e-01   +1.859231123056904e-01   +5.038348041145971e-02   +1.111901843607515e-01   +1.172167142591242e-01; +2.232120678705565e-02   +1.692150613934825e-01   -6.282989406326651e-02   +1.138981064849172e-01   -2.483092498959904e-02   +2.434231582108339e-01; -1.346671561028664e-01   -7.003649095129061e-02   -3.256969401544758e-02   +3.491998825141829e-02   -1.193367081898985e-02   -1.526006088304742e-01; +8.063165582249408e-02   +2.095044418565970e-01   +2.283444924052260e-02   -1.098227110699900e-01   +1.305317714761235e-02   -1.411691279590324e-01; -9.555495651864815e-02   +3.288277390728017e-02   -3.145137776114406e-02   -5.625392541070095e-02   +7.206125800985475e-02   -2.412222669660094e-02; +3.561869607715341e-02   -1.303751368493292e-01   -3.630174393900799e-02   -1.006446200331160e-01   +1.523806576662426e-01   +1.764292599017875e-01; +8.909047625973623e-03   +1.509902828625846e-01   -1.303809244619936e-01   +1.131557462461461e-01   +1.494037547558452e-02   +1.937049395092225e-01; -4.577947547495682e-03   -9.244838917006121e-02   +1.008477582932877e-01   +7.571856184508595e-02   -1.507979850488563e-02   -5.553661585919434e-02; +1.086079050462992e-01   +8.003524816792532e-02   -1.162064817157375e-01   +9.830835155089918e-02   -1.687013785699527e-01   -9.759636390325248e-02; -9.905193264394113e-02   -8.424745447963669e-02   +1.991741836919383e-01   +8.833518439764199e-02   -5.783255393463933e-03   -1.024161801163653e-01; +2.877112736353407e-02   -2.386772595203545e-01   -1.360936525071705e-01   +1.013563996742262e-01   -1.916724435859155e-02   +6.455816247590462e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
