function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.298101933329229e-01   +6.908671542646329e-02   -8.154908952613804e-02   +3.421787389514830e-02   -4.970525823835609e-02   -6.570366225705951e-02   -2.397312781729609e-02   +1.900184251340862e-02   -2.628928460796120e-02; +7.677081770547652e-02   +8.923935389948477e-02   +5.747410890093844e-02   +5.948343521749392e-02   -1.439062886911365e-01   -4.516595697957367e-02   +7.586925937481470e-02   +1.321015447953580e-01   -7.610309547340720e-02; +5.230333260406363e-02   -1.071875047276982e-01   -8.622118303440535e-02   -1.808523497127180e-02   -1.441751481591216e-01   +5.117438800500993e-02   +8.792971412431351e-02   -3.862535582176869e-02   +4.792759856218536e-04; -8.226780753955062e-02   +7.717142256454354e-02   +4.979684621626107e-02   +8.903202630378970e-04   -5.225300229096948e-02   +7.276335212410501e-03   +5.389223592140170e-02   -5.893393736895532e-02   +1.914986222138301e-01; -1.240482576485285e-01   +7.353771289256908e-02   -3.214960830689648e-02   -1.548378927708594e-01   +1.257058116050717e-01   -5.929681326195151e-02   +1.212408441318327e-01   -9.825818692428243e-02   +3.329178747934368e-02; -3.743147102179263e-02   -8.328298069695400e-04   -1.106734976291217e-01   +2.385660077524249e-02   -5.265826527434016e-02   -6.766980350450924e-02   -4.292627192790652e-02   -2.439075346834053e-03   +1.665628659264401e-01; +2.989375974506207e-02   +1.783021350316460e-01   +8.813963223913905e-02   -1.110755760283517e-01   +4.186772319167306e-02   +1.886515963145738e-01   +1.150897029305948e-01   -2.339151376446899e-03   +1.107872814498900e-01; -1.630057753483349e-03   -1.012542888269423e-01   -7.916227992192224e-02   +6.714730626045112e-02   -1.651687343936928e-01   +1.837987308937299e-02   -2.643337838271952e-02   -2.075126159195827e-02   +2.551050109351762e-01; -2.389345538078228e-02   +3.722397470222391e-04   -1.053807494557429e-02   -1.847556777770427e-01   -1.336635634523980e-01   +3.335971286482574e-02   +5.500708266110280e-02   +1.097366430884869e-01   +1.368673981374420e-01];
L1_L2_iAMPA_netcon = [-1.470353334474393e-01   -9.100049043684616e-02   +1.745043517947304e-01   -3.769645354218100e-02   +2.090591085233207e-01   -1.197491112633501e-01   -1.567610700578831e-03   -7.107056899673245e-02   +7.944859388058617e-02; +8.750637610154889e-02   -8.771678059063592e-02   +3.596142001580464e-02   +2.735751510888071e-02   -1.064576037947285e-01   +6.804139393998575e-02   +2.731060335460653e-03   -1.409146660270739e-01   -8.535974977299021e-02; +7.910201012885140e-02   +8.687569266326965e-02   -1.203792507075276e-02   -1.106344624714423e-02   -4.322576318237659e-02   +2.526123069650090e-02   +4.377209067598460e-02   -2.255001299354175e-02   -6.491218511207604e-03; -1.893702648754657e-01   -1.763777084402586e-01   +3.581986745347956e-02   -6.304887684133216e-02   +5.077541134178386e-02   -1.255415910562281e-02   +3.963003803775155e-02   -6.061804777513866e-02   +1.174646497237678e-01; -1.008144723615176e-01   -9.429545973813422e-02   -7.102685604351616e-02   +9.729606510425759e-03   +4.704478672099816e-02   +2.531131652877164e-03   +9.331861829528267e-02   +1.363460363166351e-01   +6.121598536752773e-03; +7.187853718089415e-03   -8.996636060014621e-03   -1.315643236972120e-01   +1.081939701953155e-01   -1.694793882850909e-01   +1.779266053673470e-02   +1.479920245180022e-02   -2.365954036725669e-02   +1.632932092380961e-01; -6.246028637181854e-02   -3.310747082524251e-02   -6.815422592103028e-02   -9.651757838426779e-02   +1.033305311897234e-01   -1.535333034915192e-01   -9.906362843898150e-02   +1.202845606651433e-01   +1.075512394623845e-01; +1.453191022600995e-01   -5.286021666750481e-02   +3.681674643887567e-02   -1.096642507721283e-01   +1.438557492309168e-02   -5.424773389614225e-02   +7.187496883385364e-02   +1.367134850952243e-01   +4.251747933559432e-02; +3.167410814656334e-03   +9.181836138192613e-02   +4.788785499691417e-02   +1.986728284021101e-02   +2.299616266189729e-02   +5.787527184104367e-02   -1.280883564246735e-02   +3.862367030676063e-02   -1.705990108624738e-01];
L2_L5_iAMPA_netcon = [+1.055986760831752e-01   +1.610613315202439e-02   +7.401464523487196e-03   -7.701332212911462e-02   -1.692322386672818e-02   -2.567477728421211e-02   +7.882383084122235e-02   -9.724895348931334e-02   +7.914926459390897e-02; -9.790156231465452e-03   +1.864141545372111e-01   -4.678969059285752e-02   -1.618576534626988e-01   +1.700861348958269e-02   +8.069616222410009e-02   -1.768025700203608e-01   -4.097790329270491e-02   +3.626170645908894e-02; +6.222338268752243e-02   +1.252774997430531e-01   -1.039561697697117e-01   -9.017293915396938e-03   -1.866531834330704e-02   -1.612144005285774e-02   +7.155303446613495e-02   +8.259348366294515e-02   -1.095227364504613e-01; +2.231671260333816e-02   -2.675894173475138e-02   +6.472387177437230e-02   -4.157776932225712e-02   +5.407884699714781e-03   -2.880191032921771e-02   -2.106491843380703e-01   -3.813099516599619e-02   +3.720946041303230e-02; +1.320741310116992e-01   -1.118982482579894e-01   -1.898228914602437e-01   -3.255542600619933e-02   +9.140934871178810e-02   +3.627795897561154e-02   +5.778940687222767e-02   -1.260962485988051e-01   -1.498875454158850e-02; -2.186657261847677e-01   -3.628470072779448e-02   -1.567455832814539e-01   -1.750624781391381e-01   -3.060138734521096e-03   +1.255066626773735e-01   +4.254573962117015e-02   -1.135886602564545e-01   +1.330898496716748e-01];
L5_L2_iGABA_netcon = [+1.536574057214260e-03   +7.315663384650032e-03   -7.143424948712032e-02   -1.124359646705258e-02   -2.872133685239669e-03   -9.191436018746735e-02; +5.062621928094234e-02   -1.856983052137566e-01   -5.297425566266604e-02   +5.420694992912339e-02   +2.529635499700114e-02   -9.855843399237431e-04; +1.234417909480898e-01   -4.087168734622766e-03   +6.135512244425628e-02   +2.302307615259505e-02   -5.087485671487692e-02   +5.395943824894750e-04; -2.413724959002420e-02   -6.678895609446579e-02   -5.435073373478193e-02   +1.080036701824126e-01   +7.210878139974235e-02   -5.404919208652871e-02; +1.073184205783023e-01   +3.271454521795791e-02   +1.142370740560586e-02   +3.732105119311689e-02   -6.223632185462352e-02   +1.245591011997317e-01; -9.086810676901354e-02   -1.919064965601916e-02   +6.211606106268446e-02   -4.233435873944717e-02   +1.951802841514388e-03   -1.205557467010543e-01; +9.974533701649010e-03   -1.138607888690327e-01   -8.671118826598592e-02   +1.422037725669066e-01   -6.913671512044259e-02   +2.669167568117320e-02; +1.760726748686510e-01   -1.350494891221318e-01   -1.303052724132268e-01   +2.111123369102157e-01   -7.359203020730454e-02   -6.630604522986201e-02; -1.023962625066471e-01   -3.772784932527533e-02   +6.161861932263125e-03   +1.273147625100584e-01   -7.320819635171258e-02   -1.167578856889911e-01];
L3_L2_iAMPA_netcon = [-1.725540346749447e-01   -1.732143547112033e-02   +6.135188850754496e-02   -1.164516457995783e-01   -1.463806241116088e-01   -8.668898030767676e-02; +6.179346773598804e-02   +1.328002963976153e-01   -1.033495327534056e-01   +2.351559425044963e-02   -4.454710560109524e-03   +2.451189066706923e-01; +2.919353129904037e-02   +9.389656163045823e-02   +1.046352855914646e-01   -1.351488300890789e-01   +1.810142282167915e-01   -1.363735538093651e-01; -2.592791415704351e-02   -4.356917850117506e-02   -1.447586440297375e-01   -7.831884269983212e-02   -6.384273202643984e-02   -6.604930720749928e-02; -8.564156442274393e-02   -1.504431897823170e-02   +1.429395021256591e-02   -8.241303452368250e-02   -1.739740358503543e-01   +1.205276711474949e-02; -7.457901730161777e-02   -1.249399981346986e-01   -1.510144232952506e-01   -1.669404604484697e-01   -8.060193341011558e-02   +1.483450230231699e-01; -1.261871597517163e-01   +1.360674959075505e-01   +8.217434948406488e-02   -7.791770399927779e-02   +8.889534840429747e-02   -4.523420907231047e-02; +9.578614072767490e-02   +3.264582399216395e-02   -1.802261701123330e-01   -5.268209095149348e-02   -4.987766123234484e-02   -1.002389283816616e-01; -1.147611656417751e-01   +2.091997007352268e-02   -4.490151467397940e-02   -6.213244346677019e-02   -5.907903703041696e-02   -2.542556201596560e-03];
L2_L3_iGABA_netcon = [-5.104580520361862e-02   -2.965772898840801e-02   +1.405023199445153e-01   +9.788582401236362e-02   -6.043829331563425e-02   +2.526894819825445e-03   +9.438788272534474e-02   +6.100733978397395e-02   +7.310111421603701e-03; -1.463713600802432e-01   -8.948936746284497e-02   -2.622562784930707e-02   +1.526729794960991e-01   +1.068253733465704e-01   -9.119892814206144e-02   -1.034011738091316e-01   -6.543462416623175e-02   -3.499535460275812e-02; -6.549449484924216e-02   -7.083768636980678e-02   +5.097678373018483e-02   -8.103965550246239e-02   -2.878701690151786e-02   +1.918046347204118e-01   -1.362989548412867e-02   +1.179068793082641e-01   -1.844324574638889e-01; -7.686476948567694e-03   +5.274870701926788e-02   +5.405837789407260e-02   +1.000148419086413e-01   -3.643220891073160e-02   +2.001643920203015e-01   -2.975483793247648e-02   +8.324810076997988e-02   -4.022291093284018e-02; +4.180993658327991e-02   +1.453277403726321e-01   -1.078148885349116e-01   -1.524601922293289e-02   -3.579183957733623e-03   +1.312268631516909e-01   +2.251971704088309e-02   +1.302901942982660e-01   +1.683764806556316e-02; +1.192049508865361e-01   -2.941891399518521e-02   -5.717003900849248e-02   -1.787362570108250e-01   -6.769241794253567e-02   -3.904816268331685e-02   -6.221410402880426e-02   +4.468376126080044e-02   -1.585438301091685e-01];
L1_L4_iGABA_netcon = [-5.268697304378191e-02   -4.463562944901906e-02   +1.447233822307471e-01   +3.786542947567181e-03   +1.921512663183420e-01   -1.615078297970358e-01   -3.169616673099430e-02   -1.574747653748331e-02   +7.661468841019876e-03; +5.914971738371794e-02   +4.327371919247507e-02   -4.612616504939708e-02   -1.701424846262943e-01   -6.854894012998958e-02   +1.729395839478521e-01   -3.250118274618528e-02   +4.907085362760086e-02   +6.188134987299883e-02; -9.092591868268840e-02   +3.195537179323882e-02   -1.081085350888596e-01   +1.930860506770301e-01   -1.210675368612521e-01   -3.257859527698767e-02   -6.109182171268141e-03   +5.978024314852524e-02   -1.921822965029628e-01; +3.207535189492509e-03   +3.294964811935460e-02   +7.549354432306737e-02   -1.007331105047903e-01   -1.125375814086797e-01   +7.116567332000648e-02   +1.076883989841284e-01   +1.486138023892020e-02   +1.691352711383142e-01; -1.659035670777770e-01   -4.618984872791507e-02   -1.231737729728237e-02   +9.617275904491070e-03   -8.105022453675474e-02   +8.985308193838923e-02   -8.484211521962348e-02   -4.000645910405178e-02   +2.627266119084319e-02; -3.761759368312972e-02   +9.217601035058814e-02   +3.298447927962811e-02   -5.212848023009178e-02   -2.064513540097071e-03   -1.959423735460791e-03   -2.064185532338408e-01   +1.646840207150604e-02   -1.765582492743545e-01; -5.892702755391081e-02   +1.180574349956412e-01   -1.717654464412346e-01   -8.359072094123533e-02   +6.383224747162936e-03   +7.295795818239435e-03   +3.628436383532646e-02   +6.842784396596382e-02   +1.712484535865748e-01; +1.103856456895579e-01   +1.344349900926641e-01   +4.272098657241543e-02   +6.328062761955638e-02   -1.055987375863674e-01   +1.202228635702861e-01   +8.545212765119513e-02   -7.172976762124411e-02   +7.529383851276758e-03; +2.890554949121632e-02   -1.669203859210094e-01   +3.739367747082968e-02   -1.187299934802468e-01   +2.495221886047311e-02   +1.430412538486248e-01   +5.846338720504468e-02   -2.209245207375611e-01   +1.282198393081864e-01; +1.102078118104116e-02   +4.535456344423210e-02   -5.246562023428036e-02   +1.529251015551683e-01   +3.100673979735711e-03   -3.667690563624458e-02   -1.230919808199421e-01   +7.830846493205623e-02   -3.108929491894109e-02; +6.721677859489272e-02   +4.168378552931989e-02   +1.464157902955147e-01   -3.939515258191273e-02   +5.300771694455588e-02   -2.086155734168021e-02   -1.516736391044039e-01   +1.467056848680244e-01   +1.595607365085327e-01; +1.776213152753544e-02   -4.182241932523131e-02   +5.293161194515889e-02   +8.025397495639303e-02   +1.178999608881877e-01   +2.089963319186780e-01   +5.004996155456706e-02   -1.437060992675489e-01   -1.259160279853457e-01];
L4_L1_iAMPA_netcon = [-1.168462384758222e-01   +1.173260226970480e-01   -2.299738661835591e-02   +4.623068109990192e-02   -5.436340172938319e-02   +5.908250898403364e-02   +9.476545943978196e-02   +6.021658694899568e-02   -1.078303698167807e-02   +2.575302071356288e-02   +3.062461498317855e-02   +7.630984604737207e-02; +2.809543888953915e-02   +3.612792581358936e-02   -1.695832492267603e-01   -7.041946676971755e-02   -9.118088424199667e-03   -7.344114932532805e-02   +1.163324471497723e-01   +1.251308851232065e-01   +4.897697703200910e-02   +1.911298460545998e-01   +6.436472998965452e-02   -7.944418105917089e-02; -1.304884507296662e-02   -1.487157919579450e-01   +5.160477698419769e-02   +5.629770872589458e-03   +1.516934851885304e-01   +4.281241853530940e-02   +1.379830377209609e-01   +5.557554196344604e-02   -2.339661019569160e-02   +1.027362656842691e-01   -2.100017228079831e-03   +9.115214845984274e-02; -8.871635354306806e-02   +8.669828188792300e-02   -1.160296390562437e-01   +2.166464790772746e-03   -1.096431924251705e-01   -3.920530259575558e-02   +5.508381787523058e-02   +9.552449092443382e-02   -2.085590202129436e-03   -1.143571244136301e-01   -5.699458498328485e-03   -4.025173368779467e-02; +9.847489675416737e-02   -8.923914190614821e-03   +6.023479164495181e-02   +2.698846541937421e-02   -5.930144524255155e-02   +1.023329087547790e-01   -5.578069887902753e-03   +1.482119014983089e-01   +6.433764119441635e-02   -1.323857399518119e-01   -8.712696257424651e-02   +1.166538955801035e-01; +1.611116286833724e-01   +1.666830155555900e-02   -7.050323802461403e-02   +4.605578685094943e-02   -8.072578406791886e-02   +1.280075685126388e-01   +1.823317585665058e-01   -1.249235454032040e-01   +1.771489946113416e-01   +1.717576660326798e-02   +2.476719069186486e-02   +8.598815966299156e-02; -9.475277719116020e-02   -3.449469677400105e-02   -1.364096668119943e-02   -1.666681330723088e-01   -4.422459786602495e-02   -1.486567646386979e-01   -7.549464841251606e-03   -2.859612562017588e-02   -1.635372359395221e-01   -1.190691787625158e-01   +1.134748373522240e-01   -6.763712348148233e-02; -6.820665617857616e-02   -1.014324517829763e-01   +4.192872489284823e-02   -6.529913048919216e-02   -3.489713448737565e-02   -2.523810430889492e-02   -5.101781817779714e-02   +7.142455591258713e-02   -2.599034173147740e-01   -5.874105877197107e-02   +1.523271641993886e-01   -1.355776085045429e-01; -2.203071164458832e-02   +3.892755948053289e-02   -1.866505436373295e-01   +6.628008754031298e-02   -1.087742666106729e-01   +1.393802870448933e-01   +1.173954765479624e-01   -6.996973253134675e-02   +7.871219195073619e-02   -1.909121726442476e-01   -3.810158179101142e-02   -2.242669753689991e-02];
L1_L3_iAMPA_netcon = [+5.414497705854647e-02   -7.268284837533839e-02   -1.794272626309343e-01   -7.519986696851647e-02   -1.801473358190384e-01   +6.134404303429009e-02   +1.372086355469103e-01   +3.121644146335196e-02   -5.945315405502923e-02; +5.196607011475386e-02   +1.570563653392639e-01   +8.174334713265081e-02   -1.018959168321679e-01   -2.556482559116589e-02   +5.915293069395467e-02   -1.682233664587124e-01   -3.555460869345980e-03   -3.884414206629907e-02; +1.362070295923736e-01   -1.073245589196287e-01   -1.168516113648194e-01   -1.675725110354612e-01   -8.827813864688039e-02   +1.512957111478194e-01   +3.628354470432678e-02   +7.388473633397533e-02   -7.286123704097863e-02; -1.117226248998616e-01   +1.583481879627573e-01   +1.192702041277465e-01   -2.329540389161066e-02   +7.495947725566617e-02   -5.375332071520994e-03   -2.715088525121556e-02   +6.098709224273138e-02   -3.163634512874763e-02; +2.750254682683819e-02   -1.953941799636770e-02   +5.452802313897712e-02   -9.352374969704017e-04   +4.423274961168204e-02   -1.303068935803323e-01   -1.214470549979066e-01   +7.339719891546023e-02   +3.659456740937382e-02; +8.537306408312077e-02   -2.605738920048861e-02   -9.019826322942583e-02   -1.873359844572552e-01   +7.278988378575432e-02   +1.393088103051442e-01   +7.285882324416974e-02   +4.045525656421196e-02   +1.484966217889959e-01];
L3_L1_iGABA_netcon = [-6.326949327187298e-02   -7.834024711649661e-02   -1.298565284980274e-01   -2.569394900331744e-02   -8.734746865209930e-02   +9.726498268007921e-03; -6.160285109123238e-02   -9.551391330843248e-02   +6.143769748334069e-02   -7.504902236490375e-02   -3.955916691721387e-02   +1.261923346582583e-01; +5.908004982313552e-02   -3.896415942050975e-02   +1.295554985688323e-01   +1.182409419171381e-01   +5.530361632293979e-02   -8.047944231400336e-02; +8.232800314917971e-02   +1.869067523300459e-01   -1.101294149965776e-01   -1.357855711410497e-01   -4.688860304986953e-02   +5.209421146136397e-02; -2.551759511662795e-02   -1.341300518386045e-01   +2.124205971094202e-02   +9.143669519125974e-02   -8.574590414278713e-02   -4.697206633091276e-02; -1.362267437922753e-01   -2.781741525604925e-03   -1.575816304217263e-01   +1.037105665469584e-01   -7.785214345157661e-02   +1.996125612972009e-01; -2.118735818830780e-02   +7.151747181003695e-02   -1.422018492022883e-01   -4.270447711920006e-02   -1.664809876929506e-02   +3.400652579854897e-02; +1.109071067254994e-01   -1.378322776862753e-02   +2.261634051964035e-02   +2.006415235361002e-03   +3.421993289219818e-02   +1.618269962583883e-01; +5.008354289781169e-02   +9.667561088736112e-02   +1.257358162851465e-01   +8.725220974223818e-03   -7.685667614010970e-02   -7.539477509224105e-02];
L5_Input1_iAMPA_netcon = [+5.890638893695439e-02   +1.674297180910330e-01   +8.226055270833899e-02   +7.039459241523706e-02   -4.688665094897781e-02   +1.747011561700777e-02];
L6_Input2_iAMPA_netcon = [-2.025891537166153e-02   +1.459807907064809e-01   -2.628835394188656e-02   -9.217768217314371e-03   +1.198514505828107e-01   +5.279932896280947e-02];
L5_L6_iAMPA_netcon = [-9.331265685607412e-02   +5.332303816013633e-02   +2.115106273309759e-01   -1.074955994488520e-01   -4.360503218599289e-02   -9.786836119786223e-02; -3.047860082139489e-03   +5.053388298829228e-02   -1.576361472733989e-01   +5.267663223978913e-02   +4.525029427279129e-02   +8.400140957802626e-02; +2.937142627376213e-02   +1.228712548912379e-01   -7.154816814124315e-02   +7.937656544360397e-02   +2.952716589420821e-02   -2.055596323321764e-01; +5.911319198510019e-02   -7.431929715199698e-02   -1.367472745492912e-01   +1.675976287234891e-01   +1.547984266982730e-01   +2.134396759156805e-02; -9.538588278704979e-02   +7.793855686270096e-02   +6.851225763103044e-02   -8.456314779656368e-02   -4.853791796352227e-02   -1.485960526367478e-02; -5.306715978106501e-02   +4.490534014696242e-02   -3.068903788970523e-02   +8.261255899355731e-02   -7.574958398494422e-02   +1.266193267797347e-01];
L4_L5_iGABA_netcon = [+1.435200829766207e-01   +1.142006994211294e-03   -7.148933109215322e-02   -3.048330974978494e-02   +6.807300948145154e-02   -2.981394337027860e-02   -9.930871020329926e-02   +1.411545817302409e-01   -1.446756225358061e-01   -3.261449319942392e-04   +6.060010013246546e-02   +9.570054898230418e-02; -2.510734452901995e-02   -2.216628936304822e-02   +2.374461875463058e-03   -3.320754489083914e-02   +1.046119489128258e-02   -2.645476905115939e-02   +5.151268174544169e-02   -1.478419590548413e-01   +1.131951156443676e-01   -1.102686637442917e-01   -4.207528300694659e-02   +5.556197207771068e-03; +8.699001601213535e-03   +1.061995217343773e-01   -1.884265464842634e-02   -1.191266081957280e-02   +1.232657243961244e-02   +1.304144370630295e-01   +7.037261842371356e-02   -7.378936743429661e-02   -1.375502028600146e-01   -1.115830650691624e-01   +6.163046682132709e-02   +1.728188555168766e-01; -3.273798002674325e-02   -2.047451964227712e-01   -4.398510819662405e-02   -1.020571608826515e-03   -1.528991632200896e-01   +4.403724677886280e-02   +8.312510192944680e-02   -2.296379833875942e-02   +8.339039940849986e-02   +1.569145756462371e-01   +1.585322137618399e-02   -7.575851978550678e-02; +8.083554380782984e-02   +1.938585737571784e-01   -2.261664235906744e-02   -5.377336294351930e-02   -9.445630051625277e-02   +5.184410340097763e-03   -2.042298778364153e-01   +7.538506399604668e-02   +2.854175466278183e-02   -1.985474161657189e-03   -4.500931044950925e-02   +7.717415913211061e-03; +4.265336570610920e-02   +8.516726517653317e-02   -4.940459796791523e-02   -8.630673925832877e-02   -2.168117566949201e-01   -1.387153560059146e-01   -9.939873239195643e-02   -3.437118430446229e-02   +8.014263563114545e-02   -1.334625509584171e-01   +7.968749515763619e-02   -1.256040186747178e-01];
L6_L4_iAMPA_netcon = [-5.713615304031357e-02   +7.994260277453816e-02   +1.732248418205665e-02   -3.134222104620690e-02   +5.334046995228107e-02   +2.367545503985512e-01; -9.591466127309636e-02   +8.318039792628956e-02   -4.185742214305366e-02   +3.391449757670296e-03   -8.385662207074243e-02   +1.770194190633601e-01; +2.172963166750980e-01   +6.938424937350879e-02   +4.927903931122087e-03   +6.744821448283031e-02   -7.173625897985425e-02   -6.801829220071101e-02; -5.569946385422561e-03   -1.770809971891110e-02   +7.474530169414506e-02   +1.303027092503679e-01   -3.058653913698856e-02   -4.334925920981094e-02; +1.098235117076142e-01   -1.301464819685854e-02   -3.628564561656076e-02   +2.482836141545676e-02   -1.071032162575310e-01   +2.418355932649452e-02; +1.540276471278866e-01   +4.879285206916321e-02   +1.130322242616330e-02   -1.283388656877034e-02   -2.097107886105443e-02   -1.161542489244960e-01; +4.667256711934388e-03   -2.247793546945936e-02   -2.081083102106569e-02   -3.174712099644175e-02   -4.461902632621744e-02   +3.744843527827810e-02; -8.284491681421506e-02   +7.186787185696331e-02   -1.049769300319517e-01   -6.858007294511120e-02   +8.070873969165505e-02   +3.221698911298178e-02; -1.989973463492190e-01   +8.157696672972163e-02   +9.948740798047964e-02   -3.633029950138547e-02   -9.347107452638763e-02   -7.292011519408501e-02; +8.664376804866479e-02   +4.347593887741304e-02   +6.859726366244107e-02   +4.486030746188848e-02   +5.187982705172882e-02   -8.543983932859800e-02; -1.150430693480921e-01   +7.209033581345967e-02   +3.717698684710206e-02   +1.409761132674572e-01   +6.735137677908119e-02   +2.101399108446790e-03; -1.516695343080154e-02   -2.891488984219578e-03   +1.203154445865531e-01   +6.929894337406382e-02   -1.662767076025209e-01   +8.235473824830940e-02];
L5_L4_iAMPA_netcon = [-1.083945680365481e-01   -4.501189021161459e-02   -4.973670114501341e-02   +6.836599024032718e-02   +9.443580074053542e-02   -1.605986647160858e-02; +9.412367583828241e-03   +4.288342970283199e-02   -6.874288694228051e-02   +1.731305381988162e-02   -9.576607379738489e-02   +6.113486253725647e-02; +1.285903867698194e-02   +7.819102944425507e-02   +1.816742169475217e-02   -1.456726670662310e-01   +1.052508737837335e-01   +8.097538351833702e-02; -7.674192089437759e-02   +7.948066269503323e-02   +1.140625274991091e-01   +9.599674926545682e-02   -1.340109077551900e-01   -7.046182407519652e-02; -3.066482858679309e-02   +1.188920722217047e-01   +2.449805741502620e-02   -6.131532031653977e-02   +1.038449729761147e-02   +3.811074066065537e-02; +6.692292458548843e-02   -3.006076377802547e-02   +5.810086269411333e-02   -5.736216880847019e-02   +1.105585449833537e-01   +3.013078132410966e-02; -5.909262024914824e-02   +1.431621714487774e-01   -9.966031680069665e-02   -4.727629654693558e-02   -3.769371679733895e-02   -7.178261094189020e-02; +4.084502837943284e-02   -8.060897602640249e-02   -2.314170103963391e-02   -9.268219553429832e-02   +7.562210324318749e-02   +3.400643217955547e-02; -1.109201416917987e-01   +9.810086590934648e-02   +1.329877996323840e-02   +5.965268181692414e-02   -1.489262002036713e-01   +9.600991712560944e-03; +1.058764746372146e-01   -9.790766562019028e-02   -1.160579266810754e-01   -1.556149837831996e-01   +7.838955465854411e-02   +6.710464813990663e-02; +4.137055324935909e-02   +9.235595795735616e-02   +8.441715484939578e-02   -2.132472035763487e-02   +1.529374389446884e-02   -1.533262920127086e-01; -5.582019762058122e-02   +1.740935344504006e-02   +2.281943891804007e-02   -9.963583134786440e-02   +5.845839483423697e-02   +1.336584823055329e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
