function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.720629079159502e-02   +1.203167512520825e-01   +3.672333254372043e-02   -4.255944076624929e-01   +7.835072690266229e-02   +5.564410327493122e-02   +2.377326245751908e-01   -1.193774096983026e-01   +1.747321521309325e-01; +2.041292951231329e-01   +2.964830628349191e-01   +2.499882181732448e-01   +8.947718894064670e-02   +3.698510749578150e-01   +1.274356963537084e-01   +1.495068013120335e-01   -1.779531516485119e-01   -4.604743561016144e-01; -5.044699276639278e-01   +1.383746799447358e-01   +4.074710104377723e-01   +1.672948429266087e-01   -1.024473740565956e-01   +8.195778565639286e-02   +3.887672451381552e-01   -4.062841304488850e-01   +1.836716622585882e-01; -2.633582971018448e-01   +4.722530836381417e-02   +5.586787971138585e-01   +4.954777900986811e-01   +5.359031254322144e-01   +1.792701408798638e-01   +7.282640105606386e-02   -4.358757635756389e-01   +5.352027817806252e-01; -1.081671528699529e-01   +5.247603145214563e-01   +5.603901383877622e-01   -6.195052064875606e-03   -5.644590199963605e-02   +9.153351893299982e-02   +6.108456530548639e-01   +1.064605852162687e-02   -2.851498082242476e-01; +1.930047789481703e-01   +6.764256351439324e-02   +2.940843313004911e-01   +6.495229608723416e-02   -4.995519707859033e-01   +3.538384820979926e-02   +1.654063395934013e-01   +4.837326945988042e-01   +6.476880541314374e-01; +4.086817161850786e-01   +3.583866401092080e-01   -2.313567224464168e-01   +7.435916175211732e-01   +1.232918316856182e-01   +2.647669874640526e-01   +5.041446810728767e-01   +3.132077734106764e-02   -1.783058472435025e-01; -4.221461139636332e-01   +3.152528655275166e-01   +9.948680325077386e-02   -6.734054418867552e-02   +4.479458071884063e-01   -4.366255533520452e-01   -2.295569920915952e-01   +2.706362496816025e-02   +2.256751591561369e-01; -2.168220274379193e-02   +1.126942904457559e-01   +2.483912612177270e-01   +1.516051250231215e-01   +3.198488634132912e-01   +1.090580327261535e-01   +1.512816261454156e-01   +2.734491189736060e-01   +5.226344643940067e-01];
L1_L2_iAMPA_netcon = [+7.980616084733085e-02   -3.459269080159774e-01   -3.785698069447626e-01   +6.323963603888705e-02   +3.507961618550725e-01   -2.811916151893359e-01   +1.526852474735516e-01   +2.240024299790970e-01   +4.255213211316467e-01; +6.974112162068767e-02   +2.635102987725406e-01   +4.475169327094608e-02   +4.363651845253962e-02   -1.488439588600903e-01   -2.652867214155334e-01   -1.121286447972913e-01   -4.184615994641646e-02   -2.863583330810324e-01; +3.444680255508927e-01   -4.318860634690080e-01   -3.604811629103472e-01   +2.261169782363615e-01   +2.940139350495096e-01   +5.900265554642403e-01   -6.062317782346742e-01   +1.155020126405307e-02   +3.845214823547041e-01; +1.410324679851737e-01   +5.543844689241850e-03   -6.318239457618266e-02   +1.487280799268276e-01   -1.645482324989348e-01   +2.166933796471477e-01   -2.502388109745310e-01   +1.232449906595121e-01   -3.512356528989663e-02; +2.394842298912625e-01   -1.276937699656996e-01   -4.671506210341943e-01   +2.865188368392479e-01   +3.483044967431044e-01   +4.324192987682990e-01   -5.076662312090982e-02   +3.816039179115083e-02   +4.468037091584596e-01; +1.633395335942608e-02   -6.405312866344673e-02   +2.008866094779197e-01   +9.421953493698464e-02   +9.984373683871034e-02   -1.441803744146614e-01   +3.016217542606039e-01   +3.350198982000832e-01   +2.200715771512397e-02; -3.081034587149233e-01   +2.568529034490813e-01   -1.866071154286567e-01   +7.085758267604106e-02   +2.253607928454543e-01   -1.145466697562155e-01   +2.856800371751865e-01   +4.663019178613768e-01   -7.270986653217913e-03; +3.271593845847676e-02   +1.460729739489657e-01   +1.699486173616213e-01   -2.657058344811166e-01   +2.368442061941224e-01   +5.844898099540470e-01   +1.611647152452477e-01   +4.941049059431246e-01   -1.107213155694134e-01; +5.493936801328079e-01   +4.176253318792456e-01   +1.473696649068015e-01   -4.670717272673358e-02   +5.293757422899661e-02   +1.690253662446959e-01   +3.412352661859382e-01   +4.955285511522370e-02   +6.035283029755579e-01];
L2_L5_iAMPA_netcon = [+3.937312583305219e-01   -4.476662760263578e-01   -4.324137631943087e-02   +1.227856824766410e-01   +2.803015991415619e-01   -1.331742490352834e-01   +3.829112690235565e-01   +2.110664367897926e-01   -5.014365108444019e-02; +4.060812932292255e-01   +1.225868536016052e-01   +2.942650206532642e-01   +5.364488553907818e-01   +2.329061281298994e-01   +3.142277912128106e-01   -5.166990479940062e-02   +1.795969578270606e-01   +3.292478105010321e-01; +5.506578179977639e-01   +1.157782351156125e-01   +5.173886015591684e-01   -3.646523227174229e-01   +9.102046546677380e-01   +6.165030761499288e-02   -1.432628240547230e-01   -4.652853637505898e-01   -7.317013494631691e-02; +1.965654817397101e-01   +6.292810241900771e-01   +5.792424401006961e-01   +1.233538003432780e-01   +2.852132517122161e-01   +2.341298811778122e-01   -3.393082440787629e-01   -1.137438745894317e-01   +3.434342059922646e-01; +2.694635623032017e-01   +4.621040350499932e-01   +3.530077617825008e-01   +3.138510682025059e-02   +4.214197469652151e-02   +3.065308746237410e-01   +4.399715396919468e-02   -7.182728514698744e-02   +7.387048633183676e-01; +1.123728316977206e-01   -1.945949627665594e-02   +9.373215079213473e-01   +2.251197968432200e-01   +5.216430445658928e-01   +1.656451223857175e-01   +9.426986239641788e-01   +3.252811986141213e-02   +1.304664760498376e-01];
L5_L2_iGABA_netcon = [-2.669617439245203e-01   +2.176426181042314e-01   +5.921466266295980e-01   +1.579322461170076e-01   -3.167360722404979e-01   +5.497789326425611e-01; +4.217896141081093e-01   -1.292024929809110e-01   +2.278278636074011e-01   +2.107923381764487e-01   +1.326199060231950e-01   -2.282577831601661e-01; +3.591793125226639e-02   -2.064853184819427e-01   +6.037324363252154e-01   +2.518749723176286e-01   +6.402670532028588e-02   +2.346622021065109e-01; -2.091530805274840e-01   -6.482568832115010e-02   +2.493579178432724e-01   +5.773898725868716e-01   -2.151279081943596e-01   +2.111073527647987e-01; +1.272818772191555e-01   +2.341503533225796e-01   +4.554775490625160e-01   +4.454859493349325e-01   -6.799906548413190e-02   -1.438163415592157e-01; +3.939726184344468e-01   +1.755383703655299e-01   +2.562698242604053e-01   +5.882196470433425e-01   +2.200492740288634e-01   +2.925227386152124e-01; -3.580416949889917e-01   -1.070547058395170e-01   +5.459104259040809e-02   +2.256263531589864e-01   +1.443002536536344e-01   -2.376110612895581e-01; +5.016446426412180e-02   +3.713077776650240e-01   +8.102649316669608e-01   +4.330565775277309e-01   +2.454166733830702e-01   +7.185183186777542e-01; +4.333267456457762e-01   -2.237913222716061e-01   +7.771039446451037e-01   -4.098382900742232e-01   +3.445454856923582e-01   -3.141278858390105e-01];
L3_L2_iAMPA_netcon = [+7.359023497413595e-01   +1.091382146615729e-01   +6.105191834221044e-01   -1.067525475820909e-01   -8.052686216753799e-02   -9.964453185610246e-02; -1.565800530546767e-01   +9.189487537049107e-01   +3.941430624265673e-01   -1.663469219569003e-02   +3.220343908239737e-01   +7.547214299781793e-01; +4.583826982187472e-01   +2.994166257030753e-02   -3.859166929315648e-01   +4.786076381661345e-01   +1.693478585549904e-01   +4.485509472828014e-01; +1.540087884634273e-01   +1.465340986499781e-01   +4.234182438428552e-02   +2.769491168799452e-01   -1.362301178146469e-01   +4.364137953568978e-02; -2.584141909769830e-01   -1.864482225535846e-01   +3.796012505243389e-01   +5.139482184982036e-01   -3.881290193840126e-01   +5.781680824606333e-02; +2.152267085773877e-01   +2.876588235901734e-01   +1.360930248785017e-01   +4.857767686070673e-01   +3.000318099424999e-01   +2.839473286567282e-01; -5.967012541755920e-02   -2.459935515704653e-01   +3.423566529164524e-01   -2.547307801587883e-01   +3.322192590350273e-01   -4.249946958789316e-01; -3.623113268420425e-01   +4.555207188205750e-01   -2.096633385265394e-01   +6.405562485178282e-02   +2.673532307042365e-01   -2.518008220998952e-01; +5.322935634380002e-02   +2.741002819341868e-01   -2.195645182022074e-01   +2.691459184703973e-01   +4.074384004583305e-01   -4.142158458088305e-01];
L2_L3_iGABA_netcon = [+1.419644980434466e-01   -7.717558294161656e-02   +5.821590076220443e-01   +6.366790255917892e-02   -1.864115060271779e-01   +5.112022078431855e-02   +5.740784696985146e-01   +3.807743371163611e-01   -5.126830669750370e-02; -3.145809593635421e-02   +1.543278810812858e-01   +1.485871540652619e-01   +6.430853851142074e-02   +5.025295100792562e-01   +1.843314477047070e-01   +5.303284030717254e-01   +5.292407952477798e-01   -2.855261352218319e-01; +1.676427206933914e-01   +4.665849246124443e-02   -1.163782741663866e-01   +4.410696437548712e-01   -5.344262311988538e-01   +4.714329887767097e-01   -5.375758001292233e-02   -1.287954386880283e-01   +3.766271054227167e-01; +7.366518880217133e-01   +2.487227009579734e-01   -4.538883059654722e-01   +2.461081335269514e-01   +1.393600222972277e-01   +2.249814302068819e-01   +2.917454305939080e-01   +4.094148839623210e-01   -3.582497970992198e-02; +5.956234660534976e-02   +1.823532428746715e-01   -3.960242565381974e-02   -1.432881789275097e-01   -1.118822036153840e-01   +2.365230094172375e-02   -1.839060416117526e-01   -4.957406982310525e-01   -2.329737061535651e-01; +2.420595668469821e-01   +3.484320298784188e-01   +1.665607294971385e-01   -1.707479538622952e-01   -1.535667594163218e-02   +6.624714046865053e-02   +6.113854069219506e-01   +4.258747987523180e-01   +5.328163418585601e-01];
L1_L4_iGABA_netcon = [+4.429676068523519e-01   -2.445058711662343e-01   -2.698485918123427e-01   +7.911039244466822e-01   -1.587547083375978e-01   -6.047268307879899e-02   +3.664994496673800e-01   +3.345393197369514e-01   -2.302869920774390e-01; +2.580066956528680e-01   -4.641462739368869e-02   +3.724753388567482e-01   -2.884961526861662e-01   +3.046437330003169e-01   +4.846119152807846e-01   +3.330653946005707e-01   +2.243770647172077e-01   -4.450757799737313e-01; -1.683904052443823e-01   +5.413379372958358e-01   -7.297680859710842e-01   -2.437412828291539e-01   +4.088702811381775e-01   -4.865186854830099e-02   +2.057584870145427e-01   +3.309470631058381e-03   +1.051879195525433e-01; +8.811867439167824e-02   +2.231323465295519e-01   -1.863256541088567e-01   +4.741048227465926e-01   +3.268137273867521e-01   -1.859111499443877e-01   +3.523164971675628e-02   -1.110644665445159e-01   +1.473616556616826e-01; -9.418677726598576e-02   -5.479640434639024e-02   +3.149014816604219e-01   -1.376841149982960e-01   -9.538120750347727e-02   -1.688688253033191e-01   +5.720106264856545e-01   +2.990593828145879e-01   +5.129344854015658e-02; +3.966250311808777e-01   -1.178969833934809e-01   +2.848117044209397e-01   +2.014314169430864e-02   -2.152414693888638e-01   +5.217555354316307e-01   -2.562105102874405e-01   +6.986035965384668e-01   +3.249388497325825e-01; -1.590488768113505e-01   -1.713673998221949e-01   -4.559009170928836e-01   +1.624848610616382e-01   +4.049292189894588e-01   +1.863801552075409e-02   +3.974260706205108e-01   +3.237295098489446e-01   +2.458390044950882e-01; +1.481646224870212e-01   -1.268830093840645e-01   +3.708933887547359e-01   +5.877379588519224e-01   +3.169391099362692e-01   +5.036002964618175e-01   +2.485869193776336e-02   +4.089313598753435e-01   +3.967109078671318e-01; -2.839072700184678e-01   +1.728031841743533e-01   +4.326934329369602e-01   +2.166549146260504e-01   -1.428539419581670e-02   +1.764158684785478e-01   +2.280558440339892e-01   +3.627378312552397e-01   +1.719602336035005e-01; +3.038202140782446e-01   +5.078742684416464e-01   -8.165538611815959e-02   -1.044609889109736e-01   +3.878217343874028e-01   +1.524997706549422e-01   +2.921851274271404e-02   +1.270083456256251e-01   +5.235642234214244e-02; -2.496381092933320e-02   +1.726881848408947e-01   +2.159153632711586e-02   -4.575809726922149e-02   +2.094775106540641e-01   +4.251410781626749e-02   -4.322342150309128e-01   +3.464475077055566e-01   +2.919464392597237e-01; +4.944418168450205e-01   -1.169377142855178e-01   +1.783751225730112e-02   +4.038631415217804e-01   +4.897774005614171e-01   -2.108809611769617e-01   +2.094952898222703e-01   +2.975383811399618e-02   +1.989385320767819e-01];
L4_L1_iAMPA_netcon = [+4.542321563778298e-01   +3.834991129672581e-01   +2.107794887160607e-01   +5.658494742722318e-02   +9.037921562991930e-02   +2.499077806490776e-01   +5.447110349386696e-01   +3.040136169024676e-02   +2.366294768990070e-01   +1.779189698326323e-01   -3.886922278419407e-01   -5.609764009809805e-02; -9.382385876672486e-02   +1.690070841749534e-02   -2.114796770313412e-02   +1.007798142868119e-01   +7.336455646089164e-01   +3.502939107253304e-01   -3.308126331260221e-01   -9.126115568384351e-02   +3.224578017752391e-01   +7.057259733619827e-01   -9.543372474227992e-02   -7.679023496723690e-02; -1.444398115765262e-01   +4.944775762260178e-01   +5.716214398220301e-01   -1.410288471492398e-01   +1.681536406737763e-02   +2.295852556604099e-01   +4.720560381206781e-01   -1.932029546390178e-01   +2.078957956969914e-01   +4.458000156007133e-01   +2.749307919328725e-01   +7.999702023254165e-01; +3.477316366124893e-01   +3.953275554751491e-01   +3.680295331745508e-01   +5.776210346754211e-01   +7.423352506307754e-02   +5.750097781605049e-02   -2.431782192047112e-01   +7.945103726273521e-01   +2.579881875088639e-01   -1.839306484990242e-01   -3.338631206795672e-03   +1.315014994663093e-01; +5.544494967686269e-01   -1.890354484728712e-01   -4.579687250546424e-01   -1.433475334765859e-01   +3.656280143179046e-01   +1.004984478513349e-01   +4.334116468455924e-01   +4.174497975173017e-01   +4.386624920077209e-02   -1.903636924942559e-02   +6.910853490948810e-02   -1.753017019513477e-01; +4.568322352048028e-01   +7.460586456108617e-02   -2.225669788331095e-01   -1.519981934445641e-01   +3.929964859935670e-01   -3.522943533990264e-02   -2.372023779922844e-01   -2.155215962906266e-01   +5.262869182597993e-01   +6.998914575179205e-01   +2.920965501710839e-01   +1.291264148514535e-01; -2.472805020281784e-01   +1.054284883839413e-01   +4.810143510014454e-01   +4.199915252077935e-01   +4.214726668768776e-02   +1.121085805101404e-01   +2.960687706719146e-01   -2.512607422789440e-02   +3.016472304900794e-01   +3.939939437760820e-01   +3.090068183741309e-01   -3.415557498611363e-01; +5.867055050255547e-01   -5.629807064706283e-02   -2.549220536977109e-01   -2.651634064203862e-01   -2.018671252881809e-01   +9.044070192258839e-02   +2.971815969949396e-01   -1.992163393084103e-01   -2.287397171812758e-01   -2.076304609643041e-01   +3.073823109948106e-01   +2.031015880889381e-01; -9.560902178749391e-02   -1.185200714070031e-01   +2.199336439387952e-01   +1.825893102408463e-01   +1.234234078312329e-01   +1.112633545923538e-01   +3.757925928431416e-01   +2.316559407388688e-01   -3.080654603057460e-01   +2.657752305226175e-01   +3.849339375509735e-01   +1.324369657501012e-01];
L1_L3_iAMPA_netcon = [+5.574112370716268e-02   -2.898563211215620e-01   +2.466586739456555e-01   -6.308443133323377e-04   +2.356365567287257e-01   +1.615878662280084e-01   -4.881470494352409e-01   +3.731803681036845e-01   +1.167883285063904e-01; +5.505142370416592e-01   +1.482003061794330e-01   +3.814506228920090e-01   -1.300834264333370e-01   +9.000045566580961e-02   +1.103666803551871e-01   +1.277228140713909e-01   -2.668969073497371e-01   +2.716071191761947e-01; +4.692061519330154e-01   +2.552500754965005e-01   -9.488821268967398e-02   -2.071488352943931e-01   +1.943705873555117e-01   +2.243519761865011e-01   +3.405256840619938e-01   -1.341674226108683e-02   +1.018800376599633e-01; +4.855123956544299e-01   +7.384143441857192e-02   +2.599745018328040e-01   -1.281669259306708e-01   +1.992918687929615e-01   +2.955336357817763e-01   +2.145705991190912e-01   +4.765773857664468e-02   +2.377079203354778e-01; +1.575308364799751e-01   +4.871626242702657e-01   -1.605326989759014e-01   +4.500826588418578e-01   +1.413557904948341e-01   +3.521487088888489e-01   -4.381658887897156e-01   -3.006926977598183e-01   +5.359146582304326e-01; -1.766381703686550e-01   -2.354979673060115e-03   +4.294690892181902e-01   +3.932263799534895e-01   +9.543554753048840e-02   +4.819516217630319e-01   +5.189497859145520e-01   +2.590144517486920e-01   +2.662643461465205e-01];
L3_L1_iGABA_netcon = [+2.415749158060620e-01   +4.765022991572841e-01   +2.926333519437906e-01   +2.795179161321198e-01   +1.759377915612381e-02   +4.247164344567368e-01; -1.089226197742142e-01   -1.427109636238488e-03   +3.161283749770187e-01   +2.126285447437876e-01   -6.947469101281747e-02   -4.263552549022094e-01; +4.041179969924910e-01   +3.491633751648565e-01   -3.573105190754993e-01   +4.684431524402133e-01   -3.931000004472388e-02   +2.435132024756902e-01; -5.554962401443275e-02   +2.986504233164391e-01   -1.668187298525566e-01   -3.127870861389455e-01   -3.863989636840334e-02   +7.703870816217603e-02; +2.477533362505479e-01   +4.679895196127884e-02   -1.206757806016158e-01   +2.840724045421778e-01   +9.384025194249251e-02   +5.415752128695472e-01; -2.140122736393182e-02   +2.761229551090993e-01   +1.056282970378801e-01   -2.067719597607339e-01   -1.052100254641434e-01   +2.016101797322586e-02; +2.032003174132905e-01   -2.391665910883861e-02   -6.724273679602917e-03   +2.705464083739605e-01   +5.540177988941902e-01   -2.071585353715487e-01; +2.261037021465824e-01   +5.837802693591179e-01   +7.245549667512026e-01   +2.797644231700868e-01   +1.074258030623685e-01   -5.174302524414236e-02; -9.350675611413151e-02   -3.231005265031763e-01   +2.274192463625053e-01   +1.840831071807188e-01   +1.097145777604061e-01   +1.676937930860462e-01];
L5_Input1_iAMPA_netcon = [+2.310967905867272e-01   -3.844621779914182e-01   +1.920742236543045e-01   -1.256916972521398e-01   +4.087714676082713e-02   -1.767988863191380e-02];
L6_Input2_iAMPA_netcon = [+2.234664858181118e-01   +5.206417371273200e-02   +3.590090382419748e-01   +3.173792709571127e-02   -4.296391630377533e-02   +3.574273708464674e-01];
L5_L6_iAMPA_netcon = [+1.847854175563424e-01   -3.238291362203613e-02   +2.946614527908977e-01   -9.144577469519174e-02   +8.195070371654310e-02   +3.663355210431646e-01; +8.697901092875671e-02   +4.605738003985753e-01   +5.025508672420059e-01   +6.116405297799087e-01   +4.328662681279398e-01   +3.516406113838755e-01; +3.778539117097349e-02   +1.916743548407039e-01   -1.351864945834924e-01   +5.381054714027600e-01   +4.022689395755027e-01   +7.978969271073000e-02; +5.624123575186293e-02   +3.844487043845921e-02   +1.763136956863894e-02   +1.560578396192402e-01   +1.488225184592316e-01   -4.222213648003953e-01; +1.633585897683127e-01   -2.272497998588586e-01   +5.761070980281455e-01   -3.467518785518648e-01   -1.360163688186429e-01   +3.545732093050210e-01; +3.503522525771265e-01   -1.020965935230166e-01   +2.829693022315570e-02   +7.868663225407109e-01   +1.412401444372796e-02   +4.177726436288218e-01];
L4_L5_iGABA_netcon = [+2.531079809036881e-01   -2.071371368324998e-01   +2.583416301680589e-01   -6.029334224534255e-02   +4.677446013838709e-01   -3.048305778411015e-01   +5.506520645969056e-02   +4.368547090730938e-01   +5.462313849219607e-02   +1.942425629629987e-01   +5.063567832124409e-01   +1.423129541624497e-01; +3.562853620624144e-01   +3.674503273414914e-01   +2.304111755903716e-01   +1.355149704835110e-01   +9.881816278645619e-02   +6.277132341769476e-01   -3.612851325648275e-01   +7.721596828525754e-02   +3.969066020057986e-01   -3.346539311033646e-01   -8.807431646706119e-02   -2.457495070620462e-01; +2.052320963460343e-01   +4.287906212829659e-01   -9.178425942409675e-02   -1.234720497188617e-01   +1.083996985054750e-01   +3.918904645719256e-01   +3.210746205083927e-01   +3.679319100064956e-01   -6.722742031998949e-02   -1.910965078926892e-01   -9.517646023052878e-02   +3.951794014738148e-02; +5.286806089511444e-01   -1.712600402753945e-01   +3.271811197871595e-01   +3.368821803244099e-01   +2.228479328510082e-01   +1.000000000000000e+00   -4.087856497182566e-01   +2.309786878088129e-01   +2.620381423441319e-01   +6.073973458783495e-03   -1.060863480735185e-02   +4.285146702738271e-01; +1.456944298160286e-01   +3.332655300294708e-01   -1.859113396897267e-01   -2.779182773525820e-01   +1.130828768467201e-01   +4.120422857576481e-01   +2.371019014313630e-01   -2.268270349952177e-01   -3.323003052340175e-02   +6.884673632258763e-01   +2.964541695403239e-01   +3.679130765898299e-01; -4.529977073839443e-01   +5.019290151577807e-01   +3.505921238372351e-01   +1.734657837561882e-01   -2.213839832733554e-01   +4.356660523493296e-02   +6.313473165345163e-02   +2.347772233871467e-01   +4.180911524200060e-01   +4.992395476453922e-02   +5.091960674030735e-01   +9.310927930073447e-02];
L6_L4_iAMPA_netcon = [+5.431794571323719e-01   +5.236407974362968e-01   -1.009007876011669e-01   -2.435998038932708e-01   -2.998263741931942e-02   -2.495925823155536e-01; +2.707439216520269e-02   +2.038317040745382e-01   +2.450431440269888e-01   +6.343373601133810e-01   -2.485778834390732e-01   -2.112094879535479e-01; +2.738526937400758e-01   -8.376894957948446e-02   +2.475411263863600e-02   +1.466009866919704e-01   +1.118451087958171e-01   +9.902759060544269e-02; -1.391921516081435e-02   -2.889515630179127e-01   +3.984841749683240e-01   +3.690328279685250e-01   -2.669780529407414e-01   +3.027261435169092e-01; -5.476758218069662e-01   +1.680268461384974e-01   -2.067754183602926e-01   +6.129801627795877e-01   +5.857019518591178e-01   +2.713423543321041e-01; -1.848309975664867e-01   -2.543374943906413e-01   -2.994676104408077e-01   +3.619536398860963e-02   -3.500491679377826e-01   +5.877954066043928e-02; -3.711734891641232e-01   -4.282998847038022e-01   +1.268205672160336e-02   -1.654140694980365e-01   +4.601957497439642e-01   +1.551709149062125e-01; +5.370169254599819e-01   +3.586149321105583e-01   +1.329574374352117e-01   +2.180221889236593e-01   -3.465529205066438e-01   -3.605973823367925e-02; +1.087890651445872e-02   +3.908668624526828e-01   +1.407856948554291e-01   +3.619389939049991e-01   +3.507452548278577e-01   -3.869986944076453e-02; +3.093431901480089e-01   +3.803215344413214e-01   -2.615449286159952e-01   +3.671699552518441e-01   +3.417701898952703e-01   -2.316325127539301e-01; -3.392848443367092e-01   -1.079884988691965e-01   +6.627051068614644e-01   +2.884522979927329e-02   +3.231649098270909e-01   +6.062927292433613e-01; -6.020946187349720e-02   +5.400268478788217e-02   +5.424995487672460e-01   -1.191478538311783e-01   +2.590595693187865e-01   -2.176428468317376e-01];
L5_L4_iAMPA_netcon = [+2.148807781861325e-01   -2.055193490037907e-01   +1.052167491288525e-01   +1.627889581748110e-01   -1.918403425615620e-01   +2.182746465273777e-03; -1.561900703326821e-01   +1.938255123789047e-01   -1.813601403475052e-01   +4.335084659358306e-01   +1.484521722192121e-01   +3.439838698046792e-01; -1.827511880587501e-02   +2.773220419217253e-01   -9.541760912758954e-02   +2.244629797543591e-01   -1.420658936460171e-01   -2.300444996154656e-01; +4.876082344608567e-01   -3.170296200233627e-01   +3.482386424640779e-02   +2.193550640677378e-01   -4.096483005923246e-01   -1.526715968907414e-01; -1.876023745474643e-01   -2.298715339848880e-01   +6.082449983218683e-01   +3.367804590823506e-01   +2.254988063804818e-01   +1.824442859923492e-01; +2.783208125993986e-02   +5.876399430788289e-02   +1.979462562360477e-01   +1.861011465731911e-01   +1.543130226223368e-01   +3.459547853407456e-02; +1.816617575656491e-01   +1.675981694508398e-01   -1.374886247201878e-01   +4.493136216777443e-01   +5.016096216372627e-01   -2.324284845986775e-01; -1.061818444746615e-02   -3.392203619086362e-02   +2.396195973624356e-01   -3.939175969517839e-01   -1.719551450255442e-01   +2.802818597148463e-01; -3.171960524779681e-01   -4.304084429119538e-01   +1.672091871492274e-01   -3.845924524703184e-03   -1.778053112507473e-01   -4.724618484935645e-01; -2.791604536582291e-02   -2.243267651222085e-01   +1.181569233875923e-01   +4.798951638895687e-01   +5.702741803487273e-02   -7.336878684589995e-02; -1.537660161527266e-01   +7.551508931567621e-01   +3.721519478190510e-01   +5.452973622624582e-01   -3.180371463130000e-01   +2.439802870608540e-01; +2.354340449454294e-01   +4.924288880699560e-01   +6.837150768587361e-01   -1.514404462069004e-02   +2.918096521033752e-01   +1.817358502791113e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
