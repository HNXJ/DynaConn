function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.728232404309329e-02   +1.806656155124748e-01   -3.465978076005061e-01   -4.002253968992341e-02   +1.483835054714453e-01   +1.613073726075173e-01   -2.071103070244408e-01   +1.001483692162464e-01   -1.899464629831328e-01; +5.421450451663729e-01   +2.391050464940651e-01   -4.434892255271138e-01   -8.156510584357721e-02   +2.951294318713950e-01   -2.517979103739781e-01   -1.600370239893827e-01   -7.933183735755145e-02   -6.706020099382958e-01; +2.287459588875227e-01   +2.963740811290863e-01   -2.036133459246650e-01   -1.246311048060476e-01   -3.043682044724377e-01   -5.995366477681727e-02   +2.755307429681278e-01   -3.408618102680379e-01   +1.946140791392713e-01; -2.001983316589697e-01   -2.736882646355775e-01   -2.073665829384321e-01   -1.592980350355274e-01   -2.818789149935795e-01   -4.032658910928003e-01   +3.342701623874584e-01   -1.586404189644543e-01   -5.678383272331167e-02; -2.105375392145959e-01   +2.248367671475780e-02   -1.586046303583730e-01   -7.010426806515077e-02   -4.680501330954880e-01   +1.735330689909320e-01   +3.129317360545000e-01   +4.630014547075962e-01   +1.113218158331424e-01; -1.125326337102366e-01   -1.045872014090234e-01   -1.926256188306634e-02   +1.286015030542647e-01   -1.416433051242439e-01   -6.501558107466594e-02   -6.140361019596821e-02   +1.538046346259544e-02   +1.959384533102391e-01; +4.228792657080205e-01   +2.464873927986157e-01   +3.016492956384262e-01   +2.112839494875479e-01   +2.100662925321134e-01   +1.650802165894217e-01   -6.491559090207135e-01   +1.261645969746483e-01   -7.122527078523569e-02; -8.674754841614468e-02   +2.218358174160863e-04   +8.377304952591494e-02   +8.105249442346187e-02   -3.934911106986307e-02   -1.920946930206682e-01   +2.573144147883923e-01   +2.789299305551782e-01   -6.572776404637319e-02; +1.346588051235867e-01   -2.541378732585411e-01   +5.292282194772542e-02   -2.467928760233596e-01   -3.104798953846023e-01   +2.555052590782156e-01   +5.208878792151852e-01   -2.594766950497195e-01   -3.159493370698859e-01];
L1_L2_iAMPA_netcon = [-6.723720597618115e-01   +2.333298277380560e-01   -4.756976425710868e-01   +5.270102426089067e-01   -3.937201308470089e-01   -2.381470140297382e-01   -1.117479644031467e-01   +2.973825947277123e-01   -3.195264283937311e-01; -2.566731110098561e-01   +1.029962238861873e-01   +1.481053080310553e-01   +2.922218060741155e-01   +1.360312905272710e-01   +1.570866223862167e-01   +2.094829666026868e-01   -3.685458908614807e-01   -4.761923800052693e-02; -7.614297700590845e-02   -3.167207649537092e-01   +2.292033052663827e-01   +2.697332861575178e-01   +4.972248057299576e-02   +2.504974910710147e-01   +2.768534138310239e-01   -5.059309750397112e-01   -2.758608884235042e-01; -3.924581042507045e-01   +4.030003645709013e-01   +1.584020827868103e-01   +1.412695752090129e-01   +8.543783305267483e-02   +9.460352380595932e-02   -1.955746845208786e-01   +4.130724681977850e-01   -9.399326360745999e-02; -9.886328103314607e-03   +3.491130704506212e-02   +1.465282888793379e-01   +2.674407998422655e-02   -1.384722649245347e-01   -4.859710942435980e-01   -1.237449829111691e-01   +5.755849673799170e-02   +2.489228571683210e-01; +3.839812825564126e-01   -4.258369094776673e-01   -3.451280842590898e-02   -1.290342300288964e-01   -2.871419089266440e-01   +2.723644665016410e-01   +7.348749612655825e-02   +1.557424026113975e-01   -3.586847399575354e-02; -3.010539278748403e-03   +3.721923421474295e-01   -4.370888595537640e-01   -1.114851142984411e-01   -3.225567080617397e-02   -2.342081224044330e-01   +3.307575487708415e-01   -1.420669579483189e-01   +5.059120975475959e-01; -3.634437406180287e-01   +6.623286678112215e-02   +9.401840747300538e-02   -5.371450571792106e-01   +9.563364065476779e-02   +1.646346774808977e-01   -5.898514816078857e-01   +5.560206152291103e-02   +6.915222019133249e-03; +3.694312349074790e-01   -2.169404958798018e-01   -8.130195579789187e-02   +7.889669815662810e-03   -2.101774567378248e-01   +7.433863333151411e-02   +2.408108728769534e-01   +2.721649872948791e-01   -2.913276013209581e-01];
L2_L5_iAMPA_netcon = [+3.748655158702921e-02   -2.186788547802017e-01   +1.165503688530366e-01   +1.809534177645635e-01   +3.011755513306192e-01   -2.698587118859695e-01   -3.653920740573788e-02   -2.103637957006346e-01   +5.093500467685751e-01; -5.177284341035173e-01   -2.318429858130773e-01   +4.587870079479709e-01   +6.336525686185484e-01   +2.361867636045109e-02   -3.375627551263224e-02   -2.903139789430160e-01   +5.836830256717895e-01   +2.591094539361955e-01; +4.670737111599902e-01   +1.171758079330198e-02   +2.804248912009966e-01   -5.016400954931076e-02   -5.630929876145008e-02   -3.180006859123415e-02   +6.055357800408664e-02   +1.401094321948732e-02   +3.230407144117996e-01; -7.201700018445831e-02   -1.872578072895124e-01   -3.979578052066199e-02   +1.972767169565245e-01   +2.836713434641487e-01   -2.608836063141585e-01   -2.670152658695197e-01   -1.546903914238604e-01   +1.505333916005839e-01; -6.424783627350010e-02   +4.302164808254536e-02   -2.711905294679469e-01   -5.272008380886338e-02   +3.206871432618555e-01   +1.954020720044229e-01   +3.994501208708742e-01   +1.013139877998338e-01   +7.492809200503345e-02; -1.178585403880235e-01   -6.841733896538817e-02   +1.337960893972073e-01   +2.269393453579257e-01   +2.717416025166488e-01   +3.012438368760283e-01   -2.369753595461412e-01   -8.043186840242353e-02   +3.367583196865445e-02];
L5_L2_iGABA_netcon = [+5.340699126172378e-02   -2.311186324946549e-01   -3.737284487972103e-01   -1.355643514718815e-01   -5.231252561124607e-02   +1.066623759035330e-01; +6.752635638032822e-02   +1.265236455447856e-01   +5.661961122316805e-01   +2.223494615279962e-01   +1.813051223148393e-01   -2.267691090029027e-01; +1.849075877089576e-01   +1.679101051350955e-02   +7.363800353798117e-02   +1.876393360942149e-01   -1.194758362255872e-01   +1.312702493669748e-01; +4.495647612677192e-02   +1.312073874089511e-01   -4.281328217571014e-01   -2.117304946447371e-01   +3.694058040889036e-01   +1.759210506957507e-01; +9.676983495033376e-03   -1.079565653303485e-01   -8.716876642699584e-02   +2.686090187488868e-01   -4.025723440945155e-01   +9.448556151092082e-02; -2.773706819814314e-01   -3.429551483705453e-01   +1.511662147723030e-01   +1.249708031717460e-01   -2.572763347415893e-03   -3.035511716468514e-03; +1.559516915492936e-01   +1.191908686255430e-02   +2.842174482148421e-01   +5.443683231288633e-02   +1.874972645639514e-01   +7.697521804138471e-01; +9.885275459818860e-02   -3.417767757843960e-01   +2.101782136560255e-01   +8.410009966792352e-02   +7.782929597327870e-02   -1.272857070239312e-01; +2.966113563865223e-01   -1.849725968282530e-01   +3.108872840231713e-02   +2.558675056165548e-02   +6.001882298163278e-02   +5.210227916801514e-01];
L3_L2_iAMPA_netcon = [+2.239808831464958e-01   +8.432535077111200e-02   +2.817935351231906e-01   +1.878145298904895e-01   +3.952301294232577e-02   -3.085907177004382e-03; -2.584964789256419e-01   +1.435050959196680e-01   -2.746397998673851e-01   +5.519257262957288e-02   +2.895566219461133e-01   -3.919231037124181e-02; -3.125096921725159e-01   +3.781528814607731e-01   -3.253483999219957e-01   -3.037674933623317e-01   +9.414469646213248e-02   -1.944874052001968e-01; +5.570581477993493e-01   -2.836802914372136e-01   -1.295111391453586e-01   -1.626603317493826e-01   -6.590161168311140e-02   -1.619118367105129e-01; +2.257404244469347e-01   +2.850482101944283e-01   -1.141370457570325e-01   +3.091886495251219e-01   -2.552123507931202e-01   -1.940220556003641e-01; +2.102901433703165e-01   -3.384720862147755e-02   +8.147862702176967e-02   -5.661791052798403e-02   +1.866343519361029e-01   +4.336309939577170e-02; +1.432425502790135e-01   +4.281306433595913e-01   +2.768307395902793e-01   -2.297497141517510e-01   -1.616390928154616e-01   -6.702432123291560e-02; +3.771241665888242e-02   -4.342483941013829e-01   +4.232962094444130e-01   -2.572504466169159e-01   -2.099626341158671e-01   +1.247274608452673e-02; +1.095480737048135e-01   +9.381462037543112e-02   -3.526324304212868e-01   -3.808038336724099e-01   -1.865508644304293e-01   +2.755302558372903e-01];
L2_L3_iGABA_netcon = [+3.529097145238319e-01   +1.632670465021782e-01   -2.308186345964932e-01   -1.310936198987128e-01   -2.263603761916680e-01   +2.779822463272323e-01   -1.247092517977892e-02   -1.241695492995236e-01   -1.197979869162832e-01; -2.002155986660309e-01   +1.401717888505288e-01   +8.054498535878435e-02   +3.132804100719616e-01   -1.002040224525882e-01   +2.953730108480310e-02   +9.180663234631195e-03   -4.945969828679442e-01   +5.440218318800702e-02; +5.668597916104439e-01   +1.694081289556947e-01   +4.220469614959205e-02   +9.568415331656921e-02   +4.004487099890544e-01   -2.959508758213564e-01   +3.565579348968387e-02   +1.365603743702394e-01   -2.626679908181452e-01; +2.237498661434863e-02   +1.381462735775322e-01   -1.879490258227336e-01   -7.872338477086596e-02   -2.600000989588120e-01   -8.655200251029416e-02   -9.448885481470212e-02   +1.690097529570355e-01   +1.731443686285526e-01; -6.278472966516355e-02   -2.834114326068337e-01   +4.168238043552349e-01   +2.633793848499818e-01   -3.614293642509515e-01   +4.665908125749807e-02   +2.447679870816103e-01   +3.251668402569170e-01   -1.397740451470332e-01; -6.616866820040380e-02   +5.800736997712725e-01   +2.905083239870929e-01   -2.598682970737954e-01   -4.479244917860454e-01   -3.619421881467573e-01   -4.219979460794867e-01   +2.267971719192775e-01   -1.459536930841632e-01];
L1_L4_iGABA_netcon = [-6.182950408703145e-01   +4.280062003233044e-01   -3.320092468662448e-01   -2.042529575770902e-01   +9.288819813232366e-02   +6.679974473571543e-01   +4.029191079353646e-01   +3.130979262754979e-01   +2.704466298690020e-01; +2.254649673001932e-01   +1.301718195213801e-01   -2.233532694290424e-01   -3.433525593694690e-01   -1.650650601775054e-01   +3.578051944291183e-01   +1.869472137744835e-02   +4.202409006853875e-01   -3.068262273342797e-01; +1.728295468961583e-01   +7.804170556412207e-02   +1.671305086810882e-01   -7.980292478737763e-02   -2.678835959541008e-01   +1.346735961785739e-01   -2.575269712174176e-01   +2.725371824522537e-01   -1.570299987914663e-01; +1.408852845429246e-01   +3.658968149699338e-01   -2.530793284082333e-02   +2.869944135590893e-01   -2.573952122539552e-01   +6.925591470739922e-02   +1.008927507146595e-01   -1.685460654717280e-01   -9.605411595793883e-02; -4.431237618107259e-02   +5.606841395128334e-02   +1.810273965256752e-01   -5.041377722820085e-01   -2.906322092056739e-01   +2.112414423928735e-01   +3.336401672278224e-01   +4.532605165931420e-01   -1.096630567880151e-01; -2.965222229337839e-01   -2.216987362333112e-03   +2.399682092177381e-01   -6.014642277179068e-01   +4.275832403911833e-01   +1.436061250425413e-01   -1.380191901022688e-01   +2.771368414156373e-01   -1.786261613193015e-01; -1.383047787127438e-01   -2.771644409534873e-01   -2.227661082338902e-01   +1.244081644470456e-01   +6.022120174695484e-01   -2.582944850823611e-01   +4.579941603839503e-01   +5.800180346966817e-02   -4.097327171173230e-01; +6.404358259413678e-02   +2.666163309068463e-01   +3.000036711500915e-01   -2.972774095623547e-01   -2.430060874628770e-02   +1.920235538431156e-01   +2.458713378794328e-01   -1.396764327588275e-01   -1.097451575576736e-01; +1.565983045780492e-01   -1.525018164758951e-02   -2.298913464866019e-01   -1.316910965847618e-01   +8.045384121072842e-02   -1.433794094124724e-01   +1.617880913275652e-01   -1.778161544833020e-01   -1.126766602093060e-02; -1.231596321945950e-01   -3.563081251789056e-01   -2.939725068033545e-01   +4.187113696507580e-03   +1.161417311168506e-01   +4.706386760617320e-01   +3.742672626474237e-01   -3.130317217687587e-01   +9.892157863799210e-02; -9.531560929881160e-02   +2.978566870221647e-01   +4.194447342134672e-01   -5.206059606306871e-01   +3.011059190651525e-01   +2.362430243354264e-01   +6.231629661364194e-01   +3.143448194667856e-01   +2.792882538014788e-01; -2.463593992874764e-01   -6.529890077606149e-02   -2.155078182225451e-01   +1.821601572154216e-01   +1.198399043076321e-01   +6.500345225170095e-03   -5.570519820529495e-01   -4.555005685337948e-01   -3.650427776555137e-02];
L4_L1_iAMPA_netcon = [-2.136484389865853e-01   +1.702264275120825e-02   -5.969135985071801e-02   +3.109570425660313e-01   +3.472057999034020e-02   +1.791818761107378e-01   -1.764774759460961e-01   +3.589715189906040e-02   +1.972292533074263e-01   -7.483780141354646e-02   -2.212317160988722e-01   +7.033974375782703e-02; +5.139878133525282e-01   -2.050884665330187e-01   -2.728416513337707e-02   -2.608729165062548e-01   +1.729269355495092e-01   +4.363331173218301e-01   +3.804180813999525e-02   +4.066007922906990e-02   -4.594404870363810e-01   +1.910877052751287e-01   +4.222844105337238e-02   +6.592045849226916e-02; +7.673251123948110e-02   +1.424120130634333e-01   +1.568160955782355e-01   +2.922123710713551e-02   +2.071515594836235e-01   +1.976181403456522e-01   -3.617514082903353e-03   -4.278072685431984e-01   -4.048383505373837e-01   -8.599832840965035e-02   +3.706753016023074e-01   +2.751990328260934e-02; -2.465350716209323e-01   -7.848824766108214e-02   +5.718872934798014e-01   +7.283130453385869e-01   -3.240156098001388e-01   +2.878867980567420e-01   +1.042140416854942e-01   -2.082364315960983e-01   +2.017439132444942e-01   +2.553677530328309e-01   +1.708711481751144e-01   +1.123086178268162e-01; -1.493774304739088e-01   +2.018026450446010e-01   +1.444460184891194e-01   +3.810840414205162e-01   -3.893114790119228e-01   -3.232095991561090e-01   -2.192629493384926e-01   -5.476529418855240e-01   -1.803004813597462e-01   -1.712238485676135e-01   +3.995027643245325e-02   -2.433806109623422e-01; -2.608153137759679e-02   -2.256199685586668e-01   -3.346228808402553e-01   -8.432704579812739e-03   +6.753875592102453e-02   -9.354818249488395e-02   -2.259510111751007e-01   -4.149780630161111e-01   +1.305946244703284e-01   +2.625672614687838e-01   +2.300631939474917e-01   -1.475649832117091e-01; -2.516666869995916e-02   +5.539943722173576e-02   -1.762523562138589e-01   -1.660882912106266e-01   +2.960959801115627e-01   -2.752743980410107e-01   +3.644177220509048e-01   +5.815265037220958e-01   -3.163510390643471e-01   +1.828337070597960e-01   +3.036796290578148e-01   +2.892303266774018e-01; -1.806637146536041e-01   +2.871470611400582e-01   -2.935769848610689e-01   -1.666697191304213e-01   -5.934892530549096e-02   +8.701056544966890e-04   +3.382403229285902e-02   +3.633258630295022e-02   -2.720689359326220e-01   -4.001232834873230e-01   +1.538376961456929e-01   -1.279955315655077e-01; +2.122543469626146e-01   +5.539117374715910e-02   -5.464501576891115e-02   +2.499522673295964e-01   +2.140568033606852e-01   +3.195819431399538e-02   +1.004652364598501e-01   +1.681198253112231e-01   +2.114538079590041e-01   +3.844326712920954e-03   -8.417057957710372e-02   +2.335556550730608e-01];
L1_L3_iAMPA_netcon = [-2.228746239082421e-01   +1.085107816439619e-02   -2.702482721612090e-02   -7.904813933401329e-02   -1.212612252214776e-01   -5.737320364969420e-01   +1.078591698936870e-01   -3.910925505087755e-02   +6.235579733212528e-01; -4.775236477260070e-01   +2.018495537430623e-01   +4.440061176478168e-01   -3.723738617564989e-02   +1.576586598107536e-01   +1.261626511182349e-01   -7.546409144720831e-02   -1.588877822946346e-01   +1.645678251350943e-01; -7.768941158571005e-03   +7.396754303823944e-03   -3.858976191114164e-01   -1.271103766111179e-01   +3.419045316897834e-01   -1.016445413889060e-01   +5.404458664046489e-01   +3.096996617213399e-01   -1.761081700025189e-01; +3.734330605746777e-02   +3.116031669363375e-01   +2.043234887565576e-01   +2.390389559107065e-01   +1.264443713728415e-01   -2.453667576001350e-01   +2.829686012987409e-01   +1.751818860572080e-01   -5.649383149412290e-02; +7.294672639485668e-01   +2.480054775392075e-02   -1.225929279101007e-01   -5.015714552910625e-01   +2.492602333671713e-01   -3.517348064632449e-02   -1.125534904697000e-01   +1.681196356965620e-01   +5.569952496583422e-01; -4.720592311658892e-01   +8.839341520737609e-02   -1.116379715117904e-01   -2.365890738893409e-01   +4.080677696840892e-01   -6.646615042486413e-02   +5.609562298543299e-01   +3.603346734105002e-01   -2.135173211285854e-04];
L3_L1_iGABA_netcon = [-1.823826965388507e-01   -1.481150869102267e-01   -2.156011405911920e-01   +6.973903449963187e-02   -1.276201315962625e-01   +2.903151735011977e-01; +1.664232533771013e-01   -4.204102033509297e-01   -4.002608344622981e-02   +3.388511737489284e-01   -8.122287039560815e-02   -4.535727771886787e-02; -3.649132046755492e-01   +3.913871513405993e-02   -3.494982866035312e-01   -5.473640110052901e-01   +2.710572434217230e-02   +1.173228144373787e-01; +2.140165307763229e-01   -2.889082675715489e-01   -5.636097921371628e-01   -2.870412196459114e-01   +2.646256695096388e-01   -3.751101895765254e-02; +1.553456316638484e-01   -1.369944633091419e-01   +1.570666246882687e-01   +3.157658481966957e-01   +4.037850943342390e-02   -1.818324402397165e-01; +3.577055836525609e-01   -4.984656067210491e-01   +3.843483660837277e-02   +5.244614842639074e-02   +5.654564096985540e-01   -1.363798339580107e-01; -2.349872885777961e-01   +3.561628873213866e-01   -7.195657784228264e-02   -4.654735651199407e-02   -4.184331516579263e-02   -6.069192461810353e-02; -8.260949489586218e-02   -5.956738655674859e-02   -1.719374154817596e-01   -1.016810960436711e-01   +4.844817053627120e-01   -6.538002140062495e-02; +1.947778295646193e-01   -1.495794406895977e-01   +5.955987858112421e-02   -2.033212121667342e-01   -1.748165975344537e-01   +2.149252115570904e-03];
L5_Input1_iAMPA_netcon = [-5.462205908777615e-01   -2.840010665427139e-01   -2.436915206267082e-01   +2.960733241559808e-01   -2.119494456834545e-01   -5.477480926075408e-01];
L6_Input2_iAMPA_netcon = [+1.137527491768230e-01   -6.837682445397744e-02   +9.503851618869426e-02   -1.193929634702707e-01   +2.410745450784089e-01   +1.358200210389775e-01];
L5_L6_iAMPA_netcon = [+1.803794103945894e-01   -1.222557546188075e-01   -3.945701890541120e-01   +1.705160940490422e-01   -1.002022330650637e-02   -5.527814586639620e-01; +8.459592623012074e-03   +2.766303399138852e-02   +5.772964947631467e-02   +4.233722296485296e-02   +1.335261685826463e-01   -1.487543056146146e-01; -1.878288738313982e-01   +6.132488016022748e-02   +1.281685021325535e-02   +1.581305925416163e-01   -2.084007053171866e-02   -5.498614459683972e-02; +7.370302579730559e-02   -1.002657600617548e-01   -4.392456662413938e-01   -7.257457502152562e-01   -2.008799196327966e-01   +2.923679808007978e-01; +2.702570154216027e-01   +1.664307992131261e-01   +2.414821808668005e-01   +8.336863861901420e-02   -3.350552930165024e-01   +2.039672947723539e-01; -1.787916674978331e-01   -1.671944924754295e-01   +6.227464737706644e-02   -1.051062579379236e-01   +5.843635469724666e-02   -7.722236264436344e-02];
L4_L5_iGABA_netcon = [+6.169249063230553e-02   +4.341080701981632e-01   +3.879021656932528e-01   +4.344551290953930e-01   +6.887859612060497e-02   -4.390155569999662e-02   -1.645967427926782e-01   +1.255825092829751e-01   -3.360671012536622e-01   +5.244308253206447e-01   +1.329724848559143e-01   -3.837682200336969e-01; -1.901060653930995e-01   +1.963411293259740e-02   +4.779822065149375e-01   +2.742210213434123e-01   -2.850179301446654e-02   +2.119592081839135e-02   +4.017992063818189e-01   +3.650831276436194e-01   +9.446147885301419e-02   -2.698047501036342e-02   +1.250595023703411e-01   +3.285355884873437e-01; -6.406606016170346e-01   -2.031266167838680e-01   +2.175873565399392e-02   -5.512141302701852e-01   +2.847612581668684e-01   +1.278768714266666e-01   -7.946743066831770e-02   -1.915588562678644e-01   -5.463600259655104e-01   +3.451723749418057e-01   -1.613866650154224e-01   +3.248481748809286e-01; +1.384687323139588e-01   +4.024094104890178e-01   -3.920750538591221e-01   +2.482653638917569e-01   +5.150552486499668e-01   +3.499680733639873e-02   +2.017031321627213e-01   +1.881397622475347e-01   +7.781591508883494e-02   +2.074643308822164e-01   +2.420317221666561e-01   +4.375665414906370e-01; +2.491166700697883e-01   +2.162285436496031e-01   -3.846387164093754e-01   +1.054134491096488e-01   -2.663984780813957e-01   -6.388447120363629e-02   +1.628857707498753e-01   -3.929105081737308e-01   +3.148370855344204e-01   -2.273430259160880e-01   +4.183559861223918e-01   -4.417552928848328e-02; -1.220586361301622e-01   +8.604323266189019e-02   -3.112049563784453e-01   +5.517411141857109e-02   +3.065655082221693e-01   +7.092073156916845e-03   +1.536988435471315e-02   +2.818371442386834e-01   +1.175293112803251e-01   +5.183221307181321e-02   +7.010475971593209e-02   +1.918902783940907e-01];
L6_L4_iAMPA_netcon = [+2.504393867903334e-01   -5.167997905088018e-01   -3.388255570227379e-01   -3.317337827483585e-01   +8.241755553124388e-01   -8.758144133829271e-02; +1.720934565396759e-02   -4.059081071562515e-01   +9.712451333929421e-02   -2.098718687786780e-01   -2.074614790582425e-01   +2.285863740215185e-01; -1.164599817832078e-01   -5.722139652786198e-01   +1.291975666585794e-01   -1.430617981637187e-01   +7.328656783319498e-02   -5.114897361252709e-02; +1.299043455145125e-01   -2.204056214382151e-01   -3.767774101525516e-01   -2.850177557543560e-01   -1.706580816231785e-02   +3.703172844031656e-01; -3.277420749560598e-01   +2.437042734658778e-01   +1.109955786422228e-01   +4.364556877476708e-03   +1.102617115728085e-01   +2.748582100562467e-01; +2.036101293975519e-01   +3.553700401552195e-01   +3.359238091900141e-01   -8.637925601886245e-02   +7.419102328249016e-02   -1.960668328079456e-01; +1.587497601846894e-01   +3.397931979111261e-01   -3.289494620567179e-01   -4.976550832425169e-02   -1.380697611317763e-01   +2.965202540848688e-01; +4.658063948656485e-02   -1.293869194298527e-01   +5.348247972571571e-01   +3.000404693060429e-01   -2.232046534839704e-01   +2.820315164118584e-02; +1.002286936782615e-02   -1.054214817677923e-01   -2.146279119424127e-01   -1.201940890553030e-01   +8.778414928277793e-04   +8.613246269784273e-02; +4.776079127249748e-01   +1.568650882631690e-01   -5.564150793409103e-02   -6.433497156138243e-01   +4.559500937620928e-01   -3.729143487774970e-01; +3.259547679856912e-01   -2.681764117984766e-01   +1.750186068270575e-01   -2.110942562328533e-01   -1.190265826131015e-01   -1.637830959369893e-02; +1.654307526934909e-01   -1.840828257098394e-01   +7.363516288935330e-02   -2.976486523688607e-01   -7.402230315540692e-02   +2.563055638575058e-01];
L5_L4_iAMPA_netcon = [-4.183401493658844e-01   -4.826883656867870e-01   +2.727498985908512e-01   -2.595559433696676e-01   -7.442183938374974e-02   +1.775773107899995e-01; +6.914031520532343e-02   -2.199477591869812e-01   +4.140557053433976e-01   +1.806813208211543e-01   +1.538703288381744e-01   -4.490511186645971e-02; +1.192988708457561e-01   +4.737500748706073e-01   +2.859007585890314e-02   -7.570647447293166e-02   -9.507202403081932e-02   +3.792448287512048e-01; -4.732346853039474e-01   -3.398007683200746e-01   -6.915760198395404e-03   +6.692148081000721e-02   -2.025023848129608e-01   +4.589028456951838e-02; +1.337972972928550e-01   +5.348011299696338e-01   +3.627217270919570e-01   -1.502223898725922e-01   +9.679022158564421e-02   -3.981118627913627e-01; -2.907058875242286e-02   +9.055469412195072e-02   -1.851488223868112e-01   -1.005929658506148e-01   +2.712744607481212e-01   -1.272093030465015e-01; -1.732443926083102e-01   -1.242310527652580e-01   -2.703828604148293e-01   -1.374929173739383e-01   +3.514793091319732e-01   +1.850052015966593e-01; -1.382259537942069e-01   +4.564817273952744e-01   +3.386546669850762e-02   +2.160996416958753e-01   +8.999132320414738e-02   +3.388628352576692e-01; +1.285143821277338e-01   -5.709767841553337e-02   +1.950614570993761e-01   +1.423683521313077e-01   +4.033088300253188e-03   +2.366909652171527e-01; +1.369828125242509e-01   +4.986229111050347e-01   -3.886655938602354e-01   +1.687674650298023e-01   -4.138496735815032e-01   -3.847985752423873e-01; -3.774282273767592e-02   -1.817579938810056e-01   +4.211066616057634e-01   +3.376809187052348e-01   -1.795705893586791e-01   -2.355344314353876e-01; +2.508184796321671e-01   -3.704881387514660e-01   +4.069929639871261e-02   +1.323661268452445e-01   -1.226113844132305e-01   -5.915106523022028e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
