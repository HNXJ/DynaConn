function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.642820975118742e-01   -1.453679590379484e-01   -4.014547188733719e-01   -2.740935180585435e-01   +1.868914237439828e-01   +1.593087425008982e-01   +6.028083327641929e-01   -5.981189996847419e-01   +3.290575276968649e-01; -2.714912003763373e-01   +1.046437825253875e-01   -2.060240813749869e-01   +5.446062923485577e-01   -6.118941276432804e-01   +3.164598138705895e-01   +6.349798271961604e-02   -4.627234701478104e-02   -2.842573482077693e-01; -5.481220479612567e-02   +2.381471738052895e-02   +1.949472963716218e-01   +1.411108772251035e-02   -1.060092607896725e-01   +9.356131767485816e-02   +2.579983026926218e-02   -5.586145592356642e-01   -3.564597220602254e-02; +1.000000000000000e+00   -5.669713444784156e-01   +1.802152493714670e-01   -2.170748692951749e-01   -4.392870335985571e-01   -2.128002812114338e-01   +2.258416962382492e-01   -1.865083703595944e-01   -6.968532505691761e-01; +1.137752173651489e-01   +4.431015393619325e-02   +5.456350977421426e-01   +7.800743079047580e-02   -2.214358057448444e-01   +4.579051741646361e-01   -2.823844376210775e-01   -5.579726023315842e-01   +2.765751034154454e-01; +2.844400449508039e-01   +1.369707660211173e-02   +3.840654790661317e-02   +3.415092705325250e-01   +3.990393974044668e-01   -2.322861709745927e-01   +8.538224432545864e-03   -2.813860810124391e-01   -4.875784294091185e-02; +3.722402393711254e-01   -4.165149414692038e-01   -3.963191523304888e-01   +4.485348151486622e-01   +1.954784485670387e-01   +1.593213123002834e-01   +3.433704056113949e-01   +3.642500158841372e-01   -5.157044789624059e-01; -2.197545935175068e-01   +6.341351606679808e-01   -5.947646564103913e-01   -6.087275517933496e-01   +4.056200637912669e-02   -3.732548866160433e-01   -5.030358344070773e-01   -1.841151328162670e-01   -3.696475851959382e-01; -5.573644918187404e-03   -7.505420853369359e-03   -2.761107945532782e-01   +2.125748748016539e-01   +1.273327574797225e-03   +1.724127888488963e-01   +8.052168812328430e-01   +1.683138864832892e-01   +2.408705097072520e-01];
L1_L2_iAMPA_netcon = [-1.955841683375452e-01   +2.908969009414775e-01   -1.223468696197394e-01   +3.171749272870126e-01   +5.497797195779154e-01   +4.377075393510372e-01   -6.400064089719361e-01   -1.952713102137780e-01   +4.304695239438342e-01; -1.877456216587290e-01   +2.536634486209535e-01   -4.681529168443502e-01   +5.554223316380446e-01   +2.988717118254741e-02   -1.583222392892448e-01   -2.489330224852371e-03   -8.732941923954674e-02   -2.183572464453269e-01; -2.863790048625238e-01   -3.857822989123216e-01   +1.826099916330162e-01   +3.037962906561003e-01   -7.864707304380174e-01   -2.735618399059843e-01   +8.922486700200387e-01   +1.290187372310566e-01   +2.843767889286000e-01; +5.154690908272044e-01   +6.771728786905512e-01   +2.782603643542237e-01   -7.354259575919894e-01   +2.967194742908126e-01   -8.362084868692923e-02   +8.570129323835314e-01   +3.264976671331753e-01   +2.885451431661125e-01; +7.350124910566980e-01   +1.187798728566052e-01   +2.703647472741940e-01   +4.662131656587818e-01   +2.107182245200625e-01   +5.587665764051605e-02   -3.803686352001284e-01   -5.042535131812009e-01   +4.741611606595397e-02; -5.136898260250492e-01   +1.307442954440129e-01   -1.577176194750732e-01   +1.186664656116488e-01   -2.380179270458098e-01   -3.418001638344915e-01   +8.029582331670396e-01   -2.918182204746534e-01   +4.412963233258025e-01; +8.956661265061355e-01   -5.127025380779895e-01   +4.430068481470753e-01   -2.646028538648590e-01   +5.157571023734677e-01   -7.407223991082515e-02   -5.572659108787580e-01   +3.747759538765029e-01   +7.183573022221392e-01; +4.378083987062197e-01   +2.832565106024160e-01   -3.082093668903844e-01   +3.666130571924473e-01   +6.315395099986280e-02   +1.206011438714000e-01   +2.837482813722182e-01   -1.706030860745405e-01   +1.164850746513505e-01; +2.339169894854091e-01   +5.437709696209654e-01   +2.540457607676218e-01   +2.342790276336196e-01   -4.853903470746973e-02   -1.064717671820973e-01   +2.773841777222325e-02   -5.556348199538552e-01   -6.698512534832141e-03];
L2_L5_iAMPA_netcon = [+1.000000000000000e+00   +5.684424399176195e-02   -4.815962939082270e-01   +6.667896637883860e-01   -1.585691239799945e-01   +8.545837764456234e-02   -4.296328888823184e-02   -5.607658234750343e-01   -2.355454315373457e-01; +2.589196302874217e-02   -3.497202793730270e-01   -7.123254775501904e-02   +1.933503713834779e-01   +3.030669696582210e-01   +1.741527005664096e-01   +3.012772108395056e-01   -2.814893095776394e-01   +5.666940245595574e-01; +1.193871341959118e-01   -7.432038692588557e-01   -1.941870048194511e-01   +8.050947710220230e-01   +1.434131516597854e-02   +1.744062856963758e-01   +3.437112018287086e-01   -1.886820467770181e-01   +6.383544976211754e-01; -2.253728564384261e-01   -8.142854697465704e-02   +7.099845028390191e-02   -4.780144061451274e-01   +1.773164314788750e-01   +5.656937183216019e-01   -2.893500589825052e-01   +1.829405212750301e-01   -3.345235724348074e-02; -4.363084067031947e-01   +3.506959106622153e-01   -3.145920125925602e-01   -3.692223032174095e-01   +1.485722752472569e-01   -4.675090602284054e-01   -5.431788733226652e-02   +7.577223541534779e-01   +1.611396248421484e-01; +4.033994176182975e-01   +2.985140419122476e-01   +7.715366639454194e-02   +4.627299100779297e-01   -1.698561016427193e-01   -5.576626027830772e-02   -3.707565527097408e-01   -3.058772764351113e-01   +1.089064785117211e-01];
L5_L2_iGABA_netcon = [+2.185393113714170e-01   +3.209903672915432e-03   +2.360533397902682e-01   +4.395868796309955e-01   -1.880309445961296e-01   +7.318459381666254e-01; -4.140404614151967e-01   +2.442718888189188e-01   -5.301525201466828e-01   +4.414109873030314e-02   -6.781672981622917e-01   -2.336674412175389e-01; +4.760614452070492e-01   -2.703978073494335e-01   +2.814953697822111e-01   +1.087987016588732e-01   +8.435151487442664e-02   +1.381047175082144e-01; -2.204219035624171e-01   +6.909765624330221e-02   -4.028298665154936e-01   -3.137426988883338e-01   -1.666325508559806e-01   +4.680893297216315e-02; +3.208264714402204e-01   -6.749939448663220e-01   +5.401629992152899e-01   -3.375286642170876e-01   +1.302674122489988e-01   +8.247861676789021e-01; +6.066708207895457e-01   +2.831528078319298e-02   -1.408521837689762e-01   -5.810007594108521e-02   +4.693353851486248e-02   +4.014987201872796e-01; -2.891754518257142e-01   +7.189769874787546e-01   +4.676752409014983e-01   +5.103750785625443e-01   -6.738552589882763e-01   +3.794804244996185e-01; +7.056840670808923e-01   +6.102422439877738e-01   +1.055784726497285e-01   -4.872945217266000e-02   -2.230684026410667e-01   +3.953299483096494e-01; +5.117596205013326e-01   +5.338837082948716e-02   -8.674125837639858e-01   -1.913661831517403e-01   +1.740394020905689e-02   +4.477897721765621e-01];
L3_L2_iAMPA_netcon = [+4.568271215504485e-01   -1.341889886366481e-01   +4.762607518831130e-01   +3.921960705239679e-01   -3.987395675772646e-01   -2.746699554223638e-01; -1.088249948553531e-01   +8.612195448035627e-02   -1.624733475458723e-01   +4.540937068710346e-01   +1.037006905876874e-01   -4.128535884065182e-02; +7.554451024407920e-01   +7.720092928760993e-01   +4.619803176074933e-01   -8.602304664890242e-02   -6.088040423850349e-01   +4.462403149501505e-01; -4.548049389925859e-01   -3.306703704615470e-02   -5.120970204695484e-01   +7.301635565059339e-02   +9.782753133236665e-01   +8.089520356437178e-02; -2.050205499769065e-01   +5.041814993629423e-01   +4.604062499754699e-01   +4.696321762079592e-01   +4.324318827628624e-01   +2.303349169983240e-01; +4.820527322479625e-01   -4.900291594130405e-01   +1.913018377315889e-01   +3.815756833278877e-01   +2.461585230646690e-01   +1.566844590481295e-02; +8.047654461575887e-02   -4.778433577680650e-01   -3.416586989039228e-01   -1.368110776853297e-01   +3.158067494162182e-01   -2.000688219029637e-01; -3.521306597966825e-01   +1.914862068897000e-01   +3.840795955869031e-01   -5.889511675680613e-02   +1.217313653734285e-01   -4.353992011219948e-02; +2.180984312157259e-01   +3.817851151000436e-01   +7.140507286065584e-02   +6.931237466618628e-02   -1.376363563471996e-01   -3.600510126176959e-03];
L2_L3_iGABA_netcon = [+3.743254763098707e-01   +2.207623375816655e-01   +3.030126412356150e-01   -7.861569626436971e-02   -8.574805108323472e-02   +3.124997943366453e-01   +3.734330910555744e-01   +1.315016126469338e-01   -6.880870190081374e-01; +1.380247567131855e-01   +7.422938218160640e-01   +2.504345797805366e-01   +2.250611691108516e-01   -5.983553370561382e-01   -1.929087874387790e-01   +2.193726800333517e-01   -6.993939982470135e-02   -1.655484535370400e-01; -1.402627394765328e-01   -2.241790376628278e-01   -5.390462617932945e-02   +2.295998232320721e-01   -5.345527522305215e-01   +3.011826404648873e-01   +5.702086395075194e-01   +7.431867546346504e-02   +8.117542005498452e-02; -3.432107304192672e-01   +3.741151985968866e-01   -1.831313995082390e-02   +3.868439478874063e-01   -4.010356313144114e-03   +7.459676841927395e-01   -5.263140973061669e-01   -3.820466101728903e-01   +8.851874461991087e-01; +6.067299832428399e-01   -1.682613638994861e-01   -2.451724561072980e-01   -5.541782026703949e-01   +5.946300660493847e-01   -1.761428779285697e-01   +3.784455844654679e-01   -2.709738703161821e-02   +4.413733231199075e-01; +4.224971151687218e-01   -2.391813659259689e-01   +6.594544895061260e-01   -3.000496603811128e-01   -7.502573591073969e-02   -5.176098524996966e-01   +1.194087453637133e-01   -2.895800089081640e-01   -2.248391523532567e-03];
L1_L4_iGABA_netcon = [-1.490665301348962e-01   +1.032264534386345e-01   -1.191473290480255e-01   +2.534853820255714e-01   -4.801394371224098e-01   +6.408896366278766e-02   +1.563676765194573e-01   +3.090854828821982e-01   -4.065377591568397e-01; +1.720704331302433e-01   +6.524097430777915e-01   +2.133083668525008e-01   +2.525406109656798e-01   -1.851474998124464e-01   +5.155005623076586e-01   -3.373881576145246e-01   +1.998749326835287e-01   -1.331191383130317e-01; +3.265185665125877e-01   +1.496460108666568e-01   -4.288726902932493e-01   -1.568618295125434e-01   +5.198086613347732e-01   +1.954482032234683e-03   -1.170571582702336e-01   +1.114011864214590e-01   +7.567471586603970e-01; -1.438978399931768e-01   +2.978739891021614e-01   -3.002673928787358e-01   +6.363913236519384e-01   +1.489173388238541e-01   +1.281451157176065e-01   -5.957313176088090e-01   -1.101050845827991e-01   +5.094346507774167e-02; +3.669301847499987e-01   -1.873190930218841e-01   +2.379433256863606e-01   -1.365846351481740e-01   +7.065335394167424e-01   -2.667122558402944e-01   +3.140805972649248e-01   -1.917353043322381e-01   +6.179793777838087e-03; -3.118862729898017e-01   +3.090757744860821e-03   +2.050003992048430e-01   -2.404671128833860e-01   -1.773995298720792e-01   +3.352552185453009e-01   -4.555212089374548e-01   +2.744345749671563e-02   -4.310475716172213e-01; +3.127631169765071e-01   -5.629803399747123e-01   -2.647304560978109e-01   +1.423501229581303e-01   +4.100225375819078e-01   -2.141431058880824e-01   -3.127237374512068e-01   +7.050117102236804e-03   -1.247825494307805e-01; -3.038203921227111e-01   -4.615350466007712e-01   +1.846263069331038e-01   -8.795383475688946e-02   +1.292592556089057e-01   -2.753978898322984e-01   +5.724597749610871e-02   +2.351910039440929e-02   -2.455800483421356e-01; -7.424445198716469e-01   +2.056922927397067e-01   +5.625782468643326e-01   +2.438620949443231e-01   -3.419022205730636e-01   +3.385431928435282e-01   +2.556502641576808e-01   +2.335653823353886e-01   +9.927047873568988e-03; -3.451023397259748e-01   +2.058026722955767e-01   -1.436889868190145e-01   -7.769744547340807e-02   -3.741942956919040e-01   -7.078143097067865e-01   -3.589052744331678e-01   +7.894669384231794e-02   +1.387397156718861e-02; +3.717148376905441e-01   +4.194267783800949e-01   -3.001996916206806e-01   +3.076598318115361e-01   +3.188802022969515e-01   +1.000000000000000e+00   +4.214763678713569e-01   -1.820137040315283e-01   -1.592367650722806e-01; +3.905051305736343e-02   -4.986773925050238e-02   +1.998996144584631e-01   -8.243772014887696e-02   +2.963664329995351e-01   -3.158129927402272e-01   +3.703970766869214e-02   +5.997589637301098e-01   -7.076195181178004e-01];
L4_L1_iGABA_netcon = [+4.978283464276153e-01   +4.481564681713503e-01   -9.777729346049401e-02   +4.301625958143511e-01   -7.123475251818837e-01   -7.010680551961338e-01   -1.318271273318972e-01   -7.448295819496785e-02   -5.452946180271820e-03   +3.154845353594028e-01   +2.870523291196356e-01   +1.270710598941564e-01; -5.842614738548247e-02   -2.730206432094325e-02   -3.426362290173822e-01   +2.223159665415059e-01   +6.459510334404012e-01   +3.184697443990312e-01   -1.922389226206838e-01   +4.279369938376627e-02   -7.166302320978931e-01   -2.672882130908152e-02   +5.588641163368118e-01   +1.370891068369121e-01; +4.749006974627277e-01   -6.222635923830890e-02   -1.744718328074957e-01   -3.786408586489654e-02   -1.448624403307361e-01   +7.057718140217832e-02   -7.036853460650082e-02   +9.113736727871916e-02   -2.101351693381130e-01   -6.406011799315501e-01   +2.011033418019256e-01   -1.469671529827503e-01; +5.940290799431680e-01   -1.428820830167818e-01   +5.258273041121475e-01   +2.160197735016359e-01   +7.383559707244058e-01   -1.059626591881195e-01   -1.653138430034894e-01   -9.533894921268099e-02   +2.675088973634480e-01   +1.433245208571616e-02   +1.741568986245401e-01   -3.295783925556887e-01; +1.851862356829808e-02   +5.475851848267110e-01   -1.351355741435332e-01   +2.084583350197219e-01   -1.858249364464644e-01   -1.654495020775879e-01   -1.875086298420408e-01   -1.929444923463399e-01   +5.562486238636402e-01   +7.775822182192539e-02   +4.422462501514577e-01   -2.813805264121912e-01; +7.695663222801873e-02   +8.593778747029935e-01   -1.452137265418467e-02   -4.112058001419268e-01   +7.185247912619069e-01   -1.663353054339247e-01   +1.988565416691855e-01   -6.911914243310159e-01   +5.688783202284220e-01   -1.405384117828881e-01   -1.452624569073268e-01   -2.224077322791950e-01; +6.711593475277087e-01   +1.493584751658399e-01   -9.748166122413235e-02   -1.050410817548823e-01   -3.915755432900316e-02   +2.166500527586197e-03   -3.830488264235379e-02   -1.256943414902873e-02   +3.414557561660271e-02   +1.067302624620781e-01   +2.501656808856342e-01   +6.022103998475008e-02; +1.571267239933841e-01   +2.392702489633517e-01   +4.069224809237307e-02   -3.876009101738605e-01   +1.000000000000000e+00   -5.548364562505281e-01   -4.971610352865686e-01   +6.886824183823022e-01   -1.275072632759735e-01   -5.963992360065913e-01   +2.846701131371888e-01   +2.771875634922266e-02; +2.071702027233678e-02   -1.258755796915938e-02   -6.139988932406533e-01   +4.032337679956252e-01   +7.997608997540585e-03   -3.715320375380763e-01   +5.330561908148527e-01   +2.892102968388666e-01   -3.084777737465616e-02   +6.185035665715866e-01   +3.523285442931385e-01   +1.956340130614360e-01];
L1_L3_iAMPA_netcon = [-4.646799033108155e-01   -4.515538518438575e-01   -1.597529673579692e-01   -2.576215119845879e-01   +5.415796036856798e-01   +1.235909263618769e-01   -2.289096611700480e-01   +1.739165536779685e-01   -2.796129197231220e-01; +8.246847904058721e-02   +5.328353519021594e-01   +3.349968295620792e-01   -1.411355311853341e-01   -3.432248372471244e-01   +2.055390351811620e-01   -3.523339594978254e-01   -4.016484337016193e-02   -3.501111195482866e-01; +1.001048895539652e-02   +1.652892657243949e-01   -8.876478239090287e-02   -1.706181250115938e-01   +2.307647020658476e-01   +4.431992231694958e-01   -3.299968481111026e-03   -6.852596658500399e-01   +2.336529409046428e-02; +1.330634092062336e-02   +5.059741687708891e-01   -4.657409250129506e-01   +8.604661854177971e-02   -3.517433260737096e-01   +2.901437111733420e-01   +3.299255638844535e-01   -3.322046021877700e-02   -1.724092885578126e-01; +1.644769762742906e-01   -2.547092727875718e-01   +5.554988443862195e-01   -2.759257976491560e-01   +4.725272425589340e-01   -7.612526992056122e-01   -4.307995369909317e-01   -4.414349500394349e-03   +1.711363643352325e-01; +4.989193107573985e-01   +1.701271903156739e-01   -9.995883063893361e-02   +2.408300546813701e-01   -3.189430126796468e-01   -1.602838988600767e-01   +7.573513873621815e-02   +1.958932329502946e-01   +2.344219828808102e-02];
L3_L1_iGABA_netcon = [-3.460432651648855e-02   +4.210244615145848e-01   -3.257092952110289e-01   -2.342884539231454e-01   +4.681137798085338e-01   +2.457136104269135e-01; +2.893659518487057e-01   -2.544762056917903e-01   -2.774924730511035e-01   -9.828683141241866e-02   +1.322497984209392e-02   -9.913961966598368e-02; -4.649293707269447e-01   +1.418756038038021e-01   +2.275089805217087e-01   +4.106676919019892e-03   -4.024429879902330e-01   +3.794168077056887e-01; +3.228665688301239e-01   -5.869019158632249e-02   +1.873803821376906e-01   +4.087196186743175e-02   +3.177530644587875e-01   -1.192678195731869e-01; +4.642695324190753e-01   -2.136669544684573e-01   +5.361080648678298e-01   +4.762832741602842e-01   -1.059811142471271e-01   +2.582102138490102e-01; +1.803945265494033e-01   -1.821361911743012e-01   -3.875128150488745e-01   -2.424760849050753e-02   +1.065976276190618e-01   +3.407624205206587e-01; +4.058611126210174e-01   -1.131785985393991e-01   +1.268983696720107e-01   +3.108499325344985e-02   +2.236197305522181e-01   +2.480626017277722e-01; -7.528003712587004e-01   -1.227158353927218e-01   -2.243754434523908e-02   +3.991932043459379e-02   -1.840082445387247e-01   +3.161397739196466e-02; -3.731784429125777e-01   +2.026110729743803e-01   -1.852432754989669e-01   +6.316621593411449e-01   -2.185409364279794e-01   -5.476200378242618e-02];
L5_Input1_iAMPA_netcon = [+1.878037151192113e-02   +1.371441114132806e-01   -2.290760481510012e-01   +2.532711419105969e-01   +3.259283807816530e-01   +2.480842404755340e-02];
L6_Input2_iAMPA_netcon = [+2.428754234939659e-01   +7.735719998296142e-01   +2.251719134613907e-01   +1.167235782202889e-01   +1.210468566483068e-01   +5.412993248006925e-03];
L5_L6_iAMPA_netcon = [-2.396849813197651e-01   +1.783058656293243e-01   -5.107669546004689e-01   +2.645399475821476e-01   -2.940429632033084e-01   -5.119204566623240e-01; +5.862611983842434e-01   +4.858427044050405e-01   -3.412246467951208e-01   -5.463188695070191e-01   -8.600679151419205e-02   +1.913097902517987e-01; +7.995060049570966e-01   +1.698396322909266e-01   -2.898285776090122e-01   -5.615671233663411e-03   -3.468721057963687e-01   -6.185328620737272e-01; -1.463041837323625e-02   +3.083067023506235e-01   +1.835375372991899e-01   -2.103751196452522e-01   +3.741350880475042e-02   +8.431189559143153e-01; -4.669405270910366e-01   +8.278514840171647e-02   -3.700383613553858e-01   -4.082461854444303e-01   -4.852989514731413e-01   +1.630457445905842e-03; -4.535638153287697e-01   -1.294854619103873e-01   +2.626453501554591e-01   +5.128501322923367e-01   -9.445237179080412e-03   +3.163527045888290e-01];
L4_L5_iAMPA_netcon = [-3.317467887241997e-01   +5.685493443776027e-01   +7.802538125772143e-01   -3.790946479393482e-01   -6.185306359357987e-02   -6.409718390758895e-02   -1.741908035398008e-01   -1.645076402723095e-01   -4.101636670532738e-02   +7.172727879401641e-02   +3.119245982344301e-01   -6.094537964040407e-01; +4.194868042567326e-01   -4.067092085213960e-01   +5.194080785493311e-01   +1.969452557249520e-01   +8.372516002869054e-01   -4.222890057009617e-01   -9.199056715234162e-02   -2.573166906383715e-01   +2.303423667534149e-01   +3.989121668445967e-01   +5.268557372729328e-01   +2.192827165676504e-01; +4.235140630193653e-01   +2.184040105397865e-01   -4.727606509443344e-02   -2.123684421699894e-01   +3.509695337270919e-01   +1.008048354022595e-02   +6.312701237368181e-01   +1.124616511783237e-01   +3.910601201752052e-02   +4.711415359401760e-01   +3.905969556051742e-01   -3.322442083263802e-01; +3.723061422418709e-01   +1.929529235586105e-01   -1.373767484010174e-01   -1.935267289453758e-01   -1.781279151428045e-01   -7.813596004292567e-01   -3.271186310486928e-01   -4.322780760986489e-02   -1.098761606442211e-01   -3.901928029444449e-01   +1.251566016458167e-01   +3.181785851796639e-01; +8.640247527650791e-02   +6.868513990592769e-01   -1.175426507182618e-01   +3.748075194372552e-02   +2.419163858310420e-01   +1.821495435118864e-01   +3.494345332981226e-01   -2.468926935688219e-02   -1.656747545340744e-01   -2.718047581080307e-01   +8.785474546358432e-02   +3.262776842403602e-01; -1.322539070785113e-01   -3.373058102661669e-01   -1.883318476341049e-01   +7.497355085979612e-02   -2.188112109860818e-01   +3.861062313371343e-01   -7.505055566484975e-02   -8.399260470713169e-02   +4.341662745906216e-01   +6.518978419236344e-01   +8.243164188198303e-02   -2.596185359632270e-01];
L6_L4_iAMPA_netcon = [+3.087729191924194e-01   -3.291150382143113e-01   +6.693649565943331e-02   +3.431206183914934e-01   -4.653114041804582e-03   -3.570479421720794e-02; +1.408653849721479e-01   +1.470077744160487e-01   +1.763552114284115e-01   +2.532470928427760e-01   -1.420391045659661e-01   +1.754450375610426e-02; +1.259215480961804e-01   +4.996814273002887e-01   +7.039706775124114e-01   +8.384082187231234e-01   -1.603291171524819e-01   +1.010980104944171e-01; +2.730579930515381e-01   -7.935738485464729e-02   +4.483323823512120e-01   -2.205459436548177e-01   -3.765052974649270e-02   -3.742634234328004e-01; -1.481322252725772e-01   +6.590417004894733e-01   +4.694141127566698e-01   -4.757771784634183e-01   +2.114581259228458e-01   +5.034689280544109e-01; +1.000000000000000e+00   +5.284868789277165e-01   -6.809500551357803e-02   +1.351218807943509e-01   +4.702762360150064e-01   +2.444314882383632e-01; -3.209501362475741e-01   +5.061701675789203e-01   -1.925312151650670e-02   -1.235394738024670e-01   -1.661629426255990e-01   -1.666803569192088e-01; -5.545445463684734e-01   -7.244347249776526e-01   +2.102695974772824e-01   -2.774064642201719e-02   -1.262772916280638e-01   -5.090279511111777e-01; +1.745274693977000e-02   +3.016045296383211e-02   -1.283451873193721e-02   -3.458447804454717e-01   -3.868877095788647e-01   -2.213307475900937e-01; -7.692234150184937e-01   +6.793724100756081e-02   -2.572639443872464e-01   +4.138951805008534e-01   +1.510361294011290e-02   +1.750757340517742e-01; -4.489043971705858e-01   -1.711904719872503e-01   +8.071799479121826e-01   +5.391338269016146e-01   +7.939314840782660e-01   +3.002114772926508e-01; -7.488211662770609e-01   -5.190591103781906e-01   -7.658967273746682e-02   -1.041201783415933e-01   +3.414083713337290e-01   -9.124615217944058e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 40*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 40*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
