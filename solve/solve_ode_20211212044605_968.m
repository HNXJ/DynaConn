function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-2.996828148733442e-02   +4.352800912479454e-02   -3.345808973509438e-01   -9.338748550127507e-02   +1.777330085760466e-01   +2.412265209242186e-01   -1.729997201151338e-01   +5.842986556428683e-02   -2.371802927213316e-01; +5.496028500015786e-01   +2.218555275824223e-01   -2.550013597427163e-01   -3.043680143569188e-02   +1.814730847103274e-01   -1.587293594859550e-01   -2.455383774663943e-02   +2.927247694923857e-02   -4.610085822115422e-01; +1.788788213134176e-01   +1.368221724394524e-01   -1.007229037143014e-01   -2.623750629795785e-02   -2.673993974745634e-01   +7.618515727305547e-02   +1.841208589101512e-01   -1.679448580577377e-01   +1.869898423346604e-01; -2.727477517947594e-02   -3.551808951071148e-01   -2.438006125236556e-01   -7.833184872438977e-02   -2.098595443840713e-01   -2.042253920409534e-01   +4.075236509794443e-01   -1.830429221616055e-01   -1.210568552536653e-01; -2.201071572870361e-01   +5.624555457844681e-02   -1.393761740735151e-01   +3.896377172757010e-03   -4.133884834440792e-01   +1.004809985851137e-01   +3.611634859923646e-01   +4.515210851782973e-01   +7.124207696505161e-02; -1.384996432234267e-01   -8.288632443764085e-02   +8.591755677537598e-02   +1.454235261267196e-01   -3.487622171670139e-02   -1.474369594906355e-01   -5.940066947374395e-03   +5.604476779183290e-02   +2.702697022394441e-01; +4.085649512675194e-01   +2.241958265023792e-01   +1.584583797929758e-01   +1.863472362063773e-01   +9.141492515699912e-02   +1.200572657078536e-01   -6.472919789553769e-01   +6.494582547895769e-03   -1.146334223040637e-01; -6.392570391159230e-04   -1.339826123527859e-01   -1.361696127639769e-03   -3.881481930544194e-02   +5.215262469881663e-02   -1.510025163422240e-01   +6.816638460216376e-02   +1.721797949319304e-01   -7.789629715453458e-02; +1.880469093174480e-01   -2.014310701798736e-01   -9.663721083842537e-02   -1.366199642608870e-01   -3.503611201546816e-01   +1.528134328972169e-01   +4.628345901818702e-01   -1.750095508154751e-01   -2.105498508065886e-01];
L1_L2_iAMPA_netcon = [-6.114943894133993e-01   +2.988104607633612e-01   -3.611397916816134e-01   +4.782126999878007e-01   -3.922833302312718e-01   -2.206276823253817e-01   -6.263472545790881e-02   +3.053818589329807e-01   -3.365838041977042e-01; -2.835453309922490e-01   +6.464916647823646e-02   +7.479226548419401e-02   +2.199218718228850e-01   +4.926651168539326e-02   +1.596410097050336e-01   +9.284526922942805e-02   -2.472716462979658e-01   +7.892139242616411e-02; +2.585984991941465e-02   -3.896191244471682e-01   +1.552584448884906e-01   +1.088811129207140e-01   -4.802792691612090e-02   +3.194837316325955e-01   +3.537985007023185e-01   -5.238046274843198e-01   -9.338609734835077e-02; -3.094079835417458e-01   +3.578841650122691e-01   +1.297066176171545e-02   +1.857771299559901e-01   +4.916111558469216e-04   +9.407656520720005e-02   -1.971670251396004e-01   +4.127714341745614e-01   -1.570629235381072e-01; -8.937153529064830e-02   -8.921914054014357e-02   +3.536613899020968e-02   -5.274145836207145e-02   +8.391741848787382e-03   -3.827789659835954e-01   -1.612319615459201e-01   +6.946668923242530e-02   +3.048414102700844e-01; +1.835323455592429e-01   -3.372467147946884e-01   -1.209750107538549e-01   +3.522875642164382e-02   -2.394400093453249e-01   +2.006216526815351e-01   +1.161650751120560e-01   +1.458155625559953e-01   +9.361910772454692e-02; +9.398786915551247e-02   +3.004247917764317e-01   -4.313325715751809e-01   -7.255229185784620e-02   +5.740231238131455e-02   -6.691504497001162e-02   +2.613678615432853e-01   -7.359249122538483e-02   +4.631958791508105e-01; -1.984589422908491e-01   +7.685752778392793e-02   -6.399387034231543e-02   -4.743469061051442e-01   +1.444579073334163e-01   +2.577785590954548e-01   -3.903886101810320e-01   +1.288590935115693e-01   -1.347817939940679e-02; +3.545655034622985e-01   -2.168736523933248e-01   -1.746402054198425e-01   +5.261562276794036e-02   -1.179309886987723e-01   -4.417950755160040e-02   +1.769197374427488e-01   +2.238765379559522e-01   -2.363132449941842e-01];
L2_L5_iAMPA_netcon = [+1.994531373933309e-03   -2.822069606697158e-01   +7.217351954748737e-02   +4.387462987874415e-02   +3.043419262724553e-01   -2.976163505114632e-01   -6.673979486019843e-02   -2.711125925731913e-01   +4.238253884918851e-01; -4.605418753638990e-01   -1.060018326345870e-01   +2.749606295568853e-01   +4.871444983600544e-01   +6.125606093344074e-02   -1.664716656214530e-01   -1.481739725705705e-01   +5.908331005175830e-01   +2.350008155505704e-01; +4.851541928585648e-01   +4.126031321307948e-02   +2.735562590956663e-01   +7.126753276572398e-02   -1.916135800278481e-02   -9.674271937117569e-03   -8.170621338881079e-02   +1.424706896931805e-02   +3.018649035135951e-01; +1.901436760892054e-02   -3.643098703276157e-02   -6.104703753399440e-02   +1.622820584822020e-01   +3.359087157290211e-01   -1.098520298216660e-01   -1.053419453140389e-01   -9.610878574201973e-02   +1.304504670433112e-01; -3.608999642234996e-02   +1.605758898640754e-01   -2.418586320390107e-01   +3.004013303220363e-02   +2.122132488056978e-01   +1.513505566099717e-01   +2.582843998717884e-01   +2.127901873395059e-01   -6.124129989828798e-02; -1.467300860866235e-01   -9.181572463296220e-02   +3.097857641007278e-02   +1.508230813855321e-01   +1.496789509986369e-01   +2.403714724549413e-01   -2.844099293182378e-01   -5.393218760935929e-02   +1.529063164278071e-02];
L5_L2_iGABA_netcon = [-5.244325054093654e-03   -1.866340990598300e-01   -3.138901744935149e-01   -3.061545485383650e-02   +3.807438622946155e-02   +1.159644366770267e-02; -6.710219944620963e-02   -1.991929478509995e-02   +5.175425190051326e-01   +1.876678877007303e-01   +1.102348734192837e-01   -4.934365811770100e-02; +1.107904166108133e-01   -1.225300206798924e-01   +7.468850645621382e-02   +1.843907550502750e-01   -2.100186000334962e-01   +1.225580972269908e-01; +9.102553646114037e-02   +4.151500604475089e-02   -4.685288563416257e-01   -2.814737917533394e-01   +4.162981561795551e-01   +6.085044724122071e-02; +1.392188989006410e-01   -2.248052052287215e-01   -1.625420565566430e-01   +1.798695203834680e-01   -2.884148985957657e-01   +7.407585570560685e-02; -1.862208715949950e-01   -1.683793905130856e-01   +8.189341000955130e-02   +2.319060840329606e-02   -1.345133644989145e-01   -4.193159676401503e-02; +1.111646925015186e-01   +1.058415303093360e-01   +1.767993096556317e-01   +1.049953837814254e-01   +1.313112624197415e-01   +5.762602230299352e-01; -2.894312714371611e-02   -2.983932577967112e-01   +2.445372523038890e-01   +4.969413364059417e-02   +4.672080777054315e-02   -1.101956558343488e-01; +1.912292898313109e-01   -1.400938094790922e-01   -6.647527663123005e-03   -9.426721549768734e-02   +1.008834386332877e-01   +4.309923438675073e-01];
L3_L2_iAMPA_netcon = [+1.525076965289832e-01   +1.502716627095824e-01   +1.247433115112671e-01   +3.927856179661568e-02   -2.442829678150181e-02   -2.113970242293312e-02; -1.319602489253807e-01   -2.077291483960235e-02   -2.744063716003943e-01   +1.722172008692312e-01   +1.978361679202741e-01   -1.359431393108691e-01; -2.053463230271400e-01   +3.603489078320531e-01   -3.796511480494247e-01   -2.048928226745976e-01   -1.269947437381941e-02   -1.949655449448118e-01; +4.577295827464701e-01   -2.262565857753669e-01   -2.137969014299377e-01   -9.726556366809483e-02   -7.929266245300950e-02   -7.274704478174313e-02; +3.154544594404793e-01   +1.349873944273272e-01   -6.991933234940818e-02   +1.968585460894852e-01   -2.574954846410420e-01   -5.868186344238877e-02; +2.641526481762335e-01   +7.702220459117906e-03   +1.041999598024861e-01   -3.171124618513244e-02   +5.035204901985368e-02   +1.629622054486380e-01; +1.331759579210332e-01   +2.172080441434574e-01   +3.131444174505201e-01   -7.994654711715340e-02   -1.389361934522445e-01   +1.523544121236083e-02; +6.115550448799078e-02   -4.596784800814562e-01   +4.161522948989351e-01   -2.494904888938293e-01   -3.434172591540910e-02   -1.195225299645307e-01; +5.978039668065659e-02   -1.753637148481831e-02   -3.432970521930629e-01   -3.514904125251856e-01   -2.815017218742393e-01   +1.201419652560527e-01];
L2_L3_iGABA_netcon = [+3.903356944812765e-01   +1.831975815020311e-01   -5.331277523651820e-02   -2.442365104987499e-01   -1.850255866309376e-01   +9.552094775179693e-02   +1.968189308383798e-02   -1.602314455431213e-01   -1.895672500876403e-01; -2.275255315784789e-01   +1.544494102161382e-01   +7.655347799099121e-02   +1.287504696059815e-01   +4.973453419735524e-02   +7.888649800892412e-02   -6.943069887599883e-02   -3.024136148919046e-01   +1.115506796360674e-01; +3.801021412549007e-01   +1.659897313716548e-01   +5.978618381102570e-02   +9.030102079828070e-02   +3.815881312299955e-01   -3.376559206571912e-01   -2.074652381467930e-02   +1.797825358486582e-02   -2.481416017876441e-01; -2.398591920700504e-02   +1.330173670293200e-03   -2.118073896407777e-01   -1.495983689497293e-01   -2.010360639895916e-01   -3.449837003530871e-02   -6.691259804819549e-03   +1.180166787517726e-01   +3.443381725492620e-02; -4.189306626731085e-02   -1.364117179829434e-01   +4.474605630873226e-01   +2.611037115772164e-01   -3.071937491605356e-01   +1.996602024604480e-02   +2.522695623885638e-01   +2.136909975010242e-01   -1.484241270737651e-01; -1.146638233460640e-01   +4.347070843213683e-01   +1.953661159961496e-01   -2.774760644433366e-01   -2.635809187002621e-01   -3.771624987598185e-01   -3.536958701688973e-01   +6.637008327368328e-02   -9.236575845568605e-02];
L1_L4_iGABA_netcon = [-4.568572849468625e-01   +3.791033762635985e-01   -3.520048830605945e-01   -2.406136131605065e-01   +9.018702872378513e-02   +4.098236016854913e-01   +2.045706548689601e-01   +3.349527616917443e-01   +1.678532897514299e-01; +1.412775887411965e-01   +1.645469853022941e-03   -2.661710077064802e-01   -4.133778303347345e-01   -1.259599372159411e-01   +1.638776696830258e-01   +1.331639124308738e-01   +3.368243392292404e-01   -3.356394444485408e-01; +1.691483207952797e-01   +1.858166458143722e-01   +2.071490071713799e-01   +3.079680093231967e-02   -3.013605240871419e-01   +4.296173189172299e-02   -2.025793019470270e-01   +2.986855114682360e-01   -2.544054108634872e-01; +2.133724309417739e-01   +1.770952967781865e-01   -1.032896738138022e-01   +1.585888116262139e-01   -3.451373618927808e-01   -6.470488382392268e-02   +1.395487858828456e-01   -1.359786184696063e-01   -2.002602604841627e-01; -1.613189699480231e-01   +6.872806079473576e-02   +1.795835963638810e-01   -4.899035749104518e-01   -2.347952989730633e-01   +4.455886490117099e-02   +2.303171001664220e-01   +4.776640459752087e-01   -1.135549776091391e-01; -2.466398063837165e-01   -7.359605240854730e-02   +1.476886788970458e-01   -4.410083725923281e-01   +4.320611501133880e-01   +1.287890862825989e-01   -2.249962099987212e-01   +2.182731323050509e-01   -1.665306556209451e-01; -5.688739773969494e-02   -2.319335591178736e-01   -2.636758411414638e-01   +1.913396549931449e-01   +5.170099018828497e-01   -1.991962379798035e-01   +4.742098342800508e-01   +5.529330575840492e-02   -3.650426052466878e-01; +1.609632620482489e-01   +2.082711278346520e-01   +1.949040401140227e-01   -2.544926430146914e-01   -9.729219806715390e-02   +7.742820002923985e-02   +2.658852174604301e-01   +1.892457674369219e-02   -7.474191243109254e-02; +1.960689366104217e-01   -2.143008358971743e-02   -2.606374630934949e-01   -2.205942367054886e-01   +9.441518609233858e-02   -1.039467718569008e-01   +1.918857565030653e-01   -1.523019690410727e-01   -1.711466070834015e-02; -1.013853011082630e-01   -3.940941748540040e-01   -3.636220474460825e-01   -2.171987874420959e-02   +5.596211966533494e-02   +3.028020102211305e-01   +2.216697535531797e-01   -1.509553706694878e-01   +6.956074483532740e-02; -1.054878954148185e-02   +3.038840887358515e-01   +4.752774779567250e-01   -4.723445631986178e-01   +1.263966912980674e-01   +1.853594785662066e-01   +6.383131949857082e-01   +1.660112369785449e-01   +1.949883068977958e-01; -2.792627230913883e-01   +8.279410058423027e-02   -2.121088157462382e-01   +1.373935736005804e-01   +8.634767459309417e-02   -1.091951560380451e-01   -3.696266432274659e-01   -2.689022185096571e-01   +8.045213584696777e-02];
L4_L1_iAMPA_netcon = [-2.560630166982500e-01   +1.241928345772767e-01   -8.040117251612773e-02   +3.557316011492132e-01   +8.000391001264548e-02   +7.219169521795132e-03   -1.342873329827807e-01   +9.608890151852925e-02   +2.252596746985653e-01   +2.564673978009943e-02   -4.000934433619180e-02   +8.713313813464504e-02; +5.266145779525859e-01   -2.694376222798150e-01   +9.803579991388237e-02   -1.600170082826413e-01   +2.261395041577309e-01   +4.486794187076465e-01   +1.632957943618967e-01   +5.476898070923555e-02   -3.640400997441440e-01   +2.824299150318532e-01   -2.373975531065824e-02   +8.556003612012941e-02; +2.847417000267741e-02   +1.907539212926915e-02   -1.361184575901733e-02   -9.319383561355214e-02   +2.382790759880704e-01   +8.159782965706690e-02   +8.853506484172233e-02   -3.619096383575864e-01   -1.898739917011908e-01   -2.020931122380053e-01   +3.249678037748316e-01   +7.077935753971684e-02; -1.176060556925616e-01   +1.678086987535138e-02   +4.271746702076742e-01   +4.818175612195242e-01   -3.536709801986216e-01   +2.120066425116085e-01   +1.748905506738389e-02   -1.720966615627761e-01   +1.601681579324305e-01   +3.232724789435851e-01   +3.408627704779160e-02   +7.585878772632396e-02; -9.208756586528240e-02   +1.591866359408840e-01   +2.533625704721054e-01   +3.904464264167505e-01   -4.408943529680326e-01   -2.029554212784709e-01   -2.648541635092568e-01   -4.326038944864767e-01   -1.873579530794880e-01   -1.665026101537435e-01   +6.777502143887702e-02   -1.004870670426188e-01; -5.260290523223507e-02   -2.603586483000335e-01   -1.359492797756936e-01   -6.307860109703481e-02   -6.529242915201820e-02   +6.423260669586812e-02   -1.959369710886739e-01   -4.367200850812679e-01   +1.721923532303756e-01   +7.924574796573622e-02   +7.998766858075716e-02   -5.557937083264914e-02; -7.898989235811585e-02   -4.829910904163408e-02   -1.994817290414326e-01   -1.309126148367045e-01   +1.381478910048226e-01   -1.295774400735074e-01   +2.196114418419241e-01   +3.621985435863432e-01   -3.255614495088498e-01   +1.739492825611799e-01   +2.853430866552956e-01   +1.637759162722333e-01; -6.215337305509804e-02   +1.299448893348153e-01   -3.203386597881027e-01   -2.663949298811690e-01   +1.454372801548143e-02   +1.115657468309615e-01   -2.838150499403527e-02   -3.551241889479895e-02   -2.396352070842127e-01   -2.477947379852731e-01   +4.762787679494969e-02   -1.674461452375763e-01; +7.997153494577550e-02   +4.535203628784365e-02   -9.915965601335686e-02   +2.930178748102918e-01   +5.794917799905873e-02   -2.514384112320290e-02   +1.825209753772469e-01   +1.610152666840541e-01   +1.378633905791596e-01   +3.264665220016900e-02   -1.876251741997760e-01   +2.708953286470384e-01];
L1_L3_iAMPA_netcon = [-7.780376959563175e-02   +7.327877413938307e-02   -1.434733689090294e-02   -1.797897303921707e-01   +2.645564729179728e-02   -3.973156409246731e-01   -3.166436217401609e-02   -2.152440256554506e-02   +5.587679074272988e-01; -3.958546720658251e-01   +2.133028376703859e-01   +4.790276926333675e-01   -1.621936486326296e-03   +2.723422510929162e-02   +5.875610153641784e-02   -1.891026900491732e-01   -1.602455397064630e-01   +4.386232867318611e-02; -3.967329922943215e-02   -1.099780849260853e-01   -4.251044927470501e-01   -1.314801201186017e-01   +2.832456418046914e-01   +4.558974777338268e-02   +4.751546062750251e-01   +1.843584720689416e-01   -2.699883164727612e-01; -2.605162397213408e-02   +1.523673038399197e-01   +2.667068635508543e-02   +2.757016711480008e-01   +2.359924199523496e-01   -1.099281664876639e-01   +2.529456323255123e-01   +1.879043021211859e-01   -3.674837553350888e-02; +4.610064671450428e-01   +1.357250471798384e-01   -2.653332072604947e-02   -5.191128473071229e-01   +1.997432361246794e-01   -4.189446550547173e-02   -4.363517322989603e-02   +1.466453098312149e-01   +4.137721908852137e-01; -2.801665018538654e-01   -5.869594321818905e-02   -1.895733076257940e-01   -1.605181678714317e-01   +3.459410760802574e-01   -6.553937764771921e-02   +5.388865242841736e-01   +3.625891213262030e-01   +3.829732386219707e-02];
L3_L1_iGABA_netcon = [-2.260522250062913e-01   -2.550102330282642e-01   -2.209509044398484e-01   -4.966013527412431e-02   -1.201914038282338e-02   +2.381712934615753e-01; +9.168515136849878e-02   -4.182379613449532e-01   -3.564037965937399e-02   +2.813184489827601e-01   -9.738777546540761e-02   -6.291050977671758e-02; -3.013686707806713e-01   -1.691695823241034e-02   -2.050789039731227e-01   -4.723143454357268e-01   +1.439471878941610e-01   +1.625649109351855e-01; +2.867183931929130e-01   -3.643084553764739e-01   -4.752473523268820e-01   -1.843515879538898e-01   +1.626757188196103e-01   +5.335291085838848e-02; -3.101442918181874e-03   +8.107823893622967e-03   +6.627960282674719e-02   +1.189206276627583e-01   +1.476289738006034e-01   -5.764103762084717e-02; +1.679676324600623e-01   -4.692575108832618e-01   -2.462263832099335e-02   +2.897757147857654e-02   +3.322765059059727e-01   -1.098611732427933e-01; -5.117726738644365e-02   +3.773469395413425e-01   +8.086465813578556e-02   -9.220963255850947e-02   -1.682887945100123e-01   -1.172181607099160e-01; -5.808682832434204e-02   -8.721106428715381e-02   -3.626012932822853e-02   -1.661406229576697e-02   +3.810030843817374e-01   +3.843804702870635e-02; +3.643046306066591e-02   -3.668689953515043e-02   +1.789385856671040e-01   -1.237160780919598e-01   -2.723300514311498e-01   +1.353305546071055e-01];
L5_Input1_iAMPA_netcon = [-3.741759059919542e-01   -3.020881480561419e-01   -3.240765511068422e-01   +3.512511697135954e-01   -1.794219547549386e-01   -3.202762630949744e-01];
L6_Input2_iAMPA_netcon = [+1.043801262821701e-01   +4.201416755097878e-02   -3.843364439393940e-03   -7.519732575001295e-02   +1.770541645054127e-01   +1.188742871022536e-01];
L5_L6_iAMPA_netcon = [+7.875568766667439e-02   -7.188166998924200e-02   -3.004533775297368e-01   +1.968558723350763e-01   -1.162977309501682e-01   -5.473575423042102e-01; -5.707370736467073e-02   +7.496341371839403e-02   +1.670729522656466e-02   +4.652780024514287e-02   +1.339847805832891e-01   -1.778865335864621e-01; -2.766533651412997e-01   +1.651475026437405e-01   +1.309249772482025e-01   +6.613028929177439e-02   -7.103809253019365e-02   -8.587193629174034e-02; +1.100669254370013e-01   -5.361059969415242e-02   -2.732991336021575e-01   -6.805511424272627e-01   -1.584608216206805e-01   +1.420276915312543e-01; +9.330713496156059e-02   +2.363544042431355e-01   +2.874363331414391e-01   -6.608990353580400e-02   -2.389671620763398e-01   +1.784773085943446e-01; -2.038071970368085e-01   -3.979508878972196e-02   +4.289967168671782e-02   -2.222679817992068e-01   +1.627504751285921e-01   -8.863607350650562e-02];
L4_L5_iGABA_netcon = [+4.498646520757280e-04   +3.997990625090996e-01   +3.623091195700872e-01   +3.244588817082739e-01   +1.670961726866435e-01   -1.673815264970221e-01   -5.158535804985337e-02   +7.626423296396168e-02   -1.483729929151614e-01   +4.931364138335778e-01   +1.066202965702276e-01   -3.888000287257254e-01; -2.744977545372988e-01   +8.522556025717401e-03   +3.847203054922260e-01   +1.987942736166080e-01   +1.358529786829215e-02   -1.161480039298808e-01   +3.913493023463214e-01   +3.492902184703391e-01   +5.237655494770656e-02   +1.764313907293000e-02   +2.309464060676498e-01   +1.414191021229017e-01; -5.124906690754726e-01   -1.002929609326319e-01   +3.018504527025595e-02   -4.311912157436633e-01   +1.212967227707445e-01   +1.968008452662472e-01   -1.557877656865177e-01   -1.151117924074409e-01   -4.750404283966431e-01   +3.326696233364766e-01   -9.939247056673803e-02   +3.593035548551893e-01; +2.396600486750147e-01   +3.487600271968036e-01   -2.939134549543429e-01   +1.160562768081352e-01   +4.260879704460797e-01   +1.236013257280986e-02   +1.393103021713175e-01   +2.871843036981543e-01   +5.209723435742054e-02   +2.183154709168997e-01   +2.208220853879637e-01   +2.758740965960747e-01; +2.165738266065814e-01   +1.551576228155295e-01   -3.048512228539668e-01   +1.421334914167527e-01   -1.082068144728562e-01   -1.292145674360047e-01   +1.368821151914952e-01   -2.601114667266102e-01   +2.362975785197799e-01   -6.748326405612071e-02   +4.023563036242135e-01   -1.087559230499277e-01; -7.734917059005939e-02   +1.162542367017835e-03   -3.623492827572113e-01   -4.065786275635448e-02   +2.832335436592213e-01   -5.614856967907783e-02   -6.849201387545673e-02   +2.552470325772203e-01   +1.648980445097337e-01   -3.109603615627956e-02   +4.380164497173888e-02   +1.578297888884537e-01];
L6_L4_iAMPA_netcon = [+1.496569861152831e-01   -4.343645037226563e-01   -3.066507829774774e-01   -1.434666694805667e-01   +5.965943623083443e-01   -1.986465763860195e-01; -5.412613509879023e-02   -3.403279133242261e-01   +9.912886411211860e-02   -2.835648873449813e-01   -9.735879011508879e-02   +2.535362128682283e-01; -1.140382613219325e-01   -4.146267253120674e-01   +3.041012340130066e-02   -4.938782759577931e-02   -3.073884539545327e-02   +8.918685009600988e-02; +1.550913011649489e-01   -2.996309874089538e-01   -3.984242729822387e-01   -3.397039604933648e-01   +1.458667281393739e-02   +2.448877879675840e-01; -2.490626260735570e-01   +1.499322712749725e-01   +1.502004317107939e-01   -1.204509506102111e-01   +2.094025693447409e-01   +1.505734500798893e-01; +2.065683069632125e-01   +2.233492972470256e-01   +1.639190527491791e-01   -1.219822679863177e-02   -6.107722395356267e-02   -2.740825248889056e-01; +2.329965442354024e-01   +3.106136427458604e-01   -3.294888250289985e-01   -3.821184453080402e-02   -1.281350632727208e-01   +2.426077262239281e-01; -4.990386170143619e-02   -3.147576924879116e-02   +4.509295079700975e-01   +1.359065611465367e-01   -7.416226631918503e-02   -6.549559955399319e-02; -1.112287955482002e-01   -8.318565634172578e-02   -2.309457158501478e-01   -2.003168896981128e-04   -1.018544822380624e-01   +5.674493431437786e-02; +4.619216087423629e-01   +1.740706839708927e-01   -8.086862488663768e-02   -5.184420193642454e-01   +5.026353504394798e-01   -2.066832020499227e-01; +2.339144009329830e-01   -1.260702772494585e-01   +2.514046872074800e-01   -1.265647680842598e-01   -1.803105504172339e-02   +1.048705956832447e-01; +1.560680955570692e-01   -1.091274468634726e-02   +1.228485357236188e-01   -1.224503128587527e-01   -2.701316476684895e-02   +2.439205220895316e-01];
L5_L4_iAMPA_netcon = [-2.970145289573563e-01   -4.957330867061648e-01   +2.677086112409131e-01   -1.533807706345362e-01   +7.406835295540438e-02   +2.790288697009550e-01; +6.207462234327117e-02   -2.640051613412246e-01   +3.113197158977445e-01   +5.123638243129890e-02   +2.015543510645529e-01   -2.126579813987881e-03; +1.580060130318128e-01   +3.174907491569298e-01   -9.481809587909573e-02   +7.139856117216184e-02   -4.532741027561889e-02   +3.317831819912942e-01; -4.276539363977007e-01   -3.225556793945968e-01   -1.448798801669373e-01   +1.234785983213375e-01   -2.676945727567363e-01   -2.640928151168909e-02; +7.620977566793651e-02   +4.736591263663884e-01   +2.022521659393504e-01   -1.893291615313289e-01   +2.269755178179147e-02   -4.402743024337686e-01; -4.893629745456822e-02   -2.780207953209304e-02   -3.065679378132369e-02   -1.775720771300712e-01   +1.412389447921017e-01   -1.541440180413143e-01; -3.300740469416515e-02   -1.465929898241480e-01   -3.071103988269405e-01   -2.041310532450694e-01   +2.550095633016163e-01   +9.494808350540943e-02; -8.691821251728779e-03   +3.946638268181110e-01   -1.024879746678869e-01   +7.492030025259716e-02   -4.786371761444717e-02   +3.194837590611270e-01; +9.493414945524163e-02   -1.581384276977783e-01   +9.660428425234735e-02   +1.406521147942828e-02   -2.814201627871259e-02   +1.458545353976146e-01; +5.867661170442093e-02   +2.708003156835197e-01   -2.433529265464146e-01   +2.363720733249774e-01   -3.340544727105269e-01   -3.478622159141682e-01; +6.864880865678749e-02   -2.080521500949205e-01   +4.690061034711850e-01   +3.585698419955723e-01   -3.270862801893069e-02   -1.463932546587895e-01; +8.391880133150008e-02   -3.766555182547823e-01   -6.472585087804714e-02   +6.419684815829625e-02   -2.009855831050816e-01   -1.152739357495502e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 150*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 150*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
