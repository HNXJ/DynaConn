function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+3.354297458476858e-01   +6.882485514978057e-01   +4.629966304778120e-01   +7.170288209161559e-01   +2.155371241282873e-01   +5.413760686080648e-01   +3.500935806633895e-01   +2.392662829054186e-02   +2.935576887618853e-01; +6.889920324107079e-01   +4.528218441732632e-01   -1.185208899608108e-02   +8.682892684731601e-02   +5.020136750321817e-01   +1.624379364803778e-01   +2.466366441463468e-01   +6.166116855270175e-01   +7.568648793899241e-01; +2.604693031331723e-01   +5.986558038328968e-01   +4.942852980576905e-01   +4.193773008679886e-01   +5.042413563104231e-02   +1.805078742586892e-01   -1.188383420095810e-01   -3.411875790775215e-02   +3.427160430646705e-01; +3.085369155716012e-01   +1.591114570437487e-01   +5.938968015259851e-01   +2.102355437318510e-01   +4.151626522639694e-01   +2.785030077816431e-01   -2.834379262758288e-02   +8.644264690541393e-01   -5.031175404046206e-02; +4.187477163461836e-01   -6.074682504384263e-02   +5.288046049182936e-01   +4.636332184858337e-01   +4.146855044664071e-01   +2.199171145093087e-01   +4.679303828603754e-01   +6.909503436842701e-01   +3.269342758535168e-01; +4.141020472020838e-01   +1.626152175078319e-02   +6.020514879929405e-01   +5.684501869209085e-01   +2.160428366328768e-02   -5.602827514651534e-02   +4.208576188866492e-01   +5.075929661930504e-01   +3.853853841447868e-01; +4.150711941588178e-01   +7.726900464109592e-01   +2.661873041438791e-01   +3.945212162308365e-01   +3.469336130662595e-01   +2.778248772752315e-02   -3.490676571128223e-03   +4.366410892578122e-01   +3.568664346467491e-01; +4.748649352543672e-01   +2.563438951946245e-01   +7.401591917392042e-01   +4.202705238077293e-01   +3.767848358860170e-01   +3.146021444582724e-01   +1.455578417068146e-01   +5.508389773116568e-01   +3.681326018044983e-01; +7.064744122431809e-01   +7.767644041711425e-01   +6.901519169671455e-01   +2.213259484635894e-01   +1.688133730328868e-01   +1.853795273750387e-01   +2.896654694286501e-01   +4.806457662190231e-01   +2.526917552151974e-01];
L1_L2_iAMPA_netcon = [+5.864093428727145e-01   +4.073998619212020e-01   +5.922941540792783e-01   -6.239286484860090e-02   +6.541915711970812e-01   +8.690713815214097e-01   +1.779999821943676e-01   +5.378441448744296e-01   +3.949156384168171e-01; +4.215538720842913e-01   -1.778707759963586e-02   -4.219996968896349e-02   +4.325696975714036e-01   +1.045404119204399e-01   +3.579161445971502e-02   +3.303743691399432e-01   +6.720826081548146e-01   +1.720111434299524e-01; +1.735068588713837e-01   +4.503199260146401e-01   +3.916435902893133e-01   +3.382837676035206e-01   +3.760824555172079e-01   +2.246841570836540e-01   +5.460514205822411e-01   +3.341596232625393e-01   +3.171158271177246e-02; +2.444843460122774e-01   +5.028170330925802e-01   +5.231362123269081e-01   +3.903095787602546e-01   +7.129769802651034e-01   +2.975310981976180e-01   -2.673983227374804e-03   +4.656518787451086e-01   +8.342489137969678e-02; +4.790076332737266e-01   +5.306811676044228e-02   +7.836243868943596e-02   +4.402305410667555e-01   +6.185328979139555e-01   +3.329377891214467e-01   +5.185384177942424e-01   +1.397218075456125e-01   +6.751455623459894e-01; +5.664306891127509e-01   +8.370796867985578e-01   +8.982144384859402e-02   +7.658004899855776e-01   +3.507642988728119e-01   +1.842614488504443e-01   +4.412745813016444e-01   +2.265209404446058e-01   +6.144545035463355e-01; +2.242800415378066e-02   +2.028112880044555e-01   +4.600049799528586e-01   +1.881545551910456e-02   +1.304310687459040e-01   +5.110651657026034e-01   -3.701463332069787e-02   +1.729336039926953e-01   +3.009850343915763e-01; +6.169963354306055e-01   +2.257416686177499e-01   +4.904404939338556e-01   +3.718656717947724e-01   +3.115058929470410e-01   +8.941410276676004e-01   +4.139062892156775e-02   +6.524001119240481e-01   +1.650453396878780e-01; +7.081424831104302e-02   +9.249513365188453e-02   -6.749674227862207e-02   +9.114846745168985e-01   +6.037200940810304e-01   +4.058381594093250e-01   +4.916029324200071e-01   +2.048305862295334e-01   +6.136894278067155e-01];
L2_L5_iAMPA_netcon = [+6.342512321835901e-02   +3.183550688686527e-01   +3.639289177016064e-02   +2.044938013902574e-01   +1.624670277283816e-02   +1.149770493223311e-01   +4.650432707810199e-01   +6.612600612969002e-02   +3.066102037888767e-01; +5.125485615137441e-01   +4.005463028590392e-01   +5.329819725055008e-01   +3.250630655353498e-01   +6.387520464467608e-02   +8.371277016038536e-01   +2.992998744988020e-01   +2.966804108933310e-01   +5.838320435625305e-01; +5.349228731143512e-01   +3.599911634301989e-01   +9.877251754883523e-02   +5.303472923447956e-01   +6.890326134101540e-01   +2.251801547967547e-01   +3.235910127411711e-01   +6.114494516277948e-01   +2.770467827905736e-01; +6.115622468365288e-01   +3.596374408195291e-01   +5.052748094596879e-01   -3.893972422439218e-02   +4.249709949149689e-01   +3.102935884606562e-01   +9.936549422185098e-02   +4.567674397223039e-01   +3.084252847102196e-01; +2.103364700629518e-01   +2.690248625240097e-01   +6.017092226337429e-01   +2.454003549619142e-01   +2.432585532870468e-01   +1.346050622558584e-01   +8.360818985646045e-01   +3.505469728442774e-01   +1.517649218235236e-01; +1.114716970737790e-01   +4.394599189640118e-02   +2.400788074780506e-01   +2.217418726612701e-01   +2.240473534160805e-01   +4.464803004034412e-01   +3.426700234132036e-01   +2.950325257681382e-01   +2.340931915067050e-01];
L5_L2_iGABA_netcon = [+3.200854450499649e-01   +3.301039321238122e-01   +4.634390310683691e-01   +6.932811538134905e-01   +5.568607043358918e-02   +3.109817960899406e-01; +3.241367261149556e-01   +4.685700905216733e-01   +7.056204550056974e-01   +5.496750217564771e-01   +8.882582744999292e-01   +3.525709632291621e-01; +7.341829228369366e-01   +3.343819822880876e-01   +8.163780084602422e-01   +2.013533451039256e-01   -4.510202769929639e-03   +7.375549079096539e-01; +4.325430390705601e-01   -8.481743778088413e-02   +3.287871250130688e-01   +1.095628780569499e-01   +8.039185562590112e-01   +5.912795966372519e-02; +2.363021545751658e-01   +1.566500280493039e-01   +7.692186570898940e-01   +1.917054143897417e-01   +4.193184968282637e-01   +2.061542089535218e-01; +1.664292928752359e-01   +6.213614403677167e-01   +3.529820870813123e-02   +3.338924351478038e-01   +5.310446605476630e-01   +1.310483394308323e-01; -5.972670278506984e-02   +4.309186837470790e-01   +5.036168860519868e-01   +4.266999294492329e-01   +6.939129550459955e-02   +3.512446038830455e-01; +4.275619630407203e-01   +2.284520334427304e-01   +2.776446321013871e-01   -1.396265552561739e-01   +4.939579073537908e-01   +5.474459250889695e-01; +1.135981226997932e-01   +4.340737057582109e-01   +1.875107148322360e-01   +1.338426821112405e-01   +6.271304639277331e-01   +5.273509253049568e-01];
L3_L2_iAMPA_netcon = [+5.921733119859278e-01   +5.365162127129531e-01   +5.696417689909350e-01   +3.137656710967628e-01   +4.619399087919341e-01   +7.867236599211547e-01; +5.604278882372845e-01   +3.109410847285459e-01   +8.227811540695003e-01   +3.620990390731436e-01   +3.326081893978344e-01   +5.617736971488470e-01; +1.891174399914027e-01   +4.309446032519377e-01   +6.562530398815206e-02   +7.861031926909414e-01   +5.527781065098976e-01   +5.635776800708616e-01; +1.491022037182585e-01   +1.065240210293056e-03   +3.153907643246565e-01   +8.407976684696793e-01   +7.142680982542495e-01   -6.745928134271334e-02; +7.395866663850064e-01   +5.551920805981820e-01   +1.951647206581432e-01   +6.459224707120115e-01   +5.486602135495922e-01   +4.583396537339328e-01; +6.533824395640797e-01   +1.425710482632058e-01   +5.172365797827176e-01   +6.239676300364297e-01   +2.986006612865529e-01   +4.331937300382294e-02; +5.078123136344431e-01   +1.925377102395865e-01   +3.632129897524903e-01   +4.023839905272195e-01   +2.236079043408755e-01   +1.570642847485268e-01; +2.535746801069793e-01   +6.888573466425510e-01   +3.207745953868228e-01   +3.511343020392029e-01   +1.670703367032770e-01   +4.613121808756986e-01; +8.883129086054509e-01   +8.050119021352278e-01   -1.181514638963037e-01   +9.387495538706217e-02   +8.469711615873997e-01   +4.293330676508055e-01];
L2_L3_iGABA_netcon = [+2.577486541431916e-01   +3.124984464899143e-01   +2.284245875959913e-01   +7.467182751473820e-01   +5.286057652504729e-01   +5.655128932469180e-01   +7.764794297331208e-01   +5.023908536137107e-01   +4.303111960784146e-01; +6.310555051632931e-01   +4.259911485247954e-01   +2.182577920909266e-01   +1.291983884720257e-01   +5.882876151348307e-01   +2.867733129494383e-01   +3.799010319198497e-01   -5.500289879224149e-02   -1.409830827369476e-01; +5.680162099612356e-01   +1.775650147071519e-01   +7.734208550839874e-01   +5.273851675423907e-01   +7.270213089326700e-01   +1.209208878544496e-01   +1.649735374102841e-01   +3.264346527634138e-01   +3.763292881334253e-01; +1.086957391197755e-01   +4.184130797552424e-01   +4.610800029837048e-01   +9.286844647060786e-01   +5.060546012716239e-01   +1.393258248088988e-01   +7.004074489841566e-01   +7.015019644526789e-01   -5.983209457355805e-02; +3.300009195147633e-01   +3.393627579629355e-02   +7.423255438519225e-01   +6.641415323275881e-01   +4.212678124048518e-01   +8.483058756148694e-03   +4.905576063066254e-01   +1.781126018506854e-02   +6.499831754042177e-01; -3.289558663207837e-02   +2.756953370966668e-01   +2.559387168815796e-01   +5.627794131153045e-01   +4.948502761734365e-01   +5.886309091905049e-01   +3.675701938785369e-01   +8.419967922500179e-02   +1.198162069401166e-01];
L1_L4_iGABA_netcon = [+3.864865234814387e-01   +7.040666009936404e-01   +1.792010214389687e-01   +1.572874176952855e-02   +8.357029936066899e-01   +2.994805324943733e-01   +2.725283877699212e-01   +4.412834187415057e-01   +1.007360359613787e-01; -2.160400161353618e-02   +7.682889104450054e-01   +5.391857869383803e-01   +8.233129515136095e-01   +4.287610834222739e-01   +1.643441213895910e-01   +4.439874269650470e-02   +3.879528839857034e-01   +4.599136985601295e-01; +6.152632177991385e-01   +6.634029752785122e-01   +4.736816338386149e-01   +2.546456631899137e-01   +6.986518350599643e-01   +1.515128686409520e-01   +3.443984597193103e-01   +1.781025271732987e-01   +2.469376231165626e-01; +9.228966659784260e-03   +6.955171598956982e-01   +3.302602066787514e-01   +7.877276820289060e-01   +4.903068890093270e-01   +4.698988362816601e-01   +5.005924801651391e-01   +3.516192057940545e-01   +9.034433031723925e-01; +4.363177301374008e-02   +2.275948495822405e-01   +2.817014035468448e-02   +4.728653281814231e-02   +3.576315603976600e-01   +1.916540731503852e-03   +3.032644103897500e-01   +3.085377456510489e-01   +6.351869430611194e-01; +7.155281491642760e-01   +4.804536027280639e-01   +6.567329446747794e-01   +7.051039074146189e-01   +3.021723148515558e-01   +7.067145776096887e-01   +3.769215335803571e-01   +1.704647850413390e-01   +4.027941431274009e-01; +2.928493002573374e-01   +5.963090719669855e-01   +5.613849627330492e-01   +7.530536292854771e-01   +6.280230923344968e-01   +1.647647877590162e-01   +7.856815394881038e-01   -3.697052455509946e-02   +2.837856521343387e-01; +3.301302294072727e-01   +4.680172434572074e-01   +3.092831808566218e-01   +4.153027157848365e-01   -5.460433827489727e-02   +2.612019686865671e-01   +7.080484023706205e-01   +3.204912901918072e-01   +5.818671710296217e-01; +5.128804078298557e-01   +1.496645953513834e-01   -5.839281346443594e-03   +3.156365926641824e-01   +3.606946559159163e-01   +3.590172713786640e-02   +2.598247256218476e-01   +5.237681897851856e-01   +2.602892317415673e-04; +7.811105849668498e-01   +7.292596463728813e-01   +5.005105660406886e-02   +7.730778480504595e-01   +4.089006248658813e-01   +3.212160404316924e-01   +2.283384436117179e-01   +4.667576442739494e-01   +7.703690437730015e-01; +5.167367323581207e-01   +5.264973838429863e-01   +3.278284902724394e-01   +5.166144827617477e-01   +5.380418497897135e-01   -1.038155369920145e-01   -1.640577102380958e-02   +8.342170335599111e-01   +4.013660132272776e-01; +7.072099049694656e-01   +2.405233354259289e-01   +7.301424193915506e-01   +4.245093939453357e-01   +3.564657973274303e-01   +6.118118849292612e-01   +5.955021056193052e-01   +5.688967178278689e-01   +4.570556416368189e-01];
L4_L1_iGABA_netcon = [+1.193859148032712e-02   +3.741575615891192e-01   +7.944912429986320e-02   +3.498324004014798e-01   +5.578320681053707e-01   +8.327519246215525e-01   +3.048080199014320e-01   +4.666378626489542e-01   +6.863731473873298e-01   +2.729659824522500e-01   +8.965801061968075e-01   +6.379792336944223e-01; +3.909313189214648e-01   +4.210729832383289e-01   +3.837034387574437e-01   +6.075098751599642e-01   -1.193094864425187e-01   -6.520295811628793e-02   +7.760102332165957e-01   +6.450720402714785e-01   +3.736982947167074e-01   +3.105612337661701e-02   +8.316135229105380e-01   +1.313686311369168e-01; +7.191055434201312e-01   +2.871075288752681e-01   +1.339610845627075e-01   +3.874533101191258e-01   +1.308730270246546e-01   +6.749426687967558e-01   +2.100921198415526e-01   +2.529963907371726e-01   +6.349684868277035e-01   +1.844898196245990e-01   +2.264935829698591e-01   +4.211628949119943e-01; +4.866483055748356e-01   +5.154783572612175e-01   +6.756134997428304e-01   +6.960275655082113e-02   +7.924093585185571e-01   +5.101368708311824e-01   +7.347212036599928e-01   +3.870747546861072e-01   +3.085199234220296e-01   +4.531191212645283e-01   +3.331644540291211e-01   +1.073109528552377e-01; +6.173453487937508e-01   +3.983833742739465e-01   +6.146810329257283e-01   +3.361973294949798e-01   +5.127979023229061e-01   +2.819397729983526e-01   +2.941462047199791e-01   +1.635899314234277e-01   +2.717686363087054e-01   +7.092819187838824e-01   +1.840664590277457e-01   +4.079899218190459e-01; +3.598414566657090e-01   +2.561524454993219e-01   +4.824819179551024e-01   +5.065601624860211e-01   +7.725320522871412e-02   +1.475697588758970e-01   +6.784248837373036e-02   +4.873341097395272e-01   +8.106765448615607e-01   +9.153580518483095e-02   +2.145313691903944e-01   +2.028718638190193e-01; +4.207933781522808e-01   +5.229641149203442e-01   +5.056795490355421e-01   +6.627987283170571e-01   +1.077240247963866e-01   +6.221655035019016e-01   +6.183951470250421e-01   +1.555893721779418e-01   +5.313917653941078e-01   +8.191901402691782e-01   +7.813314302206060e-01   +7.057220711078570e-01; +3.495361550345849e-02   +3.518534676688428e-01   +8.738043413597976e-01   +8.212371847015230e-01   +6.465299443776636e-01   +6.457041436155868e-01   +7.347489289304372e-01   +8.125024025915184e-01   +4.585711145473883e-01   +8.339931133386222e-02   +5.785039253566249e-01   +7.005816158840122e-02; +7.179535118482551e-01   +4.395101018983537e-01   +5.096074069881831e-01   -2.929054240835770e-02   +6.639088136876022e-01   +2.079053367921645e-01   +5.573165174249848e-01   +1.832156865963303e-01   +3.133883776893013e-01   +1.993498122274077e-02   +6.889749484449142e-01   +6.524510612550845e-01];
L1_L3_iAMPA_netcon = [+1.635475522803512e-01   +6.244021070855521e-01   +6.803249449763308e-01   +9.214313411611310e-01   +4.564486547418328e-01   +4.033749081413300e-01   +8.620035806207493e-01   +3.354357932452414e-01   +2.850886467876841e-01; +6.834101726040533e-01   +5.334111509937087e-01   +4.512474780910247e-01   +4.964016307625111e-01   +3.735307422054789e-01   +5.433541616625680e-01   +2.552773169876454e-01   +9.215895328030892e-01   +3.920244616259468e-01; +6.616875643034921e-01   +4.936713939690570e-01   +5.481843924987113e-01   +2.203259798900196e-01   -2.740724770895091e-02   +5.088605898775544e-01   +7.912165683061497e-01   +6.000902753368076e-01   +9.408831974471065e-01; +7.113328344695757e-01   +2.283429925707853e-01   +8.369883730852609e-01   +1.762483726484153e-01   +8.687504550072445e-03   +7.275365136848211e-01   +1.053060821247997e-01   +1.995903907574896e-01   +7.423516544030048e-01; -2.603316411080184e-02   +5.459667719152509e-01   -2.950075346363214e-02   +2.119585355189004e-02   +1.915147553936163e-01   +3.088950613001424e-01   -2.843121711619588e-02   +3.261424083654828e-01   +6.118996271227894e-01; +5.624198450211230e-02   +3.785657420317673e-01   +2.323916358219864e-01   +7.875266789127882e-01   +4.008246662275307e-01   +1.221815080533059e-01   +6.564746259772075e-01   +2.393066279734433e-01   +2.744186654134493e-01];
L3_L1_iGABA_netcon = [+6.539952882706584e-01   +1.131052087183308e-01   +5.433210437396983e-01   +1.973246733596562e-01   +2.273386992940993e-01   -1.127296992825587e-02; +5.545897291889644e-01   +2.522848932769270e-01   +5.449895351023376e-01   +2.035212680430058e-01   -8.442963653142455e-03   +3.748222568063129e-01; +1.203543584490858e-01   +6.209490257336164e-01   +1.556205517840884e-01   +1.903819933349273e-01   +5.271612838163466e-01   +1.149720475253499e-01; +6.493352240948634e-01   +1.409835247525035e-01   +8.221109584351198e-01   +2.445111925244550e-01   +7.987250482063489e-01   +5.155449418048108e-01; +1.564633672162383e-01   -1.048324381963180e-01   +7.691699249421216e-01   +7.344807688153256e-01   +2.608084743521694e-01   +2.415905047914439e-01; -1.210873821686045e-01   +5.533874071348938e-01   +4.263946490892591e-01   +5.927730842122290e-01   +1.630035025547050e-01   +5.476494094471419e-01; +2.134385832578350e-01   +1.044235819922059e-01   +3.926192685009807e-01   +2.741870387504455e-01   +5.650251305048934e-01   +6.051401173715004e-01; +8.251735890393196e-02   +4.395358124383958e-01   +3.504548246228037e-02   +6.339161418176134e-01   +5.029387233813866e-02   +1.402777489919942e-01; +3.048509371634405e-01   +5.615849840686351e-01   +2.507634295442066e-01   +4.687189463462280e-01   +1.232983060358866e-01   +3.916910530392587e-03];
L5_Input1_iAMPA_netcon = [+8.037793018014435e-01   +2.604899542715760e-01   -6.686370358462305e-02   +1.670288280605977e-01   +4.990722973739979e-01   +1.076200258851908e-01];
L6_Input2_iAMPA_netcon = [+3.800799637064720e-01   +2.484762149067743e-01   +4.262389833793174e-01   +2.769655207096295e-01   +9.111828845541909e-01   +1.626534993705714e-01];
L5_L6_iAMPA_netcon = [+3.948567643913007e-01   +5.840236504612408e-01   +2.101315001195758e-01   +4.422359869698023e-01   +1.927815095589091e-01   +7.949393123880819e-01; +3.070394141488558e-01   +8.055324011006409e-01   +2.826542009562341e-01   +1.743292056968153e-01   +5.757112394589776e-01   +7.658915866369409e-01; +2.764126063003925e-01   +8.040913745297860e-01   +2.144673340149422e-01   +6.204864017446499e-01   +7.818361431985419e-01   +5.752983619451935e-01; +2.318446453191450e-01   +5.344825011829394e-01   +2.515405548725481e-01   +7.678367297458811e-01   -6.888325558773617e-02   +8.295399755420374e-01; +3.741579492059084e-01   +3.047303726963656e-01   +5.928705538671309e-01   +2.254139204285197e-01   -9.545788788606206e-02   +6.174012081866506e-01; +5.189425535038316e-01   +2.836598854783766e-01   +4.994322055205901e-01   -6.454906221431828e-02   +5.288453209934536e-01   +3.087496775077168e-01];
L4_L5_iAMPA_netcon = [+4.328331344264717e-01   +4.154373954230191e-01   +4.822952440962941e-01   +5.535669812436488e-01   +2.898125117781791e-01   +6.473776560265390e-01   +2.006620809726655e-01   +6.190134782707867e-01   +2.920301159589138e-01   +2.153376272324462e-01   -7.596479145263985e-03   +5.224494918509172e-01; +9.161339478091517e-01   +6.230333567372623e-01   +6.081714049950430e-01   +5.712587340207209e-01   +6.082292107828775e-01   +6.449968196789324e-01   +7.751492100892701e-01   +5.625501484817872e-01   +5.109595486882171e-01   +8.043436474315300e-01   +2.664679657432424e-01   +5.732727524740151e-01; +5.083457650832277e-01   +7.994025654245070e-02   +7.236782869110704e-01   +6.532045518490160e-01   +1.048481186434059e-01   +6.198278735491513e-01   +1.033905638124176e-01   +1.676709738430190e-01   +8.223331326015811e-01   +4.669444399418213e-01   +5.857264007752996e-01   +5.762443688132801e-01; +2.815940103749410e-01   -8.691669797753557e-03   +3.774016058918982e-01   +1.797519958173781e-01   +4.578273236407446e-01   +1.465864703304934e-01   +6.767729641497623e-01   +3.278543451944517e-01   +6.785696517496691e-01   +4.475671112368660e-01   +7.973262440638507e-01   +4.120567394468400e-01; +5.555063528235006e-01   +1.893470397645749e-01   +5.755829292188991e-01   +1.548950714846931e-01   +4.878281249222834e-01   +8.255318297867490e-01   +4.679855241102180e-01   +6.916906318905521e-01   +1.676182705112202e-01   +5.724263470814885e-01   +4.424865192950606e-01   +5.866634945990349e-01; -3.867511028206103e-02   +7.668352959594291e-01   +2.876368918611083e-01   +3.829573757669571e-01   +2.347213427047519e-01   +7.152479353936890e-01   +1.051018493754695e-01   +7.944399071540387e-02   -1.150112585413661e-02   +4.754630791593142e-01   +7.683243862122905e-01   -2.166376785077804e-02];
L6_L4_iAMPA_netcon = [+4.558889717413511e-01   +1.550261904633163e-01   +3.600500807605637e-01   +3.500360507257113e-01   +7.291751177960952e-01   +4.938098143783096e-01; +3.725030336941096e-01   +3.384629822203926e-01   +1.113013726724605e-01   +1.998040863482897e-01   +4.709200986341997e-01   +3.936803434168453e-01; +4.243081624229538e-01   +2.071947103450331e-01   +8.364808292407746e-01   -4.596041655350436e-03   +3.570759986048046e-01   +7.888150869822079e-01; +1.564359144157003e-01   +8.624251742114228e-01   +7.928751399272768e-01   +5.973365895095407e-01   +4.455736328703944e-01   +5.679410997723752e-01; +1.867144660823006e-01   +1.214944806807220e-01   +4.877015045501591e-01   +4.520788711460140e-01   +4.822458649443855e-01   +3.650436320162908e-01; +3.486265954573656e-01   +4.406981584590913e-01   +5.320006780251727e-01   +4.313632716757250e-01   +2.078222030561563e-01   +6.285487577671908e-01; +4.918937734417303e-01   +3.175383401637236e-01   +5.924135113973997e-01   +4.970929845277838e-01   +2.651781037807583e-01   +5.342796274895296e-01; +6.068407059152763e-01   +7.901893693941444e-01   +4.035871053128135e-01   +1.524067598418943e-01   +1.706303765271009e-01   +3.495071052684484e-01; +3.952346944146468e-01   +2.526937830862903e-01   +8.621853841625814e-01   +2.578592391418580e-01   +8.533635060991845e-02   +4.813947651467902e-01; +2.786827435052449e-01   +2.138555889363042e-03   +7.224149942034173e-01   +9.156910219249476e-01   +8.888871722314311e-01   +2.324610446414082e-01; +7.471589544325572e-01   +2.652118631174726e-01   +3.636656768504749e-01   +2.725751538355466e-02   +2.425011015212056e-01   +1.456486945643446e-01; +3.473684284902055e-01   +9.099795195349365e-01   +2.236103616943899e-01   +7.910819401901727e-01   -8.038169068708519e-02   +1.992263977341311e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
