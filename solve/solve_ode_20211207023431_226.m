function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.253060362685085e-02   +3.628356755582254e-02   +1.701265665601596e-02   +4.069930746142066e-02   +3.233341402409922e-03   +3.140898302857948e-02   +3.178321042187274e-02   +5.134683151000195e-02   +3.066747158887943e-02; +9.646375499367619e-03   +2.588952391678077e-02   -1.489097774672024e-02   +3.048527224614513e-02   +4.848481216958440e-02   +2.274200426180821e-02   +2.759570282101713e-02   -9.026900405365988e-03   +1.393710215369090e-02; +1.883006240442449e-03   +1.431681328318525e-02   +2.543666407973037e-02   -7.332835146409445e-03   -1.743708583987686e-02   +1.769486618938624e-02   +5.699406590734502e-02   +3.831511617454193e-02   +2.324286723713999e-02; +2.519615972409926e-02   +5.247959729333388e-03   +4.226086307761340e-02   -1.119598712855006e-02   -6.672042951299835e-03   +2.680807620607947e-02   +4.448731975940128e-03   +3.264158417730983e-02   +1.396313524960719e-02; +3.020506285537549e-02   +4.687406311579192e-03   +5.351603829146032e-02   +2.950770005879718e-02   +5.482844913224761e-02   +3.314784835076521e-02   +2.884280393284773e-02   -6.503403083527376e-04   +2.991126335192579e-02; +1.347031465548605e-02   +1.708815740820017e-02   +2.141230173787451e-02   +5.286387753310860e-02   +4.110648680822120e-02   -4.066417772498490e-03   +3.906436164891407e-02   -2.362367106578545e-03   +4.573319813073352e-02; -2.329090732498468e-02   +1.511695136542649e-02   +2.885736791046482e-02   +3.148971808550671e-02   +6.997955737768000e-04   +3.083397643220410e-02   +8.451170505074814e-03   +2.472591041730537e-02   +3.711545683216498e-02; +3.355964785792260e-02   +7.006713532048041e-03   -1.401160902851460e-02   +2.363130850692059e-02   +2.524091453955063e-02   +3.328439587288044e-03   +7.389688827631804e-03   -4.826765626226716e-03   +1.116847505242696e-03; +2.383686221284775e-02   +3.355568939986832e-02   -3.980812351009669e-03   +1.898799844380297e-02   -1.524238471254332e-02   +4.198893489084466e-02   +2.279512290714358e-02   +1.001735208125295e-02   -8.789275686215989e-03];
L1_L2_iAMPA_netcon = [+2.174980286697248e-02   +4.777518137555611e-02   +1.878255565038004e-02   -3.489662249847920e-02   +5.079177388621917e-02   -1.136031980539631e-02   +3.592815290871271e-02   +2.908936409376464e-02   +1.701233348144118e-02; +3.133737078874354e-02   +2.606557034260081e-02   +4.417619307557013e-02   +2.218176005079222e-02   -2.641392075149804e-03   +2.985613767101524e-02   +4.033652988452941e-02   +4.937873306533602e-02   +8.699168006285157e-03; +3.959881048002088e-03   +1.391923049611397e-02   +4.646084833771147e-02   +1.797652801222459e-02   +6.935199476941240e-03   +1.313968081107450e-02   +3.124033037301775e-02   +5.847827786780903e-02   -5.255946164564498e-03; +1.004146603789919e-02   +3.664371717952690e-02   +2.052412871706469e-02   +2.659048066497140e-02   +1.744596434508705e-02   +1.375275385185953e-02   +3.120067182067726e-04   +7.764211858605347e-05   +3.192148833820058e-02; +1.772898147953512e-03   +5.270467796547890e-02   -1.284680673609634e-02   +2.552074896763858e-03   +4.196552062318917e-03   +2.584835330651290e-02   +6.280368520821800e-03   +3.294078833614329e-02   +2.390757492486748e-02; +2.528302034250657e-02   +1.685825479588920e-02   +1.626289349608222e-02   +8.290599617189372e-03   +4.132459161723993e-02   -7.873192724901274e-03   +2.341747135541919e-02   +4.792305936698433e-02   -6.376166851097121e-03; +4.957970075755087e-02   +4.489160129486340e-02   -3.723505759637338e-04   +1.854305457567028e-02   +2.940362991811686e-03   +3.404013625350011e-02   -9.020602976032664e-04   +3.165668555663488e-02   +6.152252673683469e-03; +2.109613548213984e-02   +1.960605657877355e-02   +4.817662813203732e-03   -2.078352810048079e-02   +6.078246632268020e-03   +2.381698399324001e-03   +3.504764010514135e-02   +2.272533439655768e-02   +2.786394369216640e-02; +4.546233328027502e-02   +3.102567282126512e-02   +8.089104045504043e-03   +3.360379319931997e-02   +8.421666713505985e-03   +5.177906981941693e-02   -1.727472360919533e-02   +4.950420603426720e-02   -8.360127609130470e-03];
L2_L5_iAMPA_netcon = [+4.573362088252986e-02   +1.703979256214800e-02   +1.245557872337591e-02   +5.142473135330177e-02   +4.074501203869349e-02   +4.849705507533804e-02   +5.250233121654496e-02   +4.173427319316683e-02   -1.611511166983660e-02; +1.221599874026789e-02   +3.781381379735187e-02   +2.261952457637153e-03   +3.833797058721178e-02   +4.759601179603193e-03   -9.458671459276037e-03   +7.344872170873831e-03   +1.920857484896170e-02   +3.924937030837424e-02; +3.398423244179617e-02   +3.539969022427035e-02   +6.609865477557013e-03   +4.944902983374321e-03   +1.450877601656229e-02   +3.618693864990516e-02   +6.038322648466750e-02   +3.540483830257587e-02   +3.109363500971489e-02; +5.334611099384230e-03   +3.769823272384708e-02   +7.953832610766534e-03   +4.341552172385738e-02   +2.665364292060395e-02   +3.905756826327205e-02   +6.600385647169402e-03   +4.853138040777783e-02   +2.414861944979754e-02; +7.474472093185363e-03   +8.587187110710572e-03   +8.183483428711263e-03   +1.980609990409078e-02   +3.199947104516721e-02   -1.933413896197212e-03   +1.937409279255472e-02   -1.354557512503198e-03   +1.850175803697546e-03; +2.674814843774136e-02   +1.298635244265623e-04   +1.346556937706653e-02   +5.408786957736365e-02   +1.516300484204304e-02   +2.414747613886696e-03   +1.287321826048565e-02   +2.907383846338359e-02   +6.120957923310404e-02];
L5_L2_iGABA_netcon = [+1.058003217506645e-02   -2.108957743693764e-03   +1.577917203732487e-02   -5.500076033073320e-03   +2.995313571525652e-02   +6.192420802224015e-02; +5.405328374983320e-02   +6.183522972303615e-03   +3.385815853430772e-02   +3.068963409316369e-02   +3.573040198621830e-02   +3.317100673648189e-02; +7.049358084894165e-02   +5.150283859217178e-02   +2.836463021711567e-02   +1.193735728041444e-02   +1.008522230091617e-02   +2.028509811872591e-02; +1.660823180064858e-02   +1.187664430295758e-02   +2.039354684164300e-02   -6.603531723947889e-03   +3.438227808358538e-02   +1.875511076837556e-02; +7.416603034778172e-03   +3.893615301888097e-02   +2.124213181785015e-02   +3.382474019417833e-02   -8.594585077681110e-03   +3.324460022225155e-02; +1.411009085368749e-02   +2.252527483481703e-02   +2.521087894992674e-02   +3.010830372206451e-02   +2.674086122228423e-02   +8.067721000132359e-03; +5.102806538425814e-03   +1.018069053719733e-02   +2.626593758119179e-02   -1.841792674062485e-02   +1.812593553062763e-02   +2.413483670258709e-02; +4.693707464505466e-02   +2.699361754864276e-03   +3.425919399198753e-02   +5.411483713362533e-02   +3.538701519742417e-02   -7.992367541602756e-03; +1.301143447308500e-02   +2.815283335733557e-02   -2.245828138361074e-02   +2.351928135295482e-02   -1.738857670588659e-02   +2.066028693636913e-02];
L3_L2_iAMPA_netcon = [-8.984320293545421e-03   +1.387269400697330e-02   +2.111994027930215e-02   -2.139191340573216e-02   +4.034932333366689e-02   +3.229680728229750e-02; -1.751324206821272e-03   -1.003789565363471e-02   +3.568144467880181e-02   +7.118021713162061e-02   +1.241976362093730e-02   +1.996482363085900e-02; +4.428871658549648e-02   +3.355953152173576e-02   +1.418776163180761e-02   -1.650771324426313e-02   +2.072433013139511e-02   +1.934642301747076e-02; -1.251664063778472e-03   +9.775610616197822e-03   -3.560382910457152e-04   +7.987388053933077e-03   +9.518588503983533e-03   +4.893056975600898e-02; -1.504429789206575e-02   -8.588766320070645e-03   +4.921917425953813e-03   +3.207053336640776e-02   +6.236147685225344e-02   +3.992469196440467e-02; +5.918132456396521e-02   +9.229425396518675e-03   +1.551206604904122e-02   +1.534227694307805e-02   +1.272695630927102e-02   +2.125541709787252e-02; +2.024153531068375e-02   +2.450617828997766e-02   +1.206978233779221e-02   +6.432864554510649e-03   +1.118805272710943e-02   +9.700536517603905e-03; +5.453381759962174e-03   +4.823241750398380e-02   +2.725955245020906e-02   +3.864716145909872e-02   +1.427432670829558e-02   +9.073893159083010e-04; +2.145275049575140e-02   +1.598639814373062e-02   +1.417787561478482e-02   -1.082500159583048e-03   +3.167240685631321e-02   +2.584899555426550e-02];
L2_L3_iGABA_netcon = [+2.222484007994987e-02   -8.613109246861046e-03   +3.550817762924947e-02   +2.595004778820120e-02   +2.959237872594631e-02   +1.581865024603437e-02   +3.322841378572261e-02   +5.846669896641007e-02   +4.903428318799345e-02; -9.143332431167970e-03   +6.522610213781149e-02   +3.434776217021139e-02   +3.769674937994733e-02   +3.887326747396445e-02   +1.445901159474547e-02   +2.959152732985121e-02   +2.880749794606321e-02   +3.383561251964077e-02; +1.714489063799574e-03   +2.693246184168911e-02   +1.028065949600995e-02   +1.877617444937092e-02   +3.137468469646291e-02   +4.712463274300671e-02   +2.224109912773325e-02   +5.379470950731666e-03   +2.698374420626619e-02; -8.337670068723487e-03   +3.349028012255836e-02   +1.923654408749666e-02   +2.858040039796275e-02   +2.489021162495012e-02   +3.488125876699867e-02   +9.899057855823739e-03   +1.422979328130589e-02   -1.956232558698206e-02; +3.104318745247220e-02   +4.249813807507011e-03   +2.262614540699151e-02   +2.675526530395641e-02   +2.533687699256004e-02   +3.475801514199173e-02   -6.952039944344259e-03   +3.680657931543992e-02   +7.374858872595343e-04; -4.353233773987978e-03   +4.157010121519402e-02   +4.352074465615314e-02   +3.130384419172772e-02   +9.678008675901229e-03   +6.205487902099566e-03   +3.513134765893990e-02   +3.740135415304922e-02   +4.728533994412490e-02];
L1_L4_iGABA_netcon = [+2.083815858711835e-03   +1.983539608553736e-03   +1.272606394331584e-02   +2.625799553112167e-02   +3.370942346690308e-02   +3.111969548838017e-02   +3.624939203504440e-02   -2.437118440684371e-02   -9.803395552401336e-04; +3.025484314014440e-02   +3.367943671754918e-02   +7.123725099201592e-02   +2.822542824702691e-02   +1.747177572125581e-02   +2.651609716631211e-02   +5.162998180246733e-02   +2.300578454589332e-02   +3.049695542265916e-02; +2.061340166110961e-02   +1.491737552996860e-02   +3.701842713552825e-02   +3.011567306838942e-02   +4.199040049245577e-02   +7.795450327541787e-03   -2.115517226537227e-03   -2.499644427854177e-02   +2.539612611360072e-02; -3.836201464592915e-03   +2.047221776213971e-02   +5.292364379604042e-02   +2.569932302032295e-03   -1.318701529526961e-02   +2.563884829788687e-02   +3.985242203075014e-02   +3.580734423534108e-02   +4.611816365569592e-02; +1.587504094565413e-02   +5.337553753383145e-02   +2.521151695601802e-02   +4.003379874657765e-02   +4.837046931161353e-02   +4.120701539456131e-02   -4.690949630474164e-03   +3.276925769787373e-02   +1.397717899758868e-02; +2.071412431136072e-02   +1.593544068488734e-02   +2.968901734935213e-02   +5.055673175909067e-02   +2.635249759536145e-02   +5.688869027633583e-02   +1.259508198253536e-02   +1.414966087121125e-02   -8.303182187834504e-03; +5.928209928133310e-03   +4.378839725198689e-02   +6.437086207491227e-03   +2.796075209542093e-02   +6.986522741110725e-02   +1.444821571128192e-02   +5.173089599385517e-02   +3.408975597396557e-03   -4.439870189025267e-04; +2.046398332505219e-02   +4.382718201739721e-03   +2.775814627251760e-02   +1.207343292721813e-02   +2.246640748195599e-02   +2.046378936674965e-02   +4.102050815829068e-02   +5.016590288799748e-02   +3.163036769619201e-02; +2.269187291580365e-02   +1.511634077192978e-02   -1.489523928948844e-02   +2.532068441739367e-03   +2.688226456418144e-02   +5.372931177609652e-02   +1.623074086210303e-02   +1.361072229043527e-02   -1.896001375746954e-02; +2.479276249888846e-03   +3.207484021724358e-02   +1.933374438569721e-02   -1.228283366942586e-02   +1.989240177053333e-02   +1.047108578790904e-02   +1.479075403520981e-03   +4.660793623958777e-02   +3.372416605420610e-02; +5.388346855477727e-02   +2.642777980235924e-02   +9.629739180785021e-03   +1.914560482008157e-02   +1.228081869796562e-02   +3.960079317029186e-02   +1.058264939319965e-02   +2.897753344274979e-02   +4.199710441183696e-02; +1.621178510346235e-02   -6.678139000594087e-03   -2.307242046253174e-02   +5.787330906827193e-02   +3.061316972136436e-02   +3.517118805864862e-02   +3.011268321895643e-02   +2.530302184044408e-02   +3.644469319000435e-02];
L4_L1_iGABA_netcon = [+3.122499204799258e-02   +9.838275889950052e-03   +2.007722065726393e-02   -3.442854254797928e-03   +1.460660035342652e-02   +4.997153632925529e-02   +1.103980562250581e-02   -1.973796388374140e-03   +3.676470498362255e-02   +4.483774806487191e-03   +1.107930608038737e-04   +5.767217690504678e-03; +3.075791962062270e-02   +1.410119297493604e-02   +5.722961235265887e-02   +3.033002660304662e-02   +1.279911235061839e-02   +1.731378194596457e-02   +4.546993994885766e-02   +5.506592938466085e-03   +5.757818968334510e-02   +1.030852075114079e-02   -3.071350309930804e-02   +1.367336993325106e-02; +1.488871304313429e-02   +2.601970623128761e-02   +2.828369451692968e-02   -9.759857882834535e-03   +3.067700111343796e-02   +3.300157815229243e-02   +7.151181178144273e-03   +3.363831586568061e-02   +3.071785884817863e-02   +2.171019182734084e-02   +2.166239482998344e-02   +9.390505221395767e-03; +3.717389969267786e-02   +1.050741247289952e-02   +1.501485563498619e-02   +3.400494872554179e-02   +1.790961531783840e-02   +2.259644909332601e-02   -1.709224080606957e-02   +1.137245736509425e-02   +1.460632390557929e-02   +5.368938996121082e-02   +1.989373275440648e-02   +6.061738423274815e-02; +4.573609269267098e-02   +6.861101789691353e-02   +3.446943448934980e-02   +1.755540481089925e-02   +3.511964180888662e-02   +1.382927540020762e-02   +7.161000662164693e-03   +1.512697679975484e-02   +2.799493080882482e-02   +4.074481121614380e-02   +3.193648294420875e-02   +4.263799029104250e-02; +8.270478162939906e-03   +1.224866395917951e-02   +2.809762277916612e-02   +5.513169826300223e-02   -3.303684096816833e-02   +2.215516805854976e-02   +1.543696954460123e-02   +6.900989705561361e-02   +1.942364410518338e-02   -1.437933825555749e-02   -3.739060788954581e-03   +2.514047353412958e-02; +2.143298964708237e-02   -2.964981185950607e-02   +2.785702225263372e-02   +3.764174416778573e-02   -3.652200259693962e-03   +3.399761738052641e-02   +1.236333341228170e-02   +2.427765129468301e-02   -4.226177284542380e-03   -1.168584724332867e-03   +2.975975400162628e-03   +4.651169104730198e-02; +6.406694878015444e-02   +4.546205837452988e-03   -1.640866457018605e-02   +8.935333741299812e-03   +2.055610356298688e-02   +1.154326159842648e-02   +2.883569454095221e-02   +4.667795020824315e-03   +3.295213633231460e-02   +5.802789226961368e-02   +4.907655169277211e-02   +2.717919655464254e-02; +3.424208317062905e-02   +1.216700825738164e-02   +2.031058943894740e-02   +8.471388933220421e-03   +1.353691302494374e-02   +2.572022124667647e-02   +1.727792245336164e-02   +6.024888338980091e-02   +5.353156546606951e-02   +1.797637142652229e-02   +1.699158832645934e-03   +6.135277697274779e-03];
L1_L3_iAMPA_netcon = [+2.763610020395979e-02   +3.788377824939604e-02   +3.929299220113514e-02   +3.770055847307922e-02   +1.844865932769425e-02   +2.877267418002859e-02   +3.369348724797714e-02   +3.936341415700605e-02   +1.684012095233270e-03; +1.431541822019257e-02   +4.004691593425853e-02   +2.158480511422829e-02   -1.092599292558998e-02   -5.234998949388142e-04   +7.012600855361369e-03   +7.330426241139040e-02   +1.021220315665504e-02   +4.457332569343132e-02; +2.984457416464671e-02   +2.097052950598487e-03   +4.105153198426094e-02   +6.232123936989798e-02   +3.577482322031730e-02   +3.788539360614947e-02   +3.360771546110042e-02   +6.495198258271494e-02   +2.490507080135038e-02; +4.351556341488714e-02   +4.524991409086855e-03   +1.763925460330693e-02   -1.015599900308814e-02   +3.775962671245869e-02   +3.195072110373751e-02   -1.189232807966116e-02   +2.214194120693039e-02   +9.412997280026141e-03; +2.462265573421840e-03   +2.566189642179158e-02   +2.476887425874785e-02   +4.879131333502275e-02   -3.379218945042048e-02   +2.775002554637138e-02   +1.030694012034387e-02   +1.431484995582094e-02   +1.639207365629073e-02; +2.928406842633758e-03   +2.396852565629015e-02   +1.581286240152679e-02   -4.738847247783208e-03   +1.690426190468586e-02   +2.713432817869999e-02   +2.754300387503796e-02   +1.156357208083004e-02   -1.328372107425909e-02];
L3_L1_iGABA_netcon = [+4.798896253291324e-02   +4.095974255051286e-02   +2.056822290332145e-02   -1.672819263331355e-02   +1.892940101456424e-02   +2.135119633669403e-02; +9.097281092293845e-04   +2.578146120859103e-02   +1.027866821272143e-02   +1.129831207813905e-02   -1.617871778527464e-02   -1.832719549825945e-03; +2.816839453051094e-02   +1.876056291134056e-02   +2.392652786983748e-02   +2.004332632907598e-02   +5.148844786840029e-02   +4.841876221696312e-02; -1.435256552635579e-03   +3.877574865483629e-02   +1.578737478038965e-02   +2.534306091089786e-02   +5.545379178360164e-02   +3.290225497858505e-02; +2.367212077334006e-02   +8.085143774514456e-03   +5.723201656591858e-02   +5.770647288128320e-03   +3.059004106090934e-02   +3.434852598247536e-02; +5.825986954026834e-02   +1.352482234103844e-02   +1.806542332678576e-02   +5.045413870272476e-02   +5.026339128428609e-02   +2.973125781719842e-02; -5.989193412982027e-03   -1.250312563891769e-02   +2.555629910340271e-02   +2.852199559468472e-02   +1.772597385613606e-02   -5.456133930092744e-03; +2.184482543627239e-02   +3.218288331035059e-02   +4.280789416421561e-02   +9.861784550743794e-03   +2.129377105359287e-02   -4.738677840336779e-03; +1.166719538856253e-02   +5.541098541443814e-02   +2.901937498511070e-02   +3.422740676559501e-02   +2.910069623613944e-02   +5.968547030295809e-02];
L5_Input1_iAMPA_netcon = [+2.046242189033672e-03   +2.978301275771014e-02   +1.638582859690785e-02   +4.391379158209147e-02   +7.609843158649131e-03   +4.119193451982678e-02];
L6_Input2_iAMPA_netcon = [+5.364165148247872e-03   +3.782239087848101e-02   -3.561134567626589e-03   -1.517333347334868e-04   +1.767326685947674e-02   +1.272773430235177e-03];
L5_L6_iAMPA_netcon = [-2.313732219088885e-02   +4.532061038517442e-02   +4.623545612159700e-03   +5.243782440827805e-02   +2.779216183811990e-02   -5.755120502050522e-05; -2.955819545452721e-02   +2.879657578073794e-02   +3.120864772788093e-02   +3.953357523341661e-02   +4.187788151644808e-02   +4.213005260768250e-02; +4.299794251788060e-02   +4.263074427627596e-02   +2.184699680400232e-02   +2.863981090520126e-02   -4.530888579215147e-03   +3.483997012891349e-02; +1.764279300837638e-02   +5.447723690148291e-02   +4.014332729925090e-02   -2.469714707802622e-03   +3.826399777038408e-02   +3.043981178958674e-02; +1.364748275455477e-02   +4.954706722598284e-02   +5.082205703203516e-02   +1.157406408459983e-02   +2.295710496672539e-02   +3.268893422692246e-02; +2.412677131036954e-02   -5.202001625872249e-03   +6.044304276395095e-02   +1.037601807418479e-02   +5.703020401005199e-02   +2.852594900998078e-03];
L4_L5_iAMPA_netcon = [-3.100036251006145e-03   +2.311494978375823e-02   +6.066663729839693e-02   +2.831076850276863e-02   -1.815415203498816e-06   -8.171406017789271e-03   +6.428802043503198e-02   +2.746226641955329e-02   +3.951884719503362e-02   +3.944439904477835e-02   +5.920462150542854e-02   +2.539150020188575e-02; +1.695851972845813e-02   +2.881712658677468e-02   -1.302687822566453e-03   +4.088080287304069e-02   +4.744564878335455e-03   +2.242644967067694e-02   +5.678027107565574e-02   -5.266700355094285e-03   +7.674007780218286e-03   +1.578466935677071e-02   +3.918248857326725e-02   +2.745658617013717e-02; +1.672368726763551e-02   +2.407910354733351e-02   +2.422532635924187e-02   -4.404539942883971e-03   -1.018034772442484e-02   +4.680020376016836e-02   +1.187525884456488e-02   +2.266901520230379e-02   +3.814835120336319e-02   +2.865791991769412e-02   +3.981906396810830e-02   +1.197814124146037e-02; +5.626232946763784e-03   +3.110889747462285e-02   +1.808226176912924e-02   +8.441753884636293e-04   +1.572847004968838e-02   +2.991671971508655e-02   +3.393605960985804e-02   +2.574916452884313e-03   +3.193651204494300e-02   -1.373559488744320e-03   +7.187487470059907e-02   +3.227861222117507e-02; -1.187575437505270e-02   +3.161284625726934e-02   +2.469569262876281e-02   -4.540122301708606e-03   +3.575541092571660e-02   +4.537972114289432e-02   +5.034534641109069e-02   +4.662288319715160e-02   +2.863429557371751e-02   -7.392379845304291e-03   +3.161395423888276e-02   +1.437318847310478e-02; +3.285834649882757e-02   +2.391089021879044e-02   +1.613478614104443e-02   +4.150968339226095e-02   +3.432357455310715e-02   +3.919692430382074e-02   +4.706068084368031e-03   +2.537683285482797e-02   +7.629552936080360e-03   +6.720196307161146e-02   +1.174349883813162e-02   +5.966471780133147e-02];
L6_L4_iAMPA_netcon = [+5.097783316509134e-02   +4.249355235529600e-02   +1.671088224666665e-02   +5.635303177741365e-03   +5.039309720879882e-03   +3.635667394870397e-02; -4.051226077714678e-03   +2.299217492695586e-02   -9.397922809105152e-03   +7.349632104617796e-03   +1.123015254856639e-02   +2.079940971162039e-02; -4.466678277123008e-03   +7.289240027900314e-03   -5.346068643109122e-03   +2.750710195045223e-02   +5.027913543316719e-02   -8.755156840971948e-03; +5.137672825734768e-02   +4.838690900815722e-02   +2.598306494600232e-02   +3.139877668613696e-02   +5.040025080772989e-02   +1.605839142829980e-02; +7.832537268126852e-02   +8.096741097167981e-03   +1.814474947753607e-02   +5.249057016512692e-04   +4.185877652841097e-02   +5.431250180525050e-02; +4.881600798239641e-02   +4.678979099415864e-02   +3.341966070408710e-02   +2.700153323999594e-02   +1.018418212013397e-02   +5.295182782635412e-02; +2.327851700034565e-02   +4.207133571016677e-02   -3.917949168887962e-03   -7.137818549700147e-03   +5.840202472103430e-02   -2.869886311348796e-03; +2.414736649021277e-02   +4.563098328402959e-02   +4.967196078614927e-02   +4.402220635566410e-03   +1.219292114473618e-03   +5.563885948830001e-02; +1.525402641777400e-02   +1.614522308307665e-02   +3.521692148135207e-02   +1.979571458602340e-02   +1.089850046235883e-02   -7.547586590136539e-04; +1.536233957033362e-02   +1.477414299829105e-02   +4.455031089526333e-02   +4.655338806202255e-02   +4.809317191751217e-02   +2.552689793908098e-02; +5.344748715815575e-02   -9.351498891305897e-03   +5.370729984696637e-02   +8.246669764465364e-05   +2.135507574725972e-02   +1.974129463356811e-02; +3.465113910386990e-02   +3.633428563884707e-02   +2.138019257843609e-02   -5.148023205894385e-03   +2.007274122649318e-02   +2.776129905045128e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
