function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-8.327438762473474e-02   -3.852031492325837e-02   -9.879987218484240e-02   +8.877443263811902e-02   +2.739927571214060e-03   -3.119165360278599e-02   -4.620837015583672e-04   -6.568862939127566e-02   +4.347510147617722e-02; +1.699946990771320e-02   +1.156991930675106e-01   +1.803044989117467e-03   +5.657685596026134e-02   +4.403732327192904e-02   -1.285722205003152e-02   +1.682101358571048e-01   +1.789087359148985e-02   +6.134957914223084e-02; +5.532769257058763e-02   -7.427896543326451e-02   -4.958110474299073e-02   +1.557692533403609e-02   -1.043258742732166e-01   +2.714049656024803e-03   -3.536414478845479e-02   -6.407481813530233e-02   +5.224281045656952e-02; -2.794828750599818e-02   -4.841757032992947e-02   +1.168884025644190e-01   -4.294033584566954e-02   -7.489960059573494e-02   +5.703836044760099e-02   +2.847461621364857e-02   -7.223526812508351e-03   +1.394783073142024e-01; -1.017311528042397e-01   +2.603458732939835e-02   -4.320339640473350e-02   -9.134320766778514e-02   -9.886787414416580e-03   -1.172586494610089e-03   +8.569211970882115e-02   +5.900509964419427e-02   -2.076337440662468e-02; +1.146293093109690e-01   -2.612036660070523e-02   +3.549534302841613e-03   -9.534991324894435e-02   +2.969161047012433e-02   +2.105401723483877e-02   +6.583890457883887e-02   -4.981970284378791e-02   -3.820225096442473e-02; -3.715047691232588e-02   +9.785174232956476e-02   +1.465765833035878e-02   +5.973720170614492e-02   +4.523025869228106e-02   +3.967448408912908e-02   -2.277622779162402e-03   -1.000760384454787e-01   +3.144946005195980e-02; -2.606300398334482e-02   -1.317038891974213e-02   -1.150424030658709e-01   -1.173210514972807e-02   -1.508332910394403e-01   +2.171740097538932e-02   -7.175457665525267e-02   -2.928309117350190e-02   +1.224217623135566e-01; -1.274534902728820e-02   -4.239540371002201e-02   -1.393001979351545e-02   -1.411487490202482e-01   -6.175656580538338e-02   -6.043913126183019e-02   +4.145455931831075e-02   +1.292519018284522e-02   +3.043111396987535e-02];
L1_L2_iAMPA_netcon = [-7.549191696173000e-04   -1.137859250565102e-01   -3.140583419518271e-02   -1.001137875529547e-01   +4.630059247307976e-02   -1.554717441454678e-01   +4.253812675469828e-02   -2.285870919638749e-02   -6.083480378393934e-02; -8.087928268850948e-03   +2.181571740728889e-02   -7.299692180479250e-02   +6.025127761955110e-02   -1.158872259656835e-02   +1.049251243460988e-01   -2.907764881206478e-03   -1.623183659316502e-01   +4.688924675197231e-02; +7.470959672793021e-02   +5.698037111068290e-03   +4.084088208012822e-02   -3.864846276617449e-02   -2.990575184199164e-02   +5.083882036655930e-02   +1.383999348426369e-01   +7.126185011707566e-02   -1.943906885281826e-02; -5.351917661131361e-02   -1.196054107089251e-01   -8.501392538794797e-02   -6.319596995349648e-02   +9.237601669811310e-02   -5.025519411597203e-02   +7.851475016256335e-02   +8.889688378932054e-02   +3.287189574384031e-02; -4.326027974450742e-02   -8.663724024076593e-02   -4.266040412127208e-02   -1.791044989575191e-02   -5.251196934092228e-02   -9.480940829276478e-03   +9.895415390359409e-03   +6.255330785402241e-02   -2.190526522931507e-02; +1.479136158871006e-01   -3.966415500495314e-02   -4.234740181014003e-02   +1.229898777013385e-01   +1.335542970777452e-02   +4.660057416970369e-02   +4.155806538801787e-02   -6.242591921451011e-02   +6.708477658603904e-02; +1.003052079572380e-02   -3.898598059020838e-02   -1.002327605785118e-01   +7.418781099348618e-02   +1.601116073316045e-01   -1.175194453117020e-01   -2.314198807148718e-02   +4.151820500189096e-02   +1.196053969456936e-01; -3.950981265861313e-02   -6.351468208150433e-02   +5.162313722332519e-02   -2.786176316262743e-02   +1.185159405479657e-01   +4.089455064154277e-02   +4.268465963462784e-02   +2.155210584431342e-02   +9.729508769510717e-03; -1.023948781862294e-02   +3.461693660836518e-03   -9.568083079171544e-02   -4.881737147832416e-02   +2.634965995252641e-02   +2.456677555550314e-02   +6.770270648419389e-02   +6.237290300018671e-02   -1.187161554885458e-01];
L2_L5_iAMPA_netcon = [+5.403600731143572e-02   -9.038308332246395e-02   +6.411516696798094e-04   -1.120898874347629e-01   +4.429688784463463e-02   -8.694597283602178e-02   +8.128559381453195e-02   -1.053043401306389e-01   -2.475070186472647e-02; +7.778737726789585e-02   +6.299896294079896e-02   +1.414657480384639e-02   -5.577284693850558e-02   +2.934504423150949e-02   -1.129755305811958e-02   -7.356915499089256e-02   +1.033211257545622e-01   -4.273696595325383e-02; +3.739317216618224e-03   +5.313805168682470e-02   -1.094687120544725e-01   +9.961613121188560e-02   -3.786922759050489e-02   -1.476014135987817e-02   -4.633775342667364e-02   -1.624825430781904e-02   +4.645118705168732e-02; +5.459467542899477e-02   -2.093777183448663e-02   -2.113743669501472e-02   -8.340133247104252e-02   +5.741671129128052e-02   +8.939554949350752e-02   +1.537360986822869e-03   +6.549844205491592e-02   +2.887789935935378e-02; +1.277847831462179e-01   +7.528191116790740e-04   -3.766433827897163e-02   -7.008615990050739e-02   +8.068112021847258e-02   +6.781204668592337e-03   -8.317152440229443e-02   -6.008525657599375e-02   +7.303893744352955e-03; -9.021841391987044e-02   -1.312369379304870e-01   -3.853173125946888e-02   -1.229381775085322e-01   -3.075083431083595e-02   +1.390587150381032e-02   -3.817311425830480e-02   -2.752453716530338e-02   +2.130189816542681e-03];
L5_L2_iGABA_netcon = [+1.257139846876584e-02   -1.026515042226893e-01   -7.675544394269835e-03   -1.963155657661225e-02   -5.326979192110111e-02   -7.148643603809195e-02; +1.177922181055938e-01   -9.019683675295040e-02   -1.367622809965805e-01   -7.127150543441683e-02   -1.887747190719871e-02   -3.302089853533828e-02; -4.903296384945541e-02   +3.899303708501473e-02   -3.168929044287924e-03   +2.466807900446938e-02   +2.862068295658828e-02   -1.541916332936403e-02; +3.803440750847945e-02   -3.253814689411950e-02   +3.557867209705331e-02   -4.853300208810776e-02   +9.307871893591427e-02   +2.207202399287183e-02; +4.354865234103844e-02   -5.944513571781986e-02   -1.698059912749696e-03   -1.847675304742636e-02   -1.207461706032222e-01   +9.551607392165694e-03; -6.536778448164357e-02   +8.387904918022958e-02   +1.163885278154446e-01   +6.697300892670149e-02   -4.291287705115186e-02   -5.411735780849986e-02; +8.611238727014664e-02   -4.083749844169820e-02   -1.367988383078110e-01   -3.494240305773065e-02   -6.004957628063470e-02   +5.507634945252076e-02; -6.596182670871495e-03   -8.619799536802167e-02   -7.864661797877864e-02   +8.812654725545099e-02   +2.643204379256284e-02   -5.502709981919122e-02; +3.915261202156077e-02   -8.158820938031641e-02   +1.095501590236497e-01   +8.775334978214611e-02   -2.597222889438155e-02   -6.778186478753627e-03];
L3_L2_iAMPA_netcon = [-3.954529508590759e-02   -6.908555887943260e-02   -1.228446513841026e-02   -2.637069529162381e-02   -1.124212626650960e-01   +6.870176577792171e-02; -2.970782492751675e-02   +1.327201408857943e-01   -1.390732717120094e-01   +3.199222638869020e-02   +1.277042349329958e-01   +1.169895231939535e-01; +9.470292796658016e-02   -9.034562819700278e-03   +1.322818227077387e-01   -1.072046321136479e-01   +4.114303478560359e-02   -5.484300451701949e-02; -1.907999478574737e-02   +5.017675455288104e-02   -9.595095314149224e-02   +2.660433285145591e-03   +1.373961233792674e-02   -1.419976565122819e-03; -9.272725862658903e-03   +3.047007422039900e-02   +4.154481807819049e-02   -3.589391839964134e-02   -9.814861212698596e-02   +1.008911605544001e-01; -1.204444425367248e-01   -1.579038448636306e-01   -3.794471950581994e-02   +1.247382696476632e-03   -1.233473443808458e-01   +8.074377576258135e-02; -3.342060699637064e-02   +6.888428965323878e-02   +9.409409344862119e-02   +4.076961051615424e-03   +4.559214240035001e-02   -9.740477477535175e-02; +2.735388252922584e-02   +4.970812771875813e-02   -8.104560677567881e-02   -8.802135869132928e-02   -1.167793308363166e-01   +2.318931104323346e-02; -2.340194859296069e-02   +9.449787720110459e-02   +7.587765092753375e-02   +5.118164455938815e-02   -9.139936477596131e-02   +8.783774216811338e-02];
L2_L3_iGABA_netcon = [-1.009148662054798e-01   -2.280621231759798e-02   -2.736613017789224e-02   +1.170369753855972e-01   -9.291413267698974e-02   +1.857285874881171e-02   +1.387502153804746e-01   +3.263498565347832e-02   +3.407341690756559e-03; -5.238150536951913e-02   -1.260577189087248e-01   -7.446106215038252e-03   +5.499966839264803e-02   +3.987143580121928e-02   -1.009279470870644e-01   -4.143556439684831e-02   -7.521580772346824e-02   +2.351583912646611e-03; +3.088061652591585e-02   +1.305344748587677e-02   -9.896525328511169e-02   -1.042160280989335e-01   +2.682835358897480e-02   +5.990701918439197e-02   +5.619549222448753e-02   -1.055820726322651e-02   -6.630449391538584e-02; +8.045004894290070e-02   -7.513166006929897e-02   +1.647827297495808e-02   +5.608422963876942e-02   -4.673061583911014e-02   +5.898411210833005e-02   +9.838886437399906e-02   -3.671309550094012e-02   +9.763136715373244e-02; +1.217693749297580e-01   -9.101532847775748e-03   -6.789325935531433e-02   -3.945514813298442e-02   -1.241134228662796e-01   -2.718806334795610e-03   +6.235386850499647e-02   +1.314927057258711e-02   +4.661821097481009e-02; +6.350552543513421e-02   +7.225099570913998e-02   +7.426625935318996e-02   +3.249253845442276e-02   -1.278105944296691e-01   -2.933596141490628e-02   -6.136028128141174e-02   +9.020074770969690e-02   -5.673181982589597e-02];
L1_L4_iGABA_netcon = [+1.618761862652953e-02   -7.347174931446069e-04   +8.521099109432549e-02   +5.450641756374583e-02   +2.855121996992160e-02   -1.236048228959720e-01   -3.799754760321379e-02   +3.641552889553731e-02   -4.771442360875514e-02; +1.095579383815836e-01   +7.969829286882285e-03   -1.003608936121350e-02   -4.546432115779719e-02   -1.180640086118233e-01   -4.395225983591567e-02   +2.096009399855601e-02   -4.280589838501933e-02   +8.957996111900689e-03; -6.236016833165544e-02   -5.632825443055027e-02   +2.712145306177035e-02   +2.072403429997313e-02   -9.039753365526194e-02   -9.533565959204207e-02   +8.384134762857919e-02   +3.554854197868870e-03   -6.806931304493009e-02; +2.786768029080816e-02   -2.646859570634301e-02   +1.312307203533321e-01   -4.239391706386048e-02   +3.332598307059196e-02   +2.026546250721538e-04   +8.831273259518367e-02   +1.115825615350282e-01   +1.143765142228681e-01; -3.688314762712377e-02   -1.244405666810135e-01   -8.488326984324696e-02   +7.369436421181831e-02   -1.089284028135652e-01   -3.466151527611537e-02   -1.469579755297868e-01   -8.276338364183392e-02   +1.346833239598533e-02; +9.267060134040413e-02   +1.054442921999430e-01   +1.923883562556443e-02   +7.239655291106631e-02   -3.586560679170905e-02   +8.407540282973645e-02   -9.110872553778641e-02   -6.609822463597456e-02   -6.934428439397400e-02; -1.862479861069962e-03   +1.295058647101388e-01   -9.973830725433995e-02   -1.169016093668445e-01   +3.128753611513213e-02   +2.697927834020288e-02   +7.891347196309541e-02   -7.938675390462011e-02   +1.512632192039661e-01; +6.074183002987226e-02   +1.472148790307048e-01   -4.638665054721348e-02   +6.298993959424276e-02   -7.971151605794901e-03   +1.140949348058710e-01   +7.374948640724342e-02   +1.788446659740434e-02   +3.445708214057230e-02; +5.712850630119778e-02   -1.524418980006313e-01   -4.114016832030465e-02   -6.832063790307362e-02   -4.861194098360132e-02   +4.353126238112903e-02   -8.826487064930554e-02   -1.072697972805525e-01   +1.023803418882863e-01; +1.069307360276164e-02   +5.693896720041956e-02   -7.320235637178603e-02   -2.306327237063706e-04   +1.100633425452819e-01   -1.075273714877883e-01   +8.171691238729578e-03   +4.165216371756340e-02   +3.719710124955544e-02; -5.875999437398713e-02   -2.070661419837818e-02   +6.728464559906881e-02   -6.602566280158109e-02   -3.819662944025341e-02   +2.067811424750128e-02   -1.525587167785577e-01   -5.015593172577257e-03   +1.170366945866010e-01; -4.433086858524991e-02   +1.052005160749780e-01   +1.249520108777771e-01   -4.066575898767470e-02   +2.419476577569780e-02   +1.638940081203759e-01   +8.902115084596329e-02   -1.058817180319858e-01   -7.200357569949747e-02];
L4_L1_iAMPA_netcon = [-9.712235382669845e-02   +1.397251330156443e-01   -2.175526240499174e-02   -5.634008322562084e-03   +1.609176800396505e-02   +6.162644307079226e-02   +8.536847280898079e-02   -1.170155825009695e-01   +2.552204006631165e-02   +7.017720427246633e-02   +4.365763952196575e-02   +2.387223549156881e-02; +5.773913844965241e-02   +3.825174913405748e-02   -7.763222757940903e-02   +4.280016965281855e-02   +1.017539226229680e-01   +2.333457591187695e-02   -4.016280620820127e-02   +4.313837393581773e-02   +1.583761435521457e-02   +6.793961670819761e-02   -1.870756360855693e-02   -1.318847359939031e-01; -3.978883575418947e-02   -4.220250479653603e-05   -1.228440515971972e-01   +5.164284931170445e-02   +1.865094160188815e-02   +8.695266963021996e-02   -5.424279225298158e-02   -8.495408962915160e-04   +6.870053568722173e-02   +6.482307701327664e-02   +7.176932752923330e-02   -3.253148530094957e-02; -4.355558941561458e-02   -9.951788359872473e-03   -7.670784779020443e-02   +3.731212025583864e-02   +5.442483131344608e-02   +4.731057097566745e-02   +8.592106092520022e-02   +1.450645055817702e-01   +6.045426828466774e-02   -1.571745236891407e-01   -8.804164014853855e-02   +7.055726747936544e-02; +9.191641511376049e-02   -4.634686432820634e-02   -5.356197771530058e-02   -5.488019890636337e-02   -7.354267829730886e-02   -2.647862108258757e-02   +3.129614284322855e-02   +1.843457093818834e-01   +4.684353571797646e-02   -7.649712281412960e-02   -3.815954615433113e-03   +4.440066847917433e-02; +1.002681379296106e-01   +3.528951545659743e-02   -1.428654712839714e-01   +2.421483174699969e-02   -5.465681705718598e-02   +1.821909736901434e-02   +1.527934680768337e-01   +5.306736982354286e-02   +1.245351578376766e-01   -2.150448037087074e-02   +3.201100895540581e-02   +6.546463314048706e-03; -1.129228329230642e-01   -2.768564564624725e-02   -9.420937875054630e-03   -2.989094252584253e-02   -4.949462789450020e-02   -9.539622389763228e-02   +9.953752527435063e-02   -2.812608895707706e-02   +3.799889201263462e-03   -6.843860972225385e-02   +3.636492376979428e-02   +6.889577949585103e-02; -1.350741103970104e-01   +1.130699783347520e-01   +6.405429524703168e-02   +5.239735383478020e-02   -5.569510698960403e-02   +3.076447547252939e-02   -5.693995566598952e-03   +1.452576945396532e-02   -1.695384226472121e-01   -4.861947678642733e-02   -2.947306138381473e-02   +4.524691268956661e-02; -9.481291787109429e-02   -5.476394048939399e-02   -1.389018284993502e-01   -4.041810331308142e-02   -1.643755902554006e-02   +1.076857844362508e-01   -4.030590434557179e-02   +4.110776810516923e-02   +1.405181843565903e-01   -1.570317036940880e-01   -5.230686341429996e-02   -4.180253588838006e-02];
L1_L3_iAMPA_netcon = [-1.119270251940808e-01   -1.023715435921312e-01   -4.073236384389488e-02   -1.520862536530415e-01   -3.969440718050410e-02   +3.235607289873173e-02   +6.439897375304274e-02   +5.121397264135201e-02   +1.089259777060191e-01; +6.034125013790916e-02   +6.538264482821077e-02   +1.732319546123519e-01   -8.829041076879919e-02   -1.017531953993064e-01   +1.055908247832080e-02   +3.736327620163284e-02   -4.641436760000956e-02   +2.918798172077600e-02; -3.021160599948046e-02   -3.506456476547468e-02   -9.214617922946235e-02   -2.137565575787930e-02   -3.352269400387350e-02   +3.284812756190281e-02   +7.904197295610008e-02   +1.026775578097995e-01   -1.033421756403053e-01; -1.205848960098814e-02   +1.054109446008526e-01   +1.192523771930355e-01   -1.175697964714767e-01   -2.300426466909817e-02   +3.024878197684321e-02   -9.495836885837973e-02   -2.713014559022948e-02   +6.899022131398949e-02; -1.496535965662358e-02   -1.801375674135067e-02   +2.431814268918484e-02   -8.980571292885291e-02   +2.717357548783201e-02   -8.336948827635020e-02   +1.806579856124075e-02   +4.893067843577920e-02   +3.754031142820285e-02; +9.947605633850896e-02   -1.325664521512865e-02   -5.318796466562453e-02   +1.189651876382072e-02   +2.910598529125263e-02   +3.926754114109218e-02   +2.780231731326221e-03   -6.079324923260177e-02   +1.167701236771305e-01];
L3_L1_iGABA_netcon = [+1.317404563571391e-02   -7.304433798275482e-02   -4.435900660131422e-02   -1.226723131147081e-01   -1.187020634284873e-01   +1.246680490469299e-01; -1.975598223920802e-02   -1.150546695485566e-01   +1.721888297810659e-02   -9.402122240403429e-02   -9.570931864826020e-02   +3.125444365376210e-02; +4.277794560730935e-02   +3.502186565123581e-02   +1.234932790773399e-01   +3.364271714398466e-02   +8.280680724483953e-02   -1.015945461530764e-01; +3.298455865395027e-02   +7.056539981975854e-02   +5.438326156246330e-02   -4.525401754610444e-03   -4.008722624400488e-02   -9.986784392119367e-02; -1.020310076762080e-01   +1.212242189705214e-02   -1.004460958387484e-01   +7.744972350075768e-02   -1.962993793394725e-02   +3.843091584397137e-02; -1.082987038898889e-01   -3.613812164802268e-02   -8.225566265507238e-02   -5.116532941683481e-02   -1.645077793410098e-02   +8.501223009187829e-02; +1.078708382006198e-01   +6.599292125536943e-02   -5.015557776199128e-02   -7.216455132539383e-02   +7.199900979167716e-02   -6.922908888330173e-02; +8.621675691542922e-02   -9.190684613980404e-02   -8.367293722204057e-02   -7.415418798492671e-02   +3.362915226979266e-03   +1.174297602734171e-01; -3.647330356505321e-02   +1.103765004158943e-01   +6.902215090660931e-02   -1.006495136010614e-01   -6.166088834690216e-02   +2.607036698777811e-02];
L5_Input1_iAMPA_netcon = [-5.115562128701710e-02   +8.295633685097296e-02   +2.155423311009715e-02   +5.981089903599081e-02   -1.330036549478171e-01   +1.246657990355374e-02];
L6_Input2_iAMPA_netcon = [+2.505984087729990e-03   -4.848205919481263e-03   -3.426847818543009e-02   -1.130732794281565e-01   +1.207206621214803e-01   -6.667422797635515e-02];
L5_L6_iAMPA_netcon = [-8.026801873164680e-02   +1.025674010765704e-01   +1.194010105090367e-01   -4.052964039884409e-02   -7.461222476734400e-02   -2.265516055354050e-02; +2.488842382753835e-02   +1.171246032719211e-02   +3.607572078102936e-02   -4.301432877461299e-02   +4.746078504902927e-02   -3.560016189294167e-02; -8.014893261146544e-02   +1.393713551488592e-02   -1.305375338034396e-02   -3.436177786839206e-02   -5.808712788021728e-02   -7.008561334052935e-02; +5.076768054172860e-02   +2.775626382873417e-03   -2.854721075732383e-02   +4.479993172338725e-02   +8.129092858819445e-02   -2.650051127777224e-02; +1.976353740944142e-02   -1.210793516402505e-02   +3.359934391581741e-03   -9.480252433373687e-03   -4.990160902688139e-02   +6.031120236811346e-02; +3.751059768264706e-03   -5.502227408747065e-02   -8.617679887431424e-02   +1.524806863867774e-01   -8.164051229646480e-02   +9.942345237890105e-04];
L4_L5_iGABA_netcon = [-1.022961664798305e-02   -2.472795346577610e-02   -2.700384996296233e-02   -7.757774440374318e-02   +3.695664966326312e-02   -2.194773994145271e-03   -1.477134926029199e-01   +2.659328690416060e-02   -4.734149005587685e-02   -1.275102242380194e-01   +9.150526228488703e-02   -2.236055160969664e-04; -4.253081613738607e-02   -8.631346343112344e-02   +4.381822150797855e-02   +9.212330244077372e-03   -8.649601363419846e-03   -9.937936133037102e-02   -2.246687593583402e-02   -1.294977534274721e-01   -5.589844418234024e-02   -1.343232871743868e-01   -1.010083129094795e-01   -4.026263733579719e-02; +2.403012585868193e-02   +1.082752768023818e-02   -3.061294015654400e-02   +8.983536395101441e-02   +2.467487596381038e-02   -6.147857833725533e-02   +6.161762716340426e-02   -7.884451319357819e-02   -6.320926771129881e-02   +2.838921334770737e-02   +6.511781291995078e-02   +2.101910075667884e-02; +7.185257065587290e-02   -1.682377985358058e-01   +9.254801379716537e-02   -1.006607308855812e-01   +5.990515754730408e-02   +1.834407755289067e-02   +8.815348239029529e-02   -8.488107466059730e-02   +4.681177468581751e-03   -7.480685173813978e-02   +5.163560099356454e-02   -2.107529676740930e-02; +7.468761803760997e-02   +7.604675093006406e-02   -9.426158250922027e-03   -1.066572916963543e-02   +6.568353134682228e-02   +1.003368757638299e-01   -1.621435355686605e-01   +6.087715926312583e-02   +7.812789905544579e-02   +3.196753756389436e-02   -3.352201289714694e-02   +2.973482836298923e-02; +1.734017960481839e-02   +1.325353934286120e-02   -3.376448304133547e-02   -1.039013668815570e-01   -5.096016627383919e-02   +4.030386314879145e-02   -2.306554902450313e-02   -2.482926344889225e-02   +9.130615621545383e-02   -4.275047234843225e-02   +1.018710959952353e-01   -1.951050575038183e-02];
L6_L4_iAMPA_netcon = [+9.854551116086528e-02   +3.585551040873643e-02   +2.228538071150281e-02   -1.199637448204441e-01   +1.220981941296041e-03   +1.151141170736316e-02; -9.899298052127502e-02   +1.782327616245978e-02   -8.843132901589403e-02   +5.970189443178001e-02   -1.669678013521110e-02   +9.718305974557152e-02; +1.354923675101256e-02   -1.654695406916206e-02   +4.025298678646318e-02   -3.524000787914805e-02   -6.153975733920533e-02   +7.434519561843039e-02; -7.400671109928147e-02   +3.253305427054441e-02   +9.014646303805053e-02   -8.609669385955195e-03   +1.806846745405143e-02   +5.234165643362241e-03; +8.258189758577054e-02   +4.178771420924907e-02   -1.051339011789924e-01   +8.823468122521701e-02   -3.918985427505742e-02   -6.654531216636199e-03; +1.441077657223410e-01   +6.364398542886297e-03   +3.775215957823855e-02   +1.961263225365421e-02   -8.192192392490173e-02   -7.357637959662192e-02; -7.620775332592664e-02   -1.134948935131053e-01   +5.117212375508917e-03   -7.605576460583661e-02   -8.225586632782222e-02   +5.023095074211439e-02; +1.955339756380447e-02   +7.196715191371621e-02   -1.122539117718259e-01   -1.240889343990518e-01   -3.240692881121882e-02   +6.415126075431002e-02; -1.637560837394827e-01   +1.496014387317967e-01   +7.480587312827504e-02   +1.149479176722620e-01   -1.092390643340062e-02   -1.128789328098822e-01; +1.225698043172655e-01   +1.111061901298955e-01   -4.930510519009451e-02   -8.132630927845941e-02   +5.943640973369145e-02   -5.918136441651687e-03; -1.236954874216335e-01   +9.321937052374393e-02   -2.367319979366136e-02   +7.566415725645108e-02   +1.171711975143984e-01   +1.318180550279875e-01; -8.612080929790009e-02   -7.571030072807240e-02   +1.406063952725066e-02   -2.039517834539310e-02   -3.681457073688758e-02   +1.037229428547315e-01];
L5_L4_iAMPA_netcon = [-7.690414103441710e-02   -5.930394216665615e-02   +5.460220522576613e-02   +8.798968852546725e-02   +2.170604534504927e-02   +8.198266171729349e-02; +1.903374175773774e-02   -7.737498166579220e-03   -1.565511943394025e-03   -2.985994099076665e-02   -5.347476464780732e-02   +5.929672820573484e-02; -7.744284860843699e-02   +4.758896107726063e-02   +8.189264118164641e-02   -1.333663006782464e-01   -3.042277965830405e-02   +8.632477297627601e-02; -1.344415548223208e-01   -7.081889534540801e-02   +9.253933332778162e-02   -6.331687631006545e-02   +3.730663297403047e-02   +4.817303724936121e-02; -1.054824210658561e-01   +4.727811783089557e-03   -6.162183174656978e-02   -4.337620469130200e-02   -6.389197382726097e-02   +1.434115395163346e-03; +1.442578757048392e-02   -1.335809224359541e-02   -3.891291053428254e-02   -1.211161551431358e-01   -6.506383696711739e-03   -4.410473013734045e-02; -3.360877380180979e-02   +1.542847903758069e-02   -6.127421214774661e-02   +4.978424114451038e-02   +6.108529650854844e-02   -6.799126090587723e-02; +1.271108805942363e-01   -2.800194819829059e-02   -7.118153052251919e-02   +1.910696531874705e-02   -5.173455238124566e-02   +8.791647155902310e-02; +1.349878646871808e-02   +1.919348425018787e-03   -8.772831607453338e-02   -4.641313552087580e-02   -1.034127754130354e-01   -3.316242470741115e-02; -3.770236078783503e-02   -7.570796582875983e-02   -1.080845298842444e-02   -9.688623952286700e-02   +1.530013771844741e-03   +1.041604026759991e-02; +5.165503089058940e-02   +3.047354100296993e-02   +1.118399372652088e-01   +4.504904695038679e-02   -9.125012236985872e-02   -3.541684757352796e-02; +7.874186615200016e-02   +6.386134891878240e-02   -7.003891740468381e-02   +5.481510811398749e-02   +3.860891276584152e-02   +5.736405778279398e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
