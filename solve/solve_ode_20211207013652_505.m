function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.564464822509529e-01   +1.035571956090472e-01   +2.918021062844627e-02   +1.804646897186797e-01   +2.780146421741040e-01   +2.779167734704726e-01   +9.649128023416234e-02   +1.935320426309664e-01   +6.309826142348943e-02; +6.022377082434872e-02   +1.124396761586875e-01   +2.432277114598039e-01   +1.368482996717788e-01   +2.968942604706958e-01   +2.471623622079689e-02   +4.850714553657600e-02   +6.665922556647665e-02   +1.342925501155265e-01; +4.044717517996073e-03   +1.757551671856196e-01   +1.477938522557349e-01   +2.543701442366709e-01   +3.589600654118727e-02   +1.787788484007247e-01   +1.844030138149054e-01   +2.684884884229020e-01   +6.093863253478729e-02; +1.068420326319679e-01   +2.617555798387056e-02   +3.680838841921032e-02   +2.630052818823566e-01   +1.099211958557097e-01   +1.843511593142481e-01   +8.642112613513227e-02   +1.618238323960589e-01   +2.210010649349045e-01; +1.636479140004469e-01   +2.963272477050753e-01   +1.275678607582593e-01   +2.030651924360299e-01   +2.330790611572025e-01   +1.657782753890512e-01   +8.664293277516663e-02   +3.455897628848926e-01   -8.126692028561984e-03; +2.051934813754015e-01   +2.735234231150457e-01   +2.309976960588898e-01   +7.953972486018517e-02   +2.585275307591349e-01   +8.384704652770229e-02   +2.880682954945161e-01   +1.502499818529946e-02   +2.363420453439174e-01; +3.510805184639983e-02   +2.921133391423008e-01   +3.081016057862034e-01   +2.810248631717869e-01   +3.166344348853796e-01   +7.702224150098738e-02   +2.611064399370722e-01   +1.138458283160953e-01   +1.204079624461756e-01; +9.727108855199336e-02   +2.461740411613655e-01   -1.327665973264410e-02   +6.106608434208451e-02   +2.717457745348066e-01   +2.851042258421961e-01   +2.340240668809461e-01   +2.578858879274706e-02   +2.274932028294011e-01; +1.862318621398768e-01   +1.320170353759380e-01   +2.221247312790870e-01   +2.795645712452200e-01   +2.338368146655828e-01   +2.774937391068800e-01   +1.974318003981907e-01   +4.755116009997268e-02   +2.753133701825212e-01];
L1_L2_iAMPA_netcon = [-3.884400357197853e-03   +1.483096877505400e-01   -3.593794604657732e-02   +1.966003469476172e-01   +5.132417234485549e-03   +2.545327695370005e-01   +5.321089383210630e-02   +1.116716493476678e-01   +3.238367287658315e-01; +2.045463047966691e-01   +3.212480482887207e-01   +2.484949490537680e-01   +1.388873470690265e-02   -1.284192989281925e-02   +1.552125750655379e-01   +2.543943160159961e-01   +3.920569162129146e-02   +1.958638222422994e-01; +4.245552930367620e-02   +9.305454830457537e-02   +7.254351186054661e-02   +7.739846054025620e-02   +6.391770104700267e-02   +1.330671571157171e-01   +7.909412873361152e-02   +1.270578479831495e-01   +1.538974864098698e-01; +2.720670089347266e-01   +2.796114827307899e-01   +3.148004746623599e-01   +2.959155186042791e-01   +1.496906575278403e-01   +1.706054647409583e-01   +2.354435365071888e-01   +1.760865072325650e-01   +2.441147124963090e-01; +2.399586938423375e-01   -2.309093773954537e-02   +6.734674765791131e-02   +1.654227182722741e-01   +3.967276189139905e-02   +2.138574339344394e-01   +2.675245153656992e-01   +3.119125698976402e-02   +1.173055907155902e-01; +2.075783678707834e-01   +1.803973742337193e-01   +3.146437092527128e-01   +3.152542615571303e-01   -2.179940571579889e-02   +1.292210246143550e-01   +7.296340499652096e-02   +1.798120249665885e-01   +1.015475727243574e-01; +2.763565955205200e-01   +1.391000065013921e-02   +2.068483469733357e-02   +2.066135538987148e-01   +1.976065302054648e-01   +3.081681466263783e-01   +6.016609756764141e-02   +1.793818111197504e-01   +4.363558276100674e-02; +1.507701730632685e-01   +2.426720696043574e-01   +9.762463964162782e-02   +2.597919636298117e-01   +1.105675730763700e-01   +2.352480174476720e-01   +2.747323293294618e-01   +5.697127831894591e-02   +1.937367701287722e-02; +2.650424673116267e-02   +1.021067612747989e-01   +1.811499420340882e-01   +2.741093388515867e-01   +2.945862231620653e-01   +7.502689371718813e-02   +3.138819189712938e-01   +2.767412865946484e-01   +1.849413526774145e-01];
L2_L5_iAMPA_netcon = [+2.228470634781135e-01   +1.614081014996790e-01   +1.470841368105928e-01   +3.073171146041671e-01   +3.086699994009120e-01   +2.595321630451197e-01   +2.961898460694853e-01   +2.794101984633208e-01   +1.490324633601635e-01; +1.391501350459565e-01   +1.404061032755844e-01   +2.929767241558067e-01   +2.030628518300128e-01   +1.358232815104483e-01   +6.148277053191160e-03   +9.048098572759029e-02   +1.363946853757328e-01   +2.337692262962465e-01; +7.368936602791490e-02   +2.432312423042058e-01   +1.333755452921593e-01   +7.784003965369779e-02   +2.983778663484422e-01   +5.286078960286866e-02   +1.239616872325092e-01   +2.209272225838073e-01   +1.563762810561514e-01; +1.198761459918897e-01   +2.060426205013423e-01   +1.179332666000059e-01   +3.190582001161181e-01   +2.105615926130104e-01   +2.823796385597494e-01   +3.268386949537186e-01   +3.327629210597828e-01   +2.866185483588854e-01; +2.720489851875327e-01   +2.427252638273090e-01   +2.160888516061809e-02   +2.612930650422415e-01   +2.432858647370497e-01   +2.147438441112907e-01   +4.171724470352248e-02   +1.241236729709323e-01   +2.458117362325620e-01; +3.480505266597329e-01   +1.856522232914765e-01   +2.473998679100556e-01   +1.221242674675254e-01   +1.328434287415827e-01   +2.594631652817148e-01   +2.287973161897529e-01   +1.107120653253436e-01   +3.337874318333369e-01];
L5_L2_iGABA_netcon = [+3.047497545077926e-02   +2.373993066751472e-01   +1.208064282690233e-01   +3.098431454649859e-01   +6.109425322263130e-02   +2.386973172025804e-02; +3.685728849950979e-01   -1.561366710439838e-02   +1.280292977701253e-01   +1.404360474387274e-02   +2.939142158279081e-01   +1.886689024667163e-01; +1.009358620953622e-01   +2.803337327312069e-01   +2.107742520297255e-01   +6.044131018850862e-02   +9.557147610560321e-02   +1.884648332393810e-01; +6.417266350452212e-02   +1.342053554917828e-01   +1.909554938457788e-02   +5.053515239528139e-02   +9.859760727641713e-02   +2.316790389470397e-01; +1.063198897171504e-01   +3.136000176982469e-02   +2.981799679118659e-01   +2.944884252189912e-01   +2.595939383445256e-01   +2.233003961037835e-01; +2.312122751086811e-01   +2.092124565333761e-01   +2.092394414382996e-01   +2.428371195031249e-01   +1.020732379582234e-02   +8.876029666088245e-02; +1.191217875286805e-01   +3.130498254190287e-01   +1.203642219976883e-01   +5.271249007078611e-02   +2.253284992821461e-01   +1.804339410741981e-01; +9.843044439872073e-02   +3.442776193316593e-01   +1.275889853132532e-01   +7.144784934932114e-02   +1.726878700495240e-01   +1.871554673243859e-01; +2.030453499422735e-01   +6.101399932420409e-02   +9.148972006574980e-02   +2.989093342243098e-01   +3.679534887675647e-01   +1.299282595574477e-01];
L3_L2_iAMPA_netcon = [+1.173684208030672e-01   +2.953454426830022e-01   +7.553956336577324e-02   +1.749097579088003e-01   +3.263505672530403e-01   +2.801991579046190e-01; +8.714597597283921e-02   +6.144291038282031e-02   +2.449287397984490e-01   +9.701257782923703e-02   -4.653099839066000e-03   +2.751170581424531e-02; +2.465901055751372e-01   +7.975465991487689e-02   +1.448021960257597e-01   +2.845547779519260e-01   +1.220393214974305e-01   -4.996168286606448e-02; +5.952724228441172e-02   +1.525462931171356e-01   -7.061544895798190e-03   +2.176697591191948e-01   +4.356921683716004e-02   +1.914900849866363e-01; +1.538898712924297e-01   +3.713175684194169e-02   +1.037734955776667e-02   +2.669593471921927e-01   +7.742543229669042e-02   +3.233601568242209e-01; +7.278670254401573e-02   +2.654843835851299e-01   +5.488109091280126e-02   +2.899215891893167e-01   +2.522872903069110e-01   +2.250183595773375e-01; +1.371951216586335e-01   +4.288361578478798e-02   +2.127421469882093e-01   +1.644589607706722e-01   +1.806146492130910e-01   +9.813062303100074e-02; +1.513782830039931e-02   +6.992622258505254e-02   +3.344338480161054e-01   +7.452414923049400e-02   +2.790040628012889e-01   +5.436404772905551e-02; +3.242810590094291e-01   +3.374157354917379e-01   +7.617912926591275e-02   -8.968035493765857e-04   +2.607518490459634e-01   +2.159351748265477e-01];
L2_L3_iGABA_netcon = [+1.773736583593279e-01   +5.070998060427523e-02   +1.902457966174909e-01   +2.323750650933203e-01   +2.745540024097227e-01   +1.794745130638042e-01   +2.892252342949914e-01   +4.340911211176932e-02   +6.842121886455940e-02; +2.711839441426115e-01   +3.411060747198880e-01   +1.077190664595649e-03   +5.433365390216582e-02   +2.185689773871731e-01   +3.546284341837064e-02   -5.234796016750606e-02   +1.739415111399610e-01   +1.314620899761219e-01; +7.630059847136061e-02   +1.834211326505436e-01   +2.007183890219759e-01   +2.865429675125535e-01   +2.710439630565386e-01   +1.326530176845264e-01   +9.191458924022669e-02   +1.290780081960895e-01   +2.824884936758270e-01; +7.104258293598273e-02   +4.523663214835599e-02   +9.124087156627307e-02   +1.144092569981995e-01   +2.781618976005010e-01   +2.565961478663703e-01   +4.037950195947546e-02   +1.371404688001442e-01   +3.147369773302479e-01; -5.952697183416138e-02   +2.355526876288853e-01   +3.169217201072622e-01   +1.189030409465064e-01   +1.458837260254341e-01   +1.896072323301491e-02   +2.916898605305080e-01   +5.234700913015742e-03   +9.108688536372889e-02; +1.735165679437418e-01   +2.782509718357036e-01   +9.264206632049221e-02   +2.163518131195784e-01   -1.303671394076081e-02   +1.777074667189388e-01   +6.542735404378200e-02   +2.357501499337483e-01   +1.536481746833714e-01];
L1_L4_iGABA_netcon = [+1.210142619382355e-01   +1.830051215969596e-01   +2.435156886221054e-01   +2.669494301091898e-01   +8.486291625322367e-02   +2.217728352617592e-01   +9.029192247534457e-03   +1.235868703621448e-01   +3.207089930284426e-01; +2.829067431783690e-01   +1.381493063073543e-01   +1.871610206965739e-02   +1.088532800430245e-01   +8.668523701729001e-02   +2.094247780659057e-01   +5.717984661506405e-02   +1.365551237587983e-01   +3.014648759639218e-01; -7.724963807588827e-03   +1.201760248599259e-01   +2.412363259860860e-01   +2.186651938406096e-01   +1.428348926136082e-01   +1.108240252783869e-01   +2.025692374290494e-01   +1.907491312620739e-01   +2.832493399271114e-01; +2.526194708826245e-01   +3.028697497364970e-01   +8.754959946864110e-02   +1.370176525984821e-01   +1.918184003717667e-01   +3.234623459914301e-01   +3.377163064509960e-01   +3.212009801111085e-02   +2.240124551476958e-02; +1.873412270642273e-01   +2.269992483765968e-03   +8.884533315053166e-03   +3.599892585238061e-02   +3.174232339677936e-01   +5.927034886506598e-02   +6.548186235700798e-02   +6.041319788632948e-02   +2.112595106407692e-01; +1.272140139882614e-01   +2.253463678888785e-01   +1.719470200709098e-01   +2.508244260672624e-02   +5.038322631731444e-02   +7.101201313577636e-02   +1.912203664570963e-01   +7.440657555647240e-02   +2.410022054804932e-02; +3.677140572165573e-02   +2.517257162287176e-01   +2.058657701732152e-01   +2.041773840263365e-01   +3.443911832416146e-02   +9.844151623418840e-02   +3.196069970815785e-02   +8.489831581431601e-03   +3.190176801740184e-01; +2.106367809302542e-01   +9.529571223731523e-03   +2.631807528961344e-01   +2.118538885239248e-01   +1.690449920978614e-01   +1.876348041515433e-01   +1.038171468251657e-01   +1.159229710697905e-01   +8.040272215742481e-02; +1.180828550458518e-01   +1.199373089134313e-01   +1.563952290648525e-01   +1.761258883229053e-01   +7.656944047397299e-02   +1.907724607418419e-01   +9.670014949104985e-02   +1.774689464180210e-01   +3.033365052014931e-01; +4.478850220397546e-02   +1.099333981738223e-01   +2.348163783392632e-01   +1.332084217079949e-01   +2.466566093106363e-01   +1.154851160148438e-01   +2.138859836554730e-01   +8.012918796881728e-02   +1.953188160294214e-01; +6.121617085161251e-02   +1.177312022054744e-01   +4.167099534524550e-02   +3.024186754158337e-01   +2.806044734076748e-01   +2.685160857322534e-01   +5.788043026933629e-02   +1.696077307655884e-01   +2.548106308694508e-01; +1.356901305719536e-01   +3.099317980903848e-01   +2.061646226628800e-01   +1.990633087620210e-01   +1.181797552749324e-01   +5.513900349103987e-02   +6.591258549245985e-02   +2.320958759183535e-03   +2.566465850020329e-01];
L4_L1_iGABA_netcon = [+2.151422779164436e-01   +1.241469270970732e-01   +4.328623022164303e-02   +1.587501963452251e-01   +1.224245011079271e-01   +3.900074489857833e-02   +1.785227269771157e-01   +1.880508166265898e-01   +1.043466076131627e-03   +5.397702415783630e-02   +1.811828796180442e-01   +2.888548626048971e-01; +4.885312464964797e-02   +1.137971752129922e-01   +3.015176335369831e-01   +4.374257776562070e-02   +2.220203580644392e-02   +2.717228331672073e-01   +3.676086320779661e-02   +2.909887698836011e-01   +2.828043552131468e-01   +2.868345111619482e-01   +2.371938226823260e-02   +3.004607443385373e-01; -1.866876894639722e-03   +1.250681792598153e-01   +9.627066711868981e-02   +2.681453302456529e-01   +1.155991148192304e-01   +9.151142066263707e-02   +2.366768711582485e-01   +3.364528378252306e-01   +2.477883295894596e-01   +1.190448455132846e-02   +2.097130864701571e-01   +6.797259505385116e-02; +7.843191145469186e-02   +1.246280303745768e-02   +3.113539021677414e-01   +3.082589472867080e-01   +1.197798692980178e-01   +2.494151611029571e-01   +2.236101941998885e-01   +3.438808473510696e-01   +2.857458313213175e-01   +9.630963755874783e-02   +3.324838341029310e-01   +1.655372654369297e-01; +1.733155697975822e-01   +7.775894262633336e-02   +6.178934667417524e-02   +2.753017391974317e-01   +8.264301446585889e-02   +1.323708802879185e-01   +1.753745802836049e-01   +1.360128139739145e-01   +2.652308836620208e-01   +1.852321104371456e-01   +1.282315449459209e-01   +3.571318713804452e-02; +6.567789327043089e-02   +3.422769722592901e-01   +2.280541119651923e-01   +3.131140067887285e-01   +1.196545954356919e-01   +9.639392688265518e-02   +2.309903943180930e-01   +3.189649276938119e-01   +9.149667159892144e-02   +1.754467846212054e-01   +2.539627630351833e-01   +2.049484294589402e-02; +1.229571424377679e-01   +5.951908025022203e-02   +2.640897501273753e-01   +2.506666179715289e-01   +2.999111149397887e-01   +2.552837605092209e-01   +9.577344435179547e-02   +1.710863331910374e-01   +1.731401657708773e-01   +2.750610506526318e-01   +9.313555757447883e-02   +2.335684590966315e-01; +8.945453832290198e-02   +1.289041556766267e-01   +7.359330888950018e-04   +1.270361436515980e-01   +3.939681518804945e-02   +1.051895350359051e-01   +1.097749109713830e-01   +2.799554716827661e-01   +1.784476041309918e-01   +7.399093954294442e-02   +3.259773045743955e-01   +2.551578580601041e-01; +1.442903059917102e-01   +1.828875349423080e-01   +3.515316996216721e-01   +2.953007865514374e-01   +2.318188398963838e-01   +1.476829305456623e-01   +1.433522418650357e-01   -5.945321063941754e-03   +2.104157785085758e-01   +2.101557660395721e-02   +8.854101930453620e-02   +1.174606446436885e-01];
L1_L3_iAMPA_netcon = [+1.672486629061290e-01   +2.550919883783581e-01   +2.411033292408540e-01   +4.964460268641752e-02   +2.711917651150038e-01   +2.664189518785730e-01   +6.979107677105234e-02   +1.567750490719819e-01   +2.838057301608203e-01; +1.310003400200555e-01   +2.640892478928111e-01   +2.323225742444772e-01   +2.872558348095149e-01   +3.714428233329598e-01   +2.576052522300279e-01   +2.953397252065491e-01   +5.714326333609129e-02   +2.148525389444411e-01; +3.202984011023766e-01   +2.619559838838763e-01   +1.146749428824864e-01   +2.093785674843425e-01   +2.350130578707748e-01   +1.695123605743236e-01   +1.425449040963248e-01   +3.015265436748341e-01   +1.552346206554344e-01; +3.738921311124972e-02   +2.596322791134137e-01   +1.672584909775872e-01   +1.926972704685946e-01   +2.280739350596067e-01   +2.160160229204150e-02   +9.378078510650310e-02   +2.258538653937314e-01   +2.768671262729011e-01; +2.145359080423417e-01   +3.358785348407353e-02   +2.508370568486152e-01   +2.007429426732082e-01   +2.953813989301835e-01   +2.064578919936299e-02   +1.406940721364583e-01   +2.830279105928800e-01   +2.223171992035083e-01; +8.235687394507112e-02   +7.202764442230926e-02   +7.114344774533009e-02   +2.745128634959603e-01   +3.741014871664163e-01   +1.905728380701832e-01   +1.774578122645020e-02   +1.437615282833784e-01   +2.153879727115977e-01];
L3_L1_iGABA_netcon = [+2.306793273310832e-02   +8.622849180164796e-02   +2.467664191874696e-01   +1.532507451376127e-01   +2.111755528246041e-01   +2.713156971330881e-01; +2.819554975764191e-01   +3.194839039854180e-01   +1.330871193973824e-01   +1.628962228363085e-01   +1.052681712930980e-01   +2.485540250945730e-01; +2.660705417839248e-01   +2.832205550388789e-01   +2.044536525490345e-01   +3.069284866899661e-01   +1.268486167274633e-01   +1.173823053996400e-01; +1.664730778222608e-01   +2.795707502354007e-01   +2.592523043091286e-01   +2.839139887251434e-01   +7.484685696269522e-02   +1.557074819920982e-01; +1.571229483914488e-01   +2.347315427069128e-01   +7.843772589475696e-02   +1.820132179617446e-01   +5.281883073921067e-03   +6.025529286018715e-02; +3.513259785619555e-02   +2.303252424704667e-01   +3.166333928174626e-01   +8.878706347121997e-02   +2.613488207228395e-02   +1.487520817839475e-01; +5.138710943557409e-02   +3.307599409932924e-01   +1.446546499155610e-01   +1.217696167923430e-01   +2.234972749368445e-01   +1.828484667681869e-01; -1.098136190192673e-02   +1.346115800240996e-01   +3.160480766172035e-01   +1.568114388505129e-01   +5.375432886711443e-02   +1.188449641565745e-01; +9.711557922203452e-03   +3.041452059965495e-01   +1.593628551101843e-01   +1.155208638448176e-01   +2.356789168822509e-01   +2.515967058146129e-01];
L5_Input1_iAMPA_netcon = [+1.164885069176092e-01   +1.137190847849317e-01   +2.295817805322963e-01   +1.434827633125404e-01   -5.726589036826563e-03   +1.764703503751614e-01];
L6_Input2_iAMPA_netcon = [+2.177844825164631e-02   +2.793292936456853e-01   +1.505145711333863e-01];
L5_L6_iAMPA_netcon = [+3.205219148535725e-01   +4.428294918491030e-02   +2.636029267173497e-01   +2.138319280817721e-01   +2.799870824048910e-01   +2.254805233267329e-01; +1.395446260789467e-01   +6.189868287045281e-02   +1.955601659442577e-01   +1.287148267019475e-01   +1.043176135830457e-01   +2.783668498328565e-01; +3.009533330799228e-01   +2.940796177642852e-02   +1.233447229198070e-01   +8.328532119940707e-02   +2.421002278301958e-02   +1.689024191023012e-01];
L4_L5_iAMPA_netcon = [+2.511936164530483e-01   +3.148876538135461e-01   +1.199714710919340e-01   +6.146281342262987e-02   +8.980561918876262e-02   +3.051647102993494e-02   +1.105226216142685e-01   +1.668286948622331e-01   +1.261163858711412e-01   +1.868106150986290e-01   +6.372397577511880e-02   +4.258693559260467e-02; +2.959066484737612e-01   +5.753470531322300e-02   +1.563432599597430e-01   +1.433165551202716e-02   +5.210795495989147e-02   +1.366293948145439e-01   +2.149058671767697e-01   +1.353015465520751e-01   +2.075813281255998e-02   +5.068676479646110e-02   +3.372735599709346e-02   +3.262434441920135e-01; +4.793041054943857e-02   +1.823957753464963e-01   +5.548709392960022e-02   +1.170922973060509e-01   +3.141079029251839e-01   -3.022992592108919e-02   +1.682209583908957e-01   +2.538701095585963e-01   +1.337953857258387e-01   +6.562274393303606e-02   +2.099437209186278e-01   +2.421412718514918e-01; +2.119677042829476e-01   +1.736094280686638e-01   +2.664947442475366e-01   +2.093821523326297e-01   +1.967590790325868e-01   +3.496080613644025e-02   +1.746533905751928e-02   +2.108028737700740e-01   +5.051636123546190e-02   +1.710442208772539e-01   +1.303256200712483e-01   +2.672749709152347e-01; +2.752852544376959e-01   +2.249974500948854e-01   +3.053539292421018e-01   +6.882141451586708e-02   +1.769535171953842e-01   +2.835802628518839e-01   +3.226300738837670e-01   +2.982521651940507e-01   +3.469336933107561e-01   +2.815793541091793e-02   +8.482258817899571e-02   +2.703643344565858e-01; +1.275235355779641e-01   +2.953137590658810e-01   +6.995255624791517e-02   +2.075652080278950e-01   +2.943126604357220e-01   +3.072775955116492e-01   +1.114758632906735e-01   +1.511465081984832e-01   +3.315266665552621e-01   +2.165830138926120e-01   +3.500112437632643e-01   +2.235877193859695e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
