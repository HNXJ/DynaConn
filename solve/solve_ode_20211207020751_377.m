function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.571480321944351e-01   +9.385502190238790e-01   -9.032291175730250e-01   +2.178622113959908e-01   -7.972617420776448e-01   -1.714484920336211e-01   -8.692993115727998e-01   -2.641530258335880e-01   -2.379398781662991e-01; -8.081622798933776e-01   -6.740640092620754e-01   +1.319421818956377e-01   -7.339441824542916e-01   -5.515114996115671e-01   -6.021034675861370e-01   -4.054454981561900e-04   -6.095718866545119e-01   -7.082237028009253e-01; -1.427761457387829e-01   +5.527722903659715e-01   -4.305440019818293e-01   +8.384376450027304e-01   +9.967426919182877e-01   -4.699319193814287e-01   -6.112675021770807e-01   -8.328107318954876e-01   -1.391698157365182e-01; -2.352115863309658e-01   +4.011662256392488e-01   -5.080894767522244e-01   -3.708387978952459e-02   +5.839452584233391e-01   -7.115449844162290e-01   -8.499825900671124e-01   -8.105736039753255e-01   -5.864171018077829e-01; +5.880370654743643e-01   -9.541222523766113e-01   +2.019034128435445e-01   +7.514066196058794e-01   -7.426596232475163e-02   +1.777353661299442e-01   +6.365856933438894e-01   +6.000633943849489e-01   +2.963549088078968e-01; +3.694669183153360e-01   +1.000000000000000e+00   +4.351488915369103e-01   +6.588521218155046e-01   -8.412412833430978e-01   +4.859110450374279e-01   +1.221065253086878e-01   +8.294013450804969e-01   -1.836058358211002e-02; -4.686833875279218e-01   +5.186363393096212e-01   -4.055811295067730e-02   -6.800503833893921e-01   -5.850644028828151e-01   +6.030520514016835e-01   +2.790171972646536e-01   +2.511389878359458e-01   +9.481642345472263e-01; -3.939572478594421e-01   +2.461291147837199e-01   -1.097358263296605e-01   +4.814925350575299e-02   -7.227143512833740e-01   -3.717672128430652e-01   -3.634630141924121e-01   -6.671858510608921e-01   -1.342211063582470e-01; +5.156823484968364e-01   -5.326828503123476e-01   -8.680483714590544e-01   +1.909870248162611e-01   -7.564516101826927e-01   -6.536299292367351e-01   -9.936646118539554e-01   +3.262969115312244e-01   -5.596478511314259e-01];
L1_L2_iAMPA_netcon = [-3.696971971948590e-01   -1.836043215530358e-01   +4.662809559544877e-01   +5.959497012630498e-01   -9.234182364316804e-01   -9.531616043525933e-01   +4.304038564659182e-01   +6.261798262429086e-01   -9.635330559104281e-02; -5.305115219705686e-01   +2.359225693789633e-02   -6.696420278999433e-01   +2.672802661733475e-01   -7.069663758806268e-01   -2.146800124155430e-01   -1.781459319512652e-01   +3.064071275766470e-01   +4.778452188674120e-01; +1.460029702623176e-01   +7.705908943650623e-01   +2.835939744576658e-01   +3.643297517258510e-01   +9.303997981427732e-01   -6.816814992931507e-01   +2.418546239950690e-01   +9.099901658794836e-01   -1.624132903822824e-02; +7.405551789624069e-01   -3.322853441313997e-01   +6.796684026332769e-01   +6.545150878470915e-02   +6.509920143933324e-01   -7.771216226266124e-01   +3.468196767464126e-01   +8.061924031171385e-01   -2.990395514815828e-01; -8.125604526302550e-01   -9.960043015999974e-01   +1.000000000000000e+00   -4.062226225243643e-01   +3.525229445113819e-01   -3.893195708786829e-02   -3.921039545374949e-01   -6.803941406568326e-01   +1.046653298420363e-01; -2.658296251612469e-01   +3.698989304674622e-01   -6.170243016453528e-01   +5.888232821504423e-01   -6.755548411168264e-01   +6.193941380730512e-01   -4.655238556991259e-01   -3.235002649456054e-01   +3.449252982722402e-02; +6.960684011592564e-01   +4.406984516579679e-01   +5.302055599450480e-01   -4.179609341589207e-01   -9.551172682435031e-01   -4.095087443095914e-01   -9.586252845765678e-02   +8.436549506663086e-01   -1.668460758721413e-01; -8.948489686595870e-02   +5.435643531135723e-02   -2.786644673662027e-01   -9.424770479768722e-01   -7.655426206926257e-01   -7.757998924160979e-01   +6.136630451287785e-01   +9.498061719590818e-01   -7.488772771959363e-01; +5.589253437261374e-01   +6.709410936334290e-01   +5.179997402127835e-01   +7.536445708090024e-01   -5.593639247707729e-01   +5.121592728946505e-01   +1.343511018610369e-01   -5.093380259259171e-01   +8.490931772928958e-01];
L2_L5_iAMPA_netcon = [-8.489150551043723e-02   -6.942422211920135e-01   +1.907941878118419e-02   -2.150592224656016e-01   +1.508732457319171e-01   -1.885092347656753e-01   +2.623087147209124e-02   -9.799745735043970e-01   -5.715067969368821e-01; +3.166919085386493e-02   -6.126369746238916e-01   -1.000000000000000e+00   +4.197519810489642e-01   +4.582817621296626e-01   +7.079069551144768e-01   -3.511800829956387e-01   -8.456557837203812e-01   -8.043586459653600e-02; +9.523124907775218e-02   -9.379053175469447e-01   -9.258927477752451e-01   +7.970616773374190e-01   +3.457475140571375e-01   -3.243635291253105e-01   -5.005352559475888e-02   +2.099804332821408e-01   -1.146138210820102e-01; +2.771027244946810e-01   -5.872407138658154e-01   +6.988581651900027e-01   +9.886170309860011e-01   -6.685117104701568e-01   +9.353217991856403e-01   -8.985069043281717e-01   -7.201194969788759e-01   -4.470350705410830e-02; +6.167792265443974e-01   +3.863977359174409e-02   +9.481333387058083e-01   -3.925588366907755e-01   -5.160038468262889e-01   +5.061217472797589e-01   +5.246575296228632e-02   -7.126970815671690e-01   +6.393003621730556e-01; +8.858106600090455e-01   -5.150323368424431e-01   +3.171137983567474e-01   -2.937562370975439e-01   -3.551008317116726e-01   +6.082392511546495e-01   +7.970171779201348e-01   +5.735147499434063e-01   -4.152956059207571e-01];
L5_L2_iGABA_netcon = [-6.794770089450569e-01   -1.215866720130503e-01   +5.905749493326220e-01   -6.333953816773628e-02   -7.693944354268748e-01   -2.233127266781753e-01; -8.499785970942245e-02   +9.847111348643847e-01   +8.750864376682849e-01   -3.944726334049666e-01   +4.551011712797801e-01   +5.487769399987875e-01; +7.180078048816620e-01   +7.437598995967701e-01   +7.838252638654805e-02   +8.000205745046917e-01   -4.625121236421901e-01   -1.281536358248773e-01; +6.674052757575559e-01   -5.509939879901757e-01   -2.213438206153876e-01   -4.407593326993722e-01   +1.000000000000000e+00   +4.959838096323958e-01; -9.605834678373982e-01   -3.058372562810536e-01   +9.383381009264465e-02   +8.641297285755958e-02   +9.738712598390153e-02   +5.791810216864887e-01; -1.918610689446935e-01   +2.791806783113264e-01   +3.133228332534219e-01   -3.025308192089011e-01   +4.246464141333036e-01   -2.909765116615490e-01; -4.896521081289201e-01   +5.474270641835208e-01   -8.465465949930450e-01   -5.393960315946362e-01   -1.385107695983129e-01   +9.623452046338631e-01; +8.576632940336265e-02   +8.567268321701782e-01   -8.253057646688645e-03   +9.712322095856498e-01   +8.684836107064935e-01   -7.954276928445327e-01; +2.600662446342802e-01   +5.661772136360742e-01   -1.492785591330041e-02   -4.774308421931573e-01   +4.755500577651892e-02   -1.073264625941385e-01];
L3_L2_iAMPA_netcon = [+6.252432287282407e-01   -9.560762981479111e-01   -8.409556446266819e-01   +7.165960844213907e-01   -3.396448564361199e-01   -8.698575384411713e-01; +6.882515949173863e-02   +1.895456962773399e-01   -6.709494579893990e-02   -2.419483678464656e-01   -6.205594039231966e-01   -3.911335252566873e-01; -9.751347522444754e-01   -8.125911686748583e-01   -4.701284486677313e-01   -7.327609567518820e-01   -3.502273606852944e-01   -5.185557292867092e-01; -3.446265093948781e-01   +9.036138433334501e-01   -5.654435456443654e-01   -9.150321837478710e-01   -3.330459180634140e-01   +8.994938581869675e-01; +5.650880906221980e-01   -8.029672531578320e-01   +1.557284664760647e-02   +2.437782606264542e-01   +9.466153071621717e-01   -1.000000000000000e+00; -3.851648515491201e-01   +4.457163400139730e-02   -5.153139131855604e-01   +5.098335977304419e-01   -9.248342929718847e-01   -7.098238468466321e-01; -3.287169117704350e-01   -9.127985450709580e-01   -5.153056337461053e-01   +1.275628181178906e-01   +3.694602439195395e-01   -6.170740201765886e-01; +3.098907311575970e-01   -8.863490267702209e-02   +8.648263592401583e-01   -3.629266281299856e-01   +1.699383929480784e-02   -1.826698997403697e-01; +3.205278930105133e-01   +5.260258738095958e-02   -2.841864377646298e-01   +6.702719287184441e-01   -1.481889567445456e-01   +5.918013156078781e-01];
L2_L3_iGABA_netcon = [-3.851909218058825e-01   +5.017597687311919e-02   -1.365109832993560e-01   -3.848532163697521e-01   -1.000000000000000e+00   -4.086156108622278e-01   +3.052183309199747e-01   +8.331960058904339e-01   -9.500601998148143e-01; +5.735381126513754e-01   -2.291350735894825e-01   +1.201649796651847e-01   +3.687946054772769e-01   +5.162630114047839e-01   -6.396946446964199e-01   -3.311645042557739e-01   +3.825202879751775e-03   -1.904780777369777e-01; -8.203273908118880e-01   +7.958522579073006e-01   -8.635909068202585e-01   -6.070375546989927e-01   +9.073219444445878e-01   +3.834237329311936e-01   +8.393392248333625e-01   -7.684793417870023e-01   -7.432416358461726e-01; +6.855553931757431e-01   -8.506796340659281e-01   -9.515808562688669e-01   -4.825180849634003e-01   -4.997805523484321e-01   -7.827879217099343e-01   +9.732308440620396e-02   -5.624718783909096e-01   -1.234502671436651e-01; +2.662730773238600e-01   +3.600221755455176e-01   -4.012267395050349e-01   -3.610757705364310e-01   -8.804775574003747e-01   -6.058992215665999e-02   -3.692444022459042e-01   -1.875094267401573e-01   -5.392884046069448e-02; -1.407039295288824e-01   +9.718460635706194e-01   -4.065682185703121e-01   -9.048248388808390e-01   +6.825620855980932e-01   +7.540484325797916e-01   -8.945662210585594e-01   -7.378082981183020e-01   +4.071633258446918e-02];
L1_L4_iGABA_netcon = [+8.073246092042895e-01   -6.249810798920064e-01   +8.091660636048106e-01   -8.264528664260568e-01   +7.827425387917075e-01   +5.003957708450598e-01   +8.663915628462409e-01   -3.647267656097818e-01   +2.066903640186836e-01; -8.291437603880921e-01   -9.837130122488218e-01   -2.585399420050280e-01   +6.462669856040074e-01   -1.848760883318693e-01   +8.389321528347105e-01   +8.081421044752097e-01   +3.053287371428059e-01   -4.482851404229829e-01; +4.014393483155946e-01   +7.588985065956239e-01   -1.363700460386330e-01   +5.099330487033482e-01   -1.413168321929157e-01   -4.975309477198320e-01   -1.118503046867765e-01   +3.259332960123424e-01   -8.114967127294903e-01; +9.642113592039147e-01   +1.689927154781233e-01   -2.121775388016448e-01   +1.000000000000000e+00   +1.754723207297074e-01   +2.388896016177237e-01   -7.285472204350936e-01   +2.321174361009581e-01   +3.145816464317216e-01; -5.972911305284279e-01   -7.709884945225928e-01   -4.485177349064825e-01   +9.779375509858990e-01   +6.447559410821568e-01   +8.615034564717312e-02   -1.422538695075952e-03   -8.973131976474910e-01   +9.171345335531532e-01; -4.448112031895612e-01   +3.908851708435807e-01   -8.108287898219546e-01   -4.227187218827653e-01   -6.665236693696337e-01   -4.678186422082714e-01   -9.467341625611092e-01   -8.939175070840098e-02   +9.214009436231446e-01; +2.039462705148921e-02   -2.424492195076730e-01   +3.125570133399546e-01   +3.346514665258035e-01   -7.070993108004329e-01   +3.030695938508167e-01   -2.236156355801032e-01   +1.597189780322764e-01   -1.358771418894869e-01; +5.471258260704896e-02   +4.567766757182692e-01   +6.645474417352677e-01   -6.663780817008335e-01   -8.036824439056475e-02   -9.452758599102241e-01   +2.256157766701031e-01   -7.195167534066697e-01   +1.793215367678620e-02; -8.736887628863174e-01   +3.064282834082022e-01   -2.500958978339233e-01   +2.914322288516814e-01   +4.761716480996218e-01   -4.486725923093808e-01   +8.422052329365064e-01   +4.976985633748481e-01   -8.729683501571046e-01; -9.638885718004986e-01   +3.363691900059591e-01   -1.225284525112923e-01   +7.769732183406352e-01   +3.820082937380090e-01   -7.793802429593141e-01   +1.191235467708168e-01   +7.811293260987653e-01   +4.146972466626350e-01; -8.351942305290698e-01   -4.994899693830937e-01   +7.183724408432480e-01   +2.682091431627998e-01   +2.239402070535500e-01   -9.248456919687019e-01   +9.485914543052985e-01   -5.338729512026841e-01   +5.602271745475860e-01; -1.442476569156022e-01   -1.926653743613957e-01   -9.529696568880274e-01   -7.620684302102165e-01   -2.522923605906315e-02   +9.705516536242081e-01   -7.850982779737643e-01   -7.370437716519643e-01   -5.622720287359994e-01];
L4_L1_iGABA_netcon = [+6.394794739704979e-01   +1.278210348758539e-01   -1.354362003583314e-01   -7.132064010575931e-01   +1.120227929081105e-02   +8.323522295067229e-01   +5.289553399040372e-01   +4.811446701239421e-01   -4.369698850007185e-01   -6.980951648954182e-01   +4.392224966876445e-01   -3.698078905812419e-02; +2.631998763020951e-01   +1.298521207427187e-01   +4.006639892732995e-01   -7.611049706184131e-01   +3.548083932344315e-01   -5.673287680167001e-01   +4.349930536511979e-01   +2.564793868598791e-01   +2.811476185263592e-01   +7.353999411124079e-01   +5.911238801858560e-01   -1.098082833010772e-01; -1.823145974542638e-01   +6.112640653366251e-01   +7.667480885338026e-01   +3.511704095378314e-01   +4.924110304227192e-01   -8.733799943792377e-01   +7.234619713391956e-02   +1.514604772375797e-01   -4.255372021613113e-01   -9.408711180167441e-01   -3.795959065052826e-01   -7.795946263097777e-01; -8.412064941797518e-01   +1.000000000000000e+00   +7.329089463204684e-01   -5.843904452574210e-01   +4.238818947348887e-01   -9.401629178379425e-01   +2.787474968885862e-01   -4.385185057223041e-01   +2.015109830645484e-01   -4.246998312681214e-01   -2.697387598321195e-01   -8.048540372163249e-01; +2.432718333868954e-02   +4.780155873784736e-01   +6.150400234128200e-01   -2.823301650381791e-01   +7.575337154322578e-01   +9.138174012490097e-01   +9.570608919229963e-01   +2.981947541381383e-01   +8.733801597846345e-01   +5.851661627364625e-01   +7.460092204604140e-01   -4.123054468594813e-01; -6.232639056411947e-01   -4.211738664222581e-01   -3.968220752238344e-01   -3.095223143163560e-01   +5.822891583265268e-01   -1.082148747396592e-01   +6.550736575024064e-01   +6.989820284928866e-01   -2.690006576869774e-01   -4.475414001878860e-01   -2.507884248055036e-01   -9.486432430372387e-02; +9.328240608972274e-01   +4.964797788811590e-01   -9.530253054024099e-01   -7.364492838279396e-01   +5.222435150491707e-01   +1.934537301332744e-01   +4.955044491832522e-03   -4.837528325285901e-01   +4.547315349276038e-01   +4.576309650879462e-01   -1.214895154239760e-01   -1.621804623090421e-01; -5.713245622691127e-01   -2.130017831164218e-01   +3.655179823396958e-01   -4.490807303163768e-01   -7.337935827650521e-01   -4.243248056712508e-01   -6.776442961830172e-01   +7.272506619893099e-02   +8.455596931345306e-01   +2.228723460362624e-02   -9.043862092586069e-01   +2.078275158482205e-01; -3.067441733485058e-01   +1.986914769605473e-01   -6.663562980252843e-01   +6.413353332634428e-02   +3.978876100837053e-01   +3.078259404921169e-01   +2.494535111295280e-01   -1.717797433706507e-01   -4.228293381513397e-01   +3.281109783895035e-01   +5.718742255440864e-01   +8.388444890721998e-01];
L1_L3_iAMPA_netcon = [+8.220738673773006e-01   -9.150858335455315e-01   -1.154911032692491e-01   -5.622468116509903e-01   -3.395060359748876e-02   -8.576317879426784e-01   +5.919826786323380e-01   +1.070423482142279e-01   -1.860951885793342e-01; -5.376985140123833e-01   +1.120969014811010e-01   -3.196940082668500e-01   +9.291259253784316e-01   -5.528484891992644e-01   -9.901525341543701e-01   -9.557894743307978e-02   +9.202350867879960e-01   -3.125409728088585e-01; -4.390161993001344e-01   -1.367424560938630e-01   -6.581664870959496e-01   -4.289113147635964e-01   +5.593514418893990e-01   +9.215857402722502e-01   -2.519479697562708e-01   -2.397732572581958e-01   +9.728417356971830e-01; -2.949677860158850e-01   +5.052732959099621e-01   -7.983845766798646e-02   -9.238737402203037e-01   +4.367346851565367e-01   -3.592597428505486e-01   -8.071566339382039e-01   -5.636470027775914e-01   +7.472339000622949e-02; -2.658931312522335e-01   -5.881124544170644e-02   -2.948014106097196e-01   +7.435778470724816e-01   +8.902384723473304e-01   +2.970437784190036e-01   +8.439532033734218e-01   -1.000000000000000e+00   -2.116257128066824e-01; -8.502034947192213e-01   +9.192934023367748e-01   +5.096376029845136e-03   +1.727162421863368e-01   -7.663712828529693e-01   +4.514296504937135e-01   +3.911608856184428e-01   +8.295251228670533e-01   +2.703670256842400e-01];
L3_L1_iGABA_netcon = [+9.479516715870657e-01   -2.372674569591840e-01   +9.606027307848320e-01   +4.302615564904381e-01   -9.324930134569134e-02   +2.835572849370944e-01; +1.598831865936148e-01   -5.170604375609226e-01   +1.738161562706366e-01   -3.809207907531869e-01   +5.957365620532482e-01   +3.391516793088962e-01; -5.812678220380043e-01   -6.534159784929353e-01   -6.422761890366013e-01   -2.044195072164565e-01   -3.576168565461594e-01   -9.386689797267996e-01; +7.592510034796655e-01   -8.196150829571077e-01   +3.054682004798315e-01   +4.616566465534455e-01   +4.048482553264499e-01   -7.470412042240838e-01; +5.717134443547005e-01   -5.824506283159623e-01   +3.027695334203272e-01   -5.307221157410494e-01   +6.055965875874156e-01   -6.981692839155801e-01; -5.256016002304323e-01   -9.479931972811889e-01   -8.868970733009642e-01   +1.876930505205195e-01   -3.579478061528031e-01   -3.641749814150856e-01; -9.968622933289096e-01   -6.948796003466221e-01   +5.035927735195512e-02   +2.915600154397248e-01   -1.934574635378132e-02   +2.266228961715911e-01; -7.195709195339809e-01   +2.045544962932772e-01   +2.081784445516197e-01   -9.342886211870018e-01   -8.313446573643027e-01   -7.429057091768577e-01; +3.766952739762872e-01   +7.527156613538772e-01   -5.553326492159034e-01   -5.799348857622786e-01   -4.682394640157211e-02   +1.000000000000000e+00];
L5_Input1_iAMPA_netcon = [+8.607195776810823e-01   +7.699701813586503e-02   -6.267474437650999e-01   +7.620117294480981e-01   -3.966159720433279e-01   -1.000000000000000e+00];
L6_Input2_iAMPA_netcon = [-4.904176458576927e-01   +1.000000000000000e+00   +5.261208320048353e-01   -8.583366522606143e-01   +1.907646062000247e-01   -6.095612780414360e-01];
L5_L6_iAMPA_netcon = [-8.760900798618259e-01   +4.590787546866715e-01   -5.414016766499637e-01   -3.887461470854530e-01   -4.797512353989314e-01   +9.404850877326355e-01; -4.828268663478358e-01   -4.090594249906296e-02   +4.247492968433569e-01   +3.647555000532232e-01   -2.325573796734439e-01   +5.403902311023819e-02; +5.352583422287889e-01   +6.962157619416022e-03   +2.753714659914752e-01   -9.491959269578341e-01   -3.915674956547423e-01   +4.521317489155024e-01; +6.687119375906756e-01   -9.483343367761540e-01   +2.672304590205402e-01   -1.050890503557185e-01   +8.234125580256978e-01   -5.569521291080207e-01; -5.701140841338789e-01   -7.837455175058671e-01   -3.560102815249941e-01   +9.327701771042600e-01   +2.556180599316950e-01   -2.893840804812770e-02; -6.968048890679711e-01   -9.301323075122431e-01   +8.440341684761745e-01   -1.000000000000000e+00   -5.185709746983721e-01   +6.604416322435933e-01];
L4_L5_iAMPA_netcon = [-2.030330141753330e-01   -4.637054220083668e-01   -9.526587313009506e-01   +7.876291143595014e-01   -7.556430647267117e-01   +7.560056098749522e-01   +7.096222106733205e-01   +8.057922460337028e-01   +9.597379045874185e-01   -3.547179929788914e-01   -1.456189354566386e-02   +6.447673809237177e-01; +6.188408163349738e-01   +7.605379369768203e-01   +3.680716550334949e-01   +3.500330336785722e-01   +9.320756873084975e-01   -1.224703541702793e-01   -1.809365566015296e-02   -5.255961540038060e-01   -1.000000000000000e+00   -8.395816184140892e-03   +5.158520720402574e-01   -7.601513487822361e-01; -3.271956192924366e-01   -1.512874863005995e-01   +7.660560998912138e-01   -8.605277189526731e-01   +7.841111809789452e-01   +8.749184483818112e-01   +5.898461749873051e-01   +1.756416608324411e-01   -2.039035754787316e-01   -8.377771955733507e-01   -8.820249308143931e-01   -9.389293257165734e-01; +2.399831688231591e-01   +7.871526190308206e-01   -6.510336691733611e-01   +3.027433799272601e-01   -4.963693289238120e-01   +2.002156930284600e-01   +9.015958111606457e-01   -5.329155628317618e-02   +5.803255592880364e-01   +2.681576023595216e-01   +2.023782143844326e-01   -7.867982592619800e-02; -7.397709411351779e-02   -7.380215476272645e-01   -8.650648379295766e-01   +5.246531700786469e-01   +2.793639716181159e-01   -6.064618895856106e-01   +8.856977592213594e-01   +2.135649415270729e-02   +7.935315454841784e-01   -4.749603060381281e-01   +7.534545627863929e-01   +9.546533989371456e-02; +2.964908274729324e-01   +8.400895214218930e-01   +9.557522585541600e-01   -2.218713320338285e-01   +1.589765521467640e-01   -1.067722876355339e-01   +4.938989970888376e-01   +8.927208555341302e-02   -6.026770130083442e-01   +2.534186206427658e-03   +7.166965725323413e-01   +4.685688902691618e-01];
L6_L4_iAMPA_netcon = [+3.634652531362640e-01   +5.836942036412489e-01   -5.561842141170945e-01   +1.362865322420819e-01   -5.895093923101147e-01   -2.344683685078531e-01; +8.731412948110544e-01   +7.931976099152842e-01   +9.985397662973863e-01   -4.395274082758115e-01   +2.550849151335007e-01   -8.409885997757144e-01; +1.964308026014190e-01   +4.963845298594212e-01   -9.522473435533807e-01   -9.333706455190753e-01   +4.208505603680086e-01   -3.152693763772054e-01; -6.632706424425914e-01   -1.183866511882209e-02   -6.416933288996151e-01   +1.140106695237476e-01   +6.137363426708528e-01   +9.145465634471321e-01; +5.353742517045553e-01   -1.350049279280864e-01   +7.762745753699020e-01   -8.757905829875106e-01   -3.259717966153502e-01   -8.444561365127998e-01; -6.157683218302310e-01   -6.948936710347116e-01   +2.894897487733591e-01   -8.513910433198898e-01   +7.088091770064532e-01   +5.228946249779417e-01; +6.844313735686558e-01   -4.481854334473466e-01   +6.720251170114047e-01   -3.087617246441854e-01   +7.653993812000501e-01   +7.341736969407375e-02; +4.198232035107771e-02   +3.717329556885043e-02   +8.404341065018084e-01   -6.247958474228841e-01   +9.280593978068988e-01   +5.709484969892172e-01; -2.478182174962050e-02   +9.941275626367285e-02   -7.660222618190606e-01   -4.675635008622077e-01   +2.110016280762547e-01   +2.871741428664815e-01; +6.506410549172171e-01   -7.717670482902775e-01   +1.928323987735580e-01   +8.792330970742558e-01   -3.909558113225012e-01   +6.242161132792280e-01; +3.083861745141594e-01   +1.644458648624425e-01   +5.491088925006788e-01   -1.502281184211698e-01   +2.411854479793357e-01   -1.000000000000000e+00; -2.217998544126704e-01   -9.159767537765878e-01   -4.586949007174551e-01   +3.509867426322896e-01   +5.411521339703926e-01   -1.380347963988461e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
