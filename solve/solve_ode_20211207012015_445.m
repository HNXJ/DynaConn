function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.653569137360204e-02   +1.396973396418598e-01   +5.838305911998496e-02   -4.175291551852823e-01   -1.238019497804882e-01   +8.198876909153166e-02   -4.885046219307549e-01   -4.777669286190754e-01   -5.420220250955494e-01; -4.464373780311977e-02   -3.628995209118701e-01   -2.899532800677095e-01   -2.664074040420877e-01   -3.228341419847470e-01   +4.791715059427622e-02   -2.384738293490823e-01   -1.992065764640659e-01   -1.861088629580095e-01; -2.249623526911026e-01   +5.371261546144759e-02   +1.785934153188700e-02   -6.019205589691612e-01   -3.584039220623975e-01   +1.583478572044958e-02   -3.025389265866958e-01   +1.687892804258646e-01   -4.698963174648793e-01; -1.945181728651099e-01   -9.963155347257419e-03   -3.797599075007543e-02   -1.522741260281973e-01   +2.596741919281048e-01   +1.039038355735429e-01   -3.701621750672589e-01   +8.151383918408295e-02   -6.164174883856442e-02; -1.724779305326169e-01   -3.155128392921143e-01   +7.488674496795827e-02   +2.618652479948060e-01   +3.618421272986630e-03   -1.955402776722494e-01   +1.844462586067420e-01   -4.229357673462220e-01   -3.351769928868891e-01; -6.394191843455438e-02   +3.118104486034105e-02   -7.548998187751169e-02   -2.350840755226381e-01   -3.584546056901955e-02   -1.160516604800674e-01   -4.020723083755542e-01   -1.528843537316209e-01   +2.891844217820605e-01; -6.812904188470384e-02   -1.868343035129857e-01   -3.578012777343812e-01   -3.360971374431742e-01   -6.331539684878666e-01   -3.391257678896472e-01   +1.104529966329596e-01   -2.582338069150668e-01   -1.907063618505773e-01; -3.080126227967759e-01   -4.032126769793730e-01   -4.183444008579082e-01   -2.763559304697175e-01   -1.631372521550712e-01   +2.768321555516733e-01   -3.047272512020059e-01   -4.569621449462801e-01   -6.280529786887555e-02; -4.164733741853848e-01   +1.489195844646118e-01   +3.834151646590728e-02   -9.961607459400695e-02   -2.689997967631705e-01   +1.019882948574949e-01   -1.927369978346696e-02   -3.437478984469977e-01   -4.162647427732872e-01];
L1_L2_iAMPA_netcon = [-2.233285222554903e-02   -3.292315652546026e-01   -3.486994610053067e-01   -1.754458806864004e-01   -5.059097943061267e-01   -1.136605023754356e-01   -1.117417370219082e-01   -1.290989194453123e-01   -4.105527788081169e-02; +1.109572208627073e-01   -3.816301447420906e-01   -2.806658717452482e-02   -1.772604562837055e-02   -8.941270088072642e-02   -3.959410927961395e-01   -1.476329833595494e-01   -3.529725850746659e-01   +3.245856850401885e-01; -1.485419661289852e-01   +5.367127826378471e-02   -6.523436942327869e-02   +1.557296955712502e-01   +1.272297612080439e-01   -4.522846356283380e-01   -3.269011219649984e-01   -1.830065152285630e-01   -2.116774001199067e-01; +3.953900620419649e-03   -2.407403132271832e-01   -2.749238100636772e-01   -3.403526016022792e-01   -2.137457054252115e-02   -5.830374787470381e-02   -4.078721377586885e-01   -2.861344366677491e-01   -5.185682886638803e-01; -2.821066700683103e-01   -3.848618517794429e-01   -6.342287431652183e-02   -2.304808540967487e-01   -4.597732986514955e-02   -8.621776943670914e-02   -1.153697012895283e-01   -9.150798521658100e-02   -3.410620995598768e-01; -5.646169617925150e-01   -2.165689733552762e-01   -5.898723936780688e-01   +3.654254274802677e-01   -1.403381945226826e-01   -6.186505694074224e-01   +5.211483396274888e-02   -1.584618026839910e-01   -2.176177107831664e-01; -2.524730353729155e-01   -1.754149402690276e-01   +1.095158269494822e-01   +3.266871622485890e-01   -1.713572857901197e-01   -2.353252860827850e-01   -3.124425427856674e-01   -6.908783647812490e-02   +9.738250197676405e-02; +1.267665526924633e-01   +1.198186679973262e-03   -2.189193592637051e-01   -1.935093006160665e-02   +6.390844407562299e-02   +1.835554550896359e-01   +3.861697118279495e-03   +3.039794090445628e-01   -2.298242196873681e-01; -5.178805155599369e-01   -4.051987103755881e-01   -5.169503111055163e-02   -2.863416702831557e-01   +1.965705840525764e-01   -4.465267048908218e-01   +1.745043842212940e-03   -1.150485759297036e-01   -1.619691025626389e-01];
L2_L5_iAMPA_netcon = [-2.887419077624892e-02   +2.125695828320244e-01   -2.001765615785794e-01   +1.613784514937848e-01   +3.212979052874634e-02   -1.297470377680482e-01   -3.465662615519552e-01   -4.686495547907980e-02   -3.479310516056444e-01; +1.219108354292659e-01   -2.849213509525310e-01   -4.358039289900080e-01   +2.709108192462351e-01   -4.698145822488784e-01   -5.437715257736696e-01   -1.606040581947911e-01   -3.003116518985899e-02   -1.066330331704994e-01; -6.308428633548599e-02   -7.393012118337657e-02   -2.567598216364093e-01   -1.821160519215836e-02   +2.257051966527304e-02   +3.549552890477861e-01   +1.238606558159782e-01   -5.140479802049752e-01   -1.573521209825419e-01; +2.010113095411603e-01   +1.157389441965629e-01   +1.422756789421072e-01   +2.481023449394395e-01   -4.098438612640066e-01   +3.838942271704579e-02   -3.948655106499137e-01   +6.304458115256752e-02   -3.447439725049696e-01; -3.748080119739689e-01   -2.850093455613374e-01   -4.802181077183323e-01   -4.203512530628018e-01   -5.721725855689654e-01   -5.500626528753196e-01   -1.847380556601776e-01   -2.491775840972393e-01   -1.581298700294986e-01; -2.731268515855907e-01   -2.958880914928949e-01   -2.728262526714538e-01   +1.300680826880239e-01   -1.154596464111834e-01   +1.199038251945622e-01   -3.109108861963346e-01   -2.027400946874783e-01   +2.146734656303240e-01];
L5_L2_iGABA_netcon = [-2.573975665181988e-01   -1.116460663987145e-01   -4.995195756387296e-01   -2.033164394752573e-01   -2.335398885091785e-01   -1.939350839129386e-01; -1.002944870126508e-01   +1.130340365924487e-01   -2.043984086802950e-01   -4.074548157567608e-01   -3.362109368851127e-01   +5.016969078337391e-02; -3.870556490469538e-01   +1.870289048609817e-01   -4.732739342196543e-01   -8.556356090728059e-02   -5.281835500357626e-01   -6.359072880699285e-02; +8.821029599565625e-02   -6.616501450166679e-02   +2.253960161822264e-01   -2.222228570305914e-01   +1.226436126505484e-01   +6.774448595907376e-02; -3.291669086615533e-01   -3.388136990715794e-01   +1.676977799241999e-01   +9.507804693463491e-02   -1.615007437661317e-01   -2.278215315277959e-02; -1.639416462278516e-01   -2.629534613285767e-01   +1.023511573847934e-01   -2.477210536084667e-01   +1.228271345443385e-02   -2.683485167265718e-01; -1.501706790686754e-01   -1.985248354841498e-01   -2.953065405529166e-01   +2.144424320420750e-01   +1.271849972057179e-02   +1.111186885729120e-01; -2.926222329795903e-01   +9.493357717171508e-02   +1.378657679346037e-01   -1.907905061677282e-01   -6.030366340914216e-03   -3.173212781851721e-03; -9.802901211784738e-02   -6.354818950710366e-01   -5.189362243689256e-01   +1.018066845741695e-01   -5.869671487190750e-02   -2.182008532487373e-03];
L3_L2_iAMPA_netcon = [-1.890033101034842e-01   -2.794002548327041e-01   +2.640561331839086e-01   -5.809724902945349e-01   -4.783687532776716e-02   +2.902031581608460e-01; -8.561167580988839e-02   -3.703613949538529e-01   -6.209427759349334e-02   -1.212579809220400e-01   -2.351873114852773e-01   -1.104867888213199e-01; -1.329662108164042e-01   -4.380771920317104e-01   -3.470882962091195e-01   -4.123568212468620e-01   -1.206247832664298e-01   -2.564737534254384e-01; -6.226803938116215e-02   -3.084550262334346e-01   -2.628304882333137e-01   -1.275179817711327e-01   +5.457387722198066e-02   -1.908252273398467e-01; -1.685813823511163e-02   -1.325217512577543e-01   -2.609064979218808e-01   -1.804529748427797e-02   +5.399499381002348e-02   -4.257471125251511e-01; -5.518762800277019e-01   +4.451884242352985e-02   -5.749649220032167e-02   +6.891920038459114e-03   -4.550425816633181e-01   -2.561445403837559e-01; -1.528317470769311e-01   +1.574291778407131e-01   -5.560863378581489e-01   +1.302864164562154e-01   -1.036507608387797e-01   -3.955648767291757e-01; -3.096847656832658e-02   -1.113646869123523e-01   -1.120594571091299e-01   -3.171834787284603e-02   -8.827686239599858e-02   +2.499397101788130e-02; -5.087845797423773e-01   -1.388264562347174e-01   -1.741119432505545e-01   +1.883148143730302e-01   -1.041184366732247e-01   -3.935689633299902e-01];
L2_L3_iAMPA_netcon = [-1.988829243500223e-01   +3.851844116287725e-02   -1.875399694344820e-01   +2.536414534592524e-03   -3.240193203142245e-01   -5.768184514294263e-01   -5.099111488190502e-01   +2.490909877562544e-01   -1.736401501079650e-01; +3.072826913741774e-01   -4.521109794724354e-01   -4.193158768251035e-01   -1.934093693783313e-01   +4.892002655116745e-03   -1.046146479016700e-01   +8.318592772366365e-02   -2.879337679625285e-01   -3.113958979601503e-01; +1.913270608271871e-02   -2.021414459867845e-01   -1.936422213517812e-01   -3.147560639149983e-01   -4.549462604649590e-01   -3.710813029630792e-01   -9.129255408215640e-02   +9.831946425147718e-02   -1.507765197099326e-02; +1.559226878690917e-02   -2.752795342021561e-01   -2.050239369510525e-01   -7.919898987881063e-03   -3.764154119889544e-02   +2.107542388710763e-01   -2.849194760674190e-01   +2.811641279388657e-01   +2.708020316025319e-01; +6.451933139903446e-02   -5.362547707089407e-01   -3.220533482103087e-01   +1.309454171679226e-01   -3.367530770056088e-01   -3.604705726205693e-02   -5.075461003725507e-02   -5.832689969202853e-02   -5.187971008827448e-01; +4.212840634119433e-02   +9.973284382138464e-02   -2.134138617748283e-02   -2.033224053216247e-01   +7.061993437144637e-02   -3.614822178102965e-01   -4.516520981962627e-01   -2.841555660899629e-02   -2.530908003279043e-01];
L1_L4_iGABA_netcon = [-6.522600960526286e-01   +6.483700391033312e-02   -2.968922515927437e-01   -3.550375007509783e-01   +3.790816431251579e-02   -3.461663729685009e-01   -3.060714965242962e-01   +9.554365719878027e-03   +2.608644900575501e-02; +2.456995362516476e-01   -4.514683205189557e-01   +1.189379564914132e-01   +3.669898868721155e-02   +3.862658142975356e-02   -4.538840490733531e-02   -7.730790318762032e-02   -2.681731256695293e-01   -2.548936544850848e-01; -2.560950246033188e-01   -1.967090009737426e-01   -1.196660017341612e-01   -3.164223366576535e-01   -2.956128950505630e-01   +3.731487929199240e-02   -2.861275408451502e-01   +2.107561208310769e-01   +1.352219664482415e-01; -1.347174357851505e-02   -3.386533677056162e-01   -8.080608893491506e-02   -2.576472125742617e-01   -3.433506461390827e-01   +1.944274109906851e-01   -2.292135371873102e-01   -1.375881582325580e-01   +1.682808557852920e-01; -5.321598333342395e-02   -1.617128357047423e-01   -2.760169510237909e-01   -1.886126619506701e-01   +4.366436254217260e-03   -3.334856507608155e-01   -3.784405126920524e-01   -2.636458218404450e-01   -4.025097329114710e-01; -2.948576902030534e-01   -3.076451639421099e-01   -1.444432201050898e-01   -7.061764668486542e-02   -7.815371698340268e-02   +7.622455480324480e-02   -9.002320005462006e-02   -7.997311213926103e-02   -9.943518163144011e-02; -1.141168477638368e-01   +2.180255256271213e-02   -3.756807690690572e-01   +7.696111929195218e-02   +3.543747557283801e-01   -9.742152543517799e-02   +8.931419743449640e-02   -1.703333739173860e-01   -1.614421633810086e-01; -4.008378650323622e-01   +1.030975622175225e-01   +2.596807300618421e-01   -3.300185758776046e-01   +4.816897437099708e-03   -9.610641839525227e-02   +9.315042456461994e-02   -3.411233352264400e-01   -3.174212758675029e-01; -2.282075832546507e-01   -3.153844855780671e-01   +2.714392961686510e-01   -8.369477257580415e-02   +5.144154921261519e-02   -1.813453042612823e-02   -2.579127693597874e-01   -1.450146564777804e-01   -7.833587322723883e-02; -3.564258230288451e-01   +7.165431914701575e-02   -2.265841388865701e-01   -1.847287708994349e-01   -1.621737561141549e-01   -5.310716226250549e-01   -4.480634592194380e-01   -1.941768478521336e-01   +2.511462025385022e-01; -3.687449153988221e-01   +2.732572534280436e-01   -2.343153964420653e-02   +1.008546359165302e-01   -1.806211416647026e-01   -4.892732146078819e-01   -3.343967194720385e-02   -1.917233016563465e-01   -3.241308837708080e-01; -3.109365474482876e-01   -7.422563601148954e-02   -8.294318167492960e-02   -4.072993067038645e-01   +4.806737249186599e-02   +2.658816322994293e-01   -5.822615658055395e-02   -4.404412556196299e-01   -9.240041241735943e-02];
L4_L1_iGABA_netcon = [+1.464953101904124e-01   -1.635428139440301e-01   -1.896177645733209e-01   -2.567037962510954e-01   +4.981615053748781e-02   -3.961913432542460e-01   -3.859599266834730e-01   -1.681553420984410e-01   -7.111524452462543e-02   +1.145301132685501e-01   -9.694911510969299e-02   +1.693998366984285e-01; -1.009380616576021e-01   -4.957942425052171e-01   +1.215222127181914e-01   +6.663312377417169e-02   -4.411584054996173e-01   +6.264958807663092e-02   -3.196183986246857e-01   -4.650180765197505e-01   +1.393971688945944e-01   -4.168099592985560e-01   -2.619731534123229e-01   -1.220057956968441e-01; -2.771462578231865e-02   -6.638073698412256e-01   -1.308118002534308e-01   +6.203304126002351e-02   -1.395473309291003e-01   -1.587017984293322e-01   -2.084514498760910e-01   -2.508366028139652e-01   -3.942296156528827e-02   +1.446198764483680e-01   -2.272275611794938e-01   -1.548339633815504e-02; -2.985890214883183e-01   -5.173995623915247e-01   +1.209813921821568e-02   +5.588545254303057e-02   +4.104731696160065e-02   -2.761294925321808e-01   -1.579295804555820e-01   -1.763816203337962e-01   -8.203672421988426e-02   -2.612623829201260e-02   +2.802532807876377e-01   -2.757045843584812e-01; -4.255674269840992e-01   -1.322314120775457e-01   +1.375955310904393e-01   -5.721620144813169e-02   -2.965207681076687e-01   -3.156330216359837e-01   +1.246165879684117e-01   +1.179961546641450e-02   -3.926578538597597e-01   -3.453695383777780e-01   +1.591268668346533e-01   -2.840829417837993e-01; -4.364544299899850e-01   +6.658811249669730e-02   -3.843683203468237e-01   +3.266095415424666e-02   -9.991974602359965e-02   +1.179970562056170e-01   -2.167481223505269e-02   +6.215886981347126e-02   -2.761627230989617e-01   -2.873180656489125e-01   -3.615480769640192e-01   -6.144049125761035e-01; +1.564876682700627e-01   -2.143730352200702e-01   +2.521984900548874e-02   +1.052731942499956e-01   -2.204469048346542e-01   -5.869418598517695e-03   -2.955285715902245e-01   -6.479140167445457e-01   +1.239164454099735e-01   -1.179271633405271e-01   -1.757322347844408e-01   -2.571223577647323e-01; -3.531166075856004e-01   +1.985544098537471e-01   -3.378310293536471e-01   +6.851166680204404e-02   -2.073059176626033e-01   -5.881722146282896e-01   -4.271260777662779e-02   -6.298561823843238e-03   -4.148525995569056e-02   -6.519430068003099e-02   -4.501866565663889e-01   -9.003956548359827e-02; -5.662312541563803e-01   -4.168075274285022e-01   -8.771680960291500e-02   -4.525735295686307e-01   -2.541035363099239e-01   +2.403063431064222e-01   -1.228983671738984e-01   -4.376025732427484e-01   -5.294706522292864e-02   -8.106695373047543e-02   -9.116830673732680e-02   -1.909877778973570e-01];
L1_L3_iAMPA_netcon = [-1.752687180620036e-01   -8.213184070824273e-02   -3.221706562302553e-01   -4.048625130150760e-01   -4.448297582399594e-01   -2.916838733335708e-01   +9.435141593209892e-02   -2.587507967087512e-01   +2.423185000312414e-01; -2.214110273444076e-01   +1.976179739423667e-01   +1.108341037640515e-01   +9.447870200470962e-02   -1.432694529982788e-01   -4.364294654059285e-02   +2.416195074348522e-01   -3.102815720249965e-01   -1.245636730752898e-01; -2.871163672203741e-02   +2.372007312622656e-01   -9.489887407788308e-02   +4.005299230327033e-02   -1.175190035879810e-01   -4.249152078480258e-01   +1.667476109468890e-01   -5.089258260505616e-01   -1.849272481655785e-01; -9.630256833927359e-02   -2.380966454696735e-01   -1.054809924188086e-01   -2.503339987464219e-01   -1.884432731540476e-01   +6.780239183239306e-03   -2.317499855384433e-01   -4.564590519575729e-01   -1.323860071092617e-01; -1.716130242234150e-01   -9.348330577205811e-02   -8.521527719142567e-02   -2.108849825089605e-03   -3.061599080283159e-01   +2.423386577011512e-01   -4.598701925741457e-01   +2.410093410853147e-01   -2.564113010324528e-01; -5.069008043166802e-01   -2.892888144980387e-01   -1.170807684796384e-01   -1.041850683056132e-01   -3.105741437845179e-01   +7.307287614108955e-02   -2.945312708105559e-01   +2.517251389557018e-01   -4.429394138546953e-01];
L3_L1_iGABA_netcon = [-3.698918467235218e-03   -1.636581402594162e-01   -1.232417486782145e-01   -6.007332692959346e-01   +2.194942417265314e-01   -7.030865221136866e-01; -9.884911542413133e-02   -1.012369909491220e-01   -6.957094232715505e-02   -2.895911703809526e-01   -5.126004580704652e-01   -6.197594533604447e-01; -1.249623469439993e-01   -2.137011717272227e-01   -7.917560936171461e-02   +1.197165547943463e-01   -2.621191413306633e-01   -9.573057326950554e-02; -2.138228425604290e-01   -4.544266701182509e-02   -4.052979491150500e-01   -5.208229253943951e-01   -1.060952230396948e-01   -2.136349839325718e-01; -1.843135532519446e-01   -3.505458964968767e-01   -4.677369476577085e-01   +1.108458531845968e-01   +3.240597614246124e-02   -2.598772389562091e-01; +4.029721281997381e-02   -2.508568345115558e-01   -9.126388344527336e-03   +1.851331263337933e-01   +8.455186396616335e-02   +1.074912082947415e-01; -1.006439973267951e-01   +1.022743911972523e-01   -1.260882235910666e-01   -3.749273061580183e-01   +1.633180483488711e-01   +9.112180580038874e-02; -3.536070086951565e-02   -3.012168942223291e-01   -4.340551893948898e-01   -2.583060090843414e-01   -2.864889893777467e-01   +4.452263538428186e-02; -2.243069915807873e-01   -3.557520335169402e-01   -3.123678039655015e-01   +1.095414319462157e-01   -6.064097790142400e-01   -2.566220690827883e-01];
L5_Input1_iAMPA_netcon = [-1.089371891569896e-02   -5.085310304953297e-02   -1.682156574334123e-01   +5.204663111020191e-02   -3.020532396345673e-01   -5.779261561079929e-01];
L6_Input2_iAMPA_netcon = [-2.619753868518312e-01   -4.074241518892137e-01   -2.366912374858810e-01];
L5_L6_iAMPA_netcon = [-1.542638728828388e-01   -4.381102388577081e-01   -6.298430553418752e-02   -1.524320703419741e-02   -5.329788064896377e-01   +1.898028324185311e-02; -2.176759027539759e-01   +4.440827737386170e-02   -1.844086580251044e-01   -8.655014717658807e-02   -2.939434592286198e-01   -1.745730006877236e-01; -4.521264878507356e-01   -1.609271754932777e-01   +2.513200395237681e-01   +1.943819060968258e-02   -4.692434000998395e-02   -5.187331861352429e-02];
L4_L5_iAMPA_netcon = [-3.498561675794590e-01   -3.146070684344044e-01   -3.091031389714980e-01   -2.532760015644819e-01   -2.282063372535942e-01   -3.932674701488619e-01   +2.051230904033747e-01   -1.626599244000564e-02   -3.771941009599940e-01   -1.439241858335813e-01   -4.417533876293819e-01   -4.666707561655612e-01; +9.669715291803124e-02   -8.870488848543856e-03   +9.863467096584946e-02   -1.037123127372976e-01   -1.079217586177448e-01   -3.632869588534769e-01   +2.506118463571588e-02   +2.123668027841231e-01   -3.526013921535921e-01   -1.305098129436026e-01   -6.170616105418985e-01   -1.004005634770762e-01; +1.153567784982403e-01   -3.964719736089397e-01   +9.016235861305490e-02   +1.548703900699586e-02   -1.408012294818530e-01   -9.860706438357382e-02   -6.288483058553995e-02   -5.272260175285900e-02   -2.865397958409288e-01   -2.339125319787079e-01   -2.481386214034575e-01   +1.651632580060939e-01; +9.257636034572586e-02   -1.071923488043375e-01   -1.449770356502547e-01   +2.388694291845184e-02   -3.022059511646185e-01   -2.803206452141128e-01   -1.595328121949061e-02   +8.130966323935183e-02   -2.841515006912998e-01   -8.298493647462465e-02   -4.798587092448069e-01   -2.325383530112960e-01; +6.792523070914228e-02   +1.000853369274246e-01   -5.438692188841025e-02   +1.209446688097423e-02   +1.840386061768880e-02   +1.724789455776823e-01   -8.546445426371745e-02   -2.434202533020136e-01   -2.801202062462512e-01   -2.136898065851122e-01   +2.587394405792758e-01   +4.197887941419263e-01; -4.389360346639593e-01   -4.145376961487679e-01   -3.154077168065840e-01   -1.364269902964793e-01   -3.569045959863090e-01   -3.249028080416979e-01   +1.541550648834130e-01   +7.834666419520653e-02   +1.487069012876316e-01   -4.842270784849231e-01   -3.837971610884353e-01   -1.682635739348641e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
