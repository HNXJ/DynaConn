function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-9.548397046384567e-02   +6.137026076997563e-02   +5.599526102104495e-03   +3.498855071892727e-02   -5.227544423819604e-02   -7.474905622827167e-02   +1.205646525631269e-01   -1.222769479107523e-01   -5.386336048215747e-02; -2.650060911749217e-03   +1.665953455477271e-01   -5.544275443527556e-02   -1.574150137431349e-01   -1.026075627386334e-02   -1.061452627796166e-01   -7.450324663165139e-03   -6.386969025475338e-02   +1.792410086996176e-02; +5.372463318880782e-03   +1.472363163110409e-01   -1.157429498864733e-01   +1.902326194684528e-02   -4.746697383778451e-02   +1.061579738373079e-01   +1.389504913259745e-01   +1.016532002111160e-01   +1.984954748687711e-01; -8.379053330700435e-03   -7.933827457668906e-02   +4.076484286953750e-02   +1.135498969493608e-01   -1.028702849847165e-01   +9.976179782398580e-02   +1.214428028935616e-01   +1.011631968056544e-01   +4.417349371762722e-02; -3.956959247090955e-04   -3.988152293125943e-02   -1.438124002725953e-02   -5.162920846490896e-02   +6.347987166297996e-03   -1.500372261795774e-02   +1.787564359228080e-01   -2.738024909539379e-02   +4.100014445404093e-02; +4.700511559605359e-02   +1.122402505789971e-01   -8.134110800018669e-02   +8.825438403540205e-02   -1.105909701332693e-01   +7.626324178010863e-02   +6.596681591877178e-02   +2.183960644213628e-02   +7.351876018393251e-02; +3.779727936349583e-02   +6.045537004407749e-02   +1.587335267217867e-01   +1.276313005926215e-01   -4.829429409818137e-02   +3.529922394656824e-02   -3.063062559656831e-02   -1.801372855151225e-01   +8.263783144983256e-02; -1.014926958371992e-01   +1.620943058770048e-02   +6.387438175342822e-02   -3.423043088479253e-02   +6.044416325928450e-03   +6.208348069124799e-02   +8.003504177412130e-02   -6.534068752866459e-02   +1.449266610695360e-01; -5.640789251955731e-02   -5.718051828944409e-03   -5.755886195694579e-02   -2.326370555583542e-02   -2.555360996418714e-02   -2.994450447081944e-02   +6.437446714261905e-02   +5.762911289998047e-02   -2.367948731135463e-02];
L1_L2_iAMPA_netcon = [-7.153040126855389e-02   -1.025716170580336e-01   +1.268624288458020e-02   -3.784495830121180e-02   +3.337221196276542e-02   -1.124758480320070e-01   +1.443977064879177e-03   -1.372991394245414e-02   +3.475048571237722e-02; +6.984211945465892e-02   -4.325400429386491e-02   +2.044615656006217e-02   -8.687158724016551e-02   -8.635252828162363e-03   -1.803218570459674e-02   -1.403841255394441e-01   -1.188853660705429e-01   -1.334678492331109e-01; -4.116684019102399e-02   -1.177012630962147e-01   -1.219620028552700e-01   +4.180583388459758e-02   +1.238983857487783e-01   +1.424277567723777e-01   -2.950924611231698e-02   +1.241157314045417e-01   +1.242822264213142e-01; -1.100541753164144e-02   -2.887059935247724e-02   +1.109135178054753e-01   +8.283343277088095e-02   -2.850633573466903e-02   -1.440528957505877e-01   -1.496591522344590e-01   -5.702481795932961e-02   +2.184290885697922e-02; +2.761863503488621e-02   -9.330043271872936e-02   -8.180042215832118e-03   +1.866570872666221e-01   +1.776951052451415e-03   +2.481625390337851e-02   +6.339067680913624e-02   -8.488349653114674e-02   -6.223683194568202e-02; +1.255031921448462e-01   +8.511126891036860e-02   -1.650615139358908e-01   +1.500947134398434e-02   +3.851499562355541e-02   -5.834983169983607e-02   +1.133355167107625e-02   +8.702220974909947e-02   +1.042885591393281e-01; +8.201146993643883e-02   +1.018629304189213e-01   -1.117516012683162e-01   -1.149005730703579e-01   +9.876480237098068e-02   -6.432041232464109e-02   -7.845713050309527e-02   +9.367989379456187e-02   +2.341426887227704e-02; +1.598280170777160e-01   +1.775900532238444e-01   +2.515499206578398e-02   +4.617248265247067e-02   +2.523235120665989e-02   +1.192951726394047e-01   +8.340907725896544e-02   -1.134898011314191e-03   -7.790278328542011e-02; +2.036257105815718e-01   +7.485064876162649e-02   +2.642123678120673e-02   -7.081991125041384e-02   +4.410400878680833e-02   -4.128818341291771e-02   +2.807914663024304e-02   +5.143201915983307e-03   -8.429007744291864e-02];
L2_L5_iAMPA_netcon = [+6.365328093146366e-02   -1.319397704785353e-01   -1.375503857891946e-01   -3.959576253593017e-02   -7.974368066288576e-02   +1.212101622980006e-02   +1.102056954545454e-03   +9.295624317607641e-02   -9.074181953280491e-02; +1.555462930904082e-01   +6.418964350980727e-02   -9.214529278459288e-02   -7.376114114746658e-02   +1.081723308005890e-01   -3.524130624223423e-02   -1.051696225698892e-01   +1.013527994826370e-01   -7.429872939644323e-02; +1.641157808874522e-01   +1.317844629338291e-01   +2.206861218178055e-02   +1.099171908832890e-01   +4.767322183182081e-02   -8.476018567997307e-02   -5.027000474364079e-02   -9.591754152473184e-02   +1.253906346673943e-02; -2.400551753598981e-02   -2.846686146564783e-02   +1.762875742621062e-01   -2.745435586855505e-02   +8.360725799841567e-02   +2.428754382116624e-02   -1.037034039986798e-01   -1.262061486284152e-01   +2.545027528012746e-02; +1.758124155918244e-01   +5.527749249309691e-02   -2.927969288125993e-02   -2.656980095474054e-02   +3.640632336225279e-02   +6.795687263980911e-02   +6.894960428622322e-02   -4.963652063428895e-02   +3.066365844560782e-02; -9.918592548092213e-02   +2.873085483367178e-02   +6.452195342828537e-02   -7.527166648274276e-02   -3.741738494521438e-02   -5.784847320602057e-02   +1.723130487881872e-01   +1.009701031794531e-01   +8.277617765061233e-02];
L5_L2_iGABA_netcon = [-3.567257424175487e-02   -3.729333851941687e-02   -3.955171050583978e-03   -1.118430837631506e-01   +1.155800487831643e-01   +2.551650761002737e-02; +1.754793138262771e-01   -1.351523103195235e-01   +7.718599571749860e-02   +8.623356797057004e-03   -5.445545022114295e-02   -1.312285186605089e-01; -1.859684677102537e-03   -1.010845498864925e-01   +4.899657677203262e-02   +1.336483093997032e-01   -1.216931648851956e-01   -2.800726346015488e-02; -1.025518033593347e-01   +7.972015264691078e-02   -3.605614477307105e-02   +2.122876952976329e-01   -6.662802133360921e-02   +1.547571340008330e-02; +3.762312029754582e-02   -1.001182887012475e-02   +1.187360983816977e-01   -8.794030191532681e-02   -1.394745823548335e-01   +5.642407921080859e-02; -8.627540898477320e-04   +9.880730382630845e-02   -4.207551046600033e-03   +1.346059826666308e-02   -1.330782943580404e-01   -4.998836523552119e-02; -1.205260790366311e-01   -8.853815146278123e-02   +1.245488672675743e-01   +4.622749335469325e-02   -8.094175135941707e-02   -2.837375494436627e-02; +1.368256488116046e-01   -1.309433756152369e-01   +5.079338477412251e-02   +8.967820668775298e-02   +8.658470941053273e-02   +9.853102244224943e-02; +9.827989019496951e-03   -1.047899565821656e-02   +7.105124045889639e-02   +9.529134423794439e-02   -4.059233913086870e-02   -6.875482409066672e-03];
L3_L2_iAMPA_netcon = [-1.985234531615260e-02   +3.975525638432767e-02   +1.404106076197678e-01   -6.749700715454894e-02   -8.102442012624618e-02   +3.013468579266494e-02; +2.696649323436007e-02   +1.540762779509178e-01   +4.166770198457549e-02   -6.307318637448822e-03   +8.516813324565890e-02   +1.764956132681441e-01; +2.947891010626482e-02   +1.083811459099468e-02   +5.761712945588328e-02   +7.120714554554446e-02   +1.370685740984818e-01   +6.832011129450886e-02; +1.395184010545366e-02   +1.800285413731468e-01   -1.306426738283078e-02   +4.047120873417100e-02   +1.276316686205443e-01   +1.247733471403594e-01; -1.842189830358477e-01   -1.524605853302764e-02   +1.162540089085462e-01   +8.045509658940739e-02   -1.411707095957850e-01   +1.213997161522670e-02; -3.118057170286438e-02   +3.641275448691550e-02   -3.365778818065259e-03   -1.814447608904175e-01   +8.866092421616974e-02   +4.947293670946695e-02; -3.977671153682971e-02   -8.330463536597255e-02   -5.901481740878123e-02   -4.435136298460535e-02   +2.299745009146430e-02   -1.210720731599468e-01; -6.532549816467204e-02   +3.936606779264325e-02   -1.727134053318501e-01   -4.897795466960367e-02   +1.416160506893252e-01   +3.149283833493540e-02; -4.778062336038355e-02   +5.634918291878983e-02   +5.228793945815359e-03   +8.536620300477996e-02   +4.464667706801347e-02   +2.302264088197330e-02];
L2_L3_iGABA_netcon = [+1.014366763533086e-01   -1.214837358321479e-02   +1.207447282637632e-01   -2.731893856900970e-02   +2.809112948231726e-02   +1.624288490977953e-01   -9.619107842358875e-02   -4.116554478459453e-02   +8.911295356255154e-02; -8.623450797368933e-02   -3.489096776721961e-03   -5.662381803735367e-02   +3.804451538995547e-02   -9.506078963612187e-02   +3.975977576584066e-02   -2.633862106994100e-02   +1.991912764196242e-02   +5.161952350658604e-03; +1.153804471577576e-01   -1.242683603906278e-01   -8.089695487846337e-03   -2.274807298405384e-02   -1.514986020841170e-01   +2.008111018978190e-01   -1.675557042116121e-01   -5.324994689833717e-04   -1.106558587765499e-01; +9.285290841866509e-02   +9.175366098346172e-02   -1.899535329450351e-01   -1.815633348157148e-03   +5.146712817999376e-02   +8.248232464709784e-02   +2.294573187321211e-02   +1.210319547796733e-01   -6.805739623885899e-02; -9.286522430448800e-02   +3.040344793048147e-02   -1.219155016650595e-01   -1.361154251732113e-01   +1.654823954656672e-02   +3.581406790964568e-02   +7.613933120809996e-02   -1.058252168769792e-01   -1.662306940210608e-01; +1.425223420812748e-01   +7.208222114545114e-02   -6.768352725510232e-02   +1.353837464304278e-02   +5.314802896146975e-02   +1.914713567117718e-01   +7.859597918050019e-02   +1.284231660117802e-01   -6.624704641162965e-03];
L1_L4_iGABA_netcon = [-7.532566546377080e-02   -7.265853312671294e-02   +9.493966917512739e-02   +1.502783427237822e-02   +1.070467263098348e-01   -1.376903966259274e-01   +4.027197321156953e-02   -3.233231983752316e-02   -7.968362507100883e-02; -4.031099199504887e-02   -3.379804152555169e-02   -5.123125772216679e-02   -3.252632850101600e-02   +5.916544694981773e-02   +8.481491341414354e-02   -5.513390873774295e-02   -6.415198659507068e-02   -5.605747496491557e-02; -5.175179556616068e-02   -1.929920602242014e-02   -1.411191065701364e-01   +4.231340181569136e-02   -3.023361491977981e-02   -1.127709517923789e-02   -6.403858087655706e-02   +2.972113681274393e-02   -1.573451719817862e-01; +9.475963091565168e-02   -7.606263960348335e-02   -1.045463934068065e-01   +1.054201632716460e-01   -5.957368168929406e-02   -2.090830207143292e-02   -3.678413585828307e-02   -5.979724661510718e-02   +4.183766562306334e-03; -8.407750121331595e-02   -5.404470848303547e-03   -6.773835140709480e-02   -5.634427229644731e-02   -8.089329064184482e-02   +3.559154078966914e-02   -7.876196314033798e-02   +7.254270460612211e-02   +8.652538307429254e-02; +1.356352040118081e-01   +4.631518740148925e-02   +9.187027496527750e-02   -5.632329565194525e-02   +1.098693985498978e-01   -3.332190094454118e-02   -8.001834455080330e-02   +1.401699546957909e-01   -7.482382779616253e-03; +3.640692517342205e-02   +1.123839345501593e-01   +1.849536081618048e-02   +6.256680121477613e-04   +1.234244365360277e-02   +1.148750972459988e-01   -7.981292292659981e-02   +1.019770125931048e-01   -2.098426280989058e-02; +1.203833733120629e-01   -2.276574912912011e-02   -9.732861488740660e-03   +6.303100588322434e-02   +4.632977996721706e-02   +5.416550517773499e-02   -1.016524099249830e-02   +1.292796019178614e-02   +1.182663738199694e-01; -1.714836665450179e-01   -7.962631229659450e-02   -4.281556576047627e-02   -4.161106149792057e-02   -3.523894876827222e-02   +2.997186779655378e-02   -7.250927678917801e-02   -1.643964503439100e-01   +8.244830280069972e-02; +6.991964520128546e-02   +9.682525571226548e-02   +8.403297262615286e-02   -3.810113784188506e-02   -1.032355357781649e-02   +9.838870626876874e-02   -1.617888916218707e-01   +8.848903508717605e-02   -1.057923221698942e-01; -3.928403032939200e-02   -3.177063447240366e-02   -6.047623090091842e-02   +6.939280495576977e-02   +9.238376505350396e-02   -9.654263902275725e-02   +2.692673033122821e-02   +6.281242876014799e-02   +1.424430586159328e-01; +1.048288261909665e-01   -1.094498787097952e-01   -3.307270298481689e-02   +2.694723316967718e-02   -4.948506961930942e-02   +1.052656486112154e-01   +9.374296412223114e-02   -9.111724393437584e-02   -4.743151169373631e-02];
L4_L1_iAMPA_netcon = [+4.140881855847900e-02   -5.563535776750646e-02   +3.854844268607757e-02   +6.813476917022786e-02   -6.808692684007264e-02   +2.559501274329147e-02   -7.894842733596964e-03   +1.090684530462415e-01   +1.764447110476250e-01   -1.010363194892866e-01   -1.176388240311839e-01   +2.446358145756244e-02; +4.028383213102537e-02   +8.813642921346587e-02   -5.076754467946120e-02   +4.431727665660292e-02   +2.578878131044092e-02   -6.503384655196834e-02   -1.030142733807239e-01   +1.109387362342500e-01   +6.651356357152892e-02   +1.843604716545699e-01   +1.146173751769700e-01   -1.398572614856122e-01; -1.202110599705099e-01   +1.173295320440050e-01   +7.562447229294472e-02   +2.577032433015788e-02   -4.199450627410346e-02   +1.038756678313330e-01   -1.205869113401060e-02   +7.065149785858119e-02   +1.132176449143436e-01   -4.091403176733417e-02   +5.057546106764050e-02   +1.038886394470411e-01; -4.371018146631346e-02   +1.329003683280124e-01   -6.813873512339652e-02   -1.404921346381484e-02   -6.713803087073521e-02   -8.532361721844497e-02   -6.407444271896294e-03   -1.765530608925754e-02   +2.798174383282389e-02   +4.442616496448727e-02   +9.727466730139320e-02   +6.419788590964272e-03; +1.452137031778612e-01   +1.057788424057323e-01   -7.986352233578897e-02   +1.338513525001455e-01   -8.497836082380840e-03   +9.549601844034455e-03   +2.482580565197743e-02   +8.096102509505329e-02   +9.051712352431109e-02   +7.228491982588540e-02   -2.362093174533529e-02   -6.164259338964442e-02; +5.293780115770139e-02   +2.277057256079192e-02   -4.084251038866026e-02   +3.874887349807370e-02   -3.658658900114237e-02   -5.842554956792574e-02   +9.170605244138857e-02   +8.600097253385273e-02   +3.741089033315261e-02   +6.910004957619816e-02   +4.121779196499267e-02   +1.319322666413158e-01; +5.341710682609572e-02   +4.651321661811434e-03   +2.311705822878797e-03   -5.360435268394168e-02   +1.059353404939457e-01   +9.526758030298560e-02   +8.878663948931495e-02   +4.586205085468185e-02   -5.005868679434319e-02   -7.519911083582075e-02   -1.031325610306177e-01   -4.254692912969450e-02; -6.829169626527369e-03   +1.410000203352586e-01   -1.119936538398228e-01   -1.137184679835513e-01   -5.302366021970421e-02   +4.256140753596677e-02   -2.161813878014320e-02   +8.862025162968459e-02   -2.176699491400772e-01   +1.138628216333566e-01   +1.772299355074816e-01   -1.269810438365104e-02; +1.220282768524043e-01   +2.040895814455452e-02   -1.422398388206458e-01   +1.648690793234046e-01   -2.042981957762669e-02   -1.152373726981784e-01   +9.078796494668073e-02   +7.601591070101339e-02   -1.431081376490267e-01   -1.026458227516518e-01   +1.202025156154990e-01   -2.913608599900711e-02];
L1_L3_iAMPA_netcon = [-6.357203743669494e-02   -6.686543188489046e-02   -7.623317250981702e-02   +9.182839488336825e-02   -8.245770332384375e-02   -4.028211763845103e-02   +2.209334224003559e-02   -9.776704944845049e-02   -7.985586837305680e-02; -3.779278757090759e-02   +5.477544618281908e-02   -8.387128651830887e-03   -4.437753491205139e-02   -7.222573049939798e-02   -1.974512022487768e-01   -8.789958820383990e-03   +3.327822185271487e-02   +7.400293043262035e-02; +2.459697377552384e-02   +2.906844319482930e-02   -2.032039645239965e-03   -1.357148562604282e-02   -8.801258401561046e-02   +1.395219297195932e-01   +9.422631487792001e-02   +7.582880600501446e-02   +6.164465941222592e-03; -5.333328028849728e-02   +9.520995325326682e-02   -9.715354732935760e-03   -9.338134323874881e-03   +8.338871671367100e-02   -8.710239739340694e-02   +2.746331442453539e-03   +3.847775029758869e-02   -1.077025245026625e-02; -1.006255583206019e-01   +1.134215858051768e-01   +3.105182288317558e-02   -3.897661843364697e-02   +6.509390160123753e-02   -3.548773086383285e-02   -6.406616120731659e-02   -1.562862085012663e-01   +1.294906745560706e-01; -3.096919644766110e-02   +3.542962353647273e-02   -4.069352037004689e-02   -5.901907517842508e-02   +7.761433458498697e-02   +4.282588961479377e-02   -2.004026842073339e-02   +7.934044487612175e-02   +4.719708977886790e-02];
L3_L1_iGABA_netcon = [-7.906110878920029e-02   +6.874023042375686e-02   +9.911097163403773e-02   -6.814029272029887e-03   -1.037163034224951e-01   +1.669474362899645e-02; +3.356807702772820e-02   +1.047852514858292e-01   +1.231466963170330e-01   -6.874081967032892e-03   +1.277987497672914e-01   -5.431320574239124e-02; +1.242959980099286e-01   +8.547818397033387e-02   -2.648079659721223e-02   +7.946647951243865e-02   +3.859591770247970e-02   -5.246349670242596e-02; +3.531244888608424e-02   +3.859945142196063e-02   -1.489926550650743e-01   -1.070487227119609e-01   +1.046363244705644e-01   -2.662204946315094e-02; +1.453398100587031e-01   +2.972619960847998e-04   -7.001651123180201e-02   -1.083448020536888e-03   -1.057383634265598e-01   -4.413784536099687e-02; +2.731323601190376e-05   -1.868678912348272e-02   -3.717412375616703e-02   -3.330738023493280e-03   -1.389318332262249e-01   +7.589938592621487e-02; -9.627394844805429e-02   +1.314828129774395e-01   +7.455795015572837e-02   +9.050263763359465e-02   -1.784887302836041e-02   -2.996025649341191e-02; -4.367167948487590e-03   +1.097328600870057e-01   +1.177912808386556e-01   -4.779730824413578e-02   +1.854996279216064e-02   +9.066148049811450e-02; -3.856964706769159e-02   -8.974968600565715e-02   +3.522878327258201e-02   +1.303677648735420e-02   +3.370930878757508e-02   +1.175579037590608e-02];
L5_Input1_iAMPA_netcon = [-4.417148083464299e-02   -5.547641354820360e-02   -7.171597223618417e-02   +8.344341474672945e-02   -2.368537047015886e-02   -8.554794308789510e-02];
L6_Input2_iAMPA_netcon = [-1.373818860211415e-01   -7.472537779122847e-02   -2.429086254435573e-02   +1.416035176173956e-01   +9.884146818174273e-02   -2.698398841358466e-02];
L5_L6_iAMPA_netcon = [-1.060756020104534e-01   +1.370040176799888e-01   +1.138951625589780e-01   -6.169215714592857e-02   +4.891830886465864e-02   +9.834784177995844e-02; -8.410175540434028e-02   +1.430984704467742e-01   +5.554415997675823e-02   +1.466443430451040e-01   +5.337663848172500e-02   +9.946786891953771e-02; -9.346712340632476e-02   +7.996422614916510e-02   -7.522859997678905e-02   +1.066594290911727e-01   -6.320924619401495e-02   -1.086868925888042e-01; +1.537901433927537e-01   -8.407257708624752e-02   -3.586329065726756e-02   -1.032338695770657e-01   -5.413276429721265e-02   -4.430366548374469e-03; +2.173491886133618e-01   -9.964235777876460e-02   +6.060847325403944e-02   -2.403648565359113e-02   +4.553323023441941e-02   +1.862679782035489e-03; +2.652362684253311e-02   -1.652456140785591e-02   +9.624467826221524e-02   +2.001257499908756e-01   -1.062523238908020e-02   +1.619393117967624e-01];
L4_L5_iGABA_netcon = [+6.235992018384536e-02   -4.287741307269280e-02   +9.369917230004385e-02   -1.038449581531995e-01   +8.091011465524852e-03   +5.250706973586328e-02   +2.508793758611555e-02   +1.302917383706914e-01   -2.902322625104449e-02   -8.973872092076478e-02   +5.984839503670289e-02   -8.516270360584956e-02; -4.460609328750167e-02   -8.401760163858600e-02   -2.401231830167214e-02   -6.398783568819520e-02   +9.284736819348252e-02   +8.756912119838875e-02   -1.036291351406587e-01   -1.427484186394715e-01   +2.574185115568069e-02   -1.321627128136905e-01   -1.632322971956334e-01   +9.102365767755587e-02; -9.873951576142387e-02   +1.192175905763169e-01   -1.648026537720371e-02   +7.170658736314117e-02   +1.448005387872759e-01   +8.463402788213738e-02   -2.975041998541917e-02   -8.384047425520325e-02   +3.661210979234468e-03   +2.829631253878461e-02   +1.111358519393983e-01   +7.898924358951762e-02; +1.386009325720449e-01   -5.004769534088781e-02   +2.045770321996601e-01   +1.799689629901245e-01   -5.454238144117862e-02   +1.284674659378515e-01   +8.701543295243862e-02   -8.650154361872295e-02   +4.601843129055007e-02   +1.386589450694553e-02   -8.972866282922695e-02   +5.499957942083019e-02; -7.745862971935523e-02   -1.537739859639308e-02   -5.354989004852549e-02   -1.081365315692012e-01   -1.519858263083749e-02   +7.237440760580020e-03   -1.356371090163591e-01   -4.803095217265671e-02   -1.451956757763033e-01   -7.896950704370732e-02   -2.748526890089055e-02   +6.478882977388102e-02; -3.561344034325232e-02   -3.605787875020322e-03   -2.766273563242844e-02   -3.577364570950321e-02   -1.108048243814685e-01   -1.965804466132188e-02   -3.332793267203549e-02   -9.428746738344573e-03   +1.074158477100983e-01   -7.800625680525482e-02   +4.084621779995992e-02   -3.546670378826897e-02];
L6_L4_iAMPA_netcon = [+1.428688919051356e-01   +5.190025141964353e-02   -1.594168605979996e-01   -1.156587206358916e-01   +3.762804005591484e-03   +5.731464954810368e-02; -4.859554843249627e-02   +8.634859555943716e-02   -2.777259637455273e-02   +7.553474467688573e-02   -9.561409756573604e-02   +2.398293894150332e-02; +1.416145635276224e-01   +3.604946296085205e-02   +1.037165647713056e-01   -2.483957598068018e-02   -1.022488794926808e-01   -9.474111657652755e-02; -3.885722245237230e-02   -1.268170357493317e-02   +1.565284063538555e-01   +1.374837705838424e-01   -1.824885413983917e-02   +5.940656651539152e-03; -1.246257021821334e-01   +8.495558999910649e-02   -4.104203639209288e-02   -8.689404741397053e-04   +1.761132021507903e-01   -2.723853889957292e-02; +6.721801034666776e-02   -7.710879671978370e-02   -1.757066793659622e-02   -7.086934203943266e-03   +8.236054851874888e-02   +1.324271395051519e-02; +3.944243237187257e-02   +6.717728371171676e-03   -1.181348722374362e-01   -1.255284377224835e-01   -1.806989860219070e-02   -1.795637007484712e-02; -2.419081912204111e-03   -1.900867690543795e-02   +9.650540697502677e-02   -8.381371477657610e-03   -1.015244999683130e-02   -3.517760188438661e-02; -9.457884164886590e-02   +3.532578100547745e-02   -9.343770811617023e-02   -3.601917545930799e-02   -1.597515673511447e-02   -9.792483366860255e-03; +9.720516302561806e-02   -1.249702776482996e-01   +5.382481761794272e-02   -7.748047071180730e-02   +9.323602397829543e-02   -6.273994924066779e-02; +4.440429820873659e-02   -1.070302182206259e-01   +5.575959498202094e-02   -1.286291143583609e-01   +1.498713400435713e-01   +2.426254714185776e-01; -7.887670087137026e-04   -1.342612512511720e-02   +4.016157161594208e-02   +5.141851787626202e-02   +2.031709197238783e-02   +4.959390608262484e-02];
L5_L4_iAMPA_netcon = [+3.328621392291699e-03   -5.845333206627081e-02   +7.883354530066670e-02   +5.451681759002584e-02   -5.266888351566115e-02   -8.654127184460032e-02; -1.196907781007952e-01   -8.469446841899682e-02   +9.268312764556201e-02   +1.718682724788202e-02   -1.481020091175437e-01   +5.755160042098421e-02; +1.515507440017670e-01   +3.562806596048718e-02   +1.263142129111662e-01   -1.166736406526715e-01   -6.929024289767025e-02   +4.422134858869718e-02; +2.436365701103610e-02   -7.527710038064062e-02   +7.083623547975687e-02   -1.753669691066974e-02   +1.947231766577840e-02   -1.503153743051025e-02; -6.864008353065054e-02   -2.788163002006958e-02   -2.371188875720802e-02   -1.431664154696332e-01   +1.064513234110853e-01   -2.014795612318242e-02; -7.029556643848114e-02   -1.365506987914492e-04   +1.623595788310567e-01   +3.976766172959828e-02   +1.388434568091405e-02   +6.775637006125151e-02; -8.185135182964716e-02   +1.969580733637457e-01   +3.764307170809111e-02   -1.473119928961662e-02   +7.835749399314025e-02   -7.725354931090912e-02; -5.949555321909218e-02   +9.265754232688456e-02   +1.131957934950191e-01   -7.814276078832207e-02   +6.647499323907197e-02   +2.186665193574068e-02; +1.221160098721279e-01   +9.417462131948573e-02   -5.294674280138087e-02   +6.555755779833758e-02   -6.698583738280590e-02   -2.218915022966914e-02; -2.090178935479570e-02   +4.722483613873255e-02   -2.297531817884394e-02   -4.930895347661696e-02   +2.945811173789564e-02   +5.842213442106195e-02; +5.513481730862427e-02   +7.065400765634802e-02   -4.303946392954189e-02   +2.353892804725676e-02   -9.341203818012521e-02   +9.947750856604486e-02; +1.833174606543130e-01   -5.901559702331701e-02   +1.748676508270709e-02   -1.817327137483980e-02   +1.037905907502402e-01   +5.208072846618848e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
