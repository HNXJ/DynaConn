function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-3.507287037421234e-01   -3.483458048031192e-01   -5.216884949239061e-01   -5.466741199202863e-01   -4.882051580778184e-01   -4.354446114759537e-01   -6.442790755425502e-01   -7.114599331819460e-01   -5.535874254908369e-01; -5.848583944583354e-01   -3.863941529853142e-01   -5.466603887112143e-01   -4.567783915769501e-01   -5.061245160416510e-01   -4.753113083774207e-01   -7.804114936073833e-01   -5.989111958921475e-01   -3.929497859449363e-01; -5.308935298018369e-01   -3.016829634913045e-01   -6.661872735456207e-01   -7.125582373127870e-01   -6.500199016940887e-01   -5.728009559799621e-01   -6.163684903252370e-01   -3.951108481542271e-01   -5.897343729217359e-01; -5.270112987192879e-01   -4.017653218605912e-01   -6.047702224487077e-01   -4.037210740557491e-01   -3.483995981480289e-01   -4.517233011570205e-01   -6.041949851570270e-01   -2.256614902050018e-01   -5.033692744132460e-01; -6.047275005915789e-01   -4.201967110827231e-01   -2.550821956467344e-01   -4.154745406287437e-01   -3.595324945284817e-01   -5.279804437681007e-01   -4.719859774016655e-01   -5.874772063858575e-01   -4.872070379101467e-01; -4.426534254742723e-01   -2.516607413638847e-01   -3.630983114188397e-01   -5.645628486610486e-01   -3.995188523417816e-01   -4.463747339425750e-01   -7.236934813510399e-01   -7.002082773480462e-01   -3.316470710670021e-01; -4.363232124063284e-01   -4.652446071671549e-01   -5.800000328533214e-01   -5.994212443700000e-01   -7.069781293286205e-01   -5.488759515898897e-01   -4.906155282601488e-01   -6.733877776340405e-01   -6.936934352780484e-01; -5.497796126156390e-01   -6.758822553494191e-01   -5.814324146200122e-01   -4.423042915079300e-01   -4.263235972541964e-01   -3.314832568085875e-01   -6.083962370320686e-01   -7.919663872728206e-01   -6.206013813151053e-01; -6.515063670806190e-01   -5.449492426052179e-01   -5.134193610071489e-01   -3.371191891489807e-01   -4.654954621855922e-01   -2.676962880559656e-01   -4.503280144538112e-01   -4.279281976789513e-01   -4.392920662427061e-01];
L1_L2_iAMPA_netcon = [-4.259501470922898e-01   -4.644181003460732e-01   -4.426770287236965e-01   -5.705610826313795e-01   -7.251566918142105e-01   -4.753527402920631e-01   -3.569077254539060e-01   -6.161905316830582e-01   -4.551679144551571e-01; -4.338768449726145e-01   -5.494914012269454e-01   -4.368026086390467e-01   -4.525325746338903e-01   -4.960251522765566e-01   -6.808097067269381e-01   -4.490372826763533e-01   -6.270912683006922e-01   -2.442882932247639e-01; -5.451321988626687e-01   -3.171990030940424e-01   -6.552220931371097e-01   -4.780246248537466e-01   -2.039227910563564e-01   -7.267444048506966e-01   -5.556724094278486e-01   -5.403137905616512e-01   -6.627865533002644e-01; -3.772943650101043e-01   -5.186383692491813e-01   -7.794240483172973e-01   -5.574871210189958e-01   -4.276352053334638e-01   -6.503260236257791e-01   -7.786737974215231e-01   -5.165681438307178e-01   -4.943242583205430e-01; -5.696765288425694e-01   -3.619124524326989e-01   -3.891726510501906e-01   -3.595702543994934e-01   -4.410604151831230e-01   -7.452820185710872e-01   -3.839228820250145e-01   -5.704323445677512e-01   -5.456565147081340e-01; -7.630991113137064e-01   -4.676065177102633e-01   -7.281284271907447e-01   -1.103732787653774e-01   -5.643252407376350e-01   -4.855658881557269e-01   -4.788840579027789e-01   -2.580216703002227e-01   -6.679452130195768e-01; -4.980388139428257e-01   -4.576143549323682e-01   -3.402797102479181e-01   -5.256885933519077e-01   -4.864802315724185e-01   -6.640683228385520e-01   -4.326580785499314e-01   -4.940682168026350e-01   -4.590959524074311e-01; -1.774771769092618e-01   -4.988517397775240e-01   -5.236136438735373e-01   -4.412780374528255e-01   -2.934871431492028e-01   -4.580766912049284e-01   -3.707249917350380e-01   -2.503822498814162e-01   -6.230726077598101e-01; -8.197310136150139e-01   -6.129025023447973e-01   -5.807717163984372e-01   -6.856381656979519e-01   -1.345138960639660e-01   -6.905639482420746e-01   -4.726444325261782e-01   -6.364992966279384e-01   -4.362296504488100e-01];
L2_L5_iAMPA_netcon = [-5.769768287092549e-01   -3.383747784861718e-01   -6.909003989007914e-01   -4.027489845405989e-01   -5.577534169018420e-01   -6.144016337779249e-01   -6.524721746914203e-01   -2.842861188113005e-01   -6.542483154797281e-01; -4.331860431291679e-01   -4.970182577999267e-01   -6.435680090700464e-01   -4.975213527936690e-01   -5.902864336135101e-01   -7.109698537193901e-01   -4.563855726242786e-01   -4.813745125030706e-01   -6.310818238323490e-01; -4.835069139715589e-01   -3.426554905978494e-01   -4.414451924938234e-01   -3.173455859818392e-01   -3.576081773687945e-01   -2.147961131722106e-01   -5.069254762316318e-01   -7.212245812942952e-01   -4.705011494190263e-01; -5.311326779118769e-01   -3.862028402694856e-01   -3.982009466323609e-01   -4.700925922960629e-01   -7.425874747753667e-01   -3.918012522872555e-01   -5.348561952076312e-01   -5.882045179470557e-01   -5.303946162143752e-01; -6.153452170648980e-01   -6.352553820013402e-01   -5.765515848899085e-01   -5.441895713774350e-01   -7.074829455988744e-01   -7.760086861813768e-01   -7.056219584461063e-01   -4.994105284336813e-01   -4.224777991589970e-01; -4.163844568820657e-01   -5.308742852299009e-01   -6.414351074010995e-01   -3.672212801400769e-01   -4.463689863628564e-01   -5.708029209821643e-01   -5.724816407759533e-01   -5.814781800554409e-01   -3.841350819820575e-01];
L5_L2_iGABA_netcon = [-6.121518914348888e-01   -4.564622091352465e-01   -6.887105436475174e-01   -5.835907922531667e-01   -6.397269792037826e-01   -5.132840175175490e-01; -5.127420992939504e-01   -4.641823240475193e-01   -5.180838178692139e-01   -6.664205208445373e-01   -5.197754131844970e-01   -5.653825920626183e-01; -5.070052124954484e-01   -4.041196315154315e-01   -5.562273760056002e-01   -4.951387719952695e-01   -7.340804955716771e-01   -4.431547429835132e-01; -2.582141812976406e-01   -4.322375648429581e-01   -1.895739616275008e-01   -4.994094768957678e-01   -3.792198190824133e-01   -3.853760189256845e-01; -5.955803531734580e-01   -4.754785204009085e-01   -4.781870168864878e-01   -6.036978955330226e-01   -6.786667107692388e-01   -2.661677166016540e-01; -5.392061841039307e-01   -3.611277984097822e-01   -3.508155064556963e-01   -5.963874880922139e-01   -4.822928973938858e-01   -6.986141867939789e-01; -3.698372720350932e-01   -4.272565809257908e-01   -6.508679994142579e-01   -5.116289836450770e-01   -2.694670106395938e-01   -3.145445249947762e-01; -5.282592375988328e-01   -3.042009049697985e-01   -3.401289659639622e-01   -5.777014215632486e-01   -4.190587762469961e-01   -4.229401519285800e-01; -4.541363764294190e-01   -6.395098064384142e-01   -5.924100819562891e-01   -3.294661717688158e-01   -3.094213024764398e-01   -5.272399194011130e-01];
L3_L2_iAMPA_netcon = [-5.767286092208812e-01   -6.482169412184292e-01   -3.770934093140826e-01   -7.046143338810412e-01   -4.333691470157248e-01   -2.039847001944285e-01; -4.220495800717090e-01   -6.138319024251264e-01   -5.896301929117267e-01   -5.021209690711330e-01   -5.318344649355725e-01   -6.131588510755055e-01; -5.988867849651368e-01   -6.487560815116653e-01   -4.472831681337645e-01   -7.436583230128471e-01   -5.185396863638839e-01   -4.715341684750242e-01; -5.125330439116780e-01   -5.521902332788958e-01   -6.333804589792301e-01   -5.678286503665450e-01   -5.695192644525139e-01   -4.609487814463057e-01; -5.400387931297397e-01   -5.522785737282163e-01   -3.654155695147056e-01   -3.959624697591859e-01   -4.383002681126738e-01   -4.878649768555341e-01; -6.379868382614651e-01   -5.155619943559224e-01   -4.452771255778963e-01   -5.134100569779912e-01   -5.546446517637764e-01   -6.310956254802744e-01; -5.588573216292391e-01   -4.782997929364684e-01   -7.264291533716098e-01   -4.150510188974710e-01   -5.010757939021830e-01   -5.125518703110189e-01; -4.529328607194504e-01   -4.689973832303256e-01   -5.879156007268768e-01   -5.289906875890963e-01   -5.384416052035542e-01   -2.726889985287049e-01; -7.955073195850390e-01   -6.029767581708854e-01   -4.728833838224731e-01   -3.067299185992062e-01   -3.992779691250347e-01   -5.783679597650699e-01];
L2_L3_iAMPA_netcon = [-4.257098697113088e-01   -5.154943940874523e-01   -5.998337228960762e-01   -5.009108469757640e-01   -5.720592093183225e-01   -6.822018994407122e-01   -4.119016737992790e-01   -2.300831700571116e-01   -4.569285061442770e-01; -4.716847519345388e-01   -4.983869018383539e-01   -3.883839809492847e-01   -4.375073616729279e-01   -4.954469400725284e-01   -5.810919456271850e-01   -4.910610132725092e-01   -5.290598321228372e-01   -4.910800292277262e-01; -3.909038468461722e-01   -6.626538209814254e-01   -4.680991081036049e-01   -4.811993466199249e-01   -4.503067462007683e-01   -5.771850427064261e-01   -4.095873882746865e-01   -4.808779365135225e-01   -6.302944638598336e-01; -4.867550383079648e-01   -5.427007759821239e-01   -6.199195869485232e-01   -3.207366269875490e-01   -3.705108383752835e-01   -4.782913935616649e-01   -6.017487826409598e-01   -1.534373808869310e-01   -2.500124896885012e-01; -4.723561572755068e-01   -7.982375738041196e-01   -4.897090560679730e-01   -4.563473255145321e-01   -6.423952863662371e-01   -4.751939748781021e-01   -6.079665270839758e-01   -4.555899045055122e-01   -5.727236882514805e-01; -1.482981903435501e-01   -2.486705759934582e-01   -3.147748392764012e-01   -4.804396692978184e-01   -3.279159564441881e-01   -5.097657053078241e-01   -6.929793765521524e-01   -4.774851697004567e-01   -6.035953088516767e-01];
L1_L4_iGABA_netcon = [-7.523548588057568e-01   -3.442373931118891e-01   -6.588660270885711e-01   -5.646272504877897e-01   -4.835671601740547e-01   -4.933481089288989e-01   -4.382277885937276e-01   -6.291239075354335e-01   -2.594971766889441e-01; -3.277753819464987e-01   -4.096344003600690e-01   -4.840260447373420e-01   -4.608019580262923e-01   -4.883457412767386e-01   -5.334053254487412e-01   -4.806067858136600e-01   -7.586405047843503e-01   -7.723758216384047e-01; -5.787405666988461e-01   -6.370450666728638e-01   -4.052546451184153e-01   -5.767486055022916e-01   -4.672374221446388e-01   -3.059499515414606e-01   -7.524424144749127e-01   -4.420126597236290e-01   -3.563229020139143e-01; -5.579588135052530e-01   -6.433569380686576e-01   -4.748937913803437e-01   -4.433535340982315e-01   -8.226854785093662e-01   -3.367223763117911e-01   -4.299472036789631e-01   -5.283909891781615e-01   -3.746050518918751e-01; -4.986195702049070e-01   -5.266691413700670e-01   -6.327259707733458e-01   -4.393578000464554e-01   -5.843245743510823e-01   -6.461581912374370e-01   -5.996243917703763e-01   -6.717971878688822e-01   -6.369886543020499e-01; -4.831055025724137e-01   -4.803763796456165e-01   -6.630063134106718e-01   -5.067344507826906e-01   -4.494592397100326e-01   -4.336995310837970e-01   -4.697097300038970e-01   -4.403593452327662e-01   -3.146377372131369e-01; -6.018404326630529e-01   -6.174963648481916e-01   -5.155821752332838e-01   -3.874379238067905e-01   -3.862292211149750e-01   -5.845164627161668e-01   -2.739043685069265e-01   -6.474980171771054e-01   -5.328438470347773e-01; -8.011995140601175e-01   -5.475418062071220e-01   -3.040291946778252e-01   -4.493185800058983e-01   -5.450581921958445e-01   -4.196778582435150e-01   -5.587613998814437e-01   -6.086204793945690e-01   -5.876448218342155e-01; -6.686712049678136e-01   -6.100437854130827e-01   -3.192924148441589e-01   -3.252433455376956e-01   -3.554960232376780e-01   -3.531373626980252e-01   -6.553007352708617e-01   -5.085036835399150e-01   -4.158029967541804e-01; -6.641524455685771e-01   -3.237307142316483e-01   -5.794338657895117e-01   -6.210335831923121e-01   -5.831608517718950e-01   -5.978318830886143e-01   -4.135661656950721e-01   -4.796969248174436e-01   -1.242672151367479e-01; -5.492154802975504e-01   -3.852499485093157e-01   -2.427792138389175e-01   -4.956521145467459e-01   -5.348547728058709e-01   -5.951877209930201e-01   -4.392332319276642e-01   -5.378674586345987e-01   -5.887083809245011e-01; -7.321694045558169e-01   -3.694343182925531e-01   -5.028022152712437e-01   -6.006330642691062e-01   -5.534483808472850e-01   -3.979557102509501e-01   -4.833160147016424e-01   -6.473645349413645e-01   -5.043503863565144e-01];
L4_L1_iGABA_netcon = [-4.088245876763664e-01   -3.825705477471643e-01   -7.572789944491508e-01   -4.898745339643177e-01   -5.595612060258555e-01   -7.038188277724573e-01   -5.423872957706145e-01   -5.952228733614773e-01   -3.301290030159428e-01   -4.336056114447909e-01   -5.812707567154639e-01   -5.563306565832947e-01; -2.344493733549045e-01   -6.228623756567047e-01   -3.901554276097470e-01   -4.708951387840753e-01   -6.175910605556040e-01   -6.142350075742944e-01   -4.771665034376517e-01   -6.017854430456382e-01   -2.694363184162193e-01   -3.621932198117007e-01   -5.688321401544992e-01   -4.775935314580177e-01; -4.647715495714519e-01   -6.972485824881248e-01   -6.589593760637599e-01   -5.136046315741313e-01   -6.736201846455979e-01   -5.930369968270186e-01   -5.363639211561910e-01   -4.600016309921918e-01   -4.154130145101561e-01   -3.748864500138035e-01   -6.686371065119863e-01   -5.643522866566397e-01; -6.015498089544652e-01   -6.749848399258432e-01   -4.936187408548924e-01   -5.114703395144253e-01   -6.581739411148996e-01   -5.384540633912462e-01   -4.820479571027630e-01   -5.040357334246890e-01   -4.968020953211768e-01   -5.879122863078154e-01   -1.403315630102083e-01   -5.000397838358385e-01; -6.732846342960941e-01   -5.800600675195813e-01   -5.542778407533537e-01   -4.114731933864317e-01   -5.250204136012574e-01   -6.743729275372713e-01   -2.943475974628692e-01   -4.757641131664889e-01   -5.311096366954089e-01   -4.964848256252388e-01   -3.059335988615516e-01   -5.609302438702551e-01; -5.714520937321840e-01   -3.019923299073570e-01   -4.190426652392489e-01   -4.753948093321984e-01   -4.638457604193248e-01   -3.817023389470596e-01   -5.581847041884902e-01   -3.859010533051054e-01   -6.319793630021310e-01   -4.266010146488199e-01   -4.220618060020030e-01   -8.143826636353318e-01; -3.656680091124299e-01   -7.463050052921021e-01   -4.740261221921718e-01   -5.302344875170469e-01   -6.508865459073098e-01   -4.976119796804649e-01   -5.997960735423348e-01   -6.975959004260730e-01   -3.604232149023451e-01   -4.266595448317625e-01   -4.985322287438881e-01   -7.075750421365116e-01; -6.844392648936494e-01   -4.526412326926408e-01   -5.326940904427421e-01   -3.814251200756226e-01   -7.000259874152156e-01   -7.269560146506017e-01   -2.460868012301689e-01   -4.660545371682885e-01   -4.390591557156972e-01   -6.181462326223208e-01   -5.731134633966236e-01   -4.007808040277143e-01; -8.024189268539894e-01   -6.400622645851143e-01   -4.083031835890242e-01   -7.281817279758843e-01   -6.731172869697920e-01   -2.707556228483068e-01   -5.154370322820097e-01   -3.724672019600537e-01   -4.638881688560698e-01   -6.049036193352455e-01   -4.545051179510075e-01   -5.441157273559685e-01];
L1_L3_iAMPA_netcon = [-6.252331190011298e-01   -4.270922542494181e-01   -5.220082151361980e-01   -6.793225145797318e-01   -7.721752530171467e-01   -5.938993650678731e-01   -4.492635386909324e-01   -4.997485433862675e-01   -4.799611267781652e-01; -6.314757125308927e-01   -3.869207359375362e-01   -5.325177544646643e-01   -4.880625435863790e-01   -5.538766680332167e-01   -5.697868077783619e-01   -3.731356390658315e-01   -7.905017466137322e-01   -5.268619953405994e-01; -5.595507398499859e-01   -3.694841557334859e-01   -5.834652204562150e-01   -2.278505906694831e-01   -4.112649525095164e-01   -8.050464436722988e-01   -2.439841723890938e-01   -7.304827267838642e-01   -7.375815310677786e-01; -3.108303361577032e-01   -4.603750166755575e-01   -5.045985089122236e-01   -5.424578109215615e-01   -3.896117644928498e-01   -1.585504406943386e-01   -4.387283380025693e-01   -7.715936279070448e-01   -3.882959620932037e-01; -5.980229017860464e-01   -7.067923264674985e-01   -5.912458637090346e-01   -5.289552306680269e-01   -6.365784411645568e-01   -2.904848064210511e-01   -4.977235790051013e-01   -2.655263389092073e-01   -5.388241327148588e-01; -5.143486827262492e-01   -3.554031032955000e-01   -6.648842018885249e-01   -5.350957869293660e-01   -6.091003084927500e-01   -4.756992214929264e-01   -4.664416707195613e-01   -4.313915117496615e-02   -6.974482050494580e-01];
L3_L1_iGABA_netcon = [-6.150693301219698e-01   -3.912253352993202e-01   -4.765792183113619e-01   -7.072625612217941e-01   -3.617280902384724e-01   -7.710312245609285e-01; -6.917716273617506e-01   -4.873839147325402e-01   -3.220885450552581e-01   -5.113229097340746e-01   -6.058938187377994e-01   -7.994255012361171e-01; -4.378187522643123e-01   -6.646362932510528e-01   -3.070526520165673e-01   -4.142815533220681e-01   -4.810995436939162e-01   -5.856663106741171e-01; -4.673650833696849e-01   -3.669643125207123e-01   -5.763425711258359e-01   -6.706517370100092e-01   -3.421636635059798e-01   -6.688925281163388e-01; -5.463773980604953e-01   -5.865872267905515e-01   -7.124862871373716e-01   -4.897281427708697e-01   -4.969291094677791e-01   -4.187655600387027e-01; -4.170829841263362e-01   -4.874596449458430e-01   -6.621261811298761e-01   -3.050239403734390e-01   -3.436414139403152e-01   -3.694867124860212e-01; -4.473708422998242e-01   -4.559551245879667e-01   -4.326101422252991e-01   -7.395754663292891e-01   -2.443812972689012e-01   -2.044039725387277e-01; -2.770285911997447e-01   -4.910193042558293e-01   -6.714457515062874e-01   -5.826270204820695e-01   -6.669953259529275e-01   -5.182405245506023e-01; -5.652533886583112e-01   -6.104212327459571e-01   -6.396389300490539e-01   -4.193733600521378e-01   -5.789561242605035e-01   -5.597467136988874e-01];
L5_Input1_iAMPA_netcon = [-4.246519714164560e-01   -5.582385639552210e-01   -5.233223456575007e-01   -4.534417615841834e-01   -5.228103017276952e-01   -7.394047034236905e-01];
L6_Input2_iAMPA_netcon = [-6.589888590251720e-01   -6.858463381677375e-01   -5.295234986387789e-01];
L5_L6_iAMPA_netcon = [-6.161062090314514e-01   -6.129026468716617e-01   -4.178424375098768e-01   -4.178548832421236e-01   -6.062399305068547e-01   -4.779824974530887e-01; -6.425964825849313e-01   -4.648695795664941e-01   -6.361983918181374e-01   -5.253350702485081e-01   -4.804459706347313e-01   -3.687232582153080e-01; -7.329785518126682e-01   -3.808109472295415e-01   -2.749102213655261e-01   -3.799113690268753e-01   -4.179377209830792e-01   -4.586931656532770e-01];
L4_L5_iAMPA_netcon = [-4.331122622522969e-01   -4.190965601323071e-01   -5.543692336076469e-01   -4.229673255112411e-01   -5.120460916556879e-01   -5.646754629373797e-01   -3.594750829253311e-01   -3.669573477027594e-01   -6.074411746847874e-01   -3.272801956170765e-01   -7.106645914569066e-01   -5.675201891311905e-01; -3.835620123256376e-01   -2.724687075583453e-01   -3.028227341168806e-01   -3.282953932178918e-01   -5.456645119486001e-01   -5.285156589622572e-01   -5.157440427740462e-01   -1.344038285638022e-01   -4.186323064429031e-01   -3.765684658291381e-01   -6.950423944697243e-01   -6.740499670917681e-01; -3.587667106750455e-01   -5.793627947896655e-01   -3.275087185194284e-01   -5.334701756678563e-01   -4.920696801748883e-01   -5.347052906733981e-01   -4.580318736043902e-01   -4.160078551572312e-01   -5.065634536693716e-01   -6.016786609914875e-01   -6.611194927305346e-01   -4.641781469508484e-01; -2.903379213909209e-01   -4.888223452182207e-01   -5.465106793622623e-01   -3.265749677225303e-01   -6.581588713523490e-01   -5.725607273108575e-01   -3.753383880899384e-01   -5.712100609533577e-01   -5.456214558697549e-01   -6.137543060298347e-01   -7.273367493627628e-01   -5.416897453641327e-01; -4.456170511176140e-01   -3.064580513860029e-01   -6.733965598342229e-01   -4.374823226698836e-01   -4.212006170996734e-01   -3.304917634001789e-01   -6.527676561445090e-01   -5.356435583478496e-01   -5.298447583312357e-01   -7.100779184583208e-01   -5.070832760740316e-01   -1.791627576353789e-01; -7.910615821180375e-01   -5.636408224424323e-01   -7.047835374199793e-01   -6.224824442553778e-01   -6.288011484665527e-01   -6.250336010510684e-01   -4.006667829405011e-01   -3.945468532327095e-01   -4.624204066587946e-01   -7.633003516737155e-01   -5.466955726382987e-01   -7.181178184173607e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
