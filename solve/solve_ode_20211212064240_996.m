function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iAMPA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iGABA_s,L6_L4_iAMPA_s,L5_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iAMPA_IAMPA,L4_L5_iGABA_IGABA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L4_iAMPA_IAMPA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iAMPA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iGABA_netcon,L6_L4_iAMPA_netcon,L5_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.916301526426748e-01   +7.549932622025674e-02   +7.513495524344657e-02   -1.342669603535275e-01   +2.142684255487518e-01   -2.240700400315049e-01   +1.543201037603896e-01   -3.706171834752767e-02   +5.476872493492096e-01; -5.117101380353917e-02   +3.683335115927321e-01   +3.641269099612776e-01   +3.321969287690936e-01   -3.856237474258885e-02   +1.995120016241257e-01   +4.100721766478109e-01   -1.526260421754217e-01   -2.890305449287477e-02; -1.839376498860615e-01   +6.890612367235860e-02   +2.422090584343153e-01   +4.368480504417607e-01   +3.737243019529645e-01   -4.793040303434808e-01   +2.373641337319196e-01   -1.641987975241953e-01   +4.300030674754776e-01; -8.775639621955135e-02   +3.017648315485303e-01   +2.328091927708822e-01   +5.550340652003197e-01   +2.738984008832749e-01   +4.080673819727070e-01   +1.619115689156055e-01   +8.107413389256721e-02   +2.113025688441078e-01; +2.378332098052440e-01   +5.779545070884179e-01   +2.235415277274937e-01   +2.253021056596441e-01   +1.785806970319614e-02   +6.002636805328558e-01   +4.134554879356471e-01   +3.127744359862648e-01   +1.783490280460544e-02; +5.693344852259281e-01   +1.197896401761995e-01   +8.115869783146758e-02   +3.390350958763999e-01   -4.460071564560784e-01   +2.600658659598734e-01   +3.900077046973753e-01   +2.064268929561047e-01   +3.466977363135407e-01; +7.687861177374772e-01   +2.987076784349349e-02   +3.361834765759390e-02   +5.980684810545339e-01   +2.280143613339297e-01   +5.190133533435853e-01   +4.697863149390377e-01   +3.245160546113965e-01   -8.610930561014264e-03; -3.252232153117582e-01   +5.555207855312070e-01   +4.821045508043640e-01   +2.688358406599470e-01   +7.365743013276558e-01   -5.975373756679947e-01   +2.035477549376191e-01   +3.768406952783268e-01   +4.717927431154992e-01; +1.839128976763111e-01   +1.169289947962822e-02   +3.680271680792428e-01   +1.640080506213571e-01   -1.402054614187301e-01   +4.177640007405538e-01   +4.382711280111656e-01   +3.071615732607471e-01   +5.322591877632192e-01];
L1_L2_iAMPA_netcon = [+2.636265127502401e-02   -2.278414838480440e-01   -3.344155510262380e-02   +5.408709645628761e-01   +1.659879858652320e-01   -1.748395170522253e-01   +2.305819252700191e-01   +8.809584631576134e-03   +5.081745293427733e-01; +1.486830415976844e-01   +3.364038696592297e-01   +3.571429565964128e-01   +2.225092669804552e-01   +2.982399355532446e-01   -2.843494925417270e-02   +1.045567411705059e-01   +5.464564135089284e-02   +1.169372423101146e-01; +4.540701004042092e-01   -2.217065668742665e-01   +1.352778626860775e-01   +4.344355082317721e-01   +1.595005608870581e-01   +2.732359169219118e-01   -3.769148074258781e-01   -1.149171016657338e-01   +3.440585629887315e-01; +3.650964267002504e-01   +3.659888856559237e-02   +4.917976588452127e-01   +3.247446194870552e-01   +1.492269305315004e-01   +8.004552661888512e-02   +2.493040081645456e-01   +2.602868502526656e-02   -9.078391265308863e-03; -7.073361334707956e-03   +5.147781978834771e-01   -2.166619177958411e-01   +1.562071351594833e-01   +4.107771971096946e-01   +4.066425057440423e-01   -7.573069294718145e-02   -3.870339528491181e-01   +4.372143131039523e-01; +1.144493751479011e-01   +1.514695126060540e-01   -1.518501008925900e-01   +1.284903883565193e-01   +3.040266135070865e-01   +2.771696416288716e-01   +5.127594028444198e-01   +4.137536051171925e-01   -2.719607137587227e-01; +1.142143025005263e-01   +4.847457219230736e-01   -3.330832103512128e-02   +1.095756480375278e-02   -1.120040411612321e-01   +3.721236921016711e-02   +2.852001095176455e-01   +4.935724158259602e-01   -1.168340979000167e-01; +2.563007857649509e-01   -2.104932053385501e-01   +3.810373746142316e-01   +6.667821092352552e-02   +1.430559300862719e-01   +3.100473719450809e-01   -3.679303057157587e-02   +5.062038119847323e-01   -1.611467144957043e-01; +6.418843044601846e-01   +1.387506300766213e-01   -1.537649701806601e-01   +1.744395487542559e-01   +2.045029123960407e-01   -2.778627535718577e-02   +1.383646082260242e-01   -2.627078797528261e-01   +2.269279928672349e-01];
L2_L5_iAMPA_netcon = [+5.891541163716649e-01   -3.821004409072726e-01   -2.367449539240238e-01   +3.637219634049633e-01   +5.062488752100702e-01   +9.515941260019879e-02   +4.680636590037178e-01   +1.040334000437176e-01   +7.341813614964419e-02; +1.157577530488423e-02   +2.630363691269122e-01   +1.367362312889725e-01   +5.733421442591798e-01   -1.521512628494592e-01   +9.567304886446105e-02   +5.281725882311722e-02   +8.108570157322953e-02   +5.419733524465007e-01; +4.163210288311944e-01   +1.985526430110074e-01   +1.642973082774762e-01   +1.896030671782284e-01   +8.137091259019800e-01   +1.624276970407770e-01   +4.392580751416112e-01   -4.687055694763617e-02   -3.826921364297914e-02; +4.157662431029553e-02   +5.085338126750089e-01   +3.079230713248443e-01   -1.392525464051221e-01   +3.032777790402816e-02   +6.575654440434121e-01   -9.157509595000393e-02   +9.350599023918611e-02   +3.064953560504249e-01; +3.583438695310694e-01   +2.452291804593729e-01   +5.409185025383897e-01   +4.478503848077819e-01   +3.000691819041683e-01   +2.447305377119157e-01   +7.228856845790721e-01   -3.884216269107122e-01   +7.231441837703534e-01; +6.315606939887221e-01   +3.758589388616025e-01   +7.213847497362351e-01   -2.176299664086344e-01   +4.624870888915860e-01   +1.925865436443809e-01   +8.637839777317158e-01   +6.490726485716172e-02   +4.824820304628895e-01];
L5_L2_iGABA_netcon = [+3.696161078537787e-01   +4.372704831420062e-01   +5.595849769753733e-01   +6.151447960702845e-01   -1.654214048320776e-02   +2.199031117083742e-01; +5.672309654304433e-01   -3.285136436740748e-01   +1.108009536758971e-01   +3.202670298901003e-01   +3.690677472422889e-01   -3.062182494144312e-01; +2.027863156789213e-01   +1.695739977815297e-01   +5.069527992951469e-01   +4.409374929964595e-01   +4.212775514921038e-01   +5.428647019461958e-01; +3.178334176955753e-01   -4.710128061035510e-02   +1.849014049230672e-01   +5.902301357726937e-01   -1.749566330920137e-01   +2.748058780030239e-01; +7.841951584346986e-02   +3.597101051124957e-02   -6.054897187028074e-02   +2.505737775054654e-01   +2.655506711977014e-01   -3.162633009808629e-02; +3.212403944909036e-01   +1.311296190743342e-01   +4.874140482560738e-01   +2.404353850228169e-01   +4.287141668476213e-02   +2.307528260765666e-01; -3.190815383809312e-01   -1.305751543760017e-01   +3.062732940931805e-01   +6.945021214439575e-01   +2.620939835499746e-01   +1.853975703829114e-01; +1.911246093863407e-01   -1.483498640725044e-01   +5.244096879488866e-01   +4.612205429400635e-01   +4.409708886211094e-01   +6.049394128203490e-01; +3.625751533353442e-01   -5.522902412265913e-02   +4.564420891709978e-01   -1.767991825510245e-01   +2.870076376328812e-01   -1.005198908810210e-01];
L3_L2_iAMPA_netcon = [+4.591194138939784e-01   +1.080838557554250e-01   +1.975161880564370e-01   +3.170446624340628e-01   +3.404791810703425e-02   -3.427341551012406e-02; -5.069349615028132e-02   +6.566720100963784e-01   +3.161607341650451e-01   +2.738338864360700e-01   +5.924587071339535e-01   +6.004589101580021e-01; +3.811620141827045e-01   +1.493317866765198e-01   +1.167620530999502e-01   +2.411632666679097e-01   -4.425000920486944e-02   +1.805501720037406e-01; +4.501847785210609e-01   +8.983758687918225e-02   -1.455012495473151e-01   +2.275755189905861e-01   +2.573370514866671e-01   +3.731168046353294e-01; -3.922112499252135e-02   +2.218130365416143e-01   +1.360098790545769e-01   +6.063557007541707e-01   +1.358574320140915e-01   +1.919431832253802e-01; +2.342294969068084e-02   +4.716345946094188e-01   +2.184335721461405e-01   +4.813258826394896e-01   +4.415541097763276e-01   -3.180594225338772e-02; +3.014271937854455e-01   -2.462072832909485e-01   +3.279125727074047e-01   +1.420032362105796e-02   +4.172921134177195e-01   +1.698186469444080e-02; -1.853996206718076e-01   +2.325738425912936e-01   -2.074615333111064e-01   +4.207483440023987e-01   +5.930792167801852e-01   -7.350707334098855e-02; -2.582289125903922e-01   +3.308201491774481e-01   -4.882964667757490e-02   +6.637716166570107e-05   +2.644856204034788e-01   -2.748300068825109e-01];
L2_L3_iGABA_netcon = [+3.300950719981886e-01   -1.017775787981438e-01   +5.515497280718504e-01   +4.695778301142063e-01   +3.762275874369678e-01   +3.162959951776556e-01   +2.514493713604359e-01   +3.475328636400214e-01   +1.319444014536356e-01; -6.592259120374967e-02   +1.052595237506000e-01   +3.059643879419176e-01   +4.412233818877902e-02   +2.767471663370699e-01   +4.039510767659856e-01   +5.700817610157703e-01   +5.635637732455222e-01   +4.584804990097098e-02; +7.744214532132951e-02   +2.156508610156763e-01   +5.140283402817901e-01   +2.722111958446400e-01   -2.609433514384972e-01   +3.990540794613263e-02   -7.001786381738703e-02   -5.815295793988805e-02   +3.909390324738245e-01; +4.548428685942739e-01   +2.473072899065105e-01   +4.508454236400941e-02   +2.593155984432766e-01   -1.098979266083149e-01   +1.445777059153705e-01   +1.961210560815153e-01   +5.716587239650451e-01   +1.414948920198534e-01; +4.425856802685035e-01   +3.634816437500540e-01   +1.258243750827099e-01   +4.190061778408677e-01   -2.206748009867235e-01   +3.153360788338224e-01   +3.193451195127062e-01   -2.703264088074275e-01   +3.539548409978353e-01; +4.691518365785166e-01   +4.591547159333007e-01   +1.575010937790616e-01   -2.036488212136454e-01   -8.606215414854468e-02   +2.896966792905305e-02   +5.797352039711378e-01   +1.632829746284664e-01   +4.860519292113384e-01];
L1_L4_iGABA_netcon = [+1.164903809335698e-01   +7.312631933888426e-02   +1.905807460033147e-01   +5.397684472304738e-01   +2.841896007168769e-01   +6.584964039622914e-01   +3.026149407994256e-01   +6.269659897810993e-01   -1.788195053302926e-01; +1.167310687138764e-01   +2.055596486342291e-01   +2.095783490795832e-01   -3.701393972514129e-01   +4.199826891303378e-01   +3.069327389759592e-01   +1.079520531147970e-01   +3.561091018080991e-01   -7.842247713885249e-02; +2.592018771179386e-01   +4.981365100303676e-01   -4.569419954812763e-01   -9.213699631017355e-03   +8.095463542148487e-02   +5.251437194598166e-02   +3.114597613818170e-01   +5.649560101248929e-01   +2.344600557071305e-01; +2.746396175712801e-01   +2.554104729082486e-01   +3.073091131445324e-02   +6.271744802649730e-02   +8.903171974993374e-02   +1.563810211384048e-01   +2.368083503710285e-01   +2.060019440471361e-01   -1.151962526373805e-01; +1.889503875662882e-01   -1.252367703957132e-01   +3.308141079538775e-01   +1.110187504119124e-01   -2.456752678370765e-01   +1.622731547923136e-01   +1.590569964702342e-01   +1.736315815309006e-01   +2.240158221949300e-01; +3.490664265591298e-01   -3.434906482943901e-01   +2.902077205632350e-01   -6.725568856686340e-02   -1.084930177293615e-01   +2.794651135074296e-01   -2.303525480927693e-01   +4.784586018372464e-01   +4.710550092520215e-01; -3.815375482344567e-02   +3.574413685511825e-01   -2.173402812404596e-01   +5.640500231345820e-01   +5.907588254946732e-01   -1.284462084606320e-01   +1.608731787501014e-01   +1.990062469850640e-01   +2.926846330553236e-01; +3.370192923705298e-01   -1.466165636727959e-02   +7.782898690543508e-01   +3.906682851892482e-01   +2.883618253698310e-01   +5.701190305687046e-01   +1.247961977243040e-01   +2.867131438517857e-01   +3.465373363464693e-01; +5.638611265755290e-02   +1.461193977189662e-01   +2.106059069937161e-01   +3.359081659700368e-02   -2.583549334912896e-01   +1.437538279562193e-01   +2.123086829129232e-01   +2.825506708618727e-01   +2.641756360710811e-01; +5.565715504905965e-01   +2.496233574318212e-01   +8.057799439558830e-02   -1.622625349181785e-01   +3.704414529517482e-01   +1.132142045423725e-01   +1.243353619646016e-01   +1.025266193674212e-01   +5.367451852320333e-01; -2.065332724639722e-01   -2.516800175523136e-02   -1.577554890917927e-01   +8.931744421570618e-02   +4.630760445366181e-01   +5.351782596759502e-01   -9.827703583860603e-02   +2.868268556351031e-01   +5.265853951018858e-01; +4.643615915059757e-01   -7.314110240412891e-02   +1.651194733950030e-01   +5.056319906665296e-01   +6.315648860999579e-01   +3.798657148148046e-04   +4.034661930282094e-01   -1.656756809711764e-01   +3.046995710447733e-01];
L4_L1_iAMPA_netcon = [+4.020764035052854e-01   +1.553457362119763e-01   -3.230084515774141e-01   +3.213919978489146e-01   +3.619931667720018e-01   +2.424177153446118e-01   +6.790312749930478e-01   +4.169819536147314e-01   +4.333839549008910e-01   +6.516219992868116e-01   -1.595515673367440e-01   +2.606478845578674e-02; -1.384302748411887e-01   +4.237331267831934e-03   +3.739032739673652e-01   +3.423456237089877e-01   +7.855870574692850e-01   +4.316038489575522e-01   +1.553751004180157e-01   -7.156557534247206e-02   +1.296581200004133e-01   +4.327439494134202e-01   +3.204815821973292e-02   +5.834640575789178e-02; +3.094845585158569e-02   +2.153795824985475e-01   +7.059745911886898e-01   +1.622896716620439e-01   +3.461372238905159e-01   +3.552359628226929e-01   +7.168723347396697e-01   -4.349407787948764e-02   +1.575455073518188e-03   +4.751816845021776e-01   +4.662750217723965e-01   +6.764097422480765e-01; +7.058418093100227e-01   +6.920700375052757e-01   +3.662878399415213e-01   +2.444965724532904e-01   +2.267384244315106e-02   +9.710318944270968e-02   +1.017850378646747e-01   +5.709658761281493e-01   +4.216249392568963e-01   -2.626498054875384e-01   -7.274173951368187e-03   +5.048299845495209e-01; +3.643859716311939e-01   +2.358099455710135e-02   -1.232977281651731e-01   -1.515563966092645e-02   -3.322286400802048e-02   +5.381697921677290e-01   +5.837724251304339e-01   +4.125335554675352e-01   +3.530437781359048e-01   +4.941208628240145e-01   +7.642504699466773e-02   +4.700537872095387e-01; +4.258716416344493e-01   +1.842618372035357e-01   -2.896954001162495e-02   +2.081966034460462e-01   +4.974756215891761e-01   +1.350400181919681e-01   -1.137992967626282e-01   +1.311121372266844e-01   +4.197774311735913e-01   +7.617270068208921e-01   +4.212842285232426e-01   +4.892048031288976e-01; -1.391696797118148e-01   +2.263717764511704e-01   +3.712215780213839e-01   +8.453395392476204e-02   -3.265658765295783e-01   -1.089538232294585e-01   +1.066712631486875e-01   +1.855037481827295e-01   +2.245786516595090e-01   +1.714257754358246e-01   +4.700465909339738e-01   +4.387837924582907e-02; +1.655887489636021e-01   +4.227924406299069e-02   -1.318233718826589e-01   -2.848454851863197e-02   +3.112969613023628e-02   -1.166209275538589e-01   +6.012140695781173e-01   +2.352272887369453e-02   -2.860661364962850e-01   +1.805537408944308e-02   +1.985241146697652e-01   +1.596291635647183e-01; -5.978170897520876e-02   -8.020148097190330e-02   +2.446517859399390e-01   +1.047508656880635e-01   -1.929520366430709e-02   +4.439661244058081e-01   +1.944675379582820e-01   +3.987488161126907e-02   +1.796822839013577e-01   +2.117746191485274e-01   +5.737011886558582e-01   +1.301958652422935e-01];
L1_L3_iAMPA_netcon = [+2.880120726349022e-04   -5.169135824823990e-02   +5.671790991850129e-01   +1.655793385092348e-01   +2.753007388490472e-02   -2.612492767471071e-01   -2.106965906619970e-01   +5.564132952245503e-02   +4.317241348410654e-01; +4.105596878622144e-01   +1.224097684065319e-01   +3.271231156073586e-01   -3.244851499359372e-02   +3.624338717805290e-01   +1.342705039701644e-01   -1.874532301582565e-01   -7.025496993187833e-03   +6.343494913795050e-01; +1.971950929662133e-01   +3.534474528210135e-01   +2.465130352368729e-01   +2.888881752553714e-01   +2.192169522925174e-01   +3.213858262237643e-01   +2.179711476383747e-01   -9.257433325263437e-03   +4.794639087254570e-01; +3.095121480632310e-01   -2.101775536269966e-01   +2.192006147528903e-01   +1.486979364430051e-01   -2.491582744259071e-01   +5.537795441099240e-02   +4.395136227448212e-02   +1.261081733057524e-01   +3.487910263358175e-01; +4.172427821719038e-01   +1.033308524060404e-01   +2.818833052227543e-02   +2.388672008931435e-01   +4.451968856114911e-01   +5.369155541264042e-01   -5.917607546459570e-02   -1.140429781275307e-01   +6.146567791252242e-01; -2.926537661139539e-04   +1.602377296673924e-01   +2.936286645916605e-01   +2.610192873088008e-01   +1.741770681896490e-01   +4.174893953119466e-01   +6.073298806442926e-01   +1.100877302150708e-01   +1.552294159413770e-01];
L3_L1_iGABA_netcon = [-5.596294821076057e-02   +4.551435618791159e-01   +2.866382616803592e-01   +5.410846021123934e-01   +1.882423779489278e-01   +2.367304342713086e-01; -2.448834788886460e-01   +8.560802082747214e-02   +2.756533663520422e-01   +3.400935700899561e-01   +9.870574089079154e-02   +1.626170535499452e-02; +4.161261784209929e-01   +5.541143242789702e-01   -3.647697866976162e-02   +3.802800555744816e-01   +4.750640470226698e-01   +2.915903145464209e-01; +1.802394773540663e-01   -1.829745968589230e-02   +1.608875646728323e-01   -1.281660848192647e-01   -2.964274190715208e-02   +5.283585274381217e-01; +5.561610414860980e-01   +1.268907446284710e-01   +1.398860347941865e-01   +1.305927628473553e-01   +2.060290618267707e-03   +3.034267567838102e-01; -5.574808331036142e-02   +6.474379369472505e-01   -1.203929311198096e-02   +2.379505581597204e-01   +5.127329239466363e-01   +3.601728895163385e-01; +2.733948227173534e-02   -1.921681210863582e-01   +5.116855711733517e-02   +2.475050281557173e-01   +1.269320147829760e-01   -2.576064391110916e-01; +2.003794919788032e-01   +4.808163002215146e-01   +4.924049682232098e-01   +5.160639538621808e-01   +1.763072994339321e-01   +1.302316784929540e-01; -2.817883604775905e-02   +5.370784621679987e-02   -1.200900291252320e-01   +1.063429225744348e-01   +4.784222081424194e-02   +4.218758477739720e-02];
L5_Input1_iAMPA_netcon = [+2.390107848606314e-01   +2.157698337008387e-02   -2.066684668309392e-01   +9.598419408295664e-02   +3.611865694652204e-01   -7.432615724187804e-02];
L6_Input2_iAMPA_netcon = [+6.529072876241891e-02   -1.476286095631258e-01   +3.535140588834458e-01   +8.297197628995379e-02   +5.327050129132931e-01   +2.646464427647500e-01];
L5_L6_iAMPA_netcon = [-9.403876156866003e-02   +1.024008219418256e-01   +1.676274425919764e-01   +1.962008506209202e-02   +1.986056561500953e-01   +2.782425475687600e-01; +3.395292139581240e-01   +3.970816016655777e-01   +4.692785495311139e-01   +7.558928151982856e-01   +5.479918206865471e-01   +6.074998231666165e-01; -2.566687062086462e-01   +3.883290247568096e-02   +2.365597265266396e-01   +4.118053867555777e-01   +3.837245454052325e-01   +2.891046515885344e-01; +1.569554819487622e-01   -1.338777962494109e-02   +4.225119695605554e-01   -7.019768860731920e-02   +6.330379743197030e-02   -2.554545610966917e-01; -3.801423077368724e-02   -2.306196239526728e-02   +5.008738055703097e-01   -2.793525419309084e-02   -1.224488804099403e-01   +1.496168009986188e-01; +2.575581463415807e-01   +1.478588393994693e-01   +1.493356031948027e-01   +6.232825869113843e-01   -1.814227344000523e-01   +3.978488574875587e-01];
L4_L5_iGABA_netcon = [+3.698613475774815e-01   +7.859827180679296e-03   +6.285037344257409e-01   -3.935331086100941e-02   +2.455083424215000e-01   -3.562700616318397e-02   -8.903486342093817e-02   +6.808523835202536e-01   -1.817652290693449e-01   +2.393481718876429e-01   +4.954423952054103e-01   +1.260311403642144e-01; +2.723995697441704e-01   +6.400005516114786e-01   +2.287910974831575e-01   +2.269558391558725e-02   +3.545290162242496e-01   +8.910893579873236e-01   +1.531029575104602e-01   +3.639273849277588e-01   +5.128012095851153e-01   -1.189124246818906e-01   +7.004713089516079e-01   +4.657297966519092e-03; -1.019814985558874e-01   +8.596703413791633e-01   +9.824256775311556e-02   +1.675052605261823e-01   -8.284514113466804e-02   +3.731405095310974e-01   +3.704750851470751e-01   +1.313696839651750e-01   -2.554329163273973e-01   -1.200834035743577e-01   -2.705417485467213e-01   -2.522168567798536e-02; +4.043361110656064e-01   +1.668100706647841e-01   +4.909588318916185e-01   +2.643452936467598e-01   +1.968348505761473e-01   +8.343018690989261e-01   -3.929293727561496e-02   +6.928954864881157e-02   +3.529512981638324e-01   -2.831400973163767e-02   +4.291063601411874e-01   +2.612525747796399e-01; +2.324348076861971e-01   +3.191132187620082e-01   -1.876126005864970e-01   +2.325151431770624e-01   +3.259460063842850e-01   +4.528650761945187e-01   +4.056215314943764e-01   +3.299289785947151e-01   +7.258636154928438e-02   +4.245688965781798e-01   -1.440469644549590e-02   +2.774163146618691e-01; +1.435340250969129e-01   +5.463751925228454e-01   +5.844763921950760e-01   +4.275405146878765e-01   -1.199600702018988e-01   +2.625668031924258e-01   -2.216960415954152e-01   +1.590803292979881e-01   +3.039372454673017e-01   +4.053541606180847e-01   +3.522592478113629e-01   +1.947756774285310e-01];
L6_L4_iAMPA_netcon = [+3.644388626351964e-01   +4.195819387434270e-01   +1.981923437643768e-01   +2.049773714710322e-02   +1.627991606147488e-01   -1.321869607948676e-01; +1.967059374858583e-01   +5.408295654105679e-01   +2.077849547305734e-01   +3.150233907999458e-01   +1.095967763638450e-01   +1.351972697333280e-01; +2.502705874306854e-01   -1.914994290203331e-01   +3.541049213517958e-01   +6.352944512943032e-01   +2.699493898243666e-01   +3.735513380243425e-01; +5.848038389527691e-01   -1.032615035523614e-01   +4.261667367813520e-01   +3.408543805156400e-01   +2.115865939872476e-01   +1.588492118624996e-01; -2.138674493271563e-01   +1.956480466360379e-01   -1.302182324503703e-01   +4.643508239775331e-01   +4.533843421098920e-01   +2.334827103888804e-01; +1.936565956479294e-01   +3.362731712644398e-01   -1.042209409235450e-01   -7.283371269467029e-03   -9.369723686436075e-03   +2.448293438515249e-01; -8.397130093715544e-02   +1.215881041323832e-01   -2.079521952669316e-02   +2.290171937520962e-01   +1.330119919548805e-01   -8.173008628357403e-02; +4.668627334178772e-01   +1.705558940553116e-01   +2.467596495835154e-01   -7.697221964595435e-04   -3.210296364208578e-01   +3.034785182550555e-02; +1.717304639860362e-01   +1.162617899383379e-01   +7.011698759369936e-02   +4.180252888056422e-01   +4.246918216629565e-01   -5.357438892859827e-03; +2.800373694303323e-01   +1.833998077143486e-01   -2.370380479311605e-01   -1.652068939075731e-01   +5.712797528130618e-01   +3.587239024580590e-01; -2.383464525118635e-01   +2.087154391990133e-01   +5.425300218832615e-01   -1.488159625250369e-01   +2.845662554864913e-01   +4.336705552635707e-01; +8.335829749236058e-02   -1.056482553523184e-01   +2.994379710328141e-01   +2.913705895015195e-01   +2.021189881600789e-01   +5.087200265082957e-01];
L5_L4_iAMPA_netcon = [-2.034879801070777e-01   +2.118822755863759e-01   +1.726193846875999e-01   +2.972072507796024e-02   +1.689151568408008e-01   +9.273504652086859e-02; -2.641272291147023e-04   +3.717654119385155e-01   -1.994914593517598e-01   +1.862689319936349e-01   -6.783962506916855e-02   +4.960846170289147e-01; +3.207441135065993e-01   +9.284502901824529e-02   -3.865904539808943e-01   +5.050708106631291e-01   +2.685105451824944e-01   -1.682625326742199e-01; +6.796442652251478e-01   +1.836927626504435e-01   +1.079865169337513e-01   +2.110707449153870e-01   +1.012754023768914e-02   -1.099793558495968e-01; +1.248164389805882e-01   -1.862206865336486e-01   +4.598301726322803e-01   +1.006216479827025e-01   +4.656149612763265e-02   +1.902169087520401e-01; +2.836348161928194e-01   +8.397363899810856e-03   +3.711153419110814e-01   +4.887086733960114e-01   +1.138268418823847e-01   +3.927683947164814e-01; +7.460109513884512e-01   +5.249360885981684e-01   +2.438103875740802e-01   +3.891559938366801e-01   +6.001098611349576e-01   -1.300469141551653e-01; +4.785443329315062e-01   +5.609413056060367e-01   +2.854742538052924e-01   +1.458948549822777e-01   +2.015674875051264e-01   +2.978898140112233e-01; -3.898355677534379e-02   -2.246197765404379e-01   +2.475627837161983e-01   +1.183873785833944e-02   -1.725899305167816e-01   -1.559876840970685e-01; +5.100090752869488e-02   +4.036141832449655e-02   -1.725284872667930e-01   +3.612232999953966e-01   +2.678082087919507e-01   -1.102496596641411e-02; +1.954345698619101e-01   +3.680153250486629e-01   +1.307383303431666e-01   +4.356174987539079e-01   -2.183498603151247e-01   +9.560040631297083e-02; +8.580028086848248e-01   +2.070753944003740e-01   +5.010097438880565e-01   -1.245230863269079e-01   +4.872155390090606e-01   +3.478984344575907e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iAMPA_s_last =  p.L4_L1_iAMPA_IC+p.L4_L1_iAMPA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iAMPA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iAMPA_s(1,:) = L4_L1_iAMPA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iGABA_s_last =  p.L4_L5_iGABA_IC+p.L4_L5_iGABA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iGABA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iGABA_s(1,:) = L4_L5_iGABA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;
L5_L4_iAMPA_s_last =  p.L5_L4_iAMPA_IC+p.L5_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L5_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L5_L4_iAMPA_s(1,:) = L5_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L1_iAMPA_IAMPA(1,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA);
L4_L5_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L5_iGABA_IGABA(1,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA));
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L4_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L4_iAMPA_IAMPA(1,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA);
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((((-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s_last*L4_L1_iAMPA_netcon).*(L4_v_last-p.L4_L1_iAMPA_EAMPA))))+((-(((p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s_last*L4_L5_iGABA_netcon).*(L4_v_last-p.L4_L5_iGABA_EGABA)))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA))))+((((-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s_last*L5_L4_iAMPA_netcon).*(L5_v_last-p.L5_L4_iAMPA_EAMPA))))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 100*(sin(2*t)) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 100*(sin(2*t)) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iAMPA_s_k1 = -L4_L1_iAMPA_s_last./p.L4_L1_iAMPA_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L4_L1_iAMPA_s_last)/p.L4_L1_iAMPA_tauR);
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iGABA_s_k1 = -L4_L5_iGABA_s_last./p.L4_L5_iGABA_tauGABA + ((1-L4_L5_iGABA_s_last)/p.L4_L5_iGABA_tauGABAr).*(1+tanh(L5_v_last/10));
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);
  L5_L4_iAMPA_s_k1 = -L5_L4_iAMPA_s_last./p.L5_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L5_L4_iAMPA_s_last)/p.L5_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iAMPA_s_last = L4_L1_iAMPA_s_last+dt*L4_L1_iAMPA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iGABA_s_last = L4_L5_iGABA_s_last+dt*L4_L5_iGABA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;
  L5_L4_iAMPA_s_last = L5_L4_iAMPA_s_last+dt*L5_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iAMPA_s(n,:) = L4_L1_iAMPA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iGABA_s(n,:) = L4_L5_iGABA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;
    L5_L4_iAMPA_s(n,:) = L5_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iAMPA_IAMPA(n,:)=-p.L4_L1_iAMPA_gAMPA.*(L4_L1_iAMPA_s(n,:)*L4_L1_iAMPA_netcon).*(L4_v(n,:)-p.L4_L1_iAMPA_EAMPA);
  L4_L5_iGABA_IGABA(n,:)=(p.L4_L5_iGABA_gGABA.*(L4_L5_iGABA_s(n,:)*L4_L5_iGABA_netcon).*(L4_v(n,:)-p.L4_L5_iGABA_EGABA));
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L4_iAMPA_IAMPA(n,:)=-p.L5_L4_iAMPA_gAMPA.*(L5_L4_iAMPA_s(n,:)*L5_L4_iAMPA_netcon).*(L5_v(n,:)-p.L5_L4_iAMPA_EAMPA);
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
