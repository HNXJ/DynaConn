function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+1.414645556289588e-01   +2.434129112499712e-01   +4.583901830887444e-02   +7.079840884904260e-01   +2.489365975115524e-01   +3.916973577666689e-01   +7.050314313420820e-01   +5.061154408390408e-01   +5.993717447200619e-01; +3.346245118439439e-01   +1.234718891645942e-01   +1.275886482339077e-01   +4.037185802637505e-02   +7.443229898208288e-01   +7.740218325488037e-01   +7.037193338392816e-01   +1.896229371275510e-01   +1.984799760059099e-01; +1.235269252608464e-01   +5.330225678139205e-01   +3.037854368762689e-01   +5.668494354229239e-01   +8.621912624695535e-02   +1.826372499677124e-02   +8.499553393393916e-01   +7.207406537619823e-01   +1.478633248796798e-01; +7.151382653528569e-01   +2.003599346486110e-02   +3.750447469923018e-01   -6.251826674244853e-03   +2.656500281813371e-01   +3.961794855745664e-01   +3.079042422300061e-01   +6.848857237059796e-01   +3.941925761851400e-01; +4.218010101862089e-01   +2.298948371542661e-01   +7.358500934962852e-01   +4.851277244071551e-01   +4.578053148660991e-01   +7.943891915441957e-01   +5.719597958274035e-01   +2.747746049751482e-01   +5.122531480501292e-01; +3.966070141346064e-01   +2.621663221483399e-01   +4.838719189835324e-01   +5.669497430606494e-01   +5.797904027598304e-01   +6.344659718015536e-02   +7.959276394831456e-01   +3.923792413641185e-01   +5.218476405637678e-01; -1.825630707037649e-03   +5.558756651334321e-01   +5.253565886559247e-01   +4.849552015428438e-01   +7.340696873884947e-02   +4.164140974685451e-01   +3.513242878872818e-01   +6.392148835450775e-01   +6.531427907202758e-01; +8.822200413235620e-02   +1.778779165142472e-01   +1.481941471789337e-02   +3.660173646865452e-01   +6.804609526054337e-01   +5.484520804718328e-01   +5.210800930474460e-01   +1.322611698024779e-01   +1.911958138306876e-01; +1.808388012741958e-01   +1.948081008032612e-01   +8.562490668654653e-02   +3.159049434260227e-01   +9.551337568859637e-02   +5.229033345617385e-01   +5.071377480196522e-01   +4.496922890143049e-01   +1.993306858624240e-01];
L1_L2_iAMPA_netcon = [+3.571621530065154e-01   +5.756733002155270e-01   +3.375863282451179e-01   +2.267196569578358e-02   +6.539943811459707e-01   +4.349197167557990e-01   +6.739995798021032e-01   +6.552283165862356e-01   +4.407969629847263e-01; +3.220153055283480e-01   -1.866862412701759e-03   +4.763997798735575e-01   +3.640311447884582e-02   +4.388720032905019e-01   +3.163739820186813e-02   +5.323425762304058e-01   +3.902770850668965e-01   +7.652440221295447e-01; +4.902076845269442e-02   +2.075918086027873e-02   +6.548370371429035e-01   +6.626715743083370e-01   +2.395405250240445e-01   +2.973515977726238e-01   +3.630563609290199e-01   +5.579117542794764e-01   +2.803200720478772e-01; +2.670162086626153e-01   +3.482752417552922e-01   +3.470005908426925e-01   +8.109446408469380e-01   +6.384971860651846e-01   +4.183100312462928e-02   +4.212603781231242e-01   +2.896267578850244e-02   +6.229272643161462e-01; +1.356772979679083e-01   +7.269363563645900e-01   +7.417116688877046e-02   +2.227523995635896e-02   +2.599733530107242e-01   +5.257931720402869e-01   +5.951437055488358e-01   +5.435688761982341e-01   +5.312315754355174e-01; +4.237799278196654e-01   +6.395742118147107e-01   +2.013776169234042e-01   +3.128276749533622e-01   +6.740642466959386e-01   +3.178586581219733e-01   +6.019776779044612e-01   +6.691743763027863e-01   +4.419707720187681e-02; +7.400476492406814e-01   +7.067245820624730e-01   +1.382353886523213e-01   +2.197944305383403e-01   +2.453425304842911e-01   +2.838260386591457e-01   +8.724446380574832e-02   +6.859957269957041e-01   +1.996671063238508e-01; +2.919253435962653e-01   +2.250665456209061e-01   +1.205494315901878e-01   +4.425056112535196e-02   +4.328426139062888e-01   +7.548249828701441e-01   +6.158223528676312e-01   +6.812985070823834e-01   +6.102601956878150e-01; +7.446231404238355e-01   +5.424115649383554e-01   +4.168224701440146e-01   +3.626064598337705e-01   +3.109745843124729e-01   +7.146766928871637e-01   +1.225816523258939e-01   +7.443989429061760e-01   +5.582575400031091e-02];
L2_L5_iAMPA_netcon = [+6.243798914252375e-01   +9.599375405339319e-02   +3.665801568832093e-02   +6.843866553610121e-01   +4.755669231279027e-01   +4.771711244684284e-01   +6.345258969606941e-01   +7.290910046338708e-01   +1.774189142162631e-01; +4.772061930629729e-01   +7.141684724319903e-01   +1.762882650474373e-01   +7.359449367663925e-01   +2.039772728143458e-01   +2.140228659378478e-02   +3.667162584559758e-02   +2.708680548784496e-01   +6.055962540929870e-01; +1.622479884689685e-01   +4.064805040992066e-01   +2.250164472508794e-01   +1.320207956186017e-01   +2.718882174760539e-01   +8.101886086518503e-01   +7.030738377715444e-01   +4.387054845040225e-01   +4.930825803500745e-01; +2.641726944299973e-01   +3.982345238286645e-01   +2.573838063876445e-01   +4.266905150902401e-01   +4.501798491787614e-01   +5.355759941571525e-01   +6.341209918924805e-01   +6.665495207414518e-01   +2.332302355566081e-01; +6.393531812957786e-01   +2.501683942400025e-01   +1.213814192288826e-01   +4.472753558265223e-01   +8.124102720148069e-01   +9.285296573098176e-02   +2.748786127965986e-01   +4.995727941708767e-02   +6.732076719545887e-02; +7.533919301935930e-01   +2.884539467993874e-01   +7.311806472668757e-02   +7.235117789903264e-01   +2.092165168788504e-01   -1.681631931453685e-02   +4.989085603929620e-01   +6.479834844676896e-01   +7.100928566780818e-01];
L5_L2_iGABA_netcon = [+1.973894199450363e-01   +1.878881576964929e-01   +7.328004791638232e-01   +2.468573552837708e-01   +1.169312832960321e-01   +7.745287895526254e-01; +6.505172251016283e-01   +5.634889050392768e-02   +6.032272304202184e-01   +1.041732956246873e-01   +6.228684550707901e-01   +8.118706297443548e-01; +8.094084536809254e-01   +6.285926493338612e-01   +4.149659626235645e-01   +1.040049411850004e-01   +2.788540989671353e-01   +3.891512272321115e-01; +2.963460926955717e-01   +3.459749443894640e-01   +5.752596425481628e-01   +1.128008222646078e-01   +7.651350449897012e-01   +3.015877786289199e-02; +5.152731479167586e-01   +5.746088529335425e-01   +7.322220510911950e-01   +4.679919666665471e-01   +2.537448658099185e-01   +4.913371353518747e-01; +1.205811926637908e-01   +7.477844277457273e-01   +1.722049798435619e-01   +3.955474580011982e-01   +3.930643908454436e-01   +5.410205477192093e-01; +7.663363168869571e-02   +4.128175214535263e-01   +6.764971952645158e-01   +5.308667330777143e-02   +6.291459936019802e-01   +3.141921452044891e-01; +7.577404845755034e-01   +1.640279673219012e-01   +1.068915193480052e-01   +6.030725416176094e-01   +1.033175125168430e-01   +1.529284728906686e-01; +2.621751404408016e-01   +1.578606243652137e-01   +9.320128356551240e-03   +5.039083221199684e-01   +1.307604580527556e-01   +5.457643148053798e-01];
L3_L2_iAMPA_netcon = [+8.493442636905671e-02   +4.659740426488746e-01   +6.144525065732629e-01   +1.408070611733221e-01   +8.318316763009411e-01   +5.135633414816361e-01; +4.441763237643842e-01   +1.997770643717589e-01   +6.147556136494376e-01   +6.765398286570399e-01   +4.134661859545776e-01   +3.378614348682785e-01; +2.280955110032460e-01   +1.127662492316573e-01   +2.902815920902435e-01   -1.603945033223447e-02   +3.325328267627293e-01   +3.040895986740171e-01; +5.751199204856198e-01   +2.206002468795582e-01   +2.398061609758006e-01   +5.190161675758864e-01   +2.212361781308231e-01   +6.726126945860453e-01; +8.760059422608849e-02   -3.103350339290726e-02   +5.750134218296563e-02   +6.305339813627558e-01   +7.200156318231545e-01   +8.231306507343158e-01; +6.826284538584780e-01   +1.759061422044572e-01   +4.505145076260055e-02   +3.886243145907926e-01   +3.104166361494646e-01   +5.567860508601372e-01; +3.050771536004010e-01   +5.755166935310398e-01   +4.038444294179794e-01   +1.939789941090569e-01   +3.424474924670703e-01   +2.599151832888967e-01; +2.993915676012882e-01   +6.606182829829668e-01   +6.059827944332481e-01   +2.828540020832150e-01   +6.271039953319617e-01   +2.394105845700396e-01; +1.881736127570560e-01   +4.803191689448376e-01   +2.979060322501836e-01   +8.100016784821627e-02   +5.654800686772109e-01   +6.859409755807448e-01];
L2_L3_iGABA_netcon = [+5.869912326334347e-01   +5.938799477021180e-02   +3.340946854097515e-01   +6.302158886434381e-01   +3.451520549958399e-01   +2.819349435129241e-01   +4.575621342744323e-01   +6.192603375556326e-01   +6.817595678113224e-01; +1.852715392697392e-01   +7.265277315063936e-01   +6.354591616366499e-01   +5.037276125412158e-01   +6.488894032235569e-01   +2.553995929572307e-01   +5.567831389029255e-01   +1.712764403703035e-01   +2.530710943481966e-01; +8.583761342673123e-02   +6.673199550157116e-01   +7.406317753530476e-01   +7.932542848429555e-01   +1.696170084663411e-01   +6.214456286482466e-01   +7.681144166290159e-01   +2.385328427525923e-01   +2.473228321369256e-01; +8.599561152850942e-02   +6.761056127462207e-01   +4.154702654503336e-01   +5.929097450452898e-01   +5.520510984697532e-01   +1.883707583370014e-01   -1.108683879705707e-04   +3.091364863339804e-01   +4.950006033639855e-02; +3.265504272116656e-01   +4.992779133530693e-01   +7.500070180485986e-02   +3.003814148944611e-01   -2.594469708025367e-02   +4.787960531690437e-01   +1.101216005336764e-01   +3.496946909403570e-01   +1.019107931503455e-01; +6.072306678849066e-02   +5.904218887702972e-01   +3.258224477262901e-01   +7.907098702594245e-01   +1.242834080994598e-01   +2.910333134713545e-01   +1.312270165731947e-01   +6.522748614207612e-01   +6.050611700971376e-01];
L1_L4_iGABA_netcon = [+2.884969418901362e-01   +1.903581648553114e-01   +3.140364732643868e-01   +2.895860369937884e-01   +4.797607533839633e-01   +1.117179968605519e-01   +5.810931969352197e-01   +1.564880493377155e-01   +9.720397259379537e-02; +1.041050886912161e-01   +5.547502480683406e-01   +5.919058040901328e-01   +5.038515641126592e-01   +5.388499641517295e-01   +4.027027951698384e-01   +7.238745003433260e-01   +2.539445361794840e-01   +3.610524982140439e-01; +6.605928359872255e-01   +3.673300703934435e-01   +4.485738111406298e-01   +2.832092192743791e-01   +5.636118204710878e-01   -2.030625817715908e-02   +3.571579551350392e-01   +9.502612300351097e-02   +5.462535429372021e-01; +2.992866519519525e-01   +4.761683658382762e-01   +5.687550620124280e-01   +1.856570118272306e-01   +1.000699053240193e-01   +1.301036213728004e-01   +3.913017515663502e-01   +1.725767607661385e-01   +7.505604486405895e-01; +6.197852766046409e-02   +7.450227396755866e-01   +5.930011083931552e-01   +7.414149688664023e-01   +5.386288209948663e-01   +8.315090794201122e-01   +2.351643453069165e-01   +4.201965284127970e-01   +2.979341759046650e-01; +1.034691010856055e-01   +7.370657701683332e-01   +2.884582928446757e-01   +6.607925657772542e-01   +2.891921886472808e-01   +6.898529956045937e-01   +5.313651540664343e-01   +3.404030036546224e-01   +9.386740828280085e-02; +3.560046782709181e-01   +4.006757456662156e-01   +5.180221740051764e-01   +8.058558071269515e-01   +5.911256879458181e-01   +4.694840832537944e-01   +1.541035897369847e-01   +1.002447093250173e-01   -2.021859399753725e-02; +6.998808896520865e-01   +3.201470744394252e-01   +6.323297993011268e-01   +5.901837436635018e-01   +7.336543621523505e-01   +3.827609369121492e-01   +6.665347117079848e-01   +7.373157368693569e-01   +8.341369520073030e-01; +4.427423967338239e-01   +2.469405782585729e-01   -4.503762921632244e-02   +1.328446698106949e-01   +6.595613758085649e-01   +5.879515889907854e-01   +5.399859108423586e-01   +2.033050001933953e-01   +1.221263177176873e-01; +1.115703641734283e-01   +7.551836286678580e-01   +5.753159488651011e-01   -4.116054391193295e-02   +4.698101377665816e-01   +2.372387076936548e-01   +7.575139542773873e-02   +5.571775257536218e-01   +7.326215515943436e-01; +4.731964401942631e-01   +3.347523069224245e-01   +1.904127698185630e-01   +5.220737423555390e-01   +2.343914043660366e-01   +4.993309443799078e-01   +5.937158258212203e-01   +4.373506953852042e-01   +6.892360689588981e-01; +6.161575453373473e-01   -5.708767850612975e-03   +2.840940383382429e-02   +6.035266584918302e-01   +5.349888322349134e-01   +4.026582762442803e-01   +4.185651678575306e-01   +1.271936714789141e-01   +6.192580090585356e-01];
L4_L1_iGABA_netcon = [+3.547050448544041e-01   +4.770149998267040e-01   +3.381871757178366e-01   +3.595006295432157e-01   +1.191034619553228e-01   +5.537023197146973e-01   +2.775797417027156e-01   +3.604798025468589e-02   +5.918856123149172e-01   +1.538142929958194e-01   +1.769443704272170e-01   +2.884493542915388e-01; +5.618715589011828e-02   +1.115172211594090e-01   +4.307098076168054e-01   +7.179226333524511e-01   +2.400958988745513e-01   +1.502487790105001e-01   +6.399020052372202e-01   +2.161006869220901e-01   +7.273753791628472e-01   +4.437099339596957e-02   +1.996564875410501e-01   +1.270559286682773e-01; +2.676745240241500e-01   +7.105037792860077e-01   +6.454255288010959e-01   +3.359500513815824e-01   +5.874858193494280e-01   +6.170911077028551e-01   +4.476007936953939e-01   +6.469582101916357e-01   +4.355983360305494e-01   +5.698975800535464e-01   +3.331768056828921e-01   +3.749685209274914e-01; +6.572608190989535e-01   +3.675413094710377e-02   +4.629594597948318e-01   +4.134403282065207e-01   +3.770602214787790e-02   +4.708498942554775e-01   +1.611621766533623e-02   +6.875349984718704e-01   +3.274835103119484e-01   +6.549243698557513e-01   +9.188501593294339e-03   +8.410399722111485e-01; +8.203854712407330e-01   +8.077521628319764e-01   +5.511720376854597e-01   +3.307289158558818e-01   +2.701538707215132e-01   +5.277208367859597e-01   +4.718240614419709e-02   +1.575519861093327e-01   +2.906507377343206e-01   +7.933766675625414e-01   +5.407220826335037e-01   +7.246527613095233e-01; +1.164696157424532e-01   +3.148815093901930e-01   +3.302078434500238e-01   +7.517446536920893e-01   -3.772642570391858e-03   +5.652085642555462e-01   +5.867564329428728e-01   +7.775688320296370e-01   +2.124419741597136e-01   +2.942769973071317e-02   +8.624973466774223e-02   +1.791924490677519e-01; +6.912548784169972e-01   +1.714896814856732e-02   +3.206670189133851e-01   +3.074746232785275e-01   +1.127734633155192e-01   +3.077652078085273e-01   +1.841792398131703e-01   +7.314382813279650e-01   +4.420662296757094e-01   +1.829427553798734e-01   +2.640165721276405e-01   +6.227555945147411e-01; +6.633931610938752e-01   +1.690509755426576e-01   +2.466436357699819e-01   +1.732530443913889e-01   +6.591535282457375e-01   +2.180676944709155e-01   +4.545998289278631e-01   +3.945632750218860e-01   +7.841376882154788e-01   +7.515087741517985e-01   +3.851893984007149e-01   +3.432101926443255e-01; +7.220485712455151e-01   +2.158088566039364e-02   +4.764353730744730e-01   +4.629369219184468e-01   +2.657474948939453e-01   +5.199643662998317e-01   +2.238495416206943e-01   +6.591926962731901e-01   +6.884270617362089e-01   +3.172988642670910e-01   +1.948811204072258e-01   +3.675431521913514e-01];
L1_L3_iAMPA_netcon = [+1.190432094697731e-01   +4.924520469092465e-01   +6.929373183001842e-01   +5.460302867114647e-01   +3.511077442763947e-01   +4.057365847785130e-01   +1.827938456774240e-01   +2.538402762781942e-01   +1.251487867712972e-01; +2.840468394053449e-01   +4.672824473354403e-01   +5.778697350371436e-01   -1.016653337258693e-03   +1.178535448326066e-01   +1.694001861608725e-01   +8.017085408771298e-01   +1.378015786090633e-02   +7.850557080466403e-01; +5.843941922931916e-01   +1.665739009165413e-01   +1.832237981805318e-01   +5.759910084671332e-01   +3.696953702096570e-01   +6.195870172630213e-01   +3.485407469855822e-01   +7.192734568955662e-01   +3.533105172438051e-01; +3.690755672131342e-01   +4.589929312467346e-01   +2.153965903458492e-01   +2.703814392433751e-02   +6.129553757525616e-01   +7.381563192533193e-01   +5.664860034886664e-03   +8.058705120510302e-01   +2.523468283834983e-01; +1.127576935974473e-01   +3.803461428738212e-01   +3.348362090763587e-01   +3.414496462058811e-01   +2.938019826906847e-02   +5.424676018247218e-01   +5.510843910281581e-01   +2.736450228791145e-01   +2.705450647165899e-01; +3.698660491633933e-01   +6.672139522426034e-01   +6.045861967475998e-01   +2.528601474827440e-01   +5.887677464295731e-02   +5.607095236412885e-01   +8.339322242148114e-01   +3.166877180108738e-01   +1.038354318406065e-03];
L3_L1_iGABA_netcon = [+8.221758165358658e-01   +5.500905880023439e-01   +6.751922116743422e-01   +1.382172851764709e-01   +7.737102603183951e-02   +3.134030958081925e-01; +5.219654645221388e-01   +2.154436499804606e-01   +5.163475693110280e-02   +1.427077329952773e-01   -3.035477842129339e-02   +2.536512639634893e-01; +6.844350471062147e-01   +1.408668113569705e-01   +5.636306813602471e-01   +2.802746941572836e-01   +5.429981584955039e-01   +6.165885156820415e-01; +6.233850523745244e-02   +3.702577667049327e-01   +5.983144750692344e-01   +2.680318180836625e-01   +6.327676115199635e-01   +2.354296990131403e-01; +5.237661813346148e-01   +2.109095501342861e-01   +2.755916913078190e-01   +7.822976537482780e-01   +1.727263076932823e-01   +2.185401995261908e-01; +5.119741934018406e-01   +2.810323153842565e-01   +3.517336765811195e-01   +7.711435016210859e-01   +5.663573950998579e-01   +6.156169771747761e-01; +9.944154437298315e-02   +1.009094843433919e-01   +6.547608601612079e-01   +3.207790694167820e-01   +5.562162778803635e-01   +8.714111574794715e-03; +4.225048629591034e-01   +2.469894464588366e-01   +7.723274058164180e-01   +1.986110643323200e-01   +3.128560472421953e-01   +1.379865964910751e-01; +5.534140070899340e-01   +7.459353055228944e-01   +8.199429671445053e-01   +3.114544390753571e-01   +3.375759403197877e-01   +7.599190556419677e-01];
L5_Input1_iAMPA_netcon = [+3.313031495827335e-02   +5.603449476277489e-01   +2.045693451686802e-02   +2.811515116430482e-01   +3.781360904180366e-02   +7.142043284368526e-01];
L6_Input2_iAMPA_netcon = [+5.516539233312837e-01   +4.915063406351348e-01   +7.366810002054702e-02   +6.327580184626065e-01   +3.837947713010387e-01   +1.652796364243760e-01];
L5_L6_iAMPA_netcon = [+6.125988625835146e-03   +3.578999371755594e-01   +1.793389144859932e-01   +7.649317701307979e-01   +2.205266821714467e-02   +1.798097295688101e-01; +2.435498688935099e-01   +3.284566690575657e-01   +7.351003154548769e-01   +6.147965057492056e-01   +7.058875203520826e-01   +7.828587166487636e-01; +6.667056810698440e-01   +5.021951351850625e-01   +5.587352668418125e-01   +2.344680302123786e-01   +1.624238567169959e-01   +4.977911548772946e-01; +5.908989744574200e-01   +7.492896579828972e-01   +5.297914977427950e-01   +3.330046375138164e-01   +3.129470172028703e-01   +8.139677303918363e-01; +2.852317598610017e-01   +7.874516501625950e-01   +8.212156447629316e-01   +2.759492178972995e-01   +5.418793143950564e-01   +4.974663197852593e-01; +8.359304560019016e-01   +5.099976473817870e-02   +6.014425042783005e-01   +1.802862843857421e-01   +5.928476225223409e-01   +6.312283589648728e-02];
L4_L5_iAMPA_netcon = [+3.450279001315534e-01   +6.538281174231444e-01   +5.946730089967275e-01   +4.017028897615578e-01   +3.132002242313385e-01   +2.936227512153419e-01   +6.731239783846107e-01   +1.763656912887099e-01   +4.724618747206074e-01   +1.509523983917436e-01   +6.953465576672941e-01   +2.932604530458737e-01; +1.117747590502423e-01   +7.515946909717913e-01   +1.075130582291922e-01   +4.303857360539928e-01   +3.133389415671377e-01   +5.153078281406130e-01   +8.138855395090915e-01   +1.781908700745032e-01   +2.152693526300225e-01   +2.655744723010100e-01   +5.004497307133333e-01   +4.414357639749970e-01; +5.160263346422871e-02   +6.985387567616669e-01   +1.919653127093134e-01   +5.553935894476675e-01   +1.096056006367289e-01   +5.623155027653653e-01   +6.924644243230008e-02   +2.848211367865962e-01   +6.627583071372538e-01   +4.963080274585490e-01   +6.012869363016660e-01   +7.031975751948104e-02; +1.355410209909569e-01   +3.218487530738646e-01   +5.457916271539682e-01   +5.109560209584514e-02   +1.166914774648549e-01   +8.162375623619247e-01   +5.772655478125224e-02   +1.626642469767756e-01   +2.483795815300881e-01   +4.884015359545592e-02   +5.515088508716532e-01   +1.727334454328531e-01; +3.011781301496636e-01   +6.760113829773191e-01   +3.023772761124250e-01   +6.155834225272701e-01   +4.516161646861230e-01   +5.996644580261541e-01   +6.850736756424851e-01   +6.324457000599276e-01   +4.135357489214208e-01   +1.299461430831369e-01   +4.989465501352892e-01   +5.623404335594989e-01; +3.754094035178183e-01   +6.355613771839477e-01   +1.902089260497098e-02   +4.472746788930234e-01   +6.483618539201869e-01   +8.076987842880186e-01   +1.457305825656238e-01   +3.269248933457614e-01   +3.050789522016625e-01   +4.390855012301774e-01   +3.861861419281342e-01   +7.773096518558672e-01];
L6_L4_iAMPA_netcon = [+3.143040304763197e-01   +5.754606102068544e-01   +4.653880375056755e-01   +5.264088879498229e-02   +2.650869930744069e-01   +4.874296341416428e-01; +5.348478468818236e-02   +2.689750636331976e-01   -4.687649046599369e-02   +1.342371052656524e-01   +2.136936737583484e-01   +5.538109082661722e-01; +2.824836375003657e-01   +3.537991992614096e-01   -7.869422517338536e-03   +2.208213944847658e-02   +4.781344109885098e-01   +3.404970359760738e-01; +6.651732333955050e-01   +7.331516652388809e-01   +3.553053165294832e-01   +2.359182031366424e-01   +7.525733979993697e-01   +4.245170794466825e-01; +7.409658268243170e-01   +1.679988134308606e-01   +2.831555339395166e-01   +2.797692321592886e-01   +3.479789213270880e-01   +8.449172194406647e-01; +6.729669528823768e-01   +7.017902379249430e-01   +5.364378937954201e-01   +5.170489118392912e-01   +3.445531990969672e-01   +4.389332245559510e-01; +6.196773981335213e-01   +7.738902225917788e-01   +3.619012998941427e-01   +7.678664783619715e-01   +5.965628300699797e-01   -4.305909603793207e-02; +7.398152733906142e-02   +6.406064484627233e-01   +5.393657231452957e-01   +1.629970236477993e-01   +6.944716680931320e-02   +7.986703414464260e-01; +2.281572737932047e-02   +1.509864244371761e-01   +5.627069072222095e-01   -2.541861895064011e-02   +5.892522070343172e-02   +1.093086476828275e-01; +1.854995959204475e-01   +5.384016809416574e-01   +3.494044643635761e-01   +2.330876241409745e-01   +7.138156630807349e-01   +5.566170482620959e-01; +5.078087030888675e-01   +3.002232039049167e-01   +6.766538951440075e-01   +1.200881643636239e-01   +3.867535783735168e-01   +6.860979087687389e-01; +4.894613859391458e-01   +5.118333878904135e-01   +7.607006412621194e-02   +1.766086212987260e-01   +7.190890726390461e-01   +7.102252519830866e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t<50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
