function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+2.668133632880831e-05   +3.898192707069612e-02   +1.046860594828957e-02   +6.667832282281319e-02   +2.385770205323413e-03   +4.978127576939332e-02   +9.213798366383912e-02   +5.870898832448322e-02   +4.913384598160423e-02; +2.333400824712169e-02   +2.323564948193943e-02   +8.689926857599107e-03   +5.125794914283165e-02   +9.781303191687565e-02   +3.818959521053886e-02   +5.493512268746568e-02   -9.763478581407817e-03   +2.094123148056160e-02; +2.913005888090450e-02   +6.518480421795765e-02   +4.310932626077930e-02   +2.873865286898165e-02   -2.740603864237219e-02   -5.540948793992858e-04   +1.154148111379030e-01   +6.723585040002189e-02   +4.016506717634093e-02; +8.327396249711344e-02   -3.037218819546997e-03   +6.640776236524772e-02   +1.173849584622363e-02   +3.902455858539025e-02   +3.931869372498543e-02   +3.369740680501634e-02   +6.762228009941414e-02   +4.735694039566033e-02; +3.395337812484860e-02   +7.268075424572262e-05   +9.032085955916637e-02   +6.935289073740537e-02   +8.690156769356756e-02   +7.566218548133813e-02   +3.816493123151224e-02   +1.611095490154779e-02   +3.609763711617897e-02; +5.420122973969022e-02   +1.945221206040883e-02   +5.657025649531177e-02   +9.772520457786557e-02   +6.367974602813120e-02   -8.810707601288881e-04   +8.744159404170729e-02   +1.131235729761649e-02   +3.725807805272693e-02; -2.097460990303892e-02   +1.391027303862035e-02   +5.238056521402625e-02   +5.932287658743353e-02   -1.294246270712252e-03   +4.105753988841414e-02   +5.417293965077343e-03   +5.527107793899803e-02   +6.391329101816481e-02; +5.461099837215630e-02   +3.648771495854915e-02   +1.306642021137868e-02   +4.000257988182621e-02   +3.184911810509674e-02   +1.638726746554972e-02   +4.702207842054992e-02   -3.254034818494119e-03   +6.135318124591629e-04; +4.841023860071923e-02   +5.554855674695277e-02   -1.243263868424432e-02   +2.593900008660583e-02   +5.748568098934168e-03   +9.379074951612539e-02   +4.292257528225805e-02   +1.593300594357368e-02   +9.464559973693587e-04];
L1_L2_iAMPA_netcon = [+6.716079021969493e-02   +6.841644692413129e-02   +5.390326876830615e-02   -3.621639250783129e-02   +6.888158778750232e-02   -1.763816514872498e-02   +7.781799897153661e-02   +5.355075809974336e-02   +6.624720713484449e-02; +4.628853224845194e-02   +2.942256629749276e-02   +5.556223647676929e-02   +7.695731290777462e-03   +4.282320193953489e-03   +5.248342123338028e-02   +7.238761512696819e-02   +8.210181924735258e-02   +3.525683044609537e-02; +2.183215117960701e-03   +4.412240793334854e-02   +7.419265822799130e-02   +3.846280650802830e-02   -1.572622810034083e-02   +3.328083509798154e-02   +6.467651304435421e-02   +8.385360351429354e-02   -2.948930428109833e-03; -3.478338580522134e-03   +6.178276217501463e-02   +3.618743010120674e-02   +7.192174750228415e-02   +2.404955894552912e-02   +5.288797764072324e-02   -1.288417702717242e-02   -1.399588998354546e-02   +7.108789053857231e-02; -5.565051410806250e-03   +1.019293736537422e-01   +1.918590822141097e-02   -1.965567389419233e-02   +1.685998042379361e-02   +5.246056293596790e-02   +2.566365771976384e-02   +6.197923932581624e-02   +5.376455199174533e-02; +5.460867597347560e-02   +7.839697451507350e-03   +5.849393883034071e-02   +3.119352171298827e-02   +5.425237729768152e-02   +2.557295215055912e-02   +6.601185799099833e-02   +8.600314184803655e-02   +2.318659565413954e-02; +8.602262529467897e-02   +7.655230343561543e-02   -1.285857703121983e-02   +6.111272429577966e-02   -7.583463571093641e-03   +5.845269781685550e-02   +3.747133623665712e-02   +9.050494392007415e-02   +1.519018352856020e-02; +4.245119262906123e-02   +3.820027275869389e-02   -2.365640109049362e-02   -1.249844249924919e-02   +4.826523023365844e-02   +2.647937474468496e-02   +7.410608127306546e-02   +5.620322175997657e-02   +8.873475627744455e-02; +1.001132684429145e-01   +5.375540367623240e-02   +1.193656002561144e-02   +3.755741723215467e-02   +4.819136294663352e-02   +1.077422554494380e-01   -9.804815491731893e-03   +1.172470911743247e-01   +1.622630401824061e-02];
L2_L5_iAMPA_netcon = [+1.027286533114232e-01   +3.885414755453366e-02   +2.643076726720272e-03   +1.039494077743213e-01   +8.485313235697292e-02   +8.104043667125670e-02   +7.255083152225825e-02   +8.382095740440001e-02   -2.064440733220324e-03; +3.712333627703183e-02   +1.042251467424435e-01   +2.312016827074167e-02   +8.430213746304965e-02   +1.089427393665085e-02   -8.720793419867484e-03   +9.362464573499183e-03   +1.969647031575752e-02   +7.448617447674416e-02; +6.939118049667319e-02   +5.440265590184754e-02   +8.221178879005073e-03   +1.154924603621074e-02   +4.157579330188883e-02   +9.222114783375568e-02   +7.759431493569460e-02   +7.505776510571076e-02   +4.514887107665504e-02; +2.514172737680572e-02   +5.512460914017916e-02   +3.190674466400255e-02   +8.346782886857765e-02   +2.740937231012377e-02   +7.985431008856217e-02   +3.078861507005495e-02   +9.724358362876456e-02   +5.761740012519555e-02; +1.840103254305376e-02   -3.412468947967614e-03   +1.048301335173043e-02   +5.285329962635396e-02   +7.370969011500028e-02   -6.534790988728176e-03   +2.961323689750941e-02   +8.911258450812289e-03   +1.746825105286564e-02; +6.445208223062526e-02   +1.380446608941034e-02   +1.725948538601982e-02   +9.064400004647349e-02   +3.512537280839997e-02   +2.471470646322625e-02   +1.717433580986489e-02   +6.093187274520794e-02   +8.866503151185737e-02];
L5_L2_iGABA_netcon = [+1.699214085444645e-02   +8.682640112911984e-03   +4.797394199106829e-02   -6.912299045093676e-03   +2.709264129641547e-02   +1.087956262352651e-01; +9.060506035955948e-02   -2.833472744530808e-04   +5.650806424855796e-02   +4.864134080570481e-02   +4.248575813523582e-02   +6.888271504603834e-02; +1.039789643468479e-01   +9.909345866488281e-02   +5.674122990820699e-02   +2.318098532151400e-02   +1.861214735478110e-02   +4.424010363376026e-02; +6.564232982046397e-03   +3.097506184193248e-02   +3.420386745757260e-02   -1.089093428783456e-02   +7.160399754266202e-02   +2.006072870469538e-02; +4.383062095807263e-02   +6.581610101961205e-02   +7.464146768044763e-02   +7.131702518116570e-02   +3.092155998406244e-03   +3.580784282207261e-02; +4.224835444457065e-02   +3.500633718733638e-02   +3.593958011120338e-02   +8.419143848494165e-02   +4.744382131104634e-02   +1.861887912232453e-02; +1.805112398495979e-02   +1.925065461951860e-02   +8.643122410149953e-02   -2.135997760799532e-02   +8.826572230833708e-02   +3.112114075606676e-02; +7.575835451957424e-02   +4.572906936871942e-03   +4.490438879729797e-02   +8.282541723768540e-02   +5.035032986285105e-02   -2.642610069497264e-02; +4.370177472698807e-02   +4.131046293501035e-02   -4.012254987649898e-02   +4.518975808739489e-02   -1.145617691929163e-02   +5.111814341013615e-02];
L3_L2_iAMPA_netcon = [-2.961641366513244e-02   +2.352297229845457e-02   +3.087876355712360e-02   +1.905272844049040e-03   +8.989594161581879e-02   +5.903430859127029e-02; +2.602264986054274e-02   -2.219901281557797e-03   +5.251677309112666e-02   +1.091041197700696e-01   +4.256826375717323e-02   +3.071955200167309e-02; +6.058419355771111e-02   +3.664411114646423e-02   +3.808783714994834e-02   -8.975864190459201e-03   +1.593042124433274e-02   +3.956021924621882e-02; +3.359863948058746e-02   +2.759357344218479e-02   -3.737484390048675e-03   +3.828093900236195e-02   +3.545348036602883e-02   +9.898160222393326e-02; +2.186893494560860e-02   +1.816126832112311e-02   -1.424228549681276e-02   +9.607088261831565e-02   +9.890000289913582e-02   +7.929041903310777e-02; +8.499248995588632e-02   +2.635139420054990e-02   +1.137339616398059e-02   +1.277544957866599e-03   +4.707822835808620e-02   +5.504935957060565e-02; +3.563217232802290e-02   +7.620672449919362e-02   +1.669450715734484e-02   +6.527798427500439e-03   +2.953696397018100e-02   +2.068684780169042e-02; +1.497334075352719e-02   +6.997545957653376e-02   +5.466872381063209e-02   +4.390005588355497e-02   +3.708031767404674e-02   +3.009538320422220e-02; +1.247101553770468e-02   +5.450019094674144e-04   +3.011332259494649e-02   -2.886888507480246e-02   +6.041892451726443e-02   +5.893878127365135e-02];
L2_L3_iGABA_netcon = [+7.044265635155242e-02   -7.440522866418733e-03   +5.413101279625812e-02   +5.086630769539092e-02   +6.871914588157862e-02   +2.873097304666693e-02   +7.324926022802411e-02   +9.552496841428879e-02   +8.740113488741055e-02; -2.181932028670807e-02   +1.010837578019279e-01   +7.734987874095194e-02   +6.191492385426882e-02   +7.605639117299136e-02   +4.792975990242448e-02   +2.869655876922286e-02   +5.957799394499252e-02   +5.677348909965114e-02; +2.165172064249376e-02   +7.254444381605897e-02   +3.641244324470088e-02   +3.550647807137266e-02   +1.844717755391018e-02   +6.124914997968092e-02   +6.842801578213815e-02   +2.749955401903230e-02   +4.066877973819858e-02; +1.078467444311219e-02   +7.472455842224164e-02   +3.306386361665319e-02   +5.661154084925887e-02   +6.270340153109495e-02   +6.981446274777324e-02   +4.026865304551835e-02   +3.341076315266044e-02   -2.476675722974756e-02; +2.916090664558599e-02   +3.956834741628337e-02   +3.976726930276036e-02   +5.028740364880599e-02   +1.841058662646106e-02   +5.018327540897759e-02   +1.196384532174559e-02   +3.133880741201575e-02   -4.184989115308435e-03; +3.978924665225505e-03   +9.248428844123907e-02   +1.019009096373881e-01   +5.587060035735191e-02   +6.553044060968496e-02   +4.404539834257218e-02   +5.345235745886975e-02   +5.199602005388170e-02   +8.991225108950983e-02];
L1_L4_iGABA_netcon = [+2.548722584374972e-03   +6.484450508109032e-03   +3.187049016284368e-02   +3.256048532905911e-02   +7.877307946829443e-02   +4.562794982077470e-02   +6.818397741780187e-02   +3.425537310409376e-03   -6.303006836137821e-03; +3.086232923169580e-02   +8.619610194498602e-02   +1.081705622805088e-01   +6.009573765115519e-02   +4.374688048397784e-02   +6.520047533522719e-02   +9.860237563866395e-02   +4.661215094645735e-02   +4.945858161736869e-02; +6.286427621197752e-02   +4.539343072085418e-02   +7.699770229501765e-02   +6.529067463770200e-02   +7.556476227632204e-02   +6.893752418267150e-03   +8.175311959011373e-03   -1.629037111576948e-02   +6.254833314207306e-02; +7.276761723111922e-03   +4.010237159593318e-02   +8.830469857089608e-02   +6.022322303166868e-03   -3.598841444365333e-02   +1.548324360518575e-02   +5.651499094047593e-02   +4.826850034437608e-02   +8.610599305179616e-02; +1.415995776922317e-02   +8.752075627628696e-02   +3.189395765626207e-02   +7.468158059292455e-02   +7.217343721482304e-02   +6.618515383773638e-02   +1.565594110703809e-02   +4.848198923181700e-02   +1.579747930863826e-02; +1.798618405822478e-02   +5.989508596156524e-02   +3.854115683534864e-02   +5.674597569145019e-02   +2.761399579281199e-02   +7.497542654198101e-02   +4.967212666788315e-02   +6.091382638480158e-02   -2.300035946524018e-02; +2.411267505071404e-02   +6.042011854773264e-02   +2.898350540695285e-02   +5.632739159390079e-02   +1.094511624512891e-01   +4.059884116717680e-02   +5.170157753686293e-02   -1.364414192329130e-02   +1.452778257419960e-02; +5.200065391042639e-02   +2.274366733410247e-02   +5.839766930753039e-02   +3.983420674577091e-02   +5.505238671193216e-02   +1.752211747557770e-02   +3.469393478687295e-02   +4.532294063719328e-02   +8.120486408128648e-02; +3.937550701974463e-02   +4.021515604088453e-02   -1.109245033201253e-02   -7.615966797774522e-03   +6.600443568453307e-02   +7.161643651749589e-02   +4.522745123183957e-02   +3.387009059537759e-02   -1.164296698178532e-02; +1.606225822492002e-02   +7.764000074439693e-02   +6.398797548512365e-02   -1.846737382195441e-02   +1.379436947421489e-02   +3.022936097197028e-02   +2.042614178618037e-03   +6.908530570736846e-02   +6.659695187965836e-02; +1.100316337540315e-01   +5.014497738785342e-02   +1.364474905833258e-02   +5.730928730759895e-02   +3.321031052087599e-02   +7.059432592376196e-02   +3.298871858513931e-02   +4.122856369074224e-02   +1.026573998094100e-01; +5.022491381924066e-02   +1.659136250963041e-02   -2.192146712392640e-02   +8.401714210009212e-02   +4.628085968363017e-02   +6.238698905079269e-02   +5.383149532807933e-02   +4.673590400985034e-02   +7.623876459878270e-02];
L4_L1_iGABA_netcon = [+4.756507951441984e-02   +5.911150660636898e-02   +5.509943948454731e-02   +1.236708982354402e-02   +6.435616031192342e-04   +7.371207107336961e-02   +4.490788597969059e-02   -3.008842991086549e-03   +6.753987041717398e-02   +1.381950499452388e-03   +3.518208209176316e-02   +2.304275017240030e-02; +2.826094743649136e-02   +6.461479282909879e-03   +7.670656345649518e-02   +4.536294552995312e-02   +2.180915749441464e-02   +4.837401188638334e-02   +1.083234277064543e-01   +1.854146618776442e-02   +1.215636881046272e-01   +3.167081117336500e-02   -2.421424324862756e-02   +4.623913660625773e-02; +2.722604818124830e-02   +5.824070741647744e-02   +4.824427330178754e-02   +1.915089357356340e-02   +5.849395186768516e-02   +5.330453202149182e-02   +1.902670520859957e-02   +6.122537811750791e-02   +6.699402577453120e-02   +1.052872501603443e-02   +4.096197522802981e-02   +4.334004747419426e-02; +8.293245262665785e-02   +4.443233176813385e-02   +4.338703720654552e-02   +6.242501831441554e-02   +3.216077524643549e-02   +5.066676880517113e-02   -1.097927907575751e-02   +6.089966774910002e-02   +1.791907081652835e-02   +8.908063294487369e-02   +2.278594072924180e-02   +7.730241880949870e-02; +7.190255108207641e-02   +1.220100495151310e-01   +4.936739370053337e-02   +4.688266119176833e-02   +5.981036533456059e-02   +2.966655389614089e-02   +1.275248416546510e-03   +2.070904200867141e-02   +2.375110137876981e-02   +1.087576864026209e-01   +8.024015763245392e-02   +5.215393131509123e-02; +4.521224968216971e-02   +2.724380477711179e-02   +5.308222316598882e-02   +9.503595553896559e-02   -3.177106936536934e-02   +4.640054826303971e-02   +6.181157874135163e-02   +1.056426861159563e-01   +5.043136623216888e-03   -1.464495590508267e-02   +2.470426187412953e-02   +1.869699506041223e-02; +4.530725196974683e-02   -5.654319687905125e-02   +3.833180449848791e-02   +3.217961217289637e-02   -2.380243242386934e-02   +2.942469220298598e-02   -7.447683056077419e-03   +7.382171265572569e-02   +2.489742026383738e-02   -2.200906671432867e-03   +1.011067437428400e-02   +7.287187623286154e-02; +1.096771201662790e-01   +2.653394695896667e-02   -1.430886837715678e-02   -1.655967262422924e-03   +7.765307188990243e-02   +5.077970332741304e-03   +7.274292900871901e-02   +3.869026076219105e-02   +8.714435024705117e-02   +9.922861721261497e-02   +8.015685027201330e-02   +4.191598447467035e-02; +7.440003540420470e-02   +3.367948917049096e-02   +6.441592920015324e-02   +5.239776362012395e-02   +1.504277480388805e-02   +4.206788360880755e-02   +5.252098213483672e-02   +1.137274503414813e-01   +7.926538228890671e-02   +3.689411099021396e-02   -1.140356936381642e-02   +2.423117683598163e-02];
L1_L3_iAMPA_netcon = [+3.776294377393546e-02   +7.273435694907089e-02   +3.569003567913535e-02   +7.133120927673198e-02   +4.265263425374274e-02   +5.860209272007361e-02   +2.803624336149272e-02   +7.251441946548542e-02   +4.406412782010439e-03; +1.216105219265626e-02   +6.649525520253027e-02   +3.716602013658282e-02   -1.517424048714243e-02   -7.072210664542532e-03   +2.807219478979030e-02   +1.139917329668673e-01   +8.414970428742636e-03   +8.927593843429849e-02; +7.217335811053013e-02   +4.109747808074037e-02   +5.162292329972149e-02   +1.040443869599254e-01   +2.476090398791946e-02   +7.787196802230753e-02   +5.242351689836035e-02   +1.130118472837128e-01   +4.593029250584797e-02; +8.173306038872170e-02   +1.417558838687310e-02   +1.048336619314922e-02   -6.282750318031216e-03   +7.593139338072484e-02   +4.619215532325317e-02   +1.914797995856855e-02   +6.450587380158364e-02   +7.889653869002351e-03; +1.981264650802633e-02   +3.765708443494431e-02   +2.050787002287737e-02   +4.987079324149782e-02   -1.536186906861766e-02   +8.165937720438532e-02   +4.578429578204497e-02   +1.070262525010626e-02   +4.992189703505974e-02; +1.885171849187439e-02   +7.941356859959223e-02   +5.563752571835394e-02   -4.424826779180187e-03   +1.784547069779122e-02   +4.394980470469185e-02   +5.827043756150554e-02   +3.969871091470096e-02   +1.150271836017109e-02];
L3_L1_iGABA_netcon = [+9.919425703495974e-02   +6.977973615885898e-02   +4.350972713320333e-02   -1.664530498194339e-02   -8.720528065622622e-03   +6.788451564264740e-02; +2.859751574112670e-02   +5.218488933469454e-02   -1.073805572881438e-03   +8.107105203928178e-03   -7.803460990456240e-03   +4.376776484691252e-02; +6.687881737493423e-02   +2.399393664236357e-02   +6.292352052267608e-02   +4.100376341444451e-02   +7.949033153774387e-02   +7.531257147660080e-02; -1.985512073167648e-02   +7.200325570756780e-02   +4.817250649416484e-02   +5.263394862141473e-02   +1.154707220496625e-01   +8.988594840536646e-02; +4.429730248319868e-02   +3.739917097876817e-02   +8.298808053029379e-02   +4.165517520680449e-02   +3.658877710043734e-02   +4.589999591054332e-02; +8.968253374148148e-02   +5.380067000583865e-02   +3.444772708538868e-02   +7.816632862679482e-02   +8.729148174814533e-02   +6.703718476774810e-02; +5.801502610164763e-03   -7.005621789694554e-03   +8.359877174100007e-02   +3.144352823311055e-02   +4.572445423993168e-02   -2.163954208038282e-03; +2.882606328146067e-02   +4.521734223605332e-02   +8.487944608908547e-02   +4.702027198786765e-02   +1.870108887433481e-02   +1.252292983118197e-02; +3.203680619208042e-02   +1.036778071887647e-01   +7.598007505363484e-02   +6.714287916875794e-02   +4.416261613065194e-02   +7.331946306873123e-02];
L5_Input1_iAMPA_netcon = [+1.088406356717158e-02   +6.444854003297930e-02   +4.988066212045987e-02   +4.979432623355824e-02   -2.083058554039156e-02   +7.573907069185443e-02];
L6_Input2_iAMPA_netcon = [+4.642093516061900e-02   +6.439973372045642e-02   +5.795543854599855e-04   +4.081345879535751e-02   +4.867796820383406e-02   +9.654549214235900e-03];
L5_L6_iAMPA_netcon = [-4.074680553227596e-02   +6.523068356794313e-02   -1.007410770132529e-03   +1.118200633764181e-01   +2.761956471813504e-02   +1.760567710986494e-02; -1.065487923258038e-02   +1.314151597156846e-03   +6.236526055875154e-02   +7.997185566279649e-02   +7.821533414321148e-02   +5.002773428306655e-02; +8.054127185422114e-02   +7.226252672190608e-02   +6.294016563806598e-02   +1.130857579175147e-02   -1.562802154293279e-02   +7.012093321898473e-02; +6.481939971507501e-02   +1.073283389391945e-01   +8.243803091190971e-02   +1.246976121023133e-02   +4.974566446043036e-02   +7.081430741782280e-02; +3.282746619245604e-02   +9.960204081535275e-02   +9.623100880661908e-02   +1.452663002413438e-03   +4.229818277102323e-02   +3.884930334201945e-02; +6.371658197082000e-02   -2.104079296325645e-02   +1.303618603923816e-01   +1.946210257679029e-02   +9.144733887214418e-02   +2.872909099341339e-03];
L4_L5_iAMPA_netcon = [-9.870634734515148e-03   +3.825825371093194e-02   +8.294648684574329e-02   +3.141841830801112e-02   +2.327516232339874e-02   -9.477607051458233e-03   +1.154016842332920e-01   +2.538211913115001e-02   +5.111385199747414e-02   +6.203933277052249e-02   +9.381143768650928e-02   +1.919839878374355e-02; +1.948055747686588e-02   +8.495298541034302e-02   +3.605707215873409e-02   +5.444120243010188e-02   +5.315115304667778e-03   +4.268689659062706e-02   +9.634392063976352e-02   -2.768563401707762e-02   +1.725092076541797e-02   +2.165297561792313e-02   +8.062781296083073e-02   +6.792757164741010e-02; +4.199446513488708e-02   +4.538337733246914e-02   +1.308398468516328e-02   +2.540309212683513e-02   -2.639423076853019e-02   +1.063438542656551e-01   +9.460767109869889e-03   +3.268310874632351e-02   +5.718430664978869e-02   +6.908179062345518e-02   +8.106618014873791e-02   +3.492633475914621e-02; +5.640473470195285e-03   +4.773191313685387e-02   +3.595626609276097e-02   +2.497183496073530e-02   +1.039352247349942e-02   +6.753754073604730e-02   +1.457815262072019e-02   +3.168035601462832e-02   +7.250399401521201e-02   -1.331628220443659e-02   +1.072850391167651e-01   +1.920121716469945e-02; -1.686740707180938e-02   +6.203437800096873e-02   +4.966890968918595e-02   +3.139591718460940e-02   +5.463508296070154e-02   +6.281411327544188e-02   +7.702073987424103e-02   +1.190041433794232e-01   +3.384704810366890e-02   +1.103604125907461e-02   +6.678420801376876e-02   +5.298095596911209e-02; +7.420317270579353e-02   +7.208310892518850e-02   +4.704585271799820e-02   +7.822543100527606e-02   +5.214213426051612e-02   +1.151597519433596e-01   -5.744289292174363e-03   +1.234310121298895e-02   +2.865592656529329e-02   +9.088712623981958e-02   +5.946315843918029e-02   +9.116730281208302e-02];
L6_L4_iAMPA_netcon = [+6.490104683196618e-02   +5.529080093285892e-02   +5.628779469005641e-02   +2.639420163356285e-02   +4.128130068696372e-02   +5.311612640741123e-02; -7.237235773869851e-03   +4.709643422629323e-02   -1.347033839714317e-02   +1.277297911777489e-02   +5.183346543158043e-02   +4.243164249020556e-02; -1.166910530136015e-02   +2.214362481330243e-02   -2.710616207412148e-02   +2.578368355512451e-02   +1.054064401433824e-01   -9.867472513231976e-03; +8.348520447051742e-02   +6.950561226546505e-02   +3.410617919888905e-02   +4.010368060676486e-02   +8.506358844626215e-02   +2.186302485370454e-02; +1.450540741050160e-01   -1.209325121203300e-03   +3.031881974066875e-02   +2.579420544547726e-02   +6.316564635911391e-02   +8.374485296006980e-02; +7.017333153278724e-02   +6.409027365503914e-02   +5.386857233774268e-02   +5.875026458989240e-02   +1.389670188114425e-02   +9.905444872385703e-02; +4.071989009178512e-02   +7.406198224365526e-02   -3.190402688204183e-03   +3.639764636778386e-02   +8.262284186644679e-02   +6.900535792006741e-03; +2.251763590898431e-02   +1.024176159776240e-01   +9.491460996767752e-02   -2.840024038297174e-03   +4.530903600102729e-03   +1.003863059353026e-01; +1.263335199217516e-02   +3.006550559896585e-02   +6.673826725474229e-02   +3.306027305695399e-02   +3.661788607936456e-03   +3.194439081797900e-02; +2.992504446848083e-02   +4.054854450951853e-02   +7.040616379304510e-02   +4.959029026229308e-02   +9.897239400563693e-02   +3.828066640174922e-02; +6.916835876388175e-02   +8.647043347045847e-03   +9.666296018176714e-02   +4.305885611438856e-02   +4.611462807050253e-02   +1.758604194825330e-02; +5.336713206088053e-02   +6.057790498815519e-02   +1.974344286900070e-02   +1.149964912654677e-02   +5.904100018012653e-02   +5.413870885814615e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
