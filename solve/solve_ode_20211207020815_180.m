function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.381329029709958e-01   +9.122170959489995e-01   +8.833511460854009e-01   +8.089788988459246e-01   +9.124456932248326e-02   -9.365060940974685e-01   +5.755359069219483e-01   +8.659206388068752e-01   -9.352504045269691e-01; +7.191617002650562e-01   +8.131060383316008e-01   -6.934891442369759e-01   +9.904601419583203e-01   +7.346349006233863e-01   +5.810646294760208e-01   +1.365176940306341e-01   -9.125253230385204e-01   +7.515124021195125e-01; +7.643345165296107e-02   +7.914399998491928e-01   +2.442830155458902e-02   -3.964896397678957e-01   +9.567778415873386e-01   +7.184763109938491e-01   +5.920339614551627e-01   +9.820190622932390e-01   +5.311699053833295e-02; -4.934858754989674e-01   -7.535956895201867e-01   -5.318007446447457e-01   -5.074523521049362e-01   -8.789838437950820e-02   -5.183188241096002e-01   +4.675789833695213e-01   -5.448967644437728e-01   +2.003537042610239e-01; +2.753546329957740e-01   -4.713776021586701e-01   -9.706587821938190e-01   +9.891787938149390e-01   -2.003525886447907e-01   +6.953991768662203e-01   +6.626450099409174e-01   +3.375978542945402e-03   +3.312947451079527e-01; +8.728941861152063e-02   +3.883431425691143e-01   +1.000000000000000e+00   +9.915515937402248e-01   -1.047709653401373e-01   -8.640576366631709e-01   +9.046440888747131e-01   +2.756503725917375e-01   +1.083278963918978e-01; -9.229205312661144e-01   +3.521409415612985e-01   -8.438912342465578e-01   -4.846463547042176e-02   +3.347334976154803e-02   -7.874871133201994e-01   +3.653660345112321e-01   -3.337421308392803e-01   -3.456754932484778e-01; -1.274323867033084e-01   +6.898674665687948e-01   -9.447839155907889e-01   -8.329474518609056e-01   +9.371754835898318e-01   -1.644482031158830e-01   +7.045525477737149e-01   -3.670319608171151e-01   +7.809323266951785e-01; +1.200827445090037e-01   +9.167223227308523e-01   -6.289800420082866e-01   +8.922107509806002e-01   -4.031436014024407e-01   +9.796242160726401e-01   -5.266242505408294e-01   -6.815006869373034e-01   -8.542372392437312e-01];
L1_L2_iAMPA_netcon = [-1.172430021609079e-02   -3.360045913269205e-01   -6.483793992807282e-01   -2.126535591894650e-01   -5.208284072706036e-01   +9.386370645197718e-01   +2.020271222805749e-01   +8.998138932974867e-01   +4.686619633894036e-01; -2.622350818323330e-01   -7.969741539655149e-01   -8.181589807814619e-01   +3.784196474241386e-01   +6.672809344132912e-01   -2.802132677705936e-01   -5.714299096708634e-01   -3.188299278331468e-01   -2.502511168359255e-01; +2.773547924627345e-01   +9.933626023845010e-01   -8.729283378411588e-01   +5.781675829602763e-02   -3.634591600997752e-01   +2.897081813931220e-01   +4.427447704843159e-01   -7.986686159971443e-01   -5.457937833698132e-01; +4.895944834599164e-01   +4.929219302156114e-01   -8.534757766711418e-01   -6.163435425254217e-01   -4.592459997955110e-01   +4.430522957151129e-01   -8.704872397142646e-01   -1.507621117902156e-01   -5.026894825691319e-01; -9.078808813984423e-01   +2.759770025587130e-01   +3.338259321527458e-01   +1.764103595552901e-01   -4.221309355196494e-01   +8.905481662930240e-01   +6.730979819326162e-02   -2.551718425468669e-01   +7.693524688709499e-01; +8.352799082022363e-01   -3.410742952917432e-01   -9.107035026851155e-01   -2.094502795018730e-01   -8.173002432332926e-01   +1.552379761240412e-01   -3.508311133948964e-01   +2.085844244855363e-01   -9.044956767991859e-01; -8.746912966308750e-01   +7.294733705846429e-01   +9.352472297644997e-01   +4.916179631722645e-01   +3.031175839687583e-01   -5.587117151036064e-01   +2.295432113330602e-01   -4.750469874012733e-02   -3.319793589608613e-01; +6.304283564933197e-01   -8.550752459153823e-01   +8.066719243106802e-01   +4.464798180918151e-01   -3.221427309906641e-01   -2.188586692678561e-02   +9.084676620308444e-01   +8.049763308430672e-01   -9.450948517031837e-01; -3.032620434967564e-01   +1.000000000000000e+00   -2.311862239514682e-01   -7.330313011987007e-02   -9.302746850343442e-01   +1.271375281624675e-01   -8.740398890219701e-01   +6.361043157732789e-02   -5.347973740549515e-01];
L2_L5_iAMPA_netcon = [+2.715501927753755e-02   -8.189778641775374e-01   +3.450631094451741e-01   +5.211703954659186e-01   +5.081179615888877e-01   -8.396596693673699e-01   -6.016692684921072e-01   -9.834739985950022e-01   +7.106240670516781e-01; +3.318603056577075e-01   -6.772524146686665e-02   +8.208062496699090e-01   +5.164754446577856e-01   -2.957046159150507e-01   +4.942863549635361e-01   -7.558211287779879e-01   -1.000000000000000e+00   -6.526205528889398e-02; -8.777571502608548e-01   +9.050555399336044e-01   -2.332495118162097e-01   +9.615256698409506e-01   +7.435796630644392e-01   -4.911093409572585e-01   +6.562719497826439e-02   +9.251529313717313e-02   +3.599696492436414e-01; -3.236248465609997e-01   -8.124437665998473e-01   -3.004715900986009e-01   -4.768622968525925e-01   +8.420496640783975e-01   +1.334711828465164e-01   +1.253110049002922e-01   -5.958058644425761e-01   -7.839634199329281e-01; +4.568206672642984e-01   -7.023076994777037e-02   +8.543880355292042e-01   +3.980495761325091e-01   +7.602010145207584e-01   -2.254659707120688e-01   +4.366323123522465e-02   -7.156945720058311e-01   -8.477375690225186e-01; +7.943517126239898e-01   -1.855166792870044e-01   -1.079074920708293e-01   +7.697209897945955e-01   +4.101980092386030e-01   -8.018391927029096e-01   +9.962490842261579e-02   +7.133549349111269e-01   +7.123414897973142e-01];
L5_L2_iGABA_netcon = [+3.191566641900578e-01   +7.795748042910862e-01   +9.601155530313095e-01   +5.723050587675682e-01   -3.182597667084905e-01   -7.102962158327959e-02; -7.576285371819187e-01   +6.017964920213198e-02   +8.465256777916152e-01   +3.785365296705011e-01   -8.658465319412881e-01   +9.320563840438799e-01; -6.984462727361472e-01   +9.434409849079926e-01   +3.000279428961141e-01   +1.391235590470443e-01   -1.852804626072375e-01   +9.961982874571452e-01; +2.243483811598127e-01   -8.004399056775895e-01   -6.626464112677847e-01   -8.131371029502835e-02   -2.574040173976914e-01   +6.539881873496086e-01; -7.681059751040691e-01   +3.300011361617533e-01   -7.054957853854716e-01   +9.542681625390587e-01   -6.318133338190481e-01   -3.157223581001828e-01; -5.185460563441163e-03   +3.406778523577220e-01   -5.303316456157902e-01   -4.024137723221068e-01   -2.981234813281773e-02   +1.291664042475784e-01; -8.207013891011146e-02   +8.942230421262092e-01   -1.313525226563982e-01   +5.431673955913173e-01   +6.837808622563143e-01   -5.657858870609147e-01; +1.000000000000000e+00   -6.094489414528507e-01   -8.905362058080487e-01   +7.217214685551308e-01   -8.254676685095720e-01   -5.023641767305762e-03; -1.407224257977185e-01   +8.897845655867695e-01   -8.118027424678240e-01   +7.291528774869228e-01   -1.101333058443260e-01   -5.185543407524055e-01];
L3_L2_iAMPA_netcon = [+6.750919062953933e-01   -6.325218188170897e-01   +6.478357725755365e-01   +5.353315181218521e-01   +6.960244929897460e-01   +5.938923959739004e-01; +8.327704884664597e-01   +1.265001673061135e-01   -7.675573682529980e-01   +6.075047886044947e-01   -4.915104863920081e-01   +1.423837066083183e-01; -2.947517924531868e-01   +2.460147190737628e-01   -3.366955467455419e-01   +4.085059494510501e-01   -3.869459407062699e-02   -3.079901763876529e-01; -7.453001603752318e-01   -9.789212634181686e-02   +3.537104005238534e-01   +1.497827620320399e-01   -3.401353016758104e-01   +1.045423665356875e-01; -9.841446988294373e-01   +7.980512390721783e-01   +4.557389013303853e-01   -7.565606353591409e-01   +6.430703532198870e-02   +9.551515068006763e-01; -6.727630688177053e-02   +8.825322294354355e-01   -6.826159955706947e-03   -1.029597793567590e-01   -7.657774107199775e-01   -8.253030718829023e-01; +9.543920880612837e-01   -1.000000000000000e+00   +6.211560165543306e-01   +1.184458049747336e-01   -8.447173225247501e-01   +2.320012500748259e-01; -2.367866070153246e-01   -3.591018411449567e-01   -9.881004192398194e-01   +6.698340577497295e-01   -3.988071065159825e-02   +5.794269882172149e-01; -6.742050160973052e-01   +5.760670774340677e-01   +1.887584230199148e-01   -8.678452679363462e-02   +6.383351912755948e-01   +3.212044394156583e-01];
L2_L3_iGABA_netcon = [+3.141951714662758e-01   +5.206197019023128e-01   +2.679713426073385e-01   -9.523595374181115e-01   -3.025123889487132e-01   -4.670621473259056e-01   +4.660754073122633e-02   +8.940480549382636e-01   +2.857091834253070e-01; -9.832826550202951e-01   +6.459321685574810e-01   -3.194356994174230e-01   +7.501354220530130e-01   -8.291497929566061e-01   +1.755440275336275e-01   -3.246483349025676e-01   -8.403607615181733e-01   +4.819709053164412e-01; +4.453032968977738e-01   +8.880642256382301e-01   -9.550543532123732e-01   +6.866767852222779e-01   +8.713116670929838e-01   +9.642163202288291e-01   -8.211384019098190e-01   -4.125215587459336e-01   +5.093533716042832e-01; +6.889188107600157e-01   +5.797644858015397e-01   +8.801795919861435e-01   -5.847605594887930e-01   -5.585235225503006e-01   -9.733869964857768e-02   +4.597673628881963e-01   -9.948233947528224e-01   +9.516507394026651e-01; +5.054150172514680e-01   +7.748852998512962e-01   +5.065183556985345e-01   -5.557813547864867e-01   +1.000000000000000e+00   +2.425112204221200e-01   +8.287640410410479e-01   -3.020143665773781e-01   -8.928802613142724e-01; -3.472444682737009e-01   +4.671859682927839e-01   -1.309732047787283e-01   +4.019541370561275e-01   -7.365670440220715e-02   +6.096399140900484e-02   -7.799170985415910e-01   +1.082898177957273e-01   -6.834163274109178e-01];
L1_L4_iGABA_netcon = [+6.036950323608088e-02   +4.233879467499673e-01   -2.947048842955502e-01   -9.712550084669037e-01   +1.049530487774150e-01   +5.782683337833823e-01   +6.967291732360603e-01   -4.652649759157820e-01   -4.563207873728679e-01; +1.000000000000000e+00   +2.757986307092507e-01   +7.970933060261975e-01   +4.390426708818056e-01   +3.489970215487652e-01   +1.366758811365950e-01   -9.360907864957153e-01   +3.965500839977003e-01   +8.504367397701305e-01; -3.081893077002512e-01   +9.076639951504830e-01   +6.063402620020241e-01   -1.232256883004911e-01   -1.547202384897533e-01   -1.260922548219071e-01   -9.881362980832846e-02   -7.607116985231243e-01   +5.202513995606939e-01; +8.607246969556395e-01   -4.399784160813197e-01   -7.426454455020007e-02   +8.509810372107567e-01   +9.344309336697866e-01   -8.409155681901547e-01   +9.513088321104257e-01   +5.948712247990403e-01   +6.487545265735775e-01; -6.523624290480130e-01   -5.779760157048499e-01   +2.948546961628963e-01   +7.487537423260467e-01   +4.068853755041604e-02   +7.015452269732994e-01   -4.918962689736475e-01   -1.639331807242049e-01   +8.235702599779338e-01; -5.837607610692640e-01   -7.432527652793681e-01   +2.531792028736475e-01   -4.951611279527390e-01   -9.751193652873816e-01   +1.419002483975365e-01   -2.351190689358864e-01   -5.150835514788705e-01   +9.538000726452502e-01; -5.709907779617625e-02   +1.644689834761266e-01   -7.702076150028508e-01   +3.509185896924514e-01   +1.201504806540055e-01   -1.594349346268861e-01   -4.734127387724586e-01   +8.146420409075992e-01   +5.133366551634252e-01; +5.656430538517560e-01   -7.015640838093359e-01   +9.034921018650227e-01   -8.871978227710399e-01   -2.172849935369228e-01   +6.806300847216843e-01   -4.937377147222136e-01   -5.552475935741468e-01   -1.059082212206814e-01; +3.371750305729253e-01   +3.363952522570808e-01   +5.160422493345520e-01   -7.551639627734932e-01   -4.322073875912772e-02   -1.128685220145555e-01   -2.849313574919555e-01   -4.480395807807662e-01   +4.668905650444165e-01; +7.406080498949764e-01   -4.622201218954730e-01   -1.861460600211274e-03   -8.945610122098947e-01   -4.786824268719997e-01   -5.959859678381618e-01   -9.870434303841806e-01   +2.645468512359267e-01   -5.982663512903393e-01; -3.610393481492761e-03   -3.875734069818797e-01   -8.222829888016762e-01   +4.076965636181292e-01   -3.391422820231127e-01   -2.465544003237467e-01   +8.296284458721551e-01   +3.012063880162764e-01   -7.418249743515278e-01; -6.567491629355247e-01   -8.923088025074949e-02   -8.524024346676126e-01   +3.145094596343008e-01   -9.970985787161336e-01   -1.821809268039753e-01   +2.336361608847410e-01   +3.545855251039715e-01   +8.111206851333777e-01];
L4_L1_iGABA_netcon = [-8.753229826569693e-01   -9.884234648749918e-01   -7.769285270715474e-01   -1.699609461246243e-01   +9.613283055761874e-01   -8.643677868186353e-02   -7.016346848633765e-01   +8.348313954988951e-01   -1.705634130233439e-01   +9.644301036107923e-01   +3.588781875957830e-01   -9.437178799843119e-01; -8.958127323687309e-01   -9.395655634694362e-01   +1.096617937249681e-01   +9.620872959188690e-01   -6.012650314132838e-02   +2.881403621462758e-01   +1.000000000000000e+00   -3.696672475237564e-01   +6.072295037964822e-01   +4.281562136678694e-01   -8.677173619209309e-01   +9.020379009405529e-01; +4.738555474670844e-01   -5.503625287755917e-01   -3.098714074310279e-01   +4.338074923686732e-01   -8.678678109089700e-01   +6.775744957455823e-01   +5.885219128924513e-01   +8.152771674601159e-01   -8.228614109061396e-01   +5.177226347607751e-01   -5.341884597579301e-01   -9.540495199005165e-02; -1.914297137292790e-02   +3.320828345269664e-01   -8.936353961368634e-01   -2.154326721465165e-01   -6.822306657715346e-01   +8.355807677021412e-01   -3.300526204660462e-01   -8.818696720949798e-01   -2.145572160974941e-01   +2.491119196207270e-01   +6.490134909845225e-01   +8.628307985221447e-01; -6.007721058398576e-01   +4.877394553664199e-01   +5.868456814293165e-01   +5.391515966401659e-01   +4.753020836626236e-01   -2.415815511288552e-01   +3.701449338878780e-02   +4.634360048418150e-01   -9.115349763117923e-01   -9.107701234295047e-01   +2.604581835689223e-01   -3.783775019502231e-01; +9.749681776367495e-01   -3.057960176371447e-01   +8.786365380004616e-01   +9.472361290955656e-01   +7.858364817347007e-01   -7.551195572804971e-01   -5.288957259590896e-01   -5.976223829399963e-02   +7.498037111534649e-01   +2.072303639755458e-01   +3.755984745246543e-02   +3.343596800249464e-01; -7.678781620372319e-01   +5.839675214203411e-01   +7.385232364783184e-01   -5.290208071761233e-01   +9.250795127771020e-01   -3.857619141925789e-01   -5.076984411974395e-01   +7.532566869536546e-01   +1.046027318589767e-01   -6.380382534293150e-01   -9.883053126432668e-01   +7.112442989609611e-01; +4.726441655175405e-01   -7.972765796722581e-01   +3.870268108591266e-01   -1.261521031638517e-01   +6.502563281655794e-01   +4.305845158487911e-01   -5.654392825032636e-01   +3.030574564030298e-01   +4.649128151417006e-01   -7.168226082987721e-02   -3.567633460669770e-01   +5.701576762255942e-02; -9.107484376904519e-01   +8.280896290622234e-01   -1.426557996600208e-01   +5.542288234257344e-01   -5.315854809195448e-01   -6.571707767156656e-01   +2.711552035974991e-01   +7.837072675177510e-01   -1.135931152436512e-02   -7.882895462410395e-01   -2.757674237323772e-01   +4.578385309256695e-01];
L1_L3_iAMPA_netcon = [+7.104823285549474e-01   -1.151509762628350e-01   +2.749778700302165e-01   -7.476936283542436e-02   -6.927577374623504e-01   +9.510627425881185e-01   -5.892727957405317e-01   -5.257114110531239e-01   -9.970594248588207e-01; -9.912499833361055e-01   -3.224425005041574e-02   +4.857919125009045e-01   +3.997094757483511e-01   +1.354719019535795e-01   -8.217237550039858e-01   +3.674047362090123e-01   -1.095243702146933e-01   +4.569340534278455e-01; +5.894064305314157e-01   -9.138239746826813e-01   +2.837244992017846e-01   -7.843405775526815e-01   +9.275069717636808e-01   +1.000000000000000e+00   +2.688899878608713e-01   -8.508076902621986e-01   +3.259288111669034e-01; +9.508523710519121e-01   +1.523066886335186e-01   +5.263365879712596e-01   -9.277422604337459e-01   -3.201608959623097e-01   +3.921890303240129e-01   +7.723936221632413e-01   +2.050299712986743e-01   -6.979504112579663e-02; -4.785069409131426e-01   -3.326385565930554e-01   +8.002447451583929e-01   -6.818709555155024e-01   +4.447070084071313e-01   +4.116850446330598e-01   +7.798626829225767e-01   +5.882805193576216e-01   +9.710562517480769e-01; +9.633189173128638e-01   -6.671159440782761e-01   +3.758113398911934e-01   -7.776272982543211e-01   -4.901125252087453e-01   +8.684521940292725e-01   -6.101080465735604e-01   +8.038605200442317e-01   +3.749700778031502e-02];
L3_L1_iGABA_netcon = [+1.765826479232801e-01   +2.187100539019556e-01   +2.569620240743959e-01   -3.619034666508837e-01   +6.838554140690276e-01   +9.147415428767638e-01; -3.147682163053424e-01   -4.039866951729321e-01   -4.161863622735492e-01   +2.763722317846895e-01   -5.672596943110744e-01   +3.967308111317927e-01; +4.364564276647078e-01   +8.702733176625088e-01   -5.822859387149033e-01   +1.255989563651266e-01   +5.999365283220232e-03   -5.006698508987236e-01; +2.504677297649121e-01   +6.606821865757566e-01   -9.312110123888715e-01   -6.304588444601710e-01   -1.737629959304183e-01   -1.694973965314845e-01; -7.882574952575210e-01   +6.223153714079980e-01   -5.286317221828480e-01   +3.200304779555341e-02   +2.969159784836115e-01   +4.425773150569946e-01; +1.576866754741177e-02   +8.091048331299955e-01   -4.524687429948682e-01   -5.677679238803630e-01   -7.975622175324099e-01   +4.932958756423237e-01; +6.657384092587105e-01   +2.969829759424039e-01   -6.395270527720371e-01   +9.596874801756430e-01   -9.179797483761493e-01   -1.000000000000000e+00; -9.814790291234841e-01   -9.797974504973975e-01   +6.458917389158128e-01   -6.148175822243480e-01   +5.476817930416438e-02   +1.720213846291592e-01; -6.449178029393401e-01   -7.831874875411876e-01   -1.745442939610333e-01   +9.483719879475107e-01   +2.708321019255119e-01   +9.539515541083814e-01];
L5_Input1_iAMPA_netcon = [+5.129778897936381e-01   -1.000000000000000e+00   +3.634902627496859e-01   -3.337369370386922e-01   +1.695189280413819e-01   -6.633718271409932e-01];
L6_Input2_iAMPA_netcon = [+3.199085455634213e-01   -7.533324463586137e-01   +1.000000000000000e+00   -6.273473835240208e-01   -6.510311054434176e-01   +2.324264936038773e-01];
L5_L6_iAMPA_netcon = [-1.268380098452700e-01   +5.916965697029232e-02   +5.295836603518007e-01   +2.545271899534578e-01   +4.341484033464007e-01   +3.032732626551221e-01; +8.625481562526817e-02   -4.585371118527755e-02   -8.937557798886037e-01   +6.599975387763621e-01   -1.000000000000000e+00   +5.140856281984723e-01; +8.812925568279353e-01   -2.574067708996533e-02   -5.573256634167967e-01   -5.242884374559460e-01   -6.505083513541047e-01   -3.164065293081902e-01; -5.965628036881961e-01   -7.780441465209872e-01   -9.187106984061900e-01   +7.255482229981219e-01   -2.546242657858911e-02   -6.197113945688963e-01; -6.220229435748551e-01   -1.541025085184961e-01   -8.288429525371792e-01   +8.161489889315574e-02   -5.381563507112753e-01   +3.278771011218267e-01; -7.837274842156911e-01   -7.466800164063648e-01   -3.373742835659001e-01   +8.582347814332973e-01   +2.017950184258816e-01   -9.876080666236614e-01];
L4_L5_iAMPA_netcon = [+9.910566171077326e-01   -6.512809811698439e-01   +2.438365962133349e-01   -8.232156476290083e-01   -7.037619284320725e-01   +4.212957356860700e-01   -9.760062167172209e-02   -5.777182881603490e-03   -3.331309256147727e-01   -3.052645589316048e-02   -8.667469080670910e-01   -4.359154183240097e-01; -7.959111903350981e-01   -2.415242209556017e-01   -9.673935976542989e-01   +5.336658686085342e-01   -2.733771123509182e-01   -3.823249562161061e-01   +7.025134222988572e-01   +1.479824483827920e-01   -3.304406528939198e-01   +3.776185713781534e-01   -1.000000000000000e+00   -5.501948402472606e-01; -1.612506597099824e-01   +4.645763428025980e-01   -3.818709027526567e-01   -1.659026842711296e-01   +3.863226047283384e-01   -7.044072418508831e-01   +2.695343266951835e-01   +9.254881059539580e-01   +1.846892837616784e-01   +6.739742300573650e-01   -9.233259627797746e-01   -9.417276409653291e-02; -8.860924679801251e-01   +6.160898601580127e-01   +6.156641670028882e-01   +8.339875290988688e-01   +8.520059054978091e-01   -6.295766252068452e-01   +6.331091038354688e-01   +7.542069225144818e-01   -1.875815733242317e-01   +6.177578316350345e-01   +2.433453693117252e-01   +7.360822881784854e-01; -3.983197521814426e-01   +1.726171398771329e-01   +1.404822269524882e-01   -3.092980515420574e-01   -6.652984436962958e-01   +4.319199198339661e-01   +1.005695409559159e-01   +5.830879968856673e-01   +9.155339253031007e-01   +6.969250461212680e-01   -3.567926594035116e-01   +1.726352126154075e-01; -6.825731798791059e-01   -3.623990124970477e-01   +7.822660520004041e-01   +7.942469840266235e-01   -8.750418389168874e-01   -4.152113549075439e-01   +4.698220043479777e-01   +8.155253991556571e-01   -2.042922700963153e-01   -1.185532630719819e-01   -1.876941769155948e-01   -5.827193445994505e-01];
L6_L4_iAMPA_netcon = [+1.029790363916739e-01   +4.599862271794160e-01   +2.608138580164989e-01   +1.618583097438321e-01   -2.458490557604400e-01   -3.828078363175100e-01; -1.964789454363550e-01   +5.959754289999384e-01   -7.771015718744400e-01   -1.000000000000000e+00   +4.508116058664345e-01   -7.706361896142981e-01; +4.520251679504838e-01   -2.989913491009812e-01   +8.083414784389970e-01   -5.367548807887600e-01   -4.568814969036663e-01   -2.321919504851953e-01; -4.631037313142853e-01   +5.726353994805479e-01   +2.625488326893951e-01   +8.755038627807917e-01   -8.964019589378395e-01   -3.775545992681559e-01; +1.811967144937520e-01   +6.760515507957075e-02   +7.160118118327081e-01   +8.059821853150990e-01   +2.223898565954940e-01   -3.829842064707092e-01; +7.913906089235622e-01   +3.261690527192261e-01   -6.139174444332398e-01   -5.188360089765479e-02   +7.066960454832992e-01   -2.785418693272116e-01; -4.211356890664865e-01   -7.974861797769269e-01   -1.386434280969014e-01   -8.666336870717453e-01   +2.215103954763727e-01   -6.572882564145051e-01; -3.382789847483889e-01   +3.111276911246141e-01   +9.186283572819842e-01   -7.182058986661464e-01   +9.134120630083647e-01   -1.461947076286969e-01; +2.700590122373046e-01   +9.544581494328710e-01   +4.821051126083337e-01   +1.024038044412992e-01   +8.389209223420714e-01   +8.751028080750096e-01; +1.893454821716110e-01   -2.528910294895156e-01   +5.197015641625312e-01   -9.711239817125228e-01   -4.036043384442562e-01   -8.376062524094829e-01; -3.971083248587519e-01   +2.492791553246821e-01   +2.222936731392638e-01   +5.312548392046195e-01   +3.773699715091816e-02   -3.176476798308503e-01; +4.672822795649565e-01   -6.700609483294147e-01   +9.219342766823363e-01   -7.482022220273641e-01   +4.592174829328835e-02   +7.735943793297252e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
