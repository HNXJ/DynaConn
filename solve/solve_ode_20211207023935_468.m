function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-1.274638424529581e-02   +2.720772539101909e-02   -3.114356159963207e-02   +1.303732405852711e-02   +1.114642123603439e-02   -9.106631333196678e-02   -9.099921112000968e-03   +3.063451796468513e-02   +2.933453129615118e-02; -1.164655277785127e-02   -3.908165786783722e-02   -9.866431374328154e-03   +3.824991507229740e-02   -1.728496942617043e-02   +2.263829621870928e-02   +1.620864828634463e-02   -4.881902455715739e-02   +7.770774069988388e-02; +2.294455048963987e-02   -5.765881152504398e-02   +6.758329521964842e-03   -1.271106783778183e-02   -2.301568030030739e-02   +2.442855070079811e-02   +4.540911199758493e-03   -5.592919624866072e-02   -1.878701799972365e-02; +2.500085451424126e-03   +1.182241070653469e-02   +1.239359879043224e-02   +5.350566431752261e-02   +9.640712619225619e-02   +1.957343784223419e-02   +3.077652581907147e-03   -1.317218886852973e-02   +3.705729371369153e-02; -2.769367038675693e-02   -3.126804058723989e-02   -3.172161051472109e-02   -2.052618848717994e-02   -2.712796416524916e-02   -8.299221866831958e-04   +3.095552292530918e-03   +3.331030179500195e-03   -1.388890483198717e-02; -4.041397014900444e-03   -1.612887342678782e-04   -7.953033737988888e-02   -3.196741765041741e-02   -1.806075430147004e-02   -4.265457687684062e-02   +4.146685281499941e-02   -5.707230425978431e-02   +1.855384041225280e-02; -1.991994854733450e-02   +4.874661962406068e-02   +5.256351089480150e-02   +1.832637418154335e-02   -5.101982137940102e-03   -2.704355128951345e-02   -2.283982594926361e-02   -3.142242970666664e-02   +1.788358268497902e-02; +1.296765977046552e-02   +1.743752387944275e-02   -1.321098735797967e-02   +4.477304590921351e-02   +7.032667876536043e-02   +1.886670491802820e-02   +4.499282317691305e-02   +4.971105298632369e-04   -1.732377049339994e-02; +2.869755908375968e-02   +2.036878192778127e-02   -2.096795263742441e-02   -3.329778521681666e-02   +3.832652944677155e-03   +1.772009569658976e-02   +5.936932416448273e-02   +2.840922939059637e-02   -1.198646617443813e-02];
L1_L2_iAMPA_netcon = [-2.802290481515661e-02   -2.426109169608358e-03   +2.730748096224891e-02   -2.445150683413371e-02   +3.217004741632552e-02   -9.556959564449422e-02   +1.811892543012342e-02   +2.833587276387725e-02   +6.257749308804402e-03; +5.175671712478686e-02   -1.532962555923720e-02   +1.677360481489458e-02   +1.795535437233386e-02   +4.080112644941272e-02   +8.088406059780773e-03   +2.268540866035288e-03   -3.021060788599406e-02   +5.483714025403963e-02; -5.485111662762471e-03   +3.806232892997653e-02   +1.113835534723685e-02   -9.862271532578046e-03   -4.493874036619966e-02   -7.701952732199213e-02   -9.903607813896967e-03   +3.627107710628202e-02   +9.678898326976024e-03; -2.522301051358708e-02   +6.058992374354264e-03   +1.116465551463625e-02   +2.740836667011972e-02   -7.855611146255990e-03   -2.794209538695733e-03   -7.080647601946308e-04   -7.767961613486060e-02   +7.442373477219236e-02; +4.147383647731451e-02   -1.098075680144489e-02   -6.055907093126045e-02   +4.171048651087550e-02   +1.325011895501597e-03   +5.553307640585275e-02   +2.997846870075362e-02   +7.512217671947286e-03   -2.530386475551374e-02; -9.430435637998530e-03   -6.998707000856336e-03   -2.099078164683070e-02   -2.676321921102818e-02   +2.709105794035339e-02   -1.638402136891062e-02   +6.519952305991197e-02   +8.697288195816295e-02   +2.184766198437738e-02; -1.360135028337175e-03   -7.631218816482116e-03   +4.879876774228351e-02   -4.653771293927358e-02   +9.112985403102972e-03   -3.325526358852958e-02   -1.101856002771682e-02   +5.605111790782150e-02   -2.401095005537150e-02; -3.854751972621021e-02   -1.608677579303032e-02   -1.870844359971075e-02   +1.943961396291887e-02   +3.002191240796771e-02   +1.842314181891759e-02   +3.111081950583110e-03   -1.282126058833583e-02   -2.288374698571380e-02; +6.246339705800010e-02   -1.489398035847356e-02   -2.809584160408250e-02   -2.049077919588113e-02   +5.991977238462422e-03   +1.265602069534086e-03   -3.987613568332344e-02   -2.445876233987539e-02   +5.457911111751863e-02];
L2_L5_iAMPA_netcon = [+1.290463161883587e-02   +2.789710012391950e-02   +2.747298209402228e-02   +8.661685494344936e-04   +2.740612478739347e-02   +1.336534664244387e-02   +2.974543300306519e-02   -1.564777758936087e-02   +3.063597640727403e-02; -3.027333169797180e-02   -1.479044057108569e-02   -3.947466067287804e-02   +8.661385014555653e-02   -1.506925256795058e-02   +3.205156698551609e-02   +2.316063374663191e-02   +3.341108669695215e-03   +2.019892516109183e-02; -2.378104867228181e-02   +4.331105969031785e-02   +5.697099770605149e-02   -9.304144324471264e-03   -2.521178678468557e-02   +8.444857894081141e-02   -3.261038906202350e-02   +2.376301134431254e-02   +5.239833925497491e-02; +2.151906081832846e-02   -1.217522009496095e-02   +4.448913090916465e-02   +1.234522533499922e-01   +2.910568743352823e-02   +4.481573264158389e-02   +4.581349273453886e-02   +1.243614934626364e-03   +2.452543452963783e-02; -3.074070442125101e-02   +3.793959175768537e-02   +2.402985588953756e-02   +6.153490103636734e-03   +2.579970608428128e-04   +3.340481689747531e-02   -4.843112135505756e-03   -9.956897297239278e-03   +4.011883689978093e-03; -2.858456659838269e-02   +7.632376380983654e-03   -1.095926808414299e-02   -5.040077665226930e-03   +3.768422613305311e-03   +2.725280965997192e-02   +1.875406349441476e-02   -5.178461058294441e-03   +2.752425597395760e-02];
L5_L2_iGABA_netcon = [+2.066587668255757e-02   -1.824442257241962e-02   +3.386078664604181e-03   -3.778878851837360e-02   -3.633451642192292e-02   -3.456867061334818e-02; +1.555205820311682e-02   -2.143766926178265e-02   -8.268300736358862e-04   -4.673779234397381e-03   +4.878192209260682e-02   -5.842884764594382e-02; +3.579359339347384e-03   +4.768197209451090e-02   +2.013660769354469e-02   +1.004162169028161e-02   -1.672837182815493e-02   +4.375690433980167e-02; -3.125975016029434e-02   -3.696104055476113e-02   +2.927968016547140e-02   -2.375484722159144e-02   +3.969398963405397e-02   -1.624901933493914e-02; +2.146293518421310e-02   +3.357484890547615e-02   +3.232671835583834e-02   +5.039265744694929e-02   +2.246492749455701e-02   +2.707093542402732e-02; -5.319693513959906e-02   +6.618202161506470e-02   +3.727801475259405e-02   +9.210846310318321e-03   +2.917227084399762e-02   +6.052202110465900e-03; -9.068347805944993e-02   -5.679920471200910e-02   -5.542556405389874e-02   +1.020079314626863e-02   -4.264363442635642e-02   +1.589831293513137e-02; +4.715511086801599e-02   +1.227802652627811e-02   +1.541182820131499e-02   +2.258945524677448e-02   -1.932903369414320e-02   -3.851989924131248e-02; +4.379659797251820e-02   +7.652076039494485e-02   +1.135247397319121e-02   -2.373597618498232e-02   -6.995613059259784e-02   +3.655367361049293e-02];
L3_L2_iAMPA_netcon = [+3.014349184578885e-02   -7.007003861990603e-02   -3.737006328725014e-02   -3.187458569213108e-02   +2.627987972709708e-02   -1.728071881293851e-02; +3.641309621008143e-02   +6.617004462820303e-02   +1.993838273975542e-02   +1.386729156056105e-02   -1.751113013436836e-02   +2.490285796416607e-02; -2.254768367384675e-02   -1.066143321196701e-02   +2.858209545041668e-02   +5.543508651583702e-02   -1.272607059997609e-02   +1.244187993299975e-02; +9.812037616952495e-03   +1.037674156863764e-02   +2.018552880058066e-02   +2.985217757273082e-02   -6.160350037952064e-02   -6.718736340171208e-03; -6.363907244392641e-02   +1.333332713704855e-02   +1.727402433178772e-02   +3.686760546195822e-03   +2.448298833180576e-02   -2.680085373246120e-02; +4.794618819010796e-02   +3.087294365810266e-02   -2.786999983088723e-02   +5.418121807008233e-03   +6.062474292869140e-04   -2.687212197861502e-02; -4.161218903922392e-02   +3.206670391781179e-02   +3.361987574811244e-03   +2.958756245980111e-03   +3.736082852349493e-02   -7.053391240776398e-04; +4.039350433554104e-02   +2.009723730101149e-02   +1.114369686212336e-02   +2.282357970897556e-03   -1.585657286649982e-02   +3.496719046429500e-02; +4.617074223409184e-02   +1.132614318738082e-02   -1.078677066125739e-02   +3.622651584039725e-02   -5.209366343816495e-02   +3.296682610994333e-02];
L2_L3_iGABA_netcon = [+3.537770993584259e-02   -6.576843840683974e-02   +3.112568469298596e-02   +4.242672763734680e-02   -3.864420477915672e-02   +1.966048331778075e-02   +1.094581772186505e-02   +4.515413612929571e-02   +1.628660140190645e-02; -5.217980613562212e-03   -1.541545552111038e-02   +5.124883622381738e-02   -4.293575671735832e-02   +3.916315587499437e-02   -1.705971677205704e-02   -3.913102214572754e-02   -1.659225333384779e-02   +1.777227995419413e-02; +2.802880082466207e-02   -1.776707737896343e-02   +2.292094817041784e-02   -3.063305655508253e-02   +6.277500339659380e-02   +6.286224779558533e-02   -1.332114815293428e-02   +1.557297115614080e-03   +3.149423598062910e-02; -5.892248921656448e-03   -6.810340431069037e-02   +2.454600777462974e-02   +5.938218324823700e-03   +4.607949711678647e-02   -5.741753238699498e-02   -5.645007137009370e-03   +2.723250861341558e-02   -5.604054378782666e-02; +1.579733632427778e-02   -3.714756691728594e-03   +1.848660758639197e-02   -7.087698310905340e-03   +4.326092082526948e-02   +3.490512378202378e-02   +9.061402121363605e-03   +4.359456675527314e-02   +4.508565404013875e-02; +4.762677406621146e-03   +3.832532661472416e-03   +3.271263064272672e-02   +1.889322085875719e-02   -1.880686750307652e-02   +2.696840708670290e-02   -3.331703344719966e-03   +2.935204754778662e-02   -3.930355665657263e-02];
L1_L4_iGABA_netcon = [+4.836673344388497e-02   +2.898047581231684e-02   +2.305249759801516e-02   +2.634225995826536e-02   -7.669824250606378e-03   -3.922210287389816e-02   -6.025444527174391e-04   -7.471705544928171e-02   -2.111376082281245e-02; +6.811463168577339e-02   +3.528348982798842e-02   +6.609887506609310e-02   -2.793143267154628e-02   +5.685143094591721e-02   -6.018638104980510e-03   +8.953522210035034e-02   -1.090878056705770e-02   -2.141806767458656e-02; -8.049964501888041e-03   -1.050571088275671e-02   +7.419203121597381e-03   -2.493043138354174e-02   +4.364807753095473e-02   -3.738723617331390e-02   +9.145988426446945e-02   +3.632070191332390e-02   -1.324369851921369e-02; +1.759978171000242e-02   +1.135703484471341e-02   -5.583622707376508e-04   +6.979141206198001e-03   +7.843950491192606e-03   +2.672453508340951e-02   -4.443025797288820e-02   +2.395710785437740e-02   -2.880379399804648e-02; +4.716144036967522e-02   +4.606823058703505e-02   +2.216048769005983e-02   -1.721143108959159e-02   +7.963221768154448e-02   +2.362317534650160e-02   +3.754781565435854e-02   -3.131154855052647e-02   +2.048875870191758e-02; +8.921909184797922e-03   +3.462962310466534e-02   +1.933397147555426e-02   +7.851337885827790e-02   -1.465778690461388e-02   -5.607673073682645e-02   -7.197276564784662e-02   -3.296158252824516e-02   +2.866306349634549e-02; -6.479364954295073e-02   +4.991965110552010e-03   +7.498676200074196e-03   +1.013768092866515e-03   -2.303950524726739e-02   +3.735191829763262e-02   +1.444570292650743e-02   -2.561633764444639e-02   -3.909060225412823e-02; -2.169661148786932e-02   +3.694903062980525e-02   +6.767345421965976e-02   -4.865373519340925e-02   +3.415450721359237e-02   +4.845814555286027e-02   +4.606389972670015e-02   +1.416728801312739e-02   -2.207515735987026e-02; +2.071267975970606e-02   +1.851035466544053e-02   +5.341713789976237e-02   +3.387672066542119e-02   -2.404737166757913e-02   +6.018107113151124e-02   -3.441688194698922e-03   +9.979935200117614e-03   +1.491263358696051e-02; -4.539363464362120e-02   +4.443985408012353e-02   +3.176802656520952e-02   -5.656515221939298e-03   -4.212537824017987e-02   +2.973304807925032e-02   +2.291998056416952e-02   +2.624761840827192e-02   +5.503545426759174e-02; -1.558312999579799e-03   +3.582809970333061e-02   +1.658198375035469e-02   -4.253789533312971e-02   -2.261882242647816e-02   +5.472527828621851e-02   +7.362442493542043e-03   +3.404842379087962e-02   +2.757691702167778e-03; -6.216751990745156e-02   +1.081487303886100e-02   -8.066411440795663e-04   +1.661725660916172e-04   +6.358019783398823e-02   +5.113221477702309e-02   +5.327126866818013e-02   -1.145662638520845e-02   +9.731543082441380e-02];
L4_L1_iGABA_netcon = [+1.783659125525967e-02   -7.349055519488820e-02   -1.118358489472055e-03   -3.958320081911467e-02   -3.365820226085687e-03   +3.494829222987753e-02   -8.947680389362223e-03   -1.151940294277990e-02   -6.677230622512847e-02   -2.617311520155219e-02   +1.899866137197623e-02   -2.078379218488135e-02; +4.528649048181758e-02   +1.431709879526837e-02   +1.617259076132578e-02   -3.484216880725367e-02   -3.260514255242249e-02   -3.329417026411651e-02   +2.997445156797893e-02   +8.485802299893772e-03   -1.123389414671338e-02   +5.288418097936946e-03   +2.625882208315114e-02   -3.170197401823975e-03; -5.470835044248525e-02   -3.849414924224946e-02   +5.394274554691969e-02   +3.503695772404718e-02   +3.626054363990862e-03   +3.258843895414185e-02   -2.072571096293635e-02   -3.175001768714480e-03   -1.145419303185563e-02   -3.191334070790752e-03   +2.508170280593201e-02   +2.034729888850051e-02; -2.273441648906885e-02   +5.158905016423050e-03   -3.981903240152548e-02   -1.082068914809425e-02   +8.462699398417246e-03   +6.991267084093400e-02   +5.310866096312129e-03   -1.336718885000422e-02   -5.519292730730155e-02   -1.169345591995941e-02   -4.789079575178809e-03   +3.312098838935301e-02; +1.642633175256342e-02   +2.819994045627641e-02   -2.668553272532261e-02   +3.807538107166542e-02   -4.076782720940339e-02   -3.993696160327598e-02   +2.401894357868094e-03   -7.415412339685942e-03   +2.394660530439078e-02   -4.645865745637291e-02   +9.316163101279876e-03   +4.700206896290850e-02; +7.571651068340179e-03   +6.627236682544446e-02   +2.607572619830911e-02   +6.467449248657352e-02   -2.387583805845719e-02   +3.866487296540973e-02   -2.463847682918109e-04   +7.289122842454748e-02   +7.177375926691573e-02   +2.335257824228228e-02   -5.404035921305426e-02   +4.411981600159352e-02; -3.157710677338401e-03   -7.069512382959434e-02   -6.658269327480784e-02   +5.113368672757961e-03   +3.637335313280347e-02   -1.809888751435700e-02   +4.588014551049342e-02   +2.842087793627190e-02   +6.234231879933311e-02   -6.487136794669092e-03   -2.982379107969377e-02   +5.582971465502205e-02; -1.039533599532571e-02   -8.328679567385365e-02   +1.885045452447277e-02   -4.731783560809497e-02   -2.614325464191260e-02   +4.735528404461679e-02   +1.817345618184310e-02   -3.335027308763572e-02   -2.147684545047879e-02   +2.912547839369839e-02   +4.279722052684462e-02   -1.886534214961366e-02; +4.151619881300188e-02   +2.954949933193777e-02   +4.039419784740921e-02   -5.906525102623622e-02   -3.235625189446663e-02   +1.421827656986350e-02   +5.554292347971957e-02   -4.597456318433737e-03   -5.876071393090013e-02   +1.550516311033198e-02   +2.750756318072979e-02   +2.674804542081634e-02];
L1_L3_iAMPA_netcon = [+8.157223165642068e-02   -7.028879221625834e-03   -3.528618682084876e-02   -5.001444335520032e-02   +5.849989469705934e-03   +6.664981332031401e-02   +2.534725140851042e-02   +4.610272651956160e-02   -5.134572845263253e-02; -9.687605371115793e-03   +1.139466683933454e-02   +6.531017274146922e-03   +5.032543952938659e-03   +2.691021906924870e-02   -3.890833229198114e-02   -1.466249747841184e-02   +5.754324580216559e-02   -2.793875444160251e-02; +2.930696806417303e-02   +2.023482453966481e-02   +3.394334665211748e-02   +3.900995485955833e-02   -2.621724212705142e-03   +4.483475181649377e-02   -4.843521541662177e-02   -4.320121690212834e-03   +4.658106620350496e-02; +1.649785410577516e-02   -3.696016193020150e-02   -3.198354095923887e-04   -4.841006693206383e-03   -4.147780399467263e-02   +7.665394082029141e-02   -5.080074895029246e-02   -3.862670611997929e-02   +2.536694105166883e-02; +1.584259103864287e-02   -6.411935356001597e-05   +1.579332623543374e-02   +7.132939870873545e-02   +4.447152236299526e-02   -1.392051688367320e-02   -2.867375744192988e-03   -3.540090890407369e-02   +3.545558371458923e-02; +5.285033208857998e-02   +4.273247869821147e-02   +5.179412550128341e-03   -3.179593250163035e-02   +2.064008308357473e-02   -3.020916021715661e-02   +3.663683757030982e-02   -1.659646928085530e-02   +2.619864292271135e-02];
L3_L1_iGABA_netcon = [-1.210372805739347e-02   +1.377743612412149e-02   +3.592386624229381e-02   +5.327397148359060e-02   +7.869434703590829e-03   -7.809394077895626e-03; +5.907562181669514e-02   +3.445165550452500e-02   -3.311244433444382e-02   +6.232613716325460e-02   +7.704951503915983e-02   -1.788443148239661e-02; +1.330502617991442e-03   -2.274448492327458e-02   +3.316982200461947e-02   -1.569829304595423e-02   +9.283577415564667e-04   +2.589497508240774e-02; -6.162542897368398e-03   +2.353067128923142e-02   -8.163829142334283e-02   -2.264561542558869e-02   -1.067146662189105e-02   -6.301441058698492e-03; -2.219927462529858e-02   +4.656659651051748e-03   +7.156768625144454e-02   -6.104233251727956e-02   +2.263340345130017e-02   -5.940308390418840e-02; -4.897004016690545e-03   -2.286596176404752e-02   +7.519942341699247e-02   +3.034973464349697e-02   +1.296521690732680e-02   +5.932723822472501e-02; +3.315780803885358e-02   +3.704062442028899e-02   +1.263020523271744e-02   +2.945486212930126e-02   -1.248318204472119e-02   -5.956764090494551e-02; +3.789239331675875e-02   +1.567463216676456e-02   -2.576050570275650e-02   -2.101094981906969e-02   +5.506973185359340e-02   -7.015727932835426e-02; -4.798526839958514e-02   -1.502275767731320e-02   -4.865163991277646e-03   +1.990796165960759e-02   +7.946573203497193e-03   +2.847862125440122e-02];
L5_Input1_iAMPA_netcon = [+2.949093506902145e-03   -1.364975674666670e-02   +2.575643917650614e-02   +3.764464795653014e-02   +9.083826712905710e-03   -5.346976575999870e-02];
L6_Input2_iAMPA_netcon = [-8.331580153799228e-03   -1.479404904798839e-02   -1.844853938180734e-02   -8.688137292643833e-02   +1.055844183352490e-02   -2.152348389659570e-02];
L5_L6_iAMPA_netcon = [-1.282690946465496e-03   -2.217313443130733e-02   -6.124168276279485e-03   +4.953592885712724e-02   +2.941704975818318e-02   -2.786319494079272e-02; -2.254059290463704e-02   -8.991365851244324e-03   -5.994624334704091e-03   +8.674826737722016e-02   +1.824766738135258e-02   +7.564690814959266e-02; +2.531926425809038e-02   +4.560618649931270e-02   +1.515181861415154e-02   -4.721598814172827e-02   +4.727099115793157e-02   +6.042150189862541e-02; +1.803083712749929e-02   +1.061650412280035e-02   +7.958209986377086e-02   -4.159978599728206e-02   -5.179012564317580e-02   -1.728165456283358e-02; +2.879583969293675e-02   +1.508363835191346e-02   +7.149556740872957e-02   +1.451208749510303e-02   -3.167041450386854e-02   +3.084489465172678e-02; +1.952751429640338e-02   -2.204006512892768e-02   +4.691413540848600e-02   +3.958735019267771e-03   -7.379688257297068e-02   +4.420374354053522e-02];
L4_L5_iAMPA_netcon = [-3.298089497122276e-02   -2.236259548327359e-02   -2.483504640385314e-02   +2.818342798267621e-02   -2.063182537443511e-02   -3.500147735416612e-02   +3.771852145406716e-02   +3.082171317995721e-02   +3.924476954908909e-02   +2.511554491055768e-02   +1.625491911077933e-02   -4.204314697396397e-02; +4.534768680134403e-02   -1.544711753430656e-02   +3.032873845610655e-02   +3.329339132446259e-03   +1.863280327628142e-02   -3.163665422494190e-02   -3.311034580181166e-02   -2.785269021911436e-02   -2.834324441232677e-02   +1.173486814580363e-02   -1.258214159550186e-04   +8.163224063034412e-02; +1.371610678543134e-03   +1.970629869794794e-02   +9.176663057159323e-02   -3.474248160122220e-04   +2.371660304217917e-02   +7.945380439898506e-02   -1.348075165531110e-02   +5.506526494134256e-02   -1.138581211861252e-02   +6.752236460248304e-02   +9.763237101126573e-04   -8.281954251015912e-03; -4.616998234821287e-02   -3.802062833150712e-02   -1.253953692286671e-02   +2.921321038845081e-02   -1.576879752650496e-02   +1.237047232651674e-02   -5.490108147088535e-03   -8.580289962420089e-03   +1.869408676343829e-02   +5.192670398018299e-02   +8.554142795848433e-03   +1.487762068965763e-02; +1.296619290259365e-02   +4.126527986897415e-02   +1.062043140267650e-02   -3.786099341693462e-02   +9.512661995028947e-03   +1.661165653682609e-02   -4.090486820216648e-02   +5.746350550560452e-03   +3.354985973801984e-02   -5.118572387933108e-02   +2.418387997154965e-02   +3.401601833711081e-02; -4.490056025585058e-02   -9.216095289711805e-03   -4.665854110128913e-02   -2.683445927763591e-02   -5.049385859862621e-02   +9.432023753072188e-02   -2.580233009580975e-02   -8.400252576314453e-03   +1.795590722214024e-02   +7.030783070631788e-02   +9.264231072826888e-03   -3.076386666121434e-02];
L6_L4_iAMPA_netcon = [+2.102044311174557e-02   -3.706845149086551e-02   +5.672281430855644e-03   -3.653009506450253e-02   -2.144754207311551e-02   +6.088357766239100e-02; +1.248036192116384e-02   +6.723339934660524e-02   +2.309447822301519e-02   -2.701844955045198e-02   +3.025248454661357e-02   +2.547668360225811e-02; -3.542636158963301e-02   -9.476692112754648e-03   -5.780100078791989e-02   -7.803083323923128e-03   -1.048638391902423e-02   -1.735035946252722e-02; +3.666194566660740e-03   -3.783859854125866e-02   +1.605113345336261e-02   +2.133618501386158e-02   +3.144613236587271e-02   -1.076891706092501e-02; -3.700222808669688e-03   +4.818900437077898e-02   -4.265981830821926e-02   -1.867444270625181e-02   -5.177331169753056e-03   +6.637490767479226e-02; +3.411968367842277e-03   +4.646385758664383e-02   -1.308732983409988e-02   +9.197040769587293e-03   +5.377776626738812e-02   -4.174370385989391e-02; +4.840612170531704e-02   +6.321812667189390e-02   +4.783630863855821e-03   +6.951645362185729e-02   +4.741478926364696e-02   +3.871126200592858e-02; +2.711932287704200e-02   +3.837501310397601e-02   +2.944927614455799e-02   -8.899393637493022e-03   +4.324538868058943e-02   +2.881739918352344e-02; -2.392929953727094e-02   +6.485852448094256e-03   -8.087749721804427e-02   -9.302184644338553e-03   -2.087580655094825e-02   +3.119567794794723e-02; +1.902527136450198e-03   -1.987234621052874e-02   +1.730124283435434e-03   -2.130941027307206e-02   +3.980372595553013e-02   -3.136284736868223e-02; +3.977551145437999e-02   -1.581651780349443e-02   +6.918878649813745e-02   +1.073130008106505e-01   -4.906788262783236e-02   -1.450531468397703e-02; +3.793530454279285e-02   +6.416141270243318e-02   +1.992346562405118e-03   +1.899213930722603e-02   -5.385922716320282e-02   -1.874001445172534e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
