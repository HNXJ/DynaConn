function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-4.463931703751137e-02   +6.655318577260359e-02   -6.352119393805267e-02   +9.300901889580965e-03   +1.265859968160669e-02   -5.589778270397192e-02   +1.445020366877565e-02   +4.163567106323444e-02   +3.239779913156763e-02; +3.840614478272680e-02   -7.452367131293448e-03   -1.749149256759562e-02   +2.859060340059878e-03   +2.548203702154165e-02   +3.183713739946047e-02   -1.832887166674309e-02   -3.493713403089663e-02   +3.463427551547721e-02; +2.474477667598625e-02   -3.241099697386991e-02   -3.969107976165052e-02   -3.565592864519084e-02   -6.799962040923026e-02   -6.594422679621299e-03   -2.942664386646639e-02   -3.198172528279264e-02   +3.174338125420437e-02; -3.216328023989599e-02   +1.606408190468248e-02   +8.411694094418914e-03   +4.368754243632098e-02   +5.944777701605733e-02   +2.292584403870501e-02   -3.914191626828717e-02   +1.801196237089674e-02   +6.644081176103511e-03; -2.480736247224212e-02   +2.307195911363338e-02   -2.182204293851325e-02   -2.151266597037837e-02   +1.351609968193799e-02   -3.922945750257846e-02   +6.588314739619157e-02   -4.346893603595504e-02   -3.297863346345482e-02; +1.317993251866049e-02   +6.789386249456257e-02   -2.257170386961764e-02   -7.408078284434797e-03   +1.936603579699189e-02   -3.734447855618465e-02   +3.848652447367231e-02   -3.612688495204201e-02   +3.049705530450421e-03; -1.828469988314193e-02   +1.506830347246617e-02   +6.091308466587104e-02   +4.039070853771039e-02   +3.218754562897206e-02   -2.760635214499559e-02   -3.984861421551331e-02   +2.207209031865596e-02   +1.338716076558886e-02; +5.531746526811459e-02   +2.342357351131465e-02   -5.884810562265231e-02   +7.907138821744222e-04   +5.311518081139624e-02   -2.918983561062632e-03   +8.196034143909570e-02   -6.269986137692918e-03   -4.426544850271751e-02; +4.832255674615298e-02   +5.447607716905297e-03   +3.580592648324794e-02   -1.178695092898151e-03   +2.478394556814067e-02   +4.313964509267396e-02   +2.353555030791111e-02   -7.715574915558160e-03   +5.400582829326250e-02];
L1_L2_iAMPA_netcon = [+4.588226115785678e-02   -5.162681421366996e-03   -1.750038876553076e-02   +8.203327529942503e-04   +5.958239108246424e-02   -4.942065903551965e-02   -1.903383906940446e-03   +6.395044796573737e-02   +5.624186331747332e-02; +7.610268837502922e-02   +2.922638332209268e-02   +2.784289784216741e-02   +1.443489002213099e-02   +4.993438557470645e-02   +3.168824818155060e-02   +7.145174908162634e-03   +3.499848478973619e-02   +3.560516505854125e-02; -2.416269978900092e-03   +1.987523068038939e-02   +9.055222271187868e-02   -5.939612112188327e-03   -5.892801322173413e-02   -4.377429963261447e-02   -4.816886636273287e-02   +6.821717883850668e-02   -1.724262612571758e-02; -1.398714323481528e-02   -2.399786868517699e-02   +3.386218386901937e-02   +3.883588490556335e-03   +1.240429937602488e-02   +2.985858164330585e-02   +4.037106829272930e-02   -1.814874100543971e-02   +5.708042400301536e-02; +1.436334092398595e-02   +4.531815237239822e-02   -4.964832752887630e-02   +2.983687892335516e-02   -4.574193526268843e-03   +7.541618531390684e-02   +7.250657426966036e-03   +1.167953116565237e-02   -4.576461340710343e-02; +1.771324311149215e-03   -4.786716683842059e-03   -9.017560189204438e-03   -1.789808048567672e-02   +5.212861128583923e-02   +2.095079879294219e-02   +1.430811693237646e-02   +4.812278006337575e-02   +1.735348535464699e-02; -1.159901411272463e-02   +1.037453914982523e-02   +1.915959424820988e-02   +1.267763698738804e-02   +5.152936838269304e-02   +1.334662566276640e-02   -6.267214762279368e-03   +5.053372378830452e-02   -1.664534376067902e-02; -2.801135749929521e-02   +1.319019423311578e-02   +2.159718330239437e-02   -5.525573441026971e-02   -2.390100470738201e-02   +1.449066183421780e-02   -3.582860918458360e-02   +9.142410826617500e-03   +1.698379161511831e-02; +8.314649913514219e-02   -4.102446752168697e-02   +5.825362606282341e-03   -5.400050156583214e-02   +9.379861415010260e-03   -2.153518228760602e-02   +1.382715460540564e-02   -1.271356151101614e-02   +4.482896257826657e-02];
L2_L5_iAMPA_netcon = [+3.932110508082655e-02   +1.414974195485328e-02   +2.168702049982860e-02   +4.449559405930554e-02   +1.388329108726666e-02   +4.048364734876385e-02   -1.015685181167627e-02   +6.625873497442260e-02   +1.969273082267664e-02; -2.962610859874463e-02   +1.527257261990267e-02   +3.389076595252168e-04   +5.170969514274430e-02   -1.928402699655814e-02   +2.272183118939994e-02   +1.463317594009583e-02   -6.589828920500222e-03   +5.186227429312902e-03; -1.218776984661460e-02   +2.282581456644471e-03   +2.257203169725035e-02   +1.847249328437701e-02   -1.347431339059021e-02   +8.104250508405619e-02   +2.237704839549547e-02   -2.952999774019366e-03   +3.119281737382146e-02; +6.607753132190032e-03   +9.057985656280319e-03   +5.832441332716232e-02   +9.981878848650157e-02   +9.000230714796831e-03   -1.102065400990329e-02   +1.986314748716987e-02   +3.989734943707055e-02   +6.435309107298828e-02; -5.331491553934205e-02   +3.057802794846949e-02   +3.696781570382875e-02   +3.161700463204485e-03   -1.218398326891094e-02   +2.069922203329536e-02   +1.688443958750640e-02   -1.986757439892128e-03   +3.499002116477817e-02; +1.444619426319651e-02   +1.538223542345958e-02   +2.161321411802698e-02   -2.233313835804410e-02   +1.965662869826778e-02   -1.487084869092756e-02   +1.595583403637903e-02   +1.088201509973877e-02   -5.315903303692234e-03];
L5_L2_iGABA_netcon = [+6.090927994857509e-02   +2.998946583467202e-02   +1.304055866112408e-02   +2.071548181335101e-02   -3.128087545400812e-02   +1.814094539741622e-02; +3.915869389747945e-02   +1.163072603077380e-02   +1.820109308356073e-02   -2.245602565489668e-02   +9.438601472795086e-02   -4.289609820338021e-02; +2.130919499832974e-02   +3.230154803251671e-02   +6.591416671419727e-02   -1.157746959818524e-02   -1.513088607997969e-02   +5.341078911592016e-02; -5.381166555873804e-04   -8.679368998187748e-03   +4.289154407920350e-02   -3.520218624878169e-03   +2.714940645575283e-02   -2.951427718590912e-02; +3.630256691557804e-02   +6.000847728677185e-02   +1.663163462794096e-02   +1.608251799237199e-02   -4.694222889401392e-02   +1.289205616814773e-02; -3.635382737394173e-02   +4.984655721692453e-02   +1.758837533488334e-02   +2.298547657724379e-02   +3.393895510622094e-02   +2.708871031753210e-03; -5.151500733531428e-02   -1.961558149583036e-03   -4.133540248346263e-02   -1.259354548541910e-02   +2.659749234695127e-02   +1.980448209463579e-02; -8.806063831445072e-03   +2.563655746615859e-02   +1.144386870143321e-02   +5.753654160055169e-03   +5.833911066941738e-03   -4.431380281492694e-02; +4.691404168601794e-02   +3.004822172244297e-02   -5.542213177439570e-02   -3.726040144086865e-02   -6.979901022099698e-02   -1.033384989564452e-02];
L3_L2_iAMPA_netcon = [-1.703747508186358e-02   -4.442325567880449e-02   -1.027462864859421e-02   -1.051093348823311e-02   +6.813178521242358e-02   -5.202919555716862e-02; +7.650804609006037e-02   +1.289399370555732e-02   +3.989494522189958e-02   -1.469992044631178e-02   -2.095651077263162e-03   +1.647019819325305e-02; -5.956650013737436e-03   -2.298196318947075e-02   +5.702606436379690e-02   +5.735030484146743e-02   -1.376186061902466e-02   +1.400666275824432e-02; +5.553849105486878e-03   +7.891200814737613e-03   -3.112832689017407e-02   -1.137945927703475e-02   -5.473050685464930e-03   -2.301376811524845e-02; -2.027500326782465e-02   -1.007338241377017e-02   -2.388285153159068e-02   -3.181747184217370e-03   +4.890865053291138e-02   -2.960235802536756e-02; +5.528594831530907e-02   +4.327811835832803e-02   -5.848197881982157e-03   -1.925448568672111e-02   -2.987356095283241e-02   -1.613049184477625e-02; -1.573820927892253e-02   +4.095317703031450e-03   -1.862584041847394e-02   +3.333080420246626e-03   -4.685426670962448e-02   +2.046616000516456e-02; -4.475865340077238e-02   +3.108410977757011e-02   +1.152806097547758e-02   -3.081028490887696e-02   +1.470543408038171e-02   +4.718310911864841e-02; +3.611864572046379e-03   +1.406883850125840e-02   -5.820202207315210e-03   +3.314966390127289e-02   +1.673772094882721e-02   -5.652145937616788e-03];
L2_L3_iGABA_netcon = [+3.248976724620026e-02   -3.052853724385737e-02   -2.134905782067566e-02   +6.220566726144428e-02   -1.651715936115593e-03   +1.286360440404575e-02   +2.129244096225825e-03   +1.899687285449881e-02   +6.410306980777443e-02; -2.860262503377175e-02   -9.816914810758907e-04   +2.848758686248826e-02   -3.077434416503713e-02   +5.253822874792121e-02   -2.409956445025236e-02   -4.937860215281611e-02   +5.264693474448690e-02   +9.084570892968616e-02; +2.797071367236238e-02   -2.845520443811802e-02   -4.083248957467543e-02   +9.506273138746170e-03   +2.680704265260975e-02   +3.887343206201033e-02   +4.008625823160238e-02   -5.371827870293965e-03   -5.180319607244214e-03; -1.979876782515822e-02   -7.233975707331389e-02   -1.315588030504267e-02   -9.528319018557434e-03   +1.909718322036701e-02   -2.759198196692905e-02   -1.149240963822181e-02   -9.870995379778424e-03   -5.455301348169515e-02; +1.504530083071296e-02   -1.346081524822822e-02   -2.050067806976862e-02   +2.019621531227580e-02   +3.306837003776519e-03   +2.349045780244211e-03   -8.297017958189117e-03   +4.372673314448017e-02   +3.028097450988572e-02; -1.474371984696353e-02   +2.896310761670173e-02   +3.007537525846966e-02   +5.330461464305850e-02   +6.116880454167858e-03   +7.185731171392362e-02   -3.678765758566802e-02   +6.620970155702535e-02   +3.906513094488154e-02];
L1_L4_iGABA_netcon = [+8.740153068514903e-03   +4.383204118416278e-03   -1.317887956830901e-02   +1.970086726408394e-02   +1.487381805910928e-02   -1.003840709780410e-02   +3.059987694911969e-02   -5.715235383558947e-02   -1.625625365572222e-02; +1.959537170228571e-02   +2.469821745051634e-02   +5.685876609877247e-02   -2.059925793188503e-02   +5.307383395709608e-02   +1.128866750266792e-02   +3.904150427394937e-02   +2.432904071226491e-02   +4.490408442680554e-02; -1.078988993991403e-02   +2.799737063709240e-02   +2.002164424935307e-02   -9.484196982688164e-03   +3.814408663488787e-02   +1.038398642804539e-02   +6.261438567253039e-02   -2.737475994305127e-03   +6.687411571430659e-03; -1.600716714227263e-03   +1.539440447159573e-02   +4.304958276495525e-04   -1.517419475979330e-02   +5.100581267227341e-03   +4.790914612252322e-03   -1.517142737170878e-02   -1.296542401116477e-02   -1.275489711464866e-02; +6.224917618091395e-02   +5.041255648846298e-02   -2.983997526177854e-02   -1.883815204443354e-02   +5.231988138650796e-02   +1.204563475291460e-02   -3.302401825530348e-02   -3.452530858353831e-02   -7.576214248729733e-03; +1.411019208914361e-02   +4.901264838701860e-02   +6.062887025980363e-02   +2.758170882498852e-02   -2.803489300589515e-03   -1.482023372513527e-02   -2.876033854760933e-02   +2.410529429651732e-04   -4.704377363407355e-03; -2.721552581323255e-02   +1.943148347012037e-02   -9.367457050182885e-03   -7.456276879135890e-03   +2.218409836540085e-02   +2.951005566005884e-03   +2.793608449640179e-02   -6.154853416685835e-02   +2.799446201369536e-02; +3.076675022188016e-02   -3.679579471308094e-03   +6.838607514027370e-02   -5.705698815266908e-03   +3.516115819916001e-02   +2.242236116699798e-02   +3.842482941534178e-02   +8.957024393805184e-03   -2.068239554950381e-02; +1.847451875259579e-02   -1.297128909981057e-04   +4.513922915967505e-02   -3.901873690227410e-03   -2.401487165131594e-02   +5.322193547297328e-02   -8.311558025514554e-02   +7.138520451452048e-02   -2.434068963424504e-03; +2.948119405826027e-02   +4.446894858921687e-02   -1.270432873858441e-02   -1.805176264367107e-03   -4.052507725980740e-02   +2.460011708239659e-02   +7.993433468771816e-03   +3.684882072975587e-02   +3.319339963407673e-02; +3.655137896078665e-02   +6.716759857678582e-02   +2.986011793025295e-02   -1.550649738810322e-02   -5.374394490865430e-02   +1.500548838314140e-02   +1.526092112200197e-02   +3.580310647003402e-02   +2.647486927823089e-03; -6.319794173820427e-02   +1.423697214465917e-02   -4.139209724138503e-03   -1.479746473576973e-04   +8.103276689889007e-03   +8.919515934733033e-02   +7.009841648351028e-02   -2.802529041300612e-02   +5.321282537379518e-02];
L4_L1_iGABA_netcon = [+2.964354060497281e-02   -5.288668450652602e-02   +1.606022603404544e-02   -9.234987008548037e-03   -2.235097943084401e-02   +6.955550026715068e-02   +1.625693259362039e-02   -2.951107745715817e-05   -3.058541915989804e-02   -5.659884356962646e-04   +1.257012755984508e-02   +3.908897121700019e-02; +2.466499538124142e-02   +4.245391700769855e-02   +5.593711079358826e-02   -8.683708223651479e-03   -4.561997855145026e-03   -6.131810052635026e-03   +1.625564606269985e-02   +1.909039942217198e-02   -1.206009094065138e-02   +3.875514905347414e-02   +1.146190101039008e-02   +2.608780108169541e-03; +9.014121637121827e-03   -6.813261867445158e-02   +1.103357314186348e-02   +5.788601233698505e-03   -7.643933847670585e-03   +3.678873047465224e-02   -2.715968372068718e-04   -4.137193791681680e-02   -2.299441626108279e-03   -8.210696030145178e-03   +4.143177502862823e-02   +2.677795670827465e-02; +1.086810178264152e-02   +4.384322617033621e-02   -4.909656889986083e-03   +2.147580054358243e-02   -5.194674050038224e-02   +2.016907894679719e-02   -2.487066688048301e-02   +5.476232140123314e-02   -1.486434436843291e-02   -1.002977379770124e-02   +8.417252030386017e-03   +4.243352274967135e-02; -2.813822762569499e-02   +2.579928617342908e-02   -5.818288684301548e-02   +1.916929908744956e-03   -3.674251604676534e-02   -6.745209952879641e-03   +2.018243651931200e-02   +3.852491134127812e-02   +2.505391319262705e-02   -4.880158324201105e-02   +2.949737246082867e-02   +2.187143906438243e-02; +2.100129262891883e-02   +2.775128618614849e-02   -2.589355392579601e-02   +1.242355518959517e-02   -1.049338974538028e-02   +1.250197268881268e-02   -3.260533793886767e-02   +5.862070659298894e-02   +5.527551691907152e-02   -3.283195544544873e-02   -7.482522327380111e-03   +5.979238969903584e-02; -1.106261967493797e-02   -6.666117179354809e-02   -3.337855780785685e-02   +4.260505216676099e-02   +3.949887958876740e-02   +1.704781898572909e-02   +6.802639661501121e-02   -8.753135129923286e-03   +4.119268162046068e-02   +2.552165572968126e-02   -1.927890927945172e-02   +4.824271779180737e-02; -1.075913371465717e-02   -4.712403910647640e-02   -4.346704215883325e-03   +1.157907757170736e-03   +1.499743753120366e-02   +1.225593929768888e-02   +1.415887188279718e-02   +2.218517708605035e-02   -3.732805032269186e-03   +5.207978736928953e-02   +3.965942160867546e-02   +2.389385703730919e-02; +6.391067423359800e-02   +6.609552508567579e-02   -1.469552922380191e-02   +6.297661562977269e-03   -2.897684087436350e-03   +3.346505259836582e-02   +3.802349261773156e-03   -3.711074343979525e-03   -9.949451123367623e-03   +5.854929267537123e-02   -1.894394651156985e-02   +8.396280446263095e-03];
L1_L3_iAMPA_netcon = [+4.592435906017664e-02   -3.508212962345117e-03   +6.123419781478652e-03   -1.492149745219577e-02   +2.164677916165415e-02   +6.720820913534112e-02   -3.767882986465106e-03   +4.530050193617042e-02   -2.163013740272814e-02; -2.236732619022007e-02   -2.363585012918452e-02   -1.473610879497908e-02   +1.259862258032611e-02   +4.631897539539231e-02   +2.333754714533587e-02   +3.906085431022983e-02   +4.620633546358115e-02   +9.723434906111154e-03; -7.381291109028600e-03   -1.375334540828110e-03   +1.168837187602437e-02   +8.075095550810654e-02   +9.319365915801923e-04   +4.090169053659107e-02   -3.163207257432141e-02   -1.754861152426219e-02   -2.138766378079068e-02; +4.909904011354148e-02   -5.109603225423209e-02   -3.893703385568570e-02   +8.301692838262431e-03   -7.339495583881180e-02   +4.468557736555384e-02   -1.513156909455410e-03   -3.230365068809011e-02   -5.139478296883777e-04; +6.046110865343470e-02   -1.986242201148783e-02   -4.014737563567252e-02   +2.164697571915365e-02   +2.977795957095679e-02   +8.732546849743604e-03   -2.858305981140492e-02   +2.329173468090061e-02   +4.038775136517254e-02; +1.050756595922693e-02   -2.007638705237534e-02   +2.372355431174908e-02   -4.628555985307600e-02   +9.934503421477900e-03   +8.118800459577479e-03   +4.085661989506745e-02   +2.183166196911243e-02   +4.282833075738014e-02];
L3_L1_iGABA_netcon = [+3.988724885286354e-02   +2.981833261705424e-02   +1.646475980269998e-02   +2.142486461983542e-02   +4.883190336271239e-02   -8.627633708738196e-03; +2.445396904254758e-02   +1.569950285007422e-03   +1.062351787149582e-02   +2.643696277871053e-03   +1.412121496210522e-02   -7.325232018069186e-02; -7.881035944544292e-03   -1.436887494035291e-02   +2.868061351617460e-02   -2.973301458512383e-02   +3.348422919656549e-02   +2.656151683357885e-02; +3.232937026046322e-02   -4.202537493628908e-03   -3.887227909667314e-02   +3.976702175445003e-02   -1.976794820893922e-02   +2.401375912248289e-02; -6.886790489673916e-03   -2.283943622104719e-03   +5.911911953170428e-02   -5.832247500015501e-02   +1.560548901002549e-02   -2.316294042119933e-02; +3.252826990109443e-02   +2.081433305493195e-02   +4.705223727754419e-02   +4.986362068745647e-02   +3.288126241266225e-02   +5.175626036021942e-02; -1.716031864249547e-03   +5.520846031608831e-02   +8.966086564059960e-03   -2.089812955900643e-03   +4.017265512982891e-02   -3.122305604073355e-02; +4.764485908000163e-02   +3.998774890627756e-02   +3.394842091792102e-02   +3.040273849806973e-02   -7.014712652374392e-03   -1.511425403983070e-02; +1.598268728084910e-02   -1.747879759702453e-02   -2.329636510248759e-02   +9.371121765050089e-03   -1.106588365790678e-02   +6.411300500891084e-03];
L5_Input1_iAMPA_netcon = [+1.292679882006206e-02   -4.769431832637357e-02   +2.639415742170441e-02   +3.440803747094874e-02   +4.748354605185523e-02   -2.325226983899399e-03];
L6_Input2_iAMPA_netcon = [-2.493854628893961e-02   +1.472521790416818e-03   -6.684426453085507e-03   -6.324978882138051e-02   +3.175905359114775e-02   -3.964120288245302e-02];
L5_L6_iAMPA_netcon = [+6.200225445590421e-02   +3.105900434210667e-02   -4.513791319307280e-02   +5.606886168919384e-02   +1.149129232665060e-02   -2.991418181808951e-02; -2.941854153544230e-02   -5.560413050717031e-03   -2.628211891829680e-03   +6.201881479416703e-02   +1.561672524117461e-03   +3.566625526452251e-02; -7.969338664987984e-03   +3.964354157070737e-02   +1.026305377426311e-02   +2.187228366095955e-03   +4.545535186853462e-02   +3.098859098289514e-02; +2.168865906374146e-02   -1.464394064835182e-02   +4.461620279068001e-02   -1.841433974334004e-02   -3.076170437336527e-02   -1.570108379499076e-02; +4.958889278379667e-02   +7.528920695777780e-02   +3.875674121776947e-02   +1.976326635605718e-02   +2.584292501897488e-02   +7.526939785073433e-03; -3.424060813942566e-02   +1.847600375858589e-02   +5.990392688642906e-02   +9.125710787465879e-03   -4.525326744114976e-02   +5.075184093313343e-02];
L4_L5_iAMPA_netcon = [-5.091053498687376e-02   +4.214297337097316e-03   +4.258257052649671e-02   +3.931334246784707e-02   -2.672420397449127e-03   -2.643244168118077e-02   +2.667918259128587e-02   +4.440756378743005e-02   +4.479107255164572e-02   -3.220606397555797e-02   -4.093511341416849e-02   +3.324532185801041e-02; -4.540250195910128e-03   -9.985717148365953e-03   +4.231267035083176e-02   +7.093193722549376e-03   -5.434642929681925e-03   +1.278797293704255e-02   +4.041127856235399e-02   -2.718561193345115e-02   -4.625447817623557e-02   -2.547554379417038e-03   -1.460534039866129e-02   +7.313527452268442e-02; +1.311062828507766e-02   +2.910564382254746e-02   +8.063968343422440e-02   +6.811148970162448e-02   +1.218839986317125e-02   +2.881992754694490e-02   +1.668522009995911e-02   +2.101313636008922e-02   -1.503786332542873e-02   +8.269340135348552e-03   +4.223994973539986e-03   +6.358759627775794e-03; -4.060185899077531e-02   -2.505570698095855e-02   +3.992145331842578e-02   +2.752418675183457e-03   -3.075935943958183e-02   -2.788517688153727e-02   -5.880185943312791e-02   +1.142734153564964e-02   +5.440165353993158e-03   +1.326086674441695e-02   +4.324722734450072e-02   +1.076807887165109e-02; +2.386615710833661e-03   +1.870648399145262e-02   -1.552631348535854e-02   -3.302525869017987e-02   +4.089033926705886e-02   +3.303505522709106e-02   -2.614856375974849e-02   +1.085520740353416e-02   +2.750147066947303e-02   -1.045501919631147e-02   +2.719109095249675e-02   -3.609962390849140e-02; -2.773968532064285e-02   +3.106817636482660e-02   +2.248967659748620e-02   +1.384787889174102e-02   -6.812563785237144e-02   +4.941250411950343e-02   +5.369327138614488e-03   +2.111690369158066e-02   -2.046095976231836e-02   +2.453596242724018e-02   -1.713757617345798e-02   +1.520620036386698e-02];
L6_L4_iAMPA_netcon = [-8.500150281877977e-03   -1.149116187929319e-02   +6.381243443679277e-03   -4.890212039626342e-02   -7.286854617577873e-03   -1.082290069801134e-02; +2.551532091431696e-02   +5.303566947415272e-02   +2.299432172493705e-02   -2.720399038746721e-02   +3.826433556712491e-02   +4.554134959076017e-02; -4.847343209315564e-02   +1.819798437483833e-02   -4.243086396063808e-02   -1.927258492616648e-02   -1.041373979411220e-02   +1.003162122422429e-02; +7.462212794983351e-02   -4.206563535916809e-02   -4.123403299773397e-02   -7.909802274003487e-03   +4.986774945080932e-02   -4.331173962790499e-02; -2.276304788490872e-02   +3.555614585374235e-02   -2.062295111801427e-02   -4.552686084798678e-02   +2.584096355833775e-02   +5.507627066924182e-02; -3.907854798259333e-02   +5.162197703420593e-02   -6.726511177251334e-03   +6.361787132677640e-02   +4.196754597379955e-02   -2.556515950133271e-02; +2.960077355494747e-02   +4.220735441591707e-02   +4.940827528098309e-02   +4.136671866503808e-02   +5.774439833432885e-03   +3.534494712973407e-02; -9.878478259250104e-03   +2.249734596644171e-02   +5.386001849860272e-02   +4.212240137239195e-02   +4.063050620799676e-02   +6.417757924945935e-02; -7.229794232467153e-03   +8.090766602668575e-02   -7.003215364718679e-02   +5.446073676664345e-05   -3.175225866305800e-03   +1.723815722080279e-02; -1.578248938952587e-02   -8.192394652506450e-03   +1.451097710589554e-03   +1.667065953013961e-02   +7.684028236277407e-02   -4.032699007829876e-02; +3.101918005096450e-02   +1.796775038876152e-02   +5.222394875935663e-02   +7.007364654573192e-02   -3.864604081437167e-02   -1.575786119217202e-02; +3.186747847352073e-02   +2.415566108239780e-02   -5.025317574681699e-02   -6.424817065029616e-03   -6.094255538808858e-02   +1.590869086936512e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
