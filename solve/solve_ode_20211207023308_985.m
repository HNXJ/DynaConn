function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L6_L4_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L6_L4_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon,L6_L4_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [-7.768582409138683e-03   +3.610915849932989e-02   +1.065374844465876e-03   +6.363638780619707e-02   +1.047237973844555e-02   +4.990823970130966e-02   +7.295132153053167e-02   +5.096413250263374e-02   +3.268266912485963e-02; +1.675427820358528e-02   +1.824291453076959e-02   -4.012557288602487e-04   +3.243978330975932e-02   +8.495998431224740e-02   +2.941937569326298e-02   +3.987346151537780e-02   -6.289773781887106e-04   +1.641183101637392e-02; +2.941732620509608e-02   +4.792731824519177e-02   +3.308929231913853e-02   +1.414926485619912e-02   -2.422134217871916e-02   +8.630695507326095e-03   +9.499523182515607e-02   +5.677730030513676e-02   +3.133428256753123e-02; +6.123252341930859e-02   +3.603911955952928e-03   +6.423738023849465e-02   +5.534204806062997e-03   +2.156279610776593e-02   +2.605398053777307e-02   +1.706093469534065e-02   +4.776890918103012e-02   +3.557239385343072e-02; +2.377930084551558e-02   +6.864178021937165e-04   +6.104960697437908e-02   +5.718298870866888e-02   +8.065236030103347e-02   +5.354689001735925e-02   +3.580951199602149e-02   +3.673851983131431e-03   +2.706268294626641e-02; +3.356899368312109e-02   +3.389819517231683e-03   +3.340313792606281e-02   +8.738432914719269e-02   +4.009881895273876e-02   +2.300923881701361e-03   +6.548718819791455e-02   +1.977784912704163e-02   +4.106556246232568e-02; -1.973664266455723e-02   +1.095145677379226e-02   +4.295716341223745e-02   +4.863961709376242e-02   +1.081553114950363e-02   +3.912452627498268e-02   +7.617476504744678e-03   +4.786510519164391e-02   +4.609438715020772e-02; +3.429363676375987e-02   +2.931619797169060e-02   +5.802284574526907e-04   +3.284079528307714e-02   +3.048815347040127e-02   +1.138110256966100e-02   +2.988417906534125e-02   -5.247528972513313e-03   +3.734753893826279e-04; +3.133900634760966e-02   +5.520544880536207e-02   -1.237851475501603e-02   +3.276702296405984e-02   +3.770005439551304e-03   +7.901252236526704e-02   +2.716226596835966e-02   +1.244060391803726e-02   -3.621445995312876e-03];
L1_L2_iAMPA_netcon = [+4.951479474407666e-02   +6.107703821628804e-02   +3.655834670118444e-02   -2.655505419735732e-02   +6.038713202922752e-02   -1.501161340700529e-02   +5.262388676792713e-02   +5.336097987312609e-02   +5.072148776496250e-02; +4.633758550733477e-02   +2.508735393899892e-02   +5.356739563659049e-02   +4.472213438506044e-03   -6.130794078677857e-03   +5.253639956012884e-02   +6.083832414526030e-02   +6.830786986467742e-02   +2.219306263724608e-02; +5.308239691733540e-03   +2.521452334412424e-02   +5.850991836492969e-02   +3.251641095180048e-02   -8.014485902756930e-03   +2.551699054878785e-02   +5.319454757814426e-02   +5.996423629502334e-02   -1.258250326221992e-02; +8.835004140801121e-03   +4.993361762429060e-02   +2.437341180655484e-02   +4.949495770899351e-02   +3.101334480883598e-02   +4.093246629064323e-02   -1.414327758469433e-03   -2.074133659813852e-02   +5.020496617245991e-02; +1.174821212487153e-03   +9.098793994078486e-02   +8.950836240154355e-03   -1.874386852568396e-02   +6.404636335759097e-03   +4.783047097521404e-02   +2.234536879329450e-02   +5.020840607646306e-02   +5.476103908255710e-02; +4.540329922627331e-02   +9.444173604502157e-03   +3.872126047047205e-02   +2.095019114683958e-02   +3.736123289212880e-02   +9.494288656901047e-03   +4.064931622139048e-02   +6.969705935730235e-02   +9.124011645008239e-03; +6.774147506879334e-02   +5.349204608571453e-02   -4.079976168029203e-03   +5.062067910114156e-02   -7.753402689613559e-03   +5.014964130996605e-02   +3.039167329909531e-02   +6.896399649554487e-02   +2.366335397363034e-03; +2.489096344771818e-02   +3.066814722065828e-02   -1.735673759076787e-02   -1.472918287116478e-02   +3.609558300751377e-02   +2.357665239060559e-02   +6.526360725655579e-02   +5.428196015380882e-02   +6.789273122273565e-02; +8.504907507262537e-02   +5.311611087412076e-02   +1.183443802257273e-02   +3.763244352593622e-02   +4.314085885342218e-02   +7.829149870042450e-02   -1.760985116940866e-02   +1.037306806748481e-01   +7.030370048861320e-03];
L2_L5_iAMPA_netcon = [+8.062559171613332e-02   +3.489475645359384e-02   +2.928682859642952e-03   +9.405490465420613e-02   +6.356303070165797e-02   +6.869086253640876e-02   +5.494404684042031e-02   +7.647401062656502e-02   -9.533336654073691e-03; +2.100943671333572e-02   +7.911092943084537e-02   +1.130688529915807e-02   +6.156148963073115e-02   -3.224985529604247e-03   -1.589220718734975e-02   +7.493666363521860e-03   +2.758974066635688e-02   +6.943478264872366e-02; +6.027853604805226e-02   +4.474425634961648e-02   +2.166353891198489e-04   +1.033903355079625e-02   +4.094248226214980e-02   +7.263447656994163e-02   +6.818415473239291e-02   +5.282475835450744e-02   +2.683304549098608e-02; +3.202444536448705e-02   +4.659221767079524e-02   +3.603502977521159e-02   +6.030062274867073e-02   +2.984529215800447e-02   +5.607319180955533e-02   +1.531896869651799e-02   +7.224001013877512e-02   +4.641913893874128e-02; +2.272935485234778e-02   +5.869413309990112e-03   +1.630068683497364e-02   +3.185450637279016e-02   +5.246456388582223e-02   -1.255973114878957e-02   +1.779946596317902e-02   +5.255324718904473e-05   +5.393706007956425e-03; +4.797993843819028e-02   -7.858007235377832e-04   +2.412938977919514e-02   +7.767452772438337e-02   +2.345607944342815e-02   +1.972060775365733e-02   +2.514893938279148e-02   +4.063108528254336e-02   +7.724169131832927e-02];
L5_L2_iGABA_netcon = [+9.807082451457214e-03   +1.614828886766959e-02   +4.468911561448458e-02   -1.869963461878080e-03   +3.048322013717106e-02   +9.881481859380438e-02; +8.388508648212857e-02   +4.925262707413486e-03   +4.601043271171140e-02   +3.114372708143652e-02   +3.529690764978875e-02   +5.156132159512738e-02; +8.528234848873367e-02   +9.123152961341358e-02   +4.108902089933918e-02   +2.770328618937393e-02   +9.919249098643177e-03   +2.497830838070697e-02; -2.510595066297041e-03   +1.315362603530255e-02   +2.531441204788095e-02   -1.192496970076494e-02   +5.422674461298486e-02   +8.466380721161579e-03; +2.778692926701299e-02   +5.850074815919099e-02   +5.088647151921394e-02   +4.796586408218662e-02   -2.282703339807365e-03   +2.844011255388894e-02; +3.427235519135131e-02   +1.713356070871438e-02   +2.249424320257522e-02   +7.544436920415400e-02   +2.800387291395804e-02   +2.287531685625721e-02; +2.012564113542448e-02   +2.281542562020021e-02   +6.092918955109439e-02   -2.626931349320390e-02   +5.846051496454721e-02   +3.382420416836885e-02; +6.954142751041500e-02   +1.548848219820968e-02   +4.796447446169757e-02   +6.876376590841737e-02   +4.604589719357559e-02   -1.257209000953423e-02; +2.499800743727915e-02   +3.010256497195206e-02   -2.538904894659905e-02   +4.778539007990141e-02   -9.144352287217458e-03   +4.064795955777636e-02];
L3_L2_iAMPA_netcon = [-1.731358338073946e-02   +2.282660724336370e-02   +3.673260658277288e-02   -8.515161471432983e-03   +7.319770570140556e-02   +4.298811326098909e-02; +1.548544939992841e-02   +4.186089193053574e-03   +4.718762598897600e-02   +9.648026397533366e-02   +4.048266529511073e-02   +3.348826378240429e-02; +5.163467149947524e-02   +2.645719582410839e-02   +3.291541527112939e-02   -1.866840812836225e-02   +3.754325934051178e-03   +3.545439954568303e-02; +3.060888143890776e-02   +3.399487464480921e-02   -1.043667184201745e-02   +4.061317597445120e-02   +1.820183902324739e-02   +7.536595120428109e-02; +5.508289878293665e-03   +6.807533896953249e-03   -2.786703139137727e-03   +7.930259515779542e-02   +7.801566317229125e-02   +5.514262696272309e-02; +7.406366638386500e-02   +3.127046887387125e-02   +1.022839279633654e-02   +1.988037879290369e-03   +4.723589339242410e-02   +3.438048850467039e-02; +2.095978850773187e-02   +5.052862326414147e-02   +1.206232026634048e-02   -4.945820797044050e-03   +2.972232861675908e-02   +2.800836281260267e-02; +1.277568967927505e-02   +6.654175598855516e-02   +5.507726864982984e-02   +2.901375935354601e-02   +1.936699036571454e-02   +3.526918616439954e-02; +2.006056081408607e-02   -4.705859533071332e-03   +2.399331495621886e-02   -3.207118951118873e-02   +4.094728042538424e-02   +4.229435191682080e-02];
L2_L3_iGABA_netcon = [+5.205252621640793e-02   -1.717444521861388e-02   +3.322636029541853e-02   +3.045673871711545e-02   +6.113437977252278e-02   +2.306700398756791e-02   +5.940670234023329e-02   +7.039736510789581e-02   +6.538990959391205e-02; -2.050550263753001e-02   +9.259660703892940e-02   +5.565333101113390e-02   +5.176294260130147e-02   +7.280438134106462e-02   +4.510141572813412e-02   +3.368018418260532e-02   +5.209386532607782e-02   +3.762396518543724e-02; +2.236298046567741e-02   +5.591766526091228e-02   +3.443111863323444e-02   +3.639596382464871e-02   +2.484558399586989e-02   +5.417225103497576e-02   +4.541649708416197e-02   +2.907616789849055e-02   +3.740439912790264e-02; +6.930078155964317e-03   +6.069391832699461e-02   +1.992515675863852e-02   +5.119944443411283e-02   +4.967303939903572e-02   +6.189368944732981e-02   +3.051328471960401e-02   +2.666636475860400e-02   -3.129052367209777e-02; +3.048457411064003e-02   +3.511801800420977e-02   +2.950482097334796e-02   +2.867060607853238e-02   +1.191335012720465e-02   +4.340609612990656e-02   +7.525786925563775e-03   +2.564317596801420e-02   -1.311419761468431e-02; +1.505151535270731e-02   +7.142604935122433e-02   +7.094559425319073e-02   +5.487672000457311e-02   +4.834030349387442e-02   +4.221374323671524e-02   +4.808054133066309e-02   +3.716434301434029e-02   +7.552342028477563e-02];
L1_L4_iGABA_netcon = [-4.016792478046456e-04   +1.170939701813909e-02   +1.750116267694472e-02   +2.989195693056372e-02   +7.101066857531028e-02   +3.847371863121604e-02   +4.795242601562703e-02   -9.199121315617413e-03   -6.915113228362045e-03; +2.330406807312861e-02   +6.071943021067205e-02   +7.906772450150766e-02   +4.798612082325523e-02   +3.275845023149632e-02   +4.833704647711468e-02   +7.385634108883743e-02   +3.644480555857500e-02   +4.036887438960673e-02; +4.083178970462203e-02   +2.774081947899134e-02   +6.060992352196725e-02   +5.507427329152498e-02   +7.074651506159962e-02   +1.022817436679105e-02   +1.052094100969727e-02   -1.863060831833306e-02   +4.800231884228327e-02; +1.158959500456955e-03   +2.846814408218198e-02   +6.511686895828178e-02   +5.810091486246769e-03   -2.649875596133126e-02   +9.877609441820709e-03   +4.904645200199424e-02   +4.759601140747647e-02   +6.224279824324676e-02; +2.091702136968663e-02   +8.027298757722648e-02   +2.316305188430771e-02   +7.187217112694638e-02   +5.888534447973824e-02   +4.321572016013792e-02   +1.556092510197810e-02   +4.789598828412563e-02   +1.706779349635165e-02; +5.621320894189421e-03   +4.600796833374113e-02   +4.030828768635069e-02   +5.251298036447505e-02   +3.000042778256025e-02   +6.645687096363476e-02   +3.135329070967003e-02   +5.182056810848622e-02   -2.749921368735826e-02; +1.267227578429590e-02   +5.895379938607125e-02   +1.258158744581094e-02   +4.490701352938463e-02   +8.598855353104998e-02   +3.287038063812496e-02   +4.844137753986767e-02   +7.524885888080101e-04   +2.189889824835482e-03; +3.066321748256599e-02   +2.764031385524656e-02   +5.788381898845595e-02   +2.396093029252011e-02   +4.791282131712088e-02   +1.222540812646394e-02   +3.310020615309988e-02   +4.812558315641826e-02   +7.637498695529310e-02; +2.736232422507259e-02   +2.768028459285776e-02   -8.162462948186110e-03   +9.308164986726103e-04   +5.557631140203309e-02   +6.142310272677590e-02   +3.204567960647127e-02   +3.687621433825897e-02   -1.540007259845974e-02; +2.221950049273995e-03   +5.891249451508991e-02   +4.985535873455343e-02   -2.061743640017275e-02   +1.949804178248470e-02   +2.132084739112860e-02   +2.610152336889024e-03   +5.032310477732720e-02   +5.261465739053450e-02; +9.947763710464649e-02   +3.647922055236646e-02   +3.107416593100182e-03   +5.672295193127368e-02   +1.695530674064272e-02   +4.491199568250718e-02   +2.186426575816579e-02   +3.947682171170398e-02   +7.445864926158076e-02; +4.295793446575388e-02   +1.583117041147475e-03   -2.111185712274450e-02   +7.749383008552171e-02   +4.777661763354332e-02   +5.458694843858115e-02   +3.982503224458384e-02   +4.114898931622036e-02   +6.186778701786087e-02];
L4_L1_iGABA_netcon = [+4.045556882602765e-02   +4.842510709999814e-02   +3.860950602203790e-02   +5.233583110753894e-03   +9.819962437610104e-03   +6.619077065260001e-02   +3.162341589031051e-02   +4.341186570574898e-03   +4.575395983946706e-02   -2.758961173278588e-03   +2.049993306658593e-02   +2.428383493750351e-02; +2.991242738145704e-02   +5.486287458529165e-03   +6.825850091224873e-02   +4.454359114389503e-02   +2.636861210401586e-02   +3.651011841120435e-02   +7.451873759049529e-02   +2.306948615614199e-02   +9.484604606705638e-02   +2.559400041252649e-02   -3.083166341861486e-02   +4.512332548268277e-02; +2.288696204684114e-02   +4.022241122183449e-02   +4.496320160799631e-02   +6.891716922521480e-03   +5.507909971813842e-02   +4.639290077493973e-02   +1.785753423437446e-02   +5.724965763866927e-02   +5.451362008309679e-02   +1.053946896953527e-02   +4.453160924377553e-02   +3.162264068498608e-02; +6.578904081430184e-02   +2.678621803536564e-02   +3.029356283885386e-02   +5.314558526115784e-02   +2.577682971287151e-02   +4.227260464021846e-02   -2.075446039524703e-02   +3.686814438236811e-02   +2.305164524196643e-02   +7.075397239900720e-02   +2.488621006515591e-02   +6.826954904920723e-02; +6.254570095699728e-02   +1.076070891229330e-01   +5.165583844497043e-02   +2.787847089302569e-02   +4.092254276775801e-02   +3.309417635334442e-02   -2.660584907095713e-03   +2.035142793703977e-02   +2.352748914333885e-02   +8.393571243844132e-02   +6.069648600795705e-02   +5.366370849783234e-02; +3.097380118964513e-02   +2.780890735577454e-02   +3.849374447042136e-02   +8.540228524289688e-02   -2.649820940455340e-02   +4.381269408284628e-02   +3.816809561601495e-02   +8.978416569747655e-02   +1.011640498362042e-02   -1.375576834620621e-02   +2.320944692653325e-02   +1.979871673498336e-02; +3.223962783633957e-02   -3.705525062413940e-02   +3.694096227113172e-02   +3.744855121021592e-02   -2.487451183347659e-02   +3.179585702037650e-02   -1.309977836560248e-03   +6.583042490759808e-02   +8.764977339670152e-03   -2.126112245944133e-03   +1.831164732586613e-03   +5.976233177252420e-02; +9.889433703544079e-02   +3.256817460581202e-02   -1.202092309908667e-02   -6.677354468568724e-03   +5.469868150502437e-02   +1.248366248349740e-02   +5.118197260126720e-02   +2.854750364126335e-02   +7.925008759816404e-02   +7.927074802069074e-02   +5.321854042326456e-02   +4.025152250807105e-02; +4.871859778600162e-02   +2.688941644336177e-02   +6.257896497091055e-02   +3.469953124462610e-02   +2.240508703762767e-02   +3.492079100608692e-02   +3.641720922609804e-02   +1.002303331042938e-01   +5.434831586841077e-02   +1.995774151606221e-02   -3.833913075478994e-03   +1.532217298986008e-02];
L1_L3_iAMPA_netcon = [+3.931085691617056e-02   +6.036075896839940e-02   +3.116370968547347e-02   +6.752144732656061e-02   +2.969848855201159e-02   +3.608201899754458e-02   +2.771164588211828e-02   +6.362974504978731e-02   +7.785930643654864e-03; +1.393837516886326e-02   +5.456744046725358e-02   +3.952703654151635e-02   -1.392491806354603e-02   -1.475798454583973e-02   +3.137774661108665e-02   +8.285767360547119e-02   +6.952789278011475e-03   +7.908508928316207e-02; +4.999638170465939e-02   +3.034952822813728e-02   +5.323649448781290e-02   +8.442576717489508e-02   +2.563001549293084e-02   +5.859674579566067e-02   +3.971938259385206e-02   +8.954099533678193e-02   +3.983312419491984e-02; +7.254529128642884e-02   +1.543460971048846e-02   +8.797612655887731e-03   -8.015400463555903e-04   +6.415218543325898e-02   +4.908837979385218e-02   +1.126686230432330e-02   +4.148552198301545e-02   +9.745115667250960e-03; +7.321545532321030e-03   +4.192685959265182e-02   +2.057868119060858e-02   +4.511485220224175e-02   -2.382295982113329e-02   +6.382754128089477e-02   +3.722334554811461e-02   +1.648886529354551e-02   +4.873077273424903e-02; +1.332832002340319e-02   +5.737864364551574e-02   +3.726330609501200e-02   -1.474737576751329e-02   +2.608664497235046e-02   +4.706181794430157e-02   +4.176176126498880e-02   +3.991984782549159e-02   +3.254504559859520e-03];
L3_L1_iGABA_netcon = [+8.091932222710363e-02   +5.239921214367662e-02   +3.933072203686625e-02   -1.337839526812206e-02   +3.186173025287399e-03   +6.062852216103228e-02; +1.854719279506031e-02   +4.725917210258954e-02   -1.297564867613078e-02   +9.424048308610260e-03   -1.059371642690601e-02   +2.397450487533958e-02; +4.824198023753448e-02   +2.422035008651525e-02   +5.135638929457394e-02   +3.104410013481477e-02   +7.022127827990467e-02   +6.750993207854261e-02; -1.674890224666759e-02   +6.107620340164383e-02   +5.034020285673210e-02   +3.621746269468272e-02   +1.022270798771226e-01   +7.258573119161908e-02; +4.080853529129029e-02   +3.510804102235499e-02   +7.262079510360676e-02   +2.640433325711531e-02   +3.996100303469922e-02   +3.599992139421248e-02; +7.596793146727580e-02   +3.511115086811482e-02   +1.786922440262907e-02   +7.241249578742399e-02   +7.675840215044342e-02   +4.864419221938489e-02; +6.996362463901277e-03   -1.296341060028716e-03   +5.720116472219749e-02   +3.015445133946483e-02   +3.587486512870741e-02   -5.677296232715060e-03; +2.301793777143064e-02   +3.991562919500964e-02   +7.132105639996988e-02   +3.173257817590820e-02   +2.317960565839315e-02   -1.441742413251183e-04; +2.092418342358259e-02   +9.184530720181575e-02   +7.130869818761577e-02   +6.400451136958357e-02   +3.834350384729344e-02   +6.401878851226367e-02];
L5_Input1_iAMPA_netcon = [+1.984934697866617e-02   +5.155524964104595e-02   +3.724416891218819e-02   +4.774032621303830e-02   -1.533623463607968e-02   +6.463893479979856e-02];
L6_Input2_iAMPA_netcon = [+2.757675606658078e-02   +4.847959274035335e-02   -9.407034780410490e-03   +3.145545554732127e-02   +3.241134692820670e-02   +2.448068362419752e-03];
L5_L6_iAMPA_netcon = [-2.301456860571929e-02   +5.950534450634224e-02   -5.843606979451419e-03   +8.383085148058125e-02   +2.079988610097693e-02   +7.738254326697743e-03; -1.995936451662925e-02   +1.050242134130037e-02   +4.197346715806283e-02   +5.698712138331480e-02   +6.111630823278198e-02   +3.661344400908590e-02; +5.343515063235537e-02   +5.767565346336146e-02   +3.911282451387520e-02   +1.748638005339441e-02   -5.536513158757738e-03   +5.746289386082207e-02; +4.558380543147996e-02   +7.581058218568384e-02   +6.685885677223570e-02   +1.610198057786178e-02   +4.336815525601259e-02   +5.292614594301270e-02; +2.157912648628917e-02   +6.802784505836432e-02   +7.956929114925239e-02   +6.680560053577105e-03   +3.353925862818484e-02   +4.257497491359122e-02; +4.048125681538264e-02   -1.034125773491315e-02   +1.102153299698360e-01   +6.706194131558374e-03   +7.969088588739773e-02   +2.080372999876085e-03];
L4_L5_iAMPA_netcon = [+4.722093783443206e-04   +3.581007423324303e-02   +6.179996727029433e-02   +2.490314782612666e-02   +1.273253778241332e-02   -1.638788433630958e-02   +9.404863938626033e-02   +2.512889507561558e-02   +4.252772023432832e-02   +4.956698923418574e-02   +8.418898461221348e-02   +2.166844856935469e-02; +1.287564760255569e-02   +7.610714717611500e-02   +2.588709063315104e-02   +3.481881319652340e-02   +1.643970980237996e-02   +2.916302603537628e-02   +6.896504744741430e-02   -1.464646681946825e-02   +1.801923482955927e-02   +7.982482539316306e-03   +7.619946027904642e-02   +4.702631520116549e-02; +2.687222710513176e-02   +4.106997275741096e-02   +1.686846442807510e-02   +2.116414270947172e-02   -2.197105956087349e-02   +8.496508058209129e-02   -8.903191092312409e-04   +3.760598430114560e-02   +5.324321758431461e-02   +5.908693383766914e-02   +5.616000246963102e-02   +2.079911139881037e-02; +1.562728681320461e-02   +3.752296766097822e-02   +3.932157847637240e-02   +1.038276498682532e-02   +1.325367679213994e-02   +5.927515135237204e-02   +2.223772655627600e-02   +1.532857658938233e-02   +5.788276850400569e-02   -1.346439810001233e-02   +9.311778859581915e-02   +2.212839697455835e-02; -1.239283164085967e-02   +5.309992109209519e-02   +4.983116911891922e-02   +1.510212192805401e-02   +3.778003259583414e-02   +5.306388670685632e-02   +6.329815281484909e-02   +9.459684423032197e-02   +3.692288919718206e-02   -1.095465688730961e-03   +4.787254170020840e-02   +3.808130764655080e-02; +6.169899681055548e-02   +4.909700251626500e-02   +3.264498118585786e-02   +5.874785002439575e-02   +3.579695552706691e-02   +8.140855402291650e-02   +5.636989490537182e-03   +7.428950357320887e-03   +2.307632077479742e-02   +8.309509089607622e-02   +3.849231242707470e-02   +7.915019607970641e-02];
L6_L4_iAMPA_netcon = [+6.243140794543092e-02   +3.301704993987054e-02   +4.591940140999106e-02   +2.027319710672924e-02   +3.884148733839302e-02   +4.695210149170952e-02; +1.251833184452918e-03   +2.984081896631019e-02   -2.057625067954962e-05   -4.952622302604893e-04   +2.974733682062733e-02   +3.242757260434705e-02; -1.386359797723057e-02   +2.398775144428632e-02   -1.018189940444149e-02   +1.730028363053672e-02   +9.162069536507594e-02   -1.105300240743794e-02; +6.984537762783412e-02   +5.691935012559195e-02   +3.604752558875315e-02   +3.628910395962321e-02   +7.147062328215177e-02   +2.275889599355534e-02; +1.261412582698225e-01   +8.050899074909652e-03   +1.777884374228163e-02   +1.239725643308380e-02   +5.700760042771223e-02   +6.943105770207934e-02; +5.166537162024253e-02   +6.327305879480073e-02   +4.252348331450655e-02   +5.233181515801589e-02   +4.614719600179630e-03   +8.415974181999987e-02; +3.063538502382762e-02   +6.639576903859033e-02   +7.467954749197096e-04   +2.115116877719791e-02   +7.733646937715979e-02   +4.383038547790491e-03; +2.645968322866317e-02   +9.247670493322351e-02   +8.450435445089557e-02   +3.837251913405361e-03   +2.206120785992523e-04   +8.012688889484933e-02; +1.982435108686480e-02   +2.868092150296989e-02   +5.216373543984999e-02   +1.565096845496718e-02   +1.478354043774896e-02   +1.709318253110360e-02; +1.545819533377690e-02   +2.470737038153270e-02   +6.721894902618812e-02   +4.915141318312462e-02   +7.693114280237938e-02   +2.848844975903106e-02; +5.922186566694743e-02   -3.522936223859529e-03   +6.863971632809004e-02   +2.949389428344136e-02   +4.365359897140760e-02   +1.497643485603519e-02; +4.491102103126676e-02   +5.322352100893007e-02   +2.272575649428992e-02   +2.121627146305043e-02   +5.206722830367337e-02   +4.579367629792302e-02];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;
L6_L4_iAMPA_s_last =  p.L6_L4_iAMPA_IC+p.L6_L4_iAMPA_IC_noise.*rand(1,p.L4_Npop);
L6_L4_iAMPA_s = zeros(nsamp,p.L4_Npop);
L6_L4_iAMPA_s(1,:) = L6_L4_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);
L6_L4_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_L4_iAMPA_IAMPA(1,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA))))+((((-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s_last*L6_L4_iAMPA_netcon).*(L6_v_last-p.L6_L4_iAMPA_EAMPA))))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 50*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 50*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);
  L6_L4_iAMPA_s_k1 = -L6_L4_iAMPA_s_last./p.L6_L4_iAMPA_tauD + 1/2*(1+tanh(L4_v_last/10)).*((1-L6_L4_iAMPA_s_last)/p.L6_L4_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;
  L6_L4_iAMPA_s_last = L6_L4_iAMPA_s_last+dt*L6_L4_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  conditional_indx=(any(Input2_v_last>=0&Input2_v(n-1,:)<0));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  conditional_indx=(any(Input1_v_last>=0&Input1_v(n-1,:)<0));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=0&L6_v(n-1,:)<0));
  conditional_indx=(any(L6_v_last>=0&L6_v(n-1,:)<0));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=0&L5_v(n-1,:)<0));
  conditional_indx=(any(L5_v_last>=0&L5_v(n-1,:)<0));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=0&L4_v(n-1,:)<0));
  conditional_indx=(any(L4_v_last>=0&L4_v(n-1,:)<0));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;
    L6_L4_iAMPA_s(n,:) = L6_L4_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);
  L6_L4_iAMPA_IAMPA(n,:)=-p.L6_L4_iAMPA_gAMPA.*(L6_L4_iAMPA_s(n,:)*L6_L4_iAMPA_netcon).*(L6_v(n,:)-p.L6_L4_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
