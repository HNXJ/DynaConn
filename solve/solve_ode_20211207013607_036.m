function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iGABA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iGABA_IGABA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iGABA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+4.264367948443228e-01   +1.411462716397662e-01   +6.637955100956681e-02   +2.773268700565665e-01   +4.027039475898074e-01   +4.423866888143094e-01   +1.594889647118432e-01   +2.724769619310072e-01   +5.681946580727328e-02; +1.329225832823581e-01   +2.003080356911929e-01   +3.737737254844934e-01   +2.057082644423796e-01   +4.774622012427427e-01   +5.942121704609405e-02   +8.584800254453170e-02   +8.005898930478729e-02   +1.845531898073884e-01; -4.882549921905465e-03   +2.752710448869779e-01   +1.934193839742794e-01   +3.924520324581022e-01   +4.809055559604036e-02   +2.645052532443253e-01   +3.298202497704683e-01   +3.987778910920409e-01   +6.665660953256201e-02; +1.781605139902301e-01   +3.428504117476059e-02   +5.218503601175298e-02   +4.283414500043673e-01   +1.700102210597695e-01   +2.672953750015156e-01   +1.164658527233629e-01   +2.542365551972448e-01   +3.116080632255879e-01; +2.445910902352878e-01   +5.052084851568748e-01   +2.258434680792631e-01   +2.880689057596136e-01   +3.885966294362509e-01   +2.855986155403090e-01   +1.221887784543170e-01   +4.928291762456470e-01   -1.086618243484256e-02; +2.994464477411440e-01   +4.075179180148271e-01   +3.781970626503760e-01   +1.093269181685534e-01   +4.245705467923501e-01   +1.581964891323980e-01   +4.440621876511853e-01   +7.496561022978879e-02   +3.417295696152297e-01; +4.608865694615846e-02   +4.664681755039968e-01   +4.730106621267671e-01   +4.289902816357921e-01   +4.908571675470459e-01   +9.159237254790691e-02   +3.697144514696756e-01   +1.902232033675146e-01   +1.776036894223495e-01; +1.428655947539795e-01   +4.191975642016036e-01   +4.284382954582056e-03   +1.274382094919982e-01   +3.748798830594103e-01   +4.462344908621785e-01   +3.401024700195509e-01   +7.196930198284465e-02   +3.653434368066669e-01; +2.636151151492059e-01   +1.508637233730998e-01   +3.290317597688493e-01   +4.368592276097762e-01   +3.151561350643218e-01   +4.208439069274468e-01   +3.098825083465864e-01   +1.283437402730530e-01   +4.576772102525274e-01];
L1_L2_iAMPA_netcon = [+1.120286531628856e-02   +2.771513928995296e-01   -2.178004122161639e-02   +2.655146451662851e-01   +2.781379872065012e-02   +4.251978403928366e-01   +6.731456000914603e-02   +1.806713069533941e-01   +5.075121419958429e-01; +3.019065659385959e-01   +4.694705565428337e-01   +4.286438486093297e-01   +2.666795862449926e-02   +1.245169967494276e-02   +2.517486727148859e-01   +3.597427148042180e-01   +1.072254003741912e-01   +3.371265952580400e-01; +5.478252283051931e-02   +9.808074074186042e-02   +8.914624351759448e-02   +1.097689534742991e-01   +1.204330328514705e-01   +1.826643767641445e-01   +1.434010799956359e-01   +2.061036875855254e-01   +2.244172952804275e-01; +4.538230534149342e-01   +4.322189129990585e-01   +4.350158305603374e-01   +4.446050538982336e-01   +2.466673648041648e-01   +2.442370113307258e-01   +4.206655404611330e-01   +2.886697202506982e-01   +3.949587517046277e-01; +3.503779601360186e-01   -5.974852177363640e-03   +1.075098255686540e-01   +2.698511783261688e-01   +7.829602848188376e-02   +3.760312285178126e-01   +3.877220385698380e-01   +9.086601934421043e-02   +1.819376973128653e-01; +2.934273397200425e-01   +2.948337952063134e-01   +4.646666777823399e-01   +5.248113895625123e-01   -2.234962550629170e-02   +1.936604015604987e-01   +7.019104972507828e-02   +2.778215963099280e-01   +1.843063735808760e-01; +4.071767061660272e-01   +1.165101936421994e-02   +1.074121998348195e-02   +3.135306636089217e-01   +2.858662520380806e-01   +4.387436812277376e-01   +1.172221135155922e-01   +2.652981204020602e-01   +5.925952879861346e-02; +2.618347009885281e-01   +3.365689521282501e-01   +1.458986379325940e-01   +4.101004900050074e-01   +2.094778669647746e-01   +3.725821352687983e-01   +4.249314765230604e-01   +1.081658969695182e-01   +2.559659469848074e-02; +6.566914926477588e-02   +1.136492971440340e-01   +3.051095546777333e-01   +4.186045185048331e-01   +4.897004756516919e-01   +1.251575109162714e-01   +4.737782854200691e-01   +4.172805913340161e-01   +2.760821738751726e-01];
L2_L5_iAMPA_netcon = [+3.259689986990901e-01   +2.141457261993522e-01   +2.003276840362797e-01   +4.453155141563861e-01   +4.824631861694477e-01   +3.872421772866969e-01   +4.664058040872386e-01   +4.820630877056268e-01   +2.553462954437420e-01; +2.290332084882359e-01   +2.468214760246585e-01   +4.557787122159276e-01   +3.382093567018697e-01   +2.003647462628281e-01   +8.812445170627257e-03   +1.043157108213834e-01   +1.916348599818328e-01   +4.062107621682624e-01; +1.545644528694968e-01   +4.043838083066441e-01   +1.592442052402961e-01   +7.840753503417039e-02   +4.615074051833307e-01   +8.116928407410932e-02   +2.239358440534602e-01   +3.321499745411285e-01   +2.493794825648708e-01; +2.215899710958144e-01   +3.193536260311666e-01   +2.097103874421127e-01   +4.691583488571103e-01   +3.384278282958241e-01   +4.696959965083482e-01   +4.953444752557365e-01   +4.784924488820596e-01   +4.212838193284086e-01; +4.246277208474064e-01   +3.794518036847306e-01   +2.955753049639664e-02   +4.181465305153416e-01   +3.788661729954190e-01   +3.710977882348512e-01   +3.454538100988094e-02   +1.701567939048560e-01   +4.138676479654566e-01; +4.908842801619131e-01   +3.202077932089105e-01   +4.023830050170376e-01   +1.741563614226942e-01   +1.778101335907860e-01   +4.071238555934497e-01   +3.302488165829378e-01   +1.447540300057733e-01   +5.093403118673535e-01];
L5_L2_iGABA_netcon = [+1.913868906036758e-02   +3.985117967772344e-01   +2.227935006400535e-01   +4.649466129410341e-01   +7.983109544993161e-02   +8.924494234556388e-02; +5.506414394874544e-01   -5.566283405109063e-02   +2.051270723762926e-01   +1.156282557900825e-02   +4.772276082919986e-01   +3.110757233150951e-01; +1.246412769154057e-01   +4.150361130346384e-01   +3.007605546096562e-01   +1.131096512008161e-01   +1.450267314499321e-01   +3.445848061309731e-01; +1.091379183074469e-01   +2.228645673456683e-01   +3.101444815543836e-02   +9.138774820514048e-02   +1.325703711399493e-01   +3.825444816465670e-01; +1.533187399147140e-01   +6.892710482976377e-02   +4.471307057813981e-01   +4.090899784513361e-01   +3.849915340527589e-01   +3.516961522641033e-01; +4.175349497809437e-01   +3.420560288963042e-01   +3.619531196853609e-01   +3.378084260420744e-01   +3.326292064944839e-02   +1.470501900973509e-01; +1.532425903486903e-01   +5.116071256324440e-01   +1.862043070489694e-01   +7.219948641395536e-02   +3.593581076575714e-01   +3.008164894140727e-01; +1.141987148978643e-01   +5.312861121218633e-01   +1.462946149606127e-01   +1.279202792701192e-01   +2.698640377311596e-01   +2.675061919678592e-01; +3.151345588577708e-01   +1.322897750427139e-01   +1.367490242988811e-01   +4.543007395011658e-01   +5.291941971957922e-01   +2.466002053484155e-01];
L3_L2_iAMPA_netcon = [+2.248929738926959e-01   +4.585587679252734e-01   +1.322329433005804e-01   +2.821134113050964e-01   +4.691510527365274e-01   +4.657598700115773e-01; +1.047208030813831e-01   +1.239699761594949e-01   +3.899031244994888e-01   +1.348496155822428e-01   +4.768163495883201e-03   +1.799951910808171e-02; +3.827451755829678e-01   +1.377252648733887e-01   +2.276981904314098e-01   +4.103441652132770e-01   +2.255945376244946e-01   -6.013075469762490e-02; +1.084688090282678e-01   +2.416542978219397e-01   -1.703910964720224e-02   +3.578694582205669e-01   +8.136519107661980e-02   +2.954320132067011e-01; +2.028798360324074e-01   +8.874717389507755e-02   -1.727497293272379e-02   +4.700337471799330e-01   +1.588160758925904e-01   +5.179247302130345e-01; +1.050035330037212e-01   +4.080931261234916e-01   +7.315419792903252e-02   +4.822774145871684e-01   +3.664916443350341e-01   +3.501670859178844e-01; +2.005720145454324e-01   +7.572327949348112e-02   +3.311075296037300e-01   +2.721953744387638e-01   +2.790650991609012e-01   +1.459513801014352e-01; +2.814267959797570e-02   +1.256300310854248e-01   +4.905265308734917e-01   +8.677588131674732e-02   +4.488014371846010e-01   +1.315816630845140e-01; +4.888636132927531e-01   +4.733677376756271e-01   +1.172432233615989e-01   +1.468566293330248e-02   +4.242692944275107e-01   +2.838997800407075e-01];
L2_L3_iGABA_netcon = [+2.803274511430536e-01   +9.617797969685936e-02   +3.102892406133559e-01   +3.603321661890271e-01   +4.421593579793243e-01   +2.444450624730449e-01   +4.385416219687724e-01   +1.079719603989109e-01   +1.400954436635819e-01; +4.190258745753709e-01   +4.821672400561829e-01   +2.111393895851246e-02   +4.475265972637689e-02   +3.767264087540140e-01   +6.987104613193892e-03   -3.224068591801778e-02   +2.776618047990330e-01   +1.897320163010564e-01; +1.446179129912975e-01   +2.653829378954568e-01   +3.243721287140661e-01   +4.195042138061313e-01   +3.816762174191947e-01   +1.785430268738142e-01   +1.369100227298698e-01   +2.175799375405387e-01   +4.823185409357941e-01; +1.247296362028588e-01   +6.489938365164513e-02   +1.461389670131976e-01   +1.569823138025089e-01   +4.034566648852871e-01   +4.268739450313597e-01   +8.674420682656986e-02   +2.688151626074746e-01   +4.748400632478265e-01; -4.638908887557264e-02   +4.022081890125253e-01   +4.794004415404621e-01   +1.746747590132285e-01   +1.957638603203032e-01   +4.118304020651564e-02   +4.271928066444472e-01   -2.668492275864867e-03   +1.580480627681984e-01; +3.264358702110542e-01   +4.127552769847625e-01   +1.401242819499845e-01   +3.624416395287706e-01   -4.190964284154174e-03   +2.437307291212282e-01   +1.001883162677043e-01   +3.234732369063243e-01   +2.278057046315344e-01];
L1_L4_iGABA_netcon = [+1.680701781557063e-01   +2.947232850235124e-01   +4.021182747154541e-01   +3.840730349367764e-01   +1.433879325853707e-01   +3.247004615137369e-01   -4.176838747418074e-03   +1.653713823027032e-01   +5.519738840284689e-01; +4.241450473665707e-01   +2.215611556602005e-01   -7.157103419409776e-03   +1.361398430912528e-01   +8.978819496278455e-02   +3.078047894925274e-01   +1.242477869983686e-01   +2.176728606639250e-01   +4.674568410964231e-01; +2.939552742621348e-02   +1.738685796160183e-01   +3.947884421868054e-01   +3.706388396686554e-01   +2.145808023356800e-01   +1.813025051256555e-01   +3.463456138257164e-01   +2.919075477656380e-01   +4.002466002651526e-01; +4.201188168841749e-01   +4.614586472502970e-01   +1.616148282404956e-01   +2.544189664751816e-01   +3.020080361939255e-01   +4.824659111206778e-01   +5.226670963526205e-01   +7.825346768782243e-02   +2.633439777253965e-02; +3.058909215323271e-01   +2.465930963522208e-02   -1.324427756555876e-02   +5.411842597505229e-02   +4.625927827337802e-01   +1.501629030871266e-01   +9.103092808640327e-02   +9.730045839070806e-02   +2.993489473026846e-01; +2.318283630873334e-01   +3.554417650723825e-01   +2.966466379829517e-01   +6.394378208949432e-02   +8.328923630542140e-02   +1.038095206839453e-01   +2.981231843590297e-01   +1.122122710062340e-01   +4.729441834486312e-02; +8.791621606029795e-02   +4.155367580493132e-01   +3.028647336500666e-01   +3.496452219825472e-01   +7.064748625374508e-02   +1.464301290555031e-01   +6.764200420528284e-02   +3.440965798983351e-02   +4.791425769227029e-01; +3.255815137706977e-01   +3.175823927764916e-02   +3.985517670539250e-01   +3.036579007923099e-01   +2.483245938484726e-01   +3.018816516548546e-01   +1.640476462355488e-01   +1.775169108879032e-01   +1.352176972747819e-01; +2.181206839453766e-01   +1.723932591218308e-01   +2.159817764620455e-01   +2.735034128312713e-01   +8.072988061160516e-02   +3.048419936483055e-01   +1.125141039469386e-01   +2.823170978031539e-01   +4.994065319551261e-01; +6.624539454278239e-02   +1.632344483535386e-01   +3.960667565036037e-01   +1.762231244628626e-01   +4.160046922029131e-01   +1.673747923318255e-01   +3.297611135441569e-01   +1.602616456418144e-01   +2.829048806549251e-01; +8.039487714787960e-02   +2.054867016197310e-01   +4.753200742327570e-02   +4.490840149806831e-01   +4.885174416041062e-01   +4.215710005106253e-01   +9.246075419642094e-02   +2.732481105349474e-01   +3.502769962097662e-01; +2.642172080102215e-01   +4.791148128016486e-01   +2.804212053263205e-01   +2.973824481200217e-01   +1.744617603404025e-01   +1.303725378491037e-01   +8.221203286574463e-02   +5.132615613889750e-02   +4.236325379750449e-01];
L4_L1_iGABA_netcon = [+3.220716616606434e-01   +2.157270264799374e-01   +5.482231713997796e-02   +2.743656295911224e-01   +1.350885796577553e-01   +7.115555541586416e-02   +2.915840363830649e-01   +3.228325472191580e-01   +1.313527262253235e-03   +1.178101910607054e-01   +2.830609373593612e-01   +4.600952401955155e-01; +1.011002643384601e-01   +1.688220419057276e-01   +4.478439000868455e-01   +5.966259588487826e-02   +5.102885111849705e-02   +4.289687870181009e-01   +7.889798094536168e-02   +4.474433788701668e-01   +4.446715601923558e-01   +4.162151057948111e-01   +7.417507685734544e-02   +4.836334584170922e-01; +2.026567786495990e-02   +1.789083408563804e-01   +1.613155926612128e-01   +4.090603857209553e-01   +1.688684976079474e-01   +1.173899092460008e-01   +3.340166380550984e-01   +5.075835638507841e-01   +4.145764371359008e-01   +2.508702499253414e-02   +2.827690881381446e-01   +1.206769684159946e-01; +1.695164929723479e-01   +5.350812237176010e-02   +4.553366807010811e-01   +4.953179304808535e-01   +1.383184114683682e-01   +3.681965694960584e-01   +3.285650674282780e-01   +5.529523854670103e-01   +4.722452149974102e-01   +1.596045885739960e-01   +5.111480937201373e-01   +2.860608446625208e-01; +2.382590469886013e-01   +9.009110325025974e-02   +7.104810612072548e-02   +4.422855604931739e-01   +1.059567925891498e-01   +1.955694436818727e-01   +2.761073413849465e-01   +2.283062976914511e-01   +4.341153496485802e-01   +2.437337767616132e-01   +2.107551073284665e-01   +1.137514583806677e-01; +6.128317054504118e-02   +5.101791223183172e-01   +3.833842505201852e-01   +5.141404375016095e-01   +1.987539325487484e-01   +1.759921795466201e-01   +3.635442577892479e-01   +5.147542694901535e-01   +1.414351275957578e-01   +2.674408594407093e-01   +3.815891214435090e-01   +4.255876913432412e-02; +1.924026838755812e-01   +8.854666504310607e-02   +3.827774486304164e-01   +3.593919591852596e-01   +4.817922039030054e-01   +3.628309895104672e-01   +1.657553274209403e-01   +3.030582630703694e-01   +2.787905038509912e-01   +4.757308637857068e-01   +1.804908165275360e-01   +3.248243058150357e-01; +1.482004397878423e-01   +2.000655752994631e-01   +3.947751034052840e-02   +2.208323770849473e-01   +8.681871346311142e-02   +1.591504409705297e-01   +1.767506587448110e-01   +4.168749361717470e-01   +3.093029142864571e-01   +9.773011371046623e-02   +5.327645111351487e-01   +3.954775345227955e-01; +2.093214697421358e-01   +2.735971259755198e-01   +5.284299661264416e-01   +4.698697031786707e-01   +3.208526656285299e-01   +2.627399568461214e-01   +2.434829936119989e-01   -1.070604991946327e-02   +3.165288851072947e-01   +5.850945783264597e-02   +1.769400929828628e-01   +1.411925207896363e-01];
L1_L3_iAMPA_netcon = [+2.775794106406634e-01   +3.819797679277449e-01   +3.588125918201295e-01   +1.936513015282755e-02   +4.022809771747596e-01   +4.423043499386559e-01   +7.037902162084121e-02   +2.338269078236755e-01   +4.295904281018968e-01; +2.061379379753771e-01   +4.272944292774343e-01   +3.968642315337362e-01   +4.439453615547930e-01   +5.583453893001858e-01   +4.384318811237711e-01   +4.703425170765385e-01   +6.205729107783126e-02   +3.541447761146262e-01; +4.769707168918060e-01   +3.685707396798139e-01   +1.891623420401554e-01   +3.489349466023263e-01   +3.455303407844874e-01   +3.126790019121707e-01   +2.476849655531831e-01   +4.583960915101005e-01   +2.572373728585729e-01; +8.777051253914159e-02   +4.181009414177945e-01   +2.116644883871875e-01   +3.292742144584755e-01   +3.708677842239832e-01   +4.716793170797995e-02   +1.261074365831555e-01   +3.447436564821043e-01   +4.323160130286527e-01; +3.443943391814823e-01   +8.308914976560863e-02   +3.623383254709492e-01   +3.010098856832329e-01   +4.370450434091672e-01   +7.158157984034315e-02   +2.528023579105036e-01   +4.761166121212320e-01   +3.333375026546417e-01; +1.611418432151946e-01   +9.975698259057242e-02   +6.284498453271052e-02   +4.031204721062694e-01   +5.397797156546321e-01   +2.847802417173838e-01   +5.083457187975517e-02   +2.759214709326406e-01   +3.434701616525270e-01];
L3_L1_iGABA_netcon = [+8.425759984041988e-02   +1.352381272739683e-01   +3.435192366870831e-01   +2.228446496340268e-01   +3.171782614302138e-01   +4.708532538823770e-01; +4.281699204117979e-01   +4.804416089621827e-01   +1.952520896234348e-01   +2.963047937884764e-01   +1.358962875290600e-01   +3.754197400020607e-01; +3.936844514270759e-01   +4.370082094812923e-01   +2.934134118087099e-01   +5.014458550381216e-01   +1.858754043947958e-01   +1.723787429940802e-01; +3.165301802283844e-01   +4.615048276531745e-01   +3.987188243458702e-01   +4.387251330084215e-01   +1.568800185959306e-01   +2.460814307077842e-01; +2.546545515315951e-01   +3.711445969542152e-01   +1.331207422347176e-01   +2.993431058059429e-01   +1.270934106551676e-02   +9.650227037700472e-02; +2.852104022383582e-02   +3.283703874987940e-01   +5.228996077820546e-01   +9.532740668636187e-02   +2.572983687057367e-02   +2.383502248823515e-01; +5.066994966994116e-02   +4.914512676803325e-01   +2.395330228768680e-01   +1.651634180311982e-01   +3.272905821349498e-01   +3.072173845607810e-01; -1.419189114502574e-02   +2.038480343124369e-01   +4.691722847274226e-01   +2.674899000576138e-01   +8.543569766248763e-02   +2.136863383628610e-01; +2.912246607810672e-02   +4.998556571867652e-01   +2.373751264005152e-01   +1.639386875525539e-01   +3.615354639368581e-01   +3.957302097742316e-01];
L5_Input1_iAMPA_netcon = [+1.853152287473672e-01   +1.979235076183762e-01   +3.386664598850923e-01   +2.294701678229341e-01   -1.585889936573241e-02   +2.854331411087182e-01];
L6_Input2_iAMPA_netcon = [+2.820479854974705e-02   +4.464564444549978e-01   +2.643901601408808e-01];
L5_L6_iAMPA_netcon = [+5.341567739805455e-01   +7.510379736245970e-02   +4.163331781127285e-01   +3.200107147719715e-01   +4.490349003814045e-01   +3.038771249531139e-01; +2.436044486644521e-01   +5.912537600417644e-02   +2.919474447821207e-01   +1.816057524720510e-01   +1.138138130453163e-01   +3.971478568633351e-01; +4.808168078943905e-01   +6.120599812991200e-02   +1.688018708324721e-01   +1.567903789985068e-01   +4.421977842404560e-02   +2.690668411041203e-01];
L4_L5_iAMPA_netcon = [+3.618140512195800e-01   +4.718090231463820e-01   +1.425710105152046e-01   +9.141099176979448e-02   +1.145155541139739e-01   +5.062727225540183e-02   +2.029208977215678e-01   +2.441212061170464e-01   +1.700736334761766e-01   +2.511263222269311e-01   +1.296405307372694e-01   +6.891666145174397e-02; +4.766703947035625e-01   +7.510830066386659e-02   +2.563341175322302e-01   -2.569020506312206e-02   +7.828566518620460e-02   +1.870333256488787e-01   +3.528755006917397e-01   +2.440017994007902e-01   +5.340734288593070e-02   +7.071430249908006e-02   +3.094036158390443e-02   +4.956454943417848e-01; +7.221098031868925e-02   +2.623887026271386e-01   +7.601725439437851e-02   +1.664541429309687e-01   +4.721278969856869e-01   -2.546133108688661e-02   +2.479026875065676e-01   +4.268639624021274e-01   +2.474062475437244e-01   +6.105990527618881e-02   +3.166334371886157e-01   +3.725632542756188e-01; +3.358483008047374e-01   +2.616218367585096e-01   +3.983176435972618e-01   +3.209281710590425e-01   +3.393031342916236e-01   +3.031328409375084e-02   +3.860077315091448e-02   +3.528970969179429e-01   +9.390159604651804e-02   +2.352294057548874e-01   +1.661330108252932e-01   +4.599350343144386e-01; +4.193079173341504e-01   +2.981266356164856e-01   +5.079804591592838e-01   +1.163175473787202e-01   +2.562881230599196e-01   +4.591936601299124e-01   +4.543025034987166e-01   +5.071672802027603e-01   +5.591281572954009e-01   +2.696862590507066e-02   +1.428367944941717e-01   +4.373441422070523e-01; +2.208123354195140e-01   +4.237341659681435e-01   +9.014576249892040e-02   +3.088001600860805e-01   +4.205564253927925e-01   +4.940811094136117e-01   +1.680310342941005e-01   +2.761549837346872e-01   +5.097772011012275e-01   +3.451919727202600e-01   +5.690195208193067e-01   +3.400911569568433e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iGABA_s_last =  p.L2_L3_iGABA_IC+p.L2_L3_iGABA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iGABA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iGABA_s(1,:) = L2_L3_iGABA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iGABA_IGABA = zeros(nsamp,p.L2_Npop);
  L2_L3_iGABA_IGABA(1,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA));
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((-(((p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s_last*L2_L3_iGABA_netcon).*(L2_v_last-p.L2_L3_iGABA_EGABA))))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t<50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iGABA_s_k1 = -L2_L3_iGABA_s_last./p.L2_L3_iGABA_tauGABA + ((1-L2_L3_iGABA_s_last)/p.L2_L3_iGABA_tauGABAr).*(1+tanh(L3_v_last/10));
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iGABA_s_last = L2_L3_iGABA_s_last+dt*L2_L3_iGABA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=0&L3_v(n-1,:)<0));
  conditional_indx=(any(L3_v_last>=0&L3_v(n-1,:)<0));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=0&L2_v(n-1,:)<0));
  conditional_indx=(any(L2_v_last>=0&L2_v(n-1,:)<0));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=0&L1_v(n-1,:)<0));
  conditional_indx=(any(L1_v_last>=0&L1_v(n-1,:)<0));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iGABA_s(n,:) = L2_L3_iGABA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iGABA_IGABA(n,:)=(p.L2_L3_iGABA_gGABA.*(L2_L3_iGABA_s(n,:)*L2_L3_iGABA_netcon).*(L2_v(n,:)-p.L2_L3_iGABA_EGABA));
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
