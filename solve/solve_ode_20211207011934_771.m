function [T,L1_v,L1_iNa_m,L1_iNa_h,L1_iK_n,L2_v,L2_iNa_m,L2_iNa_h,L2_iK_n,L3_v,L3_iNa_m,L3_iNa_h,L3_iK_n,L4_v,L4_iNa_m,L4_iNa_h,L4_iK_n,L5_v,L5_iNa_m,L5_iNa_h,L5_iK_n,L6_v,L6_iNa_m,L6_iNa_h,L6_iK_n,Input1_v,Input1_iNa_m,Input1_iNa_h,Input1_iK_n,Input2_v,Input2_iNa_m,Input2_iNa_h,Input2_iK_n,L2_L1_iGABAa_s,L1_L2_iAMPA_s,L2_L5_iAMPA_s,L5_L2_iGABA_s,L3_L2_iAMPA_s,L2_L3_iAMPA_s,L1_L4_iGABA_s,L4_L1_iGABA_s,L1_L3_iAMPA_s,L3_L1_iGABA_s,L5_Input1_iAMPA_s,L6_Input2_iAMPA_s,L5_L6_iAMPA_s,L4_L5_iAMPA_s,L1_v_spikes,L2_v_spikes,L3_v_spikes,L4_v_spikes,L5_v_spikes,L6_v_spikes,Input1_v_spikes,Input2_v_spikes,L1_L2_iAMPA_IAMPA,L1_L3_iAMPA_IAMPA,L1_L4_iGABA_IGABA,L2_L1_iGABAa_IGABAa,L2_L3_iAMPA_IAMPA,L2_L5_iAMPA_IAMPA,L3_L1_iGABA_IGABA,L3_L2_iAMPA_IAMPA,L4_L1_iGABA_IGABA,L4_L5_iAMPA_IAMPA,L5_Input1_iAMPA_IAMPA,L5_L2_iGABA_IGABA,L5_L6_iAMPA_IAMPA,L6_Input2_iAMPA_IAMPA,L2_L1_iGABAa_netcon,L1_L2_iAMPA_netcon,L2_L5_iAMPA_netcon,L5_L2_iGABA_netcon,L3_L2_iAMPA_netcon,L2_L3_iAMPA_netcon,L1_L4_iGABA_netcon,L4_L1_iGABA_netcon,L1_L3_iAMPA_netcon,L3_L1_iGABA_netcon,L5_Input1_iAMPA_netcon,L6_Input2_iAMPA_netcon,L5_L6_iAMPA_netcon,L4_L5_iAMPA_netcon]=solve_ode

% ------------------------------------------------------------
% Parameters:
% ------------------------------------------------------------
params = load('params.mat','p');
p = params.p;
downsample_factor=p.downsample_factor;
dt=p.dt;
T=(p.tspan(1):dt:p.tspan(2))';
ntime=length(T);
nsamp=length(1:downsample_factor:ntime);

% random_seed was set to shuffle earlier. 

% ------------------------------------------------------------
% Fixed variables:
% ------------------------------------------------------------
L2_L1_iGABAa_netcon = [+5.633413742977972e-01   +4.036691225418134e-01   +1.642131532113705e-01   -2.058434905758860e-01   +2.533186908538638e-01   +4.130523145169159e-01   -1.832716494874199e-01   -7.572781726392719e-02   -1.452744083338705e-01; +4.272751108859128e-01   +9.478268700279653e-02   -2.020410034183963e-01   -9.603533080351513e-02   +1.930324257355443e-01   +4.011065081623346e-01   +1.091026371665351e-01   +1.887017391954964e-01   +3.860785745767294e-01; +2.023558953710644e-02   +1.170194693033677e-01   +1.079362471792445e-01   -1.450887827108055e-01   -1.376892762702373e-01   +4.929650559289391e-01   +6.751135039475240e-02   +6.778406354967564e-01   -9.078868358608030e-02; +1.850671489015391e-01   +4.783152939318710e-01   +2.626553469234680e-01   +1.728372004481745e-01   +4.453401429216620e-01   +6.827417103240752e-01   -2.405098195003169e-01   +6.439050073206138e-01   +3.828160839411934e-01; +2.261079244088210e-01   +1.092547679216722e-01   +3.249372442710270e-01   +5.576621946581026e-01   +4.133614565663264e-01   +2.075055716185754e-01   +3.856773368608063e-01   -3.164743335778292e-03   -5.385754405838623e-02; +4.115537705551579e-01   +4.080921639468752e-01   +4.914688606056888e-01   -9.342504538844790e-02   +5.296679506224500e-01   +3.590415375339789e-01   -1.165538399982466e-01   +7.650202094933178e-02   +6.427550315030433e-01; +1.049362937953745e-01   +3.228375652153548e-01   -1.185263598598574e-01   +6.077850971060031e-02   -2.358849246206623e-01   +1.384732785164217e-02   +6.351738692934471e-01   +5.366714100200479e-02   +1.481699520363422e-01; -2.574713353975724e-02   -1.462529908581837e-01   -9.115468208208038e-02   -9.046990048093048e-02   +2.841089190674925e-03   +5.039956107205843e-01   +1.517939640923642e-01   -1.822667795869034e-01   +4.449880106642181e-01; -2.671059613771509e-02   +4.857186703114540e-01   +5.835342528942713e-01   +3.361925882373006e-01   +3.772331387266864e-02   +6.087135493535205e-01   +2.423411498639100e-01   +2.035693198906514e-01   -2.104379662567158e-01];
L1_L2_iAMPA_netcon = [+2.125432242572408e-01   +1.704858918007764e-02   -1.328054545820523e-01   +1.186760549241717e-01   -2.792915535708819e-01   +1.679582433890180e-01   +3.438172723351481e-01   +4.195602826388214e-01   +2.251899306542224e-01; +4.706367102715696e-01   -1.694163006346527e-02   +2.238204325675832e-01   +1.423847534438339e-01   +5.117695389537075e-01   -3.912342700409583e-02   +9.581000304153328e-02   +7.900183968188119e-02   +6.112882247106071e-01; +3.290960611177779e-01   +4.804486984245572e-01   +4.740851363571060e-01   +3.342277143235716e-01   +5.466191730678479e-01   -1.166687988395750e-01   +2.165051560927251e-01   +3.714859499910987e-01   +1.721674197608349e-01; +2.408752681191192e-01   +1.524948898151864e-01   +2.844636736029527e-02   +9.257700113084422e-02   +6.053236080719311e-01   +3.743850353182164e-01   -9.760374633216448e-02   +1.034859706783666e-01   -1.844179105620126e-01; -1.562033894008441e-03   -2.044930387422302e-01   +1.475519966861366e-01   +2.827294285143130e-01   +2.589510989450737e-01   +3.921115859244697e-01   +1.667928714804893e-01   +7.427697516691760e-02   +1.431939574734447e-01; -1.619613856356342e-01   -6.814170902235017e-03   -2.285686840438395e-01   +6.326018244708786e-01   +4.837735525321245e-01   -1.830599337893970e-01   +3.927597129115519e-01   +3.432865398610785e-01   -8.947245024468614e-03; +1.018268200266501e-01   +5.248870839446140e-02   +5.806604205034425e-01   +6.071999156272185e-01   +1.554351757938225e-01   -8.142610243200826e-02   -1.032490399033294e-01   +1.070187306317827e-01   +4.527657980294487e-01; +6.081468662443479e-01   +3.807180174103456e-01   -9.346852318661168e-02   +6.273869716832032e-01   +3.163923155387500e-01   +5.752411950112556e-01   +5.766407462890457e-01   +5.170222690424049e-01   +9.697158591525101e-02; -1.956201117714359e-01   -1.871377105788567e-02   +4.525828520806785e-01   -3.899859563775316e-02   +6.739113051724778e-01   -1.016335758545255e-01   +4.353549481162560e-01   +2.316176895732552e-01   +2.755047153285700e-01];
L2_L5_iAMPA_netcon = [+6.024750052099442e-01   +3.836117231348956e-01   +1.370800659593710e-02   +6.453066713061136e-01   +4.295335088205847e-01   +2.744796328548527e-01   -1.364200027868245e-02   +3.028167869689178e-01   +4.892512335500970e-02; +4.293009970328036e-01   +5.876567159413637e-02   -1.290928759708779e-01   +4.741566537813131e-01   -1.518908201641863e-01   -1.960310447933606e-01   +3.854133613316487e-01   +1.716842685281777e-01   +5.231872417510137e-01; +2.484930315105131e-01   +2.312149257191953e-01   +5.195714633620983e-02   +3.735607892579730e-01   +3.437126161222822e-01   +5.633069473060158e-01   +4.209077086360047e-01   -2.743508220899216e-01   +3.719128007280043e-01; +6.370678600587010e-01   +3.720491976908599e-01   +6.873963453397228e-01   +5.933314759253788e-01   +2.127957572437841e-01   +5.383672040547244e-01   -1.092878307917516e-01   +3.089000875906038e-01   -2.020516062154407e-02; +1.995364596906018e-01   +4.155521496986631e-02   -1.299336588183089e-01   -1.354702735894620e-01   -2.205707734820283e-01   -1.403845875223131e-01   +8.963768475150902e-02   +8.818647102798929e-02   +2.010852534311278e-01; -1.867651350204932e-02   -1.386683067550755e-01   +3.984203602826182e-01   +4.983648628755506e-01   +2.011659456387514e-01   +5.030973239326588e-01   +1.815246230129923e-01   +3.160844134888171e-01   +5.198359854214915e-01];
L5_L2_iGABA_netcon = [+2.864881056764411e-01   +8.161816034796487e-03   -1.839594531294643e-01   -1.548760888084622e-02   +1.498414123862828e-01   +2.720654016410048e-01; +3.833357082981954e-01   +4.839935375671439e-01   +1.708427013844804e-02   +1.334862445564048e-01   -1.653942126051168e-01   +2.990268371972892e-01; +8.147868698857447e-02   +7.059539063972720e-01   -1.444359964723093e-01   +4.563260940038261e-01   -1.389864611411112e-01   +3.474178064073950e-01; +5.364875995743773e-01   +5.791571163867089e-01   +7.024869966988786e-01   +9.391939534269889e-02   +4.231571855438711e-01   +5.153210713578644e-01; -4.716387601909264e-02   +1.313053721749824e-01   +6.089003887318526e-01   +4.022131883485277e-01   +5.396760813485913e-02   +5.994617292522169e-01; +3.822747202323138e-01   +1.848935304274717e-01   +3.165615354982133e-01   +1.138205322288342e-01   +5.992283374457764e-01   -5.612488998537531e-02; +7.394199223505839e-02   +4.342779301146236e-01   -3.118909892224107e-02   +5.454136248219176e-01   +5.463929997434660e-01   +4.732511138121739e-01; +1.224343382638264e-01   +4.587541818275690e-01   +5.901936266114447e-01   +1.083387524052811e-01   +2.282777351086914e-01   +2.625229850407171e-01; +1.934028266563472e-01   -2.877406638572224e-01   -7.083435463897449e-02   +4.007955783087040e-01   +2.708082166467822e-01   +5.324186070545505e-01];
L3_L2_iAMPA_netcon = [+1.532922776494192e-01   +3.410268072234406e-01   +6.649576749370055e-01   -8.135105575334316e-02   +1.281837540480452e-02   +5.590845448882010e-01; -2.671940386070147e-02   -7.821646505150365e-02   +1.862706354973073e-01   +2.305913131484967e-01   +7.713929661735627e-02   +3.780414912370350e-01; +1.856357450084434e-01   -1.986985036175304e-01   -3.904427398036583e-02   -1.316914731480184e-01   +4.350843744614428e-01   -1.259120549924465e-01; +4.099203409398161e-02   -1.004661600398409e-01   +2.514678705113199e-02   +1.589578964461259e-01   +5.244143213753143e-01   +2.424676880591862e-01; +2.800838792743413e-01   +2.789530242327258e-01   -5.848108720742337e-02   +6.975937525748838e-02   +3.644335244706173e-01   -1.743149555670268e-01; -1.415540495355886e-01   +4.474298375654036e-01   +9.598545619656462e-02   +1.775491269710498e-01   -5.319181320652344e-03   +1.107993802818544e-01; +3.855588848473659e-01   +3.826386031502055e-01   -2.024766323395264e-01   +5.393995978924928e-01   +2.555168837007497e-01   -2.342471762945156e-02; +4.717896860500034e-01   +6.468628436093028e-02   +9.470358276433852e-02   +3.153394975159051e-01   +4.399878659183432e-01   +4.898866322393780e-01; -1.173736229040350e-01   +9.618317467178264e-02   +3.302974885526758e-01   +4.320772426954412e-01   +5.617790944802289e-01   +4.199434391394410e-02];
L2_L3_iAMPA_netcon = [+1.921559258108624e-01   +3.514656202127928e-01   +4.493755494107722e-01   +5.312362944496041e-01   -7.845209155337871e-02   -2.309382480156629e-01   -1.463668416535956e-02   +6.189512362181421e-01   +4.484722905229043e-01; +6.960875180904880e-01   +8.302178225602359e-02   -1.570206096091117e-01   +9.486486975670499e-02   +5.148873251413462e-01   +3.051583320579899e-01   +4.216942861997249e-01   -1.701323582345836e-01   -2.874984636867391e-02; +2.678260577485376e-01   +2.200379338572941e-01   +3.604360696902400e-02   +1.685402176024928e-01   -1.987799188410297e-02   -2.506338249046514e-01   +1.805383508538524e-01   +5.079165179225482e-01   +4.259689384984439e-01; +3.622620934421545e-01   +7.259776500930010e-02   +1.289546656547396e-01   +4.517341913579127e-01   +2.819602160770514e-01   +7.013100927182383e-01   -3.447082137383002e-02   +6.352855558824144e-01   +6.136078887025510e-01; +4.704480926513797e-01   -2.662317588771628e-01   -8.836698378045975e-02   +6.144425234984553e-01   +3.044045063460862e-01   +4.569702506373128e-01   +1.850645117805721e-01   +3.979690674031979e-01   -1.286421968264070e-01; +5.433373356991734e-01   +5.897601486029787e-01   +2.086182277477496e-01   +3.067593518457232e-01   +3.418631894467145e-01   -2.410842322630971e-03   -1.162422000872005e-01   +1.584455710851416e-01   +1.503983351990656e-01];
L1_L4_iGABA_netcon = [-1.321623224535331e-01   +6.389812599803248e-01   +1.032039628746278e-01   +2.125210494761231e-01   +2.939824383579740e-01   +1.097980193993427e-01   -1.288545223152221e-03   +5.222210233370429e-01   +3.500608307876243e-01; +4.779002607572735e-01   -2.123813656723546e-01   +4.561002648986529e-01   +3.778222654155187e-01   +4.762752251480031e-01   +6.043241096074826e-01   +4.147672383259289e-01   +4.196821528794276e-01   +2.530280756810485e-01; +1.217751155789894e-01   +2.017438493617390e-01   +8.179063641147778e-02   -7.849072887071144e-02   +2.864368181803540e-01   +3.515609902388722e-01   +2.162093011545782e-02   +4.948882161086147e-01   +6.036517166475431e-01; +3.821087111084647e-01   -2.361021164807098e-01   +1.589791982994192e-01   +4.087685754964944e-01   -8.187757574182389e-02   +4.175041904753421e-01   -4.100424791712108e-02   -1.074374317198669e-01   +6.831485896048239e-01; +3.629131110771996e-01   +2.197066938901399e-01   -3.910448333250896e-02   +1.927956331186413e-01   +3.274400248796012e-01   +2.273708706409394e-01   -2.698397317288712e-02   +2.034123390214792e-01   -1.332884449813024e-01; +1.102219732721512e-01   +1.883067301495299e-01   +2.732828662417101e-01   +1.990297974303172e-01   +6.892830799322722e-02   +3.781303066941463e-01   +8.705510407547079e-02   +1.147232673802674e-01   +3.929519189779573e-01; +3.828980983284761e-01   +4.039995374116408e-01   +9.687366368321318e-02   +5.580074828840593e-01   +6.184199261181990e-01   +2.817843781819988e-01   +6.205866827827095e-01   +3.102337182194788e-01   +3.205691443752385e-01; -6.592029109288594e-02   +3.971772699310256e-01   +6.453815828268742e-01   +7.107400213575477e-02   +3.319888632732165e-01   +6.379463037571681e-02   +5.795500610968259e-01   -7.272107177734324e-02   -1.197346527101157e-01; +6.342662630590234e-02   +2.280403432075965e-02   +6.264426871280502e-01   +3.875546775646918e-01   +5.089124836588316e-01   +3.027821852117744e-01   -1.441967568714729e-01   +2.459713153930779e-01   +4.960148542417541e-01; -1.481779864249009e-01   +6.823799326299480e-01   -1.116324608387928e-02   +3.311775505187080e-01   +2.912011327519001e-01   -2.656324607538860e-01   -1.648202105640217e-01   -4.540729584175143e-02   +5.634083638323478e-01; -1.174704809974648e-01   +4.694450889760878e-01   +4.040150991784766e-01   +6.373989769121136e-01   +2.960180729570721e-01   -8.176181008013700e-02   +3.997796936600687e-01   -6.778797058921431e-02   -2.466556390768584e-02; +2.398156814409950e-01   +4.114780581133750e-01   +3.672086541495821e-01   +4.496454405902339e-02   +5.323731355359355e-01   +4.706291174270076e-01   +3.044403684983558e-01   -7.766668198115260e-02   +3.472098444084918e-01];
L4_L1_iGABA_netcon = [+6.246623616526376e-01   +2.991885477702458e-01   +1.784109828089282e-01   +3.398127955248064e-01   +6.151092467035684e-01   +9.324440524800501e-02   +6.727455206298819e-02   -4.201443268671634e-02   -3.169505122291241e-02   +4.624795978803671e-01   +2.505376435415155e-02   +4.976116279716531e-01; +3.343037367933318e-01   -3.338904971520273e-01   +5.156663059453931e-01   +4.483046824441745e-01   -9.312704608768381e-02   +2.736848218143080e-01   +6.418454008422797e-02   -2.176415713785554e-01   +5.089440429716083e-01   +8.583540612762597e-02   -1.179528156844283e-01   +1.959617999557546e-01; +3.514249151514296e-01   -3.075615373214556e-01   +5.317988517134103e-01   +5.380155694930708e-01   +2.071521697770563e-01   +4.843917609162238e-03   +7.142034158509886e-02   -1.352953861900672e-01   +1.942482362183131e-01   +3.942857227455688e-01   +2.714394568802296e-01   +2.004999453021610e-01; +1.505856299681241e-01   +6.503329297057422e-03   +3.881395801192598e-01   +5.115177227908759e-01   +2.330278962325080e-01   +3.149660905866390e-01   +1.821696380405139e-01   +1.107713005155856e-01   +4.504475736863223e-01   +5.469401199315590e-01   +4.981937305016269e-01   +1.722397775833935e-01; -4.368460173721844e-02   +2.168616413521868e-01   +5.957606949511758e-01   +5.139946671090719e-01   +7.307518655373817e-03   +1.318446210828720e-01   +5.232953906534031e-01   +4.208547872226975e-01   -1.523516919332377e-01   +1.518738123357054e-02   +5.220674000116396e-01   -2.134161069230159e-01; -1.942633862866413e-01   +3.172513379395623e-01   +7.701485470796970e-02   +3.532664805339282e-01   -1.818102932531568e-02   +4.725357461471327e-01   +9.917620257909361e-02   +4.544360237066656e-01   +3.627306265742976e-01   +1.536052506817809e-01   -2.024409248827168e-01   -1.596406329623710e-01; +5.023414477434307e-01   +1.127669402137814e-01   +3.808531407556422e-01   +4.267559002864121e-01   +1.389798284411937e-01   +3.234508966443385e-01   -5.233422537832821e-02   -1.531132875068984e-01   +3.177141971455490e-01   +4.698397316073947e-01   +3.073168065303306e-02   +2.791637791475796e-01; -6.538284616910750e-02   +6.236943233937098e-01   -5.568645049013163e-02   +4.217450381060849e-01   +9.987168028099841e-02   -1.692177612410789e-01   +1.015673443156961e-01   +3.708890539686653e-01   +2.984421665088992e-01   +4.264459901351713e-01   -1.339773048021200e-01   +4.123157523202277e-01; -1.155918778383040e-01   -5.636843064586172e-03   +2.636701715248372e-01   -2.266638832207456e-01   -1.449488404362306e-03   +5.181436753968480e-01   +4.380349073867488e-01   -1.659668977157440e-01   +4.505915580298545e-01   +8.055226418341910e-02   +2.309051655938725e-01   -1.203425299322064e-01];
L1_L3_iAMPA_netcon = [-1.857131916472508e-02   +3.170685725124945e-01   +2.280852789428414e-01   -1.748958942022031e-01   -4.707842987050859e-02   -4.419219872864695e-02   +3.868876627164138e-01   -1.471146200967645e-02   +6.254780532344842e-01; +4.566017139894096e-02   +6.187623034462796e-01   +5.519891520752479e-01   +5.031991460638714e-01   +4.527331147637963e-01   +4.123991173108452e-01   +5.873141008454078e-01   -1.062060915835567e-01   +2.341761452216295e-01; +5.732865961988299e-01   +5.428677644490603e-01   +3.782850183449126e-01   +5.468149021597006e-01   +3.080712734098241e-01   +2.499692217918917e-03   +5.015464587358428e-01   -1.631107133995826e-01   +3.328725885855736e-01; +1.630063416637375e-01   -8.273254076120962e-02   +2.118209728869330e-01   -4.208882797446064e-02   +3.544289182690016e-02   +3.724634304603640e-01   -5.101103972297075e-02   -2.198178775573796e-01   +2.010923523696083e-01; +2.944985222812704e-01   +3.394708539784881e-01   +4.547237379393256e-01   +1.203639060694796e-01   +1.792322837757641e-01   +6.039373422411394e-01   -2.486555475377433e-01   +5.261656404415725e-01   -4.732460780766731e-02; -2.253471235229320e-01   +1.261455560334886e-01   +1.791159047519801e-01   +3.984509968958662e-01   -2.874584430083126e-01   +2.140919983188283e-01   +1.735442894475935e-01   +5.649212115244480e-01   -1.512247669455307e-01];
L3_L1_iGABA_netcon = [+5.715912969123913e-01   +1.060590841314079e-01   +2.010138102065969e-01   -1.744292773250725e-01   +6.599956649911757e-01   -1.714659612929369e-01; +1.520499072193410e-01   +5.778429790512496e-01   +5.036898764480165e-03   +6.653912747790756e-02   -8.626260156060762e-02   -7.388622257738976e-02; +3.866181187748536e-01   +4.811620981432210e-01   +5.426749019872030e-01   +2.804236811352758e-01   +1.061515779658737e-01   +2.219447144761794e-01; +1.641488715608899e-01   +2.210404931429988e-01   -3.118562055701243e-02   -6.577615028877995e-02   +1.619807043993013e-01   -2.321868735276460e-02; +1.077989760735952e-01   +2.624960086434276e-01   -3.042086607394932e-02   +4.066244149889288e-01   +4.244560956479284e-01   -9.207356514891134e-02; +5.684402325289911e-01   +1.978186125522385e-01   +4.823515110857653e-01   +4.975127224320789e-01   +5.458558209101703e-01   +4.744916184293335e-01; +1.656005058685411e-01   +4.934097116884837e-01   +3.506825084722127e-01   -1.006765388045189e-01   +5.704206875589766e-01   +2.794509921673407e-01; +1.523795312658190e-01   +9.609054517513586e-02   -1.048301158671055e-01   +1.432593300207439e-01   -2.168312925228756e-02   +5.498112612465863e-01; +1.156580516944486e-01   -1.526262320172246e-01   -9.718718375921112e-02   +2.208477129808596e-01   -2.357258038543351e-01   +3.362407272430007e-01];
L5_Input1_iAMPA_netcon = [+5.283429270691794e-01   +3.286546606119752e-01   -4.011879969498518e-02   +6.021530828310999e-01   +1.019823834512762e-01   -2.441360466988549e-01];
L6_Input2_iAMPA_netcon = [+1.803448707121538e-01   -5.468347242354563e-02   -2.319997248600408e-02];
L5_L6_iAMPA_netcon = [+1.181136244581333e-01   -1.709778358903499e-01   +2.908188511184580e-01   +3.410729620365827e-01   -1.432629721766682e-01   +4.054046506559359e-01; +2.756863549581905e-01   +6.185346603145861e-01   +1.152754920015555e-01   +2.498509571884518e-01   -9.017335182335978e-02   +1.809170690248927e-01; -1.444566135433246e-01   +2.471702501933500e-01   +6.816072220537638e-01   +4.397813705194100e-01   +1.643174844000961e-01   +2.330482747129927e-01];
L4_L5_iAMPA_netcon = [-4.230409743426945e-02   +1.348986081204403e-02   -1.354842388648828e-01   +2.597748765818506e-01   +6.901220631457049e-02   -1.327785091362107e-01   +6.940513002609060e-01   +2.644255409574159e-01   +1.773496750623479e-02   +3.123660498150651e-01   -1.681505430611169e-01   -1.347273741233722e-01; +6.761002174713020e-01   +4.191977580881614e-01   +6.723352925773931e-01   +8.437682148546932e-02   +6.386809147476807e-02   -4.564925970057467e-02   +2.750453506904030e-01   +6.259750356355578e-01   -5.897850900722430e-02   +3.488544317729179e-01   -2.037339800573245e-01   +8.993779960751663e-02; +5.118682080758246e-01   +1.612343414087861e-01   +4.306206641167533e-01   +4.505337446293664e-01   +3.535874598248469e-01   +1.656837474395213e-01   +3.544798943331006e-01   +2.041272394236064e-01   +7.899658695701809e-03   +3.628151108043090e-02   +3.329080501384101e-01   +4.438555337281119e-01; +6.391671422590866e-01   +1.327347181856699e-01   +1.858461318408534e-01   +3.136464525971709e-01   +1.349836842976284e-01   -1.130375105756925e-01   +5.506880813994298e-01   +5.206607202274595e-01   +1.614190946805942e-01   +1.050753344950741e-01   -6.336755617822892e-02   +8.507434920264485e-02; +2.382480185199638e-01   +4.951769500498024e-01   +1.517316058750397e-01   +3.110313362859133e-01   +2.798888634836414e-01   +5.426927503457201e-01   +2.068814568405441e-01   +2.843255821192985e-01   -8.740380079105406e-02   +8.715983919091311e-02   +6.518348443077401e-01   +7.899413081415688e-01; -6.089225576556695e-04   -1.520427063548275e-01   -5.730154965439732e-02   +2.656554033473948e-01   -2.733040751696859e-02   +1.063609712014172e-01   +6.427193693105144e-01   +4.673162090433994e-01   +5.410966313040989e-01   -1.009401248431871e-01   -1.369848112460503e-01   +4.063905144996856e-01];

% ------------------------------------------------------------
% Initial conditions:
% ------------------------------------------------------------
t=0; k=1;

% STATE_VARIABLES:
L1_v_last = zeros(1,p.L1_Npop);
L1_v = zeros(nsamp,p.L1_Npop);
L1_v(1,:) = L1_v_last;
L1_iNa_m_last = p.L1_iNa_m_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_m = zeros(nsamp,p.L1_Npop);
L1_iNa_m(1,:) = L1_iNa_m_last;
L1_iNa_h_last = p.L1_iNa_h_IC+p.L1_iNa_IC_noise*rand(1,p.L1_Npop);
L1_iNa_h = zeros(nsamp,p.L1_Npop);
L1_iNa_h(1,:) = L1_iNa_h_last;
L1_iK_n_last = p.L1_iK_n_IC+p.L1_iK_IC_noise*rand(1,p.L1_Npop);
L1_iK_n = zeros(nsamp,p.L1_Npop);
L1_iK_n(1,:) = L1_iK_n_last;
L2_v_last = zeros(1,p.L2_Npop);
L2_v = zeros(nsamp,p.L2_Npop);
L2_v(1,:) = L2_v_last;
L2_iNa_m_last = p.L2_iNa_m_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_m = zeros(nsamp,p.L2_Npop);
L2_iNa_m(1,:) = L2_iNa_m_last;
L2_iNa_h_last = p.L2_iNa_h_IC+p.L2_iNa_IC_noise*rand(1,p.L2_Npop);
L2_iNa_h = zeros(nsamp,p.L2_Npop);
L2_iNa_h(1,:) = L2_iNa_h_last;
L2_iK_n_last = p.L2_iK_n_IC+p.L2_iK_IC_noise*rand(1,p.L2_Npop);
L2_iK_n = zeros(nsamp,p.L2_Npop);
L2_iK_n(1,:) = L2_iK_n_last;
L3_v_last = zeros(1,p.L3_Npop);
L3_v = zeros(nsamp,p.L3_Npop);
L3_v(1,:) = L3_v_last;
L3_iNa_m_last = p.L3_iNa_m_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_m = zeros(nsamp,p.L3_Npop);
L3_iNa_m(1,:) = L3_iNa_m_last;
L3_iNa_h_last = p.L3_iNa_h_IC+p.L3_iNa_IC_noise*rand(1,p.L3_Npop);
L3_iNa_h = zeros(nsamp,p.L3_Npop);
L3_iNa_h(1,:) = L3_iNa_h_last;
L3_iK_n_last = p.L3_iK_n_IC+p.L3_iK_IC_noise*rand(1,p.L3_Npop);
L3_iK_n = zeros(nsamp,p.L3_Npop);
L3_iK_n(1,:) = L3_iK_n_last;
L4_v_last = zeros(1,p.L4_Npop);
L4_v = zeros(nsamp,p.L4_Npop);
L4_v(1,:) = L4_v_last;
L4_iNa_m_last = p.L4_iNa_m_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_m = zeros(nsamp,p.L4_Npop);
L4_iNa_m(1,:) = L4_iNa_m_last;
L4_iNa_h_last = p.L4_iNa_h_IC+p.L4_iNa_IC_noise*rand(1,p.L4_Npop);
L4_iNa_h = zeros(nsamp,p.L4_Npop);
L4_iNa_h(1,:) = L4_iNa_h_last;
L4_iK_n_last = p.L4_iK_n_IC+p.L4_iK_IC_noise*rand(1,p.L4_Npop);
L4_iK_n = zeros(nsamp,p.L4_Npop);
L4_iK_n(1,:) = L4_iK_n_last;
L5_v_last = zeros(1,p.L5_Npop);
L5_v = zeros(nsamp,p.L5_Npop);
L5_v(1,:) = L5_v_last;
L5_iNa_m_last = p.L5_iNa_m_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_m = zeros(nsamp,p.L5_Npop);
L5_iNa_m(1,:) = L5_iNa_m_last;
L5_iNa_h_last = p.L5_iNa_h_IC+p.L5_iNa_IC_noise*rand(1,p.L5_Npop);
L5_iNa_h = zeros(nsamp,p.L5_Npop);
L5_iNa_h(1,:) = L5_iNa_h_last;
L5_iK_n_last = p.L5_iK_n_IC+p.L5_iK_IC_noise*rand(1,p.L5_Npop);
L5_iK_n = zeros(nsamp,p.L5_Npop);
L5_iK_n(1,:) = L5_iK_n_last;
L6_v_last = zeros(1,p.L6_Npop);
L6_v = zeros(nsamp,p.L6_Npop);
L6_v(1,:) = L6_v_last;
L6_iNa_m_last = p.L6_iNa_m_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_m = zeros(nsamp,p.L6_Npop);
L6_iNa_m(1,:) = L6_iNa_m_last;
L6_iNa_h_last = p.L6_iNa_h_IC+p.L6_iNa_IC_noise*rand(1,p.L6_Npop);
L6_iNa_h = zeros(nsamp,p.L6_Npop);
L6_iNa_h(1,:) = L6_iNa_h_last;
L6_iK_n_last = p.L6_iK_n_IC+p.L6_iK_IC_noise*rand(1,p.L6_Npop);
L6_iK_n = zeros(nsamp,p.L6_Npop);
L6_iK_n(1,:) = L6_iK_n_last;
Input1_v_last = zeros(1,p.Input1_Npop);
Input1_v = zeros(nsamp,p.Input1_Npop);
Input1_v(1,:) = Input1_v_last;
Input1_iNa_m_last = p.Input1_iNa_m_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_m = zeros(nsamp,p.Input1_Npop);
Input1_iNa_m(1,:) = Input1_iNa_m_last;
Input1_iNa_h_last = p.Input1_iNa_h_IC+p.Input1_iNa_IC_noise*rand(1,p.Input1_Npop);
Input1_iNa_h = zeros(nsamp,p.Input1_Npop);
Input1_iNa_h(1,:) = Input1_iNa_h_last;
Input1_iK_n_last = p.Input1_iK_n_IC+p.Input1_iK_IC_noise*rand(1,p.Input1_Npop);
Input1_iK_n = zeros(nsamp,p.Input1_Npop);
Input1_iK_n(1,:) = Input1_iK_n_last;
Input2_v_last = zeros(1,p.Input2_Npop);
Input2_v = zeros(nsamp,p.Input2_Npop);
Input2_v(1,:) = Input2_v_last;
Input2_iNa_m_last = p.Input2_iNa_m_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_m = zeros(nsamp,p.Input2_Npop);
Input2_iNa_m(1,:) = Input2_iNa_m_last;
Input2_iNa_h_last = p.Input2_iNa_h_IC+p.Input2_iNa_IC_noise*rand(1,p.Input2_Npop);
Input2_iNa_h = zeros(nsamp,p.Input2_Npop);
Input2_iNa_h(1,:) = Input2_iNa_h_last;
Input2_iK_n_last = p.Input2_iK_n_IC+p.Input2_iK_IC_noise*rand(1,p.Input2_Npop);
Input2_iK_n = zeros(nsamp,p.Input2_Npop);
Input2_iK_n(1,:) = Input2_iK_n_last;
L2_L1_iGABAa_s_last =  p.L2_L1_iGABAa_IC+p.L2_L1_iGABAa_IC_noise.*rand(1,p.L1_Npop);
L2_L1_iGABAa_s = zeros(nsamp,p.L1_Npop);
L2_L1_iGABAa_s(1,:) = L2_L1_iGABAa_s_last;
L1_L2_iAMPA_s_last =  p.L1_L2_iAMPA_IC+p.L1_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L1_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L1_L2_iAMPA_s(1,:) = L1_L2_iAMPA_s_last;
L2_L5_iAMPA_s_last =  p.L2_L5_iAMPA_IC+p.L2_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L2_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L2_L5_iAMPA_s(1,:) = L2_L5_iAMPA_s_last;
L5_L2_iGABA_s_last =  p.L5_L2_iGABA_IC+p.L5_L2_iGABA_IC_noise.*rand(1,p.L2_Npop);
L5_L2_iGABA_s = zeros(nsamp,p.L2_Npop);
L5_L2_iGABA_s(1,:) = L5_L2_iGABA_s_last;
L3_L2_iAMPA_s_last =  p.L3_L2_iAMPA_IC+p.L3_L2_iAMPA_IC_noise.*rand(1,p.L2_Npop);
L3_L2_iAMPA_s = zeros(nsamp,p.L2_Npop);
L3_L2_iAMPA_s(1,:) = L3_L2_iAMPA_s_last;
L2_L3_iAMPA_s_last =  p.L2_L3_iAMPA_IC+p.L2_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L2_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L2_L3_iAMPA_s(1,:) = L2_L3_iAMPA_s_last;
L1_L4_iGABA_s_last =  p.L1_L4_iGABA_IC+p.L1_L4_iGABA_IC_noise.*rand(1,p.L4_Npop);
L1_L4_iGABA_s = zeros(nsamp,p.L4_Npop);
L1_L4_iGABA_s(1,:) = L1_L4_iGABA_s_last;
L4_L1_iGABA_s_last =  p.L4_L1_iGABA_IC+p.L4_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L4_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L4_L1_iGABA_s(1,:) = L4_L1_iGABA_s_last;
L1_L3_iAMPA_s_last =  p.L1_L3_iAMPA_IC+p.L1_L3_iAMPA_IC_noise.*rand(1,p.L3_Npop);
L1_L3_iAMPA_s = zeros(nsamp,p.L3_Npop);
L1_L3_iAMPA_s(1,:) = L1_L3_iAMPA_s_last;
L3_L1_iGABA_s_last =  p.L3_L1_iGABA_IC+p.L3_L1_iGABA_IC_noise.*rand(1,p.L1_Npop);
L3_L1_iGABA_s = zeros(nsamp,p.L1_Npop);
L3_L1_iGABA_s(1,:) = L3_L1_iGABA_s_last;
L5_Input1_iAMPA_s_last =  p.L5_Input1_iAMPA_IC+p.L5_Input1_iAMPA_IC_noise.*rand(1,p.Input1_Npop);
L5_Input1_iAMPA_s = zeros(nsamp,p.Input1_Npop);
L5_Input1_iAMPA_s(1,:) = L5_Input1_iAMPA_s_last;
L6_Input2_iAMPA_s_last =  p.L6_Input2_iAMPA_IC+p.L6_Input2_iAMPA_IC_noise.*rand(1,p.Input2_Npop);
L6_Input2_iAMPA_s = zeros(nsamp,p.Input2_Npop);
L6_Input2_iAMPA_s(1,:) = L6_Input2_iAMPA_s_last;
L5_L6_iAMPA_s_last =  p.L5_L6_iAMPA_IC+p.L5_L6_iAMPA_IC_noise.*rand(1,p.L6_Npop);
L5_L6_iAMPA_s = zeros(nsamp,p.L6_Npop);
L5_L6_iAMPA_s(1,:) = L5_L6_iAMPA_s_last;
L4_L5_iAMPA_s_last =  p.L4_L5_iAMPA_IC+p.L4_L5_iAMPA_IC_noise.*rand(1,p.L5_Npop);
L4_L5_iAMPA_s = zeros(nsamp,p.L5_Npop);
L4_L5_iAMPA_s(1,:) = L4_L5_iAMPA_s_last;

% MONITORS:
L1_tspike = -1e32*ones(2,p.L1_Npop);
L1_buffer_index = ones(1,p.L1_Npop);
L1_v_spikes = zeros(nsamp,p.L1_Npop);
L2_tspike = -1e32*ones(2,p.L2_Npop);
L2_buffer_index = ones(1,p.L2_Npop);
L2_v_spikes = zeros(nsamp,p.L2_Npop);
L3_tspike = -1e32*ones(2,p.L3_Npop);
L3_buffer_index = ones(1,p.L3_Npop);
L3_v_spikes = zeros(nsamp,p.L3_Npop);
L4_tspike = -1e32*ones(2,p.L4_Npop);
L4_buffer_index = ones(1,p.L4_Npop);
L4_v_spikes = zeros(nsamp,p.L4_Npop);
L5_tspike = -1e32*ones(2,p.L5_Npop);
L5_buffer_index = ones(1,p.L5_Npop);
L5_v_spikes = zeros(nsamp,p.L5_Npop);
L6_tspike = -1e32*ones(2,p.L6_Npop);
L6_buffer_index = ones(1,p.L6_Npop);
L6_v_spikes = zeros(nsamp,p.L6_Npop);
Input1_tspike = -1e32*ones(2,p.Input1_Npop);
Input1_buffer_index = ones(1,p.Input1_Npop);
Input1_v_spikes = zeros(nsamp,p.Input1_Npop);
Input2_tspike = -1e32*ones(2,p.Input2_Npop);
Input2_buffer_index = ones(1,p.Input2_Npop);
Input2_v_spikes = zeros(nsamp,p.Input2_Npop);
L1_L2_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L2_iAMPA_IAMPA(1,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA);
L1_L3_iAMPA_IAMPA = zeros(nsamp,p.L1_Npop);
  L1_L3_iAMPA_IAMPA(1,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA);
L1_L4_iGABA_IGABA = zeros(nsamp,p.L1_Npop);
  L1_L4_iGABA_IGABA(1,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA));
L2_L1_iGABAa_IGABAa = zeros(nsamp,p.L2_Npop);
  L2_L1_iGABAa_IGABAa(1,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa);
L2_L3_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L3_iAMPA_IAMPA(1,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA);
L2_L5_iAMPA_IAMPA = zeros(nsamp,p.L2_Npop);
  L2_L5_iAMPA_IAMPA(1,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA);
L3_L1_iGABA_IGABA = zeros(nsamp,p.L3_Npop);
  L3_L1_iGABA_IGABA(1,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA));
L3_L2_iAMPA_IAMPA = zeros(nsamp,p.L3_Npop);
  L3_L2_iAMPA_IAMPA(1,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA);
L4_L1_iGABA_IGABA = zeros(nsamp,p.L4_Npop);
  L4_L1_iGABA_IGABA(1,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA));
L4_L5_iAMPA_IAMPA = zeros(nsamp,p.L4_Npop);
  L4_L5_iAMPA_IAMPA(1,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA);
L5_Input1_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_Input1_iAMPA_IAMPA(1,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA);
L5_L2_iGABA_IGABA = zeros(nsamp,p.L5_Npop);
  L5_L2_iGABA_IGABA(1,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA));
L5_L6_iAMPA_IAMPA = zeros(nsamp,p.L5_Npop);
  L5_L6_iAMPA_IAMPA(1,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA);
L6_Input2_iAMPA_IAMPA = zeros(nsamp,p.L6_Npop);
  L6_Input2_iAMPA_IAMPA(1,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA);

% ###########################################################
% Numerical integration:
% ###########################################################
n=2;
for k=2:ntime
  t=T(k-1);
  L1_v_k1 =p.L1_Iapp+0.5*((((-p.L1_iNa_gNa.*L1_iNa_m_last.^3.*L1_iNa_h_last.*(L1_v_last-p.L1_iNa_ENa))))+((((-p.L1_iK_gK.*L1_iK_n_last.^4.*(L1_v_last-p.L1_iK_EK))))+((((-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s_last*L1_L2_iAMPA_netcon).*(L1_v_last-p.L1_L2_iAMPA_EAMPA))))+((-(((p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s_last*L1_L4_iGABA_netcon).*(L1_v_last-p.L1_L4_iGABA_EGABA)))))+((((-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s_last*L1_L3_iAMPA_netcon).*(L1_v_last-p.L1_L3_iAMPA_EAMPA)))))))))+p.L1_noise*rand(1,p.L1_Npop);
  L1_iNa_m_k1 = (((2.5-.1*(L1_v_last+65))./(exp(2.5-.1*(L1_v_last+65))-1))).*(1-L1_iNa_m_last)-((4*exp(-(L1_v_last+65)/18))).*L1_iNa_m_last;
  L1_iNa_h_k1 = ((.07*exp(-(L1_v_last+65)/20))).*(1-L1_iNa_h_last)-((1./(exp(3-.1*(L1_v_last+65))+1))).*L1_iNa_h_last;
  L1_iK_n_k1 = (((.1-.01*(L1_v_last+65))./(exp(1-.1*(L1_v_last+65))-1))).*(1-L1_iK_n_last)-((.125*exp(-(L1_v_last+65)/80))).*L1_iK_n_last;
  L2_v_k1 =p.L2_Iapp+0.5*((((-p.L2_iNa_gNa.*L2_iNa_m_last.^3.*L2_iNa_h_last.*(L2_v_last-p.L2_iNa_ENa))))+((((-p.L2_iK_gK.*L2_iK_n_last.^4.*(L2_v_last-p.L2_iK_EK))))+((((-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s_last*L2_L1_iGABAa_netcon).*(L2_v_last-p.L2_L1_iGABAa_EGABAa))))+((((-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s_last*L2_L5_iAMPA_netcon).*(L2_v_last-p.L2_L5_iAMPA_EAMPA))))+((((-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s_last*L2_L3_iAMPA_netcon).*(L2_v_last-p.L2_L3_iAMPA_EAMPA)))))))))+p.L2_noise*rand(1,p.L2_Npop);
  L2_iNa_m_k1 = (((2.5-.1*(L2_v_last+65))./(exp(2.5-.1*(L2_v_last+65))-1))).*(1-L2_iNa_m_last)-((4*exp(-(L2_v_last+65)/18))).*L2_iNa_m_last;
  L2_iNa_h_k1 = ((.07*exp(-(L2_v_last+65)/20))).*(1-L2_iNa_h_last)-((1./(exp(3-.1*(L2_v_last+65))+1))).*L2_iNa_h_last;
  L2_iK_n_k1 = (((.1-.01*(L2_v_last+65))./(exp(1-.1*(L2_v_last+65))-1))).*(1-L2_iK_n_last)-((.125*exp(-(L2_v_last+65)/80))).*L2_iK_n_last;
  L3_v_k1 =p.L3_Iapp+0.5*((((-p.L3_iNa_gNa.*L3_iNa_m_last.^3.*L3_iNa_h_last.*(L3_v_last-p.L3_iNa_ENa))))+((((-p.L3_iK_gK.*L3_iK_n_last.^4.*(L3_v_last-p.L3_iK_EK))))+((((-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s_last*L3_L2_iAMPA_netcon).*(L3_v_last-p.L3_L2_iAMPA_EAMPA))))+((-(((p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s_last*L3_L1_iGABA_netcon).*(L3_v_last-p.L3_L1_iGABA_EGABA)))))))))+p.L3_noise*rand(1,p.L3_Npop);
  L3_iNa_m_k1 = (((2.5-.1*(L3_v_last+65))./(exp(2.5-.1*(L3_v_last+65))-1))).*(1-L3_iNa_m_last)-((4*exp(-(L3_v_last+65)/18))).*L3_iNa_m_last;
  L3_iNa_h_k1 = ((.07*exp(-(L3_v_last+65)/20))).*(1-L3_iNa_h_last)-((1./(exp(3-.1*(L3_v_last+65))+1))).*L3_iNa_h_last;
  L3_iK_n_k1 = (((.1-.01*(L3_v_last+65))./(exp(1-.1*(L3_v_last+65))-1))).*(1-L3_iK_n_last)-((.125*exp(-(L3_v_last+65)/80))).*L3_iK_n_last;
  L4_v_k1 =p.L4_Iapp+0.5*((((-p.L4_iNa_gNa.*L4_iNa_m_last.^3.*L4_iNa_h_last.*(L4_v_last-p.L4_iNa_ENa))))+((((-p.L4_iK_gK.*L4_iK_n_last.^4.*(L4_v_last-p.L4_iK_EK))))+((-(((p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s_last*L4_L1_iGABA_netcon).*(L4_v_last-p.L4_L1_iGABA_EGABA)))))+((((-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s_last*L4_L5_iAMPA_netcon).*(L4_v_last-p.L4_L5_iAMPA_EAMPA))))))))+p.L4_noise*rand(1,p.L4_Npop);
  L4_iNa_m_k1 = (((2.5-.1*(L4_v_last+65))./(exp(2.5-.1*(L4_v_last+65))-1))).*(1-L4_iNa_m_last)-((4*exp(-(L4_v_last+65)/18))).*L4_iNa_m_last;
  L4_iNa_h_k1 = ((.07*exp(-(L4_v_last+65)/20))).*(1-L4_iNa_h_last)-((1./(exp(3-.1*(L4_v_last+65))+1))).*L4_iNa_h_last;
  L4_iK_n_k1 = (((.1-.01*(L4_v_last+65))./(exp(1-.1*(L4_v_last+65))-1))).*(1-L4_iK_n_last)-((.125*exp(-(L4_v_last+65)/80))).*L4_iK_n_last;
  L5_v_k1 =p.L5_Iapp+0.5*((((-p.L5_iNa_gNa.*L5_iNa_m_last.^3.*L5_iNa_h_last.*(L5_v_last-p.L5_iNa_ENa))))+((((-p.L5_iK_gK.*L5_iK_n_last.^4.*(L5_v_last-p.L5_iK_EK))))+((-(((p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s_last*L5_L2_iGABA_netcon).*(L5_v_last-p.L5_L2_iGABA_EGABA)))))+((((-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s_last*L5_Input1_iAMPA_netcon).*(L5_v_last-p.L5_Input1_iAMPA_EAMPA))))+((((-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s_last*L5_L6_iAMPA_netcon).*(L5_v_last-p.L5_L6_iAMPA_EAMPA)))))))))+p.L5_noise*rand(1,p.L5_Npop);
  L5_iNa_m_k1 = (((2.5-.1*(L5_v_last+65))./(exp(2.5-.1*(L5_v_last+65))-1))).*(1-L5_iNa_m_last)-((4*exp(-(L5_v_last+65)/18))).*L5_iNa_m_last;
  L5_iNa_h_k1 = ((.07*exp(-(L5_v_last+65)/20))).*(1-L5_iNa_h_last)-((1./(exp(3-.1*(L5_v_last+65))+1))).*L5_iNa_h_last;
  L5_iK_n_k1 = (((.1-.01*(L5_v_last+65))./(exp(1-.1*(L5_v_last+65))-1))).*(1-L5_iK_n_last)-((.125*exp(-(L5_v_last+65)/80))).*L5_iK_n_last;
  L6_v_k1 =p.L6_Iapp+0.5*((((-p.L6_iNa_gNa.*L6_iNa_m_last.^3.*L6_iNa_h_last.*(L6_v_last-p.L6_iNa_ENa))))+((((-p.L6_iK_gK.*L6_iK_n_last.^4.*(L6_v_last-p.L6_iK_EK))))+((((-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s_last*L6_Input2_iAMPA_netcon).*(L6_v_last-p.L6_Input2_iAMPA_EAMPA)))))))+p.L6_noise*rand(1,p.L6_Npop);
  L6_iNa_m_k1 = (((2.5-.1*(L6_v_last+65))./(exp(2.5-.1*(L6_v_last+65))-1))).*(1-L6_iNa_m_last)-((4*exp(-(L6_v_last+65)/18))).*L6_iNa_m_last;
  L6_iNa_h_k1 = ((.07*exp(-(L6_v_last+65)/20))).*(1-L6_iNa_h_last)-((1./(exp(3-.1*(L6_v_last+65))+1))).*L6_iNa_h_last;
  L6_iK_n_k1 = (((.1-.01*(L6_v_last+65))./(exp(1-.1*(L6_v_last+65))-1))).*(1-L6_iK_n_last)-((.125*exp(-(L6_v_last+65)/80))).*L6_iK_n_last;
  Input1_v_k1 = 30*sin(3*t) * (((t>50)));
  Input1_iNa_m_k1 = (((2.5-.1*(Input1_v_last+65))./(exp(2.5-.1*(Input1_v_last+65))-1))).*(1-Input1_iNa_m_last)-((4*exp(-(Input1_v_last+65)/18))).*Input1_iNa_m_last;
  Input1_iNa_h_k1 = ((.07*exp(-(Input1_v_last+65)/20))).*(1-Input1_iNa_h_last)-((1./(exp(3-.1*(Input1_v_last+65))+1))).*Input1_iNa_h_last;
  Input1_iK_n_k1 = (((.1-.01*(Input1_v_last+65))./(exp(1-.1*(Input1_v_last+65))-1))).*(1-Input1_iK_n_last)-((.125*exp(-(Input1_v_last+65)/80))).*Input1_iK_n_last;
  Input2_v_k1 = 30*sin(3*t) * (((t>50)));
  Input2_iNa_m_k1 = (((2.5-.1*(Input2_v_last+65))./(exp(2.5-.1*(Input2_v_last+65))-1))).*(1-Input2_iNa_m_last)-((4*exp(-(Input2_v_last+65)/18))).*Input2_iNa_m_last;
  Input2_iNa_h_k1 = ((.07*exp(-(Input2_v_last+65)/20))).*(1-Input2_iNa_h_last)-((1./(exp(3-.1*(Input2_v_last+65))+1))).*Input2_iNa_h_last;
  Input2_iK_n_k1 = (((.1-.01*(Input2_v_last+65))./(exp(1-.1*(Input2_v_last+65))-1))).*(1-Input2_iK_n_last)-((.125*exp(-(Input2_v_last+65)/80))).*Input2_iK_n_last;
  L2_L1_iGABAa_s_k1 = -L2_L1_iGABAa_s_last./p.L2_L1_iGABAa_tauD + 1/2*(1+tanh(L1_v_last/10)).*((1-L2_L1_iGABAa_s_last)/p.L2_L1_iGABAa_tauR);
  L1_L2_iAMPA_s_k1 = -L1_L2_iAMPA_s_last./p.L1_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L1_L2_iAMPA_s_last)/p.L1_L2_iAMPA_tauR);
  L2_L5_iAMPA_s_k1 = -L2_L5_iAMPA_s_last./p.L2_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L2_L5_iAMPA_s_last)/p.L2_L5_iAMPA_tauR);
  L5_L2_iGABA_s_k1 = -L5_L2_iGABA_s_last./p.L5_L2_iGABA_tauGABA + ((1-L5_L2_iGABA_s_last)/p.L5_L2_iGABA_tauGABAr).*(1+tanh(L2_v_last/10));
  L3_L2_iAMPA_s_k1 = -L3_L2_iAMPA_s_last./p.L3_L2_iAMPA_tauD + 1/2*(1+tanh(L2_v_last/10)).*((1-L3_L2_iAMPA_s_last)/p.L3_L2_iAMPA_tauR);
  L2_L3_iAMPA_s_k1 = -L2_L3_iAMPA_s_last./p.L2_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L2_L3_iAMPA_s_last)/p.L2_L3_iAMPA_tauR);
  L1_L4_iGABA_s_k1 = -L1_L4_iGABA_s_last./p.L1_L4_iGABA_tauGABA + ((1-L1_L4_iGABA_s_last)/p.L1_L4_iGABA_tauGABAr).*(1+tanh(L4_v_last/10));
  L4_L1_iGABA_s_k1 = -L4_L1_iGABA_s_last./p.L4_L1_iGABA_tauGABA + ((1-L4_L1_iGABA_s_last)/p.L4_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L1_L3_iAMPA_s_k1 = -L1_L3_iAMPA_s_last./p.L1_L3_iAMPA_tauD + 1/2*(1+tanh(L3_v_last/10)).*((1-L1_L3_iAMPA_s_last)/p.L1_L3_iAMPA_tauR);
  L3_L1_iGABA_s_k1 = -L3_L1_iGABA_s_last./p.L3_L1_iGABA_tauGABA + ((1-L3_L1_iGABA_s_last)/p.L3_L1_iGABA_tauGABAr).*(1+tanh(L1_v_last/10));
  L5_Input1_iAMPA_s_k1 = -L5_Input1_iAMPA_s_last./p.L5_Input1_iAMPA_tauD + 1/2*(1+tanh(Input1_v_last/10)).*((1-L5_Input1_iAMPA_s_last)/p.L5_Input1_iAMPA_tauR);
  L6_Input2_iAMPA_s_k1 = -L6_Input2_iAMPA_s_last./p.L6_Input2_iAMPA_tauD + 1/2*(1+tanh(Input2_v_last/10)).*((1-L6_Input2_iAMPA_s_last)/p.L6_Input2_iAMPA_tauR);
  L5_L6_iAMPA_s_k1 = -L5_L6_iAMPA_s_last./p.L5_L6_iAMPA_tauD + 1/2*(1+tanh(L6_v_last/10)).*((1-L5_L6_iAMPA_s_last)/p.L5_L6_iAMPA_tauR);
  L4_L5_iAMPA_s_k1 = -L4_L5_iAMPA_s_last./p.L4_L5_iAMPA_tauD + 1/2*(1+tanh(L5_v_last/10)).*((1-L4_L5_iAMPA_s_last)/p.L4_L5_iAMPA_tauR);

  % ------------------------------------------------------------
  % Update state variables:
  % ------------------------------------------------------------
  L1_v_last = L1_v_last+dt*L1_v_k1;
  L1_iNa_m_last = L1_iNa_m_last+dt*L1_iNa_m_k1;
  L1_iNa_h_last = L1_iNa_h_last+dt*L1_iNa_h_k1;
  L1_iK_n_last = L1_iK_n_last+dt*L1_iK_n_k1;
  L2_v_last = L2_v_last+dt*L2_v_k1;
  L2_iNa_m_last = L2_iNa_m_last+dt*L2_iNa_m_k1;
  L2_iNa_h_last = L2_iNa_h_last+dt*L2_iNa_h_k1;
  L2_iK_n_last = L2_iK_n_last+dt*L2_iK_n_k1;
  L3_v_last = L3_v_last+dt*L3_v_k1;
  L3_iNa_m_last = L3_iNa_m_last+dt*L3_iNa_m_k1;
  L3_iNa_h_last = L3_iNa_h_last+dt*L3_iNa_h_k1;
  L3_iK_n_last = L3_iK_n_last+dt*L3_iK_n_k1;
  L4_v_last = L4_v_last+dt*L4_v_k1;
  L4_iNa_m_last = L4_iNa_m_last+dt*L4_iNa_m_k1;
  L4_iNa_h_last = L4_iNa_h_last+dt*L4_iNa_h_k1;
  L4_iK_n_last = L4_iK_n_last+dt*L4_iK_n_k1;
  L5_v_last = L5_v_last+dt*L5_v_k1;
  L5_iNa_m_last = L5_iNa_m_last+dt*L5_iNa_m_k1;
  L5_iNa_h_last = L5_iNa_h_last+dt*L5_iNa_h_k1;
  L5_iK_n_last = L5_iK_n_last+dt*L5_iK_n_k1;
  L6_v_last = L6_v_last+dt*L6_v_k1;
  L6_iNa_m_last = L6_iNa_m_last+dt*L6_iNa_m_k1;
  L6_iNa_h_last = L6_iNa_h_last+dt*L6_iNa_h_k1;
  L6_iK_n_last = L6_iK_n_last+dt*L6_iK_n_k1;
  Input1_v_last = Input1_v_last+dt*Input1_v_k1;
  Input1_iNa_m_last = Input1_iNa_m_last+dt*Input1_iNa_m_k1;
  Input1_iNa_h_last = Input1_iNa_h_last+dt*Input1_iNa_h_k1;
  Input1_iK_n_last = Input1_iK_n_last+dt*Input1_iK_n_k1;
  Input2_v_last = Input2_v_last+dt*Input2_v_k1;
  Input2_iNa_m_last = Input2_iNa_m_last+dt*Input2_iNa_m_k1;
  Input2_iNa_h_last = Input2_iNa_h_last+dt*Input2_iNa_h_k1;
  Input2_iK_n_last = Input2_iK_n_last+dt*Input2_iK_n_k1;
  L2_L1_iGABAa_s_last = L2_L1_iGABAa_s_last+dt*L2_L1_iGABAa_s_k1;
  L1_L2_iAMPA_s_last = L1_L2_iAMPA_s_last+dt*L1_L2_iAMPA_s_k1;
  L2_L5_iAMPA_s_last = L2_L5_iAMPA_s_last+dt*L2_L5_iAMPA_s_k1;
  L5_L2_iGABA_s_last = L5_L2_iGABA_s_last+dt*L5_L2_iGABA_s_k1;
  L3_L2_iAMPA_s_last = L3_L2_iAMPA_s_last+dt*L3_L2_iAMPA_s_k1;
  L2_L3_iAMPA_s_last = L2_L3_iAMPA_s_last+dt*L2_L3_iAMPA_s_k1;
  L1_L4_iGABA_s_last = L1_L4_iGABA_s_last+dt*L1_L4_iGABA_s_k1;
  L4_L1_iGABA_s_last = L4_L1_iGABA_s_last+dt*L4_L1_iGABA_s_k1;
  L1_L3_iAMPA_s_last = L1_L3_iAMPA_s_last+dt*L1_L3_iAMPA_s_k1;
  L3_L1_iGABA_s_last = L3_L1_iGABA_s_last+dt*L3_L1_iGABA_s_k1;
  L5_Input1_iAMPA_s_last = L5_Input1_iAMPA_s_last+dt*L5_Input1_iAMPA_s_k1;
  L6_Input2_iAMPA_s_last = L6_Input2_iAMPA_s_last+dt*L6_Input2_iAMPA_s_k1;
  L5_L6_iAMPA_s_last = L5_L6_iAMPA_s_last+dt*L5_L6_iAMPA_s_k1;
  L4_L5_iAMPA_s_last = L4_L5_iAMPA_s_last+dt*L4_L5_iAMPA_s_k1;

  % ------------------------------------------------------------
  % Conditional actions:
  % ------------------------------------------------------------
  conditional_test=any(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  conditional_indx=(any(Input2_v_last>=-20&Input2_v(n-1,:)<-20));
  if conditional_test, Input2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input2_tspike(Input2_buffer_index(i),i)=t; Input2_buffer_index(i)=mod(-1+(Input2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  conditional_indx=(any(Input1_v_last>=-20&Input1_v(n-1,:)<-20));
  if conditional_test, Input1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); Input1_tspike(Input1_buffer_index(i),i)=t; Input1_buffer_index(i)=mod(-1+(Input1_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  conditional_indx=(any(L6_v_last>=-20&L6_v(n-1,:)<-20));
  if conditional_test, L6_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L6_tspike(L6_buffer_index(i),i)=t; L6_buffer_index(i)=mod(-1+(L6_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  conditional_indx=(any(L5_v_last>=-20&L5_v(n-1,:)<-20));
  if conditional_test, L5_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L5_tspike(L5_buffer_index(i),i)=t; L5_buffer_index(i)=mod(-1+(L5_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  conditional_indx=(any(L4_v_last>=-20&L4_v(n-1,:)<-20));
  if conditional_test, L4_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L4_tspike(L4_buffer_index(i),i)=t; L4_buffer_index(i)=mod(-1+(L4_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  conditional_indx=(any(L3_v_last>=-20&L3_v(n-1,:)<-20));
  if conditional_test, L3_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L3_tspike(L3_buffer_index(i),i)=t; L3_buffer_index(i)=mod(-1+(L3_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  conditional_indx=(any(L2_v_last>=-20&L2_v(n-1,:)<-20));
  if conditional_test, L2_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L2_tspike(L2_buffer_index(i),i)=t; L2_buffer_index(i)=mod(-1+(L2_buffer_index(i)+1),2)+1; end; end
  conditional_test=any(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  conditional_indx=(any(L1_v_last>=-20&L1_v(n-1,:)<-20));
  if conditional_test, L1_v_spikes(n,conditional_indx)=1;inds=find(conditional_indx); for j=1:length(inds), i=inds(j); L1_tspike(L1_buffer_index(i),i)=t; L1_buffer_index(i)=mod(-1+(L1_buffer_index(i)+1),2)+1; end; end

  if mod(k,downsample_factor)==0 % store this time point

  % ------------------------------------------------------------
  % Store state variables:
  % ------------------------------------------------------------
    L1_v(n,:) = L1_v_last;
    L1_iNa_m(n,:) = L1_iNa_m_last;
    L1_iNa_h(n,:) = L1_iNa_h_last;
    L1_iK_n(n,:) = L1_iK_n_last;
    L2_v(n,:) = L2_v_last;
    L2_iNa_m(n,:) = L2_iNa_m_last;
    L2_iNa_h(n,:) = L2_iNa_h_last;
    L2_iK_n(n,:) = L2_iK_n_last;
    L3_v(n,:) = L3_v_last;
    L3_iNa_m(n,:) = L3_iNa_m_last;
    L3_iNa_h(n,:) = L3_iNa_h_last;
    L3_iK_n(n,:) = L3_iK_n_last;
    L4_v(n,:) = L4_v_last;
    L4_iNa_m(n,:) = L4_iNa_m_last;
    L4_iNa_h(n,:) = L4_iNa_h_last;
    L4_iK_n(n,:) = L4_iK_n_last;
    L5_v(n,:) = L5_v_last;
    L5_iNa_m(n,:) = L5_iNa_m_last;
    L5_iNa_h(n,:) = L5_iNa_h_last;
    L5_iK_n(n,:) = L5_iK_n_last;
    L6_v(n,:) = L6_v_last;
    L6_iNa_m(n,:) = L6_iNa_m_last;
    L6_iNa_h(n,:) = L6_iNa_h_last;
    L6_iK_n(n,:) = L6_iK_n_last;
    Input1_v(n) = Input1_v_last;
    Input1_iNa_m(n) = Input1_iNa_m_last;
    Input1_iNa_h(n) = Input1_iNa_h_last;
    Input1_iK_n(n) = Input1_iK_n_last;
    Input2_v(n) = Input2_v_last;
    Input2_iNa_m(n) = Input2_iNa_m_last;
    Input2_iNa_h(n) = Input2_iNa_h_last;
    Input2_iK_n(n) = Input2_iK_n_last;
    L2_L1_iGABAa_s(n,:) = L2_L1_iGABAa_s_last;
    L1_L2_iAMPA_s(n,:) = L1_L2_iAMPA_s_last;
    L2_L5_iAMPA_s(n,:) = L2_L5_iAMPA_s_last;
    L5_L2_iGABA_s(n,:) = L5_L2_iGABA_s_last;
    L3_L2_iAMPA_s(n,:) = L3_L2_iAMPA_s_last;
    L2_L3_iAMPA_s(n,:) = L2_L3_iAMPA_s_last;
    L1_L4_iGABA_s(n,:) = L1_L4_iGABA_s_last;
    L4_L1_iGABA_s(n,:) = L4_L1_iGABA_s_last;
    L1_L3_iAMPA_s(n,:) = L1_L3_iAMPA_s_last;
    L3_L1_iGABA_s(n,:) = L3_L1_iGABA_s_last;
    L5_Input1_iAMPA_s(n) = L5_Input1_iAMPA_s_last;
    L6_Input2_iAMPA_s(n) = L6_Input2_iAMPA_s_last;
    L5_L6_iAMPA_s(n,:) = L5_L6_iAMPA_s_last;
    L4_L5_iAMPA_s(n,:) = L4_L5_iAMPA_s_last;

  % ------------------------------------------------------------
  % Update monitors:
  % ------------------------------------------------------------
  L1_L2_iAMPA_IAMPA(n,:)=-p.L1_L2_iAMPA_gAMPA.*(L1_L2_iAMPA_s(n,:)*L1_L2_iAMPA_netcon).*(L1_v(n,:)-p.L1_L2_iAMPA_EAMPA);
  L1_L3_iAMPA_IAMPA(n,:)=-p.L1_L3_iAMPA_gAMPA.*(L1_L3_iAMPA_s(n,:)*L1_L3_iAMPA_netcon).*(L1_v(n,:)-p.L1_L3_iAMPA_EAMPA);
  L1_L4_iGABA_IGABA(n,:)=(p.L1_L4_iGABA_gGABA.*(L1_L4_iGABA_s(n,:)*L1_L4_iGABA_netcon).*(L1_v(n,:)-p.L1_L4_iGABA_EGABA));
  L2_L1_iGABAa_IGABAa(n,:)=-p.L2_L1_iGABAa_gGABAa.*(L2_L1_iGABAa_s(n,:)*L2_L1_iGABAa_netcon).*(L2_v(n,:)-p.L2_L1_iGABAa_EGABAa);
  L2_L3_iAMPA_IAMPA(n,:)=-p.L2_L3_iAMPA_gAMPA.*(L2_L3_iAMPA_s(n,:)*L2_L3_iAMPA_netcon).*(L2_v(n,:)-p.L2_L3_iAMPA_EAMPA);
  L2_L5_iAMPA_IAMPA(n,:)=-p.L2_L5_iAMPA_gAMPA.*(L2_L5_iAMPA_s(n,:)*L2_L5_iAMPA_netcon).*(L2_v(n,:)-p.L2_L5_iAMPA_EAMPA);
  L3_L1_iGABA_IGABA(n,:)=(p.L3_L1_iGABA_gGABA.*(L3_L1_iGABA_s(n,:)*L3_L1_iGABA_netcon).*(L3_v(n,:)-p.L3_L1_iGABA_EGABA));
  L3_L2_iAMPA_IAMPA(n,:)=-p.L3_L2_iAMPA_gAMPA.*(L3_L2_iAMPA_s(n,:)*L3_L2_iAMPA_netcon).*(L3_v(n,:)-p.L3_L2_iAMPA_EAMPA);
  L4_L1_iGABA_IGABA(n,:)=(p.L4_L1_iGABA_gGABA.*(L4_L1_iGABA_s(n,:)*L4_L1_iGABA_netcon).*(L4_v(n,:)-p.L4_L1_iGABA_EGABA));
  L4_L5_iAMPA_IAMPA(n,:)=-p.L4_L5_iAMPA_gAMPA.*(L4_L5_iAMPA_s(n,:)*L4_L5_iAMPA_netcon).*(L4_v(n,:)-p.L4_L5_iAMPA_EAMPA);
  L5_Input1_iAMPA_IAMPA(n,:)=-p.L5_Input1_iAMPA_gAMPA.*(L5_Input1_iAMPA_s(n)*L5_Input1_iAMPA_netcon).*(L5_v(n,:)-p.L5_Input1_iAMPA_EAMPA);
  L5_L2_iGABA_IGABA(n,:)=(p.L5_L2_iGABA_gGABA.*(L5_L2_iGABA_s(n,:)*L5_L2_iGABA_netcon).*(L5_v(n,:)-p.L5_L2_iGABA_EGABA));
  L5_L6_iAMPA_IAMPA(n,:)=-p.L5_L6_iAMPA_gAMPA.*(L5_L6_iAMPA_s(n,:)*L5_L6_iAMPA_netcon).*(L5_v(n,:)-p.L5_L6_iAMPA_EAMPA);
  L6_Input2_iAMPA_IAMPA(n,:)=-p.L6_Input2_iAMPA_gAMPA.*(L6_Input2_iAMPA_s(n)*L6_Input2_iAMPA_netcon).*(L6_v(n,:)-p.L6_Input2_iAMPA_EAMPA);

    n=n+1;
  end
end

T=T(1:downsample_factor:ntime);

end
